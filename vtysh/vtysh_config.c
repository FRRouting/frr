/*Configurationgenerator.*Copyright(C)2000KunihiroIshiguro**ThisfileispartofGNUZ
ebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsof
theGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2
,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeus
eful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFIT
NESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshou
ldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileC
OPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bost
on,MA02110-1301USA*/#include<zebra.h>#include"command.h"#include"linklist.h"#inc
lude"memory.h"#include"vtysh/vtysh.h"#include"vtysh/vtysh_user.h"DEFINE_MGROUP(M
VTYSH,"vtysh")DEFINE_MTYPE_STATIC(MVTYSH,VTYSH_CONFIG,"Vtyshconfiguration")DEFIN
E_MTYPE_STATIC(MVTYSH,VTYSH_CONFIG_LINE,"Vtyshconfigurationline")vectorconfigvec
;structconfig{/*Configurationnodename.*/char*name;/*Configurationstringline.*/st
ructlist*line;/*Configurationcanbenest.*/structconfig*config;/*Indexofthisconfig
.*/uint32_tindex;};structlist*config_top;staticintline_cmp(char*c1,char*c2){retu
rnstrcmp(c1,c2);}staticvoidline_del(char*line){XFREE(MTYPE_VTYSH_CONFIG_LINE,lin
e);}staticstructconfig*config_new(void){structconfig*config;config=XCALLOC(MTYPE
_VTYSH_CONFIG,sizeof(structconfig));returnconfig;}staticintconfig_cmp(structconf
ig*c1,structconfig*c2){returnstrcmp(c1->name,c2->name);}staticvoidconfig_del(str
uctconfig*config){list_delete_and_null(&config->line);if(config->name)XFREE(MTYP
E_VTYSH_CONFIG_LINE,config->name);XFREE(MTYPE_VTYSH_CONFIG,config);}staticstruct
config*config_get(intindex,constchar*line){structconfig*config;structconfig*conf
ig_loop;structlist*master;structlistnode*node,*nnode;config=config_loop=NULL;mas
ter=vector_lookup_ensure(configvec,index);if(!master){master=list_new();master->
del=(void(*)(void*))config_del;master->cmp=(int(*)(void*,void*))config_cmp;vecto
r_set_index(configvec,index,master);}for(ALL_LIST_ELEMENTS(master,node,nnode,con
fig_loop)){if(strcmp(config_loop->name,line)==0)config=config_loop;}if(!config){
config=config_new();config->line=list_new();config->line->del=(void(*)(void*))li
ne_del;config->line->cmp=(int(*)(void*,void*))line_cmp;config->name=XSTRDUP(MTYP
E_VTYSH_CONFIG_LINE,line);config->index=index;listnode_add(master,config);}retur
nconfig;}voidconfig_add_line(structlist*config,constchar*line){listnode_add(conf
ig,XSTRDUP(MTYPE_VTYSH_CONFIG_LINE,line));}staticvoidconfig_add_line_uniq(struct
list*config,constchar*line){structlistnode*node,*nnode;char*pnt;for(ALL_LIST_ELE
MENTS(config,node,nnode,pnt)){if(strcmp(pnt,line)==0)return;}listnode_add_sort(c
onfig,XSTRDUP(MTYPE_VTYSH_CONFIG_LINE,line));}/**Iwanttoexplicitlymovethiscomman
dtotheendoftheline*/staticvoidconfig_add_line_end(structlist*config,constchar*li
ne){structlistnode*node;void*item=XSTRDUP(MTYPE_VTYSH_CONFIG_LINE,line);listnode
_add(config,item);node=listnode_lookup(config,item);if(node)listnode_move_to_tai
l(config,node);}voidvtysh_config_parse_line(void*arg,constchar*line){charc;stati
cstructconfig*config=NULL;if(!line)return;c=line[0];if(c=='\0')return;/*printf("
[%s]\n",line);*/switch(c){/*Suppressexclamationpoints!andcommentedlines.The!sare
*generated*dynamicallyinvtysh_config_dump()*/case'!':case'#':break;case'':/*Stor
elinetocurrentconfiguration.*/if(config){if(strncmp(line,"link-params",strlen("l
ink-params"))==0){config_add_line(config->line,line);config->index=LINK_PARAMS_N
ODE;}elseif(strncmp(line,"ipmulticastboundary",strlen("ipmulticastboundary"))==0
){config_add_line_end(config->line,line);}elseif(config->index==LINK_PARAMS_NODE
&&strncmp(line,"exit-link-params",strlen("exit"))==0){config_add_line(config->li
ne,line);config->index=INTERFACE_NODE;}elseif(config->index==RMAP_NODE||config->
index==INTERFACE_NODE||config->index==LOGICALROUTER_NODE||config->index==VTY_NOD
E||config->index==VRF_NODE)config_add_line_uniq(config->line,line);elseconfig_ad
d_line(config->line,line);}elseconfig_add_line(config_top,line);break;default:if
(strncmp(line,"interface",strlen("interface"))==0)config=config_get(INTERFACE_NO
DE,line);elseif(strncmp(line,"pseudowire",strlen("pseudowire"))==0)config=config
_get(PW_NODE,line);elseif(strncmp(line,"logical-router",strlen("ns"))==0)config=
config_get(LOGICALROUTER_NODE,line);elseif(strncmp(line,"vrf",strlen("vrf"))==0)
config=config_get(VRF_NODE,line);elseif(strncmp(line,"router-id",strlen("router-
id"))==0)config=config_get(ZEBRA_NODE,line);elseif(strncmp(line,"routerrip",strl
en("routerrip"))==0)config=config_get(RIP_NODE,line);elseif(strncmp(line,"router
ripng",strlen("routerripng"))==0)config=config_get(RIPNG_NODE,line);elseif(strnc
mp(line,"routereigrp",strlen("routereigrp"))==0)config=config_get(EIGRP_NODE,lin
e);elseif(strncmp(line,"routerbabel",strlen("routerbabel"))==0)config=config_get
(BABEL_NODE,line);elseif(strncmp(line,"routerospf",strlen("routerospf"))==0)conf
ig=config_get(OSPF_NODE,line);elseif(strncmp(line,"routerospf6",strlen("routeros
pf6"))==0)config=config_get(OSPF6_NODE,line);elseif(strncmp(line,"mplsldp",strle
n("mplsldp"))==0)config=config_get(LDP_NODE,line);elseif(strncmp(line,"l2vpn",st
rlen("l2vpn"))==0)config=config_get(LDP_L2VPN_NODE,line);elseif(strncmp(line,"ro
uterbgp",strlen("routerbgp"))==0)config=config_get(BGP_NODE,line);elseif(strncmp
(line,"routerisis",strlen("routerisis"))==0)config=config_get(ISIS_NODE,line);el
seif(strncmp(line,"route-map",strlen("route-map"))==0)config=config_get(RMAP_NOD
E,line);elseif(strncmp(line,"access-list",strlen("access-list"))==0)config=confi
g_get(ACCESS_NODE,line);elseif(strncmp(line,"ipv6access-list",strlen("ipv6access
-list"))==0)config=config_get(ACCESS_IPV6_NODE,line);elseif(strncmp(line,"macacc
ess-list",strlen("macaccess-list"))==0)config=config_get(ACCESS_MAC_NODE,line);e
lseif(strncmp(line,"ipprefix-list",strlen("ipprefix-list"))==0)config=config_get
(PREFIX_NODE,line);elseif(strncmp(line,"ipv6prefix-list",strlen("ipv6prefix-list
"))==0)config=config_get(PREFIX_IPV6_NODE,line);elseif(strncmp(line,"ipas-pathac
cess-list",strlen("ipas-pathaccess-list"))==0)config=config_get(AS_LIST_NODE,lin
e);elseif(strncmp(line,"ipcommunity-list",strlen("ipcommunity-list"))==0||strncm
p(line,"ipextcommunity-list",strlen("ipextcommunity-list"))==0||strncmp(line,"ip
large-community-list",strlen("iplarge-community-list"))==0)config=config_get(COM
MUNITY_LIST_NODE,line);elseif(strncmp(line,"iproute",strlen("iproute"))==0)confi
g=config_get(IP_NODE,line);elseif(strncmp(line,"ipv6route",strlen("ipv6route"))=
=0)config=config_get(IP_NODE,line);elseif(strncmp(line,"key",strlen("key"))==0)c
onfig=config_get(KEYCHAIN_NODE,line);elseif(strncmp(line,"line",strlen("line"))=
=0)config=config_get(VTY_NODE,line);elseif((strncmp(line,"ipv6forwarding",strlen
("ipv6forwarding"))==0)||(strncmp(line,"ipforwarding",strlen("ipforwarding"))==0
))config=config_get(FORWARDING_NODE,line);elseif(strncmp(line,"service",strlen("
service"))==0)config=config_get(SERVICE_NODE,line);elseif(strncmp(line,"debugvrf
",strlen("debugvrf"))==0)config=config_get(VRF_DEBUG_NODE,line);elseif(strncmp(l
ine,"debug",strlen("debug"))==0)config=config_get(DEBUG_NODE,line);elseif(strncm
p(line,"password",strlen("password"))==0||strncmp(line,"enablepassword",strlen("
enablepassword"))==0)config=config_get(AAA_NODE,line);elseif(strncmp(line,"ippro
tocol",strlen("ipprotocol"))==0)config=config_get(PROTOCOL_NODE,line);elseif(str
ncmp(line,"ipv6protocol",strlen("ipv6protocol"))==0)config=config_get(PROTOCOL_N
ODE,line);elseif(strncmp(line,"ipnht",strlen("ipnht"))==0)config=config_get(PROT
OCOL_NODE,line);elseif(strncmp(line,"ipv6nht",strlen("ipv6nht"))==0)config=confi
g_get(PROTOCOL_NODE,line);elseif(strncmp(line,"mpls",strlen("mpls"))==0)config=c
onfig_get(MPLS_NODE,line);else{if(strncmp(line,"log",strlen("log"))==0||strncmp(
line,"hostname",strlen("hostname"))==0||strncmp(line,"frr",strlen("frr"))==0||st
rncmp(line,"agentx",strlen("agentx"))==0||strncmp(line,"nolog",strlen("nolog"))=
=0)config_add_line_uniq(config_top,line);elseconfig_add_line(config_top,line);co
nfig=NULL;}break;}}/*Macrotocheckdelimiterisneededbetweeneachconfigurationline*o
rnot.*/#defineNO_DELIMITER(I)\((I)==ACCESS_NODE||(I)==PREFIX_NODE||(I)==IP_NODE\
||(I)==AS_LIST_NODE||(I)==COMMUNITY_LIST_NODE\||(I)==ACCESS_IPV6_NODE||(I)==ACCE
SS_MAC_NODE\||(I)==PREFIX_IPV6_NODE||(I)==SERVICE_NODE\||(I)==FORWARDING_NODE||(
I)==DEBUG_NODE||(I)==AAA_NODE\||(I)==VRF_DEBUG_NODE||(I)==MPLS_NODE)/*Displaycon
figurationtofilepointer.*/voidvtysh_config_dump(FILE*fp){structlistnode*node,*nn
ode;structlistnode*mnode,*mnnode;structconfig*config;structlist*master;char*line
;unsignedinti;for(ALL_LIST_ELEMENTS(config_top,node,nnode,line)){fprintf(fp,"%s\
n",line);fflush(fp);}fprintf(fp,"!\n");fflush(fp);for(i=0;i<vector_active(config
vec);i++)if((master=vector_slot(configvec,i))!=NULL){for(ALL_LIST_ELEMENTS(maste
r,node,nnode,config)){/*Don'tprintemptysectionsforinterface.*Routemapsonthe*othe
rhandcouldhavealegitimateempty*sectionattheend.*VRFishandledinthebackend,wecould
have*"configured"VRFswithstaticrouteswhich*arenotundertheVRFnode.*/if(config->in
dex==INTERFACE_NODE&&list_isempty(config->line))continue;fprintf(fp,"%s\n",confi
g->name);fflush(fp);for(ALL_LIST_ELEMENTS(config->line,mnode,mnnode,line)){fprin
tf(fp,"%s\n",line);fflush(fp);}if(!NO_DELIMITER(i)){fprintf(fp,"!\n");fflush(fp)
;}}if(NO_DELIMITER(i)){fprintf(fp,"!\n");fflush(fp);}}for(i=0;i<vector_active(co
nfigvec);i++)if((master=vector_slot(configvec,i))!=NULL){list_delete_and_null(&m
aster);vector_slot(configvec,i)=NULL;}list_delete_all_node(config_top);}/*Readup
configurationfilefromfile_name.*/staticintvtysh_read_file(FILE*confp){structvty*
vty;intret;vty=vty_new();vty->wfd=STDERR_FILENO;vty->type=VTY_TERM;vty->node=CON
FIG_NODE;vtysh_execute_no_pager("enable");vtysh_execute_no_pager("configuretermi
nal");/*Executeconfigurationfile.*/ret=vtysh_config_from_file(vty,confp);vtysh_e
xecute_no_pager("end");vtysh_execute_no_pager("disable");vty_close(vty);return(r
et);}/*Readupconfigurationfilefromconfig_default_dir.*/intvtysh_read_config(cons
tchar*config_default_dir){FILE*confp=NULL;intret;confp=fopen(config_default_dir,
"r");if(confp==NULL){fprintf(stderr,"%%Can'topenconfigurationfile%sdueto'%s'.\n"
,config_default_dir,safe_strerror(errno));return(CMD_ERR_NO_FILE);}ret=vtysh_rea
d_file(confp);fclose(confp);return(ret);}/*Wedon'twritevtyshspecificintofilefrom
vtysh.vtysh.confshould*beeditedbyhand.So,wehandleonly"writeterminal"casehereand*
integratevtyshspecificconfwithconffromdaemons.*/voidvtysh_config_write(){charlin
e[81];if(cmd_hostname_get()){sprintf(line,"hostname%s",cmd_hostname_get());vtysh
_config_parse_line(NULL,line);}if(cmd_domainname_get()){sprintf(line,"domainname
%s",cmd_domainname_get());vtysh_config_parse_line(NULL,line);}if(vtysh_write_int
egrated==WRITE_INTEGRATED_NO)vtysh_config_parse_line(NULL,"noserviceintegrated-v
tysh-config");if(vtysh_write_integrated==WRITE_INTEGRATED_YES)vtysh_config_parse
_line(NULL,"serviceintegrated-vtysh-config");user_config_write();}voidvtysh_conf
ig_init(){config_top=list_new();config_top->del=(void(*)(void*))line_del;configv
ec=vector_init(1);}