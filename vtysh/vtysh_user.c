/*Userauthenticationforvtysh.*Copyright(C)2000KunihiroIshiguro**Thisfileispartof
GNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheter
msoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eithervers
ion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwill
beuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYo
rFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**You
shouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethef
ileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,
Boston,MA02110-1301USA*/#include<zebra.h>#include<lib/version.h>#include<pwd.h>#
ifdefUSE_PAM#include<security/pam_appl.h>#ifdefHAVE_PAM_MISC_H#include<security/
pam_misc.h>#endif#ifdefHAVE_OPENPAM_H#include<security/openpam.h>#endif#endif/*U
SE_PAM*/#include"memory.h"#include"linklist.h"#include"command.h"#include"vtysh/
vtysh_user.h"/**Compileriswarningaboutprototypesnotbeingdeclared.*TheDEFUNSHandD
EFUNmacro'saremessingwiththe*compilerIbelieve.Thisisjusttomakeithappy.*/#ifdefUS
E_PAMstaticintvtysh_pam(constchar*);#endifintvtysh_auth(void);voidvtysh_user_ini
t(void);externstructlist*config_top;externvoidconfig_add_line(structlist*config,
constchar*line);#ifdefUSE_PAMstaticstructpam_convconv={PAM_CONV_FUNC,NULL};stati
cintvtysh_pam(constchar*user){intret;pam_handle_t*pamh=NULL;/*StartPAM.*/ret=pam
_start(FRR_PAM_NAME,user,&conv,&pamh);/*printf("ret%d\n",ret);*//*Isuserreallyus
er?*/if(ret==PAM_SUCCESS)ret=pam_authenticate(pamh,0);/*printf("ret%d\n",ret);*/
#if0/*Permittedaccess?*/if(ret==PAM_SUCCESS)ret=pam_acct_mgmt(pamh,0);printf("re
t%d\n",ret);if(ret==PAM_AUTHINFO_UNAVAIL)ret=PAM_SUCCESS;#endif/*0*//*Thisiswher
ewehavebeenauthorizedornot.*/#ifdefDEBUGif(ret==PAM_SUCCESS)printf("Authenticate
d\n");elseprintf("NotAuthenticated\n");#endif/*DEBUG*//*closeLinux-PAM*/if(pam_e
nd(pamh,ret)!=PAM_SUCCESS){pamh=NULL;fprintf(stderr,"vtysh_pam:failedtoreleaseau
thenticator\n");exit(1);}returnret==PAM_SUCCESS?0:1;}#endif/*USE_PAM*/structvtys
h_user{char*name;uint8_tnopassword;};structlist*userlist;staticstructvtysh_user*
user_new(void){returnXCALLOC(MTYPE_TMP,sizeof(structvtysh_user));}staticstructvt
ysh_user*user_lookup(constchar*name){structlistnode*node,*nnode;structvtysh_user
*user;for(ALL_LIST_ELEMENTS(userlist,node,nnode,user)){if(strcmp(user->name,name
)==0)returnuser;}returnNULL;}voiduser_config_write(){structlistnode*node,*nnode;
structvtysh_user*user;charline[128];for(ALL_LIST_ELEMENTS(userlist,node,nnode,us
er)){if(user->nopassword){sprintf(line,"username%snopassword",user->name);config
_add_line(config_top,line);}}}staticstructvtysh_user*user_get(constchar*name){st
ructvtysh_user*user;user=user_lookup(name);if(user)returnuser;user=user_new();us
er->name=strdup(name);listnode_add(userlist,user);returnuser;}DEFUN(vtysh_banner
_motd_file,vtysh_banner_motd_file_cmd,"bannermotdfileFILE","Setbanner\n""Bannerf
ormotd\n""Bannerfromafile\n""Filename\n"){intidx_file=3;returncmd_banner_motd_fi
le(argv[idx_file]->arg);}DEFUN(username_nopassword,username_nopassword_cmd,"user
nameWORDnopassword","\n""\n""\n"){intidx_word=1;structvtysh_user*user;user=user_
get(argv[idx_word]->arg);user->nopassword=1;returnCMD_SUCCESS;}intvtysh_auth(voi
d){structvtysh_user*user;structpasswd*passwd;if((passwd=getpwuid(geteuid()))==NU
LL){fprintf(stderr,"couldnotlookupuserID%d\n",(int)geteuid());exit(1);}user=user
_lookup(passwd->pw_name);if(user&&user->nopassword)/*Passthrough*/;else{#ifdefUS
E_PAMif(vtysh_pam(passwd->pw_name))exit(0);#endif/*USE_PAM*/}return0;}char*vtysh
_get_home(void){structpasswd*passwd;char*homedir;if((homedir=getenv("HOME"))!=0)
returnhomedir;/*FallbackifHOMEisundefined*/passwd=getpwuid(getuid());returnpassw
d?passwd->pw_dir:NULL;}voidvtysh_user_init(void){userlist=list_new();install_ele
ment(CONFIG_NODE,&username_nopassword_cmd);install_element(CONFIG_NODE,&vtysh_ba
nner_motd_file_cmd);}