/*Virtualterminalinterfaceshell.*Copyright(C)2000KunihiroIshiguro**Thisfileispar
tofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthe
termsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherv
ersion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitw
illbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILI
TYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**
YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seet
hefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFlo
or,Boston,MA02110-1301USA*/#include<zebra.h>#include<sys/un.h>#include<setjmp.h>
#include<sys/wait.h>#include<pwd.h>#include<sys/file.h>#include<unistd.h>#includ
e<readline/readline.h>#include<readline/history.h>#include<lib/version.h>#includ
e"getopt.h"#include"command.h"#include"memory.h"#include"linklist.h"#include"mem
ory_vty.h"#include"libfrr.h"#include"vtysh/vtysh.h"#include"vtysh/vtysh_user.h"/
*VTYshellprogramname.*/char*progname;/*SUIDmode*/staticuid_televuid,realuid;stat
icgid_televgid,realgid;#defineVTYSH_CONFIG_NAME"vtysh.conf"#defineFRR_CONFIG_NAM
E"frr.conf"/*Configurationfilenameanddirectory.*/staticcharvtysh_config[MAXPATHL
EN];charfrr_config[MAXPATHLEN];charvtydir[MAXPATHLEN];staticcharhistory_file[MAX
PATHLEN];/*Flagforindicateexecutingchildcommand.*/intexecute_flag=0;/*Forsigsetj
mp()&siglongjmp().*/staticsigjmp_bufjmpbuf;/*Flagforavoidrecursivesiglongjmp()ca
ll.*/staticintjmpflag=0;/*Astaticvariableforholdingtheline.*/staticchar*line_rea
d;/*Masterofthreads.*/structthread_master*master;/*Commandlogging*/FILE*logfile;
/*SIGTSTPhandler.Thisfunctioncareuser's^Zinput.*/staticvoidsigtstp(intsig){/*Exe
cute"end"command.*/vtysh_execute("end");/*Initializereadline.*/rl_initialize();p
rintf("\n");/*Checkjmpflagforduplicatesiglongjmp().*/if(!jmpflag)return;jmpflag=
0;/*Backtomaincommandloop.*/siglongjmp(jmpbuf,1);}/*SIGINThandler.Thisfunctionca
reuser's^Zinput.*/staticvoidsigint(intsig){/*Checkthisprocessisnotchildprocess.*
/if(!execute_flag){rl_initialize();printf("\n");rl_forced_update_display();}}/*S
ignalewrapperforvtysh.Wedon'tusesigeventbecause*vtyshdoesn'tusethreads.TODO*/sta
ticvoidvtysh_signal_set(intsigno,void(*func)(int)){structsigactionsig;structsiga
ctionosig;sig.sa_handler=func;sigemptyset(&sig.sa_mask);sig.sa_flags=0;#ifdefSA_
RESTARTsig.sa_flags|=SA_RESTART;#endif/*SA_RESTART*/sigaction(signo,&sig,&osig);
}/*Initializationofsignalhandles.*/staticvoidvtysh_signal_init(void){vtysh_signa
l_set(SIGINT,sigint);vtysh_signal_set(SIGTSTP,sigtstp);vtysh_signal_set(SIGPIPE,
SIG_IGN);}/*Helpinformationdisplay.*/staticvoidusage(intstatus){if(status!=0)fpr
intf(stderr,"Try`%s--help'formoreinformation.\n",progname);elseprintf("Usage:%s[
OPTION...]\n\n""IntegratedshellforFRR.\n\n""-b,--bootExecutebootstartupconfigura
tion\n""-c,--commandExecuteargumentascommand\n""-d,--daemonConnectonlytothespeci
fieddaemon\n""-f,--inputfileExecutecommandsfromspecificfileandexit\n""-E,--echoE
chopromptandcommandin-cmode\n""-C,--dryrunCheckconfigurationforvalidityandexit\n
""-m,--markfileMarkinputfilewithcontextend\n""--vty_socketOverridevtysocketpath\
n""--config_dirOverrideconfigdirectorypath\n""-N--pathspaceInsertprefixintoconfi
g&socketpaths\n""-w,--writeconfigWriteintegratedconfig(frr.conf)andexit\n""-h,--
helpDisplaythishelpandexit\n\n""Notethatmultiplecommandsmaybeexecutedfromthecomm
and\n""linebypassingmultiple-cargs,orbyembeddinglinefeed\n""charactersinoneormor
eofthecommands.\n\n""Reportbugsto%s\n",progname,FRR_BUG_ADDRESS);exit(status);}/
*VTYshelloptions,weuseGNUgetoptlibrary.*/#defineOPTION_VTYSOCK1000#defineOPTION_
CONFDIR1001structoptionlongopts[]={{"boot",no_argument,NULL,'b'},/*Forcompatibil
itywitholderzebra/quaggaversions*/{"eval",required_argument,NULL,'e'},{"command"
,required_argument,NULL,'c'},{"daemon",required_argument,NULL,'d'},{"vty_socket"
,required_argument,NULL,OPTION_VTYSOCK},{"config_dir",required_argument,NULL,OPT
ION_CONFDIR},{"inputfile",required_argument,NULL,'f'},{"echo",no_argument,NULL,'
E'},{"dryrun",no_argument,NULL,'C'},{"help",no_argument,NULL,'h'},{"noerror",no_
argument,NULL,'n'},{"mark",no_argument,NULL,'m'},{"writeconfig",no_argument,NULL
,'w'},{"pathspace",required_argument,NULL,'N'},{0}};/*Readastring,andreturnapoin
tertoit.ReturnsNULLonEOF.*/staticchar*vtysh_rl_gets(void){HIST_ENTRY*last;/*Ifth
ebufferhasalreadybeenallocated,returnthememory*tothefreepool.*/if(line_read){fre
e(line_read);line_read=NULL;}/*Getalinefromtheuser.Changepromptaccordingtonode.X
XX.*/line_read=readline(vtysh_prompt());/*Ifthelinehasanytextinit,saveitonthehis
tory.Butonlyif*lastcommandinhistoryisn'tthesameone.*/if(line_read&&*line_read){u
sing_history();last=previous_history();if(!last||strcmp(last->line,line_read)!=0
){add_history(line_read);append_history(1,history_file);}}return(line_read);}sta
ticvoidlog_it(constchar*line){time_tt=time(NULL);structtm*tmp=localtime(&t);cons
tchar*user=getenv("USER");chartod[64];if(!user)user="boot";strftime(tod,sizeofto
d,"%Y%m%d-%H:%M.%S",tmp);fprintf(logfile,"%s:%s%s\n",tod,user,line);}staticintfl
ock_fd;staticvoidvtysh_flock_config(constchar*flock_file){intcount=0;flock_fd=op
en(flock_file,O_RDONLY,0644);if(flock_fd<0){fprintf(stderr,"Unabletocreatelockfi
le:%s,%s\n",flock_file,safe_strerror(errno));return;}while(count<400&&(flock(flo
ck_fd,LOCK_EX|LOCK_NB)<0)){count++;usleep(500000);}if(count>=400)fprintf(stderr,
"Flockof%sfailed,continuingthismaycauseissues\n",flock_file);}staticvoidvtysh_un
flock_config(void){flock(flock_fd,LOCK_UN);close(flock_fd);}voidsuid_on(void){if
(elevuid!=realuid&&seteuid(elevuid)){perror("seteuid(on)");exit(1);}if(elevgid!=
realgid&&setegid(elevgid)){perror("setegid(on)");exit(1);}}voidsuid_off(void){if
(elevuid!=realuid&&seteuid(realuid)){perror("seteuid(off)");exit(1);}if(elevgid!
=realgid&&setegid(realgid)){perror("setegid(off)");exit(1);}}/*VTYshellmainrouti
ne.*/intmain(intargc,char**argv,char**env){char*p;intopt;intdryrun=0;intboot_fla
g=0;constchar*daemon_name=NULL;constchar*inputfile=NULL;structcmd_rec{char*line;
structcmd_rec*next;}*cmd=NULL;structcmd_rec*tail=NULL;intecho_command=0;intno_er
ror=0;intmarkfile=0;intwriteconfig=0;intret=0;char*homedir=NULL;intditch_suid=0;
charsysconfdir[MAXPATHLEN];charpathspace[MAXPATHLEN]="";/*SUID:dropdowntocalling
user&gobackupwhenneeded*/elevuid=geteuid();elevgid=getegid();realuid=getuid();re
algid=getgid();suid_off();/*Preservenameofmyself.*/progname=((p=strrchr(argv[0],
'/'))?++p:argv[0]);strlcpy(sysconfdir,frr_sysconfdir,sizeof(sysconfdir));strlcpy
(vtydir,frr_vtydir,sizeof(vtydir));/*Optionhandling.*/while(1){opt=getopt_long(a
rgc,argv,"be:c:d:nf:mEhCwN:",longopts,0);if(opt==EOF)break;switch(opt){case0:bre
ak;case'b':boot_flag=1;break;case'e':case'c':{structcmd_rec*cr;cr=XMALLOC(MTYPE_
TMP,sizeof(*cr));cr->line=optarg;cr->next=NULL;if(tail)tail->next=cr;elsecmd=cr;
tail=cr;}break;caseOPTION_VTYSOCK:ditch_suid=1;/*optiondisablesSUID*/strlcpy(vty
dir,optarg,sizeof(vtydir));break;caseOPTION_CONFDIR:ditch_suid=1;/*optiondisable
sSUID*/strlcpy(sysconfdir,optarg,sizeof(sysconfdir));break;case'N':if(strchr(opt
arg,'/')||strchr(optarg,'.')){fprintf(stderr,"slashesordotsarenotpermittedinthe-
-pathspaceoption.\n");exit(1);}snprintf(pathspace,sizeof(pathspace),"/%s",optarg
);break;case'd':daemon_name=optarg;break;case'f':inputfile=optarg;break;case'm':
markfile=1;break;case'n':no_error=1;break;case'E':echo_command=1;break;case'C':d
ryrun=1;break;case'w':writeconfig=1;break;case'h':usage(0);break;default:usage(1
);break;}}if(ditch_suid){elevuid=realuid;elevgid=realgid;}if(markfile+writeconfi
g+dryrun+boot_flag>1){fprintf(stderr,"Invalidcombinationofarguments.Pleasespecif
yat""mostoneof:\n\t-b,-C,-m,-w\n");return1;}if(inputfile&&(writeconfig||boot_fla
g)){fprintf(stderr,"WARNING:Combininingthe-foptionwith-bor-wis""NOTSUPPORTEDsinc
eits\nresultsareinconsistent!\n");}snprintf(vtysh_config,sizeof(vtysh_config),"%
s%s%s",sysconfdir,pathspace,VTYSH_CONFIG_NAME);snprintf(frr_config,sizeof(frr_co
nfig),"%s%s%s",sysconfdir,pathspace,FRR_CONFIG_NAME);strlcat(vtydir,pathspace,si
zeof(vtydir));/*Initializeuserinputbuffer.*/line_read=NULL;setlinebuf(stdout);/*
Signalandothers.*/vtysh_signal_init();/*Makevtystructureandregistercommands.*/vt
ysh_init_vty();vtysh_init_cmd();vtysh_user_init();vtysh_config_init();vty_init_v
tysh();/*Readvtyshconfigurationfilebeforeconnectingtodaemons.*(filemaynotbereada
bletocallinguserinSUIDmode)*/suid_on();vtysh_read_config(vtysh_config);suid_off(
);if(markfile){if(!inputfile){fprintf(stderr,"-foptionMUSTbespecifiedwith-moptio
n\n");return(1);}return(vtysh_mark_file(inputfile));}/*Startexecutiononlyifnotin
dry-runmode*/if(dryrun&&!cmd){if(inputfile){ret=vtysh_read_config(inputfile);}el
se{ret=vtysh_read_config(frr_config);}exit(ret);}if(dryrun&&cmd&&cmd->line){vtys
h_execute("enable");while(cmd){structcmd_rec*cr;char*cmdnow=cmd->line,*next;do{n
ext=strchr(cmdnow,'\n');if(next)*next++='\0';if(echo_command)printf("%s%s\n",vty
sh_prompt(),cmdnow);ret=vtysh_execute_no_pager(cmdnow);if(!no_error&&!(ret==CMD_
SUCCESS||ret==CMD_SUCCESS_DAEMON||ret==CMD_WARNING))exit(1);}while((cmdnow=next)
!=NULL);cr=cmd;cmd=cmd->next;XFREE(MTYPE_TMP,cr);}exit(ret);}/*Ignoreerrormessag
es*/if(no_error){if(freopen("/dev/null","w",stdout)==NULL){fprintf(stderr,"Exiti
ng:Failedtoduplicatestdoutwith-noption");exit(1);}}/*SUID:gobackupelevatedprivs*
/suid_on();/*Makesurewepassauthenticationbeforeproceeding.*/vtysh_auth();/*Donot
connectuntilwehavepassedauthentication.*/if(vtysh_connect_all(daemon_name)<=0){f
printf(stderr,"Exiting:failedtoconnecttoanydaemons.\n");if(no_error)exit(0);else
exit(1);}/*SUID:backdown,don'tneedprivsfurtheron*/suid_off();if(writeconfig){vty
sh_execute("enable");returnvtysh_write_config_integrated();}if(inputfile){vtysh_
flock_config(inputfile);ret=vtysh_read_config(inputfile);vtysh_unflock_config();
exit(ret);}/**Setuphistoryfileforusebyboth-candregularinput*Ifwecan'tfindthehome
directory,thendon'tstore*thehistoryinformation*/homedir=vtysh_get_home();if(home
dir){snprintf(history_file,sizeof(history_file),"%s/.history_frr",homedir);if(re
ad_history(history_file)!=0){intfp;fp=open(history_file,O_CREAT|O_EXCL,S_IRUSR|S
_IWUSR);if(fp!=-1)close(fp);read_history(history_file);}}if(getenv("VTYSH_LOG"))
{constchar*logpath=getenv("VTYSH_LOG");logfile=fopen(logpath,"a");if(!logfile){f
printf(stderr,"Failedtoopenlogfile(%s):%s\n",logpath,strerror(errno));exit(1);}}
/*Ifevalmode.*/if(cmd&&cmd->line){/*Enterintoenablenode.*/vtysh_execute("enable"
);while(cmd!=NULL){intret;char*eol;while((eol=strchr(cmd->line,'\n'))!=NULL){*eo
l='\0';add_history(cmd->line);append_history(1,history_file);if(echo_command)pri
ntf("%s%s\n",vtysh_prompt(),cmd->line);if(logfile)log_it(cmd->line);ret=vtysh_ex
ecute_no_pager(cmd->line);if(!no_error&&!(ret==CMD_SUCCESS||ret==CMD_SUCCESS_DAE
MON||ret==CMD_WARNING))exit(1);cmd->line=eol+1;}add_history(cmd->line);append_hi
story(1,history_file);if(echo_command)printf("%s%s\n",vtysh_prompt(),cmd->line);
if(logfile)log_it(cmd->line);ret=vtysh_execute_no_pager(cmd->line);if(!no_error&
&!(ret==CMD_SUCCESS||ret==CMD_SUCCESS_DAEMON||ret==CMD_WARNING))exit(1);{structc
md_rec*cr;cr=cmd;cmd=cmd->next;XFREE(MTYPE_TMP,cr);}}history_truncate_file(histo
ry_file,1000);exit(0);}/*Bootstartupconfigurationfile.*/if(boot_flag){vtysh_floc
k_config(frr_config);intret=vtysh_read_config(frr_config);vtysh_unflock_config()
;if(ret){fprintf(stderr,"Configurationfile[%s]processingfailure:%d\n",frr_config
,ret);if(no_error)exit(0);elseexit(ret);}elseexit(0);}vtysh_pager_init();vtysh_r
eadline_init();vty_hello(vty);/*Enterintoenablenode.*/vtysh_execute("enable");/*
Preparationforlongjmp()insigtstp().*/sigsetjmp(jmpbuf,1);jmpflag=1;/*Maincommand
loop.*/while(vtysh_rl_gets())vtysh_execute(line_read);vtysh_uninit();history_tru
ncate_file(history_file,1000);printf("\n");/*Restinpeace.*/exit(0);}