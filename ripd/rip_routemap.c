/*RIPv2routemap.*Copyright(C)20056WIND<alain.ritoux@6wind.com>*Copyright(C)1999K
unihiroIshiguro<kunihiro@zebra.org>**ThisfileispartofGNUZebra.**GNUZebraisfreeso
ftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLice
nseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*la
terversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARR
ANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPO
SE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyofth
eGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetothe
FreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#in
clude<zebra.h>#include"memory.h"#include"prefix.h"#include"vty.h"#include"routem
ap.h"#include"command.h"#include"filter.h"#include"log.h"#include"sockunion.h"/*
forinet_aton()*/#include"plist.h"#include"vrf.h"#include"ripd/ripd.h"structrip_m
etric_modifier{enum{metric_increment,metric_decrement,metric_absolute}type;boolu
sed;uint8_tmetric;};/*Hookfunctionforupdatingroute_mapassignment.*//*ARGSUSED*/s
taticvoidrip_route_map_update(constchar*notused){inti;if(rip){for(i=0;i<ZEBRA_RO
UTE_MAX;i++){if(rip->route_map[i].name)rip->route_map[i].map=route_map_lookup_by
_name(rip->route_map[i].name);}}}/*`matchmetricMETRIC'*//*Matchfunctionreturn1if
matchissuccesselsereturnzero.*/staticroute_map_result_troute_match_metric(void*r
ule,structprefix*prefix,route_map_object_ttype,void*object){uint32_t*metric;uint
32_tcheck;structrip_info*rinfo;if(type==RMAP_RIP){metric=rule;rinfo=object;/*Ife
xternalmetricisavailable,theroute-mapshouldworkonthisone(forredistributepurpose)
*/check=(rinfo->external_metric)?rinfo->external_metric:rinfo->metric;if(check==
*metric)returnRMAP_MATCH;elsereturnRMAP_NOMATCH;}returnRMAP_NOMATCH;}/*Routemap`
matchmetric'matchstatement.`arg'isMETRICvalue*/staticvoid*route_match_metric_com
pile(constchar*arg){uint32_t*metric;metric=XMALLOC(MTYPE_ROUTE_MAP_COMPILED,size
of(uint32_t));*metric=atoi(arg);if(*metric>0)returnmetric;XFREE(MTYPE_ROUTE_MAP_
COMPILED,metric);returnNULL;}/*Freeroutemap'scompiled`matchmetric'value.*/static
voidroute_match_metric_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*R
outemapcommandsformetricmatching.*/structroute_map_rule_cmdroute_match_metric_cm
d={"metric",route_match_metric,route_match_metric_compile,route_match_metric_fre
e};/*`matchinterfaceIFNAME'*//*Matchfunctionreturn1ifmatchissuccesselsereturnzer
o.*/staticroute_map_result_troute_match_interface(void*rule,structprefix*prefix,
route_map_object_ttype,void*object){structrip_info*rinfo;structinterface*ifp;cha
r*ifname;if(type==RMAP_RIP){ifname=rule;ifp=if_lookup_by_name(ifname,VRF_DEFAULT
);if(!ifp)returnRMAP_NOMATCH;rinfo=object;if(rinfo->ifindex_out==ifp->ifindex||r
info->nh.ifindex==ifp->ifindex)returnRMAP_MATCH;elsereturnRMAP_NOMATCH;}returnRM
AP_NOMATCH;}/*Routemap`matchinterface'matchstatement.`arg'isIFNAMEvalue*//*XXXId
on`tknowifIneedtocheckdoesinterfaceexist?*/staticvoid*route_match_interface_comp
ile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}/*Freeroutemap's
compiled`matchinterface'value.*/staticvoidroute_match_interface_free(void*rule){
XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routemapcommandsforinterfacematching.*/s
tructroute_map_rule_cmdroute_match_interface_cmd={"interface",route_match_interf
ace,route_match_interface_compile,route_match_interface_free};/*`matchipnext-hop
IP_ACCESS_LIST'*//*Matchfunctionreturn1ifmatchissuccesselsereturnzero.*/staticro
ute_map_result_troute_match_ip_next_hop(void*rule,structprefix*prefix,route_map_
object_ttype,void*object){structaccess_list*alist;structrip_info*rinfo;structpre
fix_ipv4p;if(type==RMAP_RIP){rinfo=object;p.family=AF_INET;p.prefix=(rinfo->nh.g
ate.ipv4.s_addr)?rinfo->nh.gate.ipv4:rinfo->from;p.prefixlen=IPV4_MAX_BITLEN;ali
st=access_list_lookup(AFI_IP,(char*)rule);if(alist==NULL)returnRMAP_NOMATCH;retu
rn(access_list_apply(alist,&p)==FILTER_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP
_NOMATCH;}/*Routemap`ipnext-hop'matchstatement.`arg'shouldbeaccess-listname.*/st
aticvoid*route_match_ip_next_hop_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUT
E_MAP_COMPILED,arg);}/*Freeroutemap'scompiled`.*/staticvoidroute_match_ip_next_h
op_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routemapcommandsforip
next-hopmatching.*/staticstructroute_map_rule_cmdroute_match_ip_next_hop_cmd={"i
pnext-hop",route_match_ip_next_hop,route_match_ip_next_hop_compile,route_match_i
p_next_hop_free};/*`matchipnext-hopprefix-listPREFIX_LIST'*/staticroute_map_resu
lt_troute_match_ip_next_hop_prefix_list(void*rule,structprefix*prefix,route_map_
object_ttype,void*object){structprefix_list*plist;structrip_info*rinfo;structpre
fix_ipv4p;if(type==RMAP_RIP){rinfo=object;p.family=AF_INET;p.prefix=(rinfo->nh.g
ate.ipv4.s_addr)?rinfo->nh.gate.ipv4:rinfo->from;p.prefixlen=IPV4_MAX_BITLEN;pli
st=prefix_list_lookup(AFI_IP,(char*)rule);if(plist==NULL)returnRMAP_NOMATCH;retu
rn(prefix_list_apply(plist,&p)==PREFIX_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP
_NOMATCH;}staticvoid*route_match_ip_next_hop_prefix_list_compile(constchar*arg){
returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}staticvoidroute_match_ip_next_hop_p
refix_list_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructrou
te_map_rule_cmdroute_match_ip_next_hop_prefix_list_cmd={"ipnext-hopprefix-list",
route_match_ip_next_hop_prefix_list,route_match_ip_next_hop_prefix_list_compile,
route_match_ip_next_hop_prefix_list_free};/*`matchipaddressIP_ACCESS_LIST'*//*Ma
tchfunctionshouldreturn1ifmatchissuccesselsereturnzero.*/staticroute_map_result_
troute_match_ip_address(void*rule,structprefix*prefix,route_map_object_ttype,voi
d*object){structaccess_list*alist;if(type==RMAP_RIP){alist=access_list_lookup(AF
I_IP,(char*)rule);if(alist==NULL)returnRMAP_NOMATCH;return(access_list_apply(ali
st,prefix)==FILTER_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}/*Routemap
`ipaddress'matchstatement.`arg'shouldbeaccess-listname.*/staticvoid*route_match_
ip_address_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}/
*Freeroutemap'scompiled`ipaddress'value.*/staticvoidroute_match_ip_address_free(
void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routemapcommandsforipaddressm
atching.*/staticstructroute_map_rule_cmdroute_match_ip_address_cmd={"ipaddress",
route_match_ip_address,route_match_ip_address_compile,route_match_ip_address_fre
e};/*`matchipaddressprefix-listPREFIX_LIST'*/staticroute_map_result_troute_match
_ip_address_prefix_list(void*rule,structprefix*prefix,route_map_object_ttype,voi
d*object){structprefix_list*plist;if(type==RMAP_RIP){plist=prefix_list_lookup(AF
I_IP,(char*)rule);if(plist==NULL)returnRMAP_NOMATCH;return(prefix_list_apply(pli
st,prefix)==PREFIX_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}staticvoid
*route_match_ip_address_prefix_list_compile(constchar*arg){returnXSTRDUP(MTYPE_R
OUTE_MAP_COMPILED,arg);}staticvoidroute_match_ip_address_prefix_list_free(void*r
ule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructroute_map_rule_cmdroute_m
atch_ip_address_prefix_list_cmd={"ipaddressprefix-list",route_match_ip_address_p
refix_list,route_match_ip_address_prefix_list_compile,route_match_ip_address_pre
fix_list_free};/*`matchtagTAG'*//*Matchfunctionreturn1ifmatchissuccesselsereturn
zero.*/staticroute_map_result_troute_match_tag(void*rule,structprefix*prefix,rou
te_map_object_ttype,void*object){route_tag_t*tag;structrip_info*rinfo;route_tag_
trinfo_tag;if(type==RMAP_RIP){tag=rule;rinfo=object;/*Theinformationstoredbyrinf
oishostordered.*/rinfo_tag=rinfo->tag;if(rinfo_tag==*tag)returnRMAP_MATCH;elsere
turnRMAP_NOMATCH;}returnRMAP_NOMATCH;}/*Routemapcommandsfortagmatching.*/statics
tructroute_map_rule_cmdroute_match_tag_cmd={"tag",route_match_tag,route_map_rule
_tag_compile,route_map_rule_tag_free,};/*`setmetricMETRIC'*//*Setmetrictoattribu
te.*/staticroute_map_result_troute_set_metric(void*rule,structprefix*prefix,rout
e_map_object_ttype,void*object){if(type==RMAP_RIP){structrip_metric_modifier*mod
;structrip_info*rinfo;mod=rule;rinfo=object;if(!mod->used)returnRMAP_OKAY;if(mod
->type==metric_increment)rinfo->metric_out+=mod->metric;elseif(mod->type==metric
_decrement)rinfo->metric_out-=mod->metric;elseif(mod->type==metric_absolute)rinf
o->metric_out=mod->metric;if((signedint)rinfo->metric_out<1)rinfo->metric_out=1;
if(rinfo->metric_out>RIP_METRIC_INFINITY)rinfo->metric_out=RIP_METRIC_INFINITY;r
info->metric_set=1;}returnRMAP_OKAY;}/*setmetriccompilation.*/staticvoid*route_s
et_metric_compile(constchar*arg){intlen;constchar*pnt;longmetric;char*endptr=NUL
L;structrip_metric_modifier*mod;mod=XMALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(stru
ctrip_metric_modifier));mod->used=false;len=strlen(arg);pnt=arg;if(len==0)return
mod;/*Examinefirstcharacter.*/if(arg[0]=='+'){mod->type=metric_increment;pnt++;}
elseif(arg[0]=='-'){mod->type=metric_decrement;pnt++;}elsemod->type=metric_absol
ute;/*Checkbeginningwithdigitstring.*/if(*pnt<'0'||*pnt>'9')returnmod;/*Converts
tringtointeger.*/metric=strtol(pnt,&endptr,10);if(*endptr!='\0'||metric<0){retur
nmod;}if(metric>RIP_METRIC_INFINITY){zlog_info("%s:Metricspecified:%ldisgreatert
hanRIP_METRIC_INFINITY,usingINFINITYinstead",__PRETTY_FUNCTION__,metric);mod->me
tric=RIP_METRIC_INFINITY;}elsemod->metric=metric;mod->used=true;returnmod;}/*Fre
eroutemap'scompiled`setmetric'value.*/staticvoidroute_set_metric_free(void*rule)
{XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Setmetricrulestructure.*/staticstructro
ute_map_rule_cmdroute_set_metric_cmd={"metric",route_set_metric,route_set_metric
_compile,route_set_metric_free,};/*`setipnext-hopIP_ADDRESS'*//*Setnexthoptoobje
ct.ojbectmustbepointertostructattr.*/staticroute_map_result_troute_set_ip_nextho
p(void*rule,structprefix*prefix,route_map_object_ttype,void*object){structin_add
r*address;structrip_info*rinfo;if(type==RMAP_RIP){/*Fetchroutemap'sruleinformati
on.*/address=rule;rinfo=object;/*Setnexthopvalue.*/rinfo->nexthop_out=*address;}
returnRMAP_OKAY;}/*Routemap`ipnexthop'compilefunction.Givenstringisconvertedtost
ructin_addrstructure.*/staticvoid*route_set_ip_nexthop_compile(constchar*arg){in
tret;structin_addr*address;address=XMALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(struc
tin_addr));ret=inet_aton(arg,address);if(ret==0){XFREE(MTYPE_ROUTE_MAP_COMPILED,
address);returnNULL;}returnaddress;}/*Freeroutemap'scompiled`ipnexthop'value.*/s
taticvoidroute_set_ip_nexthop_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rul
e);}/*Routemapcommandsforipnexthopset.*/staticstructroute_map_rule_cmdroute_set_
ip_nexthop_cmd={"ipnext-hop",route_set_ip_nexthop,route_set_ip_nexthop_compile,r
oute_set_ip_nexthop_free};/*`settagTAG'*//*Settagtoobject.ojbectmustbepointertos
tructattr.*/staticroute_map_result_troute_set_tag(void*rule,structprefix*prefix,
route_map_object_ttype,void*object){route_tag_t*tag;structrip_info*rinfo;if(type
==RMAP_RIP){/*Fetchroutemap'sruleinformation.*/tag=rule;rinfo=object;/*Setnextho
pvalue.*/rinfo->tag_out=*tag;}returnRMAP_OKAY;}/*Routemapcommandsfortagset.*/sta
ticstructroute_map_rule_cmdroute_set_tag_cmd={"tag",route_set_tag,route_map_rule
_tag_compile,route_map_rule_tag_free};#defineMATCH_STR"Matchvaluesfromroutingtab
le\n"#defineSET_STR"Setvaluesindestinationroutingprotocol\n"voidrip_route_map_re
set(){;}/*Route-mapinit*/voidrip_route_map_init(){route_map_init();route_map_add
_hook(rip_route_map_update);route_map_delete_hook(rip_route_map_update);route_ma
p_match_interface_hook(generic_match_add);route_map_no_match_interface_hook(gene
ric_match_delete);route_map_match_ip_address_hook(generic_match_add);route_map_n
o_match_ip_address_hook(generic_match_delete);route_map_match_ip_address_prefix_
list_hook(generic_match_add);route_map_no_match_ip_address_prefix_list_hook(gene
ric_match_delete);route_map_match_ip_next_hop_hook(generic_match_add);route_map_
no_match_ip_next_hop_hook(generic_match_delete);route_map_match_ip_next_hop_pref
ix_list_hook(generic_match_add);route_map_no_match_ip_next_hop_prefix_list_hook(
generic_match_delete);route_map_match_metric_hook(generic_match_add);route_map_n
o_match_metric_hook(generic_match_delete);route_map_match_tag_hook(generic_match
_add);route_map_no_match_tag_hook(generic_match_delete);route_map_set_ip_nexthop
_hook(generic_set_add);route_map_no_set_ip_nexthop_hook(generic_set_delete);rout
e_map_set_metric_hook(generic_set_add);route_map_no_set_metric_hook(generic_set_
delete);route_map_set_tag_hook(generic_set_add);route_map_no_set_tag_hook(generi
c_set_delete);route_map_install_match(&route_match_metric_cmd);route_map_install
_match(&route_match_interface_cmd);route_map_install_match(&route_match_ip_next_
hop_cmd);route_map_install_match(&route_match_ip_next_hop_prefix_list_cmd);route
_map_install_match(&route_match_ip_address_cmd);route_map_install_match(&route_m
atch_ip_address_prefix_list_cmd);route_map_install_match(&route_match_tag_cmd);r
oute_map_install_set(&route_set_metric_cmd);route_map_install_set(&route_set_ip_
nexthop_cmd);route_map_install_set(&route_set_tag_cmd);}