/*RIPpeersupport*Copyright(C)2000KunihiroIshiguro<kunihiro@zebra.org>**Thisfilei
spartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*unde
rthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eit
herversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopetha
titwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTA
BILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetail
s.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;
seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fift
hFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"if.h"#include"prefix.h"
#include"command.h"#include"linklist.h"#include"thread.h"#include"memory.h"#incl
ude"ripd/ripd.h"/*LinkedlistofRIPpeer.*/structlist*peer_list;staticstructrip_pee
r*rip_peer_new(void){returnXCALLOC(MTYPE_RIP_PEER,sizeof(structrip_peer));}stati
cvoidrip_peer_free(structrip_peer*peer){XFREE(MTYPE_RIP_PEER,peer);}structrip_pe
er*rip_peer_lookup(structin_addr*addr){structrip_peer*peer;structlistnode*node,*
nnode;for(ALL_LIST_ELEMENTS(peer_list,node,nnode,peer)){if(IPV4_ADDR_SAME(&peer-
>addr,addr))returnpeer;}returnNULL;}structrip_peer*rip_peer_lookup_next(structin
_addr*addr){structrip_peer*peer;structlistnode*node,*nnode;for(ALL_LIST_ELEMENTS
(peer_list,node,nnode,peer)){if(htonl(peer->addr.s_addr)>htonl(addr->s_addr))ret
urnpeer;}returnNULL;}/*RIPpeeristimeout.*/staticintrip_peer_timeout(structthread
*t){structrip_peer*peer;peer=THREAD_ARG(t);listnode_delete(peer_list,peer);rip_p
eer_free(peer);return0;}/*GetRIPpeer.Atthesametimeupdatetimeoutthread.*/staticst
ructrip_peer*rip_peer_get(structin_addr*addr){structrip_peer*peer;peer=rip_peer_
lookup(addr);if(peer){if(peer->t_timeout)thread_cancel(peer->t_timeout);}else{pe
er=rip_peer_new();peer->addr=*addr;listnode_add_sort(peer_list,peer);}/*Updateti
meoutthread.*/peer->t_timeout=NULL;thread_add_timer(master,rip_peer_timeout,peer
,RIP_PEER_TIMER_DEFAULT,&peer->t_timeout);/*Lastupdatetimeset.*/time(&peer->upti
me);returnpeer;}voidrip_peer_update(structsockaddr_in*from,uint8_tversion){struc
trip_peer*peer;peer=rip_peer_get(&from->sin_addr);peer->version=version;}voidrip
_peer_bad_route(structsockaddr_in*from){structrip_peer*peer;peer=rip_peer_get(&f
rom->sin_addr);peer->recv_badroutes++;}voidrip_peer_bad_packet(structsockaddr_in
*from){structrip_peer*peer;peer=rip_peer_get(&from->sin_addr);peer->recv_badpack
ets++;}/*Displaypeeruptime.*/staticchar*rip_peer_uptime(structrip_peer*peer,char
*buf,size_tlen){time_tuptime;structtm*tm;/*Ifthereisnoconnectionhasbeendonebefor
eprint`never'.*/if(peer->uptime==0){snprintf(buf,len,"never");returnbuf;}/*Getcu
rrenttime.*/uptime=time(NULL);uptime-=peer->uptime;tm=gmtime(&uptime);if(uptime<
ONE_DAY_SECOND)snprintf(buf,len,"%02d:%02d:%02d",tm->tm_hour,tm->tm_min,tm->tm_s
ec);elseif(uptime<ONE_WEEK_SECOND)snprintf(buf,len,"%dd%02dh%02dm",tm->tm_yday,t
m->tm_hour,tm->tm_min);elsesnprintf(buf,len,"%02dw%dd%02dh",tm->tm_yday/7,tm->tm
_yday-((tm->tm_yday/7)*7),tm->tm_hour);returnbuf;}voidrip_peer_display(structvty
*vty){structrip_peer*peer;structlistnode*node,*nnode;#defineRIP_UPTIME_LEN25char
timebuf[RIP_UPTIME_LEN];for(ALL_LIST_ELEMENTS(peer_list,node,nnode,peer)){vty_ou
t(vty,"%-16s%9d%9d%9d%s\n",inet_ntoa(peer->addr),peer->recv_badpackets,peer->rec
v_badroutes,ZEBRA_RIP_DISTANCE_DEFAULT,rip_peer_uptime(peer,timebuf,RIP_UPTIME_L
EN));}}staticintrip_peer_list_cmp(structrip_peer*p1,structrip_peer*p2){returnhto
nl(p1->addr.s_addr)>htonl(p2->addr.s_addr);}voidrip_peer_init(void){peer_list=li
st_new();peer_list->cmp=(int(*)(void*,void*))rip_peer_list_cmp;}