/*RIPdandzebrainterface.*Copyright(C)1997,1999KunihiroIshiguro<kunihiro@zebra.or
g>**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/or
modifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareF
oundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistribute
dinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrant
yof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicense
formoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*wit
hthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Fr
anklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"command.h"
#include"prefix.h"#include"table.h"#include"stream.h"#include"memory.h"#include"
routemap.h"#include"zclient.h"#include"log.h"#include"vrf.h"#include"ripd/ripd.h
"#include"ripd/rip_debug.h"#include"ripd/rip_interface.h"/*Allinformationaboutze
bra.*/structzclient*zclient=NULL;/*SendECMProutestozebra.*/staticvoidrip_zebra_i
pv4_send(structroute_node*rp,uint8_tcmd){structlist*list=(structlist*)rp->info;s
tructzapi_routeapi;structzapi_nexthop*api_nh;structlistnode*listnode=NULL;struct
rip_info*rinfo=NULL;intcount=0;memset(&api,0,sizeof(api));api.vrf_id=VRF_DEFAULT
;api.type=ZEBRA_ROUTE_RIP;api.safi=SAFI_UNICAST;SET_FLAG(api.message,ZAPI_MESSAG
E_NEXTHOP);for(ALL_LIST_ELEMENTS_RO(list,listnode,rinfo)){if(count>=MULTIPATH_NU
M)break;api_nh=&api.nexthops[count];api_nh->vrf_id=VRF_DEFAULT;api_nh->gate=rinf
o->nh.gate;api_nh->type=NEXTHOP_TYPE_IPV4;if(cmd==ZEBRA_ROUTE_ADD)SET_FLAG(rinfo
->flags,RIP_RTF_FIB);elseUNSET_FLAG(rinfo->flags,RIP_RTF_FIB);count++;}api.prefi
x=rp->p;api.nexthop_num=count;rinfo=listgetdata(listhead(list));SET_FLAG(api.mes
sage,ZAPI_MESSAGE_METRIC);api.metric=rinfo->metric;if(rinfo->distance&&rinfo->di
stance!=ZEBRA_RIP_DISTANCE_DEFAULT){SET_FLAG(api.message,ZAPI_MESSAGE_DISTANCE);
api.distance=rinfo->distance;}if(rinfo->tag){SET_FLAG(api.message,ZAPI_MESSAGE_T
AG);api.tag=rinfo->tag;}zclient_route_send(cmd,zclient,&api);if(IS_RIP_DEBUG_ZEB
RA){if(rip->ecmp)zlog_debug("%s:%s/%dnexthops%d",(cmd==ZEBRA_ROUTE_ADD)?"Install
intozebra":"Deletefromzebra",inet_ntoa(rp->p.u.prefix4),rp->p.prefixlen,count);e
lsezlog_debug("%s:%s/%d",(cmd==ZEBRA_ROUTE_ADD)?"Installintozebra":"Deletefromze
bra",inet_ntoa(rp->p.u.prefix4),rp->p.prefixlen);}rip_global_route_changes++;}/*
Add/updateECMProutestozebra.*/voidrip_zebra_ipv4_add(structroute_node*rp){rip_ze
bra_ipv4_send(rp,ZEBRA_ROUTE_ADD);}/*DeleteECMProutesfromzebra.*/voidrip_zebra_i
pv4_delete(structroute_node*rp){rip_zebra_ipv4_send(rp,ZEBRA_ROUTE_DELETE);}/*Ze
brarouteaddanddeletetreatment.*/staticintrip_zebra_read_route(intcommand,structz
client*zclient,zebra_size_tlength,vrf_id_tvrf_id){structzapi_routeapi;structnext
hopnh;if(!rip)return0;if(zapi_route_decode(zclient->ibuf,&api)<0)return-1;memset
(&nh,0,sizeof(nh));nh.type=api.nexthops[0].type;nh.gate.ipv4=api.nexthops[0].gat
e.ipv4;nh.ifindex=api.nexthops[0].ifindex;/*ThenfetchIPv4prefixes.*/if(command==
ZEBRA_REDISTRIBUTE_ROUTE_ADD)rip_redistribute_add(api.type,RIP_ROUTE_REDISTRIBUT
E,(structprefix_ipv4*)&api.prefix,&nh,api.metric,api.distance,api.tag);elseif(co
mmand==ZEBRA_REDISTRIBUTE_ROUTE_DEL)rip_redistribute_delete(api.type,RIP_ROUTE_R
EDISTRIBUTE,(structprefix_ipv4*)&api.prefix,nh.ifindex);return0;}voidrip_zclient
_reset(void){zclient_reset(zclient);}/*RIProute-mapsetforredistribution*/staticv
oidrip_routemap_set(inttype,constchar*name){if(rip->route_map[type].name)free(ri
p->route_map[type].name);rip->route_map[type].name=strdup(name);rip->route_map[t
ype].map=route_map_lookup_by_name(name);}staticvoidrip_redistribute_metric_set(i
nttype,unsignedintmetric){rip->route_map[type].metric_config=1;rip->route_map[ty
pe].metric=metric;}staticintrip_metric_unset(inttype,unsignedintmetric){#defineD
ONT_CARE_METRIC_RIP17if(metric!=DONT_CARE_METRIC_RIP&&rip->route_map[type].metri
c!=metric)return1;rip->route_map[type].metric_config=0;rip->route_map[type].metr
ic=0;return0;}/*RIProute-mapunsetforredistribution*/staticintrip_routemap_unset(
inttype,constchar*name){if(!rip->route_map[type].name||(name!=NULL&&strcmp(rip->
route_map[type].name,name)))return1;free(rip->route_map[type].name);rip->route_m
ap[type].name=NULL;rip->route_map[type].map=NULL;return0;}/*Redistributiontypes*
/staticstruct{inttype;intstr_min_len;constchar*str;}redist_type[]={{ZEBRA_ROUTE_
KERNEL,1,"kernel"},{ZEBRA_ROUTE_CONNECT,1,"connected"},{ZEBRA_ROUTE_STATIC,1,"st
atic"},{ZEBRA_ROUTE_OSPF,1,"ospf"},{ZEBRA_ROUTE_BGP,2,"bgp"},{ZEBRA_ROUTE_VNC,1,
"vnc"},{0,0,NULL}};staticintrip_redistribute_unset(inttype){if(!vrf_bitmap_check
(zclient->redist[AFI_IP][type],VRF_DEFAULT))returnCMD_SUCCESS;vrf_bitmap_unset(z
client->redist[AFI_IP][type],VRF_DEFAULT);if(zclient->sock>0)zebra_redistribute_
send(ZEBRA_REDISTRIBUTE_DELETE,zclient,AFI_IP,type,0,VRF_DEFAULT);/*Removetherou
tesfromRIPtable.*/rip_redistribute_withdraw(type);returnCMD_SUCCESS;}intrip_redi
stribute_check(inttype){returnvrf_bitmap_check(zclient->redist[AFI_IP][type],VRF
_DEFAULT);}voidrip_redistribute_clean(void){inti;for(i=0;redist_type[i].str;i++)
{if(vrf_bitmap_check(zclient->redist[AFI_IP][redist_type[i].type],VRF_DEFAULT)){
if(zclient->sock>0)zebra_redistribute_send(ZEBRA_REDISTRIBUTE_DELETE,zclient,AFI
_IP,redist_type[i].type,0,VRF_DEFAULT);vrf_bitmap_unset(zclient->redist[AFI_IP][
redist_type[i].type],VRF_DEFAULT);/*RemovetheroutesfromRIPtable.*/rip_redistribu
te_withdraw(redist_type[i].type);}}}DEFUN(rip_redistribute_type,rip_redistribute
_type_cmd,"redistribute"FRR_REDIST_STR_RIPD,REDIST_STRFRR_REDIST_HELP_STR_RIPD){
inti;for(i=0;redist_type[i].str;i++){if(strncmp(redist_type[i].str,argv[1]->arg,
redist_type[i].str_min_len)==0){zclient_redistribute(ZEBRA_REDISTRIBUTE_ADD,zcli
ent,AFI_IP,redist_type[i].type,0,VRF_DEFAULT);returnCMD_SUCCESS;}}vty_out(vty,"I
nvalidtype%s\n",argv[1]->arg);returnCMD_WARNING_CONFIG_FAILED;}DEFUN(no_rip_redi
stribute_type,no_rip_redistribute_type_cmd,"noredistribute"FRR_REDIST_STR_RIPD,N
O_STRREDIST_STRFRR_REDIST_HELP_STR_RIPD){inti;for(i=0;redist_type[i].str;i++){if
(strncmp(redist_type[i].str,argv[2]->arg,redist_type[i].str_min_len)==0){rip_met
ric_unset(redist_type[i].type,DONT_CARE_METRIC_RIP);rip_routemap_unset(redist_ty
pe[i].type,NULL);rip_redistribute_unset(redist_type[i].type);returnCMD_SUCCESS;}
}vty_out(vty,"Invalidtype%s\n",argv[2]->arg);returnCMD_WARNING_CONFIG_FAILED;}DE
FUN(rip_redistribute_type_routemap,rip_redistribute_type_routemap_cmd,"redistrib
ute"FRR_REDIST_STR_RIPD"route-mapWORD",REDIST_STRFRR_REDIST_HELP_STR_RIPD"Routem
apreference\n""Pointertoroute-mapentries\n"){intidx_protocol=1;intidx_word=3;int
i;for(i=0;redist_type[i].str;i++){if(strmatch(redist_type[i].str,argv[idx_protoc
ol]->text)){rip_routemap_set(redist_type[i].type,argv[idx_word]->arg);zclient_re
distribute(ZEBRA_REDISTRIBUTE_ADD,zclient,AFI_IP,redist_type[i].type,0,VRF_DEFAU
LT);returnCMD_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",argv[idx_protocol]->text);
returnCMD_WARNING_CONFIG_FAILED;}DEFUN(no_rip_redistribute_type_routemap,no_rip_
redistribute_type_routemap_cmd,"noredistribute"FRR_REDIST_STR_RIPD"route-mapWORD
",NO_STRREDIST_STRFRR_REDIST_HELP_STR_RIPD"Routemapreference\n""Pointertoroute-m
apentries\n"){intidx_protocol=2;intidx_word=4;inti;for(i=0;redist_type[i].str;i+
+){if(strmatch(redist_type[i].str,argv[idx_protocol]->text)){if(rip_routemap_uns
et(redist_type[i].type,argv[idx_word]->arg))returnCMD_WARNING_CONFIG_FAILED;rip_
redistribute_unset(redist_type[i].type);returnCMD_SUCCESS;}}vty_out(vty,"Invalid
type%s\n",argv[idx_protocol]->text);returnCMD_WARNING_CONFIG_FAILED;}DEFUN(rip_r
edistribute_type_metric,rip_redistribute_type_metric_cmd,"redistribute"FRR_REDIS
T_STR_RIPD"metric(0-16)",REDIST_STRFRR_REDIST_HELP_STR_RIPD"Metric\n""Metricvalu
e\n"){intidx_protocol=1;intidx_number=3;inti;intmetric;metric=atoi(argv[idx_numb
er]->arg);for(i=0;redist_type[i].str;i++){if(strmatch(redist_type[i].str,argv[id
x_protocol]->text)){rip_redistribute_metric_set(redist_type[i].type,metric);zcli
ent_redistribute(ZEBRA_REDISTRIBUTE_ADD,zclient,AFI_IP,redist_type[i].type,0,VRF
_DEFAULT);returnCMD_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",argv[idx_protocol]->
text);returnCMD_WARNING_CONFIG_FAILED;}DEFUN(no_rip_redistribute_type_metric,no_
rip_redistribute_type_metric_cmd,"noredistribute"FRR_REDIST_STR_RIPD"metric(0-16
)",NO_STRREDIST_STRFRR_REDIST_HELP_STR_RIPD"Metric\n""Metricvalue\n"){intidx_pro
tocol=2;intidx_number=4;inti;for(i=0;redist_type[i].str;i++){if(strmatch(redist_
type[i].str,argv[idx_protocol]->text)){if(rip_metric_unset(redist_type[i].type,a
toi(argv[idx_number]->arg)))returnCMD_WARNING_CONFIG_FAILED;rip_redistribute_uns
et(redist_type[i].type);returnCMD_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",argv[i
dx_protocol]->text);returnCMD_WARNING_CONFIG_FAILED;}DEFUN(rip_redistribute_type
_metric_routemap,rip_redistribute_type_metric_routemap_cmd,"redistribute"FRR_RED
IST_STR_RIPD"metric(0-16)route-mapWORD",REDIST_STRFRR_REDIST_HELP_STR_RIPD"Metri
c\n""Metricvalue\n""Routemapreference\n""Pointertoroute-mapentries\n"){intidx_pr
otocol=1;intidx_number=3;intidx_word=5;inti;intmetric;metric=atoi(argv[idx_numbe
r]->arg);for(i=0;redist_type[i].str;i++){if(strmatch(redist_type[i].str,argv[idx
_protocol]->text)){rip_redistribute_metric_set(redist_type[i].type,metric);rip_r
outemap_set(redist_type[i].type,argv[idx_word]->arg);zclient_redistribute(ZEBRA_
REDISTRIBUTE_ADD,zclient,AFI_IP,redist_type[i].type,0,VRF_DEFAULT);returnCMD_SUC
CESS;}}vty_out(vty,"Invalidtype%s\n",argv[idx_protocol]->text);returnCMD_WARNING
_CONFIG_FAILED;}DEFUN(no_rip_redistribute_type_metric_routemap,no_rip_redistribu
te_type_metric_routemap_cmd,"noredistribute"FRR_REDIST_STR_RIPD"metric(0-16)rout
e-mapWORD",NO_STRREDIST_STRFRR_REDIST_HELP_STR_RIPD"Metric\n""Metricvalue\n""Rou
temapreference\n""Pointertoroute-mapentries\n"){intidx_protocol=2;intidx_number=
4;intidx_word=6;inti;for(i=0;redist_type[i].str;i++){if(strmatch(redist_type[i].
str,argv[idx_protocol]->text)){if(rip_metric_unset(redist_type[i].type,atoi(argv
[idx_number]->arg)))returnCMD_WARNING_CONFIG_FAILED;if(rip_routemap_unset(redist
_type[i].type,argv[idx_word]->arg)){rip_redistribute_metric_set(redist_type[i].t
ype,atoi(argv[idx_number]->arg));returnCMD_WARNING_CONFIG_FAILED;}rip_redistribu
te_unset(redist_type[i].type);returnCMD_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",
argv[idx_protocol]->text);returnCMD_WARNING_CONFIG_FAILED;}/*Defaultinformationo
riginate.*/DEFUN(rip_default_information_originate,rip_default_information_origi
nate_cmd,"default-informationoriginate","Controldistributionofdefaultroute\n""Di
stributeadefaultroute\n"){structprefix_ipv4p;structnexthopnh;if(!rip->default_in
formation){memset(&p,0,sizeof(structprefix_ipv4));memset(&nh,0,sizeof(nh));p.fam
ily=AF_INET;nh.type=NEXTHOP_TYPE_IPV4;rip->default_information=1;rip_redistribut
e_add(ZEBRA_ROUTE_RIP,RIP_ROUTE_DEFAULT,&p,&nh,0,0,0);}returnCMD_SUCCESS;}DEFUN(
no_rip_default_information_originate,no_rip_default_information_originate_cmd,"n
odefault-informationoriginate",NO_STR"Controldistributionofdefaultroute\n""Distr
ibuteadefaultroute\n"){structprefix_ipv4p;if(rip->default_information){memset(&p
,0,sizeof(structprefix_ipv4));p.family=AF_INET;rip->default_information=0;rip_re
distribute_delete(ZEBRA_ROUTE_RIP,RIP_ROUTE_DEFAULT,&p,0);}returnCMD_SUCCESS;}in
tconfig_write_rip_redistribute(structvty*vty,intconfig_mode){inti;for(i=0;i<ZEBR
A_ROUTE_MAX;i++){if(i==zclient->redist_default||!vrf_bitmap_check(zclient->redis
t[AFI_IP][i],VRF_DEFAULT))continue;if(!config_mode){vty_out(vty,"%s",zebra_route
_string(i));continue;}if(rip->route_map[i].metric_config){if(rip->route_map[i].n
ame)vty_out(vty,"redistribute%smetric%droute-map%s\n",zebra_route_string(i),rip-
>route_map[i].metric,rip->route_map[i].name);elsevty_out(vty,"redistribute%smetr
ic%d\n",zebra_route_string(i),rip->route_map[i].metric);}else{if(rip->route_map[
i].name)vty_out(vty,"redistribute%sroute-map%s\n",zebra_route_string(i),rip->rou
te_map[i].name);elsevty_out(vty,"redistribute%s\n",zebra_route_string(i));}}retu
rn0;}staticvoidrip_zebra_connected(structzclient*zclient){zclient_send_reg_reque
sts(zclient,VRF_DEFAULT);}voidrip_zclient_init(structthread_master*master){/*Set
defaultvaluetothezebraclientstructure.*/zclient=zclient_new_notify(master,&zclie
nt_options_default);zclient_init(zclient,ZEBRA_ROUTE_RIP,0,&ripd_privs);zclient-
>zebra_connected=rip_zebra_connected;zclient->interface_add=rip_interface_add;zc
lient->interface_delete=rip_interface_delete;zclient->interface_address_add=rip_
interface_address_add;zclient->interface_address_delete=rip_interface_address_de
lete;zclient->interface_up=rip_interface_up;zclient->interface_down=rip_interfac
e_down;zclient->redistribute_route_add=rip_zebra_read_route;zclient->redistribut
e_route_del=rip_zebra_read_route;/*Installcommandelementstoripnode.*/install_ele
ment(RIP_NODE,&rip_redistribute_type_cmd);install_element(RIP_NODE,&rip_redistri
bute_type_routemap_cmd);install_element(RIP_NODE,&rip_redistribute_type_metric_c
md);install_element(RIP_NODE,&rip_redistribute_type_metric_routemap_cmd);install
_element(RIP_NODE,&no_rip_redistribute_type_cmd);install_element(RIP_NODE,&no_ri
p_redistribute_type_routemap_cmd);install_element(RIP_NODE,&no_rip_redistribute_
type_metric_cmd);install_element(RIP_NODE,&no_rip_redistribute_type_metric_route
map_cmd);install_element(RIP_NODE,&rip_default_information_originate_cmd);instal
l_element(RIP_NODE,&no_rip_default_information_originate_cmd);}voidrip_zclient_s
top(void){zclient_stop(zclient);zclient_free(zclient);}