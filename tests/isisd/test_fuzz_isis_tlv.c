#include"test_fuzz_isis_tlv_tests.h"#include<zebra.h>#include"memory.h"#include"
sbuf.h"#include"stream.h"#include"thread.h"#include"isisd/isis_circuit.h"#includ
e"isisd/isis_tlvs.h"#defineTEST_STREAM_SIZE1500structthread_master*master;intisi
s_sock_init(structisis_circuit*circuit);intisis_sock_init(structisis_circuit*cir
cuit){return0;}structzebra_privs_tisisd_privs;staticboolatexit_registered;static
voidshow_meminfo_at_exit(void){log_memstats(stderr,"isisfuzztest");}staticintcom
p_line(constvoid*p1,constvoid*p2){returnstrcmp(*(char*const*)p1,*(char*const*)p2
);}staticchar*sortlines(char*in){size_tline_count=1;size_trv_len=strlen(in)+1;si
ze_trv_pos=0;char*rv=XMALLOC(MTYPE_TMP,rv_len);for(char*c=in;*c;c++){if(*c=='\n'
)line_count++;}if(line_count==1){strncpy(rv,in,rv_len);returnrv;}char**lines=XCA
LLOC(MTYPE_TMP,sizeof(char*)*line_count);char*saveptr=NULL;size_ti=0;for(char*li
ne=strtok_r(in,"\n",&saveptr);line;line=strtok_r(NULL,"\n",&saveptr)){lines[i++]
=line;assert(i<=line_count);}line_count=i;qsort(lines,line_count,sizeof(char*),c
omp_line);for(i=0;i<line_count;i++){intprintf_rv=snprintf(rv+rv_pos,rv_len-rv_po
s,"%s\n",lines[i]);assert(printf_rv>=0);rv_pos+=printf_rv;}XFREE(MTYPE_TMP,lines
);returnrv;}staticinttest(FILE*input,FILE*output){structstream*s=stream_new(TEST
_STREAM_SIZE);charbuf[TEST_STREAM_SIZE];size_tbytes_read=0;if(!atexit_registered
){atexit(show_meminfo_at_exit);atexit_registered=true;}while(STREAM_WRITEABLE(s)
&&!feof(input)){bytes_read=fread(buf,1,STREAM_WRITEABLE(s),input);if(bytes_read=
=0)break;stream_put(s,buf,bytes_read);}if(bytes_read&&!feof(input)){fprintf(outp
ut,"Toomuchinputdata.\n");stream_free(s);return1;}stream_set_getp(s,0);structisi
s_tlvs*tlvs;constchar*log;intrv=isis_unpack_tlvs(STREAM_READABLE(s),s,&tlvs,&log
);if(rv){fprintf(output,"CouldnotunpackTLVs:\n%s\n",log);isis_free_tlvs(tlvs);st
ream_free(s);return2;}fprintf(output,"Unpacklog:\n%s",log);constchar*s_tlvs=isis
_format_tlvs(tlvs);fprintf(output,"UnpackedTLVs:\n%s",s_tlvs);structisis_tlvs*tl
v_copy=isis_copy_tlvs(tlvs);isis_free_tlvs(tlvs);structstream*s2=stream_new(TEST
_STREAM_SIZE);if(isis_pack_tlvs(tlv_copy,s2,(size_t)-1,false,false)){fprintf(out
put,"CouldnotpackTLVs.\n");assert(0);}stream_set_getp(s2,0);rv=isis_unpack_tlvs(
STREAM_READABLE(s2),s2,&tlvs,&log);if(rv){fprintf(output,"CouldnotunpackownTLVs:
\n%s\n",log);assert(0);}char*orig_tlvs=XSTRDUP(MTYPE_TMP,s_tlvs);s_tlvs=isis_for
mat_tlvs(tlvs);if(strcmp(orig_tlvs,s_tlvs)){fprintf(output,"DeserializedandSeria
lizedLSPseemtodiffer.\n");fprintf(output,"Re-UnpackedTLVs:\n%s",s_tlvs);assert(0
);}isis_free_tlvs(tlv_copy);stream_free(s);stream_free(s2);structlist*fragments=
isis_fragment_tlvs(tlvs,550);isis_free_tlvs(tlvs);if(!fragments){XFREE(MTYPE_TMP
,orig_tlvs);return0;}s=stream_new(550);structsbuffragment_format;sbuf_init(&frag
ment_format,NULL,0);structlistnode*node;for(ALL_LIST_ELEMENTS_RO(fragments,node,
tlvs)){stream_reset(s);intrv=isis_pack_tlvs(tlvs,s,(size_t)-1,false,false);if(rv
){fprintf(output,"Couldnotpackfragment,toolarge.\n");assert(0);}sbuf_push(&fragm
ent_format,0,"%s",isis_format_tlvs(tlvs));isis_free_tlvs(tlvs);}list_delete_and_
null(&fragments);stream_free(s);char*fragment_content=sortlines((char*)sbuf_buf(
&fragment_format));sbuf_free(&fragment_format);char*orig_tlv_content=sortlines(o
rig_tlvs);XFREE(MTYPE_TMP,orig_tlvs);if(strcmp(fragment_content,orig_tlv_content
)){fprintf(output,"FragmentedandunfragmentedLSPseemtodiffer.\n");fprintf(output,
"Original:\n%s\nFragmented:\n%s\n",orig_tlv_content,fragment_content);assert(0);
}XFREE(MTYPE_TMP,fragment_content);XFREE(MTYPE_TMP,orig_tlv_content);return0;}