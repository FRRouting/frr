/**Routingtabletest*Copyright(C)2012OSR.**ThisfileispartofQuagga**Quaggaisfreeso
ftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLice
nseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*la
terversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRAN
TY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE
.SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheG
NUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFr
eeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#incl
ude<zebra.h>#include"prefix.h"#include"table.h"/**test_node_t**Informationthatis
keptforeachnodeintheradixtree.*/typedefstructtest_node_t_{/**Humanreadablerepres
entationofthestring.Allocatedusing*malloc()/dup().*/char*prefix_str;}test_node_t
;structthread_master*master;/**add_node**Addthegivenprefix(passedinasastring)tot
hegiventable.*/staticvoidadd_node(structroute_table*table,constchar*prefix_str){
structprefix_ipv4p;test_node_t*node;structroute_node*rn;assert(prefix_str);if(st
r2prefix_ipv4(prefix_str,&p)<=0){assert(0);}rn=route_node_get(table,(structprefi
x*)&p);if(rn->info){assert(0);return;}node=malloc(sizeof(test_node_t));assert(no
de);node->prefix_str=strdup(prefix_str);assert(node->prefix_str);rn->info=node;}
/**add_nodes**Conveniencefunctiontoaddabunchofnodestogether.**Theargumentsmustbe
prefixesinstringformat,withaNULLasthe*lastargument.*/staticvoidadd_nodes(structr
oute_table*table,...){va_listarglist;char*prefix;va_start(arglist,table);prefix=
va_arg(arglist,char*);while(prefix){add_node(table,prefix);prefix=va_arg(arglist
,char*);}va_end(arglist);}/**print_subtree**Recursivefunctiontoprintaroutenodean
ditschildren.**@seeprint_table*/staticvoidprint_subtree(structroute_node*rn,cons
tchar*legend,intindent_level){charbuf[PREFIX2STR_BUFFER];inti;/**Printthisnodefi
rst.*/for(i=0;i<indent_level;i++){printf("");}prefix2str(&rn->p,buf,sizeof(buf))
;printf("%s:%s",legend,buf);if(!rn->info){printf("(internal)");}printf("\n");if(
rn->l_left){print_subtree(rn->l_left,"Left",indent_level+1);}if(rn->l_right){pri
nt_subtree(rn->l_right,"Right",indent_level+1);}}/**print_table**Functionthatpri
ntsouttheinternalstructureofaroutetable.*/staticvoidprint_table(structroute_tabl
e*table){structroute_node*rn;rn=table->top;if(!rn){printf("<EmptyTable>\n");retu
rn;}print_subtree(rn,"Top",0);}/**clear_table**Removeallnodesfromthegiventable.*
/staticvoidclear_table(structroute_table*table){route_table_iter_titer;structrou
te_node*rn;test_node_t*node;route_table_iter_init(&iter,table);while((rn=route_t
able_iter_next(&iter))){node=rn->info;if(!node){continue;}rn->info=NULL;route_un
lock_node(rn);free(node->prefix_str);free(node);}route_table_iter_cleanup(&iter)
;assert(table->top==NULL);}/**verify_next_by_iterating**Iterateoverthetreetomake
surethatthefirstprefixafter*target_pfxistheexpectedone.Notethattarget_pfxmaynotb
e*presentinthetree.*/staticvoidverify_next_by_iterating(structroute_table*table,
structprefix*target_pfx,structprefix*next_pfx){route_table_iter_titer;structrout
e_node*rn;route_table_iter_init(&iter,table);while((rn=route_table_iter_next(&it
er))){if(route_table_prefix_iter_cmp(&rn->p,target_pfx)>0){assert(!prefix_cmp(&r
n->p,next_pfx));break;}}if(!rn){assert(!next_pfx);}route_table_iter_cleanup(&ite
r);}/**verify_next**Verifiesthatroute_table_get_next()returnstheexpectedresult*(
result)fortheprefixstring'target'.*/staticvoidverify_next(structroute_table*tabl
e,constchar*target,constchar*next){structprefix_ipv4target_pfx,next_pfx;structro
ute_node*rn;charresult_buf[PREFIX2STR_BUFFER];if(str2prefix_ipv4(target,&target_
pfx)<=0){assert(0);}rn=route_table_get_next(table,(structprefix*)&target_pfx);if
(rn){prefix2str(&rn->p,result_buf,sizeof(result_buf));}else{snprintf(result_buf,
sizeof(result_buf),"(Null)");}printf("\n");print_table(table);printf("Verifyings
uccessorof%s.Expected:%s,Result:%s\n",target,next?next:"(Null)",result_buf);if(!
rn){assert(!next);verify_next_by_iterating(table,(structprefix*)&target_pfx,NULL
);return;}assert(next);if(str2prefix_ipv4(next,&next_pfx)<=0){assert(0);}if(pref
ix_cmp(&rn->p,(structprefix*)&next_pfx)){assert(0);}route_unlock_node(rn);verify
_next_by_iterating(table,(structprefix*)&target_pfx,(structprefix*)&next_pfx);}/
**test_get_next*/staticvoidtest_get_next(void){structroute_table*table;printf("\
n\nTestingroute_table_get_next()\n");table=route_table_init();/**Targetexistsint
ree,buthasnosuccessor.*/add_nodes(table,"1.0.1.0/24",NULL);verify_next(table,"1.
0.1.0/24",NULL);clear_table(table);/**Targetexistsintree,andthereisanodeinitslef
tsubtree.*/add_nodes(table,"1.0.1.0/24","1.0.1.0/25",NULL);verify_next(table,"1.
0.1.0/24","1.0.1.0/25");clear_table(table);/**Targetexistsintree,andthereisanode
initsrightsubtree.*/add_nodes(table,"1.0.1.0/24","1.0.1.128/25",NULL);verify_nex
t(table,"1.0.1.0/24","1.0.1.128/25");clear_table(table);/**Targetexistsinthetree
,nextnodeisoutsidesubtree.*/add_nodes(table,"1.0.1.0/24","1.1.0.0/16",NULL);veri
fy_next(table,"1.0.1.0/24","1.1.0.0/16");clear_table(table);/**Thetargetnodedoes
notexistinthetreeforallthetestcases*belowthispoint.*//**Thereisnosuccessorinthet
ree.*/add_nodes(table,"1.0.0.0/16",NULL);verify_next(table,"1.0.1.0/24",NULL);cl
ear_table(table);/**Thereexistsanodethatwouldbeinthetarget'sleftsubtree.*/add_no
des(table,"1.0.0.0/16","1.0.1.0/25",NULL);verify_next(table,"1.0.1.0/24","1.0.1.
0/25");clear_table(table);/**Thereexistsanodewouldbeinthetarget'srightsubtree.*/
add_nodes(table,"1.0.0.0/16","1.0.1.128/25",NULL);verify_next(table,"1.0.1.0/24"
,"1.0.1.128/25");clear_table(table);/**Asearchforthetargetreachesanodewherethere
arenochild*nodesinthedirectionofthetarget(left),butthenodehasa*rightchild.*/add_
nodes(table,"1.0.0.0/16","1.0.128.0/17",NULL);verify_next(table,"1.0.0.0/17","1.
0.128.0/17");clear_table(table);/**Asearchforthetargetreachesanodewithnochildren
.Wehave*togoupwardsinthetreetofindasuccessor.*/add_nodes(table,"1.0.0.0/16","1.0
.0.0/24","1.0.1.0/24","1.0.128.0/17",NULL);verify_next(table,"1.0.1.0/25","1.0.1
28.0/17");clear_table(table);/**Asearchforthetargetreachesanodewhereneithertheno
denor*thetargetprefixcontaineachother.**Infirstcasebelowthenodesucceedsthetarget
.**Inthesecondcase,thenodecomesbeforethetarget,sowehave*togoupthetreelookingfora
successor.*/add_nodes(table,"1.0.0.0/16","1.0.1.0/24",NULL);verify_next(table,"1
.0.0.0/24","1.0.1.0/24");clear_table(table);add_nodes(table,"1.0.0.0/16","1.0.0.
0/24","1.0.1.0/25","1.0.128.0/17",NULL);verify_next(table,"1.0.1.128/25","1.0.12
8.0/17");clear_table(table);route_table_finish(table);}/**verify_prefix_iter_cmp
*/staticvoidverify_prefix_iter_cmp(constchar*p1,constchar*p2,intexp_result){stru
ctprefix_ipv4p1_pfx,p2_pfx;intresult;if(str2prefix_ipv4(p1,&p1_pfx)<=0){assert(0
);}if(str2prefix_ipv4(p2,&p2_pfx)<=0){assert(0);}result=route_table_prefix_iter_
cmp((structprefix*)&p1_pfx,(structprefix*)&p2_pfx);printf("Verifyingcmp(%s,%s)re
turns%d\n",p1,p2,exp_result);assert(exp_result==result);/**Alsocheckthereverseco
mparision.*/result=route_table_prefix_iter_cmp((structprefix*)&p2_pfx,(structpre
fix*)&p1_pfx);if(exp_result){exp_result=-exp_result;}printf("Verifyingcmp(%s,%s)
returns%d\n",p1,p2,exp_result);assert(result==exp_result);}/**test_prefix_iter_c
mp**Testscomparisionofprefixesaccordingtoorderofiteration.*/staticvoidtest_prefi
x_iter_cmp(){printf("\n\nTestingroute_table_prefix_iter_cmp()\n");verify_prefix_
iter_cmp("1.0.0.0/8","1.0.0.0/8",0);verify_prefix_iter_cmp("1.0.0.0/8","1.0.0.0/
16",-1);verify_prefix_iter_cmp("1.0.0.0/16","1.128.0.0/16",-1);}/**verify_iter_w
ith_pause**Iteratesoveratreeusingtwomethods:'normal'iteration,andan*iteratorthat
pausesateachnode.Verifiesthatthetwomethods*yieldthesameresults.*/staticvoidverif
y_iter_with_pause(structroute_table*table){unsignedlongnum_nodes;structroute_nod
e*rn,*iter_rn;route_table_iter_titer_space;route_table_iter_t*iter=&iter_space;r
oute_table_iter_init(iter,table);num_nodes=0;for(rn=route_top(table);rn;rn=route
_next(rn)){num_nodes++;route_table_iter_pause(iter);assert(iter->current==NULL);
if(route_table_iter_started(iter)){assert(iter->state==RT_ITER_STATE_PAUSED);}el
se{assert(rn==table->top);assert(iter->state==RT_ITER_STATE_INIT);}iter_rn=route
_table_iter_next(iter);/**Makesurebothiterationsreturnthesamenode.*/assert(rn==i
ter_rn);}assert(num_nodes==route_table_count(table));route_table_iter_pause(iter
);iter_rn=route_table_iter_next(iter);assert(iter_rn==NULL);assert(iter->state==
RT_ITER_STATE_DONE);assert(route_table_iter_next(iter)==NULL);assert(iter->state
==RT_ITER_STATE_DONE);route_table_iter_cleanup(iter);print_table(table);printf("
Verifiedpausingiterationontreewith%lunodes\n",num_nodes);}/**test_iter_pause*/st
aticvoidtest_iter_pause(void){structroute_table*table;inti,num_prefixes;constcha
r*prefixes[]={"1.0.1.0/24","1.0.1.0/25","1.0.1.128/25","1.0.2.0/24","2.0.0.0/8"}
;num_prefixes=sizeof(prefixes)/sizeof(prefixes[0]);printf("\n\nTestingthatroute_
table_iter_pause()worksasexpected\n");table=route_table_init();for(i=0;i<num_pre
fixes;i++){add_nodes(table,prefixes[i],NULL);}verify_iter_with_pause(table);clea
r_table(table);route_table_finish(table);}/**run_tests*/staticvoidrun_tests(void
){test_prefix_iter_cmp();test_get_next();test_iter_pause();}/**main*/intmain(voi
d){run_tests();}