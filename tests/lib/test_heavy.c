/**ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodif
yit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFounda
tion;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedintheh
opethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MER
CHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformore
details.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispr
ogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinS
t,FifthFloor,Boston,MA02110-1301USA*//*Thisprogrammeshowstheeffectsof'heavy'long
-runningfunctions*onthecooperativethreadingmodel.**Runitwithaconfigfilecontainin
g'passwordwhatever',telnettoit*(itdefaultstoport4000)andenterthe'clearfoostring'
command.*thentypewhateverandobservethatthevtyinterfaceisunresponsive*forquiteape
riodoftime,duetotheclear_somethingcommand*takingaverylongtimetocomplete.*/#inclu
de<zebra.h>#include"thread.h"#include"vty.h"#include"command.h"#include"memory.h
"#include<math.h>#include"tests.h"enum{ITERS_FIRST=0,ITERS_ERR=100,ITERS_LATER=4
00,ITERS_PRINT=10,ITERS_MAX=1000,};staticvoidslow_func(structvty*vty,constchar*s
tr,constinti){doublex=1;intj;for(j=0;j<300;j++)x+=sin(x)*j;if((i%ITERS_LATER)==0
)printf("%s:%d,temporaryerror,savethissomehowanddoitlater..\n",__func__,i);if((i
%ITERS_ERR)==0)printf("%s:harderror\n",__func__);if((i%ITERS_PRINT)==0)printf("%
sdid%d,x=%g\n",str,i,x);}staticvoidclear_something(structvty*vty,constchar*str){
inti;/*thiscouldbelikeiteratingthrough150kofroute_table*orworse,iteratingthrough
alistofpeers,tobgp_stopthemwith*eachhaving150kroutetablestoprocess...*/for(i=ITE
RS_FIRST;i<ITERS_MAX;i++)slow_func(vty,str,i);}DEFUN(clear_foo,clear_foo_cmd,"cl
earfooLINE...","clearcommand\n""arbitrarystring\n"){char*str;if(!argc){vty_out(v
ty,"%%stringargumentrequired\n");returnCMD_WARNING;}str=argv_concat(argv,argc,0)
;clear_something(vty,str);XFREE(MTYPE_TMP,str);returnCMD_SUCCESS;}staticvoidslow
_vty_init(){install_element(VIEW_NODE,&clear_foo_cmd);}voidtest_init(){slow_vty_
init();}