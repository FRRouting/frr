/**RecursiveNexthopIteratortest.*ThisteststheALL_NEXTHOPSmacro.**Copyright(C)201
2byOpenSourceRouting.*Copyright(C)2012byInternetSystemsConsortium,Inc.("ISC")**T
hisfileispartofQuagga**Quaggaisfreesoftware;youcanredistributeitand/ormodifyit*u
nderthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;
eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedinthehopeth
atitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANT
ABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetai
ls.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram
;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fif
thFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"zebra/rib.h"#include"p
rng.h"structthread_master*master;staticintverbose;staticvoidstr_append(char**buf
,constchar*repr){if(*buf){*buf=realloc(*buf,strlen(*buf)+strlen(repr)+1);assert(
*buf);strncpy((*buf)+strlen(*buf),repr,strlen(repr)+1);}else{*buf=strdup(repr);a
ssert(*buf);}}staticvoidstr_appendf(char**buf,constchar*format,...){va_listap;in
trv;char*pbuf;va_start(ap,format);rv=vasprintf(&pbuf,format,ap);va_end(ap);asser
t(rv>=0);str_append(buf,pbuf);free(pbuf);}/*Thisstructurecontainsanexthopchain*a
nditsexpectedrepresentation*/structnexthop_chain{/*Headofthechain*/structnexthop
_grouphead;/*Lastnexthopintopchain*/structnexthop*current_top;/*Lastnexthopincur
rentrecursivechain*/structnexthop*current_recursive;/*Expectedstringrepresentati
on.*/char*repr;};staticstructnexthop_chain*nexthop_chain_new(void){structnexthop
_chain*rv;rv=calloc(sizeof(*rv),1);assert(rv);returnrv;}staticvoidnexthop_chain_
add_top(structnexthop_chain*nc){structnexthop*nh;nh=calloc(sizeof(*nh),1);assert
(nh);if(nc->head.nexthop){nc->current_top->next=nh;nh->prev=nc->current_top;nc->
current_top=nh;}else{nc->head.nexthop=nc->current_top=nh;}nc->current_recursive=
NULL;str_appendf(&nc->repr,"%p\n",nh);}staticvoidadd_string_representation(char*
*repr,structnexthop*nh){structnexthop*parent;/*addindentationsfirst*/parent=nh->
rparent;while(parent){str_appendf(repr,"");parent=parent->rparent;}str_appendf(r
epr,"%p\n",nh);}staticvoidstart_recursive_chain(structnexthop_chain*nc,structnex
thop*nh){SET_FLAG(nc->current_top->flags,NEXTHOP_FLAG_RECURSIVE);nc->current_top
->resolved=nh;nh->rparent=nc->current_top;nc->current_recursive=nh;}staticvoidne
xthop_chain_add_recursive(structnexthop_chain*nc){structnexthop*nh;nh=calloc(siz
eof(*nh),1);assert(nh);assert(nc->current_top);if(nc->current_recursive){nc->cur
rent_recursive->next=nh;nh->prev=nc->current_recursive;nh->rparent=nc->current_r
ecursive->rparent;nc->current_recursive=nh;}elsestart_recursive_chain(nc,nh);add
_string_representation(&nc->repr,nh);}staticvoidnexthop_chain_add_recursive_leve
l(structnexthop_chain*nc){structnexthop*nh;nh=calloc(sizeof(*nh),1);assert(nh);a
ssert(nc->current_top);if(nc->current_recursive){SET_FLAG(nc->current_recursive-
>flags,NEXTHOP_FLAG_RECURSIVE);nc->current_recursive->resolved=nh;nh->rparent=nc
->current_recursive;nc->current_recursive=nh;}elsestart_recursive_chain(nc,nh);a
dd_string_representation(&nc->repr,nh);}staticvoidnexthop_clear_recursive(struct
nexthop*tcur){if(!tcur)return;if(CHECK_FLAG(tcur->flags,NEXTHOP_FLAG_RECURSIVE))
nexthop_clear_recursive(tcur->resolved);if(tcur->next)nexthop_clear_recursive(tc
ur->next);free(tcur);}staticvoidnexthop_chain_clear(structnexthop_chain*nc){next
hop_clear_recursive(nc->head.nexthop);nc->head.nexthop=nc->current_top=nc->curre
nt_recursive=NULL;free(nc->repr);nc->repr=NULL;}staticvoidnexthop_chain_free(str
uctnexthop_chain*nc){if(!nc)return;nexthop_chain_clear(nc);free(nc);}/*Thisfunct
ionbuildsastringrepresentationof*thenexthopchainusingtheALL_NEXTHOPSmacro.*Itver
ifiesthattheALL_NEXTHOPSmacroiterated*correctlyoverthenexthopchainbycomparingthe
*generatedrepresentationwiththeexpectedrepresentation.*/staticvoidnexthop_chain_
verify_iter(structnexthop_chain*nc){structnexthop*nh;char*repr=NULL;for(ALL_NEXT
HOPS(nc->head,nh))add_string_representation(&repr,nh);if(repr&&verbose)printf("=
==\n%s",repr);assert((!repr&&!nc->repr)||(repr&&nc->repr&&!strcmp(repr,nc->repr)
));free(repr);}/*Thistestrunbuildsasimplenexthopchain*withsomerecursivenexthopsa
ndverifiesthat*theiteratorworkscorrectlyineachstagealong*theway.*/staticvoidtest
_run_first(void){structnexthop_chain*nc;nc=nexthop_chain_new();nexthop_chain_ver
ify_iter(nc);nexthop_chain_add_top(nc);nexthop_chain_verify_iter(nc);nexthop_cha
in_add_top(nc);nexthop_chain_verify_iter(nc);nexthop_chain_add_recursive(nc);nex
thop_chain_verify_iter(nc);nexthop_chain_add_recursive(nc);nexthop_chain_verify_
iter(nc);nexthop_chain_add_top(nc);nexthop_chain_verify_iter(nc);nexthop_chain_a
dd_top(nc);nexthop_chain_verify_iter(nc);nexthop_chain_add_top(nc);nexthop_chain
_verify_iter(nc);nexthop_chain_add_recursive(nc);nexthop_chain_verify_iter(nc);n
exthop_chain_add_recursive(nc);nexthop_chain_verify_iter(nc);nexthop_chain_add_r
ecursive(nc);nexthop_chain_verify_iter(nc);nexthop_chain_add_recursive_level(nc)
;nexthop_chain_verify_iter(nc);nexthop_chain_add_recursive(nc);nexthop_chain_ver
ify_iter(nc);nexthop_chain_add_recursive(nc);nexthop_chain_verify_iter(nc);nexth
op_chain_add_top(nc);nexthop_chain_verify_iter(nc);nexthop_chain_free(nc);}/*Thi
stestrunbuildsnumerousrandom*nexthopchainconfigurationsandverifies*thattheiterat
orcorrectlyprogresses*througheach.*/staticvoidtest_run_prng(void){structnexthop_
chain*nc;structprng*prng;inti;nc=nexthop_chain_new();prng=prng_new(0);for(i=0;i<
1000000;i++){switch(prng_rand(prng)%10){case0:nexthop_chain_clear(nc);break;case
1:case2:case3:case4:case5:nexthop_chain_add_top(nc);break;case6:case7:case8:if(n
c->current_top)nexthop_chain_add_recursive(nc);break;case9:if(nc->current_top)ne
xthop_chain_add_recursive_level(nc);break;}nexthop_chain_verify_iter(nc);}nextho
p_chain_free(nc);prng_free(prng);}intmain(intargc,char**argv){if(argc>=2&&!strcm
p("-v",argv[1]))verbose=1;test_run_first();printf("Simpletestpassed.\n");test_ru
n_prng();printf("PRNGtestpassed.\n");}