/**ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodif
yit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFounda
tion;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedintheh
opethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MER
CHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformore
details.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispr
ogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinS
t,FifthFloor,Boston,MA02110-1301USA*//*Thisprogrammeshowstheeffectsof'heavy'long
-runningfunctions*onthecooperativethreadingmodel.**Runitwithaconfigfilecontainin
g'passwordwhatever',telnettoit*(itdefaultstoport4000)andenterthe'clearfoostring'
command.*thentypewhateverandobservethatthevtyinterfaceisunresponsive*forquiteape
riodoftime,duetotheclear_somethingcommand*takingaverylongtimetocomplete.*/#inclu
de<zebra.h>#include"thread.h"#include"vty.h"#include"command.h"#include"memory.h
"#include"log.h"#include"workqueue.h"#include<math.h>#include"tests.h"DEFINE_MGR
OUP(TEST_HEAVYWQ,"heavy-wqtest")DEFINE_MTYPE_STATIC(TEST_HEAVYWQ,WQ_NODE,"heavy_
wq_node")DEFINE_MTYPE_STATIC(TEST_HEAVYWQ,WQ_NODE_STR,"heavy_wq_node->str")exter
nstructthread_master*master;staticstructwork_queue*heavy_wq;structheavy_wq_node{
char*str;inti;};enum{ITERS_FIRST=0,ITERS_ERR=100,ITERS_LATER=400,ITERS_PRINT=10,
ITERS_MAX=1000,};staticvoidheavy_wq_add(structvty*vty,constchar*str,inti){struct
heavy_wq_node*hn;if((hn=XCALLOC(MTYPE_WQ_NODE,sizeof(structheavy_wq_node)))==NUL
L){zlog_err("%s:unabletoallocatehn",__func__);return;}hn->i=i;if(!(hn->str=XSTRD
UP(MTYPE_WQ_NODE_STR,str))){zlog_err("%s:unabletoxstrdup",__func__);XFREE(MTYPE_
WQ_NODE,hn);return;}work_queue_add(heavy_wq,hn);return;}staticvoidslow_func_err(
structwork_queue*wq,structwork_queue_item*item){printf("%s:runningerrorfunction\
n",__func__);}staticvoidslow_func_del(structwork_queue*wq,void*data){structheavy
_wq_node*hn=data;assert(hn&&hn->str);printf("%s:%s\n",__func__,hn->str);XFREE(MT
YPE_WQ_NODE_STR,hn->str);hn->str=NULL;XFREE(MTYPE_WQ_NODE,hn);}staticwq_item_sta
tusslow_func(structwork_queue*wq,void*data){structheavy_wq_node*hn=data;doublex=
1;intj;assert(hn&&hn->str);for(j=0;j<300;j++)x+=sin(x)*j;if((hn->i%ITERS_LATER)=
=0)returnWQ_RETRY_LATER;if((hn->i%ITERS_ERR)==0)returnWQ_RETRY_NOW;if((hn->i%ITE
RS_PRINT)==0)printf("%sdid%d,x=%g\n",hn->str,hn->i,x);returnWQ_SUCCESS;}staticvo
idclear_something(structvty*vty,constchar*str){inti;/*thiscouldbelikeiteratingth
rough150kofroute_table*orworse,iteratingthroughalistofpeers,tobgp_stopthemwith*e
achhaving150kroutetablestoprocess...*/for(i=ITERS_FIRST;i<ITERS_MAX;i++)heavy_wq
_add(vty,str,i);}DEFUN(clear_foo,clear_foo_cmd,"clearfooLINE...","clearcommand\n
""arbitrarystring\n"){char*str;if(!argc){vty_out(vty,"%%stringargumentrequired\n
");returnCMD_WARNING;}str=argv_concat(argv,argc,0);clear_something(vty,str);XFRE
E(MTYPE_TMP,str);returnCMD_SUCCESS;}staticintheavy_wq_init(){if(!(heavy_wq=work_
queue_new(master,"heavy_work_queue"))){zlog_err("%s:couldnotgetnewworkqueue!",__
func__);return-1;}heavy_wq->spec.workfunc=&slow_func;heavy_wq->spec.errorfunc=&s
low_func_err;heavy_wq->spec.del_item_data=&slow_func_del;heavy_wq->spec.max_retr
ies=3;heavy_wq->spec.hold=1000;return0;}voidtest_init(){install_element(VIEW_NOD
E,&clear_foo_cmd);heavy_wq_init();}