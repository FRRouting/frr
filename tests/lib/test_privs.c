/**ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodif
yit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFounda
tion;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedintheh
opethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MER
CHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformore
details.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispr
ogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinS
t,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<lib/version.h>#in
clude"getopt.h"#include"privs.h"#include"memory.h"#include"memory_vty.h"zebra_ca
pabilities_t_caps_p[]={ZCAP_NET_RAW,ZCAP_BIND,ZCAP_NET_ADMIN,ZCAP_DAC_OVERRIDE,}
;structzebra_privs_ttest_privs={#ifdefined(FRR_USER)&&defined(FRR_GROUP).user=FR
R_USER,.group=FRR_GROUP,#endif#ifdefined(VTY_GROUP).vty_group=VTY_GROUP,#endif.c
aps_p=_caps_p,.cap_num_p=sizeof(_caps_p)/sizeof(_caps_p[0]),.cap_num_i=0};struct
optionlongopts[]={{"help",no_argument,NULL,'h'},{"user",required_argument,NULL,'
u'},{"group",required_argument,NULL,'g'},{0}};/*Helpinformationdisplay.*/staticv
oidusage(char*progname,intstatus){if(status!=0)fprintf(stderr,"Try`%s--help'form
oreinformation.\n",progname);else{printf("Usage:%s[OPTION...]\n\Daemonwhichdoes'
slow'things.\n\n\-u,--userUsertorunas\n\-g,--groupGrouptorunas\n\-h,--helpDispla
ythishelpandexit\n\\n\Reportbugsto%s\n",progname,FRR_BUG_ADDRESS);}exit(status);
}structthread_master*master;/*mainroutine.*/intmain(intargc,char**argv){char*p;c
har*progname;structzprivs_ids_tids;/*Setumaskbeforeanythingforsecurity*/umask(00
27);/*getprogramname*/progname=((p=strrchr(argv[0],'/'))?++p:argv[0]);while(1){i
ntopt;opt=getopt_long(argc,argv,"hu:g:",longopts,0);if(opt==EOF)break;switch(opt
){case0:break;case'u':test_privs.user=optarg;break;case'g':test_privs.group=opta
rg;break;case'h':usage(progname,0);break;default:usage(progname,1);break;}}/*Lib
raryinits.*/memory_init();zprivs_preinit(&test_privs);zprivs_init(&test_privs);#
definePRIV_STATE()\((test_privs.current_state()==ZPRIVS_RAISED)?"Raised":"Lowere
d")printf("%s\n",PRIV_STATE());test_privs.change(ZPRIVS_RAISE);printf("%s\n",PRI
V_STATE());test_privs.change(ZPRIVS_LOWER);printf("%s\n",PRIV_STATE());zprivs_ge
t_ids(&ids);/*terminateprivileges*/zprivs_terminate(&test_privs);/*buttheseshoul
dcontinuetowork...*/printf("%s\n",PRIV_STATE());test_privs.change(ZPRIVS_RAISE);
printf("%s\n",PRIV_STATE());test_privs.change(ZPRIVS_LOWER);printf("%s\n",PRIV_S
TATE());zprivs_get_ids(&ids);printf("terminating\n");return0;}