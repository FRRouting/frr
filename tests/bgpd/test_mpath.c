/**BGPMultipathUnitTest*Copyright(C)2010GoogleInc.**ThisfileispartofQuagga**Quag
gaisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneral
PublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouropt
ion)any*laterversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOU
TANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICU
LARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceiveda
copyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,wr
itetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301
USA*/#include<zebra.h>#include"qobj.h"#include"vty.h"#include"stream.h"#include"
privs.h"#include"linklist.h"#include"memory.h"#include"zclient.h"#include"queue.
h"#include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgpd
/bgp_route.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_nexthop.h"#include"bgpd/
bgp_mpath.h"#defineVT100_RESET"\x1b[0m"#defineVT100_RED"\x1b[31m"#defineVT100_GR
EEN"\x1b[32m"#defineVT100_YELLOW"\x1b[33m"#defineOKVT100_GREEN"OK"VT100_RESET#de
fineFAILEDVT100_RED"failed"VT100_RESET#defineTEST_PASSED0#defineTEST_FAILED-1#de
fineEXPECT_TRUE(expr,res)\if(!(expr)){\printf("Testfailurein%sline%u:%s\n",__FUN
CTION__,\__LINE__,#expr);\(res)=TEST_FAILED;\}typedefstructtestcase_t__testcase_
t;typedefint(*test_setup_func)(testcase_t*);typedefint(*test_run_func)(testcase_
t*);typedefint(*test_cleanup_func)(testcase_t*);structtestcase_t__{constchar*des
c;void*test_data;void*verify_data;void*tmp_data;test_setup_funcsetup;test_run_fu
ncrun;test_cleanup_funccleanup;};/*needthesetolinkinlibbgp*/structthread_master*
master=NULL;structzclient*zclient;structzebra_privs_tbgpd_privs={.user=NULL,.gro
up=NULL,.vty_group=NULL,};staticinttty=0;/*Createfakebgpinstance*/staticstructbg
p*bgp_create_fake(as_t*as,constchar*name){structbgp*bgp;afi_tafi;safi_tsafi;if((
bgp=XCALLOC(MTYPE_BGP,sizeof(structbgp)))==NULL)returnNULL;bgp_lock(bgp);//bgp->
peer_self=peer_new(bgp);//bgp->peer_self->host=XSTRDUP(MTYPE_BGP_PEER_HOST,"Stat
ic//announcement");bgp->peer=list_new();//bgp->peer->cmp=(int(*)(void*,void*))pe
er_cmp;bgp->group=list_new();//bgp->group->cmp=(int(*)(void*,void*))peer_group_c
mp;for(afi=AFI_IP;afi<AFI_MAX;afi++)for(safi=SAFI_UNICAST;safi<SAFI_MAX;safi++){
bgp->route[afi][safi]=bgp_table_init(afi,safi);bgp->aggregate[afi][safi]=bgp_tab
le_init(afi,safi);bgp->rib[afi][safi]=bgp_table_init(afi,safi);bgp->maxpaths[afi
][safi].maxpaths_ebgp=MULTIPATH_NUM;bgp->maxpaths[afi][safi].maxpaths_ibgp=MULTI
PATH_NUM;}bgp_scan_init(bgp);bgp->default_local_pref=BGP_DEFAULT_LOCAL_PREF;bgp-
>default_holdtime=BGP_DEFAULT_HOLDTIME;bgp->default_keepalive=BGP_DEFAULT_KEEPAL
IVE;bgp->restart_time=BGP_DEFAULT_RESTART_TIME;bgp->stalepath_time=BGP_DEFAULT_S
TALEPATH_TIME;bgp->as=*as;if(name)bgp->name=strdup(name);returnbgp;}/*==========
===============================================*Testcaseformaximum-pathsconfigur
ation*/staticintsetup_bgp_cfg_maximum_paths(testcase_t*t){as_tasn=1;t->tmp_data=
bgp_create_fake(&asn,NULL);if(!t->tmp_data)return-1;return0;}staticintrun_bgp_cf
g_maximum_paths(testcase_t*t){afi_tafi;safi_tsafi;structbgp*bgp;intapi_result;in
ttest_result=TEST_PASSED;bgp=t->tmp_data;for(afi=AFI_IP;afi<AFI_MAX;afi++)for(sa
fi=SAFI_UNICAST;safi<SAFI_MAX;safi++){/*testbgp_maximum_paths_set*/api_result=bg
p_maximum_paths_set(bgp,afi,safi,BGP_PEER_EBGP,10,0);EXPECT_TRUE(api_result==0,t
est_result);api_result=bgp_maximum_paths_set(bgp,afi,safi,BGP_PEER_IBGP,10,0);EX
PECT_TRUE(api_result==0,test_result);EXPECT_TRUE(bgp->maxpaths[afi][safi].maxpat
hs_ebgp==10,test_result);EXPECT_TRUE(bgp->maxpaths[afi][safi].maxpaths_ibgp==10,
test_result);/*testbgp_maximum_paths_unset*/api_result=bgp_maximum_paths_unset(b
gp,afi,safi,BGP_PEER_EBGP);EXPECT_TRUE(api_result==0,test_result);api_result=bgp
_maximum_paths_unset(bgp,afi,safi,BGP_PEER_IBGP);EXPECT_TRUE(api_result==0,test_
result);EXPECT_TRUE((bgp->maxpaths[afi][safi].maxpaths_ebgp==MULTIPATH_NUM),test
_result);EXPECT_TRUE((bgp->maxpaths[afi][safi].maxpaths_ibgp==MULTIPATH_NUM),tes
t_result);}returntest_result;}staticintcleanup_bgp_cfg_maximum_paths(testcase_t*
t){returnbgp_delete((structbgp*)t->tmp_data);}testcase_ttest_bgp_cfg_maximum_pat
hs={.desc="Testbgpmaximum-pathsconfig",.setup=setup_bgp_cfg_maximum_paths,.run=r
un_bgp_cfg_maximum_paths,.cleanup=cleanup_bgp_cfg_maximum_paths,};/*============
=============================================*Testcaseforbgp_mp_list*/structpeer
test_mp_list_peer[]={{.local_as=1,.as=2},{.local_as=1,.as=2},{.local_as=1,.as=2}
,{.local_as=1,.as=2},{.local_as=1,.as=2},};inttest_mp_list_peer_count=sizeof(tes
t_mp_list_peer)/sizeof(structpeer);structattrtest_mp_list_attr[4];structbgp_info
test_mp_list_info[]={{.peer=&test_mp_list_peer[0],.attr=&test_mp_list_attr[0]},{
.peer=&test_mp_list_peer[1],.attr=&test_mp_list_attr[1]},{.peer=&test_mp_list_pe
er[2],.attr=&test_mp_list_attr[1]},{.peer=&test_mp_list_peer[3],.attr=&test_mp_l
ist_attr[2]},{.peer=&test_mp_list_peer[4],.attr=&test_mp_list_attr[3]},};inttest
_mp_list_info_count=sizeof(test_mp_list_info)/sizeof(structbgp_info);staticintse
tup_bgp_mp_list(testcase_t*t){test_mp_list_attr[0].nexthop.s_addr=0x01010101;tes
t_mp_list_attr[1].nexthop.s_addr=0x02020202;test_mp_list_attr[2].nexthop.s_addr=
0x03030303;test_mp_list_attr[3].nexthop.s_addr=0x04040404;if((test_mp_list_peer[
0].su_remote=sockunion_str2su("1.1.1.1"))==NULL)return-1;if((test_mp_list_peer[1
].su_remote=sockunion_str2su("2.2.2.2"))==NULL)return-1;if((test_mp_list_peer[2]
.su_remote=sockunion_str2su("3.3.3.3"))==NULL)return-1;if((test_mp_list_peer[3].
su_remote=sockunion_str2su("4.4.4.4"))==NULL)return-1;if((test_mp_list_peer[4].s
u_remote=sockunion_str2su("5.5.5.5"))==NULL)return-1;return0;}staticintrun_bgp_m
p_list(testcase_t*t){structlistmp_list;structlistnode*mp_node;structbgp_info*inf
o;inti;inttest_result=TEST_PASSED;bgp_mp_list_init(&mp_list);EXPECT_TRUE(listcou
nt(&mp_list)==0,test_result);bgp_mp_list_add(&mp_list,&test_mp_list_info[1]);bgp
_mp_list_add(&mp_list,&test_mp_list_info[4]);bgp_mp_list_add(&mp_list,&test_mp_l
ist_info[2]);bgp_mp_list_add(&mp_list,&test_mp_list_info[3]);bgp_mp_list_add(&mp
_list,&test_mp_list_info[0]);for(i=0,mp_node=mp_list.head;i<test_mp_list_info_co
unt;i++,mp_node=listnextnode(mp_node)){info=listgetdata(mp_node);EXPECT_TRUE(inf
o==&test_mp_list_info[i],test_result);}bgp_mp_list_clear(&mp_list);EXPECT_TRUE(l
istcount(&mp_list)==0,test_result);returntest_result;}staticintcleanup_bgp_mp_li
st(testcase_t*t){inti;for(i=0;i<test_mp_list_peer_count;i++)sockunion_free(test_
mp_list_peer[i].su_remote);return0;}testcase_ttest_bgp_mp_list={.desc="Testbgp_m
p_list",.setup=setup_bgp_mp_list,.run=run_bgp_mp_list,.cleanup=cleanup_bgp_mp_li
st,};/*=========================================================*Testcaseforbgp_
info_mpath_update*/structbgp_nodetest_rn;staticintsetup_bgp_info_mpath_update(te
stcase_t*t){inti;str2prefix("42.1.1.0/24",&test_rn.p);setup_bgp_mp_list(t);for(i
=0;i<test_mp_list_info_count;i++)bgp_info_add(&test_rn,&test_mp_list_info[i]);re
turn0;}staticintrun_bgp_info_mpath_update(testcase_t*t){structbgp_info*new_best,
*old_best,*mpath;structlistmp_list;structbgp_maxpaths_cfgmp_cfg={3,3};inttest_re
sult=TEST_PASSED;bgp_mp_list_init(&mp_list);bgp_mp_list_add(&mp_list,&test_mp_li
st_info[4]);bgp_mp_list_add(&mp_list,&test_mp_list_info[3]);bgp_mp_list_add(&mp_
list,&test_mp_list_info[0]);bgp_mp_list_add(&mp_list,&test_mp_list_info[1]);new_
best=&test_mp_list_info[3];old_best=NULL;bgp_info_mpath_update(&test_rn,new_best
,old_best,&mp_list,&mp_cfg);bgp_mp_list_clear(&mp_list);EXPECT_TRUE(bgp_info_mpa
th_count(new_best)==2,test_result);mpath=bgp_info_mpath_first(new_best);EXPECT_T
RUE(mpath==&test_mp_list_info[0],test_result);EXPECT_TRUE(CHECK_FLAG(mpath->flag
s,BGP_INFO_MULTIPATH),test_result);mpath=bgp_info_mpath_next(mpath);EXPECT_TRUE(
mpath==&test_mp_list_info[1],test_result);EXPECT_TRUE(CHECK_FLAG(mpath->flags,BG
P_INFO_MULTIPATH),test_result);bgp_mp_list_add(&mp_list,&test_mp_list_info[0]);b
gp_mp_list_add(&mp_list,&test_mp_list_info[1]);new_best=&test_mp_list_info[0];ol
d_best=&test_mp_list_info[3];bgp_info_mpath_update(&test_rn,new_best,old_best,&m
p_list,&mp_cfg);bgp_mp_list_clear(&mp_list);EXPECT_TRUE(bgp_info_mpath_count(new
_best)==1,test_result);mpath=bgp_info_mpath_first(new_best);EXPECT_TRUE(mpath==&
test_mp_list_info[1],test_result);EXPECT_TRUE(CHECK_FLAG(mpath->flags,BGP_INFO_M
ULTIPATH),test_result);EXPECT_TRUE(!CHECK_FLAG(test_mp_list_info[0].flags,BGP_IN
FO_MULTIPATH),test_result);returntest_result;}staticintcleanup_bgp_info_mpath_up
date(testcase_t*t){inti;for(i=0;i<test_mp_list_peer_count;i++)sockunion_free(tes
t_mp_list_peer[i].su_remote);return0;}testcase_ttest_bgp_info_mpath_update={.des
c="Testbgp_info_mpath_update",.setup=setup_bgp_info_mpath_update,.run=run_bgp_in
fo_mpath_update,.cleanup=cleanup_bgp_info_mpath_update,};/*=====================
====================================*Setuptestcasevector*/testcase_t*all_tests[]
={&test_bgp_cfg_maximum_paths,&test_bgp_mp_list,&test_bgp_info_mpath_update,};in
tall_tests_count=(sizeof(all_tests)/sizeof(testcase_t*));/*=====================
====================================*TestDriverFunctions*/staticintglobal_test_i
nit(void){qobj_init();master=thread_master_create(NULL);zclient=zclient_new_noti
fy(master,&zclient_options_default);bgp_master_init(master);vrf_init(NULL,NULL,N
ULL,NULL);bgp_option_set(BGP_OPT_NO_LISTEN);if(fileno(stdout)>=0)tty=isatty(file
no(stdout));return0;}staticintglobal_test_cleanup(void){if(zclient!=NULL)zclient
_free(zclient);thread_master_free(master);return0;}staticvoiddisplay_result(test
case_t*test,intresult){if(tty)printf("%s:%s\n",test->desc,result==TEST_PASSED?OK
:FAILED);elseprintf("%s:%s\n",test->desc,result==TEST_PASSED?"OK":"FAILED");}sta
ticintsetup_test(testcase_t*t){intres=0;if(t->setup)res=t->setup(t);returnres;}s
taticintcleanup_test(testcase_t*t){intres=0;if(t->cleanup)res=t->cleanup(t);retu
rnres;}staticvoidrun_tests(testcase_t*tests[],intnum_tests,int*pass_count,int*fa
il_count){inttest_index,result;testcase_t*cur_test;*pass_count=*fail_count=0;for
(test_index=0;test_index<num_tests;test_index++){cur_test=tests[test_index];if(!
cur_test->desc){printf("error:test%dhasnodescription!\n",test_index);continue;}i
f(!cur_test->run){printf("error:test%shasnorunfunction!\n",cur_test->desc);conti
nue;}if(setup_test(cur_test)!=0){printf("error:setupfailedfortest%s\n",cur_test-
>desc);continue;}result=cur_test->run(cur_test);if(result==TEST_PASSED)*pass_cou
nt+=1;else*fail_count+=1;display_result(cur_test,result);if(cleanup_test(cur_tes
t)!=0){printf("error:cleanupfailedfortest%s\n",cur_test->desc);continue;}}}intma
in(void){intpass_count,fail_count;time_tcur_time;time(&cur_time);printf("BGPMult
ipathTestsRunat%s",ctime(&cur_time));if(global_test_init()!=0){printf("Globalini
tfailed.Terminating.\n");exit(1);}run_tests(all_tests,all_tests_count,&pass_coun
t,&fail_count);global_test_cleanup();printf("Totalpass/fail:%d/%d\n",pass_count,
fail_count);returnfail_count;}