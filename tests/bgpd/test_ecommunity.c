/**Copyright(C)2007SunMicrosystems,Inc.**ThisfileispartofQuagga.**Quaggaisfreeso
ftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLice
nseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*la
terversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRAN
TY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE
.SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheG
NUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFr
eeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#incl
ude<zebra.h>#include"vty.h"#include"stream.h"#include"privs.h"#include"memory.h"
#include"queue.h"#include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_ecommu
nity.h"/*needthesetolinkinlibbgp*/structzebra_privs_t*bgpd_privs=NULL;structthre
ad_master*master=NULL;staticintfailed=0;/*specificationforatest-whattheresultssh
ouldbe*/structtest_spec{constchar*shouldbe;/*thestringthepathshouldparseto*/};/*
testsegmentstoparseandvalidate,anduseforothertests*/staticstructtest_segment{con
stchar*name;constchar*desc;constuint8_tdata[1024];intlen;structtest_specsp;}test
_segments[]={{/*0*/"ipaddr","rt1.2.3.4:257",{ECOMMUNITY_ENCODE_IP,ECOMMUNITY_ROU
TE_TARGET,0x1,0x2,0x3,0x4,0x1,0x1},8,{"rt1.2.3.4:257"}},{/*1*/"ipaddr-so","soo1.
2.3.4:257",{ECOMMUNITY_ENCODE_IP,ECOMMUNITY_SITE_ORIGIN,0x1,0x2,0x3,0x4,0x1,0x1}
,8,{"soo1.2.3.4:257"}},{/*2*/"asn","rt23456:987654321",{ECOMMUNITY_ENCODE_AS,ECO
MMUNITY_SITE_ORIGIN,0x5b,0xa0,0x3a,0xde,0x68,0xb1},8,{"soo23456:987654321"}},{/*
3*/"asn4","rt168450976:4321",{ECOMMUNITY_ENCODE_AS4,ECOMMUNITY_SITE_ORIGIN,0xa,0
xa,0x5b,0xa0,0x10,0xe1},8,{"soo168450976:4321"}},{NULL,NULL,{0},0,{NULL}}};/*val
idatethegivenaspath*/staticintvalidate(structecommunity*ecom,conststructtest_spe
c*sp){intfails=0;structecommunity*etmp;char*str1,*str2;printf("got:\n%s\n",ecomm
unity_str(ecom));str1=ecommunity_ecom2str(ecom,ECOMMUNITY_FORMAT_COMMUNITY_LIST,
0);etmp=ecommunity_str2com(str1,0,1);if(etmp)str2=ecommunity_ecom2str(etmp,ECOMM
UNITY_FORMAT_COMMUNITY_LIST,0);elsestr2=NULL;if(strcmp(sp->shouldbe,str1)){faile
d++;fails++;printf("shouldbe:%s\n%s\n",str1,sp->shouldbe);}if(!etmp||strcmp(str1
,str2)){failed++;fails++;printf("dogfood:in%s\n""in->out%s\n",str1,(etmp&&str2)?
str2:"NULL");}ecommunity_free(&etmp);XFREE(MTYPE_ECOMMUNITY_STR,str1);XFREE(MTYP
E_ECOMMUNITY_STR,str2);returnfails;}/*basicparsingtest*/staticvoidparse_test(str
ucttest_segment*t){structecommunity*ecom;printf("%s:%s\n",t->name,t->desc);ecom=
ecommunity_parse((uint8_t*)t->data,t->len);printf("ecom:%s\nvalidating...:\n",ec
ommunity_str(ecom));if(!validate(ecom,&t->sp))printf("OK\n");elseprintf("failed\
n");printf("\n");ecommunity_unintern(&ecom);}intmain(void){inti=0;ecommunity_ini
t();while(test_segments[i].name)parse_test(&test_segments[i++]);printf("failures
:%d\n",failed);//printf("aspathcount:%ld\n",aspath_count());returnfailed;//retur
n(failed+aspath_count());}