/**Copyright(C)2008SunMicrosystems,Inc.**ThisfileispartofQuagga.**Quaggaisfreeso
ftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLice
nseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*la
terversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRAN
TY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE
.SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheG
NUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFr
eeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#incl
ude<zebra.h>#include"qobj.h"#include"vty.h"#include"stream.h"#include"privs.h"#i
nclude"memory.h"#include"queue.h"#include"filter.h"#include"bgpd/bgpd.h"#include
"bgpd/bgp_attr.h"#include"bgpd/bgp_open.h"#include"bgpd/bgp_debug.h"#include"bgp
d/bgp_route.h"#include"bgpd/bgp_packet.h"#include"bgpd/bgp_mplsvpn.h"#include"bg
pd/bgp_nexthop.h"#include"bgpd/bgp_vty.h"#defineVT100_RESET"\x1b[0m"#defineVT100
_RED"\x1b[31m"#defineVT100_GREEN"\x1b[32m"#defineVT100_YELLOW"\x1b[33m"#defineCA
PABILITY0#defineDYNCAP1#defineOPT_PARAM2/*needthesetolinkinlibbgp*/structzebra_p
rivs_t*bgpd_privs=NULL;structthread_master*master=NULL;staticintfailed=0;statici
nttty=0;/*testsegmentstoparseandvalidate,anduseforothertests*/staticstructtest_s
egment{constchar*name;constchar*desc;constuint8_tdata[1024];intlen;#defineSHOULD
_PARSE0#defineSHOULD_ERR-1intparses;/*whetheritshouldparseornot*/}mp_reach_segme
nts[]={{"IPv6","IPV6MPReach,globalnexthop,1NLRI",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_U
NICAST,/*nexthopbytes*/16,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,0xaa,0xbb,0xcc,0x
dd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/32
,0xff,0xfe,0x1,0x2,/*fffe:102::/32*/},(4+16+1+5),SHOULD_PARSE,},{"IPv6-2","IPV6M
PReach,globalnexthop,2NLRIs",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*nexthopbyte
s*/16,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,/*ffee:102:...*/0xaa,0xbb,0xcc,0xdd,0
x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/32,0xf
f,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2,
0x0,0x3,},(4+16+1+5+9),SHOULD_PARSE,},{"IPv6-default","IPV6MPReach,globalnexthop
,2NLRIs+default",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*nexthopbytes*/16,/*Next
hop(global)*/0xff,0xfe,0x1,0x2,0xaa,0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa
3,0xa4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/32,0xff,0xfe,0x1,0x2,/*fffe:102::/
32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2,0x0,0x3,0x0,/*::/0*/},(4+16+
1+5+9+1),SHOULD_PARSE,},{"IPv6-lnh","IPV6MPReach,global+localnexthops,2NLRIs+def
ault",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*nexthopbytes*/32,/*Nexthop(global)
*/0xff,0xfe,0x1,0x2,/*fffe:102:...*/0xaa,0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa
2,0xa3,0xa4,/*Nexthop(local)*/0xfe,0x80,0x0,0x0,/*fe80::210:2ff:..*/0x0,0x0,0x0,
0x0,0x2,0x10,0x2,0xff,0x1,0x2,0x3,0x4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/32,
0xff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0
x2,0x0,0x3,0x0,/*::/0*/},(4+32+1+5+9+1),SHOULD_PARSE,},{"IPv6-nhlen","IPV6MPReac
h,inappropriatenexthoplength",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*nexthopbyt
es*/4,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,/*fffe:102:...*/0xaa,0xbb,0xcc,0xdd,0
x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*Nexthop(local)*/0xfe,0x80,0x0,0x0,/*fe80::2
10:2ff:..*/0x0,0x0,0x0,0x0,0x2,0x10,0x2,0xff,0x1,0x2,0x3,0x4,/*SNPA(defunct,MBZ)
*/0x0,/*NLRItuples*/32,0xff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/
*fffe:1:2:3::/64*/0x0,0x2,0x0,0x3,0x0,/*::/0*/},(4+32+1+5+9+1),SHOULD_ERR,},{"IP
v6-nhlen2","IPV6MPReach,invalidnexthoplength",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNIC
AST,/*nexthopbytes*/5,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,/*fffe:102:...*/0xaa,
0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*Nexthop(local)*/0xfe,0x80,0
x0,0x0,/*fe80::210:2ff:..*/0x0,0x0,0x0,0x0,0x2,0x10,0x2,0xff,0x1,0x2,0x3,0x4,/*S
NPA(defunct,MBZ)*/0x0,/*NLRItuples*/32,0xff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xf
f,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2,0x0,0x3,0x0,/*::/0*/},(4+32+1+5+9+1),S
HOULD_ERR,},{"IPv6-nhlen3","IPV6MPReach,nexthoplengthoverflow",{/*AFI/SAFI*/0x0,
AFI_IP6,SAFI_UNICAST,/*nexthopbytes*/32,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,/*f
ffe:102:...*/0xaa,0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,},(4+16),SH
OULD_ERR,},{"IPv6-nhlen4","IPV6MPReach,nexthoplengthshort",{/*AFI/SAFI*/0x0,AFI_
IP6,SAFI_UNICAST,/*nexthopbytes*/16,/*Nexthop(global)*/0xff,0xfe,0x1,0x2,/*fffe:
102:...*/0xaa,0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*Nexthop(local
)*/0xfe,0x80,0x0,0x0,/*fe80::210:2ff:..*/0x0,0x0,0x0,0x0,0x2,0x10,0x2,0xff,0x1,0
x2,0x3,0x4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/32,0xff,0xfe,0x1,0x2,/*fffe:10
2::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2,0x0,0x3,0x0,/*::/0*/},(4
+32+1+5+9+1),SHOULD_ERR,},{"IPv6-nlri","IPV6MPReach,NLRIbitlenoverflow",{/*AFI/S
AFI*/0x0,AFI_IP6,SAFI_UNICAST,/*nexthopbytes*/32,/*Nexthop(global)*/0xff,0xfe,0x
1,0x2,/*fffe:102:...*/0xaa,0xbb,0xcc,0xdd,0x3,0x4,0x5,0x6,0xa1,0xa2,0xa3,0xa4,/*
Nexthop(local)*/0xfe,0x80,0x0,0x0,/*fe80::210:2ff:..*/0x0,0x0,0x0,0x0,0x2,0x10,0
x2,0xff,0x1,0x2,0x3,0x4,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/120,0xff,0xfe,0x1
,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2,0x0,0x3,0,
/*::/0*/},(4+32+1+5+9+1),SHOULD_ERR,},{"IPv4","IPv4MPReach,2NLRIs+default",{/*AF
I/SAFI*/0x0,AFI_IP,SAFI_UNICAST,/*nexthopbytes*/4,/*Nexthop*/192,168,0,1,/*SNPA(
defunct,MBZ)*/0x0,/*NLRItuples*/16,10,1,/*10.1/16*/17,10,2,3,/*10.2.3/17*/0,/*0/
0*/},(4+4+1+3+4+1),SHOULD_PARSE,},{"IPv4-nhlen","IPv4MPReach,nexthoplenthoverflo
w",{/*AFI/SAFI*/0x0,AFI_IP,SAFI_UNICAST,/*nexthopbytes*/32,/*Nexthop*/192,168,0,
1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/16,10,1,/*10.1/16*/17,10,2,3,/*10.2.3/1
7*/0,/*0/0*/},(4+4+1+3+4+1),SHOULD_ERR,},{"IPv4-nlrilen","IPv4MPReach,nlrilentho
verflow",{/*AFI/SAFI*/0x0,AFI_IP,SAFI_UNICAST,/*nexthopbytes*/4,/*Nexthop*/192,1
68,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/16,10,1,/*10.1/16*/30,10,0,/*0/0*/
},(4+4+1+3+2+1),SHOULD_ERR,},{"IPv4-VPNv4","IPv4/VPNv4MPReach,RD,Nexthop,2NLRIs"
,{/*AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*R
Ddefinedtobe0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItup
les*/88+16,0,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):v
al(4)*/10,1,/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192
,168,0,1,/*IPv4*/10,2,3,/*10.2.3/17*/},(4+12+1+(1+3+8+2)+(1+3+8+3)),SHOULD_PARSE
,},{"IPv4-VPNv4-bogus-plen","IPv4/MPLS-labeledVPNMPReach,RD,Nexthop,NLRI/bogusp'
len",{/*AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,1,2
,0,0xff,3,4,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/16,10,
1,/*10.1/16*/17,10,2,3,/*10.2.3/17*/0,/*0/0*/},(3+1+3*4+1+3+4+1),SHOULD_ERR,},{"
IPv4-VPNv4-plen1-short","IPv4/VPNv4MPReach,RD,Nexthop,2NLRIs,1stplenshort",{/*AF
I/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*RDdefin
edtobe0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/8
8+1,0,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):val(4)*/
10,1,/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192,168,0,
1,/*IPv4*/10,2,3,/*10.2.3/17*/},(4+12+1+(1+3+8+2)+(1+3+8+3)),SHOULD_ERR,},{"IPv4
-VPNv4-plen1-long","IPv4/VPNv4MPReach,RD,Nexthop,2NLRIs,1stplenlong",{/*AFI/SAFI
*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*RDdefinedtobe
0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/88+32,0
,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):val(4)*/10,1,
/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192,168,0,1,/*I
Pv4*/10,2,3,/*10.2.3/17*/},(4+12+1+(1+3+8+2)+(1+3+8+3)),SHOULD_ERR,},{"IPv4-VPNv
4-plenn-long","IPv4/VPNv4MPReach,RD,Nexthop,3NLRIs,lastplenlong",{/*AFI/SAFI*/0x
0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*RDdefinedtobe0*/0
,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*/88+16,0,1,2
,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):val(4)*/10,1,/*10
.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192,168,0,1,/*IPv4*
/10,2,3,/*10.2.3/17*/88+1,/*bogus*/},(4+12+1+(1+3+8+2)+(1+3+8+3)+1),SHOULD_ERR,}
,{"IPv4-VPNv4-plenn-short","IPv4/VPNv4MPReach,RD,Nexthop,2NLRIs,lastplenshort",{
/*AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*RDd
efinedtobe0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuple
s*/88+16,0,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):val
(4)*/10,1,/*10.1/16*/88+2,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192,16
8,0,1,/*IPv4*/10,2,3,/*10.2.3/17*/},(4+12+1+(1+3+8+2)+(1+3+8+3)),SHOULD_ERR,},{"
IPv4-VPNv4-bogus-rd-type","IPv4/VPNv4MPReach,RD,NH,2NLRI,unknownRDin1st(log,butp
arse)",{/*AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0
,0,/*RDdefinedtobe0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*N
LRItuples*/88+16,0,1,2,/*tag*//*rd,8octets*/0xff,0,/*BogusRD*/0,2,0,0xff,3,4,/*A
S(2):val(4)*/10,1,/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_I
P*/192,168,0,1,/*IPv4*/10,2,3,/*10.2.3/17*/},(4+12+1+(1+3+8+2)+(1+3+8+3)),SHOULD
_PARSE,},{"IPv4-VPNv4-0-nlri","IPv4/VPNv4MPReach,RD,Nexthop,3NLRI,3rd0bogus",{/*
AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_MPLS_VPN,/*nexthopbytes*/12,/*RD*/0,0,0,0,/*RDdef
inedtobe0*/0,0,0,0,/*Nexthop*/192,168,0,1,/*SNPA(defunct,MBZ)*/0x0,/*NLRItuples*
/88+16,0,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_AS*/0,2,0,0xff,3,4,/*AS(2):val(4
)*/10,1,/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_IP*/192,168
,0,1,/*IPv4*/10,2,3,/*10.2.3/17*/0/*0/0,bogusforvpnv4??*/},(4+12+1+(1+3+8+2)+(1+
3+8+3)+1),SHOULD_ERR,},/*Frombug#385*/{"IPv6-bug","IPv6,globalnexthop,1defaultNL
RI",{/*AFI/SAFI*/0x0,0x2,0x1,/*nexthopbytes*/0x20,/*Nexthop(global)*/0x20,0x01,0
x04,0x70,0x00,0x01,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,/*Nexthop(l
ocal)*/0xfe,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x0c,0xdb,0xff,0xfe,0xfe,0xe
b,0x00,/*SNPA(defunct,MBZ)*/0,/*NLRItuples*//*Shouldhave0herefor::/0,butdont*/},
37,SHOULD_ERR,},{.name="IPv4",.desc="IPV4MPReach,flowspec,1NLRI",.data={/*AFI/SA
FI*/0x0,AFI_IP,IANA_SAFI_FLOWSPEC,0x00,/*noNH*/0x00,0x06,/*FSLength*/0x01,/*FSde
stprefixID*/0x1e,/*IP*/0x1e,0x28,0x28,0x0},.len=12,.parses=SHOULD_PARSE,},{NULL,
NULL,{0},0,0}};/*MP_UNREACH_NLRItests*/staticstructtest_segmentmp_unreach_segmen
ts[]={{"IPv6-unreach","IPV6MPUnreach,1NLRI",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAS
T,/*NLRItuples*/32,0xff,0xfe,0x1,0x2,/*fffe:102::/32*/},(3+5),SHOULD_PARSE,},{"I
Pv6-unreach2","IPV6MPUnreach,2NLRIs",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*NLR
Ituples*/32,0xff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3
::/64*/0x0,0x2,0x0,0x3,},(3+5+9),SHOULD_PARSE,},{"IPv6-unreach-default","IPV6MPU
nreach,2NLRIs+default",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*NLRItuples*/32,0x
ff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0x2
,0x0,0x3,0x0,/*::/0*/},(3+5+9+1),SHOULD_PARSE,},{"IPv6-unreach-nlri","IPV6MPUnre
ach,NLRIbitlenoverflow",{/*AFI/SAFI*/0x0,AFI_IP6,SAFI_UNICAST,/*NLRItuples*/120,
0xff,0xfe,0x1,0x2,/*fffe:102::/32*/64,0xff,0xfe,0x0,0x1,/*fffe:1:2:3::/64*/0x0,0
x2,0x0,0x3,0,/*::/0*/},(3+5+9+1),SHOULD_ERR,},{"IPv4-unreach","IPv4MPUnreach,2NL
RIs+default",{/*AFI/SAFI*/0x0,AFI_IP,SAFI_UNICAST,/*NLRItuples*/16,10,1,/*10.1/1
6*/17,10,2,3,/*10.2.3/17*/0,/*0/0*/},(3+3+4+1),SHOULD_PARSE,},{"IPv4-unreach-nlr
ilen","IPv4MPUnreach,nlrilengthoverflow",{/*AFI/SAFI*/0x0,AFI_IP,SAFI_UNICAST,/*
NLRItuples*/16,10,1,/*10.1/16*/30,10,0,/*0/0*/},(3+3+2+1),SHOULD_ERR,},{"IPv4-un
reach-VPNv4","IPv4/MPLS-labeledVPNMPUnreach,RD,3NLRIs",{/*AFI/SAFI*/0x0,AFI_IP,I
ANA_SAFI_MPLS_VPN,/*NLRItuples*/88+16,0,1,2,/*tag*//*rd,8octets*/0,0,/*RD_TYPE_A
S*/0,2,0,0xff,3,4,/*AS(2):val(4)*/10,1,/*10.1/16*/88+17,0xff,0,0,/*tag*//*rd,8oc
tets*/0,0,/*RD_TYPE_IP*/192,168,0,1,/*IPv4*/10,2,3,/*10.2.3/17*/},(3+(1+3+8+2)+(
1+3+8+3)),SHOULD_PARSE,},{.name="IPv4",.desc="IPV4MPUnreach,flowspec,1NLRI",.dat
a={/*AFI/SAFI*/0x0,AFI_IP,IANA_SAFI_FLOWSPEC,0x06,/*FSLength*/0x01,/*FSdestprefi
xID*/0x1e,/*IP*/0x1e,0x28,0x28,0x0},.len=10,.parses=SHOULD_PARSE,},{NULL,NULL,{0
},0,0}};/*nlri_parseindicates0onsuccessfulparse,and-1otherwise.*attr_parseindica
tesBGP_ATTR_PARSE_PROCEED/0onsuccess,*andBGP_ATTR_PARSE_ERROR/-1orlowernegativer
etonerr.*/staticvoidhandle_result(structpeer*peer,structtest_segment*t,intparse_
ret,intnlri_ret){intoldfailed=failed;printf("mpattrparsed?:%s\n",parse_ret?"no":
"yes");if(!parse_ret)printf("nrliparsed?:%s\n",nlri_ret?"no":"yes");printf("shou
ldparse?:%s\n",t->parses?"no":"yes");if((parse_ret!=0||nlri_ret!=0)!=(t->parses!
=0))failed++;if(tty)printf("%s",(failed>oldfailed)?VT100_RED"failed!"VT100_RESET
:VT100_GREEN"OK"VT100_RESET);elseprintf("%s",(failed>oldfailed)?"failed!":"OK");
if(failed)printf("(%u)",failed);printf("\n\n");}/*basicparsingtest*/staticvoidpa
rse_test(structpeer*peer,structtest_segment*t,inttype){intparse_ret=0,nlri_ret=0
;structattrattr={};structbgp_nlrinlri={};structbgp_attr_parser_argsattr_args={.p
eer=peer,.length=t->len,.total=1,.attr=&attr,.type=type,.flags=BGP_ATTR_FLAG_OPT
IONAL,.startp=BGP_INPUT_PNT(peer),};#defineRANDOM_FUZZ35stream_reset(peer->curr)
;stream_put(peer->curr,NULL,RANDOM_FUZZ);stream_set_getp(peer->curr,RANDOM_FUZZ)
;stream_write(peer->curr,t->data,t->len);printf("%s:%s\n",t->name,t->desc);if(ty
pe==BGP_ATTR_MP_REACH_NLRI)parse_ret=bgp_mp_reach_parse(&attr_args,&nlri);elsepa
rse_ret=bgp_mp_unreach_parse(&attr_args,&nlri);if(!parse_ret){iana_afi_tpkt_afi;
iana_safi_tpkt_safi;/*ConvertAFI,SAFItointernalvalues,check.*/if(bgp_map_afi_saf
i_int2iana(nlri.afi,nlri.safi,&pkt_afi,&pkt_safi))assert(0);printf("MP:%u(%u)/%u
(%u):recv%u,nego%u\n",nlri.afi,pkt_afi,nlri.safi,pkt_safi,peer->afc_recv[nlri.af
i][nlri.safi],peer->afc_nego[nlri.afi][nlri.safi]);}if(!parse_ret){if(type==BGP_
ATTR_MP_REACH_NLRI)nlri_ret=bgp_nlri_parse(peer,&attr,&nlri,0);elsenlri_ret=bgp_
nlri_parse(peer,&attr,&nlri,1);}handle_result(peer,t,parse_ret,nlri_ret);}static
structbgp*bgp;staticas_tasn=100;intmain(void){structpeer*peer;inti,j;conf_bgp_de
bug_neighbor_events=-1UL;conf_bgp_debug_packet=-1UL;conf_bgp_debug_as4=-1UL;conf
_bgp_debug_flowspec=-1UL;term_bgp_debug_neighbor_events=-1UL;term_bgp_debug_pack
et=-1UL;term_bgp_debug_as4=-1UL;term_bgp_debug_flowspec=-1UL;qobj_init();cmd_ini
t(0);bgp_vty_init();master=thread_master_create("testmpattr");bgp_master_init(ma
ster);vrf_init(NULL,NULL,NULL,NULL);bgp_option_set(BGP_OPT_NO_LISTEN);bgp_attr_i
nit();if(fileno(stdout)>=0)tty=isatty(fileno(stdout));if(bgp_get(&bgp,&asn,NULL,
BGP_INSTANCE_TYPE_DEFAULT))return-1;peer=peer_create_accept(bgp);peer->host=(cha
r*)"foo";peer->status=Established;peer->curr=stream_new(BGP_MAX_PACKET_SIZE);for
(i=AFI_IP;i<AFI_MAX;i++)for(j=SAFI_UNICAST;j<SAFI_MAX;j++){peer->afc[i][j]=1;pee
r->afc_adv[i][j]=1;}i=0;while(mp_reach_segments[i].name)parse_test(peer,&mp_reac
h_segments[i++],BGP_ATTR_MP_REACH_NLRI);i=0;while(mp_unreach_segments[i].name)pa
rse_test(peer,&mp_unreach_segments[i++],BGP_ATTR_MP_UNREACH_NLRI);printf("failur
es:%d\n",failed);returnfailed;}