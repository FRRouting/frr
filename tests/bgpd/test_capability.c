/**Copyright(C)2007SunMicrosystems,Inc.**ThisfileispartofQuagga.**Quaggaisfreeso
ftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLice
nseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*la
terversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRAN
TY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE
.SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheG
NUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFr
eeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#incl
ude<zebra.h>#include"qobj.h"#include"vty.h"#include"stream.h"#include"privs.h"#i
nclude"memory.h"#include"queue.h"#include"filter.h"#include"frr_pthread.h"#inclu
de"bgpd/bgpd.c"#include"bgpd/bgp_open.h"#include"bgpd/bgp_debug.h"#include"bgpd/
bgp_packet.h"#defineVT100_RESET"\x1b[0m"#defineVT100_RED"\x1b[31m"#defineVT100_G
REEN"\x1b[32m"#defineVT100_YELLOW"\x1b[33m"#defineCAPABILITY0#defineDYNCAP1#defi
neOPT_PARAM2/*needthesetolinkinlibbgp*/structzebra_privs_t*bgpd_privs=NULL;struc
tthread_master*master=NULL;staticintfailed=0;staticinttty=0;/*testsegmentstopars
eandvalidate,anduseforothertests*/staticstructtest_segment{constchar*name;constc
har*desc;constuint8_tdata[1024];intlen;#defineSHOULD_PARSE0#defineSHOULD_ERR-1in
tparses;/*whetheritshouldparseornot*/as_tpeek_for;/*whatpeek_for_as4_capabilitys
houldsay*//*AFI/SAFIvalidation*/intvalidate_afi;iana_afi_tafi;iana_safi_tsafi;#d
efineVALID_AFI1#defineINVALID_AFI0intafi_valid;}test_segments[]={/*0*/{"caphdr",
"capabilityheader,andnomore",{CAPABILITY_CODE_REFRESH,0x0},2,SHOULD_PARSE,},/*1*
/{"nodata","header,nodatabutlengthsaysthereis",{0x1,0xa},2,SHOULD_ERR,},/*2*/{"p
added","valid,withpadding",{CAPABILITY_CODE_REFRESH,0x2,0x0,0x0},4,SHOULD_PARSE,
},/*3*/{"minsize","violatesminsizerequirement",{CAPABILITY_CODE_ORF,0x2,0x0,0x0}
,4,SHOULD_ERR,},{NULL,NULL,{0},0,0},};staticstructtest_segmentmp_segments[]={{"M
P4","MPIP/Uni",{0x1,0x4,0x0,0x1,0x0,0x1},6,SHOULD_PARSE,0,1,IANA_AFI_IPV4,IANA_S
AFI_UNICAST,VALID_AFI,},{"MPv6","MPIPv6/Uni",{0x1,0x4,0x0,0x2,0x0,0x1},6,SHOULD_
PARSE,0,1,IANA_AFI_IPV6,IANA_SAFI_UNICAST,VALID_AFI,},/*5*/{"MP2","MPIP/Multicas
t",{CAPABILITY_CODE_MP,0x4,0x0,0x1,0x0,0x2},6,SHOULD_PARSE,0,1,IANA_AFI_IPV4,IAN
A_SAFI_MULTICAST,VALID_AFI,},/*6*/{"MP3","MPIP6/MPLS-labeledVPN",{CAPABILITY_COD
E_MP,0x4,0x0,0x2,0x0,0x80},6,SHOULD_PARSE,0,1,IANA_AFI_IPV6,IANA_SAFI_MPLS_VPN,V
ALID_AFI,},/*7*/{"MP5","MPIP6/MPLS-VPN",{CAPABILITY_CODE_MP,0x4,0x0,0x2,0x0,0x4}
,6,SHOULD_PARSE,0,1,IANA_AFI_IPV6,IANA_SAFI_MPLS_VPN,VALID_AFI,},/*8*/{"MP6","MP
IP4/MPLS-labeledVPN",{CAPABILITY_CODE_MP,0x4,0x0,0x1,0x0,0x80},6,SHOULD_PARSE,0,
1,IANA_AFI_IPV4,IANA_SAFI_MPLS_VPN,VALID_AFI,},/*10*/{"MP8","MPunknownAFI/SAFI",
{CAPABILITY_CODE_MP,0x4,0x0,0xa,0x0,0x81},6,SHOULD_PARSE,0,1,0xa,0x81,INVALID_AF
I,/*parses,butunknown*/},/*11*/{"MP-short","MPIP4/Unicast,lengthtooshort(<minimu
m)",{CAPABILITY_CODE_MP,0x2,0x0,0x1,0x0,0x1},6,SHOULD_ERR,},/*12*/{"MP-overflow"
,"MPIP4/Unicast,lengthtoolong",{CAPABILITY_CODE_MP,0x6,0x0,0x1,0x0,0x1},6,SHOULD
_ERR,0,1,IANA_AFI_IPV4,IANA_SAFI_UNICAST,VALID_AFI,},{NULL,NULL,{0},0,0}};static
structtest_segmentmisc_segments[]={/*13*/{"ORF","ORF,simple,singleentry,singletu
ple",{/*hdr*/CAPABILITY_CODE_ORF,0x7,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x1,/*tuples*
/0x40,0x3},9,SHOULD_PARSE,},/*14*/{"ORF-many","ORF,multientry/tuple",{/*hdr*/CAP
ABILITY_CODE_ORF,0x21,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x3,/*tuples*/0x40,ORF_MODE_
BOTH,0x80,ORF_MODE_RECEIVE,0x80,ORF_MODE_SEND,/*mpc*/0x0,0x2,0x0,0x1,/*num*/0x3,
/*tuples*/0x40,ORF_MODE_BOTH,0x80,ORF_MODE_RECEIVE,0x80,ORF_MODE_SEND,/*mpc*/0x0
,0x2,0x0,0x2,/*num*/0x3,/*tuples*/0x40,ORF_MODE_RECEIVE,0x80,ORF_MODE_SEND,0x80,
ORF_MODE_BOTH,},35,SHOULD_PARSE,},/*15*/{"ORFlo","ORF,multientry/tuple,hdrlength
tooshort",{/*hdr*/CAPABILITY_CODE_ORF,0x15,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x3,/*t
uples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x3,/*tuples*/0x
40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x2,/*num*/0x3,/*tuples*/0x40,0x3,0x
80,0x1,0x80,0x2,},35,SHOULD_ERR,/*ItshoulderroroninvalidRoute-Refresh..*/},/*16*
/{"ORFlu","ORF,multientry/tuple,lengthtoolong",{/*hdr*/0x3,0x22,/*mpc*/0x0,0x1,0
x0,0x1,/*num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x1,/*
num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x2,/*num*/0x3,
/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,},35,SHOULD_ERR},/*17*/{"ORFnu","ORF,multie
ntry/tuple,entrynumbertoolong",{/*hdr*/0x3,0x21,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x
3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x1,/*num*/0x4,/*tuple
s*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x2,/*num*/0x3,/*tuples*/0x40,0
x3,0x80,0x1,0x80,0x2,},35,SHOULD_PARSE,/*parses,butlastfewtuplesshouldbegibberis
h*/},/*18*/{"ORFno","ORF,multientry/tuple,entrynumbertooshort",{/*hdr*/0x3,0x21,
/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x
0,0x2,0x0,0x1,/*num*/0x1,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0
,0x2,/*num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,},35,SHOULD_PARSE,/*Parses,
butshouldgetgibberishafi/safis*/},/*17*/{"ORFpad","ORF,multientry/tuple,paddedto
align",{/*hdr*/0x3,0x22,/*mpc*/0x0,0x1,0x0,0x1,/*num*/0x3,/*tuples*/0x40,0x3,0x8
0,0x1,0x80,0x2,/*mpc*/0x0,0x2,0x0,0x1,/*num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x8
0,0x2,/*mpc*/0x0,0x2,0x0,0x2,/*num*/0x3,/*tuples*/0x40,0x3,0x80,0x1,0x80,0x2,0x0
0,},36,SHOULD_PARSE,},/*19*/{"AS4","AS4capability",{0x41,0x4,0xab,0xcd,0xef,0x12
},/*AS:2882400018*/6,SHOULD_PARSE,2882400018,},{"AS4","AS4capability:short",{0x4
1,0x4,0xab,0xcd,0xef},/*AS:2882400018*/5,SHOULD_ERR,},{"AS4","AS4capability:long
",{0x41,0x4,0xab,0xcd,0xef,0x12,0x12},7,SHOULD_ERR,2882400018,},{"GR","GRcapabil
ity",{/*hdr*/CAPABILITY_CODE_RESTART,0xe,/*R-bit,time*/0xf1,0x12,/*afi*/0x0,0x1,
/*safi*/0x1,/*flags*/0xf,/*afi*/0x0,0x2,/*safi*/0x1,/*flags*/0x0,/*afi*/0x0,0x2,
/*safi*/0x2,/*flags*/0x1,},16,SHOULD_PARSE,},{"GR-short","GRcapability,butheader
lengthtooshort",{/*hdr*/0x40,0xa,/*R-bit,time*/0xf1,0x12,/*afi*/0x0,0x1,/*safi*/
0x1,/*flags*/0xf,/*afi*/0x0,0x2,/*safi*/0x1,/*flags*/0x0,/*afi*/0x0,0x2,/*safi*/
0x2,/*flags*/0x1,},15/*arrayis16though*/,SHOULD_ERR,},{"GR-long","GRcapability,b
utheaderlengthtoolong",{/*hdr*/0x40,0xf,/*R-bit,time*/0xf1,0x12,/*afi*/0x0,0x1,/
*safi*/0x1,/*flags*/0xf,/*afi*/0x0,0x2,/*safi*/0x1,/*flags*/0x0,/*afi*/0x0,0x2,/
*safi*/0x2,/*flags*/0x01,},16,SHOULD_ERR,},{"GR-trunc","GRcapability,buttruncate
d",{/*hdr*/0x40,0xf,/*R-bit,time*/0xf1,0x12,/*afi*/0x0,0x1,/*safi*/0x1,/*flags*/
0xf,/*afi*/0x0,0x2,/*safi*/0x1,/*flags*/0x0,/*afi*/0x0,0x2,/*safi*/0x2,/*flags*/
0x1,},15,SHOULD_ERR,},{"GR-empty","GRcapability,butempty.",{/*hdr*/0x40,0x0,},2,
SHOULD_ERR,},{"MP-empty","MPcapability,butempty.",{/*hdr*/0x1,0x0,},2,SHOULD_ERR
,},{"ORF-empty","ORFcapability,butempty.",{/*hdr*/0x3,0x0,},2,SHOULD_ERR,},{"AS4
-empty","AS4capability,butempty.",{/*hdr*/0x41,0x0,},2,SHOULD_ERR,},{"dyn-empty"
,"Dynamiccapability,butempty.",{/*hdr*/0x42,0x0,},2,SHOULD_PARSE,},{"dyn-old","D
ynamiccapability(deprecatedversion)",{CAPABILITY_CODE_DYNAMIC,0x0},2,SHOULD_PARS
E,},{NULL,NULL,{0},0,0}};/*DYNAMICmessage*/structtest_segmentdynamic_cap_msgs[]=
{{"DynCap","DynamicCapabilityMessage,IP/Multicast",{0x0,0x1,0x4,0x0,0x1,0x0,0x2}
,7,SHOULD_PARSE,/*horriblealignment,justaswithORF*/},{"DynCapLong","DynamicCapab
ilityMessage,IP/Multicast,truncated",{0x0,0x1,0x4,0x0,0x1,0x0,0x2},5,SHOULD_ERR,
},{"DynCapPadded","DynamicCapabilityMessage,IP/Multicast,padded",{0x0,0x1,0x4,0x
0,0x1,0x0,0x2,0x0},8,SHOULD_ERR,/*Nowaytotellpaddingfromdata..*/},{"DynCapMPCpad
ded","DynamicCapabilityMessage,IP/Multicast,capdatapadded",{0x0,0x1,0x5,0x0,0x1,
0x0,0x2,0x0},8,SHOULD_PARSE,/*Youcanthoughaddpaddingtothecapabilitydata*/},{"Dyn
CapMPCoverflow","DynamicCapabilityMessage,IP/Multicast,capdata!=length",{0x0,0x1
,0x3,0x0,0x1,0x0,0x2,0x0},8,SHOULD_ERR,},{NULL,NULL,{0},0,0}};/*EntireOptional-P
arametersblock*/structtest_segmentopt_params[]={{"Cap-singlets","Onecapabilitype
rOptional-Param",{0x02,0x06,0x01,0x04,0x00,0x01,0x00,0x01,/*MPIPv4/Uni*/0x02,0x0
6,0x01,0x04,0x00,0x02,0x00,0x01,/*MPIPv6/Uni*/0x02,0x02,0x80,0x00,/*RR(old)*/0x0
2,0x02,0x02,0x00,/*RR*/},24,SHOULD_PARSE,},{"Cap-series","Seriesofcapability,one
Optional-Param",{0x02,0x10,0x01,0x04,0x00,0x01,0x00,0x01,/*MPIPv4/Uni*/0x01,0x04
,0x00,0x02,0x00,0x01,/*MPIPv6/Uni*/0x80,0x00,/*RR(old)*/0x02,0x00,/*RR*/},18,SHO
ULD_PARSE,},{"AS4more","AS4capabilityafterothercaps(singlets)",{0x02,0x06,0x01,0
x04,0x00,0x01,0x00,0x01,/*MPIPv4/Uni*/0x02,0x06,0x01,0x04,0x00,0x02,0x00,0x01,/*
MPIPv6/Uni*/0x02,0x02,0x80,0x00,/*RR(old)*/0x02,0x02,0x02,0x00,/*RR*/0x02,0x06,0
x41,0x04,0x00,0x03,0x00,0x06/*AS4:1996614*/},32,SHOULD_PARSE,196614,},{"AS4serie
s","AS4capability,inseriesofcapabilities",{0x02,0x16,0x01,0x04,0x00,0x01,0x00,0x
01,/*MPIPv4/Uni*/0x01,0x04,0x00,0x02,0x00,0x01,/*MPIPv6/Uni*/0x80,0x00,/*RR(old)
*/0x02,0x00,/*RR*/0x41,0x04,0x00,0x03,0x00,0x06/*AS4:1996614*/},24,SHOULD_PARSE,
196614,},{"AS4real","AS4capability,inseriesofcapabilities",{0x02,0x06,0x01,0x04,
0x00,0x01,0x00,0x01,/*MPIPv4/uni*/0x02,0x06,0x01,0x04,0x00,0x02,0x00,0x01,/*MPIP
v6/uni*/0x02,0x02,0x80,0x00,/*RRold*/0x02,0x02,0x02,0x00,/*RR*/0x02,0x06,0x41,0x
04,0x00,0x03,0x00,0x06,/*AS4*/},32,SHOULD_PARSE,196614,},{"AS4real2","AS4capabil
ity,inseriesofcapabilities",{0x02,0x06,0x01,0x04,0x00,0x01,0x00,0x01,0x02,0x06,0
x01,0x04,0x00,0x02,0x00,0x01,0x02,0x02,0x80,0x00,0x02,0x02,0x02,0x00,0x02,0x06,0
x41,0x04,0x00,0x00,0xfc,0x03,0x02,0x09,0x82,0x07,0x00,0x01,0x00,0x01,0x01,0x80,0
x03,0x02,0x09,0x03,0x07,0x00,0x01,0x00,0x01,0x01,0x40,0x03,0x02,0x02,0x42,0x00,}
,58,SHOULD_PARSE,64515,},{NULL,NULL,{0},0,0}};/*basicparsingtest*/staticvoidpars
e_test(structpeer*peer,structtest_segment*t,inttype){intret;intcapability=0;as_t
as4=0;intoldfailed=failed;intlen=t->len;#defineRANDOM_FUZZ35stream_reset(peer->c
urr);stream_put(peer->curr,NULL,RANDOM_FUZZ);stream_set_getp(peer->curr,RANDOM_F
UZZ);switch(type){caseCAPABILITY:stream_putc(peer->curr,BGP_OPEN_OPT_CAP);stream
_putc(peer->curr,t->len);break;caseDYNCAP:/*for(i=0;i<BGP_MARKER_SIZE;i++)stream
_putc(peer->,0xff);stream_putw(s,0);stream_putc(s,BGP_MSG_CAPABILITY);*/break;}s
tream_write(peer->curr,t->data,t->len);printf("%s:%s\n",t->name,t->desc);switch(
type){caseCAPABILITY:len+=2;/*tocovertheOPT-Paramheader*/caseOPT_PARAM:printf("l
en:%u\n",len);/*peek_for_as4wantsgetpatcapibility*/as4=peek_for_as4_capability(p
eer,len);printf("peek_for_as4:as4is%u\n",as4);/*anditshouldleavegetpasitfoundit*
/assert(stream_get_getp(peer->curr)==RANDOM_FUZZ);ret=bgp_open_option_parse(peer
,len,&capability);break;caseDYNCAP:ret=bgp_capability_receive(peer,t->len);break
;default:printf("unknowntype%u\n",type);exit(1);}if(ret!=BGP_Stop&&t->validate_a
fi){afi_tafi;safi_tsafi;/*ConvertAFI,SAFItointernalvalues,check.*/if(bgp_map_afi
_safi_iana2int(t->afi,t->safi,&afi,&safi)){if(t->afi_valid==VALID_AFI)failed++;}
printf("MP:%u(%u)/%u(%u):recv%u,nego%u\n",t->afi,afi,t->safi,safi,peer->afc_recv
[afi][safi],peer->afc_nego[afi][safi]);if(t->afi_valid==VALID_AFI){if(!peer->afc
_recv[afi][safi])failed++;if(!peer->afc_nego[afi][safi])failed++;}}if(as4!=t->pe
ek_for){printf("as4%u!=%u\n",as4,t->peek_for);failed++;}/**Someofthefunctionsuse
dreturnBGP_Stoponerrorandsomereturn*-1.Ifwehave-1,keepit;ifwehaveBGP_Stop,transf
ormittothe*correctpass/failcode*/if(ret!=-1)ret=(ret==BGP_Stop)?-1:0;printf("par
sed?:%s\n",ret?"no":"yes");if(ret!=t->parses){printf("t->parses:%d\nret:%d\n",t-
>parses,ret);failed++;}if(tty)printf("%s",(failed>oldfailed)?VT100_RED"failed!"V
T100_RESET:VT100_GREEN"OK"VT100_RESET);elseprintf("%s",(failed>oldfailed)?"faile
d!":"OK");if(failed)printf("(%u)",failed);printf("\n\n");}staticstructbgp*bgp;st
aticas_tasn=100;intmain(void){structpeer*peer;inti,j;conf_bgp_debug_neighbor_eve
nts=-1UL;conf_bgp_debug_packet=-1UL;conf_bgp_debug_as4=-1UL;term_bgp_debug_neigh
bor_events=-1UL;term_bgp_debug_packet=-1UL;term_bgp_debug_as4=-1UL;qobj_init();m
aster=thread_master_create(NULL);bgp_master_init(master);vrf_init(NULL,NULL,NULL
,NULL);bgp_option_set(BGP_OPT_NO_LISTEN);bgp_pthreads_init();frr_pthread_get(PTH
READ_KEEPALIVES)->running=true;if(fileno(stdout)>=0)tty=isatty(fileno(stdout));i
f(bgp_get(&bgp,&asn,NULL,BGP_INSTANCE_TYPE_DEFAULT))return-1;peer=peer_create_ac
cept(bgp);peer->host=(char*)"foo";for(i=AFI_IP;i<AFI_MAX;i++)for(j=SAFI_UNICAST;
j<SAFI_MAX;j++){peer->afc[i][j]=1;peer->afc_adv[i][j]=1;}peer->curr=stream_new(B
GP_MAX_PACKET_SIZE);i=0;while(mp_segments[i].name)parse_test(peer,&mp_segments[i
++],CAPABILITY);/*Thesetestsassumemp_segmentstestssetatleast*oneoftheafc_nego's*
/i=0;while(test_segments[i].name)parse_test(peer,&test_segments[i++],CAPABILITY)
;i=0;while(misc_segments[i].name)parse_test(peer,&misc_segments[i++],CAPABILITY)
;i=0;while(opt_params[i].name)parse_test(peer,&opt_params[i++],OPT_PARAM);SET_FL
AG(peer->cap,PEER_CAP_DYNAMIC_ADV);peer->status=Established;i=0;while(dynamic_ca
p_msgs[i].name)parse_test(peer,&dynamic_cap_msgs[i++],DYNCAP);printf("failures:%
d\n",failed);returnfailed;}