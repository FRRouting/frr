/**CLI/commanddummyhandlingtester**Copyright(C)2015byDavidLamparter,*forOpenSour
ceRouting/NetDEF,Inc.**Quaggaisfreesoftware;youcanredistributeitand/ormodifyit*u
nderthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;
eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedinthehopeth
atitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANT
ABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetai
ls.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram
;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fif
thFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"vect
or.h"#include"vty.h"#include"ospf6d/ospf6_lsa.h"#include"ospf6d/ospf6_lsdb.h"#in
clude"tests/lib/cli/common_cli.h"#include"ospf6d/test_lsdb_clippy.c"staticstruct
ospf6_lsdb*lsdb;staticstructospf6_lsa**lsas=NULL;staticsize_tlsa_count=0;staticv
oidlsa_check_resize(size_tlen){if(lsa_count>=len)return;lsas=realloc(lsas,len*si
zeof(lsas[0]));memset(lsas+lsa_count,0,sizeof(lsas[0])*(len-lsa_count));lsa_coun
t=len;}DEFPY(lsa_set,lsa_set_cmd,"lsaset(0-999999)$idx{type(0-65535)|idA.B.C.D|a
dvA.B.C.D}","LSA\n""set\n""LSAindexinarray\n""OSPF6typecode\n""OSPF6typecode\n""
LS-ID\n""LS-ID\n""Advertisingrouter\n""Advertisingrouter\n"){structospf6_lsa_hea
derhdr;memset(&hdr,0,sizeof(hdr));hdr.type=htons(type);hdr.id=id.s_addr;hdr.adv_
router=adv.s_addr;lsa_check_resize(idx+1);if(lsas[idx])ospf6_lsa_unlock(lsas[idx
]);lsas[idx]=ospf6_lsa_create_headeronly(&hdr);ospf6_lsa_lock(lsas[idx]);returnC
MD_SUCCESS;}DEFPY(lsa_drop,lsa_drop_cmd,"lsadrop(0-999999)$idx","LSA\n""droprefe
rence\n""LSAindexinarray\n"){if((size_t)idx>=lsa_count)returnCMD_SUCCESS;if(lsas
[idx]->lock!=1)vty_out(vty,"refcountat%u\n",lsas[idx]->lock);ospf6_lsa_unlock(ls
as[idx]);lsas[idx]=NULL;returnCMD_SUCCESS;}DEFPY(lsdb_add,lsdb_add_cmd,"lsdbadd(
0-999999)$idx","LSDB\n""insertLSAintoLSDB\n""LSAindexinarray\n"){ospf6_lsdb_add(
lsas[idx],lsdb);returnCMD_SUCCESS;}DEFPY(lsdb_remove,lsdb_remove_cmd,"lsdbremove
(0-999999)$idx","LSDB\n""removeLSAfromLSDB\n""LSAindexinarray\n"){ospf6_lsdb_rem
ove(lsas[idx],lsdb);returnCMD_SUCCESS;}staticvoidlsa_show_oneline(structvty*vty,
structospf6_lsa*lsa){charadv_router[64],id[64];if(!lsa){vty_out(vty,"lsa=NULL\n"
);return;}inet_ntop(AF_INET,&lsa->header->id,id,sizeof(id));inet_ntop(AF_INET,&l
sa->header->adv_router,adv_router,sizeof(adv_router));vty_out(vty,"type%uadv%sid
%s\n",ntohs(lsa->header->type),adv_router,id);}DEFPY(lsdb_walk,lsdb_walk_cmd,"ls
dbwalk","LSDB\n""walkentries\n"){structospf6_lsa*lsa;unsignedcnt=0;for(ALL_LSDB(
lsdb,lsa)){lsa_show_oneline(vty,lsa);cnt++;}vty_out(vty,"%uentries.\n",cnt);retu
rnCMD_SUCCESS;}DEFPY(lsdb_walk_type,lsdb_walk_type_cmd,"lsdbwalktype(0-65535)","
LSDB\n""walkentries\n""entrytype\n""entrytype\n"){structospf6_lsa*lsa;unsignedcn
t=0;type=htons(type);for(ALL_LSDB_TYPED(lsdb,type,lsa)){lsa_show_oneline(vty,lsa
);cnt++;}vty_out(vty,"%uentries.\n",cnt);returnCMD_SUCCESS;}DEFPY(lsdb_walk_type
_adv,lsdb_walk_type_adv_cmd,"lsdbwalktype(0-65535)advA.B.C.D","LSDB\n""walkentri
es\n""entrytype\n""entrytype\n""advertisingrouterID\n""advertisingrouterID\n"){s
tructospf6_lsa*lsa;unsignedcnt=0;type=htons(type);for(ALL_LSDB_TYPED_ADVRTR(lsdb
,type,adv.s_addr,lsa)){lsa_show_oneline(vty,lsa);cnt++;}vty_out(vty,"%uentries.\
n",cnt);returnCMD_SUCCESS;}DEFPY(lsdb_get,lsdb_get_cmd,"lsdb<get-next|get>type(0
-65535)advA.B.C.DidA.B.C.D","LSDB\n""getentry'ssuccessor\n""entrytype\n""entryty
pe\n""advertisingrouterID\n""advertisingrouterID\n""LS-ID\n""LS-ID\n"){structosp
f6_lsa*lsa;type=htons(type);if(!strcmp(argv[1]->text,"get-next"))lsa=ospf6_lsdb_
lookup_next(type,id.s_addr,adv.s_addr,lsdb);elselsa=ospf6_lsdb_lookup(type,id.s_
addr,adv.s_addr,lsdb);lsa_show_oneline(vty,lsa);returnCMD_SUCCESS;}DEFPY(lsa_ref
counts,lsa_refcounts_cmd,"lsarefcounts","LSA\n""showreferencecounts\n"){for(size
_ti=0;i<lsa_count;i++)if(lsas[i])vty_out(vty,"[%zu]%u\n",i,lsas[i]->lock);return
CMD_SUCCESS;}DEFPY(lsdb_create,lsdb_create_cmd,"lsdbcreate","LSDB\n""createLSDB\
n"){if(lsdb)ospf6_lsdb_delete(lsdb);lsdb=ospf6_lsdb_create(NULL);returnCMD_SUCCE
SS;}DEFPY(lsdb_delete,lsdb_delete_cmd,"lsdbdelete","LSDB\n""deleteLSDB\n"){ospf6
_lsdb_delete(lsdb);lsdb=NULL;returnCMD_SUCCESS;}structzebra_privs_tospf6d_privs;
voidtest_init(intargc,char**argv){ospf6_lsa_init();install_element(ENABLE_NODE,&
lsa_set_cmd);install_element(ENABLE_NODE,&lsa_refcounts_cmd);install_element(ENA
BLE_NODE,&lsa_drop_cmd);install_element(ENABLE_NODE,&lsdb_create_cmd);install_el
ement(ENABLE_NODE,&lsdb_delete_cmd);install_element(ENABLE_NODE,&lsdb_add_cmd);i
nstall_element(ENABLE_NODE,&lsdb_remove_cmd);install_element(ENABLE_NODE,&lsdb_w
alk_cmd);install_element(ENABLE_NODE,&lsdb_walk_type_cmd);install_element(ENABLE
_NODE,&lsdb_walk_type_adv_cmd);install_element(ENABLE_NODE,&lsdb_get_cmd);}