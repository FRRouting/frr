/*Copyright(c)2007,2008byJuliuszChroboczekCopyright2011byMatthieuBoutierandJuliu
szChroboczekPermissionisherebygranted,freeofcharge,toanypersonobtainingacopyofth
issoftwareandassociateddocumentationfiles(the"Software"),todealintheSoftwarewith
outrestriction,includingwithoutlimitationtherightstouse,copy,modify,merge,publis
h,distribute,sublicense,and/orsellcopiesoftheSoftware,andtopermitpersonstowhomth
eSoftwareisfurnishedtodoso,subjecttothefollowingconditions:Theabovecopyrightnoti
ceandthispermissionnoticeshallbeincludedinallcopiesorsubstantialportionsoftheSof
tware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCL
UDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY,FITNESSFORAPARTICULARPURPOSEA
NDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,
DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,
OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERDEALINGSINTHESOFTWARE.*/#includ
e<zebra.h>#include"if.h"#include"log.h"#include"babeld.h"#include"kernel.h"#incl
ude"neighbour.h"#include"message.h"#include"route.h"#include"xroute.h"#include"u
til.h"#include"babel_interface.h"staticintxroute_add_new_route(unsignedcharprefi
x[16],unsignedcharplen,unsignedshortmetric,unsignedintifindex,intproto,intsend_u
pdates);staticstructxroute*xroutes;staticintnumxroutes=0,maxxroutes=0;/*Addredis
tributedroutetoBabeltable.*/intbabel_route_add(structzapi_route*api){unsignedcha
ruchar_prefix[16];switch(api->prefix.family){caseAF_INET:inaddr_to_uchar(uchar_p
refix,&api->prefix.u.prefix4);debugf(BABEL_DEBUG_ROUTE,"Addingnewipv4routecoming
fromZebra.");xroute_add_new_route(uchar_prefix,api->prefix.prefixlen+96,api->met
ric,api->nexthops[0].ifindex,0,1);break;caseAF_INET6:in6addr_to_uchar(uchar_pref
ix,&api->prefix.u.prefix6);debugf(BABEL_DEBUG_ROUTE,"Addingnewipv6routecomingfro
mZebra.");xroute_add_new_route(uchar_prefix,api->prefix.prefixlen,api->metric,ap
i->nexthops[0].ifindex,0,1);break;}return0;}/*RemoveredistributedroutefromBabelt
able.*/intbabel_route_delete(structzapi_route*api){unsignedcharuchar_prefix[16];
structxroute*xroute=NULL;switch(api->prefix.family){caseAF_INET:inaddr_to_uchar(
uchar_prefix,&api->prefix.u.prefix4);xroute=find_xroute(uchar_prefix,api->prefix
.prefixlen+96);if(xroute!=NULL){debugf(BABEL_DEBUG_ROUTE,"Removingipv4route(from
zebra).");flush_xroute(xroute);}break;caseAF_INET6:in6addr_to_uchar(uchar_prefix
,&api->prefix.u.prefix6);xroute=find_xroute(uchar_prefix,api->prefix.prefixlen);
if(xroute!=NULL){debugf(BABEL_DEBUG_ROUTE,"Removingipv6route(fromzebra).");flush
_xroute(xroute);}break;}return0;}structxroute*find_xroute(constunsignedchar*pref
ix,unsignedcharplen){inti;for(i=0;i<numxroutes;i++){if(xroutes[i].plen==plen&&me
mcmp(xroutes[i].prefix,prefix,16)==0)return&xroutes[i];}returnNULL;}voidflush_xr
oute(structxroute*xroute){inti;i=xroute-xroutes;assert(i>=0&&i<numxroutes);if(i!
=numxroutes-1)memcpy(xroutes+i,xroutes+numxroutes-1,sizeof(structxroute));numxro
utes--;VALGRIND_MAKE_MEM_UNDEFINED(xroutes+numxroutes,sizeof(structxroute));if(n
umxroutes==0){free(xroutes);xroutes=NULL;maxxroutes=0;}elseif(maxxroutes>8&&numx
routes<maxxroutes/4){structxroute*new_xroutes;intn=maxxroutes/2;new_xroutes=real
loc(xroutes,n*sizeof(structxroute));if(new_xroutes==NULL)return;xroutes=new_xrou
tes;maxxroutes=n;}}staticintadd_xroute(unsignedcharprefix[16],unsignedcharplen,u
nsignedshortmetric,unsignedintifindex,intproto){structxroute*xroute=find_xroute(
prefix,plen);if(xroute){if(xroute->metric<=metric)return0;xroute->metric=metric;
return1;}if(numxroutes>=maxxroutes){structxroute*new_xroutes;intn=maxxroutes<1?8
:2*maxxroutes;new_xroutes=xroutes==NULL?malloc(n*sizeof(structxroute)):realloc(x
routes,n*sizeof(structxroute));if(new_xroutes==NULL)return-1;maxxroutes=n;xroute
s=new_xroutes;}memcpy(xroutes[numxroutes].prefix,prefix,16);xroutes[numxroutes].
plen=plen;xroutes[numxroutes].metric=metric;xroutes[numxroutes].ifindex=ifindex;
xroutes[numxroutes].proto=proto;numxroutes++;return1;}/*Returnsanoverestimateoft
henumberofxroutes.*/intxroutes_estimate(){returnnumxroutes;}structxroute_stream{
intindex;};structxroute_stream*xroute_stream(void){structxroute_stream*stream=ma
lloc(sizeof(structxroute_stream));if(stream==NULL)returnNULL;stream->index=0;ret
urnstream;}structxroute*xroute_stream_next(structxroute_stream*stream){if(stream
->index<numxroutes)return&xroutes[stream->index++];elsereturnNULL;}voidxroute_st
ream_done(structxroute_stream*stream){free(stream);}/*addanxroute,verifyingsomec
onditions;return0ifthereisnochanges*/staticintxroute_add_new_route(unsignedcharp
refix[16],unsignedcharplen,unsignedshortmetric,unsignedintifindex,intproto,intse
nd_updates){intrc;if(martian_prefix(prefix,plen))return0;metric=redistribute_fil
ter(prefix,plen,ifindex,proto);if(metric<INFINITY){rc=add_xroute(prefix,plen,met
ric,ifindex,proto);if(rc>0){structbabel_route*route;route=find_installed_route(p
refix,plen);if(route)uninstall_route(route);if(send_updates)send_update(NULL,0,p
refix,plen);return1;}}return0;}