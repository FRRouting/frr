/*Copyright(c)2007,2008byJuliuszChroboczekCopyright2011byMatthieuBoutierandJuliu
szChroboczekPermissionisherebygranted,freeofcharge,toanypersonobtainingacopyofth
issoftwareandassociateddocumentationfiles(the"Software"),todealintheSoftwarewith
outrestriction,includingwithoutlimitationtherightstouse,copy,modify,merge,publis
h,distribute,sublicense,and/orsellcopiesoftheSoftware,andtopermitpersonstowhomth
eSoftwareisfurnishedtodoso,subjecttothefollowingconditions:Theabovecopyrightnoti
ceandthispermissionnoticeshallbeincludedinallcopiesorsubstantialportionsoftheSof
tware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCL
UDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY,FITNESSFORAPARTICULARPURPOSEA
NDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,
DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,
OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERDEALINGSINTHESOFTWARE.*/#ifndef
BABEL_ROUTE_H#defineBABEL_ROUTE_H#include"babel_interface.h"#include"source.h"#d
efineDIVERSITY_NONE0#defineDIVERSITY_INTERFACE_11#defineDIVERSITY_CHANNEL_12#def
ineDIVERSITY_CHANNEL3#defineDIVERSITY_HOPS8structbabel_route{structsource*src;un
signedshortrefmetric;unsignedshortcost;unsignedshortadd_metric;unsignedshortseqn
o;structneighbour*neigh;unsignedcharnexthop[16];time_ttime;unsignedshorthold_tim
e;/*inseconds*/unsignedshortsmoothed_metric;/*forrouteselection*/time_tsmoothed_
metric_time;shortinstalled;unsignedcharchannels[DIVERSITY_HOPS];structbabel_rout
e*next;};structroute_stream;externstructbabel_route**routes;externintkernel_metr
ic;externintdiversity_kind,diversity_factor;externintkeep_unfeasible;externintsm
oothing_half_life;staticinlineintroute_metric(conststructbabel_route*route){intm
=(int)route->refmetric+route->cost+route->add_metric;returnMIN(m,INFINITY);}stat
icinlineintroute_metric_noninterfering(conststructbabel_route*route){intm=(int)r
oute->refmetric+(diversity_factor*route->cost+128)/256+route->add_metric;m=MAX(m
,route->refmetric+1);returnMIN(m,INFINITY);}structbabel_route*find_route(constun
signedchar*prefix,unsignedcharplen,structneighbour*neigh,constunsignedchar*nexth
op);structbabel_route*find_installed_route(constunsignedchar*prefix,unsignedchar
plen);intinstalled_routes_estimate(void);voidflush_route(structbabel_route*route
);voidflush_all_routes(void);voidflush_neighbour_routes(structneighbour*neigh);v
oidflush_interface_routes(structinterface*ifp,intv4only);structroute_stream*rout
e_stream(intinstalled);structbabel_route*route_stream_next(structroute_stream*st
ream);voidroute_stream_done(structroute_stream*stream);voidinstall_route(structb
abel_route*route);voiduninstall_route(structbabel_route*route);introute_feasible
(structbabel_route*route);introute_old(structbabel_route*route);introute_expired
(structbabel_route*route);introute_interferes(structbabel_route*route,structinte
rface*ifp);intupdate_feasible(structsource*src,unsignedshortseqno,unsignedshortr
efmetric);voidchange_smoothing_half_life(inthalf_life);introute_smoothed_metric(
structbabel_route*route);structbabel_route*find_best_route(constunsignedchar*pre
fix,unsignedcharplen,intfeasible,structneighbour*exclude);structbabel_route*inst
all_best_route(constunsignedcharprefix[16],unsignedcharplen);voidupdate_neighbou
r_metric(structneighbour*neigh,intchange);voidupdate_interface_metric(structinte
rface*ifp);voidupdate_route_metric(structbabel_route*route);structbabel_route*up
date_route(constunsignedchar*id,constunsignedchar*prefix,unsignedcharplen,unsign
edshortseqno,unsignedshortrefmetric,unsignedshortinterval,structneighbour*neigh,
constunsignedchar*nexthop,constunsignedchar*channels,intchannels_len);voidretrac
t_neighbour_routes(structneighbour*neigh);voidsend_unfeasible_request(structneig
hbour*neigh,intforce,unsignedshortseqno,unsignedshortmetric,structsource*src);vo
idsend_triggered_update(structbabel_route*route,structsource*oldsrc,unsignedoldm
etric);voidroute_changed(structbabel_route*route,structsource*oldsrc,unsignedsho
rtoldmetric);voidroute_lost(structsource*src,unsignedoldmetric);voidexpire_route
s(void);#endif