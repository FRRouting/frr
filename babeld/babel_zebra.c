/*Copyright2011byMatthieuBoutierandJuliuszChroboczekPermissionisherebygranted,fr
eeofcharge,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfile
s(the"Software"),todealintheSoftwarewithoutrestriction,includingwithoutlimitatio
ntherightstouse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopies
oftheSoftware,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothef
ollowingconditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincluded
inallcopiesorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOU
TWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCH
ANTABILITY,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHO
RSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIO
NOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEU
SEOROTHERDEALINGSINTHESOFTWARE.*//*FRR'sincludes*/#include<zebra.h>#include"comm
and.h"#include"zclient.h"#include"stream.h"/*babel'sincludes*/#include"babel_zeb
ra.h"#include"babel_interface.h"#include"xroute.h"#include"util.h"voidbabelz_zeb
ra_init(void);/*wemustuseapointerbecauseofzclient.c'sfunctions(new,free).*/struc
tzclient*zclient;/*Debugtypes*/staticstruct{inttype;intstr_min_len;constchar*str
;}debug_type[]={{BABEL_DEBUG_COMMON,1,"common"},{BABEL_DEBUG_KERNEL,1,"kernel"},
{BABEL_DEBUG_FILTER,1,"filter"},{BABEL_DEBUG_TIMEOUT,1,"timeout"},{BABEL_DEBUG_I
F,1,"interface"},{BABEL_DEBUG_ROUTE,1,"route"},{BABEL_DEBUG_ALL,1,"all"},{0,0,NU
LL}};/*Zebrarouteaddanddeletetreatment.*/staticintbabel_zebra_read_route(intcomm
and,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf){structzapi_routeapi;if
(zapi_route_decode(zclient->ibuf,&api)<0)return-1;/*wecompletelyignoresrcdestrou
tesfornow.*/if(CHECK_FLAG(api.message,ZAPI_MESSAGE_SRCPFX))return0;if(command==Z
EBRA_REDISTRIBUTE_ROUTE_ADD){babel_route_add(&api);}else{babel_route_delete(&api
);}return0;}/*[BabelCommand]*/DEFUN(babel_redistribute_type,babel_redistribute_t
ype_cmd,"[no]redistribute<ipv4"FRR_IP_REDIST_STR_BABELD"|ipv6"FRR_IP6_REDIST_STR
_BABELD">",NO_STR"Redistribute\n""RedistributeIPv4routes\n"FRR_IP_REDIST_HELP_ST
R_BABELD"RedistributeIPv6routes\n"FRR_IP6_REDIST_HELP_STR_BABELD){intnegate=0;in
tfamily;intafi;inttype;intidx=0;if(argv_find(argv,argc,"no",&idx))negate=1;argv_
find(argv,argc,"redistribute",&idx);family=str2family(argv[idx+1]->text);if(fami
ly<0)returnCMD_WARNING_CONFIG_FAILED;afi=family2afi(family);if(!afi)returnCMD_WA
RNING_CONFIG_FAILED;type=proto_redistnum(afi,argv[idx+2]->text);if(type<0){vty_o
ut(vty,"Invalidtype%s\n",argv[idx+2]->arg);returnCMD_WARNING_CONFIG_FAILED;}if(!
negate)zclient_redistribute(ZEBRA_REDISTRIBUTE_ADD,zclient,afi,type,0,VRF_DEFAUL
T);else{zclient_redistribute(ZEBRA_REDISTRIBUTE_DELETE,zclient,afi,type,0,VRF_DE
FAULT);/*perhapsshouldweremovexrouteshavingthesametype...*/}returnCMD_SUCCESS;}#
ifndefNO_DEBUG/*[BabelCommand]*/DEFUN(debug_babel,debug_babel_cmd,"debugbabel<co
mmon|kernel|filter|timeout|interface|route|all>","Enabledebugmessagesforspecific
orallpart.\n""Babelinformation\n""Commonmessages(default)\n""Kernelmessages\n""F
iltermessages\n""Timeoutmessages\n""Interfacemessages\n""Routemessages\n""Allmes
sages\n"){inti;for(i=0;debug_type[i].str!=NULL;i++){if(strncmp(debug_type[i].str
,argv[2]->arg,debug_type[i].str_min_len)==0){debug|=debug_type[i].type;returnCMD
_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",argv[2]->arg);returnCMD_WARNING_CONFIG_
FAILED;}/*[BabelCommand]*/DEFUN(no_debug_babel,no_debug_babel_cmd,"nodebugbabel<
common|kernel|filter|timeout|interface|route|all>",NO_STR"Disabledebugmessagesfo
rspecificorallpart.\n""Babelinformation\n""Commonmessages(default)\n""Kernelmess
ages\n""Filtermessages\n""Timeoutmessages\n""Interfacemessages\n""Routemessages\
n""Allmessages\n"){inti;for(i=0;debug_type[i].str;i++){if(strncmp(debug_type[i].
str,argv[3]->arg,debug_type[i].str_min_len)==0){debug&=~debug_type[i].type;retur
nCMD_SUCCESS;}}vty_out(vty,"Invalidtype%s\n",argv[3]->arg);returnCMD_WARNING_CON
FIG_FAILED;}#endif/*NO_DEBUG*//*Output"debug"statementlines,ifnecessary.*/intdeb
ug_babel_config_write(structvty*vty){#ifdefNO_DEBUGreturn0;#elseinti,lines=0;if(
debug==BABEL_DEBUG_ALL){vty_out(vty,"debugbabelall\n");lines++;}elsefor(i=0;debu
g_type[i].str!=NULL;i++)if(debug_type[i].type!=BABEL_DEBUG_ALL&&CHECK_FLAG(debug
,debug_type[i].type)){vty_out(vty,"debugbabel%s\n",debug_type[i].str);lines++;}i
f(lines){vty_out(vty,"!\n");lines++;}returnlines;#endif/*NO_DEBUG*/}DEFUN_NOSH(s
how_debugging_babel,show_debugging_babel_cmd,"showdebugging[babel]",SHOW_STRDEBU
G_STR"Babel"){vty_out(vty,"BABELdebuggingstatus\n");debug_babel_config_write(vty
);returnCMD_SUCCESS;}staticvoidbabel_zebra_connected(structzclient*zclient){zcli
ent_send_reg_requests(zclient,VRF_DEFAULT);}voidbabelz_zebra_init(void){zclient=
zclient_new_notify(master,&zclient_options_default);zclient_init(zclient,ZEBRA_R
OUTE_BABEL,0,&babeld_privs);zclient->zebra_connected=babel_zebra_connected;zclie
nt->interface_add=babel_interface_add;zclient->interface_delete=babel_interface_
delete;zclient->interface_up=babel_interface_up;zclient->interface_down=babel_in
terface_down;zclient->interface_address_add=babel_interface_address_add;zclient-
>interface_address_delete=babel_interface_address_delete;zclient->redistribute_r
oute_add=babel_zebra_read_route;zclient->redistribute_route_del=babel_zebra_read
_route;install_element(BABEL_NODE,&babel_redistribute_type_cmd);install_element(
ENABLE_NODE,&debug_babel_cmd);install_element(ENABLE_NODE,&no_debug_babel_cmd);i
nstall_element(CONFIG_NODE,&debug_babel_cmd);install_element(CONFIG_NODE,&no_deb
ug_babel_cmd);install_element(VIEW_NODE,&show_debugging_babel_cmd);}voidbabel_ze
bra_close_connexion(void){zclient_stop(zclient);zclient_free(zclient);}