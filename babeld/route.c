/*Copyright(c)2007,2008byJuliuszChroboczekCopyright2011byMatthieuBoutierandJuliu
szChroboczekPermissionisherebygranted,freeofcharge,toanypersonobtainingacopyofth
issoftwareandassociateddocumentationfiles(the"Software"),todealintheSoftwarewith
outrestriction,includingwithoutlimitationtherightstouse,copy,modify,merge,publis
h,distribute,sublicense,and/orsellcopiesoftheSoftware,andtopermitpersonstowhomth
eSoftwareisfurnishedtodoso,subjecttothefollowingconditions:Theabovecopyrightnoti
ceandthispermissionnoticeshallbeincludedinallcopiesorsubstantialportionsoftheSof
tware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCL
UDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY,FITNESSFORAPARTICULARPURPOSEA
NDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,
DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,
OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERDEALINGSINTHESOFTWARE.*/#includ
e<zebra.h>#include"if.h"#include"babeld.h"#include"util.h"#include"kernel.h"#inc
lude"babel_interface.h"#include"source.h"#include"neighbour.h"#include"route.h"#
include"xroute.h"#include"message.h"#include"resend.h"staticvoidconsider_route(s
tructbabel_route*route);structbabel_route**routes=NULL;staticintroute_slots=0,ma
x_route_slots=0;intkernel_metric=0;intdiversity_kind=DIVERSITY_NONE;intdiversity
_factor=BABEL_DEFAULT_DIVERSITY_FACTOR;intkeep_unfeasible=0;intsmoothing_half_li
fe=0;staticinttwo_to_the_one_over_hl=0;/*2^(1/hl)*0x10000*//*Wemaintainalistof"s
lots",orderedbyprefix.Everyslotcontainsalinkedlistoftheroutestothisprefix,withth
einstalledroute,ifany,attheheadofthelist.*/staticintroute_compare(constunsignedc
har*prefix,unsignedcharplen,structbabel_route*route){inti=memcmp(prefix,route->s
rc->prefix,16);if(i!=0)returni;if(plen<route->src->plen)return-1;elseif(plen>rou
te->src->plen)return1;elsereturn0;}/*Performsbinarysearch,returns-1incaseoffailu
re.Inthelattercase,new_returnistheplacewheretoinsertthenewelement.*/staticintfin
d_route_slot(constunsignedchar*prefix,unsignedcharplen,int*new_return){intp,m,g,
c;if(route_slots<1){if(new_return)*new_return=0;return-1;}p=0;g=route_slots-1;do
{m=(p+g)/2;c=route_compare(prefix,plen,routes[m]);if(c==0)returnm;elseif(c<0)g=m
-1;elsep=m+1;}while(p<=g);if(new_return)*new_return=p;return-1;}structbabel_rout
e*find_route(constunsignedchar*prefix,unsignedcharplen,structneighbour*neigh,con
stunsignedchar*nexthop){structbabel_route*route;inti=find_route_slot(prefix,plen
,NULL);if(i<0)returnNULL;route=routes[i];while(route){if(route->neigh==neigh&&me
mcmp(route->nexthop,nexthop,16)==0)returnroute;route=route->next;}returnNULL;}st
ructbabel_route*find_installed_route(constunsignedchar*prefix,unsignedcharplen){
inti=find_route_slot(prefix,plen,NULL);if(i>=0&&routes[i]->installed)returnroute
s[i];returnNULL;}/*Returnsanoverestimateofthenumberofinstalledroutes.*/intinstal
led_routes_estimate(void){returnroute_slots;}staticintresize_route_table(intnew_
slots){structbabel_route**new_routes;assert(new_slots>=route_slots);if(new_slots
==0){new_routes=NULL;free(routes);}else{new_routes=realloc(routes,new_slots*size
of(structbabel_route*));if(new_routes==NULL)return-1;}max_route_slots=new_slots;
routes=new_routes;return1;}/*Insertarouteintothetable.Ifsuccessful,retainstherou
te.Onfailure,callermustfreetheroute.*/staticstructbabel_route*insert_route(struc
tbabel_route*route){inti,n;assert(!route->installed);i=find_route_slot(route->sr
c->prefix,route->src->plen,&n);if(i<0){if(route_slots>=max_route_slots)resize_ro
ute_table(max_route_slots<1?8:2*max_route_slots);if(route_slots>=max_route_slots
)returnNULL;route->next=NULL;if(n<route_slots)memmove(routes+n+1,routes+n,(route
_slots-n)*sizeof(structbabel_route*));route_slots++;routes[n]=route;}else{struct
babel_route*r;r=routes[i];while(r->next)r=r->next;r->next=route;route->next=NULL
;}returnroute;}voidflush_route(structbabel_route*route){inti;structsource*src;un
signedoldmetric;intlost=0;oldmetric=route_metric(route);src=route->src;if(route-
>installed){uninstall_route(route);lost=1;}i=find_route_slot(route->src->prefix,
route->src->plen,NULL);assert(i>=0&&i<route_slots);if(route==routes[i]){routes[i
]=route->next;route->next=NULL;free(route);if(routes[i]==NULL){if(i<route_slots-
1)memmove(routes+i,routes+i+1,(route_slots-i-1)*sizeof(structbabel_route*));rout
es[route_slots-1]=NULL;route_slots--;}if(route_slots==0)resize_route_table(0);el
seif(max_route_slots>8&&route_slots<max_route_slots/4)resize_route_table(max_rou
te_slots/2);}else{structbabel_route*r=routes[i];while(r->next!=route)r=r->next;r
->next=route->next;route->next=NULL;free(route);}if(lost)route_lost(src,oldmetri
c);release_source(src);}voidflush_all_routes(){inti;/*Startfromtheend,toavoidshi
ftingthetable.*/i=route_slots-1;while(i>=0){while(i<route_slots){/*Uninstallfirs
t,toavoidcallingroute_lost.*/if(routes[i]->installed)uninstall_route(routes[i]);
flush_route(routes[i]);}i--;}check_sources_released();}voidflush_neighbour_route
s(structneighbour*neigh){inti;i=0;while(i<route_slots){structbabel_route*r;r=rou
tes[i];while(r){if(r->neigh==neigh){flush_route(r);gotoagain;}r=r->next;}i++;aga
in:;}}voidflush_interface_routes(structinterface*ifp,intv4only){inti;i=0;while(i
<route_slots){structbabel_route*r;r=routes[i];while(r){if(r->neigh->ifp==ifp&&(!
v4only||v4mapped(r->nexthop))){flush_route(r);gotoagain;}r=r->next;}i++;again:;}
}structroute_stream{intinstalled;intindex;structbabel_route*next;};structroute_s
tream*route_stream(intinstalled){structroute_stream*stream;stream=malloc(sizeof(
structroute_stream));if(stream==NULL)returnNULL;stream->installed=installed;stre
am->index=installed?0:-1;stream->next=NULL;returnstream;}structbabel_route*route
_stream_next(structroute_stream*stream){if(stream->installed){while(stream->inde
x<route_slots&&!routes[stream->index]->installed)stream->index++;if(stream->inde
x<route_slots)returnroutes[stream->index++];elsereturnNULL;}else{structbabel_rou
te*next;if(!stream->next){stream->index++;if(stream->index>=route_slots)returnNU
LL;stream->next=routes[stream->index];}next=stream->next;stream->next=next->next
;returnnext;}}voidroute_stream_done(structroute_stream*stream){free(stream);}sta
ticintmetric_to_kernel(intmetric){returnmetric<INFINITY?kernel_metric:KERNEL_INF
INITY;}/*Thisisusedtomaintaintheinvariantthattheinstalledrouteisattheheadoftheli
st.*/staticvoidmove_installed_route(structbabel_route*route,inti){assert(i>=0&&i
<route_slots);assert(route->installed);if(route!=routes[i]){structbabel_route*r=
routes[i];while(r->next!=route)r=r->next;r->next=route->next;route->next=routes[
i];routes[i]=route;}}voidinstall_route(structbabel_route*route){inti,rc;if(route
->installed)return;if(!route_feasible(route))zlog_err("WARNING:installingunfeasi
bleroute""(thisshouldn'thappen).");i=find_route_slot(route->src->prefix,route->s
rc->plen,NULL);assert(i>=0&&i<route_slots);if(routes[i]!=route&&routes[i]->insta
lled){zlog_err("WARNING:attemptingtoinstallduplicateroute""(thisshouldn'thappen)
.");return;}rc=kernel_route(ROUTE_ADD,route->src->prefix,route->src->plen,route-
>nexthop,route->neigh->ifp->ifindex,metric_to_kernel(route_metric(route)),NULL,0
,0);if(rc<0){intsave=errno;zlog_err("kernel_route(ADD):%s",safe_strerror(errno))
;if(save!=EEXIST)return;}route->installed=1;move_installed_route(route,i);}voidu
ninstall_route(structbabel_route*route){intrc;if(!route->installed)return;rc=ker
nel_route(ROUTE_FLUSH,route->src->prefix,route->src->plen,route->nexthop,route->
neigh->ifp->ifindex,metric_to_kernel(route_metric(route)),NULL,0,0);if(rc<0)zlog
_err("kernel_route(FLUSH):%s",safe_strerror(errno));route->installed=0;}/*Thisis
equivalenttouninstall_routefollowedwithinstall_route,butwithouttheracecondition.
Thedestinationofbothroutesmustbethesame.*/staticvoidswitch_routes(structbabel_ro
ute*old,structbabel_route*new){intrc;if(!old){install_route(new);return;}if(!old
->installed)return;if(!route_feasible(new))zlog_err("WARNING:switchingtounfeasib
leroute""(thisshouldn'thappen).");rc=kernel_route(ROUTE_MODIFY,old->src->prefix,
old->src->plen,old->nexthop,old->neigh->ifp->ifindex,metric_to_kernel(route_metr
ic(old)),new->nexthop,new->neigh->ifp->ifindex,metric_to_kernel(route_metric(new
)));if(rc<0){zlog_err("kernel_route(MODIFY):%s",safe_strerror(errno));return;}ol
d->installed=0;new->installed=1;move_installed_route(new,find_route_slot(new->sr
c->prefix,new->src->plen,NULL));}staticvoidchange_route_metric(structbabel_route
*route,unsignedrefmetric,unsignedcost,unsignedadd){intold,new;intnewmetric=MIN(r
efmetric+cost+add,INFINITY);old=metric_to_kernel(route_metric(route));new=metric
_to_kernel(newmetric);if(route->installed&&old!=new){intrc;rc=kernel_route(ROUTE
_MODIFY,route->src->prefix,route->src->plen,route->nexthop,route->neigh->ifp->if
index,old,route->nexthop,route->neigh->ifp->ifindex,new);if(rc<0){zlog_err("kern
el_route(MODIFYmetric):%s",safe_strerror(errno));return;}}/*Updateroute->smoothe
d_metricusingtheoldmetric.*/route_smoothed_metric(route);route->refmetric=refmet
ric;route->cost=cost;route->add_metric=add;if(smoothing_half_life==0){route->smo
othed_metric=route_metric(route);route->smoothed_metric_time=babel_now.tv_sec;}}
staticvoidretract_route(structbabel_route*route){/*Wecannotsimplyremovetheroutef
romthekernel,asthatmightcausearoutingloop--seeRFC6126Sections2.8and3.5.5.*/chang
e_route_metric(route,INFINITY,INFINITY,0);}introute_feasible(structbabel_route*r
oute){returnupdate_feasible(route->src,route->seqno,route->refmetric);}introute_
old(structbabel_route*route){returnroute->time<babel_now.tv_sec-route->hold_time
*7/8;}introute_expired(structbabel_route*route){returnroute->time<babel_now.tv_s
ec-route->hold_time;}staticintchannels_interfere(intch1,intch2){if(ch1==BABEL_IF
_CHANNEL_NONINTERFERING||ch2==BABEL_IF_CHANNEL_NONINTERFERING)return0;if(ch1==BA
BEL_IF_CHANNEL_INTERFERING||ch2==BABEL_IF_CHANNEL_INTERFERING)return1;returnch1=
=ch2;}introute_interferes(structbabel_route*route,structinterface*ifp){structbab
el_interface*babel_ifp=NULL;switch(diversity_kind){caseDIVERSITY_NONE:return1;ca
seDIVERSITY_INTERFACE_1:returnroute->neigh->ifp==ifp;caseDIVERSITY_CHANNEL_1:cas
eDIVERSITY_CHANNEL:if(route->neigh->ifp==ifp)return1;babel_ifp=babel_get_if_nfo(
ifp);if(channels_interfere(babel_ifp->channel,babel_get_if_nfo(route->neigh->ifp
)->channel))return1;if(diversity_kind==DIVERSITY_CHANNEL){inti;for(i=0;i<DIVERSI
TY_HOPS;i++){if(route->channels[i]==0)break;if(channels_interfere(babel_ifp->cha
nnel,route->channels[i]))return1;}}return0;default:zlog_err("Unknownkindofdivers
ity.");return1;}}intupdate_feasible(structsource*src,unsignedshortseqno,unsigned
shortrefmetric){if(src==NULL)return1;if(src->time<babel_now.tv_sec-SOURCE_GC_TIM
E)/*Nevermindwhatisprobablystaledata*/return1;if(refmetric>=INFINITY)/*Retractio
nsarealwaysfeasible*/return1;return(seqno_compare(seqno,src->seqno)>0||(src->seq
no==seqno&&refmetric<src->metric));}voidchange_smoothing_half_life(inthalf_life)
{if(half_life<=0){smoothing_half_life=0;two_to_the_one_over_hl=0;return;}smoothi
ng_half_life=half_life;switch(smoothing_half_life){case1:two_to_the_one_over_hl=
131072;break;case2:two_to_the_one_over_hl=92682;break;case3:two_to_the_one_over_
hl=82570;break;case4:two_to_the_one_over_hl=77935;break;default:/*2^(1/x)is1+log
(2)/x+O(1/x^2)atinfinity.*/two_to_the_one_over_hl=0x10000+45426/half_life;}}/*Up
datethesmoothedmetric,returnthenewvalue.*/introute_smoothed_metric(structbabel_r
oute*route){intmetric=route_metric(route);if(smoothing_half_life<=0||/*nosmoothi
ng*/metric>=INFINITY||/*routeretracted*/route->smoothed_metric_time>babel_now.tv
_sec||/*clockstepped*/route->smoothed_metric==metric){/*alreadyconverged*/route-
>smoothed_metric=metric;route->smoothed_metric_time=babel_now.tv_sec;}else{intdi
ff;/*Werandomisethecomputation,tominimiseglobalsynchronisationandhenceoscillatio
ns.*/while(route->smoothed_metric_time<=babel_now.tv_sec-smoothing_half_life){di
ff=metric-route->smoothed_metric;route->smoothed_metric+=roughly(diff)/2;route->
smoothed_metric_time+=smoothing_half_life;}while(route->smoothed_metric_time<bab
el_now.tv_sec){diff=metric-route->smoothed_metric;route->smoothed_metric+=roughl
y(diff)*(two_to_the_one_over_hl-0x10000)/0x10000;route->smoothed_metric_time++;}
diff=metric-route->smoothed_metric;if(diff>-4&&diff<4)route->smoothed_metric=met
ric;}/*change_route_metricreliesonthis*/assert(route->smoothed_metric_time==babe
l_now.tv_sec);returnroute->smoothed_metric;}staticintroute_acceptable(structbabe
l_route*route,intfeasible,structneighbour*exclude){if(route_expired(route))retur
n0;if(feasible&&!route_feasible(route))return0;if(exclude&&route->neigh==exclude
)return0;return1;}/*Findthebestrouteaccordingtotheweakordering.Anylinearisationo
fthestrongordering(seeconsider_route)willdo,weusesm<=sm'.Wecouldprobablyusealexi
calordering,butthat'sprobablyoverkill.*/structbabel_route*find_best_route(constu
nsignedchar*prefix,unsignedcharplen,intfeasible,structneighbour*exclude){structb
abel_route*route=NULL,*r=NULL;inti=find_route_slot(prefix,plen,NULL);if(i<0)retu
rnNULL;route=routes[i];while(route&&!route_acceptable(route,feasible,exclude))ro
ute=route->next;if(!route)returnNULL;r=route->next;while(r){if(route_acceptable(
r,feasible,exclude)&&(route_smoothed_metric(r)<route_smoothed_metric(route)))rou
te=r;r=r->next;}returnroute;}voidupdate_route_metric(structbabel_route*route){in
toldmetric=route_metric(route);intold_smoothed_metric=route_smoothed_metric(rout
e);if(route_expired(route)){if(route->refmetric<INFINITY){route->seqno=seqno_plu
s(route->src->seqno,1);retract_route(route);if(oldmetric<INFINITY)route_changed(
route,route->src,oldmetric);}}else{structneighbour*neigh=route->neigh;intadd_met
ric=input_filter(route->src->id,route->src->prefix,route->src->plen,neigh->addre
ss,neigh->ifp->ifindex);change_route_metric(route,route->refmetric,neighbour_cos
t(route->neigh),add_metric);if(route_metric(route)!=oldmetric||route_smoothed_me
tric(route)!=old_smoothed_metric)route_changed(route,route->src,oldmetric);}}/*C
alledwheneveraneighbour'scostchanges,toupdatethemetricofallroutesthroughthatneig
hbour.*/voidupdate_neighbour_metric(structneighbour*neigh,intchanged){if(changed
){inti;for(i=0;i<route_slots;i++){structbabel_route*r=routes[i];while(r){if(r->n
eigh==neigh)update_route_metric(r);r=r->next;}}}}voidupdate_interface_metric(str
uctinterface*ifp){inti;for(i=0;i<route_slots;i++){structbabel_route*r=routes[i];
while(r){if(r->neigh->ifp==ifp)update_route_metric(r);r=r->next;}}}/*Thisiscalle
dwheneverwereceiveanupdate.*/structbabel_route*update_route(constunsignedchar*ro
uter_id,constunsignedchar*prefix,unsignedcharplen,unsignedshortseqno,unsignedsho
rtrefmetric,unsignedshortinterval,structneighbour*neigh,constunsignedchar*nextho
p,constunsignedchar*channels,intchannels_len){structbabel_route*route;structsour
ce*src;intmetric,feasible;intadd_metric;inthold_time=MAX((4*interval)/100+interv
al/50,15);if(memcmp(router_id,myid,8)==0)returnNULL;if(martian_prefix(prefix,ple
n)){zlog_err("Rejectingmartianrouteto%sthrough%s.",format_prefix(prefix,plen),fo
rmat_address(nexthop));returnNULL;}add_metric=input_filter(router_id,prefix,plen
,neigh->address,neigh->ifp->ifindex);if(add_metric>=INFINITY)returnNULL;route=fi
nd_route(prefix,plen,neigh,nexthop);if(route&&memcmp(route->src->id,router_id,8)
==0)/*Avoidscanningthesourcetable.*/src=route->src;elsesrc=find_source(router_id
,prefix,plen,1,seqno);if(src==NULL)returnNULL;feasible=update_feasible(src,seqno
,refmetric);metric=MIN((int)refmetric+neighbour_cost(neigh)+add_metric,INFINITY)
;if(route){structsource*oldsrc;unsignedshortoldmetric;intlost=0;oldsrc=route->sr
c;oldmetric=route_metric(route);/*Ifasuccessorswitchessources,wemustaccepthisupd
ateevenifitmakesarouteunfeasibleinordertobreakanyroutingloopsinatimelymanner.Ift
hesourceremainsthesame,weignoretheupdate.*/if(!feasible&&route->installed){debug
f(BABEL_DEBUG_COMMON,"Unfeasibleupdateforinstalledrouteto%s""(%s%d%d->%s%d%d).",
format_prefix(src->prefix,src->plen),format_eui64(route->src->id),route->seqno,r
oute->refmetric,format_eui64(src->id),seqno,refmetric);if(src!=route->src){unins
tall_route(route);lost=1;}}route->src=retain_source(src);if((feasible||keep_unfe
asible)&&refmetric<INFINITY)route->time=babel_now.tv_sec;route->seqno=seqno;mems
et(&route->channels,0,sizeof(route->channels));if(channels_len>0)memcpy(&route->
channels,channels,MIN(channels_len,DIVERSITY_HOPS));change_route_metric(route,re
fmetric,neighbour_cost(neigh),add_metric);route->hold_time=hold_time;route_chang
ed(route,oldsrc,oldmetric);if(lost)route_lost(oldsrc,oldmetric);if(!feasible)sen
d_unfeasible_request(neigh,route->installed&&route_old(route),seqno,metric,src);
release_source(oldsrc);}else{structbabel_route*new_route;if(refmetric>=INFINITY)
/*Somebody'sretractingarouteweneversaw.*/returnNULL;if(!feasible){send_unfeasibl
e_request(neigh,0,seqno,metric,src);if(!keep_unfeasible)returnNULL;}route=malloc
(sizeof(structbabel_route));if(route==NULL){perror("malloc(route)");returnNULL;}
route->src=retain_source(src);route->refmetric=refmetric;route->cost=neighbour_c
ost(neigh);route->add_metric=add_metric;route->seqno=seqno;route->neigh=neigh;me
mcpy(route->nexthop,nexthop,16);route->time=babel_now.tv_sec;route->hold_time=ho
ld_time;route->smoothed_metric=MAX(route_metric(route),INFINITY/2);route->smooth
ed_metric_time=babel_now.tv_sec;route->installed=0;memset(&route->channels,0,siz
eof(route->channels));if(channels_len>0)memcpy(&route->channels,channels,MIN(cha
nnels_len,DIVERSITY_HOPS));route->next=NULL;new_route=insert_route(route);if(new
_route==NULL){zlog_err("Couldn'tinsertroute.");free(route);returnNULL;}consider_
route(route);}returnroute;}/*Wejustreceivedanunfeasibleupdate.Ifit'sanygood,send
arequestforanewseqno.*/voidsend_unfeasible_request(structneighbour*neigh,intforc
e,unsignedshortseqno,unsignedshortmetric,structsource*src){structbabel_route*rou
te=find_installed_route(src->prefix,src->plen);if(seqno_minus(src->seqno,seqno)>
100){/*Probablyasourcethatlostitsseqno.Letittime-out.*/return;}if(force||!route|
|route_metric(route)>=metric+512){send_unicast_multihop_request(neigh,src->prefi
x,src->plen,src->metric>=INFINITY?src->seqno:seqno_plus(src->seqno,1),src->id,12
7);}}/*Thistakesafeasiblerouteanddecideswhethertoinstallit.Thisusesthestrongorde
ring,whichisdefinedbysm<=sm'ANDm<=m'.Thisorderingisnottotal,whichiswhatcauseshys
teresis.*/staticvoidconsider_route(structbabel_route*route){structbabel_route*in
stalled;structxroute*xroute;if(route->installed)return;if(!route_feasible(route)
)return;xroute=find_xroute(route->src->prefix,route->src->plen);if(xroute)return
;installed=find_installed_route(route->src->prefix,route->src->plen);if(installe
d==NULL)gotoinstall;if(route_metric(route)>=INFINITY)return;if(route_metric(inst
alled)>=INFINITY)gotoinstall;if(route_metric(installed)>=route_metric(route)&&ro
ute_smoothed_metric(installed)>route_smoothed_metric(route))gotoinstall;return;i
nstall:switch_routes(installed,route);if(installed&&route->installed)send_trigge
red_update(route,installed->src,route_metric(installed));elsesend_update(NULL,1,
route->src->prefix,route->src->plen);return;}voidretract_neighbour_routes(struct
neighbour*neigh){inti;for(i=0;i<route_slots;i++){structbabel_route*r=routes[i];w
hile(r){if(r->neigh==neigh){if(r->refmetric!=INFINITY){unsignedshortoldmetric=ro
ute_metric(r);retract_route(r);if(oldmetric!=INFINITY)route_changed(r,r->src,old
metric);}}r=r->next;}}}voidsend_triggered_update(structbabel_route*route,structs
ource*oldsrc,unsignedoldmetric){unsignednewmetric,diff;/*1meanssendspeedily,2mea
nsresend*/inturgent;if(!route->installed)return;newmetric=route_metric(route);di
ff=newmetric>=oldmetric?newmetric-oldmetric:oldmetric-newmetric;if(route->src!=o
ldsrc||(oldmetric<INFINITY&&newmetric>=INFINITY))/*Switchingsourcescancausetrans
ientroutingloops.Retractionscancauseblackholes.*/urgent=2;elseif(newmetric>oldme
tric&&oldmetric<6*256&&diff>=512)/*Routegettingsignificantlyworse*/urgent=1;else
if(unsatisfied_request(route->src->prefix,route->src->plen,route->seqno,route->s
rc->id))/*Makesurethatrequestsaresatisfiedspeedily*/urgent=1;elseif(oldmetric>=I
NFINITY&&newmetric<INFINITY)/*Newroute*/urgent=0;elseif(newmetric<oldmetric&&dif
f<1024)/*Routegettingbetter.Thismaybeatransientfluctuation,sodon'tadvertiseittoa
voidmakingroutesunfeasiblelateron.*/return;elseif(diff<384)/*Don'tfretabouttrivi
alities*/return;elseurgent=0;if(urgent>=2)send_update_resend(NULL,route->src->pr
efix,route->src->plen);elsesend_update(NULL,urgent,route->src->prefix,route->src
->plen);if(oldmetric<INFINITY){if(newmetric>=oldmetric+512){send_request_resend(
NULL,route->src->prefix,route->src->plen,route->src->metric>=INFINITY?route->src
->seqno:seqno_plus(route->src->seqno,1),route->src->id);}elseif(newmetric>=oldme
tric+288){send_request(NULL,route->src->prefix,route->src->plen);}}}/*Aroutehasj
ustchanged.Decidewhethertoswitchtoadifferentrouteorsendanupdate.*/voidroute_chan
ged(structbabel_route*route,structsource*oldsrc,unsignedshortoldmetric){if(route
->installed){structbabel_route*better_route;/*Dothisunconditionally--microoptimi
sationisnotworthit.*/better_route=find_best_route(route->src->prefix,route->src-
>plen,1,NULL);if(better_route&&route_metric(better_route)<route_metric(route))co
nsider_route(better_route);}if(route->installed){/*Wedidn'tchangeroutesafterall.
*/send_triggered_update(route,oldsrc,oldmetric);}else{/*Reconsiderroutesevenwhen
theirmetricdidn'tdecrease,theymaynothavebeenfeasiblebefore.*/consider_route(rout
e);}}/*Wejustlosttheinstalledroutetoagivendestination.*/voidroute_lost(structsou
rce*src,unsignedoldmetric){structbabel_route*new_route;new_route=find_best_route
(src->prefix,src->plen,1,NULL);if(new_route){consider_route(new_route);}elseif(o
ldmetric<INFINITY){/*Avoidcreatingablackhole.*/send_update_resend(NULL,src->pref
ix,src->plen);/*Iftheroutewasusableenough,trytogetanalternateone.Ifitwasnot,weco
uldbedealingwithoscillationsaroundthevalueofINFINITY.*/if(oldmetric<=INFINITY/2)
send_request_resend(NULL,src->prefix,src->plen,src->metric>=INFINITY?src->seqno:
seqno_plus(src->seqno,1),src->id);}}/*Thisiscalledperiodicallytoflusholdroutes.I
twillalsosendrequestsforroutesthatareabouttoexpire.*/voidexpire_routes(void){str
uctbabel_route*r;inti;debugf(BABEL_DEBUG_COMMON,"Expiringoldroutes.");i=0;while(
i<route_slots){r=routes[i];while(r){/*Protectagainstclockbeingstepped.*/if(r->ti
me>babel_now.tv_sec||route_old(r)){flush_route(r);gotoagain;}update_route_metric
(r);if(r->installed&&r->refmetric<INFINITY){if(route_old(r))/*Routeabouttoexpire
,sendarequest.*/send_unicast_request(r->neigh,r->src->prefix,r->src->plen);}r=r-
>next;}i++;again:;}}