/*Copyright(c)2007,2008byJuliuszChroboczekCopyright2011byMatthieuBoutierandJuliu
szChroboczekPermissionisherebygranted,freeofcharge,toanypersonobtainingacopyofth
issoftwareandassociateddocumentationfiles(the"Software"),todealintheSoftwarewith
outrestriction,includingwithoutlimitationtherightstouse,copy,modify,merge,publis
h,distribute,sublicense,and/orsellcopiesoftheSoftware,andtopermitpersonstowhomth
eSoftwareisfurnishedtodoso,subjecttothefollowingconditions:Theabovecopyrightnoti
ceandthispermissionnoticeshallbeincludedinallcopiesorsubstantialportionsoftheSof
tware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCL
UDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY,FITNESSFORAPARTICULARPURPOSEA
NDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,
DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,
OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERDEALINGSINTHESOFTWARE.*/#ifndef
BABEL_UTIL_H#defineBABEL_UTIL_H#include"babeld.h"#include"babel_main.h"#include"
log.h"#ifdefined(i386)||defined(__mc68020__)||defined(__x86_64__)#defineDO_NTOHS
(_d,_s)do{_d=ntohs(*(constunsignedshort*)(_s));}while(0)#defineDO_NTOHL(_d,_s)do
{_d=ntohl(*(constunsigned*)(_s));}while(0)#defineDO_HTONS(_d,_s)do{*(unsignedsho
rt*)(_d)=htons(_s);}while(0)#defineDO_HTONL(_d,_s)do{*(unsigned*)(_d)=htonl(_s);
}while(0)/*Someversionsofgccseemtobebuggy,andignorethepackedattribute.Disablethi
scodeuntiltheissueisclarified.*//*#elifdefined__GNUC__*/#else#defineDO_NTOHS(_d,
_s)\do{short_dd;\memcpy(&(_dd),(_s),2);\_d=ntohs(_dd);}while(0)#defineDO_NTOHL(_
d,_s)\do{int_dd;\memcpy(&(_dd),(_s),4);\_d=ntohl(_dd);}while(0)#defineDO_HTONS(_
d,_s)\do{unsignedshort_dd;\_dd=htons(_s);\memcpy((_d),&(_dd),2);}while(0)#define
DO_HTONL(_d,_s)\do{unsigned_dd;\_dd=htonl(_s);\memcpy((_d),&(_dd),4);}while(0)#e
ndifstaticinlineintseqno_compare(unsignedshorts1,unsignedshorts2){if(s1==s2)retu
rn0;elsereturn((s2-s1)&0x8000)?1:-1;}staticinlineshortseqno_minus(unsignedshorts
1,unsignedshorts2){return(short)((s1-s2)&0xFFFF);}staticinlineunsignedshortseqno
_plus(unsignedshorts,intplus){return((s+plus)&0xFFFF);}/*Returnsatimeinmicroseco
ndson32bits(thusmodulo2^32,i.e.about4295seconds).*/staticinlineunsignedinttime_u
s(conststructtimevalt){return(unsignedint)(t.tv_sec*1000000+t.tv_usec);}intrough
ly(intvalue);voidtimeval_minus(structtimeval*d,conststructtimeval*s1,conststruct
timeval*s2);unsignedtimeval_minus_msec(conststructtimeval*s1,conststructtimeval*
s2)ATTRIBUTE((pure));voidtimeval_add_msec(structtimeval*d,conststructtimeval*s,i
ntmsecs);voidset_timeout(structtimeval*timeout,intmsecs);inttimeval_compare(cons
tstructtimeval*s1,conststructtimeval*s2)ATTRIBUTE((pure));voidtimeval_min(struct
timeval*d,conststructtimeval*s);voidtimeval_min_sec(structtimeval*d,time_tsecs);
intparse_nat(constchar*string)ATTRIBUTE((pure));intparse_msec(constchar*string)A
TTRIBUTE((pure));intin_prefix(constunsignedchar*restrictaddress,constunsignedcha
r*restrictprefix,unsignedcharplen)ATTRIBUTE((pure));unsignedchar*mask_prefix(uns
ignedchar*restrictret,constunsignedchar*restrictprefix,unsignedcharplen);constch
ar*format_address(constunsignedchar*address);constchar*format_prefix(constunsign
edchar*address,unsignedcharprefix);constchar*format_eui64(constunsignedchar*eui)
;constchar*format_thousands(unsignedintvalue);intparse_address(constchar*address
,unsignedchar*addr_r,int*af_r);intparse_eui64(constchar*eui,unsignedchar*eui_r);
intwait_for_fd(intdirection,intfd,intmsecs);intmartian_prefix(constunsignedchar*
prefix,intplen)ATTRIBUTE((pure));intlinklocal(constunsignedchar*address)ATTRIBUT
E((pure));intv4mapped(constunsignedchar*address)ATTRIBUTE((pure));voidv4tov6(uns
ignedchar*dst,constunsignedchar*src);voidinaddr_to_uchar(unsignedchar*dest,const
structin_addr*src);voiduchar_to_inaddr(structin_addr*dest,constunsignedchar*src)
;voidin6addr_to_uchar(unsignedchar*dest,conststructin6_addr*src);voiduchar_to_in
6addr(structin6_addr*dest,constunsignedchar*src);intdaemonise(void);constunsigne
dcharv4prefix[16];/*Ifdebuggingisdisabled,wewanttoavoidcallingformat_addressfore
veryomitteddebuggingmessage.Sodebugisamacro.Butvarargmacrosarenotportable.*/#ifd
efinedNO_DEBUG#ifdefined__STDC_VERSION__&&__STDC_VERSION__>=199901L#definedebugf
(...)do{}while(0)#elifdefined__GNUC__#definedebugf(_args...)do{}while(0)#elsesta
ticinlinevoiddebugf(intlevel,constchar*format,...){return;}#endif#else/*NO_DEBUG
*//*somelevels*/#defineBABEL_DEBUG_COMMON(1<<0)#defineBABEL_DEBUG_KERNEL(1<<1)#d
efineBABEL_DEBUG_FILTER(1<<2)#defineBABEL_DEBUG_TIMEOUT(1<<3)#defineBABEL_DEBUG_
IF(1<<4)#defineBABEL_DEBUG_ROUTE(1<<5)#defineBABEL_DEBUG_ALL(0xFFFF)#ifdefined__
STDC_VERSION__&&__STDC_VERSION__>=199901L#definedebugf(level,...)\do{\if(UNLIKEL
Y(debug&level))zlog_debug(__VA_ARGS__);\}while(0)#elifdefined__GNUC__#definedebu
gf(level,_args...)\do{\if(UNLIKELY(debug&level))zlog_debug(_args);\}while(0)#els
estaticinlinevoiddebugf(intlevel,constchar*format,...){return;}#endif#endif/*NO_
DEBUG*/#endif/*BABEL_UTIL_H*/