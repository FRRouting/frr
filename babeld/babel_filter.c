/*Copyright2011byMatthieuBoutierandJuliuszChroboczekPermissionisherebygranted,fr
eeofcharge,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfile
s(the"Software"),todealintheSoftwarewithoutrestriction,includingwithoutlimitatio
ntherightstouse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopies
oftheSoftware,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothef
ollowingconditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincluded
inallcopiesorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOU
TWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCH
ANTABILITY,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHO
RSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIO
NOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEU
SEOROTHERDEALINGSINTHESOFTWARE.*/#include"babel_filter.h"#include"vty.h"#include
"filter.h"#include"log.h"#include"plist.h"#include"distribute.h"#include"util.h"
intbabel_filter(intoutput,constunsignedchar*prefix,unsignedshortplen,unsignedint
ifindex){structinterface*ifp=if_lookup_by_index(ifindex,VRF_DEFAULT);babel_inter
face_nfo*babel_ifp=ifp?babel_get_if_nfo(ifp):NULL;structprefixp;structdistribute
*dist;structaccess_list*alist;structprefix_list*plist;intdistribute;p.family=v4m
apped(prefix)?AF_INET:AF_INET6;p.prefixlen=v4mapped(prefix)?plen-96:plen;if(p.fa
mily==AF_INET){uchar_to_inaddr(&p.u.prefix4,prefix);distribute=output?DISTRIBUTE
_V4_OUT:DISTRIBUTE_V4_IN;}else{uchar_to_in6addr(&p.u.prefix6,prefix);distribute=
output?DISTRIBUTE_V6_OUT:DISTRIBUTE_V6_IN;}if(babel_ifp!=NULL&&babel_ifp->list[d
istribute]){if(access_list_apply(babel_ifp->list[distribute],&p)==FILTER_DENY){d
ebugf(BABEL_DEBUG_FILTER,"%s/%dfilteredbydistribute%s",p.family==AF_INET?inet_nt
oa(p.u.prefix4):inet6_ntoa(p.u.prefix6),p.prefixlen,output?"out":"in");returnINF
INITY;}}if(babel_ifp!=NULL&&babel_ifp->prefix[distribute]){if(prefix_list_apply(
babel_ifp->prefix[distribute],&p)==PREFIX_DENY){debugf(BABEL_DEBUG_FILTER,"%s/%d
filteredbydistribute%s",p.family==AF_INET?inet_ntoa(p.u.prefix4):inet6_ntoa(p.u.
prefix6),p.prefixlen,output?"out":"in");returnINFINITY;}}/*Allinterfacefilterche
ck.*/dist=distribute_lookup(NULL);if(dist){if(dist->list[distribute]){alist=acce
ss_list_lookup(p.family,dist->list[distribute]);if(alist){if(access_list_apply(a
list,&p)==FILTER_DENY){debugf(BABEL_DEBUG_FILTER,"%s/%dfilteredbydistribute%s",p
.family==AF_INET?inet_ntoa(p.u.prefix4):inet6_ntoa(p.u.prefix6),p.prefixlen,outp
ut?"out":"in");returnINFINITY;}}}if(dist->prefix[distribute]){plist=prefix_list_
lookup(p.family,dist->prefix[distribute]);if(plist){if(prefix_list_apply(plist,&
p)==PREFIX_DENY){debugf(BABEL_DEBUG_FILTER,"%s/%dfilteredbydistribute%s",p.famil
y==AF_INET?inet_ntoa(p.u.prefix4):inet6_ntoa(p.u.prefix6),p.prefixlen,output?"ou
t":"in");returnINFINITY;}}}}return0;}