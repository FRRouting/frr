/*Copyright(c)2007,2008byJuliuszChroboczekPermissionisherebygranted,freeofcharge
,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfiles(the"Soft
ware"),todealintheSoftwarewithoutrestriction,includingwithoutlimitationtherights
touse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopiesoftheSoftw
are,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothefollowingco
nditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincludedinallcopie
sorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYO
FANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY
,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRI
GHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRAC
T,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERD
EALINGSINTHESOFTWARE.*/#include<zebra.h>#include"if.h"#include"babeld.h"#include
"util.h"#include"net.h"#include"babel_interface.h"#include"source.h"#include"nei
ghbour.h"#include"route.h"#include"xroute.h"#include"resend.h"#include"message.h
"#include"kernel.h"#include"babel_main.h"staticunsignedcharpacket_header[4]={42,
2};intsplit_horizon=1;unsignedshortmyseqno=0;#defineUNICAST_BUFSIZE1024staticint
unicast_buffered=0;staticunsignedchar*unicast_buffer=NULL;structneighbour*unicas
t_neighbour=NULL;structtimevalunicast_flush_timeout={0,0};/*MinimumTLV_body_leng
thforTLVsofparticulartypes(0=nolimit).*/staticconstunsignedchartlv_min_length[ME
SSAGE_MAX+1]={[MESSAGE_PAD1]=0,[MESSAGE_PADN]=0,[MESSAGE_ACK_REQ]=6,[MESSAGE_ACK
]=2,[MESSAGE_HELLO]=6,[MESSAGE_IHU]=6,[MESSAGE_ROUTER_ID]=10,[MESSAGE_NH]=2,[MES
SAGE_UPDATE]=10,[MESSAGE_REQUEST]=2,[MESSAGE_MH_REQUEST]=14,};/*Parseanetworkpre
fix,encodedinthesomewhatbaroquecompressedrepresentationusedbyBabel.Returnthenumb
erofbytesparsed.*/staticintnetwork_prefix(intae,intplen,unsignedintomitted,const
unsignedchar*p,constunsignedchar*dp,unsignedintlen,unsignedchar*p_r){unsignedpb;
unsignedcharprefix[16];intret=-1;if(plen>=0)pb=(plen+7)/8;elseif(ae==1)pb=4;else
pb=16;if(pb>16)return-1;memset(prefix,0,16);switch(ae){case0:ret=0;break;case1:i
f(omitted>4||pb>4||(pb>omitted&&len<pb-omitted))return-1;memcpy(prefix,v4prefix,
12);if(omitted){if(dp==NULL||!v4mapped(dp))return-1;memcpy(prefix,dp,12+omitted)
;}if(pb>omitted)memcpy(prefix+12+omitted,p,pb-omitted);ret=pb-omitted;break;case
2:if(omitted>16||(pb>omitted&&len<pb-omitted))return-1;if(omitted){if(dp==NULL||
v4mapped(dp))return-1;memcpy(prefix,dp,omitted);}if(pb>omitted)memcpy(prefix+omi
tted,p,pb-omitted);ret=pb-omitted;break;case3:if(pb>8&&len<pb-8)return-1;prefix[
0]=0xfe;prefix[1]=0x80;if(pb>8)memcpy(prefix+8,p,pb-8);ret=pb-8;break;default:re
turn-1;}mask_prefix(p_r,prefix,plen<0?128:ae==1?plen+96:plen);returnret;}staticv
oidparse_update_subtlv(constunsignedchar*a,intalen,unsignedchar*channels){inttyp
e,len,i=0;while(i<alen){type=a[i];if(type==SUBTLV_PAD1){i++;continue;}if(i+1>ale
n){zlog_err("Receivedtruncatedattributes.");return;}len=a[i+1];if(i+len>alen){zl
og_err("Receivedtruncatedattributes.");return;}if(type==SUBTLV_PADN){/*Nothing.*
/}elseif(type==SUBTLV_DIVERSITY){if(len>DIVERSITY_HOPS){zlog_err("Receivedoverlo
ngchannelinformation(%d>%d).n",len,DIVERSITY_HOPS);len=DIVERSITY_HOPS;}if(memchr
(a+i+2,0,len)!=NULL){/*0isreserved.*/zlog_err("Channelinformationcontains0!");re
turn;}memset(channels,0,DIVERSITY_HOPS);memcpy(channels,a+i+2,len);}else{debugf(
BABEL_DEBUG_COMMON,"Receivedunknownrouteattribute%d.",type);}i+=len+2;}}staticin
tparse_hello_subtlv(constunsignedchar*a,intalen,unsignedint*hello_send_us){intty
pe,len,i=0,ret=0;while(i<alen){type=a[0];if(type==SUBTLV_PAD1){i++;continue;}if(
i+1>alen){zlog_err("Receivedtruncatedsub-TLVonHellomessage.");return-1;}len=a[i+
1];if(i+len>alen){zlog_err("Receivedtruncatedsub-TLVonHellomessage.");return-1;}
if(type==SUBTLV_PADN){/*Nothingtodo.*/}elseif(type==SUBTLV_TIMESTAMP){if(len>=4)
{DO_NTOHL(*hello_send_us,a+i+2);ret=1;}else{zlog_err("ReceivedincorrectRTTsub-TL
VonHellomessage.");}}else{debugf(BABEL_DEBUG_COMMON,"ReceivedunknownHellosub-TLV
type%d.",type);}i+=len+2;}returnret;}staticintparse_ihu_subtlv(constunsignedchar
*a,intalen,unsignedint*hello_send_us,unsignedint*hello_rtt_receive_time){inttype
,len,i=0,ret=0;while(i<alen){type=a[0];if(type==SUBTLV_PAD1){i++;continue;}if(i+
1>alen){zlog_err("Receivedtruncatedsub-TLVonIHUmessage.");return-1;}len=a[i+1];i
f(i+len>alen){zlog_err("Receivedtruncatedsub-TLVonIHUmessage.");return-1;}if(typ
e==SUBTLV_PADN){/*Nothingtodo.*/}elseif(type==SUBTLV_TIMESTAMP){if(len>=8){DO_NT
OHL(*hello_send_us,a+i+2);DO_NTOHL(*hello_rtt_receive_time,a+i+6);ret=1;}else{zl
og_err("ReceivedincorrectRTTsub-TLVonIHUmessage.");}}else{debugf(BABEL_DEBUG_COM
MON,"ReceivedunknownIHUsub-TLVtype%d.",type);}i+=len+2;}returnret;}staticintnetw
ork_address(intae,constunsignedchar*a,unsignedintlen,unsignedchar*a_r){returnnet
work_prefix(ae,-1,0,a,NULL,len,a_r);}staticintchannels_len(unsignedchar*channels
){unsignedchar*p=memchr(channels,0,DIVERSITY_HOPS);returnp?(p-channels):DIVERSIT
Y_HOPS;}/*Check,thattheprovidedframeconsistsofavalidBabelpacketheaderfollowedbya
sequenceofTLVs.TLVsofknowntypesarealsocheckedtomeetminimumlengthconstraintsdefin
edforeach.Return0fornoerrors.*/staticintbabel_packet_examin(constunsignedchar*pa
cket,intpacketlen){unsignedi=0,bodylen;constunsignedchar*message;unsignedchartyp
e,len;if(packetlen<4||packet[0]!=42||packet[1]!=2)return1;DO_NTOHS(bodylen,packe
t+2);while(i<bodylen){message=packet+4+i;type=message[0];if(type==MESSAGE_PAD1){
i++;continue;}if(i+1>bodylen){debugf(BABEL_DEBUG_COMMON,"Receivedtruncatedmessag
e.");return1;}len=message[1];if(i+len>bodylen){debugf(BABEL_DEBUG_COMMON,"Receiv
edtruncatedmessage.");return1;}/*notPad1*/if(type<=MESSAGE_MAX&&tlv_min_length[t
ype]&&len<tlv_min_length[type]){debugf(BABEL_DEBUG_COMMON,"Undersized%uTLV",type
);return1;}i+=len+2;}return0;}voidparse_packet(constunsignedchar*from,structinte
rface*ifp,constunsignedchar*packet,intpacketlen){inti;constunsignedchar*message;
unsignedchartype,len;intbodylen;structneighbour*neigh;inthave_router_id=0,have_v
4_prefix=0,have_v6_prefix=0,have_v4_nh=0,have_v6_nh=0;unsignedcharrouter_id[8],v
4_prefix[16],v6_prefix[16],v4_nh[16],v6_nh[16];inthave_hello_rtt=0;/*Contentofth
eRTTsub-TLVonIHUmessages.*/unsignedinthello_send_us=0,hello_rtt_receive_time=0;b
abel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);if(babel_ifp->flags&BABEL_IF_
TIMESTAMPS){/*Wewanttotrackexactlywhenwereceivedthispacket.*/gettime(&babel_now)
;}if(!linklocal(from)){zlog_err("Receivedpacketfromnon-localaddress%s.",format_a
ddress(from));return;}if(babel_packet_examin(packet,packetlen)){zlog_err("Receiv
edmalformedpacketon%sfrom%s.",ifp->name,format_address(from));return;}neigh=find
_neighbour(from,ifp);if(neigh==NULL){zlog_err("Couldn'tallocateneighbour.");retu
rn;}DO_NTOHS(bodylen,packet+2);if(bodylen+4>packetlen){zlog_err("Receivedtruncat
edpacket(%d+4>%d).",bodylen,packetlen);bodylen=packetlen-4;}i=0;while(i<bodylen)
{message=packet+4+i;type=message[0];if(type==MESSAGE_PAD1){debugf(BABEL_DEBUG_CO
MMON,"Receivedpad1from%son%s.",format_address(from),ifp->name);i++;continue;}len
=message[1];if(type==MESSAGE_PADN){debugf(BABEL_DEBUG_COMMON,"Receivedpad%dfrom%
son%s.",len,format_address(from),ifp->name);}elseif(type==MESSAGE_ACK_REQ){unsig
nedshortnonce,interval;DO_NTOHS(nonce,message+4);DO_NTOHS(interval,message+6);de
bugf(BABEL_DEBUG_COMMON,"Receivedack-req(%04X%d)from%son%s.",nonce,interval,form
at_address(from),ifp->name);send_ack(neigh,nonce,interval);}elseif(type==MESSAGE
_ACK){debugf(BABEL_DEBUG_COMMON,"Receivedackfrom%son%s.",format_address(from),if
p->name);/*Nothingrightnow*/}elseif(type==MESSAGE_HELLO){unsignedshortseqno,inte
rval;intchanged;unsignedinttimestamp=0;DO_NTOHS(seqno,message+4);DO_NTOHS(interv
al,message+6);debugf(BABEL_DEBUG_COMMON,"Receivedhello%d(%d)from%son%s.",seqno,i
nterval,format_address(from),ifp->name);changed=update_neighbour(neigh,seqno,int
erval);update_neighbour_metric(neigh,changed);if(interval>0)/*Multiplyby3/2toall
owhellostoexpire.*/schedule_neighbours_check(interval*15,0);/*Sub-TLVhandling.*/
if(len>8){if(parse_hello_subtlv(message+8,len-6,&timestamp)>0){neigh->hello_send
_us=timestamp;neigh->hello_rtt_receive_time=babel_now;have_hello_rtt=1;}}}elseif
(type==MESSAGE_IHU){unsignedshorttxcost,interval;unsignedcharaddress[16];intrc;D
O_NTOHS(txcost,message+4);DO_NTOHS(interval,message+6);rc=network_address(messag
e[2],message+8,len-6,address);if(rc<0)gotofail;debugf(BABEL_DEBUG_COMMON,"Receiv
edihu%d(%d)from%son%sfor%s.",txcost,interval,format_address(from),ifp->name,form
at_address(address));if(message[2]==0||is_interface_ll_address(ifp,address)){int
changed=txcost!=neigh->txcost;neigh->txcost=txcost;neigh->ihu_time=babel_now;nei
gh->ihu_interval=interval;update_neighbour_metric(neigh,changed);if(interval>0)/
*Multiplyby3/2toallowneighbourstoexpire.*/schedule_neighbours_check(interval*45,
0);/*RTTsub-TLV.*/if(len>10+rc)parse_ihu_subtlv(message+8+rc,len-6-rc,&hello_sen
d_us,&hello_rtt_receive_time);}}elseif(type==MESSAGE_ROUTER_ID){memcpy(router_id
,message+4,8);have_router_id=1;debugf(BABEL_DEBUG_COMMON,"Receivedrouter-id%sfro
m%son%s.",format_eui64(router_id),format_address(from),ifp->name);}elseif(type==
MESSAGE_NH){unsignedcharnh[16];intrc;rc=network_address(message[2],message+4,len
-2,nh);if(rc<0){have_v4_nh=0;have_v6_nh=0;gotofail;}debugf(BABEL_DEBUG_COMMON,"R
eceivednh%s(%d)from%son%s.",format_address(nh),message[2],format_address(from),i
fp->name);if(message[2]==1){memcpy(v4_nh,nh,16);have_v4_nh=1;}else{memcpy(v6_nh,
nh,16);have_v6_nh=1;}}elseif(type==MESSAGE_UPDATE){unsignedcharprefix[16],*nh;un
signedcharplen;unsignedcharchannels[DIVERSITY_HOPS];unsignedshortinterval,seqno,
metric;intrc,parsed_len;DO_NTOHS(interval,message+6);DO_NTOHS(seqno,message+8);D
O_NTOHS(metric,message+10);if(message[5]==0||(message[2]==1?have_v4_prefix:have_
v6_prefix))rc=network_prefix(message[2],message[4],message[5],message+12,message
[2]==1?v4_prefix:v6_prefix,len-10,prefix);elserc=-1;if(rc<0){if(message[3]&0x80)
have_v4_prefix=have_v6_prefix=0;gotofail;}parsed_len=10+rc;plen=message[4]+(mess
age[2]==1?96:0);if(message[3]&0x80){if(message[2]==1){memcpy(v4_prefix,prefix,16
);have_v4_prefix=1;}else{memcpy(v6_prefix,prefix,16);have_v6_prefix=1;}}if(messa
ge[3]&0x40){if(message[2]==1){memset(router_id,0,4);memcpy(router_id+4,prefix+12
,4);}else{memcpy(router_id,prefix+8,8);}have_router_id=1;}if(!have_router_id&&me
ssage[2]!=0){zlog_err("Receivedprefixwithnorouterid.");gotofail;}debugf(BABEL_DE
BUG_COMMON,"Receivedupdate%s%sfor%sfrom%son%s.",(message[3]&0x80)?"/prefix":"",(
message[3]&0x40)?"/id":"",format_prefix(prefix,plen),format_address(from),ifp->n
ame);if(message[2]==0){if(metric<0xFFFF){zlog_err("Receivedwildcardupdatewithfin
itemetric.");gotodone;}retract_neighbour_routes(neigh);gotodone;}elseif(message[
2]==1){if(!have_v4_nh)gotofail;nh=v4_nh;}elseif(have_v6_nh){nh=v6_nh;}else{nh=ne
igh->address;}if(message[2]==1){if(!babel_get_if_nfo(ifp)->ipv4)gotodone;}if((ba
bel_get_if_nfo(ifp)->flags&BABEL_IF_FARAWAY)){channels[0]=0;}else{/*Thiswillbeov
erwrittenbyparse_update_subtlvbelow.*/if(metric<256){/*Assumenon-interfering(wir
ed)link.*/channels[0]=0;}else{/*Assumeinterfering.*/channels[0]=BABEL_IF_CHANNEL
_INTERFERING;channels[1]=0;}if(parsed_len<len)parse_update_subtlv(message+2+pars
ed_len,len-parsed_len,channels);}update_route(router_id,prefix,plen,seqno,metric
,interval,neigh,nh,channels,channels_len(channels));}elseif(type==MESSAGE_REQUES
T){unsignedcharprefix[16],plen;intrc;rc=network_prefix(message[2],message[3],0,m
essage+4,NULL,len-2,prefix);if(rc<0)gotofail;plen=message[3]+(message[2]==1?96:0
);debugf(BABEL_DEBUG_COMMON,"Receivedrequestfor%sfrom%son%s.",message[2]==0?"any
":format_prefix(prefix,plen),format_address(from),ifp->name);if(message[2]==0){s
tructbabel_interface*neigh_ifp=babel_get_if_nfo(neigh->ifp);/*Ifaneighbourisrequ
estingafullroutedumpfromus,wemightaswellsenditanIHU.*/send_ihu(neigh,NULL);/*Sin
cenodessendwildcardrequestsonboot,bootingalargenumberofnodesatthesametimemaycaus
eanupdatestorm.Ignoreawildcardrequestthathappensshortlyafterwesentafullupdate.*/
if(neigh_ifp->last_update_time<(time_t)(babel_now.tv_sec-MAX(neigh_ifp->hello_in
terval/100,1)))send_update(neigh->ifp,0,NULL,0);}else{send_update(neigh->ifp,0,p
refix,plen);}}elseif(type==MESSAGE_MH_REQUEST){unsignedcharprefix[16],plen;unsig
nedshortseqno;intrc;DO_NTOHS(seqno,message+4);rc=network_prefix(message[2],messa
ge[3],0,message+16,NULL,len-14,prefix);if(rc<0)gotofail;plen=message[3]+(message
[2]==1?96:0);debugf(BABEL_DEBUG_COMMON,"Receivedrequest(%d)for%sfrom%son%s(%s,%d
).",message[6],format_prefix(prefix,plen),format_address(from),ifp->name,format_
eui64(message+8),seqno);handle_request(neigh,prefix,plen,message[6],seqno,messag
e+8);}else{debugf(BABEL_DEBUG_COMMON,"Receivedunknownpackettype%dfrom%son%s.",ty
pe,format_address(from),ifp->name);}done:i+=len+2;continue;fail:zlog_err("Couldn
'tparsepacket(%d,%d)from%son%s.",message[0],message[1],format_address(from),ifp-
>name);gotodone;}/*WecancalculatetheRTTtothisneighbour.*/if(have_hello_rtt&&hell
o_send_us&&hello_rtt_receive_time){intremote_waiting_us,local_waiting_us;unsigne
dintrtt,smoothed_rtt;unsignedintold_rttcost;intchanged=0;remote_waiting_us=neigh
->hello_send_us-hello_rtt_receive_time;local_waiting_us=time_us(neigh->hello_rtt
_receive_time)-hello_send_us;/*Sanitychecks(validitywindowof10minutes).*/if(remo
te_waiting_us<0||local_waiting_us<0||remote_waiting_us>600000000||local_waiting_
us>600000000)return;rtt=MAX(0,local_waiting_us-remote_waiting_us);debugf(BABEL_D
EBUG_COMMON,"RTTto%son%ssampleresult:%dus.\n",format_address(from),ifp->name,rtt
);old_rttcost=neighbour_rttcost(neigh);if(valid_rtt(neigh)){/*Runningexponential
average.*/smoothed_rtt=(babel_ifp->rtt_decay*rtt+(256-babel_ifp->rtt_decay)*neig
h->rtt);/*Rounding(upordown)togetclosertothesample.*/neigh->rtt=(neigh->rtt>=rtt
)?smoothed_rtt/256:(smoothed_rtt+255)/256;}else{/*Weprefertobeconservativewithne
wneighbours(higherRTT)*/assert(rtt<=0x7FFFFFFF);neigh->rtt=2*rtt;}changed=(neigh
bour_rttcost(neigh)==old_rttcost?0:1);update_neighbour_metric(neigh,changed);nei
gh->rtt_time=babel_now;}return;}/*Undernormalcircumstances,thereareenoughmoderat
ionmechanismselsewhereintheprotocoltomakesurethatthislast-ditchcheckshouldnevert
rigger.ButI'msuperstitious.*/staticintcheck_bucket(structinterface*ifp){babel_in
terface_nfo*babel_ifp=babel_get_if_nfo(ifp);if(babel_ifp->bucket<=0){intseconds=
babel_now.tv_sec-babel_ifp->bucket_time;if(seconds>0){babel_ifp->bucket=MIN(BUCK
ET_TOKENS_MAX,seconds*BUCKET_TOKENS_PER_SEC);}/*Resetbuckettimeunconditionally,i
ncaseclockisstepped.*/babel_ifp->bucket_time=babel_now.tv_sec;}if(babel_ifp->buc
ket>0){babel_ifp->bucket--;return1;}else{return0;}}staticintfill_rtt_message(str
uctinterface*ifp){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);if((babel_
ifp->flags&BABEL_IF_TIMESTAMPS)&&(babel_ifp->buffered_hello>=0)){if(babel_ifp->s
endbuf[babel_ifp->buffered_hello+8]==SUBTLV_PADN&&babel_ifp->sendbuf[babel_ifp->
buffered_hello+9]==4){unsignedinttime;/*Changethetypeofsub-TLV.*/babel_ifp->send
buf[babel_ifp->buffered_hello+8]=SUBTLV_TIMESTAMP;gettime(&babel_now);time=time_
us(babel_now);DO_HTONL(babel_ifp->sendbuf+babel_ifp->buffered_hello+10,time);ret
urn1;}else{zlog_err("Nospaceleftfortimestampsub-TLV""(thisshouldn'thappen)");ret
urn-1;}}return0;}voidflushbuf(structinterface*ifp){intrc;structsockaddr_in6sin6;
babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);assert(babel_ifp->buffered<=
babel_ifp->bufsize);flushupdates(ifp);if(babel_ifp->buffered>0){debugf(BABEL_DEB
UG_COMMON,"(flushing%dbufferedbyteson%s)",babel_ifp->buffered,ifp->name);if(chec
k_bucket(ifp)){memset(&sin6,0,sizeof(sin6));sin6.sin6_family=AF_INET6;memcpy(&si
n6.sin6_addr,protocol_group,16);sin6.sin6_port=htons(protocol_port);sin6.sin6_sc
ope_id=ifp->ifindex;DO_HTONS(packet_header+2,babel_ifp->buffered);fill_rtt_messa
ge(ifp);rc=babel_send(protocol_socket,packet_header,sizeof(packet_header),babel_
ifp->sendbuf,babel_ifp->buffered,(structsockaddr*)&sin6,sizeof(sin6));if(rc<0)zl
og_err("send:%s",safe_strerror(errno));}else{zlog_err("Warning:bucketfull,droppi
ngpacketto%s.",ifp->name);}}VALGRIND_MAKE_MEM_UNDEFINED(babel_ifp->sendbuf,babel
_ifp->bufsize);babel_ifp->buffered=0;babel_ifp->buffered_hello=-1;babel_ifp->hav
e_buffered_id=0;babel_ifp->have_buffered_nh=0;babel_ifp->have_buffered_prefix=0;
babel_ifp->flush_timeout.tv_sec=0;babel_ifp->flush_timeout.tv_usec=0;}staticvoid
schedule_flush(structinterface*ifp){babel_interface_nfo*babel_ifp=babel_get_if_n
fo(ifp);unsignedmsecs=jitter(babel_ifp,0);if(babel_ifp->flush_timeout.tv_sec!=0&
&timeval_minus_msec(&babel_ifp->flush_timeout,&babel_now)<msecs)return;set_timeo
ut(&babel_ifp->flush_timeout,msecs);}staticvoidschedule_flush_now(structinterfac
e*ifp){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);/*Almostnow*/unsigned
msecs=roughly(10);if(babel_ifp->flush_timeout.tv_sec!=0&&timeval_minus_msec(&bab
el_ifp->flush_timeout,&babel_now)<msecs)return;set_timeout(&babel_ifp->flush_tim
eout,msecs);}staticvoidschedule_unicast_flush(unsignedmsecs){if(!unicast_neighbo
ur)return;if(unicast_flush_timeout.tv_sec!=0&&timeval_minus_msec(&unicast_flush_
timeout,&babel_now)<msecs)return;unicast_flush_timeout.tv_usec=(babel_now.tv_use
c+msecs*1000)%1000000;unicast_flush_timeout.tv_sec=babel_now.tv_sec+(babel_now.t
v_usec/1000+msecs)/1000;}staticvoidensure_space(structinterface*ifp,intspace){ba
bel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);if(babel_ifp->bufsize-babel_if
p->buffered<space)flushbuf(ifp);}staticvoidstart_message(structinterface*ifp,int
type,intlen){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);if(babel_ifp->b
ufsize-babel_ifp->buffered<len+2)flushbuf(ifp);babel_ifp->sendbuf[babel_ifp->buf
fered++]=type;babel_ifp->sendbuf[babel_ifp->buffered++]=len;}staticvoidend_messa
ge(structinterface*ifp,inttype,intbytes){babel_interface_nfo*babel_ifp=babel_get
_if_nfo(ifp);assert(babel_ifp->buffered>=bytes+2&&babel_ifp->sendbuf[babel_ifp->
buffered-bytes-2]==type&&babel_ifp->sendbuf[babel_ifp->buffered-bytes-1]==bytes)
;schedule_flush(ifp);}staticvoidaccumulate_byte(structinterface*ifp,unsignedchar
value){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);babel_ifp->sendbuf[ba
bel_ifp->buffered++]=value;}staticvoidaccumulate_short(structinterface*ifp,unsig
nedshortvalue){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);DO_HTONS(babe
l_ifp->sendbuf+babel_ifp->buffered,value);babel_ifp->buffered+=2;}staticvoidaccu
mulate_int(structinterface*ifp,unsignedintvalue){babel_interface_nfo*babel_ifp=b
abel_get_if_nfo(ifp);DO_HTONL(babel_ifp->sendbuf+babel_ifp->buffered,value);babe
l_ifp->buffered+=4;}staticvoidaccumulate_bytes(structinterface*ifp,constunsigned
char*value,unsignedlen){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);memc
py(babel_ifp->sendbuf+babel_ifp->buffered,value,len);babel_ifp->buffered+=len;}s
taticintstart_unicast_message(structneighbour*neigh,inttype,intlen){if(unicast_n
eighbour){if(neigh!=unicast_neighbour||unicast_buffered+len+2>=MIN(UNICAST_BUFSI
ZE,babel_get_if_nfo(neigh->ifp)->bufsize))flush_unicast(0);}if(!unicast_buffer)u
nicast_buffer=malloc(UNICAST_BUFSIZE);if(!unicast_buffer){zlog_err("malloc(unica
st_buffer):%s",safe_strerror(errno));return-1;}unicast_neighbour=neigh;unicast_b
uffer[unicast_buffered++]=type;unicast_buffer[unicast_buffered++]=len;return1;}s
taticvoidend_unicast_message(structneighbour*neigh,inttype,intbytes){assert(unic
ast_neighbour==neigh&&unicast_buffered>=bytes+2&&unicast_buffer[unicast_buffered
-bytes-2]==type&&unicast_buffer[unicast_buffered-bytes-1]==bytes);schedule_unica
st_flush(jitter(babel_get_if_nfo(neigh->ifp),0));}staticvoidaccumulate_unicast_b
yte(structneighbour*neigh,unsignedcharvalue){unicast_buffer[unicast_buffered++]=
value;}staticvoidaccumulate_unicast_short(structneighbour*neigh,unsignedshortval
ue){DO_HTONS(unicast_buffer+unicast_buffered,value);unicast_buffered+=2;}staticv
oidaccumulate_unicast_int(structneighbour*neigh,unsignedintvalue){DO_HTONL(unica
st_buffer+unicast_buffered,value);unicast_buffered+=4;}staticvoidaccumulate_unic
ast_bytes(structneighbour*neigh,constunsignedchar*value,unsignedlen){memcpy(unic
ast_buffer+unicast_buffered,value,len);unicast_buffered+=len;}voidsend_ack(struc
tneighbour*neigh,unsignedshortnonce,unsignedshortinterval){intrc;debugf(BABEL_DE
BUG_COMMON,"Sendingack(%04x)to%son%s.",nonce,format_address(neigh->address),neig
h->ifp->name);rc=start_unicast_message(neigh,MESSAGE_ACK,2);if(rc<0)return;accum
ulate_unicast_short(neigh,nonce);end_unicast_message(neigh,MESSAGE_ACK,2);/*Roug
hlyyieldsavaluenolargerthan3/2,sothismeetsthedeadline*/schedule_unicast_flush(ro
ughly(interval*6));}voidsend_hello_noupdate(structinterface*ifp,unsignedinterval
){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);/*Thisavoidssendingmultipl
ehellosinasinglepacket,whichbreakslinkqualityestimation.*/if(babel_ifp->buffered
_hello>=0)flushbuf(ifp);babel_ifp->hello_seqno=seqno_plus(babel_ifp->hello_seqno
,1);set_timeout(&babel_ifp->hello_timeout,babel_ifp->hello_interval);if(!if_up(i
fp))return;debugf(BABEL_DEBUG_COMMON,"Sendinghello%d(%d)to%s.",babel_ifp->hello_
seqno,interval,ifp->name);start_message(ifp,MESSAGE_HELLO,(babel_ifp->flags&BABE
L_IF_TIMESTAMPS)?12:6);babel_ifp->buffered_hello=babel_ifp->buffered-2;accumulat
e_short(ifp,0);accumulate_short(ifp,babel_ifp->hello_seqno);accumulate_short(ifp
,interval>0xFFFF?0xFFFF:interval);if(babel_ifp->flags&BABEL_IF_TIMESTAMPS){/*Sub
-TLVcontainingthelocaltimeofemission.WeuseaPad4sub-TLV,whichwe'llfilljustbefores
ending.*/accumulate_byte(ifp,SUBTLV_PADN);accumulate_byte(ifp,4);accumulate_int(
ifp,0);}end_message(ifp,MESSAGE_HELLO,(babel_ifp->flags&BABEL_IF_TIMESTAMPS)?12:
6);}voidsend_hello(structinterface*ifp){babel_interface_nfo*babel_ifp=babel_get_
if_nfo(ifp);send_hello_noupdate(ifp,(babel_ifp->hello_interval+9)/10);/*Sendfull
IHUevery3hellos,andmarginalIHUeachtime*/if(babel_ifp->hello_seqno%3==0)send_ihu(
NULL,ifp);elsesend_marginal_ihu(ifp);}voidflush_unicast(intdofree){structsockadd
r_in6sin6;intrc;if(unicast_buffered==0)gotodone;if(!if_up(unicast_neighbour->ifp
))gotodone;/*Preserveorderingofmessages*/flushbuf(unicast_neighbour->ifp);if(che
ck_bucket(unicast_neighbour->ifp)){memset(&sin6,0,sizeof(sin6));sin6.sin6_family
=AF_INET6;memcpy(&sin6.sin6_addr,unicast_neighbour->address,16);sin6.sin6_port=h
tons(protocol_port);sin6.sin6_scope_id=unicast_neighbour->ifp->ifindex;DO_HTONS(
packet_header+2,unicast_buffered);fill_rtt_message(unicast_neighbour->ifp);rc=ba
bel_send(protocol_socket,packet_header,sizeof(packet_header),unicast_buffer,unic
ast_buffered,(structsockaddr*)&sin6,sizeof(sin6));if(rc<0)zlog_err("send(unicast
):%s",safe_strerror(errno));}else{zlog_err("Warning:bucketfull,droppingunicastpa
cketto%sif%s.",format_address(unicast_neighbour->address),unicast_neighbour->ifp
->name);}done:VALGRIND_MAKE_MEM_UNDEFINED(unicast_buffer,UNICAST_BUFSIZE);unicas
t_buffered=0;if(dofree&&unicast_buffer){free(unicast_buffer);unicast_buffer=NULL
;}unicast_neighbour=NULL;unicast_flush_timeout.tv_sec=0;unicast_flush_timeout.tv
_usec=0;}staticvoidreally_send_update(structinterface*ifp,constunsignedchar*id,c
onstunsignedchar*prefix,unsignedcharplen,unsignedshortseqno,unsignedshortmetric,
unsignedchar*channels,intchannels_len){babel_interface_nfo*babel_ifp=babel_get_i
f_nfo(ifp);intadd_metric,v4,real_plen,omit=0;constunsignedchar*real_prefix;unsig
nedshortflags=0;intchannels_size;if(diversity_kind!=DIVERSITY_CHANNEL)channels_l
en=-1;channels_size=channels_len>=0?channels_len+2:0;if(!if_up(ifp))return;add_m
etric=output_filter(id,prefix,plen,ifp->ifindex);if(add_metric>=INFINITY)return;
metric=MIN(metric+add_metric,INFINITY);/*Worstcase*/ensure_space(ifp,20+12+28);v
4=plen>=96&&v4mapped(prefix);if(v4){if(!babel_ifp->ipv4)return;if(!babel_ifp->ha
ve_buffered_nh||memcmp(babel_ifp->buffered_nh,babel_ifp->ipv4,4)!=0){start_messa
ge(ifp,MESSAGE_NH,6);accumulate_byte(ifp,1);accumulate_byte(ifp,0);accumulate_by
tes(ifp,babel_ifp->ipv4,4);end_message(ifp,MESSAGE_NH,6);memcpy(babel_ifp->buffe
red_nh,babel_ifp->ipv4,4);babel_ifp->have_buffered_nh=1;}real_prefix=prefix+12;r
eal_plen=plen-96;}else{if(babel_ifp->have_buffered_prefix){while(omit<plen/8&&ba
bel_ifp->buffered_prefix[omit]==prefix[omit])omit++;}if(!babel_ifp->have_buffere
d_prefix||plen>=48)flags|=0x80;real_prefix=prefix;real_plen=plen;}if(!babel_ifp-
>have_buffered_id||memcmp(id,babel_ifp->buffered_id,8)!=0){if(real_plen==128&&me
mcmp(real_prefix+8,id,8)==0){flags|=0x40;}else{start_message(ifp,MESSAGE_ROUTER_
ID,10);accumulate_short(ifp,0);accumulate_bytes(ifp,id,8);end_message(ifp,MESSAG
E_ROUTER_ID,10);}memcpy(babel_ifp->buffered_id,id,sizeof(babel_ifp->buffered_id)
);babel_ifp->have_buffered_id=1;}start_message(ifp,MESSAGE_UPDATE,10+(real_plen+
7)/8-omit+channels_size);accumulate_byte(ifp,v4?1:2);accumulate_byte(ifp,flags);
accumulate_byte(ifp,real_plen);accumulate_byte(ifp,omit);accumulate_short(ifp,(b
abel_ifp->update_interval+5)/10);accumulate_short(ifp,seqno);accumulate_short(if
p,metric);accumulate_bytes(ifp,real_prefix+omit,(real_plen+7)/8-omit);/*Notethat
anemptychannelsTLVisdifferentfromnosuchTLV.*/if(channels_len>=0){accumulate_byte
(ifp,2);accumulate_byte(ifp,channels_len);accumulate_bytes(ifp,channels,channels
_len);}end_message(ifp,MESSAGE_UPDATE,10+(real_plen+7)/8-omit+channels_size);if(
flags&0x80){memcpy(babel_ifp->buffered_prefix,prefix,16);babel_ifp->have_buffere
d_prefix=1;}}staticintcompare_buffered_updates(constvoid*av,constvoid*bv){consts
tructbuffered_update*a=av,*b=bv;intrc,v4a,v4b,ma,mb;rc=memcmp(a->id,b->id,8);if(
rc!=0)returnrc;v4a=(a->plen>=96&&v4mapped(a->prefix));v4b=(b->plen>=96&&v4mapped
(b->prefix));if(v4a>v4b)return1;elseif(v4a<v4b)return-1;ma=(!v4a&&a->plen==128&&
memcmp(a->prefix+8,a->id,8)==0);mb=(!v4b&&b->plen==128&&memcmp(b->prefix+8,b->id
,8)==0);if(ma>mb)return-1;elseif(mb>ma)return1;if(a->plen<b->plen)return1;elseif
(a->plen>b->plen)return-1;returnmemcmp(a->prefix,b->prefix,16);}voidflushupdates
(structinterface*ifp){babel_interface_nfo*babel_ifp=NULL;structxroute*xroute;str
uctbabel_route*route;constunsignedchar*last_prefix=NULL;unsignedcharlast_plen=0x
FF;inti;if(ifp==NULL){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterfac
e*ifp_aux;FOR_ALL_INTERFACES(vrf,ifp_aux)flushupdates(ifp_aux);return;}babel_ifp
=babel_get_if_nfo(ifp);if(babel_ifp->num_buffered_updates>0){structbuffered_upda
te*b=babel_ifp->buffered_updates;intn=babel_ifp->num_buffered_updates;babel_ifp-
>buffered_updates=NULL;babel_ifp->update_bufsize=0;babel_ifp->num_buffered_updat
es=0;if(!if_up(ifp))gotodone;debugf(BABEL_DEBUG_COMMON,"(flushing%dbufferedupdat
eson%s(%d))",n,ifp->name,ifp->ifindex);/*Inordertosendfewerupdatemessages,wewant
tosendupdateswiththesamerouter-idtogether,withIPv6goingoutbeforeIPv4.*/for(i=0;i
<n;i++){route=find_installed_route(b[i].prefix,b[i].plen);if(route)memcpy(b[i].i
d,route->src->id,8);elsememcpy(b[i].id,myid,8);}qsort(b,n,sizeof(structbuffered_
update),compare_buffered_updates);for(i=0;i<n;i++){/*Thesameupdatemaybescheduled
multipletimesbeforeitissentout.Sinceourbufferisnowsorted,itisenoughtocomparewith
thepreviousupdate.*/if(last_prefix){if(b[i].plen==last_plen&&memcmp(b[i].prefix,
last_prefix,16)==0)continue;}xroute=find_xroute(b[i].prefix,b[i].plen);route=fin
d_installed_route(b[i].prefix,b[i].plen);if(xroute&&(!route||xroute->metric<=ker
nel_metric)){really_send_update(ifp,myid,xroute->prefix,xroute->plen,myseqno,xro
ute->metric,NULL,0);last_prefix=xroute->prefix;last_plen=xroute->plen;}elseif(ro
ute){unsignedcharchannels[DIVERSITY_HOPS];intchlen;structinterface*route_ifp=rou
te->neigh->ifp;structbabel_interface*babel_route_ifp=NULL;unsignedshortmetric;un
signedshortseqno;seqno=route->seqno;metric=route_interferes(route,ifp)?route_met
ric(route):route_metric_noninterfering(route);if(metric<INFINITY)satisfy_request
(route->src->prefix,route->src->plen,seqno,route->src->id,ifp);if((babel_ifp->fl
ags&BABEL_IF_SPLIT_HORIZON)&&route->neigh->ifp==ifp)continue;babel_route_ifp=bab
el_get_if_nfo(route_ifp);if(babel_route_ifp->channel==BABEL_IF_CHANNEL_NONINTERF
ERING){memcpy(channels,route->channels,DIVERSITY_HOPS);}else{if(babel_route_ifp-
>channel==BABEL_IF_CHANNEL_UNKNOWN)channels[0]=BABEL_IF_CHANNEL_INTERFERING;else
{assert(babel_route_ifp->channel>0&&babel_route_ifp->channel<=255);channels[0]=b
abel_route_ifp->channel;}memcpy(channels+1,route->channels,DIVERSITY_HOPS-1);}ch
len=channels_len(channels);really_send_update(ifp,route->src->id,route->src->pre
fix,route->src->plen,seqno,metric,channels,chlen);update_source(route->src,seqno
,metric);last_prefix=route->src->prefix;last_plen=route->src->plen;}else{/*There
'snorouteforthisprefix.Thiscanhappenshortlyafteranxroutehasbeenretracted,sosenda
retraction.*/really_send_update(ifp,myid,b[i].prefix,b[i].plen,myseqno,INFINITY,
NULL,-1);}}schedule_flush_now(ifp);done:free(b);}babel_ifp->update_flush_timeout
.tv_sec=0;babel_ifp->update_flush_timeout.tv_usec=0;}staticvoidschedule_update_f
lush(structinterface*ifp,inturgent){babel_interface_nfo*babel_ifp=babel_get_if_n
fo(ifp);unsignedmsecs;msecs=update_jitter(babel_ifp,urgent);if(babel_ifp->update
_flush_timeout.tv_sec!=0&&timeval_minus_msec(&babel_ifp->update_flush_timeout,&b
abel_now)<msecs)return;set_timeout(&babel_ifp->update_flush_timeout,msecs);}stat
icvoidbuffer_update(structinterface*ifp,constunsignedchar*prefix,unsignedcharple
n){babel_interface_nfo*babel_ifp=babel_get_if_nfo(ifp);if(babel_ifp->num_buffere
d_updates>0&&babel_ifp->num_buffered_updates>=babel_ifp->update_bufsize)flushupd
ates(ifp);if(babel_ifp->update_bufsize==0){intn;assert(babel_ifp->buffered_updat
es==NULL);/*Allocateenoughspacetoholdafullupdate.Sincethenumberofinstalledroutes
willgrowovertime,makesurewehaveenoughspacetosendafull-ishframe.*/n=installed_rou
tes_estimate()+xroutes_estimate()+4;n=MAX(n,babel_ifp->bufsize/16);again:babel_i
fp->buffered_updates=malloc(n*sizeof(structbuffered_update));if(babel_ifp->buffe
red_updates==NULL){zlog_err("malloc(buffered_updates):%s",safe_strerror(errno));
if(n>4){/*Tryagainwithatinybuffer.*/n=4;gotoagain;}return;}babel_ifp->update_buf
size=n;babel_ifp->num_buffered_updates=0;}memcpy(babel_ifp->buffered_updates[bab
el_ifp->num_buffered_updates].prefix,prefix,16);babel_ifp->buffered_updates[babe
l_ifp->num_buffered_updates].plen=plen;babel_ifp->num_buffered_updates++;}voidse
nd_update(structinterface*ifp,inturgent,constunsignedchar*prefix,unsignedcharple
n){babel_interface_nfo*babel_ifp=NULL;if(ifp==NULL){structvrf*vrf=vrf_lookup_by_
id(VRF_DEFAULT);structinterface*ifp_aux;structbabel_route*route;FOR_ALL_INTERFAC
ES(vrf,ifp_aux)send_update(ifp_aux,urgent,prefix,plen);if(prefix){/*Sinceflushup
datesonlydealswithnon-wildcardinterfaces,weneedtodothisnow.*/route=find_installe
d_route(prefix,plen);if(route&&route_metric(route)<INFINITY)satisfy_request(pref
ix,plen,route->src->seqno,route->src->id,NULL);}return;}if(!if_up(ifp))return;ba
bel_ifp=babel_get_if_nfo(ifp);if(prefix){debugf(BABEL_DEBUG_COMMON,"Sendingupdat
eto%sfor%s.",ifp->name,format_prefix(prefix,plen));buffer_update(ifp,prefix,plen
);}else{structroute_stream*routes=NULL;send_self_update(ifp);debugf(BABEL_DEBUG_
COMMON,"Sendingupdateto%sforany.",ifp->name);routes=route_stream(1);if(routes){w
hile(1){structbabel_route*route=route_stream_next(routes);if(route==NULL)break;b
uffer_update(ifp,route->src->prefix,route->src->plen);}route_stream_done(routes)
;}else{zlog_err("Couldn'tallocateroutestream.");}set_timeout(&babel_ifp->update_
timeout,babel_ifp->update_interval);babel_ifp->last_update_time=babel_now.tv_sec
;}schedule_update_flush(ifp,urgent);}voidsend_update_resend(structinterface*ifp,
constunsignedchar*prefix,unsignedcharplen){assert(prefix!=NULL);send_update(ifp,
1,prefix,plen);record_resend(RESEND_UPDATE,prefix,plen,0,NULL,NULL,resend_delay)
;}voidsend_wildcard_retraction(structinterface*ifp){babel_interface_nfo*babel_if
p=NULL;if(ifp==NULL){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface
*ifp_aux;FOR_ALL_INTERFACES(vrf,ifp_aux)send_wildcard_retraction(ifp_aux);return
;}if(!if_up(ifp))return;babel_ifp=babel_get_if_nfo(ifp);start_message(ifp,MESSAG
E_UPDATE,10);accumulate_byte(ifp,0);accumulate_byte(ifp,0x40);accumulate_byte(if
p,0);accumulate_byte(ifp,0);accumulate_short(ifp,0xFFFF);accumulate_short(ifp,my
seqno);accumulate_short(ifp,0xFFFF);end_message(ifp,MESSAGE_UPDATE,10);babel_ifp
->have_buffered_id=0;}voidupdate_myseqno(){myseqno=seqno_plus(myseqno,1);}voidse
nd_self_update(structinterface*ifp){structxroute_stream*xroutes;if(ifp==NULL){st
ructvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp_aux;FOR_ALL_INTERF
ACES(vrf,ifp_aux){if(!if_up(ifp_aux))continue;send_self_update(ifp_aux);}return;
}debugf(BABEL_DEBUG_COMMON,"Sendingselfupdateto%s.",ifp->name);xroutes=xroute_st
ream();if(xroutes){while(1){structxroute*xroute=xroute_stream_next(xroutes);if(x
route==NULL)break;send_update(ifp,0,xroute->prefix,xroute->plen);}xroute_stream_
done(xroutes);}else{zlog_err("Couldn'tallocatexroutestream.");}}voidsend_ihu(str
uctneighbour*neigh,structinterface*ifp){babel_interface_nfo*babel_ifp=NULL;intrx
cost,interval;intll;intsend_rtt_data;intmsglen;if(neigh==NULL&&ifp==NULL){struct
vrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp_aux;FOR_ALL_INTERFACES
(vrf,ifp_aux){if(if_up(ifp_aux))continue;send_ihu(NULL,ifp_aux);}return;}if(neig
h==NULL){structneighbour*ngh;FOR_ALL_NEIGHBOURS(ngh){if(ngh->ifp==ifp)send_ihu(n
gh,ifp);}return;}if(ifp&&neigh->ifp!=ifp)return;ifp=neigh->ifp;babel_ifp=babel_g
et_if_nfo(ifp);if(!if_up(ifp))return;rxcost=neighbour_rxcost(neigh);interval=(ba
bel_ifp->hello_interval*3+9)/10;/*Conceptually,anIHUisaunicastmessage.Weusuallys
endthemasmulticast,sincethisallowsaggregationintoasinglepacketandavoidsanARPexch
ange.Ifwealreadyhaveaunicastmessagequeuedforthisneighbour,however,wemightaswellp
iggybacktheIHU.*/debugf(BABEL_DEBUG_COMMON,"Sending%sihu%don%sto%s.",unicast_nei
ghbour==neigh?"unicast":"",rxcost,neigh->ifp->name,format_address(neigh->address
));ll=linklocal(neigh->address);if((babel_ifp->flags&BABEL_IF_TIMESTAMPS)&&neigh
->hello_send_us/*CheckswhethertheRTTdataisnottoooldtobesent.*/&&timeval_minus_ms
ec(&babel_now,&neigh->hello_rtt_receive_time)<1000000){send_rtt_data=1;}else{nei
gh->hello_send_us=0;send_rtt_data=0;}/*Thelengthdependsontheformatoftheaddress,a
ndthenanoptional10-bytessub-TLVfortimestamps(usedtocomputeaRTT).*/msglen=(ll?14:
22)+(send_rtt_data?10:0);if(unicast_neighbour!=neigh){start_message(ifp,MESSAGE_
IHU,msglen);accumulate_byte(ifp,ll?3:2);accumulate_byte(ifp,0);accumulate_short(
ifp,rxcost);accumulate_short(ifp,interval);if(ll)accumulate_bytes(ifp,neigh->add
ress+8,8);elseaccumulate_bytes(ifp,neigh->address,16);if(send_rtt_data){accumula
te_byte(ifp,SUBTLV_TIMESTAMP);accumulate_byte(ifp,8);accumulate_int(ifp,neigh->h
ello_send_us);accumulate_int(ifp,time_us(neigh->hello_rtt_receive_time));}end_me
ssage(ifp,MESSAGE_IHU,msglen);}else{intrc;rc=start_unicast_message(neigh,MESSAGE
_IHU,msglen);if(rc<0)return;accumulate_unicast_byte(neigh,ll?3:2);accumulate_uni
cast_byte(neigh,0);accumulate_unicast_short(neigh,rxcost);accumulate_unicast_sho
rt(neigh,interval);if(ll)accumulate_unicast_bytes(neigh,neigh->address+8,8);else
accumulate_unicast_bytes(neigh,neigh->address,16);if(send_rtt_data){accumulate_u
nicast_byte(neigh,SUBTLV_TIMESTAMP);accumulate_unicast_byte(neigh,8);accumulate_
unicast_int(neigh,neigh->hello_send_us);accumulate_unicast_int(neigh,time_us(nei
gh->hello_rtt_receive_time));}end_unicast_message(neigh,MESSAGE_IHU,msglen);}}/*
SendIHUstoallmarginalneighbours*/voidsend_marginal_ihu(structinterface*ifp){stru
ctneighbour*neigh;FOR_ALL_NEIGHBOURS(neigh){if(ifp&&neigh->ifp!=ifp)continue;if(
neigh->txcost>=384||(neigh->reach&0xF000)!=0xF000)send_ihu(neigh,ifp);}}voidsend
_request(structinterface*ifp,constunsignedchar*prefix,unsignedcharplen){intv4,pb
,len;if(ifp==NULL){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*i
fp_aux;FOR_ALL_INTERFACES(vrf,ifp_aux){if(if_up(ifp_aux))continue;send_request(i
fp_aux,prefix,plen);}return;}/*makesureanybufferedupdatesgooutbeforethisrequest.
*/flushupdates(ifp);if(!if_up(ifp))return;debugf(BABEL_DEBUG_COMMON,"sendingrequ
estto%sfor%s.",ifp->name,prefix?format_prefix(prefix,plen):"any");v4=plen>=96&&v
4mapped(prefix);pb=v4?((plen-96)+7)/8:(plen+7)/8;len=!prefix?2:2+pb;start_messag
e(ifp,MESSAGE_REQUEST,len);accumulate_byte(ifp,!prefix?0:v4?1:2);accumulate_byte
(ifp,!prefix?0:v4?plen-96:plen);if(prefix){if(v4)accumulate_bytes(ifp,prefix+12,
pb);elseaccumulate_bytes(ifp,prefix,pb);}end_message(ifp,MESSAGE_REQUEST,len);}v
oidsend_unicast_request(structneighbour*neigh,constunsignedchar*prefix,unsignedc
harplen){intrc,v4,pb,len;/*makesureanybufferedupdatesgooutbeforethisrequest.*/fl
ushupdates(neigh->ifp);debugf(BABEL_DEBUG_COMMON,"sendingunicastrequestto%sfor%s
.",format_address(neigh->address),prefix?format_prefix(prefix,plen):"any");v4=pl
en>=96&&v4mapped(prefix);pb=v4?((plen-96)+7)/8:(plen+7)/8;len=!prefix?2:2+pb;rc=
start_unicast_message(neigh,MESSAGE_REQUEST,len);if(rc<0)return;accumulate_unica
st_byte(neigh,!prefix?0:v4?1:2);accumulate_unicast_byte(neigh,!prefix?0:v4?plen-
96:plen);if(prefix){if(v4)accumulate_unicast_bytes(neigh,prefix+12,pb);elseaccum
ulate_unicast_bytes(neigh,prefix,pb);}end_unicast_message(neigh,MESSAGE_REQUEST,
len);}voidsend_multihop_request(structinterface*ifp,constunsignedchar*prefix,uns
ignedcharplen,unsignedshortseqno,constunsignedchar*id,unsignedshorthop_count){in
tv4,pb,len;/*Makesureanybufferedupdatesgooutbeforethisrequest.*/flushupdates(ifp
);if(ifp==NULL){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp_
aux;FOR_ALL_INTERFACES(vrf,ifp_aux){if(!if_up(ifp_aux))continue;send_multihop_re
quest(ifp_aux,prefix,plen,seqno,id,hop_count);}return;}if(!if_up(ifp))return;deb
ugf(BABEL_DEBUG_COMMON,"Sendingrequest(%d)on%sfor%s.",hop_count,ifp->name,format
_prefix(prefix,plen));v4=plen>=96&&v4mapped(prefix);pb=v4?((plen-96)+7)/8:(plen+
7)/8;len=6+8+pb;start_message(ifp,MESSAGE_MH_REQUEST,len);accumulate_byte(ifp,v4
?1:2);accumulate_byte(ifp,v4?plen-96:plen);accumulate_short(ifp,seqno);accumulat
e_byte(ifp,hop_count);accumulate_byte(ifp,0);accumulate_bytes(ifp,id,8);if(prefi
x){if(v4)accumulate_bytes(ifp,prefix+12,pb);elseaccumulate_bytes(ifp,prefix,pb);
}end_message(ifp,MESSAGE_MH_REQUEST,len);}voidsend_unicast_multihop_request(stru
ctneighbour*neigh,constunsignedchar*prefix,unsignedcharplen,unsignedshortseqno,c
onstunsignedchar*id,unsignedshorthop_count){intrc,v4,pb,len;/*Makesureanybuffere
dupdatesgooutbeforethisrequest.*/flushupdates(neigh->ifp);debugf(BABEL_DEBUG_COM
MON,"Sendingmulti-hoprequestto%sfor%s(%dhops).",format_address(neigh->address),f
ormat_prefix(prefix,plen),hop_count);v4=plen>=96&&v4mapped(prefix);pb=v4?((plen-
96)+7)/8:(plen+7)/8;len=6+8+pb;rc=start_unicast_message(neigh,MESSAGE_MH_REQUEST
,len);if(rc<0)return;accumulate_unicast_byte(neigh,v4?1:2);accumulate_unicast_by
te(neigh,v4?plen-96:plen);accumulate_unicast_short(neigh,seqno);accumulate_unica
st_byte(neigh,hop_count);accumulate_unicast_byte(neigh,0);accumulate_unicast_byt
es(neigh,id,8);if(prefix){if(v4)accumulate_unicast_bytes(neigh,prefix+12,pb);els
eaccumulate_unicast_bytes(neigh,prefix,pb);}end_unicast_message(neigh,MESSAGE_MH
_REQUEST,len);}voidsend_request_resend(structneighbour*neigh,constunsignedchar*p
refix,unsignedcharplen,unsignedshortseqno,unsignedchar*id){if(neigh)send_unicast
_multihop_request(neigh,prefix,plen,seqno,id,127);elsesend_multihop_request(NULL
,prefix,plen,seqno,id,127);record_resend(RESEND_REQUEST,prefix,plen,seqno,id,nei
gh?neigh->ifp:NULL,resend_delay);}voidhandle_request(structneighbour*neigh,const
unsignedchar*prefix,unsignedcharplen,unsignedcharhop_count,unsignedshortseqno,co
nstunsignedchar*id){structxroute*xroute;structbabel_route*route;structneighbour*
successor=NULL;xroute=find_xroute(prefix,plen);route=find_installed_route(prefix
,plen);if(xroute&&(!route||xroute->metric<=kernel_metric)){if(hop_count>0&&memcm
p(id,myid,8)==0){if(seqno_compare(seqno,myseqno)>0){if(seqno_minus(seqno,myseqno
)>100){/*Hopelesslyout-of-daterequest*/return;}update_myseqno();}}send_update(ne
igh->ifp,1,prefix,plen);return;}if(route&&(memcmp(id,route->src->id,8)!=0||seqno
_compare(seqno,route->seqno)<=0)){send_update(neigh->ifp,1,prefix,plen);return;}
if(hop_count<=1)return;if(route&&memcmp(id,route->src->id,8)==0&&seqno_minus(seq
no,route->seqno)>100){/*Hopelesslyout-of-date*/return;}if(request_redundant(neig
h->ifp,prefix,plen,seqno,id))return;/*Let'strytoforwardthisrequest.*/if(route&&r
oute_metric(route)<INFINITY)successor=route->neigh;if(!successor||successor==nei
gh){/*Wewereabouttoforwardarequesttoitsrequestor.Trytofindadifferentneighbourtof
orwardtherequestto.*/structbabel_route*other_route;other_route=find_best_route(p
refix,plen,0,neigh);if(other_route&&route_metric(other_route)<INFINITY)successor
=other_route->neigh;}if(!successor||successor==neigh)/*Giveup*/return;send_unica
st_multihop_request(successor,prefix,plen,seqno,id,hop_count-1);record_resend(RE
SEND_REQUEST,prefix,plen,seqno,id,neigh->ifp,0);}