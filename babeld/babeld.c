/*Copyright2011byMatthieuBoutierandJuliuszChroboczekPermissionisherebygranted,fr
eeofcharge,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfile
s(the"Software"),todealintheSoftwarewithoutrestriction,includingwithoutlimitatio
ntherightstouse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopies
oftheSoftware,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothef
ollowingconditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincluded
inallcopiesorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOU
TWARRANTYOFANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCH
ANTABILITY,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHO
RSORCOPYRIGHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIO
NOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEU
SEOROTHERDEALINGSINTHESOFTWARE.*/#include<zebra.h>#include"command.h"#include"pr
efix.h"#include"memory.h"#include"table.h"#include"distribute.h"#include"prefix.
h"#include"filter.h"#include"plist.h"#include"babel_main.h"#include"babeld.h"#in
clude"util.h"#include"net.h"#include"kernel.h"#include"babel_interface.h"#includ
e"neighbour.h"#include"route.h"#include"message.h"#include"resend.h"#include"bab
el_filter.h"#include"babel_zebra.h"#include"babel_memory.h"staticintbabel_init_r
outing_process(structthread*thread);staticvoidbabel_get_myid(void);staticvoidbab
el_initial_noise(void);staticintbabel_read_protocol(structthread*thread);statici
ntbabel_main_loop(structthread*thread);staticvoidbabel_set_timer(structtimeval*t
imeout);staticvoidbabel_fill_with_next_timeout(structtimeval*tv);/*Informationsr
elativetothebabelrunningdaemon.*/staticstructbabel*babel_routing_process=NULL;st
aticunsignedchar*receive_buffer=NULL;staticintreceive_buffer_size=0;/*timeouts*/
structtimevalcheck_neighbours_timeout;statictime_texpiry_time;statictime_tsource
_expiry_time;/*Babelnodestructure.*/staticstructcmd_nodecmd_babel_node={.node=BA
BEL_NODE,.prompt="%s(config-router)#",.vtysh=1,};/*printcurrentbabelconfiguratio
nonvty*/staticintbabel_config_write(structvty*vty){intlines=0;intafi;inti;/*list
enableddebugmodes*/lines+=debug_babel_config_write(vty);if(!babel_routing_proces
s)returnlines;vty_out(vty,"routerbabel\n");if(diversity_kind!=DIVERSITY_NONE){vt
y_out(vty,"babeldiversity\n");lines++;}if(diversity_factor!=BABEL_DEFAULT_DIVERS
ITY_FACTOR){vty_out(vty,"babeldiversity-factor%d\n",diversity_factor);lines++;}i
f(resend_delay!=BABEL_DEFAULT_RESEND_DELAY){vty_out(vty,"babelresend-delay%u\n",
resend_delay);lines++;}if(smoothing_half_life!=BABEL_DEFAULT_SMOOTHING_HALF_LIFE
){vty_out(vty,"babelsmoothing-half-life%u\n",smoothing_half_life);lines++;}/*lis
tenabledinterfaces*/lines=1+babel_enable_if_config_write(vty);/*listredistribute
dprotocols*/for(afi=AFI_IP;afi<=AFI_IP6;afi++){for(i=0;i<ZEBRA_ROUTE_MAX;i++){if
(i!=zclient->redist_default&&vrf_bitmap_check(zclient->redist[afi][i],VRF_DEFAUL
T)){vty_out(vty,"redistribute%s%s\n",(afi==AFI_IP)?"ipv4":"ipv6",zebra_route_str
ing(i));lines++;}}}lines+=config_write_distribute(vty);returnlines;}staticintbab
el_create_routing_process(void){assert(babel_routing_process==NULL);/*AllocasteB
abelinstance.*/babel_routing_process=XCALLOC(MTYPE_BABEL,sizeof(structbabel));/*
Initializetimeouts*/gettime(&babel_now);expiry_time=babel_now.tv_sec+roughly(30)
;source_expiry_time=babel_now.tv_sec+roughly(300);/*MakesocketforBabelprotocol.*
/protocol_socket=babel_socket(protocol_port);if(protocol_socket<0){zlog_err("Cou
ldn'tcreatelinklocalsocket:%s",safe_strerror(errno));gotofail;}/*Threads.*/threa
d_add_read(master,&babel_read_protocol,NULL,protocol_socket,&babel_routing_proce
ss->t_read);/*waitalittle:zebrawillannounceinterfaces,addresses,routes...*/threa
d_add_timer_msec(master,babel_init_routing_process,NULL,200L,&babel_routing_proc
ess->t_update);return0;fail:XFREE(MTYPE_BABEL,babel_routing_process);babel_routi
ng_process=NULL;return-1;}/*threadreadingentriesformothersbabeldaemons*/staticin
tbabel_read_protocol(structthread*thread){intrc;structvrf*vrf=vrf_lookup_by_id(V
RF_DEFAULT);structinterface*ifp=NULL;structsockaddr_in6sin6;assert(babel_routing
_process!=NULL);assert(protocol_socket>=0);rc=babel_recv(protocol_socket,receive
_buffer,receive_buffer_size,(structsockaddr*)&sin6,sizeof(sin6));if(rc<0){if(err
no!=EAGAIN&&errno!=EINTR){zlog_err("recv:%s",safe_strerror(errno));}}else{FOR_AL
L_INTERFACES(vrf,ifp){if(!if_up(ifp))continue;if(ifp->ifindex==(ifindex_t)sin6.s
in6_scope_id){parse_packet((unsignedchar*)&sin6.sin6_addr,ifp,receive_buffer,rc)
;break;}}}/*re-addthread*/thread_add_read(master,&babel_read_protocol,NULL,proto
col_socket,&babel_routing_process->t_read);return0;}/*Zebrawillgivesomeinformati
on,especiallyaboutinterfaces.Thisfunctionmustbecallwithalittetimeoutwichmaygivez
ebrathetimetodohisjob,makingtheseinitshavesense.*/staticintbabel_init_routing_pr
ocess(structthread*thread){myseqno=(random()&0xFFFF);babel_get_myid();babel_load
_state_file();debugf(BABEL_DEBUG_COMMON,"MyIDis:%s.",format_eui64(myid));babel_i
nitial_noise();babel_main_loop(thread);/*thisfunctionself-addtothet_updatethread
*/return0;}/*fill"myid"withanuniqueid(onlyifmyid!={0}).*/staticvoidbabel_get_myi
d(void){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp=NULL;int
rc;inti;/*ifwealreadyhaveanid(fromstatefile),wereturn.*/if(memcmp(myid,zeroes,8)
!=0){return;}FOR_ALL_INTERFACES(vrf,ifp){/*ifp->ifindexisnotnecessarilyvalidatth
ispoint*/intifindex=if_nametoindex(ifp->name);if(ifindex>0){unsignedchareui[8];r
c=if_eui64(ifindex,eui);if(rc<0)continue;memcpy(myid,eui,8);return;}}/*Wefailedt
ogetaglobalEUI64fromtheinterfacesweweregiven.Let'strytofindaninterfacewithaMACad
dress.*/for(i=1;i<256;i++){charbuf[IF_NAMESIZE],*ifname;unsignedchareui[8];ifnam
e=if_indextoname(i,buf);if(ifname==NULL)continue;rc=if_eui64(i,eui);if(rc<0)cont
inue;memcpy(myid,eui,8);return;}zlog_err("Warning:couldn'tfindrouterid--usingran
domvalue.");rc=read_random_bytes(myid,8);if(rc<0){zlog_err("read(random):%s(cann
otassignanID)",safe_strerror(errno));exit(1);}/*Cleargroupandglobalbits*/myid[0]
&=~3;}/*Makesomenoisesothatothersnoticeus,andsendretractionsincasewewererestarte
drecently*/staticvoidbabel_initial_noise(void){structvrf*vrf=vrf_lookup_by_id(VR
F_DEFAULT);structinterface*ifp=NULL;FOR_ALL_INTERFACES(vrf,ifp){if(!if_up(ifp))c
ontinue;/*Applyjitterbeforewesendthefirstmessage.*/usleep(roughly(10000));gettim
e(&babel_now);send_hello(ifp);send_wildcard_retraction(ifp);}FOR_ALL_INTERFACES(
vrf,ifp){if(!if_up(ifp))continue;usleep(roughly(10000));gettime(&babel_now);send
_hello(ifp);send_wildcard_retraction(ifp);send_self_update(ifp);send_request(ifp
,NULL,0);flushupdates(ifp);flushbuf(ifp);}}/*Deletealltheaddedbabelroutes,makeba
beldonlyspeaktozebra.*/staticvoidbabel_clean_routing_process(){flush_all_routes(
);babel_interface_close_all();/*cancelthreads*/if(babel_routing_process->t_read!
=NULL){thread_cancel(babel_routing_process->t_read);}if(babel_routing_process->t
_update!=NULL){thread_cancel(babel_routing_process->t_update);}XFREE(MTYPE_BABEL
,babel_routing_process);babel_routing_process=NULL;}/*Functionusedwithtimeout.*/
staticintbabel_main_loop(structthread*thread){structtimevaltv;structvrf*vrf=vrf_
lookup_by_id(VRF_DEFAULT);structinterface*ifp=NULL;while(1){gettime(&babel_now);
/*timeouts---------------------------------------------------------*//*getthenex
ttimeout*/babel_fill_with_next_timeout(&tv);/*ifthereisnotimeout,wemustwait.*/if
(timeval_compare(&tv,&babel_now)>0){timeval_minus(&tv,&tv,&babel_now);debugf(BAB
EL_DEBUG_TIMEOUT,"babelmainloop:timeout:%lldmsecs",(longlong)tv.tv_sec*1000+tv.t
v_usec/1000);/*ithappensoftentohavelessthan1ms,it'sbad.*/timeval_add_msec(&tv,&t
v,300);babel_set_timer(&tv);return0;}gettime(&babel_now);/*updatedatabase-------
-------------------------------------------*/if(timeval_compare(&check_neighbour
s_timeout,&babel_now)<0){intmsecs;msecs=check_neighbours();/*Multiplyby3/2toallo
wneighbourstoexpire.*/msecs=MAX(3*msecs/2,10);schedule_neighbours_check(msecs,1)
;}if(babel_now.tv_sec>=expiry_time){expire_routes();expire_resend();expiry_time=
babel_now.tv_sec+roughly(30);}if(babel_now.tv_sec>=source_expiry_time){expire_so
urces();source_expiry_time=babel_now.tv_sec+roughly(300);}FOR_ALL_INTERFACES(vrf
,ifp){babel_interface_nfo*babel_ifp=NULL;if(!if_up(ifp))continue;babel_ifp=babel
_get_if_nfo(ifp);if(timeval_compare(&babel_now,&babel_ifp->hello_timeout)>=0)sen
d_hello(ifp);if(timeval_compare(&babel_now,&babel_ifp->update_timeout)>=0)send_u
pdate(ifp,0,NULL,0);if(timeval_compare(&babel_now,&babel_ifp->update_flush_timeo
ut)>=0)flushupdates(ifp);}if(resend_time.tv_sec!=0){if(timeval_compare(&babel_no
w,&resend_time)>=0)do_resend();}if(unicast_flush_timeout.tv_sec!=0){if(timeval_c
ompare(&babel_now,&unicast_flush_timeout)>=0)flush_unicast(1);}FOR_ALL_INTERFACE
S(vrf,ifp){babel_interface_nfo*babel_ifp=NULL;if(!if_up(ifp))continue;babel_ifp=
babel_get_if_nfo(ifp);if(babel_ifp->flush_timeout.tv_sec!=0){if(timeval_compare(
&babel_now,&babel_ifp->flush_timeout)>=0)flushbuf(ifp);}}}assert(0);/*thislinesh
ouldneverbereach*/}staticvoidprintIfMin(structtimeval*tv,intcmd,constchar*tag,co
nstchar*ifname){staticstructtimevalcurr_tv;staticcharbuffer[200];staticconstchar
*curr_tag=NULL;switch(cmd){case0:/*resettimeval*/curr_tv=*tv;if(ifname!=NULL){sn
printf(buffer,200L,"interface:%s;%s",ifname,tag);curr_tag=buffer;}else{curr_tag=
tag;}break;case1:/*takethemin*/if(tv->tv_sec==0&&tv->tv_usec==0){/*if(tv==âˆž)*/br
eak;}if(tv->tv_sec<curr_tv.tv_sec||(tv->tv_sec==curr_tv.tv_sec&&tv->tv_usec<curr
_tv.tv_usec)){curr_tv=*tv;if(ifname!=NULL){snprintf(buffer,200L,"interface:%s;%s
",ifname,tag);curr_tag=buffer;}else{curr_tag=tag;}}break;case2:/*printmessage*/d
ebugf(BABEL_DEBUG_TIMEOUT,"nexttimeoutdueto:%s",curr_tag);break;default:break;}}
staticvoidbabel_fill_with_next_timeout(structtimeval*tv){#if(definedNO_DEBUG)#de
fineprintIfMin(a,b,c,d)#else#defineprintIfMin(a,b,c,d)\if(UNLIKELY(debug&BABEL_D
EBUG_TIMEOUT)){printIfMin(a,b,c,d);}structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);
structinterface*ifp=NULL;*tv=check_neighbours_timeout;printIfMin(tv,0,"check_nei
ghbours_timeout",NULL);timeval_min_sec(tv,expiry_time);printIfMin(tv,1,"expiry_t
ime",NULL);timeval_min_sec(tv,source_expiry_time);printIfMin(tv,1,"source_expiry
_time",NULL);timeval_min(tv,&resend_time);printIfMin(tv,1,"resend_time",NULL);FO
R_ALL_INTERFACES(vrf,ifp){babel_interface_nfo*babel_ifp=NULL;if(!if_up(ifp))cont
inue;babel_ifp=babel_get_if_nfo(ifp);timeval_min(tv,&babel_ifp->flush_timeout);p
rintIfMin(tv,1,"flush_timeout",ifp->name);timeval_min(tv,&babel_ifp->hello_timeo
ut);printIfMin(tv,1,"hello_timeout",ifp->name);timeval_min(tv,&babel_ifp->update
_timeout);printIfMin(tv,1,"update_timeout",ifp->name);timeval_min(tv,&babel_ifp-
>update_flush_timeout);printIfMin(tv,1,"update_flush_timeout",ifp->name);}timeva
l_min(tv,&unicast_flush_timeout);printIfMin(tv,1,"unicast_flush_timeout",NULL);p
rintIfMin(tv,2,NULL,NULL);#undefprintIfMin#endif}/*setthet_updatethreadofthebabe
lroutingprocesstobelaunchin'timeout'(approximateatthemilisecond)*/staticvoidbabe
l_set_timer(structtimeval*timeout){longmsecs=timeout->tv_sec*1000+timeout->tv_us
ec/1000;if(babel_routing_process->t_update!=NULL){thread_cancel(babel_routing_pr
ocess->t_update);}thread_add_timer_msec(master,babel_main_loop,NULL,msecs,&babel
_routing_process->t_update);}voidschedule_neighbours_check(intmsecs,intoverride)
{structtimevaltimeout;timeval_add_msec(&timeout,&babel_now,msecs);if(override)ch
eck_neighbours_timeout=timeout;elsetimeval_min(&check_neighbours_timeout,&timeou
t);}intresize_receive_buffer(intsize){if(size<=receive_buffer_size)return0;if(re
ceive_buffer==NULL){receive_buffer=malloc(size);if(receive_buffer==NULL){zlog_er
r("malloc(receive_buffer):%s",safe_strerror(errno));return-1;}receive_buffer_siz
e=size;}else{unsignedchar*new;new=realloc(receive_buffer,size);if(new==NULL){zlo
g_err("realloc(receive_buffer):%s",safe_strerror(errno));return-1;}receive_buffe
r=new;receive_buffer_size=size;}return1;}staticvoidbabel_distribute_update(struc
tdistribute*dist){structinterface*ifp;babel_interface_nfo*babel_ifp;inttype;intf
amily;if(!dist->ifname)return;ifp=if_lookup_by_name(dist->ifname,VRF_DEFAULT);if
(ifp==NULL)return;babel_ifp=babel_get_if_nfo(ifp);for(type=0;type<DISTRIBUTE_MAX
;type++){family=type==DISTRIBUTE_V4_IN||type==DISTRIBUTE_V4_OUT?AFI_IP:AFI_IP6;i
f(dist->list[type])babel_ifp->list[type]=access_list_lookup(family,dist->list[ty
pe]);elsebabel_ifp->list[type]=NULL;if(dist->prefix[type])babel_ifp->prefix[type
]=prefix_list_lookup(family,dist->prefix[type]);elsebabel_ifp->prefix[type]=NULL
;}}staticvoidbabel_distribute_update_interface(structinterface*ifp){structdistri
bute*dist;dist=distribute_lookup(ifp->name);if(dist)babel_distribute_update(dist
);}/*Updateallinterface'sdistributelist.*/staticvoidbabel_distribute_update_all(
structprefix_list*notused){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structint
erface*ifp;FOR_ALL_INTERFACES(vrf,ifp)babel_distribute_update_interface(ifp);}st
aticvoidbabel_distribute_update_all_wrapper(structaccess_list*notused){babel_dis
tribute_update_all(NULL);}/*[Command]*/DEFUN_NOSH(router_babel,router_babel_cmd,
"routerbabel","Enablearoutingprocess\n""MakeBabelinstancecommand\n"){intret;vty-
>node=BABEL_NODE;if(!babel_routing_process){ret=babel_create_routing_process();/
*Noticetouserwecouldn'tcreateBabel.*/if(ret<0){zlog_warn("can'tcreateBabel");ret
urnCMD_WARNING;}}returnCMD_SUCCESS;}/*[Command]*/DEFUN(no_router_babel,no_router
_babel_cmd,"norouterbabel",NO_STR"Disablearoutingprocess\n""RemoveBabelinstancec
ommand\n"){if(babel_routing_process)babel_clean_routing_process();returnCMD_SUCC
ESS;}/*[BabelCommand]*/DEFUN(babel_diversity,babel_diversity_cmd,"babeldiversity
","Babelcommands\n""Enablediversity-awarerouting.\n"){diversity_kind=DIVERSITY_C
HANNEL;returnCMD_SUCCESS;}/*[BabelCommand]*/DEFUN(no_babel_diversity,no_babel_di
versity_cmd,"nobabeldiversity",NO_STR"Babelcommands\n""Disablediversity-awarerou
ting.\n"){diversity_kind=DIVERSITY_NONE;returnCMD_SUCCESS;}/*[BabelCommand]*/DEF
UN(babel_diversity_factor,babel_diversity_factor_cmd,"babeldiversity-factor(1-25
6)","Babelcommands\n""Setthediversityfactor.\n""Factorinunitsof1/256.\n"){intfac
tor;factor=strtoul(argv[2]->arg,NULL,10);diversity_factor=factor;returnCMD_SUCCE
SS;}/*[BabelCommand]*/DEFUN(babel_set_resend_delay,babel_set_resend_delay_cmd,"b
abelresend-delay(20-655340)","Babelcommands\n""Timebeforeresendingamessage\n""Mi
lliseconds\n"){intinterval;interval=strtoul(argv[2]->arg,NULL,10);resend_delay=i
nterval;returnCMD_SUCCESS;}/*[BabelCommand]*/DEFUN(babel_set_smoothing_half_life
,babel_set_smoothing_half_life_cmd,"babelsmoothing-half-life(0-65534)","Babelcom
mands\n""Smoothinghalf-life\n""Seconds(0todisable)\n"){intseconds;seconds=strtou
l(argv[2]->arg,NULL,10);change_smoothing_half_life(seconds);returnCMD_SUCCESS;}v
oidbabeld_quagga_init(void){install_node(&cmd_babel_node,&babel_config_write);in
stall_element(CONFIG_NODE,&router_babel_cmd);install_element(CONFIG_NODE,&no_rou
ter_babel_cmd);install_default(BABEL_NODE);install_element(BABEL_NODE,&babel_div
ersity_cmd);install_element(BABEL_NODE,&no_babel_diversity_cmd);install_element(
BABEL_NODE,&babel_diversity_factor_cmd);install_element(BABEL_NODE,&babel_set_re
send_delay_cmd);install_element(BABEL_NODE,&babel_set_smoothing_half_life_cmd);b
abel_if_init();/*Accesslistinstall.*/access_list_init();access_list_add_hook(bab
el_distribute_update_all_wrapper);access_list_delete_hook(babel_distribute_updat
e_all_wrapper);/*Prefixlistinitialize.*/prefix_list_init();prefix_list_add_hook(
babel_distribute_update_all);prefix_list_delete_hook(babel_distribute_update_all
);/*Distributelistinstall.*/distribute_list_init(BABEL_NODE);distribute_list_add
_hook(babel_distribute_update);distribute_list_delete_hook(babel_distribute_upda
te);}/*StubstoadaptBabel'sfilteringcallstoQuagga'sinfrastructure.*/intinput_filt
er(constunsignedchar*id,constunsignedchar*prefix,unsignedshortplen,constunsigned
char*neigh,unsignedintifindex){returnbabel_filter(0,prefix,plen,ifindex);}intout
put_filter(constunsignedchar*id,constunsignedchar*prefix,unsignedshortplen,unsig
nedintifindex){returnbabel_filter(1,prefix,plen,ifindex);}/*There'snoredistribut
efilterinQuagga--thezebradaemondoesitsownfiltering.*/intredistribute_filter(cons
tunsignedchar*prefix,unsignedshortplen,unsignedintifindex,intproto){return0;}