/*Copyright(c)2007,2008byJuliuszChroboczekPermissionisherebygranted,freeofcharge
,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfiles(the"Soft
ware"),todealintheSoftwarewithoutrestriction,includingwithoutlimitationtherights
touse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopiesoftheSoftw
are,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothefollowingco
nditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincludedinallcopie
sorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYO
FANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY
,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRI
GHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRAC
T,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERD
EALINGSINTHESOFTWARE.*/#include<sys/time.h>#include<time.h>#include<string.h>#in
clude<stdlib.h>#include<zebra.h>#include"if.h"#include"babel_main.h"#include"bab
eld.h"#include"util.h"#include"neighbour.h"#include"resend.h"#include"message.h"
#include"babel_interface.h"structtimevalresend_time={0,0};structresend*to_resend
=NULL;staticintresend_match(structresend*resend,intkind,constunsignedchar*prefix
,unsignedcharplen){return(resend->kind==kind&&resend->plen==plen&&memcmp(resend-
>prefix,prefix,16)==0);}/*Thisiscalledbyneigh.cwhenaneighbourisflushed*/voidflus
h_resends(structneighbour*neigh){/*Nothingfornow*/}staticstructresend*find_resen
d(intkind,constunsignedchar*prefix,unsignedcharplen,structresend**previous_retur
n){structresend*current,*previous;previous=NULL;current=to_resend;while(current)
{if(resend_match(current,kind,prefix,plen)){if(previous_return)*previous_return=
previous;returncurrent;}previous=current;current=current->next;}returnNULL;}stru
ctresend*find_request(constunsignedchar*prefix,unsignedcharplen,structresend**pr
evious_return){returnfind_resend(RESEND_REQUEST,prefix,plen,previous_return);}in
trecord_resend(intkind,constunsignedchar*prefix,unsignedcharplen,unsignedshortse
qno,constunsignedchar*id,structinterface*ifp,intdelay){structresend*resend;unsig
nedintifindex=ifp?ifp->ifindex:0;if((kind==RESEND_REQUEST&&input_filter(NULL,pre
fix,plen,NULL,ifindex)>=INFINITY)||(kind==RESEND_UPDATE&&output_filter(NULL,pref
ix,plen,ifindex)>=INFINITY))return0;if(delay>=0xFFFF)delay=0xFFFF;resend=find_re
send(kind,prefix,plen,NULL);if(resend){if(resend->delay&&delay)resend->delay=MIN
(resend->delay,delay);elseif(delay)resend->delay=delay;resend->time=babel_now;re
send->max=RESEND_MAX;if(id&&memcmp(resend->id,id,8)==0&&seqno_compare(resend->se
qno,seqno)>0){return0;}if(id)memcpy(resend->id,id,8);elsememset(resend->id,0,8);
resend->seqno=seqno;if(resend->ifp!=ifp)resend->ifp=NULL;}else{resend=malloc(siz
eof(structresend));if(resend==NULL)return-1;resend->kind=kind;resend->max=RESEND
_MAX;resend->delay=delay;memcpy(resend->prefix,prefix,16);resend->plen=plen;rese
nd->seqno=seqno;if(id)memcpy(resend->id,id,8);elsememset(resend->id,0,8);resend-
>ifp=ifp;resend->time=babel_now;resend->next=to_resend;to_resend=resend;}if(rese
nd->delay){structtimevaltimeout;timeval_add_msec(&timeout,&resend->time,resend->
delay);timeval_min(&resend_time,&timeout);}return1;}staticintresend_expired(stru
ctresend*resend){switch(resend->kind){caseRESEND_REQUEST:returntimeval_minus_mse
c(&babel_now,&resend->time)>=REQUEST_TIMEOUT;default:returnresend->max<=0;}}intu
nsatisfied_request(constunsignedchar*prefix,unsignedcharplen,unsignedshortseqno,
constunsignedchar*id){structresend*request;request=find_request(prefix,plen,NULL
);if(request==NULL||resend_expired(request))return0;if(memcmp(request->id,id,8)!
=0||seqno_compare(request->seqno,seqno)<=0)return1;return0;}/*Determinewhetherag
ivenrequestshouldbeforwarded.*/intrequest_redundant(structinterface*ifp,constuns
ignedchar*prefix,unsignedcharplen,unsignedshortseqno,constunsignedchar*id){struc
tresend*request;request=find_request(prefix,plen,NULL);if(request==NULL||resend_
expired(request))return0;if(memcmp(request->id,id,8)==0&&seqno_compare(request->
seqno,seqno)>0)return0;if(request->ifp!=NULL&&request->ifp!=ifp)return0;if(reque
st->max>0)/*Willberesent.*/return1;if(timeval_minus_msec(&babel_now,&request->ti
me)<(ifp?MIN(babel_get_if_nfo(ifp)->hello_interval,1000):1000))/*Fairlyrecent.*/
return1;return0;}intsatisfy_request(constunsignedchar*prefix,unsignedcharplen,un
signedshortseqno,constunsignedchar*id,structinterface*ifp){structresend*request,
*previous;request=find_request(prefix,plen,&previous);if(request==NULL)return0;i
f(ifp!=NULL&&request->ifp!=ifp)return0;if(memcmp(request->id,id,8)!=0||seqno_com
pare(request->seqno,seqno)<=0){/*Wecannotremovetherequest,aswemaybewalkingthelis
trightnow.Markitasexpired,sothatexpire_resendwillremoveit.*/request->max=0;reque
st->time.tv_sec=0;recompute_resend_time();return1;}return0;}voidexpire_resend(){
structresend*current,*previous;intrecompute=0;previous=NULL;current=to_resend;wh
ile(current){if(resend_expired(current)){if(previous==NULL){to_resend=current->n
ext;free(current);current=to_resend;}else{previous->next=current->next;free(curr
ent);current=previous->next;}recompute=1;}else{previous=current;current=current-
>next;}}if(recompute)recompute_resend_time();}voidrecompute_resend_time(){struct
resend*request;structtimevalresend={0,0};request=to_resend;while(request){if(!re
send_expired(request)&&request->delay>0&&request->max>0){structtimevaltimeout;ti
meval_add_msec(&timeout,&request->time,request->delay);timeval_min(&resend,&time
out);}request=request->next;}resend_time=resend;}voiddo_resend(){structresend*re
send;resend=to_resend;while(resend){if(!resend_expired(resend)&&resend->delay>0&
&resend->max>0){structtimevaltimeout;timeval_add_msec(&timeout,&resend->time,res
end->delay);if(timeval_compare(&babel_now,&timeout)>=0){switch(resend->kind){cas
eRESEND_REQUEST:send_multihop_request(resend->ifp,resend->prefix,resend->plen,re
send->seqno,resend->id,127);break;caseRESEND_UPDATE:send_update(resend->ifp,1,re
send->prefix,resend->plen);break;default:abort();}resend->delay=MIN(0xFFFF,resen
d->delay*2);resend->max--;}}resend=resend->next;}recompute_resend_time();}