/*Copyright(c)2007,2008byJuliuszChroboczekPermissionisherebygranted,freeofcharge
,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfiles(the"Soft
ware"),todealintheSoftwarewithoutrestriction,includingwithoutlimitationtherights
touse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopiesoftheSoftw
are,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothefollowingco
nditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincludedinallcopie
sorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYO
FANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY
,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPYRI
GHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTRAC
T,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHERD
EALINGSINTHESOFTWARE.*/#include<stdlib.h>#include<stdio.h>#include<string.h>#inc
lude<sys/time.h>#include"babel_main.h"#include"babeld.h"#include"util.h"#include
"source.h"#include"babel_interface.h"#include"route.h"structsource*srcs=NULL;str
uctsource*find_source(constunsignedchar*id,constunsignedchar*p,unsignedcharplen,
intcreate,unsignedshortseqno){structsource*src;for(src=srcs;src;src=src->next){/
*Thisshouldreallybeahashtable.Fornow,checkthelastbytefirst.*/if(src->id[7]!=id[7
])continue;if(memcmp(src->id,id,8)!=0)continue;if(src->plen!=plen)continue;if(me
mcmp(src->prefix,p,16)==0)returnsrc;}if(!create)returnNULL;src=malloc(sizeof(str
uctsource));if(src==NULL){zlog_err("malloc(source):%s",safe_strerror(errno));ret
urnNULL;}memcpy(src->id,id,8);memcpy(src->prefix,p,16);src->plen=plen;src->seqno
=seqno;src->metric=INFINITY;src->time=babel_now.tv_sec;src->route_count=0;src->n
ext=srcs;srcs=src;returnsrc;}structsource*retain_source(structsource*src){assert
(src->route_count<0xffff);src->route_count++;returnsrc;}voidrelease_source(struc
tsource*src){assert(src->route_count>0);src->route_count--;}intflush_source(stru
ctsource*src){if(src->route_count>0)/*Thesourceisinusebyaroute.*/return0;if(srcs
==src){srcs=src->next;}else{structsource*previous=srcs;while(previous->next!=src
)previous=previous->next;previous->next=src->next;}free(src);return1;}voidupdate
_source(structsource*src,unsignedshortseqno,unsignedshortmetric){if(metric>=INFI
NITY)return;/*Ifasourceisexpired,pretendthatitdoesn'texistandupdateituncondition
ally.Thismakesensuresthatolddatawilleventuallybeoverridden,andpreventsusfromgett
ingstuckifarouterlosesitssequencenumber.*/if(src->time<babel_now.tv_sec-SOURCE_G
C_TIME||seqno_compare(src->seqno,seqno)<0||(src->seqno==seqno&&src->metric>metri
c)){src->seqno=seqno;src->metric=metric;}src->time=babel_now.tv_sec;}voidexpire_
sources(){structsource*src;src=srcs;while(src){if(src->time>babel_now.tv_sec)/*c
lockstepped*/src->time=babel_now.tv_sec;if(src->time<babel_now.tv_sec-SOURCE_GC_
TIME){structsource*old=src;src=src->next;flush_source(old);continue;}src=src->ne
xt;}}voidcheck_sources_released(void){structsource*src;for(src=srcs;src;src=src-
>next){if(src->route_count!=0)fprintf(stderr,"Warning:source%s%shasrefcount%d.\n
",format_eui64(src->id),format_prefix(src->prefix,src->plen),(int)src->route_cou
nt);}}