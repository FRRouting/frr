/*Copyright2007,2008byGr√©goireHenry,JulienCristauandJuliuszChroboczekCopyright20
11,2012byMatthieuBoutierandJuliuszChroboczekPermissionisherebygranted,freeofchar
ge,toanypersonobtainingacopyofthissoftwareandassociateddocumentationfiles(the"So
ftware"),todealintheSoftwarewithoutrestriction,includingwithoutlimitationtherigh
tstouse,copy,modify,merge,publish,distribute,sublicense,and/orsellcopiesoftheSof
tware,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,subjecttothefollowing
conditions:Theabovecopyrightnoticeandthispermissionnoticeshallbeincludedinallcop
iesorsubstantialportionsoftheSoftware.THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANT
YOFANYKIND,EXPRESSORIMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILI
TY,FITNESSFORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSORCOPY
RIGHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERINANACTIONOFCONTR
ACT,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTIONWITHTHESOFTWAREORTHEUSEOROTHE
RDEALINGSINTHESOFTWARE.*/#include<sys/time.h>#include<sys/param.h>#include<time.
h>#include"babeld.h"#include<sys/types.h>#include<sys/socket.h>#include<netinet/
in.h>#include<netdb.h>#include<arpa/inet.h>#include<zebra.h>#include"prefix.h"#i
nclude"zclient.h"#include"kernel.h"#include"privs.h"#include"command.h"#include"
vty.h"#include"memory.h"#include"thread.h"#include"nexthop.h"#include"util.h"#in
clude"babel_interface.h"#include"babel_zebra.h"staticintzebra_route(intadd,intfa
milt,constunsignedchar*pref,unsignedshortplen,constunsignedchar*gate,intifindex,
unsignedintmetric);intkernel_interface_operational(structinterface*interface){re
turnif_is_operative(interface);}intkernel_interface_mtu(structinterface*interfac
e){returnMIN(interface->mtu,interface->mtu6);}intkernel_interface_wireless(struc
tinterface*interface){return0;}intkernel_route(intoperation,constunsignedchar*pr
ef,unsignedshortplen,constunsignedchar*gate,intifindex,unsignedintmetric,constun
signedchar*newgate,intnewifindex,unsignedintnewmetric){intrc;intfamily;/*Checkth
attheprotocolfamilyisconsistent.*/if(plen>=96&&v4mapped(pref)){if(!v4mapped(gate
)){errno=EINVAL;return-1;}family=AF_INET;}else{if(v4mapped(gate)){errno=EINVAL;r
eturn-1;}family=AF_INET6;}switch(operation){caseROUTE_ADD:returnzebra_route(1,fa
mily,pref,plen,gate,ifindex,metric);break;caseROUTE_FLUSH:returnzebra_route(0,fa
mily,pref,plen,gate,ifindex,metric);break;caseROUTE_MODIFY:if(newmetric==metric&
&memcmp(newgate,gate,16)==0&&newifindex==ifindex)return0;debugf(BABEL_DEBUG_ROUT
E,"Modifyroute:deleteold;addnew.");rc=zebra_route(0,family,pref,plen,gate,ifinde
x,metric);if(rc<0)return-1;rc=zebra_route(1,family,pref,plen,newgate,newifindex,
newmetric);returnrc;break;default:zlog_err("thisshouldneverhappen(falsevalue-ker
nel_route)");assert(0);exit(1);break;}}staticintzebra_route(intadd,intfamily,con
stunsignedchar*pref,unsignedshortplen,constunsignedchar*gate,intifindex,unsigned
intmetric){structzapi_routeapi;/*quagga'scommunicationsystem*/structprefixquagga
_prefix;/*quagga'sprefix*/uniong_addrbabel_prefix_addr;/*babeld'sprefixaddr*/str
uctzapi_nexthop*api_nh;/*nextroutertogo-noECMP*/api_nh=&api.nexthops[0];/*conver
ttobeunderstandablebyquagga*//*convertgivenaddresses*/switch(family){caseAF_INET
:uchar_to_inaddr(&babel_prefix_addr.ipv4,pref);break;caseAF_INET6:uchar_to_in6ad
dr(&babel_prefix_addr.ipv6,pref);break;}/*makeprefixstructure*/memset(&quagga_pr
efix,0,sizeof(quagga_prefix));quagga_prefix.family=family;switch(family){caseAF_
INET:IPV4_ADDR_COPY(&quagga_prefix.u.prefix4,&babel_prefix_addr.ipv4);/*ourpleni
sforv4mapped'saddr*/quagga_prefix.prefixlen=plen-96;break;caseAF_INET6:IPV6_ADDR
_COPY(&quagga_prefix.u.prefix6,&babel_prefix_addr.ipv6);quagga_prefix.prefixlen=
plen;break;}apply_mask(&quagga_prefix);memset(&api,0,sizeof(api));api.type=ZEBRA
_ROUTE_BABEL;api.safi=SAFI_UNICAST;api.vrf_id=VRF_DEFAULT;api.prefix=quagga_pref
ix;if(metric>=KERNEL_INFINITY){zapi_route_set_blackhole(&api,BLACKHOLE_REJECT);}
else{SET_FLAG(api.message,ZAPI_MESSAGE_NEXTHOP);api.nexthop_num=1;api_nh->ifinde
x=ifindex;api_nh->vrf_id=VRF_DEFAULT;switch(family){caseAF_INET:uchar_to_inaddr(
&api_nh->gate.ipv4,gate);if(IPV4_ADDR_SAME(&api_nh->gate.ipv4,&quagga_prefix.u.p
refix4)&&quagga_prefix.prefixlen==32){api_nh->type=NEXTHOP_TYPE_IFINDEX;}else{ap
i_nh->type=NEXTHOP_TYPE_IPV4_IFINDEX;}break;caseAF_INET6:uchar_to_in6addr(&api_n
h->gate.ipv6,gate);/*differencetoIPv4:alwaysleavethelinklocalasnexthop*/api_nh->
type=NEXTHOP_TYPE_IPV6_IFINDEX;break;}SET_FLAG(api.message,ZAPI_MESSAGE_METRIC);
api.metric=metric;}debugf(BABEL_DEBUG_ROUTE,"%sroute(%s)tozebra",add?"adding":"r
emoving",(family==AF_INET)?"ipv4":"ipv6");returnzclient_route_send(add?ZEBRA_ROU
TE_ADD:ZEBRA_ROUTE_DELETE,zclient,&api);}intif_eui64(intifindex,unsignedchar*eui
){structinterface*ifp=if_lookup_by_index(ifindex,VRF_DEFAULT);if(ifp==NULL){retu
rn-1;}uint8_tlen=(uint8_t)ifp->hw_addr_len;char*tmp=(void*)ifp->hw_addr;if(len==
8){memcpy(eui,tmp,8);eui[0]^=2;}elseif(len==6){memcpy(eui,tmp,3);eui[3]=0xFF;eui
[4]=0xFE;memcpy(eui+5,tmp+3,3);}else{return-1;}return0;}/*Likegettimeofday,butre
turnsmonotonictime.IfPOSIXclocksarenotavailable,fallsbacktogettimeofdaybutenforc
esmonotonicity.*/intgettime(structtimeval*tv){returnmonotime(tv);}/*If/dev/urand
omdoesn'texist,thiswillfailwithENOENT,whichthecallerwilldealwithgracefully.*/int
read_random_bytes(void*buf,size_tlen){intfd;intrc;fd=open("/dev/urandom",O_RDONL
Y);if(fd<0){rc=-1;}else{rc=read(fd,buf,len);if(rc<0||(unsigned)rc<len)rc=-1;clos
e(fd);}returnrc;}