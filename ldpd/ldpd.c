/*$OpenBSD$*//**Copyright(c)2013,2016RenatoWestphal<renato@openbsd.org>*Copyrigh
t(c)2005ClaudioJeker<claudio@openbsd.org>*Copyright(c)2004,2008EsbenNorby<norby@
openbsd.org>*Copyright(c)2003,2004HenningBrauer<henning@openbsd.org>**Permission
touse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishereb
ygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearinallc
opies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGARD
TOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVEN
TSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORAN
YDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCONT
RACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPERF
ORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include<sys/wait.h>#include"ldpd.h"#in
clude"ldpe.h"#include"lde.h"#include"log.h"#include"ldp_vty.h"#include"ldp_debug
.h"#include<lib/version.h>#include<lib/log.h>#include"getopt.h"#include"vty.h"#i
nclude"command.h"#include"memory.h"#include"privs.h"#include"sigevent.h"#include
"zclient.h"#include"vrf.h"#include"filter.h"#include"qobj.h"#include"libfrr.h"st
aticvoidldpd_shutdown(void);staticpid_tstart_child(enumldpd_process,char*,int,in
t);staticintmain_dispatch_ldpe(structthread*);staticintmain_dispatch_lde(structt
hread*);staticintmain_imsg_send_ipc_sockets(structimsgbuf*,structimsgbuf*);stati
cvoidmain_imsg_send_net_sockets(int);staticvoidmain_imsg_send_net_socket(int,enu
msocket_type);staticintmain_imsg_send_config(structldpd_conf*);staticvoidldp_con
fig_normalize(structldpd_conf*);staticvoidldp_config_reset(structldpd_conf*);sta
ticvoidldp_config_reset_main(structldpd_conf*);staticvoidldp_config_reset_af(str
uctldpd_conf*,int);staticvoidldp_config_reset_l2vpns(structldpd_conf*);staticvoi
dmerge_global(structldpd_conf*,structldpd_conf*);staticvoidmerge_af(int,structld
pd_af_conf*,structldpd_af_conf*);staticvoidmerge_ifaces(structldpd_conf*,structl
dpd_conf*);staticvoidmerge_iface_af(structiface_af*,structiface_af*);staticvoidm
erge_tnbrs(structldpd_conf*,structldpd_conf*);staticvoidmerge_nbrps(structldpd_c
onf*,structldpd_conf*);staticvoidmerge_l2vpns(structldpd_conf*,structldpd_conf*)
;staticvoidmerge_l2vpn(structldpd_conf*,structl2vpn*,structl2vpn*);DEFINE_QOBJ_T
YPE(iface)DEFINE_QOBJ_TYPE(tnbr)DEFINE_QOBJ_TYPE(nbr_params)DEFINE_QOBJ_TYPE(l2v
pn_if)DEFINE_QOBJ_TYPE(l2vpn_pw)DEFINE_QOBJ_TYPE(l2vpn)DEFINE_QOBJ_TYPE(ldpd_con
f)structldpd_globalglobal;structldpd_initinit;structldpd_conf*ldpd_conf,*vty_con
f;staticstructimsgev*iev_ldpe,*iev_ldpe_sync;staticstructimsgev*iev_lde,*iev_lde
_sync;staticpid_tldpe_pid;staticpid_tlde_pid;#defineLDP_DEFAULT_CONFIG"ldpd.conf
"#defineLDP_VTY_PORT2612/*Masterofthreads.*/structthread_master*master;staticstr
uctfrr_daemon_infoldpd_di;/*ldpdprivileges*/staticzebra_capabilities_t_caps_p[]=
{ZCAP_BIND,ZCAP_NET_ADMIN};structzebra_privs_tldpd_privs={#ifdefined(FRR_USER)&&
defined(FRR_GROUP).user=FRR_USER,.group=FRR_GROUP,#endif#ifdefined(VTY_GROUP).vt
y_group=VTY_GROUP,#endif.caps_p=_caps_p,.cap_num_p=array_size(_caps_p),.cap_num_
i=0};/*CTLSocketpath*/charctl_sock_path[MAXPATHLEN]=LDPD_SOCKET;/*LDPdoptions.*/
#defineOPTION_CTLSOCK1001staticstructoptionlongopts[]={{"ctl_socket",required_ar
gument,NULL,OPTION_CTLSOCK},{"instance",required_argument,NULL,'n'},{0}};/*SIGHU
Phandler.*/staticvoidsighup(void){log_info("SIGHUPreceived");/**Doafullconfigura
tionreload.Inotherwords,resetvty_conf*andbuildanewconfiguartionfromscratch.*/ldp
_config_reset(vty_conf);vty_read_config(ldpd_di.config_file,config_default);ldp_
config_apply(NULL,vty_conf);}/*SIGINT/SIGTERMhandler.*/staticvoidsigint(void){lo
g_info("SIGINTreceived");ldpd_shutdown();}/*SIGUSR1handler.*/staticvoidsigusr1(v
oid){zlog_rotate();}staticstructquagga_signal_tldp_signals[]={{.signal=SIGHUP,.h
andler=&sighup,},{.signal=SIGINT,.handler=&sigint,},{.signal=SIGTERM,.handler=&s
igint,},{.signal=SIGUSR1,.handler=&sigusr1,}};FRR_DAEMON_INFO(ldpd,LDP,.vty_port
=LDP_VTY_PORT,.proghelp="ImplementationoftheLDPprotocol.",.signals=ldp_signals,.
n_signals=array_size(ldp_signals),.privs=&ldpd_privs,)intmain(intargc,char*argv[
]){char*saved_argv0;intlflag=0,eflag=0;intpipe_parent2ldpe[2],pipe_parent2ldpe_s
ync[2];intpipe_parent2lde[2],pipe_parent2lde_sync[2];char*ctl_sock_name;ldpd_pro
cess=PROC_MAIN;log_procname=log_procnames[ldpd_process];saved_argv0=argv[0];if(s
aved_argv0==NULL)saved_argv0=(char*)"ldpd";frr_preinit(&ldpd_di,argc,argv);frr_o
pt_add("LEn:",longopts,"--ctl_socketOverridectlsocketpath\n""-n,--instanceInstan
ceid\n");while(1){intopt;opt=frr_getopt(argc,argv,NULL);if(opt==EOF)break;switch
(opt){case0:break;caseOPTION_CTLSOCK:ctl_sock_name=strrchr(LDPD_SOCKET,'/');if(c
tl_sock_name)/*skip'/'*/ctl_sock_name++;else/**LDPD_SOCKETconfiguredasrelativepa
th*duringconfig?Shouldreallyneverhappenfor*sensibleconfig*/ctl_sock_name=(char*)
LDPD_SOCKET;strlcpy(ctl_sock_path,optarg,sizeof(ctl_sock_path));strlcat(ctl_sock
_path,"/",sizeof(ctl_sock_path));strlcat(ctl_sock_path,ctl_sock_name,sizeof(ctl_
sock_path));break;case'n':init.instance=atoi(optarg);if(init.instance<1)exit(0);
break;case'L':lflag=1;break;case'E':eflag=1;break;default:frr_help_exit(1);break
;}}strlcpy(init.user,ldpd_privs.user,sizeof(init.user));strlcpy(init.group,ldpd_
privs.group,sizeof(init.group));strlcpy(init.ctl_sock_path,ctl_sock_path,sizeof(
init.ctl_sock_path));strlcpy(init.zclient_serv_path,frr_zclientpath,sizeof(init.
zclient_serv_path));argc-=optind;if(argc>0||(lflag&&eflag))frr_help_exit(1);/*ch
eckforrootprivileges*/if(geteuid()!=0){errno=EPERM;perror(ldpd_di.progname);exit
(1);}if(lflag||eflag)openzlog(ldpd_di.progname,"LDP",0,LOG_CONS|LOG_NDELAY|LOG_P
ID,LOG_DAEMON);if(lflag)lde();elseif(eflag)ldpe();if(socketpair(AF_UNIX,SOCK_STR
EAM,PF_UNSPEC,pipe_parent2ldpe)==-1)fatal("socketpair");if(socketpair(AF_UNIX,SO
CK_STREAM,PF_UNSPEC,pipe_parent2ldpe_sync)==-1)fatal("socketpair");if(socketpair
(AF_UNIX,SOCK_STREAM,PF_UNSPEC,pipe_parent2lde)==-1)fatal("socketpair");if(socke
tpair(AF_UNIX,SOCK_STREAM,PF_UNSPEC,pipe_parent2lde_sync)==-1)fatal("socketpair"
);sock_set_nonblock(pipe_parent2ldpe[0]);sock_set_cloexec(pipe_parent2ldpe[0]);s
ock_set_nonblock(pipe_parent2ldpe[1]);sock_set_cloexec(pipe_parent2ldpe[1]);sock
_set_nonblock(pipe_parent2ldpe_sync[0]);sock_set_cloexec(pipe_parent2ldpe_sync[0
]);sock_set_cloexec(pipe_parent2ldpe_sync[1]);sock_set_nonblock(pipe_parent2lde[
0]);sock_set_cloexec(pipe_parent2lde[0]);sock_set_nonblock(pipe_parent2lde[1]);s
ock_set_cloexec(pipe_parent2lde[1]);sock_set_nonblock(pipe_parent2lde_sync[0]);s
ock_set_cloexec(pipe_parent2lde_sync[0]);sock_set_cloexec(pipe_parent2lde_sync[1
]);/*startchildren*/lde_pid=start_child(PROC_LDE_ENGINE,saved_argv0,pipe_parent2
lde[1],pipe_parent2lde_sync[1]);ldpe_pid=start_child(PROC_LDP_ENGINE,saved_argv0
,pipe_parent2ldpe[1],pipe_parent2ldpe_sync[1]);master=frr_init();vty_config_lock
less();vrf_init(NULL,NULL,NULL,NULL);access_list_init();ldp_vty_init();ldp_zebra
_init(master);/**Createbaseconfigurationwithsanedefaults.Allconfiguration*reques
ts(e.g.CLI)actonvty_confandthencallldp_config_apply()*tomergethechangesintoldpd_
conf,whichcontainstheactual*runningconfiguration.*/ldpd_conf=config_new_empty();
vty_conf=config_new_empty();QOBJ_REG(vty_conf,ldpd_conf);/*readconfigurationfile
anddaemonize*/frr_config_fork();/*applyconfiguration*/ldp_config_apply(NULL,vty_
conf);/*setuppipestochildren*/if((iev_ldpe=calloc(1,sizeof(structimsgev)))==NULL
||(iev_ldpe_sync=calloc(1,sizeof(structimsgev)))==NULL||(iev_lde=calloc(1,sizeof
(structimsgev)))==NULL||(iev_lde_sync=calloc(1,sizeof(structimsgev)))==NULL)fata
l(NULL);imsg_init(&iev_ldpe->ibuf,pipe_parent2ldpe[0]);iev_ldpe->handler_read=ma
in_dispatch_ldpe;iev_ldpe->ev_read=NULL;thread_add_read(master,iev_ldpe->handler
_read,iev_ldpe,iev_ldpe->ibuf.fd,&iev_ldpe->ev_read);iev_ldpe->handler_write=ldp
_write_handler;imsg_init(&iev_ldpe_sync->ibuf,pipe_parent2ldpe_sync[0]);iev_ldpe
_sync->handler_read=main_dispatch_ldpe;iev_ldpe_sync->ev_read=NULL;thread_add_re
ad(master,iev_ldpe_sync->handler_read,iev_ldpe_sync,iev_ldpe_sync->ibuf.fd,&iev_
ldpe_sync->ev_read);iev_ldpe_sync->handler_write=ldp_write_handler;imsg_init(&ie
v_lde->ibuf,pipe_parent2lde[0]);iev_lde->handler_read=main_dispatch_lde;iev_lde-
>ev_read=NULL;thread_add_read(master,iev_lde->handler_read,iev_lde,iev_lde->ibuf
.fd,&iev_lde->ev_read);iev_lde->handler_write=ldp_write_handler;imsg_init(&iev_l
de_sync->ibuf,pipe_parent2lde_sync[0]);iev_lde_sync->handler_read=main_dispatch_
lde;iev_lde_sync->ev_read=NULL;thread_add_read(master,iev_lde_sync->handler_read
,iev_lde_sync,iev_lde_sync->ibuf.fd,&iev_lde_sync->ev_read);iev_lde_sync->handle
r_write=ldp_write_handler;if(main_imsg_send_ipc_sockets(&iev_ldpe->ibuf,&iev_lde
->ibuf))fatal("couldnotestablishimsglinks");main_imsg_compose_both(IMSG_DEBUG_UP
DATE,&ldp_debug,sizeof(ldp_debug));main_imsg_compose_both(IMSG_INIT,&init,sizeof
(init));main_imsg_send_config(ldpd_conf);if(ldpd_conf->ipv4.flags&F_LDPD_AF_ENAB
LED)main_imsg_send_net_sockets(AF_INET);if(ldpd_conf->ipv6.flags&F_LDPD_AF_ENABL
ED)main_imsg_send_net_sockets(AF_INET6);frr_run(master);/*NOTREACHED*/return(0);
}staticvoidldpd_shutdown(void){pid_tpid;intstatus;frr_early_fini();/*closepipes*
/msgbuf_clear(&iev_ldpe->ibuf.w);close(iev_ldpe->ibuf.fd);msgbuf_clear(&iev_lde-
>ibuf.w);close(iev_lde->ibuf.fd);config_clear(ldpd_conf);ldp_config_reset(vty_co
nf);QOBJ_UNREG(vty_conf);free(vty_conf);log_debug("waitingforchildrentoterminate
");do{pid=wait(&status);if(pid==-1){if(errno!=EINTR&&errno!=ECHILD)fatal("wait")
;}elseif(WIFSIGNALED(status))log_warnx("%sterminated;signal%d",(pid==lde_pid)?"l
abeldecisionengine":"ldpengine",WTERMSIG(status));}while(pid!=-1||(pid==-1&&errn
o==EINTR));free(iev_ldpe);free(iev_lde);log_info("terminating");vrf_terminate();
access_list_reset();ldp_zebra_destroy();frr_fini();exit(0);}staticpid_tstart_chi
ld(enumldpd_processp,char*argv0,intfd_async,intfd_sync){char*argv[3];intargc=0,n
ullfd;pid_tpid;switch(pid=fork()){case-1:fatal("cannotfork");case0:break;default
:close(fd_async);close(fd_sync);return(pid);}nullfd=open("/dev/null",O_RDONLY|O_
NOCTTY);if(nullfd==-1){zlog_err("%s:failedtoopen/dev/null:%s",__func__,safe_stre
rror(errno));}else{dup2(nullfd,0);dup2(nullfd,1);dup2(nullfd,2);close(nullfd);}i
f(dup2(fd_async,LDPD_FD_ASYNC)==-1)fatal("cannotsetupimsgasyncfd");if(dup2(fd_sy
nc,LDPD_FD_SYNC)==-1)fatal("cannotsetupimsgsyncfd");argv[argc++]=argv0;switch(p)
{casePROC_MAIN:fatalx("Cannotstartmainprocess");casePROC_LDE_ENGINE:argv[argc++]
=(char*)"-L";break;casePROC_LDP_ENGINE:argv[argc++]=(char*)"-E";break;}argv[argc
++]=NULL;execvp(argv0,argv);fatal("execvp");}/*imsghandling*//*ARGSUSED*/statici
ntmain_dispatch_ldpe(structthread*thread){structimsgev*iev=THREAD_ARG(thread);st
ructimsgbuf*ibuf=&iev->ibuf;structimsgimsg;intaf;ssize_tn;intshut=0;iev->ev_read
=NULL;if((n=imsg_read(ibuf))==-1&&errno!=EAGAIN)fatal("imsg_readerror");if(n==0)
/*connectionclosed*/shut=1;for(;;){if((n=imsg_get(ibuf,&imsg))==-1)fatal("imsg_g
et");if(n==0)break;switch(imsg.hdr.type){caseIMSG_LOG:logit(imsg.hdr.pid,"%s",(c
onstchar*)imsg.data);break;caseIMSG_REQUEST_SOCKETS:af=imsg.hdr.pid;main_imsg_se
nd_net_sockets(af);break;caseIMSG_ACL_CHECK:if(imsg.hdr.len!=IMSG_HEADER_SIZE+si
zeof(structacl_check))fatalx("IMSG_ACL_CHECKimsgwithwronglen");ldp_acl_reply(iev
,(structacl_check*)imsg.data);break;default:log_debug("%s:errorhandlingimsg%d",_
_func__,imsg.hdr.type);break;}imsg_free(&imsg);}if(!shut)imsg_event_add(iev);els
e{/*thispipeisdead,soremovetheeventhandlersandexit*/THREAD_READ_OFF(iev->ev_read
);THREAD_WRITE_OFF(iev->ev_write);ldpe_pid=0;if(lde_pid==0)ldpd_shutdown();elsek
ill(lde_pid,SIGTERM);}return(0);}/*ARGSUSED*/staticintmain_dispatch_lde(structth
read*thread){structimsgev*iev=THREAD_ARG(thread);structimsgbuf*ibuf=&iev->ibuf;s
tructimsgimsg;ssize_tn;intshut=0;iev->ev_read=NULL;if((n=imsg_read(ibuf))==-1&&e
rrno!=EAGAIN)fatal("imsg_readerror");if(n==0)/*connectionclosed*/shut=1;for(;;){
if((n=imsg_get(ibuf,&imsg))==-1)fatal("imsg_get");if(n==0)break;switch(imsg.hdr.
type){caseIMSG_LOG:logit(imsg.hdr.pid,"%s",(constchar*)imsg.data);break;caseIMSG
_KLABEL_CHANGE:if(imsg.hdr.len-IMSG_HEADER_SIZE!=sizeof(structkroute))fatalx("in
validsizeofIMSG_KLABEL_CHANGE");if(kr_change(imsg.data))log_warnx("%s:errorchang
ingroute",__func__);break;caseIMSG_KLABEL_DELETE:if(imsg.hdr.len-IMSG_HEADER_SIZ
E!=sizeof(structkroute))fatalx("invalidsizeofIMSG_KLABEL_DELETE");if(kr_delete(i
msg.data))log_warnx("%s:errordeletingroute",__func__);break;caseIMSG_KPW_ADD:cas
eIMSG_KPW_DELETE:caseIMSG_KPW_SET:caseIMSG_KPW_UNSET:if(imsg.hdr.len-IMSG_HEADER
_SIZE!=sizeof(structzapi_pw))fatalx("invalidsizeofIMSG_KPWLABEL_CHANGE");switch(
imsg.hdr.type){caseIMSG_KPW_ADD:if(kmpw_add(imsg.data))log_warnx("%s:erroradding
""pseudowire",__func__);break;caseIMSG_KPW_DELETE:if(kmpw_del(imsg.data))log_war
nx("%s:errordeleting""pseudowire",__func__);break;caseIMSG_KPW_SET:if(kmpw_set(i
msg.data))log_warnx("%s:errorsetting""pseudowire",__func__);break;caseIMSG_KPW_U
NSET:if(kmpw_unset(imsg.data))log_warnx("%s:errorunsetting""pseudowire",__func__
);break;}break;caseIMSG_ACL_CHECK:if(imsg.hdr.len!=IMSG_HEADER_SIZE+sizeof(struc
tacl_check))fatalx("IMSG_ACL_CHECKimsgwithwronglen");ldp_acl_reply(iev,(structac
l_check*)imsg.data);break;default:log_debug("%s:errorhandlingimsg%d",__func__,im
sg.hdr.type);break;}imsg_free(&imsg);}if(!shut)imsg_event_add(iev);else{/*thispi
peisdead,soremovetheeventhandlersandexit*/THREAD_READ_OFF(iev->ev_read);THREAD_W
RITE_OFF(iev->ev_write);lde_pid=0;if(ldpe_pid==0)ldpd_shutdown();elsekill(ldpe_p
id,SIGTERM);}return(0);}/*ARGSUSED*/intldp_write_handler(structthread*thread){st
ructimsgev*iev=THREAD_ARG(thread);structimsgbuf*ibuf=&iev->ibuf;ssize_tn;iev->ev
_write=NULL;if((n=msgbuf_write(&ibuf->w))==-1&&errno!=EAGAIN)fatal("msgbuf_write
");if(n==0){/*thispipeisdead,soremovetheeventhandlers*/THREAD_READ_OFF(iev->ev_r
ead);THREAD_WRITE_OFF(iev->ev_write);return(0);}imsg_event_add(iev);return(0);}v
oidmain_imsg_compose_ldpe(inttype,pid_tpid,void*data,uint16_tdatalen){if(iev_ldp
e==NULL)return;imsg_compose_event(iev_ldpe,type,0,pid,-1,data,datalen);}voidmain
_imsg_compose_lde(inttype,pid_tpid,void*data,uint16_tdatalen){imsg_compose_event
(iev_lde,type,0,pid,-1,data,datalen);}intmain_imsg_compose_both(enumimsg_typetyp
e,void*buf,uint16_tlen){if(iev_ldpe==NULL||iev_lde==NULL)return(0);if(imsg_compo
se_event(iev_ldpe,type,0,0,-1,buf,len)==-1)return(-1);if(imsg_compose_event(iev_
lde,type,0,0,-1,buf,len)==-1)return(-1);return(0);}voidimsg_event_add(structimsg
ev*iev){if(iev->handler_read)thread_add_read(master,iev->handler_read,iev,iev->i
buf.fd,&iev->ev_read);if(iev->handler_write&&iev->ibuf.w.queued)thread_add_write
(master,iev->handler_write,iev,iev->ibuf.fd,&iev->ev_write);}intimsg_compose_eve
nt(structimsgev*iev,uint16_ttype,uint32_tpeerid,pid_tpid,intfd,void*data,uint16_
tdatalen){intret;if((ret=imsg_compose(&iev->ibuf,type,peerid,pid,fd,data,datalen
))!=-1)imsg_event_add(iev);return(ret);}voidevbuf_enqueue(structevbuf*eb,structi
buf*buf){ibuf_close(&eb->wbuf,buf);evbuf_event_add(eb);}voidevbuf_event_add(stru
ctevbuf*eb){if(eb->wbuf.queued)thread_add_write(master,eb->handler,eb->arg,eb->w
buf.fd,&eb->ev);}voidevbuf_init(structevbuf*eb,intfd,int(*handler)(structthread*
),void*arg){msgbuf_init(&eb->wbuf);eb->wbuf.fd=fd;eb->handler=handler;eb->arg=ar
g;}voidevbuf_clear(structevbuf*eb){THREAD_WRITE_OFF(eb->ev);msgbuf_clear(&eb->wb
uf);eb->wbuf.fd=-1;}staticintmain_imsg_send_ipc_sockets(structimsgbuf*ldpe_buf,s
tructimsgbuf*lde_buf){intpipe_ldpe2lde[2];if(socketpair(AF_UNIX,SOCK_STREAM,PF_U
NSPEC,pipe_ldpe2lde)==-1)return(-1);sock_set_nonblock(pipe_ldpe2lde[0]);sock_set
_nonblock(pipe_ldpe2lde[1]);if(imsg_compose(ldpe_buf,IMSG_SOCKET_IPC,0,0,pipe_ld
pe2lde[0],NULL,0)==-1)return(-1);if(imsg_compose(lde_buf,IMSG_SOCKET_IPC,0,0,pip
e_ldpe2lde[1],NULL,0)==-1)return(-1);return(0);}staticvoidmain_imsg_send_net_soc
kets(intaf){if(!ldp_addrisset(af,&(ldp_af_conf_get(ldpd_conf,af))->trans_addr))r
eturn;main_imsg_send_net_socket(af,LDP_SOCKET_DISC);main_imsg_send_net_socket(af
,LDP_SOCKET_EDISC);main_imsg_send_net_socket(af,LDP_SOCKET_SESSION);imsg_compose
_event(iev_ldpe,IMSG_SETUP_SOCKETS,af,0,-1,NULL,0);}staticvoidmain_imsg_send_net
_socket(intaf,enumsocket_typetype){intfd;fd=ldp_create_socket(af,type);if(fd==-1
){log_warnx("%s:failedtocreate%ssocketforaddress-family""%s",__func__,socket_nam
e(type),af_name(af));return;}imsg_compose_event(iev_ldpe,IMSG_SOCKET_NET,af,0,fd
,&type,sizeof(type));}intldp_acl_request(structimsgev*iev,char*acl_name,intaf,un
ionldpd_addr*addr,uint8_tprefixlen){structimsgimsg;ssize_tn;structacl_checkacl_c
heck;if(acl_name[0]=='\0')returnFILTER_PERMIT;/*buildrequest*/strlcpy(acl_check.
acl,acl_name,sizeof(acl_check.acl));acl_check.af=af;acl_check.addr=*addr;acl_che
ck.prefixlen=prefixlen;/*send(blocking)*/imsg_compose_event(iev,IMSG_ACL_CHECK,0
,0,-1,&acl_check,sizeof(acl_check));imsg_flush(&iev->ibuf);/*receive(blocking)an
dparseresult*/if((n=imsg_read(&iev->ibuf))==-1)fatal("imsg_readerror");if((n=ims
g_get(&iev->ibuf,&imsg))==-1)fatal("imsg_get");if(imsg.hdr.type!=IMSG_ACL_CHECK|
|imsg.hdr.len!=IMSG_HEADER_SIZE+sizeof(int))fatalx("ldp_acl_request:invalidrespo
nse");return(*((int*)imsg.data));}voidldp_acl_reply(structimsgev*iev,structacl_c
heck*acl_check){structaccess_list*alist;structprefixprefix;intresult;alist=acces
s_list_lookup(family2afi(acl_check->af),acl_check->acl);if(alist==NULL)result=FI
LTER_DENY;else{prefix.family=acl_check->af;switch(prefix.family){caseAF_INET:pre
fix.u.prefix4=acl_check->addr.v4;break;caseAF_INET6:prefix.u.prefix6=acl_check->
addr.v6;break;default:fatalx("ldp_acl_reply:unknownaf");}prefix.prefixlen=acl_ch
eck->prefixlen;result=access_list_apply(alist,&prefix);}imsg_compose_event(iev,I
MSG_ACL_CHECK,0,0,-1,&result,sizeof(result));}structldpd_af_conf*ldp_af_conf_get
(structldpd_conf*xconf,intaf){switch(af){caseAF_INET:return(&xconf->ipv4);caseAF
_INET6:return(&xconf->ipv6);default:fatalx("ldp_af_conf_get:unknownaf");}}struct
ldpd_af_global*ldp_af_global_get(structldpd_global*xglobal,intaf){switch(af){cas
eAF_INET:return(&xglobal->ipv4);caseAF_INET6:return(&xglobal->ipv6);default:fata
lx("ldp_af_global_get:unknownaf");}}intldp_is_dual_stack(structldpd_conf*xconf){
return((xconf->ipv4.flags&F_LDPD_AF_ENABLED)&&(xconf->ipv6.flags&F_LDPD_AF_ENABL
ED));}in_addr_tldp_rtr_id_get(structldpd_conf*xconf){if(xconf->rtr_id.s_addr!=IN
ADDR_ANY)return(xconf->rtr_id.s_addr);elsereturn(global.rtr_id.s_addr);}staticin
tmain_imsg_send_config(structldpd_conf*xconf){structiface*iface;structtnbr*tnbr;
structnbr_params*nbrp;structl2vpn*l2vpn;structl2vpn_if*lif;structl2vpn_pw*pw;if(
main_imsg_compose_both(IMSG_RECONF_CONF,xconf,sizeof(*xconf))==-1)return(-1);RB_
FOREACH(iface,iface_head,&xconf->iface_tree){if(main_imsg_compose_both(IMSG_RECO
NF_IFACE,iface,sizeof(*iface))==-1)return(-1);}RB_FOREACH(tnbr,tnbr_head,&xconf-
>tnbr_tree){if(main_imsg_compose_both(IMSG_RECONF_TNBR,tnbr,sizeof(*tnbr))==-1)r
eturn(-1);}RB_FOREACH(nbrp,nbrp_head,&xconf->nbrp_tree){if(main_imsg_compose_bot
h(IMSG_RECONF_NBRP,nbrp,sizeof(*nbrp))==-1)return(-1);}RB_FOREACH(l2vpn,l2vpn_he
ad,&xconf->l2vpn_tree){if(main_imsg_compose_both(IMSG_RECONF_L2VPN,l2vpn,sizeof(
*l2vpn))==-1)return(-1);RB_FOREACH(lif,l2vpn_if_head,&l2vpn->if_tree){if(main_im
sg_compose_both(IMSG_RECONF_L2VPN_IF,lif,sizeof(*lif))==-1)return(-1);}RB_FOREAC
H(pw,l2vpn_pw_head,&l2vpn->pw_tree){if(main_imsg_compose_both(IMSG_RECONF_L2VPN_
PW,pw,sizeof(*pw))==-1)return(-1);}RB_FOREACH(pw,l2vpn_pw_head,&l2vpn->pw_inacti
ve_tree){if(main_imsg_compose_both(IMSG_RECONF_L2VPN_IPW,pw,sizeof(*pw))==-1)ret
urn(-1);}}if(main_imsg_compose_both(IMSG_RECONF_END,NULL,0)==-1)return(-1);retur
n(0);}intldp_config_apply(structvty*vty,structldpd_conf*xconf){/**Whenreadingfro
maconfigurationfile(startupandsighup),we*callmerge_config()onlyonceafterthewhole
confighasbeenread.*Thisistheoptimalandleastdisruptivewaytoupdatetherunning*confi
guration.*/if(vty&&vty->type==VTY_FILE)return(0);ldp_config_normalize(xconf);if(
main_imsg_send_config(xconf)==-1)return(-1);merge_config(ldpd_conf,xconf);return
(0);}staticvoidldp_config_normalize(structldpd_conf*xconf){structiface*iface,*it
mp;structnbr_params*nbrp,*ntmp;structl2vpn*l2vpn;structl2vpn_pw*pw,*ptmp;if(!(xc
onf->flags&F_LDPD_ENABLED))ldp_config_reset_main(xconf);else{if(!(xconf->ipv4.fl
ags&F_LDPD_AF_ENABLED))ldp_config_reset_af(xconf,AF_INET);if(!(xconf->ipv6.flags
&F_LDPD_AF_ENABLED))ldp_config_reset_af(xconf,AF_INET6);RB_FOREACH_SAFE(iface,if
ace_head,&xconf->iface_tree,itmp){if(iface->ipv4.enabled||iface->ipv6.enabled)co
ntinue;QOBJ_UNREG(iface);RB_REMOVE(iface_head,&vty_conf->iface_tree,iface);free(
iface);}RB_FOREACH_SAFE(nbrp,nbrp_head,&xconf->nbrp_tree,ntmp){if(nbrp->flags&(F
_NBRP_KEEPALIVE|F_NBRP_GTSM))continue;if(nbrp->auth.method!=AUTH_NONE)continue;Q
OBJ_UNREG(nbrp);RB_REMOVE(nbrp_head,&vty_conf->nbrp_tree,nbrp);free(nbrp);}}RB_F
OREACH(l2vpn,l2vpn_head,&xconf->l2vpn_tree){RB_FOREACH_SAFE(pw,l2vpn_pw_head,&l2
vpn->pw_tree,ptmp){if(!(pw->flags&F_PW_STATIC_NBR_ADDR)){pw->af=AF_INET;pw->addr
.v4=pw->lsr_id;}if(pw->lsr_id.s_addr!=INADDR_ANY&&pw->pwid!=0)continue;RB_REMOVE
(l2vpn_pw_head,&l2vpn->pw_tree,pw);RB_INSERT(l2vpn_pw_head,&l2vpn->pw_inactive_t
ree,pw);}RB_FOREACH_SAFE(pw,l2vpn_pw_head,&l2vpn->pw_inactive_tree,ptmp){if(!(pw
->flags&F_PW_STATIC_NBR_ADDR)){pw->af=AF_INET;pw->addr.v4=pw->lsr_id;}if(pw->lsr
_id.s_addr==INADDR_ANY||pw->pwid==0)continue;RB_REMOVE(l2vpn_pw_head,&l2vpn->pw_
inactive_tree,pw);RB_INSERT(l2vpn_pw_head,&l2vpn->pw_tree,pw);}}}staticvoidldp_c
onfig_reset(structldpd_conf*conf){ldp_config_reset_main(conf);ldp_config_reset_l
2vpns(conf);}staticvoidldp_config_reset_main(structldpd_conf*conf){structiface*i
face;structnbr_params*nbrp;while(!RB_EMPTY(iface_head,&conf->iface_tree)){iface=
RB_ROOT(iface_head,&conf->iface_tree);QOBJ_UNREG(iface);RB_REMOVE(iface_head,&co
nf->iface_tree,iface);free(iface);}while(!RB_EMPTY(nbrp_head,&conf->nbrp_tree)){
nbrp=RB_ROOT(nbrp_head,&conf->nbrp_tree);QOBJ_UNREG(nbrp);RB_REMOVE(nbrp_head,&c
onf->nbrp_tree,nbrp);free(nbrp);}conf->rtr_id.s_addr=INADDR_ANY;ldp_config_reset
_af(conf,AF_INET);ldp_config_reset_af(conf,AF_INET6);conf->lhello_holdtime=LINK_
DFLT_HOLDTIME;conf->lhello_interval=DEFAULT_HELLO_INTERVAL;conf->thello_holdtime
=TARGETED_DFLT_HOLDTIME;conf->thello_interval=DEFAULT_HELLO_INTERVAL;conf->trans
_pref=DUAL_STACK_LDPOV6;conf->flags=0;}staticvoidldp_config_reset_af(structldpd_
conf*conf,intaf){structldpd_af_conf*af_conf;structiface*iface;structiface_af*ia;
structtnbr*tnbr,*ttmp;RB_FOREACH(iface,iface_head,&conf->iface_tree){ia=iface_af
_get(iface,af);ia->enabled=0;}RB_FOREACH_SAFE(tnbr,tnbr_head,&conf->tnbr_tree,tt
mp){if(tnbr->af!=af)continue;QOBJ_UNREG(tnbr);RB_REMOVE(tnbr_head,&conf->tnbr_tr
ee,tnbr);free(tnbr);}af_conf=ldp_af_conf_get(conf,af);af_conf->keepalive=180;af_
conf->lhello_holdtime=0;af_conf->lhello_interval=0;af_conf->thello_holdtime=0;af
_conf->thello_interval=0;memset(&af_conf->trans_addr,0,sizeof(af_conf->trans_add
r));af_conf->flags=0;}staticvoidldp_config_reset_l2vpns(structldpd_conf*conf){st
ructl2vpn*l2vpn;structl2vpn_if*lif;structl2vpn_pw*pw;while(!RB_EMPTY(l2vpn_head,
&conf->l2vpn_tree)){l2vpn=RB_ROOT(l2vpn_head,&conf->l2vpn_tree);while(!RB_EMPTY(
l2vpn_if_head,&l2vpn->if_tree)){lif=RB_ROOT(l2vpn_if_head,&l2vpn->if_tree);QOBJ_
UNREG(lif);RB_REMOVE(l2vpn_if_head,&l2vpn->if_tree,lif);free(lif);}while(!RB_EMP
TY(l2vpn_pw_head,&l2vpn->pw_tree)){pw=RB_ROOT(l2vpn_pw_head,&l2vpn->pw_tree);QOB
J_UNREG(pw);RB_REMOVE(l2vpn_pw_head,&l2vpn->pw_tree,pw);free(pw);}while(!RB_EMPT
Y(l2vpn_pw_head,&l2vpn->pw_inactive_tree)){pw=RB_ROOT(l2vpn_pw_head,&l2vpn->pw_i
nactive_tree);QOBJ_UNREG(pw);RB_REMOVE(l2vpn_pw_head,&l2vpn->pw_inactive_tree,pw
);free(pw);}QOBJ_UNREG(l2vpn);RB_REMOVE(l2vpn_head,&conf->l2vpn_tree,l2vpn);free
(l2vpn);}}voidldp_clear_config(structldpd_conf*xconf){structiface*iface;structtn
br*tnbr;structnbr_params*nbrp;structl2vpn*l2vpn;while(!RB_EMPTY(iface_head,&xcon
f->iface_tree)){iface=RB_ROOT(iface_head,&xconf->iface_tree);RB_REMOVE(iface_hea
d,&xconf->iface_tree,iface);free(iface);}while(!RB_EMPTY(tnbr_head,&xconf->tnbr_
tree)){tnbr=RB_ROOT(tnbr_head,&xconf->tnbr_tree);RB_REMOVE(tnbr_head,&xconf->tnb
r_tree,tnbr);free(tnbr);}while(!RB_EMPTY(nbrp_head,&xconf->nbrp_tree)){nbrp=RB_R
OOT(nbrp_head,&xconf->nbrp_tree);RB_REMOVE(nbrp_head,&xconf->nbrp_tree,nbrp);fre
e(nbrp);}while(!RB_EMPTY(l2vpn_head,&xconf->l2vpn_tree)){l2vpn=RB_ROOT(l2vpn_hea
d,&xconf->l2vpn_tree);RB_REMOVE(l2vpn_head,&xconf->l2vpn_tree,l2vpn);l2vpn_del(l
2vpn);}free(xconf);}#defineCOPY(a,b)do{\a=malloc(sizeof(*a));\if(a==NULL)\fatal(
__func__);\*a=*b;\}while(0)voidmerge_config(structldpd_conf*conf,structldpd_conf
*xconf){merge_global(conf,xconf);merge_af(AF_INET,&conf->ipv4,&xconf->ipv4);merg
e_af(AF_INET6,&conf->ipv6,&xconf->ipv6);merge_ifaces(conf,xconf);merge_tnbrs(con
f,xconf);merge_nbrps(conf,xconf);merge_l2vpns(conf,xconf);}staticvoidmerge_globa
l(structldpd_conf*conf,structldpd_conf*xconf){/*changeofrouter-idrequiresresetti
ngallneighborships*/if(conf->rtr_id.s_addr!=xconf->rtr_id.s_addr){if(ldpd_proces
s==PROC_LDP_ENGINE){ldpe_reset_nbrs(AF_UNSPEC);if(conf->rtr_id.s_addr==INADDR_AN
Y||xconf->rtr_id.s_addr==INADDR_ANY){if_update_all(AF_UNSPEC);tnbr_update_all(AF
_UNSPEC);}}conf->rtr_id=xconf->rtr_id;}conf->lhello_holdtime=xconf->lhello_holdt
ime;conf->lhello_interval=xconf->lhello_interval;conf->thello_holdtime=xconf->th
ello_holdtime;conf->thello_interval=xconf->thello_interval;if(conf->trans_pref!=
xconf->trans_pref){if(ldpd_process==PROC_LDP_ENGINE)ldpe_reset_ds_nbrs();conf->t
rans_pref=xconf->trans_pref;}if((conf->flags&F_LDPD_DS_CISCO_INTEROP)!=(xconf->f
lags&F_LDPD_DS_CISCO_INTEROP)){if(ldpd_process==PROC_LDP_ENGINE)ldpe_reset_ds_nb
rs();}conf->flags=xconf->flags;}staticvoidmerge_af(intaf,structldpd_af_conf*af_c
onf,structldpd_af_conf*xa){intstop_init_backoff=0;intremove_dynamic_tnbrs=0;intc
hange_egress_label=0;intreset_nbrs_ipv4=0;intreset_nbrs=0;intupdate_sockets=0;/*
updatetimers*/if(af_conf->keepalive!=xa->keepalive){af_conf->keepalive=xa->keepa
live;stop_init_backoff=1;}af_conf->lhello_holdtime=xa->lhello_holdtime;af_conf->
lhello_interval=xa->lhello_interval;af_conf->thello_holdtime=xa->thello_holdtime
;af_conf->thello_interval=xa->thello_interval;/*updateflags*/if((af_conf->flags&
F_LDPD_AF_THELLO_ACCEPT)&&!(xa->flags&F_LDPD_AF_THELLO_ACCEPT))remove_dynamic_tn
brs=1;if((af_conf->flags&F_LDPD_AF_NO_GTSM)!=(xa->flags&F_LDPD_AF_NO_GTSM)){if(a
f==AF_INET6)/*needtoset/unsetIPV6_MINHOPCOUNT*/update_sockets=1;else/*forLDPv4ju
stresettingtheneighborsisenough*/reset_nbrs_ipv4=1;}if((af_conf->flags&F_LDPD_AF
_EXPNULL)!=(xa->flags&F_LDPD_AF_EXPNULL))change_egress_label=1;af_conf->flags=xa
->flags;/*updatethetransportaddress*/if(ldp_addrcmp(af,&af_conf->trans_addr,&xa-
>trans_addr)){af_conf->trans_addr=xa->trans_addr;update_sockets=1;}/*updateACLs*
/if(strcmp(af_conf->acl_label_advertise_to,xa->acl_label_advertise_to)||strcmp(a
f_conf->acl_label_advertise_for,xa->acl_label_advertise_for)||strcmp(af_conf->ac
l_label_accept_from,xa->acl_label_accept_from)||strcmp(af_conf->acl_label_accept
_for,xa->acl_label_accept_for))reset_nbrs=1;if(strcmp(af_conf->acl_thello_accept
_from,xa->acl_thello_accept_from))remove_dynamic_tnbrs=1;if(strcmp(af_conf->acl_
label_expnull_for,xa->acl_label_expnull_for))change_egress_label=1;strlcpy(af_co
nf->acl_thello_accept_from,xa->acl_thello_accept_from,sizeof(af_conf->acl_thello
_accept_from));strlcpy(af_conf->acl_label_allocate_for,xa->acl_label_allocate_fo
r,sizeof(af_conf->acl_label_allocate_for));strlcpy(af_conf->acl_label_advertise_
to,xa->acl_label_advertise_to,sizeof(af_conf->acl_label_advertise_to));strlcpy(a
f_conf->acl_label_advertise_for,xa->acl_label_advertise_for,sizeof(af_conf->acl_
label_advertise_for));strlcpy(af_conf->acl_label_accept_from,xa->acl_label_accep
t_from,sizeof(af_conf->acl_label_accept_from));strlcpy(af_conf->acl_label_accept
_for,xa->acl_label_accept_for,sizeof(af_conf->acl_label_accept_for));strlcpy(af_
conf->acl_label_expnull_for,xa->acl_label_expnull_for,sizeof(af_conf->acl_label_
expnull_for));/*applythenewconfiguration*/switch(ldpd_process){casePROC_LDE_ENGI
NE:if(change_egress_label)lde_change_egress_label(af);break;casePROC_LDP_ENGINE:
if(stop_init_backoff)ldpe_stop_init_backoff(af);if(remove_dynamic_tnbrs)ldpe_rem
ove_dynamic_tnbrs(af);if(reset_nbrs)ldpe_reset_nbrs(AF_UNSPEC);elseif(reset_nbrs
_ipv4)ldpe_reset_nbrs(AF_INET);break;casePROC_MAIN:if(update_sockets&&iev_ldpe)i
msg_compose_event(iev_ldpe,IMSG_CLOSE_SOCKETS,af,0,-1,NULL,0);break;}}staticvoid
merge_ifaces(structldpd_conf*conf,structldpd_conf*xconf){structiface*iface,*itmp
,*xi;RB_FOREACH_SAFE(iface,iface_head,&conf->iface_tree,itmp){/*finddeletedinter
faces*/if((xi=if_lookup_name(xconf,iface->name))==NULL){switch(ldpd_process){cas
ePROC_LDP_ENGINE:ldpe_if_exit(iface);break;casePROC_LDE_ENGINE:casePROC_MAIN:bre
ak;}RB_REMOVE(iface_head,&conf->iface_tree,iface);free(iface);}}RB_FOREACH_SAFE(
xi,iface_head,&xconf->iface_tree,itmp){/*findnewinterfaces*/if((iface=if_lookup_
name(conf,xi->name))==NULL){COPY(iface,xi);RB_INSERT(iface_head,&conf->iface_tre
e,iface);switch(ldpd_process){casePROC_LDP_ENGINE:ldpe_if_init(iface);break;case
PROC_LDE_ENGINE:break;casePROC_MAIN:/*resendaddressestoactivatenewinterfaces*/ki
f_redistribute(iface->name);break;}continue;}/*updateexistinginterfaces*/merge_i
face_af(&iface->ipv4,&xi->ipv4);merge_iface_af(&iface->ipv6,&xi->ipv6);}}staticv
oidmerge_iface_af(structiface_af*ia,structiface_af*xi){if(ia->enabled!=xi->enabl
ed){ia->enabled=xi->enabled;if(ldpd_process==PROC_LDP_ENGINE)ldp_if_update(ia->i
face,ia->af);}ia->hello_holdtime=xi->hello_holdtime;ia->hello_interval=xi->hello
_interval;}staticvoidmerge_tnbrs(structldpd_conf*conf,structldpd_conf*xconf){str
ucttnbr*tnbr,*ttmp,*xt;RB_FOREACH_SAFE(tnbr,tnbr_head,&conf->tnbr_tree,ttmp){if(
!(tnbr->flags&F_TNBR_CONFIGURED))continue;/*finddeletedtnbrs*/if((xt=tnbr_find(x
conf,tnbr->af,&tnbr->addr))==NULL){switch(ldpd_process){casePROC_LDP_ENGINE:tnbr
->flags&=~F_TNBR_CONFIGURED;tnbr_check(conf,tnbr);break;casePROC_LDE_ENGINE:case
PROC_MAIN:RB_REMOVE(tnbr_head,&conf->tnbr_tree,tnbr);free(tnbr);break;}}}RB_FORE
ACH_SAFE(xt,tnbr_head,&xconf->tnbr_tree,ttmp){/*findnewtnbrs*/if((tnbr=tnbr_find
(conf,xt->af,&xt->addr))==NULL){COPY(tnbr,xt);RB_INSERT(tnbr_head,&conf->tnbr_tr
ee,tnbr);switch(ldpd_process){casePROC_LDP_ENGINE:tnbr_update(tnbr);break;casePR
OC_LDE_ENGINE:casePROC_MAIN:break;}continue;}/*updateexistingtnbrs*/if(!(tnbr->f
lags&F_TNBR_CONFIGURED))tnbr->flags|=F_TNBR_CONFIGURED;}}staticvoidmerge_nbrps(s
tructldpd_conf*conf,structldpd_conf*xconf){structnbr_params*nbrp,*ntmp,*xn;struc
tnbr*nbr;intnbrp_changed;RB_FOREACH_SAFE(nbrp,nbrp_head,&conf->nbrp_tree,ntmp){/
*finddeletednbrps*/if((xn=nbr_params_find(xconf,nbrp->lsr_id))==NULL){switch(ldp
d_process){casePROC_LDP_ENGINE:nbr=nbr_find_ldpid(nbrp->lsr_id.s_addr);if(nbr){s
ession_shutdown(nbr,S_SHUTDOWN,0,0);#ifdef__OpenBSD__pfkey_remove(nbr);#elsesock
_set_md5sig((ldp_af_global_get(&global,nbr->af))->ldp_session_socket,nbr->af,&nb
r->raddr,NULL);#endifnbr->auth.method=AUTH_NONE;if(nbr_session_active_role(nbr))
nbr_establish_connection(nbr);}break;casePROC_LDE_ENGINE:casePROC_MAIN:break;}RB
_REMOVE(nbrp_head,&conf->nbrp_tree,nbrp);free(nbrp);}}RB_FOREACH_SAFE(xn,nbrp_he
ad,&xconf->nbrp_tree,ntmp){/*findnewnbrps*/if((nbrp=nbr_params_find(conf,xn->lsr
_id))==NULL){COPY(nbrp,xn);RB_INSERT(nbrp_head,&conf->nbrp_tree,nbrp);switch(ldp
d_process){casePROC_LDP_ENGINE:nbr=nbr_find_ldpid(nbrp->lsr_id.s_addr);if(nbr){s
ession_shutdown(nbr,S_SHUTDOWN,0,0);nbr->auth.method=nbrp->auth.method;#ifdef__O
penBSD__if(pfkey_establish(nbr,nbrp)==-1)fatalx("pfkeysetupfailed");#elsesock_se
t_md5sig((ldp_af_global_get(&global,nbr->af))->ldp_session_socket,nbr->af,&nbr->
raddr,nbrp->auth.md5key);#endifif(nbr_session_active_role(nbr))nbr_establish_con
nection(nbr);}break;casePROC_LDE_ENGINE:casePROC_MAIN:break;}continue;}/*updatee
xistingnbrps*/if(nbrp->flags!=xn->flags||nbrp->keepalive!=xn->keepalive||nbrp->g
tsm_enabled!=xn->gtsm_enabled||nbrp->gtsm_hops!=xn->gtsm_hops||nbrp->auth.method
!=xn->auth.method||strcmp(nbrp->auth.md5key,xn->auth.md5key)!=0)nbrp_changed=1;e
lsenbrp_changed=0;nbrp->keepalive=xn->keepalive;nbrp->gtsm_enabled=xn->gtsm_enab
led;nbrp->gtsm_hops=xn->gtsm_hops;nbrp->auth.method=xn->auth.method;strlcpy(nbrp
->auth.md5key,xn->auth.md5key,sizeof(nbrp->auth.md5key));nbrp->auth.md5key_len=x
n->auth.md5key_len;nbrp->flags=xn->flags;if(ldpd_process==PROC_LDP_ENGINE){nbr=n
br_find_ldpid(nbrp->lsr_id.s_addr);if(nbr&&nbrp_changed){session_shutdown(nbr,S_
SHUTDOWN,0,0);#ifdef__OpenBSD__pfkey_remove(nbr);nbr->auth.method=nbrp->auth.met
hod;if(pfkey_establish(nbr,nbrp)==-1)fatalx("pfkeysetupfailed");#elsenbr->auth.m
ethod=nbrp->auth.method;sock_set_md5sig((ldp_af_global_get(&global,nbr->af))->ld
p_session_socket,nbr->af,&nbr->raddr,nbrp->auth.md5key);#endifif(nbr_session_act
ive_role(nbr))nbr_establish_connection(nbr);}}}}staticvoidmerge_l2vpns(structldp
d_conf*conf,structldpd_conf*xconf){structl2vpn*l2vpn,*ltmp,*xl;RB_FOREACH_SAFE(l
2vpn,l2vpn_head,&conf->l2vpn_tree,ltmp){/*finddeletedl2vpns*/if((xl=l2vpn_find(x
conf,l2vpn->name))==NULL){switch(ldpd_process){casePROC_LDE_ENGINE:l2vpn_exit(l2
vpn);break;casePROC_LDP_ENGINE:ldpe_l2vpn_exit(l2vpn);break;casePROC_MAIN:break;
}RB_REMOVE(l2vpn_head,&conf->l2vpn_tree,l2vpn);l2vpn_del(l2vpn);}}RB_FOREACH_SAF
E(xl,l2vpn_head,&xconf->l2vpn_tree,ltmp){/*findnewl2vpns*/if((l2vpn=l2vpn_find(c
onf,xl->name))==NULL){COPY(l2vpn,xl);RB_INSERT(l2vpn_head,&conf->l2vpn_tree,l2vp
n);RB_INIT(l2vpn_if_head,&l2vpn->if_tree);RB_INIT(l2vpn_pw_head,&l2vpn->pw_tree)
;RB_INIT(l2vpn_pw_head,&l2vpn->pw_inactive_tree);switch(ldpd_process){casePROC_L
DE_ENGINE:l2vpn_init(l2vpn);break;casePROC_LDP_ENGINE:ldpe_l2vpn_init(l2vpn);bre
ak;casePROC_MAIN:break;}}/*updateexistingl2vpns*/merge_l2vpn(conf,l2vpn,xl);}}st
aticvoidmerge_l2vpn(structldpd_conf*xconf,structl2vpn*l2vpn,structl2vpn*xl){stru
ctl2vpn_if*lif,*ftmp,*xf;structl2vpn_pw*pw,*ptmp,*xp;structnbr*nbr;intreset_nbr,
reinstall_pwfec,reinstall_tnbr;intprevious_pw_type,previous_mtu;previous_pw_type
=l2vpn->pw_type;previous_mtu=l2vpn->mtu;/*mergeintefaces*/RB_FOREACH_SAFE(lif,l2
vpn_if_head,&l2vpn->if_tree,ftmp){/*finddeletedinterfaces*/if((xf=l2vpn_if_find(
xl,lif->ifname))==NULL){RB_REMOVE(l2vpn_if_head,&l2vpn->if_tree,lif);free(lif);}
}RB_FOREACH_SAFE(xf,l2vpn_if_head,&xl->if_tree,ftmp){/*findnewinterfaces*/if((li
f=l2vpn_if_find(l2vpn,xf->ifname))==NULL){COPY(lif,xf);RB_INSERT(l2vpn_if_head,&
l2vpn->if_tree,lif);lif->l2vpn=l2vpn;switch(ldpd_process){casePROC_LDP_ENGINE:ca
sePROC_LDE_ENGINE:break;casePROC_MAIN:kif_redistribute(lif->ifname);break;}}}/*m
ergeactivepseudowires*/RB_FOREACH_SAFE(pw,l2vpn_pw_head,&l2vpn->pw_tree,ptmp){/*
finddeletedactivepseudowires*/if((xp=l2vpn_pw_find_active(xl,pw->ifname))==NULL)
{switch(ldpd_process){casePROC_LDE_ENGINE:l2vpn_pw_exit(pw);break;casePROC_LDP_E
NGINE:ldpe_l2vpn_pw_exit(pw);break;casePROC_MAIN:break;}RB_REMOVE(l2vpn_pw_head,
&l2vpn->pw_tree,pw);free(pw);}}RB_FOREACH_SAFE(xp,l2vpn_pw_head,&xl->pw_tree,ptm
p){/*findnewactivepseudowires*/if((pw=l2vpn_pw_find_active(l2vpn,xp->ifname))==N
ULL){COPY(pw,xp);RB_INSERT(l2vpn_pw_head,&l2vpn->pw_tree,pw);pw->l2vpn=l2vpn;swi
tch(ldpd_process){casePROC_LDE_ENGINE:l2vpn_pw_init(pw);break;casePROC_LDP_ENGIN
E:ldpe_l2vpn_pw_init(pw);break;casePROC_MAIN:kif_redistribute(pw->ifname);break;
}continue;}/*updateexistingactivepseudowire*/if(pw->af!=xp->af||ldp_addrcmp(pw->
af,&pw->addr,&xp->addr))reinstall_tnbr=1;elsereinstall_tnbr=0;/*changesthatrequi
reasessionrestart*/if((pw->flags&(F_PW_STATUSTLV_CONF|F_PW_CWORD_CONF))!=(xp->fl
ags&(F_PW_STATUSTLV_CONF|F_PW_CWORD_CONF)))reset_nbr=1;elsereset_nbr=0;if(l2vpn-
>pw_type!=xl->pw_type||l2vpn->mtu!=xl->mtu||pw->pwid!=xp->pwid||reinstall_tnbr||
reset_nbr||pw->lsr_id.s_addr!=xp->lsr_id.s_addr)reinstall_pwfec=1;elsereinstall_
pwfec=0;if(ldpd_process==PROC_LDP_ENGINE){if(reinstall_tnbr)ldpe_l2vpn_pw_exit(p
w);if(reset_nbr){nbr=nbr_find_ldpid(pw->lsr_id.s_addr);if(nbr&&nbr->state==NBR_S
TA_OPER)session_shutdown(nbr,S_SHUTDOWN,0,0);}}if(ldpd_process==PROC_LDE_ENGINE&
&reinstall_pwfec)l2vpn_pw_exit(pw);pw->lsr_id=xp->lsr_id;pw->af=xp->af;pw->addr=
xp->addr;pw->pwid=xp->pwid;strlcpy(pw->ifname,xp->ifname,sizeof(pw->ifname));pw-
>ifindex=xp->ifindex;if(xp->flags&F_PW_CWORD_CONF)pw->flags|=F_PW_CWORD_CONF;els
epw->flags&=~F_PW_CWORD_CONF;if(xp->flags&F_PW_STATUSTLV_CONF)pw->flags|=F_PW_ST
ATUSTLV_CONF;elsepw->flags&=~F_PW_STATUSTLV_CONF;if(xp->flags&F_PW_STATIC_NBR_AD
DR)pw->flags|=F_PW_STATIC_NBR_ADDR;elsepw->flags&=~F_PW_STATIC_NBR_ADDR;if(ldpd_
process==PROC_LDP_ENGINE&&reinstall_tnbr)ldpe_l2vpn_pw_init(pw);if(ldpd_process=
=PROC_LDE_ENGINE&&reinstall_pwfec){l2vpn->pw_type=xl->pw_type;l2vpn->mtu=xl->mtu
;l2vpn_pw_init(pw);l2vpn->pw_type=previous_pw_type;l2vpn->mtu=previous_mtu;}}/*m
ergeinactivepseudowires*/RB_FOREACH_SAFE(pw,l2vpn_pw_head,&l2vpn->pw_inactive_tr
ee,ptmp){/*finddeletedinactivepseudowires*/if((xp=l2vpn_pw_find_inactive(xl,pw->
ifname))==NULL){RB_REMOVE(l2vpn_pw_head,&l2vpn->pw_inactive_tree,pw);free(pw);}}
RB_FOREACH_SAFE(xp,l2vpn_pw_head,&xl->pw_inactive_tree,ptmp){/*findnewinactiveps
eudowires*/if((pw=l2vpn_pw_find_inactive(l2vpn,xp->ifname))==NULL){COPY(pw,xp);R
B_INSERT(l2vpn_pw_head,&l2vpn->pw_inactive_tree,pw);pw->l2vpn=l2vpn;switch(ldpd_
process){casePROC_LDE_ENGINE:casePROC_LDP_ENGINE:break;casePROC_MAIN:kif_redistr
ibute(pw->ifname);break;}continue;}/*updateexistinginactivepseudowire*/pw->lsr_i
d.s_addr=xp->lsr_id.s_addr;pw->af=xp->af;pw->addr=xp->addr;pw->pwid=xp->pwid;str
lcpy(pw->ifname,xp->ifname,sizeof(pw->ifname));pw->ifindex=xp->ifindex;pw->flags
=xp->flags;}l2vpn->pw_type=xl->pw_type;l2vpn->mtu=xl->mtu;strlcpy(l2vpn->br_ifna
me,xl->br_ifname,sizeof(l2vpn->br_ifname));l2vpn->br_ifindex=xl->br_ifindex;}str
uctldpd_conf*config_new_empty(void){structldpd_conf*xconf;xconf=calloc(1,sizeof(
*xconf));if(xconf==NULL)fatal(NULL);RB_INIT(iface_head,&xconf->iface_tree);RB_IN
IT(tnbr_head,&xconf->tnbr_tree);RB_INIT(nbrp_head,&xconf->nbrp_tree);RB_INIT(l2v
pn_head,&xconf->l2vpn_tree);/*setdefaultvalues*/ldp_config_reset(xconf);return(x
conf);}voidconfig_clear(structldpd_conf*conf){structldpd_conf*xconf;/**Mergecurr
entconfigwithanemptyconfig,thiswilldeactivate*anddeallocatealltheinterfaces,pseu
dowiresandsoon.Before*merging,copytherouter-idandothervariablestoavoidsome*unnec
essaryoperations,liketryingtoresettheneighborships.*/xconf=config_new_empty();xc
onf->ipv4=conf->ipv4;xconf->ipv6=conf->ipv6;xconf->rtr_id=conf->rtr_id;xconf->tr
ans_pref=conf->trans_pref;xconf->flags=conf->flags;merge_config(conf,xconf);free
(xconf);free(conf);}