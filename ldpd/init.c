/*$OpenBSD$*//**Copyright(c)2009MicheleMarchetto<michele@openbsd.org>**Permissio
ntouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishere
bygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearinall
copies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGAR
DTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVE
NTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORA
NYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCON
TRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPER
FORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"ldpd.h"#include"ldpe.h"#inclu
de"log.h"#include"ldp_debug.h"staticintgen_init_prms_tlv(structibuf*,structnbr*)
;staticintgen_cap_dynamic_tlv(structibuf*);staticintgen_cap_twcard_tlv(structibu
f*,int);staticintgen_cap_unotif_tlv(structibuf*,int);voidsend_init(structnbr*nbr
){structibuf*buf;uint16_tsize;interr=0;debug_msg_send("initialization:lsr-id%s",
inet_ntoa(nbr->id));size=LDP_HDR_SIZE+LDP_MSG_SIZE+SESS_PRMS_SIZE+CAP_TLV_DYNAMI
C_SIZE+CAP_TLV_TWCARD_SIZE+CAP_TLV_UNOTIF_SIZE;if((buf=ibuf_open(size))==NULL)fa
tal(__func__);err|=gen_ldp_hdr(buf,size);size-=LDP_HDR_SIZE;err|=gen_msg_hdr(buf
,MSG_TYPE_INIT,size);err|=gen_init_prms_tlv(buf,nbr);err|=gen_cap_dynamic_tlv(bu
f);err|=gen_cap_twcard_tlv(buf,1);err|=gen_cap_unotif_tlv(buf,1);if(err){ibuf_fr
ee(buf);return;}evbuf_enqueue(&nbr->tcp->wbuf,buf);}intrecv_init(structnbr*nbr,c
har*buf,uint16_tlen){structldp_msgmsg;structsess_prms_tlvsess;uint16_tmax_pdu_le
n;intcaps_rcvd=0;debug_msg_recv("initialization:lsr-id%s",inet_ntoa(nbr->id));me
mcpy(&msg,buf,sizeof(msg));buf+=LDP_MSG_SIZE;len-=LDP_MSG_SIZE;if(len<SESS_PRMS_
SIZE){session_shutdown(nbr,S_BAD_MSG_LEN,msg.id,msg.type);return(-1);}memcpy(&se
ss,buf,sizeof(sess));if(ntohs(sess.length)!=SESS_PRMS_LEN){session_shutdown(nbr,
S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}if(ntohs(sess.proto_version)!=LDP_VER
SION){session_shutdown(nbr,S_BAD_PROTO_VER,msg.id,msg.type);return(-1);}if(ntohs
(sess.keepalive_time)<MIN_KEEPALIVE){session_shutdown(nbr,S_KEEPALIVE_BAD,msg.id
,msg.type);return(-1);}if(sess.lsr_id!=ldp_rtr_id_get(leconf)||ntohs(sess.lspace
_id)!=0){session_shutdown(nbr,S_NO_HELLO,msg.id,msg.type);return(-1);}buf+=SESS_
PRMS_SIZE;len-=SESS_PRMS_SIZE;/*OptionalParameters*/while(len>0){structtlvtlv;ui
nt16_ttlv_type;uint16_ttlv_len;if(len<sizeof(tlv)){session_shutdown(nbr,S_BAD_TL
V_LEN,msg.id,msg.type);return(-1);}memcpy(&tlv,buf,TLV_HDR_SIZE);tlv_type=ntohs(
tlv.type);tlv_len=ntohs(tlv.length);if(tlv_len+TLV_HDR_SIZE>len){session_shutdow
n(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}buf+=TLV_HDR_SIZE;len-=TLV_HDR_
SIZE;/**RFC5561-Section6:*"TheS-bitofaCapabilityParameterinanInitialization*mess
ageMUSTbe1andSHOULDbeignoredonreceipt".*/switch(tlv_type){caseTLV_TYPE_ATMSESSIO
NPAR:session_shutdown(nbr,S_BAD_TLV_VAL,msg.id,msg.type);return(-1);caseTLV_TYPE
_FRSESSION:session_shutdown(nbr,S_BAD_TLV_VAL,msg.id,msg.type);return(-1);caseTL
V_TYPE_DYNAMIC_CAP:if(tlv_len!=CAP_TLV_DYNAMIC_LEN){session_shutdown(nbr,S_BAD_T
LV_LEN,msg.id,msg.type);return(-1);}if(caps_rcvd&F_CAP_TLV_RCVD_DYNAMIC){session
_shutdown(nbr,S_BAD_TLV_VAL,msg.id,msg.type);return(-1);}caps_rcvd|=F_CAP_TLV_RC
VD_DYNAMIC;nbr->flags|=F_NBR_CAP_DYNAMIC;log_debug("%s:lsr-id%sannouncedtheDynam
ic""CapabilityAnnouncementcapability",__func__,inet_ntoa(nbr->id));break;caseTLV
_TYPE_TWCARD_CAP:if(tlv_len!=CAP_TLV_TWCARD_LEN){session_shutdown(nbr,S_BAD_TLV_
LEN,msg.id,msg.type);return(-1);}if(caps_rcvd&F_CAP_TLV_RCVD_TWCARD){session_shu
tdown(nbr,S_BAD_TLV_VAL,msg.id,msg.type);return(-1);}caps_rcvd|=F_CAP_TLV_RCVD_T
WCARD;nbr->flags|=F_NBR_CAP_TWCARD;log_debug("%s:lsr-id%sannouncedtheTypedWildca
rd""FECcapability",__func__,inet_ntoa(nbr->id));break;caseTLV_TYPE_UNOTIF_CAP:if
(tlv_len!=CAP_TLV_UNOTIF_LEN){session_shutdown(nbr,S_BAD_TLV_LEN,msg.id,msg.type
);return(-1);}if(caps_rcvd&F_CAP_TLV_RCVD_UNOTIF){session_shutdown(nbr,S_BAD_TLV
_VAL,msg.id,msg.type);return(-1);}caps_rcvd|=F_CAP_TLV_RCVD_UNOTIF;nbr->flags|=F
_NBR_CAP_UNOTIF;log_debug("%s:lsr-id%sannouncedtheUnrecognized""Notificationcapa
bility",__func__,inet_ntoa(nbr->id));break;default:if(!(ntohs(tlv.type)&UNKNOWN_
FLAG))send_notification_rtlvs(nbr,S_UNSSUPORTDCAP,msg.id,msg.type,tlv_type,tlv_l
en,buf);/*ignoreunknowntlv*/break;}buf+=tlv_len;len-=tlv_len;}nbr->keepalive=min
(nbr_get_keepalive(nbr->af,nbr->id),ntohs(sess.keepalive_time));max_pdu_len=ntoh
s(sess.max_pdu_len);/**RFC5036-Section3.5.3:*"Avalueof255orlessspecifiesthedefau
ltmaximumlengthof*4096octets".*/if(max_pdu_len<=255)max_pdu_len=LDP_MAX_LEN;nbr-
>max_pdu_len=min(max_pdu_len,LDP_MAX_LEN);nbr_fsm(nbr,NBR_EVT_INIT_RCVD);return(
0);}voidsend_capability(structnbr*nbr,uint16_tcapability,intenable){structibuf*b
uf;uint16_tsize;interr=0;log_debug("%s:lsr-id%s",__func__,inet_ntoa(nbr->id));si
ze=LDP_HDR_SIZE+LDP_MSG_SIZE+CAP_TLV_DYNAMIC_SIZE;if((buf=ibuf_open(size))==NULL
)fatal(__func__);err|=gen_ldp_hdr(buf,size);size-=LDP_HDR_SIZE;err|=gen_msg_hdr(
buf,MSG_TYPE_CAPABILITY,size);switch(capability){caseTLV_TYPE_TWCARD_CAP:err|=ge
n_cap_twcard_tlv(buf,enable);break;caseTLV_TYPE_UNOTIF_CAP:err|=gen_cap_unotif_t
lv(buf,enable);break;caseTLV_TYPE_DYNAMIC_CAP:/**RFC5561-Section9:*"AnLDPspeaker
MUSTNOTincludetheDynamicCapability*AnnouncementParameterinCapabilitymessagessent
to*itspeers".*//*FALLTHROUGH*/default:fatalx("send_capability:unsupportedcapabil
ity");}if(err){ibuf_free(buf);return;}evbuf_enqueue(&nbr->tcp->wbuf,buf);nbr_fsm
(nbr,NBR_EVT_PDU_SENT);nbr->stats.capability_sent++;}intrecv_capability(structnb
r*nbr,char*buf,uint16_tlen){structldp_msgmsg;intenable=0;intcaps_rcvd=0;log_debu
g("%s:lsr-id%s",__func__,inet_ntoa(nbr->id));memcpy(&msg,buf,sizeof(msg));buf+=L
DP_MSG_SIZE;len-=LDP_MSG_SIZE;/*OptionalParameters*/while(len>0){structtlvtlv;ui
nt16_ttlv_type;uint16_ttlv_len;uint8_treserved;if(len<sizeof(tlv)){session_shutd
own(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}memcpy(&tlv,buf,TLV_HDR_SIZE)
;tlv_type=ntohs(tlv.type);tlv_len=ntohs(tlv.length);if(tlv_len+TLV_HDR_SIZE>len)
{session_shutdown(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}buf+=TLV_HDR_SI
ZE;len-=TLV_HDR_SIZE;switch(tlv_type){caseTLV_TYPE_TWCARD_CAP:if(tlv_len!=CAP_TL
V_TWCARD_LEN){session_shutdown(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}if
(caps_rcvd&F_CAP_TLV_RCVD_TWCARD){session_shutdown(nbr,S_BAD_TLV_VAL,msg.id,msg.
type);return(-1);}caps_rcvd|=F_CAP_TLV_RCVD_TWCARD;memcpy(&reserved,buf,sizeof(r
eserved));enable=reserved&STATE_BIT;if(enable)nbr->flags|=F_NBR_CAP_TWCARD;elsen
br->flags&=~F_NBR_CAP_TWCARD;log_debug("%s:lsr-id%s%stheTypedWildcardFEC""capabi
lity",__func__,inet_ntoa(nbr->id),(enable)?"announced":"withdrew");break;caseTLV
_TYPE_UNOTIF_CAP:if(tlv_len!=CAP_TLV_UNOTIF_LEN){session_shutdown(nbr,S_BAD_TLV_
LEN,msg.id,msg.type);return(-1);}if(caps_rcvd&F_CAP_TLV_RCVD_UNOTIF){session_shu
tdown(nbr,S_BAD_TLV_VAL,msg.id,msg.type);return(-1);}caps_rcvd|=F_CAP_TLV_RCVD_U
NOTIF;memcpy(&reserved,buf,sizeof(reserved));enable=reserved&STATE_BIT;if(enable
)nbr->flags|=F_NBR_CAP_UNOTIF;elsenbr->flags&=~F_NBR_CAP_UNOTIF;log_debug("%s:ls
r-id%s%stheUnrecognized""Notificationcapability",__func__,inet_ntoa(nbr->id),(en
able)?"announced":"withdrew");break;caseTLV_TYPE_DYNAMIC_CAP:/**RFC5561-Section9
:*"AnLDPspeakerthatreceivesaCapabilitymessage*fromapeerthatincludestheDynamicCap
ability*AnnouncementParameterSHOULDsilentlyignorethe*parameterandprocessanyother
CapabilityParameters*inthemessage".*//*FALLTHROUGH*/default:if(!(ntohs(tlv.type)
&UNKNOWN_FLAG))send_notification_rtlvs(nbr,S_UNSSUPORTDCAP,msg.id,msg.type,tlv_t
ype,tlv_len,buf);/*ignoreunknowntlv*/break;}buf+=tlv_len;len-=tlv_len;}nbr_fsm(n
br,NBR_EVT_PDU_RCVD);return(0);}staticintgen_init_prms_tlv(structibuf*buf,struct
nbr*nbr){structsess_prms_tlvparms;memset(&parms,0,sizeof(parms));parms.type=hton
s(TLV_TYPE_COMMONSESSION);parms.length=htons(SESS_PRMS_LEN);parms.proto_version=
htons(LDP_VERSION);parms.keepalive_time=htons(nbr_get_keepalive(nbr->af,nbr->id)
);parms.reserved=0;parms.pvlim=0;parms.max_pdu_len=0;parms.lsr_id=nbr->id.s_addr
;parms.lspace_id=0;return(ibuf_add(buf,&parms,SESS_PRMS_SIZE));}staticintgen_cap
_dynamic_tlv(structibuf*buf){structcapability_tlvcap;memset(&cap,0,sizeof(cap));
cap.type=htons(TLV_TYPE_DYNAMIC_CAP);cap.length=htons(CAP_TLV_DYNAMIC_LEN);/*the
S-bitisalways1fortheDynamicCapabilityAnnouncement*/cap.reserved=STATE_BIT;return
(ibuf_add(buf,&cap,CAP_TLV_DYNAMIC_SIZE));}staticintgen_cap_twcard_tlv(structibu
f*buf,intenable){structcapability_tlvcap;memset(&cap,0,sizeof(cap));cap.type=hto
ns(TLV_TYPE_TWCARD_CAP);cap.length=htons(CAP_TLV_TWCARD_LEN);if(enable)cap.reser
ved=STATE_BIT;return(ibuf_add(buf,&cap,CAP_TLV_TWCARD_SIZE));}staticintgen_cap_u
notif_tlv(structibuf*buf,intenable){structcapability_tlvcap;memset(&cap,0,sizeof
(cap));cap.type=htons(TLV_TYPE_UNOTIF_CAP);cap.length=htons(CAP_TLV_UNOTIF_LEN);
if(enable)cap.reserved=STATE_BIT;return(ibuf_add(buf,&cap,CAP_TLV_UNOTIF_SIZE));
}