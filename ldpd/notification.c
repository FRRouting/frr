/*$OpenBSD$*//**Copyright(c)2009MicheleMarchetto<michele@openbsd.org>**Permissio
ntouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishere
bygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearinall
copies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGAR
DTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVE
NTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORA
NYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCON
TRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPER
FORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"ldpd.h"#include"ldp.h"#includ
e"log.h"#include"ldpe.h"#include"ldp_debug.h"staticintgen_returned_tlvs(structib
uf*,uint16_t,uint16_t,char*);staticvoidlog_msg_notification(int,structnbr*,struc
tnotify_msg*);voidsend_notification_full(structtcp_conn*tcp,structnotify_msg*nm)
{structibuf*buf;uint16_tsize;interr=0;/*calculatesize*/size=LDP_HDR_SIZE+LDP_MSG
_SIZE+STATUS_SIZE;if(nm->flags&F_NOTIF_PW_STATUS)size+=PW_STATUS_TLV_SIZE;if(nm-
>flags&F_NOTIF_FEC)size+=len_fec_tlv(&nm->fec);if(nm->flags&F_NOTIF_RETURNED_TLV
S)size+=TLV_HDR_SIZE*2+nm->rtlvs.length;if((buf=ibuf_open(size))==NULL)fatal(__f
unc__);err|=gen_ldp_hdr(buf,size);size-=LDP_HDR_SIZE;err|=gen_msg_hdr(buf,MSG_TY
PE_NOTIFICATION,size);err|=gen_status_tlv(buf,nm->status_code,nm->msg_id,nm->msg
_type);/*optionaltlvs*/if(nm->flags&F_NOTIF_PW_STATUS)err|=gen_pw_status_tlv(buf
,nm->pw_status);if(nm->flags&F_NOTIF_FEC)err|=gen_fec_tlv(buf,&nm->fec);if(nm->f
lags&F_NOTIF_RETURNED_TLVS)err|=gen_returned_tlvs(buf,nm->rtlvs.type,nm->rtlvs.l
ength,nm->rtlvs.data);if(err){ibuf_free(buf);return;}if(tcp->nbr){log_msg_notifi
cation(1,tcp->nbr,nm);nbr_fsm(tcp->nbr,NBR_EVT_PDU_SENT);tcp->nbr->stats.notif_s
ent++;}evbuf_enqueue(&tcp->wbuf,buf);}/*sendanotificationwithoutoptionaltlvs*/vo
idsend_notification(structtcp_conn*tcp,uint32_tstatus_code,uint32_tmsg_id,uint16
_tmsg_type){structnotify_msgnm;memset(&nm,0,sizeof(nm));nm.status_code=status_co
de;nm.msg_id=msg_id;nm.msg_type=msg_type;send_notification_full(tcp,&nm);}voidse
nd_notification_rtlvs(structnbr*nbr,uint32_tstatus_code,uint32_tmsg_id,uint16_tm
sg_type,uint16_ttlv_type,uint16_ttlv_len,char*tlv_data){structnotify_msgnm;memse
t(&nm,0,sizeof(nm));nm.status_code=status_code;nm.msg_id=msg_id;nm.msg_type=msg_
type;/*donotappendthegivenTLVifit'stoobig(shouldn'thappen)*/if(tlv_len<1024){nm.
rtlvs.type=tlv_type;nm.rtlvs.length=tlv_len;nm.rtlvs.data=tlv_data;nm.flags|=F_N
OTIF_RETURNED_TLVS;}send_notification_full(nbr->tcp,&nm);}intrecv_notification(s
tructnbr*nbr,char*buf,uint16_tlen){structldp_msgmsg;structstatus_tlvst;structnot
ify_msgnm;inttlen;memcpy(&msg,buf,sizeof(msg));buf+=LDP_MSG_SIZE;len-=LDP_MSG_SI
ZE;if(len<STATUS_SIZE){session_shutdown(nbr,S_BAD_MSG_LEN,msg.id,msg.type);retur
n(-1);}memcpy(&st,buf,sizeof(st));if(ntohs(st.length)>STATUS_SIZE-TLV_HDR_SIZE||
ntohs(st.length)>len-TLV_HDR_SIZE){session_shutdown(nbr,S_BAD_TLV_LEN,msg.id,msg
.type);return(-1);}buf+=STATUS_SIZE;len-=STATUS_SIZE;memset(&nm,0,sizeof(nm));nm
.status_code=ntohl(st.status_code);/*OptionalParameters*/while(len>0){structtlvt
lv;uint16_ttlv_type;uint16_ttlv_len;if(len<sizeof(tlv)){session_shutdown(nbr,S_B
AD_TLV_LEN,msg.id,msg.type);return(-1);}memcpy(&tlv,buf,TLV_HDR_SIZE);tlv_type=n
tohs(tlv.type);tlv_len=ntohs(tlv.length);if(tlv_len+TLV_HDR_SIZE>len){session_sh
utdown(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}buf+=TLV_HDR_SIZE;len-=TLV
_HDR_SIZE;switch(tlv_type){caseTLV_TYPE_EXTSTATUS:caseTLV_TYPE_RETURNEDPDU:caseT
LV_TYPE_RETURNEDMSG:/*TODOisthereanyuseforthis?*/break;caseTLV_TYPE_PW_STATUS:if
(tlv_len!=4){session_shutdown(nbr,S_BAD_TLV_LEN,msg.id,msg.type);return(-1);}nm.
pw_status=ntohl(*(uint32_t*)buf);nm.flags|=F_NOTIF_PW_STATUS;break;caseTLV_TYPE_
FEC:if((tlen=tlv_decode_fec_elm(nbr,&msg,buf,tlv_len,&nm.fec))==-1)return(-1);/*
allowonlyonefecelement*/if(tlen!=tlv_len){session_shutdown(nbr,S_BAD_TLV_VAL,msg
.id,msg.type);return(-1);}nm.flags|=F_NOTIF_FEC;break;default:if(!(ntohs(tlv.typ
e)&UNKNOWN_FLAG))send_notification_rtlvs(nbr,S_UNKNOWN_TLV,msg.id,msg.type,tlv_t
ype,tlv_len,buf);/*ignoreunknowntlv*/break;}buf+=tlv_len;len-=tlv_len;}/*sanityc
hecks*/switch(nm.status_code){caseS_PW_STATUS:if(!(nm.flags&(F_NOTIF_PW_STATUS|F
_NOTIF_FEC))){send_notification(nbr->tcp,S_MISS_MSG,msg.id,msg.type);return(-1);
}switch(nm.fec.type){caseMAP_TYPE_PWID:break;default:send_notification(nbr->tcp,
S_BAD_TLV_VAL,msg.id,msg.type);return(-1);}break;caseS_ENDOFLIB:if(!(nm.flags&F_
NOTIF_FEC)){send_notification(nbr->tcp,S_MISS_MSG,msg.id,msg.type);return(-1);}i
f(nm.fec.type!=MAP_TYPE_TYPED_WCARD){send_notification(nbr->tcp,S_BAD_TLV_VAL,ms
g.id,msg.type);return(-1);}break;default:break;}log_msg_notification(0,nbr,&nm);
if(st.status_code&htonl(STATUS_FATAL)){if(nbr->state==NBR_STA_OPENSENT)nbr_start
_idtimer(nbr);/**RFC5036-Section3.5.1.1:*"WhenanLSRreceivesaShutdownmessagedurin
gsession*initialization,itSHOULDtransmitaShutdownmessageand*thenclosethetranspor
tconnection".*/if(nbr->state!=NBR_STA_OPER&&nm.status_code==S_SHUTDOWN)send_noti
fication(nbr->tcp,S_SHUTDOWN,msg.id,msg.type);nbr_fsm(nbr,NBR_EVT_CLOSE_SESSION)
;return(-1);}/*ldeneedstoknowaboutafewnotificationmessages*/switch(nm.status_cod
e){caseS_PW_STATUS:caseS_ENDOFLIB:ldpe_imsg_compose_lde(IMSG_NOTIFICATION,nbr->p
eerid,0,&nm,sizeof(nm));break;default:break;}return(0);}intgen_status_tlv(struct
ibuf*buf,uint32_tstatus_code,uint32_tmsg_id,uint16_tmsg_type){structstatus_tlvst
;memset(&st,0,sizeof(st));st.type=htons(TLV_TYPE_STATUS);st.length=htons(STATUS_
TLV_LEN);st.status_code=htonl(status_code);/**Forconvenience,msg_idandmsg_typear
ealreadyinnetwork*byteorder.*/st.msg_id=msg_id;st.msg_type=msg_type;return(ibuf_
add(buf,&st,STATUS_SIZE));}staticintgen_returned_tlvs(structibuf*buf,uint16_ttyp
e,uint16_tlength,char*tlv_data){structtlvrtlvs;structtlvtlv;interr;rtlvs.type=ht
ons(TLV_TYPE_RETURNED_TLVS);rtlvs.length=htons(length+TLV_HDR_SIZE);tlv.type=hto
ns(type);tlv.length=htons(length);err=ibuf_add(buf,&rtlvs,sizeof(rtlvs));err|=ib
uf_add(buf,&tlv,sizeof(tlv));err|=ibuf_add(buf,tlv_data,length);return(err);}voi
dlog_msg_notification(intout,structnbr*nbr,structnotify_msg*nm){if(nm->status_co
de&STATUS_FATAL){debug_msg(out,"notification:lsr-id%s,status%s""(fatalerror)",in
et_ntoa(nbr->id),status_code_name(nm->status_code));return;}debug_msg(out,"notif
ication:lsr-id%s,status%s",inet_ntoa(nbr->id),status_code_name(nm->status_code))
;if(nm->flags&F_NOTIF_FEC)debug_msg(out,"notification:fec%s",log_map(&nm->fec));
if(nm->flags&F_NOTIF_PW_STATUS)debug_msg(out,"notification:pw-status%s",(nm->pw_
status)?"notforwarding":"forwarding");}