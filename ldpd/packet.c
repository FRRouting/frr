/*$OpenBSD$*//**Copyright(c)2013,2016RenatoWestphal<renato@openbsd.org>*Copyrigh
t(c)2009MicheleMarchetto<michele@openbsd.org>*Copyright(c)2004,2005,2008EsbenNor
by<norby@openbsd.org>**Permissiontouse,copy,modify,anddistributethissoftwarefora
ny*purposewithorwithoutfeeisherebygranted,providedthattheabove*copyrightnoticean
dthispermissionnoticeappearinallcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHOR
DISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*M
ERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,IN
DIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAO
RPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUT
OF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#inclu
de"ldpd.h"#include"ldpe.h"#include"log.h"#include"sockopt.h"staticstructiface*di
sc_find_iface(unsignedint,int,unionldpd_addr*);staticintsession_read(structthrea
d*);staticintsession_write(structthread*);staticssize_tsession_get_pdu(structibu
f_read*,char**);staticvoidtcp_close(structtcp_conn*);staticstructpending_conn*pe
nding_conn_new(int,int,unionldpd_addr*);staticintpending_conn_timeout(structthre
ad*);intgen_ldp_hdr(structibuf*buf,uint16_tsize){structldp_hdrldp_hdr;memset(&ld
p_hdr,0,sizeof(ldp_hdr));ldp_hdr.version=htons(LDP_VERSION);/*excludethe'Version
'and'PDULength'fieldsfromthetotal*/ldp_hdr.length=htons(size-LDP_HDR_DEAD_LEN);l
dp_hdr.lsr_id=ldp_rtr_id_get(leconf);ldp_hdr.lspace_id=0;return(ibuf_add(buf,&ld
p_hdr,LDP_HDR_SIZE));}intgen_msg_hdr(structibuf*buf,uint16_ttype,uint16_tsize){s
taticintmsgcnt=0;structldp_msgmsg;memset(&msg,0,sizeof(msg));msg.type=htons(type
);/*excludethe'Type'and'Length'fieldsfromthetotal*/msg.length=htons(size-LDP_MSG
_DEAD_LEN);msg.id=htonl(++msgcnt);return(ibuf_add(buf,&msg,sizeof(msg)));}/*send
packets*/intsend_packet(intfd,intaf,unionldpd_addr*dst,structiface_af*ia,void*pk
t,size_tlen){structsockaddr*sa;switch(af){caseAF_INET:if(ia&&IN_MULTICAST(ntohl(
dst->v4.s_addr))){/*setoutgoinginterfaceformulticasttraffic*/if(sock_set_ipv4_mc
ast(ia->iface)==-1){log_debug("%s:errorsettingmulticast""interface,%s",__func__,
ia->iface->name);return(-1);}}break;caseAF_INET6:if(ia&&IN6_IS_ADDR_MULTICAST(&d
st->v6)){/*setoutgoinginterfaceformulticasttraffic*/if(sock_set_ipv6_mcast(ia->i
face)==-1){log_debug("%s:errorsettingmulticast""interface,%s",__func__,ia->iface
->name);return(-1);}}break;default:fatalx("send_packet:unknownaf");}sa=addr2sa(a
f,dst,LDP_PORT);if(sendto(fd,pkt,len,0,sa,sockaddr_len(sa))==-1){log_warn("%s:er
rorsendingpacketto%s",__func__,log_sockaddr(sa));return(-1);}return(0);}/*Discov
eryfunctions*/intdisc_recv_packet(structthread*thread){intfd=THREAD_FD(thread);s
tructthread**threadp=THREAD_ARG(thread);union{structcmsghdrhdr;#ifdefHAVE_STRUCT
_SOCKADDR_DLcharbuf[CMSG_SPACE(sizeof(structsockaddr_dl))];#elsecharbuf[CMSG_SPA
CE(sizeof(structin6_pktinfo))];#endif}cmsgbuf;structmsghdrm;structsockaddr_stora
gefrom;structioveciov;char*buf;#ifndefMSG_MCASTstructcmsghdr*cmsg;#endifssize_tr
;intmulticast;intaf;unionldpd_addrsrc;unsignedintifindex=0;structiface*iface=NUL
L;uint16_tlen;structldp_hdrldp_hdr;uint16_tpdu_len;structldp_msgmsg;uint16_tmsg_
len;structin_addrlsr_id;/*rescheduleread*/*threadp=NULL;thread_add_read(master,d
isc_recv_packet,threadp,fd,&*threadp);/*setupbuffer*/memset(&m,0,sizeof(m));iov.
iov_base=buf=pkt_ptr;iov.iov_len=IBUF_READ_SIZE;m.msg_name=&from;m.msg_namelen=s
izeof(from);m.msg_iov=&iov;m.msg_iovlen=1;m.msg_control=&cmsgbuf.buf;m.msg_contr
ollen=sizeof(cmsgbuf.buf);if((r=recvmsg(fd,&m,0))==-1){if(errno!=EAGAIN&&errno!=
EINTR)log_debug("%s:readerror:%s",__func__,strerror(errno));return(0);}sa2addr((
structsockaddr*)&from,&af,&src,NULL);#ifdefMSG_MCASTmulticast=(m.msg_flags&MSG_M
CAST)?1:0;#elsemulticast=0;for(cmsg=CMSG_FIRSTHDR(&m);cmsg!=NULL;cmsg=CMSG_NXTHD
R(&m,cmsg)){#ifdefined(HAVE_IP_PKTINFO)if(af==AF_INET&&cmsg->cmsg_level==IPPROTO
_IP&&cmsg->cmsg_type==IP_PKTINFO){structin_pktinfo*pktinfo;pktinfo=(structin_pkt
info*)CMSG_DATA(cmsg);if(IN_MULTICAST(ntohl(pktinfo->ipi_addr.s_addr)))multicast
=1;break;}#elifdefined(HAVE_IP_RECVDSTADDR)if(af==AF_INET&&cmsg->cmsg_level==IPP
ROTO_IP&&cmsg->cmsg_type==IP_RECVDSTADDR){structin_addr*addr;addr=(structin_addr
*)CMSG_DATA(cmsg);if(IN_MULTICAST(ntohl(addr->s_addr)))multicast=1;break;}#else#
error"UnsupportedsocketAPI"#endifif(af==AF_INET6&&cmsg->cmsg_level==IPPROTO_IPV6
&&cmsg->cmsg_type==IPV6_PKTINFO){structin6_pktinfo*pktinfo;pktinfo=(structin6_pk
tinfo*)CMSG_DATA(cmsg);if(IN6_IS_ADDR_MULTICAST(&pktinfo->ipi6_addr))multicast=1
;break;}}#endif/*MSG_MCAST*/if(bad_addr(af,&src)){log_debug("%s:invalidsourceadd
ress:%s",__func__,log_addr(af,&src));return(0);}ifindex=getsockopt_ifindex(af,&m
);/*findamatchinginterface*/if(multicast){iface=disc_find_iface(ifindex,af,&src)
;if(iface==NULL)return(0);}/*checkpacketsize*/len=(uint16_t)r;if(len<(LDP_HDR_SI
ZE+LDP_MSG_SIZE)||len>LDP_MAX_LEN){log_debug("%s:badpacketsize,source%s",__func_
_,log_addr(af,&src));return(0);}/*LDPheadersanitychecks*/memcpy(&ldp_hdr,buf,siz
eof(ldp_hdr));if(ntohs(ldp_hdr.version)!=LDP_VERSION){log_debug("%s:invalidLDPve
rsion%d,source%s",__func__,ntohs(ldp_hdr.version),log_addr(af,&src));return(0);}
if(ntohs(ldp_hdr.lspace_id)!=0){log_debug("%s:invalidlabelspace%u,source%s",__fu
nc__,ntohs(ldp_hdr.lspace_id),log_addr(af,&src));return(0);}/*check"PDULength"fi
eld*/pdu_len=ntohs(ldp_hdr.length);if((pdu_len<(LDP_HDR_PDU_LEN+LDP_MSG_SIZE))||
(pdu_len>(len-LDP_HDR_DEAD_LEN))){log_debug("%s:invalidLDPpacketlength%u,source%
s",__func__,ntohs(ldp_hdr.length),log_addr(af,&src));return(0);}buf+=LDP_HDR_SIZ
E;len-=LDP_HDR_SIZE;lsr_id.s_addr=ldp_hdr.lsr_id;/**ForUDP,weprocessonlythefirst
messageofeachpacket.Thisdoes*notimposeanyrestrictionssinceLDPusesUDPonlyforsendi
ngHello*packets.*/memcpy(&msg,buf,sizeof(msg));/*check"MessageLength"field*/msg_
len=ntohs(msg.length);if(msg_len<LDP_MSG_LEN||((msg_len+LDP_MSG_DEAD_LEN)>pdu_le
n)){log_debug("%s:invalidLDPmessagelength%u,source%s",__func__,ntohs(msg.length)
,log_addr(af,&src));return(0);}buf+=LDP_MSG_SIZE;len-=LDP_MSG_SIZE;/*switchLDPpa
ckettype*/switch(ntohs(msg.type)){caseMSG_TYPE_HELLO:recv_hello(lsr_id,&msg,af,&
src,iface,multicast,buf,len);break;default:log_debug("%s:unknownLDPpackettype,so
urce%s",__func__,log_addr(af,&src));}return(0);}staticstructiface*disc_find_ifac
e(unsignedintifindex,intaf,unionldpd_addr*src){structiface*iface;structiface_af*
ia;iface=if_lookup(leconf,ifindex);if(iface==NULL)return(NULL);ia=iface_af_get(i
face,af);if(!ia->enabled)return(NULL);/**RFC7552-Section5.1:*"Link-localIPv6addr
essMUSTbeusedasthesourceIPaddressin*IPv6LDPLinkHellos".*/if(af==AF_INET6&&!IN6_I
S_ADDR_LINKLOCAL(&src->v6))return(NULL);return(iface);}intsession_accept(structt
hread*thread){intfd=THREAD_FD(thread);structsockaddr_storagesrc;socklen_tlen=siz
eof(src);intnewfd;intaf;unionldpd_addraddr;structnbr*nbr;structpending_conn*pcon
n;newfd=accept(fd,(structsockaddr*)&src,&len);if(newfd==-1){/**Pauseacceptifwear
eoutoffiledescriptors,or*libeventwillhauntusheretoo.*/if(errno==ENFILE||errno==E
MFILE){accept_pause();}elseif(errno!=EWOULDBLOCK&&errno!=EINTR&&errno!=ECONNABOR
TED)log_debug("%s:accepterror:%s",__func__,strerror(errno));return(0);}sock_set_
nonblock(newfd);sa2addr((structsockaddr*)&src,&af,&addr,NULL);/**Sincewedon'tsup
portlabelspaces,wecanidentifythisneighbor*justbyitssourceaddress.Thiswaywedon'tn
eedtowaitforits*Initializationmessagetoknowwhowearetalkingto.*/nbr=nbr_find_addr
(af,&addr);if(nbr==NULL){/**AccordingtoRFC5036,wewouldneedtosendaNoHello*ErrorNo
tificationmessageandclosethisTCPconnection*rightnow.Butdoingsowouldtriggerthebac
koffexponential*timerintheremotepeer,whichwouldconsiderablyslowdown*thesessiones
tablishmentprocess.Thetrickhereistowait*fivesecondsbeforesendingtheNotificationM
essage.There's*agoodchancethattheremotepeerwillsendusaHello*messagewithinthisint
erval,soit'sworthwaitingbefore*takingamoredrasticmeasure.*/pconn=pending_conn_fi
nd(af,&addr);if(pconn)close(newfd);elsepending_conn_new(newfd,af,&addr);return(0
);}/*protectionagainstbuggyimplementations*/if(nbr_session_active_role(nbr)){clo
se(newfd);return(0);}if(nbr->state!=NBR_STA_PRESENT){log_debug("%s:lsr-id%s:reje
ctingadditionaltransport""connection",__func__,inet_ntoa(nbr->id));close(newfd);
return(0);}session_accept_nbr(nbr,newfd);return(0);}voidsession_accept_nbr(struc
tnbr*nbr,intfd){#ifdef__OpenBSD__structnbr_params*nbrp;intopt;socklen_tlen;nbrp=
nbr_params_find(leconf,nbr->id);if(nbr_gtsm_check(fd,nbr,nbrp)){close(fd);return
;}if(nbrp&&nbrp->auth.method==AUTH_MD5SIG){if(sysdep.no_pfkey||sysdep.no_md5sig)
{log_warnx("md5sigconfiguredbutnotavailable");close(fd);return;}len=sizeof(opt);
if(getsockopt(fd,IPPROTO_TCP,TCP_MD5SIG,&opt,&len)==-1)fatal("getsockoptTCP_MD5S
IG");if(!opt){/*non-md5'dconnection!*/log_warnx("connectionattemptwithoutmd5sign
ature");close(fd);return;}}#endifnbr->tcp=tcp_new(fd,nbr);nbr_fsm(nbr,NBR_EVT_MA
TCH_ADJ);}staticintsession_read(structthread*thread){intfd=THREAD_FD(thread);str
uctnbr*nbr=THREAD_ARG(thread);structtcp_conn*tcp=nbr->tcp;structldp_hdr*ldp_hdr;
structldp_msg*msg;char*buf=NULL,*pdu;ssize_tn,len;uint16_tpdu_len,msg_len,msg_si
ze,max_pdu_len;intret;tcp->rev=NULL;thread_add_read(master,session_read,nbr,fd,&
tcp->rev);if((n=read(fd,tcp->rbuf->buf+tcp->rbuf->wpos,sizeof(tcp->rbuf->buf)-tc
p->rbuf->wpos))==-1){if(errno!=EINTR&&errno!=EAGAIN){log_warn("%s:readerror",__f
unc__);nbr_fsm(nbr,NBR_EVT_CLOSE_SESSION);return(0);}/*retryread*/return(0);}if(
n==0){/*connectionclosed*/log_debug("%s:connectionclosedbyremoteend",__func__);n
br_fsm(nbr,NBR_EVT_CLOSE_SESSION);return(0);}tcp->rbuf->wpos+=n;while((len=sessi
on_get_pdu(tcp->rbuf,&buf))>0){pdu=buf;ldp_hdr=(structldp_hdr*)pdu;if(ntohs(ldp_
hdr->version)!=LDP_VERSION){session_shutdown(nbr,S_BAD_PROTO_VER,0,0);free(buf);
return(0);}pdu_len=ntohs(ldp_hdr->length);/**RFC5036-Section3.5.3:*"Priortocompl
etionofthenegotiation,themaximum*allowablelengthis4096bytes".*/if(nbr->state==NB
R_STA_OPER)max_pdu_len=nbr->max_pdu_len;elsemax_pdu_len=LDP_MAX_LEN;if(pdu_len<(
LDP_HDR_PDU_LEN+LDP_MSG_SIZE)||pdu_len>max_pdu_len){session_shutdown(nbr,S_BAD_P
DU_LEN,0,0);free(buf);return(0);}pdu_len-=LDP_HDR_PDU_LEN;if(ldp_hdr->lsr_id!=nb
r->id.s_addr||ldp_hdr->lspace_id!=0){session_shutdown(nbr,S_BAD_LDP_ID,0,0);free
(buf);return(0);}pdu+=LDP_HDR_SIZE;len-=LDP_HDR_SIZE;nbr_fsm(nbr,NBR_EVT_PDU_RCV
D);while(len>=LDP_MSG_SIZE){uint16_ttype;msg=(structldp_msg*)pdu;type=ntohs(msg-
>type);msg_len=ntohs(msg->length);if(msg_len<LDP_MSG_LEN||(msg_len+LDP_MSG_DEAD_
LEN)>pdu_len){session_shutdown(nbr,S_BAD_MSG_LEN,msg->id,msg->type);free(buf);re
turn(0);}msg_size=msg_len+LDP_MSG_DEAD_LEN;pdu_len-=msg_size;/*checkforerrorcond
itionsearlier*/switch(type){caseMSG_TYPE_INIT:if((nbr->state!=NBR_STA_INITIAL)&&
(nbr->state!=NBR_STA_OPENSENT)){session_shutdown(nbr,S_SHUTDOWN,msg->id,msg->typ
e);free(buf);return(0);}break;caseMSG_TYPE_KEEPALIVE:if((nbr->state==NBR_STA_INI
TIAL)||(nbr->state==NBR_STA_OPENSENT)){session_shutdown(nbr,S_SHUTDOWN,msg->id,m
sg->type);free(buf);return(0);}break;caseMSG_TYPE_NOTIFICATION:break;default:if(
nbr->state!=NBR_STA_OPER){session_shutdown(nbr,S_SHUTDOWN,msg->id,msg->type);fre
e(buf);return(0);}break;}/*switchLDPpackettype*/switch(type){caseMSG_TYPE_NOTIFI
CATION:ret=recv_notification(nbr,pdu,msg_size);break;caseMSG_TYPE_INIT:ret=recv_
init(nbr,pdu,msg_size);break;caseMSG_TYPE_KEEPALIVE:ret=recv_keepalive(nbr,pdu,m
sg_size);break;caseMSG_TYPE_CAPABILITY:ret=recv_capability(nbr,pdu,msg_size);bre
ak;caseMSG_TYPE_ADDR:caseMSG_TYPE_ADDRWITHDRAW:ret=recv_address(nbr,pdu,msg_size
);break;caseMSG_TYPE_LABELMAPPING:caseMSG_TYPE_LABELREQUEST:caseMSG_TYPE_LABELWI
THDRAW:caseMSG_TYPE_LABELRELEASE:caseMSG_TYPE_LABELABORTREQ:ret=recv_labelmessag
e(nbr,pdu,msg_size,type);break;default:log_debug("%s:unknownLDPmessagefromnbr%s"
,__func__,inet_ntoa(nbr->id));if(!(ntohs(msg->type)&UNKNOWN_FLAG))send_notificat
ion(nbr->tcp,S_UNKNOWN_MSG,msg->id,msg->type);/*ignorethemessage*/ret=0;break;}i
f(ret==-1){/*parserfailed,givingup*/free(buf);return(0);}/*noerrors-updatepernei
ghbormessagecounters*/switch(type){caseMSG_TYPE_NOTIFICATION:nbr->stats.notif_rc
vd++;break;caseMSG_TYPE_KEEPALIVE:nbr->stats.kalive_rcvd++;break;caseMSG_TYPE_CA
PABILITY:nbr->stats.capability_rcvd++;break;caseMSG_TYPE_ADDR:nbr->stats.addr_rc
vd++;break;caseMSG_TYPE_ADDRWITHDRAW:nbr->stats.addrwdraw_rcvd++;break;caseMSG_T
YPE_LABELMAPPING:nbr->stats.labelmap_rcvd++;break;caseMSG_TYPE_LABELREQUEST:nbr-
>stats.labelreq_rcvd++;break;caseMSG_TYPE_LABELWITHDRAW:nbr->stats.labelwdraw_rc
vd++;break;caseMSG_TYPE_LABELRELEASE:nbr->stats.labelrel_rcvd++;break;caseMSG_TY
PE_LABELABORTREQ:nbr->stats.labelabreq_rcvd++;break;default:break;}/*Analysethen
extmessage*/pdu+=msg_size;len-=msg_size;}free(buf);if(len!=0){session_shutdown(n
br,S_BAD_PDU_LEN,0,0);return(0);}}return(0);}staticintsession_write(structthread
*thread){structtcp_conn*tcp=THREAD_ARG(thread);structnbr*nbr=tcp->nbr;tcp->wbuf.
ev=NULL;if(msgbuf_write(&tcp->wbuf.wbuf)<=0)if(errno!=EAGAIN&&nbr)nbr_fsm(nbr,NB
R_EVT_CLOSE_SESSION);if(nbr==NULL&&!tcp->wbuf.wbuf.queued){/**Wearedonesendingth
enotificationmessage,nowwecan*closethesocket.*/tcp_close(tcp);return(0);}evbuf_e
vent_add(&tcp->wbuf);return(0);}voidsession_shutdown(structnbr*nbr,uint32_tstatu
s,uint32_tmsg_id,uint32_tmsg_type){switch(nbr->state){caseNBR_STA_PRESENT:if(nbr
_pending_connect(nbr))THREAD_WRITE_OFF(nbr->ev_connect);break;caseNBR_STA_INITIA
L:caseNBR_STA_OPENREC:caseNBR_STA_OPENSENT:caseNBR_STA_OPER:send_notification(nb
r->tcp,status,msg_id,msg_type);nbr_fsm(nbr,NBR_EVT_CLOSE_SESSION);break;default:
fatalx("session_shutdown:unknownneighborstate");}}voidsession_close(structnbr*nb
r){log_debug("%s:closingsessionwithlsr-id%s",__func__,inet_ntoa(nbr->id));tcp_cl
ose(nbr->tcp);nbr_stop_ktimer(nbr);nbr_stop_ktimeout(nbr);nbr_stop_itimeout(nbr)
;}staticssize_tsession_get_pdu(structibuf_read*r,char**b){structldp_hdrl;size_ta
v,dlen,left;av=r->wpos;if(av<sizeof(l))return(0);memcpy(&l,r->buf,sizeof(l));dle
n=ntohs(l.length)+LDP_HDR_DEAD_LEN;if(dlen>av)return(0);if((*b=malloc(dlen))==NU
LL)return(-1);memcpy(*b,r->buf,dlen);if(dlen<av){left=av-dlen;memmove(r->buf,r->
buf+dlen,left);r->wpos=left;}elser->wpos=0;return(dlen);}structtcp_conn*tcp_new(
intfd,structnbr*nbr){structtcp_conn*tcp;structsockaddr_storagess;socklen_tlen=si
zeof(ss);if((tcp=calloc(1,sizeof(*tcp)))==NULL)fatal(__func__);tcp->fd=fd;evbuf_
init(&tcp->wbuf,tcp->fd,session_write,tcp);if(nbr){if((tcp->rbuf=calloc(1,sizeof
(structibuf_read)))==NULL)fatal(__func__);tcp->rev=NULL;thread_add_read(master,s
ession_read,nbr,tcp->fd,&tcp->rev);tcp->nbr=nbr;}if(getsockname(fd,(structsockad
dr*)&ss,&len)!=0)log_warn("%s:getsockname",__func__);elsesa2addr((structsockaddr
*)&ss,NULL,NULL,&tcp->lport);if(getpeername(fd,(structsockaddr*)&ss,&len)!=0)log
_warn("%s:getpeername",__func__);elsesa2addr((structsockaddr*)&ss,NULL,NULL,&tcp
->rport);return(tcp);}staticvoidtcp_close(structtcp_conn*tcp){/*trytoflushwriteb
uffer*/msgbuf_write(&tcp->wbuf.wbuf);evbuf_clear(&tcp->wbuf);if(tcp->nbr){THREAD
_READ_OFF(tcp->rev);free(tcp->rbuf);tcp->nbr->tcp=NULL;}close(tcp->fd);accept_un
pause();free(tcp);}staticstructpending_conn*pending_conn_new(intfd,intaf,unionld
pd_addr*addr){structpending_conn*pconn;if((pconn=calloc(1,sizeof(*pconn)))==NULL
)fatal(__func__);pconn->fd=fd;pconn->af=af;pconn->addr=*addr;TAILQ_INSERT_TAIL(&
global.pending_conns,pconn,entry);pconn->ev_timeout=NULL;thread_add_timer(master
,pending_conn_timeout,pconn,PENDING_CONN_TIMEOUT,&pconn->ev_timeout);return(pcon
n);}voidpending_conn_del(structpending_conn*pconn){THREAD_TIMER_OFF(pconn->ev_ti
meout);TAILQ_REMOVE(&global.pending_conns,pconn,entry);free(pconn);}structpendin
g_conn*pending_conn_find(intaf,unionldpd_addr*addr){structpending_conn*pconn;TAI
LQ_FOREACH(pconn,&global.pending_conns,entry)if(af==pconn->af&&ldp_addrcmp(af,ad
dr,&pconn->addr)==0)return(pconn);return(NULL);}staticintpending_conn_timeout(st
ructthread*thread){structpending_conn*pconn=THREAD_ARG(thread);structtcp_conn*tc
p;pconn->ev_timeout=NULL;log_debug("%s:noadjacencywithremoteend:%s",__func__,log
_addr(pconn->af,&pconn->addr));/**Createawritebufferdetachedfromanyneighbortosen
da*notificationmessagereliably.*/tcp=tcp_new(pconn->fd,NULL);send_notification(t
cp,S_NO_HELLO,0,0);msgbuf_write(&tcp->wbuf.wbuf);pending_conn_del(pconn);return(
0);}