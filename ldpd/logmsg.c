/*$OpenBSD$*//**Copyright(c)2003,2004HenningBrauer<henning@openbsd.org>**Permiss
iontouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishe
rebygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearina
llcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREG
ARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOE
VENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESO
RANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFC
ONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORP
ERFORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"mpls.h"#include"ldpd.h"#inc
lude"ldpe.h"#include"lde.h"#defineNUM_LOGS4constchar*log_sockaddr(void*vp){stati
ccharbuf[NUM_LOGS][NI_MAXHOST];staticintround=0;structsockaddr*sa=vp;round=(roun
d+1)%NUM_LOGS;if(getnameinfo(sa,sockaddr_len(sa),buf[round],NI_MAXHOST,NULL,0,NI
_NUMERICHOST))return("(unknown)");elsereturn(buf[round]);}constchar*log_in6addr(
conststructin6_addr*addr){structsockaddr_in6sa_in6;memset(&sa_in6,0,sizeof(sa_in
6));#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENsa_in6.sin6_len=sizeof(sa_in6);#endifsa
_in6.sin6_family=AF_INET6;sa_in6.sin6_addr=*addr;recoverscope(&sa_in6);return(lo
g_sockaddr(&sa_in6));}constchar*log_in6addr_scope(conststructin6_addr*addr,unsig
nedintifindex){structsockaddr_in6sa_in6;memset(&sa_in6,0,sizeof(sa_in6));#ifdefH
AVE_STRUCT_SOCKADDR_IN_SIN_LENsa_in6.sin6_len=sizeof(sa_in6);#endifsa_in6.sin6_f
amily=AF_INET6;sa_in6.sin6_addr=*addr;addscope(&sa_in6,ifindex);return(log_socka
ddr(&sa_in6));}constchar*log_addr(intaf,constunionldpd_addr*addr){staticcharbuf[
NUM_LOGS][INET6_ADDRSTRLEN];staticintround=0;switch(af){caseAF_INET:round=(round
+1)%NUM_LOGS;if(inet_ntop(AF_INET,&addr->v4,buf[round],sizeof(buf[round]))==NULL
)return("???");return(buf[round]);caseAF_INET6:return(log_in6addr(&addr->v6));de
fault:break;}return("???");}#defineTF_BUFS4#defineTF_LEN32char*log_label(uint32_
tlabel){char*buf;staticchartfbuf[TF_BUFS][TF_LEN];/*ringbuffer*/staticintidx=0;b
uf=tfbuf[idx++];if(idx==TF_BUFS)idx=0;switch(label){caseNO_LABEL:snprintf(buf,TF
_LEN,"-");break;caseMPLS_LABEL_IMPLICIT_NULL:snprintf(buf,TF_LEN,"imp-null");bre
ak;caseMPLS_LABEL_IPV4_EXPLICIT_NULL:caseMPLS_LABEL_IPV6_EXPLICIT_NULL:snprintf(
buf,TF_LEN,"exp-null");break;default:snprintf(buf,TF_LEN,"%u",label);break;}retu
rn(buf);}constchar*log_time(time_tt){char*buf;staticchartfbuf[TF_BUFS][TF_LEN];/
*ringbuffer*/staticintidx=0;unsignedintsec,min,hrs,day,week;buf=tfbuf[idx++];if(
idx==TF_BUFS)idx=0;week=t;sec=week%60;week/=60;min=week%60;week/=60;hrs=week%24;
week/=24;day=week%7;week/=7;if(week>0)snprintf(buf,TF_LEN,"%02uw%01ud%02uh",week
,day,hrs);elseif(day>0)snprintf(buf,TF_LEN,"%01ud%02uh%02um",day,hrs,min);elsesn
printf(buf,TF_LEN,"%02u:%02u:%02u",hrs,min,sec);return(buf);}char*log_hello_src(
conststructhello_source*src){staticcharbuf[64];switch(src->type){caseHELLO_LINK:
snprintf(buf,sizeof(buf),"iface%s",src->link.ia->iface->name);break;caseHELLO_TA
RGETED:snprintf(buf,sizeof(buf),"source%s",log_addr(src->target->af,&src->target
->addr));break;}return(buf);}constchar*log_map(conststructmap*map){staticcharbuf
[128];switch(map->type){caseMAP_TYPE_WILDCARD:if(snprintf(buf,sizeof(buf),"wildc
ard")<0)return("???");break;caseMAP_TYPE_PREFIX:if(snprintf(buf,sizeof(buf),"%s/
%u",log_addr(map->fec.prefix.af,&map->fec.prefix.prefix),map->fec.prefix.prefixl
en)==-1)return("???");break;caseMAP_TYPE_PWID:if(snprintf(buf,sizeof(buf),"pw-id
%ugroup-id%u(%s)",map->fec.pwid.pwid,map->fec.pwid.group_id,pw_type_name(map->fe
c.pwid.type))==-1)return("???");break;caseMAP_TYPE_TYPED_WCARD:if(snprintf(buf,s
izeof(buf),"typedwildcard")<0)return("???");switch(map->fec.twcard.type){caseMAP
_TYPE_PREFIX:if(snprintf(buf+strlen(buf),sizeof(buf)-strlen(buf),"(prefix,addres
s-family%s)",af_name(map->fec.twcard.u.prefix_af))<0)return("???");break;caseMAP
_TYPE_PWID:if(snprintf(buf+strlen(buf),sizeof(buf)-strlen(buf),"(pwid,type%s)",p
w_type_name(map->fec.twcard.u.pw_type))<0)return("???");break;default:if(snprint
f(buf+strlen(buf),sizeof(buf)-strlen(buf),"(unknowntype)")<0)return("???");break
;}break;default:return("???");}return(buf);}constchar*log_fec(conststructfec*fec
){staticcharbuf[64];unionldpd_addraddr;switch(fec->type){caseFEC_TYPE_IPV4:addr.
v4=fec->u.ipv4.prefix;if(snprintf(buf,sizeof(buf),"ipv4%s/%u",log_addr(AF_INET,&
addr),fec->u.ipv4.prefixlen)==-1)return("???");break;caseFEC_TYPE_IPV6:addr.v6=f
ec->u.ipv6.prefix;if(snprintf(buf,sizeof(buf),"ipv6%s/%u",log_addr(AF_INET6,&add
r),fec->u.ipv6.prefixlen)==-1)return("???");break;caseFEC_TYPE_PWID:if(snprintf(
buf,sizeof(buf),"pwid%u(%s)-%s",fec->u.pwid.pwid,pw_type_name(fec->u.pwid.type),
inet_ntoa(fec->u.pwid.lsr_id))==-1)return("???");break;default:return("???");}re
turn(buf);}/*names*/constchar*af_name(intaf){switch(af){caseAF_INET:return("ipv4
");caseAF_INET6:return("ipv6");#ifdefAF_MPLScaseAF_MPLS:return("mpls");#endifdef
ault:return("UNKNOWN");}}constchar*socket_name(inttype){switch(type){caseLDP_SOC
KET_DISC:return("discovery");caseLDP_SOCKET_EDISC:return("extendeddiscovery");ca
seLDP_SOCKET_SESSION:return("session");default:return("UNKNOWN");}}constchar*nbr
_state_name(intstate){switch(state){caseNBR_STA_PRESENT:return("PRESENT");caseNB
R_STA_INITIAL:return("INITIALIZED");caseNBR_STA_OPENREC:return("OPENREC");caseNB
R_STA_OPENSENT:return("OPENSENT");caseNBR_STA_OPER:return("OPERATIONAL");default
:return("UNKNOWN");}}constchar*if_state_name(intstate){switch(state){caseIF_STA_
DOWN:return("DOWN");caseIF_STA_ACTIVE:return("ACTIVE");default:return("UNKNOWN")
;}}constchar*if_type_name(enumiface_typetype){switch(type){caseIF_TYPE_POINTOPOI
NT:return("POINTOPOINT");caseIF_TYPE_BROADCAST:return("BROADCAST");}/*NOTREACHED
*/return("UNKNOWN");}constchar*msg_name(uint16_tmsg){staticcharbuf[16];switch(ms
g){caseMSG_TYPE_NOTIFICATION:return("notification");caseMSG_TYPE_HELLO:return("h
ello");caseMSG_TYPE_INIT:return("initialization");caseMSG_TYPE_KEEPALIVE:return(
"keepalive");caseMSG_TYPE_CAPABILITY:return("capability");caseMSG_TYPE_ADDR:retu
rn("address");caseMSG_TYPE_ADDRWITHDRAW:return("addresswithdraw");caseMSG_TYPE_L
ABELMAPPING:return("labelmapping");caseMSG_TYPE_LABELREQUEST:return("labelreques
t");caseMSG_TYPE_LABELWITHDRAW:return("labelwithdraw");caseMSG_TYPE_LABELRELEASE
:return("labelrelease");caseMSG_TYPE_LABELABORTREQ:default:snprintf(buf,sizeof(b
uf),"[%08x]",msg);return(buf);}}constchar*status_code_name(uint32_tstatus){stati
ccharbuf[16];switch(status){caseS_SUCCESS:return("Success");caseS_BAD_LDP_ID:ret
urn("BadLDPIdentifier");caseS_BAD_PROTO_VER:return("BadProtocolVersion");caseS_B
AD_PDU_LEN:return("BadPDULength");caseS_UNKNOWN_MSG:return("UnknownMessageType")
;caseS_BAD_MSG_LEN:return("BadMessageLength");caseS_UNKNOWN_TLV:return("UnknownT
LV");caseS_BAD_TLV_LEN:return("BadTLVLength");caseS_BAD_TLV_VAL:return("Malforme
dTLVValue");caseS_HOLDTIME_EXP:return("HoldTimerExpired");caseS_SHUTDOWN:return(
"Shutdown");caseS_LOOP_DETECTED:return("LoopDetected");caseS_UNKNOWN_FEC:return(
"UnknownFEC");caseS_NO_ROUTE:return("NoRoute");caseS_NO_LABEL_RES:return("NoLabe
lResources");caseS_AVAILABLE:return("LabelResourcesAvailable");caseS_NO_HELLO:re
turn("SessionRejected,NoHello");caseS_PARM_ADV_MODE:return("RejectedAdvertisemen
tModeParameter");caseS_MAX_PDU_LEN:return("RejectedMaxPDULengthParameter");caseS
_PARM_L_RANGE:return("RejectedLabelRangeParameter");caseS_KEEPALIVE_TMR:return("
KeepAliveTimerExpired");caseS_LAB_REQ_ABRT:return("LabelRequestAborted");caseS_M
ISS_MSG:return("MissingMessageParameters");caseS_UNSUP_ADDR:return("UnsupportedA
ddressFamily");caseS_KEEPALIVE_BAD:return("BadKeepAliveTime");caseS_INTERN_ERR:r
eturn("InternalError");caseS_ILLEGAL_CBIT:return("IllegalC-Bit");caseS_WRONG_CBI
T:return("WrongC-Bit");caseS_INCPT_BITRATE:return("Incompatiblebit-rate");caseS_
CEP_MISCONF:return("CEP-TDMmis-configuration");caseS_PW_STATUS:return("PWStatus"
);caseS_UNASSIGN_TAI:return("Unassigned/UnrecognizedTAI");caseS_MISCONF_ERR:retu
rn("GenericMisconfigurationError");caseS_WITHDRAW_MTHD:return("LabelWithdrawPWSt
atusMethod");caseS_UNSSUPORTDCAP:return("UnsupportedCapability");caseS_ENDOFLIB:
return("End-of-LIB");caseS_TRANS_MISMTCH:return("TransportConnectionMismatch");c
aseS_DS_NONCMPLNCE:return("Dual-StackNoncompliance");default:snprintf(buf,sizeof
(buf),"[%08x]",status);return(buf);}}constchar*pw_type_name(uint16_tpw_type){sta
ticcharbuf[64];switch(pw_type){casePW_TYPE_ETHERNET_TAGGED:return("EthTagged");c
asePW_TYPE_ETHERNET:return("Ethernet");casePW_TYPE_WILDCARD:return("Wildcard");d
efault:snprintf(buf,sizeof(buf),"[%0x]",pw_type);return(buf);}}