/**Copyright(C)2016byOpenSourceRouting.**Thisprogramisfreesoftware;youcanredistr
ibuteitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseaspublishedby*the
FreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption)anylaterversi
on.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;
withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.Se
etheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUG
eneralPublicLicense*alongwiththisprogram;seethefileCOPYING;ifnot,writetothe*Free
SoftwareFoundation,Inc.,51FranklinSt,FifthFloor,Boston,*MA02110-1301USA*/#includ
e<zebra.h>#include"prefix.h"#include"stream.h"#include"memory.h"#include"zclient
.h"#include"command.h"#include"network.h"#include"linklist.h"#include"mpls.h"#in
clude"ldpd.h"#include"ldpe.h"#include"lde.h"#include"log.h"#include"ldp_debug.h"
staticvoidifp2kif(structinterface*,structkif*);staticvoidifc2kaddr(structinterfa
ce*,structconnected*,structkaddr*);staticintzebra_send_mpls_labels(int,structkro
ute*);staticintldp_router_id_update(int,structzclient*,zebra_size_t,vrf_id_t);st
aticintldp_interface_add(int,structzclient*,zebra_size_t,vrf_id_t);staticintldp_
interface_delete(int,structzclient*,zebra_size_t,vrf_id_t);staticintldp_interfac
e_status_change(intcommand,structzclient*,zebra_size_t,vrf_id_t);staticintldp_in
terface_address_add(int,structzclient*,zebra_size_t,vrf_id_t);staticintldp_inter
face_address_delete(int,structzclient*,zebra_size_t,vrf_id_t);staticintldp_zebra
_read_route(int,structzclient*,zebra_size_t,vrf_id_t);staticintldp_zebra_read_pw
_status_update(int,structzclient*,zebra_size_t,vrf_id_t);staticvoidldp_zebra_con
nected(structzclient*);staticstructzclient*zclient;staticvoidifp2kif(structinter
face*ifp,structkif*kif){memset(kif,0,sizeof(*kif));strlcpy(kif->ifname,ifp->name
,sizeof(kif->ifname));kif->ifindex=ifp->ifindex;kif->operative=if_is_operative(i
fp);if(ifp->ll_type==ZEBRA_LLT_ETHER)memcpy(kif->mac,ifp->hw_addr,ETH_ALEN);}sta
ticvoidifc2kaddr(structinterface*ifp,structconnected*ifc,structkaddr*ka){memset(
ka,0,sizeof(*ka));strlcpy(ka->ifname,ifp->name,sizeof(ka->ifname));ka->ifindex=i
fp->ifindex;ka->af=ifc->address->family;ka->prefixlen=ifc->address->prefixlen;sw
itch(ka->af){caseAF_INET:ka->addr.v4=ifc->address->u.prefix4;if(ifc->destination
)ka->dstbrd.v4=ifc->destination->u.prefix4;break;caseAF_INET6:ka->addr.v6=ifc->a
ddress->u.prefix6;if(ifc->destination)ka->dstbrd.v6=ifc->destination->u.prefix6;
break;default:break;}}voidpw2zpw(structl2vpn_pw*pw,structzapi_pw*zpw){memset(zpw
,0,sizeof(*zpw));strlcpy(zpw->ifname,pw->ifname,sizeof(zpw->ifname));zpw->ifinde
x=pw->ifindex;zpw->type=pw->l2vpn->pw_type;zpw->af=pw->af;zpw->nexthop.ipv6=pw->
addr.v6;zpw->local_label=NO_LABEL;zpw->remote_label=NO_LABEL;if(pw->flags&F_PW_C
WORD)zpw->flags=F_PSEUDOWIRE_CWORD;zpw->data.ldp.lsr_id=pw->lsr_id;zpw->data.ldp
.pwid=pw->pwid;strlcpy(zpw->data.ldp.vpn_name,pw->l2vpn->name,sizeof(zpw->data.l
dp.vpn_name));}staticintzebra_send_mpls_labels(intcmd,structkroute*kr){structstr
eam*s;if(kr->local_label<MPLS_LABEL_RESERVED_MAX||kr->remote_label==NO_LABEL)ret
urn(0);debug_zebra_out("prefix%s/%unexthop%sifindex%ulabels%s/%s(%s)",log_addr(k
r->af,&kr->prefix),kr->prefixlen,log_addr(kr->af,&kr->nexthop),kr->ifindex,log_l
abel(kr->local_label),log_label(kr->remote_label),(cmd==ZEBRA_MPLS_LABELS_ADD)?"
add":"delete");/*Resetstream.*/s=zclient->obuf;stream_reset(s);zclient_create_he
ader(s,cmd,VRF_DEFAULT);stream_putc(s,ZEBRA_LSP_LDP);stream_putl(s,kr->af);switc
h(kr->af){caseAF_INET:stream_put_in_addr(s,&kr->prefix.v4);stream_putc(s,kr->pre
fixlen);stream_put_in_addr(s,&kr->nexthop.v4);break;caseAF_INET6:stream_write(s,
(uint8_t*)&kr->prefix.v6,16);stream_putc(s,kr->prefixlen);stream_write(s,(uint8_
t*)&kr->nexthop.v6,16);break;default:fatalx("kr_change:unknownaf");}stream_putl(
s,kr->ifindex);stream_putc(s,kr->priority);stream_putl(s,kr->local_label);stream
_putl(s,kr->remote_label);/*Putlengthatthefirstpointofthestream.*/stream_putw_at
(s,0,stream_get_endp(s));return(zclient_send_message(zclient));}intkr_change(str
uctkroute*kr){return(zebra_send_mpls_labels(ZEBRA_MPLS_LABELS_ADD,kr));}intkr_de
lete(structkroute*kr){return(zebra_send_mpls_labels(ZEBRA_MPLS_LABELS_DELETE,kr)
);}intkmpw_add(structzapi_pw*zpw){debug_zebra_out("pseudowire%snexthop%s(add)",z
pw->ifname,log_addr(zpw->af,(unionldpd_addr*)&zpw->nexthop));return(zebra_send_p
w(zclient,ZEBRA_PW_ADD,zpw));}intkmpw_del(structzapi_pw*zpw){debug_zebra_out("ps
eudowire%snexthop%s(del)",zpw->ifname,log_addr(zpw->af,(unionldpd_addr*)&zpw->ne
xthop));return(zebra_send_pw(zclient,ZEBRA_PW_DELETE,zpw));}intkmpw_set(structza
pi_pw*zpw){debug_zebra_out("pseudowire%snexthop%slabels%u/%u(set)",zpw->ifname,l
og_addr(zpw->af,(unionldpd_addr*)&zpw->nexthop),zpw->local_label,zpw->remote_lab
el);return(zebra_send_pw(zclient,ZEBRA_PW_SET,zpw));}intkmpw_unset(structzapi_pw
*zpw){debug_zebra_out("pseudowire%snexthop%s(unset)",zpw->ifname,log_addr(zpw->a
f,(unionldpd_addr*)&zpw->nexthop));return(zebra_send_pw(zclient,ZEBRA_PW_UNSET,z
pw));}voidkif_redistribute(constchar*ifname){structvrf*vrf=vrf_lookup_by_id(VRF_
DEFAULT);structlistnode*cnode;structinterface*ifp;structconnected*ifc;structkifk
if;structkaddrka;FOR_ALL_INTERFACES(vrf,ifp){if(ifname&&strcmp(ifname,ifp->name)
!=0)continue;ifp2kif(ifp,&kif);main_imsg_compose_both(IMSG_IFSTATUS,&kif,sizeof(
kif));for(ALL_LIST_ELEMENTS_RO(ifp->connected,cnode,ifc)){ifc2kaddr(ifp,ifc,&ka)
;main_imsg_compose_ldpe(IMSG_NEWADDR,0,&ka,sizeof(ka));}}}staticintldp_router_id
_update(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){stru
ctprefixrouter_id;zebra_router_id_update_read(zclient->ibuf,&router_id);if(bad_a
ddr_v4(router_id.u.prefix4))return(0);debug_zebra_in("router-idupdate%s",inet_nt
oa(router_id.u.prefix4));global.rtr_id.s_addr=router_id.u.prefix4.s_addr;main_im
sg_compose_ldpe(IMSG_RTRID_UPDATE,0,&global.rtr_id,sizeof(global.rtr_id));return
(0);}staticintldp_interface_add(intcommand,structzclient*zclient,zebra_size_tlen
gth,vrf_id_tvrf_id){structinterface*ifp;structkifkif;ifp=zebra_interface_add_rea
d(zclient->ibuf,vrf_id);debug_zebra_in("interfaceadd%sindex%dmtu%d",ifp->name,if
p->ifindex,ifp->mtu);ifp2kif(ifp,&kif);main_imsg_compose_both(IMSG_IFSTATUS,&kif
,sizeof(kif));return(0);}staticintldp_interface_delete(intcommand,structzclient*
zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structkifkif;/*ze
bra_interface_state_read()updatesinterfacestructureiniflist*/ifp=zebra_interface
_state_read(zclient->ibuf,vrf_id);if(ifp==NULL)return(0);debug_zebra_in("interfa
cedelete%sindex%dmtu%d",ifp->name,ifp->ifindex,ifp->mtu);/*Tosupportpseudointerf
acedonotfreeinterfacestructure.*//*if_delete(ifp);*/if_set_index(ifp,IFINDEX_INT
ERNAL);ifp2kif(ifp,&kif);main_imsg_compose_both(IMSG_IFSTATUS,&kif,sizeof(kif));
return(0);}staticintldp_interface_status_change(intcommand,structzclient*zclient
,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structlistnode*node;stru
ctconnected*ifc;structkifkif;structkaddrka;/**zebra_interface_state_read()update
sinterfacestructurein*iflist.*/ifp=zebra_interface_state_read(zclient->ibuf,vrf_
id);if(ifp==NULL)return(0);debug_zebra_in("interface%sstateupdate",ifp->name);if
p2kif(ifp,&kif);main_imsg_compose_both(IMSG_IFSTATUS,&kif,sizeof(kif));if(if_is_
operative(ifp)){for(ALL_LIST_ELEMENTS_RO(ifp->connected,node,ifc)){ifc2kaddr(ifp
,ifc,&ka);main_imsg_compose_ldpe(IMSG_NEWADDR,0,&ka,sizeof(ka));}}else{for(ALL_L
IST_ELEMENTS_RO(ifp->connected,node,ifc)){ifc2kaddr(ifp,ifc,&ka);main_imsg_compo
se_ldpe(IMSG_DELADDR,0,&ka,sizeof(ka));}}return(0);}staticintldp_interface_addre
ss_add(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){struc
tconnected*ifc;structinterface*ifp;structkaddrka;ifc=zebra_interface_address_rea
d(command,zclient->ibuf,vrf_id);if(ifc==NULL)return(0);ifp=ifc->ifp;ifc2kaddr(if
p,ifc,&ka);/*Filterinvalidaddresses.*/if(bad_addr(ka.af,&ka.addr))return(0);debu
g_zebra_in("addressadd%s/%uinterface%s",log_addr(ka.af,&ka.addr),ka.prefixlen,if
p->name);/*notifyldpeaboutnewaddress*/main_imsg_compose_ldpe(IMSG_NEWADDR,0,&ka,
sizeof(ka));return(0);}staticintldp_interface_address_delete(intcommand,structzc
lient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structconnected*ifc;structinter
face*ifp;structkaddrka;ifc=zebra_interface_address_read(command,zclient->ibuf,vr
f_id);if(ifc==NULL)return(0);ifp=ifc->ifp;ifc2kaddr(ifp,ifc,&ka);connected_free(
ifc);/*Filterinvalidaddresses.*/if(bad_addr(ka.af,&ka.addr))return(0);debug_zebr
a_in("addressdelete%s/%uinterface%s",log_addr(ka.af,&ka.addr),ka.prefixlen,ifp->
name);/*notifyldpeaboutremovedaddress*/main_imsg_compose_ldpe(IMSG_DELADDR,0,&ka
,sizeof(ka));return(0);}staticintldp_zebra_read_route(intcommand,structzclient*z
client,zebra_size_tlength,vrf_id_tvrf_id){structzapi_routeapi;structzapi_nexthop
*api_nh;structkroutekr;inti,add=0;if(zapi_route_decode(zclient->ibuf,&api)<0)ret
urn-1;/*wecompletelyignoresrcdestroutesfornow.*/if(CHECK_FLAG(api.message,ZAPI_M
ESSAGE_SRCPFX))return(0);memset(&kr,0,sizeof(kr));kr.af=api.prefix.family;switch
(kr.af){caseAF_INET:kr.prefix.v4=api.prefix.u.prefix4;break;caseAF_INET6:kr.pref
ix.v6=api.prefix.u.prefix6;break;default:break;}kr.prefixlen=api.prefix.prefixle
n;kr.priority=api.distance;switch(api.type){caseZEBRA_ROUTE_CONNECT:kr.flags|=F_
CONNECTED;break;caseZEBRA_ROUTE_BGP:/*LDPshouldfollowtheIGPandignoreBGProutes*/r
eturn(0);default:break;}if(bad_addr(kr.af,&kr.prefix)||(kr.af==AF_INET6&&IN6_IS_
SCOPE_EMBED(&kr.prefix.v6)))return(0);if(command==ZEBRA_REDISTRIBUTE_ROUTE_ADD)a
dd=1;if(api.nexthop_num==0)debug_zebra_in("route%s%s/%d(%s)",(add)?"add":"delete
",log_addr(kr.af,&kr.prefix),kr.prefixlen,zebra_route_string(api.type));/*loopth
roughallthenexthops*/for(i=0;i<api.nexthop_num;i++){api_nh=&api.nexthops[i];swit
ch(api_nh->type){caseNEXTHOP_TYPE_IPV4:if(kr.af!=AF_INET)continue;kr.nexthop.v4=
api_nh->gate.ipv4;kr.ifindex=0;break;caseNEXTHOP_TYPE_IPV4_IFINDEX:if(kr.af!=AF_
INET)continue;kr.nexthop.v4=api_nh->gate.ipv4;kr.ifindex=api_nh->ifindex;break;c
aseNEXTHOP_TYPE_IPV6:if(kr.af!=AF_INET6)continue;kr.nexthop.v6=api_nh->gate.ipv6
;kr.ifindex=0;break;caseNEXTHOP_TYPE_IPV6_IFINDEX:if(kr.af!=AF_INET6)continue;kr
.nexthop.v6=api_nh->gate.ipv6;kr.ifindex=api_nh->ifindex;break;caseNEXTHOP_TYPE_
IFINDEX:if(!(kr.flags&F_CONNECTED))continue;break;default:continue;}debug_zebra_
in("route%s%s/%dnexthop%sifindex%u(%s)",(add)?"add":"delete",log_addr(kr.af,&kr.
prefix),kr.prefixlen,log_addr(kr.af,&kr.nexthop),kr.ifindex,zebra_route_string(a
pi.type));if(add)main_imsg_compose_lde(IMSG_NETWORK_ADD,0,&kr,sizeof(kr));}main_
imsg_compose_lde(IMSG_NETWORK_UPDATE,0,&kr,sizeof(kr));return(0);}/**ReceivePWst
atusupdatefromZebraandsendittoLDEprocess.*/staticintldp_zebra_read_pw_status_upd
ate(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structza
pi_pw_statuszpw;zebra_read_pw_status_update(command,zclient,length,vrf_id,&zpw);
debug_zebra_in("pseudowire%sstatus%s",zpw.ifname,(zpw.status==PW_STATUS_UP)?"up"
:"down");main_imsg_compose_lde(IMSG_PW_UPDATE,0,&zpw,sizeof(zpw));return(0);}sta
ticvoidldp_zebra_connected(structzclient*zclient){zclient_send_reg_requests(zcli
ent,VRF_DEFAULT);zebra_redistribute_send(ZEBRA_REDISTRIBUTE_ADD,zclient,AFI_IP,Z
EBRA_ROUTE_ALL,0,VRF_DEFAULT);zebra_redistribute_send(ZEBRA_REDISTRIBUTE_ADD,zcl
ient,AFI_IP6,ZEBRA_ROUTE_ALL,0,VRF_DEFAULT);}externstructzebra_privs_tldpd_privs
;voidldp_zebra_init(structthread_master*master){/*Setdefaultvalues.*/zclient=zcl
ient_new_notify(master,&zclient_options_default);zclient_init(zclient,ZEBRA_ROUT
E_LDP,0,&ldpd_privs);/*setcallbacks*/zclient->zebra_connected=ldp_zebra_connecte
d;zclient->router_id_update=ldp_router_id_update;zclient->interface_add=ldp_inte
rface_add;zclient->interface_delete=ldp_interface_delete;zclient->interface_up=l
dp_interface_status_change;zclient->interface_down=ldp_interface_status_change;z
client->interface_address_add=ldp_interface_address_add;zclient->interface_addre
ss_delete=ldp_interface_address_delete;zclient->redistribute_route_add=ldp_zebra
_read_route;zclient->redistribute_route_del=ldp_zebra_read_route;zclient->pw_sta
tus_update=ldp_zebra_read_pw_status_update;}voidldp_zebra_destroy(void){zclient_
stop(zclient);zclient_free(zclient);zclient=NULL;}