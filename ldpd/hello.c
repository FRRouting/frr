/*$OpenBSD$*//**Copyright(c)2013,2016RenatoWestphal<renato@openbsd.org>*Copyrigh
t(c)2009MicheleMarchetto<michele@openbsd.org>**Permissiontouse,copy,modify,anddi
stributethissoftwareforany*purposewithorwithoutfeeisherebygranted,providedthatth
eabove*copyrightnoticeandthispermissionnoticeappearinallcopies.**THESOFTWAREISPR
OVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINCLUDING
ALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBELIABLE
FOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEVERRESU
LTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOROTHERT
ORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFTWARE.*
/#include<zebra.h>#include"ldpd.h"#include"ldpe.h"#include"log.h"#include"ldp_de
bug.h"staticintgen_hello_prms_tlv(structibuf*buf,uint16_t,uint16_t);staticintgen
_opt4_hello_prms_tlv(structibuf*,uint16_t,uint32_t);staticintgen_opt16_hello_prm
s_tlv(structibuf*,uint16_t,uint8_t*);staticintgen_ds_hello_prms_tlv(structibuf*,
uint32_t);staticinttlv_decode_hello_prms(char*,uint16_t,uint16_t*,uint16_t*);sta
ticinttlv_decode_opt_hello_prms(char*,uint16_t,int*,int,unionldpd_addr*,uint32_t
*,uint16_t*);intsend_hello(enumhello_typetype,structiface_af*ia,structtnbr*tnbr)
{intaf;unionldpd_addrdst;uint16_tsize,holdtime=0,flags=0;intfd=0;structibuf*buf;
interr=0;switch(type){caseHELLO_LINK:af=ia->af;holdtime=if_get_hello_holdtime(ia
);flags=0;fd=(ldp_af_global_get(&global,af))->ldp_disc_socket;/*multicastdestina
tionaddress*/switch(af){caseAF_INET:if(!(leconf->ipv4.flags&F_LDPD_AF_NO_GTSM))f
lags|=F_HELLO_GTSM;dst.v4=global.mcast_addr_v4;break;caseAF_INET6:dst.v6=global.
mcast_addr_v6;break;default:fatalx("send_hello:unknownaf");}break;caseHELLO_TARG
ETED:af=tnbr->af;holdtime=tnbr_get_hello_holdtime(tnbr);flags=F_HELLO_TARGETED;i
f((tnbr->flags&F_TNBR_CONFIGURED)||tnbr->pw_count)flags|=F_HELLO_REQ_TARG;fd=(ld
p_af_global_get(&global,af))->ldp_edisc_socket;/*unicastdestinationaddress*/dst=
tnbr->addr;break;default:fatalx("send_hello:unknownhellotype");}/*calculatemessa
gesize*/size=LDP_HDR_SIZE+LDP_MSG_SIZE+sizeof(structhello_prms_tlv);switch(af){c
aseAF_INET:size+=sizeof(structhello_prms_opt4_tlv);break;caseAF_INET6:size+=size
of(structhello_prms_opt16_tlv);break;default:fatalx("send_hello:unknownaf");}siz
e+=sizeof(structhello_prms_opt4_tlv);if(ldp_is_dual_stack(leconf))size+=sizeof(s
tructhello_prms_opt4_tlv);/*generatemessage*/if((buf=ibuf_open(size))==NULL)fata
l(__func__);err|=gen_ldp_hdr(buf,size);size-=LDP_HDR_SIZE;err|=gen_msg_hdr(buf,M
SG_TYPE_HELLO,size);err|=gen_hello_prms_tlv(buf,holdtime,flags);/**RFC7552-Secti
on6.1:*"AnLSRMUSTincludeonlythetransportaddresswhoseaddress*familyisthesameastha
toftheIPpacketcarryingtheHello*message".*/switch(af){caseAF_INET:err|=gen_opt4_h
ello_prms_tlv(buf,TLV_TYPE_IPV4TRANSADDR,leconf->ipv4.trans_addr.v4.s_addr);brea
k;caseAF_INET6:err|=gen_opt16_hello_prms_tlv(buf,TLV_TYPE_IPV6TRANSADDR,leconf->
ipv6.trans_addr.v6.s6_addr);break;default:fatalx("send_hello:unknownaf");}err|=g
en_opt4_hello_prms_tlv(buf,TLV_TYPE_CONFIG,htonl(global.conf_seqnum));/**RFC7552
-Section6.1.1:*"ADual-stackLSR(i.e.,anLSRsupportingDual-stackLDPforapeer)*MUSTin
cludetheDual-StackcapabilityTLVinallofitsLDPHellos".*/if(ldp_is_dual_stack(lecon
f))err|=gen_ds_hello_prms_tlv(buf,leconf->trans_pref);if(err){ibuf_free(buf);ret
urn(-1);}switch(type){caseHELLO_LINK:debug_hello_send("iface%s(%s)holdtime%u",ia
->iface->name,af_name(ia->af),holdtime);break;caseHELLO_TARGETED:debug_hello_sen
d("targeted-neighbor%s(%s)holdtime%u",log_addr(tnbr->af,&tnbr->addr),af_name(tnb
r->af),holdtime);break;default:fatalx("send_hello:unknownhellotype");}send_packe
t(fd,af,&dst,ia,buf->buf,buf->wpos);ibuf_free(buf);return(0);}voidrecv_hello(str
uctin_addrlsr_id,structldp_msg*msg,intaf,unionldpd_addr*src,structiface*iface,in
tmulticast,char*buf,uint16_tlen){structadj*adj=NULL;structnbr*nbr,*nbrt;uint16_t
holdtime=0,flags=0;inttlvs_rcvd;intds_tlv;unionldpd_addrtrans_addr;uint32_tscope
_id=0;uint32_tconf_seqnum;uint16_ttrans_pref;intr;structhello_sourcesource;struc
tiface_af*ia=NULL;structtnbr*tnbr=NULL;r=tlv_decode_hello_prms(buf,len,&holdtime
,&flags);if(r==-1){log_debug("%s:lsr-id%s:failedtodecodeparams",__func__,inet_nt
oa(lsr_id));return;}/*safetychecks*/if(holdtime!=0&&holdtime<MIN_HOLDTIME){log_d
ebug("%s:lsr-id%s:invalidhelloholdtime(%u)",__func__,inet_ntoa(lsr_id),holdtime)
;return;}if(multicast&&(flags&F_HELLO_TARGETED)){log_debug("%s:lsr-id%s:multicas
ttargetedhello",__func__,inet_ntoa(lsr_id));return;}if(!multicast&&!((flags&F_HE
LLO_TARGETED))){log_debug("%s:lsr-id%s:unicastlinkhello",__func__,inet_ntoa(lsr_
id));return;}buf+=r;len-=r;r=tlv_decode_opt_hello_prms(buf,len,&tlvs_rcvd,af,&tr
ans_addr,&conf_seqnum,&trans_pref);if(r==-1){log_debug("%s:lsr-id%s:failedtodeco
deoptionalparams",__func__,inet_ntoa(lsr_id));return;}if(r!=len){log_debug("%s:l
sr-id%s:unexpecteddatainmessage",__func__,inet_ntoa(lsr_id));return;}ds_tlv=(tlv
s_rcvd&F_HELLO_TLV_RCVD_DS)?1:0;/*implicittransportaddress*/if(!(tlvs_rcvd&F_HEL
LO_TLV_RCVD_ADDR))trans_addr=*src;if(bad_addr(af,&trans_addr)){log_debug("%s:lsr
-id%s:invalidtransportaddress%s",__func__,inet_ntoa(lsr_id),log_addr(af,&trans_a
ddr));return;}if(af==AF_INET6&&IN6_IS_SCOPE_EMBED(&trans_addr.v6)){/**RFC7552-Se
ction6.1:*"AnLSRMUSTuseaglobalunicastIPv6addressinanIPv6*TransportAddressoptiona
lobjectofoutgoingtargeted*HellosandcheckforthesameinincomingtargetedHellos*(i.e.
,MUSTdiscardthetargetedHelloifitfailedthe*check)".*/if(flags&F_HELLO_TARGETED){l
og_debug("%s:lsr-id%s:invalidtargetedhello""transportaddress%s",__func__,inet_nt
oa(lsr_id),log_addr(af,&trans_addr));return;}scope_id=iface->ifindex;}memset(&so
urce,0,sizeof(source));if(flags&F_HELLO_TARGETED){/**RFC7552-Section5.2:*"Thelin
k-localIPv6addressesMUSTNOTbeusedasthe*targetedLDPHellopacket'ssourceordestinati
onaddresses".*/if(af==AF_INET6&&IN6_IS_SCOPE_EMBED(&src->v6)){log_debug("%s:lsr-
id%s:targetedhellowith""link-localsourceaddress",__func__,inet_ntoa(lsr_id));ret
urn;}tnbr=tnbr_find(leconf,af,src);/*removethedynamictnbrifthe'R'bitwascleared*/
if(tnbr&&(tnbr->flags&F_TNBR_DYNAMIC)&&!((flags&F_HELLO_REQ_TARG))){tnbr->flags&
=~F_TNBR_DYNAMIC;tnbr=tnbr_check(leconf,tnbr);}if(!tnbr){structldpd_af_conf*af_c
onf;if(!(flags&F_HELLO_REQ_TARG))return;af_conf=ldp_af_conf_get(leconf,af);if(!(
af_conf->flags&F_LDPD_AF_THELLO_ACCEPT))return;if(ldpe_acl_check(af_conf->acl_th
ello_accept_from,af,src,(af==AF_INET)?32:128)!=FILTER_PERMIT)return;tnbr=tnbr_ne
w(af,src);tnbr->flags|=F_TNBR_DYNAMIC;tnbr_update(tnbr);RB_INSERT(tnbr_head,&lec
onf->tnbr_tree,tnbr);}source.type=HELLO_TARGETED;source.target=tnbr;}else{ia=ifa
ce_af_get(iface,af);source.type=HELLO_LINK;source.link.ia=ia;source.link.src_add
r=*src;}debug_hello_recv("%slsr-id%stransport-address%sholdtime%u%s",log_hello_s
rc(&source),inet_ntoa(lsr_id),log_addr(af,&trans_addr),holdtime,(ds_tlv)?"(duals
tackTLVpresent)":"");adj=adj_find(lsr_id,&source);if(adj&&adj->ds_tlv!=ds_tlv){/
**Transientcondition,ignorepacketandwaituntiladjacency*timesout.*/return;}nbr=nb
r_find_ldpid(lsr_id.s_addr);/*checkdual-stacktlv*/if(ds_tlv&&trans_pref!=leconf-
>trans_pref){/**RFC7552-Section6.1.1:*"IftheDual-StackcapabilityTLVispresentandt
heremote*preferencedoesnotmatchthelocalpreference(ordoesnot*getrecognized),thent
heLSRMUSTdiscardtheHellomessage*andloganerror.*IfanLDPsessionwasalreadyinplace,t
hentheLSRMUST*sendafatalNotificationmessagewithstatuscodeof*'TransportConnection
Mismatch'andresetthesession".*/log_debug("%s:lsr-id%s:remotetransportpreferenced
oesnot""matchthelocalpreference",__func__,inet_ntoa(lsr_id));if(nbr)session_shut
down(nbr,S_TRANS_MISMTCH,msg->id,msg->type);if(adj)adj_del(adj,S_SHUTDOWN);retur
n;}/**Checkfornoncompliantdual-stackneighboraccordingto*RFC7552section6.1.1.*/if
(nbr&&!ds_tlv){switch(af){caseAF_INET:if(nbr_adj_count(nbr,AF_INET6)>0){session_
shutdown(nbr,S_DS_NONCMPLNCE,msg->id,msg->type);return;}break;caseAF_INET6:if(nb
r_adj_count(nbr,AF_INET)>0){session_shutdown(nbr,S_DS_NONCMPLNCE,msg->id,msg->ty
pe);return;}break;default:fatalx("recv_hello:unknownaf");}}/**Protectionsagainst
misconfigurednetworksandbuggyimplementations.*/if(nbr&&nbr->af==af&&(ldp_addrcmp
(af,&nbr->raddr,&trans_addr)||nbr->raddr_scope!=scope_id)){log_warnx("%s:lsr-id%
s:hellopacketadvertisingadifferent""transportaddress",__func__,inet_ntoa(lsr_id)
);if(adj)adj_del(adj,S_SHUTDOWN);return;}if(nbr==NULL){nbrt=nbr_find_addr(af,&tr
ans_addr);if(nbrt){log_debug("%s:transportaddress%sisalreadybeing""usedbylsr-id%
s",__func__,log_addr(af,&trans_addr),inet_ntoa(nbrt->id));if(adj)adj_del(adj,S_S
HUTDOWN);return;}}if(adj==NULL){adj=adj_new(lsr_id,&source,&trans_addr);if(nbr){
adj->nbr=nbr;RB_INSERT(nbr_adj_head,&nbr->adj_tree,adj);}}adj->ds_tlv=ds_tlv;/**
Ifthehelloadjacency'saddress-familydoesn'tmatchthelocal*preference,thenanadjacen
cyisstillcreatedbutwedon'tattempt*tostartanLDPsession.*/if(nbr==NULL&&(!ds_tlv||
((trans_pref==DUAL_STACK_LDPOV4&&af==AF_INET)||(trans_pref==DUAL_STACK_LDPOV6&&a
f==AF_INET6))))nbr=nbr_new(lsr_id,af,ds_tlv,&trans_addr,scope_id);/*dynamicLDPv4
GTSMnegotiationasperRFC6720*/if(nbr){if(flags&F_HELLO_GTSM)nbr->flags|=F_NBR_GTS
M_NEGOTIATED;elsenbr->flags&=~F_NBR_GTSM_NEGOTIATED;}/*updateneighbor'sconfigura
tionsequencenumber*/if(nbr&&(tlvs_rcvd&F_HELLO_TLV_RCVD_CONF)){if(conf_seqnum>nb
r->conf_seqnum&&nbr_pending_idtimer(nbr))nbr_stop_idtimer(nbr);nbr->conf_seqnum=
conf_seqnum;}/*alwaysupdatetheholdtimetoproperlyhandleruntimechanges*/switch(sou
rce.type){caseHELLO_LINK:if(holdtime==0)holdtime=LINK_DFLT_HOLDTIME;adj->holdtim
e=min(if_get_hello_holdtime(ia),holdtime);break;caseHELLO_TARGETED:if(holdtime==
0)holdtime=TARGETED_DFLT_HOLDTIME;adj->holdtime=min(tnbr_get_hello_holdtime(tnbr
),holdtime);}if(adj->holdtime!=INFINITE_HOLDTIME)adj_start_itimer(adj);elseadj_s
top_itimer(adj);if(nbr&&nbr->state==NBR_STA_PRESENT&&!nbr_pending_idtimer(nbr)&&
nbr_session_active_role(nbr)&&!nbr_pending_connect(nbr))nbr_establish_connection
(nbr);}staticintgen_hello_prms_tlv(structibuf*buf,uint16_tholdtime,uint16_tflags
){structhello_prms_tlvparms;memset(&parms,0,sizeof(parms));parms.type=htons(TLV_
TYPE_COMMONHELLO);parms.length=htons(sizeof(parms.holdtime)+sizeof(parms.flags))
;parms.holdtime=htons(holdtime);parms.flags=htons(flags);return(ibuf_add(buf,&pa
rms,sizeof(parms)));}staticintgen_opt4_hello_prms_tlv(structibuf*buf,uint16_ttyp
e,uint32_tvalue){structhello_prms_opt4_tlvparms;memset(&parms,0,sizeof(parms));p
arms.type=htons(type);parms.length=htons(sizeof(parms.value));parms.value=value;
return(ibuf_add(buf,&parms,sizeof(parms)));}staticintgen_opt16_hello_prms_tlv(st
ructibuf*buf,uint16_ttype,uint8_t*value){structhello_prms_opt16_tlvparms;memset(
&parms,0,sizeof(parms));parms.type=htons(type);parms.length=htons(sizeof(parms.v
alue));memcpy(&parms.value,value,sizeof(parms.value));return(ibuf_add(buf,&parms
,sizeof(parms)));}staticintgen_ds_hello_prms_tlv(structibuf*buf,uint32_tvalue){i
f(leconf->flags&F_LDPD_DS_CISCO_INTEROP)value=htonl(value);elsevalue=htonl(value
<<28);return(gen_opt4_hello_prms_tlv(buf,TLV_TYPE_DUALSTACK,value));}staticinttl
v_decode_hello_prms(char*buf,uint16_tlen,uint16_t*holdtime,uint16_t*flags){struc
thello_prms_tlvtlv;if(len<sizeof(tlv))return(-1);memcpy(&tlv,buf,sizeof(tlv));if
(tlv.type!=htons(TLV_TYPE_COMMONHELLO))return(-1);if(ntohs(tlv.length)!=sizeof(t
lv)-TLV_HDR_SIZE)return(-1);*holdtime=ntohs(tlv.holdtime);*flags=ntohs(tlv.flags
);return(sizeof(tlv));}staticinttlv_decode_opt_hello_prms(char*buf,uint16_tlen,i
nt*tlvs_rcvd,intaf,unionldpd_addr*addr,uint32_t*conf_number,uint16_t*trans_pref)
{structtlvtlv;uint16_ttlv_len;inttotal=0;*tlvs_rcvd=0;memset(addr,0,sizeof(*addr
));*conf_number=0;*trans_pref=0;/**RFC7552-Section6.1:*"AnLSRSHOULDaccepttheHell
omessagethatcontainsbothIPv4and*IPv6TransportAddressoptionalobjectsbutMUSTuseonl
ythe*transportaddresswhoseaddressfamilyisthesameasthatofthe*IPpacketcarryingtheH
ellomessage.AnLSRSHOULDacceptonly*thefirstTransportAddressoptionalobjectforagive
naddress*familyinthereceivedHellomessageandignoretherestifthe*LSRreceivesmoretha
noneTransportAddressoptionalobjectfora*givenaddressfamily".*/while(len>=sizeof(t
lv)){memcpy(&tlv,buf,TLV_HDR_SIZE);tlv_len=ntohs(tlv.length);if(tlv_len+TLV_HDR_
SIZE>len)return(-1);buf+=TLV_HDR_SIZE;len-=TLV_HDR_SIZE;total+=TLV_HDR_SIZE;swit
ch(ntohs(tlv.type)){caseTLV_TYPE_IPV4TRANSADDR:if(tlv_len!=sizeof(addr->v4))retu
rn(-1);if(af!=AF_INET)return(-1);if(*tlvs_rcvd&F_HELLO_TLV_RCVD_ADDR)break;memcp
y(&addr->v4,buf,sizeof(addr->v4));*tlvs_rcvd|=F_HELLO_TLV_RCVD_ADDR;break;caseTL
V_TYPE_IPV6TRANSADDR:if(tlv_len!=sizeof(addr->v6))return(-1);if(af!=AF_INET6)ret
urn(-1);if(*tlvs_rcvd&F_HELLO_TLV_RCVD_ADDR)break;memcpy(&addr->v6,buf,sizeof(ad
dr->v6));*tlvs_rcvd|=F_HELLO_TLV_RCVD_ADDR;break;caseTLV_TYPE_CONFIG:if(tlv_len!
=sizeof(uint32_t))return(-1);memcpy(conf_number,buf,sizeof(uint32_t));*tlvs_rcvd
|=F_HELLO_TLV_RCVD_CONF;break;caseTLV_TYPE_DUALSTACK:if(tlv_len!=sizeof(uint32_t
))return(-1);/**RFC7552-Section6.1:*"ASingle-stackLSRdoesnotneedtousethe*Dual-St
ackcapabilityinHellomessagesandSHOULD*ignorethiscapabilityifreceived".*/if(!ldp_
is_dual_stack(leconf))break;/*Shameonyou,Cisco!*/if(leconf->flags&F_LDPD_DS_CISC
O_INTEROP){memcpy(trans_pref,buf+sizeof(uint16_t),sizeof(uint16_t));*trans_pref=
ntohs(*trans_pref);}else{memcpy(trans_pref,buf,sizeof(uint16_t));*trans_pref=nto
hs(*trans_pref)>>12;}*tlvs_rcvd|=F_HELLO_TLV_RCVD_DS;break;default:/*ifunknownfl
agset,ignoreTLV*/if(!(ntohs(tlv.type)&UNKNOWN_FLAG))return(-1);break;}buf+=tlv_l
en;len-=tlv_len;total+=tlv_len;}return(total);}