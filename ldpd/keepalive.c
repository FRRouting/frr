/*$OpenBSD$*//**Copyright(c)2009MicheleMarchetto<michele@openbsd.org>**Permissio
ntouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishere
bygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearinall
copies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGAR
DTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVE
NTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORA
NYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCON
TRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPER
FORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"ldpd.h"#include"ldpe.h"#inclu
de"log.h"#include"ldp_debug.h"voidsend_keepalive(structnbr*nbr){structibuf*buf;u
int16_tsize;size=LDP_HDR_SIZE+LDP_MSG_SIZE;if((buf=ibuf_open(size))==NULL)fatal(
__func__);gen_ldp_hdr(buf,size);size-=LDP_HDR_SIZE;gen_msg_hdr(buf,MSG_TYPE_KEEP
ALIVE,size);debug_kalive_send("keepalive:lsr-id%s",inet_ntoa(nbr->id));evbuf_enq
ueue(&nbr->tcp->wbuf,buf);nbr->stats.kalive_sent++;}intrecv_keepalive(structnbr*
nbr,char*buf,uint16_tlen){structldp_msgmsg;memcpy(&msg,buf,sizeof(msg));if(len!=
LDP_MSG_SIZE){session_shutdown(nbr,S_BAD_MSG_LEN,msg.id,msg.type);return(-1);}de
bug_kalive_recv("keepalive:lsr-id%s",inet_ntoa(nbr->id));if(nbr->state!=NBR_STA_
OPER)nbr_fsm(nbr,NBR_EVT_KEEPALIVE_RCVD);return(0);}