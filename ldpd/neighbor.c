/*$OpenBSD$*//**Copyright(c)2013,2016RenatoWestphal<renato@openbsd.org>*Copyrigh
t(c)2009MicheleMarchetto<michele@openbsd.org>*Copyright(c)2005ClaudioJeker<claud
io@openbsd.org>*Copyright(c)2004,2005,2008EsbenNorby<norby@openbsd.org>**Permiss
iontouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishe
rebygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearina
llcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREG
ARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOE
VENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESO
RANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFC
ONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORP
ERFORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"ldpd.h"#include"ldpe.h"#inc
lude"lde.h"#include"log.h"static__inlineintnbr_id_compare(conststructnbr*,consts
tructnbr*);static__inlineintnbr_addr_compare(conststructnbr*,conststructnbr*);st
atic__inlineintnbr_pid_compare(conststructnbr*,conststructnbr*);staticvoidnbr_up
date_peerid(structnbr*);staticintnbr_ktimer(structthread*);staticvoidnbr_start_k
timer(structnbr*);staticintnbr_ktimeout(structthread*);staticvoidnbr_start_ktime
out(structnbr*);staticintnbr_itimeout(structthread*);staticvoidnbr_start_itimeou
t(structnbr*);staticintnbr_idtimer(structthread*);staticintnbr_act_session_opera
tional(structnbr*);staticvoidnbr_send_labelmappings(structnbr*);static__inlinein
tnbr_params_compare(conststructnbr_params*,conststructnbr_params*);RB_GENERATE(n
br_id_head,nbr,id_tree,nbr_id_compare)RB_GENERATE(nbr_addr_head,nbr,addr_tree,nb
r_addr_compare)RB_GENERATE(nbr_pid_head,nbr,pid_tree,nbr_pid_compare)RB_GENERATE
(nbrp_head,nbr_params,entry,nbr_params_compare)struct{intstate;enumnbr_eventeven
t;enumnbr_actionaction;intnew_state;}nbr_fsm_tbl[]={/*currentstateeventthathappe
nedactiontotakeresultingstate*//*PassiveRole*/{NBR_STA_PRESENT,NBR_EVT_MATCH_ADJ
,NBR_ACT_NOTHING,NBR_STA_INITIAL},{NBR_STA_INITIAL,NBR_EVT_INIT_RCVD,NBR_ACT_PAS
SIVE_INIT,NBR_STA_OPENREC},{NBR_STA_OPENREC,NBR_EVT_KEEPALIVE_RCVD,NBR_ACT_SESSI
ON_EST,NBR_STA_OPER},/*ActiveRole*/{NBR_STA_PRESENT,NBR_EVT_CONNECT_UP,NBR_ACT_C
ONNECT_SETUP,NBR_STA_INITIAL},{NBR_STA_INITIAL,NBR_EVT_INIT_SENT,NBR_ACT_NOTHING
,NBR_STA_OPENSENT},{NBR_STA_OPENSENT,NBR_EVT_INIT_RCVD,NBR_ACT_KEEPALIVE_SEND,NB
R_STA_OPENREC},/*SessionMaintenance*/{NBR_STA_OPER,NBR_EVT_PDU_RCVD,NBR_ACT_RST_
KTIMEOUT,0},{NBR_STA_SESSION,NBR_EVT_PDU_RCVD,NBR_ACT_NOTHING,0},{NBR_STA_OPER,N
BR_EVT_PDU_SENT,NBR_ACT_RST_KTIMER,0},{NBR_STA_SESSION,NBR_EVT_PDU_SENT,NBR_ACT_
NOTHING,0},/*SessionClose*/{NBR_STA_PRESENT,NBR_EVT_CLOSE_SESSION,NBR_ACT_NOTHIN
G,0},{NBR_STA_SESSION,NBR_EVT_CLOSE_SESSION,NBR_ACT_CLOSE_SESSION,NBR_STA_PRESEN
T},{-1,NBR_EVT_NOTHING,NBR_ACT_NOTHING,0},};constchar*constnbr_event_names[]={"N
OTHING","ADJACENCYMATCHED","CONNECTIONUP","SESSIONCLOSE","INITRECEIVED","KEEPALI
VERECEIVED","PDURECEIVED","PDUSENT","INITSENT"};constchar*constnbr_action_names[
]={"NOTHING","RESETKEEPALIVETIMEOUT","STARTNEIGHBORSESSION","RESETKEEPALIVETIMER
","SETUPNEIGHBORCONNECTION","SENDINITANDKEEPALIVE","SENDKEEPALIVE","CLOSESESSION
"};structnbr_id_headnbrs_by_id=RB_INITIALIZER(&nbrs_by_id);structnbr_addr_headnb
rs_by_addr=RB_INITIALIZER(&nbrs_by_addr);structnbr_pid_headnbrs_by_pid=RB_INITIA
LIZER(&nbrs_by_pid);static__inlineintnbr_id_compare(conststructnbr*a,conststruct
nbr*b){return(ntohl(a->id.s_addr)-ntohl(b->id.s_addr));}static__inlineintnbr_add
r_compare(conststructnbr*a,conststructnbr*b){if(a->af<b->af)return(-1);if(a->af>
b->af)return(1);return(ldp_addrcmp(a->af,&a->raddr,&b->raddr));}static__inlinein
tnbr_pid_compare(conststructnbr*a,conststructnbr*b){return(a->peerid-b->peerid);
}intnbr_fsm(structnbr*nbr,enumnbr_eventevent){structtimevalnow;intold_state;intn
ew_state=0;inti;old_state=nbr->state;for(i=0;nbr_fsm_tbl[i].state!=-1;i++)if((nb
r_fsm_tbl[i].state&old_state)&&(nbr_fsm_tbl[i].event==event)){new_state=nbr_fsm_
tbl[i].new_state;break;}if(nbr_fsm_tbl[i].state==-1){/*eventoutsideofthedefinedf
sm,ignoreit.*/log_warnx("%s:lsr-id%s,event%snotexpectedin""state%s",__func__,ine
t_ntoa(nbr->id),nbr_event_names[event],nbr_state_name(old_state));return(0);}if(
new_state!=0)nbr->state=new_state;if(old_state!=nbr->state){log_debug("%s:event%
sresultedinaction%sand""changingstateforlsr-id%sfrom%sto%s",__func__,nbr_event_n
ames[event],nbr_action_names[nbr_fsm_tbl[i].action],inet_ntoa(nbr->id),nbr_state
_name(old_state),nbr_state_name(nbr->state));if(nbr->state==NBR_STA_OPER){gettim
eofday(&now,NULL);nbr->uptime=now.tv_sec;}}if(nbr->state==NBR_STA_OPER||nbr->sta
te==NBR_STA_PRESENT)nbr_stop_itimeout(nbr);elsenbr_start_itimeout(nbr);switch(nb
r_fsm_tbl[i].action){caseNBR_ACT_RST_KTIMEOUT:nbr_start_ktimeout(nbr);break;case
NBR_ACT_RST_KTIMER:nbr_start_ktimer(nbr);break;caseNBR_ACT_SESSION_EST:nbr_act_s
ession_operational(nbr);nbr_start_ktimer(nbr);nbr_start_ktimeout(nbr);if(nbr->v4
_enabled)send_address_all(nbr,AF_INET);if(nbr->v6_enabled)send_address_all(nbr,A
F_INET6);nbr_send_labelmappings(nbr);break;caseNBR_ACT_CONNECT_SETUP:nbr->tcp=tc
p_new(nbr->fd,nbr);/*triggernextstate*/send_init(nbr);nbr_fsm(nbr,NBR_EVT_INIT_S
ENT);break;caseNBR_ACT_PASSIVE_INIT:send_init(nbr);send_keepalive(nbr);break;cas
eNBR_ACT_KEEPALIVE_SEND:nbr_start_ktimeout(nbr);send_keepalive(nbr);break;caseNB
R_ACT_CLOSE_SESSION:ldpe_imsg_compose_lde(IMSG_NEIGHBOR_DOWN,nbr->peerid,0,NULL,
0);session_close(nbr);break;caseNBR_ACT_NOTHING:/*donothing*/break;}return(0);}s
tructnbr*nbr_new(structin_addrid,intaf,intds_tlv,unionldpd_addr*addr,uint32_tsco
pe_id){structnbr*nbr;structnbr_params*nbrp;structadj*adj;structpending_conn*pcon
n;log_debug("%s:lsr-id%stransport-address%s",__func__,inet_ntoa(id),log_addr(af,
addr));if((nbr=calloc(1,sizeof(*nbr)))==NULL)fatal(__func__);RB_INIT(nbr_adj_hea
d,&nbr->adj_tree);nbr->state=NBR_STA_PRESENT;nbr->peerid=0;nbr->af=af;nbr->ds_tl
v=ds_tlv;if(af==AF_INET||ds_tlv)nbr->v4_enabled=1;if(af==AF_INET6||ds_tlv)nbr->v
6_enabled=1;nbr->id=id;nbr->laddr=(ldp_af_conf_get(leconf,af))->trans_addr;nbr->
raddr=*addr;nbr->raddr_scope=scope_id;nbr->conf_seqnum=0;RB_FOREACH(adj,global_a
dj_head,&global.adj_tree){if(adj->lsr_id.s_addr==nbr->id.s_addr){adj->nbr=nbr;RB
_INSERT(nbr_adj_head,&nbr->adj_tree,adj);}}if(RB_INSERT(nbr_id_head,&nbrs_by_id,
nbr)!=NULL)fatalx("nbr_new:RB_INSERT(nbrs_by_id)failed");if(RB_INSERT(nbr_addr_h
ead,&nbrs_by_addr,nbr)!=NULL)fatalx("nbr_new:RB_INSERT(nbrs_by_addr)failed");TAI
LQ_INIT(&nbr->mapping_list);TAILQ_INIT(&nbr->withdraw_list);TAILQ_INIT(&nbr->req
uest_list);TAILQ_INIT(&nbr->release_list);TAILQ_INIT(&nbr->abortreq_list);nbrp=n
br_params_find(leconf,nbr->id);if(nbrp){nbr->auth.method=nbrp->auth.method;#ifde
f__OpenBSD__if(pfkey_establish(nbr,nbrp)==-1)fatalx("pfkeysetupfailed");#elsesoc
k_set_md5sig((ldp_af_global_get(&global,nbr->af))->ldp_session_socket,nbr->af,&n
br->raddr,nbrp->auth.md5key);#endif}pconn=pending_conn_find(nbr->af,&nbr->raddr)
;if(pconn){session_accept_nbr(nbr,pconn->fd);pending_conn_del(pconn);}return(nbr
);}voidnbr_del(structnbr*nbr){structadj*adj;log_debug("%s:lsr-id%s",__func__,ine
t_ntoa(nbr->id));nbr_fsm(nbr,NBR_EVT_CLOSE_SESSION);#ifdef__OpenBSD__pfkey_remov
e(nbr);#elsesock_set_md5sig((ldp_af_global_get(&global,nbr->af))->ldp_session_so
cket,nbr->af,&nbr->raddr,NULL);#endifnbr->auth.method=AUTH_NONE;if(nbr_pending_c
onnect(nbr))THREAD_WRITE_OFF(nbr->ev_connect);nbr_stop_ktimer(nbr);nbr_stop_ktim
eout(nbr);nbr_stop_itimeout(nbr);nbr_stop_idtimer(nbr);mapping_list_clr(&nbr->ma
pping_list);mapping_list_clr(&nbr->withdraw_list);mapping_list_clr(&nbr->request
_list);mapping_list_clr(&nbr->release_list);mapping_list_clr(&nbr->abortreq_list
);while(!RB_EMPTY(nbr_adj_head,&nbr->adj_tree)){adj=RB_ROOT(nbr_adj_head,&nbr->a
dj_tree);adj->nbr=NULL;RB_REMOVE(nbr_adj_head,&nbr->adj_tree,adj);}if(nbr->peeri
d)RB_REMOVE(nbr_pid_head,&nbrs_by_pid,nbr);RB_REMOVE(nbr_id_head,&nbrs_by_id,nbr
);RB_REMOVE(nbr_addr_head,&nbrs_by_addr,nbr);free(nbr);}staticvoidnbr_update_pee
rid(structnbr*nbr){staticuint32_tpeercnt=1;if(nbr->peerid)RB_REMOVE(nbr_pid_head
,&nbrs_by_pid,nbr);/*getnextunusedpeerid*/while(nbr_find_peerid(++peercnt));nbr-
>peerid=peercnt;if(RB_INSERT(nbr_pid_head,&nbrs_by_pid,nbr)!=NULL)fatalx("nbr_up
date_peerid:RB_INSERT(nbrs_by_pid)failed");}structnbr*nbr_find_ldpid(uint32_tlsr
_id){structnbrn;n.id.s_addr=lsr_id;return(RB_FIND(nbr_id_head,&nbrs_by_id,&n));}
structnbr*nbr_find_addr(intaf,unionldpd_addr*addr){structnbrn;n.af=af;n.raddr=*a
ddr;return(RB_FIND(nbr_addr_head,&nbrs_by_addr,&n));}structnbr*nbr_find_peerid(u
int32_tpeerid){structnbrn;n.peerid=peerid;return(RB_FIND(nbr_pid_head,&nbrs_by_p
id,&n));}intnbr_adj_count(structnbr*nbr,intaf){structadj*adj;inttotal=0;RB_FOREA
CH(adj,nbr_adj_head,&nbr->adj_tree)if(adj_get_af(adj)==af)total++;return(total);
}intnbr_session_active_role(structnbr*nbr){if(ldp_addrcmp(nbr->af,&nbr->laddr,&n
br->raddr)>0)return(1);return(0);}/*timers*//*Keepalivetimer:timertosendkeepaliv
emessagetoneighbors*/staticintnbr_ktimer(structthread*thread){structnbr*nbr=THRE
AD_ARG(thread);nbr->keepalive_timer=NULL;send_keepalive(nbr);nbr_start_ktimer(nb
r);return(0);}staticvoidnbr_start_ktimer(structnbr*nbr){intsecs;/*sendthreekeepa
livesperperiod*/secs=nbr->keepalive/KEEPALIVE_PER_PERIOD;THREAD_TIMER_OFF(nbr->k
eepalive_timer);nbr->keepalive_timer=NULL;thread_add_timer(master,nbr_ktimer,nbr
,secs,&nbr->keepalive_timer);}voidnbr_stop_ktimer(structnbr*nbr){THREAD_TIMER_OF
F(nbr->keepalive_timer);}/*Keepalivetimeout:ifthenbrhasn'tsentkeepalive*/statici
ntnbr_ktimeout(structthread*thread){structnbr*nbr=THREAD_ARG(thread);nbr->keepal
ive_timeout=NULL;log_debug("%s:lsr-id%s",__func__,inet_ntoa(nbr->id));session_sh
utdown(nbr,S_KEEPALIVE_TMR,0,0);return(0);}staticvoidnbr_start_ktimeout(structnb
r*nbr){THREAD_TIMER_OFF(nbr->keepalive_timeout);nbr->keepalive_timeout=NULL;thre
ad_add_timer(master,nbr_ktimeout,nbr,nbr->keepalive,&nbr->keepalive_timeout);}vo
idnbr_stop_ktimeout(structnbr*nbr){THREAD_TIMER_OFF(nbr->keepalive_timeout);}/*S
essioninitializationtimeout:ifnbrgotstuckintheinitializationFSM*/staticintnbr_it
imeout(structthread*thread){structnbr*nbr=THREAD_ARG(thread);log_debug("%s:lsr-i
d%s",__func__,inet_ntoa(nbr->id));nbr_fsm(nbr,NBR_EVT_CLOSE_SESSION);return(0);}
staticvoidnbr_start_itimeout(structnbr*nbr){intsecs;secs=INIT_FSM_TIMEOUT;THREAD
_TIMER_OFF(nbr->init_timeout);nbr->init_timeout=NULL;thread_add_timer(master,nbr
_itimeout,nbr,secs,&nbr->init_timeout);}voidnbr_stop_itimeout(structnbr*nbr){THR
EAD_TIMER_OFF(nbr->init_timeout);}/*Initdelaytimer:timertoretrytoiniziatizesessi
on*/staticintnbr_idtimer(structthread*thread){structnbr*nbr=THREAD_ARG(thread);n
br->initdelay_timer=NULL;log_debug("%s:lsr-id%s",__func__,inet_ntoa(nbr->id));nb
r_establish_connection(nbr);return(0);}voidnbr_start_idtimer(structnbr*nbr){ints
ecs;secs=INIT_DELAY_TMR;switch(nbr->idtimer_cnt){default:/*donotfurtherincreaset
hecounter*/secs=MAX_DELAY_TMR;break;case2:secs*=2;/*FALLTHROUGH*/case1:secs*=2;/
*FALLTHROUGH*/case0:nbr->idtimer_cnt++;break;}THREAD_TIMER_OFF(nbr->initdelay_ti
mer);nbr->initdelay_timer=NULL;thread_add_timer(master,nbr_idtimer,nbr,secs,&nbr
->initdelay_timer);}voidnbr_stop_idtimer(structnbr*nbr){THREAD_TIMER_OFF(nbr->in
itdelay_timer);}intnbr_pending_idtimer(structnbr*nbr){return(nbr->initdelay_time
r!=NULL);}intnbr_pending_connect(structnbr*nbr){return(nbr->ev_connect!=NULL);}s
taticintnbr_connect_cb(structthread*thread){structnbr*nbr=THREAD_ARG(thread);int
error;socklen_tlen;nbr->ev_connect=NULL;len=sizeof(error);if(getsockopt(nbr->fd,
SOL_SOCKET,SO_ERROR,&error,&len)<0){log_warn("%s:getsockoptSOL_SOCKETSO_ERROR",_
_func__);return(0);}if(error){close(nbr->fd);errno=error;log_debug("%s:errorwhil
econnectingto%s:%s",__func__,log_addr(nbr->af,&nbr->raddr),strerror(errno));retu
rn(0);}nbr_fsm(nbr,NBR_EVT_CONNECT_UP);return(0);}intnbr_establish_connection(st
ructnbr*nbr){structsockaddr_storagelocal_sa;structsockaddr_storageremote_sa;stru
ctadj*adj;structnbr_params*nbrp;#ifdef__OpenBSD__intopt=1;#endifnbr->fd=socket(n
br->af,SOCK_STREAM,0);if(nbr->fd==-1){log_warn("%s:errorwhilecreatingsocket",__f
unc__);return(-1);}sock_set_nonblock(nbr->fd);nbrp=nbr_params_find(leconf,nbr->i
d);if(nbrp&&nbrp->auth.method==AUTH_MD5SIG){#ifdef__OpenBSD__if(sysdep.no_pfkey|
|sysdep.no_md5sig){log_warnx("md5sigconfiguredbutnotavailable");close(nbr->fd);r
eturn(-1);}if(setsockopt(nbr->fd,IPPROTO_TCP,TCP_MD5SIG,&opt,sizeof(opt))==-1){l
og_warn("setsockoptmd5sig");close(nbr->fd);return(-1);}#elsesock_set_md5sig(nbr-
>fd,nbr->af,&nbr->raddr,nbrp->auth.md5key);#endif}memcpy(&local_sa,addr2sa(nbr->
af,&nbr->laddr,0),sizeof(local_sa));memcpy(&remote_sa,addr2sa(nbr->af,&nbr->radd
r,LDP_PORT),sizeof(local_sa));if(nbr->af==AF_INET6&&nbr->raddr_scope)addscope((s
tructsockaddr_in6*)&remote_sa,nbr->raddr_scope);if(bind(nbr->fd,(structsockaddr*
)&local_sa,sockaddr_len((structsockaddr*)&local_sa))==-1){log_warn("%s:errorwhil
ebindingsocketto%s",__func__,log_sockaddr((structsockaddr*)&local_sa));close(nbr
->fd);return(-1);}if(nbr_gtsm_check(nbr->fd,nbr,nbrp)){close(nbr->fd);return(-1)
;}/**Sendanextrahellotoguaranteethattheremotepeerhasformed*anadjacencyaswell.*/R
B_FOREACH(adj,nbr_adj_head,&nbr->adj_tree)send_hello(adj->source.type,adj->sourc
e.link.ia,adj->source.target);if(connect(nbr->fd,(structsockaddr*)&remote_sa,soc
kaddr_len((structsockaddr*)&remote_sa))==-1){if(errno==EINPROGRESS){thread_add_w
rite(master,nbr_connect_cb,nbr,nbr->fd,&nbr->ev_connect);return(0);}log_warn("%s
:errorwhileconnectingto%s",__func__,log_sockaddr((structsockaddr*)&remote_sa));c
lose(nbr->fd);return(-1);}/*connectioncompletedimmediately*/nbr_fsm(nbr,NBR_EVT_
CONNECT_UP);return(0);}intnbr_gtsm_enabled(structnbr*nbr,structnbr_params*nbrp){
/**RFC6720-Section3:*"Thisdocumentallowsfortheimplementationtoprovideanoptionto*
statically(e.g.,viaconfiguration)and/ordynamicallyoverridethe*defaultbehaviorand
enable/disableGTSMonaper-peerbasis".*/if(nbrp&&(nbrp->flags&F_NBRP_GTSM))return(
nbrp->gtsm_enabled);if((ldp_af_conf_get(leconf,nbr->af))->flags&F_LDPD_AF_NO_GTS
M)return(0);/*Bydefault,GTSMsupporthastobenegotiatedforLDPv4*/if(nbr->af==AF_INE
T&&!(nbr->flags&F_NBR_GTSM_NEGOTIATED))return(0);return(1);}intnbr_gtsm_setup(in
tfd,intaf,structnbr_params*nbrp){intttl=255;if(nbrp&&(nbrp->flags&F_NBRP_GTSM_HO
PS))ttl=256-nbrp->gtsm_hops;switch(af){caseAF_INET:if(sock_set_ipv4_minttl(fd,tt
l)==-1)return(-1);ttl=255;if(sock_set_ipv4_ucast_ttl(fd,ttl)==-1)return(-1);brea
k;caseAF_INET6:/*ignoreanypossibleerror*/sock_set_ipv6_minhopcount(fd,ttl);ttl=2
55;if(sock_set_ipv6_ucast_hops(fd,ttl)==-1)return(-1);break;default:fatalx("nbr_
gtsm_setup:unknownaf");}return(0);}intnbr_gtsm_check(intfd,structnbr*nbr,structn
br_params*nbrp){if(!nbr_gtsm_enabled(nbr,nbrp)){switch(nbr->af){caseAF_INET:sock
_set_ipv4_ucast_ttl(fd,-1);break;caseAF_INET6:/**SendpacketswithaHopLimitof255ev
enwhenGSTM*isdisabledtoguaranteeinteroperability.*/sock_set_ipv6_ucast_hops(fd,2
55);break;default:fatalx("nbr_gtsm_check:unknownaf");break;}return(0);}if(nbr_gt
sm_setup(fd,nbr->af,nbrp)==-1){log_warnx("%s:errorenablingGTSMforlsr-id%s",__fun
c__,inet_ntoa(nbr->id));return(-1);}return(0);}staticintnbr_act_session_operatio
nal(structnbr*nbr){structlde_nbrlde_nbr;nbr->idtimer_cnt=0;/*thisisnecessarytoav
oidipcsynchronizationissues*/nbr_update_peerid(nbr);memset(&lde_nbr,0,sizeof(lde
_nbr));lde_nbr.id=nbr->id;lde_nbr.v4_enabled=nbr->v4_enabled;lde_nbr.v6_enabled=
nbr->v6_enabled;lde_nbr.flags=nbr->flags;return(ldpe_imsg_compose_lde(IMSG_NEIGH
BOR_UP,nbr->peerid,0,&lde_nbr,sizeof(lde_nbr)));}staticvoidnbr_send_labelmapping
s(structnbr*nbr){ldpe_imsg_compose_lde(IMSG_LABEL_MAPPING_FULL,nbr->peerid,0,NUL
L,0);}static__inlineintnbr_params_compare(conststructnbr_params*a,conststructnbr
_params*b){return(ntohl(a->lsr_id.s_addr)-ntohl(b->lsr_id.s_addr));}structnbr_pa
rams*nbr_params_new(structin_addrlsr_id){structnbr_params*nbrp;if((nbrp=calloc(1
,sizeof(*nbrp)))==NULL)fatal(__func__);nbrp->lsr_id=lsr_id;nbrp->auth.method=AUT
H_NONE;return(nbrp);}structnbr_params*nbr_params_find(structldpd_conf*xconf,stru
ctin_addrlsr_id){structnbr_paramsnbrp;nbrp.lsr_id=lsr_id;return(RB_FIND(nbrp_hea
d,&xconf->nbrp_tree,&nbrp));}uint16_tnbr_get_keepalive(intaf,structin_addrlsr_id
){structnbr_params*nbrp;nbrp=nbr_params_find(leconf,lsr_id);if(nbrp&&(nbrp->flag
s&F_NBRP_KEEPALIVE))return(nbrp->keepalive);return((ldp_af_conf_get(leconf,af))-
>keepalive);}structctl_nbr*nbr_to_ctl(structnbr*nbr){staticstructctl_nbrnctl;str
ucttimevalnow;nctl.af=nbr->af;nctl.id=nbr->id;nctl.laddr=nbr->laddr;nctl.lport=n
br->tcp->lport;nctl.raddr=nbr->raddr;nctl.rport=nbr->tcp->rport;nctl.auth_method
=nbr->auth.method;nctl.holdtime=nbr->keepalive;nctl.nbr_state=nbr->state;nctl.st
ats=nbr->stats;nctl.flags=nbr->flags;gettimeofday(&now,NULL);if(nbr->state==NBR_
STA_OPER){nctl.uptime=now.tv_sec-nbr->uptime;}elsenctl.uptime=0;return(&nctl);}v
oidnbr_clear_ctl(structctl_nbr*nctl){structnbr*nbr;RB_FOREACH(nbr,nbr_addr_head,
&nbrs_by_addr){if(ldp_addrisset(nctl->af,&nctl->raddr)&&ldp_addrcmp(nctl->af,&nc
tl->raddr,&nbr->raddr))continue;log_debug("%s:neighbor%smanuallycleared",__func_
_,log_addr(nbr->af,&nbr->raddr));session_shutdown(nbr,S_SHUTDOWN,0,0);}}