/*$OpenBSD$*//**Copyright(c)2013,2016RenatoWestphal<renato@openbsd.org>*Copyrigh
t(c)2009MicheleMarchetto<michele@openbsd.org>**Permissiontouse,copy,modify,anddi
stributethissoftwareforany*purposewithorwithoutfeeisherebygranted,providedthatth
eabove*copyrightnoticeandthispermissionnoticeappearinallcopies.**THESOFTWAREISPR
OVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINCLUDING
ALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBELIABLE
FOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEVERRESU
LTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOROTHERT
ORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFTWARE.*
/#include<zebra.h>#include"ldpd.h"#include"lde.h"#include"log.h"#include"mpls.h"
static__inlineintfec_compare(conststructfec*,conststructfec*);staticintlde_nbr_i
s_nexthop(structfec_node*,structlde_nbr*);staticvoidfec_free(void*);staticstruct
fec_node*fec_add(structfec*fec);staticstructfec_nh*fec_nh_add(structfec_node*,in
t,unionldpd_addr*,ifindex_t,uint8_t);staticvoidfec_nh_del(structfec_nh*);RB_GENE
RATE(fec_tree,fec,entry,fec_compare)structfec_treeft=RB_INITIALIZER(&ft);structt
hread*gc_timer;/*FECtreefunctions*/voidfec_init(structfec_tree*fh){RB_INIT(fec_t
ree,fh);}static__inlineintfec_compare(conststructfec*a,conststructfec*b){if(a->t
ype<b->type)return(-1);if(a->type>b->type)return(1);switch(a->type){caseFEC_TYPE
_IPV4:if(ntohl(a->u.ipv4.prefix.s_addr)<ntohl(b->u.ipv4.prefix.s_addr))return(-1
);if(ntohl(a->u.ipv4.prefix.s_addr)>ntohl(b->u.ipv4.prefix.s_addr))return(1);if(
a->u.ipv4.prefixlen<b->u.ipv4.prefixlen)return(-1);if(a->u.ipv4.prefixlen>b->u.i
pv4.prefixlen)return(1);return(0);caseFEC_TYPE_IPV6:if(memcmp(&a->u.ipv6.prefix,
&b->u.ipv6.prefix,sizeof(structin6_addr))<0)return(-1);if(memcmp(&a->u.ipv6.pref
ix,&b->u.ipv6.prefix,sizeof(structin6_addr))>0)return(1);if(a->u.ipv6.prefixlen<
b->u.ipv6.prefixlen)return(-1);if(a->u.ipv6.prefixlen>b->u.ipv6.prefixlen)return
(1);return(0);caseFEC_TYPE_PWID:if(a->u.pwid.type<b->u.pwid.type)return(-1);if(a
->u.pwid.type>b->u.pwid.type)return(1);if(a->u.pwid.pwid<b->u.pwid.pwid)return(-
1);if(a->u.pwid.pwid>b->u.pwid.pwid)return(1);if(ntohl(a->u.pwid.lsr_id.s_addr)<
ntohl(b->u.pwid.lsr_id.s_addr))return(-1);if(ntohl(a->u.pwid.lsr_id.s_addr)>ntoh
l(b->u.pwid.lsr_id.s_addr))return(1);return(0);}return(-1);}structfec*fec_find(s
tructfec_tree*fh,structfec*f){return(RB_FIND(fec_tree,fh,f));}intfec_insert(stru
ctfec_tree*fh,structfec*f){if(RB_INSERT(fec_tree,fh,f)!=NULL)return(-1);return(0
);}intfec_remove(structfec_tree*fh,structfec*f){if(RB_REMOVE(fec_tree,fh,f)==NUL
L){log_warnx("%sfailedfor%s",__func__,log_fec(f));return(-1);}return(0);}voidfec
_clear(structfec_tree*fh,void(*free_cb)(void*)){structfec*f;while(!RB_EMPTY(fec_
tree,fh)){f=RB_ROOT(fec_tree,fh);fec_remove(fh,f);free_cb(f);}}/*routingtablefun
ctions*/staticintlde_nbr_is_nexthop(structfec_node*fn,structlde_nbr*ln){structfe
c_nh*fnh;LIST_FOREACH(fnh,&fn->nexthops,entry)if(lde_address_find(ln,fnh->af,&fn
h->nexthop))return(1);return(0);}voidrt_dump(pid_tpid){structfec*f;structfec_nod
e*fn;structlde_map*me;staticstructctl_rtrtctl;RB_FOREACH(f,fec_tree,&ft){fn=(str
uctfec_node*)f;if(fn->local_label==NO_LABEL&&RB_EMPTY(lde_map_head,&fn->downstre
am))continue;memset(&rtctl,0,sizeof(rtctl));switch(fn->fec.type){caseFEC_TYPE_IP
V4:rtctl.af=AF_INET;rtctl.prefix.v4=fn->fec.u.ipv4.prefix;rtctl.prefixlen=fn->fe
c.u.ipv4.prefixlen;break;caseFEC_TYPE_IPV6:rtctl.af=AF_INET6;rtctl.prefix.v6=fn-
>fec.u.ipv6.prefix;rtctl.prefixlen=fn->fec.u.ipv6.prefixlen;break;default:contin
ue;}rtctl.local_label=fn->local_label;if(RB_EMPTY(lde_map_head,&fn->downstream))
{rtctl.in_use=0;rtctl.nexthop.s_addr=INADDR_ANY;rtctl.remote_label=NO_LABEL;rtct
l.no_downstream=1;}lde_imsg_compose_ldpe(IMSG_CTL_SHOW_LIB_BEGIN,0,pid,&rtctl,si
zeof(rtctl));RB_FOREACH(me,lde_map_head,&fn->upstream){rtctl.nexthop=me->nexthop
->id;lde_imsg_compose_ldpe(IMSG_CTL_SHOW_LIB_SENT,0,pid,&rtctl,sizeof(rtctl));}R
B_FOREACH(me,lde_map_head,&fn->downstream){rtctl.in_use=lde_nbr_is_nexthop(fn,me
->nexthop);rtctl.nexthop=me->nexthop->id;rtctl.remote_label=me->map.label;lde_im
sg_compose_ldpe(IMSG_CTL_SHOW_LIB_RCVD,0,pid,&rtctl,sizeof(rtctl));}lde_imsg_com
pose_ldpe(IMSG_CTL_SHOW_LIB_END,0,pid,&rtctl,sizeof(rtctl));}}voidfec_snap(struc
tlde_nbr*ln){structfec*f;structfec_node*fn;RB_FOREACH(f,fec_tree,&ft){fn=(struct
fec_node*)f;if(fn->local_label==NO_LABEL)continue;lde_send_labelmapping(ln,fn,0)
;}lde_imsg_compose_ldpe(IMSG_MAPPING_ADD_END,ln->peerid,0,NULL,0);}staticvoidfec
_free(void*arg){structfec_node*fn=arg;structfec_nh*fnh;while((fnh=LIST_FIRST(&fn
->nexthops))){fec_nh_del(fnh);assert(fnh!=LIST_FIRST(&fn->nexthops));}if(!RB_EMP
TY(lde_map_head,&fn->downstream))log_warnx("%s:fec%sdownstreamlistnotempty",__fu
nc__,log_fec(&fn->fec));if(!RB_EMPTY(lde_map_head,&fn->upstream))log_warnx("%s:f
ec%supstreamlistnotempty",__func__,log_fec(&fn->fec));free(fn);}voidfec_tree_cle
ar(void){fec_clear(&ft,fec_free);}staticstructfec_node*fec_add(structfec*fec){st
ructfec_node*fn;fn=calloc(1,sizeof(*fn));if(fn==NULL)fatal(__func__);fn->fec=*fe
c;fn->local_label=NO_LABEL;RB_INIT(lde_map_head,&fn->upstream);RB_INIT(lde_map_h
ead,&fn->downstream);LIST_INIT(&fn->nexthops);if(fec_insert(&ft,&fn->fec))log_wa
rnx("failedtoadd%stofttree",log_fec(&fn->fec));return(fn);}structfec_nh*fec_nh_f
ind(structfec_node*fn,intaf,unionldpd_addr*nexthop,ifindex_tifindex,uint8_tprior
ity){structfec_nh*fnh;LIST_FOREACH(fnh,&fn->nexthops,entry)if(fnh->af==af&&ldp_a
ddrcmp(af,&fnh->nexthop,nexthop)==0&&fnh->ifindex==ifindex&&fnh->priority==prior
ity)return(fnh);return(NULL);}staticstructfec_nh*fec_nh_add(structfec_node*fn,in
taf,unionldpd_addr*nexthop,ifindex_tifindex,uint8_tpriority){structfec_nh*fnh;fn
h=calloc(1,sizeof(*fnh));if(fnh==NULL)fatal(__func__);fnh->af=af;fnh->nexthop=*n
exthop;fnh->ifindex=ifindex;fnh->remote_label=NO_LABEL;fnh->priority=priority;LI
ST_INSERT_HEAD(&fn->nexthops,fnh,entry);return(fnh);}staticvoidfec_nh_del(struct
fec_nh*fnh){LIST_REMOVE(fnh,entry);free(fnh);}voidlde_kernel_insert(structfec*fe
c,intaf,unionldpd_addr*nexthop,ifindex_tifindex,uint8_tpriority,intconnected,voi
d*data){structfec_node*fn;structfec_nh*fnh;fn=(structfec_node*)fec_find(&ft,fec)
;if(fn==NULL)fn=fec_add(fec);if(data)fn->data=data;fnh=fec_nh_find(fn,af,nexthop
,ifindex,priority);if(fnh==NULL)fnh=fec_nh_add(fn,af,nexthop,ifindex,priority);f
nh->flags|=F_FEC_NH_NEW;if(connected)fnh->flags|=F_FEC_NH_CONNECTED;}voidlde_ker
nel_remove(structfec*fec,intaf,unionldpd_addr*nexthop,ifindex_tifindex,uint8_tpr
iority){structfec_node*fn;structfec_nh*fnh;fn=(structfec_node*)fec_find(&ft,fec)
;if(fn==NULL)/*routelost*/return;fnh=fec_nh_find(fn,af,nexthop,ifindex,priority)
;if(fnh==NULL)/*routelost*/return;lde_send_delete_klabel(fn,fnh);fec_nh_del(fnh)
;}/**Wheneverarouteischanged,zebraadvertisesitsnewversionwithout*withdrawingtheo
ldone.So,afterprocessingaZEBRA_REDISTRIBUTE_IPV[46]_ADD*message,weneedtocheckfor
nexthopsthatwereremovedand,foreachof*them(ifany),withdrawtheassociatedlabelsfrom
zebra.*/voidlde_kernel_update(structfec*fec){structfec_node*fn;structfec_nh*fnh,
*safe;structlde_nbr*ln;structlde_map*me;fn=(structfec_node*)fec_find(&ft,fec);if
(fn==NULL)return;LIST_FOREACH_SAFE(fnh,&fn->nexthops,entry,safe){if(fnh->flags&F
_FEC_NH_NEW)fnh->flags&=~F_FEC_NH_NEW;else{lde_send_delete_klabel(fn,fnh);fec_nh
_del(fnh);}}if(LIST_EMPTY(&fn->nexthops)){RB_FOREACH(ln,nbr_tree,&lde_nbrs)lde_s
end_labelwithdraw(ln,fn,NULL,NULL);fn->data=NULL;/**Donotdeallocatethelocallabel
now,dothatonlyinthe*LIBgarbagecollector.Thiswillpreventldpdfromchanging*theinput
labelofsomeprefixestoooftenwhenrunningon*anunstablenetwork.Also,restartthegarbag
ecollector*timersothatlabelsaredeallocatedonlywhenthenetwork*isstabilized.*/lde_
gc_start_timer();}else{fn->local_label=lde_update_label(fn);if(fn->local_label!=
NO_LABEL)/*FEC.1:performlsrlabeldistributionprocedure*/RB_FOREACH(ln,nbr_tree,&l
de_nbrs)lde_send_labelmapping(ln,fn,1);}LIST_FOREACH(fnh,&fn->nexthops,entry){ld
e_send_change_klabel(fn,fnh);switch(fn->fec.type){caseFEC_TYPE_IPV4:caseFEC_TYPE
_IPV6:ln=lde_nbr_find_by_addr(fnh->af,&fnh->nexthop);break;caseFEC_TYPE_PWID:ln=
lde_nbr_find_by_lsrid(fn->fec.u.pwid.lsr_id);break;default:ln=NULL;break;}if(ln)
{/*FEC.2*/me=(structlde_map*)fec_find(&ln->recv_map,&fn->fec);if(me)/*FEC.5*/lde
_check_mapping(&me->map,ln);}}}voidlde_check_mapping(structmap*map,structlde_nbr
*ln){structfecfec;structfec_node*fn;structfec_nh*fnh;structlde_req*lre;structlde
_map*me;structl2vpn_pw*pw;lde_map2fec(map,ln->id,&fec);switch(fec.type){caseFEC_
TYPE_IPV4:if(lde_acl_check(ldeconf->ipv4.acl_label_accept_from,AF_INET,(unionldp
d_addr*)&ln->id,32)!=FILTER_PERMIT)return;if(lde_acl_check(ldeconf->ipv4.acl_lab
el_accept_for,AF_INET,(unionldpd_addr*)&fec.u.ipv4.prefix,fec.u.ipv4.prefixlen)!
=FILTER_PERMIT)return;break;caseFEC_TYPE_IPV6:if(lde_acl_check(ldeconf->ipv6.acl
_label_accept_from,AF_INET,(unionldpd_addr*)&ln->id,32)!=FILTER_PERMIT)return;if
(lde_acl_check(ldeconf->ipv6.acl_label_accept_for,AF_INET6,(unionldpd_addr*)&fec
.u.ipv6.prefix,fec.u.ipv6.prefixlen)!=FILTER_PERMIT)return;break;default:break;}
fn=(structfec_node*)fec_find(&ft,&fec);if(fn==NULL)fn=fec_add(&fec);/*LMp.1:firs
tcheckifwehaveapendingrequestrunning*/lre=(structlde_req*)fec_find(&ln->sent_req
,&fn->fec);if(lre)/*LMp.2:deleterecordofoutstandinglabelrequest*/lde_req_del(ln,
lre,1);/*RFC4447controlwordandstatustlvnegotiation*/if(map->type==MAP_TYPE_PWID&
&l2vpn_pw_negotiate(ln,fn,map))return;/**LMp.3-LMp.8:loopdetection-unnecessaryfo
rframe-mode*mplsnetworks.*//*LMp.9*/me=(structlde_map*)fec_find(&ln->recv_map,&f
n->fec);if(me){/*LMp.10*/if(me->map.label!=map->label&&lre==NULL){/*LMp.10a*/lde
_send_labelrelease(ln,fn,NULL,me->map.label);/**Cannotuselde_nbr_find_by_addr()b
ecausethere's*thepossibilityofmultipath.*/LIST_FOREACH(fnh,&fn->nexthops,entry){
if(lde_address_find(ln,fnh->af,&fnh->nexthop)==NULL)continue;lde_send_delete_kla
bel(fn,fnh);fnh->remote_label=NO_LABEL;}}}/**LMp.11-12:considermultiplenexthopsi
norderto*supportmultipath*/LIST_FOREACH(fnh,&fn->nexthops,entry){/*LMp.15:instal
lFECinFIB*/switch(fec.type){caseFEC_TYPE_IPV4:caseFEC_TYPE_IPV6:if(!lde_address_
find(ln,fnh->af,&fnh->nexthop))continue;fnh->remote_label=map->label;lde_send_ch
ange_klabel(fn,fnh);break;caseFEC_TYPE_PWID:pw=(structl2vpn_pw*)fn->data;if(pw==
NULL)continue;pw->remote_group=map->fec.pwid.group_id;if(map->flags&F_MAP_PW_IFM
TU)pw->remote_mtu=map->fec.pwid.ifmtu;if(map->flags&F_MAP_PW_STATUS)pw->remote_s
tatus=map->pw_status;elsepw->remote_status=PW_FORWARDING;fnh->remote_label=map->
label;if(l2vpn_pw_ok(pw,fnh))lde_send_change_klabel(fn,fnh);break;default:break;
}}/*LMp.13&LMp.16:Recordthemappingfromthispeer*/if(me==NULL)me=lde_map_add(ln,fn
,0);me->map=*map;/**LMp.17-LMp.27areunnecessarysincewedon'tneedtoimplement*loopd
etection.LMp.28-LMp.30areunnecessarybecauseweare*mergingcapable.*/}voidlde_check
_request(structmap*map,structlde_nbr*ln){structfecfec;structlde_req*lre;structfe
c_node*fn;structfec_nh*fnh;/*wildcardlabelrequest*/if(map->type==MAP_TYPE_TYPED_
WCARD){lde_check_request_wcard(map,ln);return;}/*LRq.1:skiploopdetection(notnece
ssary)*//*LRq.2:isthereanexthopforfec?*/lde_map2fec(map,ln->id,&fec);fn=(structf
ec_node*)fec_find(&ft,&fec);if(fn==NULL||LIST_EMPTY(&fn->nexthops)){/*LRq.5:send
NoRoutenotification*/lde_send_notification(ln,S_NO_ROUTE,map->msg_id,htons(MSG_T
YPE_LABELREQUEST));return;}/*LRq.3:isMsgSourcethenexthop?*/LIST_FOREACH(fnh,&fn-
>nexthops,entry){switch(fec.type){caseFEC_TYPE_IPV4:caseFEC_TYPE_IPV6:if(!lde_ad
dress_find(ln,fnh->af,&fnh->nexthop))continue;/*LRq.4:sendLoopDetectednotificati
on*/lde_send_notification(ln,S_LOOP_DETECTED,map->msg_id,htons(MSG_TYPE_LABELREQ
UEST));return;default:break;}}/*LRq.6:firstcheckifwehaveapendingrequestrunning*/
lre=(structlde_req*)fec_find(&ln->recv_req,&fn->fec);if(lre!=NULL)/*LRq.7:duplic
aterequest*/return;/*LRq.8:recordlabelrequest*/lre=lde_req_add(ln,&fn->fec,0);if
(lre!=NULL)lre->msg_id=ntohl(map->msg_id);/*LRq.9:performLSRlabeldistribution*/l
de_send_labelmapping(ln,fn,1);/**LRq.10:donothing(RequestNever)sinceweuseliberal
*labelretention.*LRq.11-12areunnecessarysincewearemergingcapable.*/}voidlde_chec
k_request_wcard(structmap*map,structlde_nbr*ln){structfec*f;structfec_node*fn;st
ructlde_req*lre;RB_FOREACH(f,fec_tree,&ft){fn=(structfec_node*)f;/*onlyatypedwil
dcardispossiblehere*/if(lde_wildcard_apply(map,&fn->fec,NULL)==0)continue;/*LRq.
2:isthereanexthopforfec?*/if(LIST_EMPTY(&fn->nexthops))continue;/*LRq.6:firstche
ckifwehaveapendingrequestrunning*/lre=(structlde_req*)fec_find(&ln->recv_req,&fn
->fec);if(lre!=NULL)/*LRq.7:duplicaterequest*/continue;/*LRq.8:recordlabelreques
t*/lre=lde_req_add(ln,&fn->fec,0);if(lre!=NULL)lre->msg_id=ntohl(map->msg_id);/*
LRq.9:performLSRlabeldistribution*/lde_send_labelmapping(ln,fn,1);}}voidlde_chec
k_release(structmap*map,structlde_nbr*ln){structfecfec;structfec_node*fn;structl
de_wdraw*lw;structlde_map*me;structfec*pending_map;/*wildcardlabelrelease*/if(ma
p->type==MAP_TYPE_WILDCARD||map->type==MAP_TYPE_TYPED_WCARD||(map->type==MAP_TYP
E_PWID&&!(map->flags&F_MAP_PW_ID))){lde_check_release_wcard(map,ln);return;}lde_
map2fec(map,ln->id,&fec);fn=(structfec_node*)fec_find(&ft,&fec);/*LRl.1:doesFECm
atchaknownFEC?*/if(fn==NULL)return;/*LRl.6:checksentmaplistandremoveitifavailabl
e*/me=(structlde_map*)fec_find(&ln->sent_map,&fn->fec);if(me&&(map->label==NO_LA
BEL||map->label==me->map.label))lde_map_del(ln,me,1);/*LRl.3:firstcheckifwehavea
pendingwithdrawrunning*/lw=(structlde_wdraw*)fec_find(&ln->sent_wdraw,&fn->fec);
if(lw&&(map->label==NO_LABEL||map->label==lw->label)){/*LRl.4:deleterecordofouts
tandinglabelwithdraw*/lde_wdraw_del(ln,lw);/*sendpendinglabelmappingifany*/pendi
ng_map=fec_find(&ln->sent_map_pending,&fn->fec);if(pending_map){lde_send_labelma
pping(ln,fn,1);lde_map_pending_del(ln,pending_map);}}/**LRl.11-13areunnecessarys
inceweremovethelabelfrom*forwarding/switchingassoonastheFECisunreachable.*/}void
lde_check_release_wcard(structmap*map,structlde_nbr*ln){structfec*f;structfec_no
de*fn;structlde_wdraw*lw;structlde_map*me;structfec*pending_map;RB_FOREACH(f,fec
_tree,&ft){fn=(structfec_node*)f;me=(structlde_map*)fec_find(&ln->sent_map,&fn->
fec);/*LRl.1:doesFECmatchaknownFEC?*/if(lde_wildcard_apply(map,&fn->fec,me)==0)c
ontinue;/*LRl.6:checksentmaplistandremoveitifavailable*/if(me&&(map->label==NO_L
ABEL||map->label==me->map.label))lde_map_del(ln,me,1);/*LRl.3:firstcheckifwehave
apendingwithdrawrunning*/lw=(structlde_wdraw*)fec_find(&ln->sent_wdraw,&fn->fec)
;if(lw&&(map->label==NO_LABEL||map->label==lw->label)){/*LRl.4:deleterecordofout
standinglblwithdraw*/lde_wdraw_del(ln,lw);/*sendpendinglabelmappingifany*/pendin
g_map=fec_find(&ln->sent_map_pending,&fn->fec);if(pending_map){lde_send_labelmap
ping(ln,fn,1);lde_map_pending_del(ln,pending_map);}}/**LRl.11-13areunnecessarysi
nceweremovethelabelfrom*forwarding/switchingassoonastheFECisunreachable.*/}}void
lde_check_withdraw(structmap*map,structlde_nbr*ln){structfecfec;structfec_node*f
n;structfec_nh*fnh;structlde_map*me;structl2vpn_pw*pw;/*wildcardlabelwithdraw*/i
f(map->type==MAP_TYPE_WILDCARD||map->type==MAP_TYPE_TYPED_WCARD||(map->type==MAP
_TYPE_PWID&&!(map->flags&F_MAP_PW_ID))){lde_check_withdraw_wcard(map,ln);return;
}lde_map2fec(map,ln->id,&fec);fn=(structfec_node*)fec_find(&ft,&fec);if(fn==NULL
)fn=fec_add(&fec);/*LWd.1:removelabelfromforwarding/switchinguse*/LIST_FOREACH(f
nh,&fn->nexthops,entry){switch(fec.type){caseFEC_TYPE_IPV4:caseFEC_TYPE_IPV6:if(
!lde_address_find(ln,fnh->af,&fnh->nexthop))continue;break;caseFEC_TYPE_PWID:pw=
(structl2vpn_pw*)fn->data;if(pw==NULL)continue;pw->remote_status=PW_NOT_FORWARDI
NG;break;default:break;}if(map->label!=NO_LABEL&&map->label!=fnh->remote_label)c
ontinue;lde_send_delete_klabel(fn,fnh);fnh->remote_label=NO_LABEL;}/*LWd.2:sendl
abelrelease*/lde_send_labelrelease(ln,fn,NULL,map->label);/*LWd.3:checkpreviousl
yreceivedlabelmapping*/me=(structlde_map*)fec_find(&ln->recv_map,&fn->fec);if(me
&&(map->label==NO_LABEL||map->label==me->map.label))/*LWd.4:removerecordofprevio
uslyreceivedlblmapping*/lde_map_del(ln,me,0);}voidlde_check_withdraw_wcard(struc
tmap*map,structlde_nbr*ln){structfec*f;structfec_node*fn;structfec_nh*fnh;struct
lde_map*me;structl2vpn_pw*pw;/*LWd.2:sendlabelrelease*/lde_send_labelrelease(ln,
NULL,map,map->label);RB_FOREACH(f,fec_tree,&ft){fn=(structfec_node*)f;me=(struct
lde_map*)fec_find(&ln->recv_map,&fn->fec);if(lde_wildcard_apply(map,&fn->fec,me)
==0)continue;/*LWd.1:removelabelfromforwarding/switchinguse*/LIST_FOREACH(fnh,&f
n->nexthops,entry){switch(f->type){caseFEC_TYPE_IPV4:caseFEC_TYPE_IPV6:if(!lde_a
ddress_find(ln,fnh->af,&fnh->nexthop))continue;break;caseFEC_TYPE_PWID:if(f->u.p
wid.lsr_id.s_addr!=ln->id.s_addr)continue;pw=(structl2vpn_pw*)fn->data;if(pw)pw-
>remote_status=PW_NOT_FORWARDING;break;default:break;}if(map->label!=NO_LABEL&&m
ap->label!=fnh->remote_label)continue;lde_send_delete_klabel(fn,fnh);fnh->remote
_label=NO_LABEL;}/*LWd.3:checkpreviouslyreceivedlabelmapping*/if(me&&(map->label
==NO_LABEL||map->label==me->map.label))/**LWd.4:removerecordofpreviouslyreceived
*labelmapping*/lde_map_del(ln,me,0);}}intlde_wildcard_apply(structmap*wcard,stru
ctfec*fec,structlde_map*me){switch(wcard->type){caseMAP_TYPE_WILDCARD:/*fullwild
card*/return(1);caseMAP_TYPE_TYPED_WCARD:switch(wcard->fec.twcard.type){caseMAP_
TYPE_PREFIX:if(wcard->fec.twcard.u.prefix_af==AF_INET&&fec->type!=FEC_TYPE_IPV4)
return(0);if(wcard->fec.twcard.u.prefix_af==AF_INET6&&fec->type!=FEC_TYPE_IPV6)r
eturn(0);return(1);caseMAP_TYPE_PWID:if(fec->type!=FEC_TYPE_PWID)return(0);if(wc
ard->fec.twcard.u.pw_type!=PW_TYPE_WILDCARD&&wcard->fec.twcard.u.pw_type!=fec->u
.pwid.type)return(0);return(1);default:fatalx("lde_wildcard_apply:unexpectedfect
ype");}break;caseMAP_TYPE_PWID:/*RFC4447pw-idgroupwildcard*/if(fec->type!=FEC_TY
PE_PWID)return(0);if(fec->u.pwid.type!=wcard->fec.pwid.type)return(0);if(me==NUL
L||(me->map.fec.pwid.group_id!=wcard->fec.pwid.group_id))return(0);return(1);def
ault:fatalx("lde_wildcard_apply:unexpectedfectype");}}/*gabagecollectortimer:tim
ertoremovedeadentriesfromtheLIB*//*ARGSUSED*/intlde_gc_timer(structthread*thread
){structfec*fec,*safe;structfec_node*fn;intcount=0;RB_FOREACH_SAFE(fec,fec_tree,
&ft,safe){fn=(structfec_node*)fec;if(!LIST_EMPTY(&fn->nexthops)||!RB_EMPTY(lde_m
ap_head,&fn->downstream)||!RB_EMPTY(lde_map_head,&fn->upstream))continue;fec_rem
ove(&ft,&fn->fec);free(fn);count++;}if(count>0)log_debug("%s:%uentriesremoved",_
_func__,count);lde_gc_start_timer();return(0);}voidlde_gc_start_timer(void){THRE
AD_TIMER_OFF(gc_timer);gc_timer=NULL;thread_add_timer(master,lde_gc_timer,NULL,L
DE_GC_INTERVAL,&gc_timer);}voidlde_gc_stop_timer(void){THREAD_TIMER_OFF(gc_timer
);}