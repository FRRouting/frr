/**Getinterface'saddressandmaskinformationbysysctl()function.*Copyright(C)1997,9
8KunihiroIshiguro**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredis
tributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbyth
e*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZe
braisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventh
eimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*Gener
alPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicL
icensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Found
ation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#if!
defined(GNU_LINUX)&&!defined(OPEN_BSD)&&!defined(SUNOS_5)#include"if.h"#include"
sockunion.h"#include"prefix.h"#include"connected.h"#include"memory.h"#include"ze
bra_memory.h"#include"ioctl.h"#include"log.h"#include"interface.h"#include"vrf.h
"#include"zebra/rt.h"#include"zebra/kernel_socket.h"#include"zebra/rib.h"voidifs
tat_update_sysctl(void){caddr_tref,buf,end;size_tbufsiz;structif_msghdr*ifm;stru
ctinterface*ifp;#defineMIBSIZ6intmib[MIBSIZ]={CTL_NET,PF_ROUTE,0,0,/*AF_INET&AF_
INET6*/NET_RT_IFLIST,0};/*Querybuffersize.*/if(sysctl(mib,MIBSIZ,NULL,&bufsiz,NU
LL,0)<0){zlog_warn("sysctl()errorby%s",safe_strerror(errno));return;}/*Wefreethi
smemoryattheendofthisfunction.*/ref=buf=XMALLOC(MTYPE_TMP,bufsiz);/*Fetchinterfa
ceinformationsintoallocatedbuffer.*/if(sysctl(mib,MIBSIZ,buf,&bufsiz,NULL,0)<0){
zlog_warn("sysctlerrorby%s",safe_strerror(errno));XFREE(MTYPE_TMP,ref);return;}/
*Parsebothinterfacesandaddresses.*/for(end=buf+bufsiz;buf<end;buf+=ifm->ifm_msgl
en){ifm=(structif_msghdr*)buf;if(ifm->ifm_type==RTM_IFINFO){ifp=if_lookup_by_ind
ex(ifm->ifm_index,VRF_DEFAULT);if(ifp)ifp->stats=ifm->ifm_data;}}/*Freesysctlbuf
fer.*/XFREE(MTYPE_TMP,ref);return;}/*Interfacelistingupfunctionusingsysctl().*/v
oidinterface_list(structzebra_ns*zns){caddr_tref,buf,end;size_tbufsiz;structif_m
sghdr*ifm;#defineMIBSIZ6intmib[MIBSIZ]={CTL_NET,PF_ROUTE,0,0,/*AF_INET&AF_INET6*
/NET_RT_IFLIST,0};if(zns->ns_id!=NS_DEFAULT){zlog_warn("interface_list:ignoreNS%
u",zns->ns_id);return;}/*Querybuffersize.*/if(sysctl(mib,MIBSIZ,NULL,&bufsiz,NUL
L,0)<0){zlog_warn("sysctl()errorby%s",safe_strerror(errno));return;}/*Wefreethis
memoryattheendofthisfunction.*/ref=buf=XMALLOC(MTYPE_TMP,bufsiz);/*Fetchinterfac
einformationsintoallocatedbuffer.*/if(sysctl(mib,MIBSIZ,buf,&bufsiz,NULL,0)<0){z
log_warn("sysctlerrorby%s",safe_strerror(errno));return;}/*Parsebothinterfacesan
daddresses.*/for(end=buf+bufsiz;buf<end;buf+=ifm->ifm_msglen){ifm=(structif_msgh
dr*)buf;switch(ifm->ifm_type){caseRTM_IFINFO:ifm_read(ifm);break;caseRTM_NEWADDR
:ifam_read((structifa_msghdr*)ifm);break;default:zlog_info("interfaces_list():un
expectedmessagetype");XFREE(MTYPE_TMP,ref);return;break;}}/*Freesysctlbuffer.*/X
FREE(MTYPE_TMP,ref);}#endif/*!defined(GNU_LINUX)&&!defined(OPEN_BSD)&&!defined(S
UNOS_5)*/