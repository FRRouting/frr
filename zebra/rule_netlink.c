/**ZebraPolicyBasedRouting(PBR)interactionwiththekernelusing*netlink.*Copyright(
C)2018CumulusNetworks,Inc.**ThisfileispartofFRR.**FRRisfreesoftware;youcanredist
ributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe
*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**FRRisd
istributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpli
edwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPubl
icLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicense
*alongwithFRR;seethefileCOPYING.Ifnot,writetotheFree*SoftwareFoundation,Inc.,59T
emplePlace-Suite330,Boston,MA*02111-1307,USA.*/#include<zebra.h>#ifdefHAVE_NETLI
NK#include"if.h"#include"prefix.h"#include"vrf.h"#include<linux/fib_rules.h>#inc
lude"zebra/zserv.h"#include"zebra/zebra_ns.h"#include"zebra/zebra_vrf.h"#include
"zebra/rt.h"#include"zebra/interface.h"#include"zebra/debug.h"#include"zebra/rta
dv.h"#include"zebra/kernel_netlink.h"#include"zebra/rule_netlink.h"#include"zebr
a/zebra_pbr.h"/*definitions*//*staticfunctiondeclarations*//*Privatefunctions*//
*Installoruninstallspecifiedruleforaspecificinterface.*Formnetlinkmessageandship
it.Currently,notifystatusafter*waitingfornetlinkstatus.*/staticintnetlink_rule_u
pdate(intcmd,structzebra_pbr_rule*rule){intfamily;intbytelen;struct{structnlmsgh
drn;structfib_rule_hdrfrh;charbuf[NL_PKT_BUF_SIZE];}req;structzebra_ns*zns=zebra
_ns_lookup(NS_DEFAULT);structsockaddr_nlsnl;charbuf1[PREFIX_STRLEN];charbuf2[PRE
FIX_STRLEN];memset(&req,0,sizeof(req)-NL_PKT_BUF_SIZE);family=PREFIX_FAMILY(&rul
e->filter.src_ip);bytelen=(family==AF_INET?4:16);req.n.nlmsg_type=cmd;req.n.nlms
g_len=NLMSG_LENGTH(sizeof(structrtmsg));req.n.nlmsg_flags=NLM_F_REQUEST;req.n.nl
msg_pid=zns->netlink_cmd.snl.nl_pid;req.frh.family=family;req.frh.action=FR_ACT_
TO_TBL;if(cmd==RTM_NEWRULE)req.n.nlmsg_flags|=NLM_F_CREATE|NLM_F_EXCL;/*rule'spr
ef#*/addattr32(&req.n,sizeof(req),FRA_PRIORITY,rule->priority);/*interfaceonwhic
happlied*/if(rule->ifp)addattr_l(&req.n,sizeof(req),FRA_IFNAME,rule->ifp->name,s
trlen(rule->ifp->name)+1);/*sourceIP,ifspecified*/if(IS_RULE_FILTERING_ON_SRC_IP
(rule)){req.frh.src_len=rule->filter.src_ip.prefixlen;addattr_l(&req.n,sizeof(re
q),FRA_SRC,&rule->filter.src_ip.u.prefix,bytelen);}/*destinationIP,ifspecified*/
if(IS_RULE_FILTERING_ON_DST_IP(rule)){req.frh.dst_len=rule->filter.dst_ip.prefix
len;addattr_l(&req.n,sizeof(req),FRA_DST,&rule->filter.dst_ip.u.prefix,bytelen);
}/*Routetabletousetoforward,iffiltercriteriamatches.*/if(rule->action.table<256)
req.frh.table=rule->action.table;else{req.frh.table=RT_TABLE_UNSPEC;addattr32(&r
eq.n,sizeof(req),FRA_TABLE,rule->action.table);}if(IS_ZEBRA_DEBUG_KERNEL)zlog_de
bug("Tx%sfamily%sIF%s(%u)Pref%uSrc%sDst%sTable%u",nl_msg_type_to_str(cmd),nl_fam
ily_to_str(family),rule->ifp?rule->ifp->name:"Unknown",rule->ifp?rule->ifp->ifin
dex:0,rule->priority,prefix2str(&rule->filter.src_ip,buf1,sizeof(buf1)),prefix2s
tr(&rule->filter.dst_ip,buf2,sizeof(buf2)),rule->action.table);/*Shipoffthemessa
ge.*Note:Currently,netlink_talk()isablockingcallwhichreturns*backthestatus.*/mem
set(&snl,0,sizeof(snl));snl.nl_family=AF_NETLINK;returnnetlink_talk(netlink_talk
_filter,&req.n,&zns->netlink_cmd,zns,0);}/*Publicfunctions*//**Installspecifiedr
uleforaspecificinterface.Thepreferenceiswhat*goesintheruletodenoterelativeorderi
ng;itmayormaynotbethe*sameastherule'suser-definedsequencenumber.*/voidkernel_add
_pbr_rule(structzebra_pbr_rule*rule){intret=0;ret=netlink_rule_update(RTM_NEWRUL
E,rule);kernel_pbr_rule_add_del_status(rule,(!ret)?SOUTHBOUND_INSTALL_SUCCESS:SO
UTHBOUND_INSTALL_FAILURE);}/**Uninstallspecifiedruleforaspecificinterface.*/void
kernel_del_pbr_rule(structzebra_pbr_rule*rule){intret=0;ret=netlink_rule_update(
RTM_DELRULE,rule);kernel_pbr_rule_add_del_status(rule,(!ret)?SOUTHBOUND_DELETE_S
UCCESS:SOUTHBOUND_DELETE_FAILURE);}/**Handlenetlinknotificationinformingaruleadd
ordelete.*HandlingofanADDisTBD.*DELsarenotifiedup,ifotherattributesindicateitmay
bea*notificationofinterest.Theexpectationisthatifthiscorresponds*toaPBRruleadded
byFRR,itwillbereadded.*/intnetlink_rule_change(structsockaddr_nl*snl,structnlmsg
hdr*h,ns_id_tns_id,intstartup){structzebra_ns*zns;structfib_rule_hdr*frh;structr
tattr*tb[FRA_MAX+1];intlen;char*ifname;structzebra_pbr_rulerule;charbuf1[PREFIX_
STRLEN];charbuf2[PREFIX_STRLEN];/*Basicvalidationfollowedbyextractingattributes.
*/if(h->nlmsg_type!=RTM_NEWRULE&&h->nlmsg_type!=RTM_DELRULE)return0;/*TBD*/if(h-
>nlmsg_type==RTM_NEWRULE)return0;len=h->nlmsg_len-NLMSG_LENGTH(sizeof(structfib_
rule_hdr));if(len<0)return-1;frh=NLMSG_DATA(h);if(frh->family!=AF_INET&&frh->fam
ily!=AF_INET6)return0;if(frh->action!=FR_ACT_TO_TBL)return0;memset(tb,0,sizeof(t
b));netlink_parse_rtattr(tb,FRA_MAX,RTM_RTA(frh),len);/*TBD:Wedon'tcareaboutrule
snotspecifyinganIIF.*/if(tb[FRA_IFNAME]==NULL)return0;/*Ifwedon'tknowtheinterfac
e,wedon'tcare.*/ifname=(char*)RTA_DATA(tb[FRA_IFNAME]);zns=zebra_ns_lookup(ns_id
);rule.ifp=if_lookup_by_name_per_ns(zns,ifname);if(!rule.ifp)return0;memset(&rul
e,0,sizeof(rule));if(tb[FRA_PRIORITY])rule.priority=*(uint32_t*)RTA_DATA(tb[FRA_
PRIORITY]);if(tb[FRA_SRC]){if(frh->family==AF_INET)memcpy(&rule.filter.src_ip.u.
prefix4,RTA_DATA(tb[FRA_SRC]),4);elsememcpy(&rule.filter.src_ip.u.prefix6,RTA_DA
TA(tb[FRA_SRC]),16);rule.filter.src_ip.prefixlen=frh->src_len;rule.filter.filter
_bm|=PBR_FILTER_SRC_IP;}if(tb[FRA_DST]){if(frh->family==AF_INET)memcpy(&rule.fil
ter.dst_ip.u.prefix4,RTA_DATA(tb[FRA_DST]),4);elsememcpy(&rule.filter.dst_ip.u.p
refix6,RTA_DATA(tb[FRA_DST]),16);rule.filter.dst_ip.prefixlen=frh->dst_len;rule.
filter.filter_bm|=PBR_FILTER_DST_IP;}if(tb[FRA_TABLE])rule.action.table=*(uint32
_t*)RTA_DATA(tb[FRA_TABLE]);elserule.action.table=frh->table;if(IS_ZEBRA_DEBUG_K
ERNEL)zlog_debug("Rx%sfamily%sIF%s(%u)Pref%uSrc%sDst%sTable%u",nl_msg_type_to_st
r(h->nlmsg_type),nl_family_to_str(frh->family),rule.ifp->name,rule.ifp->ifindex,
rule.priority,prefix2str(&rule.filter.src_ip,buf1,sizeof(buf1)),prefix2str(&rule
.filter.dst_ip,buf2,sizeof(buf2)),rule.action.table);returnkernel_pbr_rule_del(&
rule);}/**GettoknowexistingPBRrulesinthekernel-typicallycalledatstartup.*TBD.*/i
ntnetlink_rules_read(structzebra_ns*zns){return0;}#endif/*HAVE_NETLINK*/