/**ZebraVxLAN(EVPN)Datastructuresanddefinitions*Theseare"internal"tothisfunction
.*Copyright(C)2016,2017CumulusNetworks,Inc.**ThisfileispartofFRR.**FRRisfreesoft
ware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicens
easpublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*late
rversion.**FRRisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;wi
thouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.Seet
heGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGen
eralPublicLicense*alongwithFRR;seethefileCOPYING.Ifnot,writetotheFree*SoftwareFo
undation,Inc.,59TemplePlace-Suite330,Boston,MA*02111-1307,USA.*/#ifndef_ZEBRA_VX
LAN_PRIVATE_H#define_ZEBRA_VXLAN_PRIVATE_H#include<zebra.h>#include<zebra.h>#inc
lude"if.h"#include"linklist.h"#include"zebra_vxlan.h"#defineERR_STR_SZ256/*defin
itions*/typedefstructzebra_vni_t_zebra_vni_t;typedefstructzebra_vtep_t_zebra_vte
p_t;typedefstructzebra_mac_t_zebra_mac_t;typedefstructzebra_neigh_t_zebra_neigh_
t;typedefstructzebra_l3vni_t_zebra_l3vni_t;/**VTEPinfo**Rightnow,thisjusthaseach
remoteVTEP'sIPaddress.*/structzebra_vtep_t_{/*RemoteIP.*//*NOTE:CanonlybeIPv4rig
htnow.*/structin_addrvtep_ip;/*Links.*/structzebra_vtep_t_*next;structzebra_vtep
_t_*prev;};/**VNIhashtable**ContainsinformationpertainingtoaVNI:*-thelistofremot
eVTEPs(withthisVNI)*/structzebra_vni_t_{/*VNI-key*/vni_tvni;/*Flagforadvertising
gwmacip*/uint8_tadvertise_gw_macip;/*Flagforadvertisinggwmacip*/uint8_tadvertise
_subnet;/*CorrespondingVxLANinterface.*/structinterface*vxlan_if;/*ListofremoteV
TEPs*/zebra_vtep_t*vteps;/*LocalIP*/structin_addrlocal_vtep_ip;/*tenantVRF,ifany
*/vrf_id_tvrf_id;/*ListoflocalorremoteMAC*/structhash*mac_table;/*Listoflocalorr
emoteneighbors(MAC+IP)*/structhash*neigh_table;};/*L3VNIhashtable*/structzebra_l
3vni_t_{/*VNIkey*/vni_tvni;/*vrf_id*/vrf_id_tvrf_id;uint32_tfilter;#definePREFIX
_ROUTES_ONLY(1<<0)/*l3-vniusedforprefixroutesonly*//*LocalIP*/structin_addrlocal
_vtep_ip;/*kernelinterfaceforl3vni*/structinterface*vxlan_if;/*SVIinterfacecorre
spondingtothel3vni*/structinterface*svi_if;/*listofL2VNIsassociatedwiththeL3VNI*
/structlist*l2vnis;/*listofremoterouter-macs*/structhash*rmac_table;/*listofremo
tevtep-ipneigh*/structhash*nh_table;};/*getthevx-intfnameforl3vni*/staticinlinec
onstchar*zl3vni_vxlan_if_name(zebra_l3vni_t*zl3vni){returnzl3vni->vxlan_if?zl3vn
i->vxlan_if->name:"None";}/*getthesviintfnameforl3vni*/staticinlineconstchar*zl3
vni_svi_if_name(zebra_l3vni_t*zl3vni){returnzl3vni->svi_if?zl3vni->svi_if->name:
"None";}/*getthevrfnameforl3vni*/staticinlineconstchar*zl3vni_vrf_name(zebra_l3v
ni_t*zl3vni){returnvrf_id_to_name(zl3vni->vrf_id);}/*getthermacstring*/staticinl
ineconstchar*zl3vni_rmac2str(zebra_l3vni_t*zl3vni,char*buf,intsize){char*ptr;if(
!buf)ptr=(char*)XMALLOC(MTYPE_TMP,ETHER_ADDR_STRLEN*sizeof(char));else{assert(si
ze>=ETHER_ADDR_STRLEN);ptr=buf;}if(zl3vni->svi_if)snprintf(ptr,(ETHER_ADDR_STRLE
N),"%02x:%02x:%02x:%02x:%02x:%02x",(uint8_t)zl3vni->svi_if->hw_addr[0],(uint8_t)
zl3vni->svi_if->hw_addr[1],(uint8_t)zl3vni->svi_if->hw_addr[2],(uint8_t)zl3vni->
svi_if->hw_addr[3],(uint8_t)zl3vni->svi_if->hw_addr[4],(uint8_t)zl3vni->svi_if->
hw_addr[5]);elsesnprintf(ptr,ETHER_ADDR_STRLEN,"None");returnptr;}/**l3-vniisope
rupwhen:*0.ifEVPNisenabled(advertise-all-vnicfged)*1.itisassociatedtoavxlan-intf
*2.Associatedvxlan-intfisoperup*3.itisassociatedtoanSVI*4.associatedSVIisoperup*
/staticinlineintis_l3vni_oper_up(zebra_l3vni_t*zl3vni){return(is_evpn_enabled()&
&zl3vni&&(zl3vni->vrf_id!=VRF_UNKNOWN)&&zl3vni->vxlan_if&&if_is_operative(zl3vni
->vxlan_if)&&zl3vni->svi_if&&if_is_operative(zl3vni->svi_if));}staticinlineconst
char*zl3vni_state2str(zebra_l3vni_t*zl3vni){if(!zl3vni)returnNULL;if(is_l3vni_op
er_up(zl3vni))return"Up";elsereturn"Down";returnNULL;}staticinlinevrf_id_tzl3vni
_vrf_id(zebra_l3vni_t*zl3vni){returnzl3vni->vrf_id;}staticinlinevoidzl3vni_get_r
mac(zebra_l3vni_t*zl3vni,structethaddr*rmac){if(!zl3vni)return;if(!is_l3vni_oper
_up(zl3vni))return;if(zl3vni->svi_if&&if_is_operative(zl3vni->svi_if))memcpy(rma
c->octet,zl3vni->svi_if->hw_addr,ETH_ALEN);}/**MAChashtable.**Thistablecontainst
heMACaddressespertainingtothisVNI.*ThisincludeslocalMACslearntonanattachedVLANth
atmaps*tothisVNIaswellasremoteMACslearntandinstalledbyBGP.*LocalMACswillbeknowne
itheronaVLANsub-interfaceor*on(port,VLAN);however,itissufficientforzebratomainta
in*againsttheVNIi.e.,itdoesnotneedtoretainthelocal"port"*information.ThecorrectV
NIwillbeobtainedaszebramaintains*themapping(ofVLANtoVNI).*/structzebra_mac_t_{/*
MACaddress.*/structethaddrmacaddr;uint32_tflags;#defineZEBRA_MAC_LOCAL0x01#defin
eZEBRA_MAC_REMOTE0x02#defineZEBRA_MAC_AUTO0x04/*Autocreatedforneighbor.*/#define
ZEBRA_MAC_STICKY0x08/*StaticMAC*/#defineZEBRA_MAC_REMOTE_RMAC0x10/*remoterouterm
ac*/#defineZEBRA_MAC_DEF_GW0x20/*Localorremoteinfo.*/union{struct{ifindex_tifind
ex;vlanid_tvid;}local;structin_addrr_vtep_ip;}fwd_info;/*Listofneighassociatedwi
ththismac*/structlist*neigh_list;/*listofhostspointingtothisremoteRMAC*/structli
st*host_list;};/**ContextforMAChashwalk-usedbycallbacks.*/structmac_walk_ctx{zeb
ra_vni_t*zvni;/*VNIhash*/structzebra_vrf*zvrf;/*VRF-forclientnotification.*/intu
ninstall;/*uninstallfromkernel?*/intupd_client;/*uninstallfromclient?*/uint32_tf
lags;#defineDEL_LOCAL_MAC0x1#defineDEL_REMOTE_MAC0x2#defineDEL_ALL_MAC(DEL_LOCAL
_MAC|DEL_REMOTE_MAC)#defineDEL_REMOTE_MAC_FROM_VTEP0x4#defineSHOW_REMOTE_MAC_FRO
M_VTEP0x8structin_addrr_vtep_ip;/*TowalkMACsfromspecificVTEP*/structvty*vty;/*Us
edbyVTYhandlers*/uint32_tcount;/*UsedbyVTYhandlers*/structjson_object*json;/*Use
dforJSONOutput*/};structrmac_walk_ctx{structvty*vty;structjson_object*json;};enu
mzebra_neigh_state{ZEBRA_NEIGH_INACTIVE=0,ZEBRA_NEIGH_ACTIVE=1};#defineIS_ZEBRA_
NEIGH_ACTIVE(n)n->state==ZEBRA_NEIGH_ACTIVE#defineIS_ZEBRA_NEIGH_INACTIVE(n)n->s
tate==ZEBRA_NEIGH_INACTIVE#defineZEBRA_NEIGH_SET_ACTIVE(n)n->state=ZEBRA_NEIGH_A
CTIVE#defineZEBRA_NEIGH_SET_INACTIVE(n)n->state=ZEBRA_NEIGH_INACTIVE/**Neighborh
ashtable.**Thistablecontainstheneighbors(IPtoMACbindings)pertainingto*thisVNI.Th
isincludeslocalneighborslearntontheattachedVLAN*devicethatmapstothisVNIaswellasr
emoteneighborslearntand*installedbyBGP.*LocalneighborswillbeknownagainsttheVLANd
evice(SVI);however,*itissufficientforzebratomaintainagainsttheVNI.Thecorrect*VNI
willbeobtainedaszebramaintainsthemapping(ofVLANtoVNI).*/structzebra_neigh_t_{/*I
Paddress.*/structipaddrip;/*MACaddress.*/structethaddremac;/*Underlyinginterface
.*/ifindex_tifindex;uint32_tflags;#defineZEBRA_NEIGH_LOCAL0x01#defineZEBRA_NEIGH
_REMOTE0x02#defineZEBRA_NEIGH_REMOTE_NH0x04/*neighentryforremotevtep*/#defineZEB
RA_NEIGH_DEF_GW0x08enumzebra_neigh_statestate;/*RemoteVTEPIP-applicableonlyforre
moteneighbors.*/structin_addrr_vtep_ip;/*listofhostspointingtothisremoteNHentry*
/structlist*host_list;};/**Contextforneighborhashwalk-usedbycallbacks.*/structne
igh_walk_ctx{zebra_vni_t*zvni;/*VNIhash*/structzebra_vrf*zvrf;/*VRF-forclientnot
ification.*/intuninstall;/*uninstallfromkernel?*/intupd_client;/*uninstallfromcl
ient?*/uint32_tflags;#defineDEL_LOCAL_NEIGH0x1#defineDEL_REMOTE_NEIGH0x2#defineD
EL_ALL_NEIGH(DEL_LOCAL_NEIGH|DEL_REMOTE_NEIGH)#defineDEL_REMOTE_NEIGH_FROM_VTEP0
x4#defineSHOW_REMOTE_NEIGH_FROM_VTEP0x8structin_addrr_vtep_ip;/*Towalkneighborsf
romspecificVTEP*/structvty*vty;/*UsedbyVTYhandlers*/uint32_tcount;/*UsedbyVTYhan
dlers*/uint8_taddr_width;/*UsedbyVTYhandlers*/structjson_object*json;/*UsedforJS
ONOutput*/};/*contextforneighhashwalk-updatel3vniandrmac*/structneigh_l3info_wal
k_ctx{zebra_vni_t*zvni;zebra_l3vni_t*zl3vni;intadd;};structnh_walk_ctx{structvty
*vty;structjson_object*json;};#endif/*_ZEBRA_VXLAN_PRIVATE_H*/