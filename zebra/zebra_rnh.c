/*Zebranexthoptrackingcode*Copyright(C)2013CumulusNetworks,Inc.**Thisfileisparto
fGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthete
rmsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherver
sion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwil
lbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITY
orFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yo
ushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethe
fileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor
,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"table.h"#in
clude"memory.h"#include"command.h"#include"if.h"#include"log.h"#include"sockunio
n.h"#include"linklist.h"#include"thread.h"#include"workqueue.h"#include"prefix.h
"#include"routemap.h"#include"stream.h"#include"nexthop.h"#include"vrf.h"#includ
e"zebra/rib.h"#include"zebra/rt.h"#include"zebra/zserv.h"#include"zebra/zebra_ns
.h"#include"zebra/zebra_vrf.h"#include"zebra/redistribute.h"#include"zebra/debug
.h"#include"zebra/zebra_rnh.h"#include"zebra/zebra_routemap.h"#include"zebra/int
erface.h"#include"zebra/zebra_memory.h"staticvoidfree_state(vrf_id_tvrf_id,struc
troute_entry*re,structroute_node*rn);staticvoidcopy_state(structrnh*rnh,structro
ute_entry*re,structroute_node*rn);#definelookup_rnh_table(v,f)\({\structzebra_vr
f*zvrf;\structroute_table*t=NULL;\zvrf=zebra_vrf_lookup_by_id(v);\if(zvrf)\t=zvr
f->rnh_table[family2afi(f)];\t;\})staticintcompare_state(structroute_entry*r1,st
ructroute_entry*r2);staticintsend_client(structrnh*rnh,structzserv*client,rnh_ty
pe_ttype,vrf_id_tvrf_id);staticvoidprint_rnh(structroute_node*rn,structvty*vty);
intzebra_rnh_ip_default_route=0;intzebra_rnh_ipv6_default_route=0;staticinlinest
ructroute_table*get_rnh_table(vrf_id_tvrfid,intfamily,rnh_type_ttype){structzebr
a_vrf*zvrf;structroute_table*t=NULL;zvrf=zebra_vrf_lookup_by_id(vrfid);if(zvrf)s
witch(type){caseRNH_NEXTHOP_TYPE:t=zvrf->rnh_table[family2afi(family)];break;cas
eRNH_IMPORT_CHECK_TYPE:t=zvrf->import_check_table[family2afi(family)];break;}ret
urnt;}char*rnh_str(structrnh*rnh,char*buf,intsize){prefix2str(&(rnh->node->p),bu
f,size);returnbuf;}structrnh*zebra_add_rnh(structprefix*p,vrf_id_tvrfid,rnh_type
_ttype){structroute_table*table;structroute_node*rn;structrnh*rnh=NULL;charbuf[P
REFIX2STR_BUFFER];if(IS_ZEBRA_DEBUG_NHT){prefix2str(p,buf,sizeof(buf));zlog_debu
g("%u:AddRNH%stype%d",vrfid,buf,type);}table=get_rnh_table(vrfid,PREFIX_FAMILY(p
),type);if(!table){prefix2str(p,buf,sizeof(buf));zlog_warn("%u:AddRNH%stype%d-ta
blenotfound",vrfid,buf,type);returnNULL;}/*Makeitsureprefixlenisappliedtothepref
ix.*/apply_mask(p);/*Lookup(oradd)routenode.*/rn=route_node_get(table,p);if(!rn-
>info){rnh=XCALLOC(MTYPE_RNH,sizeof(structrnh));rnh->client_list=list_new();rnh-
>vrf_id=vrfid;rnh->zebra_static_route_list=list_new();rnh->zebra_pseudowire_list
=list_new();route_lock_node(rn);rn->info=rnh;rnh->node=rn;}route_unlock_node(rn)
;return(rn->info);}structrnh*zebra_lookup_rnh(structprefix*p,vrf_id_tvrfid,rnh_t
ype_ttype){structroute_table*table;structroute_node*rn;table=get_rnh_table(vrfid
,PREFIX_FAMILY(p),type);if(!table)returnNULL;/*Makeitsureprefixlenisappliedtothe
prefix.*/apply_mask(p);/*Lookuproutenode.*/rn=route_node_lookup(table,p);if(!rn)
returnNULL;route_unlock_node(rn);return(rn->info);}voidzebra_free_rnh(structrnh*
rnh){rnh->flags|=ZEBRA_NHT_DELETED;list_delete_and_null(&rnh->client_list);list_
delete_and_null(&rnh->zebra_static_route_list);list_delete_and_null(&rnh->zebra_
pseudowire_list);free_state(rnh->vrf_id,rnh->state,rnh->node);XFREE(MTYPE_RNH,rn
h);}voidzebra_delete_rnh(structrnh*rnh,rnh_type_ttype){structroute_node*rn;if(!r
nh||(rnh->flags&ZEBRA_NHT_DELETED)||!(rn=rnh->node))return;if(IS_ZEBRA_DEBUG_NHT
){charbuf[PREFIX2STR_BUFFER];zlog_debug("%u:DelRNH%stype%d",rnh->vrf_id,rnh_str(
rnh,buf,sizeof(buf)),type);}zebra_free_rnh(rnh);rn->info=NULL;route_unlock_node(
rn);}voidzebra_add_rnh_client(structrnh*rnh,structzserv*client,rnh_type_ttype,vr
f_id_tvrf_id){if(IS_ZEBRA_DEBUG_NHT){charbuf[PREFIX2STR_BUFFER];zlog_debug("%u:C
lient%sregistersforRNH%stype%d",vrf_id,zebra_route_string(client->proto),rnh_str
(rnh,buf,sizeof(buf)),type);}if(!listnode_lookup(rnh->client_list,client)){listn
ode_add(rnh->client_list,client);send_client(rnh,client,type,vrf_id);//Pending:c
heckifitsneeded}}voidzebra_remove_rnh_client(structrnh*rnh,structzserv*client,rn
h_type_ttype){if(IS_ZEBRA_DEBUG_NHT){charbuf[PREFIX2STR_BUFFER];zlog_debug("Clie
nt%sunregistersforRNH%stype%d",zebra_route_string(client->proto),rnh_str(rnh,buf
,sizeof(buf)),type);}listnode_delete(rnh->client_list,client);if(list_isempty(rn
h->client_list)&&list_isempty(rnh->zebra_static_route_list)&&list_isempty(rnh->z
ebra_pseudowire_list))zebra_delete_rnh(rnh,type);}voidzebra_register_rnh_static_
nh(vrf_id_tvrf_id,structprefix*nh,structroute_node*static_rn){structrnh*rnh;rnh=
zebra_add_rnh(nh,vrf_id,RNH_NEXTHOP_TYPE);if(rnh&&!listnode_lookup(rnh->zebra_st
atic_route_list,static_rn)){listnode_add(rnh->zebra_static_route_list,static_rn)
;}}voidzebra_deregister_rnh_static_nh(vrf_id_tvrf_id,structprefix*nh,structroute
_node*static_rn){structrnh*rnh;rnh=zebra_lookup_rnh(nh,vrf_id,RNH_NEXTHOP_TYPE);
if(!rnh||(rnh->flags&ZEBRA_NHT_DELETED))return;listnode_delete(rnh->zebra_static
_route_list,static_rn);if(list_isempty(rnh->client_list)&&list_isempty(rnh->zebr
a_static_route_list)&&list_isempty(rnh->zebra_pseudowire_list))zebra_delete_rnh(
rnh,RNH_NEXTHOP_TYPE);}voidzebra_deregister_rnh_static_nexthops(vrf_id_tvrf_id,s
tructnexthop*nexthop,structroute_node*rn){structnexthop*nh;structprefixnh_p;for(
nh=nexthop;nh;nh=nh->next){switch(nh->type){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TY
PE_IPV4_IFINDEX:nh_p.family=AF_INET;nh_p.prefixlen=IPV4_MAX_BITLEN;nh_p.u.prefix
4=nh->gate.ipv4;break;caseNEXTHOP_TYPE_IPV6:caseNEXTHOP_TYPE_IPV6_IFINDEX:nh_p.f
amily=AF_INET6;nh_p.prefixlen=IPV6_MAX_BITLEN;nh_p.u.prefix6=nh->gate.ipv6;break
;/**Notsurewhatreallytodohere,wearenot*supposedtohaveeitheroftheseforNHT*andthec
odehasnowaytoknowwhatprefix*touse.SoI'mgoingtojustcontinue*forthemoment,whichisp
referableto*whatiscurrentlyhappeningwhichisa*CRASHandBURN.*Somesimpletestingshow
sthatwe*arenotleavingslagaroundforthese*skippedstaticroutes.Since*theydon'tappea
rtobeinstalled*/caseNEXTHOP_TYPE_IFINDEX:caseNEXTHOP_TYPE_BLACKHOLE:continue;bre
ak;}zebra_deregister_rnh_static_nh(vrf_id,&nh_p,rn);}}/*XXXmovethisutilityfuncti
onelsewhere?*/staticvoidaddr2hostprefix(intaf,constuniong_addr*addr,structprefix
*prefix){switch(af){caseAF_INET:prefix->family=AF_INET;prefix->prefixlen=IPV4_MA
X_BITLEN;prefix->u.prefix4=addr->ipv4;break;caseAF_INET6:prefix->family=AF_INET6
;prefix->prefixlen=IPV6_MAX_BITLEN;prefix->u.prefix6=addr->ipv6;break;default:me
mset(prefix,0,sizeof(*prefix));zlog_warn("%s:unknownaddressfamily%d",__func__,af
);break;}}voidzebra_register_rnh_pseudowire(vrf_id_tvrf_id,structzebra_pw*pw){st
ructprefixnh;structrnh*rnh;addr2hostprefix(pw->af,&pw->nexthop,&nh);rnh=zebra_ad
d_rnh(&nh,vrf_id,RNH_NEXTHOP_TYPE);if(rnh&&!listnode_lookup(rnh->zebra_pseudowir
e_list,pw)){listnode_add(rnh->zebra_pseudowire_list,pw);pw->rnh=rnh;zebra_evalua
te_rnh(vrf_id,pw->af,1,RNH_NEXTHOP_TYPE,&nh);}}voidzebra_deregister_rnh_pseudowi
re(vrf_id_tvrf_id,structzebra_pw*pw){structrnh*rnh;rnh=pw->rnh;if(!rnh)return;li
stnode_delete(rnh->zebra_pseudowire_list,pw);pw->rnh=NULL;if(list_isempty(rnh->c
lient_list)&&list_isempty(rnh->zebra_static_route_list)&&list_isempty(rnh->zebra
_pseudowire_list))zebra_delete_rnh(rnh,RNH_NEXTHOP_TYPE);}/*ApplytheNHTroute-map
foraclienttotheroute(andnexthops)*resolvingaNH.*/staticintzebra_rnh_apply_nht_rm
ap(intfamily,structroute_node*prn,structroute_entry*re,intproto){intat_least_one
=0;intrmap_family;/*RoutemaphasdiffAFfamilyenum*/structnexthop*nexthop;intret;rm
ap_family=(family==AF_INET)?AFI_IP:AFI_IP6;if(prn&&re){for(nexthop=re->ng.nextho
p;nexthop;nexthop=nexthop->next){ret=zebra_nht_route_map_check(rmap_family,proto
,&prn->p,re,nexthop);if(ret!=RMAP_DENYMATCH){SET_FLAG(nexthop->flags,NEXTHOP_FLA
G_ACTIVE);at_least_one++;/*atleastonevalidNH*/}else{UNSET_FLAG(nexthop->flags,NE
XTHOP_FLAG_ACTIVE);}}}return(at_least_one);}/**Determineappropriateroute(REentry
)resolvingatrackedBGProute*forBGProuteforimport.*/staticstructroute_entry*zebra_
rnh_resolve_import_entry(vrf_id_tvrfid,intfamily,structroute_node*nrn,structrnh*
rnh,structroute_node**prn){structroute_table*route_table;structroute_node*rn;str
uctroute_entry*re;*prn=NULL;route_table=zebra_vrf_table(family2afi(family),SAFI_
UNICAST,vrfid);if(!route_table)//unexpectedreturnNULL;rn=route_node_match(route_
table,&nrn->p);if(!rn)returnNULL;/*Unlockroutenode-wedon'tneedtolockwhenwalkingt
hetree.*/route_unlock_node(rn);if(CHECK_FLAG(rnh->flags,ZEBRA_NHT_EXACT_MATCH)&&
!prefix_same(&nrn->p,&rn->p))returnNULL;/*Identifyappropriaterouteentry.*/RNODE_
FOREACH_RE(rn,re){if(!CHECK_FLAG(re->status,ROUTE_ENTRY_REMOVED)&&CHECK_FLAG(re-
>flags,ZEBRA_FLAG_SELECTED)&&(re->type!=ZEBRA_ROUTE_BGP))break;}if(re)*prn=rn;re
turnre;}/**Seeifatrackedrouteentryforimport(byBGP)hasundergoneany*change,andifso
,notifytheclient.*/staticvoidzebra_rnh_eval_import_check_entry(vrf_id_tvrfid,int
family,intforce,structroute_node*nrn,structrnh*rnh,structroute_entry*re){intstat
e_changed=0;structzserv*client;charbufn[INET6_ADDRSTRLEN];structlistnode*node;st
ructnexthop*nexthop;if(re&&(rnh->state==NULL)){for(ALL_NEXTHOPS(re->ng,nexthop))
if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)){state_changed=1;break;}}elseif(!
re&&(rnh->state!=NULL))state_changed=1;if(compare_state(re,rnh->state))copy_stat
e(rnh,re,nrn);if(state_changed||force){if(IS_ZEBRA_DEBUG_NHT){prefix2str(&nrn->p
,bufn,INET6_ADDRSTRLEN);zlog_debug("%u:%s:Routeimportcheck%s%s\n",vrfid,bufn,rnh
->state?"passed":"failed",state_changed?"(statechanged)":"");}/*statechanged,not
ifyclients*/for(ALL_LIST_ELEMENTS_RO(rnh->client_list,node,client)){send_client(
rnh,client,RNH_IMPORT_CHECK_TYPE,vrfid);}}}/**Notifyclientsregisteredforthisnext
hopaboutachange.*/staticvoidzebra_rnh_notify_protocol_clients(vrf_id_tvrfid,intf
amily,structroute_node*nrn,structrnh*rnh,structroute_node*prn,structroute_entry*
re){structlistnode*node;structzserv*client;charbufn[INET6_ADDRSTRLEN];charbufp[I
NET6_ADDRSTRLEN];intnum_resolving_nh;if(IS_ZEBRA_DEBUG_NHT){prefix2str(&nrn->p,b
ufn,INET6_ADDRSTRLEN);if(prn&&re){prefix2str(&prn->p,bufp,INET6_ADDRSTRLEN);zlog
_debug("%u:%s:NHresolvedoverroute%s",vrfid,bufn,bufp);}elsezlog_debug("%u:%s:NHh
asbecomeunresolved",vrfid,bufn);}for(ALL_LIST_ELEMENTS_RO(rnh->client_list,node,
client)){if(prn&&re){/*Applyroute-mapforthisclienttorouteresolving*this*nexthopt
oseeifitisfilteredornot.*/num_resolving_nh=zebra_rnh_apply_nht_rmap(family,prn,r
e,client->proto);if(num_resolving_nh)rnh->filtered[client->proto]=0;elsernh->fil
tered[client->proto]=1;if(IS_ZEBRA_DEBUG_NHT)zlog_debug("%u:%s:Notifyingclient%s
aboutNH%s",vrfid,bufn,zebra_route_string(client->proto),num_resolving_nh?"":"(fi
lteredbyroute-map)");}else{rnh->filtered[client->proto]=0;if(IS_ZEBRA_DEBUG_NHT)
zlog_debug("%u:%s:Notifyingclient%saboutNH(unreachable)",vrfid,bufn,zebra_route_
string(client->proto));}send_client(rnh,client,RNH_NEXTHOP_TYPE,vrfid);}}staticv
oidzebra_rnh_process_static_routes(vrf_id_tvrfid,intfamily,structroute_node*nrn,
structrnh*rnh,structroute_node*prn,structroute_entry*re){structlistnode*node;int
num_resolving_nh=0;structroute_node*static_rn;structroute_entry*sre;structnextho
p*nexthop;charbufn[INET6_ADDRSTRLEN];charbufp[INET6_ADDRSTRLEN];charbufs[INET6_A
DDRSTRLEN];if(IS_ZEBRA_DEBUG_NHT){prefix2str(&nrn->p,bufn,INET6_ADDRSTRLEN);if(p
rn)prefix2str(&prn->p,bufp,INET6_ADDRSTRLEN);}if(prn&&re){/*Applyroute-mapfor"st
atic"torouteresolvingthis*nexthoptoseeifitisfilteredornot.*/num_resolving_nh=zeb
ra_rnh_apply_nht_rmap(family,prn,re,ZEBRA_ROUTE_STATIC);if(num_resolving_nh)rnh-
>filtered[ZEBRA_ROUTE_STATIC]=0;elsernh->filtered[ZEBRA_ROUTE_STATIC]=1;}elsernh
->filtered[ZEBRA_ROUTE_STATIC]=0;/*Evaluateeachstaticrouteassociatedwiththisnext
hop.*/for(ALL_LIST_ELEMENTS_RO(rnh->zebra_static_route_list,node,static_rn)){RNO
DE_FOREACH_RE(static_rn,sre){if(sre->type!=ZEBRA_ROUTE_STATIC)continue;/*Setthef
ilterflagforthecorrectnexthop-static*routemay*behavingmultiple.Wecarehereonlyabo
ut*registerednexthops.*/for(nexthop=sre->ng.nexthop;nexthop;nexthop=nexthop->nex
t){switch(nexthop->type){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV4_IFINDEX:if(
nexthop->gate.ipv4.s_addr==nrn->p.u.prefix4.s_addr){if(num_resolving_nh)UNSET_FL
AG(nexthop->flags,NEXTHOP_FLAG_FILTERED);elseSET_FLAG(nexthop->flags,NEXTHOP_FLA
G_FILTERED);}break;caseNEXTHOP_TYPE_IPV6:caseNEXTHOP_TYPE_IPV6_IFINDEX:if(memcmp
(&nexthop->gate.ipv6,&nrn->p.u.prefix6,16)==0){if(num_resolving_nh)UNSET_FLAG(ne
xthop->flags,NEXTHOP_FLAG_FILTERED);elseSET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIL
TERED);}break;default:break;}}if(IS_ZEBRA_DEBUG_NHT){prefix2str(&static_rn->p,bu
fs,INET6_ADDRSTRLEN);if(prn&&re)zlog_debug("%u:%s:NHchange%s,schedulingstaticrou
te%s",vrfid,bufn,num_resolving_nh?"":"(filteredbyroute-map)",bufs);elsezlog_debu
g("%u:%s:NHunreachable,schedulingstaticroute%s",vrfid,bufn,bufs);}SET_FLAG(sre->
status,ROUTE_ENTRY_CHANGED);SET_FLAG(sre->status,ROUTE_ENTRY_NEXTHOPS_CHANGED);}
rib_queue_add(static_rn);}}/**Determineappropriateroute(routeentry)resolvingatra
cked*nexthop.*/staticstructroute_entry*zebra_rnh_resolve_nexthop_entry(vrf_id_tv
rfid,intfamily,structroute_node*nrn,structrnh*rnh,structroute_node**prn){structr
oute_table*route_table;structroute_node*rn;structroute_entry*re;*prn=NULL;route_
table=zebra_vrf_table(family2afi(family),SAFI_UNICAST,vrfid);if(!route_table)ret
urnNULL;rn=route_node_match(route_table,&nrn->p);if(!rn)returnNULL;/*Unlockroute
node-wedon'tneedtolockwhenwalkingthetree.*/route_unlock_node(rn);/*Whileresolvin
gnexthops,wemayneedtowalkupthetreefromthe*most-specificmatch.Dosimilarlogicasinz
ebra_rib.c*/while(rn){/*Donotresolveoverdefaultrouteunlessallowed&&*matchrouteto
beexactifsospecified*/if(is_default_prefix(&rn->p)&&!rnh_resolve_via_default(rn-
>p.family))returnNULL;/*Identifyappropriaterouteentry.*/RNODE_FOREACH_RE(rn,re){
if(CHECK_FLAG(re->status,ROUTE_ENTRY_REMOVED))continue;if(!CHECK_FLAG(re->flags,
ZEBRA_FLAG_SELECTED))continue;if(CHECK_FLAG(rnh->flags,ZEBRA_NHT_CONNECTED)){if(
(re->type==ZEBRA_ROUTE_CONNECT)||(re->type==ZEBRA_ROUTE_STATIC))break;if(re->typ
e==ZEBRA_ROUTE_NHRP){structnexthop*nexthop;for(nexthop=re->ng.nexthop;nexthop;ne
xthop=nexthop->next)if(nexthop->type==NEXTHOP_TYPE_IFINDEX)break;if(nexthop)brea
k;}}elsebreak;}/*Routeentryfound,we'redone;else,walkupthetree.*/if(re){*prn=rn;r
eturnre;}if(CHECK_FLAG(rnh->flags,ZEBRA_NHT_CONNECTED))rn=rn->parent;elsereturnN
ULL;}returnNULL;}staticvoidzebra_rnh_process_pseudowires(vrf_id_tvrfid,structrnh
*rnh){structzebra_pw*pw;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(rnh->zebra_
pseudowire_list,node,pw))zebra_pw_update(pw);}/**Seeifatrackednexthopentryhasund
ergoneanychange,andifso,*takeappropriateaction;thisinvolvesnotifyinganyclientsan
d/or*schedulingdependentstaticroutesforprocessing.*/staticvoidzebra_rnh_eval_nex
thop_entry(vrf_id_tvrfid,intfamily,intforce,structroute_node*nrn,structrnh*rnh,s
tructroute_node*prn,structroute_entry*re){intstate_changed=0;/*Ifwe'reresolvingo
veradifferentroute,resolutionhaschangedor*theresolvingroutehassomechange(e.g.,me
tric),thereisastate*change.*/if(!prefix_same(&rnh->resolved_route,&prn->p)){if(p
rn)prefix_copy(&rnh->resolved_route,&prn->p);elsememset(&rnh->resolved_route,0,s
izeof(structprefix));copy_state(rnh,re,nrn);state_changed=1;}elseif(compare_stat
e(re,rnh->state)){copy_state(rnh,re,nrn);state_changed=1;}if(state_changed||forc
e){/*NOTE:Usethe"copy"ofresolvingroutestoredin'rnh'i.e.,*rnh->state.*//*Notifyre
gisteredprotocolclients.*/zebra_rnh_notify_protocol_clients(vrfid,family,nrn,rnh
,prn,rnh->state);/*Processstaticroutesattachedtothisnexthop*/zebra_rnh_process_s
tatic_routes(vrfid,family,nrn,rnh,prn,rnh->state);/*Processpseudowiresattachedto
thisnexthop*/zebra_rnh_process_pseudowires(vrfid,rnh);}}/*Evaluateonetrackedentr
y*/staticvoidzebra_rnh_evaluate_entry(vrf_id_tvrfid,intfamily,intforce,rnh_type_
ttype,structroute_node*nrn){structrnh*rnh;structroute_entry*re;structroute_node*
prn;charbufn[INET6_ADDRSTRLEN];if(IS_ZEBRA_DEBUG_NHT){prefix2str(&nrn->p,bufn,IN
ET6_ADDRSTRLEN);zlog_debug("%u:%s:EvaluateRNH,type%d%s",vrfid,bufn,type,force?"(
force)":"");}rnh=nrn->info;/*Identifyrouteentry(RE)resolvingthistrackedentry.*/i
f(type==RNH_IMPORT_CHECK_TYPE)re=zebra_rnh_resolve_import_entry(vrfid,family,nrn
,rnh,&prn);elsere=zebra_rnh_resolve_nexthop_entry(vrfid,family,nrn,rnh,&prn);/*I
ftheentrycannotberesolvedandthatisalsotheexistingstate,*thereisnothingfurthertod
o.*/if(!re&&rnh->state==NULL&&!force)return;/*Processbasedontypeofentry.*/if(typ
e==RNH_IMPORT_CHECK_TYPE)zebra_rnh_eval_import_check_entry(vrfid,family,force,nr
n,rnh,re);elsezebra_rnh_eval_nexthop_entry(vrfid,family,force,nrn,rnh,prn,re);}/
**CleartheROUTE_ENTRY_NEXTHOPS_CHANGEDflag*fromthereentries.**Pleasenotewearedoi
ngthis*after*wehave*notifiedtheworldabouteachnexthopasthat*wecanhaveasituationwh
ereonereentry*coversmultiplenexthopsweareinterestedin.*/staticvoidzebra_rnh_clea
r_nhc_flag(vrf_id_tvrfid,intfamily,rnh_type_ttype,structroute_node*nrn){structrn
h*rnh;structroute_entry*re;structroute_node*prn;rnh=nrn->info;/*Identifyrouteent
ry(RIB)resolvingthistrackedentry.*/if(type==RNH_IMPORT_CHECK_TYPE)re=zebra_rnh_r
esolve_import_entry(vrfid,family,nrn,rnh,&prn);elsere=zebra_rnh_resolve_nexthop_
entry(vrfid,family,nrn,rnh,&prn);if(re){UNSET_FLAG(re->status,ROUTE_ENTRY_NEXTHO
PS_CHANGED);UNSET_FLAG(re->status,ROUTE_ENTRY_LABELS_CHANGED);}}/*Evaluatealltra
ckedentries(nexthopsorroutesforimportintoBGP)*ofaparticularVRFandaddress-familyo
raspecificprefix.*/voidzebra_evaluate_rnh(vrf_id_tvrfid,intfamily,intforce,rnh_t
ype_ttype,structprefix*p){structroute_table*rnh_table;structroute_node*nrn;rnh_t
able=get_rnh_table(vrfid,family,type);if(!rnh_table)//unexpectedreturn;if(p){/*E
valuatingaspecificentry,makesureitexists.*/nrn=route_node_lookup(rnh_table,p);if
(nrn&&nrn->info)zebra_rnh_evaluate_entry(vrfid,family,force,type,nrn);if(nrn)rou
te_unlock_node(nrn);}else{/*Evaluateentiretable.*/nrn=route_top(rnh_table);while
(nrn){if(nrn->info)zebra_rnh_evaluate_entry(vrfid,family,force,type,nrn);nrn=rou
te_next(nrn);/*thiswillalsounlocknrn*/}nrn=route_top(rnh_table);while(nrn){if(nr
n->info)zebra_rnh_clear_nhc_flag(vrfid,family,type,nrn);nrn=route_next(nrn);/*th
iswillalsounlocknrn*/}}}voidzebra_print_rnh_table(vrf_id_tvrfid,intaf,structvty*
vty,rnh_type_ttype){structroute_table*table;structroute_node*rn;table=get_rnh_ta
ble(vrfid,af,type);if(!table){zlog_debug("print_rnhs:rnhtablenotfound\n");return
;}for(rn=route_top(table);rn;rn=route_next(rn))if(rn->info)print_rnh(rn,vty);}in
tzebra_cleanup_rnh_client(vrf_id_tvrf_id,intfamily,structzserv*client,rnh_type_t
type){structroute_table*ntable;structroute_node*nrn;structrnh*rnh;if(IS_ZEBRA_DE
BUG_NHT)zlog_debug("%u:Client%sRNHcleanupforfamily%dtype%d",vrf_id,zebra_route_s
tring(client->proto),family,type);ntable=get_rnh_table(vrf_id,family,type);if(!n
table){zlog_debug("cleanup_rnh_client:rnhtablenotfound\n");return-1;}for(nrn=rou
te_top(ntable);nrn;nrn=route_next(nrn)){if(!nrn->info)continue;rnh=nrn->info;zeb
ra_remove_rnh_client(rnh,client,type);}return1;}/***free_state-freeuptherestruct
ureassociatedwiththernh.*/staticvoidfree_state(vrf_id_tvrf_id,structroute_entry*
re,structroute_node*rn){if(!re)return;/*freeREandnexthops*/zebra_deregister_rnh_
static_nexthops(vrf_id,re->ng.nexthop,rn);nexthops_free(re->ng.nexthop);XFREE(MT
YPE_RE,re);}staticvoidcopy_state(structrnh*rnh,structroute_entry*re,structroute_
node*rn){structroute_entry*state;if(rnh->state){free_state(rnh->vrf_id,rnh->stat
e,rn);rnh->state=NULL;}if(!re)return;state=XCALLOC(MTYPE_RE,sizeof(structroute_e
ntry));state->type=re->type;state->distance=re->distance;state->metric=re->metri
c;state->vrf_id=re->vrf_id;route_entry_copy_nexthops(state,re->ng.nexthop);rnh->
state=state;}staticintcompare_state(structroute_entry*r1,structroute_entry*r2){i
f(!r1&&!r2)return0;if((!r1&&r2)||(r1&&!r2))return1;if(r1->distance!=r2->distance
)return1;if(r1->metric!=r2->metric)return1;if(r1->nexthop_num!=r2->nexthop_num)r
eturn1;if(CHECK_FLAG(r1->status,ROUTE_ENTRY_NEXTHOPS_CHANGED)||CHECK_FLAG(r1->st
atus,ROUTE_ENTRY_LABELS_CHANGED))return1;return0;}staticintsend_client(structrnh
*rnh,structzserv*client,rnh_type_ttype,vrf_id_tvrf_id){structstream*s;structrout
e_entry*re;unsignedlongnump;uint8_tnum;structnexthop*nh;structroute_node*rn;intc
md=(type==RNH_IMPORT_CHECK_TYPE)?ZEBRA_IMPORT_CHECK_UPDATE:ZEBRA_NEXTHOP_UPDATE;
rn=rnh->node;re=rnh->state;/*Getoutputstream.*/s=stream_new(ZEBRA_MAX_PACKET_SIZ
);zclient_create_header(s,cmd,vrf_id);stream_putw(s,rn->p.family);switch(rn->p.f
amily){caseAF_INET:stream_putc(s,rn->p.prefixlen);stream_put_in_addr(s,&rn->p.u.
prefix4);break;caseAF_INET6:stream_putc(s,rn->p.prefixlen);stream_put(s,&rn->p.u
.prefix6,IPV6_MAX_BYTELEN);break;default:zlog_err("%s:Unknownfamily(%d)notificat
ionattempted\n",__FUNCTION__,rn->p.family);break;}if(re){stream_putc(s,re->type)
;stream_putw(s,re->instance);stream_putc(s,re->distance);stream_putl(s,re->metri
c);num=0;nump=stream_get_endp(s);stream_putc(s,0);for(nh=re->ng.nexthop;nh;nh=nh
->next)if((CHECK_FLAG(nh->flags,NEXTHOP_FLAG_FIB)||CHECK_FLAG(nh->flags,NEXTHOP_
FLAG_RECURSIVE))&&CHECK_FLAG(nh->flags,NEXTHOP_FLAG_ACTIVE)){stream_putc(s,nh->t
ype);switch(nh->type){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV4_IFINDEX:stream
_put_in_addr(s,&nh->gate.ipv4);stream_putl(s,nh->ifindex);break;caseNEXTHOP_TYPE
_IFINDEX:stream_putl(s,nh->ifindex);break;caseNEXTHOP_TYPE_IPV6:caseNEXTHOP_TYPE
_IPV6_IFINDEX:stream_put(s,&nh->gate.ipv6,16);stream_putl(s,nh->ifindex);break;d
efault:/*donothing*/break;}if(nh->nh_label){stream_putc(s,nh->nh_label->num_labe
ls);if(nh->nh_label->num_labels)stream_put(s,&nh->nh_label->label[0],nh->nh_labe
l->num_labels*sizeof(mpls_label_t));}elsestream_putc(s,0);num++;}stream_putc_at(
s,nump,num);}else{stream_putc(s,0);//typestream_putw(s,0);//instancestream_putc(
s,0);//distancestream_putl(s,0);//metricstream_putc(s,0);//nexthops}stream_putw_
at(s,0,stream_get_endp(s));client->nh_last_upd_time=monotime(NULL);client->last_
write_cmd=cmd;returnzebra_server_send_message(client,s);}staticvoidprint_nh(stru
ctnexthop*nexthop,structvty*vty){charbuf[BUFSIZ];structzebra_ns*zns=zebra_ns_loo
kup(NS_DEFAULT);switch(nexthop->type){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV
4_IFINDEX:vty_out(vty,"via%s",inet_ntoa(nexthop->gate.ipv4));if(nexthop->ifindex
)vty_out(vty,",%s",ifindex2ifname_per_ns(zns,nexthop->ifindex));break;caseNEXTHO
P_TYPE_IPV6:caseNEXTHOP_TYPE_IPV6_IFINDEX:vty_out(vty,"%s",inet_ntop(AF_INET6,&n
exthop->gate.ipv6,buf,BUFSIZ));if(nexthop->ifindex)vty_out(vty,",via%s",ifindex2
ifname_per_ns(zns,nexthop->ifindex));break;caseNEXTHOP_TYPE_IFINDEX:vty_out(vty,
"isdirectlyconnected,%s",ifindex2ifname_per_ns(zns,nexthop->ifindex));break;case
NEXTHOP_TYPE_BLACKHOLE:vty_out(vty,"isdirectlyconnected,Null0");break;default:br
eak;}vty_out(vty,"\n");}staticvoidprint_rnh(structroute_node*rn,structvty*vty){s
tructrnh*rnh;structnexthop*nexthop;structlistnode*node;structzserv*client;charbu
f[BUFSIZ];rnh=rn->info;vty_out(vty,"%s%s\n",inet_ntop(rn->p.family,&rn->p.u.pref
ix,buf,BUFSIZ),CHECK_FLAG(rnh->flags,ZEBRA_NHT_CONNECTED)?"(Connected)":"");if(r
nh->state){vty_out(vty,"resolvedvia%s\n",zebra_route_string(rnh->state->type));f
or(nexthop=rnh->state->ng.nexthop;nexthop;nexthop=nexthop->next)print_nh(nexthop
,vty);}elsevty_out(vty,"unresolved%s\n",CHECK_FLAG(rnh->flags,ZEBRA_NHT_CONNECTE
D)?"(Connected)":"");vty_out(vty,"Clientlist:");for(ALL_LIST_ELEMENTS_RO(rnh->cl
ient_list,node,client))vty_out(vty,"%s(fd%d)%s",zebra_route_string(client->proto
),client->sock,rnh->filtered[client->proto]?"(filtered)":"");if(!list_isempty(rn
h->zebra_static_route_list))vty_out(vty,"zebra%s",rnh->filtered[ZEBRA_ROUTE_STAT
IC]?"(filtered)":"");if(!list_isempty(rnh->zebra_pseudowire_list))vty_out(vty,"z
ebra[pseudowires]");vty_out(vty,"\n");}