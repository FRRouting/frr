/**Addresslinkedlistroutine.*Copyright(C)1997,98KunihiroIshiguro**Thisfileispart
ofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthet
ermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherve
rsion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwi
llbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILIT
YorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Y
oushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seeth
efileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloo
r,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"linklist.h
"#include"if.h"#include"table.h"#include"rib.h"#include"table.h"#include"log.h"#
include"memory.h"#include"zebra_memory.h"#include"vty.h"#include"zebra/debug.h"#
include"zebra/zserv.h"#include"zebra/redistribute.h"#include"zebra/interface.h"#
include"zebra/connected.h"#include"zebra/rtadv.h"#include"zebra/zebra_mpls.h"#in
clude"zebra/debug.h"/*communicatethewithdrawalofaconnectedaddress*/staticvoidcon
nected_withdraw(structconnected*ifc){if(!ifc)return;/*Updateinterfaceaddressinfo
rmationtoprotocoldaemon.*/if(CHECK_FLAG(ifc->conf,ZEBRA_IFC_REAL)){zebra_interfa
ce_address_delete_update(ifc->ifp,ifc);if(ifc->address->family==AF_INET)if_subne
t_delete(ifc->ifp,ifc);connected_down(ifc->ifp,ifc);UNSET_FLAG(ifc->conf,ZEBRA_I
FC_REAL);}/*Theaddressisnotinthekernelanymore,socleartheflag*/UNSET_FLAG(ifc->co
nf,ZEBRA_IFC_QUEUED);if(!CHECK_FLAG(ifc->conf,ZEBRA_IFC_CONFIGURED)){listnode_de
lete(ifc->ifp->connected,ifc);connected_free(ifc);}}staticvoidconnected_announce
(structinterface*ifp,structconnected*ifc){if(!ifc)return;if(!if_is_loopback(ifp)
&&ifc->address->family==AF_INET&&!IS_ZEBRA_IF_VRF(ifp)){if(ifc->address->prefixl
en==32)SET_FLAG(ifc->flags,ZEBRA_IFA_UNNUMBERED);elseUNSET_FLAG(ifc->flags,ZEBRA
_IFA_UNNUMBERED);}listnode_add(ifp->connected,ifc);/*Updateinterfaceaddressinfor
mationtoprotocoldaemon.*/if(ifc->address->family==AF_INET)if_subnet_add(ifp,ifc)
;zebra_interface_address_add_update(ifp,ifc);if(if_is_operative(ifp)){connected_
up(ifp,ifc);}}/*Ifsameinterfaceaddressisalreadyexist...*/structconnected*connect
ed_check(structinterface*ifp,unionprefixconstptrpu){conststructprefix*p=pu.p;str
uctconnected*ifc;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(ifp->connected,nod
e,ifc))if(prefix_same(ifc->address,p))returnifc;returnNULL;}/*same,butwithpeerad
dress*/structconnected*connected_check_ptp(structinterface*ifp,unionprefixconstp
trpu,unionprefixconstptrdu){conststructprefix*p=pu.p;conststructprefix*d=du.p;st
ructconnected*ifc;structlistnode*node;/*ignorebroadcastaddresses*/if(p->prefixle
n!=IPV4_MAX_PREFIXLEN)d=NULL;for(ALL_LIST_ELEMENTS_RO(ifp->connected,node,ifc)){
if(!prefix_same(ifc->address,p))continue;if(!CONNECTED_PEER(ifc)&&!d)returnifc;i
f(CONNECTED_PEER(ifc)&&d&&prefix_same(ifc->destination,d))returnifc;}returnNULL;
}/*Checkiftwoifc'sdescribethesameaddressinthesamestate*/staticintconnected_same(
structconnected*ifc1,structconnected*ifc2){if(ifc1->ifp!=ifc2->ifp)return0;if(if
c1->destination)if(!ifc2->destination)return0;if(ifc2->destination)if(!ifc1->des
tination)return0;if(ifc1->destination&&ifc2->destination)if(!prefix_same(ifc1->d
estination,ifc2->destination))return0;if(ifc1->flags!=ifc2->flags)return0;if(ifc
1->conf!=ifc2->conf)return0;return1;}/*Handlechangestoaddressesandsendtheneccesa
ryannouncements*toclients.*/staticvoidconnected_update(structinterface*ifp,struc
tconnected*ifc){structconnected*current;/*Checksameconnectedroute.*/current=conn
ected_check_ptp(ifp,ifc->address,ifc->destination);if(current){if(CHECK_FLAG(cur
rent->conf,ZEBRA_IFC_CONFIGURED))SET_FLAG(ifc->conf,ZEBRA_IFC_CONFIGURED);/*Avoi
dspuriouswithdraws,thismightbejustthekernel*'reflecting'*backanaddresswehavealre
adyadded.*/if(connected_same(current,ifc)){/*nothingtodo*/connected_free(ifc);re
turn;}/*Cleartheconfiguredflagontheoldifc,soitwillbefreed*by*connectedwithdraw.*
/UNSET_FLAG(current->conf,ZEBRA_IFC_CONFIGURED);connected_withdraw(current);/*im
plicitwithdraw-freebsddoesthis*/}/*Iftheconnectedisneworhaschanged,announceit,if
itisusable*/if(CHECK_FLAG(ifc->conf,ZEBRA_IFC_REAL))connected_announce(ifp,ifc);
}/*Calledfromif_up().*/voidconnected_up(structinterface*ifp,structconnected*ifc)
{afi_tafi;structprefixp;structnexthopnh={.type=NEXTHOP_TYPE_IFINDEX,.ifindex=ifp
->ifindex,.vrf_id=ifp->vrf_id,};if(!CHECK_FLAG(ifc->conf,ZEBRA_IFC_REAL))return;
PREFIX_COPY(&p,CONNECTED_PREFIX(ifc));/*Applymasktothenetwork.*/apply_mask(&p);a
fi=family2afi(p.family);switch(afi){caseAFI_IP:/**Incaseofconnectedaddressis0.0.
0.0/0wetreatittunnel*address.*/if(prefix_ipv4_any((structprefix_ipv4*)&p))return
;break;caseAFI_IP6:#ifndefLINUX/*XXX:Itisalreadydonebyrib_bogus_ipv6withinrib_ad
d*/if(IN6_IS_ADDR_UNSPECIFIED(&p.u.prefix6))return;#endifbreak;default:zlog_warn
("ReceivedunknownAFI:%s",afi2str(afi));return;break;}rib_add(afi,SAFI_UNICAST,if
p->vrf_id,ZEBRA_ROUTE_CONNECT,0,0,&p,NULL,&nh,RT_TABLE_MAIN,ifp->metric,0,0,0);r
ib_add(afi,SAFI_MULTICAST,ifp->vrf_id,ZEBRA_ROUTE_CONNECT,0,0,&p,NULL,&nh,RT_TAB
LE_MAIN,ifp->metric,0,0,0);if(IS_ZEBRA_DEBUG_RIB_DETAILED){charbuf[PREFIX_STRLEN
];zlog_debug("%u:IF%saddress%sadd/up,schedulingRIBprocessing",ifp->vrf_id,ifp->n
ame,prefix2str(&p,buf,sizeof(buf)));}rib_update(ifp->vrf_id,RIB_UPDATE_IF_CHANGE
);/*ScheduleLSPforwardingentriesforprocessing,ifappropriate.*/if(ifp->vrf_id==VR
F_DEFAULT){if(IS_ZEBRA_DEBUG_MPLS){charbuf[PREFIX_STRLEN];zlog_debug("%u:IF%sIP%
saddressadd/up,schedulingMPLSprocessing",ifp->vrf_id,ifp->name,prefix2str(&p,buf
,sizeof(buf)));}mpls_mark_lsps_for_processing(vrf_info_lookup(ifp->vrf_id));}}/*
AddconnectedIPv4routetotheinterface.*/voidconnected_add_ipv4(structinterface*ifp
,intflags,structin_addr*addr,uint8_tprefixlen,structin_addr*broad,constchar*labe
l){structprefix_ipv4*p;structconnected*ifc;if(ipv4_martian(addr))return;/*Makeco
nnectedstructure.*/ifc=connected_new();ifc->ifp=ifp;ifc->flags=flags;/*Ifwegetan
otificationfromthekernel,*wecansafelyassumetheaddressisknowntothekernel*/SET_FLA
G(ifc->conf,ZEBRA_IFC_QUEUED);/*Allocatenewconnectedaddress.*/p=prefix_ipv4_new(
);p->family=AF_INET;p->prefix=*addr;p->prefixlen=CHECK_FLAG(flags,ZEBRA_IFA_PEER
)?IPV4_MAX_PREFIXLEN:prefixlen;ifc->address=(structprefix*)p;/*Ifthereisbroadcas
torpeeraddress.*/if(broad){p=prefix_ipv4_new();p->family=AF_INET;p->prefix=*broa
d;p->prefixlen=prefixlen;ifc->destination=(structprefix*)p;/*validatethedestinat
ionaddress*/if(CONNECTED_PEER(ifc)){if(IPV4_ADDR_SAME(addr,broad))zlog_warn("war
ning:interface%shassamelocalandpeer""address%s,routingprotocolsmaymalfunction",i
fp->name,inet_ntoa(*addr));}else{if(broad->s_addr!=ipv4_broadcast_addr(addr->s_a
ddr,prefixlen)){charbuf[2][INET_ADDRSTRLEN];structin_addrbcalc;bcalc.s_addr=ipv4
_broadcast_addr(addr->s_addr,prefixlen);zlog_warn("warning:interface%sbroadcasta
ddr%s/%d!=""calculated%s,routingprotocolsmaymalfunction",ifp->name,inet_ntop(AF_
INET,broad,buf[0],sizeof(buf[0])),prefixlen,inet_ntop(AF_INET,&bcalc,buf[1],size
of(buf[1])));}}}else{if(CHECK_FLAG(ifc->flags,ZEBRA_IFA_PEER)){zlog_warn("warnin
g:%scalledforinterface%s""withpeerflagset,butnopeeraddresssupplied",__func__,ifp
->name);UNSET_FLAG(ifc->flags,ZEBRA_IFA_PEER);}/*nobroadcastordestinationaddress
wassupplied*/if((prefixlen==IPV4_MAX_PREFIXLEN)&&if_is_pointopoint(ifp))zlog_war
n("warning:PtPinterface%swithaddr%s/%dneedsa""peeraddress",ifp->name,inet_ntoa(*
addr),prefixlen);}/*Labelofthisaddress.*/if(label)ifc->label=XSTRDUP(MTYPE_CONNE
CTED_LABEL,label);/*ForallthatIknowanIPv4addressisalwaysreadywhenwereceive*theno
tification.SoitshouldbesafetosettheREALflaghere.*/SET_FLAG(ifc->conf,ZEBRA_IFC_R
EAL);connected_update(ifp,ifc);}voidconnected_down(structinterface*ifp,structcon
nected*ifc){afi_tafi;structprefixp;structnexthopnh={.type=NEXTHOP_TYPE_IFINDEX,.
ifindex=ifp->ifindex,.vrf_id=ifp->vrf_id,};if(!CHECK_FLAG(ifc->conf,ZEBRA_IFC_RE
AL))return;PREFIX_COPY(&p,CONNECTED_PREFIX(ifc));/*Applymasktothenetwork.*/apply
_mask(&p);afi=family2afi(p.family);switch(afi){caseAFI_IP:/**Incaseofconnectedad
dressis0.0.0.0/0wetreatittunnel*address.*/if(prefix_ipv4_any((structprefix_ipv4*
)&p))return;break;caseAFI_IP6:if(IN6_IS_ADDR_UNSPECIFIED(&p.u.prefix6))return;br
eak;default:zlog_info("UnknownAFI:%s",afi2str(afi));break;}/**Samelogicasforconn
ected_up():pushthechangesintothe*head.*/rib_delete(afi,SAFI_UNICAST,ifp->vrf_id,
ZEBRA_ROUTE_CONNECT,0,0,&p,NULL,&nh,0,0,false,NULL);rib_delete(afi,SAFI_MULTICAS
T,ifp->vrf_id,ZEBRA_ROUTE_CONNECT,0,0,&p,NULL,&nh,0,0,false,NULL);if(IS_ZEBRA_DE
BUG_RIB_DETAILED){charbuf[PREFIX_STRLEN];zlog_debug("%u:IF%sIP%saddressdown,sche
dulingRIBprocessing",ifp->vrf_id,ifp->name,prefix2str(&p,buf,sizeof(buf)));}rib_
update(ifp->vrf_id,RIB_UPDATE_IF_CHANGE);/*ScheduleLSPforwardingentriesforproces
sing,ifappropriate.*/if(ifp->vrf_id==VRF_DEFAULT){if(IS_ZEBRA_DEBUG_MPLS){charbu
f[PREFIX_STRLEN];zlog_debug("%u:IF%sIP%saddressdown,schedulingMPLSprocessing",if
p->vrf_id,ifp->name,prefix2str(&p,buf,sizeof(buf)));}mpls_mark_lsps_for_processi
ng(vrf_info_lookup(ifp->vrf_id));}}staticvoidconnected_delete_helper(structconne
cted*ifc,structprefix*p){structinterface*ifp;if(!ifc)return;ifp=ifc->ifp;connect
ed_withdraw(ifc);if(IS_ZEBRA_DEBUG_RIB_DETAILED){charbuf[PREFIX_STRLEN];zlog_deb
ug("%u:IF%sIP%saddressdel,schedulingRIBprocessing",ifp->vrf_id,ifp->name,prefix2
str(p,buf,sizeof(buf)));}rib_update(ifp->vrf_id,RIB_UPDATE_IF_CHANGE);/*Schedule
LSPforwardingentriesforprocessing,ifappropriate.*/if(ifp->vrf_id==VRF_DEFAULT){i
f(IS_ZEBRA_DEBUG_MPLS){charbuf[PREFIX_STRLEN];zlog_debug("%u:IF%sIP%saddressdele
te,schedulingMPLSprocessing",ifp->vrf_id,ifp->name,prefix2str(p,buf,sizeof(buf))
);}mpls_mark_lsps_for_processing(vrf_info_lookup(ifp->vrf_id));}}/*Deleteconnect
edIPv4routetotheinterface.*/voidconnected_delete_ipv4(structinterface*ifp,intfla
gs,structin_addr*addr,uint8_tprefixlen,structin_addr*broad){structprefixp,d;stru
ctconnected*ifc;memset(&p,0,sizeof(structprefix));p.family=AF_INET;p.u.prefix4=*
addr;p.prefixlen=CHECK_FLAG(flags,ZEBRA_IFA_PEER)?IPV4_MAX_PREFIXLEN:prefixlen;i
f(broad){memset(&d,0,sizeof(structprefix));d.family=AF_INET;d.u.prefix4=*broad;d
.prefixlen=prefixlen;ifc=connected_check_ptp(ifp,&p,&d);}elseifc=connected_check
_ptp(ifp,&p,NULL);connected_delete_helper(ifc,&p);}/*AddconnectedIPv6routetothei
nterface.*/voidconnected_add_ipv6(structinterface*ifp,intflags,structin6_addr*ad
dr,uint8_tprefixlen,constchar*label){structprefix_ipv6*p;structconnected*ifc;if(
ipv6_martian(addr))return;/*Makeconnectedstructure.*/ifc=connected_new();ifc->if
p=ifp;ifc->flags=flags;/*Ifwegetanotificationfromthekernel,*wecansafelyassumethe
addressisknowntothekernel*/SET_FLAG(ifc->conf,ZEBRA_IFC_QUEUED);/*Allocatenewcon
nectedaddress.*/p=prefix_ipv6_new();p->family=AF_INET6;IPV6_ADDR_COPY(&p->prefix
,addr);p->prefixlen=prefixlen;ifc->address=(structprefix*)p;/*Labelofthisaddress
.*/if(label)ifc->label=XSTRDUP(MTYPE_CONNECTED_LABEL,label);/*OnLinux,weonlygeth
erewhenDADiscomplete,thereforewecanset*ZEBRA_IFC_REAL.**OnBSD,therecurrentlydoes
n'tseemtobeawaytocheckfor*completionof*DAD,sowereplicatetheoldbehaviourandsetZEB
RA_IFC_REAL,*althoughDAD*mightstillberunning.*/SET_FLAG(ifc->conf,ZEBRA_IFC_REAL
);connected_update(ifp,ifc);}voidconnected_delete_ipv6(structinterface*ifp,struc
tin6_addr*address,uint8_tprefixlen){structprefixp;structconnected*ifc;memset(&p,
0,sizeof(structprefix));p.family=AF_INET6;memcpy(&p.u.prefix6,address,sizeof(str
uctin6_addr));p.prefixlen=prefixlen;ifc=connected_check(ifp,&p);connected_delete
_helper(ifc,&p);}intconnected_is_unnumbered(structinterface*ifp){structconnected
*connected;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(ifp->connected,node,conn
ected)){if(CHECK_FLAG(connected->conf,ZEBRA_IFC_REAL)&&connected->address->famil
y==AF_INET)returnCHECK_FLAG(connected->flags,ZEBRA_IFA_UNNUMBERED);}return0;}