/*MPLSforwardingtableupdatesusingnetlinkoverGNU/Linuxsystem.*Copyright(C)2016Cum
ulusNetworks,Inc.**ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistrib
uteitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*Fr
eeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisd
istributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpli
edwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPubl
icLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicense
along*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,
Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefHAVE
_NETLINK#include"zebra/rt.h"#include"zebra/rt_netlink.h"#include"zebra/zebra_mpl
s.h"/**InstallLabelForwardingentryintothekernel.*/voidkernel_add_lsp(zebra_lsp_t
*lsp){intret;if(!lsp||!lsp->best_nhlfe){//unexpectedkernel_lsp_pass_fail(lsp,SOU
THBOUND_INSTALL_FAILURE);return;}ret=netlink_mpls_multipath(RTM_NEWROUTE,lsp);ke
rnel_lsp_pass_fail(lsp,(!ret)?SOUTHBOUND_INSTALL_SUCCESS:SOUTHBOUND_INSTALL_FAIL
URE);}/**UpdateLabelForwardingentryinthekernel.ThismeansthattheLabel*forwardinge
ntryisalreadyinstalledandneedsanupdate-eitheranew*pathistobeadded,aninstalledpat
hhaschanged(e.g.,outgoinglabel)*oraninstalledpath(butnotallpaths)hastoberemoved.
*TODO:PerformsaDELfollowedbyADDnow,needtochangetoREPLACE.Note*thatREPLACEwasorig
inallyimplementedforIPv4nexthopsbutremovedas*itwasnotfunctioningwhenmovingfromsw
aptoPHPasthatwassignaled*throughthemetricfield(beforekernel-MPLS).Thisshouldn'tb
eanissue*anylonger,soREPLACEcanbereintroduced.*/voidkernel_upd_lsp(zebra_lsp_t*l
sp){intret;if(!lsp||!lsp->best_nhlfe){//unexpectedkernel_lsp_pass_fail(lsp,SOUTH
BOUND_INSTALL_FAILURE);return;}ret=netlink_mpls_multipath(RTM_NEWROUTE,lsp);kern
el_lsp_pass_fail(lsp,(!ret)?SOUTHBOUND_INSTALL_SUCCESS:SOUTHBOUND_INSTALL_FAILUR
E);}/**DeleteLabelForwardingentryfromthekernel.*/voidkernel_del_lsp(zebra_lsp_t*
lsp){intret;if(!lsp){//unexpectedkernel_lsp_pass_fail(lsp,SOUTHBOUND_DELETE_FAIL
URE);return;}if(!CHECK_FLAG(lsp->flags,LSP_FLAG_INSTALLED)){kernel_lsp_pass_fail
(lsp,SOUTHBOUND_DELETE_FAILURE);return;}ret=netlink_mpls_multipath(RTM_DELROUTE,
lsp);kernel_lsp_pass_fail(lsp,(!ret)?SOUTHBOUND_DELETE_SUCCESS:SOUTHBOUND_DELETE
_FAILURE);}intmpls_kernel_init(void){structstatst;/**CheckiftheMPLSmoduleisloade
dinthekernel.*/if(stat("/proc/sys/net/mpls",&st)!=0)return-1;return0;};#endif/*H
AVE_NETLINK*/