/**ZebraEVPNforVxLANcode*Copyright(C)2016,2017CumulusNetworks,Inc.**Thisfileispa
rtofFRR.**FRRisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofth
eGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,o
r(atyouroption)any*laterversion.**FRRisdistributedinthehopethatitwillbeuseful,bu
t*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFOR
APARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaver
eceivedacopyoftheGNUGeneralPublicLicense*alongwithFRR;seethefileCOPYING.Ifnot,wr
itetotheFree*SoftwareFoundation,Inc.,59TemplePlace-Suite330,Boston,MA*02111-1307
,USA.*/#include<zebra.h>#include"if.h"#include"prefix.h"#include"table.h"#includ
e"memory.h"#include"log.h"#include"linklist.h"#include"stream.h"#include"hash.h"
#include"jhash.h"#include"vlan.h"#include"vxlan.h"#include"zebra/rib.h"#include"
zebra/rt.h"#include"zebra/zebra_ns.h"#include"zebra/zserv.h"#include"zebra/debug
.h"#include"zebra/interface.h"#include"zebra/zebra_vrf.h"#include"zebra/rt_netli
nk.h"#include"zebra/zebra_vxlan_private.h"#include"zebra/zebra_vxlan.h"#include"
zebra/zebra_memory.h"#include"zebra/zebra_l2.h"DEFINE_MTYPE_STATIC(ZEBRA,HOST_PR
EFIX,"hostprefix");DEFINE_MTYPE_STATIC(ZEBRA,ZVNI,"VNIhash");DEFINE_MTYPE_STATIC
(ZEBRA,ZL3VNI,"L3VNIhash");DEFINE_MTYPE_STATIC(ZEBRA,ZVNI_VTEP,"VNIremoteVTEP");
DEFINE_MTYPE_STATIC(ZEBRA,MAC,"VNIMAC");DEFINE_MTYPE_STATIC(ZEBRA,NEIGH,"VNINeig
hbor");/*definitions*//*staticfunctiondeclarations*/staticintip_prefix_send_to_c
lient(vrf_id_tvrf_id,structprefix*p,uint16_tcmd);staticvoidzvni_print_neigh(zebr
a_neigh_t*n,void*ctxt,json_object*json);staticvoidzvni_print_neigh_hash(structha
sh_backet*backet,void*ctxt);staticvoidzvni_print_neigh_hash_all_vni(structhash_b
acket*backet,void**args);staticvoidzl3vni_print_nh(zebra_neigh_t*n,structvty*vty
,json_object*json);staticvoidzl3vni_print_rmac(zebra_mac_t*zrmac,structvty*vty,j
son_object*json);staticvoidzvni_print_mac(zebra_mac_t*mac,void*ctxt);staticvoidz
vni_print_mac_hash(structhash_backet*backet,void*ctxt);staticvoidzvni_print_mac_
hash_all_vni(structhash_backet*backet,void*ctxt);staticvoidzvni_print(zebra_vni_
t*zvni,void**ctxt);staticvoidzvni_print_hash(structhash_backet*backet,void*ctxt[
]);staticintzvni_macip_send_msg_to_client(vni_tvni,structethaddr*macaddr,structi
paddr*ip,uint8_tflags,uint16_tcmd);staticunsignedintneigh_hash_keymake(void*p);s
taticintneigh_cmp(constvoid*p1,constvoid*p2);staticvoid*zvni_neigh_alloc(void*p)
;staticzebra_neigh_t*zvni_neigh_add(zebra_vni_t*zvni,structipaddr*ip,structethad
dr*mac);staticintzvni_neigh_del(zebra_vni_t*zvni,zebra_neigh_t*n);staticintzvni_
neigh_del_hash_entry(structhash_backet*backet,void*arg);staticvoidzvni_neigh_del
_from_vtep(zebra_vni_t*zvni,intuninstall,structin_addr*r_vtep_ip);staticvoidzvni
_neigh_del_all(zebra_vni_t*zvni,intuninstall,intupd_client,uint32_tflags);static
zebra_neigh_t*zvni_neigh_lookup(zebra_vni_t*zvni,structipaddr*ip);staticintzvni_
neigh_send_add_to_client(vni_tvni,structipaddr*ip,structethaddr*macaddr,uint8_tf
lags);staticintzvni_neigh_send_del_to_client(vni_tvni,structipaddr*ip,structetha
ddr*macaddr,uint8_tflags);staticintzvni_neigh_install(zebra_vni_t*zvni,zebra_nei
gh_t*n);staticintzvni_neigh_uninstall(zebra_vni_t*zvni,zebra_neigh_t*n);staticze
bra_vni_t*zvni_from_svi(structinterface*ifp,structinterface*br_if);staticstructi
nterface*zvni_map_to_svi(vlanid_tvid,structinterface*br_if);/*l3-vninext-hopneig
hrelatedAPIs*/staticzebra_neigh_t*zl3vni_nh_lookup(zebra_l3vni_t*zl3vni,structip
addr*ip);staticvoid*zl3vni_nh_alloc(void*p);staticzebra_neigh_t*zl3vni_nh_add(ze
bra_l3vni_t*zl3vni,structipaddr*vtep_ip,structethaddr*rmac);staticintzl3vni_nh_d
el(zebra_l3vni_t*zl3vni,zebra_neigh_t*n);staticintzl3vni_nh_install(zebra_l3vni_
t*zl3vni,zebra_neigh_t*n);staticintzl3vni_nh_uninstall(zebra_l3vni_t*zl3vni,zebr
a_neigh_t*n);/*l3-vnirmacrelatedAPIs*/staticvoidzl3vni_print_rmac_hash(structhas
h_backet*,void*);staticzebra_mac_t*zl3vni_rmac_lookup(zebra_l3vni_t*zl3vni,struc
tethaddr*rmac);staticvoid*zl3vni_rmac_alloc(void*p);staticzebra_mac_t*zl3vni_rma
c_add(zebra_l3vni_t*zl3vni,structethaddr*rmac);staticintzl3vni_rmac_del(zebra_l3
vni_t*zl3vni,zebra_mac_t*zrmac);staticintzl3vni_rmac_install(zebra_l3vni_t*zl3vn
i,zebra_mac_t*zrmac);staticintzl3vni_rmac_uninstall(zebra_l3vni_t*zl3vni,zebra_m
ac_t*zrmac);/*l3-vnirelatedAPIs*/staticzebra_l3vni_t*zl3vni_lookup(vni_tvni);sta
ticvoid*zl3vni_alloc(void*p);staticzebra_l3vni_t*zl3vni_add(vni_tvni,vrf_id_tvrf
_id);staticintzl3vni_del(zebra_l3vni_t*zl3vni);staticzebra_l3vni_t*zl3vni_from_v
rf(vrf_id_t);staticstructinterface*zl3vni_map_to_svi_if(zebra_l3vni_t*zl3vni);st
aticstructinterface*zl3vni_map_to_vxlan_if(zebra_l3vni_t*zl3vni);staticvoidzebra
_vxlan_process_l3vni_oper_up(zebra_l3vni_t*zl3vni);staticvoidzebra_vxlan_process
_l3vni_oper_down(zebra_l3vni_t*zl3vni);staticunsignedintmac_hash_keymake(void*p)
;staticintmac_cmp(constvoid*p1,constvoid*p2);staticvoid*zvni_mac_alloc(void*p);s
taticzebra_mac_t*zvni_mac_add(zebra_vni_t*zvni,structethaddr*macaddr);staticintz
vni_mac_del(zebra_vni_t*zvni,zebra_mac_t*mac);staticintzvni_mac_del_hash_entry(s
tructhash_backet*backet,void*arg);staticvoidzvni_mac_del_from_vtep(zebra_vni_t*z
vni,intuninstall,structin_addr*r_vtep_ip);staticvoidzvni_mac_del_all(zebra_vni_t
*zvni,intuninstall,intupd_client,uint32_tflags);staticzebra_mac_t*zvni_mac_looku
p(zebra_vni_t*zvni,structethaddr*macaddr);staticintzvni_mac_send_add_to_client(v
ni_tvni,structethaddr*macaddr,uint8_tflags);staticintzvni_mac_send_del_to_client
(vni_tvni,structethaddr*macaddr,uint8_tflags);staticzebra_vni_t*zvni_map_vlan(st
ructinterface*ifp,structinterface*br_if,vlanid_tvid);staticintzvni_mac_install(z
ebra_vni_t*zvni,zebra_mac_t*mac);staticintzvni_mac_uninstall(zebra_vni_t*zvni,ze
bra_mac_t*mac,intlocal);staticvoidzvni_install_mac_hash(structhash_backet*backet
,void*ctxt);staticunsignedintvni_hash_keymake(void*p);staticintvni_hash_cmp(cons
tvoid*p1,constvoid*p2);staticvoid*zvni_alloc(void*p);staticzebra_vni_t*zvni_look
up(vni_tvni);staticzebra_vni_t*zvni_add(vni_tvni);staticintzvni_del(zebra_vni_t*
zvni);staticintzvni_send_add_to_client(zebra_vni_t*zvni);staticintzvni_send_del_
to_client(vni_tvni);staticvoidzvni_build_hash_table();staticintzvni_vtep_match(s
tructin_addr*vtep_ip,zebra_vtep_t*zvtep);staticzebra_vtep_t*zvni_vtep_find(zebra
_vni_t*zvni,structin_addr*vtep_ip);staticzebra_vtep_t*zvni_vtep_add(zebra_vni_t*
zvni,structin_addr*vtep_ip);staticintzvni_vtep_del(zebra_vni_t*zvni,zebra_vtep_t
*zvtep);staticintzvni_vtep_del_all(zebra_vni_t*zvni,intuninstall);staticintzvni_
vtep_install(zebra_vni_t*zvni,structin_addr*vtep_ip);staticintzvni_vtep_uninstal
l(zebra_vni_t*zvni,structin_addr*vtep_ip);staticintzvni_del_macip_for_intf(struc
tinterface*ifp,zebra_vni_t*zvni);staticintzvni_add_macip_for_intf(structinterfac
e*ifp,zebra_vni_t*zvni);staticintzvni_gw_macip_add(structinterface*ifp,zebra_vni
_t*zvni,structethaddr*macaddr,structipaddr*ip);staticintzvni_gw_macip_del(struct
interface*ifp,zebra_vni_t*zvni,structipaddr*ip);structinterface*zebra_get_vrr_in
tf_for_svi(structinterface*ifp);staticintadvertise_gw_macip_enabled(zebra_vni_t*
zvni);staticvoidzvni_deref_ip2mac(zebra_vni_t*zvni,zebra_mac_t*mac,intuninstall)
;/*Privatefunctions*//**ReturnnumberofvalidMACsinaVNI'sMAChashtable-all*remoteMA
Csandnon-internal(auto)localMACscount.*/staticuint32_tnum_valid_macs(zebra_vni_t
*zvni){unsignedinti;uint32_tnum_macs=0;structhash*hash;structhash_backet*hb;zebr
a_mac_t*mac;hash=zvni->mac_table;if(!hash)returnnum_macs;for(i=0;i<hash->size;i+
+){for(hb=hash->index[i];hb;hb=hb->next){mac=(zebra_mac_t*)hb->data;if(CHECK_FLA
G(mac->flags,ZEBRA_MAC_REMOTE)||!CHECK_FLAG(mac->flags,ZEBRA_MAC_AUTO))num_macs+
+;}}returnnum_macs;}staticintadvertise_gw_macip_enabled(zebra_vni_t*zvni){struct
zebra_vrf*zvrf;zvrf=vrf_info_lookup(VRF_DEFAULT);if(zvrf&&zvrf->advertise_gw_mac
ip)return1;if(zvni&&zvni->advertise_gw_macip)return1;return0;}/**Helperfunctiont
odeterminemaximumwidthofneighborIPaddressfor*display-justbecausewe'redealingwith
IPv6addressesthatcan*widelyvary.*/staticvoidzvni_find_neigh_addr_width(structhas
h_backet*backet,void*ctxt){zebra_neigh_t*n;charbuf[INET6_ADDRSTRLEN];structneigh
_walk_ctx*wctx=ctxt;intwidth;n=(zebra_neigh_t*)backet->data;if(!n)return;ipaddr2
str(&n->ip,buf,sizeof(buf)),width=strlen(buf);if(width>wctx->addr_width)wctx->ad
dr_width=width;}/**Printaspecificneighborentry.*/staticvoidzvni_print_neigh(zebr
a_neigh_t*n,void*ctxt,json_object*json){structvty*vty;charbuf1[ETHER_ADDR_STRLEN
];charbuf2[INET6_ADDRSTRLEN];ipaddr2str(&n->ip,buf2,sizeof(buf2));prefix_mac2str
(&n->emac,buf1,sizeof(buf1));vty=(structvty*)ctxt;if(json==NULL){vty_out(vty,"IP
:%s\n",ipaddr2str(&n->ip,buf2,sizeof(buf2)));vty_out(vty,"MAC:%s",prefix_mac2str
(&n->emac,buf1,sizeof(buf1)));}else{json_object_string_add(json,"ip",buf2);json_
object_string_add(json,"mac",buf1);}if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_REMOTE)){
if(json==NULL){vty_out(vty,"RemoteVTEP:%s",inet_ntoa(n->r_vtep_ip));}elsejson_ob
ject_string_add(json,"remoteVtep",inet_ntoa(n->r_vtep_ip));}if(CHECK_FLAG(n->fla
gs,ZEBRA_NEIGH_LOCAL)){if(!json){vty_out(vty,"\n");vty_out(vty,"State:%s",IS_ZEB
RA_NEIGH_ACTIVE(n)?"Active":"Inactive");}}if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_DEF
_GW)){if(!json)vty_out(vty,"Default-gateway");elsejson_object_boolean_true_add(j
son,"defaultGateway");}if(json==NULL)vty_out(vty,"\n");}/**Printneighborhashentr
y-calledfordisplayofallneighbors.*/staticvoidzvni_print_neigh_hash(structhash_ba
cket*backet,void*ctxt){structvty*vty;json_object*json_vni=NULL,*json_row=NULL;ze
bra_neigh_t*n;charbuf1[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];structneigh
_walk_ctx*wctx=ctxt;vty=wctx->vty;json_vni=wctx->json;n=(zebra_neigh_t*)backet->
data;if(!n)return;if(json_vni)json_row=json_object_new_object();prefix_mac2str(&
n->emac,buf1,sizeof(buf1));ipaddr2str(&n->ip,buf2,sizeof(buf2));if(CHECK_FLAG(n-
>flags,ZEBRA_NEIGH_LOCAL)&&!(wctx->flags&SHOW_REMOTE_NEIGH_FROM_VTEP)){if(json_v
ni==NULL){vty_out(vty,"%*s%-6s%-17s\n",-wctx->addr_width,buf2,"local",buf1);}els
e{json_object_string_add(json_row,"type","local");json_object_string_add(json_ro
w,"mac",buf1);}wctx->count++;}else{if(wctx->flags&SHOW_REMOTE_NEIGH_FROM_VTEP){i
f(IPV4_ADDR_SAME(&n->r_vtep_ip,&wctx->r_vtep_ip)){if(json_vni==NULL){if(wctx->co
unt==0)vty_out(vty,"%*s%-6s%-17s%-21s\n",-wctx->addr_width,"Neighbor","Type","MA
C","RemoteVTEP");vty_out(vty,"%*s%-6s%-17s%-21s\n",-wctx->addr_width,buf2,"remot
e",buf1,inet_ntoa(n->r_vtep_ip));}else{json_object_string_add(json_row,"type","r
emote");json_object_string_add(json_row,"mac",buf1);json_object_string_add(json_
row,"remoteVtep",inet_ntoa(n->r_vtep_ip));}wctx->count++;}}else{if(json_vni==NUL
L){vty_out(vty,"%*s%-6s%-17s%-21s\n",-wctx->addr_width,buf2,"remote",buf1,inet_n
toa(n->r_vtep_ip));}else{json_object_string_add(json_row,"type","remote");json_o
bject_string_add(json_row,"mac",buf1);json_object_string_add(json_row,"remoteVte
p",inet_ntoa(n->r_vtep_ip));}wctx->count++;}}if(json_vni)json_object_object_add(
json_vni,buf2,json_row);}/**PrintneighborsforallVNI.*/staticvoidzvni_print_neigh
_hash_all_vni(structhash_backet*backet,void**args){structvty*vty;json_object*jso
n=NULL,*json_vni=NULL;zebra_vni_t*zvni;uint32_tnum_neigh;structneigh_walk_ctxwct
x;charvni_str[VNI_STR_LEN];vty=(structvty*)args[0];json=(json_object*)args[1];zv
ni=(zebra_vni_t*)backet->data;if(!zvni){if(json)vty_out(vty,"{}\n");return;}num_
neigh=hashcount(zvni->neigh_table);if(json==NULL)vty_out(vty,"\nVNI%u#ARP(IPv4an
dIPv6,localandremote)%u\n\n",zvni->vni,num_neigh);else{json_vni=json_object_new_
object();json_object_int_add(json_vni,"numArpNd",num_neigh);snprintf(vni_str,VNI
_STR_LEN,"%u",zvni->vni);}if(!num_neigh){if(json)json_object_object_add(json,vni
_str,json_vni);return;}/*SincewehaveIPv6addressestodealwithwhichcanvarywidelyin*
size,wetrytobeabitmoreelegantindisplaybyfirstcomputing*themaximumwidth.*/memset(
&wctx,0,sizeof(structneigh_walk_ctx));wctx.zvni=zvni;wctx.vty=vty;wctx.addr_widt
h=15;wctx.json=json_vni;hash_iterate(zvni->neigh_table,zvni_find_neigh_addr_widt
h,&wctx);if(json==NULL)vty_out(vty,"%*s%-6s%-17s%-21s\n",-wctx.addr_width,"IP","
Type","MAC","RemoteVTEP");hash_iterate(zvni->neigh_table,zvni_print_neigh_hash,&
wctx);if(json)json_object_object_add(json,vni_str,json_vni);}/*printaspecificnex
thopforanl3vni*/staticvoidzl3vni_print_nh(zebra_neigh_t*n,structvty*vty,json_obj
ect*json){charbuf1[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];structlistnode*
node=NULL;structprefix*p=NULL;json_object*json_hosts=NULL;if(!json){vty_out(vty,
"Ip:%s\n",ipaddr2str(&n->ip,buf2,sizeof(buf2)));vty_out(vty,"RMAC:%s\n",prefix_m
ac2str(&n->emac,buf1,sizeof(buf1)));vty_out(vty,"Refcount:%d\n",listcount(n->hos
t_list));vty_out(vty,"Prefixes:\n");for(ALL_LIST_ELEMENTS_RO(n->host_list,node,p
))vty_out(vty,"%s\n",prefix2str(p,buf2,sizeof(buf2)));}else{json_hosts=json_obje
ct_new_array();json_object_string_add(json,"ip",ipaddr2str(&(n->ip),buf2,sizeof(
buf2)));json_object_string_add(json,"routerMac",prefix_mac2str(&n->emac,buf2,siz
eof(buf2)));json_object_int_add(json,"refCount",listcount(n->host_list));for(ALL
_LIST_ELEMENTS_RO(n->host_list,node,p))json_object_array_add(json_hosts,json_obj
ect_new_string(prefix2str(p,buf2,sizeof(buf2))));json_object_object_add(json,"pr
efixList",json_hosts);}}/*PrintaspecificRMACentry*/staticvoidzl3vni_print_rmac(z
ebra_mac_t*zrmac,structvty*vty,json_object*json){charbuf1[ETHER_ADDR_STRLEN];cha
rbuf2[PREFIX_STRLEN];structlistnode*node=NULL;structprefix*p=NULL;json_object*js
on_hosts=NULL;if(!json){vty_out(vty,"MAC:%s\n",prefix_mac2str(&zrmac->macaddr,bu
f1,sizeof(buf1)));vty_out(vty,"RemoteVTEP:%s\n",inet_ntoa(zrmac->fwd_info.r_vtep
_ip));vty_out(vty,"Refcount:%d\n",listcount(zrmac->host_list));vty_out(vty,"Pref
ixes:\n");for(ALL_LIST_ELEMENTS_RO(zrmac->host_list,node,p))vty_out(vty,"%s\n",p
refix2str(p,buf2,sizeof(buf2)));}else{json_hosts=json_object_new_array();json_ob
ject_string_add(json,"routerMac",prefix_mac2str(&zrmac->macaddr,buf1,sizeof(buf1
)));json_object_string_add(json,"vtepIp",inet_ntoa(zrmac->fwd_info.r_vtep_ip));j
son_object_int_add(json,"refCount",listcount(zrmac->host_list));for(ALL_LIST_ELE
MENTS_RO(zrmac->host_list,node,p))json_object_array_add(json_hosts,json_object_n
ew_string(prefix2str(p,buf2,sizeof(buf2))));json_object_object_add(json,"prefixL
ist",json_hosts);}}/**PrintaspecificMACentry.*/staticvoidzvni_print_mac(zebra_ma
c_t*mac,void*ctxt){structvty*vty;zebra_neigh_t*n=NULL;structlistnode*node=NULL;c
harbuf1[20];charbuf2[INET6_ADDRSTRLEN];vty=(structvty*)ctxt;vty_out(vty,"MAC:%s"
,prefix_mac2str(&mac->macaddr,buf1,sizeof(buf1)));if(CHECK_FLAG(mac->flags,ZEBRA
_MAC_LOCAL)){structzebra_ns*zns;structinterface*ifp;ifindex_tifindex;ifindex=mac
->fwd_info.local.ifindex;zns=zebra_ns_lookup(NS_DEFAULT);ifp=if_lookup_by_index_
per_ns(zns,ifindex);if(!ifp)//unexpectedreturn;vty_out(vty,"Intf:%s(%u)",ifp->na
me,ifindex);if(mac->fwd_info.local.vid)vty_out(vty,"VLAN:%u",mac->fwd_info.local
.vid);}elseif(CHECK_FLAG(mac->flags,ZEBRA_MAC_REMOTE)){vty_out(vty,"RemoteVTEP:%
s",inet_ntoa(mac->fwd_info.r_vtep_ip));}elseif(CHECK_FLAG(mac->flags,ZEBRA_MAC_A
UTO)){vty_out(vty,"AutoMac");}if(CHECK_FLAG(mac->flags,ZEBRA_MAC_STICKY))vty_out
(vty,"StickyMac");if(CHECK_FLAG(mac->flags,ZEBRA_MAC_DEF_GW))vty_out(vty,"Defaul
t-gatewayMac");vty_out(vty,"\n");/*printalltheassociatedneigh*/vty_out(vty,"Neig
hbors:\n");if(!listcount(mac->neigh_list))vty_out(vty,"NoNeighbors\n");else{for(
ALL_LIST_ELEMENTS_RO(mac->neigh_list,node,n)){vty_out(vty,"%s%s\n",ipaddr2str(&n
->ip,buf2,sizeof(buf2)),CHECK_FLAG(n->flags,ZEBRA_MAC_LOCAL)?(IS_ZEBRA_NEIGH_ACT
IVE(n)?"Active":"Inactive"):"");}}vty_out(vty,"\n");}/**PrintMAChashentry-called
fordisplayofallMACs.*/staticvoidzvni_print_mac_hash(structhash_backet*backet,voi
d*ctxt){structvty*vty;json_object*json_mac_hdr=NULL,*json_mac=NULL;zebra_mac_t*m
ac;charbuf1[20];structmac_walk_ctx*wctx=ctxt;vty=wctx->vty;json_mac_hdr=wctx->js
on;mac=(zebra_mac_t*)backet->data;if(!mac)return;prefix_mac2str(&mac->macaddr,bu
f1,sizeof(buf1));if(json_mac_hdr)json_mac=json_object_new_object();if(CHECK_FLAG
(mac->flags,ZEBRA_MAC_LOCAL)&&!(wctx->flags&SHOW_REMOTE_MAC_FROM_VTEP)){structze
bra_ns*zns;ifindex_tifindex;structinterface*ifp;vlanid_tvid;zns=zebra_ns_lookup(
NS_DEFAULT);ifindex=mac->fwd_info.local.ifindex;ifp=if_lookup_by_index_per_ns(zn
s,ifindex);if(!ifp)//unexpectedreturn;vid=mac->fwd_info.local.vid;if(json_mac_hd
r==NULL)vty_out(vty,"%-17s%-6s%-21s",buf1,"local",ifp->name);else{json_object_st
ring_add(json_mac,"type","local");json_object_string_add(json_mac,"intf",ifp->na
me);}if(vid){if(json_mac_hdr==NULL)vty_out(vty,"%-5u",vid);elsejson_object_int_a
dd(json_mac,"vlan",vid);}if(json_mac_hdr==NULL)vty_out(vty,"\n");elsejson_object
_object_add(json_mac_hdr,buf1,json_mac);wctx->count++;}elseif(CHECK_FLAG(mac->fl
ags,ZEBRA_MAC_REMOTE)){if(wctx->flags&SHOW_REMOTE_MAC_FROM_VTEP){if(IPV4_ADDR_SA
ME(&mac->fwd_info.r_vtep_ip,&wctx->r_vtep_ip)){if(wctx->count==0){if(json_mac_hd
r==NULL){vty_out(vty,"\nVNI%u\n\n",wctx->zvni->vni);vty_out(vty,"%-17s%-6s%-21s%
-5s\n","MAC","Type","Intf/RemoteVTEP","VLAN");}}if(json_mac_hdr==NULL)vty_out(vt
y,"%-17s%-6s%-21s\n",buf1,"remote",inet_ntoa(mac->fwd_info.r_vtep_ip));else{json
_object_string_add(json_mac,"type","remote");json_object_string_add(json_mac,"re
moteVtep",inet_ntoa(mac->fwd_info.r_vtep_ip));json_object_object_add(json_mac_hd
r,buf1,json_mac);}wctx->count++;}}else{if(json_mac_hdr==NULL)vty_out(vty,"%-17s%
-6s%-21s\n",buf1,"remote",inet_ntoa(mac->fwd_info.r_vtep_ip));else{json_object_s
tring_add(json_mac,"type","remote");json_object_string_add(json_mac,"remoteVtep"
,inet_ntoa(mac->fwd_info.r_vtep_ip));json_object_object_add(json_mac_hdr,buf1,js
on_mac);}wctx->count++;}}}/**PrintMACsforallVNI.*/staticvoidzvni_print_mac_hash_
all_vni(structhash_backet*backet,void*ctxt){structvty*vty;json_object*json=NULL,
*json_vni=NULL;json_object*json_mac=NULL;zebra_vni_t*zvni;uint32_tnum_macs;struc
tmac_walk_ctx*wctx=ctxt;charvni_str[VNI_STR_LEN];vty=(structvty*)wctx->vty;json=
(structjson_object*)wctx->json;zvni=(zebra_vni_t*)backet->data;if(!zvni){if(json
)vty_out(vty,"{}\n");return;}wctx->zvni=zvni;/*WeareiteratingoveranewVNI,setthec
ountto0*/wctx->count=0;num_macs=num_valid_macs(zvni);if(!num_macs)return;if(json
){json_vni=json_object_new_object();json_mac=json_object_new_object();snprintf(v
ni_str,VNI_STR_LEN,"%u",zvni->vni);}if(!CHECK_FLAG(wctx->flags,SHOW_REMOTE_MAC_F
ROM_VTEP)){if(json==NULL){vty_out(vty,"\nVNI%u#MACs(localandremote)%u\n\n",zvni-
>vni,num_macs);vty_out(vty,"%-17s%-6s%-21s%-5s\n","MAC","Type","Intf/RemoteVTEP"
,"VLAN");}elsejson_object_int_add(json_vni,"numMacs",num_macs);}/*assignper-vnit
owctx->jsonobjecttofillmacs*underthevni.Re-assignprimaryjsonobjecttofill*nextvni
information.*/wctx->json=json_mac;hash_iterate(zvni->mac_table,zvni_print_mac_ha
sh,wctx);wctx->json=json;if(json){if(wctx->count)json_object_object_add(json_vni
,"macs",json_mac);json_object_object_add(json,vni_str,json_vni);}}staticvoidzl3v
ni_print_nh_hash(structhash_backet*backet,void*ctx){structnh_walk_ctx*wctx=NULL;
structvty*vty=NULL;structjson_object*json_vni=NULL;structjson_object*json_nh=NUL
L;zebra_neigh_t*n=NULL;charbuf1[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];wc
tx=(structnh_walk_ctx*)ctx;vty=wctx->vty;json_vni=wctx->json;if(json_vni)json_nh
=json_object_new_object();n=(zebra_neigh_t*)backet->data;if(!n)return;if(!json_v
ni){vty_out(vty,"%-15s%-17s\n",ipaddr2str(&(n->ip),buf2,sizeof(buf2)),prefix_mac
2str(&n->emac,buf1,sizeof(buf1)));}else{json_object_string_add(json_nh,"nexthopI
p",ipaddr2str(&n->ip,buf2,sizeof(buf2)));json_object_string_add(json_nh,"routerM
ac",prefix_mac2str(&n->emac,buf1,sizeof(buf1)));json_object_object_add(json_vni,
ipaddr2str(&(n->ip),buf2,sizeof(buf2)),json_nh);}}staticvoidzl3vni_print_nh_hash
_all_vni(structhash_backet*backet,void**args){structvty*vty=NULL;json_object*jso
n=NULL;json_object*json_vni=NULL;zebra_l3vni_t*zl3vni=NULL;uint32_tnum_nh=0;stru
ctnh_walk_ctxwctx;charvni_str[VNI_STR_LEN];vty=(structvty*)args[0];json=(structj
son_object*)args[1];zl3vni=(zebra_l3vni_t*)backet->data;if(!zl3vni){if(json)vty_
out(vty,"{}\n");return;}num_nh=hashcount(zl3vni->nh_table);if(!num_nh)return;if(
json){json_vni=json_object_new_object();snprintf(vni_str,VNI_STR_LEN,"%u",zl3vni
->vni);}if(json==NULL){vty_out(vty,"\nVNI%u#Next-Hops%u\n\n",zl3vni->vni,num_nh)
;vty_out(vty,"%-15s%-17s\n","IP","RMAC");}elsejson_object_int_add(json_vni,"numN
extHops",num_nh);memset(&wctx,0,sizeof(structnh_walk_ctx));wctx.vty=vty;wctx.jso
n=json_vni;hash_iterate(zl3vni->nh_table,zl3vni_print_nh_hash,&wctx);if(json)jso
n_object_object_add(json,vni_str,json_vni);}staticvoidzl3vni_print_rmac_hash_all
_vni(structhash_backet*backet,void**args){structvty*vty=NULL;json_object*json=NU
LL;json_object*json_vni=NULL;zebra_l3vni_t*zl3vni=NULL;uint32_tnum_rmacs;structr
mac_walk_ctxwctx;charvni_str[VNI_STR_LEN];vty=(structvty*)args[0];json=(structjs
on_object*)args[1];zl3vni=(zebra_l3vni_t*)backet->data;if(!zl3vni){if(json)vty_o
ut(vty,"{}\n");return;}num_rmacs=hashcount(zl3vni->rmac_table);if(!num_rmacs)ret
urn;if(json){json_vni=json_object_new_object();snprintf(vni_str,VNI_STR_LEN,"%u"
,zl3vni->vni);}if(json==NULL){vty_out(vty,"\nVNI%u#RMACs%u\n\n",zl3vni->vni,num_
rmacs);vty_out(vty,"%-17s%-21s\n","RMAC","RemoteVTEP");}elsejson_object_int_add(
json_vni,"numRmacs",num_rmacs);/*assignper-vnitowctx->jsonobjecttofillmacs*under
thevni.Re-assignprimaryjsonobjecttofill*nextvniinformation.*/memset(&wctx,0,size
of(structrmac_walk_ctx));wctx.vty=vty;wctx.json=json_vni;hash_iterate(zl3vni->rm
ac_table,zl3vni_print_rmac_hash,&wctx);if(json)json_object_object_add(json,vni_s
tr,json_vni);}staticvoidzl3vni_print_rmac_hash(structhash_backet*backet,void*ctx
){zebra_mac_t*zrmac=NULL;structrmac_walk_ctx*wctx=NULL;structvty*vty=NULL;struct
json_object*json=NULL;structjson_object*json_rmac=NULL;charbuf[ETHER_ADDR_STRLEN
];wctx=(structrmac_walk_ctx*)ctx;vty=wctx->vty;json=wctx->json;if(json)json_rmac
=json_object_new_object();zrmac=(zebra_mac_t*)backet->data;if(!zrmac)return;if(!
json){vty_out(vty,"%-17s%-21s\n",prefix_mac2str(&zrmac->macaddr,buf,sizeof(buf))
,inet_ntoa(zrmac->fwd_info.r_vtep_ip));}else{json_object_string_add(json_rmac,"r
outerMac",prefix_mac2str(&zrmac->macaddr,buf,sizeof(buf)));json_object_string_ad
d(json_rmac,"vtepIp",inet_ntoa(zrmac->fwd_info.r_vtep_ip));json_object_object_ad
d(json,prefix_mac2str(&zrmac->macaddr,buf,sizeof(buf)),json_rmac);}}/*printaspec
ificL3VNIentry*/staticvoidzl3vni_print(zebra_l3vni_t*zl3vni,void**ctx){charbuf[E
THER_ADDR_STRLEN];structvty*vty=NULL;json_object*json=NULL;zebra_vni_t*zvni=NULL
;json_object*json_vni_list=NULL;structlistnode*node=NULL,*nnode=NULL;vty=ctx[0];
json=ctx[1];if(!json){vty_out(vty,"VNI:%u\n",zl3vni->vni);vty_out(vty,"Type:%s\n
","L3");vty_out(vty,"TenantVRF:%s\n",zl3vni_vrf_name(zl3vni));vty_out(vty,"Local
VtepIp:%s\n",inet_ntoa(zl3vni->local_vtep_ip));vty_out(vty,"Vxlan-Intf:%s\n",zl3
vni_vxlan_if_name(zl3vni));vty_out(vty,"SVI-If:%s\n",zl3vni_svi_if_name(zl3vni))
;vty_out(vty,"State:%s\n",zl3vni_state2str(zl3vni));vty_out(vty,"VNIFilter:%s\n"
,CHECK_FLAG(zl3vni->filter,PREFIX_ROUTES_ONLY)?"prefix-routes-only":"none");vty_
out(vty,"RouterMAC:%s\n",zl3vni_rmac2str(zl3vni,buf,sizeof(buf)));vty_out(vty,"L
2VNIs:");for(ALL_LIST_ELEMENTS(zl3vni->l2vnis,node,nnode,zvni))vty_out(vty,"%u",
zvni->vni);vty_out(vty,"\n");}else{json_vni_list=json_object_new_array();json_ob
ject_int_add(json,"vni",zl3vni->vni);json_object_string_add(json,"type","L3");js
on_object_string_add(json,"localVtepIp",inet_ntoa(zl3vni->local_vtep_ip));json_o
bject_string_add(json,"vxlanIntf",zl3vni_vxlan_if_name(zl3vni));json_object_stri
ng_add(json,"sviIntf",zl3vni_svi_if_name(zl3vni));json_object_string_add(json,"s
tate",zl3vni_state2str(zl3vni));json_object_string_add(json,"vrf",zl3vni_vrf_nam
e(zl3vni));json_object_string_add(json,"routerMac",zl3vni_rmac2str(zl3vni,buf,si
zeof(buf)));json_object_string_add(json,"vniFilter",CHECK_FLAG(zl3vni->filter,PR
EFIX_ROUTES_ONLY)?"prefix-routes-only":"none");for(ALL_LIST_ELEMENTS(zl3vni->l2v
nis,node,nnode,zvni)){json_object_array_add(json_vni_list,json_object_new_int(zv
ni->vni));}json_object_object_add(json,"l2Vnis",json_vni_list);}}/**Printaspecif
icVNIentry.*/staticvoidzvni_print(zebra_vni_t*zvni,void**ctxt){structvty*vty;zeb
ra_vtep_t*zvtep;uint32_tnum_macs;uint32_tnum_neigh;json_object*json=NULL;json_ob
ject*json_vtep_list=NULL;json_object*json_ip_str=NULL;vty=ctxt[0];json=ctxt[1];i
f(json==NULL){vty_out(vty,"VNI:%u\n",zvni->vni);vty_out(vty,"Type:%s\n","L2");vt
y_out(vty,"TenantVRF:%s\n",vrf_id_to_name(zvni->vrf_id));}else{json_object_int_a
dd(json,"vni",zvni->vni);json_object_string_add(json,"type","L2");json_object_st
ring_add(json,"vrf",vrf_id_to_name(zvni->vrf_id));}if(!zvni->vxlan_if){//unexpec
tedif(json==NULL)vty_out(vty,"VxLANinterface:unknown\n");return;}num_macs=num_va
lid_macs(zvni);num_neigh=hashcount(zvni->neigh_table);if(json==NULL){vty_out(vty
,"VxLANinterface:%s\n",zvni->vxlan_if->name);vty_out(vty,"VxLANifIndex:%u\n",zvn
i->vxlan_if->ifindex);vty_out(vty,"LocalVTEPIP:%s\n",inet_ntoa(zvni->local_vtep_
ip));}else{json_object_string_add(json,"vxlanInterface",zvni->vxlan_if->name);js
on_object_int_add(json,"ifindex",zvni->vxlan_if->ifindex);json_object_string_add
(json,"vtepIp",inet_ntoa(zvni->local_vtep_ip));json_object_string_add(json,"adve
rtiseGatewayMacip",zvni->advertise_gw_macip?"Yes":"No");json_object_int_add(json
,"numMacs",num_macs);json_object_int_add(json,"numArpNd",num_neigh);}if(!zvni->v
teps){if(json==NULL)vty_out(vty,"NoremoteVTEPsknownforthisVNI\n");}else{if(json=
=NULL)vty_out(vty,"RemoteVTEPsforthisVNI:\n");elsejson_vtep_list=json_object_new
_array();for(zvtep=zvni->vteps;zvtep;zvtep=zvtep->next){if(json==NULL)vty_out(vt
y,"%s\n",inet_ntoa(zvtep->vtep_ip));else{json_ip_str=json_object_new_string(inet
_ntoa(zvtep->vtep_ip));json_object_array_add(json_vtep_list,json_ip_str);}}if(js
on)json_object_object_add(json,"numRemoteVteps",json_vtep_list);}if(json==NULL){
vty_out(vty,"NumberofMACs(localandremote)knownforthisVNI:%u\n",num_macs);vty_out
(vty,"NumberofARPs(IPv4andIPv6,localandremote)""knownforthisVNI:%u\n",num_neigh)
;vty_out(vty,"Advertise-gw-macip:%s\n",zvni->advertise_gw_macip?"Yes":"No");}}/*
printaL3VNIhashentry*/staticvoidzl3vni_print_hash(structhash_backet*backet,void*
ctx[]){structvty*vty=NULL;json_object*json=NULL;json_object*json_vni=NULL;zebra_
l3vni_t*zl3vni=NULL;vty=(structvty*)ctx[0];json=(json_object*)ctx[1];zl3vni=(zeb
ra_l3vni_t*)backet->data;if(!zl3vni)return;if(!json){vty_out(vty,"%-10u%-4s%-21s
%-8lu%-8lu%-15s%-37s\n",zl3vni->vni,"L3",zl3vni_vxlan_if_name(zl3vni),hashcount(
zl3vni->rmac_table),hashcount(zl3vni->nh_table),"n/a",zl3vni_vrf_name(zl3vni));}
else{charvni_str[VNI_STR_LEN];snprintf(vni_str,VNI_STR_LEN,"%u",zl3vni->vni);jso
n_vni=json_object_new_object();json_object_int_add(json_vni,"vni",zl3vni->vni);j
son_object_string_add(json_vni,"vxlanIf",zl3vni_vxlan_if_name(zl3vni));json_obje
ct_int_add(json_vni,"numMacs",hashcount(zl3vni->rmac_table));json_object_int_add
(json_vni,"numArpNd",hashcount(zl3vni->nh_table));json_object_string_add(json_vn
i,"numRemoteVteps","n/a");json_object_string_add(json_vni,"type","L3");json_obje
ct_string_add(json_vni,"tenantVrf",zl3vni_vrf_name(zl3vni));json_object_object_a
dd(json,vni_str,json_vni);}}/**PrintaVNIhashentry-calledfordisplayofallVNIs.*/st
aticvoidzvni_print_hash(structhash_backet*backet,void*ctxt[]){structvty*vty;zebr
a_vni_t*zvni;zebra_vtep_t*zvtep;uint32_tnum_vteps=0;uint32_tnum_macs=0;uint32_tn
um_neigh=0;json_object*json=NULL;json_object*json_vni=NULL;json_object*json_ip_s
tr=NULL;json_object*json_vtep_list=NULL;vty=ctxt[0];json=ctxt[1];zvni=(zebra_vni
_t*)backet->data;if(!zvni)return;zvtep=zvni->vteps;while(zvtep){num_vteps++;zvte
p=zvtep->next;}num_macs=num_valid_macs(zvni);num_neigh=hashcount(zvni->neigh_tab
le);if(json==NULL)vty_out(vty,"%-10u%-4s%-21s%-8u%-8u%-15u%-37s\n",zvni->vni,"L2
",zvni->vxlan_if?zvni->vxlan_if->name:"unknown",num_macs,num_neigh,num_vteps,vrf
_id_to_name(zvni->vrf_id));else{charvni_str[VNI_STR_LEN];snprintf(vni_str,VNI_ST
R_LEN,"%u",zvni->vni);json_vni=json_object_new_object();json_object_int_add(json
_vni,"vni",zvni->vni);json_object_string_add(json_vni,"type","L2");json_object_s
tring_add(json_vni,"vxlanIf",zvni->vxlan_if?zvni->vxlan_if->name:"unknown");json
_object_int_add(json_vni,"numMacs",num_macs);json_object_int_add(json_vni,"numAr
pNd",num_neigh);json_object_int_add(json_vni,"numRemoteVteps",num_vteps);json_ob
ject_string_add(json_vni,"tenantVrf",vrf_id_to_name(zvni->vrf_id));if(num_vteps)
{json_vtep_list=json_object_new_array();for(zvtep=zvni->vteps;zvtep;zvtep=zvtep-
>next){json_ip_str=json_object_new_string(inet_ntoa(zvtep->vtep_ip));json_object
_array_add(json_vtep_list,json_ip_str);}json_object_object_add(json_vni,"remoteV
teps",json_vtep_list);}json_object_object_add(json,vni_str,json_vni);}}/**Inform
BGPaboutlocalMACIP.*/staticintzvni_macip_send_msg_to_client(vni_tvni,structethad
dr*macaddr,structipaddr*ip,uint8_tflags,uint16_tcmd){charbuf[ETHER_ADDR_STRLEN];
charbuf2[INET6_ADDRSTRLEN];intipa_len;structzserv*client=NULL;structstream*s=NUL
L;client=zebra_find_client(ZEBRA_ROUTE_BGP,0);/*BGPmaynotberunning.*/if(!client)
return0;s=stream_new(ZEBRA_MAX_PACKET_SIZ);zclient_create_header(s,cmd,VRF_DEFAU
LT);stream_putl(s,vni);stream_put(s,macaddr->octet,ETH_ALEN);if(ip){ipa_len=0;if
(IS_IPADDR_V4(ip))ipa_len=IPV4_MAX_BYTELEN;elseif(IS_IPADDR_V6(ip))ipa_len=IPV6_
MAX_BYTELEN;stream_putl(s,ipa_len);/*IPaddresslength*/if(ipa_len)stream_put(s,&i
p->ip.addr,ipa_len);/*IPaddress*/}elsestream_putl(s,0);/*JustMAC.*/stream_putc(s
,flags);/*stickymac/gatewaymac*//*Writepacketsize.*/stream_putw_at(s,0,stream_ge
t_endp(s));if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("SendMACIP%sflags0x%xMAC%sIP%sL2-V
NI%uto%s",(cmd==ZEBRA_MACIP_ADD)?"Add":"Del",flags,prefix_mac2str(macaddr,buf,si
zeof(buf)),ipaddr2str(ip,buf2,sizeof(buf2)),vni,zebra_route_string(client->proto
));if(cmd==ZEBRA_MACIP_ADD)client->macipadd_cnt++;elseclient->macipdel_cnt++;ret
urnzebra_server_send_message(client,s);}/**Makehashkeyforneighbors.*/staticunsig
nedintneigh_hash_keymake(void*p){zebra_neigh_t*n=p;structipaddr*ip=&n->ip;if(IS_
IPADDR_V4(ip))returnjhash_1word(ip->ipaddr_v4.s_addr,0);returnjhash2(ip->ipaddr_
v6.s6_addr32,ZEBRA_NUM_OF(ip->ipaddr_v6.s6_addr32),0);}/**Comparetwoneighborhash
structures.*/staticintneigh_cmp(constvoid*p1,constvoid*p2){constzebra_neigh_t*n1
=p1;constzebra_neigh_t*n2=p2;if(n1==NULL&&n2==NULL)return1;if(n1==NULL||n2==NULL
)return0;return(memcmp(&n1->ip,&n2->ip,sizeof(structipaddr))==0);}/**Callbacktoa
llocateneighborhashentry.*/staticvoid*zvni_neigh_alloc(void*p){constzebra_neigh_
t*tmp_n=p;zebra_neigh_t*n;n=XCALLOC(MTYPE_NEIGH,sizeof(zebra_neigh_t));*n=*tmp_n
;return((void*)n);}/**Addneighborentry.*/staticzebra_neigh_t*zvni_neigh_add(zebr
a_vni_t*zvni,structipaddr*ip,structethaddr*mac){zebra_neigh_ttmp_n;zebra_neigh_t
*n=NULL;zebra_mac_t*zmac=NULL;memset(&tmp_n,0,sizeof(zebra_neigh_t));memcpy(&tmp
_n.ip,ip,sizeof(structipaddr));n=hash_get(zvni->neigh_table,&tmp_n,zvni_neigh_al
loc);assert(n);memcpy(&n->emac,mac,ETH_ALEN);n->state=ZEBRA_NEIGH_INACTIVE;/*Ass
ociatetheneightomac*/zmac=zvni_mac_lookup(zvni,mac);if(zmac)listnode_add_sort(zm
ac->neigh_list,n);returnn;}/**Deleteneighborentry.*/staticintzvni_neigh_del(zebr
a_vni_t*zvni,zebra_neigh_t*n){zebra_neigh_t*tmp_n;zebra_mac_t*zmac=NULL;zmac=zvn
i_mac_lookup(zvni,&n->emac);if(zmac)listnode_delete(zmac->neigh_list,n);/*Freeth
eVNIhashentryandallocatedmemory.*/tmp_n=hash_release(zvni->neigh_table,n);if(tmp
_n)XFREE(MTYPE_NEIGH,tmp_n);return0;}/**Freeneighborhashentry(callback)*/statici
ntzvni_neigh_del_hash_entry(structhash_backet*backet,void*arg){structneigh_walk_
ctx*wctx=arg;zebra_neigh_t*n=backet->data;if(((wctx->flags&DEL_LOCAL_NEIGH)&&(n-
>flags&ZEBRA_NEIGH_LOCAL))||((wctx->flags&DEL_REMOTE_NEIGH)&&(n->flags&ZEBRA_NEI
GH_REMOTE))||((wctx->flags&DEL_REMOTE_NEIGH_FROM_VTEP)&&(n->flags&ZEBRA_NEIGH_RE
MOTE)&&IPV4_ADDR_SAME(&n->r_vtep_ip,&wctx->r_vtep_ip))){if(wctx->upd_client&&(n-
>flags&ZEBRA_NEIGH_LOCAL))zvni_neigh_send_del_to_client(wctx->zvni->vni,&n->ip,&
n->emac,0);if(wctx->uninstall)zvni_neigh_uninstall(wctx->zvni,n);returnzvni_neig
h_del(wctx->zvni,n);}return0;}/**DeleteallneighborentriesfromspecificVTEPforapar
ticularVNI.*/staticvoidzvni_neigh_del_from_vtep(zebra_vni_t*zvni,intuninstall,st
ructin_addr*r_vtep_ip){structneigh_walk_ctxwctx;if(!zvni->neigh_table)return;mem
set(&wctx,0,sizeof(structneigh_walk_ctx));wctx.zvni=zvni;wctx.uninstall=uninstal
l;wctx.flags=DEL_REMOTE_NEIGH_FROM_VTEP;wctx.r_vtep_ip=*r_vtep_ip;hash_iterate(z
vni->neigh_table,(void(*)(structhash_backet*,void*))zvni_neigh_del_hash_entry,&w
ctx);}/**DeleteallneighborentriesforthisVNI.*/staticvoidzvni_neigh_del_all(zebra
_vni_t*zvni,intuninstall,intupd_client,uint32_tflags){structneigh_walk_ctxwctx;i
f(!zvni->neigh_table)return;memset(&wctx,0,sizeof(structneigh_walk_ctx));wctx.zv
ni=zvni;wctx.uninstall=uninstall;wctx.upd_client=upd_client;wctx.flags=flags;has
h_iterate(zvni->neigh_table,(void(*)(structhash_backet*,void*))zvni_neigh_del_ha
sh_entry,&wctx);}/**Lookupneighborhashentry.*/staticzebra_neigh_t*zvni_neigh_loo
kup(zebra_vni_t*zvni,structipaddr*ip){zebra_neigh_ttmp;zebra_neigh_t*n;memset(&t
mp,0,sizeof(tmp));memcpy(&tmp.ip,ip,sizeof(structipaddr));n=hash_lookup(zvni->ne
igh_table,&tmp);returnn;}/*Processallneighassociatedtoamacuponlocalmacaddevent*/
staticvoidzvni_process_neigh_on_local_mac_add(zebra_vni_t*zvni,zebra_mac_t*zmac)
{zebra_neigh_t*n=NULL;structlistnode*node=NULL;charbuf[ETHER_ADDR_STRLEN];charbu
f2[INET6_ADDRSTRLEN];for(ALL_LIST_ELEMENTS_RO(zmac->neigh_list,node,n)){if(CHECK
_FLAG(n->flags,ZEBRA_NEIGH_LOCAL)){/*MACislearntlocally,programallinactiveneigh*
pointingtothismac*/if(IS_ZEBRA_NEIGH_INACTIVE(n)){if(IS_ZEBRA_DEBUG_VXLAN)zlog_d
ebug("neigh%s(MAC%s)onL2-VNI%uisnowACTIVE",ipaddr2str(&n->ip,buf2,sizeof(buf2)),
prefix_mac2str(&n->emac,buf,sizeof(buf)),zvni->vni);ZEBRA_NEIGH_SET_ACTIVE(n);zv
ni_neigh_send_add_to_client(zvni->vni,&n->ip,&n->emac,n->flags);}else{if(IS_ZEBR
A_DEBUG_VXLAN)zlog_debug("neigh%s(MAC%s)onVNI%ushouldNOTbeACTIVE",ipaddr2str(&n-
>ip,buf2,sizeof(buf2)),prefix_mac2str(&n->emac,buf,sizeof(buf)),zvni->vni);}}els
eif(CHECK_FLAG(n->flags,ZEBRA_NEIGH_REMOTE)){/*TODO:assumetheneighhasmovedtoo??*
/}}}/*Processallneighassociatedtoamacuponlocalmacdelevent*/staticvoidzvni_proces
s_neigh_on_local_mac_del(zebra_vni_t*zvni,zebra_mac_t*zmac){zebra_neigh_t*n=NULL
;structlistnode*node=NULL;charbuf[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];
for(ALL_LIST_ELEMENTS_RO(zmac->neigh_list,node,n)){if(CHECK_FLAG(n->flags,ZEBRA_
NEIGH_LOCAL)){if(IS_ZEBRA_NEIGH_ACTIVE(n)){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("n
eigh%s(MAC%s)onL2-VNI%uisnowINACTIVE",ipaddr2str(&n->ip,buf2,sizeof(buf2)),prefi
x_mac2str(&n->emac,buf,sizeof(buf)),zvni->vni);ZEBRA_NEIGH_SET_INACTIVE(n);zvni_
neigh_send_del_to_client(zvni->vni,&n->ip,&n->emac,0);}}elseif(CHECK_FLAG(n->fla
gs,ZEBRA_NEIGH_REMOTE)){if(IS_ZEBRA_DEBUG_VXLAN)zlog_err("localMAC%sgettingdelet
edonVNI%uhasremoteneigh%s",prefix_mac2str(&n->emac,buf,sizeof(buf)),zvni->vni,ip
addr2str(&n->ip,buf2,sizeof(buf2)));}}}/*processallneighassociatedtoamacentryupo
nremotemacadd*/staticvoidzvni_process_neigh_on_remote_mac_add(zebra_vni_t*zvni,z
ebra_mac_t*zmac){zebra_neigh_t*n=NULL;structlistnode*node=NULL;charbuf[ETHER_ADD
R_STRLEN];charbuf2[INET6_ADDRSTRLEN];for(ALL_LIST_ELEMENTS_RO(zmac->neigh_list,n
ode,n)){if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_LOCAL)){if(IS_ZEBRA_NEIGH_ACTIVE(n)){
if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("neigh%s(MAC%s)onL2-VNI%uisnowINACTIVE",ipadd
r2str(&n->ip,buf2,sizeof(buf2)),prefix_mac2str(&n->emac,buf,sizeof(buf)),zvni->v
ni);ZEBRA_NEIGH_SET_INACTIVE(n);zvni_neigh_send_del_to_client(zvni->vni,&n->ip,&
n->emac,0);}}}}/*processallneighassociatedtomacentryuponremotemacdel*/staticvoid
zvni_process_neigh_on_remote_mac_del(zebra_vni_t*zvni,zebra_mac_t*zmac){zebra_ne
igh_t*n=NULL;structlistnode*node=NULL;charbuf[ETHER_ADDR_STRLEN];charbuf2[INET6_
ADDRSTRLEN];for(ALL_LIST_ELEMENTS_RO(zmac->neigh_list,node,n)){if(CHECK_FLAG(n->
flags,ZEBRA_NEIGH_LOCAL)){if(IS_ZEBRA_DEBUG_VXLAN)zlog_err("remoteMAC%sgettingde
letedonVNI%uhaslocalneigh%s",prefix_mac2str(&n->emac,buf,sizeof(buf)),zvni->vni,
ipaddr2str(&n->ip,buf2,sizeof(buf2)));}}}/**InformBGPaboutlocalneighboraddition.
*/staticintzvni_neigh_send_add_to_client(vni_tvni,structipaddr*ip,structethaddr*
macaddr,uint8_tneigh_flags){uint8_tflags=0;if(CHECK_FLAG(neigh_flags,ZEBRA_NEIGH
_DEF_GW))SET_FLAG(flags,ZEBRA_MACIP_TYPE_GW);returnzvni_macip_send_msg_to_client
(vni,macaddr,ip,flags,ZEBRA_MACIP_ADD);}/**InformBGPaboutlocalneighbordeletion.*
/staticintzvni_neigh_send_del_to_client(vni_tvni,structipaddr*ip,structethaddr*m
acaddr,uint8_tflags){returnzvni_macip_send_msg_to_client(vni,macaddr,ip,flags,ZE
BRA_MACIP_DEL);}/**Installremoteneighborintothekernel.*/staticintzvni_neigh_inst
all(zebra_vni_t*zvni,zebra_neigh_t*n){structzebra_if*zif;structzebra_l2info_vxla
n*vxl;structinterface*vlan_if;if(!(n->flags&ZEBRA_NEIGH_REMOTE))return0;zif=zvni
->vxlan_if->info;if(!zif)return-1;vxl=&zif->l2info.vxl;vlan_if=zvni_map_to_svi(v
xl->access_vlan,zif->brslave_info.br_if);if(!vlan_if)return-1;returnkernel_add_n
eigh(vlan_if,&n->ip,&n->emac);}/**Uninstallremoteneighborfromthekernel.*/statici
ntzvni_neigh_uninstall(zebra_vni_t*zvni,zebra_neigh_t*n){structzebra_if*zif;stru
ctzebra_l2info_vxlan*vxl;structinterface*vlan_if;if(!(n->flags&ZEBRA_NEIGH_REMOT
E))return0;if(!zvni->vxlan_if){zlog_err("VNI%uhash%pcouldn'tbeuninstalled-nointf
",zvni->vni,zvni);return-1;}zif=zvni->vxlan_if->info;if(!zif)return-1;vxl=&zif->
l2info.vxl;vlan_if=zvni_map_to_svi(vxl->access_vlan,zif->brslave_info.br_if);if(
!vlan_if)return-1;returnkernel_del_neigh(vlan_if,&n->ip);}/**Installneighborhash
entry-calleduponaccessVLANchange.*/staticvoidzvni_install_neigh_hash(structhash_
backet*backet,void*ctxt){zebra_neigh_t*n;structneigh_walk_ctx*wctx=ctxt;n=(zebra
_neigh_t*)backet->data;if(!n)return;if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_REMOTE))z
vni_neigh_install(wctx->zvni,n);}/*GettheVRRinterfaceforSVIifany*/structinterfac
e*zebra_get_vrr_intf_for_svi(structinterface*ifp){structzebra_vrf*zvrf=NULL;stru
ctinterface*tmp_if=NULL;structzebra_if*zif=NULL;zvrf=vrf_info_lookup(ifp->vrf_id
);assert(zvrf);FOR_ALL_INTERFACES(zvrf->vrf,tmp_if){zif=tmp_if->info;if(!zif)con
tinue;if(!IS_ZEBRA_IF_MACVLAN(tmp_if))continue;if(zif->link==ifp)returntmp_if;}r
eturnNULL;}staticintzvni_del_macip_for_intf(structinterface*ifp,zebra_vni_t*zvni
){structlistnode*cnode=NULL,*cnnode=NULL;structconnected*c=NULL;structethaddrmac
addr;memcpy(&macaddr.octet,ifp->hw_addr,ETH_ALEN);for(ALL_LIST_ELEMENTS(ifp->con
nected,cnode,cnnode,c)){structipaddrip;memset(&ip,0,sizeof(structipaddr));if(!CH
ECK_FLAG(c->conf,ZEBRA_IFC_REAL))continue;if(c->address->family==AF_INET){ip.ipa
_type=IPADDR_V4;memcpy(&(ip.ipaddr_v4),&(c->address->u.prefix4),sizeof(structin_
addr));}elseif(c->address->family==AF_INET6){ip.ipa_type=IPADDR_V6;memcpy(&(ip.i
paddr_v6),&(c->address->u.prefix6),sizeof(structin6_addr));}else{continue;}zvni_
gw_macip_del(ifp,zvni,&ip);}return0;}staticintzvni_add_macip_for_intf(structinte
rface*ifp,zebra_vni_t*zvni){structlistnode*cnode=NULL,*cnnode=NULL;structconnect
ed*c=NULL;structethaddrmacaddr;memcpy(&macaddr.octet,ifp->hw_addr,ETH_ALEN);for(
ALL_LIST_ELEMENTS(ifp->connected,cnode,cnnode,c)){structipaddrip;memset(&ip,0,si
zeof(structipaddr));if(!CHECK_FLAG(c->conf,ZEBRA_IFC_REAL))continue;if(c->addres
s->family==AF_INET){ip.ipa_type=IPADDR_V4;memcpy(&(ip.ipaddr_v4),&(c->address->u
.prefix4),sizeof(structin_addr));}elseif(c->address->family==AF_INET6){ip.ipa_ty
pe=IPADDR_V6;memcpy(&(ip.ipaddr_v6),&(c->address->u.prefix6),sizeof(structin6_ad
dr));}else{continue;}zvni_gw_macip_add(ifp,zvni,&macaddr,&ip);}return0;}staticin
tzvni_advertise_subnet(zebra_vni_t*zvni,structinterface*ifp,intadvertise){struct
listnode*cnode=NULL,*cnnode=NULL;structconnected*c=NULL;structethaddrmacaddr;mem
cpy(&macaddr.octet,ifp->hw_addr,ETH_ALEN);for(ALL_LIST_ELEMENTS(ifp->connected,c
node,cnnode,c)){structprefixp;memcpy(&p,c->address,sizeof(structprefix));/*skipl
inklocaladdress*/if(IN6_IS_ADDR_LINKLOCAL(&p.u.prefix6))continue;apply_mask(&p);
if(advertise)ip_prefix_send_to_client(ifp->vrf_id,&p,ZEBRA_IP_PREFIX_ROUTE_ADD);
elseip_prefix_send_to_client(ifp->vrf_id,&p,ZEBRA_IP_PREFIX_ROUTE_DEL);}return0;
}/**zvni_gw_macip_add_to_client*/staticintzvni_gw_macip_add(structinterface*ifp,
zebra_vni_t*zvni,structethaddr*macaddr,structipaddr*ip){charbuf[ETHER_ADDR_STRLE
N];charbuf2[INET6_ADDRSTRLEN];zebra_neigh_t*n=NULL;zebra_mac_t*mac=NULL;structze
bra_if*zif=NULL;structzebra_l2info_vxlan*vxl=NULL;zif=zvni->vxlan_if->info;if(!z
if)return-1;vxl=&zif->l2info.vxl;mac=zvni_mac_lookup(zvni,macaddr);if(!mac){mac=
zvni_mac_add(zvni,macaddr);if(!mac){zlog_err("FailedtoaddMAC%sintf%s(%u)VID%u",p
refix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex,vxl->access_vlan);
return-1;}}/*Set"local"forwardinginfo.*/SET_FLAG(mac->flags,ZEBRA_MAC_LOCAL);SET
_FLAG(mac->flags,ZEBRA_MAC_AUTO);SET_FLAG(mac->flags,ZEBRA_MAC_DEF_GW);memset(&m
ac->fwd_info,0,sizeof(mac->fwd_info));mac->fwd_info.local.ifindex=ifp->ifindex;m
ac->fwd_info.local.vid=vxl->access_vlan;n=zvni_neigh_lookup(zvni,ip);if(!n){n=zv
ni_neigh_add(zvni,ip,macaddr);if(!n){zlog_err("Failedtoaddneighbor%sMAC%sintf%s(
%u)->VNI%u",ipaddr2str(ip,buf2,sizeof(buf2)),prefix_mac2str(macaddr,buf,sizeof(b
uf)),ifp->name,ifp->ifindex,zvni->vni);return-1;}}/*Set"local"forwardinginfo.*/S
ET_FLAG(n->flags,ZEBRA_NEIGH_LOCAL);SET_FLAG(n->flags,ZEBRA_NEIGH_DEF_GW);memcpy
(&n->emac,macaddr,ETH_ALEN);n->ifindex=ifp->ifindex;/*OnlyadvertiseinBGPifthekno
bisenabled*/if(!advertise_gw_macip_enabled(zvni))return0;if(IS_ZEBRA_DEBUG_VXLAN
)zlog_debug("SVI%s(%u)L2-VNI%u,sendingGWMAC%sIP%saddtoBGP",ifp->name,ifp->ifinde
x,zvni->vni,prefix_mac2str(macaddr,buf,sizeof(buf)),ipaddr2str(ip,buf2,sizeof(bu
f2)));zvni_neigh_send_add_to_client(zvni->vni,ip,macaddr,n->flags);return0;}/**z
vni_gw_macip_del_from_client*/staticintzvni_gw_macip_del(structinterface*ifp,zeb
ra_vni_t*zvni,structipaddr*ip){charbuf1[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRST
RLEN];zebra_neigh_t*n=NULL;zebra_mac_t*mac=NULL;/*Iftheneighentryisnotpresentnot
hingtodo*/n=zvni_neigh_lookup(zvni,ip);if(!n)return0;/*macentryshouldbepresent*/
mac=zvni_mac_lookup(zvni,&n->emac);if(!mac){zlog_err("MAC%sdoesntexistsforneigh%
sonVNI%u",prefix_mac2str(&n->emac,buf1,sizeof(buf1)),ipaddr2str(ip,buf2,sizeof(b
uf2)),zvni->vni);return-1;}/*Iftheentryisnotlocalnothingtodo*/if(!CHECK_FLAG(n->
flags,ZEBRA_NEIGH_LOCAL))return-1;/*onlyneedtodeletetheentryfrombgpifwesentitbef
ore*/if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("%u:SVI%s(%u)VNI%u,sendingGWMAC%sIP%sdel
toBGP",ifp->vrf_id,ifp->name,ifp->ifindex,zvni->vni,prefix_mac2str(&(n->emac),NU
LL,ETHER_ADDR_STRLEN),ipaddr2str(ip,buf2,sizeof(buf2)));/*RemoveneighborfromBGP.
*/zvni_neigh_send_del_to_client(zvni->vni,&n->ip,&n->emac,ZEBRA_MACIP_TYPE_GW);/
*Deletethisneighborentry.*/zvni_neigh_del(zvni,n);/*seeifthemacneedstobedeleteda
swell*/if(mac)zvni_deref_ip2mac(zvni,mac,0);return0;}staticvoidzvni_gw_macip_del
_for_vni_hash(structhash_backet*backet,void*ctxt){zebra_vni_t*zvni=NULL;structze
bra_if*zif=NULL;structzebra_l2info_vxlanzl2_info;structinterface*vlan_if=NULL;st
ructinterface*vrr_if=NULL;structinterface*ifp;/*AddprimarySVIMAC*/zvni=(zebra_vn
i_t*)backet->data;if(!zvni)return;ifp=zvni->vxlan_if;if(!ifp)return;zif=ifp->inf
o;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_operative(ifp)||!zif->brsla
ve_info.br_if)return;zl2_info=zif->l2info.vxl;vlan_if=zvni_map_to_svi(zl2_info.a
ccess_vlan,zif->brslave_info.br_if);if(!vlan_if)return;/*DelprimaryMAC-IP*/zvni_
del_macip_for_intf(vlan_if,zvni);/*DelVRRMAC-IP-ifany*/vrr_if=zebra_get_vrr_intf
_for_svi(vlan_if);if(vrr_if)zvni_del_macip_for_intf(vrr_if,zvni);return;}staticv
oidzvni_gw_macip_add_for_vni_hash(structhash_backet*backet,void*ctxt){zebra_vni_
t*zvni=NULL;structzebra_if*zif=NULL;structzebra_l2info_vxlanzl2_info;structinter
face*vlan_if=NULL;structinterface*vrr_if=NULL;structinterface*ifp=NULL;zvni=(zeb
ra_vni_t*)backet->data;if(!zvni)return;ifp=zvni->vxlan_if;if(!ifp)return;zif=ifp
->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_operative(ifp)||!zif->
brslave_info.br_if)return;zl2_info=zif->l2info.vxl;vlan_if=zvni_map_to_svi(zl2_i
nfo.access_vlan,zif->brslave_info.br_if);if(!vlan_if)return;/*AddprimarySVIMAC-I
P*/zvni_add_macip_for_intf(vlan_if,zvni);/*AddVRRMAC-IP-ifany*/vrr_if=zebra_get_
vrr_intf_for_svi(vlan_if);if(vrr_if)zvni_add_macip_for_intf(vrr_if,zvni);return;
}/**MakehashkeyforMAC.*/staticunsignedintmac_hash_keymake(void*p){zebra_mac_t*pm
ac=p;constvoid*pnt=(void*)pmac->macaddr.octet;returnjhash(pnt,ETH_ALEN,0xa5a5a55
a);}/**ComparetwoMACaddresses.*/staticintmac_cmp(constvoid*p1,constvoid*p2){cons
tzebra_mac_t*pmac1=p1;constzebra_mac_t*pmac2=p2;if(pmac1==NULL&&pmac2==NULL)retu
rn1;if(pmac1==NULL||pmac2==NULL)return0;return(memcmp(pmac1->macaddr.octet,pmac2
->macaddr.octet,ETH_ALEN)==0);}/**CallbacktoallocateMAChashentry.*/staticvoid*zv
ni_mac_alloc(void*p){constzebra_mac_t*tmp_mac=p;zebra_mac_t*mac;mac=XCALLOC(MTYP
E_MAC,sizeof(zebra_mac_t));*mac=*tmp_mac;return((void*)mac);}/**AddMACentry.*/st
aticzebra_mac_t*zvni_mac_add(zebra_vni_t*zvni,structethaddr*macaddr){zebra_mac_t
tmp_mac;zebra_mac_t*mac=NULL;memset(&tmp_mac,0,sizeof(zebra_mac_t));memcpy(&tmp_
mac.macaddr,macaddr,ETH_ALEN);mac=hash_get(zvni->mac_table,&tmp_mac,zvni_mac_all
oc);assert(mac);mac->neigh_list=list_new();mac->neigh_list->cmp=(int(*)(void*,vo
id*))neigh_cmp;returnmac;}/**DeleteMACentry.*/staticintzvni_mac_del(zebra_vni_t*
zvni,zebra_mac_t*mac){zebra_mac_t*tmp_mac;list_delete_and_null(&mac->neigh_list)
;/*FreetheVNIhashentryandallocatedmemory.*/tmp_mac=hash_release(zvni->mac_table,
mac);if(tmp_mac)XFREE(MTYPE_MAC,tmp_mac);return0;}/**FreeMAChashentry(callback)*
/staticintzvni_mac_del_hash_entry(structhash_backet*backet,void*arg){structmac_w
alk_ctx*wctx=arg;zebra_mac_t*mac=backet->data;if(((wctx->flags&DEL_LOCAL_MAC)&&(
mac->flags&ZEBRA_MAC_LOCAL))||((wctx->flags&DEL_REMOTE_MAC)&&(mac->flags&ZEBRA_M
AC_REMOTE))||((wctx->flags&DEL_REMOTE_MAC_FROM_VTEP)&&(mac->flags&ZEBRA_MAC_REMO
TE)&&IPV4_ADDR_SAME(&mac->fwd_info.r_vtep_ip,&wctx->r_vtep_ip))){if(wctx->upd_cl
ient&&(mac->flags&ZEBRA_MAC_LOCAL)){zvni_mac_send_del_to_client(wctx->zvni->vni,
&mac->macaddr,mac->flags);}if(wctx->uninstall)zvni_mac_uninstall(wctx->zvni,mac,
0);returnzvni_mac_del(wctx->zvni,mac);}return0;}/**DeleteallMACentriesfromspecif
icVTEPforaparticularVNI.*/staticvoidzvni_mac_del_from_vtep(zebra_vni_t*zvni,intu
ninstall,structin_addr*r_vtep_ip){structmac_walk_ctxwctx;if(!zvni->mac_table)ret
urn;memset(&wctx,0,sizeof(structmac_walk_ctx));wctx.zvni=zvni;wctx.uninstall=uni
nstall;wctx.flags=DEL_REMOTE_MAC_FROM_VTEP;wctx.r_vtep_ip=*r_vtep_ip;hash_iterat
e(zvni->mac_table,(void(*)(structhash_backet*,void*))zvni_mac_del_hash_entry,&wc
tx);}/**DeleteallMACentriesforthisVNI.*/staticvoidzvni_mac_del_all(zebra_vni_t*z
vni,intuninstall,intupd_client,uint32_tflags){structmac_walk_ctxwctx;if(!zvni->m
ac_table)return;memset(&wctx,0,sizeof(structmac_walk_ctx));wctx.zvni=zvni;wctx.u
ninstall=uninstall;wctx.upd_client=upd_client;wctx.flags=flags;hash_iterate(zvni
->mac_table,(void(*)(structhash_backet*,void*))zvni_mac_del_hash_entry,&wctx);}/
**LookupMAChashentry.*/staticzebra_mac_t*zvni_mac_lookup(zebra_vni_t*zvni,struct
ethaddr*mac){zebra_mac_ttmp;zebra_mac_t*pmac;memset(&tmp,0,sizeof(tmp));memcpy(&
tmp.macaddr,mac,ETH_ALEN);pmac=hash_lookup(zvni->mac_table,&tmp);returnpmac;}/**
InformBGPaboutlocalMACaddition.*/staticintzvni_mac_send_add_to_client(vni_tvni,s
tructethaddr*macaddr,uint8_tmac_flags){uint8_tflags=0;if(CHECK_FLAG(mac_flags,ZE
BRA_MAC_STICKY))SET_FLAG(flags,ZEBRA_MACIP_TYPE_STICKY);if(CHECK_FLAG(mac_flags,
ZEBRA_MAC_DEF_GW))SET_FLAG(flags,ZEBRA_MACIP_TYPE_GW);returnzvni_macip_send_msg_
to_client(vni,macaddr,NULL,flags,ZEBRA_MACIP_ADD);}/**InformBGPaboutlocalMACdele
tion.*/staticintzvni_mac_send_del_to_client(vni_tvni,structethaddr*macaddr,uint8
_tmac_flags){uint8_tflags=0;if(CHECK_FLAG(mac_flags,ZEBRA_MAC_STICKY))SET_FLAG(f
lags,ZEBRA_MACIP_TYPE_STICKY);if(CHECK_FLAG(mac_flags,ZEBRA_MAC_DEF_GW))SET_FLAG
(flags,ZEBRA_MACIP_TYPE_GW);returnzvni_macip_send_msg_to_client(vni,macaddr,NULL
,flags,ZEBRA_MACIP_DEL);}/**Mapportor(port,VLAN)toaVNI.ThisisinvokedupongettingM
AC*notifications,toseeiftheyareofinterest.*/staticzebra_vni_t*zvni_map_vlan(stru
ctinterface*ifp,structinterface*br_if,vlanid_tvid){structzebra_ns*zns;structrout
e_node*rn;structinterface*tmp_if=NULL;structzebra_if*zif;structzebra_l2info_brid
ge*br;structzebra_l2info_vxlan*vxl=NULL;uint8_tbridge_vlan_aware;zebra_vni_t*zvn
i;intfound=0;/*DetermineifbridgeisVLAN-awareornot*/zif=br_if->info;assert(zif);b
r=&zif->l2info.br;bridge_vlan_aware=br->vlan_aware;/*Seeifthisinterface(orinterf
aceplusVLANId)mapstoaVxLAN*//*TODO:Optimizewithahash.*/zns=zebra_ns_lookup(NS_DE
FAULT);for(rn=route_top(zns->if_table);rn;rn=route_next(rn)){tmp_if=(structinter
face*)rn->info;if(!tmp_if)continue;zif=tmp_if->info;if(!zif||zif->zif_type!=ZEBR
A_IF_VXLAN)continue;if(!if_is_operative(tmp_if))continue;vxl=&zif->l2info.vxl;if
(zif->brslave_info.br_if!=br_if)continue;if(!bridge_vlan_aware||vxl->access_vlan
==vid){found=1;break;}}if(!found)returnNULL;zvni=zvni_lookup(vxl->vni);returnzvn
i;}/**MapSVIandassociatedbridgetoaVNI.Thisisinvokedupongetting*neighbornotificat
ions,toseeiftheyareofinterest.*/staticzebra_vni_t*zvni_from_svi(structinterface*
ifp,structinterface*br_if){structzebra_ns*zns;structroute_node*rn;structinterfac
e*tmp_if=NULL;structzebra_if*zif;structzebra_l2info_bridge*br;structzebra_l2info
_vxlan*vxl=NULL;uint8_tbridge_vlan_aware;vlanid_tvid=0;zebra_vni_t*zvni;intfound
=0;if(!br_if)returnNULL;/*Makesurethelinkedinterfaceisabridge.*/if(!IS_ZEBRA_IF_
BRIDGE(br_if))returnNULL;/*DetermineifbridgeisVLAN-awareornot*/zif=br_if->info;a
ssert(zif);br=&zif->l2info.br;bridge_vlan_aware=br->vlan_aware;if(bridge_vlan_aw
are){structzebra_l2info_vlan*vl;if(!IS_ZEBRA_IF_VLAN(ifp))returnNULL;zif=ifp->in
fo;assert(zif);vl=&zif->l2info.vl;vid=vl->vid;}/*Seeifthisinterface(orinterfacep
lusVLANId)mapstoaVxLAN*//*TODO:Optimizewithahash.*/zns=zebra_ns_lookup(NS_DEFAUL
T);for(rn=route_top(zns->if_table);rn;rn=route_next(rn)){tmp_if=(structinterface
*)rn->info;if(!tmp_if)continue;zif=tmp_if->info;if(!zif||zif->zif_type!=ZEBRA_IF
_VXLAN)continue;if(!if_is_operative(tmp_if))continue;vxl=&zif->l2info.vxl;if(zif
->brslave_info.br_if!=br_if)continue;if(!bridge_vlan_aware||vxl->access_vlan==vi
d){found=1;break;}}if(!found)returnNULL;zvni=zvni_lookup(vxl->vni);returnzvni;}/
*MaptoSVIonbridgecorrespondingtospecifiedVLAN.Thiscanbeone*oftwocases:*(a)Inthec
aseofaVLAN-awarebridge,theSVIisaL3VLANinterface*linkedtothebridge*(b)Inthecaseof
aVLAN-unawarebridge,theSVIisthebridgeinteface*itself*/staticstructinterface*zvni
_map_to_svi(vlanid_tvid,structinterface*br_if){structzebra_ns*zns;structroute_no
de*rn;structinterface*tmp_if=NULL;structzebra_if*zif;structzebra_l2info_bridge*b
r;structzebra_l2info_vlan*vl;uint8_tbridge_vlan_aware;intfound=0;/*Defensivechec
k,callerexpectedtoinvokeonlywithvalidbridge.*/if(!br_if)returnNULL;/*Determineif
bridgeisVLAN-awareornot*/zif=br_if->info;assert(zif);br=&zif->l2info.br;bridge_v
lan_aware=br->vlan_aware;/*CheckoperstatusoftheSVI.*/if(!bridge_vlan_aware)retur
nif_is_operative(br_if)?br_if:NULL;/*IdentifycorrespondingVLANinterface.*//*TODO
:Optimizewithahash.*/zns=zebra_ns_lookup(NS_DEFAULT);for(rn=route_top(zns->if_ta
ble);rn;rn=route_next(rn)){tmp_if=(structinterface*)rn->info;/*Checkoperstatusof
theSVI.*/if(!tmp_if||!if_is_operative(tmp_if))continue;zif=tmp_if->info;if(!zif|
|zif->zif_type!=ZEBRA_IF_VLAN||zif->link!=br_if)continue;vl=(structzebra_l2info_
vlan*)&zif->l2info.vl;if(vl->vid==vid){found=1;break;}}returnfound?tmp_if:NULL;}
/**InstallremoteMACintothekernel.*/staticintzvni_mac_install(zebra_vni_t*zvni,ze
bra_mac_t*mac){structzebra_if*zif;structzebra_l2info_vxlan*vxl;uint8_tsticky;if(
!(mac->flags&ZEBRA_MAC_REMOTE))return0;zif=zvni->vxlan_if->info;if(!zif)return-1
;vxl=&zif->l2info.vxl;sticky=CHECK_FLAG(mac->flags,ZEBRA_MAC_STICKY)?1:0;returnk
ernel_add_mac(zvni->vxlan_if,vxl->access_vlan,&mac->macaddr,mac->fwd_info.r_vtep
_ip,sticky);}/**UninstallremoteMACfromthekernel.InthescenariowheretheMAC*movesto
remote,wehavetouninstallanyexistinglocalentryfirst.*/staticintzvni_mac_uninstall
(zebra_vni_t*zvni,zebra_mac_t*mac,intlocal){structzebra_if*zif;structzebra_l2inf
o_vxlan*vxl;structin_addrvtep_ip={.s_addr=0};structzebra_ns*zns;structinterface*
ifp;if(!local&&!(mac->flags&ZEBRA_MAC_REMOTE))return0;if(!zvni->vxlan_if){zlog_e
rr("VNI%uhash%pcouldn'tbeuninstalled-nointf",zvni->vni,zvni);return-1;}zif=zvni-
>vxlan_if->info;if(!zif)return-1;vxl=&zif->l2info.vxl;if(local){zns=zebra_ns_loo
kup(NS_DEFAULT);ifp=if_lookup_by_index_per_ns(zns,mac->fwd_info.local.ifindex);i
f(!ifp)//unexpectedreturn-1;}else{ifp=zvni->vxlan_if;vtep_ip=mac->fwd_info.r_vte
p_ip;}returnkernel_del_mac(ifp,vxl->access_vlan,&mac->macaddr,vtep_ip,local);}/*
*InstallMAChashentry-calleduponaccessVLANchange.*/staticvoidzvni_install_mac_has
h(structhash_backet*backet,void*ctxt){zebra_mac_t*mac;structmac_walk_ctx*wctx=ct
xt;mac=(zebra_mac_t*)backet->data;if(!mac)return;if(CHECK_FLAG(mac->flags,ZEBRA_
MAC_REMOTE))zvni_mac_install(wctx->zvni,mac);}/**DecrementneighborrefcountofMAC;
uninstallandfreeitif*appropriate.*/staticvoidzvni_deref_ip2mac(zebra_vni_t*zvni,
zebra_mac_t*mac,intuninstall){if(!CHECK_FLAG(mac->flags,ZEBRA_MAC_AUTO)||!list_i
sempty(mac->neigh_list))return;if(uninstall)zvni_mac_uninstall(zvni,mac,0);zvni_
mac_del(zvni,mac);}/**ReadandpopulatelocalMACsandneighborscorrespondingtothisVNI
.*/staticvoidzvni_read_mac_neigh(zebra_vni_t*zvni,structinterface*ifp){structzeb
ra_ns*zns;structzebra_if*zif;structinterface*vlan_if;structzebra_l2info_vxlan*vx
l;structinterface*vrr_if;zif=ifp->info;vxl=&zif->l2info.vxl;zns=zebra_ns_lookup(
NS_DEFAULT);if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("ReadingMACFDBandNeighborsforintf
%s(%u)VNI%umaster%u",ifp->name,ifp->ifindex,zvni->vni,zif->brslave_info.bridge_i
findex);macfdb_read_for_bridge(zns,ifp,zif->brslave_info.br_if);vlan_if=zvni_map
_to_svi(vxl->access_vlan,zif->brslave_info.br_if);if(vlan_if){/*AddSVIMAC-IP*/zv
ni_add_macip_for_intf(vlan_if,zvni);/*AddVRRMAC-IP-ifany*/vrr_if=zebra_get_vrr_i
ntf_for_svi(vlan_if);if(vrr_if)zvni_add_macip_for_intf(vrr_if,zvni);neigh_read_f
or_vlan(zns,vlan_if);}}/**HashfunctionforVNI.*/staticunsignedintvni_hash_keymake
(void*p){constzebra_vni_t*zvni=p;return(jhash_1word(zvni->vni,0));}/**Compare2VN
Ihashentries.*/staticintvni_hash_cmp(constvoid*p1,constvoid*p2){constzebra_vni_t
*zvni1=p1;constzebra_vni_t*zvni2=p2;return(zvni1->vni==zvni2->vni);}/**Callbackt
oallocateVNIhashentry.*/staticvoid*zvni_alloc(void*p){constzebra_vni_t*tmp_vni=p
;zebra_vni_t*zvni;zvni=XCALLOC(MTYPE_ZVNI,sizeof(zebra_vni_t));zvni->vni=tmp_vni
->vni;return((void*)zvni);}/**LookupVNIhashentry.*/staticzebra_vni_t*zvni_lookup
(vni_tvni){structzebra_vrf*zvrf;zebra_vni_ttmp_vni;zebra_vni_t*zvni=NULL;zvrf=vr
f_info_lookup(VRF_DEFAULT);assert(zvrf);memset(&tmp_vni,0,sizeof(zebra_vni_t));t
mp_vni.vni=vni;zvni=hash_lookup(zvrf->vni_table,&tmp_vni);returnzvni;}/**AddVNIh
ashentry.*/staticzebra_vni_t*zvni_add(vni_tvni){structzebra_vrf*zvrf;zebra_vni_t
tmp_zvni;zebra_vni_t*zvni=NULL;zvrf=vrf_info_lookup(VRF_DEFAULT);assert(zvrf);me
mset(&tmp_zvni,0,sizeof(zebra_vni_t));tmp_zvni.vni=vni;zvni=hash_get(zvrf->vni_t
able,&tmp_zvni,zvni_alloc);assert(zvni);/*CreatehashtableforMAC*/zvni->mac_table
=hash_create(mac_hash_keymake,mac_cmp,"ZebraVNIMACTable");/*Createhashtableforne
ighbors*/zvni->neigh_table=hash_create(neigh_hash_keymake,neigh_cmp,"ZebraVNINei
ghborTable");returnzvni;}/**DeleteVNIhashentry.*/staticintzvni_del(zebra_vni_t*z
vni){structzebra_vrf*zvrf;zebra_vni_t*tmp_zvni;zvrf=vrf_info_lookup(VRF_DEFAULT)
;assert(zvrf);zvni->vxlan_if=NULL;/*Freetheneighborhashtable.*/hash_free(zvni->n
eigh_table);zvni->neigh_table=NULL;/*FreetheMAChashtable.*/hash_free(zvni->mac_t
able);zvni->mac_table=NULL;/*FreetheVNIhashentryandallocatedmemory.*/tmp_zvni=ha
sh_release(zvrf->vni_table,zvni);if(tmp_zvni)XFREE(MTYPE_ZVNI,tmp_zvni);return0;
}/**InformBGPaboutlocalVNIaddition.*/staticintzvni_send_add_to_client(zebra_vni_
t*zvni){structzserv*client;structstream*s;client=zebra_find_client(ZEBRA_ROUTE_B
GP,0);/*BGPmaynotberunning.*/if(!client)return0;s=stream_new(ZEBRA_MAX_PACKET_SI
Z);zclient_create_header(s,ZEBRA_VNI_ADD,VRF_DEFAULT);stream_putl(s,zvni->vni);s
tream_put_in_addr(s,&zvni->local_vtep_ip);stream_put(s,&zvni->vrf_id,sizeof(vrf_
id_t));/*tenantvrf*//*Writepacketsize.*/stream_putw_at(s,0,stream_get_endp(s));i
f(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("SendVNI_ADD%u%stenantvrf%sto%s",zvni->vni,ine
t_ntoa(zvni->local_vtep_ip),vrf_id_to_name(zvni->vrf_id),zebra_route_string(clie
nt->proto));client->vniadd_cnt++;returnzebra_server_send_message(client,s);}/**I
nformBGPaboutlocalVNIdeletion.*/staticintzvni_send_del_to_client(vni_tvni){struc
tzserv*client;structstream*s;client=zebra_find_client(ZEBRA_ROUTE_BGP,0);/*BGPma
ynotberunning.*/if(!client)return0;s=stream_new(ZEBRA_MAX_PACKET_SIZ);stream_res
et(s);zclient_create_header(s,ZEBRA_VNI_DEL,VRF_DEFAULT);stream_putl(s,vni);/*Wr
itepacketsize.*/stream_putw_at(s,0,stream_get_endp(s));if(IS_ZEBRA_DEBUG_VXLAN)z
log_debug("SendVNI_DEL%uto%s",vni,zebra_route_string(client->proto));client->vni
del_cnt++;returnzebra_server_send_message(client,s);}/**BuildtheVNIhashtablebygo
ingovertheVxLANinterfaces.This*iscalledwhenEVPN(advertise-all-vni)isenabled.*/st
aticvoidzvni_build_hash_table(){structzebra_ns*zns;structroute_node*rn;structint
erface*ifp;/*WalkVxLANinterfacesandcreateVNIhash.*/zns=zebra_ns_lookup(NS_DEFAUL
T);for(rn=route_top(zns->if_table);rn;rn=route_next(rn)){vni_tvni;zebra_vni_t*zv
ni=NULL;zebra_l3vni_t*zl3vni=NULL;structzebra_if*zif;structzebra_l2info_vxlan*vx
l;ifp=(structinterface*)rn->info;if(!ifp)continue;zif=ifp->info;if(!zif||zif->zi
f_type!=ZEBRA_IF_VXLAN)continue;vxl=&zif->l2info.vxl;vni=vxl->vni;/*L3-VNIandL2-
VNIarehandledseperately*/zl3vni=zl3vni_lookup(vni);if(zl3vni){if(IS_ZEBRA_DEBUG_
VXLAN)zlog_debug("createL3-VNIhashforIntf%s(%u)L3-VNI%u",ifp->name,ifp->ifindex,
vni);/*associatewithvxlan_if*/zl3vni->local_vtep_ip=vxl->vtep_ip;zl3vni->vxlan_i
f=ifp;/**weneedtoassociatewithSVI.*wecanassociatewithsvi-ifonlyafterassociation*
withvxlan-intfiscomplete*/zl3vni->svi_if=zl3vni_map_to_svi_if(zl3vni);if(is_l3vn
i_oper_up(zl3vni))zebra_vxlan_process_l3vni_oper_up(zl3vni);}else{structinterfac
e*vlan_if=NULL;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("CreateL2-VNIhashforintf%s(%u)
L2-VNI%ulocalIP%s",ifp->name,ifp->ifindex,vni,inet_ntoa(vxl->vtep_ip));/*VNIhash
entryisnotexpectedtoexist.*/zvni=zvni_lookup(vni);if(zvni){zlog_err("VNIhashalre
adypresentforIF%s(%u)L2-VNI%u",ifp->name,ifp->ifindex,vni);continue;}zvni=zvni_a
dd(vni);if(!zvni){zlog_err("FailedtoaddVNIhash,IF%s(%u)L2-VNI%u",ifp->name,ifp->
ifindex,vni);return;}zvni->local_vtep_ip=vxl->vtep_ip;zvni->vxlan_if=ifp;vlan_if
=zvni_map_to_svi(vxl->access_vlan,zif->brslave_info.br_if);if(vlan_if){zvni->vrf
_id=vlan_if->vrf_id;zl3vni=zl3vni_from_vrf(vlan_if->vrf_id);if(zl3vni)listnode_a
dd_sort(zl3vni->l2vnis,zvni);}/*InformBGPifintfisupandmappedtobridge.*/if(if_is_
operative(ifp)&&zif->brslave_info.br_if)zvni_send_add_to_client(zvni);}}}/**Seei
fremoteVTEPmatcheswithprefix.*/staticintzvni_vtep_match(structin_addr*vtep_ip,ze
bra_vtep_t*zvtep){return(IPV4_ADDR_SAME(vtep_ip,&zvtep->vtep_ip));}/**Locateremo
teVTEPinVNIhashtable.*/staticzebra_vtep_t*zvni_vtep_find(zebra_vni_t*zvni,struct
in_addr*vtep_ip){zebra_vtep_t*zvtep;if(!zvni)returnNULL;for(zvtep=zvni->vteps;zv
tep;zvtep=zvtep->next){if(zvni_vtep_match(vtep_ip,zvtep))break;}returnzvtep;}/**
AddremoteVTEPtoVNIhashtable.*/staticzebra_vtep_t*zvni_vtep_add(zebra_vni_t*zvni,
structin_addr*vtep_ip){zebra_vtep_t*zvtep;zvtep=XCALLOC(MTYPE_ZVNI_VTEP,sizeof(z
ebra_vtep_t));if(!zvtep){zlog_err("FailedtoallocVTEPentry,VNI%u",zvni->vni);retu
rnNULL;}zvtep->vtep_ip=*vtep_ip;if(zvni->vteps)zvni->vteps->prev=zvtep;zvtep->ne
xt=zvni->vteps;zvni->vteps=zvtep;returnzvtep;}/**RemoveremoteVTEPfromVNIhashtabl
e.*/staticintzvni_vtep_del(zebra_vni_t*zvni,zebra_vtep_t*zvtep){if(zvtep->next)z
vtep->next->prev=zvtep->prev;if(zvtep->prev)zvtep->prev->next=zvtep->next;elsezv
ni->vteps=zvtep->next;zvtep->prev=zvtep->next=NULL;XFREE(MTYPE_ZVNI_VTEP,zvtep);
return0;}/**DeleteallremoteVTEPsforthisVNI(uponVNIdelete).Also*uninstallfromkern
elifaskedto.*/staticintzvni_vtep_del_all(zebra_vni_t*zvni,intuninstall){zebra_vt
ep_t*zvtep,*zvtep_next;if(!zvni)return-1;for(zvtep=zvni->vteps;zvtep;zvtep=zvtep
_next){zvtep_next=zvtep->next;if(uninstall)zvni_vtep_uninstall(zvni,&zvtep->vtep
_ip);zvni_vtep_del(zvni,zvtep);}return0;}/**InstallremoteVTEPintothekernel.*/sta
ticintzvni_vtep_install(zebra_vni_t*zvni,structin_addr*vtep_ip){returnkernel_add
_vtep(zvni->vni,zvni->vxlan_if,vtep_ip);}/**UninstallremoteVTEPfromthekernel.*/s
taticintzvni_vtep_uninstall(zebra_vni_t*zvni,structin_addr*vtep_ip){if(!zvni->vx
lan_if){zlog_err("VNI%uhash%pcouldn'tbeuninstalled-nointf",zvni->vni,zvni);retur
n-1;}returnkernel_del_vtep(zvni->vni,zvni->vxlan_if,vtep_ip);}/**CleanupVNI/VTEP
andupdatekernel*/staticvoidzvni_cleanup_all(structhash_backet*backet,void*arg){z
ebra_vni_t*zvni=NULL;zebra_l3vni_t*zl3vni=NULL;structzebra_vrf*zvrf=(structzebra
_vrf*)arg;zvni=(zebra_vni_t*)backet->data;if(!zvni)return;/*removefroml3-vnilist
*/if(zvrf->l3vni)zl3vni=zl3vni_lookup(zvrf->l3vni);if(zl3vni)listnode_delete(zl3
vni->l2vnis,zvni);/*FreeupallneighborsandMACs,ifany.*/zvni_neigh_del_all(zvni,1,
0,DEL_ALL_NEIGH);zvni_mac_del_all(zvni,1,0,DEL_ALL_MAC);/*FreeupallremoteVTEPs,i
fany.*/zvni_vtep_del_all(zvni,1);/*Deletethehashentry.*/zvni_del(zvni);}/*cleanu
pL3VNI*/staticvoidzl3vni_cleanup_all(structhash_backet*backet,void*args){zebra_l
3vni_t*zl3vni=NULL;zl3vni=(zebra_l3vni_t*)backet->data;if(!zl3vni)return;zebra_v
xlan_process_l3vni_oper_down(zl3vni);}staticintis_host_present_in_host_list(stru
ctlist*list,structprefix*host){structlistnode*node=NULL;structprefix*p=NULL;for(
ALL_LIST_ELEMENTS_RO(list,node,p)){if(prefix_same(p,host))return1;}return0;}stat
icvoidhost_list_add_host(structlist*list,structprefix*host){structprefix*p=NULL;
p=XCALLOC(MTYPE_HOST_PREFIX,sizeof(structprefix));memcpy(p,host,sizeof(structpre
fix));listnode_add_sort(list,p);}staticvoidhost_list_delete_host(structlist*list
,structprefix*host){structlistnode*node=NULL,*nnode=NULL,*node_to_del=NULL;struc
tprefix*p=NULL;for(ALL_LIST_ELEMENTS(list,node,nnode,p)){if(prefix_same(p,host))
{XFREE(MTYPE_HOST_PREFIX,p);node_to_del=node;}}if(node_to_del)list_delete_node(l
ist,node_to_del);}/**LookupMAChashentry.*/staticzebra_mac_t*zl3vni_rmac_lookup(z
ebra_l3vni_t*zl3vni,structethaddr*rmac){zebra_mac_ttmp;zebra_mac_t*pmac;memset(&
tmp,0,sizeof(tmp));memcpy(&tmp.macaddr,rmac,ETH_ALEN);pmac=hash_lookup(zl3vni->r
mac_table,&tmp);returnpmac;}/**CallbacktoallocateRMAChashentry.*/staticvoid*zl3v
ni_rmac_alloc(void*p){constzebra_mac_t*tmp_rmac=p;zebra_mac_t*zrmac;zrmac=XCALLO
C(MTYPE_MAC,sizeof(zebra_mac_t));*zrmac=*tmp_rmac;return((void*)zrmac);}/**AddRM
ACentrytol3-vni*/staticzebra_mac_t*zl3vni_rmac_add(zebra_l3vni_t*zl3vni,structet
haddr*rmac){zebra_mac_ttmp_rmac;zebra_mac_t*zrmac=NULL;memset(&tmp_rmac,0,sizeof
(zebra_mac_t));memcpy(&tmp_rmac.macaddr,rmac,ETH_ALEN);zrmac=hash_get(zl3vni->rm
ac_table,&tmp_rmac,zl3vni_rmac_alloc);assert(zrmac);zrmac->host_list=list_new();
zrmac->host_list->cmp=(int(*)(void*,void*))prefix_cmp;SET_FLAG(zrmac->flags,ZEBR
A_MAC_REMOTE);SET_FLAG(zrmac->flags,ZEBRA_MAC_REMOTE_RMAC);returnzrmac;}/**Delet
eMACentry.*/staticintzl3vni_rmac_del(zebra_l3vni_t*zl3vni,zebra_mac_t*zrmac){zeb
ra_mac_t*tmp_rmac;if(zrmac->host_list)list_delete_and_null(&zrmac->host_list);zr
mac->host_list=NULL;tmp_rmac=hash_release(zl3vni->rmac_table,zrmac);if(tmp_rmac)
XFREE(MTYPE_MAC,tmp_rmac);return0;}/**InstallremoteRMACintothekernel.*/staticint
zl3vni_rmac_install(zebra_l3vni_t*zl3vni,zebra_mac_t*zrmac){structzebra_if*zif=N
ULL;structzebra_l2info_vxlan*vxl=NULL;if(!(CHECK_FLAG(zrmac->flags,ZEBRA_MAC_REM
OTE))||!(CHECK_FLAG(zrmac->flags,ZEBRA_MAC_REMOTE_RMAC)))return0;zif=zl3vni->vxl
an_if->info;if(!zif)return-1;vxl=&zif->l2info.vxl;returnkernel_add_mac(zl3vni->v
xlan_if,vxl->access_vlan,&zrmac->macaddr,zrmac->fwd_info.r_vtep_ip,0);}/**Uninst
allremoteRMACfromthekernel.*/staticintzl3vni_rmac_uninstall(zebra_l3vni_t*zl3vni
,zebra_mac_t*zrmac){charbuf[ETHER_ADDR_STRLEN];structzebra_if*zif=NULL;structzeb
ra_l2info_vxlan*vxl=NULL;if(!(CHECK_FLAG(zrmac->flags,ZEBRA_MAC_REMOTE))||!(CHEC
K_FLAG(zrmac->flags,ZEBRA_MAC_REMOTE_RMAC)))return0;if(!zl3vni->vxlan_if){zlog_e
rr("RMAC%sonL3-VNI%uhash%pcouldn'tbeuninstalled-novxlan_if",prefix_mac2str(&zrma
c->macaddr,buf,sizeof(buf)),zl3vni->vni,zl3vni);return-1;}zif=zl3vni->vxlan_if->
info;if(!zif)return-1;vxl=&zif->l2info.vxl;returnkernel_del_mac(zl3vni->vxlan_if
,vxl->access_vlan,&zrmac->macaddr,zrmac->fwd_info.r_vtep_ip,0);}/*handlermacadd*
/staticintzl3vni_remote_rmac_add(zebra_l3vni_t*zl3vni,structethaddr*rmac,structi
paddr*vtep_ip,structprefix*host_prefix){charbuf[ETHER_ADDR_STRLEN];charbuf1[INET
6_ADDRSTRLEN];zebra_mac_t*zrmac=NULL;zrmac=zl3vni_rmac_lookup(zl3vni,rmac);if(!z
rmac){zrmac=zl3vni_rmac_add(zl3vni,rmac);if(!zrmac){zlog_warn("FailedtoaddRMAC%s
L3VNI%uRemoteVTEP%s",prefix_mac2str(rmac,buf,sizeof(buf)),zl3vni->vni,ipaddr2str
(vtep_ip,buf1,sizeof(buf1)));return-1;}memset(&zrmac->fwd_info,0,sizeof(zrmac->f
wd_info));zrmac->fwd_info.r_vtep_ip=vtep_ip->ipaddr_v4;/*installrmacinkernel*/zl
3vni_rmac_install(zl3vni,zrmac);}if(!is_host_present_in_host_list(zrmac->host_li
st,host_prefix))host_list_add_host(zrmac->host_list,host_prefix);return0;}/*hand
lermacdelete*/staticintzl3vni_remote_rmac_del(zebra_l3vni_t*zl3vni,structethaddr
*rmac,structprefix*host_prefix){zebra_mac_t*zrmac=NULL;zrmac=zl3vni_rmac_lookup(
zl3vni,rmac);if(!zrmac)return-1;host_list_delete_host(zrmac->host_list,host_pref
ix);if(list_isempty(zrmac->host_list)){/*uninstallfromkernel*/zl3vni_rmac_uninst
all(zl3vni,zrmac);/*delthermacentry*/zl3vni_rmac_del(zl3vni,zrmac);}return0;}/**
Lookupnhhashentryonal3-vni.*/staticzebra_neigh_t*zl3vni_nh_lookup(zebra_l3vni_t*
zl3vni,structipaddr*ip){zebra_neigh_ttmp;zebra_neigh_t*n;memset(&tmp,0,sizeof(tm
p));memcpy(&tmp.ip,ip,sizeof(structipaddr));n=hash_lookup(zl3vni->nh_table,&tmp)
;returnn;}/**CallbacktoallocateNHhashentryonL3-VNI.*/staticvoid*zl3vni_nh_alloc(
void*p){constzebra_neigh_t*tmp_n=p;zebra_neigh_t*n;n=XCALLOC(MTYPE_NEIGH,sizeof(
zebra_neigh_t));*n=*tmp_n;return((void*)n);}/**Addneighborentry.*/staticzebra_ne
igh_t*zl3vni_nh_add(zebra_l3vni_t*zl3vni,structipaddr*ip,structethaddr*mac){zebr
a_neigh_ttmp_n;zebra_neigh_t*n=NULL;memset(&tmp_n,0,sizeof(zebra_neigh_t));memcp
y(&tmp_n.ip,ip,sizeof(structipaddr));n=hash_get(zl3vni->nh_table,&tmp_n,zl3vni_n
h_alloc);assert(n);n->host_list=list_new();n->host_list->cmp=(int(*)(void*,void*
))prefix_cmp;memcpy(&n->emac,mac,ETH_ALEN);SET_FLAG(n->flags,ZEBRA_NEIGH_REMOTE)
;SET_FLAG(n->flags,ZEBRA_NEIGH_REMOTE_NH);returnn;}/**Deleteneighborentry.*/stat
icintzl3vni_nh_del(zebra_l3vni_t*zl3vni,zebra_neigh_t*n){zebra_neigh_t*tmp_n;if(
n->host_list)list_delete_and_null(&n->host_list);n->host_list=NULL;tmp_n=hash_re
lease(zl3vni->nh_table,n);if(tmp_n)XFREE(MTYPE_NEIGH,tmp_n);return0;}/**Installr
emotenhasneighintothekernel.*/staticintzl3vni_nh_install(zebra_l3vni_t*zl3vni,ze
bra_neigh_t*n){if(!is_l3vni_oper_up(zl3vni))return-1;if(!(n->flags&ZEBRA_NEIGH_R
EMOTE)||!(n->flags&ZEBRA_NEIGH_REMOTE_NH))return0;returnkernel_add_neigh(zl3vni-
>svi_if,&n->ip,&n->emac);}/**Uninstallremotenhfromthekernel.*/staticintzl3vni_nh
_uninstall(zebra_l3vni_t*zl3vni,zebra_neigh_t*n){if(!(n->flags&ZEBRA_NEIGH_REMOT
E)||!(n->flags&ZEBRA_NEIGH_REMOTE_NH))return0;if(!zl3vni->svi_if||!if_is_operati
ve(zl3vni->svi_if))return0;returnkernel_del_neigh(zl3vni->svi_if,&n->ip);}/*addr
emotevtepasaneighentry*/staticintzl3vni_remote_nh_add(zebra_l3vni_t*zl3vni,struc
tipaddr*vtep_ip,structethaddr*rmac,structprefix*host_prefix){charbuf[ETHER_ADDR_
STRLEN];charbuf1[INET6_ADDRSTRLEN];zebra_neigh_t*nh=NULL;nh=zl3vni_nh_lookup(zl3
vni,vtep_ip);if(!nh){nh=zl3vni_nh_add(zl3vni,vtep_ip,rmac);if(!nh){zlog_warn("Fa
iledtoaddNHasNeigh(IP%sMAC%sL3-VNI%u)",ipaddr2str(vtep_ip,buf1,sizeof(buf1)),pre
fix_mac2str(rmac,buf,sizeof(buf)),zl3vni->vni);return-1;}/*installthenhneighinke
rnel*/zl3vni_nh_install(zl3vni,nh);}if(!is_host_present_in_host_list(nh->host_li
st,host_prefix))host_list_add_host(nh->host_list,host_prefix);return0;}/*handlen
hneighdelete*/staticintzl3vni_remote_nh_del(zebra_l3vni_t*zl3vni,structipaddr*vt
ep_ip,structprefix*host_prefix){zebra_neigh_t*nh=NULL;nh=zl3vni_nh_lookup(zl3vni
,vtep_ip);if(!nh)return-1;host_list_delete_host(nh->host_list,host_prefix);if(li
st_isempty(nh->host_list)){/*uninstallfromkernel*/zl3vni_nh_uninstall(zl3vni,nh)
;/*deletethenhentry*/zl3vni_nh_del(zl3vni,nh);}return0;}/*handleneighupdatefromk
ernel-theonlythingofinterestisto*readdstaleentries.*/staticintzl3vni_local_nh_ad
d_update(zebra_l3vni_t*zl3vni,structipaddr*ip,uint16_tstate){#ifdefGNU_LINUXzebr
a_neigh_t*n=NULL;n=zl3vni_nh_lookup(zl3vni,ip);if(!n)return0;/*allnexthopneighar
eremoteandinstalledbyfrr.*Ifthekernelhasagedthisentry,re-install.*/if(state&NUD_
STALE)zl3vni_nh_install(zl3vni,n);#endifreturn0;}/*handleneighdeletefromkernel*/
staticintzl3vni_local_nh_del(zebra_l3vni_t*zl3vni,structipaddr*ip){zebra_neigh_t
*n=NULL;n=zl3vni_nh_lookup(zl3vni,ip);if(!n)return0;/*allnexthopneighareremotean
dinstalledbyfrr.*Ifwegetanageoutnotificationfortheseneighentries,wehaveto*instal
litback*/zl3vni_nh_install(zl3vni,n);return0;}/**HashfunctionforL3VNI.*/staticun
signedintl3vni_hash_keymake(void*p){constzebra_l3vni_t*zl3vni=p;returnjhash_1wor
d(zl3vni->vni,0);}/**Compare2L3VNIhashentries.*/staticintl3vni_hash_cmp(constvoi
d*p1,constvoid*p2){constzebra_l3vni_t*zl3vni1=p1;constzebra_l3vni_t*zl3vni2=p2;r
eturn(zl3vni1->vni==zl3vni2->vni);}/**CallbacktoallocateL3VNIhashentry.*/staticv
oid*zl3vni_alloc(void*p){zebra_l3vni_t*zl3vni=NULL;constzebra_l3vni_t*tmp_l3vni=
p;zl3vni=XCALLOC(MTYPE_ZL3VNI,sizeof(zebra_l3vni_t));zl3vni->vni=tmp_l3vni->vni;
return((void*)zl3vni);}/**LookupL3VNIhashentry.*/staticzebra_l3vni_t*zl3vni_look
up(vni_tvni){structzebra_ns*zns;zebra_l3vni_ttmp_l3vni;zebra_l3vni_t*zl3vni=NULL
;zns=zebra_ns_lookup(NS_DEFAULT);assert(zns);memset(&tmp_l3vni,0,sizeof(zebra_l3
vni_t));tmp_l3vni.vni=vni;zl3vni=hash_lookup(zns->l3vni_table,&tmp_l3vni);return
zl3vni;}/**AddL3VNIhashentry.*/staticzebra_l3vni_t*zl3vni_add(vni_tvni,vrf_id_tv
rf_id){zebra_l3vni_ttmp_zl3vni;structzebra_ns*zns=NULL;zebra_l3vni_t*zl3vni=NULL
;zns=zebra_ns_lookup(NS_DEFAULT);assert(zns);memset(&tmp_zl3vni,0,sizeof(zebra_l
3vni_t));tmp_zl3vni.vni=vni;zl3vni=hash_get(zns->l3vni_table,&tmp_zl3vni,zl3vni_
alloc);assert(zl3vni);zl3vni->vrf_id=vrf_id;zl3vni->svi_if=NULL;zl3vni->vxlan_if
=NULL;zl3vni->l2vnis=list_new();zl3vni->l2vnis->cmp=(int(*)(void*,void*))vni_has
h_cmp;/*CreatehashtableforremoteRMAC*/zl3vni->rmac_table=hash_create(mac_hash_ke
ymake,mac_cmp,"ZebraL3-VNIRMAC-Table");/*Createhashtableforneighbors*/zl3vni->nh
_table=hash_create(neigh_hash_keymake,neigh_cmp,"ZebraL3-VNInext-hoptable");retu
rnzl3vni;}/**DeleteL3VNIhashentry.*/staticintzl3vni_del(zebra_l3vni_t*zl3vni){st
ructzebra_ns*zns;zebra_l3vni_t*tmp_zl3vni;zns=zebra_ns_lookup(NS_DEFAULT);assert
(zns);/*freethelistofl2vnis*/list_delete_and_null(&zl3vni->l2vnis);zl3vni->l2vni
s=NULL;/*Freethermactable*/hash_free(zl3vni->rmac_table);zl3vni->rmac_table=NULL
;/*Freethenhtable*/hash_free(zl3vni->nh_table);zl3vni->nh_table=NULL;/*FreetheVN
Ihashentryandallocatedmemory.*/tmp_zl3vni=hash_release(zns->l3vni_table,zl3vni);
if(tmp_zl3vni)XFREE(MTYPE_ZL3VNI,tmp_zl3vni);return0;}staticstructinterface*zl3v
ni_map_to_vxlan_if(zebra_l3vni_t*zl3vni){structzebra_ns*zns=NULL;structroute_nod
e*rn=NULL;structinterface*ifp=NULL;/*loopthroughallvxlan-interface*/zns=zebra_ns
_lookup(NS_DEFAULT);for(rn=route_top(zns->if_table);rn;rn=route_next(rn)){struct
zebra_if*zif=NULL;structzebra_l2info_vxlan*vxl=NULL;ifp=(structinterface*)rn->in
fo;if(!ifp)continue;zif=ifp->info;if(!zif||zif->zif_type!=ZEBRA_IF_VXLAN)continu
e;vxl=&zif->l2info.vxl;if(vxl->vni==zl3vni->vni){zl3vni->local_vtep_ip=vxl->vtep
_ip;returnifp;}}returnNULL;}staticstructinterface*zl3vni_map_to_svi_if(zebra_l3v
ni_t*zl3vni){structzebra_if*zif=NULL;/*zebra_ifforvxlan_if*/structzebra_l2info_v
xlan*vxl=NULL;/*l2infoforvxlan_if*/if(!zl3vni)returnNULL;if(!zl3vni->vxlan_if)re
turnNULL;zif=zl3vni->vxlan_if->info;if(!zif)returnNULL;vxl=&zif->l2info.vxl;retu
rnzvni_map_to_svi(vxl->access_vlan,zif->brslave_info.br_if);}staticzebra_l3vni_t
*zl3vni_from_vrf(vrf_id_tvrf_id){structzebra_vrf*zvrf=NULL;zvrf=zebra_vrf_lookup
_by_id(vrf_id);if(!zvrf)returnNULL;returnzl3vni_lookup(zvrf->l3vni);}/**MapSVIan
dassociatedbridgetoaVNI.Thisisinvokedupongetting*neighbornotifications,toseeifth
eyareofinterest.*/staticzebra_l3vni_t*zl3vni_from_svi(structinterface*ifp,struct
interface*br_if){intfound=0;vlanid_tvid=0;uint8_tbridge_vlan_aware=0;zebra_l3vni
_t*zl3vni=NULL;structzebra_ns*zns=NULL;structroute_node*rn=NULL;structzebra_if*z
if=NULL;structinterface*tmp_if=NULL;structzebra_l2info_bridge*br=NULL;structzebr
a_l2info_vxlan*vxl=NULL;if(!br_if)returnNULL;/*Makesurethelinkedinterfaceisabrid
ge.*/if(!IS_ZEBRA_IF_BRIDGE(br_if))returnNULL;/*DetermineifbridgeisVLAN-awareorn
ot*/zif=br_if->info;assert(zif);br=&zif->l2info.br;bridge_vlan_aware=br->vlan_aw
are;if(bridge_vlan_aware){structzebra_l2info_vlan*vl;if(!IS_ZEBRA_IF_VLAN(ifp))r
eturnNULL;zif=ifp->info;assert(zif);vl=&zif->l2info.vl;vid=vl->vid;}/*Seeifthisi
nterface(orinterfaceplusVLANId)mapstoaVxLAN*//*TODO:Optimizewithahash.*/zns=zebr
a_ns_lookup(NS_DEFAULT);for(rn=route_top(zns->if_table);rn;rn=route_next(rn)){tm
p_if=(structinterface*)rn->info;if(!tmp_if)continue;zif=tmp_if->info;if(!zif||zi
f->zif_type!=ZEBRA_IF_VXLAN)continue;if(!if_is_operative(tmp_if))continue;vxl=&z
if->l2info.vxl;if(zif->brslave_info.br_if!=br_if)continue;if(!bridge_vlan_aware|
|vxl->access_vlan==vid){found=1;break;}}if(!found)returnNULL;zl3vni=zl3vni_looku
p(vxl->vni);returnzl3vni;}/**InformBGPaboutl3-vni.*/staticintzl3vni_send_add_to_
client(zebra_l3vni_t*zl3vni){structstream*s=NULL;structzserv*client=NULL;structe
thaddrrmac;charbuf[ETHER_ADDR_STRLEN];client=zebra_find_client(ZEBRA_ROUTE_BGP,0
);/*BGPmaynotberunning.*/if(!client)return0;/*getthermac*/memset(&rmac,0,sizeof(
structethaddr));zl3vni_get_rmac(zl3vni,&rmac);s=stream_new(ZEBRA_MAX_PACKET_SIZ)
;zclient_create_header(s,ZEBRA_L3VNI_ADD,zl3vni_vrf_id(zl3vni));stream_putl(s,zl
3vni->vni);stream_put(s,&rmac,sizeof(structethaddr));stream_put_in_addr(s,&zl3vn
i->local_vtep_ip);stream_put(s,&zl3vni->filter,sizeof(int));/*Writepacketsize.*/
stream_putw_at(s,0,stream_get_endp(s));if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("SendL
3_VNI_ADD%uVRF%sRMAC%slocal-ip%sfilter%sto%s",zl3vni->vni,vrf_id_to_name(zl3vni_
vrf_id(zl3vni)),prefix_mac2str(&rmac,buf,sizeof(buf)),inet_ntoa(zl3vni->local_vt
ep_ip),CHECK_FLAG(zl3vni->filter,PREFIX_ROUTES_ONLY)?"prefix-routes-only":"none"
,zebra_route_string(client->proto));client->l3vniadd_cnt++;returnzebra_server_se
nd_message(client,s);}/**InformBGPaboutlocall3-VNIdeletion.*/staticintzl3vni_sen
d_del_to_client(zebra_l3vni_t*zl3vni){structstream*s=NULL;structzserv*client=NUL
L;client=zebra_find_client(ZEBRA_ROUTE_BGP,0);/*BGPmaynotberunning.*/if(!client)
return0;s=stream_new(ZEBRA_MAX_PACKET_SIZ);zclient_create_header(s,ZEBRA_L3VNI_D
EL,zl3vni_vrf_id(zl3vni));stream_putl(s,zl3vni->vni);/*Writepacketsize.*/stream_
putw_at(s,0,stream_get_endp(s));if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("SendL3_VNI_D
EL%uVRF%sto%s",zl3vni->vni,vrf_id_to_name(zl3vni_vrf_id(zl3vni)),zebra_route_str
ing(client->proto));client->l3vnidel_cnt++;returnzebra_server_send_message(clien
t,s);}staticvoidzebra_vxlan_process_l3vni_oper_up(zebra_l3vni_t*zl3vni){if(!zl3v
ni)return;/*sendl3vniaddtoBGP*/zl3vni_send_add_to_client(zl3vni);}staticvoidzebr
a_vxlan_process_l3vni_oper_down(zebra_l3vni_t*zl3vni){if(!zl3vni)return;/*sendl3
-vnideltoBGP*/zl3vni_send_del_to_client(zl3vni);}staticvoidzvni_add_to_l3vni_lis
t(structhash_backet*backet,void*ctxt){zebra_vni_t*zvni=(zebra_vni_t*)backet->dat
a;zebra_l3vni_t*zl3vni=(zebra_l3vni_t*)ctxt;if(zvni->vrf_id==zl3vni_vrf_id(zl3vn
i))listnode_add_sort(zl3vni->l2vnis,zvni);}/**handletransitionofvnifroml2tol3and
viceversa*/staticintzebra_vxlan_handle_vni_transition(structzebra_vrf*zvrf,vni_t
vni,intadd){zebra_vni_t*zvni=NULL;/*ThereisapossibilitythatVNInotificationwasalr
eadyreceived*fromkernelandweprogrammeditasL2-VNI*InsuchacaseweneedtodeletethisL2
-VNIfirst,so*thatitcanbereprogrammedasL3-VNIinthesystem.Itisalso*possiblethatthe
vrf-vnimappingisremovedfromFRRwhilethevxlan*interfaceisstillpresentinkernel.Inth
iscasetokeepit*symmetric,wewilldeletethel3-vniandreprogramitasl2-vni*/if(add){/*
Locatehashentry*/zvni=zvni_lookup(vni);if(!zvni)return0;if(IS_ZEBRA_DEBUG_VXLAN)
zlog_debug("DelL2-VNI%u-transitiontoL3-VNI",vni);/*DeleteVNIfromBGP.*/zvni_send_
del_to_client(zvni->vni);/*FreeupallneighborsandMAC,ifany.*/zvni_neigh_del_all(z
vni,0,0,DEL_ALL_NEIGH);zvni_mac_del_all(zvni,0,0,DEL_ALL_MAC);/*FreeupallremoteV
TEPs,ifany.*/zvni_vtep_del_all(zvni,0);/*Deletethehashentry.*/if(zvni_del(zvni))
{zlog_err("FailedtodelVNIhash%p,VNI%u",zvni,zvni->vni);return-1;}}else{/*TODO_MI
TESH:Thisneedstobethoughtthrough.Wedon'thave*enoughinformationatthispointtorepro
gramthevnias*l2-vni.Onewayistostoretherequiredinfoinl3-vniand*useditsolelyforthi
spurpose*/}return0;}/*deleteanduninstallrmachashentry*/staticvoidzl3vni_del_rmac
_hash_entry(structhash_backet*backet,void*ctx){zebra_mac_t*zrmac=NULL;zebra_l3vn
i_t*zl3vni=NULL;zrmac=(zebra_mac_t*)backet->data;zl3vni=(zebra_l3vni_t*)ctx;zl3v
ni_rmac_uninstall(zl3vni,zrmac);zl3vni_rmac_del(zl3vni,zrmac);}/*deleteanduninst
allnhhashentry*/staticvoidzl3vni_del_nh_hash_entry(structhash_backet*backet,void
*ctx){zebra_neigh_t*n=NULL;zebra_l3vni_t*zl3vni=NULL;n=(zebra_neigh_t*)backet->d
ata;zl3vni=(zebra_l3vni_t*)ctx;zl3vni_nh_uninstall(zl3vni,n);zl3vni_nh_del(zl3vn
i,n);}staticintip_prefix_send_to_client(vrf_id_tvrf_id,structprefix*p,uint16_tcm
d){structzserv*client=NULL;structstream*s=NULL;charbuf[PREFIX_STRLEN];client=zeb
ra_find_client(ZEBRA_ROUTE_BGP,0);/*BGPmaynotberunning.*/if(!client)return0;s=st
ream_new(ZEBRA_MAX_PACKET_SIZ);zclient_create_header(s,cmd,vrf_id);stream_put(s,
p,sizeof(structprefix));/*Writepacketsize.*/stream_putw_at(s,0,stream_get_endp(s
));if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Sendipprefix%s%sonvrf%s",prefix2str(p,buf
,sizeof(buf)),(cmd==ZEBRA_IP_PREFIX_ROUTE_ADD)?"ADD":"DEL",vrf_id_to_name(vrf_id
));if(cmd==ZEBRA_IP_PREFIX_ROUTE_ADD)client->prefixadd_cnt++;elseclient->prefixd
el_cnt++;returnzebra_server_send_message(client,s);}/*re-addremotermacifneeded*/
staticintzebra_vxlan_readd_remote_rmac(zebra_l3vni_t*zl3vni,structethaddr*rmac){
charbuf[ETHER_ADDR_STRLEN];zebra_mac_t*zrmac=NULL;zrmac=zl3vni_rmac_lookup(zl3vn
i,rmac);if(!zrmac)return0;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("DelremoteRMAC%sL3V
NI%u-readd",prefix_mac2str(rmac,buf,sizeof(buf)),zl3vni->vni);zl3vni_rmac_instal
l(zl3vni,zrmac);return0;}/*Publicfunctions*/intis_l3vni_for_prefix_routes_only(v
ni_tvni){zebra_l3vni_t*zl3vni=NULL;zl3vni=zl3vni_lookup(vni);if(!zl3vni)return0;
returnCHECK_FLAG(zl3vni->filter,PREFIX_ROUTES_ONLY)?1:0;}/*handleevpnrouteinvrft
able*/voidzebra_vxlan_evpn_vrf_route_add(vrf_id_tvrf_id,structethaddr*rmac,struc
tipaddr*vtep_ip,structprefix*host_prefix){zebra_l3vni_t*zl3vni=NULL;zl3vni=zl3vn
i_from_vrf(vrf_id);if(!zl3vni||!is_l3vni_oper_up(zl3vni))return;/*addthenexthopn
eighbor*/zl3vni_remote_nh_add(zl3vni,vtep_ip,rmac,host_prefix);/*addthermac*/zl3
vni_remote_rmac_add(zl3vni,rmac,vtep_ip,host_prefix);}/*handleevpnvrfroutedelete
*/voidzebra_vxlan_evpn_vrf_route_del(vrf_id_tvrf_id,structethaddr*rmac,structipa
ddr*vtep_ip,structprefix*host_prefix){zebra_l3vni_t*zl3vni=NULL;zl3vni=zl3vni_fr
om_vrf(vrf_id);if(!zl3vni)return;/*deletethenexthopentry*/zl3vni_remote_nh_del(z
l3vni,vtep_ip,host_prefix);/*deletethermacentry*/zl3vni_remote_rmac_del(zl3vni,r
mac,host_prefix);}voidzebra_vxlan_print_specific_rmac_l3vni(structvty*vty,vni_tl
3vni,structethaddr*rmac,uint8_tuse_json){zebra_l3vni_t*zl3vni=NULL;zebra_mac_t*z
rmac=NULL;json_object*json=NULL;if(!is_evpn_enabled()){if(use_json)vty_out(vty,"
{}\n");return;}if(use_json)json=json_object_new_object();zl3vni=zl3vni_lookup(l3
vni);if(!zl3vni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%L3-VNI%udoes
ntexist\n",l3vni);return;}zrmac=zl3vni_rmac_lookup(zl3vni,rmac);if(!zrmac){if(us
e_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%RequestedRMACdoesntexistinL3-VNI%u
",l3vni);return;}zl3vni_print_rmac(zrmac,vty,json);if(use_json){vty_out(vty,"%s\
n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_fre
e(json);}}voidzebra_vxlan_print_rmacs_l3vni(structvty*vty,vni_tl3vni,uint8_tuse_
json){zebra_l3vni_t*zl3vni;uint32_tnum_rmacs;structrmac_walk_ctxwctx;json_object
*json=NULL;if(!is_evpn_enabled())return;zl3vni=zl3vni_lookup(l3vni);if(!zl3vni){
if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%L3-VNI%udoesnotexist\n",l3vni
);return;}num_rmacs=hashcount(zl3vni->rmac_table);if(!num_rmacs)return;if(use_js
on)json=json_object_new_object();memset(&wctx,0,sizeof(structrmac_walk_ctx));wct
x.vty=vty;wctx.json=json;if(!use_json){vty_out(vty,"NumberofRemoteRMACsknownfort
hisVNI:%u\n",num_rmacs);vty_out(vty,"%-17s%-21s\n","MAC","RemoteVTEP");}elsejson
_object_int_add(json,"numRmacs",num_rmacs);hash_iterate(zl3vni->rmac_table,zl3vn
i_print_rmac_hash,&wctx);if(use_json){vty_out(vty,"%s\n",json_object_to_json_str
ing_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}voidzebra_vxlan_
print_rmacs_all_l3vni(structvty*vty,uint8_tuse_json){structzebra_ns*zns=NULL;jso
n_object*json=NULL;void*args[2];if(!is_evpn_enabled()){if(use_json)vty_out(vty,"
{}\n");return;}zns=zebra_ns_lookup(NS_DEFAULT);if(!zns){if(use_json)vty_out(vty,
"{}\n");return;}if(use_json)json=json_object_new_object();args[0]=vty;args[1]=js
on;hash_iterate(zns->l3vni_table,(void(*)(structhash_backet*,void*))zl3vni_print
_rmac_hash_all_vni,args);if(use_json){vty_out(vty,"%s\n",json_object_to_json_str
ing_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}voidzebra_vxlan_
print_specific_nh_l3vni(structvty*vty,vni_tl3vni,structipaddr*ip,uint8_tuse_json
){zebra_l3vni_t*zl3vni=NULL;zebra_neigh_t*n=NULL;json_object*json=NULL;if(!is_ev
pn_enabled()){if(use_json)vty_out(vty,"{}\n");return;}if(use_json)json=json_obje
ct_new_object();zl3vni=zl3vni_lookup(l3vni);if(!zl3vni){if(use_json)vty_out(vty,
"{}\n");elsevty_out(vty,"%%L3-VNI%udoesnotexist\n",l3vni);return;}n=zl3vni_nh_lo
okup(zl3vni,ip);if(!n){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%Reques
tednext-hopnotpresentforL3-VNI%u",l3vni);return;}zl3vni_print_nh(n,vty,json);if(
use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRIN
G_PRETTY));json_object_free(json);}}voidzebra_vxlan_print_nh_l3vni(structvty*vty
,vni_tl3vni,uint8_tuse_json){uint32_tnum_nh;structnh_walk_ctxwctx;json_object*js
on=NULL;zebra_l3vni_t*zl3vni=NULL;if(!is_evpn_enabled())return;zl3vni=zl3vni_loo
kup(l3vni);if(!zl3vni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%L3-VNI
%udoesnotexist\n",l3vni);return;}num_nh=hashcount(zl3vni->nh_table);if(!num_nh)r
eturn;if(use_json)json=json_object_new_object();wctx.vty=vty;wctx.json=json;if(!
use_json){vty_out(vty,"NumberofNHNeighborsknownforthisVNI:%u\n",num_nh);vty_out(
vty,"%-15s%-17s\n","IP","RMAC");}elsejson_object_int_add(json,"numNextHops",num_
nh);hash_iterate(zl3vni->nh_table,zl3vni_print_nh_hash,&wctx);if(use_json){vty_o
ut(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json
_object_free(json);}}voidzebra_vxlan_print_nh_all_l3vni(structvty*vty,uint8_tuse
_json){structzebra_ns*zns=NULL;json_object*json=NULL;void*args[2];if(!is_evpn_en
abled()){if(use_json)vty_out(vty,"{}\n");return;}zns=zebra_ns_lookup(NS_DEFAULT)
;if(!zns)return;if(use_json)json=json_object_new_object();args[0]=vty;args[1]=js
on;hash_iterate(zns->l3vni_table,(void(*)(structhash_backet*,void*))zl3vni_print
_nh_hash_all_vni,args);if(use_json){vty_out(vty,"%s\n",json_object_to_json_strin
g_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}return;}/**DisplayL
3VNIinformation(VTYcommandhandler).*/voidzebra_vxlan_print_l3vni(structvty*vty,v
ni_tvni,uint8_tuse_json){void*args[2];json_object*json=NULL;zebra_l3vni_t*zl3vni
=NULL;if(!is_evpn_enabled()){if(use_json)vty_out(vty,"{}\n");return;}zl3vni=zl3v
ni_lookup(vni);if(!zl3vni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%VN
I%udoesnotexist\n",vni);return;}if(use_json)json=json_object_new_object();args[0
]=vty;args[1]=json;zl3vni_print(zl3vni,(void*)args);if(use_json){vty_out(vty,"%s
\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_fr
ee(json);}}voidzebra_vxlan_print_vrf_vni(structvty*vty,structzebra_vrf*zvrf,json
_object*json_vrfs){charbuf[ETHER_ADDR_STRLEN];zebra_l3vni_t*zl3vni=NULL;zl3vni=z
l3vni_lookup(zvrf->l3vni);if(!zl3vni)return;if(!json_vrfs){vty_out(vty,"%-37s%-1
0u%-20s%-20s%-5s%-18s\n",zvrf_name(zvrf),zl3vni->vni,zl3vni_vxlan_if_name(zl3vni
),zl3vni_svi_if_name(zl3vni),zl3vni_state2str(zl3vni),zl3vni_rmac2str(zl3vni,buf
,sizeof(buf)));}else{json_object*json_vrf=NULL;json_vrf=json_object_new_object()
;json_object_string_add(json_vrf,"vrf",zvrf_name(zvrf));json_object_int_add(json
_vrf,"vni",zl3vni->vni);json_object_string_add(json_vrf,"vxlanIntf",zl3vni_vxlan
_if_name(zl3vni));json_object_string_add(json_vrf,"sviIntf",zl3vni_svi_if_name(z
l3vni));json_object_string_add(json_vrf,"state",zl3vni_state2str(zl3vni));json_o
bject_string_add(json_vrf,"routerMac",zl3vni_rmac2str(zl3vni,buf,sizeof(buf)));j
son_object_array_add(json_vrfs,json_vrf);}}/**DisplayNeighborsforaVNI(VTYcommand
handler).*/voidzebra_vxlan_print_neigh_vni(structvty*vty,structzebra_vrf*zvrf,vn
i_tvni,uint8_tuse_json){zebra_vni_t*zvni;uint32_tnum_neigh;structneigh_walk_ctxw
ctx;json_object*json=NULL;if(!is_evpn_enabled())return;zvni=zvni_lookup(vni);if(
!zvni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%VNI%udoesnotexist\n",v
ni);return;}num_neigh=hashcount(zvni->neigh_table);if(!num_neigh)return;if(use_j
son)json=json_object_new_object();/*SincewehaveIPv6addressestodealwithwhichcanva
rywidelyin*size,wetrytobeabitmoreelegantindisplaybyfirstcomputing*themaximumwidt
h.*/memset(&wctx,0,sizeof(structneigh_walk_ctx));wctx.zvni=zvni;wctx.vty=vty;wct
x.addr_width=15;wctx.json=json;hash_iterate(zvni->neigh_table,zvni_find_neigh_ad
dr_width,&wctx);if(!use_json){vty_out(vty,"NumberofARPs(localandremote)knownfort
hisVNI:%u\n",num_neigh);vty_out(vty,"%*s%-6s%-17s%-21s\n",-wctx.addr_width,"IP",
"Type","MAC","RemoteVTEP");}elsejson_object_int_add(json,"numArpNd",num_neigh);h
ash_iterate(zvni->neigh_table,zvni_print_neigh_hash,&wctx);if(use_json){vty_out(
vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_ob
ject_free(json);}}/**DisplayneighborsacrossallVNIs(VTYcommandhandler).*/voidzebr
a_vxlan_print_neigh_all_vni(structvty*vty,structzebra_vrf*zvrf,uint8_tuse_json){
json_object*json=NULL;void*args[2];if(!is_evpn_enabled())return;if(use_json)json
=json_object_new_object();args[0]=vty;args[1]=json;hash_iterate(zvrf->vni_table,
(void(*)(structhash_backet*,void*))zvni_print_neigh_hash_all_vni,args);if(use_js
on){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRET
TY));json_object_free(json);}}/**DisplayspecificneighborforaVNI,ifpresent(VTYcom
mandhandler).*/voidzebra_vxlan_print_specific_neigh_vni(structvty*vty,structzebr
a_vrf*zvrf,vni_tvni,structipaddr*ip,uint8_tuse_json){zebra_vni_t*zvni;zebra_neig
h_t*n;json_object*json=NULL;if(!is_evpn_enabled())return;zvni=zvni_lookup(vni);i
f(!zvni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%VNI%udoesnotexist\n"
,vni);return;}n=zvni_neigh_lookup(zvni,ip);if(!n){if(!use_json)vty_out(vty,"%%Re
questedneighbordoesnotexistinVNI%u\n",vni);return;}if(use_json)json=json_object_
new_object();zvni_print_neigh(n,vty,json);if(use_json){vty_out(vty,"%s\n",json_o
bject_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}
}/**DisplayneighborsforaVNIfromspecificVTEP(VTYcommandhandler).*Bydefinition,the
seareremoteneighbors.*/voidzebra_vxlan_print_neigh_vni_vtep(structvty*vty,struct
zebra_vrf*zvrf,vni_tvni,structin_addrvtep_ip,uint8_tuse_json){zebra_vni_t*zvni;u
int32_tnum_neigh;structneigh_walk_ctxwctx;json_object*json=NULL;if(!is_evpn_enab
led())return;zvni=zvni_lookup(vni);if(!zvni){if(use_json)vty_out(vty,"{}\n");els
evty_out(vty,"%%VNI%udoesnotexist\n",vni);return;}num_neigh=hashcount(zvni->neig
h_table);if(!num_neigh)return;memset(&wctx,0,sizeof(structneigh_walk_ctx));wctx.
zvni=zvni;wctx.vty=vty;wctx.flags=SHOW_REMOTE_NEIGH_FROM_VTEP;wctx.r_vtep_ip=vte
p_ip;wctx.json=json;hash_iterate(zvni->neigh_table,zvni_print_neigh_hash,&wctx);
if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_ST
RING_PRETTY));json_object_free(json);}}/**DisplayMACsforaVNI(VTYcommandhandler).
*/voidzebra_vxlan_print_macs_vni(structvty*vty,structzebra_vrf*zvrf,vni_tvni,uin
t8_tuse_json){zebra_vni_t*zvni;uint32_tnum_macs;structmac_walk_ctxwctx;json_obje
ct*json=NULL;json_object*json_mac=NULL;if(!is_evpn_enabled())return;zvni=zvni_lo
okup(vni);if(!zvni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%VNI%udoes
notexist\n",vni);return;}num_macs=num_valid_macs(zvni);if(!num_macs)return;if(us
e_json){json=json_object_new_object();json_mac=json_object_new_object();}memset(
&wctx,0,sizeof(structmac_walk_ctx));wctx.zvni=zvni;wctx.vty=vty;wctx.json=json_m
ac;if(!use_json){vty_out(vty,"NumberofMACs(localandremote)knownforthisVNI:%u\n",
num_macs);vty_out(vty,"%-17s%-6s%-21s%-5s\n","MAC","Type","Intf/RemoteVTEP","VLA
N");}elsejson_object_int_add(json,"numMacs",num_macs);hash_iterate(zvni->mac_tab
le,zvni_print_mac_hash,&wctx);if(use_json){json_object_object_add(json,"macs",js
on_mac);vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_
PRETTY));json_object_free(json);}}/**DisplayMACsforallVNIs(VTYcommandhandler).*/
voidzebra_vxlan_print_macs_all_vni(structvty*vty,structzebra_vrf*zvrf,uint8_tuse
_json){structmac_walk_ctxwctx;json_object*json=NULL;if(!is_evpn_enabled()){if(us
e_json)vty_out(vty,"{}\n");return;}if(use_json)json=json_object_new_object();mem
set(&wctx,0,sizeof(structmac_walk_ctx));wctx.vty=vty;wctx.json=json;hash_iterate
(zvrf->vni_table,zvni_print_mac_hash_all_vni,&wctx);if(use_json){vty_out(vty,"%s
\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_fr
ee(json);}}/**DisplayMACsforallVNIs(VTYcommandhandler).*/voidzebra_vxlan_print_m
acs_all_vni_vtep(structvty*vty,structzebra_vrf*zvrf,structin_addrvtep_ip,uint8_t
use_json){structmac_walk_ctxwctx;json_object*json=NULL;if(!is_evpn_enabled())ret
urn;if(use_json)json=json_object_new_object();memset(&wctx,0,sizeof(structmac_wa
lk_ctx));wctx.vty=vty;wctx.flags=SHOW_REMOTE_MAC_FROM_VTEP;wctx.r_vtep_ip=vtep_i
p;wctx.json=json;hash_iterate(zvrf->vni_table,zvni_print_mac_hash_all_vni,&wctx)
;if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_S
TRING_PRETTY));json_object_free(json);}}/**DisplayspecificMACforaVNI,ifpresent(V
TYcommandhandler).*/voidzebra_vxlan_print_specific_mac_vni(structvty*vty,structz
ebra_vrf*zvrf,vni_tvni,structethaddr*macaddr){zebra_vni_t*zvni;zebra_mac_t*mac;i
f(!is_evpn_enabled())return;zvni=zvni_lookup(vni);if(!zvni){vty_out(vty,"%%VNI%u
doesnotexist\n",vni);return;}mac=zvni_mac_lookup(zvni,macaddr);if(!mac){vty_out(
vty,"%%RequestedMACdoesnotexistinVNI%u\n",vni);return;}zvni_print_mac(mac,vty);}
/**DisplayMACsforaVNIfromspecificVTEP(VTYcommandhandler).*/voidzebra_vxlan_print
_macs_vni_vtep(structvty*vty,structzebra_vrf*zvrf,vni_tvni,structin_addrvtep_ip,
uint8_tuse_json){zebra_vni_t*zvni;uint32_tnum_macs;structmac_walk_ctxwctx;json_o
bject*json=NULL;json_object*json_mac=NULL;if(!is_evpn_enabled())return;zvni=zvni
_lookup(vni);if(!zvni){if(use_json)vty_out(vty,"{}\n");elsevty_out(vty,"%%VNI%ud
oesnotexist\n",vni);return;}num_macs=num_valid_macs(zvni);if(!num_macs)return;if
(use_json){json=json_object_new_object();json_mac=json_object_new_object();}mems
et(&wctx,0,sizeof(structmac_walk_ctx));wctx.zvni=zvni;wctx.vty=vty;wctx.flags=SH
OW_REMOTE_MAC_FROM_VTEP;wctx.r_vtep_ip=vtep_ip;wctx.json=json_mac;hash_iterate(z
vni->mac_table,zvni_print_mac_hash,&wctx);if(use_json){json_object_int_add(json,
"numMacs",wctx.count);if(wctx.count)json_object_object_add(json,"macs",json_mac)
;vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY)
);json_object_free(json);}}/**DisplayVNIinformation(VTYcommandhandler).*/voidzeb
ra_vxlan_print_vni(structvty*vty,structzebra_vrf*zvrf,vni_tvni,uint8_tuse_json){
json_object*json=NULL;void*args[2];zebra_l3vni_t*zl3vni=NULL;zebra_vni_t*zvni=NU
LL;if(!is_evpn_enabled())return;if(use_json)json=json_object_new_object();args[0
]=vty;args[1]=json;zl3vni=zl3vni_lookup(vni);if(zl3vni){zl3vni_print(zl3vni,(voi
d*)args);}else{zvni=zvni_lookup(vni);if(!zvni){if(use_json)vty_out(vty,"{}\n");e
lsevty_out(vty,"%%VNI%udoesnotexist\n",vni);return;}zvni_print(zvni,(void*)args)
;}if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_
STRING_PRETTY));json_object_free(json);}}/*DisplayallglobaldetailsforEVPN*/voidz
ebra_vxlan_print_evpn(structvty*vty,uint8_tuj){intnum_l2vnis=0;intnum_l3vnis=0;i
ntnum_vnis=0;json_object*json=NULL;structzebra_ns*zns=NULL;structzebra_vrf*zvrf=
NULL;if(!is_evpn_enabled())return;zns=zebra_ns_lookup(NS_DEFAULT);if(!zns)return
;zvrf=vrf_info_lookup(VRF_DEFAULT);if(!zvrf)return;num_l3vnis=hashcount(zns->l3v
ni_table);num_l2vnis=hashcount(zvrf->vni_table);num_vnis=num_l2vnis+num_l3vnis;i
f(uj){json=json_object_new_object();json_object_string_add(json,"advertiseGatewa
yMacip",zvrf->advertise_gw_macip?"Yes":"No");json_object_int_add(json,"numVnis",
num_vnis);json_object_int_add(json,"numL2Vnis",num_l2vnis);json_object_int_add(j
son,"numL3Vnis",num_l3vnis);}else{vty_out(vty,"L2VNIs:%u\n",num_l2vnis);vty_out(
vty,"L3VNIs:%u\n",num_l3vnis);vty_out(vty,"Advertisegatewaymac-ip:%s\n",zvrf->ad
vertise_gw_macip?"Yes":"No");}if(uj){vty_out(vty,"%s\n",json_object_to_json_stri
ng_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}/**DisplayVNIhash
table(VTYcommandhandler).*/voidzebra_vxlan_print_vnis(structvty*vty,structzebra_
vrf*zvrf,uint8_tuse_json){json_object*json=NULL;structzebra_ns*zns=NULL;void*arg
s[2];if(!is_evpn_enabled())return;zns=zebra_ns_lookup(NS_DEFAULT);if(!zns)return
;if(use_json)json=json_object_new_object();elsevty_out(vty,"%-10s%-4s%-21s%-8s%-
8s%-15s%-37s\n","VNI","Type","VxLANIF","#MACs","#ARPs","#RemoteVTEPs","TenantVRF
");args[0]=vty;args[1]=json;/*DisplayallL2-VNIs*/hash_iterate(zvrf->vni_table,(v
oid(*)(structhash_backet*,void*))zvni_print_hash,args);/*DisplayallL3-VNIs*/hash
_iterate(zns->l3vni_table,(void(*)(structhash_backet*,void*))zl3vni_print_hash,a
rgs);if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_
TO_STRING_PRETTY));json_object_free(json);}}/**Handleneighbordelete(onaVLANdevic
e/L3interface)fromthe*kernel.Thismayresultineithertheneighborgettingdeletedfrom*
ourdatabaseorbeingre-addedtothekernel(ifitisavalid*remoteneighbor).*/intzebra_vx
lan_local_neigh_del(structinterface*ifp,structinterface*link_if,structipaddr*ip)
{charbuf[INET6_ADDRSTRLEN];charbuf2[ETHER_ADDR_STRLEN];zebra_neigh_t*n=NULL;zebr
a_vni_t*zvni=NULL;zebra_mac_t*zmac=NULL;zebra_l3vni_t*zl3vni=NULL;/*checkifthisi
saremoteneighentrycorrespondingtoremote*next-hop*/zl3vni=zl3vni_from_svi(ifp,lin
k_if);if(zl3vni)returnzl3vni_local_nh_del(zl3vni,ip);/*Weareonlyinterestedinneig
hborsonanSVIthatresidesontop*ofaVxLANbridge.*/zvni=zvni_from_svi(ifp,link_if);if
(!zvni)return0;if(!zvni->vxlan_if){zlog_err("VNI%uhash%pdoesn'thaveintfuponlocal
neighborDEL",zvni->vni,zvni);return-1;}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Delne
ighbor%sintf%s(%u)->L2-VNI%u",ipaddr2str(ip,buf,sizeof(buf)),ifp->name,ifp->ifin
dex,zvni->vni);/*Ifentrydoesn'texist,nothingtodo.*/n=zvni_neigh_lookup(zvni,ip);
if(!n)return0;zmac=zvni_mac_lookup(zvni,&n->emac);if(!zmac){if(IS_ZEBRA_DEBUG_VX
LAN)zlog_err("Tryingtodelaneigh%swithoutamac%sonVNI%u",ipaddr2str(ip,buf,sizeof(
buf)),prefix_mac2str(&n->emac,buf2,sizeof(buf2)),zvni->vni);return0;}/*Ifitisare
moteentry,thekernelhasagedthisoutorsomeonehas*deletedit,itneedstobere-installeda
sQuaggaistheowner.*/if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_REMOTE)){zvni_neigh_insta
ll(zvni,n);return0;}/*RemoveneighborfromBGP.*/if(IS_ZEBRA_NEIGH_ACTIVE(n))zvni_n
eigh_send_del_to_client(zvni->vni,&n->ip,&n->emac,0);/*Deletethisneighborentry.*
/zvni_neigh_del(zvni,n);/*seeiftheAUTOmacneedstobedeleted*/if(CHECK_FLAG(zmac->f
lags,ZEBRA_MAC_AUTO)&&!listcount(zmac->neigh_list))zvni_mac_del(zvni,zmac);retur
n0;}/**Handleneighboraddorupdate(onaVLANdevice/L3interface)*fromthekernel.*/intz
ebra_vxlan_local_neigh_add_update(structinterface*ifp,structinterface*link_if,st
ructipaddr*ip,structethaddr*macaddr,uint16_tstate,uint8_text_learned){charbuf[ET
HER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];zebra_vni_t*zvni=NULL;zebra_neigh_t*
n=NULL;zebra_mac_t*zmac=NULL,*old_zmac=NULL;zebra_l3vni_t*zl3vni=NULL;/*checkift
hisisaremoteneighentrycorrespondingtoremote*next-hop*/zl3vni=zl3vni_from_svi(ifp
,link_if);if(zl3vni)returnzl3vni_local_nh_add_update(zl3vni,ip,state);/*Weareonl
yinterestedinneighborsonanSVIthatresidesontop*ofaVxLANbridge.*/zvni=zvni_from_sv
i(ifp,link_if);if(!zvni)return0;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Add/Updatene
ighbor%sMAC%sintf%s(%u)state0x%x%s->L2-VNI%u",ipaddr2str(ip,buf2,sizeof(buf2)),p
refix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex,state,ext_learned?
"ext-learned":"",zvni->vni);/*createadummyMACiftheMACisnotalreadypresent*/zmac=z
vni_mac_lookup(zvni,macaddr);if(!zmac){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("AUTOM
AC%screatedforneigh%sonVNI%u",prefix_mac2str(macaddr,buf,sizeof(buf)),ipaddr2str
(ip,buf2,sizeof(buf2)),zvni->vni);zmac=zvni_mac_add(zvni,macaddr);if(!zmac){zlog
_warn("FailedtoaddMAC%sVNI%u",prefix_mac2str(macaddr,buf,sizeof(buf)),zvni->vni)
;return-1;}memset(&zmac->fwd_info,0,sizeof(zmac->fwd_info));memset(&zmac->flags,
0,sizeof(uint32_t));SET_FLAG(zmac->flags,ZEBRA_MAC_AUTO);}/*Ifsameentryalreadyex
ists,itmightbeachangeoritmightbea*movefromremotetolocal.*/n=zvni_neigh_lookup(zv
ni,ip);if(n){if(CHECK_FLAG(n->flags,ZEBRA_NEIGH_LOCAL)){if(memcmp(n->emac.octet,
macaddr->octet,ETH_ALEN)==0){/*Updateanyparamsandreturn-clientdoesn't*careabouta
purelylocalchange.*/n->ifindex=ifp->ifindex;return0;}/*IftheMAChaschanged,*needt
oissueadeletefirst*asthismeansadifferentMACIProute.*Also,needtodosomeunlinking/r
elinking.*/zvni_neigh_send_del_to_client(zvni->vni,&n->ip,&n->emac,0);old_zmac=z
vni_mac_lookup(zvni,&n->emac);if(old_zmac){listnode_delete(old_zmac->neigh_list,
n);zvni_deref_ip2mac(zvni,old_zmac,0);}/*Set"local"forwardinginfo.*/SET_FLAG(n->
flags,ZEBRA_NEIGH_LOCAL);n->ifindex=ifp->ifindex;memcpy(&n->emac,macaddr,ETH_ALE
N);/*LinktonewMAC*/listnode_add_sort(zmac->neigh_list,n);}elseif(ext_learned)/*T
heneighborisremoteandthatisthenotificationwegot.*/{/*TODO:Evaluateifweneedtodoan
ythinghere.*/return0;}else/*Neighborhasmovedfromremotetolocal.*/{UNSET_FLAG(n->f
lags,ZEBRA_NEIGH_REMOTE);n->r_vtep_ip.s_addr=0;SET_FLAG(n->flags,ZEBRA_NEIGH_LOC
AL);n->ifindex=ifp->ifindex;}}else{n=zvni_neigh_add(zvni,ip,macaddr);if(!n){zlog
_err("Failedtoaddneighbor%sMAC%sintf%s(%u)->VNI%u",ipaddr2str(ip,buf2,sizeof(buf
2)),prefix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex,zvni->vni);re
turn-1;}/*Set"local"forwardinginfo.*/SET_FLAG(n->flags,ZEBRA_NEIGH_LOCAL);n->ifi
ndex=ifp->ifindex;}/*BeforeweprogramthisinBGP,weneedtocheckifMACislocally*learnt
aswell*/if(!CHECK_FLAG(zmac->flags,ZEBRA_MAC_LOCAL)){if(IS_ZEBRA_DEBUG_VXLAN)zlo
g_debug("Skippingneigh%saddtoclientasMAC%sisnotlocalonVNI%u",ipaddr2str(ip,buf2,
sizeof(buf2)),prefix_mac2str(macaddr,buf,sizeof(buf)),zvni->vni);return0;}/*Info
rmBGP.*/if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("neigh%s(MAC%s)isnowACTIVEonL2-VNI%u"
,ipaddr2str(ip,buf2,sizeof(buf2)),prefix_mac2str(macaddr,buf,sizeof(buf)),zvni->
vni);ZEBRA_NEIGH_SET_ACTIVE(n);returnzvni_neigh_send_add_to_client(zvni->vni,ip,
macaddr,n->flags);}/**HandlemessagefromclienttodeletearemoteMACIPforaVNI.*/voidz
ebra_vxlan_remote_macip_del(ZAPI_HANDLER_ARGS){structstream*s;vni_tvni;structeth
addrmacaddr;structipaddrip;structin_addrvtep_ip;zebra_vni_t*zvni;zebra_mac_t*mac
;zebra_neigh_t*n;unsignedshortl=0,ipa_len;charbuf[ETHER_ADDR_STRLEN];charbuf1[IN
ET6_ADDRSTRLEN];structinterface*ifp=NULL;structzebra_if*zif=NULL;memset(&macaddr
,0,sizeof(structethaddr));memset(&ip,0,sizeof(structipaddr));memset(&vtep_ip,0,s
izeof(structin_addr));s=msg;while(l<hdr->length){/*ObtaineachremoteMACIPandproce
ss.*//*MessagecontainsVNI,followedbyMACfollowedbyIP(ifany)*followedbyremoteVTEPI
P.*/mac=NULL;n=NULL;memset(&ip,0,sizeof(ip));STREAM_GETL(s,vni);STREAM_GET(&maca
ddr.octet,s,ETH_ALEN);STREAM_GETL(s,ipa_len);if(ipa_len){ip.ipa_type=(ipa_len==I
PV4_MAX_BYTELEN)?IPADDR_V4:IPADDR_V6;STREAM_GET(&ip.ip.addr,s,ipa_len);}l+=4+ETH
_ALEN+4+ipa_len;STREAM_GET(&vtep_ip.s_addr,s,IPV4_MAX_BYTELEN);l+=IPV4_MAX_BYTEL
EN;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("RecvMACIPDelMAC%sIP%sVNI%uRemoteVTEP%sfro
m%s",prefix_mac2str(&macaddr,buf,sizeof(buf)),ipaddr2str(&ip,buf1,sizeof(buf1)),
vni,inet_ntoa(vtep_ip),zebra_route_string(client->proto));/*LocateVNIhashentry-e
xpectedtoexist.*/zvni=zvni_lookup(vni);if(!zvni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_de
bug("FailedtolocateVNIhashuponremoteMACIPDEL,""VNI%u",vni);continue;}ifp=zvni->v
xlan_if;if(!ifp){zlog_err("VNI%uhash%pdoesn'thaveintfuponremoteMACIPDEL",vni,zvn
i);continue;}zif=ifp->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_op
erative(ifp)||!zif->brslave_info.br_if)continue;/*TheremoteVTEPspecifiedisnormal
lyexpectedtoexist,but*itis*possiblethatthepeermaydeletetheVTEPbeforedeleting*any
MACs*referringtotheVTEP,inwhichcasethehandler(see*remote_vtep_del)*wouldhavealre
adydeletedtheMACs.*/if(!zvni_vtep_find(zvni,&vtep_ip))continue;mac=zvni_mac_look
up(zvni,&macaddr);if(ipa_len)n=zvni_neigh_lookup(zvni,&ip);if(n&&!mac){zlog_err(
"FailedtolocateMAC%sforneigh%sVNI%u",prefix_mac2str(&macaddr,buf,sizeof(buf)),ip
addr2str(&ip,buf1,sizeof(buf1)),vni);continue;}/*Iftheremotemacorneighbordoesn't
existthereisnothing*more*todo.Otherwise,uninstalltheentryandthenremoveit.*/if(!m
ac&&!n)continue;/*Ignorethedeleteifthismacisagatewaymac-ip*/if(mac&&CHECK_FLAG(m
ac->flags,ZEBRA_MAC_LOCAL)&&CHECK_FLAG(mac->flags,ZEBRA_MAC_DEF_GW)){zlog_err("%
u:IgnoreDelforMAC%sneigh%sonVNI%uasitisconfiguredasadefaultgateway",zvrf_id(zvrf
),prefix_mac2str(&macaddr,buf,sizeof(buf)),ipaddr2str(&ip,buf1,sizeof(buf1)),vni
);continue;}/*UninstallremoteneighbororMAC.*/if(n){/*WhentheMACchangesforanIP,it
ispossiblethe*clientmay*updatethenewMACbeforetryingtodeletethe"old"*neighbor*(as
thesearetwodifferentMACIProutes).Dothe*deleteonly*iftheMACmatches.*/if(CHECK_FLA
G(n->flags,ZEBRA_NEIGH_REMOTE)&&(memcmp(n->emac.octet,macaddr.octet,ETH_ALEN)==0
)){zvni_neigh_uninstall(zvni,n);zvni_neigh_del(zvni,n);zvni_deref_ip2mac(zvni,ma
c,1);}}else{if(CHECK_FLAG(mac->flags,ZEBRA_MAC_REMOTE)){zvni_process_neigh_on_re
mote_mac_del(zvni,mac);if(list_isempty(mac->neigh_list)){zvni_mac_uninstall(zvni
,mac,0);zvni_mac_del(zvni,mac);}elseSET_FLAG(mac->flags,ZEBRA_MAC_AUTO);}}}strea
m_failure:return;}/**HandlemessagefromclienttoaddaremoteMACIPforaVNI.This*couldb
ejusttheaddofaMACaddressortheaddofaneighbor*(IP+MAC).*/voidzebra_vxlan_remote_ma
cip_add(ZAPI_HANDLER_ARGS){structstream*s;vni_tvni;structethaddrmacaddr;structip
addrip;structin_addrvtep_ip;zebra_vni_t*zvni;zebra_vtep_t*zvtep;zebra_mac_t*mac,
*old_mac;zebra_neigh_t*n;unsignedshortl=0,ipa_len;intupdate_mac=0,update_neigh=0
;charbuf[ETHER_ADDR_STRLEN];charbuf1[INET6_ADDRSTRLEN];uint8_tsticky=0;uint8_tfl
ags=0;structinterface*ifp=NULL;structzebra_if*zif=NULL;memset(&macaddr,0,sizeof(
structethaddr));memset(&ip,0,sizeof(structipaddr));memset(&vtep_ip,0,sizeof(stru
ctin_addr));if(!EVPN_ENABLED(zvrf)){zlog_warn("%s:EVPNNotturnedonyetwehavereceiv
edaremote_macipaddzapicallback",__PRETTY_FUNCTION__);return;}s=msg;while(l<hdr->
length){/*ObtaineachremoteMACIPandprocess.*//*MessagecontainsVNI,followedbyMACfo
llowedbyIP(ifany)*followedbyremoteVTEPIP.*/update_mac=update_neigh=0;mac=NULL;n=
NULL;memset(&ip,0,sizeof(ip));STREAM_GETL(s,vni);STREAM_GET(&macaddr.octet,s,ETH
_ALEN);STREAM_GETL(s,ipa_len);if(ipa_len){ip.ipa_type=(ipa_len==IPV4_MAX_BYTELEN
)?IPADDR_V4:IPADDR_V6;STREAM_GET(&ip.ip.addr,s,ipa_len);}l+=4+ETH_ALEN+4+ipa_len
;STREAM_GET(&vtep_ip.s_addr,s,IPV4_MAX_BYTELEN);l+=IPV4_MAX_BYTELEN;/*Getflags-s
tickymacand/orgatewaymac*/flags=stream_getc(s);sticky=CHECK_FLAG(flags,ZEBRA_MAC
IP_TYPE_STICKY);l++;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("RecvMACIPAddMAC%sIP%sVNI
%uRemoteVTEP%swithflags0x%xfrom%s",prefix_mac2str(&macaddr,buf,sizeof(buf)),ipad
dr2str(&ip,buf1,sizeof(buf1)),vni,inet_ntoa(vtep_ip),flags,zebra_route_string(cl
ient->proto));/*LocateVNIhashentry-expectedtoexist.*/zvni=zvni_lookup(vni);if(!z
vni){zlog_err("FailedtolocateVNIhashuponremoteMACIPADD,VNI%u",vni);continue;}ifp
=zvni->vxlan_if;if(!ifp){zlog_err("VNI%uhash%pdoesn'thaveintfuponremoteMACIPadd"
,vni,zvni);continue;}zif=ifp->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!
if_is_operative(ifp)||!zif->brslave_info.br_if)continue;/*TheremoteVTEPspecified
shouldnormallyexist,butitis*possible*thatwhenpeeringcomesup,peermayadvertiseMACI
Proutes*before*advertisingtype-3routes.*/zvtep=zvni_vtep_find(zvni,&vtep_ip);if(
!zvtep){if(zvni_vtep_add(zvni,&vtep_ip)==NULL){zlog_err("FailedtoaddremoteVTEP,V
NI%uzvni%p",vni,zvni);continue;}zvni_vtep_install(zvni,&vtep_ip);}mac=zvni_mac_l
ookup(zvni,&macaddr);/*Ignoretheupdateifthemacisalreadypresentasagatewaymac*/if(
mac&&CHECK_FLAG(mac->flags,ZEBRA_MAC_DEF_GW)&&CHECK_FLAG(flags,ZEBRA_MACIP_TYPE_
GW)){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("%u:IgnoreMAC%sIP%sonVNI%uasMACisalready
configuredasgatewaymac",zvrf_id(zvrf),prefix_mac2str(&macaddr,buf,sizeof(buf)),i
paddr2str(&ip,buf1,sizeof(buf1)),vni);continue;}/*checkiftheremoteMACisunknownor
hasachange.*Ifso,thatneedstobeupdatedfirst.Notethatclientcould*installMACandMACI
Pseparatelyorjustinstallthelatter.*/if(!mac||!CHECK_FLAG(mac->flags,ZEBRA_MAC_RE
MOTE)||(CHECK_FLAG(mac->flags,ZEBRA_MAC_STICKY)?1:0)!=sticky||!IPV4_ADDR_SAME(&m
ac->fwd_info.r_vtep_ip,&vtep_ip))update_mac=1;if(update_mac){if(!mac){mac=zvni_m
ac_add(zvni,&macaddr);if(!mac){zlog_warn("FailedtoaddMAC%sVNI%uRemoteVTEP%s",pre
fix_mac2str(&macaddr,buf,sizeof(buf)),vni,inet_ntoa(vtep_ip));return;}/*IsthisMA
CcreatedforaMACIP?*/if(ipa_len)SET_FLAG(mac->flags,ZEBRA_MAC_AUTO);}/*Set"auto"a
nd"remote"forwardinginfo.*/UNSET_FLAG(mac->flags,ZEBRA_MAC_LOCAL);memset(&mac->f
wd_info,0,sizeof(mac->fwd_info));SET_FLAG(mac->flags,ZEBRA_MAC_REMOTE);mac->fwd_
info.r_vtep_ip=vtep_ip;if(sticky)SET_FLAG(mac->flags,ZEBRA_MAC_STICKY);elseUNSET
_FLAG(mac->flags,ZEBRA_MAC_STICKY);zvni_process_neigh_on_remote_mac_add(zvni,mac
);/*Installtheentry.*/zvni_mac_install(zvni,mac);}/*IfthereisnoIP,continue-after
clearingAUTOflagof*MAC.*/if(!ipa_len){UNSET_FLAG(mac->flags,ZEBRA_MAC_AUTO);cont
inue;}/*Checkiftheremoteneighboritselfisunknownorhasa*change.*Ifso,createorupdat
eandtheninstalltheentry.*/n=zvni_neigh_lookup(zvni,&ip);if(!n||!CHECK_FLAG(n->fl
ags,ZEBRA_NEIGH_REMOTE)||(memcmp(&n->emac,&macaddr,sizeof(macaddr))!=0)||!IPV4_A
DDR_SAME(&n->r_vtep_ip,&vtep_ip))update_neigh=1;if(update_neigh){if(!n){n=zvni_n
eigh_add(zvni,&ip,&macaddr);if(!n){zlog_warn("FailedtoaddNeigh%sMAC%sVNI%uRemote
VTEP%s",ipaddr2str(&ip,buf1,sizeof(buf1)),prefix_mac2str(&macaddr,buf,sizeof(buf
)),vni,inet_ntoa(vtep_ip));return;}}elseif(memcmp(&n->emac,&macaddr,sizeof(macad
dr))!=0){/*MACchange,updateneighlistforoldandnew*mac*/old_mac=zvni_mac_lookup(zv
ni,&n->emac);if(old_mac){listnode_delete(old_mac->neigh_list,n);zvni_deref_ip2ma
c(zvni,old_mac,1);}listnode_add_sort(mac->neigh_list,n);memcpy(&n->emac,&macaddr
,ETH_ALEN);}/*Set"remote"forwardinginfo.*/UNSET_FLAG(n->flags,ZEBRA_NEIGH_LOCAL)
;/*TODO:HandleMACchange.*/n->r_vtep_ip=vtep_ip;SET_FLAG(n->flags,ZEBRA_NEIGH_REM
OTE);/*Installtheentry.*/zvni_neigh_install(zvni,n);}}stream_failure:return;}/**
HandlenotificationofMACadd/updateoverVxLAN.Ifthekernelisnotifying*us,thismustinv
olveamultihomingscenario.Treatthisasimplicitdelete*ofanypriorlocalMAC.*/intzebra
_vxlan_check_del_local_mac(structinterface*ifp,structinterface*br_if,structethad
dr*macaddr,vlanid_tvid){structzebra_if*zif;structzebra_l2info_vxlan*vxl;vni_tvni
;zebra_vni_t*zvni;zebra_mac_t*mac;charbuf[ETHER_ADDR_STRLEN];zif=ifp->info;asser
t(zif);vxl=&zif->l2info.vxl;vni=vxl->vni;/*CheckifEVPNisenabled.*/if(!is_evpn_en
abled())return0;/*Locatehashentry;itisexpectedtoexist.*/zvni=zvni_lookup(vni);if
(!zvni)return0;/*Ifentrydoesn'texist,nothingtodo.*/mac=zvni_mac_lookup(zvni,maca
ddr);if(!mac)return0;/*Isitalocalentry?*/if(!CHECK_FLAG(mac->flags,ZEBRA_MAC_LOC
AL))return0;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Add/updateremoteMAC%sintf%s(%u)V
NI%u-dellocal",prefix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex,vn
i);/*RemoveMACfromBGP.*/zvni_mac_send_del_to_client(zvni->vni,macaddr,mac->flags
);/**Iftherearenoneighassociatedwiththemacdeletethemac*elsemarkitasAUTOforforwar
dreference*/if(!listcount(mac->neigh_list)){zvni_mac_del(zvni,mac);}else{UNSET_F
LAG(mac->flags,ZEBRA_MAC_LOCAL);SET_FLAG(mac->flags,ZEBRA_MAC_AUTO);}return0;}/*
*HandleremoteMACdeletebykernel;readdtheremoteMACifwehaveit.*Thiscanhappenbecause
theremoteMACentriesarealsoaddedas"dynamic",*sothekernelcanageouttheentry.*/intze
bra_vxlan_check_readd_remote_mac(structinterface*ifp,structinterface*br_if,struc
tethaddr*macaddr,vlanid_tvid){structzebra_if*zif=NULL;structzebra_l2info_vxlan*v
xl=NULL;vni_tvni;zebra_vni_t*zvni=NULL;zebra_l3vni_t*zl3vni=NULL;zebra_mac_t*mac
=NULL;charbuf[ETHER_ADDR_STRLEN];zif=ifp->info;assert(zif);vxl=&zif->l2info.vxl;
vni=vxl->vni;/*CheckifEVPNisenabled.*/if(!is_evpn_enabled())return0;/*checkifthi
sisaremoteRMACandreaddsimillartoremotemacs*/zl3vni=zl3vni_lookup(vni);if(zl3vni)
returnzebra_vxlan_readd_remote_rmac(zl3vni,macaddr);/*Locatehashentry;itisexpect
edtoexist.*/zvni=zvni_lookup(vni);if(!zvni)return0;/*Ifentrydoesn'texist,nothing
todo.*/mac=zvni_mac_lookup(zvni,macaddr);if(!mac)return0;/*Isitaremoteentry?*/if
(!CHECK_FLAG(mac->flags,ZEBRA_MAC_REMOTE))return0;if(IS_ZEBRA_DEBUG_VXLAN)zlog_d
ebug("DelremoteMAC%sintf%s(%u)VNI%u-readd",prefix_mac2str(macaddr,buf,sizeof(buf
)),ifp->name,ifp->ifindex,vni);zvni_mac_install(zvni,mac);return0;}/**Handleloca
lMACdelete(onaportorVLANcorrespondingtothisVNI).*/intzebra_vxlan_local_mac_del(s
tructinterface*ifp,structinterface*br_if,structethaddr*macaddr,vlanid_tvid){zebr
a_vni_t*zvni;zebra_mac_t*mac;charbuf[ETHER_ADDR_STRLEN];/*WeareinterestedinMACso
nlyonportsor(port,VLAN)that*maptoaVNI.*/zvni=zvni_map_vlan(ifp,br_if,vid);if(!zv
ni)return0;if(!zvni->vxlan_if){zlog_err("VNI%uhash%pdoesn'thaveintfuponlocalMACD
EL",zvni->vni,zvni);return-1;}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("DelMAC%sintf%s
(%u)VID%u->VNI%u",prefix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex
,vid,zvni->vni);/*Ifentrydoesn'texist,nothingtodo.*/mac=zvni_mac_lookup(zvni,mac
addr);if(!mac)return0;/*Isitalocalentry?*/if(!CHECK_FLAG(mac->flags,ZEBRA_MAC_LO
CAL))return0;/*RemoveMACfromBGP.*/zvni_mac_send_del_to_client(zvni->vni,macaddr,
mac->flags);/*Updatealltheneighentriesassociatedwiththismac*/zvni_process_neigh_
on_local_mac_del(zvni,mac);/**Iftherearenoneighassociatedwiththemacdeletethemac*
elsemarkitasAUTOforforwardreference*/if(!listcount(mac->neigh_list)){zvni_mac_de
l(zvni,mac);}else{UNSET_FLAG(mac->flags,ZEBRA_MAC_LOCAL);SET_FLAG(mac->flags,ZEB
RA_MAC_AUTO);}return0;}/**HandlelocalMACadd(onaportorVLANcorrespondingtothisVNI)
.*/intzebra_vxlan_local_mac_add_update(structinterface*ifp,structinterface*br_if
,structethaddr*macaddr,vlanid_tvid,uint8_tsticky){zebra_vni_t*zvni;zebra_mac_t*m
ac;charbuf[ETHER_ADDR_STRLEN];intadd=1;uint8_tmac_sticky;/*WeareinterestedinMACs
onlyonportsor(port,VLAN)that*maptoaVNI.*/zvni=zvni_map_vlan(ifp,br_if,vid);if(!z
vni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Add/Update%sMAC%sintf%s(%u)VID%u,couldn
otfindVNI",sticky?"sticky":"",prefix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,
ifp->ifindex,vid);return0;}if(!zvni->vxlan_if){zlog_err("VNI%uhash%pdoesn'thavei
ntfuponlocalMACADD",zvni->vni,zvni);return-1;}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug
("Add/Update%sMAC%sintf%s(%u)VID%u->VNI%u",sticky?"sticky":"",prefix_mac2str(mac
addr,buf,sizeof(buf)),ifp->name,ifp->ifindex,vid,zvni->vni);/*Ifsameentryalready
exists,nothingtodo.*/mac=zvni_mac_lookup(zvni,macaddr);if(mac){if(CHECK_FLAG(mac
->flags,ZEBRA_MAC_LOCAL)){mac_sticky=CHECK_FLAG(mac->flags,ZEBRA_MAC_STICKY)?1:0
;/**returnifnothinghaschanged.*informbgpifstickyflaghaschanged*updatelocallyandd
onotinformbgpiflocal*parameterslikeinterfacehaschanged*/if(mac_sticky==sticky&&m
ac->fwd_info.local.ifindex==ifp->ifindex&&mac->fwd_info.local.vid==vid){if(IS_ZE
BRA_DEBUG_VXLAN)zlog_debug("Add/Update%sMAC%sintf%s(%u)VID%u->VNI%u,""entryexist
sandhasnotchanged",sticky?"sticky":"",prefix_mac2str(macaddr,buf,sizeof(buf)),if
p->name,ifp->ifindex,vid,zvni->vni);return0;}elseif(mac_sticky!=sticky){add=1;}e
lse{add=0;/*Thisisanupdateoflocalinterface.*/}}elseif(CHECK_FLAG(mac->flags,ZEBR
A_MAC_REMOTE)){/**IfwehavealreadylearnedtheMACasaremotesticky*MAC,*thisisaoperat
orerrorandwemustlogawarning*/if(CHECK_FLAG(mac->flags,ZEBRA_MAC_STICKY)){zlog_wa
rn("MAC%sisalreadylearntasaremotestickymacbehindVTEP%sVNI%d",prefix_mac2str(maca
ddr,buf,sizeof(buf)),inet_ntoa(mac->fwd_info.r_vtep_ip),zvni->vni);return0;}}}if
(!mac){mac=zvni_mac_add(zvni,macaddr);if(!mac){zlog_err("FailedtoaddMAC%sintf%s(
%u)VID%u",prefix_mac2str(macaddr,buf,sizeof(buf)),ifp->name,ifp->ifindex,vid);re
turn-1;}}/*Set"local"forwardinginfo.*/UNSET_FLAG(mac->flags,ZEBRA_MAC_REMOTE);UN
SET_FLAG(mac->flags,ZEBRA_MAC_AUTO);SET_FLAG(mac->flags,ZEBRA_MAC_LOCAL);memset(
&mac->fwd_info,0,sizeof(mac->fwd_info));mac->fwd_info.local.ifindex=ifp->ifindex
;mac->fwd_info.local.vid=vid;if(sticky)SET_FLAG(mac->flags,ZEBRA_MAC_STICKY);els
eUNSET_FLAG(mac->flags,ZEBRA_MAC_STICKY);/*InformBGPifrequired.*/if(add){zvni_pr
ocess_neigh_on_local_mac_add(zvni,mac);returnzvni_mac_send_add_to_client(zvni->v
ni,macaddr,mac->flags);}return0;}/**HandlemessagefromclienttodeletearemoteVTEPfo
raVNI.*/voidzebra_vxlan_remote_vtep_del(ZAPI_HANDLER_ARGS){structstream*s;unsign
edshortl=0;vni_tvni;structin_addrvtep_ip;zebra_vni_t*zvni;zebra_vtep_t*zvtep;str
uctinterface*ifp;structzebra_if*zif;if(!is_evpn_enabled()){zlog_warn("%s:EVPNisn
otenabledyetwehavereceivedavtepdelcommand",__PRETTY_FUNCTION__);return;}if(zvrf_
id(zvrf)!=VRF_DEFAULT){zlog_err("RecvMACIPDELfornon-defaultVRF%u",zvrf_id(zvrf))
;return;}s=msg;while(l<hdr->length){/*ObtaineachremoteVTEPandprocess.*/STREAM_GE
TL(s,vni);l+=4;STREAM_GET(&vtep_ip.s_addr,s,IPV4_MAX_BYTELEN);l+=IPV4_MAX_BYTELE
N;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("RecvVTEP_DEL%sVNI%ufrom%s",inet_ntoa(vtep_
ip),vni,zebra_route_string(client->proto));/*LocateVNIhashentry-expectedtoexist.
*/zvni=zvni_lookup(vni);if(!zvni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Failedtolo
cateVNIhashuponremoteVTEPDEL,""VNI%u",vni);continue;}ifp=zvni->vxlan_if;if(!ifp)
{zlog_err("VNI%uhash%pdoesn'thaveintfuponremoteVTEPDEL",zvni->vni,zvni);continue
;}zif=ifp->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_operative(ifp
)||!zif->brslave_info.br_if)continue;/*IftheremoteVTEPdoesnotexist,there'snothin
gmoreto*do.*Otherwise,uninstallanyremoteMACspointingtothisVTEP*and*then,theVTEPe
ntryitselfandremoveit.*/zvtep=zvni_vtep_find(zvni,&vtep_ip);if(!zvtep)continue;z
vni_neigh_del_from_vtep(zvni,1,&vtep_ip);zvni_mac_del_from_vtep(zvni,1,&vtep_ip)
;zvni_vtep_uninstall(zvni,&vtep_ip);zvni_vtep_del(zvni,zvtep);}stream_failure:re
turn;}/**HandlemessagefromclienttoaddaremoteVTEPforaVNI.*/voidzebra_vxlan_remote
_vtep_add(ZAPI_HANDLER_ARGS){structstream*s;unsignedshortl=0;vni_tvni;structin_a
ddrvtep_ip;zebra_vni_t*zvni;structinterface*ifp;structzebra_if*zif;if(!is_evpn_e
nabled()){zlog_warn("%s:EVPNnotenabledyetwereceivedavtep_addzapicall",__PRETTY_F
UNCTION__);return;}if(zvrf_id(zvrf)!=VRF_DEFAULT){zlog_err("RecvMACIPADDfornon-d
efaultVRF%u",zvrf_id(zvrf));return;}s=msg;while(l<hdr->length){/*Obtaineachremot
eVTEPandprocess.*/STREAM_GETL(s,vni);l+=4;STREAM_GET(&vtep_ip.s_addr,s,IPV4_MAX_
BYTELEN);l+=IPV4_MAX_BYTELEN;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("RecvVTEP_ADD%sV
NI%ufrom%s",inet_ntoa(vtep_ip),vni,zebra_route_string(client->proto));/*LocateVN
Ihashentry-expectedtoexist.*/zvni=zvni_lookup(vni);if(!zvni){zlog_err("Failedtol
ocateVNIhashuponremoteVTEPADD,VNI%u",vni);continue;}ifp=zvni->vxlan_if;if(!ifp){
zlog_err("VNI%uhash%pdoesn'thaveintfuponremoteVTEPADD",zvni->vni,zvni);continue;
}zif=ifp->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_operative(ifp)
||!zif->brslave_info.br_if)continue;/*IftheremoteVTEPalreadyexists,there'snothin
gmoretodo.*/if(zvni_vtep_find(zvni,&vtep_ip))continue;if(zvni_vtep_add(zvni,&vte
p_ip)==NULL){zlog_err("FailedtoaddremoteVTEP,VNI%uzvni%p",vni,zvni);continue;}zv
ni_vtep_install(zvni,&vtep_ip);}stream_failure:return;}/**Add/Delgatewaymaciptoe
vpn*g/wcanbe:*1.SVIinterfaceonavlanawarebridge*2.SVIinterfaceonavlanunawarebridg
e*3.vrrinterface(MACVLAN)associatedtoaSVI*Weadvertisemaciproutesforaninterfaceif
itisassociatedtoVxLanvlan*/intzebra_vxlan_add_del_gw_macip(structinterface*ifp,s
tructprefix*p,intadd){structipaddrip;structethaddrmacaddr;zebra_vni_t*zvni=NULL;
memset(&ip,0,sizeof(structipaddr));memset(&macaddr,0,sizeof(structethaddr));/*Ch
eckifEVPNisenabled.*/if(!is_evpn_enabled())return0;if(IS_ZEBRA_IF_MACVLAN(ifp)){
structinterface*svi_if=NULL;/*SVIcorrespondingtotheMACVLAN*/structzebra_if*ifp_z
if=NULL;/*ZebradaemonspecificinfoforMACVLAN*/structzebra_if*svi_if_zif=NULL;/*Ze
bradaemonspecificinfoforSVI*/ifp_zif=ifp->info;if(!ifp_zif)return-1;/**foraMACVL
ANinterfacethelinkrepresentsthesvi_if*/svi_if=if_lookup_by_index_per_ns(zebra_ns
_lookup(NS_DEFAULT),ifp_zif->link_ifindex);if(!svi_if){zlog_err("MACVLAN%s(%u)wi
thoutlinkinformation",ifp->name,ifp->ifindex);return-1;}if(IS_ZEBRA_IF_VLAN(svi_
if)){/**Ifitisavlanawarebridgethenthelinkgivesthe*bridgeinformation*/structinter
face*svi_if_link=NULL;svi_if_zif=svi_if->info;if(svi_if_zif){svi_if_link=if_look
up_by_index_per_ns(zebra_ns_lookup(NS_DEFAULT),svi_if_zif->link_ifindex);zvni=zv
ni_from_svi(svi_if,svi_if_link);}}elseif(IS_ZEBRA_IF_BRIDGE(svi_if)){/**Ifitisav
lanunawarebridgethensviisthebridge*itself*/zvni=zvni_from_svi(svi_if,svi_if);}}e
lseif(IS_ZEBRA_IF_VLAN(ifp)){structzebra_if*svi_if_zif=NULL;/*Zebradaemonspecifi
cinfoforSVI*/structinterface*svi_if_link=NULL;/*linkinfofortheSVI=bridgeinfo*/sv
i_if_zif=ifp->info;svi_if_link=if_lookup_by_index_per_ns(zebra_ns_lookup(NS_DEFA
ULT),svi_if_zif->link_ifindex);if(svi_if_zif&&svi_if_link)zvni=zvni_from_svi(ifp
,svi_if_link);}elseif(IS_ZEBRA_IF_BRIDGE(ifp)){zvni=zvni_from_svi(ifp,ifp);}if(!
zvni)return0;if(!zvni->vxlan_if){zlog_err("VNI%uhash%pdoesn'thaveintfuponMACVLAN
up",zvni->vni,zvni);return-1;}memcpy(&macaddr.octet,ifp->hw_addr,ETH_ALEN);if(p-
>family==AF_INET){ip.ipa_type=IPADDR_V4;memcpy(&(ip.ipaddr_v4),&(p->u.prefix4),s
izeof(structin_addr));}elseif(p->family==AF_INET6){ip.ipa_type=IPADDR_V6;memcpy(
&(ip.ipaddr_v6),&(p->u.prefix6),sizeof(structin6_addr));}if(add)zvni_gw_macip_ad
d(ifp,zvni,&macaddr,&ip);elsezvni_gw_macip_del(ifp,zvni,&ip);return0;}/**HandleS
VIinterfacegoingdown.*SVIcanbeassociatedtoeitherL3-VNIorL2-VNI.*ForL2-VNI:Atthis
point,thisisaNOPsince*thekerneldeletestheneighborentriesonthisSVI(ifany).*Weonly
needtoupdatethevrfcorrespondingtozvni.*ForL3-VNI:L3-VNIisoperationallydown,updat
emac-iproutesanddelete*frombgp*/intzebra_vxlan_svi_down(structinterface*ifp,stru
ctinterface*link_if){zebra_l3vni_t*zl3vni=NULL;zl3vni=zl3vni_from_svi(ifp,link_i
f);if(zl3vni){/*processl3-vnidown*/zebra_vxlan_process_l3vni_oper_down(zl3vni);/
*removeassociationwithsvi-if*/zl3vni->svi_if=NULL;}else{zebra_vni_t*zvni=NULL;/*
sincewedonthavesvicorrespondingtozvni,weassociateit*todefaultvrf.Note:thecorresp
ondingneighentriesonthe*SVIwouldhavealreadybeendeleted*/zvni=zvni_from_svi(ifp,l
ink_if);if(zvni){zvni->vrf_id=VRF_DEFAULT;/*updatethetenantvrfinBGP*/zvni_send_a
dd_to_client(zvni);}}return0;}/**HandleSVIinterfacecomingup.*SVIcanbeassociatedt
oL3-VNI(l3vnivxlaninterface)orL2-VNI(l2-vni*vxlanintf).*ForL2-VNI:weneedtoinstal
lanyremoteneighborsentried(usedfor*apr-suppression)*ForL3-VNI:SVIwillbeusedtoget
thermactobeusedwithL3-VNI*/intzebra_vxlan_svi_up(structinterface*ifp,structinter
face*link_if){zebra_vni_t*zvni=NULL;zebra_l3vni_t*zl3vni=NULL;zl3vni=zl3vni_from
_svi(ifp,link_if);if(zl3vni){/*associatewithsvi*/zl3vni->svi_if=ifp;/*processope
r-up*/if(is_l3vni_oper_up(zl3vni))zebra_vxlan_process_l3vni_oper_up(zl3vni);}els
e{/*processSVIupforl2-vni*/structneigh_walk_ctxn_wctx;zvni=zvni_from_svi(ifp,lin
k_if);if(!zvni)return0;if(!zvni->vxlan_if){zlog_err("VNI%uhash%pdoesn'thaveintfu
ponSVIup",zvni->vni,zvni);return-1;}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("SVI%s(%u
)VNI%uVRF%sisUP,installingneighbors",ifp->name,ifp->ifindex,zvni->vni,vrf_id_to_
name(ifp->vrf_id));/*updatethevrfinformationforl2-vniandinformbgp*/zvni->vrf_id=
ifp->vrf_id;zvni_send_add_to_client(zvni);/*InstallanyremoteneighborsforthisVNI.
*/memset(&n_wctx,0,sizeof(structneigh_walk_ctx));n_wctx.zvni=zvni;hash_iterate(z
vni->neigh_table,zvni_install_neigh_hash,&n_wctx);}return0;}/**HandleVxLANinterf
acedown*/intzebra_vxlan_if_down(structinterface*ifp){vni_tvni;structzebra_if*zif
=NULL;structzebra_l2info_vxlan*vxl=NULL;zebra_l3vni_t*zl3vni=NULL;zebra_vni_t*zv
ni;/*CheckifEVPNisenabled.*/if(!is_evpn_enabled())return0;zif=ifp->info;assert(z
if);vxl=&zif->l2info.vxl;vni=vxl->vni;zl3vni=zl3vni_lookup(vni);if(zl3vni){/*pro
cess-if-downforl3-vni*/if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Intf%s(%u)L3-VNI%uisD
OWN",ifp->name,ifp->ifindex,vni);zebra_vxlan_process_l3vni_oper_down(zl3vni);}el
se{/*processif-downforl2-vni*/if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Intf%s(%u)L2-V
NI%uisDOWN",ifp->name,ifp->ifindex,vni);/*Locatehashentry;itisexpectedtoexist.*/
zvni=zvni_lookup(vni);if(!zvni){zlog_err("FailedtolocateVNIhashatDOWN,IF%s(%u)VN
I%u",ifp->name,ifp->ifindex,vni);return-1;}assert(zvni->vxlan_if==ifp);/*Deletet
hisVNIfromBGP.*/zvni_send_del_to_client(zvni->vni);/*FreeupallneighborsandMACs,i
fany.*/zvni_neigh_del_all(zvni,1,0,DEL_ALL_NEIGH);zvni_mac_del_all(zvni,1,0,DEL_
ALL_MAC);/*FreeupallremoteVTEPs,ifany.*/zvni_vtep_del_all(zvni,1);}return0;}/**H
andleVxLANinterfaceup-updateBGPifrequired.*/intzebra_vxlan_if_up(structinterface
*ifp){vni_tvni;structzebra_if*zif=NULL;structzebra_l2info_vxlan*vxl=NULL;zebra_v
ni_t*zvni=NULL;zebra_l3vni_t*zl3vni=NULL;/*CheckifEVPNisenabled.*/if(!is_evpn_en
abled())return0;zif=ifp->info;assert(zif);vxl=&zif->l2info.vxl;vni=vxl->vni;zl3v
ni=zl3vni_lookup(vni);if(zl3vni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Intf%s(%u)L
3-VNI%uisUP",ifp->name,ifp->ifindex,vni);/*weneedtoassociatewithSVI,ifany,wecana
ssociatewith*svi-ifonlyafterassociationwithvxlan-intfiscomplete*/zl3vni->svi_if=
zl3vni_map_to_svi_if(zl3vni);if(is_l3vni_oper_up(zl3vni))zebra_vxlan_process_l3v
ni_oper_up(zl3vni);}else{/*HandleL2-VNIadd*/structinterface*vlan_if=NULL;if(IS_Z
EBRA_DEBUG_VXLAN)zlog_debug("Intf%s(%u)L2-VNI%uisUP",ifp->name,ifp->ifindex,vni)
;/*Locatehashentry;itisexpectedtoexist.*/zvni=zvni_lookup(vni);if(!zvni){zlog_er
r("FailedtolocateVNIhashatUP,IF%s(%u)VNI%u",ifp->name,ifp->ifindex,vni);return-1
;}assert(zvni->vxlan_if==ifp);vlan_if=zvni_map_to_svi(vxl->access_vlan,zif->brsl
ave_info.br_if);if(vlan_if){zvni->vrf_id=vlan_if->vrf_id;zl3vni=zl3vni_from_vrf(
vlan_if->vrf_id);if(zl3vni)listnode_add_sort(zl3vni->l2vnis,zvni);}/*Ifpartofabr
idge,informBGPaboutthisVNI.*//*Also,readandpopulatelocalMACsandneighbors.*/if(zi
f->brslave_info.br_if){zvni_send_add_to_client(zvni);zvni_read_mac_neigh(zvni,if
p);}}return0;}/**HandleVxLANinterfacedelete.Locateandremoveentryinhashtable*andu
pdateBGP,ifrequired.*/intzebra_vxlan_if_del(structinterface*ifp){vni_tvni;struct
zebra_if*zif=NULL;structzebra_l2info_vxlan*vxl=NULL;zebra_vni_t*zvni=NULL;zebra_
l3vni_t*zl3vni=NULL;/*CheckifEVPNisenabled.*/if(!is_evpn_enabled())return0;zif=i
fp->info;assert(zif);vxl=&zif->l2info.vxl;vni=vxl->vni;zl3vni=zl3vni_lookup(vni)
;if(zl3vni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("DelL3-VNI%uintf%s(%u)",vni,ifp->
name,ifp->ifindex);/*processoper-downforl3-vni*/zebra_vxlan_process_l3vni_oper_d
own(zl3vni);/*removetheassociationwithvxlan_if*/memset(&zl3vni->local_vtep_ip,0,
sizeof(structin_addr));zl3vni->vxlan_if=NULL;}else{/*processif-delforl2-vni*/if(
IS_ZEBRA_DEBUG_VXLAN)zlog_debug("DelL2-VNI%uintf%s(%u)",vni,ifp->name,ifp->ifind
ex);/*Locatehashentry;itisexpectedtoexist.*/zvni=zvni_lookup(vni);if(!zvni){zlog
_err("FailedtolocateVNIhashatdel,IF%s(%u)VNI%u",ifp->name,ifp->ifindex,vni);retu
rn0;}/*removefroml3-vnilist*/zl3vni=zl3vni_from_vrf(zvni->vrf_id);if(zl3vni)list
node_delete(zl3vni->l2vnis,zvni);/*DeleteVNIfromBGP.*/zvni_send_del_to_client(zv
ni->vni);/*FreeupallneighborsandMAC,ifany.*/zvni_neigh_del_all(zvni,0,0,DEL_ALL_
NEIGH);zvni_mac_del_all(zvni,0,0,DEL_ALL_MAC);/*FreeupallremoteVTEPs,ifany.*/zvn
i_vtep_del_all(zvni,0);/*Deletethehashentry.*/if(zvni_del(zvni)){zlog_err("Faile
dtodelVNIhash%p,IF%s(%u)VNI%u",zvni,ifp->name,ifp->ifindex,zvni->vni);return-1;}
}return0;}/**HandleVxLANinterfaceupdate-changetotunnelIP,masterorVLAN.*/intzebra
_vxlan_if_update(structinterface*ifp,uint16_tchgflags){vni_tvni;structzebra_if*z
if=NULL;structzebra_l2info_vxlan*vxl=NULL;zebra_vni_t*zvni=NULL;zebra_l3vni_t*zl
3vni=NULL;/*CheckifEVPNisenabled.*/if(!is_evpn_enabled())return0;zif=ifp->info;a
ssert(zif);vxl=&zif->l2info.vxl;vni=vxl->vni;zl3vni=zl3vni_lookup(vni);if(zl3vni
){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("UpdateL3-VNI%uintf%s(%u)VLAN%ulocalIP%smas
ter%uchg0x%x",vni,ifp->name,ifp->ifindex,vxl->access_vlan,inet_ntoa(vxl->vtep_ip
),zif->brslave_info.bridge_ifindex,chgflags);/*Removedfrombridge?Cleanupandretur
n*/if((chgflags&ZEBRA_VXLIF_MASTER_CHANGE)&&(zif->brslave_info.bridge_ifindex==I
FINDEX_INTERNAL)){zebra_vxlan_process_l3vni_oper_down(zl3vni);return0;}/*access-
vlanchange-processoperdown,associatewithnew*svi_ifandthenprocessoperupagain*/if(
chgflags&ZEBRA_VXLIF_VLAN_CHANGE){if(if_is_operative(ifp)){zebra_vxlan_process_l
3vni_oper_down(zl3vni);zl3vni->svi_if=NULL;zl3vni->svi_if=zl3vni_map_to_svi_if(z
l3vni);zl3vni->local_vtep_ip=vxl->vtep_ip;if(is_l3vni_oper_up(zl3vni))zebra_vxla
n_process_l3vni_oper_up(zl3vni);}}/**local-ipchange-processoperdown,associatewit
hnew*local-ipandthenprocessoperupagain*/if(chgflags&ZEBRA_VXLIF_LOCAL_IP_CHANGE)
{if(if_is_operative(ifp)){zebra_vxlan_process_l3vni_oper_down(zl3vni);zl3vni->lo
cal_vtep_ip=vxl->vtep_ip;if(is_l3vni_oper_up(zl3vni))zebra_vxlan_process_l3vni_o
per_up(zl3vni);}}/*UpdatelocaltunnelIP.*/zl3vni->local_vtep_ip=vxl->vtep_ip;/*if
wehaveavalidnewmaster,processl3-vnioperup*/if(chgflags&ZEBRA_VXLIF_MASTER_CHANGE
){if(if_is_operative(ifp)&&is_l3vni_oper_up(zl3vni))zebra_vxlan_process_l3vni_op
er_up(zl3vni);}}else{/*UpdateVNIhash.*/zvni=zvni_lookup(vni);if(!zvni){zlog_err(
"FailedtofindL2-VNIhashonupdate,IF%s(%u)VNI%u",ifp->name,ifp->ifindex,vni);retur
n-1;}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("UpdateL2-VNI%uintf%s(%u)VLAN%ulocalIP%s
master%uchg0x%x",vni,ifp->name,ifp->ifindex,vxl->access_vlan,inet_ntoa(vxl->vtep
_ip),zif->brslave_info.bridge_ifindex,chgflags);/*Removedfrombridge?Cleanupandre
turn*/if((chgflags&ZEBRA_VXLIF_MASTER_CHANGE)&&(zif->brslave_info.bridge_ifindex
==IFINDEX_INTERNAL)){/*Deletefromclient,removeallremoteVTEPs*//*Also,freeupallMA
Csandneighbors.*/zvni_send_del_to_client(zvni->vni);zvni_neigh_del_all(zvni,1,0,
DEL_ALL_NEIGH);zvni_mac_del_all(zvni,1,0,DEL_ALL_MAC);zvni_vtep_del_all(zvni,1);
return0;}/*Handleotherchanges.*/if(chgflags&ZEBRA_VXLIF_VLAN_CHANGE){/*Removeall
existinglocalneighandMACsforthisVNI*(includingfromBGP)*/zvni_neigh_del_all(zvni,
0,1,DEL_LOCAL_MAC);zvni_mac_del_all(zvni,0,1,DEL_LOCAL_MAC);}zvni->local_vtep_ip
=vxl->vtep_ip;zvni->vxlan_if=ifp;/*Takefurtheractionsneeded.*Notethatifwearehere
,thereisachangeofinterest.*//*Ifdownornotmappedtoabridge,we'redone.*/if(!if_is_o
perative(ifp)||!zif->brslave_info.br_if)return0;/*InformBGP,ifthereisachangeofin
terest.*/if(chgflags&(ZEBRA_VXLIF_MASTER_CHANGE|ZEBRA_VXLIF_LOCAL_IP_CHANGE))zvn
i_send_add_to_client(zvni);/*IfthereisavalidnewmasteroraVLANmappingchange,*reada
ndpopulatelocalMACsandneighbors.*Also,reinstallanyremoteMACsandneighbors*forthis
VNI(basedonnewVLAN).*/if(chgflags&ZEBRA_VXLIF_MASTER_CHANGE)zvni_read_mac_neigh(
zvni,ifp);elseif(chgflags&ZEBRA_VXLIF_VLAN_CHANGE){structmac_walk_ctxm_wctx;stru
ctneigh_walk_ctxn_wctx;zvni_read_mac_neigh(zvni,ifp);memset(&m_wctx,0,sizeof(str
uctmac_walk_ctx));m_wctx.zvni=zvni;hash_iterate(zvni->mac_table,zvni_install_mac
_hash,&m_wctx);memset(&n_wctx,0,sizeof(structneigh_walk_ctx));n_wctx.zvni=zvni;h
ash_iterate(zvni->neigh_table,zvni_install_neigh_hash,&n_wctx);}}return0;}/**Han
dleVxLANinterfaceadd.*/intzebra_vxlan_if_add(structinterface*ifp){vni_tvni;struc
tzebra_if*zif=NULL;structzebra_l2info_vxlan*vxl=NULL;zebra_vni_t*zvni=NULL;zebra
_l3vni_t*zl3vni=NULL;/*CheckifEVPNisenabled.*/if(!is_evpn_enabled())return0;zif=
ifp->info;assert(zif);vxl=&zif->l2info.vxl;vni=vxl->vni;zl3vni=zl3vni_lookup(vni
);if(zl3vni){/*processif-addforl3-vni*/if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("AddL3
-VNI%uintf%s(%u)VLAN%ulocalIP%smaster%u",vni,ifp->name,ifp->ifindex,vxl->access_
vlan,inet_ntoa(vxl->vtep_ip),zif->brslave_info.bridge_ifindex);/*associatewithvx
lan_if*/zl3vni->local_vtep_ip=vxl->vtep_ip;zl3vni->vxlan_if=ifp;/*AssociatewithS
VI,ifany.Wecanassociatewithsvi-ifonly*afterassociationwithvxlan_ifiscomplete*/zl
3vni->svi_if=zl3vni_map_to_svi_if(zl3vni);if(is_l3vni_oper_up(zl3vni))zebra_vxla
n_process_l3vni_oper_up(zl3vni);}else{/*processif-addforl2-vni*/structinterface*
vlan_if=NULL;/*CreateorupdateVNIhash.*/zvni=zvni_lookup(vni);if(!zvni){zvni=zvni
_add(vni);if(!zvni){zlog_err("FailedtoaddVNIhash,IF%s(%u)VNI%u",ifp->name,ifp->i
findex,vni);return-1;}}zvni->local_vtep_ip=vxl->vtep_ip;zvni->vxlan_if=ifp;vlan_
if=zvni_map_to_svi(vxl->access_vlan,zif->brslave_info.br_if);if(vlan_if){zvni->v
rf_id=vlan_if->vrf_id;zl3vni=zl3vni_from_vrf(vlan_if->vrf_id);if(zl3vni)listnode
_add_sort(zl3vni->l2vnis,zvni);}if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("AddL2-VNI%uV
RF%sintf%s(%u)VLAN%ulocalIP%smaster%u",vni,vlan_if?vrf_id_to_name(vlan_if->vrf_i
d):"Default",ifp->name,ifp->ifindex,vxl->access_vlan,inet_ntoa(vxl->vtep_ip),zif
->brslave_info.bridge_ifindex);/*Ifdownornotmappedtoabridge,we'redone.*/if(!if_i
s_operative(ifp)||!zif->brslave_info.br_if)return0;/*InformBGP*/zvni_send_add_to
_client(zvni);/*ReadandpopulatelocalMACsandneighbors*/zvni_read_mac_neigh(zvni,i
fp);}return0;}intzebra_vxlan_process_vrf_vni_cmd(structzebra_vrf*zvrf,vni_tvni,c
har*err,interr_str_sz,intfilter,intadd){zebra_l3vni_t*zl3vni=NULL;structzebra_vr
f*zvrf_default=NULL;zvrf_default=zebra_vrf_lookup_by_id(VRF_DEFAULT);if(!zvrf_de
fault)return-1;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("vrf%svni%u%s",zvrf_name(zvrf)
,vni,add?"ADD":"DEL");if(add){zebra_vxlan_handle_vni_transition(zvrf,vni,add);/*
checkifthevniisalreadypresentunderzvrf*/if(zvrf->l3vni){snprintf(err,err_str_sz,
"VNIisalreadyconfiguredunderthevrf");return-1;}/*checkifthisVNIisalreadypresenti
nthesystem*/zl3vni=zl3vni_lookup(vni);if(zl3vni){snprintf(err,err_str_sz,"VNIisa
lreadyconfiguredasL3-VNI");return-1;}/*addtheL3-VNItotheglobaltable*/zl3vni=zl3v
ni_add(vni,zvrf_id(zvrf));if(!zl3vni){snprintf(err,err_str_sz,"CouldnotaddL3-VNI
");return-1;}/*associatethevrfwithvni*/zvrf->l3vni=vni;/*setthefilterinl3vnitode
noteifweareusingl3vnionly*forprefixroutes*/if(filter)SET_FLAG(zl3vni->filter,PRE
FIX_ROUTES_ONLY);/*associatewithvxlan-intf;*weneedtoassociatewiththevxlan-intffi
rst*/zl3vni->vxlan_if=zl3vni_map_to_vxlan_if(zl3vni);/*associatewithcorrespondin
gSVIinterface,wecanassociate*withsvi-ifonlyaftervxlaninterfaceassociationis*comp
lete*/zl3vni->svi_if=zl3vni_map_to_svi_if(zl3vni);/*formulatel2vnilist*/hash_ite
rate(zvrf_default->vni_table,zvni_add_to_l3vni_list,zl3vni);if(is_l3vni_oper_up(
zl3vni))zebra_vxlan_process_l3vni_oper_up(zl3vni);}else{zl3vni=zl3vni_lookup(vni
);if(!zl3vni){snprintf(err,err_str_sz,"VNIdoesn'texist");return-1;}zebra_vxlan_p
rocess_l3vni_oper_down(zl3vni);/*deleteanduninstallallrmacs*/hash_iterate(zl3vni
->rmac_table,zl3vni_del_rmac_hash_entry,zl3vni);/*deleteanduninstallallnext-hops
*/hash_iterate(zl3vni->nh_table,zl3vni_del_nh_hash_entry,zl3vni);zvrf->l3vni=0;z
l3vni_del(zl3vni);zebra_vxlan_handle_vni_transition(zvrf,vni,add);}return0;}intz
ebra_vxlan_vrf_enable(structzebra_vrf*zvrf){zebra_l3vni_t*zl3vni=NULL;if(zvrf->l
3vni)zl3vni=zl3vni_lookup(zvrf->l3vni);if(!zl3vni)return0;zl3vni->vrf_id=zvrf_id
(zvrf);if(is_l3vni_oper_up(zl3vni))zebra_vxlan_process_l3vni_oper_up(zl3vni);ret
urn0;}intzebra_vxlan_vrf_disable(structzebra_vrf*zvrf){zebra_l3vni_t*zl3vni=NULL
;if(zvrf->l3vni)zl3vni=zl3vni_lookup(zvrf->l3vni);if(!zl3vni)return0;zl3vni->vrf
_id=VRF_UNKNOWN;zebra_vxlan_process_l3vni_oper_down(zl3vni);return0;}intzebra_vx
lan_vrf_delete(structzebra_vrf*zvrf){zebra_l3vni_t*zl3vni=NULL;vni_tvni;if(zvrf-
>l3vni)zl3vni=zl3vni_lookup(zvrf->l3vni);if(!zl3vni)return0;vni=zl3vni->vni;zl3v
ni_del(zl3vni);zebra_vxlan_handle_vni_transition(zvrf,vni,0);return0;}/**Handlem
essagefromclienttoenable/disableadvertisementofg/wmacip*routes*/voidzebra_vxlan_
advertise_subnet(ZAPI_HANDLER_ARGS){structstream*s;intadvertise;vni_tvni=0;zebra
_vni_t*zvni=NULL;structinterface*ifp=NULL;structzebra_if*zif=NULL;structzebra_l2
info_vxlanzl2_info;structinterface*vlan_if=NULL;if(zvrf_id(zvrf)!=VRF_DEFAULT){z
log_err("EVPNGW-MACIPAdvfornon-defaultVRF%u",zvrf_id(zvrf));return;}s=msg;advert
ise=stream_getc(s);vni=stream_get3(s);zvni=zvni_lookup(vni);if(!zvni)return;if(z
vni->advertise_subnet==advertise)return;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("EVPN
subnetAdv%sonVNI%d,currently%s",advertise?"enabled":"disabled",vni,zvni->adverti
se_subnet?"enabled":"disabled");zvni->advertise_subnet=advertise;ifp=zvni->vxlan
_if;if(!ifp)return;zif=ifp->info;/*Ifdownornotmappedtoabridge,we'redone.*/if(!if
_is_operative(ifp)||!zif->brslave_info.br_if)return;zl2_info=zif->l2info.vxl;vla
n_if=zvni_map_to_svi(zl2_info.access_vlan,zif->brslave_info.br_if);if(!vlan_if)r
eturn;if(zvni->advertise_subnet)zvni_advertise_subnet(zvni,vlan_if,1);elsezvni_a
dvertise_subnet(zvni,vlan_if,0);}/**Handlemessagefromclienttoenable/disableadver
tisementofg/wmacip*routes*/voidzebra_vxlan_advertise_gw_macip(ZAPI_HANDLER_ARGS)
{structstream*s;intadvertise;vni_tvni=0;zebra_vni_t*zvni=NULL;structinterface*if
p=NULL;if(zvrf_id(zvrf)!=VRF_DEFAULT){zlog_err("EVPNGW-MACIPAdvfornon-defaultVRF
%u",zvrf_id(zvrf));return;}s=msg;STREAM_GETC(s,advertise);STREAM_GET(&vni,s,3);i
f(!vni){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("EVPNgatewaymacipAdv%s,currently%s",a
dvertise?"enabled":"disabled",advertise_gw_macip_enabled(NULL)?"enabled":"disabl
ed");if(zvrf->advertise_gw_macip==advertise)return;zvrf->advertise_gw_macip=adve
rtise;if(advertise_gw_macip_enabled(zvni))hash_iterate(zvrf->vni_table,zvni_gw_m
acip_add_for_vni_hash,NULL);elsehash_iterate(zvrf->vni_table,zvni_gw_macip_del_f
or_vni_hash,NULL);}else{structzebra_if*zif=NULL;structzebra_l2info_vxlanzl2_info
;structinterface*vlan_if=NULL;structinterface*vrr_if=NULL;zvni=zvni_lookup(vni);
if(!zvni)return;if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("EVPNgatewaymacipAdv%sonVNI%d
,currently%s",advertise?"enabled":"disabled",vni,advertise_gw_macip_enabled(zvni
)?"enabled":"disabled");if(zvni->advertise_gw_macip==advertise)return;zvni->adve
rtise_gw_macip=advertise;ifp=zvni->vxlan_if;if(!ifp)return;zif=ifp->info;/*Ifdow
nornotmappedtoabridge,we'redone.*/if(!if_is_operative(ifp)||!zif->brslave_info.b
r_if)return;zl2_info=zif->l2info.vxl;vlan_if=zvni_map_to_svi(zl2_info.access_vla
n,zif->brslave_info.br_if);if(!vlan_if)return;if(advertise_gw_macip_enabled(zvni
)){/*AddprimarySVIMAC-IP*/zvni_add_macip_for_intf(vlan_if,zvni);/*AddVRRMAC-IP-i
fany*/vrr_if=zebra_get_vrr_intf_for_svi(vlan_if);if(vrr_if)zvni_add_macip_for_in
tf(vrr_if,zvni);}else{/*DelprimaryMAC-IP*/zvni_del_macip_for_intf(vlan_if,zvni);
/*DelVRRMAC-IP-ifany*/vrr_if=zebra_get_vrr_intf_for_svi(vlan_if);if(vrr_if)zvni_
del_macip_for_intf(vrr_if,zvni);}}stream_failure:return;}/**Handlemessagefromcli
enttolearn(orstoplearning)aboutVNIsandMACs.*Whenenabled,theVNIhashtablewillbebui
ltandMACFDBtableread;*whendisabled,theentriesshouldbedeletedandremoteVTEPsandMAC
s*uninstalledfromthekernel.*/voidzebra_vxlan_advertise_all_vni(ZAPI_HANDLER_ARGS
){structstream*s=NULL;intadvertise=0;structzebra_ns*zns=NULL;if(zvrf_id(zvrf)!=V
RF_DEFAULT){zlog_err("EVPNVNIAdvfornon-defaultVRF%u",zvrf_id(zvrf));return;}s=ms
g;STREAM_GETC(s,advertise);if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("EVPNVNIAdv%s,curr
ently%s",advertise?"enabled":"disabled",is_evpn_enabled()?"enabled":"disabled");
if(zvrf->advertise_all_vni==advertise)return;zvrf->advertise_all_vni=advertise;i
f(is_evpn_enabled()){/*BuildVNIhashtableandinformBGP.*/zvni_build_hash_table();/
*AddallSVI(L3GW)MACstoBGP*/hash_iterate(zvrf->vni_table,zvni_gw_macip_add_for_vn
i_hash,NULL);/*ReadtheMACFDB*/macfdb_read(zvrf->zns);/*Readneighbors*/neigh_read
(zvrf->zns);}else{/*CleanupVTEPsforallVNIs-uninstallfrom*kernelandfreeentries.*/
hash_iterate(zvrf->vni_table,zvni_cleanup_all,zvrf);/*cleanupalll3vnis*/zns=zebr
a_ns_lookup(NS_DEFAULT);if(!zns)return;hash_iterate(zns->l3vni_table,zl3vni_clea
nup_all,NULL);}stream_failure:return;}/**AllocateVNIhashtableforthisVRFanddoothe
rinitialization.*NOTE:CurrentlysupportedonlyfordefaultVRF.*/voidzebra_vxlan_init
_tables(structzebra_vrf*zvrf){if(!zvrf)return;zvrf->vni_table=hash_create(vni_ha
sh_keymake,vni_hash_cmp,"ZebraVRFVNITable");}/*CleanupVNIinfo,butdon'tfreethetab
le.*/voidzebra_vxlan_cleanup_tables(structzebra_vrf*zvrf){if(!zvrf)return;hash_i
terate(zvrf->vni_table,zvni_cleanup_all,zvrf);}/*CloseallVNIhandling*/voidzebra_
vxlan_close_tables(structzebra_vrf*zvrf){if(!zvrf)return;hash_iterate(zvrf->vni_
table,zvni_cleanup_all,zvrf);hash_free(zvrf->vni_table);}/*initthel3vnitable*/vo
idzebra_vxlan_ns_init(structzebra_ns*zns){zns->l3vni_table=hash_create(l3vni_has
h_keymake,l3vni_hash_cmp,"ZebraVRFL3VNItable");}/*freel3vnitable*/voidzebra_vxla
n_ns_disable(structzebra_ns*zns){hash_free(zns->l3vni_table);}/*getthel3vnisviif
index*/ifindex_tget_l3vni_svi_ifindex(vrf_id_tvrf_id){zebra_l3vni_t*zl3vni=NULL;
zl3vni=zl3vni_from_vrf(vrf_id);if(!zl3vni||!is_l3vni_oper_up(zl3vni))return0;ret
urnzl3vni->svi_if->ifindex;}