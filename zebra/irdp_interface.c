/***Copyright(C)2000RobertOlsson.*SwedishUniversityofAgriculturalSciences**Thisf
ileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*
underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation
;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehop
ethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCH
ANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformorede
tails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprog
ram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,
FifthFloor,Boston,MA02110-1301USA*//**Thisworkincludesworkwiththefollowingcopywr
ite:**Copyright(C)1997,2000KunihiroIshiguro**//**ThankstoJensLååsatSwedishUniversityofAgriculturalSciences*forreviewingandtests.*/#include<zebra
.h>#include"if.h"#include"vty.h"#include"sockunion.h"#include"prefix.h"#include"
command.h"#include"memory.h"#include"zebra_memory.h"#include"stream.h"#include"i
octl.h"#include"connected.h"#include"log.h"#include"zclient.h"#include"thread.h"
#include"zebra/interface.h"#include"zebra/rtadv.h"#include"zebra/rib.h"#include"
zebra/zserv.h"#include"zebra/redistribute.h"#include"zebra/irdp.h"#include<netin
et/ip_icmp.h>#include"if.h"#include"sockunion.h"#include"log.h"externintirdp_soc
k;DEFINE_MTYPE_STATIC(ZEBRA,IRDP_IF,"IRDPinterfacedata")#defineIRDP_CONFIGED\do{
\if(!irdp){\vty_out(vty,\"PleaseConfigureIRDPbeforeusingthiscommand\n");\returnC
MD_WARNING_CONFIG_FAILED;\}\}while(0)staticstructirdp_interface*irdp_if_get(stru
ctinterface*ifp){structzebra_if*zi=ifp->info;if(!zi)returnNULL;if(!zi->irdp)zi->
irdp=XCALLOC(MTYPE_IRDP_IF,sizeof(*zi->irdp));if(!zi->irdp->started)returnNULL;r
eturnzi->irdp;}staticintirdp_if_delete(structinterface*ifp){structzebra_if*zi=if
p->info;if(!zi)return0;XFREE(MTYPE_IRDP_IF,zi->irdp);return0;}staticconstchar*in
et_2a(uint32_ta,char*b){sprintf(b,"%u.%u.%u.%u",(a)&0xFF,(a>>8)&0xFF,(a>>16)&0xF
F,(a>>24)&0xFF);returnb;}staticstructprefix*irdp_get_prefix(structinterface*ifp)
{structlistnode*node;structconnected*ifc;if(ifp->connected)for(ALL_LIST_ELEMENTS
_RO(ifp->connected,node,ifc))returnifc->address;returnNULL;}/*Jointotheadd/leave
multicastgroup.*/staticintif_group(structinterface*ifp,intsock,uint32_tgroup,int
add_leave){structip_mreqm;structprefix*p;intret;charb1[INET_ADDRSTRLEN];memset(&
m,0,sizeof(m));m.imr_multiaddr.s_addr=htonl(group);p=irdp_get_prefix(ifp);if(!p)
{zlog_warn("IRDP:can'tgetaddressfor%s",ifp->name);return1;}m.imr_interface=p->u.
prefix4;ret=setsockopt(sock,IPPROTO_IP,add_leave,(char*)&m,sizeof(structip_mreq)
);if(ret<0)zlog_warn("IRDP:%scan'tsetsockopt%s:%s",add_leave==IP_ADD_MEMBERSHIP?
"joingroup":"leavegroup",inet_2a(group,b1),safe_strerror(errno));returnret;}stat
icintif_add_group(structinterface*ifp){structzebra_if*zi=ifp->info;structirdp_in
terface*irdp=zi->irdp;intret;charb1[INET_ADDRSTRLEN];if(!irdp)return-1;ret=if_gr
oup(ifp,irdp_sock,INADDR_ALLRTRS_GROUP,IP_ADD_MEMBERSHIP);if(ret<0){returnret;}i
f(irdp->flags&IF_DEBUG_MISC)zlog_debug("IRDP:Addinggroup%sfor%s",inet_2a(htonl(I
NADDR_ALLRTRS_GROUP),b1),ifp->name);return0;}staticintif_drop_group(structinterf
ace*ifp){structzebra_if*zi=ifp->info;structirdp_interface*irdp=zi->irdp;intret;c
harb1[INET_ADDRSTRLEN];if(!irdp)return-1;ret=if_group(ifp,irdp_sock,INADDR_ALLRT
RS_GROUP,IP_DROP_MEMBERSHIP);if(ret<0)returnret;if(irdp->flags&IF_DEBUG_MISC)zlo
g_debug("IRDP:Leavinggroup%sfor%s",inet_2a(htonl(INADDR_ALLRTRS_GROUP),b1),ifp->
name);return0;}staticvoidif_set_defaults(structirdp_interface*irdp){irdp->MaxAdv
ertInterval=IRDP_MAXADVERTINTERVAL;irdp->MinAdvertInterval=IRDP_MINADVERTINTERVA
L;irdp->Preference=IRDP_PREFERENCE;irdp->Lifetime=IRDP_LIFETIME;}staticstructAdv
*Adv_new(void){returnXCALLOC(MTYPE_TMP,sizeof(structAdv));}staticvoidAdv_free(st
ructAdv*adv){XFREE(MTYPE_TMP,adv);}staticvoidirdp_if_start(structinterface*ifp,i
ntmulticast,intset_defaults){structzebra_if*zi=ifp->info;structirdp_interface*ir
dp=zi->irdp;structlistnode*node;structconnected*ifc;uint32_ttimer,seed;assert(ir
dp);irdp->started=true;if(irdp->flags&IF_ACTIVE){zlog_warn("IRDP:Interfaceisalre
adyactive%s",ifp->name);return;}if((irdp_sock<0)&&((irdp_sock=irdp_sock_init())<
0)){zlog_warn("IRDP:Cannotactivateinterface%s(cannotcreate""IRDPsocket)",ifp->na
me);return;}irdp->flags|=IF_ACTIVE;if(!multicast)irdp->flags|=IF_BROADCAST;if_ad
d_update(ifp);if(!(ifp->flags&IFF_UP)){zlog_warn("IRDP:Interfaceisdown%s",ifp->n
ame);}/*Shallwecancelif_startifif_add_groupfails?*/if(multicast){if_add_group(if
p);if(!(ifp->flags&(IFF_MULTICAST|IFF_ALLMULTI))){zlog_warn("IRDP:Interfacenotmu
lticastenabled%s",ifp->name);}}if(set_defaults)if_set_defaults(irdp);irdp->irdp_
sent=0;/*Thespecsuggeststhisforrandomness*/seed=0;if(ifp->connected)for(ALL_LIST
_ELEMENTS_RO(ifp->connected,node,ifc)){seed=ifc->address->u.prefix4.s_addr;break
;}srandom(seed);timer=(random()%IRDP_DEFAULT_INTERVAL)+1;irdp->AdvPrefList=list_
new();irdp->AdvPrefList->del=(void(*)(void*))Adv_free;/*Destructor*//*Andthisfor
startup.Speedlimitfrom1991:-).Butit'sOK*/if(irdp->irdp_sent<MAX_INITIAL_ADVERTIS
EMENTS&&timer>MAX_INITIAL_ADVERT_INTERVAL)timer=MAX_INITIAL_ADVERT_INTERVAL;if(i
rdp->flags&IF_DEBUG_MISC)zlog_debug("IRDP:Inittimerfor%ssetto%u",ifp->name,timer
);irdp->t_advertise=NULL;thread_add_timer(zebrad.master,irdp_send_thread,ifp,tim
er,&irdp->t_advertise);}staticvoidirdp_if_stop(structinterface*ifp){structzebra_
if*zi=ifp->info;structirdp_interface*irdp=zi->irdp;if(irdp==NULL){zlog_warn("Int
erface%sstructureisNULL",ifp->name);return;}if(!(irdp->flags&IF_ACTIVE)){zlog_wa
rn("Interfaceisnotactive%s",ifp->name);return;}if(!(irdp->flags&IF_BROADCAST))if
_drop_group(ifp);irdp_advert_off(ifp);list_delete_and_null(&irdp->AdvPrefList);i
rdp->flags=0;}staticvoidirdp_if_shutdown(structinterface*ifp){structzebra_if*zi=
ifp->info;structirdp_interface*irdp=zi->irdp;if(!irdp)return;if(irdp->flags&IF_S
HUTDOWN){zlog_warn("IRDP:Interfaceisalreadyshutdown%s",ifp->name);return;}irdp->
flags|=IF_SHUTDOWN;irdp->flags&=~IF_ACTIVE;if(!(irdp->flags&IF_BROADCAST))if_dro
p_group(ifp);/*Tellthehostsweareoutofservice*/irdp_advert_off(ifp);}staticvoidir
dp_if_no_shutdown(structinterface*ifp){structirdp_interface*irdp=irdp_if_get(ifp
);if(!irdp)return;if(!(irdp->flags&IF_SHUTDOWN)){zlog_warn("IRDP:Interfaceisnots
hutdown%s",ifp->name);return;}irdp->flags&=~IF_SHUTDOWN;irdp_if_start(ifp,irdp->
flags&IF_BROADCAST?FALSE:TRUE,FALSE);}/*Writeconfigurationtouser*/intirdp_config
_write(structvty*vty,structinterface*ifp){structzebra_if*zi=ifp->info;structirdp
_interface*irdp=zi->irdp;structAdv*adv;structlistnode*node;charb1[INET_ADDRSTRLE
N];if(!irdp)return0;if(irdp->flags&IF_ACTIVE||irdp->flags&IF_SHUTDOWN){if(irdp->
flags&IF_SHUTDOWN)vty_out(vty,"ipirdpshutdown\n");if(irdp->flags&IF_BROADCAST)vt
y_out(vty,"ipirdpbroadcast\n");elsevty_out(vty,"ipirdpmulticast\n");vty_out(vty,
"ipirdppreference%ld\n",irdp->Preference);for(ALL_LIST_ELEMENTS_RO(irdp->AdvPref
List,node,adv))vty_out(vty,"ipirdpaddress%spreference%d\n",inet_2a(adv->ip.s_add
r,b1),adv->pref);vty_out(vty,"ipirdpholdtime%d\n",irdp->Lifetime);vty_out(vty,"i
pirdpminadvertinterval%ld\n",irdp->MinAdvertInterval);vty_out(vty,"ipirdpmaxadve
rtinterval%ld\n",irdp->MaxAdvertInterval);}return0;}DEFUN(ip_irdp_multicast,ip_i
rdp_multicast_cmd,"ipirdpmulticast",IP_STR"ICMPRouterdiscoveryonthisinterface\n"
"Usemulticastmode\n"){VTY_DECLVAR_CONTEXT(interface,ifp);irdp_if_get(ifp);irdp_i
f_start(ifp,TRUE,TRUE);returnCMD_SUCCESS;}DEFUN(ip_irdp_broadcast,ip_irdp_broadc
ast_cmd,"ipirdpbroadcast",IP_STR"ICMPRouterdiscoveryonthisinterface\n""Usebroadc
astmode\n"){VTY_DECLVAR_CONTEXT(interface,ifp);irdp_if_get(ifp);irdp_if_start(if
p,FALSE,TRUE);returnCMD_SUCCESS;}DEFUN(no_ip_irdp,no_ip_irdp_cmd,"noipirdp",NO_S
TRIP_STR"DisableICMPRouterdiscoveryonthisinterface\n"){VTY_DECLVAR_CONTEXT(inter
face,ifp);irdp_if_stop(ifp);returnCMD_SUCCESS;}DEFUN(ip_irdp_shutdown,ip_irdp_sh
utdown_cmd,"ipirdpshutdown",IP_STR"ICMPRouterdiscoveryonthisinterface\n""ICMPRou
terdiscoveryshutdownonthisinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);irdp_
if_shutdown(ifp);returnCMD_SUCCESS;}DEFUN(no_ip_irdp_shutdown,no_ip_irdp_shutdow
n_cmd,"noipirdpshutdown",NO_STRIP_STR"ICMPRouterdiscoveryonthisinterface\n""ICMP
Routerdiscoverynoshutdownonthisinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);
irdp_if_no_shutdown(ifp);returnCMD_SUCCESS;}DEFUN(ip_irdp_holdtime,ip_irdp_holdt
ime_cmd,"ipirdpholdtime(0-9000)",IP_STR"ICMPRouterdiscoveryonthisinterface\n""Se
tholdtimevalue\n""Holdtimevalueinseconds.Defaultis1800seconds\n"){intidx_number=
3;VTY_DECLVAR_CONTEXT(interface,ifp);structirdp_interface*irdp=irdp_if_get(ifp);
IRDP_CONFIGED;irdp->Lifetime=atoi(argv[idx_number]->arg);returnCMD_SUCCESS;}DEFU
N(ip_irdp_minadvertinterval,ip_irdp_minadvertinterval_cmd,"ipirdpminadvertinterv
al(3-1800)",IP_STR"ICMPRouterdiscoveryonthisinterface\n""Setminimumtimebetweenad
vertisement\n""Minimumadvertisementintervalinseconds\n"){intidx_number=3;VTY_DEC
LVAR_CONTEXT(interface,ifp);structirdp_interface*irdp=irdp_if_get(ifp);IRDP_CONF
IGED;if((unsigned)atoi(argv[idx_number]->arg)<=irdp->MaxAdvertInterval){irdp->Mi
nAdvertInterval=atoi(argv[idx_number]->arg);returnCMD_SUCCESS;}else{vty_out(vty,
"%%MinAdvertIntervalmustbelessthanorequalto""MaxAdvertInterval\n");returnCMD_WAR
NING_CONFIG_FAILED;}}DEFUN(ip_irdp_maxadvertinterval,ip_irdp_maxadvertinterval_c
md,"ipirdpmaxadvertinterval(4-1800)",IP_STR"ICMPRouterdiscoveryonthisinterface\n
""Setmaximumtimebetweenadvertisement\n""Maximumadvertisementintervalinseconds\n"
){intidx_number=3;VTY_DECLVAR_CONTEXT(interface,ifp);structirdp_interface*irdp=i
rdp_if_get(ifp);IRDP_CONFIGED;if(irdp->MinAdvertInterval<=(unsigned)atoi(argv[id
x_number]->arg)){irdp->MaxAdvertInterval=atoi(argv[idx_number]->arg);returnCMD_S
UCCESS;}else{vty_out(vty,"%%MaxAdvertIntervalmustbegreaterthanorequalto""MinAdve
rtInterval\n");returnCMD_WARNING_CONFIG_FAILED;}}/*DEFUNneedstobefixedfornegativ
eranages...*"ipirdppreference<-2147483648-2147483647>",*Bepositivefornow.:-)*/DE
FUN(ip_irdp_preference,ip_irdp_preference_cmd,"ipirdppreference(0-2147483647)",I
P_STR"ICMPRouterdiscoveryonthisinterface\n""Setdefaultpreferencelevelforthisinte
rface\n""Preferencelevel\n"){intidx_number=3;VTY_DECLVAR_CONTEXT(interface,ifp);
structirdp_interface*irdp=irdp_if_get(ifp);IRDP_CONFIGED;irdp->Preference=atoi(a
rgv[idx_number]->arg);returnCMD_SUCCESS;}DEFUN(ip_irdp_address_preference,ip_ird
p_address_preference_cmd,"ipirdpaddressA.B.C.Dpreference(0-2147483647)",IP_STR"A
lterICMPRouterdiscoverypreferenceonthisinterface\n""SetIRDPaddressforadvertise\n
""IPv4address\n""SpecifyIRDPnon-defaultpreferencetoadvertise\n""Preferencelevel\
n"){intidx_ipv4=3;intidx_number=5;VTY_DECLVAR_CONTEXT(interface,ifp);structirdp_
interface*irdp=irdp_if_get(ifp);structlistnode*node;structin_addrip;intpref;intr
et;structAdv*adv;IRDP_CONFIGED;ret=inet_aton(argv[idx_ipv4]->arg,&ip);if(!ret)re
turnCMD_WARNING_CONFIG_FAILED;pref=atoi(argv[idx_number]->arg);for(ALL_LIST_ELEM
ENTS_RO(irdp->AdvPrefList,node,adv))if(adv->ip.s_addr==ip.s_addr)returnCMD_SUCCE
SS;adv=Adv_new();adv->ip=ip;adv->pref=pref;listnode_add(irdp->AdvPrefList,adv);r
eturnCMD_SUCCESS;}DEFUN(no_ip_irdp_address_preference,no_ip_irdp_address_prefere
nce_cmd,"noipirdpaddressA.B.C.Dpreference(0-2147483647)",NO_STRIP_STR"AlterICMPR
outerdiscoverypreferenceonthisinterface\n""SelectIRDPaddress\n""IPv4address\n""R
esetICMPRouterdiscoverypreferenceonthisinterface\n""Oldpreferencelevel\n"){intid
x_ipv4=4;VTY_DECLVAR_CONTEXT(interface,ifp);structirdp_interface*irdp=irdp_if_ge
t(ifp);structlistnode*node,*nnode;structin_addrip;intret;structAdv*adv;IRDP_CONF
IGED;ret=inet_aton(argv[idx_ipv4]->arg,&ip);if(!ret)returnCMD_WARNING_CONFIG_FAI
LED;for(ALL_LIST_ELEMENTS(irdp->AdvPrefList,node,nnode,adv)){if(adv->ip.s_addr==
ip.s_addr){listnode_delete(irdp->AdvPrefList,adv);break;}}returnCMD_SUCCESS;}DEF
UN(ip_irdp_debug_messages,ip_irdp_debug_messages_cmd,"ipirdpdebugmessages",IP_ST
R"ICMPRouterdiscoverydebugAverts.andSolicits(short)\n""IRDPdebuggingoptions\n""E
nabledebuggingforIRDPmessages\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structirdp_
interface*irdp=irdp_if_get(ifp);IRDP_CONFIGED;irdp->flags|=IF_DEBUG_MESSAGES;ret
urnCMD_SUCCESS;}DEFUN(ip_irdp_debug_misc,ip_irdp_debug_misc_cmd,"ipirdpdebugmisc
",IP_STR"ICMPRouterdiscoverydebugAverts.andSolicits(short)\n""IRDPdebuggingoptio
ns\n""EnabledebuggingformiscellaneousIRDPevents\n"){VTY_DECLVAR_CONTEXT(interfac
e,ifp);structirdp_interface*irdp=irdp_if_get(ifp);IRDP_CONFIGED;irdp->flags|=IF_
DEBUG_MISC;returnCMD_SUCCESS;}DEFUN(ip_irdp_debug_packet,ip_irdp_debug_packet_cm
d,"ipirdpdebugpacket",IP_STR"ICMPRouterdiscoverydebugAverts.andSolicits(short)\n
""IRDPdebuggingoptions\n""EnabledebuggingforIRDPpackets\n"){VTY_DECLVAR_CONTEXT(
interface,ifp);structirdp_interface*irdp=irdp_if_get(ifp);IRDP_CONFIGED;irdp->fl
ags|=IF_DEBUG_PACKET;returnCMD_SUCCESS;}DEFUN(ip_irdp_debug_disable,ip_irdp_debu
g_disable_cmd,"ipirdpdebugdisable",IP_STR"ICMPRouterdiscoverydebugAverts.andSoli
cits(short)\n""IRDPdebuggingoptions\n""DisabledebuggingforallIRDPevents\n"){VTY_
DECLVAR_CONTEXT(interface,ifp);structirdp_interface*irdp=irdp_if_get(ifp);IRDP_C
ONFIGED;irdp->flags&=~IF_DEBUG_PACKET;irdp->flags&=~IF_DEBUG_MESSAGES;irdp->flag
s&=~IF_DEBUG_MISC;returnCMD_SUCCESS;}voidirdp_if_init(){hook_register(zebra_if_c
onfig_wr,irdp_config_write);hook_register(if_del,irdp_if_delete);install_element
(INTERFACE_NODE,&ip_irdp_broadcast_cmd);install_element(INTERFACE_NODE,&ip_irdp_
multicast_cmd);install_element(INTERFACE_NODE,&no_ip_irdp_cmd);install_element(I
NTERFACE_NODE,&ip_irdp_shutdown_cmd);install_element(INTERFACE_NODE,&no_ip_irdp_
shutdown_cmd);install_element(INTERFACE_NODE,&ip_irdp_holdtime_cmd);install_elem
ent(INTERFACE_NODE,&ip_irdp_maxadvertinterval_cmd);install_element(INTERFACE_NOD
E,&ip_irdp_minadvertinterval_cmd);install_element(INTERFACE_NODE,&ip_irdp_prefer
ence_cmd);install_element(INTERFACE_NODE,&ip_irdp_address_preference_cmd);instal
l_element(INTERFACE_NODE,&no_ip_irdp_address_preference_cmd);install_element(INT
ERFACE_NODE,&ip_irdp_debug_messages_cmd);install_element(INTERFACE_NODE,&ip_irdp
_debug_misc_cmd);install_element(INTERFACE_NODE,&ip_irdp_debug_packet_cmd);insta
ll_element(INTERFACE_NODE,&ip_irdp_debug_disable_cmd);}