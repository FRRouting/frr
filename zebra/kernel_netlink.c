/*Kernelcommunicationusingnetlinkinterface.*Copyright(C)1999KunihiroIshiguro**Th
isfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify
it*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundat
ion;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthe
hopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*ME
RCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformor
edetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisp
rogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Franklin
St,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefHAVE_NETLINK#includ
e"linklist.h"#include"if.h"#include"log.h"#include"prefix.h"#include"connected.h
"#include"table.h"#include"memory.h"#include"zebra_memory.h"#include"rib.h"#incl
ude"thread.h"#include"privs.h"#include"nexthop.h"#include"vrf.h"#include"mpls.h"
#include"zebra/zserv.h"#include"zebra/zebra_ns.h"#include"zebra/zebra_vrf.h"#inc
lude"zebra/rt.h"#include"zebra/debug.h"#include"zebra/kernel_netlink.h"#include"
zebra/rt_netlink.h"#include"zebra/if_netlink.h"#include"zebra/rule_netlink.h"#if
ndefSO_RCVBUFFORCE#defineSO_RCVBUFFORCE(33)#endif/*HackforGNUlibcversion2.*/#ifn
defMSG_TRUNC#defineMSG_TRUNC0x20#endif/*MSG_TRUNC*/#ifndefNLMSG_TAIL#defineNLMSG
_TAIL(nmsg)\((structrtattr*)(((uint8_t*)(nmsg))\+NLMSG_ALIGN((nmsg)->nlmsg_len))
)#endif#ifndefRTA_TAIL#defineRTA_TAIL(rta)\((structrtattr*)(((uint8_t*)(rta))+RT
A_ALIGN((rta)->rta_len)))#endif#ifndefRTNL_FAMILY_IP6MR#defineRTNL_FAMILY_IP6MR1
29#endif#ifndefRTPROT_MROUTED#defineRTPROT_MROUTED17#endifstaticconststructmessa
genlmsg_str[]={{RTM_NEWROUTE,"RTM_NEWROUTE"},{RTM_DELROUTE,"RTM_DELROUTE"},{RTM_
GETROUTE,"RTM_GETROUTE"},{RTM_NEWLINK,"RTM_NEWLINK"},{RTM_DELLINK,"RTM_DELLINK"}
,{RTM_GETLINK,"RTM_GETLINK"},{RTM_NEWADDR,"RTM_NEWADDR"},{RTM_DELADDR,"RTM_DELAD
DR"},{RTM_GETADDR,"RTM_GETADDR"},{RTM_NEWNEIGH,"RTM_NEWNEIGH"},{RTM_DELNEIGH,"RT
M_DELNEIGH"},{RTM_GETNEIGH,"RTM_GETNEIGH"},{RTM_NEWRULE,"RTM_NEWRULE"},{RTM_DELR
ULE,"RTM_DELRULE"},{RTM_GETRULE,"RTM_GETRULE"},{0}};staticconststructmessagertpr
oto_str[]={{RTPROT_REDIRECT,"redirect"},{RTPROT_KERNEL,"kernel"},{RTPROT_BOOT,"b
oot"},{RTPROT_STATIC,"static"},{RTPROT_GATED,"GateD"},{RTPROT_RA,"routeradvertis
ement"},{RTPROT_MRT,"MRT"},{RTPROT_ZEBRA,"Zebra"},#ifdefRTPROT_BIRD{RTPROT_BIRD,
"BIRD"},#endif/*RTPROT_BIRD*/{RTPROT_MROUTED,"mroute"},{RTPROT_BGP,"BGP"},{RTPRO
T_OSPF,"OSPF"},{RTPROT_ISIS,"IS-IS"},{RTPROT_RIP,"RIP"},{RTPROT_RIPNG,"RIPNG"},{
0}};staticconststructmessagefamily_str[]={{AF_INET,"ipv4"},{AF_INET6,"ipv6"},{AF
_BRIDGE,"bridge"},{RTNL_FAMILY_IPMR,"ipv4MR"},{RTNL_FAMILY_IP6MR,"ipv6MR"},{0}};
staticconststructmessagerttype_str[]={{RTN_UNICAST,"unicast"},{RTN_MULTICAST,"mu
lticast"},{0}};externstructthread_master*master;externuint32_tnl_rcvbufsize;exte
rnstructzebra_privs_tzserv_privs;intnetlink_talk_filter(structsockaddr_nl*snl,st
ructnlmsghdr*h,ns_id_tns_id,intstartup){zlog_warn("netlink_talk:ignoringmessaget
ype0x%04xNS%u",h->nlmsg_type,ns_id);return0;}staticintnetlink_recvbuf(structnlso
ck*nl,uint32_tnewsize){uint32_toldsize;socklen_tnewlen=sizeof(newsize);socklen_t
oldlen=sizeof(oldsize);intret;ret=getsockopt(nl->sock,SOL_SOCKET,SO_RCVBUF,&olds
ize,&oldlen);if(ret<0){zlog_err("Can'tget%sreceivebuffersize:%s",nl->name,safe_s
trerror(errno));return-1;}/*Tryforceoption(linux>=2.6.14)andfallbacktonormalset*
/if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("routing_socket:Can'traiseprivileg
es");ret=setsockopt(nl->sock,SOL_SOCKET,SO_RCVBUFFORCE,&nl_rcvbufsize,sizeof(nl_
rcvbufsize));if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("routing_socket:Can'tl
owerprivileges");if(ret<0)ret=setsockopt(nl->sock,SOL_SOCKET,SO_RCVBUF,&nl_rcvbu
fsize,sizeof(nl_rcvbufsize));if(ret<0){zlog_err("Can'tset%sreceivebuffersize:%s"
,nl->name,safe_strerror(errno));return-1;}ret=getsockopt(nl->sock,SOL_SOCKET,SO_
RCVBUF,&newsize,&newlen);if(ret<0){zlog_err("Can'tget%sreceivebuffersize:%s",nl-
>name,safe_strerror(errno));return-1;}zlog_info("Settingnetlinksocketreceivebuff
ersize:%u->%u",oldsize,newsize);return0;}/*MakesocketforLinuxnetlinkinterface.*/
staticintnetlink_socket(structnlsock*nl,unsignedlonggroups,ns_id_tns_id){intret;
structsockaddr_nlsnl;intsock;intnamelen;intsave_errno;if(zserv_privs.change(ZPRI
VS_RAISE)){zlog_err("Can'traiseprivileges");return-1;}sock=ns_socket(AF_NETLINK,
SOCK_RAW,NETLINK_ROUTE,ns_id);if(sock<0){zlog_err("Can'topen%ssocket:%s",nl->nam
e,safe_strerror(errno));return-1;}memset(&snl,0,sizeofsnl);snl.nl_family=AF_NETL
INK;snl.nl_groups=groups;/*Bindthesockettothenetlinkstructureforanything.*/ret=b
ind(sock,(structsockaddr*)&snl,sizeofsnl);save_errno=errno;if(zserv_privs.change
(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");if(ret<0){zlog_err("Can'tbind%ss
ockettogroup0x%x:%s",nl->name,snl.nl_groups,safe_strerror(save_errno));close(soc
k);return-1;}/*multiplenetlinksocketswillhavedifferentnl_pid*/namelen=sizeofsnl;
ret=getsockname(sock,(structsockaddr*)&snl,(socklen_t*)&namelen);if(ret<0||namel
en!=sizeofsnl){zlog_err("Can'tget%ssocketname:%s",nl->name,safe_strerror(errno))
;close(sock);return-1;}nl->snl=snl;nl->sock=sock;returnret;}staticintnetlink_inf
ormation_fetch(structsockaddr_nl*snl,structnlmsghdr*h,ns_id_tns_id,intstartup){/
*JF:Ignoremessagesthataren'tfromthekernel*/if(snl->nl_pid!=0){zlog_err("Ignoring
messagefrompid%u",snl->nl_pid);return0;}switch(h->nlmsg_type){caseRTM_NEWROUTE:r
eturnnetlink_route_change(snl,h,ns_id,startup);caseRTM_DELROUTE:returnnetlink_ro
ute_change(snl,h,ns_id,startup);caseRTM_NEWLINK:returnnetlink_link_change(snl,h,
ns_id,startup);caseRTM_DELLINK:returnnetlink_link_change(snl,h,ns_id,startup);ca
seRTM_NEWADDR:returnnetlink_interface_addr(snl,h,ns_id,startup);caseRTM_DELADDR:
returnnetlink_interface_addr(snl,h,ns_id,startup);caseRTM_NEWNEIGH:returnnetlink
_neigh_change(snl,h,ns_id);caseRTM_DELNEIGH:returnnetlink_neigh_change(snl,h,ns_
id);caseRTM_NEWRULE:returnnetlink_rule_change(snl,h,ns_id,startup);caseRTM_DELRU
LE:returnnetlink_rule_change(snl,h,ns_id,startup);default:if(IS_ZEBRA_DEBUG_KERN
EL)zlog_debug("Unknownnetlinknlmsg_type%dvrf%u\n",h->nlmsg_type,ns_id);break;}re
turn0;}staticintkernel_read(structthread*thread){structzebra_ns*zns=(structzebra
_ns*)THREAD_ARG(thread);netlink_parse_info(netlink_information_fetch,&zns->netli
nk,zns,5,0);zns->t_netlink=NULL;thread_add_read(zebrad.master,kernel_read,zns,zn
s->netlink.sock,&zns->t_netlink);return0;}/*Filteroutmessagesfromselfthatoccuron
listenersocket,*causedbyouractionsonthecommandsocket*/staticvoidnetlink_install_
filter(intsock,__u32pid){structsock_filterfilter[]={/*0:ldh[4]*/BPF_STMT(BPF_LD|
BPF_ABS|BPF_H,offsetof(structnlmsghdr,nlmsg_type)),/*1:jeq0x18jt5jfnext*/BPF_JUM
P(BPF_JMP|BPF_JEQ|BPF_K,htons(RTM_NEWROUTE),3,0),/*2:jeq0x19jt5jfnext*/BPF_JUMP(
BPF_JMP|BPF_JEQ|BPF_K,htons(RTM_DELROUTE),2,0),/*3:jeq0x19jt5jfnext*/BPF_JUMP(BP
F_JMP|BPF_JEQ|BPF_K,htons(RTM_NEWNEIGH),1,0),/*4:jeq0x19jt5jf8*/BPF_JUMP(BPF_JMP
|BPF_JEQ|BPF_K,htons(RTM_DELNEIGH),0,3),/*5:ldw[12]*/BPF_STMT(BPF_LD|BPF_ABS|BPF
_W,offsetof(structnlmsghdr,nlmsg_pid)),/*6:jeqXXjt7jf8*/BPF_JUMP(BPF_JMP|BPF_JEQ
|BPF_K,htonl(pid),0,1),/*7:ret0(skip)*/BPF_STMT(BPF_RET|BPF_K,0),/*8:ret0xffff(k
eep)*/BPF_STMT(BPF_RET|BPF_K,0xffff),};structsock_fprogprog={.len=array_size(fil
ter),.filter=filter,};if(setsockopt(sock,SOL_SOCKET,SO_ATTACH_FILTER,&prog,sizeo
f(prog))<0)zlog_warn("Can'tinstallsocketfilter:%s\n",safe_strerror(errno));}void
netlink_parse_rtattr(structrtattr**tb,intmax,structrtattr*rta,intlen){while(RTA_
OK(rta,len)){if(rta->rta_type<=max)tb[rta->rta_type]=rta;rta=RTA_NEXT(rta,len);}
}intaddattr_l(structnlmsghdr*n,unsignedintmaxlen,inttype,void*data,unsignedintal
en){intlen;structrtattr*rta;len=RTA_LENGTH(alen);if(NLMSG_ALIGN(n->nlmsg_len)+RT
A_ALIGN(len)>maxlen)return-1;rta=(structrtattr*)(((char*)n)+NLMSG_ALIGN(n->nlmsg
_len));rta->rta_type=type;rta->rta_len=len;if(data)memcpy(RTA_DATA(rta),data,ale
n);elseassert(alen==0);n->nlmsg_len=NLMSG_ALIGN(n->nlmsg_len)+RTA_ALIGN(len);ret
urn0;}intrta_addattr_l(structrtattr*rta,unsignedintmaxlen,inttype,void*data,unsi
gnedintalen){unsignedintlen;structrtattr*subrta;len=RTA_LENGTH(alen);if(RTA_ALIG
N(rta->rta_len)+RTA_ALIGN(len)>maxlen)return-1;subrta=(structrtattr*)(((char*)rt
a)+RTA_ALIGN(rta->rta_len));subrta->rta_type=type;subrta->rta_len=len;if(data)me
mcpy(RTA_DATA(subrta),data,alen);elseassert(alen==0);rta->rta_len=NLMSG_ALIGN(rt
a->rta_len)+RTA_ALIGN(len);return0;}intaddattr16(structnlmsghdr*n,unsignedintmax
len,inttype,uint16_tdata){returnaddattr_l(n,maxlen,type,&data,sizeof(uint16_t));
}intaddattr32(structnlmsghdr*n,unsignedintmaxlen,inttype,intdata){returnaddattr_
l(n,maxlen,type,&data,sizeof(uint32_t));}structrtattr*addattr_nest(structnlmsghd
r*n,intmaxlen,inttype){structrtattr*nest=NLMSG_TAIL(n);addattr_l(n,maxlen,type,N
ULL,0);returnnest;}intaddattr_nest_end(structnlmsghdr*n,structrtattr*nest){nest-
>rta_len=(uint8_t*)NLMSG_TAIL(n)-(uint8_t*)nest;returnn->nlmsg_len;}structrtattr
*rta_nest(structrtattr*rta,intmaxlen,inttype){structrtattr*nest=RTA_TAIL(rta);rt
a_addattr_l(rta,maxlen,type,NULL,0);returnnest;}intrta_nest_end(structrtattr*rta
,structrtattr*nest){nest->rta_len=(uint8_t*)RTA_TAIL(rta)-(uint8_t*)nest;returnr
ta->rta_len;}constchar*nl_msg_type_to_str(uint16_tmsg_type){returnlookup_msg(nlm
sg_str,msg_type,"");}constchar*nl_rtproto_to_str(uint8_trtproto){returnlookup_ms
g(rtproto_str,rtproto,"");}constchar*nl_family_to_str(uint8_tfamily){returnlooku
p_msg(family_str,family,"");}constchar*nl_rttype_to_str(uint8_trttype){returnloo
kup_msg(rttype_str,rttype,"");}/**netlink_parse_info**Receivemessagefromnetlinki
nterfaceandpassthoseinformation*tothegivenfunction.**filter->Functiontocalltorea
dtheresults*nl->netlinksocketinformation*zns->Thezebranamespacedata*count->Howma
nyweshouldreadin,0meansasmuchaspossible*startup->Arewereadinginunderstartupcondi
tions?passedto*thefilter.*/intnetlink_parse_info(int(*filter)(structsockaddr_nl*
,structnlmsghdr*,ns_id_t,int),structnlsock*nl,structzebra_ns*zns,intcount,intsta
rtup){intstatus;intret=0;interror;intread_in=0;while(1){charbuf[NL_PKT_BUF_SIZE]
;structioveciov={.iov_base=buf,.iov_len=sizeofbuf};structsockaddr_nlsnl;structms
ghdrmsg={.msg_name=(void*)&snl,.msg_namelen=sizeofsnl,.msg_iov=&iov,.msg_iovlen=
1};structnlmsghdr*h;if(count&&read_in>=count)return0;status=recvmsg(nl->sock,&ms
g,0);if(status<0){if(errno==EINTR)continue;if(errno==EWOULDBLOCK||errno==EAGAIN)
break;zlog_err("%srecvmsgoverrun:%s",nl->name,safe_strerror(errno));/**Inthiscas
ewearescrewed.*Thereisnogoodwayto*recoverzebraatthispoint.*/exit(-1);continue;}i
f(status==0){zlog_err("%sEOF",nl->name);return-1;}if(msg.msg_namelen!=sizeofsnl)
{zlog_err("%ssenderaddresslengtherror:length%d",nl->name,msg.msg_namelen);return
-1;}if(IS_ZEBRA_DEBUG_KERNEL_MSGDUMP_RECV){zlog_debug("%s:<<netlinkmessagedump[r
ecv]",__func__);zlog_hexdump(buf,status);}read_in++;for(h=(structnlmsghdr*)buf;N
LMSG_OK(h,(unsignedint)status);h=NLMSG_NEXT(h,status)){/*Finishofreading.*/if(h-
>nlmsg_type==NLMSG_DONE)returnret;/*Errorhandling.*/if(h->nlmsg_type==NLMSG_ERRO
R){structnlmsgerr*err=(structnlmsgerr*)NLMSG_DATA(h);interrnum=err->error;intmsg
_type=err->msg.nlmsg_type;/*Iftheerrorfieldiszero,thenthisisan*ACK*/if(err->erro
r==0){if(IS_ZEBRA_DEBUG_KERNEL){zlog_debug("%s:%sACK:type=%s(%u),seq=%u,pid=%u",
__FUNCTION__,nl->name,nl_msg_type_to_str(err->msg.nlmsg_type),err->msg.nlmsg_typ
e,err->msg.nlmsg_seq,err->msg.nlmsg_pid);}/*returnifnotamultipartmessage,*otherw
isecontinue*/if(!(h->nlmsg_flags&NLM_F_MULTI))return0;continue;}if(h->nlmsg_len<
NLMSG_LENGTH(sizeof(structnlmsgerr))){zlog_err("%serror:messagetruncated",nl->na
me);return-1;}/*Dealwitherrorsthatoccurbecauseofraces*inlinkhandling*/if(nl==&zn
s->netlink_cmd&&((msg_type==RTM_DELROUTE&&(-errnum==ENODEV||-errnum==ESRCH))||(m
sg_type==RTM_NEWROUTE&&(-errnum==ENETDOWN||-errnum==EEXIST)))){if(IS_ZEBRA_DEBUG
_KERNEL)zlog_debug("%s:error:%stype=%s(%u),seq=%u,pid=%u",nl->name,safe_strerror
(-errnum),nl_msg_type_to_str(msg_type),msg_type,err->msg.nlmsg_seq,err->msg.nlms
g_pid);return0;}/*WeseeRTM_DELNEIGHwhenshuttingdownan*interfacewithanIPv4*link-l
ocal.Thekernelshouldhavealready*deletedtheneighbor*sodonotlogtheseasanerror.*/if
(msg_type==RTM_DELNEIGH||(nl==&zns->netlink_cmd&&msg_type==RTM_NEWROUTE&&(-errnu
m==ESRCH||-errnum==ENETUNREACH))){/*Thisisknowntohappeninsome*situations,don'tlo
g*aserror.*/if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("%serror:%s,type=%s(%u),seq=%u,p
id=%u",nl->name,safe_strerror(-errnum),nl_msg_type_to_str(msg_type),msg_type,err
->msg.nlmsg_seq,err->msg.nlmsg_pid);}elsezlog_err("%serror:%s,type=%s(%u),seq=%u
,pid=%u",nl->name,safe_strerror(-errnum),nl_msg_type_to_str(msg_type),msg_type,e
rr->msg.nlmsg_seq,err->msg.nlmsg_pid);return-1;}/*OKwegotnetlinkmessage.*/if(IS_
ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_parse_info:%stype%s(%u),len=%d,seq=%u,pid
=%u",nl->name,nl_msg_type_to_str(h->nlmsg_type),h->nlmsg_type,h->nlmsg_len,h->nl
msg_seq,h->nlmsg_pid);/*skipunsolicitedmessagesoriginatingfromcommand*socket*lin
uxsetstheoriginatorsport-idfor{NEW|DEL}ADDR*messages,*sothishastobecheckedhere.*
/if(nl!=&zns->netlink_cmd&&h->nlmsg_pid==zns->netlink_cmd.snl.nl_pid&&(h->nlmsg_
type!=RTM_NEWADDR&&h->nlmsg_type!=RTM_DELADDR)){if(IS_ZEBRA_DEBUG_KERNEL)zlog_de
bug("netlink_parse_info:%spacketcomesfrom%s",zns->netlink_cmd.name,nl->name);con
tinue;}error=(*filter)(&snl,h,zns->ns_id,startup);if(error<0){zlog_err("%sfilter
functionerror",nl->name);ret=error;}}/*Aftererrorcare.*/if(msg.msg_flags&MSG_TRU
NC){zlog_err("%serror:messagetruncated",nl->name);continue;}if(status){zlog_err(
"%serror:dataremnantsize%d",nl->name,status);return-1;}}returnret;}/**netlink_ta
lk**sendmsg()tonetlinksocketthenrecvmsg().*Callsnetlink_parse_infotoparsereturne
ddata**filter->Thefiltertoreadfinalresultsfromkernel*nlmsghdr->Thedatatosendtoth
ekernel*nl->Thenetlinksocketinformation*zns->Thezebranamespaceinformation*startu
p->Arewereadinginunderstartupconditions*Thisispassedthrougheventuallytofilter.*/
intnetlink_talk(int(*filter)(structsockaddr_nl*,structnlmsghdr*,ns_id_t,intstart
up),structnlmsghdr*n,structnlsock*nl,structzebra_ns*zns,intstartup){intstatus;st
ructsockaddr_nlsnl;structioveciov;structmsghdrmsg;intsave_errno;memset(&snl,0,si
zeofsnl);memset(&iov,0,sizeofiov);memset(&msg,0,sizeofmsg);iov.iov_base=n;iov.io
v_len=n->nlmsg_len;msg.msg_name=(void*)&snl;msg.msg_namelen=sizeofsnl;msg.msg_io
v=&iov;msg.msg_iovlen=1;snl.nl_family=AF_NETLINK;n->nlmsg_seq=++nl->seq;n->nlmsg
_pid=nl->snl.nl_pid;/*RequestanacknowledgementbysettingNLM_F_ACK*/n->nlmsg_flags
|=NLM_F_ACK;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_talk:%stype%s(%u),len=%
dseq=%uflags0x%x",nl->name,nl_msg_type_to_str(n->nlmsg_type),n->nlmsg_type,n->nl
msg_len,n->nlmsg_seq,n->nlmsg_flags);/*Sendmessagetonetlinkinterface.*/if(zserv_
privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");status=sendmsg(nl->s
ock,&msg,0);save_errno=errno;if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can't
lowerprivileges");if(IS_ZEBRA_DEBUG_KERNEL_MSGDUMP_SEND){zlog_debug("%s:>>netlin
kmessagedump[sent]",__func__);zlog_hexdump(n,n->nlmsg_len);}if(status<0){zlog_er
r("netlink_talksendmsg()error:%s",safe_strerror(save_errno));return-1;}/**Getrep
lyfromnetlinksocket.*Thereplyshouldeitherbeanacknowlegementoranerror.*/returnnet
link_parse_info(filter,nl,zns,0,startup);}/*Issuerequestmessagetokernelvianetlin
ksocket.GETmessages*areissuedthroughthisinterface.*/intnetlink_request(structnls
ock*nl,structnlmsghdr*n){intret;structsockaddr_nlsnl;intsave_errno;/*Checknetlin
ksocket.*/if(nl->sock<0){zlog_err("%ssocketisn'tactive.",nl->name);return-1;}/*F
illcommonfieldsforallrequests.*/n->nlmsg_flags=NLM_F_ROOT|NLM_F_MATCH|NLM_F_REQU
EST;n->nlmsg_pid=nl->snl.nl_pid;n->nlmsg_seq=++nl->seq;memset(&snl,0,sizeofsnl);
snl.nl_family=AF_NETLINK;/*Raisecapabilitiesandsendmessage,thenlowercapabilities
.*/if(zserv_privs.change(ZPRIVS_RAISE)){zlog_err("Can'traiseprivileges");return-
1;}ret=sendto(nl->sock,(void*)n,n->nlmsg_len,0,(structsockaddr*)&snl,sizeofsnl);
save_errno=errno;if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivile
ges");if(ret<0){zlog_err("%ssendtofailed:%s",nl->name,safe_strerror(save_errno))
;return-1;}return0;}/*Exportedinterfacefunction.Thisfunctionsimplycallsnetlink_s
ocket().*/voidkernel_init(structzebra_ns*zns){unsignedlonggroups;/*Initializenet
linksockets*/groups=RTMGRP_LINK|RTMGRP_IPV4_ROUTE|RTMGRP_IPV4_IFADDR|RTMGRP_IPV6
_ROUTE|RTMGRP_IPV6_IFADDR|RTMGRP_IPV4_MROUTE|RTMGRP_NEIGH|RTNLGRP_IPV4_RULE|RTNL
GRP_IPV6_RULE;snprintf(zns->netlink.name,sizeof(zns->netlink.name),"netlink-list
en(NS%u)",zns->ns_id);zns->netlink.sock=-1;netlink_socket(&zns->netlink,groups,z
ns->ns_id);snprintf(zns->netlink_cmd.name,sizeof(zns->netlink_cmd.name),"netlink
-cmd(NS%u)",zns->ns_id);zns->netlink_cmd.sock=-1;netlink_socket(&zns->netlink_cm
d,0,zns->ns_id);/*Registerkernelsocket.*/if(zns->netlink.sock>0){/*Onlywantnon-b
lockingonthenetlinkeventsocket*/if(fcntl(zns->netlink.sock,F_SETFL,O_NONBLOCK)<0
)zlog_err("Can'tset%ssocketflags:%s",zns->netlink.name,safe_strerror(errno));/*S
etreceivebuffersizeifit'ssetfromcommandline*/if(nl_rcvbufsize)netlink_recvbuf(&z
ns->netlink,nl_rcvbufsize);netlink_install_filter(zns->netlink.sock,zns->netlink
_cmd.snl.nl_pid);zns->t_netlink=NULL;thread_add_read(zebrad.master,kernel_read,z
ns,zns->netlink.sock,&zns->t_netlink);}rt_netlink_init();}voidkernel_terminate(s
tructzebra_ns*zns){THREAD_READ_OFF(zns->t_netlink);if(zns->netlink.sock>=0){clos
e(zns->netlink.sock);zns->netlink.sock=-1;}if(zns->netlink_cmd.sock>=0){close(zn
s->netlink_cmd.sock);zns->netlink_cmd.sock=-1;}}#endif/*HAVE_NETLINK*/