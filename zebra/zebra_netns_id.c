/*zebraNETNSIDhandlingroutines*thoseroutinesareimplementedlocallytoavoidhavingex
ternaldependencies.*Copyright(C)20186WIND**Thisprogramisfreesoftware;youcanredis
tributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbyth
eFree*SoftwareFoundation;eitherversion2oftheLicense,or(atyouroption)*anylaterver
sion.**Thisprogramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANT
Y;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.
SeetheGNUGeneralPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"ns.h"#include"vrf.h"#include"log.h"#ifdefined(HAVE_NETLINK)#
include<linux/net_namespace.h>#include<linux/netlink.h>#include<linux/rtnetlink.
h>#include"rib.h"#include"zebra_ns.h"#include"kernel_netlink.h"#endif/*defined(H
AVE_NETLINK)*/#include"zebra_netns_id.h"/*defaultNSIDvalueusedwhenVRFbackendisno
tNETNS*/#defineNS_DEFAULT_INTERNAL0/*incaseNEWNSIDnotavailable,theNSIDwillbeloca
llyobtained*/#defineNS_BASE_NSID0#ifdefined(HAVE_NETLINK)#defineNETLINK_SOCKET_B
UFFER_SIZE512#defineNETLINK_ALIGNTO4#defineNETLINK_ALIGN(len)\(((len)+NETLINK_AL
IGNTO-1)&~(NETLINK_ALIGNTO-1))#defineNETLINK_NLATTR_LEN(_a,_b)(unsignedint)((cha
r*)_a-(char*)_b)#endif/*defined(HAVE_NETLINK)*/staticns_id_tzebra_ns_id_get_fall
back(constchar*netnspath){staticintzebra_ns_id_local;returnzebra_ns_id_local++;}
#ifdefined(HAVE_NETLINK)staticstructnlmsghdr*initiate_nlh(char*buf,unsignedint*s
eq,inttype){structnlmsghdr*nlh;nlh=(structnlmsghdr*)buf;nlh->nlmsg_len=NETLINK_A
LIGN(sizeof(structnlmsghdr));nlh->nlmsg_type=type;nlh->nlmsg_flags=NLM_F_REQUEST
;if(type==RTM_NEWNSID)nlh->nlmsg_flags|=NLM_F_ACK;nlh->nlmsg_seq=*seq=time(NULL)
;returnnlh;}staticintsend_receive(intsock,structnlmsghdr*nlh,unsignedintseq,char
*buf){intret;staticconststructsockaddr_nlsnl={.nl_family=AF_NETLINK};ret=sendto(
sock,(constvoid*)nlh,(size_t)nlh->nlmsg_len,0,(structsockaddr*)&snl,(socklen_t)s
izeof(snl));if(ret<0){zlog_err("netlink(%u)sendmsg()error:%s",sock,safe_strerror
(errno));return-1;}/*reception*/structsockaddr_nladdr;structioveciov={.iov_base=
buf,.iov_len=NETLINK_SOCKET_BUFFER_SIZE,};structmsghdrmsg={.msg_name=&addr,.msg_
namelen=sizeof(structsockaddr_nl),.msg_iov=&iov,.msg_iovlen=1,.msg_control=NULL,
.msg_controllen=0,.msg_flags=0,};ret=recvmsg(sock,&msg,0);if(ret<0){zlog_err("ne
tlinkrecvmsg:error%d(errno%u)",ret,errno);return-1;}if(msg.msg_flags&MSG_TRUNC){
zlog_err("netlinkrecvmsg:errormessagetruncated");return-1;}/*nlhalreadypointstob
uf*/if(nlh->nlmsg_seq!=seq){zlog_err("netlinkrecvmsg:badsequencenumber%x(expecte
d%x)",seq,nlh->nlmsg_seq);return-1;}returnret;}/*extractonavalidnlmsgthensid*val
idnlmsghdr-notanlmsgerr*/staticns_id_textract_nsid(structnlmsghdr*nlh,char*buf){
ns_id_tns_id=NS_UNKNOWN;intoffset=NETLINK_ALIGN(sizeof(structnlmsghdr))+NETLINK_
ALIGN(sizeof(structrtgenmsg));intcurr_length=offset;void*tail=(void*)((char*)nlh
+NETLINK_ALIGN(nlh->nlmsg_len));structnlattr*attr;for(attr=(structnlattr*)((char
*)buf+offset);NETLINK_NLATTR_LEN(tail,attr)>=sizeof(structnlattr)&&attr->nla_len
>=sizeof(structnlattr)&&attr->nla_len<=NETLINK_NLATTR_LEN(tail,attr);attr+=NETLI
NK_ALIGN(attr->nla_len)){curr_length+=attr->nla_len;if((attr->nla_type&NLA_TYPE_
MASK)==NETNSA_NSID){uint32_t*ptr=(uint32_t*)(attr);ns_id=ptr[1];break;}}returnns
_id;}ns_id_tzebra_ns_id_get(constchar*netnspath){intns_id=-1;structsockaddr_nlsn
l;intfd,sock,ret;unsignedintseq;ns_id_treturn_nsid=NS_UNKNOWN;/*netnspathcheck*/
if(!netnspath)returnNS_UNKNOWN;fd=open(netnspath,O_RDONLY);if(fd==-1)returnNS_UN
KNOWN;/*netlinksocket*/sock=socket(AF_NETLINK,SOCK_RAW,NETLINK_ROUTE);if(sock<0)
{zlog_err("netlink(%u)socket()error:%s",sock,safe_strerror(errno));close(fd);ret
urnNS_UNKNOWN;}memset(&snl,0,sizeof(snl));snl.nl_family=AF_NETLINK;snl.nl_groups
=RTNLGRP_NSID;snl.nl_pid=0;/*AUTOPID*/ret=bind(sock,(structsockaddr*)&snl,sizeof
(snl));if(ret<0){zlog_err("netlink(%u)socket()binderror:%s",sock,safe_strerror(e
rrno));close(sock);close(fd);returnNS_UNKNOWN;}/*messagetosendtonetlink,andrespo
nse:NEWNSID*/charbuf[NETLINK_SOCKET_BUFFER_SIZE];structnlmsghdr*nlh;structrtgenm
sg*rt;intlen;memset(buf,0,NETLINK_SOCKET_BUFFER_SIZE);nlh=initiate_nlh(buf,&seq,
RTM_NEWNSID);rt=(structrtgenmsg*)(buf+nlh->nlmsg_len);nlh->nlmsg_len+=NETLINK_AL
IGN(sizeof(structrtgenmsg));rt->rtgen_family=AF_UNSPEC;addattr32(nlh,NETLINK_SOC
KET_BUFFER_SIZE,NETNSA_FD,fd);addattr32(nlh,NETLINK_SOCKET_BUFFER_SIZE,NETNSA_NS
ID,ns_id);ret=send_receive(sock,nlh,seq,buf);if(ret<0){close(sock);close(fd);ret
urnNS_UNKNOWN;}nlh=(structnlmsghdr*)buf;/*messagetoanalyse:NEWNSIDresponse*/len=
ret;ret=0;do{if(nlh->nlmsg_type>=NLMSG_MIN_TYPE){return_nsid=extract_nsid(nlh,bu
f);if(return_nsid!=NS_UNKNOWN)break;}else{if(nlh->nlmsg_type==NLMSG_ERROR){struc
tnlmsgerr*err=(structnlmsgerr*)((char*)nlh+NETLINK_ALIGN(sizeof(structnlmsghdr))
);ret=-1;if(err->error<0)errno=-err->error;elseerrno=err->error;if(errno==0){/*r
equestNEWNSIDwassuccessfull*returnEEXISTerrortogetGETNSID*/errno=EEXIST;}}else{/
*othererrorsignored*attempttogetnsid*/ret=-1;errno=EEXIST;break;}}len=len-NETLIN
K_ALIGN(nlh->nlmsg_len);nlh=(structnlmsghdr*)((char*)nlh+NETLINK_ALIGN(nlh->nlms
g_len));}while(len!=0&&return_nsid!=NS_UNKNOWN&&ret==0);if(ret<=0){if(errno!=EEX
IST&&ret!=0){zlog_err("netlink(%u)recvfrom()error2whenreading:%s",fd,safe_strerr
or(errno));close(sock);close(fd);if(errno==ENOTSUP){zlog_warn("NEWNSIDlocallygen
erated");returnzebra_ns_id_get_fallback(netnspath);}returnNS_UNKNOWN;}/*messaget
osendtonetlink:GETNSID*/memset(buf,0,NETLINK_SOCKET_BUFFER_SIZE);nlh=initiate_nl
h(buf,&seq,RTM_GETNSID);rt=(structrtgenmsg*)(buf+nlh->nlmsg_len);nlh->nlmsg_len+
=NETLINK_ALIGN(sizeof(structrtgenmsg));rt->rtgen_family=AF_UNSPEC;addattr32(nlh,
NETLINK_SOCKET_BUFFER_SIZE,NETNSA_FD,fd);addattr32(nlh,NETLINK_SOCKET_BUFFER_SIZ
E,NETNSA_NSID,ns_id);ret=send_receive(sock,nlh,seq,buf);if(ret<0){close(sock);cl
ose(fd);returnNS_UNKNOWN;}nlh=(structnlmsghdr*)buf;len=ret;ret=0;do{if(nlh->nlms
g_type>=NLMSG_MIN_TYPE){return_nsid=extract_nsid(nlh,buf);if(return_nsid!=NS_UNK
NOWN)break;}elseif(nlh->nlmsg_type==NLMSG_ERROR){structnlmsgerr*err=(structnlmsg
err*)((char*)nlh+NETLINK_ALIGN(sizeof(structnlmsghdr)));if(err->error<0)errno=-e
rr->error;elseerrno=err->error;break;}len=len-NETLINK_ALIGN(nlh->nlmsg_len);nlh=
(structnlmsghdr*)((char*)nlh+NETLINK_ALIGN(nlh->nlmsg_len));}while(len!=0&&retur
n_nsid!=NS_UNKNOWN&&ret==0);}close(fd);close(sock);returnreturn_nsid;}#elsens_id
_tzebra_ns_id_get(constchar*netnspath){returnzebra_ns_id_get_fallback(netnspath)
;}#endif/*!defined(HAVE_NETLINK)*/#ifdefHAVE_NETNSstaticvoidzebra_ns_create_netn
s_directory(void){/*checkthat/var/run/netnsiscreated*//*S_IRWXU|S_IRGRP|S_IXGRP|
S_IROTH|S_IXOTH*/if(mkdir(NS_RUN_DIR,0755)){if(errno!=EEXIST){zlog_warn("NScheck
:failedtoaccess%s",NS_RUN_DIR);return;}}}#endifns_id_tzebra_ns_id_get_default(vo
id){#ifdefHAVE_NETNSintfd;#endif/*!HAVE_NETNS*/#ifdefHAVE_NETNSif(vrf_is_backend
_netns())zebra_ns_create_netns_directory();fd=open(NS_DEFAULT_NAME,O_RDONLY);if(
fd==-1)returnNS_DEFAULT_INTERNAL;if(!vrf_is_backend_netns()){close(fd);returnNS_
DEFAULT_INTERNAL;}close(fd);returnzebra_ns_id_get((char*)NS_DEFAULT_NAME);#else/
*HAVE_NETNS*/returnNS_DEFAULT_INTERNAL;#endif/*!HAVE_NETNS*/}