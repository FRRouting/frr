/*Routeradvertisement*Copyright(C)2016CumulusNetworks*Copyright(C)20056WIND<jean
-mickael.guerin@6wind.com>*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNU
Zebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermso
ftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion
2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeu
seful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFI
TNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yousho
uldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefile
COPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bos
ton,MA02110-1301USA*/#include<zebra.h>#include"memory.h"#include"zebra_memory.h"
#include"sockopt.h"#include"thread.h"#include"if.h"#include"stream.h"#include"lo
g.h"#include"prefix.h"#include"linklist.h"#include"command.h"#include"privs.h"#i
nclude"vrf.h"#include"ns.h"#include"zebra/interface.h"#include"zebra/rtadv.h"#in
clude"zebra/debug.h"#include"zebra/rib.h"#include"zebra/zserv.h"#include"zebra/z
ebra_ns.h"#include"zebra/zebra_vrf.h"externstructzebra_privs_tzserv_privs;#ifdef
ined(HAVE_RTADV)#ifdefOPEN_BSD#include<netinet/icmp6.h>#endif/*IfRFC2133definiti
onisused.*/#ifndefIPV6_JOIN_GROUP#defineIPV6_JOIN_GROUPIPV6_ADD_MEMBERSHIP#endif
#ifndefIPV6_LEAVE_GROUP#defineIPV6_LEAVE_GROUPIPV6_DROP_MEMBERSHIP#endif#defineA
LLNODE"ff02::1"#defineALLROUTER"ff02::2"/*Orderisintentional.MatchesRFC4191.This
arrayisalsousedforcommandmatching,soonlymodifywithcare.*/constchar*rtadv_pref_st
rs[]={"medium","high","INVALID","low",0};enumrtadv_event{RTADV_START,RTADV_STOP,
RTADV_TIMER,RTADV_TIMER_MSEC,RTADV_READ};staticvoidrtadv_event(structzebra_ns*,e
numrtadv_event,int);staticintif_join_all_router(int,structinterface*);staticinti
f_leave_all_router(int,structinterface*);staticintrtadv_increment_received(struc
tzebra_ns*zns,ifindex_t*ifindex){intret=-1;structinterface*iface;structzebra_if*
zif;iface=if_lookup_by_index_per_ns(zns,*ifindex);if(iface&&iface->info){zif=ifa
ce->info;zif->ra_rcvd++;ret=0;}returnret;}staticintrtadv_recv_packet(structzebra
_ns*zns,intsock,uint8_t*buf,intbuflen,structsockaddr_in6*from,ifindex_t*ifindex,
int*hoplimit){intret;structmsghdrmsg;structioveciov;structcmsghdr*cmsgptr;struct
in6_addrdst;charadata[1024];/*Fillinmessageandiovec.*/memset(&msg,0,sizeof(msg))
;msg.msg_name=(void*)from;msg.msg_namelen=sizeof(structsockaddr_in6);msg.msg_iov
=&iov;msg.msg_iovlen=1;msg.msg_control=(void*)adata;msg.msg_controllen=sizeofada
ta;iov.iov_base=buf;iov.iov_len=buflen;/*Ifrecvmsgfailreturnminusvalue.*/ret=rec
vmsg(sock,&msg,0);if(ret<0)returnret;for(cmsgptr=ZCMSG_FIRSTHDR(&msg);cmsgptr!=N
ULL;cmsgptr=CMSG_NXTHDR(&msg,cmsgptr)){/*Iwantinterfaceindexwhichthispacketcomes
from.*/if(cmsgptr->cmsg_level==IPPROTO_IPV6&&cmsgptr->cmsg_type==IPV6_PKTINFO){s
tructin6_pktinfo*ptr;ptr=(structin6_pktinfo*)CMSG_DATA(cmsgptr);*ifindex=ptr->ip
i6_ifindex;memcpy(&dst,&ptr->ipi6_addr,sizeof(ptr->ipi6_addr));}/*Incomingpacket
'shoplimit.*/if(cmsgptr->cmsg_level==IPPROTO_IPV6&&cmsgptr->cmsg_type==IPV6_HOPL
IMIT){int*hoptr=(int*)CMSG_DATA(cmsgptr);*hoplimit=*hoptr;}}rtadv_increment_rece
ived(zns,ifindex);returnret;}#defineRTADV_MSG_SIZE4096/*Sendrouteradvertisementp
acket.*/staticvoidrtadv_send_packet(intsock,structinterface*ifp){structmsghdrmsg
;structioveciov;structcmsghdr*cmsgptr;structin6_pktinfo*pkt;structsockaddr_in6ad
dr;staticvoid*adata=NULL;unsignedcharbuf[RTADV_MSG_SIZE];structnd_router_advert*
rtadv;intret;intlen=0;structzebra_if*zif;structrtadv_prefix*rprefix;uint8_tall_n
odes_addr[]={0xff,0x02,0,0,0,0,0,0,0,0,0,0,0,0,0,1};structlistnode*node;uint16_t
pkt_RouterLifetime;/**Allocatecontrolmessagebufffer.Thisisdynamicbecause*CMSG_SP
ACEisnotguaranteednottocallafunction.Notethat*thesizewillbedifferentondifferenta
rchitecturesdueto*differingalignmentrules.*/if(adata==NULL){/*XXXFreeonshutdown.
*/adata=calloc(1,CMSG_SPACE(sizeof(structin6_pktinfo)));if(adata==NULL){zlog_err
("rtadv_send_packet:can'tmalloccontroldata");exit(-1);}}/*Loggingofpacket.*/if(I
S_ZEBRA_DEBUG_PACKET)zlog_debug("%s(%u):TxRA,socket%u",ifp->name,ifp->ifindex,so
ck);/*Fillinsockaddr_in6.*/memset(&addr,0,sizeof(structsockaddr_in6));addr.sin6_
family=AF_INET6;#ifdefSIN6_LENaddr.sin6_len=sizeof(structsockaddr_in6);#endif/*S
IN6_LEN*/addr.sin6_port=htons(IPPROTO_ICMPV6);IPV6_ADDR_COPY(&addr.sin6_addr,all
_nodes_addr);/*Fetchinterfaceinformation.*/zif=ifp->info;/*Makerouteradvertiseme
ntmessage.*/rtadv=(structnd_router_advert*)buf;rtadv->nd_ra_type=ND_ROUTER_ADVER
T;rtadv->nd_ra_code=0;rtadv->nd_ra_cksum=0;rtadv->nd_ra_curhoplimit=64;/*RFC4191
:DefaultRouterPreferenceis0ifRouterLifetimeis0.*/rtadv->nd_ra_flags_reserved=zif
->rtadv.AdvDefaultLifetime==0?0:zif->rtadv.DefaultPreference;rtadv->nd_ra_flags_
reserved<<=3;if(zif->rtadv.AdvManagedFlag)rtadv->nd_ra_flags_reserved|=ND_RA_FLA
G_MANAGED;if(zif->rtadv.AdvOtherConfigFlag)rtadv->nd_ra_flags_reserved|=ND_RA_FL
AG_OTHER;if(zif->rtadv.AdvHomeAgentFlag)rtadv->nd_ra_flags_reserved|=ND_RA_FLAG_
HOME_AGENT;/*NotethataccordingtoNeighborDiscovery(RFC4861[18]),*AdvDefaultLifeti
meisbydefaultbasedonthevalueof*MaxRtrAdvInterval.AdvDefaultLifetimeisusedintheRo
uterLifetime*fieldofRouterAdvertisements.Giventhatthisfieldisexpressed*inseconds
,asmallMaxRtrAdvIntervalvaluecanresultinazero*valueforthisfield.Topreventthis,ro
utersSHOULDkeep*AdvDefaultLifetimeinatleastonesecond,eveniftheuseof*MaxRtrAdvInt
ervalwouldresultinasmallervalue.--RFC6275,7.5*/pkt_RouterLifetime=zif->rtadv.Adv
DefaultLifetime!=-1?zif->rtadv.AdvDefaultLifetime:MAX(1,0.003*zif->rtadv.MaxRtrA
dvInterval);rtadv->nd_ra_router_lifetime=htons(pkt_RouterLifetime);rtadv->nd_ra_
reachable=htonl(zif->rtadv.AdvReachableTime);rtadv->nd_ra_retransmit=htonl(0);le
n=sizeof(structnd_router_advert);/*IfboththeHomeAgentPreferenceandHomeAgentLifet
imearesetto*theirdefaultvaluesspecifiedabove,thisoptionSHOULDNOTbe*includedinthe
RouterAdvertisementmessagessentbythishome*agent.--RFC6275,7.4*/if(zif->rtadv.Adv
HomeAgentFlag&&(zif->rtadv.HomeAgentPreference||zif->rtadv.HomeAgentLifetime!=-1
)){structnd_opt_homeagent_info*ndopt_hai=(structnd_opt_homeagent_info*)(buf+len)
;ndopt_hai->nd_opt_hai_type=ND_OPT_HA_INFORMATION;ndopt_hai->nd_opt_hai_len=1;nd
opt_hai->nd_opt_hai_reserved=0;ndopt_hai->nd_opt_hai_preference=htons(zif->rtadv
.HomeAgentPreference);/*16-bitunsignedinteger.Thelifetimeassociatedwiththe*home*
agentinunitsofseconds.Thedefaultvalueisthesameas*the*RouterLifetime,asspecifiedi
nthemainbodyoftheRouter*Advertisement.Themaximumvaluecorrespondsto18.2hours.*A*v
alueof0MUSTNOTbeused.--RFC6275,7.5*/ndopt_hai->nd_opt_hai_lifetime=htons(zif->rt
adv.HomeAgentLifetime!=-1?zif->rtadv.HomeAgentLifetime:MAX(1,pkt_RouterLifetime)
/*0isOKforRL,butnotforHAL*/);len+=sizeof(structnd_opt_homeagent_info);}if(zif->r
tadv.AdvIntervalOption){structnd_opt_adv_interval*ndopt_adv=(structnd_opt_adv_in
terval*)(buf+len);ndopt_adv->nd_opt_ai_type=ND_OPT_ADV_INTERVAL;ndopt_adv->nd_op
t_ai_len=1;ndopt_adv->nd_opt_ai_reserved=0;ndopt_adv->nd_opt_ai_interval=htonl(z
if->rtadv.MaxRtrAdvInterval);len+=sizeof(structnd_opt_adv_interval);}/*Fillinpre
fix.*/for(ALL_LIST_ELEMENTS_RO(zif->rtadv.AdvPrefixList,node,rprefix)){structnd_
opt_prefix_info*pinfo;pinfo=(structnd_opt_prefix_info*)(buf+len);pinfo->nd_opt_p
i_type=ND_OPT_PREFIX_INFORMATION;pinfo->nd_opt_pi_len=4;pinfo->nd_opt_pi_prefix_
len=rprefix->prefix.prefixlen;pinfo->nd_opt_pi_flags_reserved=0;if(rprefix->AdvO
nLinkFlag)pinfo->nd_opt_pi_flags_reserved|=ND_OPT_PI_FLAG_ONLINK;if(rprefix->Adv
AutonomousFlag)pinfo->nd_opt_pi_flags_reserved|=ND_OPT_PI_FLAG_AUTO;if(rprefix->
AdvRouterAddressFlag)pinfo->nd_opt_pi_flags_reserved|=ND_OPT_PI_FLAG_RADDR;pinfo
->nd_opt_pi_valid_time=htonl(rprefix->AdvValidLifetime);pinfo->nd_opt_pi_preferr
ed_time=htonl(rprefix->AdvPreferredLifetime);pinfo->nd_opt_pi_reserved2=0;IPV6_A
DDR_COPY(&pinfo->nd_opt_pi_prefix,&rprefix->prefix.prefix);#ifdefDEBUG{uint8_tbu
f[INET6_ADDRSTRLEN];zlog_debug("DEBUG%s",inet_ntop(AF_INET6,&pinfo->nd_opt_pi_pr
efix,buf,INET6_ADDRSTRLEN));}#endif/*DEBUG*/len+=sizeof(structnd_opt_prefix_info
);}/*Hardwareaddress.*/if(ifp->hw_addr_len!=0){buf[len++]=ND_OPT_SOURCE_LINKADDR
;/*Optionlengthshouldberoundeduptonextoctetifthelinkaddressdoesnotendonanoctetbo
undary.*/buf[len++]=(ifp->hw_addr_len+9)>>3;memcpy(buf+len,ifp->hw_addr,ifp->hw_
addr_len);len+=ifp->hw_addr_len;/*Padoptiontoendonanoctetboundary.*/memset(buf+l
en,0,-(ifp->hw_addr_len+2)&0x7);len+=-(ifp->hw_addr_len+2)&0x7;}/*MTU*/if(zif->r
tadv.AdvLinkMTU){structnd_opt_mtu*opt=(structnd_opt_mtu*)(buf+len);opt->nd_opt_m
tu_type=ND_OPT_MTU;opt->nd_opt_mtu_len=1;opt->nd_opt_mtu_reserved=0;opt->nd_opt_
mtu_mtu=htonl(zif->rtadv.AdvLinkMTU);len+=sizeof(structnd_opt_mtu);}msg.msg_name
=(void*)&addr;msg.msg_namelen=sizeof(structsockaddr_in6);msg.msg_iov=&iov;msg.ms
g_iovlen=1;msg.msg_control=(void*)adata;msg.msg_controllen=CMSG_SPACE(sizeof(str
uctin6_pktinfo));msg.msg_flags=0;iov.iov_base=buf;iov.iov_len=len;cmsgptr=ZCMSG_
FIRSTHDR(&msg);cmsgptr->cmsg_len=CMSG_LEN(sizeof(structin6_pktinfo));cmsgptr->cm
sg_level=IPPROTO_IPV6;cmsgptr->cmsg_type=IPV6_PKTINFO;pkt=(structin6_pktinfo*)CM
SG_DATA(cmsgptr);memset(&pkt->ipi6_addr,0,sizeof(structin6_addr));pkt->ipi6_ifin
dex=ifp->ifindex;ret=sendmsg(sock,&msg,0);if(ret<0){zlog_err("%s(%u):TxRAfailed,
socket%uerror%d(%s)",ifp->name,ifp->ifindex,sock,errno,safe_strerror(errno));}el
sezif->ra_sent++;}staticintrtadv_timer(structthread*thread){structzebra_ns*zns=T
HREAD_ARG(thread);structvrf*vrf;structinterface*ifp;structzebra_if*zif;intperiod
;zns->rtadv.ra_timer=NULL;if(zns->rtadv.adv_msec_if_count==0){period=1000;/*1s*/
rtadv_event(zns,RTADV_TIMER,1/*1s*/);}else{period=10;/*10ms*/rtadv_event(zns,RTA
DV_TIMER_MSEC,10/*10ms*/);}RB_FOREACH(vrf,vrf_id_head,&vrfs_by_id)FOR_ALL_INTERF
ACES(vrf,ifp){if(if_is_loopback(ifp)||CHECK_FLAG(ifp->status,ZEBRA_INTERFACE_VRF
_LOOPBACK)||!if_is_operative(ifp))continue;zif=ifp->info;if(zif->rtadv.AdvSendAd
vertisements){if(zif->rtadv.inFastRexmit){/*Weassumewefastrexmiteverysecso*no*ad
ditionalvars*/if(--zif->rtadv.NumFastReXmitsRemain<=0)zif->rtadv.inFastRexmit=0;
if(IS_ZEBRA_DEBUG_SEND)zlog_debug("FastRARexmitoninterface%s",ifp->name);rtadv_s
end_packet(zns->rtadv.sock,ifp);}else{zif->rtadv.AdvIntervalTimer-=period;if(zif
->rtadv.AdvIntervalTimer<=0){/*FIXME:usingMaxRtrAdvIntervaleachtimeisn'twhatsect
ion6.2.4ofRFC4861tellstodo.*/zif->rtadv.AdvIntervalTimer=zif->rtadv.MaxRtrAdvInt
erval;rtadv_send_packet(zns->rtadv.sock,ifp);}}}}return0;}staticvoidrtadv_proces
s_solicit(structinterface*ifp){structzebra_vrf*zvrf=vrf_info_lookup(ifp->vrf_id)
;structzebra_ns*zns=zvrf->zns;assert(zns);rtadv_send_packet(zns->rtadv.sock,ifp)
;}staticvoidrtadv_process_advert(uint8_t*msg,unsignedintlen,structinterface*ifp,
structsockaddr_in6*addr){structnd_router_advert*radvert;charaddr_str[INET6_ADDRS
TRLEN];structzebra_if*zif;structprefixp;zif=ifp->info;inet_ntop(AF_INET6,&addr->
sin6_addr,addr_str,INET6_ADDRSTRLEN);if(len<sizeof(structnd_router_advert)){zlog
_warn("%s(%u):RxRAwithinvalidlength%dfrom%s",ifp->name,ifp->ifindex,len,addr_str
);return;}if(!IN6_IS_ADDR_LINKLOCAL(&addr->sin6_addr)){zlog_warn("%s(%u):RxRAwit
hnon-linklocalsourceaddressfrom%s",ifp->name,ifp->ifindex,addr_str);return;}radv
ert=(structnd_router_advert*)msg;if((radvert->nd_ra_curhoplimit&&zif->rtadv.AdvC
urHopLimit)&&(radvert->nd_ra_curhoplimit!=zif->rtadv.AdvCurHopLimit)){zlog_warn(
"%s(%u):RxRA-ourAdvCurHopLimitdoesn'tagreewith%s",ifp->name,ifp->ifindex,addr_st
r);}if((radvert->nd_ra_flags_reserved&ND_RA_FLAG_MANAGED)&&!zif->rtadv.AdvManage
dFlag){zlog_warn("%s(%u):RxRA-ourAdvManagedFlagdoesn'tagreewith%s",ifp->name,ifp
->ifindex,addr_str);}if((radvert->nd_ra_flags_reserved&ND_RA_FLAG_OTHER)&&!zif->
rtadv.AdvOtherConfigFlag){zlog_warn("%s(%u):RxRA-ourAdvOtherConfigFlagdoesn'tagr
eewith%s",ifp->name,ifp->ifindex,addr_str);}if((radvert->nd_ra_reachable&&zif->r
tadv.AdvReachableTime)&&(ntohl(radvert->nd_ra_reachable)!=zif->rtadv.AdvReachabl
eTime)){zlog_warn("%s(%u):RxRA-ourAdvReachableTimedoesn'tagreewith%s",ifp->name,
ifp->ifindex,addr_str);}if((radvert->nd_ra_retransmit&&zif->rtadv.AdvRetransTime
r)&&(ntohl(radvert->nd_ra_retransmit)!=(unsignedint)zif->rtadv.AdvRetransTimer))
{zlog_warn("%s(%u):RxRA-ourAdvRetransTimerdoesn'tagreewith%s",ifp->name,ifp->ifi
ndex,addr_str);}/*Createentryforneighborifnotknown.*/p.family=AF_INET6;IPV6_ADDR
_COPY(&p.u.prefix,&addr->sin6_addr);p.prefixlen=IPV6_MAX_PREFIXLEN;if(!nbr_conne
cted_check(ifp,&p))nbr_connected_add_ipv6(ifp,&addr->sin6_addr);}staticvoidrtadv
_process_packet(uint8_t*buf,unsignedintlen,ifindex_tifindex,inthoplimit,structso
ckaddr_in6*from,structzebra_ns*zns){structicmp6_hdr*icmph;structinterface*ifp;st
ructzebra_if*zif;charaddr_str[INET6_ADDRSTRLEN];inet_ntop(AF_INET6,&from->sin6_a
ddr,addr_str,INET6_ADDRSTRLEN);/*Interfacesearch.*/ifp=if_lookup_by_index_per_ns
(zns,ifindex);if(ifp==NULL){zlog_warn("RA/RSreceivedonunknownIF%ufrom%s",ifindex
,addr_str);return;}if(IS_ZEBRA_DEBUG_PACKET)zlog_debug("%s(%u):RxRA/RSlen%dfrom%
s",ifp->name,ifp->ifindex,len,addr_str);if(if_is_loopback(ifp)||CHECK_FLAG(ifp->
status,ZEBRA_INTERFACE_VRF_LOOPBACK))return;/*Checkinterfaceconfiguration.*/zif=
ifp->info;if(!zif->rtadv.AdvSendAdvertisements)return;/*ICMPmessagelengthcheck.*
/if(len<sizeof(structicmp6_hdr)){zlog_warn("%s(%u):RxRAwithInvalidICMPV6packetle
ngth%d",ifp->name,ifp->ifindex,len);return;}icmph=(structicmp6_hdr*)buf;/*ICMPme
ssagetypecheck.*/if(icmph->icmp6_type!=ND_ROUTER_SOLICIT&&icmph->icmp6_type!=ND_
ROUTER_ADVERT){zlog_warn("%s(%u):RxRA-UnwantedICMPV6messagetype%d",ifp->name,ifp
->ifindex,icmph->icmp6_type);return;}/*Hoplimitcheck.*/if(hoplimit>=0&&hoplimit!
=255){zlog_warn("%s(%u):RxRA-Invalidhoplimit%d",ifp->name,ifp->ifindex,hoplimit)
;return;}/*CheckICMPmessagetype.*/if(icmph->icmp6_type==ND_ROUTER_SOLICIT)rtadv_
process_solicit(ifp);elseif(icmph->icmp6_type==ND_ROUTER_ADVERT)rtadv_process_ad
vert(buf,len,ifp,from);return;}staticintrtadv_read(structthread*thread){intsock;
intlen;uint8_tbuf[RTADV_MSG_SIZE];structsockaddr_in6from;ifindex_tifindex=0;inth
oplimit=-1;structzebra_ns*zns=THREAD_ARG(thread);sock=THREAD_FD(thread);zns->rta
dv.ra_read=NULL;/*Registermyself.*/rtadv_event(zns,RTADV_READ,sock);len=rtadv_re
cv_packet(zns,sock,buf,sizeof(buf),&from,&ifindex,&hoplimit);if(len<0){zlog_warn
("RA/RSrecvfailed,socket%uerror%s",sock,safe_strerror(errno));returnlen;}rtadv_p
rocess_packet(buf,(unsigned)len,ifindex,hoplimit,&from,zns);return0;}staticintrt
adv_make_socket(ns_id_tns_id){intsock;intret=0;structicmp6_filterfilter;if(zserv
_privs.change(ZPRIVS_RAISE))zlog_err("rtadv_make_socket:couldnotraiseprivs,%s",s
afe_strerror(errno));sock=ns_socket(AF_INET6,SOCK_RAW,IPPROTO_ICMPV6,ns_id);if(z
serv_privs.change(ZPRIVS_LOWER))zlog_err("rtadv_make_socket:couldnotlowerprivs,%
s",safe_strerror(errno));if(sock<0){return-1;}ret=setsockopt_ipv6_pktinfo(sock,1
);if(ret<0){close(sock);returnret;}ret=setsockopt_ipv6_multicast_loop(sock,0);if
(ret<0){close(sock);returnret;}ret=setsockopt_ipv6_unicast_hops(sock,255);if(ret
<0){close(sock);returnret;}ret=setsockopt_ipv6_multicast_hops(sock,255);if(ret<0
){close(sock);returnret;}ret=setsockopt_ipv6_hoplimit(sock,1);if(ret<0){close(so
ck);returnret;}ICMP6_FILTER_SETBLOCKALL(&filter);ICMP6_FILTER_SETPASS(ND_ROUTER_
SOLICIT,&filter);ICMP6_FILTER_SETPASS(ND_ROUTER_ADVERT,&filter);ret=setsockopt(s
ock,IPPROTO_ICMPV6,ICMP6_FILTER,&filter,sizeof(structicmp6_filter));if(ret<0){zl
og_info("ICMP6_FILTERsetfail:%s",safe_strerror(errno));close(sock);returnret;}re
turnsock;}staticstructrtadv_prefix*rtadv_prefix_new(void){returnXCALLOC(MTYPE_RT
ADV_PREFIX,sizeof(structrtadv_prefix));}staticvoidrtadv_prefix_free(structrtadv_
prefix*rtadv_prefix){XFREE(MTYPE_RTADV_PREFIX,rtadv_prefix);}staticstructrtadv_p
refix*rtadv_prefix_lookup(structlist*rplist,structprefix_ipv6*p){structlistnode*
node;structrtadv_prefix*rprefix;for(ALL_LIST_ELEMENTS_RO(rplist,node,rprefix))if
(prefix_same((structprefix*)&rprefix->prefix,(structprefix*)p))returnrprefix;ret
urnNULL;}staticstructrtadv_prefix*rtadv_prefix_get(structlist*rplist,structprefi
x_ipv6*p){structrtadv_prefix*rprefix;rprefix=rtadv_prefix_lookup(rplist,p);if(rp
refix)returnrprefix;rprefix=rtadv_prefix_new();memcpy(&rprefix->prefix,p,sizeof(
structprefix_ipv6));listnode_add(rplist,rprefix);returnrprefix;}staticvoidrtadv_
prefix_set(structzebra_if*zif,structrtadv_prefix*rp){structrtadv_prefix*rprefix;
rprefix=rtadv_prefix_get(zif->rtadv.AdvPrefixList,&rp->prefix);/*Setparameters.*
/rprefix->AdvValidLifetime=rp->AdvValidLifetime;rprefix->AdvPreferredLifetime=rp
->AdvPreferredLifetime;rprefix->AdvOnLinkFlag=rp->AdvOnLinkFlag;rprefix->AdvAuto
nomousFlag=rp->AdvAutonomousFlag;rprefix->AdvRouterAddressFlag=rp->AdvRouterAddr
essFlag;}staticintrtadv_prefix_reset(structzebra_if*zif,structrtadv_prefix*rp){s
tructrtadv_prefix*rprefix;rprefix=rtadv_prefix_lookup(zif->rtadv.AdvPrefixList,&
rp->prefix);if(rprefix!=NULL){listnode_delete(zif->rtadv.AdvPrefixList,(void*)rp
refix);rtadv_prefix_free(rprefix);return1;}elsereturn0;}staticvoidipv6_nd_suppre
ss_ra_set(structinterface*ifp,ipv6_nd_suppress_ra_statusstatus){structzebra_if*z
if;structzebra_vrf*zvrf;structzebra_ns*zns;zif=ifp->info;zvrf=vrf_info_lookup(if
p->vrf_id);zns=zvrf->zns;if(status==RA_SUPPRESS){/*RAiscurrentlyenabled*/if(zif-
>rtadv.AdvSendAdvertisements){zif->rtadv.AdvSendAdvertisements=0;zif->rtadv.AdvI
ntervalTimer=0;zns->rtadv.adv_if_count--;if_leave_all_router(zns->rtadv.sock,ifp
);if(zns->rtadv.adv_if_count==0)rtadv_event(zns,RTADV_STOP,0);}}else{if(!zif->rt
adv.AdvSendAdvertisements){zif->rtadv.AdvSendAdvertisements=1;zif->rtadv.AdvInte
rvalTimer=0;zns->rtadv.adv_if_count++;if(zif->rtadv.MaxRtrAdvInterval>=1000){/*E
nableFastRAonlywhenRAintervalisin*secs*/zif->rtadv.inFastRexmit=1;zif->rtadv.Num
FastReXmitsRemain=RTADV_NUM_FAST_REXMITS;}if_join_all_router(zns->rtadv.sock,ifp
);if(zns->rtadv.adv_if_count==1)rtadv_event(zns,RTADV_START,zns->rtadv.sock);}}}
/**Handleclient(BGP)messagetoenableordisableIPv6RAonaninterface.*Notethatwhileth
eclientcouldrequestRAonaninterfaceonwhichthe*operatorhasnotenabledRA,RAwon'tbedi
sableduponclientrequest*iftheoperatorhasexplicitlyenabledRA.Theenablerequestcana
lso*specifyaRAinterval(inseconds).*/staticvoidzebra_interface_radv_set(ZAPI_HAND
LER_ARGS,intenable){structstream*s;ifindex_tifindex;structinterface*ifp;structze
bra_if*zif;intra_interval;s=msg;/*GetinterfaceindexandRAinterval.*/STREAM_GETL(s
,ifindex);STREAM_GETL(s,ra_interval);if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("%u:IF%u
RA%sfromclient%s,interval%ds",zvrf_id(zvrf),ifindex,enable?"enable":"disable",ze
bra_route_string(client->proto),ra_interval);/*LocateinterfaceandcheckVRFmatch.*
/ifp=if_lookup_by_index_per_ns(zebra_ns_lookup(NS_DEFAULT),ifindex);if(!ifp){zlo
g_warn("%u:IF%uRA%sclient%s-interfaceunknown",zvrf_id(zvrf),ifindex,enable?"enab
le":"disable",zebra_route_string(client->proto));return;}if(ifp->vrf_id!=zvrf_id
(zvrf)){zlog_warn("%u:IF%uRA%sclient%s-VRFmismatch,IFVRF%u",zvrf_id(zvrf),ifinde
x,enable?"enable":"disable",zebra_route_string(client->proto),ifp->vrf_id);retur
n;}zif=ifp->info;if(enable){SET_FLAG(zif->rtadv.ra_configured,BGP_RA_CONFIGURED)
;ipv6_nd_suppress_ra_set(ifp,RA_ENABLE);if(ra_interval&&(ra_interval*1000)<zif->
rtadv.MaxRtrAdvInterval&&!CHECK_FLAG(zif->rtadv.ra_configured,VTY_RA_INTERVAL_CO
NFIGURED))zif->rtadv.MaxRtrAdvInterval=ra_interval*1000;}else{UNSET_FLAG(zif->rt
adv.ra_configured,BGP_RA_CONFIGURED);if(!CHECK_FLAG(zif->rtadv.ra_configured,VTY
_RA_INTERVAL_CONFIGURED))zif->rtadv.MaxRtrAdvInterval=RTADV_MAX_RTR_ADV_INTERVAL
;if(!CHECK_FLAG(zif->rtadv.ra_configured,VTY_RA_CONFIGURED))ipv6_nd_suppress_ra_
set(ifp,RA_SUPPRESS);}stream_failure:return;}voidzebra_interface_radv_disable(ZA
PI_HANDLER_ARGS){zebra_interface_radv_set(client,hdr,msg,zvrf,0);}voidzebra_inte
rface_radv_enable(ZAPI_HANDLER_ARGS){zebra_interface_radv_set(client,hdr,msg,zvr
f,1);}DEFUN(ipv6_nd_suppress_ra,ipv6_nd_suppress_ra_cmd,"ipv6ndsuppress-ra","Int
erfaceIPv6configcommands\n""Neighbordiscovery\n""SuppressRouterAdvertisement\n")
{VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;if(if_is_loopba
ck(ifp)||CHECK_FLAG(ifp->status,ZEBRA_INTERFACE_VRF_LOOPBACK)){vty_out(vty,"Cann
otconfigureIPv6RouterAdvertisementsonthisinterface\n");returnCMD_WARNING_CONFIG_
FAILED;}if(!CHECK_FLAG(zif->rtadv.ra_configured,BGP_RA_CONFIGURED))ipv6_nd_suppr
ess_ra_set(ifp,RA_SUPPRESS);UNSET_FLAG(zif->rtadv.ra_configured,VTY_RA_CONFIGURE
D);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_suppress_ra,no_ipv6_nd_suppress_ra_cmd,"n
oipv6ndsuppress-ra",NO_STR"InterfaceIPv6configcommands\n""Neighbordiscovery\n""S
uppressRouterAdvertisement\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if
*zif=ifp->info;if(if_is_loopback(ifp)||CHECK_FLAG(ifp->status,ZEBRA_INTERFACE_VR
F_LOOPBACK)){vty_out(vty,"CannotconfigureIPv6RouterAdvertisementsonthisinterface
\n");returnCMD_WARNING_CONFIG_FAILED;}ipv6_nd_suppress_ra_set(ifp,RA_ENABLE);SET
_FLAG(zif->rtadv.ra_configured,VTY_RA_CONFIGURED);returnCMD_SUCCESS;}DEFUN(ipv6_
nd_ra_interval_msec,ipv6_nd_ra_interval_msec_cmd,"ipv6ndra-intervalmsec(70-18000
00)","InterfaceIPv6configcommands\n""Neighbordiscovery\n""RouterAdvertisementint
erval\n""RouterAdvertisementintervalinmilliseconds\n""RouterAdvertisementinterva
linmilliseconds\n"){intidx_number=4;VTY_DECLVAR_CONTEXT(interface,ifp);unsignedi
nterval;structzebra_if*zif=ifp->info;structzebra_vrf*zvrf=vrf_info_lookup(ifp->v
rf_id);structzebra_ns*zns;zns=zvrf->zns;interval=strtoul(argv[idx_number]->arg,N
ULL,10);if((zif->rtadv.AdvDefaultLifetime!=-1&&interval>(unsigned)zif->rtadv.Adv
DefaultLifetime*1000)){vty_out(vty,"Thisra-intervalwouldconflictwithconfiguredra
-lifetime!\n");returnCMD_WARNING_CONFIG_FAILED;}if(zif->rtadv.MaxRtrAdvInterval%
1000)zns->rtadv.adv_msec_if_count--;if(interval%1000)zns->rtadv.adv_msec_if_coun
t++;SET_FLAG(zif->rtadv.ra_configured,VTY_RA_INTERVAL_CONFIGURED);zif->rtadv.Max
RtrAdvInterval=interval;zif->rtadv.MinRtrAdvInterval=0.33*interval;zif->rtadv.Ad
vIntervalTimer=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_ra_interval,ipv6_nd_ra_interva
l_cmd,"ipv6ndra-interval(1-1800)","InterfaceIPv6configcommands\n""Neighbordiscov
ery\n""RouterAdvertisementinterval\n""RouterAdvertisementintervalinseconds\n"){i
ntidx_number=3;VTY_DECLVAR_CONTEXT(interface,ifp);unsignedinterval;structzebra_i
f*zif=ifp->info;structzebra_vrf*zvrf=vrf_info_lookup(ifp->vrf_id);structzebra_ns
*zns;zns=zvrf->zns;interval=strtoul(argv[idx_number]->arg,NULL,10);if((zif->rtad
v.AdvDefaultLifetime!=-1&&interval>(unsigned)zif->rtadv.AdvDefaultLifetime)){vty
_out(vty,"Thisra-intervalwouldconflictwithconfiguredra-lifetime!\n");returnCMD_W
ARNING_CONFIG_FAILED;}if(zif->rtadv.MaxRtrAdvInterval%1000)zns->rtadv.adv_msec_i
f_count--;/*converttomilliseconds*/interval=interval*1000;SET_FLAG(zif->rtadv.ra
_configured,VTY_RA_INTERVAL_CONFIGURED);zif->rtadv.MaxRtrAdvInterval=interval;zi
f->rtadv.MinRtrAdvInterval=0.33*interval;zif->rtadv.AdvIntervalTimer=0;returnCMD
_SUCCESS;}DEFUN(no_ipv6_nd_ra_interval,no_ipv6_nd_ra_interval_cmd,"noipv6ndra-in
terval[<(1-1800)|msec(1-1800000)>]",NO_STR"InterfaceIPv6configcommands\n""Neighb
ordiscovery\n""RouterAdvertisementinterval\n""RouterAdvertisementintervalinsecon
ds\n""Specifymillisecondrouteradvertisementinterval\n""RouterAdvertisementinterv
alinmilliseconds\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->
info;structzebra_vrf*zvrf;structzebra_ns*zns;zvrf=vrf_info_lookup(ifp->vrf_id);z
ns=zvrf->zns;if(zif->rtadv.MaxRtrAdvInterval%1000)zns->rtadv.adv_msec_if_count--
;UNSET_FLAG(zif->rtadv.ra_configured,VTY_RA_INTERVAL_CONFIGURED);if(CHECK_FLAG(z
if->rtadv.ra_configured,BGP_RA_CONFIGURED))zif->rtadv.MaxRtrAdvInterval=10000;el
sezif->rtadv.MaxRtrAdvInterval=RTADV_MAX_RTR_ADV_INTERVAL;zif->rtadv.AdvInterval
Timer=zif->rtadv.MaxRtrAdvInterval;zif->rtadv.MinRtrAdvInterval=RTADV_MIN_RTR_AD
V_INTERVAL;returnCMD_SUCCESS;}DEFUN(ipv6_nd_ra_lifetime,ipv6_nd_ra_lifetime_cmd,
"ipv6ndra-lifetime(0-9000)","InterfaceIPv6configcommands\n""Neighbordiscovery\n"
"Routerlifetime\n""Routerlifetimeinseconds(0standsforanon-defaultgw)\n"){intidx_
number=3;VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;intlife
time;lifetime=strtoul(argv[idx_number]->arg,NULL,10);/*ThevaluetobeplacedintheRo
uterLifetimefield*ofRouterAdvertisementssentfromtheinterface,*inseconds.MUSTbeei
therzeroorbetween*MaxRtrAdvIntervaland9000seconds.--RFC4861,6.2.1*/if((lifetime!
=0&&lifetime*1000<zif->rtadv.MaxRtrAdvInterval)){vty_out(vty,"Thisra-lifetimewou
ldconflictwithconfiguredra-interval\n");returnCMD_WARNING_CONFIG_FAILED;}zif->rt
adv.AdvDefaultLifetime=lifetime;returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_ra_lifetime,
no_ipv6_nd_ra_lifetime_cmd,"noipv6ndra-lifetime[(0-9000)]",NO_STR"InterfaceIPv6c
onfigcommands\n""Neighbordiscovery\n""Routerlifetime\n""Routerlifetimeinseconds(
0standsforanon-defaultgw)\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*
zif=ifp->info;zif->rtadv.AdvDefaultLifetime=-1;returnCMD_SUCCESS;}DEFUN(ipv6_nd_
reachable_time,ipv6_nd_reachable_time_cmd,"ipv6ndreachable-time(1-3600000)","Int
erfaceIPv6configcommands\n""Neighbordiscovery\n""Reachabletime\n""Reachabletimei
nmilliseconds\n"){intidx_number=3;VTY_DECLVAR_CONTEXT(interface,ifp);structzebra
_if*zif=ifp->info;zif->rtadv.AdvReachableTime=strtoul(argv[idx_number]->arg,NULL
,10);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_reachable_time,no_ipv6_nd_reachable_tim
e_cmd,"noipv6ndreachable-time[(1-3600000)]",NO_STR"InterfaceIPv6configcommands\n
""Neighbordiscovery\n""Reachabletime\n""Reachabletimeinmilliseconds\n"){VTY_DECL
VAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvReachableT
ime=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_homeagent_preference,ipv6_nd_homeagent_pr
eference_cmd,"ipv6ndhome-agent-preference(0-65535)","InterfaceIPv6configcommands
\n""Neighbordiscovery\n""HomeAgentpreference\n""preferencevalue(defaultis0,least
preferred)\n"){intidx_number=3;VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if
*zif=ifp->info;zif->rtadv.HomeAgentPreference=strtoul(argv[idx_number]->arg,NULL
,10);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_homeagent_preference,no_ipv6_nd_homeage
nt_preference_cmd,"noipv6ndhome-agent-preference[(0-65535)]",NO_STR"InterfaceIPv
6configcommands\n""Neighbordiscovery\n""HomeAgentpreference\n""preferencevalue(d
efaultis0,leastpreferred)\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*
zif=ifp->info;zif->rtadv.HomeAgentPreference=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_
homeagent_lifetime,ipv6_nd_homeagent_lifetime_cmd,"ipv6ndhome-agent-lifetime(0-6
5520)","InterfaceIPv6configcommands\n""Neighbordiscovery\n""HomeAgentlifetime\n"
"HomeAgentlifetimeinseconds(0totrackra-lifetime)\n"){intidx_number=3;VTY_DECLVAR
_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.HomeAgentLifetim
e=strtoul(argv[idx_number]->arg,NULL,10);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_hom
eagent_lifetime,no_ipv6_nd_homeagent_lifetime_cmd,"noipv6ndhome-agent-lifetime[(
0-65520)]",NO_STR"InterfaceIPv6configcommands\n""Neighbordiscovery\n""HomeAgentl
ifetime\n""HomeAgentlifetimeinseconds(0totrackra-lifetime)\n"){VTY_DECLVAR_CONTE
XT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.HomeAgentLifetime=-1;r
eturnCMD_SUCCESS;}DEFUN(ipv6_nd_managed_config_flag,ipv6_nd_managed_config_flag_
cmd,"ipv6ndmanaged-config-flag","InterfaceIPv6configcommands\n""Neighbordiscover
y\n""Managedaddressconfigurationflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp);stru
ctzebra_if*zif=ifp->info;zif->rtadv.AdvManagedFlag=1;returnCMD_SUCCESS;}DEFUN(no
_ipv6_nd_managed_config_flag,no_ipv6_nd_managed_config_flag_cmd,"noipv6ndmanaged
-config-flag",NO_STR"InterfaceIPv6configcommands\n""Neighbordiscovery\n""Managed
addressconfigurationflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*z
if=ifp->info;zif->rtadv.AdvManagedFlag=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_homeag
ent_config_flag,ipv6_nd_homeagent_config_flag_cmd,"ipv6ndhome-agent-config-flag"
,"InterfaceIPv6configcommands\n""Neighbordiscovery\n""HomeAgentconfigurationflag
\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.
AdvHomeAgentFlag=1;returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_homeagent_config_flag,no_
ipv6_nd_homeagent_config_flag_cmd,"noipv6ndhome-agent-config-flag",NO_STR"Interf
aceIPv6configcommands\n""Neighbordiscovery\n""HomeAgentconfigurationflag\n"){VTY
_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvHomeA
gentFlag=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_adv_interval_config_option,ipv6_nd_a
dv_interval_config_option_cmd,"ipv6ndadv-interval-option","InterfaceIPv6configco
mmands\n""Neighbordiscovery\n""AdvertisementIntervalOption\n"){VTY_DECLVAR_CONTE
XT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvIntervalOption=1;re
turnCMD_SUCCESS;}DEFUN(no_ipv6_nd_adv_interval_config_option,no_ipv6_nd_adv_inte
rval_config_option_cmd,"noipv6ndadv-interval-option",NO_STR"InterfaceIPv6configc
ommands\n""Neighbordiscovery\n""AdvertisementIntervalOption\n"){VTY_DECLVAR_CONT
EXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvIntervalOption=0;r
eturnCMD_SUCCESS;}DEFUN(ipv6_nd_other_config_flag,ipv6_nd_other_config_flag_cmd,
"ipv6ndother-config-flag","InterfaceIPv6configcommands\n""Neighbordiscovery\n""O
therstatefullconfigurationflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebr
a_if*zif=ifp->info;zif->rtadv.AdvOtherConfigFlag=1;returnCMD_SUCCESS;}DEFUN(no_i
pv6_nd_other_config_flag,no_ipv6_nd_other_config_flag_cmd,"noipv6ndother-config-
flag",NO_STR"InterfaceIPv6configcommands\n""Neighbordiscovery\n""Otherstatefullc
onfigurationflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->
info;zif->rtadv.AdvOtherConfigFlag=0;returnCMD_SUCCESS;}DEFUN(ipv6_nd_prefix,ipv
6_nd_prefix_cmd,"ipv6ndprefixX:X::X:X/M[<(0-4294967295)|infinite><(0-4294967295)
|infinite>][<router-address|off-link[no-autoconfig]|no-autoconfig[off-link]>]","
InterfaceIPv6configcommands\n""Neighbordiscovery\n""Prefixinformation\n""IPv6pre
fix\n""Validlifetimeinseconds\n""Infinitevalidlifetime\n""Preferredlifetimeinsec
onds\n""Infinitepreferredlifetime\n""SetRouterAddressflag\n""Donotuseprefixforon
linkdetermination\n""Donotuseprefixforautoconfiguration\n""Donotuseprefixforauto
configuration\n""Donotuseprefixforonlinkdetermination\n"){/*prelude*/char*prefix
=argv[3]->arg;intlifetimes=(argc>4)&&(argv[4]->type==RANGE_TKN||strmatch(argv[4]
->text,"infinite"));introuteropts=lifetimes?argc>6:argc>4;intidx_routeropts=rout
eropts?(lifetimes?6:4):0;char*lifetime=NULL,*preflifetime=NULL;introuteraddr=0,o
fflink=0,noautoconf=0;if(lifetimes){lifetime=argv[4]->type==RANGE_TKN?argv[4]->a
rg:argv[4]->text;preflifetime=argv[5]->type==RANGE_TKN?argv[5]->arg:argv[5]->tex
t;}if(routeropts){routeraddr=strmatch(argv[idx_routeropts]->text,"router-address
");if(!routeraddr){offlink=(argc>idx_routeropts+1||strmatch(argv[idx_routeropts]
->text,"off-link"));noautoconf=(argc>idx_routeropts+1||strmatch(argv[idx_routero
pts]->text,"no-autoconfig"));}}/*business*/VTY_DECLVAR_CONTEXT(interface,ifp);st
ructzebra_if*zebra_if=ifp->info;intret;structrtadv_prefixrp;ret=str2prefix_ipv6(
prefix,&rp.prefix);if(!ret){vty_out(vty,"MalformedIPv6prefix\n");returnCMD_WARNI
NG_CONFIG_FAILED;}apply_mask_ipv6(&rp.prefix);/*RFC48614.6.2*/rp.AdvOnLinkFlag=!
offlink;rp.AdvAutonomousFlag=!noautoconf;rp.AdvRouterAddressFlag=routeraddr;rp.A
dvValidLifetime=RTADV_VALID_LIFETIME;rp.AdvPreferredLifetime=RTADV_PREFERRED_LIF
ETIME;if(lifetimes){rp.AdvValidLifetime=strmatch(lifetime,"infinite")?UINT32_MAX
:strtoll(lifetime,NULL,10);rp.AdvPreferredLifetime=strmatch(preflifetime,"infini
te")?UINT32_MAX:strtoll(preflifetime,NULL,10);if(rp.AdvPreferredLifetime>rp.AdvV
alidLifetime){vty_out(vty,"Invalidpreferredlifetime\n");returnCMD_WARNING_CONFIG
_FAILED;}}rtadv_prefix_set(zebra_if,&rp);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_pre
fix,no_ipv6_nd_prefix_cmd,"noipv6ndprefixX:X::X:X/M[<(0-4294967295)|infinite><(0
-4294967295)|infinite>][<router-address|off-link[no-autoconfig]|no-autoconfig[of
f-link]>]",NO_STR"InterfaceIPv6configcommands\n""Neighbordiscovery\n""Prefixinfo
rmation\n""IPv6prefix\n""Validlifetimeinseconds\n""Infinitevalidlifetime\n""Pref
erredlifetimeinseconds\n""Infinitepreferredlifetime\n""SetRouterAddressflag\n""D
onotuseprefixforonlinkdetermination\n""Donotuseprefixforautoconfiguration\n""Don
otuseprefixforautoconfiguration\n""Donotuseprefixforonlinkdetermination\n"){VTY_
DECLVAR_CONTEXT(interface,ifp);structzebra_if*zebra_if=ifp->info;intret;structrt
adv_prefixrp;char*prefix=argv[4]->arg;ret=str2prefix_ipv6(prefix,&rp.prefix);if(
!ret){vty_out(vty,"MalformedIPv6prefix\n");returnCMD_WARNING_CONFIG_FAILED;}appl
y_mask_ipv6(&rp.prefix);/*RFC48614.6.2*/ret=rtadv_prefix_reset(zebra_if,&rp);if(
!ret){vty_out(vty,"Non-existantIPv6prefix\n");returnCMD_WARNING_CONFIG_FAILED;}r
eturnCMD_SUCCESS;}DEFUN(ipv6_nd_router_preference,ipv6_nd_router_preference_cmd,
"ipv6ndrouter-preference<high|medium|low>","InterfaceIPv6configcommands\n""Neigh
bordiscovery\n""Defaultrouterpreference\n""Highdefaultrouterpreference\n""Medium
defaultrouterpreference(default)\n""Lowdefaultrouterpreference\n"){intidx_high_m
edium_low=3;VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;inti
=0;while(0!=rtadv_pref_strs[i]){if(strncmp(argv[idx_high_medium_low]->arg,rtadv_
pref_strs[i],1)==0){zif->rtadv.DefaultPreference=i;returnCMD_SUCCESS;}i++;}retur
nCMD_ERR_NO_MATCH;}DEFUN(no_ipv6_nd_router_preference,no_ipv6_nd_router_preferen
ce_cmd,"noipv6ndrouter-preference[<high|medium|low>]",NO_STR"InterfaceIPv6config
commands\n""Neighbordiscovery\n""Defaultrouterpreference\n""Highdefaultrouterpre
ference\n""Mediumdefaultrouterpreference(default)\n""Lowdefaultrouterpreference\
n"){VTY_DECLVAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.D
efaultPreference=RTADV_PREF_MEDIUM;/*DefaultperRFC4191.*/returnCMD_SUCCESS;}DEFU
N(ipv6_nd_mtu,ipv6_nd_mtu_cmd,"ipv6ndmtu(1-65535)","InterfaceIPv6configcommands\
n""Neighbordiscovery\n""AdvertisedMTU\n""MTUinbytes\n"){intidx_number=3;VTY_DECL
VAR_CONTEXT(interface,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvLinkMTU=st
rtoul(argv[idx_number]->arg,NULL,10);returnCMD_SUCCESS;}DEFUN(no_ipv6_nd_mtu,no_
ipv6_nd_mtu_cmd,"noipv6ndmtu[(1-65535)]",NO_STR"InterfaceIPv6configcommands\n""N
eighbordiscovery\n""AdvertisedMTU\n""MTUinbytes\n"){VTY_DECLVAR_CONTEXT(interfac
e,ifp);structzebra_if*zif=ifp->info;zif->rtadv.AdvLinkMTU=0;returnCMD_SUCCESS;}/
*DumpinterfaceNDinformationtovty.*/staticintnd_dump_vty(structvty*vty,structinte
rface*ifp){structzebra_if*zif;structrtadvconf*rtadv;intinterval;zif=(structzebra
_if*)ifp->info;rtadv=&zif->rtadv;if(rtadv->AdvSendAdvertisements){vty_out(vty,"N
Dadvertisedreachabletimeis%dmilliseconds\n",rtadv->AdvReachableTime);vty_out(vty
,"NDadvertisedretransmitintervalis%dmilliseconds\n",rtadv->AdvRetransTimer);vty_
out(vty,"NDrouteradvertisementssent:%drcvd:%d\n",zif->ra_sent,zif->ra_rcvd);inte
rval=rtadv->MaxRtrAdvInterval;if(interval%1000)vty_out(vty,"NDrouteradvertisemen
tsaresentevery""%dmilliseconds\n",interval);elsevty_out(vty,"NDrouteradvertiseme
ntsaresentevery""%dseconds\n",interval/1000);if(rtadv->AdvDefaultLifetime!=-1)vt
y_out(vty,"NDrouteradvertisementslivefor%dseconds\n",rtadv->AdvDefaultLifetime);
elsevty_out(vty,"NDrouteradvertisementslifetimetracksra-interval\n");vty_out(vty
,"NDrouteradvertisementdefaultrouterpreferenceis""%s\n",rtadv_pref_strs[rtadv->D
efaultPreference]);if(rtadv->AdvManagedFlag)vty_out(vty,"HostsuseDHCPtoobtainrou
tableaddresses.\n");elsevty_out(vty,"Hostsusestatelessautoconfigforaddresses.\n"
);if(rtadv->AdvHomeAgentFlag){vty_out(vty,"NDrouteradvertisementswithHomeAgentfl
agbitset.\n");if(rtadv->HomeAgentLifetime!=-1)vty_out(vty,"HomeAgentlifetimeis%u
seconds\n",rtadv->HomeAgentLifetime);elsevty_out(vty,"HomeAgentlifetimetracksra-
lifetime\n");vty_out(vty,"HomeAgentpreferenceis%u\n",rtadv->HomeAgentPreference)
;}if(rtadv->AdvIntervalOption)vty_out(vty,"NDrouteradvertisementswithAdv.Interva
loption.\n");}return0;}/*Writeconfigurationaboutrouteradvertisement.*/staticintr
tadv_config_write(structvty*vty,structinterface*ifp){structzebra_if*zif;structli
stnode*node;structrtadv_prefix*rprefix;charbuf[PREFIX_STRLEN];intinterval;zif=if
p->info;if(!(if_is_loopback(ifp)||CHECK_FLAG(ifp->status,ZEBRA_INTERFACE_VRF_LOO
PBACK))){if(zif->rtadv.AdvSendAdvertisements&&CHECK_FLAG(zif->rtadv.ra_configure
d,VTY_RA_CONFIGURED))vty_out(vty,"noipv6ndsuppress-ra\n");}interval=zif->rtadv.M
axRtrAdvInterval;if(CHECK_FLAG(zif->rtadv.ra_configured,VTY_RA_INTERVAL_CONFIGUR
ED)){if(interval%1000)vty_out(vty,"ipv6ndra-intervalmsec%d\n",interval);elseif(i
nterval!=RTADV_MAX_RTR_ADV_INTERVAL)vty_out(vty,"ipv6ndra-interval%d\n",interval
/1000);}if(zif->rtadv.AdvIntervalOption)vty_out(vty,"ipv6ndadv-interval-option\n
");if(zif->rtadv.AdvDefaultLifetime!=-1)vty_out(vty,"ipv6ndra-lifetime%d\n",zif-
>rtadv.AdvDefaultLifetime);if(zif->rtadv.HomeAgentPreference)vty_out(vty,"ipv6nd
home-agent-preference%u\n",zif->rtadv.HomeAgentPreference);if(zif->rtadv.HomeAge
ntLifetime!=-1)vty_out(vty,"ipv6ndhome-agent-lifetime%u\n",zif->rtadv.HomeAgentL
ifetime);if(zif->rtadv.AdvHomeAgentFlag)vty_out(vty,"ipv6ndhome-agent-config-fla
g\n");if(zif->rtadv.AdvReachableTime)vty_out(vty,"ipv6ndreachable-time%d\n",zif-
>rtadv.AdvReachableTime);if(zif->rtadv.AdvManagedFlag)vty_out(vty,"ipv6ndmanaged
-config-flag\n");if(zif->rtadv.AdvOtherConfigFlag)vty_out(vty,"ipv6ndother-confi
g-flag\n");if(zif->rtadv.DefaultPreference!=RTADV_PREF_MEDIUM)vty_out(vty,"ipv6n
drouter-preference%s\n",rtadv_pref_strs[zif->rtadv.DefaultPreference]);if(zif->r
tadv.AdvLinkMTU)vty_out(vty,"ipv6ndmtu%d\n",zif->rtadv.AdvLinkMTU);for(ALL_LIST_
ELEMENTS_RO(zif->rtadv.AdvPrefixList,node,rprefix)){vty_out(vty,"ipv6ndprefix%s"
,prefix2str(&rprefix->prefix,buf,sizeof(buf)));if((rprefix->AdvValidLifetime!=RT
ADV_VALID_LIFETIME)||(rprefix->AdvPreferredLifetime!=RTADV_PREFERRED_LIFETIME)){
if(rprefix->AdvValidLifetime==UINT32_MAX)vty_out(vty,"infinite");elsevty_out(vty
,"%u",rprefix->AdvValidLifetime);if(rprefix->AdvPreferredLifetime==UINT32_MAX)vt
y_out(vty,"infinite");elsevty_out(vty,"%u",rprefix->AdvPreferredLifetime);}if(!r
prefix->AdvOnLinkFlag)vty_out(vty,"off-link");if(!rprefix->AdvAutonomousFlag)vty
_out(vty,"no-autoconfig");if(rprefix->AdvRouterAddressFlag)vty_out(vty,"router-a
ddress");vty_out(vty,"\n");}return0;}staticvoidrtadv_event(structzebra_ns*zns,en
umrtadv_eventevent,intval){structrtadv*rtadv=&zns->rtadv;switch(event){caseRTADV
_START:thread_add_read(zebrad.master,rtadv_read,zns,val,&rtadv->ra_read);thread_
add_event(zebrad.master,rtadv_timer,zns,0,&rtadv->ra_timer);break;caseRTADV_STOP
:if(rtadv->ra_timer){thread_cancel(rtadv->ra_timer);rtadv->ra_timer=NULL;}if(rta
dv->ra_read){thread_cancel(rtadv->ra_read);rtadv->ra_read=NULL;}break;caseRTADV_
TIMER:thread_add_timer(zebrad.master,rtadv_timer,zns,val,&rtadv->ra_timer);break
;caseRTADV_TIMER_MSEC:thread_add_timer_msec(zebrad.master,rtadv_timer,zns,val,&r
tadv->ra_timer);break;caseRTADV_READ:thread_add_read(zebrad.master,rtadv_read,zn
s,val,&rtadv->ra_read);break;default:break;}return;}voidrtadv_init(structzebra_n
s*zns){zns->rtadv.sock=rtadv_make_socket(zns->ns_id);}voidrtadv_terminate(struct
zebra_ns*zns){rtadv_event(zns,RTADV_STOP,0);if(zns->rtadv.sock>=0){close(zns->rt
adv.sock);zns->rtadv.sock=-1;}zns->rtadv.adv_if_count=0;zns->rtadv.adv_msec_if_c
ount=0;}voidrtadv_cmd_init(void){hook_register(zebra_if_extra_info,nd_dump_vty);
hook_register(zebra_if_config_wr,rtadv_config_write);install_element(INTERFACE_N
ODE,&ipv6_nd_suppress_ra_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_suppres
s_ra_cmd);install_element(INTERFACE_NODE,&ipv6_nd_ra_interval_cmd);install_eleme
nt(INTERFACE_NODE,&ipv6_nd_ra_interval_msec_cmd);install_element(INTERFACE_NODE,
&no_ipv6_nd_ra_interval_cmd);install_element(INTERFACE_NODE,&ipv6_nd_ra_lifetime
_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_ra_lifetime_cmd);install_elemen
t(INTERFACE_NODE,&ipv6_nd_reachable_time_cmd);install_element(INTERFACE_NODE,&no
_ipv6_nd_reachable_time_cmd);install_element(INTERFACE_NODE,&ipv6_nd_managed_con
fig_flag_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_managed_config_flag_cmd
);install_element(INTERFACE_NODE,&ipv6_nd_other_config_flag_cmd);install_element
(INTERFACE_NODE,&no_ipv6_nd_other_config_flag_cmd);install_element(INTERFACE_NOD
E,&ipv6_nd_homeagent_config_flag_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd
_homeagent_config_flag_cmd);install_element(INTERFACE_NODE,&ipv6_nd_homeagent_pr
eference_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_homeagent_preference_cm
d);install_element(INTERFACE_NODE,&ipv6_nd_homeagent_lifetime_cmd);install_eleme
nt(INTERFACE_NODE,&no_ipv6_nd_homeagent_lifetime_cmd);install_element(INTERFACE_
NODE,&ipv6_nd_adv_interval_config_option_cmd);install_element(INTERFACE_NODE,&no
_ipv6_nd_adv_interval_config_option_cmd);install_element(INTERFACE_NODE,&ipv6_nd
_prefix_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_prefix_cmd);install_elem
ent(INTERFACE_NODE,&ipv6_nd_router_preference_cmd);install_element(INTERFACE_NOD
E,&no_ipv6_nd_router_preference_cmd);install_element(INTERFACE_NODE,&ipv6_nd_mtu
_cmd);install_element(INTERFACE_NODE,&no_ipv6_nd_mtu_cmd);}staticintif_join_all_
router(intsock,structinterface*ifp){intret;structipv6_mreqmreq;memset(&mreq,0,si
zeof(structipv6_mreq));inet_pton(AF_INET6,ALLROUTER,&mreq.ipv6mr_multiaddr);mreq
.ipv6mr_interface=ifp->ifindex;ret=setsockopt(sock,IPPROTO_IPV6,IPV6_JOIN_GROUP,
(char*)&mreq,sizeofmreq);if(ret<0)zlog_warn("%s(%u):Failedtojoingroup,socket%uer
ror%s",ifp->name,ifp->ifindex,sock,safe_strerror(errno));if(IS_ZEBRA_DEBUG_EVENT
)zlog_debug("%s(%u):JoinAll-Routersmulticastgroup,socket%u",ifp->name,ifp->ifind
ex,sock);return0;}staticintif_leave_all_router(intsock,structinterface*ifp){intr
et;structipv6_mreqmreq;memset(&mreq,0,sizeof(structipv6_mreq));inet_pton(AF_INET
6,ALLROUTER,&mreq.ipv6mr_multiaddr);mreq.ipv6mr_interface=ifp->ifindex;ret=setso
ckopt(sock,IPPROTO_IPV6,IPV6_LEAVE_GROUP,(char*)&mreq,sizeofmreq);if(ret<0)zlog_
warn("%s(%u):Failedtoleavegroup,socket%uerror%s",ifp->name,ifp->ifindex,sock,saf
e_strerror(errno));if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("%s(%u):LeaveAll-Routersmu
lticastgroup,socket%u",ifp->name,ifp->ifindex,sock);return0;}#elsevoidrtadv_init
(structzebra_ns*zns){/*Empty.*/;}voidrtadv_terminate(structzebra_ns*zns){/*Empty
.*/;}voidrtadv_cmd_init(void){/*Empty.*/;}#endif/*HAVE_RTADV*/