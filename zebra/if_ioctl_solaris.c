/**Interfacelookingupbyioctl()onSolaris.*Copyright(C)1997,98KunihiroIshiguro**Th
isfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify
it*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundat
ion;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthe
hopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*ME
RCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformor
edetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisp
rogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Franklin
St,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefSUNOS_5#include"if.
h"#include"sockunion.h"#include"prefix.h"#include"ioctl.h"#include"connected.h"#
include"memory.h"#include"zebra_memory.h"#include"log.h"#include"privs.h"#includ
e"vrf.h"#include"vty.h"#include"zebra/interface.h"#include"zebra/ioctl_solaris.h
"#include"zebra/rib.h"staticintif_get_addr(structinterface*,structsockaddr*,cons
tchar*);staticvoidinterface_info_ioctl(structinterface*);externstructzebra_privs
_tzserv_privs;staticintinterface_list_ioctl(intaf){intret;intsock;#defineIFNUM_B
ASE32structlifnumlifn;intifnum;structlifreq*lifreq;structlifconflifconf;structin
terface*ifp;intn;intsave_errno;size_tneeded,lastneeded=0;char*buf=NULL;if(zserv_
privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");sock=socket(af,SOCK_
DGRAM,0);if(sock<0){zlog_warn("Can'tmake%ssocketstream:%s",(af==AF_INET?"AF_INET
":"AF_INET6"),safe_strerror(errno));if(zserv_privs.change(ZPRIVS_LOWER))zlog_err
("Can'tlowerprivileges");return-1;}calculate_lifc_len:/*mustholdprivilegestoente
rhere*/lifn.lifn_family=af;lifn.lifn_flags=LIFC_NOXMIT;/*wewantNOXMITinterfacest
oo*/ret=ioctl(sock,SIOCGLIFNUM,&lifn);save_errno=errno;if(zserv_privs.change(ZPR
IVS_LOWER))zlog_err("Can'tlowerprivileges");if(ret<0){zlog_warn("interface_list_
ioctl:SIOCGLIFNUMfailed%s",safe_strerror(save_errno));close(sock);return-1;}ifnu
m=lifn.lifn_count;/**Whencalculatingthebuffersizeneeded,addasmallnumber*ofinterf
acestothosewecounted.Wedothistocapture*theinterfacestatusofpotentialinterfaceswh
ichmayhave*beenplumbedbetweentheSIOCGLIFNUMandtheSIOCGLIFCONF.*/needed=(ifnum+4)
*sizeof(structlifreq);if(needed>lastneeded||needed<lastneeded/2){if(buf!=NULL)XF
REE(MTYPE_TMP,buf);if((buf=XMALLOC(MTYPE_TMP,needed))==NULL){zlog_warn("interfac
e_list_ioctl:mallocfailed");close(sock);return-1;}}lastneeded=needed;lifconf.lif
c_family=af;lifconf.lifc_flags=LIFC_NOXMIT;lifconf.lifc_len=needed;lifconf.lifc_
buf=buf;if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");ret
=ioctl(sock,SIOCGLIFCONF,&lifconf);if(ret<0){if(errno==EINVAL)gotocalculate_lifc
_len;/*deliberatelyholdprivileges*/zlog_warn("SIOCGLIFCONF:%s",safe_strerror(err
no));if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");gotoen
d;}if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");/*Alloca
teinterface.*/lifreq=lifconf.lifc_req;for(n=0;n<lifconf.lifc_len;n+=sizeof(struc
tlifreq)){/*wetreatSolarislogicalinterfacesasaddresses,because*thatis*howPF_ROUT
EonSolaristreatsthem.Hencewecannot*directlyuse*thelifreq_nametogettheifp.Weneedt
onormalisethe*name*beforeattemptingget.**Solarislogicalinterfacenamesareinthefor
mof:*<interfacename>:<logicalinterfaceid>*/unsignedintnormallen=0;uint64_tliffla
gs;/*Weshouldexclude~IFF_UPinterfaces,aswe'llfindoutabout*them*cominguplaterthro
ughRTM_NEWADDRmessageontheroute*socket.*/if(if_get_flags_direct(lifreq->lifr_nam
e,&lifflags,lifreq->lifr_addr.ss_family)||!CHECK_FLAG(lifflags,IFF_UP)){lifreq++
;continue;}/*Findthenormalisedname*/while((normallen<sizeof(lifreq->lifr_name))&
&(*(lifreq->lifr_name+normallen)!='\0')&&(*(lifreq->lifr_name+normallen)!=':'))n
ormallen++;ifp=if_get_by_name(lifreq->lifr_name,VRF_DEFAULT,0);if(lifreq->lifr_a
ddr.ss_family==AF_INET)ifp->flags|=IFF_IPV4;if(lifreq->lifr_addr.ss_family==AF_I
NET6){ifp->flags|=IFF_IPV6;}if_add_update(ifp);interface_info_ioctl(ifp);/*Ifalo
gicalinterfacepassthefullnamesoitcanbe*asalabelontheaddress*/if(*(lifreq->lifr_n
ame+normallen)!='\0')if_get_addr(ifp,(structsockaddr*)&lifreq->lifr_addr,lifreq-
>lifr_name);elseif_get_addr(ifp,(structsockaddr*)&lifreq->lifr_addr,NULL);/*Poke
theinterfaceflags.LetsIFF_UPmanglingkickin*/if_flags_update(ifp,ifp->flags);lifr
eq++;}end:close(sock);XFREE(MTYPE_TMP,lifconf.lifc_buf);returnret;}/*Getinterfac
e'sindexbyioctl.*/staticintif_get_index(structinterface*ifp){intret;structlifreq
lifreq;lifreq_set_name(&lifreq,ifp->name);if(ifp->flags&IFF_IPV4)ret=AF_IOCTL(AF
_INET,SIOCGLIFINDEX,(caddr_t)&lifreq);elseif(ifp->flags&IFF_IPV6)ret=AF_IOCTL(AF
_INET6,SIOCGLIFINDEX,(caddr_t)&lifreq);elseret=-1;if(ret<0){zlog_warn("SIOCGLIFI
NDEX(%s)failed",ifp->name);returnret;}/*OKwegotinterfaceindex.*/#ifdefifr_ifinde
xif_set_index(ifp,lifreq.lifr_ifindex);#elseif_set_index(ifp,lifreq.lifr_index);
#endifreturnifp->ifindex;}/*Interfaceaddresslookupbyioctl.Thisfunctiononlylooksu
pIPv4address.*/#defineADDRLEN(sa)\(((sa)->sa_family==AF_INET?sizeof(structsockad
dr_in)\:sizeof(structsockaddr_in6)))#defineSIN(s)((structsockaddr_in*)(s))#defin
eSIN6(s)((structsockaddr_in6*)(s))/*Retrieveaddressinformationforthegivenifp*/st
aticintif_get_addr(structinterface*ifp,structsockaddr*addr,constchar*label){intr
et;structlifreqlifreq;structsockaddr_storagemask,dest;char*dest_pnt=NULL;uint8_t
prefixlen=0;afi_taf;intflags=0;/*Interface'snameandaddressfamily.*Weneedtousethe
logicalinterfacename/label,ifwe'vebeen*givenone,inordertogettherightaddress*/str
ncpy(lifreq.lifr_name,(label?label:ifp->name),IFNAMSIZ);/*Interface'saddress.*/m
emcpy(&lifreq.lifr_addr,addr,ADDRLEN(addr));af=addr->sa_family;/*Pointtopointorb
roadcastaddresspointerinit.*/dest_pnt=NULL;if(AF_IOCTL(af,SIOCGLIFDSTADDR,(caddr
_t)&lifreq)>=0){memcpy(&dest,&lifreq.lifr_dstaddr,ADDRLEN(addr));if(af==AF_INET)
dest_pnt=(char*)&(SIN(&dest)->sin_addr);elsedest_pnt=(char*)&(SIN6(&dest)->sin6_
addr);flags=ZEBRA_IFA_PEER;}if(af==AF_INET){ret=if_ioctl(SIOCGLIFNETMASK,(caddr_
t)&lifreq);if(ret<0){if(errno!=EADDRNOTAVAIL){zlog_warn("SIOCGLIFNETMASK(%s)fail
:%s",ifp->name,safe_strerror(errno));returnret;}return0;}memcpy(&mask,&lifreq.li
fr_addr,ADDRLEN(addr));prefixlen=ip_masklen(SIN(&mask)->sin_addr);if(!dest_pnt&&
(if_ioctl(SIOCGLIFBRDADDR,(caddr_t)&lifreq)>=0)){memcpy(&dest,&lifreq.lifr_broad
addr,sizeof(structsockaddr_in));dest_pnt=(char*)&SIN(&dest)->sin_addr;}}elseif(a
f==AF_INET6){if(if_ioctl_ipv6(SIOCGLIFSUBNET,(caddr_t)&lifreq)<0){if(ifp->flags&
IFF_POINTOPOINT)prefixlen=IPV6_MAX_BITLEN;elsezlog_warn("SIOCGLIFSUBNET(%s)fail:
%s",ifp->name,safe_strerror(errno));}else{prefixlen=lifreq.lifr_addrlen;}}/*Seta
ddresstotheinterface.*/if(af==AF_INET)connected_add_ipv4(ifp,flags,&SIN(addr)->s
in_addr,prefixlen,(structin_addr*)dest_pnt,label);elseif(af==AF_INET6)connected_
add_ipv6(ifp,flags,&SIN6(addr)->sin6_addr,prefixlen,label);return0;}/*Fetchinter
faceinformationviaioctl().*/staticvoidinterface_info_ioctl(structinterface*ifp){
if_get_index(ifp);if_get_flags(ifp);if_get_mtu(ifp);if_get_metric(ifp);}/*Lookup
allinterfaceinformation.*/voidinterface_list(structzebra_ns*zns){if(zns->ns_id!=
NS_DEFAULT){zlog_warn("interface_list:ignoreNS%u",zns->ns_id);return;}interface_
list_ioctl(AF_INET);interface_list_ioctl(AF_INET6);interface_list_ioctl(AF_UNSPE
C);}structconnected*if_lookup_linklocal(structinterface*ifp){structlistnode*node
;structconnected*ifc;if(ifp==NULL)returnNULL;for(ALL_LIST_ELEMENTS_RO(ifp->conne
cted,node,ifc)){if((ifc->address->family==AF_INET6)&&(IN6_IS_ADDR_LINKLOCAL(&ifc
->address->u.prefix6)))returnifc;}returnNULL;}#endif/*SUNOS_5*/