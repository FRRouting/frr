/**ZebraLayer-2interfacehandlingcode*Copyright(C)2016,2017CumulusNetworks,Inc.**
ThisfileispartofFRR.**FRRisfreesoftware;youcanredistributeitand/ormodifyit*under
thetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eith
erversion2,or(atyouroption)any*laterversion.**FRRisdistributedinthehopethatitwil
lbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITY
orFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yo
ushouldhavereceivedacopyoftheGNUGeneralPublicLicense*alongwithFRR;seethefileCOPY
ING.Ifnot,writetotheFree*SoftwareFoundation,Inc.,59TemplePlace-Suite330,Boston,M
A*02111-1307,USA.*/#include<zebra.h>#include"if.h"#include"prefix.h"#include"tab
le.h"#include"memory.h"#include"log.h"#include"linklist.h"#include"stream.h"#inc
lude"hash.h"#include"jhash.h"#include"zebra/rib.h"#include"zebra/rt.h"#include"z
ebra/zebra_ns.h"#include"zebra/zserv.h"#include"zebra/debug.h"#include"zebra/int
erface.h"#include"zebra/zebra_memory.h"#include"zebra/zebra_vrf.h"#include"zebra
/rt_netlink.h"#include"zebra/zebra_l2.h"#include"zebra/zebra_vxlan.h"/*definitio
ns*//*staticfunctiondeclarations*//*Privatefunctions*/staticvoidmap_slaves_to_br
idge(structinterface*br_if,intlink){structvrf*vrf;structinterface*ifp;RB_FOREACH
(vrf,vrf_name_head,&vrfs_by_name){FOR_ALL_INTERFACES(vrf,ifp){structzebra_if*zif
;structzebra_l2info_brslave*br_slave;if(ifp->ifindex==IFINDEX_INTERNAL||!ifp->in
fo)continue;if(!IS_ZEBRA_IF_BRIDGE_SLAVE(ifp))continue;/*NOTE:Thisassumes'zebra_
l2info_brslave'isthe*firstfield*foranyL2interface.*/zif=(structzebra_if*)ifp->in
fo;br_slave=&zif->brslave_info;if(link){if(br_slave->bridge_ifindex==br_if->ifin
dex)br_slave->br_if=br_if;}else{if(br_slave->br_if==br_if)br_slave->br_if=NULL;}
}}}/*Publicfunctions*/voidzebra_l2_map_slave_to_bridge(structzebra_l2info_brslav
e*br_slave){structinterface*br_if;/*TODO:Handlechangeofmaster*/br_if=if_lookup_b
y_index_per_ns(zebra_ns_lookup(NS_DEFAULT),br_slave->bridge_ifindex);if(br_if)br
_slave->br_if=br_if;}voidzebra_l2_unmap_slave_from_bridge(structzebra_l2info_brs
lave*br_slave){br_slave->br_if=NULL;}/**HandleBridgeinterfaceaddorupdate.Updater
elevantinfo,*mapslaves(ifany)tothebridge.*/voidzebra_l2_bridge_add_update(struct
interface*ifp,structzebra_l2info_bridge*bridge_info,intadd){structzebra_if*zif;z
if=ifp->info;assert(zif);/*CopyovertheL2information.*/memcpy(&zif->l2info.br,bri
dge_info,sizeof(*bridge_info));/*Linkallslavestothisbridge*/map_slaves_to_bridge
(ifp,1);}/**HandleBridgeinterfacedelete.*/voidzebra_l2_bridge_del(structinterfac
e*ifp){/*Unlinkallslavestothisbridge*/map_slaves_to_bridge(ifp,0);}/**UpdateL2in
foforaVLANinterface.Onlyrelevantparameteristhe*VLANIdandthiscannotchange.*/voidz
ebra_l2_vlanif_update(structinterface*ifp,structzebra_l2info_vlan*vlan_info){str
uctzebra_if*zif;zif=ifp->info;assert(zif);/*CopyovertheL2information.*/memcpy(&z
if->l2info.vl,vlan_info,sizeof(*vlan_info));}/**UpdateL2infoforaVxLANinterface.T
hisiscalleduponinterface*additionaswellasupdate.Uponadd,needtoinvoketheVNIcreate
*function.Uponupdate,theparamsofinterestarethelocaltunnel*IPandVLANmapping,butth
elatterishandledseparately.*/voidzebra_l2_vxlanif_add_update(structinterface*ifp
,structzebra_l2info_vxlan*vxlan_info,intadd){structzebra_if*zif;structin_addrold
_vtep_ip;zif=ifp->info;assert(zif);if(add){memcpy(&zif->l2info.vxl,vxlan_info,si
zeof(*vxlan_info));zebra_vxlan_if_add(ifp);return;}old_vtep_ip=zif->l2info.vxl.v
tep_ip;if(IPV4_ADDR_SAME(&old_vtep_ip,&vxlan_info->vtep_ip))return;zif->l2info.v
xl.vtep_ip=vxlan_info->vtep_ip;zebra_vxlan_if_update(ifp,ZEBRA_VXLIF_LOCAL_IP_CH
ANGE);}/**HandlechangetoVLANtoVNImapping.*/voidzebra_l2_vxlanif_update_access_vl
an(structinterface*ifp,vlanid_taccess_vlan){structzebra_if*zif;vlanid_told_acces
s_vlan;zif=ifp->info;assert(zif);old_access_vlan=zif->l2info.vxl.access_vlan;if(
old_access_vlan==access_vlan)return;zif->l2info.vxl.access_vlan=access_vlan;zebr
a_vxlan_if_update(ifp,ZEBRA_VXLIF_VLAN_CHANGE);}/**HandleVxLANinterfacedelete.*/
voidzebra_l2_vxlanif_del(structinterface*ifp){zebra_vxlan_if_del(ifp);}/**Maporu
nmapinterfacefrombridge.*NOTE:Itiscurrentlyassumpedthataninterfacehastobeunmappe
d*fromabridgebeforeitcanbemappedtoanotherbridge.*/voidzebra_l2if_update_bridge_s
lave(structinterface*ifp,ifindex_tbridge_ifindex){structzebra_if*zif;ifindex_tol
d_bridge_ifindex;zif=ifp->info;assert(zif);old_bridge_ifindex=zif->brslave_info.
bridge_ifindex;if(old_bridge_ifindex==bridge_ifindex)return;zif->brslave_info.br
idge_ifindex=bridge_ifindex;/*Setuporremovelinkwithmaster*/if(bridge_ifindex!=IF
INDEX_INTERNAL){zebra_l2_map_slave_to_bridge(&zif->brslave_info);/*InthecaseofVx
LAN,invokethehandlerforEVPN.*/if(zif->zif_type==ZEBRA_IF_VXLAN)zebra_vxlan_if_up
date(ifp,ZEBRA_VXLIF_MASTER_CHANGE);}elseif(old_bridge_ifindex!=IFINDEX_INTERNAL
){/**InthecaseofVxLAN,invokethehandlerforEVPN.*Notethatthisshouldbedone*prior**t
ounmappingtheinterfacefromthebridge.*/if(zif->zif_type==ZEBRA_IF_VXLAN)zebra_vxl
an_if_update(ifp,ZEBRA_VXLIF_MASTER_CHANGE);zebra_l2_unmap_slave_from_bridge(&zi
f->brslave_info);}}