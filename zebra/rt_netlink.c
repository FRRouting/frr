/*KernelroutingtableupdatesusingnetlinkoverGNU/Linuxsystem.*Copyright(C)1997,98,
99KunihiroIshiguro**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredi
stributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbyt
he*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZ
ebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withoutevent
heimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*Gene
ralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublic
Licensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foun
dation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#if
defHAVE_NETLINK#include<net/if_arp.h>#include<linux/lwtunnel.h>#include<linux/mp
ls_iptunnel.h>#include<linux/neighbour.h>#include<linux/rtnetlink.h>/*HackforGNU
libcversion2.*/#ifndefMSG_TRUNC#defineMSG_TRUNC0x20#endif/*MSG_TRUNC*/#include"l
inklist.h"#include"if.h"#include"log.h"#include"prefix.h"#include"connected.h"#i
nclude"table.h"#include"memory.h"#include"zebra_memory.h"#include"rib.h"#include
"thread.h"#include"privs.h"#include"nexthop.h"#include"vrf.h"#include"vty.h"#inc
lude"mpls.h"#include"vxlan.h"#include"zebra/zserv.h"#include"zebra/zebra_ns.h"#i
nclude"zebra/zebra_vrf.h"#include"zebra/rt.h"#include"zebra/redistribute.h"#incl
ude"zebra/interface.h"#include"zebra/debug.h"#include"zebra/rtadv.h"#include"zeb
ra/zebra_ptm.h"#include"zebra/zebra_mpls.h"#include"zebra/kernel_netlink.h"#incl
ude"zebra/rt_netlink.h"#include"zebra/zebra_mroute.h"#include"zebra/zebra_vxlan.
h"#ifndefAF_MPLS#defineAF_MPLS28#endifstaticvlanid_tfilter_vlan=0;structgw_famil
y_t{uint16_tfiller;uint16_tfamily;uniong_addrgate;};charipv4_ll_buf[16]="169.254
.0.1";structin_addripv4_ll;/**Theipv4_lldatastructureisusedforall5549*additionst
othekernel.Let'sfigureoutthe*correctvalueonetimeinsteadforevery*install/removeof
a5549typeroute*/voidrt_netlink_init(void){inet_pton(AF_INET,ipv4_ll_buf,&ipv4_ll
);}staticinlineintis_selfroute(intproto){if((proto==RTPROT_BGP)||(proto==RTPROT_
OSPF)||(proto==RTPROT_STATIC)||(proto==RTPROT_ZEBRA)||(proto==RTPROT_ISIS)||(pro
to==RTPROT_RIPNG)||(proto==RTPROT_NHRP)||(proto==RTPROT_EIGRP)||(proto==RTPROT_L
DP)||(proto==RTPROT_BABEL)||(proto==RTPROT_RIP)||(proto==RTPROT_SHARP)){return1;
}return0;}staticinlineintzebra2proto(intproto){switch(proto){caseZEBRA_ROUTE_BAB
EL:proto=RTPROT_BABEL;break;caseZEBRA_ROUTE_BGP:proto=RTPROT_BGP;break;caseZEBRA
_ROUTE_OSPF:caseZEBRA_ROUTE_OSPF6:proto=RTPROT_OSPF;break;caseZEBRA_ROUTE_STATIC
:proto=RTPROT_STATIC;break;caseZEBRA_ROUTE_ISIS:proto=RTPROT_ISIS;break;caseZEBR
A_ROUTE_RIP:proto=RTPROT_RIP;break;caseZEBRA_ROUTE_RIPNG:proto=RTPROT_RIPNG;brea
k;caseZEBRA_ROUTE_NHRP:proto=RTPROT_NHRP;break;caseZEBRA_ROUTE_EIGRP:proto=RTPRO
T_EIGRP;break;caseZEBRA_ROUTE_LDP:proto=RTPROT_LDP;break;caseZEBRA_ROUTE_SHARP:p
roto=RTPROT_SHARP;break;default:proto=RTPROT_ZEBRA;break;}returnproto;}staticinl
ineintproto2zebra(intproto,intfamily){switch(proto){caseRTPROT_BABEL:proto=ZEBRA
_ROUTE_BABEL;break;caseRTPROT_BGP:proto=ZEBRA_ROUTE_BGP;break;caseRTPROT_OSPF:pr
oto=(family==AFI_IP)?ZEBRA_ROUTE_OSPF:ZEBRA_ROUTE_OSPF6;break;caseRTPROT_ISIS:pr
oto=ZEBRA_ROUTE_ISIS;break;caseRTPROT_RIP:proto=ZEBRA_ROUTE_RIP;break;caseRTPROT
_RIPNG:proto=ZEBRA_ROUTE_RIPNG;break;caseRTPROT_NHRP:proto=ZEBRA_ROUTE_NHRP;brea
k;caseRTPROT_EIGRP:proto=ZEBRA_ROUTE_EIGRP;break;caseRTPROT_LDP:proto=ZEBRA_ROUT
E_LDP;break;caseRTPROT_STATIC:proto=ZEBRA_ROUTE_STATIC;break;default:proto=ZEBRA
_ROUTE_KERNEL;break;}returnproto;}/*Pending:createanefficienttable_id(inatree/ha
sh)basedlookup)*/staticvrf_id_tvrf_lookup_by_table(uint32_ttable_id,ns_id_tns_id
){structvrf*vrf;structzebra_vrf*zvrf;RB_FOREACH(vrf,vrf_id_head,&vrfs_by_id){zvr
f=vrf->info;if(zvrf==NULL)continue;/*casevrfwithnetns:matchthenetnsid*/if(vrf_is
_backend_netns()){if(ns_id==zvrf_id(zvrf))returnzvrf_id(zvrf);}else{/*VRFisVRF_B
ACKEND_VRF_LITE*/if(zvrf->table_id!=table_id)continue;returnzvrf_id(zvrf);}}retu
rnVRF_DEFAULT;}/*Lookinguproutingtablebynetlinkinterface.*/staticintnetlink_rout
e_change_read_unicast(structsockaddr_nl*snl,structnlmsghdr*h,ns_id_tns_id,intsta
rtup){intlen;structrtmsg*rtm;structrtattr*tb[RTA_MAX+1];uint8_tflags=0;structpre
fixp;structprefix_ipv6src_p={};vrf_id_tvrf_id;charanyaddr[16]={0};intproto=ZEBRA
_ROUTE_KERNEL;intindex=0;inttable;intmetric=0;uint32_tmtu=0;uint8_tdistance=0;ro
ute_tag_ttag=0;void*dest=NULL;void*gate=NULL;void*prefsrc=NULL;/*IPv4preferredso
urcehostaddress*/void*src=NULL;/*IPv6srcdestsourceprefix*/enumblackhole_typebh_t
ype=BLACKHOLE_UNSPEC;rtm=NLMSG_DATA(h);if(startup&&h->nlmsg_type!=RTM_NEWROUTE)r
eturn0;switch(rtm->rtm_type){caseRTN_UNICAST:break;caseRTN_BLACKHOLE:bh_type=BLA
CKHOLE_NULL;break;caseRTN_UNREACHABLE:bh_type=BLACKHOLE_REJECT;break;caseRTN_PRO
HIBIT:bh_type=BLACKHOLE_ADMINPROHIB;break;default:return0;}len=h->nlmsg_len-NLMS
G_LENGTH(sizeof(structrtmsg));if(len<0)return-1;memset(tb,0,sizeoftb);netlink_pa
rse_rtattr(tb,RTA_MAX,RTM_RTA(rtm),len);if(rtm->rtm_flags&RTM_F_CLONED)return0;i
f(rtm->rtm_protocol==RTPROT_REDIRECT)return0;if(rtm->rtm_protocol==RTPROT_KERNEL
)return0;if(!startup&&is_selfroute(rtm->rtm_protocol)&&h->nlmsg_type==RTM_NEWROU
TE)return0;/*Wedon'tcareaboutchangenotificationsfortheMPLStable.*//*TODO:Revisit
this.*/if(rtm->rtm_family==AF_MPLS)return0;/*Tablecorrespondingtoroute.*/if(tb[R
TA_TABLE])table=*(int*)RTA_DATA(tb[RTA_TABLE]);elsetable=rtm->rtm_table;/*MaptoV
RF*/vrf_id=vrf_lookup_by_table(table,ns_id);if(vrf_id==VRF_DEFAULT){if(!is_zebra
_valid_kernel_table(table)&&!is_zebra_main_routing_table(table))return0;}/*Route
whichinsertedbyZebra.*/if(is_selfroute(rtm->rtm_protocol)){flags|=ZEBRA_FLAG_SEL
FROUTE;proto=proto2zebra(rtm->rtm_protocol,rtm->rtm_family);}if(tb[RTA_OIF])inde
x=*(int*)RTA_DATA(tb[RTA_OIF]);if(tb[RTA_DST])dest=RTA_DATA(tb[RTA_DST]);elsedes
t=anyaddr;if(tb[RTA_SRC])src=RTA_DATA(tb[RTA_SRC]);elsesrc=anyaddr;if(tb[RTA_PRE
FSRC])prefsrc=RTA_DATA(tb[RTA_PREFSRC]);if(tb[RTA_GATEWAY])gate=RTA_DATA(tb[RTA_
GATEWAY]);if(tb[RTA_PRIORITY])metric=*(int*)RTA_DATA(tb[RTA_PRIORITY]);#ifdefine
d(SUPPORT_REALMS)if(tb[RTA_FLOW])tag=*(uint32_t*)RTA_DATA(tb[RTA_FLOW]);#endifif
(tb[RTA_METRICS]){structrtattr*mxrta[RTAX_MAX+1];memset(mxrta,0,sizeofmxrta);net
link_parse_rtattr(mxrta,RTAX_MAX,RTA_DATA(tb[RTA_METRICS]),RTA_PAYLOAD(tb[RTA_ME
TRICS]));if(mxrta[RTAX_MTU])mtu=*(uint32_t*)RTA_DATA(mxrta[RTAX_MTU]);}if(rtm->r
tm_family==AF_INET){p.family=AF_INET;memcpy(&p.u.prefix4,dest,4);p.prefixlen=rtm
->rtm_dst_len;src_p.prefixlen=0;//Forcesdebugbelowtonotdisplayanything}elseif(rt
m->rtm_family==AF_INET6){p.family=AF_INET6;memcpy(&p.u.prefix6,dest,16);p.prefix
len=rtm->rtm_dst_len;src_p.family=AF_INET6;memcpy(&src_p.prefix,src,16);src_p.pr
efixlen=rtm->rtm_src_len;}if(rtm->rtm_src_len!=0){charbuf[PREFIX_STRLEN];zlog_wa
rn("unsupportedIPv[4|6]sourcedestroute(dest%svrf%u)",prefix2str(&p,buf,sizeof(bu
f)),vrf_id);return0;}/**ForZEBRA_ROUTE_KERNELtypes:**Themetric/priorityoftherout
ereceivedfromthekernel*isa32bitnumber.Wearegoingtointerpretthehigh*orderbyteasth
eAdminDistanceandtheloworder3bytes*asthemetric.**Thiswillallowustodotwothings:*1
)Allowthecreationofkernelroutesthatcanbe*overriddenbyzebra.*2)Allowtheoldbehavio
rfor'most'kernelroutetypes*ifauserenters'iproute...'v4routesgetametric*of0andv6r
outesgetametricof1024.Bothofthese*valueswillendupwithaadmindistanceof0,which*wil
lcausethemtowinforthepurposesofzebra.*/if(proto==ZEBRA_ROUTE_KERNEL){distance=(m
etric>>24)&0xFF;metric=(metric&0x00FFFFFF);}if(IS_ZEBRA_DEBUG_KERNEL){charbuf[PR
EFIX_STRLEN];charbuf2[PREFIX_STRLEN];zlog_debug("%s%s%s%svrf%umetric:%dAdminDist
ance:%d",nl_msg_type_to_str(h->nlmsg_type),prefix2str(&p,buf,sizeof(buf)),src_p.
prefixlen?"from":"",src_p.prefixlen?prefix2str(&src_p,buf2,sizeof(buf2)):"",vrf_
id,metric,distance);}afi_tafi=AFI_IP;if(rtm->rtm_family==AF_INET6)afi=AFI_IP6;if
(h->nlmsg_type==RTM_NEWROUTE){structinterface*ifp;vrf_id_tnh_vrf_id=vrf_id;if(!t
b[RTA_MULTIPATH]){structnexthopnh;size_tsz=(afi==AFI_IP)?4:16;memset(&nh,0,sizeo
f(nh));if(bh_type==BLACKHOLE_UNSPEC){if(index&&!gate)nh.type=NEXTHOP_TYPE_IFINDE
X;elseif(index&&gate)nh.type=(afi==AFI_IP)?NEXTHOP_TYPE_IPV4_IFINDEX:NEXTHOP_TYP
E_IPV6_IFINDEX;elseif(!index&&gate)nh.type=(afi==AFI_IP)?NEXTHOP_TYPE_IPV4:NEXTH
OP_TYPE_IPV6;else{nh.type=NEXTHOP_TYPE_BLACKHOLE;nh.bh_type=bh_type;}}else{nh.ty
pe=NEXTHOP_TYPE_BLACKHOLE;nh.bh_type=bh_type;}nh.ifindex=index;if(prefsrc)memcpy
(&nh.src,prefsrc,sz);if(gate)memcpy(&nh.gate,gate,sz);if(index){ifp=if_lookup_by
_index(index,VRF_UNKNOWN);if(ifp)nh_vrf_id=ifp->vrf_id;}nh.vrf_id=nh_vrf_id;rib_
add(afi,SAFI_UNICAST,vrf_id,proto,0,flags,&p,NULL,&nh,table,metric,mtu,distance,
tag);}else{/*Thisisamultipathroute*/structroute_entry*re;structrtnexthop*rtnh=(s
tructrtnexthop*)RTA_DATA(tb[RTA_MULTIPATH]);len=RTA_PAYLOAD(tb[RTA_MULTIPATH]);r
e=XCALLOC(MTYPE_RE,sizeof(structroute_entry));re->type=proto;re->distance=distan
ce;re->flags=flags;re->metric=metric;re->mtu=mtu;re->vrf_id=vrf_id;re->table=tab
le;re->nexthop_num=0;re->uptime=time(NULL);re->tag=tag;for(;;){vrf_id_tnh_vrf_id
;if(len<(int)sizeof(*rtnh)||rtnh->rtnh_len>len)break;index=rtnh->rtnh_ifindex;if
(index){/**Yeswearelookingthisup*foreverynexthopandjust*usingthelastonelooked*up
rightnow*/ifp=if_lookup_by_index(index,VRF_UNKNOWN);if(ifp)nh_vrf_id=ifp->vrf_id
;else{zlog_warn("%s:Unknowninterface%uspecified,defaultingtoVRF_DEFAULT",__PRETT
Y_FUNCTION__,index);nh_vrf_id=VRF_DEFAULT;}}elsenh_vrf_id=vrf_id;gate=0;if(rtnh-
>rtnh_len>sizeof(*rtnh)){memset(tb,0,sizeof(tb));netlink_parse_rtattr(tb,RTA_MAX
,RTNH_DATA(rtnh),rtnh->rtnh_len-sizeof(*rtnh));if(tb[RTA_GATEWAY])gate=RTA_DATA(
tb[RTA_GATEWAY]);}if(gate){if(rtm->rtm_family==AF_INET){if(index)route_entry_nex
thop_ipv4_ifindex_add(re,gate,prefsrc,index,nh_vrf_id);elseroute_entry_nexthop_i
pv4_add(re,gate,prefsrc,nh_vrf_id);}elseif(rtm->rtm_family==AF_INET6){if(index)r
oute_entry_nexthop_ipv6_ifindex_add(re,gate,index,nh_vrf_id);elseroute_entry_nex
thop_ipv6_add(re,gate,nh_vrf_id);}}elseroute_entry_nexthop_ifindex_add(re,index,
nh_vrf_id);len-=NLMSG_ALIGN(rtnh->rtnh_len);rtnh=RTNH_NEXT(rtnh);}zserv_nexthop_
num_warn(__func__,(conststructprefix*)&p,re->nexthop_num);if(re->nexthop_num==0)
XFREE(MTYPE_RE,re);elserib_add_multipath(afi,SAFI_UNICAST,&p,NULL,re);}}else{if(
!tb[RTA_MULTIPATH]){structnexthopnh;size_tsz=(afi==AFI_IP)?4:16;memset(&nh,0,siz
eof(nh));if(bh_type==BLACKHOLE_UNSPEC){if(index&&!gate)nh.type=NEXTHOP_TYPE_IFIN
DEX;elseif(index&&gate)nh.type=(afi==AFI_IP)?NEXTHOP_TYPE_IPV4_IFINDEX:NEXTHOP_T
YPE_IPV6_IFINDEX;elseif(!index&&gate)nh.type=(afi==AFI_IP)?NEXTHOP_TYPE_IPV4:NEX
THOP_TYPE_IPV6;else{nh.type=NEXTHOP_TYPE_BLACKHOLE;nh.bh_type=BLACKHOLE_UNSPEC;}
}else{nh.type=NEXTHOP_TYPE_BLACKHOLE;nh.bh_type=bh_type;}nh.ifindex=index;if(gat
e)memcpy(&nh.gate,gate,sz);rib_delete(afi,SAFI_UNICAST,vrf_id,proto,0,flags,&p,N
ULL,&nh,table,metric,true,NULL);}else{/*XXX:needtocomparetheentirelistofnexthops
*hereforNLM_F_APPENDstupidity*/rib_delete(afi,SAFI_UNICAST,vrf_id,proto,0,flags,
&p,NULL,NULL,table,metric,true,NULL);}}return0;}staticstructmcast_route_data*mro
ute=NULL;staticintnetlink_route_change_read_multicast(structsockaddr_nl*snl,stru
ctnlmsghdr*h,ns_id_tns_id,intstartup){intlen;structrtmsg*rtm;structrtattr*tb[RTA
_MAX+1];structmcast_route_data*m;structmcast_route_datamr;intiif=0;intcount;into
if[256];intoif_count=0;charsbuf[40];chargbuf[40];charoif_list[256]="\0";vrf_id_t
vrf;inttable;if(mroute)m=mroute;else{memset(&mr,0,sizeof(mr));m=&mr;}rtm=NLMSG_D
ATA(h);len=h->nlmsg_len-NLMSG_LENGTH(sizeof(structrtmsg));memset(tb,0,sizeoftb);
netlink_parse_rtattr(tb,RTA_MAX,RTM_RTA(rtm),len);if(tb[RTA_TABLE])table=*(int*)
RTA_DATA(tb[RTA_TABLE]);elsetable=rtm->rtm_table;vrf=vrf_lookup_by_table(table,n
s_id);if(tb[RTA_IIF])iif=*(int*)RTA_DATA(tb[RTA_IIF]);if(tb[RTA_SRC])m->sg.src=*
(structin_addr*)RTA_DATA(tb[RTA_SRC]);if(tb[RTA_DST])m->sg.grp=*(structin_addr*)
RTA_DATA(tb[RTA_DST]);if((RTA_EXPIRES<=RTA_MAX)&&tb[RTA_EXPIRES])m->lastused=*(u
nsignedlonglong*)RTA_DATA(tb[RTA_EXPIRES]);if(tb[RTA_MULTIPATH]){structrtnexthop
*rtnh=(structrtnexthop*)RTA_DATA(tb[RTA_MULTIPATH]);len=RTA_PAYLOAD(tb[RTA_MULTI
PATH]);for(;;){if(len<(int)sizeof(*rtnh)||rtnh->rtnh_len>len)break;oif[oif_count
]=rtnh->rtnh_ifindex;oif_count++;len-=NLMSG_ALIGN(rtnh->rtnh_len);rtnh=RTNH_NEXT
(rtnh);}}if(IS_ZEBRA_DEBUG_KERNEL){structinterface*ifp;strlcpy(sbuf,inet_ntoa(m-
>sg.src),sizeof(sbuf));strlcpy(gbuf,inet_ntoa(m->sg.grp),sizeof(gbuf));for(count
=0;count<oif_count;count++){ifp=if_lookup_by_index(oif[count],vrf);chartemp[256]
;sprintf(temp,"%s",ifp->name);strcat(oif_list,temp);}structzebra_vrf*zvrf=zebra_
vrf_lookup_by_id(vrf);ifp=if_lookup_by_index(iif,vrf);zlog_debug("MCASTVRF:%s(%d
)%s(%s,%s)IIF:%sOIF:%sjiffies:%lld",zvrf->vrf->name,vrf,nl_msg_type_to_str(h->nl
msg_type),sbuf,gbuf,ifp->name,oif_list,m->lastused);}return0;}intnetlink_route_c
hange(structsockaddr_nl*snl,structnlmsghdr*h,ns_id_tns_id,intstartup){intlen;str
uctrtmsg*rtm;rtm=NLMSG_DATA(h);if(!(h->nlmsg_type==RTM_NEWROUTE||h->nlmsg_type==
RTM_DELROUTE)){/*Ifthisisnotrouteadd/deletemessageprintwarning.*/zlog_warn("Kern
elmessage:%dNS%u\n",h->nlmsg_type,ns_id);return0;}/*Connectedroute.*/if(IS_ZEBRA
_DEBUG_KERNEL)zlog_debug("%s%s%sproto%sNS%u",nl_msg_type_to_str(h->nlmsg_type),n
l_family_to_str(rtm->rtm_family),nl_rttype_to_str(rtm->rtm_type),nl_rtproto_to_s
tr(rtm->rtm_protocol),ns_id);/*Wedon'tcareaboutchangenotificationsfortheMPLStabl
e.*//*TODO:Revisitthis.*/if(rtm->rtm_family==AF_MPLS)return0;len=h->nlmsg_len-NL
MSG_LENGTH(sizeof(structrtmsg));if(len<0)return-1;if(rtm->rtm_type==RTN_MULTICAS
T)netlink_route_change_read_multicast(snl,h,ns_id,startup);elsenetlink_route_cha
nge_read_unicast(snl,h,ns_id,startup);return0;}/*Requestforspecificrouteinformat
ionfromthekernel*/staticintnetlink_request_route(structzebra_ns*zns,intfamily,in
ttype){struct{structnlmsghdrn;structrtmsgrtm;}req;/*Formtherequest,specifyingfil
ter(rtattr)ifneeded.*/memset(&req,0,sizeof(req));req.n.nlmsg_type=type;req.n.nlm
sg_len=NLMSG_LENGTH(sizeof(structrtmsg));req.rtm.rtm_family=family;returnnetlink
_request(&zns->netlink_cmd,&req.n);}/*Routingtablereadfunctionusingnetlinkinterf
ace.Onlycalledbootstraptime.*/intnetlink_route_read(structzebra_ns*zns){intret;/
*GetIPv4routingtable.*/ret=netlink_request_route(zns,AF_INET,RTM_GETROUTE);if(re
t<0)returnret;ret=netlink_parse_info(netlink_route_change_read_unicast,&zns->net
link_cmd,zns,0,1);if(ret<0)returnret;/*GetIPv6routingtable.*/ret=netlink_request
_route(zns,AF_INET6,RTM_GETROUTE);if(ret<0)returnret;ret=netlink_parse_info(netl
ink_route_change_read_unicast,&zns->netlink_cmd,zns,0,1);if(ret<0)returnret;retu
rn0;}staticvoid_netlink_route_nl_add_gateway_info(uint8_troute_family,uint8_tgw_
family,structnlmsghdr*nlmsg,size_treq_size,intbytelen,structnexthop*nexthop){if(
route_family==AF_MPLS){structgw_family_tgw_fam;gw_fam.family=gw_family;if(gw_fam
ily==AF_INET)memcpy(&gw_fam.gate.ipv4,&nexthop->gate.ipv4,bytelen);elsememcpy(&g
w_fam.gate.ipv6,&nexthop->gate.ipv6,bytelen);addattr_l(nlmsg,req_size,RTA_VIA,&g
w_fam.family,bytelen+2);}else{if(gw_family==AF_INET)addattr_l(nlmsg,req_size,RTA
_GATEWAY,&nexthop->gate.ipv4,bytelen);elseaddattr_l(nlmsg,req_size,RTA_GATEWAY,&
nexthop->gate.ipv6,bytelen);}}staticvoid_netlink_route_rta_add_gateway_info(uint
8_troute_family,uint8_tgw_family,structrtattr*rta,structrtnexthop*rtnh,size_treq
_size,intbytelen,structnexthop*nexthop){if(route_family==AF_MPLS){structgw_famil
y_tgw_fam;gw_fam.family=gw_family;if(gw_family==AF_INET)memcpy(&gw_fam.gate.ipv4
,&nexthop->gate.ipv4,bytelen);elsememcpy(&gw_fam.gate.ipv6,&nexthop->gate.ipv6,b
ytelen);rta_addattr_l(rta,req_size,RTA_VIA,&gw_fam.family,bytelen+2);rtnh->rtnh_
len+=RTA_LENGTH(bytelen+2);}else{if(gw_family==AF_INET)rta_addattr_l(rta,req_siz
e,RTA_GATEWAY,&nexthop->gate.ipv4,bytelen);elserta_addattr_l(rta,req_size,RTA_GA
TEWAY,&nexthop->gate.ipv6,bytelen);rtnh->rtnh_len+=sizeof(structrtattr)+bytelen;
}}/*Thisfunctiontakesanexthopasargumentandadds*theappropriatenetlinkattributesto
anexisting*netlinkmessage.**@paramroutedesc:Humanreadabledescriptionofroutetype*
(direct/recursive,single-/multipath)*@parambytelen:Lengthofaddressesinbytes.*@pa
ramnexthop:Nexthopinformation*@paramnlmsg:nlmsghdrstructuretofillin.*@paramreq_s
ize:Thesizeallocatedforthemessage.*/staticvoid_netlink_route_build_singlepath(co
nstchar*routedesc,intbytelen,structnexthop*nexthop,structnlmsghdr*nlmsg,structrt
msg*rtmsg,size_treq_size,intcmd){structmpls_label_stack*nh_label;mpls_lse_tout_l
se[MPLS_MAX_LABELS];intnum_labels=0;charlabel_buf[256];/**label_bufis*only*curre
ntlyusedwithindebugging.*Assuchwhenweassignitweareguardingitinside*adebugtest.If
youwanttochangethismakesure*youfixthisassumption*/label_buf[0]='\0';assert(nexth
op);for(structnexthop*nh=nexthop;nh;nh=nh->rparent){charlabel_buf1[20];nh_label=
nh->nh_label;if(!nh_label||!nh_label->num_labels)continue;for(inti=0;i<nh_label-
>num_labels;i++){if(nh_label->label[i]==MPLS_LABEL_IMPLICIT_NULL)continue;if(IS_
ZEBRA_DEBUG_KERNEL){if(!num_labels)sprintf(label_buf,"label%u",nh_label->label[i
]);else{sprintf(label_buf1,"/%u",nh_label->label[i]);strlcat(label_buf,label_buf
1,sizeof(label_buf));}}out_lse[num_labels]=mpls_lse_encode(nh_label->label[i],0,
0,0);num_labels++;}}if(num_labels){/*SettheBoSbit*/out_lse[num_labels-1]|=htonl(
1<<MPLS_LS_S_SHIFT);if(rtmsg->rtm_family==AF_MPLS)addattr_l(nlmsg,req_size,RTA_N
EWDST,&out_lse,num_labels*sizeof(mpls_lse_t));else{structrtattr*nest;uint16_tenc
ap=LWTUNNEL_ENCAP_MPLS;addattr_l(nlmsg,req_size,RTA_ENCAP_TYPE,&encap,sizeof(uin
t16_t));nest=addattr_nest(nlmsg,req_size,RTA_ENCAP);addattr_l(nlmsg,req_size,MPL
S_IPTUNNEL_DST,&out_lse,num_labels*sizeof(mpls_lse_t));addattr_nest_end(nlmsg,ne
st);}}if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ONLINK))rtmsg->rtm_flags|=RTNH_F
_ONLINK;if(rtmsg->rtm_family==AF_INET&&(nexthop->type==NEXTHOP_TYPE_IPV6||nextho
p->type==NEXTHOP_TYPE_IPV6_IFINDEX)){rtmsg->rtm_flags|=RTNH_F_ONLINK;addattr_l(n
lmsg,req_size,RTA_GATEWAY,&ipv4_ll,4);addattr32(nlmsg,req_size,RTA_OIF,nexthop->
ifindex);if(nexthop->rmap_src.ipv4.s_addr&&(cmd==RTM_NEWROUTE))addattr_l(nlmsg,r
eq_size,RTA_PREFSRC,&nexthop->rmap_src.ipv4,bytelen);elseif(nexthop->src.ipv4.s_
addr&&(cmd==RTM_NEWROUTE))addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop->src.ipv
4,bytelen);if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("5549:_netlink_route_build_single
path()(%s):""nexthopvia%s%sif%u(%u)",routedesc,ipv4_ll_buf,label_buf,nexthop->if
index,nexthop->vrf_id);return;}if(nexthop->type==NEXTHOP_TYPE_IPV4||nexthop->typ
e==NEXTHOP_TYPE_IPV4_IFINDEX){/*Senddeletestothekernelwithoutspecifyingthenext-h
op*/if(cmd!=RTM_DELROUTE)_netlink_route_nl_add_gateway_info(rtmsg->rtm_family,AF
_INET,nlmsg,req_size,bytelen,nexthop);if(cmd==RTM_NEWROUTE){if(nexthop->rmap_src
.ipv4.s_addr)addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop->rmap_src.ipv4,bytele
n);elseif(nexthop->src.ipv4.s_addr)addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop
->src.ipv4,bytelen);}if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_route_multipat
h()(%s):""nexthopvia%s%sif%u(%u)",routedesc,inet_ntoa(nexthop->gate.ipv4),label_
buf,nexthop->ifindex,nexthop->vrf_id);}if(nexthop->type==NEXTHOP_TYPE_IPV6||next
hop->type==NEXTHOP_TYPE_IPV6_IFINDEX){_netlink_route_nl_add_gateway_info(rtmsg->
rtm_family,AF_INET6,nlmsg,req_size,bytelen,nexthop);if(cmd==RTM_NEWROUTE){if(!IN
6_IS_ADDR_UNSPECIFIED(&nexthop->rmap_src.ipv6))addattr_l(nlmsg,req_size,RTA_PREF
SRC,&nexthop->rmap_src.ipv6,bytelen);elseif(!IN6_IS_ADDR_UNSPECIFIED(&nexthop->s
rc.ipv6))addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop->src.ipv6,bytelen);}if(IS
_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_route_multipath()(%s):""nexthopvia%s%sif
%u(%u)",routedesc,inet6_ntoa(nexthop->gate.ipv6),label_buf,nexthop->ifindex,next
hop->vrf_id);}/**Wehavetheifindexsoweshouldalwayssendit*Thisisespeciallyusefulif
wearedoingroute*leaking.*/if(nexthop->type!=NEXTHOP_TYPE_BLACKHOLE)addattr32(nlm
sg,req_size,RTA_OIF,nexthop->ifindex);if(nexthop->type==NEXTHOP_TYPE_IFINDEX||ne
xthop->type==NEXTHOP_TYPE_IPV4_IFINDEX){if(cmd==RTM_NEWROUTE){if(nexthop->rmap_s
rc.ipv4.s_addr)addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop->rmap_src.ipv4,byte
len);elseif(nexthop->src.ipv4.s_addr)addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexth
op->src.ipv4,bytelen);}if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_route_multip
ath()(%s):""nexthopviaif%u(%u)",routedesc,nexthop->ifindex,nexthop->vrf_id);}if(
nexthop->type==NEXTHOP_TYPE_IPV6_IFINDEX){if(cmd==RTM_NEWROUTE){if(!IN6_IS_ADDR_
UNSPECIFIED(&nexthop->rmap_src.ipv6))addattr_l(nlmsg,req_size,RTA_PREFSRC,&nexth
op->rmap_src.ipv6,bytelen);elseif(!IN6_IS_ADDR_UNSPECIFIED(&nexthop->src.ipv6))a
ddattr_l(nlmsg,req_size,RTA_PREFSRC,&nexthop->src.ipv6,bytelen);}if(IS_ZEBRA_DEB
UG_KERNEL)zlog_debug("netlink_route_multipath()(%s):""nexthopviaif%u(%u)",routed
esc,nexthop->ifindex,nexthop->vrf_id);}}/*Thisfunctiontakesanexthopasargumentand
*appendstothegivenrtattr/rtnexthoppairthe*representationofthenexthop.Ifthenextho
p*definesapreferredsource,thesrcparameter*willbemodifiedtopointtothatsrc,otherwi
se*itwillbekeptunmodified.**@paramroutedesc:Humanreadabledescriptionofroutetype*
(direct/recursive,single-/multipath)*@parambytelen:Lengthofaddressesinbytes.*@pa
ramnexthop:Nexthopinformation*@paramrta:rtnetlinkattributestructure*@paramrtnh:p
ointertoanrtnetlinknexthopstructure*@paramsrc:pointerpointingtoalocationwhere*th
eprefsrcshouldbestored.*/staticvoid_netlink_route_build_multipath(constchar*rout
edesc,intbytelen,structnexthop*nexthop,structrtattr*rta,structrtnexthop*rtnh,str
uctrtmsg*rtmsg,uniong_addr**src){structmpls_label_stack*nh_label;mpls_lse_tout_l
se[MPLS_MAX_LABELS];intnum_labels=0;charlabel_buf[256];rtnh->rtnh_len=sizeof(*rt
nh);rtnh->rtnh_flags=0;rtnh->rtnh_hops=0;rta->rta_len+=rtnh->rtnh_len;/**label_b
ufis*only*currentlyusedwithindebugging.*Assuchwhenweassignitweareguardingitinsid
e*adebugtest.Ifyouwanttochangethismakesure*youfixthisassumption*/label_buf[0]='\
0';assert(nexthop);for(structnexthop*nh=nexthop;nh;nh=nh->rparent){charlabel_buf
1[20];nh_label=nh->nh_label;if(!nh_label||!nh_label->num_labels)continue;for(int
i=0;i<nh_label->num_labels;i++){if(nh_label->label[i]==MPLS_LABEL_IMPLICIT_NULL)
continue;if(IS_ZEBRA_DEBUG_KERNEL){if(!num_labels)sprintf(label_buf,"label%u",nh
_label->label[i]);else{sprintf(label_buf1,"/%u",nh_label->label[i]);strlcat(labe
l_buf,label_buf1,sizeof(label_buf));}}out_lse[num_labels]=mpls_lse_encode(nh_lab
el->label[i],0,0,0);num_labels++;}}if(num_labels){/*SettheBoSbit*/out_lse[num_la
bels-1]|=htonl(1<<MPLS_LS_S_SHIFT);if(rtmsg->rtm_family==AF_MPLS){rta_addattr_l(
rta,NL_PKT_BUF_SIZE,RTA_NEWDST,&out_lse,num_labels*sizeof(mpls_lse_t));rtnh->rtn
h_len+=RTA_LENGTH(num_labels*sizeof(mpls_lse_t));}else{structrtattr*nest;uint16_
tencap=LWTUNNEL_ENCAP_MPLS;intlen=rta->rta_len;rta_addattr_l(rta,NL_PKT_BUF_SIZE
,RTA_ENCAP_TYPE,&encap,sizeof(uint16_t));nest=rta_nest(rta,NL_PKT_BUF_SIZE,RTA_E
NCAP);rta_addattr_l(rta,NL_PKT_BUF_SIZE,MPLS_IPTUNNEL_DST,&out_lse,num_labels*si
zeof(mpls_lse_t));rta_nest_end(rta,nest);rtnh->rtnh_len+=rta->rta_len-len;}}if(C
HECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ONLINK))rtnh->rtnh_flags|=RTNH_F_ONLINK;if
(rtmsg->rtm_family==AF_INET&&(nexthop->type==NEXTHOP_TYPE_IPV6||nexthop->type==N
EXTHOP_TYPE_IPV6_IFINDEX)){bytelen=4;rtnh->rtnh_flags|=RTNH_F_ONLINK;rta_addattr
_l(rta,NL_PKT_BUF_SIZE,RTA_GATEWAY,&ipv4_ll,bytelen);rtnh->rtnh_len+=sizeof(stru
ctrtattr)+bytelen;rtnh->rtnh_ifindex=nexthop->ifindex;if(nexthop->rmap_src.ipv4.
s_addr)*src=&nexthop->rmap_src;elseif(nexthop->src.ipv4.s_addr)*src=&nexthop->sr
c;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("5549:netlink_route_build_multipath()(%s):
""nexthopvia%s%sif%u",routedesc,ipv4_ll_buf,label_buf,nexthop->ifindex);return;}
if(nexthop->type==NEXTHOP_TYPE_IPV4||nexthop->type==NEXTHOP_TYPE_IPV4_IFINDEX){_
netlink_route_rta_add_gateway_info(rtmsg->rtm_family,AF_INET,rta,rtnh,NL_PKT_BUF
_SIZE,bytelen,nexthop);if(nexthop->rmap_src.ipv4.s_addr)*src=&nexthop->rmap_src;
elseif(nexthop->src.ipv4.s_addr)*src=&nexthop->src;if(IS_ZEBRA_DEBUG_KERNEL)zlog
_debug("netlink_route_multipath()(%s):""nexthopvia%s%sif%u",routedesc,inet_ntoa(
nexthop->gate.ipv4),label_buf,nexthop->ifindex);}if(nexthop->type==NEXTHOP_TYPE_
IPV6||nexthop->type==NEXTHOP_TYPE_IPV6_IFINDEX){_netlink_route_rta_add_gateway_i
nfo(rtmsg->rtm_family,AF_INET6,rta,rtnh,NL_PKT_BUF_SIZE,bytelen,nexthop);if(!IN6
_IS_ADDR_UNSPECIFIED(&nexthop->rmap_src.ipv6))*src=&nexthop->rmap_src;elseif(!IN
6_IS_ADDR_UNSPECIFIED(&nexthop->src.ipv6))*src=&nexthop->src;if(IS_ZEBRA_DEBUG_K
ERNEL)zlog_debug("netlink_route_multipath()(%s):""nexthopvia%s%sif%u",routedesc,
inet6_ntoa(nexthop->gate.ipv6),label_buf,nexthop->ifindex);}/**Wehavefiguredoutt
heifindexsoweshouldalwayssendit*Thisisespeciallyusefulifwearedoingroute*leaking.
*/if(nexthop->type!=NEXTHOP_TYPE_BLACKHOLE)rtnh->rtnh_ifindex=nexthop->ifindex;/
*ifindex*/if(nexthop->type==NEXTHOP_TYPE_IPV4_IFINDEX||nexthop->type==NEXTHOP_TY
PE_IFINDEX){if(nexthop->rmap_src.ipv4.s_addr)*src=&nexthop->rmap_src;elseif(next
hop->src.ipv4.s_addr)*src=&nexthop->src;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("net
link_route_multipath()(%s):""nexthopviaif%u",routedesc,nexthop->ifindex);}elseif
(nexthop->type==NEXTHOP_TYPE_IPV6_IFINDEX){if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("
netlink_route_multipath()(%s):""nexthopviaif%u",routedesc,nexthop->ifindex);}els
e{rtnh->rtnh_ifindex=0;}}staticinlinevoid_netlink_mpls_build_singlepath(constcha
r*routedesc,zebra_nhlfe_t*nhlfe,structnlmsghdr*nlmsg,structrtmsg*rtmsg,size_treq
_size,intcmd){intbytelen;uint8_tfamily;family=NHLFE_FAMILY(nhlfe);bytelen=(famil
y==AF_INET?4:16);_netlink_route_build_singlepath(routedesc,bytelen,nhlfe->nextho
p,nlmsg,rtmsg,req_size,cmd);}staticinlinevoid_netlink_mpls_build_multipath(const
char*routedesc,zebra_nhlfe_t*nhlfe,structrtattr*rta,structrtnexthop*rtnh,structr
tmsg*rtmsg,uniong_addr**src){intbytelen;uint8_tfamily;family=NHLFE_FAMILY(nhlfe)
;bytelen=(family==AF_INET?4:16);_netlink_route_build_multipath(routedesc,bytelen
,nhlfe->nexthop,rta,rtnh,rtmsg,src);}/*Logdebuginformationfornetlink_route_multi
path*ifdebugloggingisenabled.**@paramcmd:Netlinkcommandwhichistobeprocessed*@par
amp:Prefixforwhichthechangeisdue*@paramnexthop:Nexthopwhichiscurrentlyprocessed*
@paramroutedesc:Semanticannotationfornexthop*(recursive,multipath,etc.)*@paramfa
mily:Addressfamilywhichthechangeconcerns*/staticvoid_netlink_route_debug(intcmd,
structprefix*p,structnexthop*nexthop,constchar*routedesc,intfamily,structzebra_v
rf*zvrf,uint32_ttableid){if(IS_ZEBRA_DEBUG_KERNEL){charbuf[PREFIX_STRLEN];zlog_d
ebug("netlink_route_multipath()(%s):%s%svrf%u(%u)type%s",routedesc,nl_msg_type_t
o_str(cmd),prefix2str(p,buf,sizeof(buf)),zvrf_id(zvrf),tableid,(nexthop)?nexthop
_type_to_str(nexthop->type):"UNK");}}staticvoid_netlink_mpls_debug(intcmd,uint32
_tlabel,constchar*routedesc){if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_mpls_m
ultipath()(%s):%s%u/20",routedesc,nl_msg_type_to_str(cmd),label);}staticintnetli
nk_neigh_update(intcmd,intifindex,uint32_taddr,char*lla,intllalen,ns_id_tns_id){
struct{structnlmsghdrn;structndmsgndm;charbuf[256];}req;structzebra_ns*zns=zebra
_ns_lookup(ns_id);memset(&req.n,0,sizeof(req.n));memset(&req.ndm,0,sizeof(req.nd
m));req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structndmsg));req.n.nlmsg_flags=NLM_F_CR
EATE|NLM_F_REQUEST;req.n.nlmsg_type=cmd;//RTM_NEWNEIGHorRTM_DELNEIGHreq.n.nlmsg_
pid=zns->netlink_cmd.snl.nl_pid;req.ndm.ndm_family=AF_INET;req.ndm.ndm_state=NUD
_PERMANENT;req.ndm.ndm_ifindex=ifindex;req.ndm.ndm_type=RTN_UNICAST;addattr_l(&r
eq.n,sizeof(req),NDA_DST,&addr,4);addattr_l(&req.n,sizeof(req),NDA_LLADDR,lla,ll
alen);returnnetlink_talk(netlink_talk_filter,&req.n,&zns->netlink_cmd,zns,0);}/*
Routingtablechangevianetlinkinterface.*//*Updateflagindicateswhetherthisisa"repl
ace"ornot.*/staticintnetlink_route_multipath(intcmd,structprefix*p,structprefix*
src_p,structroute_entry*re,intupdate){intbytelen;structsockaddr_nlsnl;structnext
hop*nexthop=NULL;unsignedintnexthop_num;intdiscard=0;intfamily=PREFIX_FAMILY(p);
constchar*routedesc;intsetsrc=0;uniong_addrsrc;struct{structnlmsghdrn;structrtms
gr;charbuf[NL_PKT_BUF_SIZE];}req;structzebra_ns*zns;structzebra_vrf*zvrf=vrf_inf
o_lookup(re->vrf_id);zns=zvrf->zns;memset(&req,0,sizeofreq-NL_PKT_BUF_SIZE);byte
len=(family==AF_INET?4:16);req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structrtmsg));req
.n.nlmsg_flags=NLM_F_CREATE|NLM_F_REQUEST;if((cmd==RTM_NEWROUTE)&&update)req.n.n
lmsg_flags|=NLM_F_REPLACE;req.n.nlmsg_type=cmd;req.n.nlmsg_pid=zns->netlink_cmd.
snl.nl_pid;req.r.rtm_family=family;req.r.rtm_dst_len=p->prefixlen;req.r.rtm_src_
len=src_p?src_p->prefixlen:0;req.r.rtm_protocol=zebra2proto(re->type);req.r.rtm_
scope=RT_SCOPE_UNIVERSE;req.r.rtm_type=RTN_UNICAST;addattr_l(&req.n,sizeofreq,RT
A_DST,&p->u.prefix,bytelen);if(src_p)addattr_l(&req.n,sizeofreq,RTA_SRC,&src_p->
u.prefix,bytelen);/*Metric.*//*Hardcodethemetricforallroutescomingfromzebra.Metr
icisn't*used*eitherbythekernelorbyzebra.Itspurelyforcalculatingbest*path(s)*byth
eroutingprotocolandforcommunicatingwithprotocolpeers.*/addattr32(&req.n,sizeofre
q,RTA_PRIORITY,NL_DEFAULT_ROUTE_METRIC);#ifdefined(SUPPORT_REALMS)if(re->tag>0&&
re->tag<=255)addattr32(&req.n,sizeofreq,RTA_FLOW,re->tag);#endif/*Tablecorrespon
dingtothisroute.*/if(re->table<256)req.r.rtm_table=re->table;else{req.r.rtm_tabl
e=RT_TABLE_UNSPEC;addattr32(&req.n,sizeofreq,RTA_TABLE,re->table);}if(discard)go
toskip;if(re->mtu||re->nexthop_mtu){charbuf[NL_PKT_BUF_SIZE];structrtattr*rta=(v
oid*)buf;uint32_tmtu=re->mtu;if(!mtu||(re->nexthop_mtu&&re->nexthop_mtu<mtu))mtu
=re->nexthop_mtu;rta->rta_type=RTA_METRICS;rta->rta_len=RTA_LENGTH(0);rta_addatt
r_l(rta,NL_PKT_BUF_SIZE,RTAX_MTU,&mtu,sizeofmtu);addattr_l(&req.n,NL_PKT_BUF_SIZ
E,RTA_METRICS,RTA_DATA(rta),RTA_PAYLOAD(rta));}/*Countoverallnexthopssowecandeci
dewhethertousesinglepath*ormultipathcase.*/nexthop_num=0;for(ALL_NEXTHOPS(re->ng
,nexthop)){if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_RECURSIVE))continue;if(cmd=
=RTM_NEWROUTE&&!NEXTHOP_IS_ACTIVE(nexthop->flags))continue;if(cmd==RTM_DELROUTE&
&!CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB))continue;nexthop_num++;}/*Singlepa
thcase.*/if(nexthop_num==1||multipath_num==1){nexthop_num=0;for(ALL_NEXTHOPS(re-
>ng,nexthop)){/**Sowewanttocover2typesofblackhole*routeshere:*1)Anormalblackhole
route(alafromastatic*install.*2)Arecursivelyresolvedblackholeroute*/if(nexthop->
type==NEXTHOP_TYPE_BLACKHOLE){switch(nexthop->bh_type){caseBLACKHOLE_ADMINPROHIB
:req.r.rtm_type=RTN_PROHIBIT;break;caseBLACKHOLE_REJECT:req.r.rtm_type=RTN_UNREA
CHABLE;break;default:req.r.rtm_type=RTN_BLACKHOLE;break;}gotoskip;}if(CHECK_FLAG
(nexthop->flags,NEXTHOP_FLAG_RECURSIVE)){if(!setsrc){if(family==AF_INET){if(next
hop->rmap_src.ipv4.s_addr!=0){src.ipv4=nexthop->rmap_src.ipv4;setsrc=1;}elseif(n
exthop->src.ipv4.s_addr!=0){src.ipv4=nexthop->src.ipv4;setsrc=1;}}elseif(family=
=AF_INET6){if(!IN6_IS_ADDR_UNSPECIFIED(&nexthop->rmap_src.ipv6)){src.ipv6=nextho
p->rmap_src.ipv6;setsrc=1;}elseif(!IN6_IS_ADDR_UNSPECIFIED(&nexthop->src.ipv6)){
src.ipv6=nexthop->src.ipv6;setsrc=1;}}}continue;}if((cmd==RTM_NEWROUTE&&NEXTHOP_
IS_ACTIVE(nexthop->flags))||(cmd==RTM_DELROUTE&&CHECK_FLAG(nexthop->flags,NEXTHO
P_FLAG_FIB))){routedesc=nexthop->rparent?"recursive,single-path":"single-path";_
netlink_route_debug(cmd,p,nexthop,routedesc,family,zvrf,re->table);_netlink_rout
e_build_singlepath(routedesc,bytelen,nexthop,&req.n,&req.r,sizeofreq,cmd);nextho
p_num++;break;}}if(setsrc&&(cmd==RTM_NEWROUTE)){if(family==AF_INET)addattr_l(&re
q.n,sizeofreq,RTA_PREFSRC,&src.ipv4,bytelen);elseif(family==AF_INET6)addattr_l(&
req.n,sizeofreq,RTA_PREFSRC,&src.ipv6,bytelen);}}else{charbuf[NL_PKT_BUF_SIZE];s
tructrtattr*rta=(void*)buf;structrtnexthop*rtnh;uniong_addr*src1=NULL;rta->rta_t
ype=RTA_MULTIPATH;rta->rta_len=RTA_LENGTH(0);rtnh=RTA_DATA(rta);nexthop_num=0;fo
r(ALL_NEXTHOPS(re->ng,nexthop)){if(nexthop_num>=multipath_num)break;if(CHECK_FLA
G(nexthop->flags,NEXTHOP_FLAG_RECURSIVE)){/*ThisonlyworksforIPv4now*/if(!setsrc)
{if(family==AF_INET){if(nexthop->rmap_src.ipv4.s_addr!=0){src.ipv4=nexthop->rmap
_src.ipv4;setsrc=1;}elseif(nexthop->src.ipv4.s_addr!=0){src.ipv4=nexthop->src.ip
v4;setsrc=1;}}elseif(family==AF_INET6){if(!IN6_IS_ADDR_UNSPECIFIED(&nexthop->rma
p_src.ipv6)){src.ipv6=nexthop->rmap_src.ipv6;setsrc=1;}elseif(!IN6_IS_ADDR_UNSPE
CIFIED(&nexthop->src.ipv6)){src.ipv6=nexthop->src.ipv6;setsrc=1;}}}continue;}if(
(cmd==RTM_NEWROUTE&&NEXTHOP_IS_ACTIVE(nexthop->flags))||(cmd==RTM_DELROUTE&&CHEC
K_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB))){routedesc=nexthop->rparent?"recursive,
multipath":"multipath";nexthop_num++;_netlink_route_debug(cmd,p,nexthop,routedes
c,family,zvrf,re->table);_netlink_route_build_multipath(routedesc,bytelen,nextho
p,rta,rtnh,&req.r,&src1);rtnh=RTNH_NEXT(rtnh);if(!setsrc&&src1){if(family==AF_IN
ET)src.ipv4=src1->ipv4;elseif(family==AF_INET6)src.ipv6=src1->ipv6;setsrc=1;}}}i
f(setsrc&&(cmd==RTM_NEWROUTE)){if(family==AF_INET)addattr_l(&req.n,sizeofreq,RTA
_PREFSRC,&src.ipv4,bytelen);elseif(family==AF_INET6)addattr_l(&req.n,sizeofreq,R
TA_PREFSRC,&src.ipv6,bytelen);if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("Settingsource
");}if(rta->rta_len>RTA_LENGTH(0))addattr_l(&req.n,NL_PKT_BUF_SIZE,RTA_MULTIPATH
,RTA_DATA(rta),RTA_PAYLOAD(rta));}/*Ifthereisnousefulnexthopthenreturn.*/if(next
hop_num==0){if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("netlink_route_multipath():Nouse
fulnexthop.");return0;}skip:/*Destinationnetlinkaddress.*/memset(&snl,0,sizeofsn
l);snl.nl_family=AF_NETLINK;/*Talktonetlinksocket.*/returnnetlink_talk(netlink_t
alk_filter,&req.n,&zns->netlink_cmd,zns,0);}intkernel_get_ipmr_sg_stats(structze
bra_vrf*zvrf,void*in){intsuc=0;structmcast_route_data*mr=(structmcast_route_data
*)in;struct{structnlmsghdrn;structndmsgndm;charbuf[256];}req;mroute=mr;structzeb
ra_ns*zns;zns=zvrf->zns;memset(&req.n,0,sizeof(req.n));memset(&req.ndm,0,sizeof(
req.ndm));req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structndmsg));req.n.nlmsg_flags=NL
M_F_REQUEST;req.n.nlmsg_pid=zns->netlink_cmd.snl.nl_pid;req.ndm.ndm_family=RTNL_
FAMILY_IPMR;req.n.nlmsg_type=RTM_GETROUTE;addattr_l(&req.n,sizeof(req),RTA_IIF,&
mroute->ifindex,4);addattr_l(&req.n,sizeof(req),RTA_OIF,&mroute->ifindex,4);adda
ttr_l(&req.n,sizeof(req),RTA_SRC,&mroute->sg.src.s_addr,4);addattr_l(&req.n,size
of(req),RTA_DST,&mroute->sg.grp.s_addr,4);addattr_l(&req.n,sizeof(req),RTA_TABLE
,&zvrf->table_id,4);suc=netlink_talk(netlink_route_change_read_multicast,&req.n,
&zns->netlink_cmd,zns,0);mroute=NULL;returnsuc;}voidkernel_route_rib(structroute
_node*rn,structprefix*p,structprefix*src_p,structroute_entry*old,structroute_ent
ry*new){intret=0;assert(old||new);if(new){if(p->family==AF_INET)ret=netlink_rout
e_multipath(RTM_NEWROUTE,p,src_p,new,(old)?1:0);else{/**Sov6routereplacesemantic
sarenotin*thekernelatthispointasIunderstandit.*Solet'sdoadeletethananadd.*Inthef
utureoncev6routereplacesemantics*areinwecanfigureoutwhattodohereto*allowworkingw
itholdandnewkernels.**I'malsointentionallyignoringthefailurecase*oftheroutedelet
e.Ifthathappensyeahwe're*screwed.*/if(old)netlink_route_multipath(RTM_DELROUTE,p
,src_p,old,0);ret=netlink_route_multipath(RTM_NEWROUTE,p,src_p,new,0);}kernel_ro
ute_rib_pass_fail(rn,p,new,(!ret)?SOUTHBOUND_INSTALL_SUCCESS:SOUTHBOUND_INSTALL_
FAILURE);return;}if(old){ret=netlink_route_multipath(RTM_DELROUTE,p,src_p,old,0)
;kernel_route_rib_pass_fail(rn,p,old,(!ret)?SOUTHBOUND_DELETE_SUCCESS:SOUTHBOUND
_DELETE_FAILURE);}}intkernel_neigh_update(intadd,intifindex,uint32_taddr,char*ll
a,intllalen,ns_id_tns_id){returnnetlink_neigh_update(add?RTM_NEWNEIGH:RTM_DELNEI
GH,ifindex,addr,lla,llalen,ns_id);}/**AddremoteVTEPtothefloodlistforthisVxLANint
erface(VNI).This*isdonebyaddinganFDBentrywithaMACof00:00:00:00:00:00.*/staticint
netlink_vxlan_flood_list_update(structinterface*ifp,structin_addr*vtep_ip,intcmd
){structzebra_ns*zns;struct{structnlmsghdrn;structndmsgndm;charbuf[256];}req;uin
t8_tdst_mac[6]={0x0,0x0,0x0,0x0,0x0,0x0};structzebra_vrf*zvrf=zebra_vrf_lookup_b
y_id(ifp->vrf_id);zns=zvrf->zns;memset(&req.n,0,sizeof(req.n));memset(&req.ndm,0
,sizeof(req.ndm));req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structndmsg));req.n.nlmsg_
flags=NLM_F_REQUEST;if(cmd==RTM_NEWNEIGH)req.n.nlmsg_flags|=(NLM_F_CREATE|NLM_F_
APPEND);req.n.nlmsg_type=cmd;req.ndm.ndm_family=PF_BRIDGE;req.ndm.ndm_state=NUD_
NOARP|NUD_PERMANENT;req.ndm.ndm_flags|=NTF_SELF;//Handleby"self",not"master"adda
ttr_l(&req.n,sizeof(req),NDA_LLADDR,&dst_mac,6);req.ndm.ndm_ifindex=ifp->ifindex
;addattr_l(&req.n,sizeof(req),NDA_DST,&vtep_ip->s_addr,4);returnnetlink_talk(net
link_talk_filter,&req.n,&zns->netlink_cmd,zns,0);}/**AddremoteVTEPforthisVxLANin
terface(VNI).InLinux,thisinvolves*adding*a"flood"MACFDBentry.*/intkernel_add_vte
p(vni_tvni,structinterface*ifp,structin_addr*vtep_ip){if(IS_ZEBRA_DEBUG_VXLAN)zl
og_debug("Install%sintofloodlistforVNI%uintf%s(%u)",inet_ntoa(*vtep_ip),vni,ifp-
>name,ifp->ifindex);returnnetlink_vxlan_flood_list_update(ifp,vtep_ip,RTM_NEWNEI
GH);}/**RemoveremoteVTEPforthisVxLANinterface(VNI).InLinux,thisinvolves*deleting
the"flood"MACFDBentry.*/intkernel_del_vtep(vni_tvni,structinterface*ifp,structin
_addr*vtep_ip){if(IS_ZEBRA_DEBUG_VXLAN)zlog_debug("Uninstall%sfromfloodlistforVN
I%uintf%s(%u)",inet_ntoa(*vtep_ip),vni,ifp->name,ifp->ifindex);returnnetlink_vxl
an_flood_list_update(ifp,vtep_ip,RTM_DELNEIGH);}#ifndefNDA_RTA#defineNDA_RTA(r)\
((structrtattr*)(((char*)(r))+NLMSG_ALIGN(sizeof(structndmsg))))#endifstaticintn
etlink_macfdb_change(structsockaddr_nl*snl,structnlmsghdr*h,intlen,ns_id_tns_id)
{structndmsg*ndm;structinterface*ifp;structzebra_if*zif;structrtattr*tb[NDA_MAX+
1];structinterface*br_if;structethaddrmac;vlanid_tvid=0;structprefixvtep_ip;intv
id_present=0,dst_present=0;charbuf[ETHER_ADDR_STRLEN];charvid_buf[20];chardst_bu
f[30];uint8_tsticky=0;ndm=NLMSG_DATA(h);/*WeonlyprocessmacfdbnotificationsifEVPN
isenabled*/if(!is_evpn_enabled())return0;/*Theinterfaceshouldexist.*/ifp=if_look
up_by_index_per_ns(zebra_ns_lookup(ns_id),ndm->ndm_ifindex);if(!ifp||!ifp->info)
return0;/*Theinterfaceshouldbesomethingwe'reinterestedin.*/if(!IS_ZEBRA_IF_BRIDG
E_SLAVE(ifp))return0;/*Drop"permanent"entries.*/if(ndm->ndm_state&NUD_PERMANENT)
return0;zif=(structzebra_if*)ifp->info;if((br_if=zif->brslave_info.br_if)==NULL)
{zlog_warn("%sfamily%sIF%s(%u)brIF%u-nobridgemaster",nl_msg_type_to_str(h->nlmsg
_type),nl_family_to_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex,zif->brslave
_info.bridge_ifindex);return0;}/*Parseattributesandextractfieldsofinterest.*/mem
set(tb,0,sizeoftb);netlink_parse_rtattr(tb,NDA_MAX,NDA_RTA(ndm),len);if(!tb[NDA_
LLADDR]){zlog_warn("%sfamily%sIF%s(%u)brIF%u-noLLADDR",nl_msg_type_to_str(h->nlm
sg_type),nl_family_to_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex,zif->brsla
ve_info.bridge_ifindex);return0;}if(RTA_PAYLOAD(tb[NDA_LLADDR])!=ETH_ALEN){zlog_
warn("%sfamily%sIF%s(%u)brIF%u-LLADDRisnotMAC,len%lu",nl_msg_type_to_str(h->nlms
g_type),nl_family_to_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex,zif->brslav
e_info.bridge_ifindex,(unsignedlong)RTA_PAYLOAD(tb[NDA_LLADDR]));return0;}memcpy
(&mac,RTA_DATA(tb[NDA_LLADDR]),ETH_ALEN);if((NDA_VLAN<=NDA_MAX)&&tb[NDA_VLAN]){v
id_present=1;vid=*(uint16_t*)RTA_DATA(tb[NDA_VLAN]);sprintf(vid_buf,"VLAN%u",vid
);}if(tb[NDA_DST]){/*TODO:OnlyIPv4supportednow.*/dst_present=1;vtep_ip.family=AF
_INET;vtep_ip.prefixlen=IPV4_MAX_BITLEN;memcpy(&(vtep_ip.u.prefix4.s_addr),RTA_D
ATA(tb[NDA_DST]),IPV4_MAX_BYTELEN);sprintf(dst_buf,"dst%s",inet_ntoa(vtep_ip.u.p
refix4));}sticky=(ndm->ndm_state&NUD_NOARP)?1:0;if(IS_ZEBRA_DEBUG_KERNEL)zlog_de
bug("Rx%sfamily%sIF%s(%u)%s%sMAC%s%s",nl_msg_type_to_str(h->nlmsg_type),nl_famil
y_to_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex,vid_present?vid_buf:"",stic
ky?"sticky":"",prefix_mac2str(&mac,buf,sizeof(buf)),dst_present?dst_buf:"");if(f
ilter_vlan&&vid!=filter_vlan)return0;/*Ifaddorupdate,doaccordinglyiflearntona"lo
cal"interface;if*thenotificationisoverVxLAN,thishastoberelatedto*multi-homing,*s
operformanimplicitdeleteofanylocalentry(ifitexists).*/if(h->nlmsg_type==RTM_NEWN
EIGH){/*Drop"permanent"entries.*/if(ndm->ndm_state&NUD_PERMANENT)return0;if(IS_Z
EBRA_IF_VXLAN(ifp))returnzebra_vxlan_check_del_local_mac(ifp,br_if,&mac,vid);ret
urnzebra_vxlan_local_mac_add_update(ifp,br_if,&mac,vid,sticky);}/*Thisisadeleten
otification.*1.ForaMACoverVxLan,checkifitneedstoberefreshed(readded)*2.ForaMACov
er"local"interface,deletethemac*Note:Wewillgetnotificationsfrombothbridgedrivera
ndVxLAN*driver.*IgnorethenotificationfromVxLandriverasitisalsogenerated*whenmacm
ovesfromremotetolocal.*/if(dst_present)return0;if(IS_ZEBRA_IF_VXLAN(ifp))returnz
ebra_vxlan_check_readd_remote_mac(ifp,br_if,&mac,vid);returnzebra_vxlan_local_ma
c_del(ifp,br_if,&mac,vid);}staticintnetlink_macfdb_table(structsockaddr_nl*snl,s
tructnlmsghdr*h,ns_id_tns_id,intstartup){intlen;structndmsg*ndm;if(h->nlmsg_type
!=RTM_NEWNEIGH)return0;/*Lengthvalidity.*/len=h->nlmsg_len-NLMSG_LENGTH(sizeof(s
tructndmsg));if(len<0)return-1;/*WeareinterestedonlyinAF_BRIDGEnotifications.*/n
dm=NLMSG_DATA(h);if(ndm->ndm_family!=AF_BRIDGE)return0;returnnetlink_macfdb_chan
ge(snl,h,len,ns_id);}/*RequestforMACFDBinformationfromthekernel*/staticintnetlin
k_request_macs(structzebra_ns*zns,intfamily,inttype,ifindex_tmaster_ifindex){str
uct{structnlmsghdrn;structifinfomsgifm;charbuf[256];}req;/*Formtherequest,specif
yingfilter(rtattr)ifneeded.*/memset(&req,0,sizeof(req));req.n.nlmsg_type=type;re
q.n.nlmsg_len=NLMSG_LENGTH(sizeof(structifinfomsg));req.ifm.ifi_family=family;if
(master_ifindex)addattr32(&req.n,sizeof(req),IFLA_MASTER,master_ifindex);returnn
etlink_request(&zns->netlink_cmd,&req.n);}/**MACforwardingdatabasereadusingnetli
nkinterface.Thisisinvoked*atstartup.*/intnetlink_macfdb_read(structzebra_ns*zns)
{intret;/*GetbridgeFDBtable.*/ret=netlink_request_macs(zns,AF_BRIDGE,RTM_GETNEIG
H,0);if(ret<0)returnret;/*Wearereadingentiretable.*/filter_vlan=0;ret=netlink_pa
rse_info(netlink_macfdb_table,&zns->netlink_cmd,zns,0,1);returnret;}/**MACforwar
dingdatabasereadusingnetlinkinterface.Thisisfora*specificbridgeandmatchingspecif
icaccessVLAN(ifVLAN-awarebridge).*/intnetlink_macfdb_read_for_bridge(structzebra
_ns*zns,structinterface*ifp,structinterface*br_if){structzebra_if*br_zif;structz
ebra_if*zif;structzebra_l2info_vxlan*vxl;intret=0;/*SaveVLANwe'refilteringon,ifn
eeded.*/br_zif=(structzebra_if*)br_if->info;zif=(structzebra_if*)ifp->info;vxl=&
zif->l2info.vxl;if(IS_ZEBRA_IF_BRIDGE_VLAN_AWARE(br_zif))filter_vlan=vxl->access
_vlan;/*GetbridgeFDBtableforspecificbridge-wedotheVLANfiltering.*/ret=netlink_re
quest_macs(zns,AF_BRIDGE,RTM_GETNEIGH,br_if->ifindex);if(ret<0)returnret;ret=net
link_parse_info(netlink_macfdb_table,&zns->netlink_cmd,zns,0,0);/*ResetVLANfilte
r.*/filter_vlan=0;returnret;}staticintnetlink_macfdb_update(structinterface*ifp,
vlanid_tvid,structethaddr*mac,structin_addrvtep_ip,intlocal,intcmd,uint8_tsticky
){structzebra_ns*zns;struct{structnlmsghdrn;structndmsgndm;charbuf[256];}req;int
dst_alen;structzebra_if*zif;structinterface*br_if;structzebra_if*br_zif;charbuf[
ETHER_ADDR_STRLEN];intvid_present=0,dst_present=0;charvid_buf[20];chardst_buf[30
];structzebra_vrf*zvrf=zebra_vrf_lookup_by_id(ifp->vrf_id);zns=zvrf->zns;zif=ifp
->info;if((br_if=zif->brslave_info.br_if)==NULL){zlog_warn("MAC%sonIF%s(%u)-noma
ppingtobridge",(cmd==RTM_NEWNEIGH)?"add":"del",ifp->name,ifp->ifindex);return-1;
}memset(&req.n,0,sizeof(req.n));memset(&req.ndm,0,sizeof(req.ndm));req.n.nlmsg_l
en=NLMSG_LENGTH(sizeof(structndmsg));req.n.nlmsg_flags=NLM_F_REQUEST;if(cmd==RTM
_NEWNEIGH)req.n.nlmsg_flags|=(NLM_F_CREATE|NLM_F_REPLACE);req.n.nlmsg_type=cmd;r
eq.ndm.ndm_family=AF_BRIDGE;req.ndm.ndm_flags|=NTF_SELF|NTF_MASTER;req.ndm.ndm_s
tate=NUD_REACHABLE;if(sticky)req.ndm.ndm_state|=NUD_NOARP;elsereq.ndm.ndm_flags|
=NTF_EXT_LEARNED;addattr_l(&req.n,sizeof(req),NDA_LLADDR,mac,6);req.ndm.ndm_ifin
dex=ifp->ifindex;if(!local){dst_alen=4;//TODO:hardcodedaddattr_l(&req.n,sizeof(r
eq),NDA_DST,&vtep_ip,dst_alen);dst_present=1;sprintf(dst_buf,"dst%s",inet_ntoa(v
tep_ip));}br_zif=(structzebra_if*)br_if->info;if(IS_ZEBRA_IF_BRIDGE_VLAN_AWARE(b
r_zif)&&vid>0){addattr16(&req.n,sizeof(req),NDA_VLAN,vid);vid_present=1;sprintf(
vid_buf,"VLAN%u",vid);}addattr32(&req.n,sizeof(req),NDA_MASTER,br_if->ifindex);i
f(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("Tx%sfamily%sIF%s(%u)%s%sMAC%s%s",nl_msg_type
_to_str(cmd),nl_family_to_str(req.ndm.ndm_family),ifp->name,ifp->ifindex,vid_pre
sent?vid_buf:"",sticky?"sticky":"",prefix_mac2str(mac,buf,sizeof(buf)),dst_prese
nt?dst_buf:"");returnnetlink_talk(netlink_talk_filter,&req.n,&zns->netlink_cmd,z
ns,0);}#defineNUD_VALID\(NUD_PERMANENT|NUD_NOARP|NUD_REACHABLE|NUD_PROBE|NUD_STA
LE\|NUD_DELAY)staticintnetlink_ipneigh_change(structsockaddr_nl*snl,structnlmsgh
dr*h,intlen,ns_id_tns_id){structndmsg*ndm;structinterface*ifp;structzebra_if*zif
;structrtattr*tb[NDA_MAX+1];structinterface*link_if;structethaddrmac;structipadd
rip;charbuf[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];intmac_present=0;uint8
_text_learned;ndm=NLMSG_DATA(h);/*WeonlyprocessneighnotificationsifEVPNisenabled
*/if(!is_evpn_enabled())return0;/*Theinterfaceshouldexist.*/ifp=if_lookup_by_ind
ex_per_ns(zebra_ns_lookup(ns_id),ndm->ndm_ifindex);if(!ifp||!ifp->info)return0;/
*Drop"permanent"entries.*/if(ndm->ndm_state&NUD_PERMANENT)return0;zif=(structzeb
ra_if*)ifp->info;/*TheneighborispresentonanSVI.Fromthis,welocatethe*underlying*b
ridgebecausewe'reonlyinterestedinneighborsonaVxLANbridge.*Thebridgeislocatedbase
donthenatureoftheSVI:*(a)InthecaseofaVLAN-awarebridge,theSVIisaL3VLAN*interface*
andislinkedtothebridge*(b)InthecaseofaVLAN-unawarebridge,theSVIisthebridge*intef
ace*itself*/if(IS_ZEBRA_IF_VLAN(ifp)){link_if=if_lookup_by_index_per_ns(zebra_ns
_lookup(ns_id),zif->link_ifindex);if(!link_if)return0;}elseif(IS_ZEBRA_IF_BRIDGE
(ifp))link_if=ifp;elsereturn0;/*Parseattributesandextractfieldsofinterest.*/mems
et(tb,0,sizeoftb);netlink_parse_rtattr(tb,NDA_MAX,NDA_RTA(ndm),len);if(!tb[NDA_D
ST]){zlog_warn("%sfamily%sIF%s(%u)-noDST",nl_msg_type_to_str(h->nlmsg_type),nl_f
amily_to_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex);return0;}memset(&mac,0
,sizeof(structethaddr));memset(&ip,0,sizeof(structipaddr));ip.ipa_type=(ndm->ndm
_family==AF_INET)?IPADDR_V4:IPADDR_V6;memcpy(&ip.ip.addr,RTA_DATA(tb[NDA_DST]),R
TA_PAYLOAD(tb[NDA_DST]));if(h->nlmsg_type==RTM_NEWNEIGH){if(tb[NDA_LLADDR]){if(R
TA_PAYLOAD(tb[NDA_LLADDR])!=ETH_ALEN){zlog_warn("%sfamily%sIF%s(%u)-LLADDRisnotM
AC,len%lu",nl_msg_type_to_str(h->nlmsg_type),nl_family_to_str(ndm->ndm_family),i
fp->name,ndm->ndm_ifindex,(unsignedlong)RTA_PAYLOAD(tb[NDA_LLADDR]));return0;}ma
c_present=1;memcpy(&mac,RTA_DATA(tb[NDA_LLADDR]),ETH_ALEN);}ext_learned=(ndm->nd
m_flags&NTF_EXT_LEARNED)?1:0;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("Rx%sfamily%sIF
%s(%u)IP%sMAC%sstate0x%xflags0x%x",nl_msg_type_to_str(h->nlmsg_type),nl_family_t
o_str(ndm->ndm_family),ifp->name,ndm->ndm_ifindex,ipaddr2str(&ip,buf2,sizeof(buf
2)),mac_present?prefix_mac2str(&mac,buf,sizeof(buf)):"",ndm->ndm_state,ndm->ndm_
flags);/*Iftheneighborstateisvalidforuse,processasanaddor*update*elseprocessasad
elete.Notethatthedeletehandlingmay*result*inre-addingtheneighborifitisavalid"rem
ote"neighbor.*/if(ndm->ndm_state&NUD_VALID)returnzebra_vxlan_local_neigh_add_upd
ate(ifp,link_if,&ip,&mac,ndm->ndm_state,ext_learned);returnzebra_vxlan_local_nei
gh_del(ifp,link_if,&ip);}if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("Rx%sfamily%sIF%s(%
u)IP%s",nl_msg_type_to_str(h->nlmsg_type),nl_family_to_str(ndm->ndm_family),ifp-
>name,ndm->ndm_ifindex,ipaddr2str(&ip,buf2,sizeof(buf2)));/*Processthedelete-itm
ayresultinre-addingtheneighborifitis*avalid"remote"neighbor.*/returnzebra_vxlan_
local_neigh_del(ifp,link_if,&ip);}staticintnetlink_neigh_table(structsockaddr_nl
*snl,structnlmsghdr*h,ns_id_tns_id,intstartup){intlen;structndmsg*ndm;if(h->nlms
g_type!=RTM_NEWNEIGH)return0;/*Lengthvalidity.*/len=h->nlmsg_len-NLMSG_LENGTH(si
zeof(structndmsg));if(len<0)return-1;/*WeareinterestedonlyinAF_INETorAF_INET6not
ifications.*/ndm=NLMSG_DATA(h);if(ndm->ndm_family!=AF_INET&&ndm->ndm_family!=AF_
INET6)return0;returnnetlink_neigh_change(snl,h,len);}/*RequestforIPneighborinfor
mationfromthekernel*/staticintnetlink_request_neigh(structzebra_ns*zns,intfamily
,inttype,ifindex_tifindex){struct{structnlmsghdrn;structndmsgndm;charbuf[256];}r
eq;/*Formtherequest,specifyingfilter(rtattr)ifneeded.*/memset(&req,0,sizeof(req)
);req.n.nlmsg_type=type;req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structndmsg));req.nd
m.ndm_family=family;if(ifindex)addattr32(&req.n,sizeof(req),NDA_IFINDEX,ifindex)
;returnnetlink_request(&zns->netlink_cmd,&req.n);}/**IPNeighbortablereadusingnet
linkinterface.Thisisinvoked*atstartup.*/intnetlink_neigh_read(structzebra_ns*zns
){intret;/*GetIPneighbortable.*/ret=netlink_request_neigh(zns,AF_UNSPEC,RTM_GETN
EIGH,0);if(ret<0)returnret;ret=netlink_parse_info(netlink_neigh_table,&zns->netl
ink_cmd,zns,0,1);returnret;}/**IPNeighbortablereadusingnetlinkinterface.Thisisfo
raspecific*VLANdevice.*/intnetlink_neigh_read_for_vlan(structzebra_ns*zns,struct
interface*vlan_if){intret=0;ret=netlink_request_neigh(zns,AF_UNSPEC,RTM_GETNEIGH
,vlan_if->ifindex);if(ret<0)returnret;ret=netlink_parse_info(netlink_neigh_table
,&zns->netlink_cmd,zns,0,0);returnret;}intnetlink_neigh_change(structsockaddr_nl
*snl,structnlmsghdr*h,ns_id_tns_id){intlen;structndmsg*ndm;if(!(h->nlmsg_type==R
TM_NEWNEIGH||h->nlmsg_type==RTM_DELNEIGH))return0;/*Lengthvalidity.*/len=h->nlms
g_len-NLMSG_LENGTH(sizeof(structndmsg));if(len<0)return-1;/*Isthisanotificationf
ortheMACFDBorIPneighbortable?*/ndm=NLMSG_DATA(h);if(ndm->ndm_family==AF_BRIDGE)r
eturnnetlink_macfdb_change(snl,h,len,ns_id);if(ndm->ndm_type!=RTN_UNICAST)return
0;if(ndm->ndm_family==AF_INET||ndm->ndm_family==AF_INET6)returnnetlink_ipneigh_c
hange(snl,h,len,ns_id);return0;}staticintnetlink_neigh_update2(structinterface*i
fp,structipaddr*ip,structethaddr*mac,uint32_tflags,intcmd){struct{structnlmsghdr
n;structndmsgndm;charbuf[256];}req;intipa_len;structzebra_ns*zns;charbuf[INET6_A
DDRSTRLEN];charbuf2[ETHER_ADDR_STRLEN];structzebra_vrf*zvrf=zebra_vrf_lookup_by_
id(ifp->vrf_id);zns=zvrf->zns;memset(&req.n,0,sizeof(req.n));memset(&req.ndm,0,s
izeof(req.ndm));req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structndmsg));req.n.nlmsg_fl
ags=NLM_F_REQUEST;if(cmd==RTM_NEWNEIGH)req.n.nlmsg_flags|=(NLM_F_CREATE|NLM_F_RE
PLACE);req.n.nlmsg_type=cmd;//RTM_NEWNEIGHorRTM_DELNEIGHreq.ndm.ndm_family=IS_IP
ADDR_V4(ip)?AF_INET:AF_INET6;req.ndm.ndm_state=flags;req.ndm.ndm_ifindex=ifp->if
index;req.ndm.ndm_type=RTN_UNICAST;req.ndm.ndm_flags=NTF_EXT_LEARNED;ipa_len=IS_
IPADDR_V4(ip)?IPV4_MAX_BYTELEN:IPV6_MAX_BYTELEN;addattr_l(&req.n,sizeof(req),NDA
_DST,&ip->ip.addr,ipa_len);if(mac)addattr_l(&req.n,sizeof(req),NDA_LLADDR,mac,6)
;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("Tx%sfamily%sIF%s(%u)Neigh%sMAC%s",nl_msg_t
ype_to_str(cmd),nl_family_to_str(req.ndm.ndm_family),ifp->name,ifp->ifindex,ipad
dr2str(ip,buf,sizeof(buf)),mac?prefix_mac2str(mac,buf2,sizeof(buf2)):"null");ret
urnnetlink_talk(netlink_talk_filter,&req.n,&zns->netlink_cmd,zns,0);}intkernel_a
dd_mac(structinterface*ifp,vlanid_tvid,structethaddr*mac,structin_addrvtep_ip,ui
nt8_tsticky){returnnetlink_macfdb_update(ifp,vid,mac,vtep_ip,0,RTM_NEWNEIGH,stic
ky);}intkernel_del_mac(structinterface*ifp,vlanid_tvid,structethaddr*mac,structi
n_addrvtep_ip,intlocal){returnnetlink_macfdb_update(ifp,vid,mac,vtep_ip,local,RT
M_DELNEIGH,0);}intkernel_add_neigh(structinterface*ifp,structipaddr*ip,structeth
addr*mac){returnnetlink_neigh_update2(ifp,ip,mac,NUD_REACHABLE,RTM_NEWNEIGH);}in
tkernel_del_neigh(structinterface*ifp,structipaddr*ip){returnnetlink_neigh_updat
e2(ifp,ip,NULL,0,RTM_DELNEIGH);}/**MPLSlabelforwardingtablechangevianetlinkinter
face.*/intnetlink_mpls_multipath(intcmd,zebra_lsp_t*lsp){mpls_lse_tlse;zebra_nhl
fe_t*nhlfe;structnexthop*nexthop=NULL;unsignedintnexthop_num;constchar*routedesc
;structzebra_ns*zns=zebra_ns_lookup(NS_DEFAULT);introute_type;struct{structnlmsg
hdrn;structrtmsgr;charbuf[NL_PKT_BUF_SIZE];}req;memset(&req,0,sizeofreq-NL_PKT_B
UF_SIZE);/**Count#nexthopssowecandecidewhethertousesinglepath*ormultipathcase.*/
nexthop_num=0;for(nhlfe=lsp->nhlfe_list;nhlfe;nhlfe=nhlfe->next){nexthop=nhlfe->
nexthop;if(!nexthop)continue;if(cmd==RTM_NEWROUTE){/*CountallselectedNHLFEs*/if(
CHECK_FLAG(nhlfe->flags,NHLFE_FLAG_SELECTED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_
FLAG_ACTIVE))nexthop_num++;}else/*DEL*/{/*CountallinstalledNHLFEs*/if(CHECK_FLAG
(nhlfe->flags,NHLFE_FLAG_INSTALLED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)
)nexthop_num++;}}if((nexthop_num==0)||(!lsp->best_nhlfe&&(cmd!=RTM_DELROUTE)))re
turn0;req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structrtmsg));req.n.nlmsg_flags=NLM_F_
CREATE|NLM_F_REQUEST;req.n.nlmsg_type=cmd;req.n.nlmsg_pid=zns->netlink_cmd.snl.n
l_pid;req.r.rtm_family=AF_MPLS;req.r.rtm_table=RT_TABLE_MAIN;req.r.rtm_dst_len=M
PLS_LABEL_LEN_BITS;req.r.rtm_scope=RT_SCOPE_UNIVERSE;req.r.rtm_type=RTN_UNICAST;
if(cmd==RTM_NEWROUTE){/*Wedoareplacetohandleupdate.*/req.n.nlmsg_flags|=NLM_F_RE
PLACE;/*settheprotocolvalueifinstalling*/route_type=re_type_from_lsp_type(lsp->b
est_nhlfe->type);req.r.rtm_protocol=zebra2proto(route_type);}/*Filldestination*/
lse=mpls_lse_encode(lsp->ile.in_label,0,0,1);addattr_l(&req.n,sizeofreq,RTA_DST,
&lse,sizeof(mpls_lse_t));/*Fillnexthops(paths)basedonsingle-pathormultipath.Thep
aths*chosendependontheoperation.*/if(nexthop_num==1||multipath_num==1){routedesc
="single-path";_netlink_mpls_debug(cmd,lsp->ile.in_label,routedesc);nexthop_num=
0;for(nhlfe=lsp->nhlfe_list;nhlfe;nhlfe=nhlfe->next){nexthop=nhlfe->nexthop;if(!
nexthop)continue;if((cmd==RTM_NEWROUTE&&(CHECK_FLAG(nhlfe->flags,NHLFE_FLAG_SELE
CTED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE)))||(cmd==RTM_DELROUTE&&(CH
ECK_FLAG(nhlfe->flags,NHLFE_FLAG_INSTALLED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_F
LAG_FIB)))){/*Addthegateway*/_netlink_mpls_build_singlepath(routedesc,nhlfe,&req
.n,&req.r,sizeofreq,cmd);nexthop_num++;break;}}}else/*Multipathcase*/{charbuf[NL
_PKT_BUF_SIZE];structrtattr*rta=(void*)buf;structrtnexthop*rtnh;uniong_addr*src1
=NULL;rta->rta_type=RTA_MULTIPATH;rta->rta_len=RTA_LENGTH(0);rtnh=RTA_DATA(rta);
routedesc="multipath";_netlink_mpls_debug(cmd,lsp->ile.in_label,routedesc);nexth
op_num=0;for(nhlfe=lsp->nhlfe_list;nhlfe;nhlfe=nhlfe->next){nexthop=nhlfe->nexth
op;if(!nexthop)continue;if(nexthop_num>=multipath_num)break;if((cmd==RTM_NEWROUT
E&&(CHECK_FLAG(nhlfe->flags,NHLFE_FLAG_SELECTED)&&CHECK_FLAG(nexthop->flags,NEXT
HOP_FLAG_ACTIVE)))||(cmd==RTM_DELROUTE&&(CHECK_FLAG(nhlfe->flags,NHLFE_FLAG_INST
ALLED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)))){nexthop_num++;/*Buildthem
ultipath*/_netlink_mpls_build_multipath(routedesc,nhlfe,rta,rtnh,&req.r,&src1);r
tnh=RTNH_NEXT(rtnh);}}/*Addthemultipath*/if(rta->rta_len>RTA_LENGTH(0))addattr_l
(&req.n,NL_PKT_BUF_SIZE,RTA_MULTIPATH,RTA_DATA(rta),RTA_PAYLOAD(rta));}/*Talkton
etlinksocket.*/returnnetlink_talk(netlink_talk_filter,&req.n,&zns->netlink_cmd,z
ns,0);}#endif/*HAVE_NETLINK*/