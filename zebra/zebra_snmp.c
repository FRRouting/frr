/*FIBSNMP.*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebra.**GNUZebra
isfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPu
blicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroptio
n)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOU
TANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICU
LARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceiveda
copyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,wr
itetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301
USA*//**CurrentlySNMPisonlyrunningproperlyforMIBsinthedefaultVRF.*/#include<zebr
a.h>#include<net-snmp/net-snmp-config.h>#include<net-snmp/net-snmp-includes.h>#i
nclude"if.h"#include"log.h"#include"prefix.h"#include"command.h"#include"smux.h"
#include"table.h"#include"vrf.h"#include"hook.h"#include"libfrr.h"#include"versi
on.h"#include"zebra/rib.h"#include"zebra/zserv.h"#include"zebra/zebra_vrf.h"#def
ineIPFWMIB1,3,6,1,2,1,4,24/*ipForwardTable*/#defineIPFORWARDDEST1#defineIPFORWAR
DMASK2#defineIPFORWARDPOLICY3#defineIPFORWARDNEXTHOP4#defineIPFORWARDIFINDEX5#de
fineIPFORWARDTYPE6#defineIPFORWARDPROTO7#defineIPFORWARDAGE8#defineIPFORWARDINFO
9#defineIPFORWARDNEXTHOPAS10#defineIPFORWARDMETRIC111#defineIPFORWARDMETRIC212#d
efineIPFORWARDMETRIC313#defineIPFORWARDMETRIC414#defineIPFORWARDMETRIC515/*ipCid
rRouteTable*/#defineIPCIDRROUTEDEST1#defineIPCIDRROUTEMASK2#defineIPCIDRROUTETOS
3#defineIPCIDRROUTENEXTHOP4#defineIPCIDRROUTEIFINDEX5#defineIPCIDRROUTETYPE6#def
ineIPCIDRROUTEPROTO7#defineIPCIDRROUTEAGE8#defineIPCIDRROUTEINFO9#defineIPCIDRRO
UTENEXTHOPAS10#defineIPCIDRROUTEMETRIC111#defineIPCIDRROUTEMETRIC212#defineIPCID
RROUTEMETRIC313#defineIPCIDRROUTEMETRIC414#defineIPCIDRROUTEMETRIC515#defineIPCI
DRROUTESTATUS16#defineINTEGER32ASN_INTEGER#defineGAUGE32ASN_GAUGE#defineENUMERAT
IONASN_INTEGER#defineROWSTATUSASN_INTEGER#defineIPADDRESSASN_IPADDRESS#defineOBJ
ECTIDENTIFIERASN_OBJECT_IDstaticoidipfw_oid[]={IPFWMIB};/*Hookfunctions.*/static
uint8_t*ipFwNumber(structvariable*,oid[],size_t*,int,size_t*,WriteMethod**);stat
icuint8_t*ipFwTable(structvariable*,oid[],size_t*,int,size_t*,WriteMethod**);sta
ticuint8_t*ipCidrNumber(structvariable*,oid[],size_t*,int,size_t*,WriteMethod**)
;staticuint8_t*ipCidrTable(structvariable*,oid[],size_t*,int,size_t*,WriteMethod
**);staticstructvariablezebra_variables[]={{0,GAUGE32,RONLY,ipFwNumber,1,{1}},{I
PFORWARDDEST,IPADDRESS,RONLY,ipFwTable,3,{2,1,1}},{IPFORWARDMASK,IPADDRESS,RONLY
,ipFwTable,3,{2,1,2}},{IPFORWARDPOLICY,INTEGER32,RONLY,ipFwTable,3,{2,1,3}},{IPF
ORWARDNEXTHOP,IPADDRESS,RONLY,ipFwTable,3,{2,1,4}},{IPFORWARDIFINDEX,INTEGER32,R
ONLY,ipFwTable,3,{2,1,5}},{IPFORWARDTYPE,ENUMERATION,RONLY,ipFwTable,3,{2,1,6}},
{IPFORWARDPROTO,ENUMERATION,RONLY,ipFwTable,3,{2,1,7}},{IPFORWARDAGE,INTEGER32,R
ONLY,ipFwTable,3,{2,1,8}},{IPFORWARDINFO,OBJECTIDENTIFIER,RONLY,ipFwTable,3,{2,1
,9}},{IPFORWARDNEXTHOPAS,INTEGER32,RONLY,ipFwTable,3,{2,1,10}},{IPFORWARDMETRIC1
,INTEGER32,RONLY,ipFwTable,3,{2,1,11}},{IPFORWARDMETRIC2,INTEGER32,RONLY,ipFwTab
le,3,{2,1,12}},{IPFORWARDMETRIC3,INTEGER32,RONLY,ipFwTable,3,{2,1,13}},{IPFORWAR
DMETRIC4,INTEGER32,RONLY,ipFwTable,3,{2,1,14}},{IPFORWARDMETRIC5,INTEGER32,RONLY
,ipFwTable,3,{2,1,15}},{0,GAUGE32,RONLY,ipCidrNumber,1,{3}},{IPCIDRROUTEDEST,IPA
DDRESS,RONLY,ipCidrTable,3,{4,1,1}},{IPCIDRROUTEMASK,IPADDRESS,RONLY,ipCidrTable
,3,{4,1,2}},{IPCIDRROUTETOS,INTEGER32,RONLY,ipCidrTable,3,{4,1,3}},{IPCIDRROUTEN
EXTHOP,IPADDRESS,RONLY,ipCidrTable,3,{4,1,4}},{IPCIDRROUTEIFINDEX,INTEGER32,RONL
Y,ipCidrTable,3,{4,1,5}},{IPCIDRROUTETYPE,ENUMERATION,RONLY,ipCidrTable,3,{4,1,6
}},{IPCIDRROUTEPROTO,ENUMERATION,RONLY,ipCidrTable,3,{4,1,7}},{IPCIDRROUTEAGE,IN
TEGER32,RONLY,ipCidrTable,3,{4,1,8}},{IPCIDRROUTEINFO,OBJECTIDENTIFIER,RONLY,ipC
idrTable,3,{4,1,9}},{IPCIDRROUTENEXTHOPAS,INTEGER32,RONLY,ipCidrTable,3,{4,1,10}
},{IPCIDRROUTEMETRIC1,INTEGER32,RONLY,ipCidrTable,3,{4,1,11}},{IPCIDRROUTEMETRIC
2,INTEGER32,RONLY,ipCidrTable,3,{4,1,12}},{IPCIDRROUTEMETRIC3,INTEGER32,RONLY,ip
CidrTable,3,{4,1,13}},{IPCIDRROUTEMETRIC4,INTEGER32,RONLY,ipCidrTable,3,{4,1,14}
},{IPCIDRROUTEMETRIC5,INTEGER32,RONLY,ipCidrTable,3,{4,1,15}},{IPCIDRROUTESTATUS
,ROWSTATUS,RONLY,ipCidrTable,3,{4,1,16}}};staticuint8_t*ipFwNumber(structvariabl
e*v,oidobjid[],size_t*objid_len,intexact,size_t*val_len,WriteMethod**write_metho
d){staticintresult;structroute_table*table;structroute_node*rn;structroute_entry
*re;if(smux_header_generic(v,objid,objid_len,exact,val_len,write_method)==MATCH_
FAILED)returnNULL;table=zebra_vrf_table(AFI_IP,SAFI_UNICAST,VRF_DEFAULT);if(!tab
le)returnNULL;/*Returnnumberofroutingentries.*/result=0;for(rn=route_top(table);
rn;rn=route_next(rn))RNODE_FOREACH_RE(rn,re){result++;}return(uint8_t*)&result;}
staticuint8_t*ipCidrNumber(structvariable*v,oidobjid[],size_t*objid_len,intexact
,size_t*val_len,WriteMethod**write_method){staticintresult;structroute_table*tab
le;structroute_node*rn;structroute_entry*re;if(smux_header_generic(v,objid,objid
_len,exact,val_len,write_method)==MATCH_FAILED)returnNULL;table=zebra_vrf_table(
AFI_IP,SAFI_UNICAST,VRF_DEFAULT);if(!table)return0;/*Returnnumberofroutingentrie
s.*/result=0;for(rn=route_top(table);rn;rn=route_next(rn))RNODE_FOREACH_RE(rn,re
){result++;}return(uint8_t*)&result;}staticintin_addr_cmp(uint8_t*p1,uint8_t*p2)
{inti;for(i=0;i<4;i++){if(*p1<*p2)return-1;if(*p1>*p2)return1;p1++;p2++;}return0
;}staticintin_addr_add(uint8_t*p,intnum){inti,ip0;ip0=*p;p+=4;for(i=3;0<=i;i--){
p--;if(*p+num>255){*p+=num;num=1;}else{*p+=num;return1;}}if(ip0>*p){/*ip+num>0xf
fffffff*/return0;}return1;}staticintproto_trans(inttype){switch(type){caseZEBRA_
ROUTE_SYSTEM:return1;/*other*/caseZEBRA_ROUTE_KERNEL:return1;/*other*/caseZEBRA_
ROUTE_CONNECT:return2;/*localinterface*/caseZEBRA_ROUTE_STATIC:return3;/*staticr
oute*/caseZEBRA_ROUTE_RIP:return8;/*rip*/caseZEBRA_ROUTE_RIPNG:return1;/*shouldn
'thappen*/caseZEBRA_ROUTE_OSPF:return13;/*ospf*/caseZEBRA_ROUTE_OSPF6:return1;/*
shouldn'thappen*/caseZEBRA_ROUTE_BGP:return14;/*bgp*/default:return1;/*other*/}}
staticvoidcheck_replace(structroute_node*np2,structroute_entry*re2,structroute_n
ode**np,structroute_entry**re){intproto,proto2;if(!*np){*np=np2;*re=re2;return;}
if(in_addr_cmp(&(*np)->p.u.prefix,&np2->p.u.prefix)<0)return;if(in_addr_cmp(&(*n
p)->p.u.prefix,&np2->p.u.prefix)>0){*np=np2;*re=re2;return;}proto=proto_trans((*
re)->type);proto2=proto_trans(re2->type);if(proto2>proto)return;if(proto2<proto)
{*np=np2;*re=re2;return;}if(in_addr_cmp((uint8_t*)&(*re)->ng.nexthop->gate.ipv4,
(uint8_t*)&re2->ng.nexthop->gate.ipv4)<=0)return;*np=np2;*re=re2;return;}staticv
oidget_fwtable_route_node(structvariable*v,oidobjid[],size_t*objid_len,intexact,
structroute_node**np,structroute_entry**re){structin_addrdest;structroute_table*
table;structroute_node*np2;structroute_entry*re2;intproto;intpolicy;structin_add
rnexthop;uint8_t*pnt;inti;/*Initindexvariables*/pnt=(uint8_t*)&dest;for(i=0;i<4;
i++)*pnt++=0;pnt=(uint8_t*)&nexthop;for(i=0;i<4;i++)*pnt++=0;proto=0;policy=0;/*
Initreturnvariables*/*np=NULL;*re=NULL;/*Shortcircuitexactmatchesofwronglength*/
if(exact&&(*objid_len!=(unsigned)v->namelen+10))return;table=zebra_vrf_table(AFI
_IP,SAFI_UNICAST,VRF_DEFAULT);if(!table)return;/*GetINDEXinformationoutofOID.*ip
ForwardDest,ipForwardProto,ipForwardPolicy,ipForwardNextHop*/if(*objid_len>(unsi
gned)v->namelen)oid2in_addr(objid+v->namelen,MIN(4U,*objid_len-v->namelen),&dest
);if(*objid_len>(unsigned)v->namelen+4)proto=objid[v->namelen+4];if(*objid_len>(
unsigned)v->namelen+5)policy=objid[v->namelen+5];if(*objid_len>(unsigned)v->name
len+6)oid2in_addr(objid+v->namelen+6,MIN(4U,*objid_len-v->namelen-6),&nexthop);/
*ApplyGETNEXTonnotexactsearch*/if(!exact&&(*objid_len>=(unsigned)v->namelen+10))
{if(!in_addr_add((uint8_t*)&nexthop,1))return;}/*Forexact:searchmatchingentryinr
ibtable.*/if(exact){if(policy)/*Notsupported(yet?)*/return;for(*np=route_top(tab
le);*np;*np=route_next(*np)){if(!in_addr_cmp(&(*np)->p.u.prefix,(uint8_t*)&dest)
){RNODE_FOREACH_RE(*np,*re){if(!in_addr_cmp((uint8_t*)&(*re)->ng.nexthop->gate.i
pv4,(uint8_t*)&nexthop))if(proto==proto_trans((*re)->type))return;}}}return;}/*S
earchnextbestentry*/for(np2=route_top(table);np2;np2=route_next(np2)){/*Checkdes
tinationfirst*/if(in_addr_cmp(&np2->p.u.prefix,(uint8_t*)&dest)>0)RNODE_FOREACH_
RE(np2,re2){check_replace(np2,re2,np,re);}if(in_addr_cmp(&np2->p.u.prefix,(uint8
_t*)&dest)==0){/*havetolookateachreindividually*/RNODE_FOREACH_RE(np2,re2){intpr
oto2,policy2;proto2=proto_trans(re2->type);policy2=0;if((policy<policy2)||((poli
cy==policy2)&&(proto<proto2))||((policy==policy2)&&(proto==proto2)&&(in_addr_cmp
((uint8_t*)&re2->ng.nexthop->gate.ipv4,(uint8_t*)&nexthop)>=0)))check_replace(np
2,re2,np,re);}}}if(!*re)return;policy=0;proto=proto_trans((*re)->type);*objid_le
n=v->namelen+10;pnt=(uint8_t*)&(*np)->p.u.prefix;for(i=0;i<4;i++)objid[v->namele
n+i]=*pnt++;objid[v->namelen+4]=proto;objid[v->namelen+5]=policy;{structnexthop*
nexthop;nexthop=(*re)->ng.nexthop;if(nexthop){pnt=(uint8_t*)&nexthop->gate.ipv4;
for(i=0;i<4;i++)objid[i+v->namelen+6]=*pnt++;}}return;}staticuint8_t*ipFwTable(s
tructvariable*v,oidobjid[],size_t*objid_len,intexact,size_t*val_len,WriteMethod*
*write_method){structroute_node*np;structroute_entry*re;staticintresult;staticin
tresarr[2];staticstructin_addrnetmask;structnexthop*nexthop;if(smux_header_table
(v,objid,objid_len,exact,val_len,write_method)==MATCH_FAILED)returnNULL;get_fwta
ble_route_node(v,objid,objid_len,exact,&np,&re);if(!np)returnNULL;nexthop=re->ng
.nexthop;if(!nexthop)returnNULL;switch(v->magic){caseIPFORWARDDEST:*val_len=4;re
turn&np->p.u.prefix;break;caseIPFORWARDMASK:masklen2ip(np->p.prefixlen,&netmask)
;*val_len=4;return(uint8_t*)&netmask;break;caseIPFORWARDPOLICY:result=0;*val_len
=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDNEXTHOP:*val_len=4;retur
n(uint8_t*)&nexthop->gate.ipv4;break;caseIPFORWARDIFINDEX:*val_len=sizeof(int);r
eturn(uint8_t*)&nexthop->ifindex;break;caseIPFORWARDTYPE:if(nexthop->type==NEXTH
OP_TYPE_IFINDEX)result=3;elseresult=4;*val_len=sizeof(int);return(uint8_t*)&resu
lt;break;caseIPFORWARDPROTO:result=proto_trans(re->type);*val_len=sizeof(int);re
turn(uint8_t*)&result;break;caseIPFORWARDAGE:result=0;*val_len=sizeof(int);retur
n(uint8_t*)&result;break;caseIPFORWARDINFO:resarr[0]=0;resarr[1]=0;*val_len=2*si
zeof(int);return(uint8_t*)resarr;break;caseIPFORWARDNEXTHOPAS:result=-1;*val_len
=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDMETRIC1:result=0;*val_le
n=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDMETRIC2:result=0;*val_l
en=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDMETRIC3:result=0;*val_
len=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDMETRIC4:result=0;*val
_len=sizeof(int);return(uint8_t*)&result;break;caseIPFORWARDMETRIC5:result=0;*va
l_len=sizeof(int);return(uint8_t*)&result;break;default:returnNULL;break;}return
NULL;}staticuint8_t*ipCidrTable(structvariable*v,oidobjid[],size_t*objid_len,int
exact,size_t*val_len,WriteMethod**write_method){if(smux_header_table(v,objid,obj
id_len,exact,val_len,write_method)==MATCH_FAILED)returnNULL;switch(v->magic){cas
eIPCIDRROUTEDEST:break;default:returnNULL;break;}returnNULL;}staticintzebra_snmp
_init(structthread_master*tm){smux_init(tm);REGISTER_MIB("mibII/ipforward",zebra
_variables,variable,ipfw_oid);return0;}staticintzebra_snmp_module_init(void){hoo
k_register(frr_late_init,zebra_snmp_init);return0;}FRR_MODULE_SETUP(.name="zebra
_snmp",.version=FRR_VERSION,.description="zebraAgentXSNMPmodule",.init=zebra_snm
p_module_init,)