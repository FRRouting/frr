/**LabelManagerforFRR**Copyright(C)2017byBingenEguzkitza,*VoltaNetworksInc.**Thi
sfileispartofFreeRangeRouting(FRR)**FRRisfreesoftware;youcanredistributeitand/or
modifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareF
oundation;eitherversion2,or(atyouroption)any*laterversion.**FRRisdistributedinth
ehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*M
ERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformo
redetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthis
program;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Frankli
nSt,FifthFloor,Boston,MA02110-1301USA*/#include<stdio.h>#include<string.h>#inclu
de<sys/types.h>#include"zebra.h"#include"zserv.h"#include"lib/log.h"#include"lib
/memory.h"#include"lib/mpls.h"#include"lib/network.h"#include"lib/stream.h"#incl
ude"lib/zclient.h"#include"lib/libfrr.h"#include"label_manager.h"#defineCONNECTI
ON_DELAY5structlabel_managerlbl_mgr;externstructzebra_privs_tzserv_privs;DEFINE_
MGROUP(LBL_MGR,"LabelManager");DEFINE_MTYPE_STATIC(LBL_MGR,LM_CHUNK,"LabelManage
rChunk");/*Incasethiszebradaemonisnotactingaslabelmanager,*itwillbeaproxytorelay
messagestoexternallabelmanager*Thiszclientthusistoconnecttoit*/staticstructstrea
m*ibuf;staticstructstream*obuf;staticstructzclient*zclient;boollm_is_external;st
aticvoiddelete_label_chunk(void*val){XFREE(MTYPE_LM_CHUNK,val);}staticintrelay_r
esponse_back(structzserv*zserv){intret=0;structstream*src,*dst;uint16_tsize=0;ui
nt8_tmarker;uint8_tversion;vrf_id_tvrf_id;uint16_tresp_cmd;src=zclient->ibuf;dst
=obuf;stream_reset(src);ret=zclient_read_header(src,zclient->sock,&size,&marker,
&version,&vrf_id,&resp_cmd);if(ret<0&&errno!=EAGAIN){zlog_err("%s:ErrorreadingLa
belManagerresponse:%s",__func__,strerror(errno));return-1;}zlog_debug("%s:LabelM
anagerresponsereceived,%dbytes",__func__,size);if(size==0)return-1;/*sendrespons
eback*/stream_copy(dst,src);ret=writen(zserv->sock,src->data,stream_get_endp(src
));if(ret<=0){zlog_err("%s:ErrorsendingLabelManagerresponseback:%s",__func__,str
error(errno));return-1;}zlog_debug("%s:LabelManagerresponse(%dbytes)sentback",__
func__,ret);return0;}staticintlm_zclient_read(structthread*t){structzserv*zserv;
intret;/*Getsockettozebra.*/zserv=THREAD_ARG(t);zclient->t_read=NULL;/*readrespo
nseandsenditback*/ret=relay_response_back(zserv);returnret;}staticintreply_error
(intcmd,structzserv*zserv,vrf_id_tvrf_id){intret;structstream*s;s=stream_new(ZEB
RA_MAX_PACKET_SIZ);zclient_create_header(s,cmd,vrf_id);/*result*/stream_putc(s,1
);/*Writepacketsize.*/stream_putw_at(s,0,stream_get_endp(s));ret=writen(zserv->s
ock,s->data,stream_get_endp(s));stream_free(s);returnret;}/***Receivearequesttog
etorreleasealabelchunkandforwardittoexternal*labelmanager.**It'scalledfromzservi
ncaseit'snotanactuallabelmanager,butjusta*proxy.**@paramcmdTypeofrequest(connect
,getorrelease)*@paramzserv*@return0onsuccess,-1otherwise*/intzread_relay_label_m
anager_request(intcmd,structzserv*zserv,vrf_id_tvrf_id){structstream*src,*dst;in
tret=0;if(zclient->sock<0){zlog_err("%s:Errorrelayinglabelchunkrequest:nozclient
socket",__func__);reply_error(cmd,zserv,vrf_id);return-1;}/*incasethere'sanyinco
mingmessageenqueued,readandforwardit*/while(ret==0)ret=relay_response_back(zserv
);/*Sendrequesttoexternallabelmanager*/src=ibuf;dst=zclient->obuf;stream_copy(ds
t,src);ret=writen(zclient->sock,dst->data,stream_get_endp(dst));if(ret<=0){zlog_
err("%s:Errorrelayinglabelchunkrequest:%s",__func__,strerror(errno));reply_error
(cmd,zserv,vrf_id);return-1;}zlog_debug("%s:Labelchunkrequestrelayed.%dbytessent
",__func__,ret);/*Releaselabelchunkhasnoresponse*/if(cmd==ZEBRA_RELEASE_LABEL_CH
UNK)return0;/*makesurewelistentotheresponse*/if(!zclient->t_read)thread_add_read
(zclient->master,lm_zclient_read,zserv,zclient->sock,&zclient->t_read);return0;}
staticintlm_zclient_connect(structthread*t){zclient->t_connect=NULL;if(zclient->
sock>=0)return0;if(zclient_socket_connect(zclient)<0){zlog_err("Errorconnectings
ynchronouszclient!");thread_add_timer(zebrad.master,lm_zclient_connect,zclient,C
ONNECTION_DELAY,&zclient->t_connect);return-1;}/*makesocketnon-blocking*/if(set_
nonblocking(zclient->sock)<0)zlog_warn("%s:set_nonblocking(%d)failed",__func__,z
client->sock);return0;}/***Functiontoinitializezclientincasethisisnotanactual*la
belmanager,butjustaproxytoanexternalone.**@paramlm_zserv_pathPathtozservsocketof
externallabelmanager*/staticvoidlm_zclient_init(char*lm_zserv_path){if(lm_zserv_
path)frr_zclient_addr(&zclient_addr,&zclient_addr_len,lm_zserv_path);/*Setdefaul
tvalues.*/zclient=zclient_new_notify(zebrad.master,&zclient_options_default);zcl
ient->privs=&zserv_privs;zclient->sock=-1;zclient->t_connect=NULL;lm_zclient_con
nect(NULL);}/***Initlabelmanager(orproxytoanexternalone)*/voidlabel_manager_init
(char*lm_zserv_path){/*thisisanactuallabelmanager*/if(!lm_zserv_path){zlog_debug
("Initializingownlabelmanager");lm_is_external=false;lbl_mgr.lc_list=list_new();
lbl_mgr.lc_list->del=delete_label_chunk;}else{/*it'sactingjustasaproxy*/zlog_deb
ug("Initializingexternallabelmanagerat%s",lm_zserv_path);lm_is_external=true;lm_
zclient_init(lm_zserv_path);}ibuf=stream_new(ZEBRA_MAX_PACKET_SIZ);obuf=stream_n
ew(ZEBRA_MAX_PACKET_SIZ);}/***Corefunction,assignslabelcunks**Itfirstsearchesthr
oughthelisttocheckifthere'soneavailable*(previouslyreleased).Otherwiseitcreatesa
ndassignsanewone**@paramprotoDaemonprotocolofclient,toidentifytheowner*@paramins
tanceInstance,toidentifytheowner*@paramkeepIfset,avoidgarbagecollection*@parasiz
eSizeofthelabelchunk*@returnPointertotheassignedlabelchunk*/structlabel_manager_
chunk*assign_label_chunk(uint8_tproto,unsignedshortinstance,uint8_tkeep,uint32_t
size){structlabel_manager_chunk*lmc;structlistnode*node;/*firstcheckifthere'sone
available*/for(ALL_LIST_ELEMENTS_RO(lbl_mgr.lc_list,node,lmc)){if(lmc->proto==NO
_PROTO&&lmc->end-lmc->start+1==size){lmc->proto=proto;lmc->instance=instance;lmc
->keep=keep;returnlmc;}}/*otherwisecreateanewone*/lmc=XCALLOC(MTYPE_LM_CHUNK,siz
eof(structlabel_manager_chunk));if(!lmc)returnNULL;if(list_isempty(lbl_mgr.lc_li
st))lmc->start=MPLS_LABEL_UNRESERVED_MIN;elselmc->start=((structlabel_manager_ch
unk*)listgetdata(listtail(lbl_mgr.lc_list)))->end+1;if(lmc->start>MPLS_LABEL_UNR
ESERVED_MAX-size+1){zlog_err("Reachedmaxlabels.Start:%u,size:%u",lmc->start,size
);XFREE(MTYPE_LM_CHUNK,lmc);returnNULL;}lmc->end=lmc->start+size-1;lmc->proto=pr
oto;lmc->instance=instance;lmc->keep=keep;listnode_add(lbl_mgr.lc_list,lmc);retu
rnlmc;}/***Corefunction,releasenolongerusedlabelcunks**@paramprotoDaemonprotocol
ofclient,toidentifytheowner*@paraminstanceInstance,toidentifytheowner*@paramstar
tFirstlabelofthechunk*@paramendLastlabelofthechunk*@return0onsuccess,-1otherwise
*/intrelease_label_chunk(uint8_tproto,unsignedshortinstance,uint32_tstart,uint32
_tend){structlistnode*node;structlabel_manager_chunk*lmc;intret=-1;/*checkthatsi
zematches*/zlog_debug("Releasinglabelchunk:%u-%u",start,end);/*findchunkanddisow
n*/for(ALL_LIST_ELEMENTS_RO(lbl_mgr.lc_list,node,lmc)){if(lmc->start!=start)cont
inue;if(lmc->end!=end)continue;if(lmc->proto!=proto||lmc->instance!=instance){zl
og_err("%s:Daemonmismatch!!",__func__);continue;}lmc->proto=NO_PROTO;lmc->instan
ce=0;lmc->keep=0;ret=0;break;}if(ret!=0)zlog_err("%s:Labelchunknotreleased!!",__
func__);returnret;}/***Releaselabelchunksfromaclient.**Calledonclientdisconnecti
onorreconnection.Itonlyreleaseschunks*withemptykeepvalue.**@paramprotoDaemonprot
ocolofclient,toidentifytheowner*@paraminstanceInstance,toidentifytheowner*@retur
nNumberofchunksreleased*/intrelease_daemon_label_chunks(uint8_tproto,unsignedsho
rtinstance){structlistnode*node;structlabel_manager_chunk*lmc;intcount=0;intret;
for(ALL_LIST_ELEMENTS_RO(lbl_mgr.lc_list,node,lmc)){if(lmc->proto==proto&&lmc->i
nstance==instance&&lmc->keep==0){ret=release_label_chunk(lmc->proto,lmc->instanc
e,lmc->start,lmc->end);if(ret==0)count++;}}zlog_debug("%s:Released%dlabelchunks"
,__func__,count);returncount;}voidlabel_manager_close(){list_delete_and_null(&lb
l_mgr.lc_list);stream_free(ibuf);stream_free(obuf);}