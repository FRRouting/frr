/**StaticRoutingInformationcode*Copyright(C)2016CumulusNetworks*DonaldSharp**Thi
sfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodifyit*un
derthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;e
itherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedinthehopetha
titwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTA
BILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetail
s.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;
seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fift
hFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<lib/nexthop.h>#include<
lib/memory.h>#include<lib/srcdest_table.h>#include<lib/if.h>#include"vty.h"#incl
ude"zebra/debug.h"#include"zebra/rib.h"#include"zebra/zserv.h"#include"zebra/zeb
ra_vrf.h"#include"zebra/zebra_static.h"#include"zebra/zebra_rnh.h"#include"zebra
/redistribute.h"#include"zebra/zebra_memory.h"/*Installstaticrouteintorib.*/void
static_install_route(afi_tafi,safi_tsafi,structprefix*p,structprefix_ipv6*src_p,
structstatic_route*si){structroute_entry*re;structroute_node*rn;structroute_tabl
e*table;structprefixnh_p;structnexthop*nexthop=NULL;enumblackhole_typebh_type=0;
/*Lookuptable.*/table=zebra_vrf_table(afi,safi,si->vrf_id);if(!table)return;mems
et(&nh_p,0,sizeof(nh_p));if(si->type==STATIC_BLACKHOLE){switch(si->bh_type){case
STATIC_BLACKHOLE_DROP:caseSTATIC_BLACKHOLE_NULL:bh_type=BLACKHOLE_NULL;break;cas
eSTATIC_BLACKHOLE_REJECT:bh_type=BLACKHOLE_REJECT;break;}}/*Lookupexistingroute*
/rn=srcdest_rnode_get(table,p,src_p);RNODE_FOREACH_RE(rn,re){if(CHECK_FLAG(re->s
tatus,ROUTE_ENTRY_REMOVED))continue;if(re->type==ZEBRA_ROUTE_STATIC&&re->distanc
e==si->distance)break;}if(re){/*iftagvaluechanged,updateoldvalueinRIB*/if(re->ta
g!=si->tag)re->tag=si->tag;/*Samedistancestaticrouteisthere.Updateitwithnewnexth
op.*/route_unlock_node(rn);switch(si->type){caseSTATIC_IPV4_GATEWAY:nexthop=rout
e_entry_nexthop_ipv4_add(re,&si->addr.ipv4,NULL,si->nh_vrf_id);nh_p.family=AF_IN
ET;nh_p.prefixlen=IPV4_MAX_BITLEN;nh_p.u.prefix4=si->addr.ipv4;zebra_register_rn
h_static_nh(si->nh_vrf_id,&nh_p,rn);break;caseSTATIC_IPV4_GATEWAY_IFNAME:nexthop
=route_entry_nexthop_ipv4_ifindex_add(re,&si->addr.ipv4,NULL,si->ifindex,si->nh_
vrf_id);break;caseSTATIC_IFNAME:nexthop=route_entry_nexthop_ifindex_add(re,si->i
findex,si->nh_vrf_id);break;caseSTATIC_BLACKHOLE:nexthop=route_entry_nexthop_bla
ckhole_add(re,bh_type);break;caseSTATIC_IPV6_GATEWAY:nexthop=route_entry_nexthop
_ipv6_add(re,&si->addr.ipv6,si->nh_vrf_id);nh_p.family=AF_INET6;nh_p.prefixlen=I
PV6_MAX_BITLEN;nh_p.u.prefix6=si->addr.ipv6;zebra_register_rnh_static_nh(si->nh_
vrf_id,&nh_p,rn);break;caseSTATIC_IPV6_GATEWAY_IFNAME:nexthop=route_entry_nextho
p_ipv6_ifindex_add(re,&si->addr.ipv6,si->ifindex,si->nh_vrf_id);break;}/*Updatel
abel(s),ifpresent.*/if(si->snh_label.num_labels)nexthop_add_labels(nexthop,ZEBRA
_LSP_STATIC,si->snh_label.num_labels,&si->snh_label.label[0]);if(IS_ZEBRA_DEBUG_
RIB){charbuf[INET6_ADDRSTRLEN];if(IS_ZEBRA_DEBUG_RIB){inet_ntop(p->family,&p->u.
prefix,buf,INET6_ADDRSTRLEN);zlog_debug("%u:%s/%d:Modifyingroutern%p,re%p(type%d
)",si->vrf_id,buf,p->prefixlen,rn,re,re->type);}}re->uptime=time(NULL);/*Schedul
erouteforprocessingorinvokeNHT,asappropriate.*/if(si->type==STATIC_IPV4_GATEWAY|
|si->type==STATIC_IPV6_GATEWAY)zebra_evaluate_rnh(si->nh_vrf_id,nh_p.family,1,RN
H_NEXTHOP_TYPE,&nh_p);elserib_queue_add(rn);}else{/*Thisisnewstaticroute.*/re=XC
ALLOC(MTYPE_RE,sizeof(structroute_entry));re->type=ZEBRA_ROUTE_STATIC;re->instan
ce=0;re->distance=si->distance;re->metric=0;re->mtu=0;re->vrf_id=si->vrf_id;re->
table=(si->vrf_id!=VRF_DEFAULT)?(zebra_vrf_lookup_by_id(si->vrf_id))->table_id:z
ebrad.rtm_table_default;re->nexthop_num=0;re->tag=si->tag;switch(si->type){caseS
TATIC_IPV4_GATEWAY:nexthop=route_entry_nexthop_ipv4_add(re,&si->addr.ipv4,NULL,s
i->nh_vrf_id);nh_p.family=AF_INET;nh_p.prefixlen=IPV4_MAX_BITLEN;nh_p.u.prefix4=
si->addr.ipv4;zebra_register_rnh_static_nh(si->nh_vrf_id,&nh_p,rn);break;caseSTA
TIC_IPV4_GATEWAY_IFNAME:nexthop=route_entry_nexthop_ipv4_ifindex_add(re,&si->add
r.ipv4,NULL,si->ifindex,si->nh_vrf_id);break;caseSTATIC_IFNAME:nexthop=route_ent
ry_nexthop_ifindex_add(re,si->ifindex,si->nh_vrf_id);break;caseSTATIC_BLACKHOLE:
nexthop=route_entry_nexthop_blackhole_add(re,bh_type);break;caseSTATIC_IPV6_GATE
WAY:nexthop=route_entry_nexthop_ipv6_add(re,&si->addr.ipv6,si->nh_vrf_id);nh_p.f
amily=AF_INET6;nh_p.prefixlen=IPV6_MAX_BITLEN;nh_p.u.prefix6=si->addr.ipv6;zebra
_register_rnh_static_nh(si->nh_vrf_id,&nh_p,rn);break;caseSTATIC_IPV6_GATEWAY_IF
NAME:nexthop=route_entry_nexthop_ipv6_ifindex_add(re,&si->addr.ipv6,si->ifindex,
si->nh_vrf_id);break;}/*Updatelabel(s),ifpresent.*/if(si->snh_label.num_labels)n
exthop_add_labels(nexthop,ZEBRA_LSP_STATIC,si->snh_label.num_labels,&si->snh_lab
el.label[0]);if(IS_ZEBRA_DEBUG_RIB){charbuf[INET6_ADDRSTRLEN];if(IS_ZEBRA_DEBUG_
RIB){inet_ntop(p->family,&p->u.prefix,buf,INET6_ADDRSTRLEN);zlog_debug("%u:%s/%d
:Insertingroutern%p,re%p(type%d)",si->vrf_id,buf,p->prefixlen,rn,re,re->type);}}
re->uptime=time(NULL);/*Linkthisretothetree.Scheduleforprocessingorinvoke*NHT,*a
sappropriate.*/if(si->type==STATIC_IPV4_GATEWAY||si->type==STATIC_IPV6_GATEWAY){
rib_addnode(rn,re,0);zebra_evaluate_rnh(si->nh_vrf_id,nh_p.family,1,RNH_NEXTHOP_
TYPE,&nh_p);}elserib_addnode(rn,re,1);}}/*thisworkscorrectlywithIFNAME<>IFINDEXb
ecauseastaticrouteona*non-activeinterfacewillhaveIFINDEX_INTERNALandthuscomparef
alse*/staticintstatic_nexthop_same(structnexthop*nexthop,structstatic_route*si){
if(nexthop->type==NEXTHOP_TYPE_BLACKHOLE&&si->type==STATIC_BLACKHOLE)return1;if(
nexthop->type==NEXTHOP_TYPE_IPV4&&si->type==STATIC_IPV4_GATEWAY&&IPV4_ADDR_SAME(
&nexthop->gate.ipv4,&si->addr.ipv4))return1;elseif(nexthop->type==NEXTHOP_TYPE_I
PV4_IFINDEX&&si->type==STATIC_IPV4_GATEWAY_IFNAME&&IPV4_ADDR_SAME(&nexthop->gate
.ipv4,&si->addr.ipv4)&&nexthop->ifindex==si->ifindex)return1;elseif(nexthop->typ
e==NEXTHOP_TYPE_IFINDEX&&si->type==STATIC_IFNAME&&nexthop->ifindex==si->ifindex)
return1;elseif(nexthop->type==NEXTHOP_TYPE_IPV6&&si->type==STATIC_IPV6_GATEWAY&&
IPV6_ADDR_SAME(&nexthop->gate.ipv6,&si->addr.ipv6))return1;elseif(nexthop->type=
=NEXTHOP_TYPE_IPV6_IFINDEX&&si->type==STATIC_IPV6_GATEWAY_IFNAME&&IPV6_ADDR_SAME
(&nexthop->gate.ipv6,&si->addr.ipv6)&&nexthop->ifindex==si->ifindex)return1;retu
rn0;}/*UninstallstaticroutefromRIB.*/voidstatic_uninstall_route(afi_tafi,safi_ts
afi,structprefix*p,structprefix_ipv6*src_p,structstatic_route*si){structroute_no
de*rn;structroute_entry*re;structnexthop*nexthop;structroute_table*table;structp
refixnh_p;/*Lookuptable.*/table=zebra_vrf_table(afi,safi,si->vrf_id);if(!table)r
eturn;/*Lookupexistingroutewithtypeanddistance.*/rn=srcdest_rnode_lookup(table,p
,src_p);if(!rn)return;RNODE_FOREACH_RE(rn,re){if(CHECK_FLAG(re->status,ROUTE_ENT
RY_REMOVED))continue;if(re->type==ZEBRA_ROUTE_STATIC&&re->distance==si->distance
&&re->tag==si->tag)break;}if(!re){route_unlock_node(rn);return;}/*Lookupnexthop.
*/for(nexthop=re->ng.nexthop;nexthop;nexthop=nexthop->next)if(static_nexthop_sam
e(nexthop,si))break;/*Can'tfindnexthop.*/if(!nexthop){route_unlock_node(rn);retu
rn;}/*Checknexthop.*/if(re->nexthop_num==1)rib_delnode(rn,re);else{/*Markthisnex
thopasinactiveandreinstalltheroute.Then,*delete*thenexthop.Thereisnoneedtore-eva
luatetheroutefor*this*scenario.*/if(IS_ZEBRA_DEBUG_RIB){charbuf[INET6_ADDRSTRLEN
];if(IS_ZEBRA_DEBUG_RIB){inet_ntop(p->family,&p->u.prefix,buf,INET6_ADDRSTRLEN);
zlog_debug("%u:%s/%d:Modifyingroutern%p,re%p(type%d)",si->vrf_id,buf,p->prefixle
n,rn,re,re->type);}}UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);if(CHECK_FLAG
(nexthop->flags,NEXTHOP_FLAG_FIB)){rib_dest_t*dest=rib_dest_from_rnode(rn);/*Ift
hereareotheractivenexthops,doanupdate.*/if(re->nexthop_active_num>1){/*Updaterou
teinkernelifit'sinfib*/if(dest->selected_fib)rib_install_kernel(rn,re,re);/*Upda
teredistributionifit'sselected*/if(CHECK_FLAG(re->flags,ZEBRA_FLAG_SELECTED))red
istribute_update(p,(structprefix*)src_p,re,NULL);}else{/*Removefromredistributei
fselectedroute*becomesinactive*/if(CHECK_FLAG(re->flags,ZEBRA_FLAG_SELECTED))red
istribute_delete(p,(structprefix*)src_p,re);/*Removefromkerneliffibroutebecomes*
inactive*/if(dest->selected_fib)rib_uninstall_kernel(rn,re);}}if(afi==AFI_IP){/*
DeletethenexthopandderegfromNHT*/nh_p.family=AF_INET;nh_p.prefixlen=IPV4_MAX_BIT
LEN;nh_p.u.prefix4=nexthop->gate.ipv4;}else{nh_p.family=AF_INET6;nh_p.prefixlen=
IPV6_MAX_BITLEN;nh_p.u.prefix6=nexthop->gate.ipv6;}route_entry_nexthop_delete(re
,nexthop);zebra_deregister_rnh_static_nh(si->vrf_id,&nh_p,rn);nexthop_free(nexth
op);}/*Unlocknode.*/route_unlock_node(rn);}intstatic_add_route(afi_tafi,safi_tsa
fi,uint8_ttype,structprefix*p,structprefix_ipv6*src_p,uniong_addr*gate,constchar
*ifname,enumstatic_blackhole_typebh_type,route_tag_ttag,uint8_tdistance,structze
bra_vrf*zvrf,structzebra_vrf*nh_zvrf,structstatic_nh_label*snh_label){structrout
e_node*rn;structstatic_route*si;structstatic_route*pp;structstatic_route*cp;stru
ctstatic_route*update=NULL;structroute_table*stable=zvrf->stable[afi][safi];if(!
stable)return-1;if(!gate&&(type==STATIC_IPV4_GATEWAY||type==STATIC_IPV4_GATEWAY_
IFNAME||type==STATIC_IPV6_GATEWAY||type==STATIC_IPV6_GATEWAY_IFNAME))return-1;if
(!ifname&&(type==STATIC_IFNAME||type==STATIC_IPV4_GATEWAY_IFNAME||type==STATIC_I
PV6_GATEWAY_IFNAME))return-1;/*Lookupstaticrouteprefix.*/rn=srcdest_rnode_get(st
able,p,src_p);/*Donothingifthereisasamestaticroute.*/for(si=rn->info;si;si=si->n
ext){if(type==si->type&&(!gate||((afi==AFI_IP&&IPV4_ADDR_SAME(&gate->ipv4,&si->a
ddr.ipv4))||(afi==AFI_IP6&&IPV6_ADDR_SAME(gate,&si->addr.ipv6))))&&(!strcmp(ifna
me?ifname:"",si->ifname))){if((distance==si->distance)&&(tag==si->tag)&&!memcmp(
&si->snh_label,snh_label,sizeof(structstatic_nh_label))&&si->bh_type==bh_type){r
oute_unlock_node(rn);return0;}elseupdate=si;}}/*Distanceortagorlabelchanged,dele
teexistingfirst.*/if(update)static_delete_route(afi,safi,type,p,src_p,gate,ifnam
e,update->tag,update->distance,zvrf,&update->snh_label);/*Makenewstaticroutestru
cture.*/si=XCALLOC(MTYPE_STATIC_ROUTE,sizeof(structstatic_route));si->type=type;
si->distance=distance;si->bh_type=bh_type;si->tag=tag;si->vrf_id=zvrf_id(zvrf);s
i->nh_vrf_id=zvrf_id(nh_zvrf);if(ifname)strlcpy(si->ifname,ifname,sizeof(si->ifn
ame));si->ifindex=IFINDEX_INTERNAL;switch(type){caseSTATIC_IPV4_GATEWAY:caseSTAT
IC_IPV4_GATEWAY_IFNAME:si->addr.ipv4=gate->ipv4;break;caseSTATIC_IPV6_GATEWAY:ca
seSTATIC_IPV6_GATEWAY_IFNAME:si->addr.ipv6=gate->ipv6;break;caseSTATIC_IFNAME:br
eak;}/*Savelabels,ifany.*/memcpy(&si->snh_label,snh_label,sizeof(structstatic_nh
_label));/*Addnewstaticrouteinformationtothetreewithsortbydistancevalueandgatewa
yaddress.*/for(pp=NULL,cp=rn->info;cp;pp=cp,cp=cp->next){if(si->distance<cp->dis
tance)break;if(si->distance>cp->distance)continue;if(si->type==STATIC_IPV4_GATEW
AY&&cp->type==STATIC_IPV4_GATEWAY){if(ntohl(si->addr.ipv4.s_addr)<ntohl(cp->addr
.ipv4.s_addr))break;if(ntohl(si->addr.ipv4.s_addr)>ntohl(cp->addr.ipv4.s_addr))c
ontinue;}}/*Makelinkedlist.*/if(pp)pp->next=si;elsern->info=si;if(cp)cp->prev=si
;si->prev=pp;si->next=cp;/*checkwhetherinterfaceexistsinsystem&installifitdoes*/
if(!ifname)static_install_route(afi,safi,p,src_p,si);else{structinterface*ifp;if
p=if_lookup_by_name(ifname,zvrf_id(nh_zvrf));if(ifp&&ifp->ifindex!=IFINDEX_INTER
NAL){si->ifindex=ifp->ifindex;static_install_route(afi,safi,p,src_p,si);}}return
1;}intstatic_delete_route(afi_tafi,safi_tsafi,uint8_ttype,structprefix*p,structp
refix_ipv6*src_p,uniong_addr*gate,constchar*ifname,route_tag_ttag,uint8_tdistanc
e,structzebra_vrf*zvrf,structstatic_nh_label*snh_label){structroute_node*rn;stru
ctstatic_route*si;structroute_table*stable;/*Lookuptable.*/stable=zebra_vrf_stat
ic_table(afi,safi,zvrf);if(!stable)return-1;/*Lookupstaticrouteprefix.*/rn=srcde
st_rnode_lookup(stable,p,src_p);if(!rn)return0;/*Findsamestaticrouteisthetree*/f
or(si=rn->info;si;si=si->next)if(type==si->type&&(!gate||((afi==AFI_IP&&IPV4_ADD
R_SAME(&gate->ipv4,&si->addr.ipv4))||(afi==AFI_IP6&&IPV6_ADDR_SAME(gate,&si->add
r.ipv6))))&&(!strcmp(ifname?ifname:"",si->ifname))&&(!tag||(tag==si->tag))&&(!sn
h_label->num_labels||!memcmp(&si->snh_label,snh_label,sizeof(structstatic_nh_lab
el))))break;/*Can'tfindstaticroute.*/if(!si){route_unlock_node(rn);return0;}/*Un
installfromrib.*/if(!si->ifname[0]||si->ifindex!=IFINDEX_INTERNAL)static_uninsta
ll_route(afi,safi,p,src_p,si);/*Unlinkstaticroutefromlinkedlist.*/if(si->prev)si
->prev->next=si->next;elsern->info=si->next;if(si->next)si->next->prev=si->prev;
route_unlock_node(rn);/*Freestaticrouteconfiguration.*/XFREE(MTYPE_STATIC_ROUTE,
si);route_unlock_node(rn);return1;}staticvoidstatic_ifindex_update_af(structinte
rface*ifp,boolup,afi_tafi,safi_tsafi){structroute_table*stable;structzebra_vrf*z
vrf=zebra_vrf_lookup_by_id(ifp->vrf_id);structroute_node*rn;structstatic_route*s
i;structprefix*p,*src_pp;structprefix_ipv6*src_p;stable=zebra_vrf_static_table(a
fi,safi,zvrf);if(!stable)return;for(rn=route_top(stable);rn;rn=srcdest_route_nex
t(rn)){srcdest_rnode_prefixes(rn,&p,&src_pp);src_p=(structprefix_ipv6*)src_pp;fo
r(si=rn->info;si;si=si->next){if(!si->ifname[0])continue;if(up){if(strcmp(si->if
name,ifp->name))continue;si->ifindex=ifp->ifindex;static_install_route(afi,safi,
p,src_p,si);}else{if(si->ifindex!=ifp->ifindex)continue;static_uninstall_route(a
fi,safi,p,src_p,si);si->ifindex=IFINDEX_INTERNAL;}}}}/*calledfromif_{add,delete}
_update,i.e.whenifindexbecomes[in]valid*/voidstatic_ifindex_update(structinterfa
ce*ifp,boolup){static_ifindex_update_af(ifp,up,AFI_IP,SAFI_UNICAST);static_ifind
ex_update_af(ifp,up,AFI_IP,SAFI_MULTICAST);static_ifindex_update_af(ifp,up,AFI_I
P6,SAFI_UNICAST);static_ifindex_update_af(ifp,up,AFI_IP6,SAFI_MULTICAST);}