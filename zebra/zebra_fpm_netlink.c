/**Codeforencoding/decodingFPMmessagesthatareinnetlinkformat.**Copyright(C)1997,
98,99KunihiroIshiguro*Copyright(C)2012byOpenSourceRouting.*Copyright(C)2012byInt
ernetSystemsConsortium,Inc.("ISC")**ThisfileispartofGNUZebra.**GNUZebraisfreesof
tware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicen
seaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*lat
erversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRA
NTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOS
E.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyofthe
GNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheF
reeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inc
lude<zebra.h>#ifdefHAVE_NETLINK#include"log.h"#include"rib.h"#include"vty.h"#inc
lude"prefix.h"#include"zebra/zserv.h"#include"zebra/zebra_ns.h"#include"zebra/ze
bra_vrf.h"#include"zebra/kernel_netlink.h"#include"zebra/rt_netlink.h"#include"n
exthop.h"#include"zebra/zebra_fpm_private.h"/**addr_to_a**Returnsstringrepresent
ationofanaddressofthegivenAF.*/staticinlineconstchar*addr_to_a(uint8_taf,void*ad
dr){if(!addr)return"<Noaddress>";switch(af){caseAF_INET:returninet_ntoa(*((struc
tin_addr*)addr));break;caseAF_INET6:returninet6_ntoa(*((structin6_addr*)addr));b
reak;default:return"<AddrinunknownAF>";break;}}/**prefix_addr_to_a**Conviencewra
pperthatreturnsahuman-readablestringforthe*addressinaprefix.*/staticconstchar*pr
efix_addr_to_a(structprefix*prefix){if(!prefix)return"<Noaddress>";returnaddr_to
_a(prefix->family,&prefix->u.prefix);}/**af_addr_size**Thesizeofanaddressinagive
naddressfamily.*/staticsize_taf_addr_size(uint8_taf){switch(af){caseAF_INET:retu
rn4;break;caseAF_INET6:return16;break;default:assert(0);return16;}}/**netlink_nh
_info_t**Holdsinformationaboutasinglenexthopfornetlink.Theseinfo*structuresaretr
ansientandmaycontainpointersintorib*datastructuresforconvenience.*/typedefstruct
netlink_nh_info_t_{uint32_tif_index;uniong_addr*gateway;/**Informationfromthestr
uctnexthopfromwhichthisnhwas*derived.Fordebugpurposesonly.*/intrecursive;enumnex
thop_types_ttype;}netlink_nh_info_t;/**netlink_route_info_t**Astructureforholdin
ginformationforanetlinkroutemessage.*/typedefstructnetlink_route_info_t_{uint16_
tnlmsg_type;uint8_trtm_type;uint32_trtm_table;uint8_trtm_protocol;uint8_taf;stru
ctprefix*prefix;uint32_t*metric;unsignedintnum_nhs;/**Nexthopstructures*/netlink
_nh_info_tnhs[MULTIPATH_NUM];uniong_addr*pref_src;}netlink_route_info_t;/**netli
nk_route_info_add_nh**Addinformationaboutthegivennexthoptothegivenrouteinfo*stru
cture.**ReturnsTRUEifanexthopwasadded,FALSEotherwise.*/staticintnetlink_route_in
fo_add_nh(netlink_route_info_t*ri,structnexthop*nexthop){netlink_nh_info_tnhi;un
iong_addr*src;memset(&nhi,0,sizeof(nhi));src=NULL;if(ri->num_nhs>=(int)ZEBRA_NUM
_OF(ri->nhs))return0;nhi.recursive=nexthop->rparent?1:0;nhi.type=nexthop->type;n
hi.if_index=nexthop->ifindex;if(nexthop->type==NEXTHOP_TYPE_IPV4||nexthop->type=
=NEXTHOP_TYPE_IPV4_IFINDEX){nhi.gateway=&nexthop->gate;if(nexthop->src.ipv4.s_ad
dr)src=&nexthop->src;}if(nexthop->type==NEXTHOP_TYPE_IPV6||nexthop->type==NEXTHO
P_TYPE_IPV6_IFINDEX){nhi.gateway=&nexthop->gate;}if(nexthop->type==NEXTHOP_TYPE_
IFINDEX){if(nexthop->src.ipv4.s_addr)src=&nexthop->src;}if(!nhi.gateway&&nhi.if_
index==0)return0;/**Wehaveavalidnhi.Copythestructureovertotheroute_info.*/ri->nh
s[ri->num_nhs]=nhi;ri->num_nhs++;if(src&&!ri->pref_src)ri->pref_src=src;return1;
}/**netlink_proto_from_route_type*/staticuint8_tnetlink_proto_from_route_type(in
ttype){switch(type){caseZEBRA_ROUTE_KERNEL:caseZEBRA_ROUTE_CONNECT:returnRTPROT_
KERNEL;default:returnRTPROT_ZEBRA;}}/**netlink_route_info_fill**Fillouttheroutei
nformationobjectfromthegivenroute.**ReturnsTRUEonsuccessandFALSEonfailure.*/stat
icintnetlink_route_info_fill(netlink_route_info_t*ri,intcmd,rib_dest_t*dest,stru
ctroute_entry*re){structnexthop*nexthop;memset(ri,0,sizeof(*ri));ri->prefix=rib_
dest_prefix(dest);ri->af=rib_dest_af(dest);ri->nlmsg_type=cmd;ri->rtm_table=zvrf
_id(rib_dest_vrf(dest));ri->rtm_protocol=RTPROT_UNSPEC;/**AnRTM_DELROUTEneednotb
eaccompaniedbyanynexthops,*particularlyinourcommunicationwiththeFPM.*/if(cmd==RT
M_DELROUTE&&!re)return1;if(!re){zfpm_debug("%s:Expectednon-NULLrepointer",__PRET
TY_FUNCTION__);return0;}ri->rtm_protocol=netlink_proto_from_route_type(re->type)
;ri->rtm_type=RTN_UNICAST;ri->metric=&re->metric;for(ALL_NEXTHOPS(re->ng,nexthop
)){if(ri->num_nhs>=multipath_num)break;if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG
_RECURSIVE))continue;if(nexthop->type==NEXTHOP_TYPE_BLACKHOLE){switch(nexthop->b
h_type){caseBLACKHOLE_ADMINPROHIB:ri->rtm_type=RTN_PROHIBIT;break;caseBLACKHOLE_
REJECT:ri->rtm_type=RTN_UNREACHABLE;break;caseBLACKHOLE_NULL:default:ri->rtm_typ
e=RTN_BLACKHOLE;break;}return1;}if((cmd==RTM_NEWROUTE&&CHECK_FLAG(nexthop->flags
,NEXTHOP_FLAG_ACTIVE))||(cmd==RTM_DELROUTE&&CHECK_FLAG(nexthop->flags,NEXTHOP_FL
AG_FIB))){netlink_route_info_add_nh(ri,nexthop);}}/*Ifthereisnousefulnexthopthen
return.*/if(ri->num_nhs==0){zfpm_debug("netlink_encode_route():Nousefulnexthop."
);return0;}return1;}/**netlink_route_info_encode**Returnsthenumberofbyteswritten
tothebuffer.0oranegative*valueindicatesanerror.*/staticintnetlink_route_info_enc
ode(netlink_route_info_t*ri,char*in_buf,size_tin_buf_len){size_tbytelen;unsigned
intnexthop_num=0;size_tbuf_offset;netlink_nh_info_t*nhi;struct{structnlmsghdrn;s
tructrtmsgr;charbuf[1];}*req;req=(void*)in_buf;buf_offset=((char*)req->buf)-((ch
ar*)req);if(in_buf_len<buf_offset){assert(0);return0;}memset(req,0,buf_offset);b
ytelen=af_addr_size(ri->af);req->n.nlmsg_len=NLMSG_LENGTH(sizeof(structrtmsg));r
eq->n.nlmsg_flags=NLM_F_CREATE|NLM_F_REQUEST;req->n.nlmsg_type=ri->nlmsg_type;re
q->r.rtm_family=ri->af;req->r.rtm_table=ri->rtm_table;req->r.rtm_dst_len=ri->pre
fix->prefixlen;req->r.rtm_protocol=ri->rtm_protocol;req->r.rtm_scope=RT_SCOPE_UN
IVERSE;addattr_l(&req->n,in_buf_len,RTA_DST,&ri->prefix->u.prefix,bytelen);req->
r.rtm_type=ri->rtm_type;/*Metric.*/if(ri->metric)addattr32(&req->n,in_buf_len,RT
A_PRIORITY,*ri->metric);if(ri->num_nhs==0)gotodone;if(ri->num_nhs==1){nhi=&ri->n
hs[0];if(nhi->gateway){addattr_l(&req->n,in_buf_len,RTA_GATEWAY,nhi->gateway,byt
elen);}if(nhi->if_index){addattr32(&req->n,in_buf_len,RTA_OIF,nhi->if_index);}go
todone;}/**Multipathcase.*/charbuf[NL_PKT_BUF_SIZE];structrtattr*rta=(void*)buf;
structrtnexthop*rtnh;rta->rta_type=RTA_MULTIPATH;rta->rta_len=RTA_LENGTH(0);rtnh
=RTA_DATA(rta);for(nexthop_num=0;nexthop_num<ri->num_nhs;nexthop_num++){nhi=&ri-
>nhs[nexthop_num];rtnh->rtnh_len=sizeof(*rtnh);rtnh->rtnh_flags=0;rtnh->rtnh_hop
s=0;rtnh->rtnh_ifindex=0;rta->rta_len+=rtnh->rtnh_len;if(nhi->gateway){rta_addat
tr_l(rta,sizeof(buf),RTA_GATEWAY,nhi->gateway,bytelen);rtnh->rtnh_len+=sizeof(st
ructrtattr)+bytelen;}if(nhi->if_index){rtnh->rtnh_ifindex=nhi->if_index;}rtnh=RT
NH_NEXT(rtnh);}assert(rta->rta_len>RTA_LENGTH(0));addattr_l(&req->n,in_buf_len,R
TA_MULTIPATH,RTA_DATA(rta),RTA_PAYLOAD(rta));done:if(ri->pref_src){addattr_l(&re
q->n,in_buf_len,RTA_PREFSRC,&ri->pref_src,bytelen);}assert(req->n.nlmsg_len<in_b
uf_len);returnreq->n.nlmsg_len;}/**zfpm_log_route_info**Helperfunctiontologthein
formationinaroute_infostructure.*/staticvoidzfpm_log_route_info(netlink_route_in
fo_t*ri,constchar*label){netlink_nh_info_t*nhi;unsignedinti;zfpm_debug("%s:%s%s/
%d,Proto:%s,Metric:%u",label,nl_msg_type_to_str(ri->nlmsg_type),prefix_addr_to_a
(ri->prefix),ri->prefix->prefixlen,nl_rtproto_to_str(ri->rtm_protocol),ri->metri
c?*ri->metric:0);for(i=0;i<ri->num_nhs;i++){nhi=&ri->nhs[i];zfpm_debug("Intf:%u,
Gateway:%s,Recursive:%s,Type:%s",nhi->if_index,addr_to_a(ri->af,nhi->gateway),nh
i->recursive?"yes":"no",nexthop_type_to_str(nhi->type));}}/**zfpm_netlink_encode
_route**Createanetlinkmessagecorrespondingtothegivenrouteinthe*givenbufferspace.
**Returnsthenumberofbyteswrittentothebuffer.0oranegative*valueindicatesanerror.*
/intzfpm_netlink_encode_route(intcmd,rib_dest_t*dest,structroute_entry*re,char*i
n_buf,size_tin_buf_len){netlink_route_info_tri_space,*ri;ri=&ri_space;if(!netlin
k_route_info_fill(ri,cmd,dest,re))return0;zfpm_log_route_info(ri,__FUNCTION__);r
eturnnetlink_route_info_encode(ri,in_buf,in_buf_len);}#endif/*HAVE_NETLINK*/