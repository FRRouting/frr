/**Kernelroutingtablereadupbygetmsg(2)*Copyright(C)1999MichaelHandler**Thisfilei
spartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*unde
rthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eit
herversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopetha
titwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTA
BILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetail
s.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;
seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fift
hFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefSUNOS_5#include"prefix.h"#
include"log.h"#include"if.h"#include"vrf.h"#include"vty.h"#include"zebra/rib.h"#
include"zebra/rt.h"/*Thankyou,Solaris,forpollutingapplicationsymbolnamespace.*/#
undefhook_register#undefhook_unregister#include<sys/stream.h>#include<sys/tihdr.
h>/*Solarisdefinestheseinboth<netinet/in.h>and<inet/in.h>,sigh*/#ifdefSUNOS_5#in
clude<sys/tiuser.h>#ifndefT_CURRENT#defineT_CURRENTMI_T_CURRENT#endif/*T_CURRENT
*/#ifndefIRE_CACHE#defineIRE_CACHE0x0020/*CachedRouteentry*/#endif/*IRE_CACHE*/#
ifndefIRE_HOST_REDIRECT#defineIRE_HOST_REDIRECT0x0200/*Hostrouteentryfromredirec
ts*/#endif/*IRE_HOST_REDIRECT*/#ifndefIRE_CACHETABLE#defineIRE_CACHETABLE(IRE_CA
CHE|IRE_BROADCAST|IRE_LOCAL|IRE_LOOPBACK)#endif/*IRE_CACHETABLE*/#undefIPOPT_EOL
#undefIPOPT_NOP#undefIPOPT_LSRR#undefIPOPT_RR#undefIPOPT_SSRR#endif/*SUNOS_5*/#i
nclude<inet/common.h>#include<inet/ip.h>#include<inet/mib2.h>/*devicetoreadIProu
tingtablefrom*/#ifndef_PATH_GETMSG_ROUTE#define_PATH_GETMSG_ROUTE"/dev/ip"#endif
/*_PATH_GETMSG_ROUTE*/#defineRT_BUFSIZ8192staticvoidhandle_route_entry(mib2_ipRo
uteEntry_t*routeEntry){structprefixprefix;structin_addrtmpaddr;structnexthopnh;u
int8_tzebra_flags=0;if(routeEntry->ipRouteInfo.re_ire_type&IRE_CACHETABLE)return
;if(routeEntry->ipRouteInfo.re_ire_type&IRE_HOST_REDIRECT)zebra_flags|=ZEBRA_FLA
G_SELFROUTE;prefix.family=AF_INET;tmpaddr.s_addr=routeEntry->ipRouteDest;prefix.
u.prefix4=tmpaddr;tmpaddr.s_addr=routeEntry->ipRouteMask;prefix.prefixlen=ip_mas
klen(tmpaddr);memset(&nh,0,sizeof(nh));nh.vrf_id=VRF_DEFAULT;nh.type=NEXTHOP_TYP
E_IPV4;nh.gate.ipv4.s_addr=routeEntry->ipRouteNextHop;rib_add(AFI_IP,SAFI_UNICAS
T,VRF_DEFAULT,ZEBRA_ROUTE_KERNEL,0,zebra_flags,&prefix,NULL,&nh,0,0,0,0,0);}void
route_read(structzebra_ns*zns){charstorage[RT_BUFSIZ];structT_optmgmt_req*TLIreq
=(structT_optmgmt_req*)storage;structT_optmgmt_ack*TLIack=(structT_optmgmt_ack*)
storage;structT_error_ack*TLIerr=(structT_error_ack*)storage;structopthdr*MIB2hd
r;mib2_ipRouteEntry_t*routeEntry,*lastRouteEntry;structstrbufmsgdata;intflags,de
v,retval,process;if((dev=open(_PATH_GETMSG_ROUTE,O_RDWR))==-1){zlog_warn("can'to
pen%s:%s",_PATH_GETMSG_ROUTE,safe_strerror(errno));return;}TLIreq->PRIM_type=T_O
PTMGMT_REQ;TLIreq->OPT_offset=sizeof(structT_optmgmt_req);TLIreq->OPT_length=siz
eof(structopthdr);TLIreq->MGMT_flags=T_CURRENT;MIB2hdr=(structopthdr*)&TLIreq[1]
;MIB2hdr->level=MIB2_IP;MIB2hdr->name=0;MIB2hdr->len=0;msgdata.buf=storage;msgda
ta.len=sizeof(structT_optmgmt_req)+sizeof(structopthdr);flags=0;if(putmsg(dev,&m
sgdata,NULL,flags)==-1){zlog_warn("putmsgfailed:%s",safe_strerror(errno));gotoex
it;}MIB2hdr=(structopthdr*)&TLIack[1];msgdata.maxlen=sizeof(storage);while(1){fl
ags=0;retval=getmsg(dev,&msgdata,NULL,&flags);if(retval==-1){zlog_warn("getmsg(c
tl)failed:%s",safe_strerror(errno));gotoexit;}/*Thisisnormallooptermination*/if(
retval==0&&(size_t)msgdata.len>=sizeof(structT_optmgmt_ack)&&TLIack->PRIM_type==
T_OPTMGMT_ACK&&TLIack->MGMT_flags==T_SUCCESS&&MIB2hdr->len==0)break;if((size_t)m
sgdata.len>=sizeof(structT_error_ack)&&TLIerr->PRIM_type==T_ERROR_ACK){zlog_warn
("getmsg(ctl)returnedT_ERROR_ACK:%s",safe_strerror((TLIerr->TLI_error==TSYSERR)?
TLIerr->UNIX_error:EPROTO));break;}/*shoulddumpmoredebugginginfotothelogstatemen
t,likewhatGateDdoesinthisinstance,butnotcriticalyet.*/if(retval!=MOREDATA||(size
_t)msgdata.len<sizeof(structT_optmgmt_ack)||TLIack->PRIM_type!=T_OPTMGMT_ACK||TL
Iack->MGMT_flags!=T_SUCCESS){errno=ENOMSG;zlog_warn("getmsg(ctl)returnedbizarren
ess");break;}/*MIB2_IP_21isthethepseudo-MIB2ipRouteTableentry,see<inet/mib2.h>."
Thisisn'ttheMIBdatayou'relookingfor."*/process=(MIB2hdr->level==MIB2_IP&&MIB2hdr
->name==MIB2_IP_21)?1:0;/*getmsgwritesthedatabufferoutcompletely,nottotheclosest
smallermultiple.Unlessreassemblingdatastructuresacrossbufferboundariesisyouridea
ofagoodtime,setmaxlentotheclosestsmallermultipleofthesizeofthedatastructureyou'r
eretrieving.*/msgdata.maxlen=sizeof(storage)-(sizeof(storage)%sizeof(mib2_ipRout
eEntry_t));msgdata.len=0;flags=0;do{retval=getmsg(dev,NULL,&msgdata,&flags);if(r
etval==-1){zlog_warn("getmsg(data)failed:%s",safe_strerror(errno));gotoexit;}if(
!(retval==0||retval==MOREDATA)){zlog_warn("getmsg(data)returned%d",retval);gotoe
xit;}if(process){if(msgdata.len%sizeof(mib2_ipRouteEntry_t)!=0){zlog_warn("getms
g(data)returned""msgdata.len=%d(%%sizeof(mib2_ipRouteEntry_t)!=0)",msgdata.len);
gotoexit;}routeEntry=(mib2_ipRouteEntry_t*)msgdata.buf;lastRouteEntry=(mib2_ipRo
uteEntry_t*)(msgdata.buf+msgdata.len);do{handle_route_entry(routeEntry);}while(+
+routeEntry<lastRouteEntry);}}while(retval==MOREDATA);}exit:close(dev);}/*Onlyim
plementedfornetlinkmethod*/voidmacfdb_read(structzebra_ns*zns){}voidmacfdb_read_
for_bridge(structzebra_ns*zns,structinterface*ifp,structinterface*br_if){}voidne
igh_read(structzebra_ns*zns){}voidneigh_read_for_vlan(structzebra_ns*zns,structi
nterface*vlan_if){}voidkernel_read_pbr_rules(structzebra_ns*zns){}#endif/*SUNOS_
5*/