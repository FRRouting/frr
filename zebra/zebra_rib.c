/*RoutingInformationBase.*Copyright(C)1997,98,99,2001KunihiroIshiguro**Thisfilei
spartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*unde
rthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eit
herversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopetha
titwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTA
BILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetail
s.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;
seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fift
hFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"if.h"#include"prefix.h"
#include"table.h"#include"memory.h"#include"zebra_memory.h"#include"command.h"#i
nclude"log.h"#include"log_int.h"#include"sockunion.h"#include"linklist.h"#includ
e"thread.h"#include"workqueue.h"#include"prefix.h"#include"routemap.h"#include"n
exthop.h"#include"vrf.h"#include"mpls.h"#include"srcdest_table.h"#include"zebra/
rib.h"#include"zebra/rt.h"#include"zebra/zebra_ns.h"#include"zebra/zserv.h"#incl
ude"zebra/zebra_vrf.h"#include"zebra/redistribute.h"#include"zebra/zebra_routema
p.h"#include"zebra/debug.h"#include"zebra/zebra_rnh.h"#include"zebra/interface.h
"#include"zebra/connected.h"#include"zebra/zebra_vxlan.h"DEFINE_HOOK(rib_update,
(structroute_node*rn,constchar*reason),(rn,reason))/*ShouldweallownonQuaggaproce
ssestodeleteourroutes*/externintallow_delete;/*Eachroutetype'sstringanddefaultdi
stancevalue.*/staticconststruct{intkey;intdistance;}route_info[ZEBRA_ROUTE_MAX]=
{[ZEBRA_ROUTE_SYSTEM]={ZEBRA_ROUTE_SYSTEM,0},[ZEBRA_ROUTE_KERNEL]={ZEBRA_ROUTE_K
ERNEL,0},[ZEBRA_ROUTE_CONNECT]={ZEBRA_ROUTE_CONNECT,0},[ZEBRA_ROUTE_STATIC]={ZEB
RA_ROUTE_STATIC,1},[ZEBRA_ROUTE_RIP]={ZEBRA_ROUTE_RIP,120},[ZEBRA_ROUTE_RIPNG]={
ZEBRA_ROUTE_RIPNG,120},[ZEBRA_ROUTE_OSPF]={ZEBRA_ROUTE_OSPF,110},[ZEBRA_ROUTE_OS
PF6]={ZEBRA_ROUTE_OSPF6,110},[ZEBRA_ROUTE_ISIS]={ZEBRA_ROUTE_ISIS,115},[ZEBRA_RO
UTE_BGP]={ZEBRA_ROUTE_BGP,20/*IBGPis200.*/},[ZEBRA_ROUTE_PIM]={ZEBRA_ROUTE_PIM,2
55},[ZEBRA_ROUTE_EIGRP]={ZEBRA_ROUTE_EIGRP,90},[ZEBRA_ROUTE_NHRP]={ZEBRA_ROUTE_N
HRP,10},[ZEBRA_ROUTE_HSLS]={ZEBRA_ROUTE_HSLS,255},[ZEBRA_ROUTE_OLSR]={ZEBRA_ROUT
E_OLSR,255},[ZEBRA_ROUTE_TABLE]={ZEBRA_ROUTE_TABLE,150},[ZEBRA_ROUTE_LDP]={ZEBRA
_ROUTE_LDP,150},[ZEBRA_ROUTE_VNC]={ZEBRA_ROUTE_VNC,20},[ZEBRA_ROUTE_VNC_DIRECT]=
{ZEBRA_ROUTE_VNC_DIRECT,20},[ZEBRA_ROUTE_VNC_DIRECT_RH]={ZEBRA_ROUTE_VNC_DIRECT_
RH,20},[ZEBRA_ROUTE_BGP_DIRECT]={ZEBRA_ROUTE_BGP_DIRECT,20},[ZEBRA_ROUTE_BGP_DIR
ECT_EXT]={ZEBRA_ROUTE_BGP_DIRECT_EXT,20},[ZEBRA_ROUTE_BABEL]={ZEBRA_ROUTE_BABEL,
100},[ZEBRA_ROUTE_SHARP]={ZEBRA_ROUTE_SHARP,150},/*noentry/default:150*/};/*RPFl
ookupbehaviour*/staticenummulticast_modeipv4_multicast_mode=MCAST_NO_CONFIG;stat
icvoid__attribute__((format(printf,5,6)))_rnode_zlog(constchar*_func,vrf_id_tvrf
_id,structroute_node*rn,intpriority,constchar*msgfmt,...){charbuf[SRCDEST2STR_BU
FFER+sizeof("(MRIB)")];charmsgbuf[512];va_listap;va_start(ap,msgfmt);vsnprintf(m
sgbuf,sizeof(msgbuf),msgfmt,ap);va_end(ap);if(rn){rib_table_info_t*info=srcdest_
rnode_table_info(rn);srcdest_rnode2str(rn,buf,sizeof(buf));if(info->safi==SAFI_M
ULTICAST)strcat(buf,"(MRIB)");}else{snprintf(buf,sizeof(buf),"{(route_node*)NULL
}");}zlog(priority,"%s:%d:%s:%s",_func,vrf_id,buf,msgbuf);}#definernode_debug(no
de,vrf_id,...)\_rnode_zlog(__func__,vrf_id,node,LOG_DEBUG,__VA_ARGS__)#definerno
de_info(node,...)\_rnode_zlog(__func__,vrf_id,node,LOG_INFO,__VA_ARGS__)uint8_tr
oute_distance(inttype){uint8_tdistance;if((unsigned)type>=array_size(route_info)
)distance=150;elsedistance=route_info[type].distance;returndistance;}intis_zebra
_valid_kernel_table(uint32_ttable_id){#ifdeflinuxif((table_id==RT_TABLE_UNSPEC)|
|(table_id==RT_TABLE_LOCAL)||(table_id==RT_TABLE_COMPAT))return0;#endifreturn1;}
intis_zebra_main_routing_table(uint32_ttable_id){if((table_id==RT_TABLE_MAIN)||(
table_id==zebrad.rtm_table_default))return1;return0;}intzebra_check_addr(structp
refix*p){if(p->family==AF_INET){uint32_taddr;addr=p->u.prefix4.s_addr;addr=ntohl
(addr);if(IPV4_NET127(addr)||IN_CLASSD(addr)||IPV4_LINKLOCAL(addr))return0;}if(p
->family==AF_INET6){if(IN6_IS_ADDR_LOOPBACK(&p->u.prefix6))return0;if(IN6_IS_ADD
R_LINKLOCAL(&p->u.prefix6))return0;}return1;}/*Addnexthoptotheendofaribnode'snex
thoplist*/voidroute_entry_nexthop_add(structroute_entry*re,structnexthop*nexthop
){nexthop_add(&re->ng.nexthop,nexthop);re->nexthop_num++;}/***copy_nexthop-copya
nexthoptotheribstructure.*/voidroute_entry_copy_nexthops(structroute_entry*re,st
ructnexthop*nh){assert(!re->ng.nexthop);copy_nexthops(&re->ng.nexthop,nh,NULL);f
or(structnexthop*nexthop=nh;nexthop;nexthop=nexthop->next)re->nexthop_num++;}/*D
eletespecifiednexthopfromthelist.*/voidroute_entry_nexthop_delete(structroute_en
try*re,structnexthop*nexthop){if(nexthop->next)nexthop->next->prev=nexthop->prev
;if(nexthop->prev)nexthop->prev->next=nexthop->next;elsere->ng.nexthop=nexthop->
next;re->nexthop_num--;}structnexthop*route_entry_nexthop_ifindex_add(structrout
e_entry*re,ifindex_tifindex,vrf_id_tnh_vrf_id){structnexthop*nexthop;nexthop=nex
thop_new();nexthop->type=NEXTHOP_TYPE_IFINDEX;nexthop->ifindex=ifindex;nexthop->
vrf_id=nh_vrf_id;route_entry_nexthop_add(re,nexthop);returnnexthop;}structnextho
p*route_entry_nexthop_ipv4_add(structroute_entry*re,structin_addr*ipv4,structin_
addr*src,vrf_id_tnh_vrf_id){structnexthop*nexthop;nexthop=nexthop_new();nexthop-
>type=NEXTHOP_TYPE_IPV4;nexthop->vrf_id=nh_vrf_id;nexthop->gate.ipv4=*ipv4;if(sr
c)nexthop->src.ipv4=*src;route_entry_nexthop_add(re,nexthop);returnnexthop;}stru
ctnexthop*route_entry_nexthop_ipv4_ifindex_add(structroute_entry*re,structin_add
r*ipv4,structin_addr*src,ifindex_tifindex,vrf_id_tnh_vrf_id){structnexthop*nexth
op;structinterface*ifp;nexthop=nexthop_new();nexthop->vrf_id=nh_vrf_id;nexthop->
type=NEXTHOP_TYPE_IPV4_IFINDEX;nexthop->gate.ipv4=*ipv4;if(src)nexthop->src.ipv4
=*src;nexthop->ifindex=ifindex;ifp=if_lookup_by_index(nexthop->ifindex,nh_vrf_id
);/*Pending:needtothinkifnullifphereisokduringbootup?Therewasacrashbecauseifpher
ewascomingtobeNULL*/if(ifp)if(connected_is_unnumbered(ifp)||CHECK_FLAG(re->flags
,ZEBRA_FLAG_EVPN_ROUTE)){SET_FLAG(nexthop->flags,NEXTHOP_FLAG_ONLINK);}route_ent
ry_nexthop_add(re,nexthop);returnnexthop;}structnexthop*route_entry_nexthop_ipv6
_add(structroute_entry*re,structin6_addr*ipv6,vrf_id_tnh_vrf_id){structnexthop*n
exthop;nexthop=nexthop_new();nexthop->vrf_id=nh_vrf_id;nexthop->type=NEXTHOP_TYP
E_IPV6;nexthop->gate.ipv6=*ipv6;route_entry_nexthop_add(re,nexthop);returnnextho
p;}structnexthop*route_entry_nexthop_ipv6_ifindex_add(structroute_entry*re,struc
tin6_addr*ipv6,ifindex_tifindex,vrf_id_tnh_vrf_id){structnexthop*nexthop;nexthop
=nexthop_new();nexthop->vrf_id=nh_vrf_id;nexthop->type=NEXTHOP_TYPE_IPV6_IFINDEX
;nexthop->gate.ipv6=*ipv6;nexthop->ifindex=ifindex;if(CHECK_FLAG(re->flags,ZEBRA
_FLAG_EVPN_ROUTE))SET_FLAG(nexthop->flags,NEXTHOP_FLAG_ONLINK);route_entry_nexth
op_add(re,nexthop);returnnexthop;}structnexthop*route_entry_nexthop_blackhole_ad
d(structroute_entry*re,enumblackhole_typebh_type){structnexthop*nexthop;nexthop=
nexthop_new();nexthop->vrf_id=VRF_DEFAULT;nexthop->type=NEXTHOP_TYPE_BLACKHOLE;n
exthop->bh_type=bh_type;route_entry_nexthop_add(re,nexthop);returnnexthop;}stati
cvoidnexthop_set_resolved(afi_tafi,structnexthop*newhop,structnexthop*nexthop){s
tructnexthop*resolved_hop;resolved_hop=nexthop_new();SET_FLAG(resolved_hop->flag
s,NEXTHOP_FLAG_ACTIVE);resolved_hop->vrf_id=nexthop->vrf_id;switch(newhop->type)
{caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV4_IFINDEX:/*Iftheresolvingroutespecif
iesagateway,useit*/resolved_hop->type=newhop->type;resolved_hop->gate.ipv4=newho
p->gate.ipv4;if(newhop->ifindex){resolved_hop->type=NEXTHOP_TYPE_IPV4_IFINDEX;re
solved_hop->ifindex=newhop->ifindex;if(newhop->flags&NEXTHOP_FLAG_ONLINK)resolve
d_hop->flags|=NEXTHOP_FLAG_ONLINK;}break;caseNEXTHOP_TYPE_IPV6:caseNEXTHOP_TYPE_
IPV6_IFINDEX:resolved_hop->type=newhop->type;resolved_hop->gate.ipv6=newhop->gat
e.ipv6;if(newhop->ifindex){resolved_hop->type=NEXTHOP_TYPE_IPV6_IFINDEX;resolved
_hop->ifindex=newhop->ifindex;}break;caseNEXTHOP_TYPE_IFINDEX:/*Iftheresolvingro
uteisaninterfaceroute,*itmeansthegatewaywearelookingupisconnected*tothatinterfac
e.(Theactualnetworkis_not_onlink).*Therefore,theresolvedrouteshouldhavetheorigin
al*gatewayasnexthopasitisdirectlyconnected.**OnLinux,wehavetosettheonlinknetlink
flagbecause*otherwise,thekernelwon'taccepttheroute.*/resolved_hop->flags|=NEXTHO
P_FLAG_ONLINK;if(afi==AFI_IP){resolved_hop->type=NEXTHOP_TYPE_IPV4_IFINDEX;resol
ved_hop->gate.ipv4=nexthop->gate.ipv4;}elseif(afi==AFI_IP6){resolved_hop->type=N
EXTHOP_TYPE_IPV6_IFINDEX;resolved_hop->gate.ipv6=nexthop->gate.ipv6;}resolved_ho
p->ifindex=newhop->ifindex;break;caseNEXTHOP_TYPE_BLACKHOLE:resolved_hop->type=N
EXTHOP_TYPE_BLACKHOLE;resolved_hop->bh_type=nexthop->bh_type;break;}/*Copylabels
oftheresolvedroute*/if(newhop->nh_label)nexthop_add_labels(resolved_hop,newhop->
nh_label_type,newhop->nh_label->num_labels,&newhop->nh_label->label[0]);resolved
_hop->rparent=nexthop;nexthop_add(&nexthop->resolved,resolved_hop);}/*Ifforcefla
gisnotset,donotmodifyfalgsatallforuninstalltheroutefromFIB.*/staticintnexthop_ac
tive(afi_tafi,structroute_entry*re,structnexthop*nexthop,intset,structroute_node
*top){structprefixp;structroute_table*table;structroute_node*rn;structroute_entr
y*match=NULL;intresolved;structnexthop*newhop;structinterface*ifp;rib_dest_t*des
t;if((nexthop->type==NEXTHOP_TYPE_IPV4)||nexthop->type==NEXTHOP_TYPE_IPV6)nextho
p->ifindex=0;if(set){UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_RECURSIVE);nexthops_
free(nexthop->resolved);nexthop->resolved=NULL;re->nexthop_mtu=0;}/*Nexthops(rem
oteVTEPs)forEVPNroutesarefullyresolved.*/if(CHECK_FLAG(nexthop->flags,NEXTHOP_FL
AG_EVPN_RVTEP))return1;/*Skipnexthopsthathavebeenfilteredoutduetoroute-map*//*Th
enexthopsarespecifictothisrouteandsothesame*//*nexthopforadifferentroutemaynotha
vethisflagset*/if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FILTERED))return0;/**Ch
ecktoseeifweshouldtrustthepassedininformation*forUNNUMBEREDinterfacesasthatwewon
'tfindtheGW*addressintheroutingtable.*/if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG
_ONLINK)){ifp=if_lookup_by_index(nexthop->ifindex,nexthop->vrf_id);if(ifp&&conne
cted_is_unnumbered(ifp)){if(if_is_operative(ifp))return1;elsereturn0;}elsereturn
0;}/*Makelookupprefix.*/memset(&p,0,sizeof(structprefix));switch(afi){caseAFI_IP
:p.family=AF_INET;p.prefixlen=IPV4_MAX_PREFIXLEN;p.u.prefix4=nexthop->gate.ipv4;
break;caseAFI_IP6:p.family=AF_INET6;p.prefixlen=IPV6_MAX_PREFIXLEN;p.u.prefix6=n
exthop->gate.ipv6;break;default:assert(afi!=AFI_IP&&afi!=AFI_IP6);break;}/*Looku
ptable.*/table=zebra_vrf_table(afi,SAFI_UNICAST,nexthop->vrf_id);if(!table)retur
n0;rn=route_node_match(table,(structprefix*)&p);while(rn){route_unlock_node(rn);
/*Lookupshouldhaltifwe'vematchedagainstourselves('top',*ifspecified)-i.e.,wecann
othaveanexthopNH1is*resolvedbyarouteNH1.Theexceptionisiftherouteisa*hostroute.*/
if(top&&rn==top)if(((afi==AFI_IP)&&(rn->p.prefixlen!=32))||((afi==AFI_IP6)&&(rn-
>p.prefixlen!=128)))return0;/*Pickupselectedroute.*//*However,donotresolveoverde
faultrouteunlessexplicitly*allowed.*/if(is_default_prefix(&rn->p)&&!rnh_resolve_
via_default(p.family))return0;dest=rib_dest_from_rnode(rn);if(dest&&dest->select
ed_fib&&!CHECK_FLAG(dest->selected_fib->status,ROUTE_ENTRY_REMOVED)&&dest->selec
ted_fib->type!=ZEBRA_ROUTE_TABLE)match=dest->selected_fib;/*Ifthereisnoselectedr
outeormatchedrouteisEGP,gouptree.*/if(!match){do{rn=rn->parent;}while(rn&&rn->in
fo==NULL);if(rn)route_lock_node(rn);continue;}if(match->type==ZEBRA_ROUTE_CONNEC
T){/*Directlypointconnectedroute.*/newhop=match->ng.nexthop;if(newhop){if(nextho
p->type==NEXTHOP_TYPE_IPV4||nexthop->type==NEXTHOP_TYPE_IPV6)nexthop->ifindex=ne
whop->ifindex;}return1;}elseif(CHECK_FLAG(re->flags,ZEBRA_FLAG_ALLOW_RECURSION))
{resolved=0;for(ALL_NEXTHOPS(match->ng,newhop)){if(!CHECK_FLAG(newhop->flags,NEX
THOP_FLAG_FIB))continue;if(CHECK_FLAG(newhop->flags,NEXTHOP_FLAG_RECURSIVE))cont
inue;if(set){SET_FLAG(nexthop->flags,NEXTHOP_FLAG_RECURSIVE);SET_FLAG(re->status
,ROUTE_ENTRY_NEXTHOPS_CHANGED);nexthop_set_resolved(afi,newhop,nexthop);}resolve
d=1;}if(resolved&&set)re->nexthop_mtu=match->mtu;returnresolved;}elseif(re->type
==ZEBRA_ROUTE_STATIC){resolved=0;for(ALL_NEXTHOPS(match->ng,newhop)){if(!CHECK_F
LAG(newhop->flags,NEXTHOP_FLAG_FIB))continue;if(set){SET_FLAG(nexthop->flags,NEX
THOP_FLAG_RECURSIVE);nexthop_set_resolved(afi,newhop,nexthop);}resolved=1;}if(re
solved&&set)re->nexthop_mtu=match->mtu;returnresolved;}else{return0;}}return0;}s
tructroute_entry*rib_match(afi_tafi,safi_tsafi,vrf_id_tvrf_id,uniong_addr*addr,s
tructroute_node**rn_out){structprefixp;structroute_table*table;structroute_node*
rn;structroute_entry*match=NULL;structnexthop*newhop;/*Lookuptable.*/table=zebra
_vrf_table(afi,safi,vrf_id);if(!table)return0;memset(&p,0,sizeof(structprefix));
p.family=afi;if(afi==AFI_IP){p.u.prefix4=addr->ipv4;p.prefixlen=IPV4_MAX_PREFIXL
EN;}else{p.u.prefix6=addr->ipv6;p.prefixlen=IPV6_MAX_PREFIXLEN;}rn=route_node_ma
tch(table,(structprefix*)&p);while(rn){rib_dest_t*dest;route_unlock_node(rn);des
t=rib_dest_from_rnode(rn);if(dest&&dest->selected_fib&&!CHECK_FLAG(dest->selecte
d_fib->status,ROUTE_ENTRY_REMOVED))match=dest->selected_fib;/*Ifthereisnoselecte
drouteormatchedrouteisEGP,gouptree.*/if(!match){do{rn=rn->parent;}while(rn&&rn->
info==NULL);if(rn)route_lock_node(rn);}else{if(match->type!=ZEBRA_ROUTE_CONNECT)
{intfound=0;for(ALL_NEXTHOPS(match->ng,newhop))if(CHECK_FLAG(newhop->flags,NEXTH
OP_FLAG_FIB)){found=1;break;}if(!found)returnNULL;}if(rn_out)*rn_out=rn;returnma
tch;}}returnNULL;}structroute_entry*rib_match_ipv4_multicast(vrf_id_tvrf_id,stru
ctin_addraddr,structroute_node**rn_out){structroute_entry*re=NULL,*mre=NULL,*ure
=NULL;structroute_node*m_rn=NULL,*u_rn=NULL;uniong_addrgaddr={.ipv4=addr};switch
(ipv4_multicast_mode){caseMCAST_MRIB_ONLY:returnrib_match(AFI_IP,SAFI_MULTICAST,
vrf_id,&gaddr,rn_out);caseMCAST_URIB_ONLY:returnrib_match(AFI_IP,SAFI_UNICAST,vr
f_id,&gaddr,rn_out);caseMCAST_NO_CONFIG:caseMCAST_MIX_MRIB_FIRST:re=mre=rib_matc
h(AFI_IP,SAFI_MULTICAST,vrf_id,&gaddr,&m_rn);if(!mre)re=ure=rib_match(AFI_IP,SAF
I_UNICAST,vrf_id,&gaddr,&u_rn);break;caseMCAST_MIX_DISTANCE:mre=rib_match(AFI_IP
,SAFI_MULTICAST,vrf_id,&gaddr,&m_rn);ure=rib_match(AFI_IP,SAFI_UNICAST,vrf_id,&g
addr,&u_rn);if(mre&&ure)re=ure->distance<mre->distance?ure:mre;elseif(mre)re=mre
;elseif(ure)re=ure;break;caseMCAST_MIX_PFXLEN:mre=rib_match(AFI_IP,SAFI_MULTICAS
T,vrf_id,&gaddr,&m_rn);ure=rib_match(AFI_IP,SAFI_UNICAST,vrf_id,&gaddr,&u_rn);if
(mre&&ure)re=u_rn->p.prefixlen>m_rn->p.prefixlen?ure:mre;elseif(mre)re=mre;elsei
f(ure)re=ure;break;}if(rn_out)*rn_out=(re==mre)?m_rn:u_rn;if(IS_ZEBRA_DEBUG_RIB)
{charbuf[BUFSIZ];inet_ntop(AF_INET,&addr,buf,BUFSIZ);zlog_debug("%s:%s:vrf:%ufou
nd%s,using%s",__func__,buf,vrf_id,mre?(ure?"MRIB+URIB":"MRIB"):ure?"URIB":"nothi
ng",re==ure?"URIB":re==mre?"MRIB":"none");}returnre;}voidmulticast_mode_ipv4_set
(enummulticast_modemode){if(IS_ZEBRA_DEBUG_RIB)zlog_debug("%s:multicastlookupmod
eset(%d)",__func__,mode);ipv4_multicast_mode=mode;}enummulticast_modemulticast_m
ode_ipv4_get(void){returnipv4_multicast_mode;}structroute_entry*rib_lookup_ipv4(
structprefix_ipv4*p,vrf_id_tvrf_id){structroute_table*table;structroute_node*rn;
structroute_entry*match=NULL;structnexthop*nexthop;rib_dest_t*dest;/*Lookuptable
.*/table=zebra_vrf_table(AFI_IP,SAFI_UNICAST,vrf_id);if(!table)return0;rn=route_
node_lookup(table,(structprefix*)p);/*Norouteforthisprefix.*/if(!rn)returnNULL;/
*Unlocknode.*/route_unlock_node(rn);dest=rib_dest_from_rnode(rn);if(dest&&dest->
selected_fib&&!CHECK_FLAG(dest->selected_fib->status,ROUTE_ENTRY_REMOVED))match=
dest->selected_fib;if(!match)returnNULL;if(match->type==ZEBRA_ROUTE_CONNECT)retu
rnmatch;for(ALL_NEXTHOPS(match->ng,nexthop))if(CHECK_FLAG(nexthop->flags,NEXTHOP
_FLAG_FIB))returnmatch;returnNULL;}/**Thisclonefunction,unlikeitsoriginalrib_loo
kup_ipv4(),checks*ifspecifiedIPv4routerecord(prefix/mask->gate)existsin*thewhole
RIBandhasROUTE_ENTRY_SELECTED_FIBset.**Returnvalues:*-1:error*0:exactmatchfound*
1:amatchwasfoundwithadifferentgate*2:connectedroutefound*3:nomatchesfound*/intri
b_lookup_ipv4_route(structprefix_ipv4*p,unionsockunion*qgate,vrf_id_tvrf_id){str
uctroute_table*table;structroute_node*rn;structroute_entry*match=NULL;structnext
hop*nexthop;intnexthops_active;rib_dest_t*dest;/*Lookuptable.*/table=zebra_vrf_t
able(AFI_IP,SAFI_UNICAST,vrf_id);if(!table)returnZEBRA_RIB_LOOKUP_ERROR;/*Scanth
eRIBtableforexactlymatchingRIBentry.*/rn=route_node_lookup(table,(structprefix*)
p);/*Norouteforthisprefix.*/if(!rn)returnZEBRA_RIB_NOTFOUND;/*Unlocknode.*/route
_unlock_node(rn);dest=rib_dest_from_rnode(rn);/*Findoutifa"selected"RRforthedisc
overedRIBentryexistsever.*/if(dest&&dest->selected_fib&&!CHECK_FLAG(dest->select
ed_fib->status,ROUTE_ENTRY_REMOVED))match=dest->selected_fib;/*Nonesuchfound:(*/
if(!match)returnZEBRA_RIB_NOTFOUND;if(match->type==ZEBRA_ROUTE_CONNECT)returnZEB
RA_RIB_FOUND_CONNECTED;/*Ok,wehaveacoodcandidate,let'scheckit'snexthoplist...*/n
exthops_active=0;for(ALL_NEXTHOPS(match->ng,nexthop))if(CHECK_FLAG(nexthop->flag
s,NEXTHOP_FLAG_FIB)){nexthops_active=1;if(nexthop->gate.ipv4.s_addr==sockunion2i
p(qgate))returnZEBRA_RIB_FOUND_EXACT;if(IS_ZEBRA_DEBUG_RIB){chargate_buf[INET_AD
DRSTRLEN],qgate_buf[INET_ADDRSTRLEN];inet_ntop(AF_INET,&nexthop->gate.ipv4.s_add
r,gate_buf,INET_ADDRSTRLEN);inet_ntop(AF_INET,&sockunion2ip(qgate),qgate_buf,INE
T_ADDRSTRLEN);zlog_debug("%s:qgate==%s,%s==%s",__func__,qgate_buf,nexthop->rpare
nt?"rgate":"gate",gate_buf);}}if(nexthops_active)returnZEBRA_RIB_FOUND_NOGATE;re
turnZEBRA_RIB_NOTFOUND;}#defineRIB_SYSTEM_ROUTE(R)\((R)->type==ZEBRA_ROUTE_KERNE
L||(R)->type==ZEBRA_ROUTE_CONNECT)/*Thisfunctionverifiesreachabilityofonegivenne
xthop,whichcanbe*numberedorunnumbered,IPv4orIPv6.Theresultisunconditionallystore
d*innexthop->flagsfield.Ifthe4thparameter,'set',isnon-zero,*nexthop->ifindexwill
beupdatedappropriatelyaswell.*Anexistingroutemapcanturn(otherwiseactive)nexthopi
ntoinactive,but*notviceversa.**Thereturnvalueisthefinalvalueof'ACTIVE'flag.*/sta
ticunsignednexthop_active_check(structroute_node*rn,structroute_entry*re,structn
exthop*nexthop,intset){structinterface*ifp;route_map_result_tret=RMAP_MATCH;intf
amily;charbuf[SRCDEST2STR_BUFFER];structprefix*p,*src_p;srcdest_rnode_prefixes(r
n,&p,&src_p);if(rn->p.family==AF_INET)family=AFI_IP;elseif(rn->p.family==AF_INET
6)family=AFI_IP6;elsefamily=0;switch(nexthop->type){caseNEXTHOP_TYPE_IFINDEX:ifp
=if_lookup_by_index(nexthop->ifindex,nexthop->vrf_id);if(ifp&&if_is_operative(if
p))SET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);elseUNSET_FLAG(nexthop->flags,NE
XTHOP_FLAG_ACTIVE);break;caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV4_IFINDEX:fam
ily=AFI_IP;if(nexthop_active(AFI_IP,re,nexthop,set,rn))SET_FLAG(nexthop->flags,N
EXTHOP_FLAG_ACTIVE);elseUNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);break;cas
eNEXTHOP_TYPE_IPV6:family=AFI_IP6;if(nexthop_active(AFI_IP6,re,nexthop,set,rn))S
ET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);elseUNSET_FLAG(nexthop->flags,NEXTHO
P_FLAG_ACTIVE);break;caseNEXTHOP_TYPE_IPV6_IFINDEX:/*RFC5549,v4prefixwithv6NH*/i
f(rn->p.family!=AF_INET)family=AFI_IP6;if(IN6_IS_ADDR_LINKLOCAL(&nexthop->gate.i
pv6)){ifp=if_lookup_by_index(nexthop->ifindex,nexthop->vrf_id);if(ifp&&if_is_ope
rative(ifp))SET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);elseUNSET_FLAG(nexthop-
>flags,NEXTHOP_FLAG_ACTIVE);}else{if(nexthop_active(AFI_IP6,re,nexthop,set,rn))S
ET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);elseUNSET_FLAG(nexthop->flags,NEXTHO
P_FLAG_ACTIVE);}break;caseNEXTHOP_TYPE_BLACKHOLE:SET_FLAG(nexthop->flags,NEXTHOP
_FLAG_ACTIVE);break;default:break;}if(!CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_AC
TIVE))return0;/*XXX:Whatexactlydothosechecksdo?Dowesupport*e.g.IPv4routeswithIPv
6nexthopsorviceversa?*/if(RIB_SYSTEM_ROUTE(re)||(family==AFI_IP&&p->family!=AF_I
NET)||(family==AFI_IP6&&p->family!=AF_INET6))returnCHECK_FLAG(nexthop->flags,NEX
THOP_FLAG_ACTIVE);/*Theoriginalcodedidn'tdeterminethefamilycorrectly*e.g.forNEXT
HOP_TYPE_IFINDEX.Retrievethecorrectafi*fromtherib_table_infointhosecases.*Possib
lyitmaybebettertouseonlytherib_table_info*ineverycase.*/if(!family){rib_table_in
fo_t*info;info=srcdest_rnode_table_info(rn);family=info->afi;}memset(&nexthop->r
map_src.ipv6,0,sizeof(uniong_addr));/*It'llgetsetifrequiredinside*/ret=zebra_rou
te_map_check(family,re->type,p,nexthop,nexthop->vrf_id,re->tag);if(ret==RMAP_DEN
YMATCH){if(IS_ZEBRA_DEBUG_RIB){srcdest_rnode2str(rn,buf,sizeof(buf));zlog_debug(
"%u:%s:FilteringoutwithNHout%sduetoroutemap",re->vrf_id,buf,ifindex2ifname(nexth
op->ifindex,nexthop->vrf_id));}UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);}r
eturnCHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);}/*Iterateoverallnexthopsoft
hegivenRIBentryandrefreshtheir*ACTIVEflag.re->nexthop_active_numisupdatedaccordi
ngly.Ifany*nexthopisfoundtotoggletheACTIVEflag,thewholerestructure*isflaggedwith
ROUTE_ENTRY_CHANGED.The4th'set'argumentis*transparentlypassedtonexthop_active_ch
eck().**Returnvalueisthenewnumberofactivenexthops.*/staticintnexthop_active_upda
te(structroute_node*rn,structroute_entry*re,intset){structnexthop*nexthop;uniong
_addrprev_src;unsignedintprev_active,new_active,old_num_nh;ifindex_tprev_index;o
ld_num_nh=re->nexthop_active_num;re->nexthop_active_num=0;UNSET_FLAG(re->status,
ROUTE_ENTRY_CHANGED);for(nexthop=re->ng.nexthop;nexthop;nexthop=nexthop->next){/
*Noprotocoldaemonprovidessrcandsowe'reskipping*trackingit*/prev_src=nexthop->rma
p_src;prev_active=CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE);prev_index=next
hop->ifindex;if((new_active=nexthop_active_check(rn,re,nexthop,set)))re->nexthop
_active_num++;/*Don'tallowsrcsettingonIPv6addrfornow*/if(prev_active!=new_active
||prev_index!=nexthop->ifindex||((nexthop->type>=NEXTHOP_TYPE_IFINDEX&&nexthop->
type<NEXTHOP_TYPE_IPV6)&&prev_src.ipv4.s_addr!=nexthop->rmap_src.ipv4.s_addr)||(
(nexthop->type>=NEXTHOP_TYPE_IPV6&&nexthop->type<NEXTHOP_TYPE_BLACKHOLE)&&!(IPV6
_ADDR_SAME(&prev_src.ipv6,&nexthop->rmap_src.ipv6)))){SET_FLAG(re->status,ROUTE_
ENTRY_CHANGED);SET_FLAG(re->status,ROUTE_ENTRY_NEXTHOPS_CHANGED);}}if(old_num_nh
!=re->nexthop_active_num)SET_FLAG(re->status,ROUTE_ENTRY_CHANGED);if(CHECK_FLAG(
re->status,ROUTE_ENTRY_CHANGED)){SET_FLAG(re->status,ROUTE_ENTRY_NEXTHOPS_CHANGE
D);}returnre->nexthop_active_num;}/**IsthisRIBlabeled-unicast?ItmustbeoftypeBGPa
ndallpaths*(nexthops)musthavealabel.*/intzebra_rib_labeled_unicast(structroute_e
ntry*re){structnexthop*nexthop=NULL;if(re->type!=ZEBRA_ROUTE_BGP)return0;for(ALL
_NEXTHOPS(re->ng,nexthop))if(!nexthop->nh_label||!nexthop->nh_label->num_labels)
return0;return1;}voidkernel_route_rib_pass_fail(structroute_node*rn,structprefix
*p,structroute_entry*re,enumsouthbound_resultsres){structnexthop*nexthop;charbuf
[PREFIX_STRLEN];rib_dest_t*dest;dest=rib_dest_from_rnode(rn);switch(res){caseSOU
THBOUND_INSTALL_SUCCESS:dest->selected_fib=re;for(ALL_NEXTHOPS(re->ng,nexthop)){
if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_RECURSIVE))continue;if(CHECK_FLAG(next
hop->flags,NEXTHOP_FLAG_ACTIVE))SET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB);elseUN
SET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB);}zsend_route_notify_owner(re,p,ZAPI_RO
UTE_INSTALLED);break;caseSOUTHBOUND_INSTALL_FAILURE:/**Iamnotsurethisistherightt
hingtodohere*butthecodealwayssetselected_fibbefore*thisassignmentwasmovedhere.*/
dest->selected_fib=re;zsend_route_notify_owner(re,p,ZAPI_ROUTE_FAIL_INSTALL);zlo
g_warn("%u:%s:Routeinstallfailed",re->vrf_id,prefix2str(p,buf,sizeof(buf)));brea
k;caseSOUTHBOUND_DELETE_SUCCESS:/**Thecasewhereselected_fibisnotreis*whenwehaver
eceivedasystemroute*thatisoverridingourinstalledroute*assuchweshouldleavethesele
cted_fib*pointeralone*/if(dest->selected_fib==re)dest->selected_fib=NULL;for(ALL
_NEXTHOPS(re->ng,nexthop))UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB);zsend_rout
e_notify_owner(re,p,ZAPI_ROUTE_REMOVED);break;caseSOUTHBOUND_DELETE_FAILURE:/**S
houldwesetthistoNULLifthe*deletefails?*/dest->selected_fib=NULL;zlog_warn("%u:%s
:RouteDeletionfailure",re->vrf_id,prefix2str(p,buf,sizeof(buf)));zsend_route_not
ify_owner(re,p,ZAPI_ROUTE_REMOVE_FAIL);break;}}/*Updateflagindicateswhetherthisi
sa"replace"ornot.Currently,this*isonlyusedforIPv4.*/voidrib_install_kernel(struc
troute_node*rn,structroute_entry*re,structroute_entry*old){structnexthop*nexthop
;rib_table_info_t*info=srcdest_rnode_table_info(rn);structprefix*p,*src_p;struct
zebra_vrf*zvrf=vrf_info_lookup(re->vrf_id);srcdest_rnode_prefixes(rn,&p,&src_p);
if(info->safi!=SAFI_UNICAST){for(ALL_NEXTHOPS(re->ng,nexthop))SET_FLAG(nexthop->
flags,NEXTHOP_FLAG_FIB);return;}else{structnexthop*prev;for(ALL_NEXTHOPS(re->ng,
nexthop)){UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_DUPLICATE);for(ALL_NEXTHOPS(re-
>ng,prev)){if(prev==nexthop)break;if(nexthop_same_firsthop(nexthop,prev)){SET_FL
AG(nexthop->flags,NEXTHOP_FLAG_DUPLICATE);break;}}}}/**IfthisisareplacetoanewREl
ettheoriginatoroftheRE*knowthatthey'velost*/if(old&&(old!=re)&&(old->type!=re->t
ype))zsend_route_notify_owner(old,p,ZAPI_ROUTE_BETTER_ADMIN_WON);/**Makesureweup
datetheFPManytimewesendnewinformationto*thekernel.*/hook_call(rib_update,rn,"ins
tallinginkernel");kernel_route_rib(rn,p,src_p,old,re);zvrf->installs++;return;}/
*Uninstalltheroutefromkernel.*/voidrib_uninstall_kernel(structroute_node*rn,stru
ctroute_entry*re){structnexthop*nexthop;rib_table_info_t*info=srcdest_rnode_tabl
e_info(rn);structprefix*p,*src_p;structzebra_vrf*zvrf=vrf_info_lookup(re->vrf_id
);srcdest_rnode_prefixes(rn,&p,&src_p);if(info->safi!=SAFI_UNICAST){for(ALL_NEXT
HOPS(re->ng,nexthop))UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB);return;}/**Make
sureweupdatetheFPManytimewesendnewinformationto*thekernel.*/hook_call(rib_update
,rn,"uninstallingfromkernel");kernel_route_rib(rn,p,src_p,re,NULL);if(zvrf)zvrf-
>removals++;return;}/*Uninstalltheroutefromkernel.*/staticvoidrib_uninstall(stru
ctroute_node*rn,structroute_entry*re){rib_table_info_t*info=srcdest_rnode_table_
info(rn);rib_dest_t*dest=rib_dest_from_rnode(rn);if(dest&&dest->selected_fib==re
){if(info->safi==SAFI_UNICAST)hook_call(rib_update,rn,"rib_uninstall");if(!RIB_S
YSTEM_ROUTE(re))rib_uninstall_kernel(rn,re);/*Iflabeled-unicastroute,uninstalltr
ansitLSP.*/if(zebra_rib_labeled_unicast(re))zebra_mpls_lsp_uninstall(info->zvrf,
rn,re);}if(CHECK_FLAG(re->flags,ZEBRA_FLAG_SELECTED)){structprefix*p,*src_p;srcd
est_rnode_prefixes(rn,&p,&src_p);redistribute_delete(p,src_p,re);UNSET_FLAG(re->
flags,ZEBRA_FLAG_SELECTED);}}/**rib_can_delete_dest**ReturnsTRUEifthegivendestca
nbedeletedfromthetable.*/staticintrib_can_delete_dest(rib_dest_t*dest){if(dest->
routes){return0;}/**Don'tdeletethedestifwehavetoupdatetheFPMaboutthis*prefix.*/i
f(CHECK_FLAG(dest->flags,RIB_DEST_UPDATE_FPM)||CHECK_FLAG(dest->flags,RIB_DEST_S
ENT_TO_FPM))return0;return1;}/**rib_gc_dest**Garbagecollecttheribdestcorrespondi
ngtothegivenroutenode*ifappropriate.**ReturnsTRUEifthedestwasdeleted,FALSEotherw
ise.*/intrib_gc_dest(structroute_node*rn){rib_dest_t*dest;dest=rib_dest_from_rno
de(rn);if(!dest)return0;if(!rib_can_delete_dest(dest))return0;if(IS_ZEBRA_DEBUG_
RIB){structzebra_vrf*zvrf;zvrf=rib_dest_vrf(dest);rnode_debug(rn,zvrf_id(zvrf),"
removingdestfromtable");}dest->rnode=NULL;XFREE(MTYPE_RIB_DEST,dest);rn->info=NU
LL;/**Releasetheonereferencethatwekeepontheroutenode.*/route_unlock_node(rn);ret
urn1;}staticvoidrib_process_add_fib(structzebra_vrf*zvrf,structroute_node*rn,str
uctroute_entry*new){rib_dest_t*dest=rib_dest_from_rnode(rn);hook_call(rib_update
,rn,"newrouteselected");/*Updaterealnexthop.Thismayactuallydetermineifnexthopisa
ctive*ornot.*/if(!nexthop_active_update(rn,new,1)){UNSET_FLAG(new->status,ROUTE_
ENTRY_CHANGED);return;}if(IS_ZEBRA_DEBUG_RIB){charbuf[SRCDEST2STR_BUFFER];srcdes
t_rnode2str(rn,buf,sizeof(buf));zlog_debug("%u:%s:Addingroutern%p,re%p(type%d)",
zvrf_id(zvrf),buf,rn,new,new->type);}/*Iflabeled-unicastroute,installtransitLSP.
*/if(zebra_rib_labeled_unicast(new))zebra_mpls_lsp_install(zvrf,rn,new);if(!RIB_
SYSTEM_ROUTE(new))rib_install_kernel(rn,new,NULL);elsedest->selected_fib=new;UNS
ET_FLAG(new->status,ROUTE_ENTRY_CHANGED);}staticvoidrib_process_del_fib(structze
bra_vrf*zvrf,structroute_node*rn,structroute_entry*old){rib_dest_t*dest=rib_dest
_from_rnode(rn);hook_call(rib_update,rn,"removingexistingroute");/*Uninstallfrom
kernel.*/if(IS_ZEBRA_DEBUG_RIB){charbuf[SRCDEST2STR_BUFFER];srcdest_rnode2str(rn
,buf,sizeof(buf));zlog_debug("%u:%s:Deletingroutern%p,re%p(type%d)",zvrf_id(zvrf
),buf,rn,old,old->type);}/*Iflabeled-unicastroute,uninstalltransitLSP.*/if(zebra
_rib_labeled_unicast(old))zebra_mpls_lsp_uninstall(zvrf,rn,old);if(!RIB_SYSTEM_R
OUTE(old))rib_uninstall_kernel(rn,old);else{/**WearesettingthistoNULLhere*becaus
ethatiswhatwetraditionally*havebeendoing.Iamnotpositive*thatthisistherightthingt
odo*butlet'sleavethecodealone*fortheRIB_SYSTEM_ROUTEcase*/dest->selected_fib=NUL
L;}/*Updatenexthopforroute,resetchangedflag.*/nexthop_active_update(rn,old,1);UN
SET_FLAG(old->status,ROUTE_ENTRY_CHANGED);}staticvoidrib_process_update_fib(stru
ctzebra_vrf*zvrf,structroute_node*rn,structroute_entry*old,structroute_entry*new
){structnexthop*nexthop=NULL;intnh_active=0;rib_dest_t*dest=rib_dest_from_rnode(
rn);/**Wehavetoinstallorupdateifanewroutehasbeenselectedor*somethinghaschanged.*
/if(new!=old||CHECK_FLAG(new->status,ROUTE_ENTRY_CHANGED)){hook_call(rib_update,
rn,"updatingexistingroute");/*Updatethenexthop;wecoulddetermineherethatnexthopis
*inactive.*/if(nexthop_active_update(rn,new,1))nh_active=1;/*Ifnexthopisactive,i
nstalltheselectedroute,if*appropriate.If*theinstallsucceeds,cleanupflagsforprior
route,if*differentfrom*newlyselected.*/if(nh_active){if(IS_ZEBRA_DEBUG_RIB){char
buf[SRCDEST2STR_BUFFER];srcdest_rnode2str(rn,buf,sizeof(buf));if(new!=old)zlog_d
ebug("%u:%s:Updatingroutern%p,re%p(type%d)""old%p(type%d)",zvrf_id(zvrf),buf,rn,
new,new->type,old,old->type);elsezlog_debug("%u:%s:Updatingroutern%p,re%p(type%d
)",zvrf_id(zvrf),buf,rn,new,new->type);}/*Iflabeled-unicastroute,uninstalltransi
tLSP.*/if(zebra_rib_labeled_unicast(old))zebra_mpls_lsp_uninstall(zvrf,rn,old);/
*Non-systemrouteshouldbeinstalled.*/if(!RIB_SYSTEM_ROUTE(new)){/*Iflabeled-unica
stroute,installtransit*LSP.*/if(zebra_rib_labeled_unicast(new))zebra_mpls_lsp_in
stall(zvrf,rn,new);rib_install_kernel(rn,new,old);}else{/**Wedonotneedtoinstallt
he*selectedroutebecauseit*isalreadyisntalledby*thesystem(ienotus)*sojustmarkitas
winning*wedoneedtoensurethat*ifweuninstallaroute*fromourselveswedon't*overwritet
hispointer*/dest->selected_fib=NULL;}/*Ifinstallsucceededorsystemroute,cleanupfl
ags*forpriorroute.*/if(new!=old){if(RIB_SYSTEM_ROUTE(new)){if(!RIB_SYSTEM_ROUTE(
old))rib_uninstall_kernel(rn,old);}else{for(nexthop=old->ng.nexthop;nexthop;next
hop=nexthop->next)UNSET_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB);}}}/**Ifnexthopfor
selectedrouteisnotactiveorinstall*failed,we*mayneedtouninstallanddeleteforredist
ribution.*/if(!nh_active){if(IS_ZEBRA_DEBUG_RIB){charbuf[SRCDEST2STR_BUFFER];src
dest_rnode2str(rn,buf,sizeof(buf));if(new!=old)zlog_debug("%u:%s:Deletingroutern
%p,re%p(type%d)""old%p(type%d)-%s",zvrf_id(zvrf),buf,rn,new,new->type,old,old->t
ype,nh_active?"installfailed":"nexthopinactive");elsezlog_debug("%u:%s:Deletingr
outern%p,re%p(type%d)-%s",zvrf_id(zvrf),buf,rn,new,new->type,nh_active?"installf
ailed":"nexthopinactive");}/*Iflabeled-unicastroute,uninstalltransitLSP.*/if(zeb
ra_rib_labeled_unicast(old))zebra_mpls_lsp_uninstall(zvrf,rn,old);if(!RIB_SYSTEM
_ROUTE(old))rib_uninstall_kernel(rn,old);elsedest->selected_fib=NULL;}}else{/**S
amerouteselected;checkifintheFIBandifnot,*re-install.This*ishousekeepingcodetode
alwithraceconditionsinkernel*withlinux*netlinkreportinginterfaceupbeforeIPv4orIP
v6protocol*isready*toaddroutes.*/if(!RIB_SYSTEM_ROUTE(new)){boolin_fib=false;for
(ALL_NEXTHOPS(new->ng,nexthop))if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)){i
n_fib=true;break;}if(!in_fib)rib_install_kernel(rn,new,NULL);}}/*Updatepriorrout
e.*/if(new!=old){/*Setrealnexthop.*/nexthop_active_update(rn,old,1);UNSET_FLAG(o
ld->status,ROUTE_ENTRY_CHANGED);}/*Clearchangedflag.*/UNSET_FLAG(new->status,ROU
TE_ENTRY_CHANGED);}/*Checkif'alternate'RIBentryisbetterthan'current'.*/staticstr
uctroute_entry*rib_choose_best(structroute_entry*current,structroute_entry*alter
nate){if(current==NULL)returnalternate;/*filterrouteselectioninfollowingorder:*-
connectedbeatsothertypes*-lowerdistancebeatshigher*-lowermetricbeatshigherforequ
aldistance*-last,henceoldest,routewinstiebreak.*//*Connectedroutes.Pickthelastco
nnected*routeofthesetoflowestmetricconnectedroutes.*/if(alternate->type==ZEBRA_R
OUTE_CONNECT){if(current->type!=ZEBRA_ROUTE_CONNECT||alternate->metric<=current-
>metric)returnalternate;returncurrent;}if(current->type==ZEBRA_ROUTE_CONNECT)ret
urncurrent;/*higherdistanceloses*/if(alternate->distance<current->distance)retur
nalternate;if(current->distance<alternate->distance)returncurrent;/*metrictie-br
eaksequaldistance*/if(alternate->metric<=current->metric)returnalternate;returnc
urrent;}/*Corefunctionforprocessingroutinginformationbase.*/staticvoidrib_proces
s(structroute_node*rn){structroute_entry*re;structroute_entry*next;structroute_e
ntry*old_selected=NULL;structroute_entry*new_selected=NULL;structroute_entry*old
_fib=NULL;structroute_entry*new_fib=NULL;structroute_entry*best=NULL;charbuf[SRC
DEST2STR_BUFFER];rib_dest_t*dest;structzebra_vrf*zvrf=NULL;structprefix*p,*src_p
;srcdest_rnode_prefixes(rn,&p,&src_p);vrf_id_tvrf_id=VRF_UNKNOWN;assert(rn);dest
=rib_dest_from_rnode(rn);if(dest){zvrf=rib_dest_vrf(dest);vrf_id=zvrf_id(zvrf);}
if(IS_ZEBRA_DEBUG_RIB)srcdest_rnode2str(rn,buf,sizeof(buf));if(IS_ZEBRA_DEBUG_RI
B_DETAILED)zlog_debug("%u:%s:Processingrn%p",vrf_id,buf,rn);/**wecanhavern'sthat
haveaNULLinfopointer*(dest).Assuchlet'snotletthederefhappen*additionallyweknowRN
ODE_FOREACH_RE_SAFE*willnotiteratesoweareok.*/if(dest)old_fib=dest->selected_fib
;RNODE_FOREACH_RE_SAFE(rn,re,next){if(IS_ZEBRA_DEBUG_RIB_DETAILED)zlog_debug("%u
:%s:Examinere%p(type%d)status%xflags%x""dist%dmetric%d",vrf_id,buf,re,re->type,r
e->status,re->flags,re->distance,re->metric);UNSET_FLAG(re->status,ROUTE_ENTRY_N
EXTHOPS_CHANGED);/*Currentlyselectedre.*/if(CHECK_FLAG(re->flags,ZEBRA_FLAG_SELE
CTED)){assert(old_selected==NULL);old_selected=re;}/*Skipdeletedentriesfromselec
tion*/if(CHECK_FLAG(re->status,ROUTE_ENTRY_REMOVED))continue;/*Skipunreachablene
xthop.*//*Thisfirstcalltonexthop_active_updateismerelyto*determineif*there'sanyc
hangetonexthopsassociatedwiththisRIB*entry.Now,*rib_process()canbeinvokedduetoan
externaleventsuchas*link*downorduetonext-hop-trackingevaluation.Inthelatter*case
,*adecisionhasalreadybeenmadethattheNHshavechanged.*So,no*needtoinvokeapotential
lyexpensivecallagain.Further,*since*thechangemightbeinarecursiveNHwhichisnotcaug
htin*thenexthop_active_update()code.Thus,wemightmisschanges*to*recursiveNHs.*/if
(!CHECK_FLAG(re->status,ROUTE_ENTRY_CHANGED)&&!nexthop_active_update(rn,re,0)){i
f(re->type==ZEBRA_ROUTE_TABLE){/*XXX:HEREBEDRAGONS!!!!!*Inallhonesty,Ihavenotyet
figuredout*whatthispart*doesorwhytheROUTE_ENTRY_CHANGEDtest*aboveiscorrect*orwhy
weneedtodeletearoutehere,and*alsonotwhether*thisconcernsbothselectedandfibroute,
or*onlyselected*oronlyfib*//*Thisentrywasdeniedbythe'ipprotocol*table'route-map,
we*needtodeleteit*/if(re!=old_selected){if(IS_ZEBRA_DEBUG_RIB)zlog_debug("%s:%u:
%s:importedviaimport-tablebutdenied""bytheipprotocoltableroute-map",__func__,vrf
_id,buf);rib_unlink(rn,re);}elseSET_FLAG(re->status,ROUTE_ENTRY_REMOVED);}contin
ue;}/*Infinitedistance.*/if(re->distance==DISTANCE_INFINITY){UNSET_FLAG(re->stat
us,ROUTE_ENTRY_CHANGED);continue;}if(CHECK_FLAG(re->flags,ZEBRA_FLAG_FIB_OVERRID
E)){best=rib_choose_best(new_fib,re);if(new_fib&&best!=new_fib)UNSET_FLAG(new_fi
b->status,ROUTE_ENTRY_CHANGED);new_fib=best;}else{best=rib_choose_best(new_selec
ted,re);if(new_selected&&best!=new_selected)UNSET_FLAG(new_selected->status,ROUT
E_ENTRY_CHANGED);new_selected=best;}if(best!=re)UNSET_FLAG(re->status,ROUTE_ENTR
Y_CHANGED);}/*RNODE_FOREACH_RE*//*IfnoFIBoverrideroute,usetheselectedroutealsofo
rFIB*/if(new_fib==NULL)new_fib=new_selected;/*Afterthecycleisfinished,thefollowi
ngpointerswillbeset:*old_selected---REentrycurrentlyhavingSELECTED*new_selected-
--REentrythatisnewlySELECTED*old_fib---REentrycurrentlyinkernelFIB*new_fib---REe
ntrythatisnewlytobeinkernelFIB**new_selectedwillgetSELECTEDflag,andisgoingtobere
distributed*thezclients.new_fib(whichcanbenew_selected)willbeinstalled*inkernel.
*/if(IS_ZEBRA_DEBUG_RIB_DETAILED){zlog_debug("%u:%s:Afterprocessing:old_selected
%pnew_selected%pold_fib%pnew_fib%p",vrf_id,buf,(void*)old_selected,(void*)new_se
lected,(void*)old_fib,(void*)new_fib);}/*BufferROUTE_ENTRY_CHANGEDhere,becauseit
willgetclearedif*fib==selected*/boolselected_changed=new_selected&&CHECK_FLAG(ne
w_selected->status,ROUTE_ENTRY_CHANGED);/*Updatefibaccordingtoselectionresults*/
if(new_fib&&old_fib)rib_process_update_fib(zvrf,rn,old_fib,new_fib);elseif(new_f
ib)rib_process_add_fib(zvrf,rn,new_fib);elseif(old_fib)rib_process_del_fib(zvrf,
rn,old_fib);/*RedistributeSELECTEDentry*/if(old_selected!=new_selected||selected
_changed){structnexthop*nexthop=NULL;/*CheckifwehaveaFIBrouteforthedestination,o
therwise,*don'tredistributeit*/if(new_fib){for(ALL_NEXTHOPS(new_fib->ng,nexthop)
){if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)){break;}}}if(!nexthop)new_selec
ted=NULL;if(new_selected&&new_selected!=new_fib){nexthop_active_update(rn,new_se
lected,1);UNSET_FLAG(new_selected->status,ROUTE_ENTRY_CHANGED);}if(old_selected)
{if(!new_selected)redistribute_delete(p,src_p,old_selected);if(old_selected!=new
_selected)UNSET_FLAG(old_selected->flags,ZEBRA_FLAG_SELECTED);}if(new_selected){
/*Installneworreplaceexistingredistributedentry*/SET_FLAG(new_selected->flags,ZE
BRA_FLAG_SELECTED);redistribute_update(p,src_p,new_selected,old_selected);}}/*Re
moveallREentriesqueuedforremoval*/RNODE_FOREACH_RE_SAFE(rn,re,next){if(CHECK_FLA
G(re->status,ROUTE_ENTRY_REMOVED)){if(IS_ZEBRA_DEBUG_RIB){rnode_debug(rn,vrf_id,
"rn%p,removingre%p",(void*)rn,(void*)re);}rib_unlink(rn,re);}}/**Checkifthedestc
anbedeletednow.*/rib_gc_dest(rn);}/*Takealistofroute_nodestructsandreturn1,ifthe
rewasarecord*pickedfromitandprocessedbyrib_process().Don'tprocessmore,*thanoneRN
record;operateonlyinthespecifiedsub-queue.*/staticunsignedintprocess_subq(struct
list*subq,uint8_tqindex){structlistnode*lnode=listhead(subq);structroute_node*rn
ode;rib_dest_t*dest;structzebra_vrf*zvrf=NULL;if(!lnode)return0;rnode=listgetdat
a(lnode);dest=rib_dest_from_rnode(rnode);if(dest)zvrf=rib_dest_vrf(dest);rib_pro
cess(rnode);if(IS_ZEBRA_DEBUG_RIB_DETAILED){charbuf[SRCDEST2STR_BUFFER];srcdest_
rnode2str(rnode,buf,sizeof(buf));zlog_debug("%u:%s:rn%pdequeuedfromsub-queue%u",
zvrf?zvrf_id(zvrf):0,buf,rnode,qindex);}if(rnode->info)UNSET_FLAG(rib_dest_from_
rnode(rnode)->flags,RIB_ROUTE_QUEUED(qindex));#if0else{zlog_debug("%s:calledforr
oute_node(%p,%d)withnoribs",__func__,rnode,rnode->lock);zlog_backtrace(LOG_DEBUG
);}#endifroute_unlock_node(rnode);list_delete_node(subq,lnode);return1;}/**Allme
taqueueshavebeenprocessed.Triggernext-hopevaluation.*/staticvoidmeta_queue_proce
ss_complete(structwork_queue*dummy){structvrf*vrf;structzebra_vrf*zvrf;/*Evaluat
enexthopsforthoseVRFswhichunderwentrouteprocessing.*This*shouldlimittheevaluatio
ntothenecessaryVRFsinmostcommon*situations.*/RB_FOREACH(vrf,vrf_id_head,&vrfs_by
_id){zvrf=vrf->info;if(zvrf==NULL||!(zvrf->flags&ZEBRA_VRF_RIB_SCHEDULED))contin
ue;zvrf->flags&=~ZEBRA_VRF_RIB_SCHEDULED;zebra_evaluate_rnh(zvrf_id(zvrf),AF_INE
T,0,RNH_NEXTHOP_TYPE,NULL);zebra_evaluate_rnh(zvrf_id(zvrf),AF_INET,0,RNH_IMPORT
_CHECK_TYPE,NULL);zebra_evaluate_rnh(zvrf_id(zvrf),AF_INET6,0,RNH_NEXTHOP_TYPE,N
ULL);zebra_evaluate_rnh(zvrf_id(zvrf),AF_INET6,0,RNH_IMPORT_CHECK_TYPE,NULL);}/*
ScheduleLSPsforprocessing,ifneeded.*/zvrf=vrf_info_lookup(VRF_DEFAULT);if(mpls_s
hould_lsps_be_processed(zvrf)){if(IS_ZEBRA_DEBUG_MPLS)zlog_debug("%u:Schedulinga
llLSPsuponRIBcompletion",zvrf_id(zvrf));zebra_mpls_lsp_schedule(zvrf);mpls_unmar
k_lsps_for_processing(zvrf);}}/*Dispatchthemetaqueuebypicking,processingandunloc
kingthenextRNfrom*anon-emptysub-queuewithlowestpriority.wqisequaltozebra->ribqan
d*data*ispointedtothemetaqueuestructure.*/staticwq_item_statusmeta_queue_process
(structwork_queue*dummy,void*data){structmeta_queue*mq=data;unsignedi;for(i=0;i<
MQ_SIZE;i++)if(process_subq(mq->subq[i],i)){mq->size--;break;}returnmq->size?WQ_
REQUEUE:WQ_SUCCESS;}/**Mapfromribtypestoqueuetype(priority)inmetaqueue*/staticco
nstuint8_tmeta_queue_map[ZEBRA_ROUTE_MAX]={[ZEBRA_ROUTE_SYSTEM]=4,[ZEBRA_ROUTE_K
ERNEL]=0,[ZEBRA_ROUTE_CONNECT]=0,[ZEBRA_ROUTE_STATIC]=1,[ZEBRA_ROUTE_RIP]=2,[ZEB
RA_ROUTE_RIPNG]=2,[ZEBRA_ROUTE_OSPF]=2,[ZEBRA_ROUTE_OSPF6]=2,[ZEBRA_ROUTE_ISIS]=
2,[ZEBRA_ROUTE_BGP]=3,[ZEBRA_ROUTE_PIM]=4,//Shouldn'thappenbutforsafety[ZEBRA_RO
UTE_EIGRP]=2,[ZEBRA_ROUTE_NHRP]=2,[ZEBRA_ROUTE_HSLS]=4,[ZEBRA_ROUTE_OLSR]=4,[ZEB
RA_ROUTE_TABLE]=1,[ZEBRA_ROUTE_LDP]=4,[ZEBRA_ROUTE_VNC]=3,[ZEBRA_ROUTE_VNC_DIREC
T]=3,[ZEBRA_ROUTE_VNC_DIRECT_RH]=3,[ZEBRA_ROUTE_BGP_DIRECT]=3,[ZEBRA_ROUTE_BGP_D
IRECT_EXT]=3,[ZEBRA_ROUTE_BABEL]=2,[ZEBRA_ROUTE_ALL]=4,//Shouldn'thappenbutforsa
fety};/*LookintotheRNandqueueitintooneormorepriorityqueues,*increasingthesizefor
eachdatapushdone.*/staticvoidrib_meta_queue_add(structmeta_queue*mq,structroute_
node*rn){structroute_entry*re;RNODE_FOREACH_RE(rn,re){uint8_tqindex=meta_queue_m
ap[re->type];structzebra_vrf*zvrf;/*Invariant:atthispointwealwayshavern->infoset
.*/if(CHECK_FLAG(rib_dest_from_rnode(rn)->flags,RIB_ROUTE_QUEUED(qindex))){if(IS
_ZEBRA_DEBUG_RIB_DETAILED)rnode_debug(rn,re->vrf_id,"rn%pisalreadyqueuedinsub-qu
eue%u",(void*)rn,qindex);continue;}SET_FLAG(rib_dest_from_rnode(rn)->flags,RIB_R
OUTE_QUEUED(qindex));listnode_add(mq->subq[qindex],rn);route_lock_node(rn);mq->s
ize++;if(IS_ZEBRA_DEBUG_RIB_DETAILED)rnode_debug(rn,re->vrf_id,"queuedrn%pintosu
b-queue%u",(void*)rn,qindex);zvrf=zebra_vrf_lookup_by_id(re->vrf_id);if(zvrf)zvr
f->flags|=ZEBRA_VRF_RIB_SCHEDULED;}}/*Addroute_nodetoworkqueueandscheduleprocess
ing*/voidrib_queue_add(structroute_node*rn){assert(rn);/*Pointlesstoqueuearoute_
nodewithnoRIBentriestoaddorremove*/if(!rnode_to_ribs(rn)){zlog_debug("%s:calledf
orroute_node(%p,%d)withnoribs",__func__,(void*)rn,rn->lock);zlog_backtrace(LOG_D
EBUG);return;}if(zebrad.ribq==NULL){zlog_err("%s:work_queuedoesnotexist!",__func
__);return;}/**TheRIBqueueshouldnormallybeeitheremptyorholdingtheonly*work_queue
_itemelement.Inthelattercasethiselementwould*holdapointertothemetaqueuestructure
,whichmustbeusedto*actuallyqueuetheroutenodestoprocess.SocreatetheMQ*holder,ifne
cessary,thenpushtheworkintoitinanycase.*Thissemanticswasintroducedafter0.99.9rel
ease.*/if(work_queue_empty(zebrad.ribq))work_queue_add(zebrad.ribq,zebrad.mq);ri
b_meta_queue_add(zebrad.mq,rn);return;}/*Createnewmetaqueue.Adestructorfunctiond
oesn'tseemtobenecessaryhere.*/staticstructmeta_queue*meta_queue_new(void){struct
meta_queue*new;unsignedi;new=XCALLOC(MTYPE_WORK_QUEUE,sizeof(structmeta_queue));
assert(new);for(i=0;i<MQ_SIZE;i++){new->subq[i]=list_new();assert(new->subq[i]);
}returnnew;}voidmeta_queue_free(structmeta_queue*mq){unsignedi;for(i=0;i<MQ_SIZE
;i++)list_delete_and_null(&mq->subq[i]);XFREE(MTYPE_WORK_QUEUE,mq);}/*initialise
zebraribworkqueue*/staticvoidrib_queue_init(structzebra_t*zebra){assert(zebra);i
f(!(zebra->ribq=work_queue_new(zebra->master,"route_nodeprocessing"))){zlog_err(
"%s:couldnotinitialiseworkqueue!",__func__);return;}/*fillintheworkqueuespec*/ze
bra->ribq->spec.workfunc=&meta_queue_process;zebra->ribq->spec.errorfunc=NULL;ze
bra->ribq->spec.completion_func=&meta_queue_process_complete;/*XXX:TODO:Thesesho
uldberuntimeconfigurableviavty*/zebra->ribq->spec.max_retries=3;zebra->ribq->spe
c.hold=ZEBRA_RIB_PROCESS_HOLD_TIME;if(!(zebra->mq=meta_queue_new())){zlog_err("%
s:couldnotinitialisemetaqueue!",__func__);return;}return;}/*RIBupdatesareprocess
edviaaqueueofpointerstoroute_nodes.**Thequeuelengthisboundedbythemaximalsizeofth
eroutingtable,*asaroute_nodewillnotberequeued,ifalreadyqueued.**REsaresubmittedv
iarib_addnodeorrib_delnodewhichsetminimal*state,orstatic_install_route(whenanexi
stingREisupdated)*andthensubmitroute_nodetoqueueforbest-pathselectionlater.*Orde
rofadd/deletestatechangesarepreservedforanygivenRE.**DeletedREsarereapedduringbe
st-pathselection.**rib_addnode*|->rib_linkorunsetROUTE_ENTRY_REMOVE|->Updatekern
elwith*|-------->||bestRE,ifrequired*||*static_install->|->rib_addqueue......->r
ib_process*||*|-------->||->rib_unlink*|->setROUTE_ENTRY_REMOVE|*rib_delnode(REf
reed)**The'info'pointerofaroute_nodepointstoarib_dest_t*('dest').Queueingstatefo
raroute_nodeiskeptonthedest.The*destiscreatedon-demandbyrib_link()andiskeptaroun
datleast*aslongasthereareribshangingoffit(@seerib_gc_dest()).**Refcounting(aka"l
ocking"throughouttheGNUZebraandQuaggacode):**-route_nodes:refcountedby:*-destatt
achedtoroute_node:*-managedby:rib_link/rib_gc_dest*-route_nodeprocessingqueue*-m
anagedby:rib_addqueue,rib_process.**//*AddREtoheadoftheroutenode.*/staticvoidrib
_link(structroute_node*rn,structroute_entry*re,intprocess){structroute_entry*hea
d;rib_dest_t*dest;afi_tafi;constchar*rmap_name;assert(re&&rn);dest=rib_dest_from
_rnode(rn);if(!dest){if(IS_ZEBRA_DEBUG_RIB_DETAILED)rnode_debug(rn,re->vrf_id,"r
n%paddingdest",rn);dest=XCALLOC(MTYPE_RIB_DEST,sizeof(rib_dest_t));route_lock_no
de(rn);/*rnroutetablereference*/rn->info=dest;dest->rnode=rn;}head=dest->routes;
if(head){head->prev=re;}re->next=head;dest->routes=re;afi=(rn->p.family==AF_INET
)?AFI_IP:(rn->p.family==AF_INET6)?AFI_IP6:AFI_MAX;if(is_zebra_import_table_enabl
ed(afi,re->table)){rmap_name=zebra_get_import_table_route_map(afi,re->table);zeb
ra_add_import_table_entry(rn,re,rmap_name);}elseif(process)rib_queue_add(rn);}vo
idrib_addnode(structroute_node*rn,structroute_entry*re,intprocess){/*REnodehasbe
enun-removedbeforeroute-nodeisprocessed.*route_nodemusthencealreadybeonthequeuef
orprocessing..*/if(CHECK_FLAG(re->status,ROUTE_ENTRY_REMOVED)){if(IS_ZEBRA_DEBUG
_RIB)rnode_debug(rn,re->vrf_id,"rn%p,un-removedre%p",(void*)rn,(void*)re);UNSET_
FLAG(re->status,ROUTE_ENTRY_REMOVED);return;}rib_link(rn,re,process);}/**rib_unl
ink**Detacharibstructurefromaroute_node.**Notethatacalltorib_unlink()shouldbefol
lowedbyacallto*rib_gc_dest()atsomepoint.Thisallowsarib_dest_tthatisno*longerrequ
iredtobedeleted.*/voidrib_unlink(structroute_node*rn,structroute_entry*re){rib_d
est_t*dest;assert(rn&&re);if(IS_ZEBRA_DEBUG_RIB)rnode_debug(rn,re->vrf_id,"rn%p,
re%p",(void*)rn,(void*)re);dest=rib_dest_from_rnode(rn);if(re->next)re->next->pr
ev=re->prev;if(re->prev)re->prev->next=re->next;else{dest->routes=re->next;}if(d
est->selected_fib==re)dest->selected_fib=NULL;/*freeREandnexthops*/if(re->type==
ZEBRA_ROUTE_STATIC)zebra_deregister_rnh_static_nexthops(re->vrf_id,re->ng.nextho
p,rn);nexthops_free(re->ng.nexthop);XFREE(MTYPE_RE,re);}voidrib_delnode(structro
ute_node*rn,structroute_entry*re){afi_tafi;if(IS_ZEBRA_DEBUG_RIB)rnode_debug(rn,
re->vrf_id,"rn%p,re%p,removing",(void*)rn,(void*)re);SET_FLAG(re->status,ROUTE_E
NTRY_REMOVED);afi=(rn->p.family==AF_INET)?AFI_IP:(rn->p.family==AF_INET6)?AFI_IP
6:AFI_MAX;if(is_zebra_import_table_enabled(afi,re->table)){zebra_del_import_tabl
e_entry(rn,re);/*Justcleanupifnonmaintable*/if(IS_ZEBRA_DEBUG_RIB){charbuf[SRCDE
ST2STR_BUFFER];srcdest_rnode2str(rn,buf,sizeof(buf));zlog_debug("%u:%s:Freeingro
utern%p,re%p(type%d)",re->vrf_id,buf,rn,re,re->type);}rib_unlink(rn,re);}else{ri
b_queue_add(rn);}}/*ThisfunctiondumpsthecontentsofagivenREentryinto*standarddebu
glog.CallingfunctionnameandIPprefixin*questionarepassedas1stand2ndarguments.*/vo
id_route_entry_dump(constchar*func,unionprefixconstptrpp,unionprefixconstptrsrc_
pp,conststructroute_entry*re){conststructprefix*p=pp.p;conststructprefix*src_p=s
rc_pp.p;boolis_srcdst=src_p&&src_p->prefixlen;charstraddr[PREFIX_STRLEN];charsrc
addr[PREFIX_STRLEN];structnexthop*nexthop;zlog_debug("%s:dumpingREentry%pfor%s%s
%svrf%u",func,(constvoid*)re,prefix2str(pp,straddr,sizeof(straddr)),is_srcdst?"f
rom":"",is_srcdst?prefix2str(src_pp,srcaddr,sizeof(srcaddr)):"",re->vrf_id);zlog
_debug("%s:uptime==%lu,type==%u,instance==%d,table==%d",func,(unsignedlong)re->u
ptime,re->type,re->instance,re->table);zlog_debug("%s:metric==%u,mtu==%u,distanc
e==%u,flags==%u,status==%u",func,re->metric,re->mtu,re->distance,re->flags,re->s
tatus);zlog_debug("%s:nexthop_num==%u,nexthop_active_num==%u",func,re->nexthop_n
um,re->nexthop_active_num);for(ALL_NEXTHOPS(re->ng,nexthop)){inet_ntop(p->family
,&nexthop->gate,straddr,INET6_ADDRSTRLEN);zlog_debug("%s:%s%s[%u]vrf%uwithflags%
s%s%s",func,(nexthop->rparent?"NH":"NH"),straddr,nexthop->ifindex,nexthop->vrf_i
d,(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_ACTIVE)?"ACTIVE":""),(CHECK_FLAG(nexth
op->flags,NEXTHOP_FLAG_FIB)?"FIB":""),(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_RE
CURSIVE)?"RECURSIVE":""));}zlog_debug("%s:dumpcomplete",func);}/*Thisisanexporte
dhelpertortm_read()todumpthestrange*REentryfoundbyrib_lookup_ipv4_route()*/voidr
ib_lookup_and_dump(structprefix_ipv4*p,vrf_id_tvrf_id){structroute_table*table;s
tructroute_node*rn;structroute_entry*re;charprefix_buf[INET_ADDRSTRLEN];/*Lookup
table.*/table=zebra_vrf_table(AFI_IP,SAFI_UNICAST,vrf_id);if(!table){zlog_err("%
s:%uzebra_vrf_table()returnedNULL",__func__,vrf_id);return;}/*ScantheRIBtablefor
exactlymatchingREentry.*/rn=route_node_lookup(table,(structprefix*)p);/*Noroutef
orthisprefix.*/if(!rn){zlog_debug("%s:%ulookupfailedfor%s",__func__,vrf_id,prefi
x2str((structprefix*)p,prefix_buf,sizeof(prefix_buf)));return;}/*Unlocknode.*/ro
ute_unlock_node(rn);/*let'sgo*/RNODE_FOREACH_RE(rn,re){zlog_debug("%s:%urn%p,re%
p:%s,%s",__func__,vrf_id,(void*)rn,(void*)re,(CHECK_FLAG(re->status,ROUTE_ENTRY_
REMOVED)?"removed":"NOTremoved"),(CHECK_FLAG(re->flags,ZEBRA_FLAG_SELECTED)?"sel
ected":"NOTselected"));route_entry_dump(p,NULL,re);}}/*Checkifrequestedaddressas
signmentwillfailduetoanother*routebeinginstalledbyzebrainFIBalready.Takenecessar
y*actions,ifneeded:removesucharoutefromFIBanddeSELECT*correspondingREentry.Thenp
utaffectedRNintoRIBQhead.*/voidrib_lookup_and_pushup(structprefix_ipv4*p,vrf_id_
tvrf_id){structroute_table*table;structroute_node*rn;unsignedchanged=0;rib_dest_
t*dest;if(NULL==(table=zebra_vrf_table(AFI_IP,SAFI_UNICAST,vrf_id))){zlog_err("%
s:%uzebra_vrf_table()returnedNULL",__func__,vrf_id);return;}/*Nomatcheswouldbeth
esimplestcase.*/if(NULL==(rn=route_node_lookup(table,(structprefix*)p)))return;/
*Unlocknode.*/route_unlock_node(rn);dest=rib_dest_from_rnode(rn);/*CheckallREent
ries.Incaseanychangeshavetobedone,requeue*theRNintoRIBQhead.Iftheroutingmessagea
boutthenewconnected*route(generatedbytheIPaddresswearegoingtoassignverysoon)*com
esbeforetheRIBQisprocessed,thenewREentrywilljoin*RIBQrecordalreadyonhead.Thisisn
ecessaryforproper*revalidation*oftherestoftheRE.*/if(dest->selected_fib&&!RIB_SY
STEM_ROUTE(dest->selected_fib)){changed=1;if(IS_ZEBRA_DEBUG_RIB){charbuf[PREFIX_
STRLEN];zlog_debug("%u:%s:freeingwayforconnectedprefix",dest->selected_fib->vrf_
id,prefix2str(&rn->p,buf,sizeof(buf)));route_entry_dump(&rn->p,NULL,dest->select
ed_fib);}rib_uninstall(rn,dest->selected_fib);}if(changed)rib_queue_add(rn);}int
rib_add_multipath(afi_tafi,safi_tsafi,structprefix*p,structprefix_ipv6*src_p,str
uctroute_entry*re){structroute_table*table;structroute_node*rn;structroute_entry
*same;structnexthop*nexthop;intret=0;if(!re)return0;assert(!src_p||afi==AFI_IP6)
;/*Lookuptable.*/table=zebra_vrf_table_with_table_id(afi,safi,re->vrf_id,re->tab
le);if(!table){XFREE(MTYPE_RE,re);return0;}/*Makeitsureprefixlenisappliedtothepr
efix.*/apply_mask(p);if(src_p)apply_mask_ipv6(src_p);/*Setdefaultdistancebyroute
type.*/if(re->distance==0){re->distance=route_distance(re->type);/*iBGPdistancei
s200.*/if(re->type==ZEBRA_ROUTE_BGP&&CHECK_FLAG(re->flags,ZEBRA_FLAG_IBGP))re->d
istance=200;}/*Lookuproutenode.*/rn=srcdest_rnode_get(table,p,src_p);/*Ifsametyp
eofrouteareinstalled,treatitasaimplicitwithdraw.*/RNODE_FOREACH_RE(rn,same){if(C
HECK_FLAG(same->status,ROUTE_ENTRY_REMOVED))continue;if(same->type!=re->type)con
tinue;if(same->instance!=re->instance)continue;if(same->type==ZEBRA_ROUTE_KERNEL
&&same->metric!=re->metric)continue;/**Weshouldallowduplicateconnectedroutesbeca
useof*IPv6link-localroutesandunnumberedinterfacesonLinux.*/if(same->type!=ZEBRA_
ROUTE_CONNECT)break;}/*Ifthisrouteiskernelroute,setFIBflagtotheroute.*/if(RIB_SY
STEM_ROUTE(re))for(nexthop=re->ng.nexthop;nexthop;nexthop=nexthop->next)SET_FLAG
(nexthop->flags,NEXTHOP_FLAG_FIB);/*Linknewretonode.*/if(IS_ZEBRA_DEBUG_RIB){rno
de_debug(rn,re->vrf_id,"Insertingroutern%p,re%p(type%d)existing%p",(void*)rn,(vo
id*)re,re->type,(void*)same);if(IS_ZEBRA_DEBUG_RIB_DETAILED)route_entry_dump(p,s
rc_p,re);}rib_addnode(rn,re,1);ret=1;/*Freeimplicitroute.*/if(same){rib_delnode(
rn,same);ret=-1;}route_unlock_node(rn);returnret;}voidrib_delete(afi_tafi,safi_t
safi,vrf_id_tvrf_id,inttype,unsignedshortinstance,intflags,structprefix*p,struct
prefix_ipv6*src_p,conststructnexthop*nh,uint32_ttable_id,uint32_tmetric,boolfrom
kernel,structethaddr*rmac){structroute_table*table;structroute_node*rn;structrou
te_entry*re;structroute_entry*fib=NULL;structroute_entry*same=NULL;structnexthop
*rtnh;charbuf2[INET6_ADDRSTRLEN];rib_dest_t*dest;assert(!src_p||afi==AFI_IP6);/*
Lookuptable.*/table=zebra_vrf_table_with_table_id(afi,safi,vrf_id,table_id);if(!
table)return;/*Applymask.*/apply_mask(p);if(src_p)apply_mask_ipv6(src_p);/*Looku
proutenode.*/rn=srcdest_rnode_lookup(table,p,src_p);if(!rn){chardst_buf[PREFIX_S
TRLEN],src_buf[PREFIX_STRLEN];prefix2str(p,dst_buf,sizeof(dst_buf));if(src_p&&sr
c_p->prefixlen)prefix2str(src_p,src_buf,sizeof(src_buf));elsesrc_buf[0]='\0';if(
IS_ZEBRA_DEBUG_RIB)zlog_debug("%u:%s%s%sdoesn'texistinrib",vrf_id,dst_buf,(src_b
uf[0]!='\0')?"from":"",src_buf);return;}dest=rib_dest_from_rnode(rn);fib=dest->s
elected_fib;/*Lookupsametyperoute.*/RNODE_FOREACH_RE(rn,re){if(CHECK_FLAG(re->st
atus,ROUTE_ENTRY_REMOVED))continue;if(re->type!=type)continue;if(re->instance!=i
nstance)continue;if(re->type==ZEBRA_ROUTE_KERNEL&&re->metric!=metric)continue;if
(re->type==ZEBRA_ROUTE_CONNECT&&(rtnh=re->ng.nexthop)&&rtnh->type==NEXTHOP_TYPE_
IFINDEX&&nh){if(rtnh->ifindex!=nh->ifindex)continue;same=re;break;}/*Makesuretha
ttheroutefoundhasthesamegateway.*/else{if(nh==NULL){same=re;break;}for(ALL_NEXTH
OPS(re->ng,rtnh))if(nexthop_same_no_recurse(rtnh,nh)){same=re;break;}if(same)bre
ak;}}/*Ifsametypeofroutecan'tbefoundandthismessageisfromkernel.*/if(!same){/**In
thepast(HA!)wecouldgetherebecause*wewerereceivingaroutedeletefromthe*kernelandwe
'renotmarkingtheproto*ascomingfromit'sappropriateoriginator.*Nowthatweareproperl
ynoticingthefact*thatthekernelhasdeletedourroutewe*arenotgoingtogetcalledinthisp
ath*Iamgoingtoleavethisherebecause*thismightstillworkthiswayonnon-linux*platform
saswellassomeweirdstateIhave*notproperlythoughtofyet.*Ifwecanshowthatthiscodepat
his*deadthenwecanremoveit.*/if(fib&&type==ZEBRA_ROUTE_KERNEL&&CHECK_FLAG(flags,Z
EBRA_FLAG_SELFROUTE)){if(IS_ZEBRA_DEBUG_RIB){rnode_debug(rn,vrf_id,"rn%p,re%p(ty
pe%d)wasdeletedfromkernel,adding",rn,fib,fib->type);}if(allow_delete){/*Unsetfla
gs.*/for(rtnh=fib->ng.nexthop;rtnh;rtnh=rtnh->next)UNSET_FLAG(rtnh->flags,NEXTHO
P_FLAG_FIB);/**ThisisanonFRRroute*assuchweshouldmark*itasdeleted*/dest->selected
_fib=NULL;}else{/*Thismeanssomeoneelse,otherthanZebra,*hasdeleted*aZebrarouterfr
omthekernel.Wewilladd*itback*/rib_install_kernel(rn,fib,NULL);}}else{if(IS_ZEBRA
_DEBUG_RIB){if(nh)rnode_debug(rn,vrf_id,"via%sifindex%dtype%d""doesn'texistinrib
",inet_ntop(family2afi(afi),&nh->gate,buf2,INET_ADDRSTRLEN),/*FIXME*/nh->ifindex
,type);elsernode_debug(rn,vrf_id,"type%ddoesn'texistinrib",type);}route_unlock_n
ode(rn);return;}}if(same){if(fromkernel&&CHECK_FLAG(flags,ZEBRA_FLAG_SELFROUTE)&
&!allow_delete){rib_install_kernel(rn,same,NULL);route_unlock_node(rn);return;}i
f(CHECK_FLAG(flags,ZEBRA_FLAG_EVPN_ROUTE)){structnexthop*tmp_nh;for(ALL_NEXTHOPS
(re->ng,tmp_nh)){structipaddrvtep_ip;memset(&vtep_ip,0,sizeof(structipaddr));if(
afi==AFI_IP){vtep_ip.ipa_type=IPADDR_V4;memcpy(&(vtep_ip.ipaddr_v4),&(tmp_nh->ga
te.ipv4),sizeof(structin_addr));}else{vtep_ip.ipa_type=IPADDR_V6;memcpy(&(vtep_i
p.ipaddr_v6),&(tmp_nh->gate.ipv6),sizeof(structin6_addr));}zebra_vxlan_evpn_vrf_
route_del(re->vrf_id,rmac,&vtep_ip,p);}}rib_delnode(rn,same);}route_unlock_node(
rn);return;}intrib_add(afi_tafi,safi_tsafi,vrf_id_tvrf_id,inttype,unsignedshorti
nstance,intflags,structprefix*p,structprefix_ipv6*src_p,conststructnexthop*nh,ui
nt32_ttable_id,uint32_tmetric,uint32_tmtu,uint8_tdistance,route_tag_ttag){struct
route_entry*re;structnexthop*nexthop;/*Allocatenewroute_entrystructure.*/re=XCAL
LOC(MTYPE_RE,sizeof(structroute_entry));re->type=type;re->instance=instance;re->
distance=distance;re->flags=flags;re->metric=metric;re->mtu=mtu;re->table=table_
id;re->vrf_id=vrf_id;re->nexthop_num=0;re->uptime=time(NULL);re->tag=tag;/*Addne
xthop.*/nexthop=nexthop_new();*nexthop=*nh;route_entry_nexthop_add(re,nexthop);r
eturnrib_add_multipath(afi,safi,p,src_p,re);}/*Scheduleroutesofaparticulartable(
address-family)basedonevent.*/staticvoidrib_update_table(structroute_table*table
,rib_update_event_tevent){structroute_node*rn;structroute_entry*re,*next;/*Walka
llroutesandqueueforprocessing,ifappropriatefor*thetriggerevent.*/for(rn=route_to
p(table);rn;rn=srcdest_route_next(rn)){/**Ifwearelookingataroutenodeandthenode*h
asalreadybeenqueuedwedon't*needtoqueueitupagain*/if(rn->info&&CHECK_FLAG(rib_des
t_from_rnode(rn)->flags,RIB_ROUTE_ANY_QUEUED))continue;switch(event){caseRIB_UPD
ATE_IF_CHANGE:/*Examineallroutesthatwon'tgetprocessedbythe*protocolor*triggeredb
ynexthopevaluation(NHT).Thiswouldbe*system,*kernelandcertainstaticroutes.Notetha
tNHTwill*get*triggereduponaninterfaceeventasconnectedroutes*always*getqueuedforp
rocessing.*/RNODE_FOREACH_RE_SAFE(rn,re,next){structnexthop*nh;if(re->type!=ZEBR
A_ROUTE_SYSTEM&&re->type!=ZEBRA_ROUTE_KERNEL&&re->type!=ZEBRA_ROUTE_CONNECT&&re-
>type!=ZEBRA_ROUTE_STATIC)continue;if(re->type!=ZEBRA_ROUTE_STATIC){rib_queue_ad
d(rn);continue;}for(nh=re->ng.nexthop;nh;nh=nh->next)if(!(nh->type==NEXTHOP_TYPE
_IPV4||nh->type==NEXTHOP_TYPE_IPV6))break;/*Ifweonlyhavenexthopstoa*gateway,NHTw
ill*takecare.*/if(nh)rib_queue_add(rn);}break;caseRIB_UPDATE_RMAP_CHANGE:caseRIB
_UPDATE_OTHER:/*Rightnow,examineallroutes.Canrestricttoa*protocolin*somecases(TO
DO).*/if(rnode_to_ribs(rn))rib_queue_add(rn);break;default:break;}}}/*RIBupdatef
unction.*/voidrib_update(vrf_id_tvrf_id,rib_update_event_tevent){structroute_tab
le*table;/*Processroutesofinterestedaddress-families.*/table=zebra_vrf_table(AFI
_IP,SAFI_UNICAST,vrf_id);if(table)rib_update_table(table,event);table=zebra_vrf_
table(AFI_IP6,SAFI_UNICAST,vrf_id);if(table)rib_update_table(table,event);}/*Del
eteselfinstalledroutesafterzebraisrelaunched.*/voidrib_sweep_table(structroute_t
able*table){structroute_node*rn;structroute_entry*re;structroute_entry*next;stru
ctnexthop*nexthop;if(!table)return;for(rn=route_top(table);rn;rn=srcdest_route_n
ext(rn)){RNODE_FOREACH_RE_SAFE(rn,re,next){if(IS_ZEBRA_DEBUG_RIB)route_entry_dum
p(&rn->p,NULL,re);if(CHECK_FLAG(re->status,ROUTE_ENTRY_REMOVED))continue;if(!CHE
CK_FLAG(re->flags,ZEBRA_FLAG_SELFROUTE))continue;/**Sowearestartingupandhaverece
ived*routesfromthekernelthatwehaveinstalled*fromapreviousrunofzebrabutnotcleaned
*up(sayakill-9)*Butsincewehaven'tactuallyinstalled*themyet(wereceivedthemfromthe
kernel)*wedon'tthinktheyareactive.*Solet'spretendtheyareactivetoactually*removet
hem.*InallhonestyI'mnotsureifweshould*markthemasactivewhenwereceivethem*Thisisst
artuponlysoprobablyok.**Ifweeverdecidetomoverib_sweep_table*toadifferentspot(ies
tartup)*thisdecisionneedstoberevisited*/for(ALL_NEXTHOPS(re->ng,nexthop))SET_FLA
G(nexthop->flags,NEXTHOP_FLAG_FIB);rib_uninstall_kernel(rn,re);rib_delnode(rn,re
);}}}/*SweepallRIBtables.*/voidrib_sweep_route(void){structvrf*vrf;structzebra_v
rf*zvrf;RB_FOREACH(vrf,vrf_id_head,&vrfs_by_id){if((zvrf=vrf->info)==NULL)contin
ue;rib_sweep_table(zvrf->table[AFI_IP][SAFI_UNICAST]);rib_sweep_table(zvrf->tabl
e[AFI_IP6][SAFI_UNICAST]);}zebra_ns_sweep_route();}/*Removespecificbyprotocolrou
tesfrom'table'.*/unsignedlongrib_score_proto_table(uint8_tproto,unsignedshortins
tance,structroute_table*table){structroute_node*rn;structroute_entry*re;structro
ute_entry*next;unsignedlongn=0;if(table)for(rn=route_top(table);rn;rn=srcdest_ro
ute_next(rn))RNODE_FOREACH_RE_SAFE(rn,re,next){if(CHECK_FLAG(re->status,ROUTE_EN
TRY_REMOVED))continue;if(re->type==proto&&re->instance==instance){rib_delnode(rn
,re);n++;}}returnn;}/*Removespecificbyprotocolroutes.*/unsignedlongrib_score_pro
to(uint8_tproto,unsignedshortinstance){structvrf*vrf;structzebra_vrf*zvrf;unsign
edlongcnt=0;RB_FOREACH(vrf,vrf_id_head,&vrfs_by_id)if((zvrf=vrf->info)!=NULL)cnt
+=rib_score_proto_table(proto,instance,zvrf->table[AFI_IP][SAFI_UNICAST])+rib_sc
ore_proto_table(proto,instance,zvrf->table[AFI_IP6][SAFI_UNICAST]);cnt+=zebra_ns
_score_proto(proto,instance);returncnt;}/*CloseRIBandcleanupkernelroutes.*/voidr
ib_close_table(structroute_table*table){structroute_node*rn;rib_table_info_t*inf
o;rib_dest_t*dest;if(!table)return;info=table->info;for(rn=route_top(table);rn;r
n=srcdest_route_next(rn)){dest=rib_dest_from_rnode(rn);if(dest&&dest->selected_f
ib){if(info->safi==SAFI_UNICAST)hook_call(rib_update,rn,NULL);if(!RIB_SYSTEM_ROU
TE(dest->selected_fib))rib_uninstall_kernel(rn,dest->selected_fib);}}}/*Routingi
nformationbaseinitialize.*/voidrib_init(void){rib_queue_init(&zebrad);}/**vrf_id
_get_next**Getthefirstvrfidthatisgreaterthanthegivenvrfidifany.**ReturnsTRUEifav
rfidwasfound,FALSEotherwise.*/staticinlineintvrf_id_get_next(vrf_id_tvrf_id,vrf_
id_t*next_id_p){structvrf*vrf;vrf=vrf_lookup_by_id(vrf_id);if(vrf){vrf=RB_NEXT(v
rf_id_head,vrf);if(vrf){*next_id_p=vrf->vrf_id;return1;}}return0;}/**rib_tables_
iter_next**Returnsthenexttableintheiteration.*/structroute_table*rib_tables_iter
_next(rib_tables_iter_t*iter){structroute_table*table;/**Arraythathelpsusgoovera
llAFI/SAFIcombinationsviaone*index.*/staticstruct{afi_tafi;safi_tsafi;}afi_safis
[]={{AFI_IP,SAFI_UNICAST},{AFI_IP,SAFI_MULTICAST},{AFI_IP,SAFI_LABELED_UNICAST},
{AFI_IP6,SAFI_UNICAST},{AFI_IP6,SAFI_MULTICAST},{AFI_IP6,SAFI_LABELED_UNICAST},}
;table=NULL;switch(iter->state){caseRIB_TABLES_ITER_S_INIT:iter->vrf_id=VRF_DEFA
ULT;iter->afi_safi_ix=-1;/*Fallthrough*/caseRIB_TABLES_ITER_S_ITERATING:iter->af
i_safi_ix++;while(1){while(iter->afi_safi_ix<(int)ZEBRA_NUM_OF(afi_safis)){table
=zebra_vrf_table(afi_safis[iter->afi_safi_ix].afi,afi_safis[iter->afi_safi_ix].s
afi,iter->vrf_id);if(table)break;iter->afi_safi_ix++;}/**Foundanothertableinthis
vrf.*/if(table)break;/**Donewithalltablesinthecurrentvrf,gotothe*next*one.*/if(!
vrf_id_get_next(iter->vrf_id,&iter->vrf_id))break;iter->afi_safi_ix=0;}break;cas
eRIB_TABLES_ITER_S_DONE:returnNULL;}if(table)iter->state=RIB_TABLES_ITER_S_ITERA
TING;elseiter->state=RIB_TABLES_ITER_S_DONE;returntable;}