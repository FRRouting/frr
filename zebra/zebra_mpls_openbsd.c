/**Copyright(C)2016byOpenSourceRouting.**ThisfileispartofGNUZebra.**GNUZebraisfr
eesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublic
Licenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)an
y*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANY
WARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARP
URPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopy
oftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writet
otheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*
/#include<zebra.h>#ifdefOPEN_BSD#include<netmpls/mpls.h>#include"zebra/rt.h"#inc
lude"zebra/zebra_mpls.h"#include"zebra/debug.h"#include"privs.h"#include"prefix.
h"#include"interface.h"#include"log.h"externstructzebra_privs_tzserv_privs;struc
t{uint32_trtseq;intfd;intioctl_fd;}kr_state;staticintkernel_send_rtmsg_v4(intact
ion,mpls_label_tin_label,zebra_nhlfe_t*nhlfe){structioveciov[5];structrt_msghdrh
dr;structsockaddr_mplssa_label_in,sa_label_out;structsockaddr_innexthop;intiovcn
t=0;intret;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("%s:0x%x,label=%u",__func__,actio
n,in_label);/*initializeheader*/memset(&hdr,0,sizeof(hdr));hdr.rtm_version=RTM_V
ERSION;hdr.rtm_type=action;hdr.rtm_flags=RTF_UP;hdr.rtm_fmask=RTF_MPLS;hdr.rtm_s
eq=kr_state.rtseq++;/*overflowdoesn'tmatter*/hdr.rtm_msglen=sizeof(hdr);hdr.rtm_
hdrlen=sizeof(structrt_msghdr);hdr.rtm_priority=0;/*adjustiovec*/iov[iovcnt].iov
_base=&hdr;iov[iovcnt++].iov_len=sizeof(hdr);/*inlabel*/memset(&sa_label_in,0,si
zeof(sa_label_in));sa_label_in.smpls_len=sizeof(sa_label_in);sa_label_in.smpls_f
amily=AF_MPLS;sa_label_in.smpls_label=htonl(in_label<<MPLS_LABEL_OFFSET);/*adjus
theader*/hdr.rtm_flags|=RTF_MPLS|RTF_MPATH;hdr.rtm_addrs|=RTA_DST;hdr.rtm_msglen
+=sizeof(sa_label_in);/*adjustiovec*/iov[iovcnt].iov_base=&sa_label_in;iov[iovcn
t++].iov_len=sizeof(sa_label_in);/*nexthop*/memset(&nexthop,0,sizeof(nexthop));n
exthop.sin_len=sizeof(nexthop);nexthop.sin_family=AF_INET;nexthop.sin_addr=nhlfe
->nexthop->gate.ipv4;/*adjustheader*/hdr.rtm_flags|=RTF_GATEWAY;hdr.rtm_addrs|=R
TA_GATEWAY;hdr.rtm_msglen+=sizeof(nexthop);/*adjustiovec*/iov[iovcnt].iov_base=&
nexthop;iov[iovcnt++].iov_len=sizeof(nexthop);/*IfactionisRTM_DELETEwehavetogetr
idofMPLSinfos*/if(action!=RTM_DELETE){memset(&sa_label_out,0,sizeof(sa_label_out
));sa_label_out.smpls_len=sizeof(sa_label_out);sa_label_out.smpls_family=AF_MPLS
;sa_label_out.smpls_label=htonl(nhlfe->nexthop->nh_label->label[0]<<MPLS_LABEL_O
FFSET);/*adjustheader*/hdr.rtm_addrs|=RTA_SRC;hdr.rtm_flags|=RTF_MPLS;hdr.rtm_ms
glen+=sizeof(sa_label_out);/*adjustiovec*/iov[iovcnt].iov_base=&sa_label_out;iov
[iovcnt++].iov_len=sizeof(sa_label_out);if(nhlfe->nexthop->nh_label->label[0]==M
PLS_LABEL_IMPLNULL)hdr.rtm_mpls=MPLS_OP_POP;elsehdr.rtm_mpls=MPLS_OP_SWAP;}if(zs
erv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");ret=writev(kr_st
ate.fd,iov,iovcnt);if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivi
leges");if(ret==-1)zlog_err("%s:%s",__func__,safe_strerror(errno));returnret;}#i
f!defined(ROUNDUP)#defineROUNDUP(a)\(((a)&(sizeof(long)-1))?(1+((a)|(sizeof(long
)-1))):(a))#endifstaticintkernel_send_rtmsg_v6(intaction,mpls_label_tin_label,ze
bra_nhlfe_t*nhlfe){structioveciov[5];structrt_msghdrhdr;structsockaddr_mplssa_la
bel_in,sa_label_out;structpad{structsockaddr_in6addr;charpad[sizeof(long)];/*tha
nkyouIPv6*/}nexthop;intiovcnt=0;intret;if(IS_ZEBRA_DEBUG_KERNEL)zlog_debug("%s:0
x%x,label=%u",__func__,action,in_label);/*initializeheader*/memset(&hdr,0,sizeof
(hdr));hdr.rtm_version=RTM_VERSION;hdr.rtm_type=action;hdr.rtm_flags=RTF_UP;hdr.
rtm_fmask=RTF_MPLS;hdr.rtm_seq=kr_state.rtseq++;/*overflowdoesn'tmatter*/hdr.rtm
_msglen=sizeof(hdr);hdr.rtm_hdrlen=sizeof(structrt_msghdr);hdr.rtm_priority=0;/*
adjustiovec*/iov[iovcnt].iov_base=&hdr;iov[iovcnt++].iov_len=sizeof(hdr);/*inlab
el*/memset(&sa_label_in,0,sizeof(sa_label_in));sa_label_in.smpls_len=sizeof(sa_l
abel_in);sa_label_in.smpls_family=AF_MPLS;sa_label_in.smpls_label=htonl(in_label
<<MPLS_LABEL_OFFSET);/*adjustheader*/hdr.rtm_flags|=RTF_MPLS|RTF_MPATH;hdr.rtm_a
ddrs|=RTA_DST;hdr.rtm_msglen+=sizeof(sa_label_in);/*adjustiovec*/iov[iovcnt].iov
_base=&sa_label_in;iov[iovcnt++].iov_len=sizeof(sa_label_in);/*nexthop*/memset(&
nexthop,0,sizeof(nexthop));nexthop.addr.sin6_len=sizeof(structsockaddr_in6);next
hop.addr.sin6_family=AF_INET6;nexthop.addr.sin6_addr=nhlfe->nexthop->gate.ipv6;i
f(IN6_IS_ADDR_LINKLOCAL(&nexthop.addr.sin6_addr)){uint16_ttmp16;structsockaddr_i
n6*sin6=&nexthop.addr;nexthop.addr.sin6_scope_id=nhlfe->nexthop->ifindex;memcpy(
&tmp16,&sin6->sin6_addr.s6_addr[2],sizeof(tmp16));tmp16=htons(sin6->sin6_scope_i
d);memcpy(&sin6->sin6_addr.s6_addr[2],&tmp16,sizeof(tmp16));sin6->sin6_scope_id=
0;}/*adjustheader*/hdr.rtm_flags|=RTF_GATEWAY;hdr.rtm_addrs|=RTA_GATEWAY;hdr.rtm
_msglen+=ROUNDUP(sizeof(structsockaddr_in6));/*adjustiovec*/iov[iovcnt].iov_base
=&nexthop;iov[iovcnt++].iov_len=ROUNDUP(sizeof(structsockaddr_in6));/*Ifactionis
RTM_DELETEwehavetogetridofMPLSinfos*/if(action!=RTM_DELETE){memset(&sa_label_out
,0,sizeof(sa_label_out));sa_label_out.smpls_len=sizeof(sa_label_out);sa_label_ou
t.smpls_family=AF_MPLS;sa_label_out.smpls_label=htonl(nhlfe->nexthop->nh_label->
label[0]<<MPLS_LABEL_OFFSET);/*adjustheader*/hdr.rtm_addrs|=RTA_SRC;hdr.rtm_flag
s|=RTF_MPLS;hdr.rtm_msglen+=sizeof(sa_label_out);/*adjustiovec*/iov[iovcnt].iov_
base=&sa_label_out;iov[iovcnt++].iov_len=sizeof(sa_label_out);if(nhlfe->nexthop-
>nh_label->label[0]==MPLS_LABEL_IMPLNULL)hdr.rtm_mpls=MPLS_OP_POP;elsehdr.rtm_mp
ls=MPLS_OP_SWAP;}if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivile
ges");ret=writev(kr_state.fd,iov,iovcnt);if(zserv_privs.change(ZPRIVS_LOWER))zlo
g_err("Can'tlowerprivileges");if(ret==-1)zlog_err("%s:%s",__func__,safe_strerror
(errno));returnret;}staticintkernel_lsp_cmd(intaction,zebra_lsp_t*lsp){zebra_nhl
fe_t*nhlfe;structnexthop*nexthop=NULL;unsignedintnexthop_num=0;for(nhlfe=lsp->nh
lfe_list;nhlfe;nhlfe=nhlfe->next){nexthop=nhlfe->nexthop;if(!nexthop)continue;if
(nexthop_num>=multipath_num)break;if(((action==RTM_ADD||action==RTM_CHANGE)&&(CH
ECK_FLAG(nhlfe->flags,NHLFE_FLAG_SELECTED)&&CHECK_FLAG(nexthop->flags,NEXTHOP_FL
AG_ACTIVE)))||(action==RTM_DELETE&&(CHECK_FLAG(nhlfe->flags,NHLFE_FLAG_INSTALLED
)&&CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_FIB)))){if(nhlfe->nexthop->nh_label->n
um_labels>1){zlog_warn("%s:can'tpush%ulabelsatonce""(maximumis1)",__func__,nhlfe
->nexthop->nh_label->num_labels);continue;}nexthop_num++;switch(NHLFE_FAMILY(nhl
fe)){caseAF_INET:kernel_send_rtmsg_v4(action,lsp->ile.in_label,nhlfe);break;case
AF_INET6:kernel_send_rtmsg_v6(action,lsp->ile.in_label,nhlfe);break;default:brea
k;}}}return(0);}voidkernel_add_lsp(zebra_lsp_t*lsp){intret;if(!lsp||!lsp->best_n
hlfe){//unexpectedkernel_lsp_pass_fail(lsp,SOUTHBOUND_INSTALL_FAILURE);return;}r
et=kernel_lsp_cmd(RTM_ADD,lsp);kernel_lsp_pass_fail(lsp,(!ret)?SOUTHBOUND_INSTAL
L_SUCCESS:SOUTHBOUND_INSTALL_FAILURE);}voidkernel_upd_lsp(zebra_lsp_t*lsp){intre
t;if(!lsp||!lsp->best_nhlfe){//unexpectedkernel_lsp_pass_fail(lsp,SOUTHBOUND_INS
TALL_FAILURE);return;}ret=kernel_lsp_cmd(RTM_CHANGE,lsp);kernel_lsp_pass_fail(ls
p,(!ret)?SOUTHBOUND_INSTALL_SUCCESS:SOUTHBOUND_INSTALL_FAILURE);return;}voidkern
el_del_lsp(zebra_lsp_t*lsp){intret;if(!lsp){//unexpectedkernel_lsp_pass_fail(lsp
,SOUTHBOUND_DELETE_FAILURE);return;}if(!CHECK_FLAG(lsp->flags,LSP_FLAG_INSTALLED
)){kernel_lsp_pass_fail(lsp,SOUTHBOUND_DELETE_FAILURE);return;}ret=kernel_lsp_cm
d(RTM_DELETE,lsp);kernel_lsp_pass_fail(lsp,(!ret)?SOUTHBOUND_DELETE_SUCCESS:SOUT
HBOUND_DELETE_FAILURE);}staticintkmpw_install(structzebra_pw*pw){structifreqifr;
structifmpwreqimr;structsockaddr_storagess;structsockaddr_in*sa_in=(structsockad
dr_in*)&ss;structsockaddr_in6*sa_in6=(structsockaddr_in6*)&ss;memset(&imr,0,size
of(imr));switch(pw->type){casePW_TYPE_ETHERNET:imr.imr_type=IMR_TYPE_ETHERNET;br
eak;casePW_TYPE_ETHERNET_TAGGED:imr.imr_type=IMR_TYPE_ETHERNET_TAGGED;break;defa
ult:zlog_err("%s:unhandledpseudowiretype(%#X)",__func__,pw->type);return-1;}if(p
w->flags&F_PSEUDOWIRE_CWORD)imr.imr_flags|=IMR_FLAG_CONTROLWORD;/*pseudowirenext
hop*/memset(&ss,0,sizeof(ss));switch(pw->af){caseAF_INET:sa_in->sin_family=AF_IN
ET;sa_in->sin_len=sizeof(structsockaddr_in);sa_in->sin_addr=pw->nexthop.ipv4;bre
ak;caseAF_INET6:sa_in6->sin6_family=AF_INET6;sa_in6->sin6_len=sizeof(structsocka
ddr_in6);sa_in6->sin6_addr=pw->nexthop.ipv6;break;default:zlog_err("%s:unhandled
pseudowireaddress-family(%u)",__func__,pw->af);return-1;}memcpy(&imr.imr_nexthop
,(structsockaddr*)&ss,sizeof(imr.imr_nexthop));/*pseudowirelocal/remotelabels*/i
mr.imr_lshim.shim_label=pw->local_label;imr.imr_rshim.shim_label=pw->remote_labe
l;/*ioctl*/memset(&ifr,0,sizeof(ifr));strlcpy(ifr.ifr_name,pw->ifname,sizeof(ifr
.ifr_name));ifr.ifr_data=(caddr_t)&imr;if(ioctl(kr_state.ioctl_fd,SIOCSETMPWCFG,
&ifr)==-1){zlog_err("ioctlSIOCSETMPWCFG:%s",safe_strerror(errno));return-1;}retu
rn0;}staticintkmpw_uninstall(structzebra_pw*pw){structifreqifr;structifmpwreqimr
;memset(&ifr,0,sizeof(ifr));memset(&imr,0,sizeof(imr));strlcpy(ifr.ifr_name,pw->
ifname,sizeof(ifr.ifr_name));ifr.ifr_data=(caddr_t)&imr;if(ioctl(kr_state.ioctl_
fd,SIOCSETMPWCFG,&ifr)==-1){zlog_err("ioctlSIOCSETMPWCFG:%s",safe_strerror(errno
));return-1;}return0;}#defineMAX_RTSOCK_BUF128*1024intmpls_kernel_init(void){int
rcvbuf,default_rcvbuf;socklen_toptlen;if((kr_state.fd=socket(AF_ROUTE,SOCK_RAW,0
))==-1){zlog_warn("%s:socket",__func__);return-1;}if((kr_state.ioctl_fd=socket(A
F_INET,SOCK_DGRAM|SOCK_NONBLOCK,0))==-1){zlog_warn("%s:ioctlsocket",__func__);re
turn-1;}/*growreceivebuffer,don'twannamissmessages*/optlen=sizeof(default_rcvbuf
);if(getsockopt(kr_state.fd,SOL_SOCKET,SO_RCVBUF,&default_rcvbuf,&optlen)==-1)zl
og_warn("kr_initgetsockoptSOL_SOCKETSO_RCVBUF");elsefor(rcvbuf=MAX_RTSOCK_BUF;rc
vbuf>default_rcvbuf&&setsockopt(kr_state.fd,SOL_SOCKET,SO_RCVBUF,&rcvbuf,sizeof(
rcvbuf))==-1&&errno==ENOBUFS;rcvbuf/=2);/*nothing*/kr_state.rtseq=1;/*registerho
oktoinstall/uninstallpseudowires*/hook_register(pw_install,kmpw_install);hook_re
gister(pw_uninstall,kmpw_uninstall);return0;}#endif/*OPEN_BSD*/