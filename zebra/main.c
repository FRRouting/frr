/*zebradaemonmainroutine.*Copyright(C)1997,98KunihiroIshiguro**ThisfileispartofG
NUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheterm
softheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversi
on2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillb
euseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include<lib/version.h>#include"getopt.h
"#include"command.h"#include"thread.h"#include"filter.h"#include"memory.h"#inclu
de"zebra_memory.h"#include"memory_vty.h"#include"prefix.h"#include"log.h"#includ
e"plist.h"#include"privs.h"#include"sigevent.h"#include"vrf.h"#include"logicalro
uter.h"#include"libfrr.h"#include"zebra/rib.h"#include"zebra/zserv.h"#include"ze
bra/debug.h"#include"zebra/router-id.h"#include"zebra/irdp.h"#include"zebra/rtad
v.h"#include"zebra/zebra_ptm.h"#include"zebra/zebra_ns.h"#include"zebra/redistri
bute.h"#include"zebra/zebra_mpls.h"#include"zebra/label_manager.h"#include"zebra
/zebra_netns_notify.h"#defineZEBRA_PTM_SUPPORT/*Zebrainstance*/structzebra_tzebr
ad={.rtm_table_default=0,.packets_to_process=ZEBRA_ZAPI_PACKETS_TO_PROCESS,};/*p
rocessid.*/pid_tpid;/*Pacifyzclient.oinlibfrr,whichexpectsthisvariable.*/structt
hread_master*master;/*Routeretainmodeflag.*/intretain_mode=0;/*Allownon-quaggaen
titiestodeletequaggaroutes*/intallow_delete=0;/*Don'tdeletekernelroute.*/intkeep
_kernel_mode=0;#ifdefHAVE_NETLINK/*Receivebuffersizefornetlinksocket*/uint32_tnl
_rcvbufsize=4194304;#endif/*HAVE_NETLINK*//*Commandlineoptions.*/structoptionlon
gopts[]={{"batch",no_argument,NULL,'b'},{"allow_delete",no_argument,NULL,'a'},{"
keep_kernel",no_argument,NULL,'k'},{"socket",required_argument,NULL,'z'},{"ecmp"
,required_argument,NULL,'e'},{"label_socket",no_argument,NULL,'l'},{"retain",no_
argument,NULL,'r'},#ifdefHAVE_NETLINK{"vrfwnetns",no_argument,NULL,'n'},{"nl-buf
size",required_argument,NULL,'s'},#endif/*HAVE_NETLINK*/{0}};zebra_capabilities_
t_caps_p[]={ZCAP_NET_ADMIN,ZCAP_SYS_ADMIN,ZCAP_NET_RAW,};/*zebraprivilegestorunw
ith*/structzebra_privs_tzserv_privs={#ifdefined(FRR_USER)&&defined(FRR_GROUP).us
er=FRR_USER,.group=FRR_GROUP,#endif#ifdefVTY_GROUP.vty_group=VTY_GROUP,#endif.ca
ps_p=_caps_p,.cap_num_p=array_size(_caps_p),.cap_num_i=0};unsignedintmultipath_n
um=MULTIPATH_NUM;/*SIGHUPhandler.*/staticvoidsighup(void){zlog_info("SIGHUPrecei
ved");/*Reloadofconfigfile.*/;}/*SIGINThandler.*/staticvoidsigint(void){structvr
f*vrf;structzebra_vrf*zvrf;zlog_notice("Terminatingonsignal");frr_early_fini();l
ist_delete_all_node(zebrad.client_list);zebra_ptm_finish();if(retain_mode)RB_FOR
EACH(vrf,vrf_name_head,&vrfs_by_name){zvrf=vrf->info;if(zvrf)SET_FLAG(zvrf->flag
s,ZEBRA_VRF_RETAIN);}if(zebrad.lsp_process_q)work_queue_free_and_null(&zebrad.ls
p_process_q);vrf_terminate();ns_walk_func(zebra_ns_disabled);zebra_ns_notify_clo
se();access_list_reset();prefix_list_reset();route_map_finish();list_delete_and_
null(&zebrad.client_list);work_queue_free_and_null(&zebrad.ribq);meta_queue_free
(zebrad.mq);frr_fini();exit(0);}/*SIGUSR1handler.*/staticvoidsigusr1(void){zlog_
rotate();}structquagga_signal_tzebra_signals[]={{.signal=SIGHUP,.handler=&sighup
,},{.signal=SIGUSR1,.handler=&sigusr1,},{.signal=SIGINT,.handler=&sigint,},{.sig
nal=SIGTERM,.handler=&sigint,},};FRR_DAEMON_INFO(zebra,ZEBRA,.vty_port=ZEBRA_VTY
_PORT,.flags=FRR_NO_ZCLIENT,.proghelp="Daemonwhichmanageskernelroutingtablemanag
ement""and\nredistributionbetweendifferentroutingprotocols.",.signals=zebra_sign
als,.n_signals=array_size(zebra_signals),.privs=&zserv_privs,)/*Mainstartuprouti
ne.*/intmain(intargc,char**argv){//intbatch_mode=0;char*zserv_path=NULL;/*Socket
toexternallabelmanager*/char*lblmgr_path=NULL;structsockaddr_storagedummy;sockle
n_tdummylen;#ifdefined(HANDLE_ZAPI_FUZZING)char*fuzzing=NULL;#endifvrf_configure
_backend(VRF_BACKEND_VRF_LITE);logicalrouter_configure_backend(LOGICALROUTER_BAC
KEND_NETNS);frr_preinit(&zebra_di,argc,argv);frr_opt_add("bakz:e:l:r"#ifdefHAVE_
NETLINK"s:n"#endif#ifdefined(HANDLE_ZAPI_FUZZING)"c:"#endif,longopts,"-b,--batch
Runsinbatchmode\n""-a,--allow_deleteAllowotherprocessestodeletezebraroutes\n""-z
,--socketSetpathofzebrasocket\n""-e,--ecmpSpecifyECMPtouse.\n""-l,--label_socket
Sockettoexternallabelmanager\n""-k,--keep_kernelDon'tdeleteoldrouteswhichinstall
edbyzebra.\n""-r,--retainWhenprogramterminates,retainaddedroutebyzebra.\n"#ifdef
HAVE_NETLINK"-n,--vrfwnetnsSetVRFwithNetNS\n""-s,--nl-bufsizeSetnetlinkreceivebu
ffersize\n"#endif/*HAVE_NETLINK*/#ifdefined(HANDLE_ZAPI_FUZZING)"-c<file>Bypassn
ormalstartupusethisfilefortetstingofzapi"#endif);while(1){intopt=frr_getopt(argc
,argv,NULL);if(opt==EOF)break;switch(opt){case0:break;case'b'://batch_mode=1;bre
ak;case'a':allow_delete=1;break;case'k':keep_kernel_mode=1;break;case'e':multipa
th_num=atoi(optarg);if(multipath_num>MULTIPATH_NUM||multipath_num<=0){zlog_err("
MultipathNumberspecifiedmustbelessthan%dandgreaterthan0",MULTIPATH_NUM);return1;
}break;case'z':zserv_path=optarg;if(!frr_zclient_addr(&dummy,&dummylen,optarg)){
fprintf(stderr,"Invalidzservsocketpath:%s\n",optarg);exit(1);}break;case'l':lblm
gr_path=optarg;break;case'r':retain_mode=1;break;#ifdefHAVE_NETLINKcase's':nl_rc
vbufsize=atoi(optarg);break;case'n':vrf_configure_backend(VRF_BACKEND_NETNS);log
icalrouter_configure_backend(LOGICALROUTER_BACKEND_OFF);break;#endif/*HAVE_NETLI
NK*/#ifdefined(HANDLE_ZAPI_FUZZING)case'c':fuzzing=optarg;break;#endifdefault:fr
r_help_exit(1);break;}}vty_config_lockless();zebrad.master=frr_init();/*Zebrarel
atedinitialize.*/zserv_init();rib_init();zebra_if_init();zebra_debug_init();rout
er_id_cmd_init();/**InitializeNS(andimplicitlytheVRFmodule),andmakekernel*routin
gsocket.*/zebra_ns_init();zebra_vty_init();access_list_init();prefix_list_init()
;#ifdefined(HAVE_RTADV)rtadv_cmd_init();#endif/*PTMsocket*/#ifdefZEBRA_PTM_SUPPO
RTzebra_ptm_init();#endifzebra_mpls_init();zebra_mpls_vty_init();zebra_pw_vty_in
it();/*Fordebugpurpose.*//*SET_FLAG(zebra_debug_event,ZEBRA_DEBUG_EVENT);*/#ifde
fined(HANDLE_ZAPI_FUZZING)if(fuzzing){zserv_read_file(fuzzing);exit(0);}#endif/*
Processtheconfigurationfile.Amongotherconfiguration*directiveswecanmeetthoseinst
allingstaticroutes.Such*requestswillnotbeexecutedimmediately,butqueuedin*zebra->
ribqstructureuntilweenterthemainexecutionloop.*Thenotificationsfromkernelwillsho
woriginatingPIDequal*tothatafterdaemon()completes(ifevercalled).*/frr_config_for
k();/*Afterwehavesuccessfullyacquiredthepidfile,wecanbesure*aboutbeingtheonlycop
yofzebraprocess,whichissubmitting*changestotheFIB.*Cleanupzebra-originatedroutes
.TherequestswillbesenttoOS*immediately,sooriginatingPIDinnotificationsfromkernel
*willbeequaltothecurrentgetpid().Toknowaboutsuchroutes,*wehavetohaveroute_read()
calledbefore.*/if(!keep_kernel_mode)rib_sweep_route();/*NeededforBSDroutingsocke
t.*/pid=getpid();/*Thismustbedoneonlyafterlockingpidfile(bug#403).*/zebra_zserv_
socket_init(zserv_path);/*Initlabelmanager*/label_manager_init(lblmgr_path);frr_
run(zebrad.master);/*Notreached...*/return0;}