/*ZebraPWcode*Copyright(C)2016VoltaNetworks,Inc.**Thisprogramisfreesoftware;youc
anredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseaspublis
hedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption)anyl
aterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHOUTANY
WARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARP
URPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopy
oftheGNUGeneralPublicLicense*alongwiththisprogram;seethefileCOPYING;ifnot,writet
othe*FreeSoftwareFoundation,Inc.,51FranklinSt,FifthFloor,Boston,*MA02110-1301USA
*/#include<zebra.h>#include"log.h"#include"memory.h"#include"thread.h"#include"c
ommand.h"#include"vrf.h"#include"zebra/debug.h"#include"zebra/rib.h"#include"zeb
ra/zserv.h"#include"zebra/zebra_rnh.h"#include"zebra/zebra_vrf.h"#include"zebra/
zebra_pw.h"DEFINE_MTYPE_STATIC(LIB,PW,"Pseudowire")DEFINE_QOBJ_TYPE(zebra_pw)DEF
INE_HOOK(pw_install,(structzebra_pw*pw),(pw))DEFINE_HOOK(pw_uninstall,(structzeb
ra_pw*pw),(pw))#defineMPLS_NO_LABELMPLS_INVALID_LABELexternstructzebra_tzebrad;s
taticintzebra_pw_enabled(structzebra_pw*);staticvoidzebra_pw_install(structzebra
_pw*);staticvoidzebra_pw_uninstall(structzebra_pw*);staticintzebra_pw_install_re
try(structthread*);staticintzebra_pw_check_reachability(structzebra_pw*);staticv
oidzebra_pw_update_status(structzebra_pw*,int);staticinlineintzebra_pw_compare(c
onststructzebra_pw*a,conststructzebra_pw*b){return(strcmp(a->ifname,b->ifname));
}RB_GENERATE(zebra_pw_head,zebra_pw,pw_entry,zebra_pw_compare)RB_GENERATE(zebra_
static_pw_head,zebra_pw,static_pw_entry,zebra_pw_compare)structzebra_pw*zebra_pw
_add(structzebra_vrf*zvrf,constchar*ifname,uint8_tprotocol,structzserv*client){s
tructzebra_pw*pw;if(IS_ZEBRA_DEBUG_PW)zlog_debug("%u:addingpseudowire%sprotocol%
s",zvrf_id(zvrf),ifname,zebra_route_string(protocol));pw=XCALLOC(MTYPE_PW,sizeof
(*pw));strlcpy(pw->ifname,ifname,sizeof(pw->ifname));pw->protocol=protocol;pw->v
rf_id=zvrf_id(zvrf);pw->client=client;pw->status=PW_STATUS_DOWN;pw->local_label=
MPLS_NO_LABEL;pw->remote_label=MPLS_NO_LABEL;pw->flags=F_PSEUDOWIRE_CWORD;RB_INS
ERT(zebra_pw_head,&zvrf->pseudowires,pw);if(pw->protocol==ZEBRA_ROUTE_STATIC){RB
_INSERT(zebra_static_pw_head,&zvrf->static_pseudowires,pw);QOBJ_REG(pw,zebra_pw)
;}returnpw;}voidzebra_pw_del(structzebra_vrf*zvrf,structzebra_pw*pw){if(IS_ZEBRA
_DEBUG_PW)zlog_debug("%u:deletingpseudowire%sprotocol%s",pw->vrf_id,pw->ifname,z
ebra_route_string(pw->protocol));/*removenexthoptracking*/zebra_deregister_rnh_p
seudowire(pw->vrf_id,pw);/*uninstall*/if(pw->status==PW_STATUS_UP)hook_call(pw_u
ninstall,pw);elseif(pw->install_retry_timer)THREAD_TIMER_OFF(pw->install_retry_t
imer);/*unlinkandreleasememory*/RB_REMOVE(zebra_pw_head,&zvrf->pseudowires,pw);i
f(pw->protocol==ZEBRA_ROUTE_STATIC)RB_REMOVE(zebra_static_pw_head,&zvrf->static_
pseudowires,pw);XFREE(MTYPE_PW,pw);}voidzebra_pw_change(structzebra_pw*pw,ifinde
x_tifindex,inttype,intaf,uniong_addr*nexthop,uint32_tlocal_label,uint32_tremote_
label,uint8_tflags,unionpw_protocol_fields*data){zebra_deregister_rnh_pseudowire
(pw->vrf_id,pw);pw->ifindex=ifindex;pw->type=type;pw->af=af;pw->nexthop=*nexthop
;pw->local_label=local_label;pw->remote_label=remote_label;pw->flags=flags;pw->d
ata=*data;if(zebra_pw_enabled(pw))zebra_register_rnh_pseudowire(pw->vrf_id,pw);e
lsezebra_pw_uninstall(pw);}structzebra_pw*zebra_pw_find(structzebra_vrf*zvrf,con
stchar*ifname){structzebra_pwpw;strlcpy(pw.ifname,ifname,sizeof(pw.ifname));retu
rn(RB_FIND(zebra_pw_head,&zvrf->pseudowires,&pw));}staticintzebra_pw_enabled(str
uctzebra_pw*pw){if(pw->protocol==ZEBRA_ROUTE_STATIC){if(pw->local_label==MPLS_NO
_LABEL||pw->remote_label==MPLS_NO_LABEL||pw->af==AF_UNSPEC)return0;return1;}else
returnpw->enabled;}voidzebra_pw_update(structzebra_pw*pw){if(zebra_pw_check_reac
hability(pw)<0){zebra_pw_uninstall(pw);/*waitforNHTandtryagainlater*/}else{/**In
stallorreinstallthepseudowire(e.g.toupdate*parameterslikethenexthoportheuseofthe
controlword).*/zebra_pw_install(pw);}}staticvoidzebra_pw_install(structzebra_pw*
pw){if(IS_ZEBRA_DEBUG_PW)zlog_debug("%u:installingpseudowire%sprotocol%s",pw->vr
f_id,pw->ifname,zebra_route_string(pw->protocol));if(hook_call(pw_install,pw)){z
ebra_pw_install_failure(pw);return;}if(pw->status==PW_STATUS_DOWN)zebra_pw_updat
e_status(pw,PW_STATUS_UP);}staticvoidzebra_pw_uninstall(structzebra_pw*pw){if(pw
->status==PW_STATUS_DOWN)return;if(IS_ZEBRA_DEBUG_PW)zlog_debug("%u:uninstalling
pseudowire%sprotocol%s",pw->vrf_id,pw->ifname,zebra_route_string(pw->protocol));
/*ignoreanypossibleerror*/hook_call(pw_uninstall,pw);if(zebra_pw_enabled(pw))zeb
ra_pw_update_status(pw,PW_STATUS_DOWN);}/**Installationofthepseudowireinthekerne
lorhardwarehasfailed.This*functionwillnotifythepseudowireclientaboutthefailurean
dschedule*toretrytheinstallationlater.Thisfunctioncanbecalledbyanexternal*agentt
hatperformsthepseudowireinstallationinanasynchronousway.*/voidzebra_pw_install_f
ailure(structzebra_pw*pw){if(IS_ZEBRA_DEBUG_PW)zlog_debug("%u:failedinstallingps
eudowire%s,""schedulingretryin%useconds",pw->vrf_id,pw->ifname,PW_INSTALL_RETRY_
INTERVAL);/*scheduletoretrylater*/THREAD_TIMER_OFF(pw->install_retry_timer);thre
ad_add_timer(zebrad.master,zebra_pw_install_retry,pw,PW_INSTALL_RETRY_INTERVAL,&
pw->install_retry_timer);zebra_pw_update_status(pw,PW_STATUS_DOWN);}staticintzeb
ra_pw_install_retry(structthread*thread){structzebra_pw*pw=THREAD_ARG(thread);pw
->install_retry_timer=NULL;zebra_pw_install(pw);return0;}staticvoidzebra_pw_upda
te_status(structzebra_pw*pw,intstatus){pw->status=status;if(pw->client)zsend_pw_
update(pw->client,pw);}staticintzebra_pw_check_reachability(structzebra_pw*pw){s
tructroute_entry*re;structnexthop*nexthop;/*TODO:considerGRE/L2TPv3tunnelsinaddi
tiontoMPLSLSPs*//*findroutetotheremoteendofthepseudowire*/re=rib_match(family2af
i(pw->af),SAFI_UNICAST,pw->vrf_id,&pw->nexthop,NULL);if(!re){if(IS_ZEBRA_DEBUG_P
W)zlog_warn("%s:noroutefoundfor%s",__func__,pw->ifname);return-1;}/**Needtoensur
ethatthere'salabelbindingforallnexthops.*Otherwise,ECMPforthisroutecouldrenderth
epseudowireunusable.*/for(ALL_NEXTHOPS(re->ng,nexthop)){if(!nexthop->nh_label){i
f(IS_ZEBRA_DEBUG_PW)zlog_warn("%s:unlabeledroutefor%s",__func__,pw->ifname);retu
rn-1;}}return0;}voidzebra_pw_client_close(structzserv*client){structvrf*vrf;stru
ctzebra_vrf*zvrf;structzebra_pw*pw,*tmp;RB_FOREACH(vrf,vrf_id_head,&vrfs_by_id){
zvrf=vrf->info;RB_FOREACH_SAFE(pw,zebra_pw_head,&zvrf->pseudowires,tmp){if(pw->c
lient!=client)continue;zebra_pw_del(zvrf,pw);}}}voidzebra_pw_init(structzebra_vr
f*zvrf){RB_INIT(zebra_pw_head,&zvrf->pseudowires);RB_INIT(zebra_static_pw_head,&
zvrf->static_pseudowires);}voidzebra_pw_exit(structzebra_vrf*zvrf){structzebra_p
w*pw;while(!RB_EMPTY(zebra_pw_head,&zvrf->pseudowires)){pw=RB_ROOT(zebra_pw_head
,&zvrf->pseudowires);zebra_pw_del(zvrf,pw);}}DEFUN_NOSH(pseudowire_if,pseudowire
_if_cmd,"[no]pseudowireIFNAME",NO_STR"Staticpseudowireconfiguration\n""Pseudowir
ename\n"){structzebra_vrf*zvrf;structzebra_pw*pw;intidx=0;constchar*ifname;zvrf=
vrf_info_lookup(VRF_DEFAULT);if(!zvrf)returnCMD_WARNING;argv_find(argv,argc,"IFN
AME",&idx);ifname=argv[idx]->arg;pw=zebra_pw_find(zvrf,ifname);if(pw&&pw->protoc
ol!=ZEBRA_ROUTE_STATIC){vty_out(vty,"%%Pseudowireisnotstatic\n");returnCMD_WARNI
NG;}if(argv_find(argv,argc,"no",&idx)){if(!pw)returnCMD_SUCCESS;zebra_pw_del(zvr
f,pw);returnCMD_SUCCESS;}if(!pw)pw=zebra_pw_add(zvrf,ifname,ZEBRA_ROUTE_STATIC,N
ULL);VTY_PUSH_CONTEXT(PW_NODE,pw);returnCMD_SUCCESS;}DEFUN(pseudowire_labels,pse
udowire_labels_cmd,"[no]mplslabellocal(16-1048575)remote(16-1048575)",NO_STR"MPL
SL2VPNPWcommand\n""MPLSL2VPNstaticlabels\n""Localpseudowirelabel\n""Localpseudow
irelabel\n""Remotepseudowirelabel\n""Remotepseudowirelabel\n"){VTY_DECLVAR_CONTE
XT(zebra_pw,pw);intidx=0;mpls_label_tlocal_label,remote_label;if(argv_find(argv,
argc,"no",&idx)){local_label=MPLS_NO_LABEL;remote_label=MPLS_NO_LABEL;}else{argv
_find(argv,argc,"local",&idx);local_label=atoi(argv[idx+1]->arg);argv_find(argv,
argc,"remote",&idx);remote_label=atoi(argv[idx+1]->arg);}zebra_pw_change(pw,pw->
ifindex,pw->type,pw->af,&pw->nexthop,local_label,remote_label,pw->flags,&pw->dat
a);returnCMD_SUCCESS;}DEFUN(pseudowire_neighbor,pseudowire_neighbor_cmd,"[no]nei
ghbor<A.B.C.D|X:X::X:X>",NO_STR"SpecifytheIPv4orIPv6addressoftheremoteendpoint\n
""IPv4address\n""IPv6address\n"){VTY_DECLVAR_CONTEXT(zebra_pw,pw);intidx=0;const
char*address;intaf;uniong_addrnexthop;af=AF_UNSPEC;memset(&nexthop,0,sizeof(next
hop));if(!argv_find(argv,argc,"no",&idx)){argv_find(argv,argc,"neighbor",&idx);a
ddress=argv[idx+1]->arg;if(inet_pton(AF_INET,address,&nexthop.ipv4)==1)af=AF_INE
T;elseif(inet_pton(AF_INET6,address,&nexthop.ipv6)==1)af=AF_INET6;else{vty_out(v
ty,"%%Malformedaddress\n");returnCMD_WARNING;}}zebra_pw_change(pw,pw->ifindex,pw
->type,af,&nexthop,pw->local_label,pw->remote_label,pw->flags,&pw->data);returnC
MD_SUCCESS;}DEFUN(pseudowire_control_word,pseudowire_control_word_cmd,"[no]contr
ol-word<exclude|include>",NO_STR"Control-wordoptions\n""Excludecontrol-wordinpse
udowirepackets\n""Includecontrol-wordinpseudowirepackets\n"){VTY_DECLVAR_CONTEXT
(zebra_pw,pw);intidx=0;uint8_tflags=0;if(argv_find(argv,argc,"no",&idx))flags=F_
PSEUDOWIRE_CWORD;else{argv_find(argv,argc,"control-word",&idx);if(argv[idx+1]->t
ext[0]=='i')flags=F_PSEUDOWIRE_CWORD;}zebra_pw_change(pw,pw->ifindex,pw->type,pw
->af,&pw->nexthop,pw->local_label,pw->remote_label,flags,&pw->data);returnCMD_SU
CCESS;}DEFUN(show_pseudowires,show_pseudowires_cmd,"showmplspseudowires",SHOW_ST
RMPLS_STR"Pseudowires\n"){structzebra_vrf*zvrf;structzebra_pw*pw;zvrf=vrf_info_l
ookup(VRF_DEFAULT);if(!zvrf)return0;vty_out(vty,"%-16s%-24s%-12s%-8s%-10s\n","In
terface","Neighbor","Labels","Protocol","Status");RB_FOREACH(pw,zebra_pw_head,&z
vrf->pseudowires){charbuf_nbr[INET6_ADDRSTRLEN];charbuf_labels[64];inet_ntop(pw-
>af,&pw->nexthop,buf_nbr,sizeof(buf_nbr));if(pw->local_label!=MPLS_NO_LABEL&&pw-
>remote_label!=MPLS_NO_LABEL)snprintf(buf_labels,sizeof(buf_labels),"%u/%u",pw->
local_label,pw->remote_label);elsesnprintf(buf_labels,sizeof(buf_labels),"-");vt
y_out(vty,"%-16s%-24s%-12s%-8s%-10s\n",pw->ifname,(pw->af!=AF_UNSPEC)?buf_nbr:"-
",buf_labels,zebra_route_string(pw->protocol),(zebra_pw_enabled(pw)&&pw->status=
=PW_STATUS_UP)?"UP":"DOWN");}returnCMD_SUCCESS;}/*Pseudowireconfigurationwritefu
nction.*/staticintzebra_pw_config(structvty*vty){intwrite=0;structzebra_vrf*zvrf
;structzebra_pw*pw;zvrf=vrf_info_lookup(VRF_DEFAULT);if(!zvrf)return0;RB_FOREACH
(pw,zebra_static_pw_head,&zvrf->static_pseudowires){vty_out(vty,"pseudowire%s\n"
,pw->ifname);if(pw->local_label!=MPLS_NO_LABEL&&pw->remote_label!=MPLS_NO_LABEL)
vty_out(vty,"mplslabellocal%uremote%u\n",pw->local_label,pw->remote_label);elsev
ty_out(vty,"!Incompleteconfig,specifythestatic""MPLSlabels\n");if(pw->af!=AF_UNS
PEC){charbuf[INET6_ADDRSTRLEN];inet_ntop(pw->af,&pw->nexthop,buf,sizeof(buf));vt
y_out(vty,"neighbor%s\n",buf);}elsevty_out(vty,"!Incompleteconfig,specifyaneighb
or""address\n");if(!(pw->flags&F_PSEUDOWIRE_CWORD))vty_out(vty,"control-wordexcl
ude\n");vty_out(vty,"!\n");write=1;}returnwrite;}staticstructcmd_nodepw_node={PW
_NODE,"%s(config-pw)#",1,};voidzebra_pw_vty_init(void){install_node(&pw_node,zeb
ra_pw_config);install_default(PW_NODE);install_element(CONFIG_NODE,&pseudowire_i
f_cmd);install_element(PW_NODE,&pseudowire_labels_cmd);install_element(PW_NODE,&
pseudowire_neighbor_cmd);install_element(PW_NODE,&pseudowire_control_word_cmd);i
nstall_element(VIEW_NODE,&show_pseudowires_cmd);}