/**Interfacelookingupbyioctl().*Copyright(C)1997,98KunihiroIshiguro**Thisfileisp
artofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undert
hetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eithe
rversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethati
twillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABI
LITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.
**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;se
ethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthF
loor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefOPEN_BSD#include"if.h"#inclu
de"sockunion.h"#include"prefix.h"#include"ioctl.h"#include"connected.h"#include"
memory.h"#include"zebra_memory.h"#include"log.h"#include"vrf.h"#include"vty.h"#i
nclude"zebra/interface.h"#include"zebra/rib.h"#include<ifaddrs.h>/*Interfacelook
ingupusinginfamousSIOCGIFCONF.*/staticintinterface_list_ioctl(void){intret;intso
ck;#defineIFNUM_BASE32intifnum;structifreq*ifreq;structifconfifconf;structinterf
ace*ifp;intn;intlastlen;/*NormallySIOCGIFCONFworkswithAF_INETsocket.*/sock=socke
t(AF_INET,SOCK_DGRAM,0);if(sock<0){zlog_warn("Can'tmakeAF_INETsocketstream:%s",s
afe_strerror(errno));return-1;}/*Setinitialifreqcount.ThiswillbedoublewhenSIOCGI
FCONFfail.SolarishasSIOCGIFNUM.*/#ifdefSIOCGIFNUMret=ioctl(sock,SIOCGIFNUM,&ifnu
m);if(ret<0)ifnum=IFNUM_BASE;elseifnum++;#elseifnum=IFNUM_BASE;#endif/*SIOCGIFNU
M*/ifconf.ifc_buf=NULL;lastlen=0;/*LoopuntilSIOCGIFCONFsuccess.*/for(;;){ifconf.
ifc_len=sizeof(structifreq)*ifnum;ifconf.ifc_buf=XREALLOC(MTYPE_TMP,ifconf.ifc_b
uf,ifconf.ifc_len);ret=ioctl(sock,SIOCGIFCONF,&ifconf);if(ret<0){zlog_warn("SIOC
GIFCONF:%s",safe_strerror(errno));gotoend;}/*Repeatedlygetinfotilbufferfailstogr
ow.*/if(ifconf.ifc_len>lastlen){lastlen=ifconf.ifc_len;ifnum+=10;continue;}/*Suc
cess.*/break;}/*Allocateinterface.*/ifreq=ifconf.ifc_req;#ifdefOPEN_BSDfor(n=0;n
<ifconf.ifc_len;){unsignedintsize;ifreq=(structifreq*)((caddr_t)ifconf.ifc_req+n
);ifp=if_get_by_name(ifreq->ifr_name,VRF_DEFAULT,0);if_add_update(ifp);size=ifre
q->ifr_addr.sa_len;if(size<sizeof(ifreq->ifr_addr))size=sizeof(ifreq->ifr_addr);
size+=sizeof(ifreq->ifr_name);n+=size;}#elsefor(n=0;n<ifconf.ifc_len;n+=sizeof(s
tructifreq)){ifp=if_get_by_name(ifreq->ifr_name,VRF_DEFAULT,0);if_add_update(ifp
);ifreq++;}#endif/*OPEN_BSD*/end:close(sock);XFREE(MTYPE_TMP,ifconf.ifc_buf);ret
urnret;}/*Getinterface'sindexbyioctl.*/staticintif_get_index(structinterface*ifp
){if_set_index(ifp,if_nametoindex(ifp->name));returnifp->ifindex;}#ifdefSIOCGIFH
WADDRstaticintif_get_hwaddr(structinterface*ifp){intret;structifreqifreq;inti;st
rncpy(ifreq.ifr_name,ifp->name,IFNAMSIZ);ifreq.ifr_addr.sa_family=AF_INET;/*Fetc
hHardwareaddressifavailable.*/ret=vrf_if_ioctl(SIOCGIFHWADDR,(caddr_t)&ifreq,ifp
->vrf_id);if(ret<0)ifp->hw_addr_len=0;else{memcpy(ifp->hw_addr,ifreq.ifr_hwaddr.
sa_data,6);for(i=0;i<6;i++)if(ifp->hw_addr[i]!=0)break;if(i==6)ifp->hw_addr_len=
0;elseifp->hw_addr_len=6;}return0;}#endif/*SIOCGIFHWADDR*/staticintif_getaddrs(v
oid){intret;structifaddrs*ifap;structifaddrs*ifapfree;structinterface*ifp;intpre
fixlen;ret=getifaddrs(&ifap);if(ret!=0){zlog_err("getifaddrs():%s",safe_strerror
(errno));return-1;}for(ifapfree=ifap;ifap;ifap=ifap->ifa_next){if(ifap->ifa_addr
==NULL){zlog_err("%s:nonsensicalifaddrwithNULLifa_addr,ifname%s",__func__,(ifap-
>ifa_name?ifap->ifa_name:"(null)"));continue;}ifp=if_lookup_by_name(ifap->ifa_na
me,VRF_DEFAULT);if(ifp==NULL){zlog_err("if_getaddrs():Can'tlookupinterface%s\n",
ifap->ifa_name);continue;}if(ifap->ifa_addr->sa_family==AF_INET){structsockaddr_
in*addr;structsockaddr_in*mask;structsockaddr_in*dest;structin_addr*dest_pnt;int
flags=0;addr=(structsockaddr_in*)ifap->ifa_addr;mask=(structsockaddr_in*)ifap->i
fa_netmask;prefixlen=ip_masklen(mask->sin_addr);dest_pnt=NULL;if(if_is_pointopoi
nt(ifp)&&ifap->ifa_dstaddr&&!IPV4_ADDR_SAME(&addr->sin_addr,&((structsockaddr_in
*)ifap->ifa_dstaddr)->sin_addr)){dest=(structsockaddr_in*)ifap->ifa_dstaddr;dest
_pnt=&dest->sin_addr;flags=ZEBRA_IFA_PEER;}elseif(ifap->ifa_broadaddr&&!IPV4_ADD
R_SAME(&addr->sin_addr,&((structsockaddr_in*)ifap->ifa_broadaddr)->sin_addr)){de
st=(structsockaddr_in*)ifap->ifa_broadaddr;dest_pnt=&dest->sin_addr;}connected_a
dd_ipv4(ifp,flags,&addr->sin_addr,prefixlen,dest_pnt,NULL);}if(ifap->ifa_addr->s
a_family==AF_INET6){structsockaddr_in6*addr;structsockaddr_in6*mask;intflags=0;a
ddr=(structsockaddr_in6*)ifap->ifa_addr;mask=(structsockaddr_in6*)ifap->ifa_netm
ask;prefixlen=ip6_masklen(mask->sin6_addr);#ifdefined(KAME)if(IN6_IS_ADDR_LINKLO
CAL(&addr->sin6_addr)){addr->sin6_scope_id=ntohs(*(uint16_t*)&addr->sin6_addr.s6
_addr[2]);addr->sin6_addr.s6_addr[2]=addr->sin6_addr.s6_addr[3]=0;}#endifconnect
ed_add_ipv6(ifp,flags,&addr->sin6_addr,prefixlen,NULL);}}freeifaddrs(ifapfree);r
eturn0;}/*Fetchinterfaceinformationviaioctl().*/staticvoidinterface_info_ioctl()
{structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp;FOR_ALL_INTERFA
CES(vrf,ifp){if_get_index(ifp);#ifdefSIOCGIFHWADDRif_get_hwaddr(ifp);#endif/*SIO
CGIFHWADDR*/if_get_flags(ifp);if_get_mtu(ifp);if_get_metric(ifp);}}/*Lookupallin
terfaceinformation.*/voidinterface_list(structzebra_ns*zns){zlog_info("interface
_list:NS%u",zns->ns_id);/*Linuxcandobothproc&ioctl,ioctlistheonlywaytogetinterfa
cealiasesin2.2serieskernels.*/#ifdefHAVE_PROC_NET_DEVinterface_list_proc();#endi
f/*HAVE_PROC_NET_DEV*/interface_list_ioctl();/*Afterlistingisdone,getindex,addre
ss,flagsandotherinterface'sinformation.*/interface_info_ioctl();if_getaddrs();#i
fdefined(HAVE_PROC_NET_IF_INET6)/*Linuxprovidesinterface'sIPv6addressvia/proc/ne
t/if_inet6.*/ifaddr_proc_ipv6();#endif/*HAVE_PROC_NET_IF_INET6*/}#endif/*OPEN_BS
D*/