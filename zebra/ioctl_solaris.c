/**CommonioctlfunctionsforSolaris.*Copyright(C)1997,98KunihiroIshiguro**Thisfile
ispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*und
erthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;ei
therversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopeth
atitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANT
ABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetai
ls.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram
;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fif
thFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefSUNOS_5#include"linklist.
h"#include"if.h"#include"prefix.h"#include"ioctl.h"#include"log.h"#include"privs
.h"#include"vty.h"#include"vrf.h"#include"zebra/rib.h"#include"zebra/rt.h"#inclu
de"zebra/interface.h"#include"zebra/ioctl_solaris.h"externstructzebra_privs_tzse
rv_privs;/*clearandsetinterfacenamestring*/voidlifreq_set_name(structlifreq*lifr
eq,constchar*ifname){strncpy(lifreq->lifr_name,ifname,IFNAMSIZ);}intvrf_if_ioctl
(unsignedlongrequest,caddr_tbuffer,vrf_id_tvrf_id){returnif_ioctl(request,buffer
);}/*callioctlsystemcall*/intif_ioctl(unsignedlongrequest,caddr_tbuffer){intsock
;intret;interr;if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivilege
s");sock=socket(AF_INET,SOCK_DGRAM,0);if(sock<0){intsave_errno=errno;if(zserv_pr
ivs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");zlog_err("Cannotcreate
UDPsocket:%s",safe_strerror(save_errno));exit(1);}if((ret=ioctl(sock,request,buf
fer))<0)err=errno;if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivil
eges");close(sock);if(ret<0){errno=err;returnret;}return0;}intif_ioctl_ipv6(unsi
gnedlongrequest,caddr_tbuffer){intsock;intret;interr;if(zserv_privs.change(ZPRIV
S_RAISE))zlog_err("Can'traiseprivileges");sock=socket(AF_INET6,SOCK_DGRAM,0);if(
sock<0){intsave_errno=errno;if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tl
owerprivileges");zlog_err("CannotcreateIPv6datagramsocket:%s",safe_strerror(save
_errno));exit(1);}if((ret=ioctl(sock,request,buffer))<0)err=errno;if(zserv_privs
.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");close(sock);if(ret<0){err
no=err;returnret;}return0;}/**getinterfacemetric*--ifvalueisnotavaliableset-1*/v
oidif_get_metric(structinterface*ifp){structlifreqlifreq;intret;lifreq_set_name(
&lifreq,ifp->name);if(ifp->flags&IFF_IPV4)ret=AF_IOCTL(AF_INET,SIOCGLIFMETRIC,(c
addr_t)&lifreq);#ifdefSOLARIS_IPV6elseif(ifp->flags&IFF_IPV6)ret=AF_IOCTL(AF_INE
T6,SIOCGLIFMETRIC,(caddr_t)&lifreq);#endif/*SOLARIS_IPV6*/elseret=-1;if(ret<0)re
turn;ifp->metric=lifreq.lifr_metric;if(ifp->metric==0)ifp->metric=1;}/*getinterf
aceMTU*/voidif_get_mtu(structinterface*ifp){structlifreqlifreq;intret;uint8_tcha
nged=0;if(ifp->flags&IFF_IPV4){lifreq_set_name(&lifreq,ifp->name);ret=AF_IOCTL(A
F_INET,SIOCGLIFMTU,(caddr_t)&lifreq);if(ret<0){zlog_info("Can'tlookupmtuon%sbyio
ctl(SIOCGLIFMTU)",ifp->name);ifp->mtu=-1;}else{ifp->mtu=lifreq.lifr_metric;chang
ed=1;}}if(ifp->flags&IFF_IPV6){memset(&lifreq,0,sizeof(lifreq));lifreq_set_name(
&lifreq,ifp->name);ret=AF_IOCTL(AF_INET6,SIOCGLIFMTU,(caddr_t)&lifreq);if(ret<0)
{zlog_info("Can'tlookupmtu6on%sbyioctl(SIOCGIFMTU)",ifp->name);ifp->mtu6=-1;}els
e{ifp->mtu6=lifreq.lifr_metric;changed=1;}}if(changed)zebra_interface_up_update(
ifp);}/*Setupinterface'saddress,netmask(andbroadcast?).Solarisusesifname:numbers
emanticstosetIPaddressaliases.*/intif_set_prefix(structinterface*ifp,structconne
cted*ifc){intret;structifreqifreq;structsockaddr_inaddr;structsockaddr_inbroad;s
tructsockaddr_inmask;structprefix_ipv4ifaddr;structprefix_ipv4*p;p=(structprefix
_ipv4*)ifc->address;ifaddr=*p;strncpy(ifreq.ifr_name,ifp->name,IFNAMSIZ);addr.si
n_addr=p->prefix;addr.sin_family=p->family;memcpy(&ifreq.ifr_addr,&addr,sizeof(s
tructsockaddr_in));ret=if_ioctl(SIOCSIFADDR,(caddr_t)&ifreq);if(ret<0)returnret;
/*Weneedmaskformakebroadcastaddr.*/masklen2ip(p->prefixlen,&mask.sin_addr);if(if
_is_broadcast(ifp)){apply_mask_ipv4(&ifaddr);addr.sin_addr=ifaddr.prefix;broad.s
in_addr.s_addr=(addr.sin_addr.s_addr|~mask.sin_addr.s_addr);broad.sin_family=p->
family;memcpy(&ifreq.ifr_broadaddr,&broad,sizeof(structsockaddr_in));ret=if_ioct
l(SIOCSIFBRDADDR,(caddr_t)&ifreq);if(ret<0)returnret;}mask.sin_family=p->family;
#ifdefSUNOS_5memcpy(&mask,&ifreq.ifr_addr,sizeof(mask));#elsememcpy(&ifreq.ifr_n
etmask,&mask,sizeof(structsockaddr_in));#endif/*SUNOS_5*/ret=if_ioctl(SIOCSIFNET
MASK,(caddr_t)&ifreq);return((ret<0)?ret:0);}/*Setupinterface'saddress,netmask(a
ndbroadcast).Solarisusesifname:numbersemanticstosetIPaddressaliases.*/intif_unse
t_prefix(structinterface*ifp,structconnected*ifc){intret;structifreqifreq;struct
sockaddr_inaddr;structprefix_ipv4*p;p=(structprefix_ipv4*)ifc->address;strncpy(i
freq.ifr_name,ifp->name,IFNAMSIZ);memset(&addr,0,sizeof(structsockaddr_in));addr
.sin_family=p->family;memcpy(&ifreq.ifr_addr,&addr,sizeof(structsockaddr_in));re
t=if_ioctl(SIOCSIFADDR,(caddr_t)&ifreq);if(ret<0)returnret;return0;}/*Getjustthe
flagsforthegivenname.*Usedbythenormal'if_get_flags'function,aswell*asthebootupin
terface-listcode,whichhastopeekatper-address*flagsinordertofigureoutwhichonessho
uldbeignored..*/intif_get_flags_direct(constchar*ifname,uint64_t*flags,unsignedi
ntaf){structlifreqlifreq;intret;lifreq_set_name(&lifreq,ifname);ret=AF_IOCTL(af,
SIOCGLIFFLAGS,(caddr_t)&lifreq);if(ret)zlog_debug("%s:ifname%s,error%s(%d)",__fu
nc__,ifname,safe_strerror(errno),errno);*flags=lifreq.lifr_flags;returnret;}/*ge
tinterfaceflags*/voidif_get_flags(structinterface*ifp){intret4=0,ret6=0;uint64_t
newflags=0;uint64_ttmpflags;if(ifp->flags&IFF_IPV4){ret4=if_get_flags_direct(ifp
->name,&tmpflags,AF_INET);if(!ret4)newflags|=tmpflags;elseif(errno==ENXIO){/*it'
sgone*/UNSET_FLAG(ifp->flags,IFF_UP);if_flags_update(ifp,ifp->flags);}}if(ifp->f
lags&IFF_IPV6){ret6=if_get_flags_direct(ifp->name,&tmpflags,AF_INET6);if(!ret6)n
ewflags|=tmpflags;elseif(errno==ENXIO){/*it'sgone*/UNSET_FLAG(ifp->flags,IFF_UP)
;if_flags_update(ifp,ifp->flags);}}/*onlyupdateflagsifoneofabovesucceeded*/if(!(
ret4&&ret6))if_flags_update(ifp,newflags);}/*Setinterfaceflags*/intif_set_flags(
structinterface*ifp,uint64_tflags){intret;structlifreqlifreq;lifreq_set_name(&li
freq,ifp->name);lifreq.lifr_flags=ifp->flags;lifreq.lifr_flags|=flags;if(ifp->fl
ags&IFF_IPV4)ret=AF_IOCTL(AF_INET,SIOCSLIFFLAGS,(caddr_t)&lifreq);elseif(ifp->fl
ags&IFF_IPV6)ret=AF_IOCTL(AF_INET6,SIOCSLIFFLAGS,(caddr_t)&lifreq);elseret=-1;if
(ret<0)zlog_info("can'tsetinterfaceflagson%s:%s",ifp->name,safe_strerror(errno))
;elseret=0;returnret;}/*Unsetinterface'sflag.*/intif_unset_flags(structinterface
*ifp,uint64_tflags){intret;structlifreqlifreq;lifreq_set_name(&lifreq,ifp->name)
;lifreq.lifr_flags=ifp->flags;lifreq.lifr_flags&=~flags;if(ifp->flags&IFF_IPV4)r
et=AF_IOCTL(AF_INET,SIOCSLIFFLAGS,(caddr_t)&lifreq);elseif(ifp->flags&IFF_IPV6)r
et=AF_IOCTL(AF_INET6,SIOCSLIFFLAGS,(caddr_t)&lifreq);elseret=-1;if(ret<0)zlog_in
fo("can'tunsetinterfaceflags");elseret=0;returnret;}/*Interface'saddressadd/dele
tefunctions.*/intif_prefix_add_ipv6(structinterface*ifp,structconnected*ifc){cha
raddrbuf[PREFIX_STRLEN];zlog_warn("Can'tset%soninterface%s",prefix2str(ifc->addr
ess,addrbuf,sizeof(addrbuf)),ifp->name);return0;}intif_prefix_delete_ipv6(struct
interface*ifp,structconnected*ifc){charaddrbuf[PREFIX_STRLEN];zlog_warn("Can'tde
lete%soninterface%s",prefix2str(ifc->address,addrbuf,sizeof(addrbuf)),ifp->name)
;return0;}#endif/*SUNOS_5*/