/**ipforwardvaluegetfunctionforsolaris.*Copyright(C)1997KunihiroIshiguro**Thisfi
leispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*u
nderthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;
eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehope
thatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHA
NTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredet
ails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogr
am;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,F
ifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefSUNOS_5#include"log.h"#
include"prefix.h"#include"privs.h"#include"zebra/ipforward.h"/***Solarisshouldde
fineIP_DEV_NAMEin<inet/ip.h>,butwe'llsave**configure.inchangesforanotherday.Weca
nusethesamedevice**forbothIPv4andIPv6.*//*#include<inet/ip.h>*/#ifndefIP_DEV_NAM
E#defineIP_DEV_NAME"/dev/ip"#endifexternstructzebra_privs_tzserv_privs;/*Thisisa
limitednddstylefunctionthatoperatesoneinteger**valueonly.Errorsreturn-1.ND_SETco
mmandsreturn0on**success.ND_GETcommandsreturnthevalueonsuccess(whichcould**be-1a
ndbeconfusedforanerror).Theparameteristhestring**nameoftheparameterbeingreferenc
ed.*/staticintsolaris_nd(constintcmd,constchar*parameter,constintvalue){#defineN
D_BUFFER_SIZE1024intfd;charnd_buf[ND_BUFFER_SIZE];structstrioctlstrioctl;constch
ar*device=IP_DEV_NAME;intretval;memset(nd_buf,'\0',ND_BUFFER_SIZE);/***ND_SETtak
esaNULLdelimitedlistofstringsfurtherterminated**buyaNULL.ND_GETreturnsalistinasi
milarlayout,although**hereweonlyusethefirstresult.*/if(cmd==ND_SET)snprintf(nd_b
uf,ND_BUFFER_SIZE,"%s%c%d%c",parameter,'\0',value,'\0');elseif(cmd==ND_GET)snpri
ntf(nd_buf,ND_BUFFER_SIZE,"%s",parameter);else{zlog_err("internalerror-inappropr
iatecommandgivento""solaris_nd()%s:%d",__FILE__,__LINE__);return-1;}strioctl.ic_
cmd=cmd;strioctl.ic_timout=0;strioctl.ic_len=ND_BUFFER_SIZE;strioctl.ic_dp=nd_bu
f;if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("solaris_nd:Can'traiseprivileges"
);if((fd=open(device,O_RDWR))<0){zlog_warn("failedtoopendevice%s-%s",device,safe
_strerror(errno));if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("solaris_nd:Can't
lowerprivileges");return-1;}if(ioctl(fd,I_STR,&strioctl)<0){intsave_errno=errno;
if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("solaris_nd:Can'tlowerprivileges");
close(fd);zlog_warn("ioctlI_STRfailedondevice%s-%s",device,safe_strerror(save_er
rno));return-1;}close(fd);if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("solaris_
nd:Can'tlowerprivileges");if(cmd==ND_GET){errno=0;retval=atoi(nd_buf);if(errno){
zlog_warn("failedtoconvertreturnedvaluetointeger-%s",safe_strerror(errno));retva
l=-1;}}else{retval=0;}returnretval;}staticintsolaris_nd_set(constchar*parameter,
constintvalue){returnsolaris_nd(ND_SET,parameter,value);}staticintsolaris_nd_get
(constchar*parameter){returnsolaris_nd(ND_GET,parameter,0);}intipforward(void){r
eturnsolaris_nd_get("ip_forwarding");}intipforward_on(void){(void)solaris_nd_set
("ip_forwarding",1);returnipforward();}intipforward_off(void){(void)solaris_nd_s
et("ip_forwarding",0);returnipforward();}intipforward_ipv6(void){returnsolaris_n
d_get("ip6_forwarding");}intipforward_ipv6_on(void){(void)solaris_nd_set("ip6_fo
rwarding",1);returnipforward_ipv6();}intipforward_ipv6_off(void){(void)solaris_n
d_set("ip6_forwarding",0);returnipforward_ipv6();}#endif/*SUNOS_5*/