/*zebraNSRoutines*Copyright(C)2016CumulusNetworks,Inc.*DonaldSharp*Copyright(C)2
017/20186WIND**ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributei
tand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSo
ftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistr
ibutedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwa
rrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLi
censeformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealon
g*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.
,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include"zebra.h"#include"lib/n
s.h"#include"lib/vrf.h"#include"lib/logicalrouter.h"#include"lib/prefix.h"#inclu
de"lib/memory.h"#include"rtadv.h"#include"zebra_ns.h"#include"zebra_vrf.h"#inclu
de"zebra_memory.h"#include"rt.h"#include"zebra_vxlan.h"#include"debug.h"#include
"zebra_netns_notify.h"#include"zebra_netns_id.h"#include"zebra_pbr.h"#include"ri
b.h"#include"table_manager.h"externstructzebra_privs_tzserv_privs;DEFINE_MTYPE(Z
EBRA,ZEBRA_NS,"ZebraNameSpace")staticinlineintzebra_ns_table_entry_compare(const
structzebra_ns_table*e1,conststructzebra_ns_table*e2);RB_GENERATE(zebra_ns_table
_head,zebra_ns_table,zebra_ns_table_entry,zebra_ns_table_entry_compare);staticst
ructzebra_ns*dzns;staticinlineintzebra_ns_table_entry_compare(conststructzebra_n
s_table*e1,conststructzebra_ns_table*e2){if(e1->tableid==e2->tableid)return(e1->
afi-e2->afi);returne1->tableid-e2->tableid;}staticintlogicalrouter_config_write(
structvty*vty);structzebra_ns*zebra_ns_lookup(ns_id_tns_id){if(ns_id==NS_DEFAULT
)returndzns;structzebra_ns*info=(structzebra_ns*)ns_info_lookup(ns_id);return(in
fo==NULL)?dzns:info;}staticstructzebra_ns*zebra_ns_alloc(void){returnXCALLOC(MTY
PE_ZEBRA_NS,sizeof(structzebra_ns));}staticintzebra_ns_new(structns*ns){structze
bra_ns*zns;if(IS_ZEBRA_DEBUG_EVENT)zlog_info("ZNS%swithid%u(created)",ns->name,n
s->ns_id);zns=zebra_ns_alloc();ns->info=zns;zns->ns=ns;/*Doanyneededper-NSdatast
ructureallocation.*/zns->if_table=route_table_init();zebra_vxlan_ns_init(zns);re
turn0;}staticintzebra_ns_delete(structns*ns){structzebra_ns*zns=(structzebra_ns*
)ns->info;if(IS_ZEBRA_DEBUG_EVENT)zlog_info("ZNS%swithid%u(deleted)",ns->name,ns
->ns_id);if(!zns)return0;XFREE(MTYPE_ZEBRA_NS,zns);return0;}staticintzebra_ns_en
abled(structns*ns){structzebra_ns*zns=ns->info;if(IS_ZEBRA_DEBUG_EVENT)zlog_info
("ZNS%swithid%u(enabled)",ns->name,ns->ns_id);if(!zns)return0;returnzebra_ns_ena
ble(ns->ns_id,(void**)&zns);}intzebra_ns_disabled(structns*ns){structzebra_ns*zn
s=ns->info;if(IS_ZEBRA_DEBUG_EVENT)zlog_info("ZNS%swithid%u(disabled)",ns->name,
ns->ns_id);if(!zns)return0;returnzebra_ns_disable(ns->ns_id,(void**)&zns);}/*Dog
lobalenableactions-opensockets,readkernelconfigetc.*/intzebra_ns_enable(ns_id_tn
s_id,void**info){structzebra_ns*zns=(structzebra_ns*)(*info);zns->ns_id=ns_id;zn
s->rules_hash=hash_create_size(8,zebra_pbr_rules_hash_key,zebra_pbr_rules_hash_e
qual,"RulesHash");#ifdefined(HAVE_RTADV)rtadv_init(zns);#endifkernel_init(zns);i
nterface_list(zns);route_read(zns);/*InitiateTableManagerperZNS*/table_manager_e
nable(ns_id);return0;}structroute_table*zebra_ns_find_table(structzebra_ns*zns,u
int32_ttableid,afi_tafi){structzebra_ns_tablefinder;structzebra_ns_table*znst;me
mset(&finder,0,sizeof(finder));finder.afi=afi;finder.tableid=tableid;znst=RB_FIN
D(zebra_ns_table_head,&zns->ns_tables,&finder);if(znst)returnznst->table;elseret
urnNULL;}unsignedlongzebra_ns_score_proto(uint8_tproto,unsignedshortinstance){st
ructzebra_ns*zns;structzebra_ns_table*znst;unsignedlongcnt=0;zns=zebra_ns_lookup
(NS_DEFAULT);RB_FOREACH(znst,zebra_ns_table_head,&zns->ns_tables)cnt+=rib_score_
proto_table(proto,instance,znst->table);returncnt;}voidzebra_ns_sweep_route(void
){structzebra_ns_table*znst;structzebra_ns*zns;zns=zebra_ns_lookup(NS_DEFAULT);R
B_FOREACH(znst,zebra_ns_table_head,&zns->ns_tables)rib_sweep_table(znst->table);
}structroute_table*zebra_ns_get_table(structzebra_ns*zns,structzebra_vrf*zvrf,ui
nt32_ttableid,afi_tafi){structzebra_ns_tablefinder;structzebra_ns_table*znst;rib
_table_info_t*info;memset(&finder,0,sizeof(finder));finder.afi=afi;finder.tablei
d=tableid;znst=RB_FIND(zebra_ns_table_head,&zns->ns_tables,&finder);if(znst)retu
rnznst->table;znst=XCALLOC(MTYPE_ZEBRA_NS,sizeof(*znst));znst->tableid=tableid;z
nst->afi=afi;znst->table=(afi==AFI_IP6)?srcdest_table_init():route_table_init();
info=XCALLOC(MTYPE_RIB_TABLE_INFO,sizeof(*info));info->zvrf=zvrf;info->afi=afi;i
nfo->safi=SAFI_UNICAST;znst->table->info=info;znst->table->cleanup=zebra_rtable_
node_cleanup;RB_INSERT(zebra_ns_table_head,&zns->ns_tables,znst);returnznst->tab
le;}staticvoidzebra_ns_free_table(structzebra_ns_table*znst){void*table_info;rib
_close_table(znst->table);table_info=znst->table->info;route_table_finish(znst->
table);XFREE(MTYPE_RIB_TABLE_INFO,table_info);XFREE(MTYPE_ZEBRA_NS,znst);}intzeb
ra_ns_disable(ns_id_tns_id,void**info){structzebra_ns_table*znst;structzebra_ns*
zns=(structzebra_ns*)(*info);hash_clean(zns->rules_hash,zebra_pbr_rules_free);ha
sh_free(zns->rules_hash);while(!RB_EMPTY(zebra_ns_table_head,&zns->ns_tables)){z
nst=RB_ROOT(zebra_ns_table_head,&zns->ns_tables);RB_REMOVE(zebra_ns_table_head,&
zns->ns_tables,znst);zebra_ns_free_table(znst);}route_table_finish(zns->if_table
);zebra_vxlan_ns_disable(zns);#ifdefined(HAVE_RTADV)rtadv_terminate(zns);#endifk
ernel_terminate(zns);table_manager_disable(zns->ns_id);zns->ns_id=NS_DEFAULT;ret
urn0;}intzebra_ns_init(void){ns_id_tns_id;dzns=zebra_ns_alloc();if(zserv_privs.c
hange(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");ns_id=zebra_ns_id_get_defau
lt();if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");ns_ini
t_management(ns_id);logicalrouter_init(logicalrouter_config_write);/*Doanyneeded
per-NSdatastructureallocation.*/dzns->if_table=route_table_init();zebra_vxlan_ns
_init(dzns);/*RegisterzebraVRFcallbacks,createandactivatedefaultVRF.*/zebra_vrf_
init();/*DefaultNSisactivated*/zebra_ns_enable(ns_id,(void**)&dzns);if(vrf_is_ba
ckend_netns()){ns_add_hook(NS_NEW_HOOK,zebra_ns_new);ns_add_hook(NS_ENABLE_HOOK,
zebra_ns_enabled);ns_add_hook(NS_DISABLE_HOOK,zebra_ns_disabled);ns_add_hook(NS_
DELETE_HOOK,zebra_ns_delete);zebra_ns_notify_parse();zebra_ns_notify_init();}ret
urn0;}staticintlogicalrouter_config_write(structvty*vty){structns*ns;intwrite=0;
RB_FOREACH(ns,ns_head,&ns_tree){if(ns->ns_id==NS_DEFAULT||ns->name==NULL)continu
e;vty_out(vty,"logical-router%unetns%s\n",ns->ns_id,ns->name);write=1;}returnwri
te;}intzebra_ns_config_write(structvty*vty,structns*ns){if(ns&&ns->name!=NULL)vt
y_out(vty,"netns%s\n",ns->name);return0;}