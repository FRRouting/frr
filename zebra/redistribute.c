/*RedistributionHandler*Copyright(C)1998KunihiroIshiguro**ThisfileispartofGNUZeb
ra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofth
eGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,o
r(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeusef
ul,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNE
SSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshould
havereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOP
YING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston
,MA02110-1301USA*/#include<zebra.h>#include"vector.h"#include"vty.h"#include"com
mand.h"#include"prefix.h"#include"table.h"#include"stream.h"#include"zclient.h"#
include"linklist.h"#include"log.h"#include"vrf.h"#include"srcdest_table.h"#inclu
de"zebra/rib.h"#include"zebra/zserv.h"#include"zebra/zebra_ns.h"#include"zebra/z
ebra_vrf.h"#include"zebra/zebra_routemap.h"#include"zebra/redistribute.h"#includ
e"zebra/debug.h"#include"zebra/router-id.h"#include"zebra/zebra_memory.h"#includ
e"zebra/zebra_vxlan.h"#defineZEBRA_PTM_SUPPORT/*arrayholdingredistributeinfoabou
ttableredistribution*//*bitAFIissetifthatAFIisredistributingroutesfromthistable*
/staticintzebra_import_table_used[AFI_MAX][ZEBRA_KERNEL_TABLE_MAX];staticuint32_
tzebra_import_table_distance[AFI_MAX][ZEBRA_KERNEL_TABLE_MAX];intis_zebra_import
_table_enabled(afi_tafi,uint32_ttable_id){/**Makesurethatwhatwearecalledwithactu
alymakessense*/if(afi==AFI_MAX)return0;if(is_zebra_valid_kernel_table(table_id)&
&table_id<ZEBRA_KERNEL_TABLE_MAX)returnzebra_import_table_used[afi][table_id];re
turn0;}staticvoidzebra_redistribute_default(structzserv*client,vrf_id_tvrf_id){i
ntafi;structprefixp;structroute_table*table;structroute_node*rn;structroute_entr
y*newre;for(afi=AFI_IP;afi<=AFI_IP6;afi++){/*Lookuptable.*/table=zebra_vrf_table
(afi,SAFI_UNICAST,vrf_id);if(!table)continue;/*Lookupdefaultroute.*/memset(&p,0,
sizeof(p));p.family=afi2family(afi);rn=route_node_lookup(table,&p);if(!rn)contin
ue;RNODE_FOREACH_RE(rn,newre){if(CHECK_FLAG(newre->flags,ZEBRA_FLAG_SELECTED)&&n
ewre->distance!=DISTANCE_INFINITY)zsend_redistribute_route(ZEBRA_REDISTRIBUTE_RO
UTE_ADD,client,&rn->p,NULL,newre);}route_unlock_node(rn);}}/*Redistributeroutes.
*/staticvoidzebra_redistribute(structzserv*client,inttype,unsignedshortinstance,
vrf_id_tvrf_id,intafi){structroute_entry*newre;structroute_table*table;structrou
te_node*rn;table=zebra_vrf_table(afi,SAFI_UNICAST,vrf_id);if(!table)return;for(r
n=route_top(table);rn;rn=srcdest_route_next(rn))RNODE_FOREACH_RE(rn,newre){struc
tprefix*dst_p,*src_p;srcdest_rnode_prefixes(rn,&dst_p,&src_p);if(IS_ZEBRA_DEBUG_
EVENT)zlog_debug("%s:client%svrf%dchecking:selected=%d,type=%d,distance=%d,""zeb
ra_check_addr=%d",__func__,zebra_route_string(client->proto),vrf_id,CHECK_FLAG(n
ewre->flags,ZEBRA_FLAG_SELECTED),newre->type,newre->distance,zebra_check_addr(ds
t_p));if(!CHECK_FLAG(newre->flags,ZEBRA_FLAG_SELECTED))continue;if((type!=ZEBRA_
ROUTE_ALL&&(newre->type!=type||newre->instance!=instance)))continue;if(newre->di
stance==DISTANCE_INFINITY)continue;if(!zebra_check_addr(dst_p))continue;zsend_re
distribute_route(ZEBRA_REDISTRIBUTE_ROUTE_ADD,client,dst_p,src_p,newre);}}/*Eith
eradvertisearouteforredistributiontoregisteredclientsor*//*withdrawredistributio
nifaddcannotbedoneforclient*/voidredistribute_update(structprefix*p,structprefix
*src_p,structroute_entry*re,structroute_entry*prev_re){structlistnode*node,*nnod
e;structzserv*client;intsend_redistribute;intafi;charbuf[INET6_ADDRSTRLEN];if(IS
_ZEBRA_DEBUG_RIB){inet_ntop(p->family,&p->u.prefix,buf,INET6_ADDRSTRLEN);zlog_de
bug("%u:%s/%d:Redistupdatere%p(type%d),old%p(type%d)",re->vrf_id,buf,p->prefixle
n,re,re->type,prev_re,prev_re?prev_re->type:-1);}afi=family2afi(p->family);if(!a
fi){zlog_warn("%s:UnknownAFI/SAFIprefixreceived\n",__FUNCTION__);return;}for(ALL
_LIST_ELEMENTS(zebrad.client_list,node,nnode,client)){send_redistribute=0;if(is_
default_prefix(p)&&vrf_bitmap_check(client->redist_default,re->vrf_id))send_redi
stribute=1;elseif(vrf_bitmap_check(client->redist[afi][ZEBRA_ROUTE_ALL],re->vrf_
id))send_redistribute=1;elseif(re->instance&&redist_check_instance(&client->mi_r
edist[afi][re->type],re->instance))send_redistribute=1;elseif(vrf_bitmap_check(c
lient->redist[afi][re->type],re->vrf_id))send_redistribute=1;if(send_redistribut
e){zsend_redistribute_route(ZEBRA_REDISTRIBUTE_ROUTE_ADD,client,p,src_p,re);}els
eif(prev_re&&((re->instance&&redist_check_instance(&client->mi_redist[afi][prev_
re->type],re->instance))||vrf_bitmap_check(client->redist[afi][prev_re->type],re
->vrf_id))){zsend_redistribute_route(ZEBRA_REDISTRIBUTE_ROUTE_DEL,client,p,src_p
,prev_re);}}}voidredistribute_delete(structprefix*p,structprefix*src_p,structrou
te_entry*re){structlistnode*node,*nnode;structzserv*client;charbuf[INET6_ADDRSTR
LEN];intafi;if(IS_ZEBRA_DEBUG_RIB){inet_ntop(p->family,&p->u.prefix,buf,INET6_AD
DRSTRLEN);zlog_debug("%u:%s/%d:Redistdeletere%p(type%d)",re->vrf_id,buf,p->prefi
xlen,re,re->type);}/*AddDISTANCE_INFINITYcheck.*/if(re->distance==DISTANCE_INFIN
ITY)return;afi=family2afi(p->family);if(!afi){zlog_warn("%s:UnknownAFI/SAFIprefi
xreceived\n",__FUNCTION__);return;}for(ALL_LIST_ELEMENTS(zebrad.client_list,node
,nnode,client)){if((is_default_prefix(p)&&vrf_bitmap_check(client->redist_defaul
t,re->vrf_id))||vrf_bitmap_check(client->redist[afi][ZEBRA_ROUTE_ALL],re->vrf_id
)||(re->instance&&redist_check_instance(&client->mi_redist[afi][re->type],re->in
stance))||vrf_bitmap_check(client->redist[afi][re->type],re->vrf_id)){zsend_redi
stribute_route(ZEBRA_REDISTRIBUTE_ROUTE_DEL,client,p,src_p,re);}}}voidzebra_redi
stribute_add(ZAPI_HANDLER_ARGS){afi_tafi=0;inttype=0;unsignedshortinstance;STREA
M_GETC(msg,afi);STREAM_GETC(msg,type);STREAM_GETW(msg,instance);if(IS_ZEBRA_DEBU
G_EVENT)zlog_debug("%s:clientproto%safi=%d,wants%s,vrf%d,instance=%d",__func__,z
ebra_route_string(client->proto),afi,zebra_route_string(type),zvrf_id(zvrf),inst
ance);if(afi==0||afi>AFI_MAX){zlog_warn("%s:Specifiedafi%ddoesnotexist",__PRETTY
_FUNCTION__,afi);return;}if(type==0||type>=ZEBRA_ROUTE_MAX){zlog_warn("%s:Specif
iedRouteType%ddoesnotexist",__PRETTY_FUNCTION__,type);return;}if(instance){if(!r
edist_check_instance(&client->mi_redist[afi][type],instance)){redist_add_instanc
e(&client->mi_redist[afi][type],instance);zebra_redistribute(client,type,instanc
e,zvrf_id(zvrf),afi);}}else{if(!vrf_bitmap_check(client->redist[afi][type],zvrf_
id(zvrf))){if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("%s:settingvrf%dredistbitmap",__fu
nc__,zvrf_id(zvrf));vrf_bitmap_set(client->redist[afi][type],zvrf_id(zvrf));zebr
a_redistribute(client,type,0,zvrf_id(zvrf),afi);}}stream_failure:return;}voidzeb
ra_redistribute_delete(ZAPI_HANDLER_ARGS){afi_tafi=0;inttype=0;unsignedshortinst
ance;STREAM_GETC(msg,afi);STREAM_GETC(msg,type);STREAM_GETW(msg,instance);if(afi
==0||afi>AFI_MAX){zlog_warn("%s:Specifiedafi%ddoesnotexist",__PRETTY_FUNCTION__,
afi);return;}if(type==0||type>=ZEBRA_ROUTE_MAX){zlog_warn("%s:SpecifiedRouteType
%ddoesnotexist",__PRETTY_FUNCTION__,type);return;}/**NOTE:noneedtowithdrawthepre
viouslyadvertisedroutes.The*clients*themselvesshouldkeeptrackofthereceivedroutes
fromzebraand*withdrawthemwhennecessary.*/if(instance)redist_del_instance(&client
->mi_redist[afi][type],instance);elsevrf_bitmap_unset(client->redist[afi][type],
zvrf_id(zvrf));stream_failure:return;}voidzebra_redistribute_default_add(ZAPI_HA
NDLER_ARGS){vrf_bitmap_set(client->redist_default,zvrf_id(zvrf));zebra_redistrib
ute_default(client,zvrf_id(zvrf));}voidzebra_redistribute_default_delete(ZAPI_HA
NDLER_ARGS){vrf_bitmap_unset(client->redist_default,zvrf_id(zvrf));}/*Interfaceu
pinformation.*/voidzebra_interface_up_update(structinterface*ifp){structlistnode
*node,*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("MESSAGE:ZEBR
A_INTERFACE_UP%s",ifp->name);if(ifp->ptm_status||!ifp->ptm_enable){for(ALL_LIST_
ELEMENTS(zebrad.client_list,node,nnode,client))if(client->ifinfo){zsend_interfac
e_update(ZEBRA_INTERFACE_UP,client,ifp);zsend_interface_link_params(client,ifp);
}}}/*Interfacedowninformation.*/voidzebra_interface_down_update(structinterface*
ifp){structlistnode*node,*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVENT)zlog_
debug("MESSAGE:ZEBRA_INTERFACE_DOWN%s",ifp->name);for(ALL_LIST_ELEMENTS(zebrad.c
lient_list,node,nnode,client)){zsend_interface_update(ZEBRA_INTERFACE_DOWN,clien
t,ifp);}}/*Interfaceinformationupdate.*/voidzebra_interface_add_update(structint
erface*ifp){structlistnode*node,*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVEN
T)zlog_debug("MESSAGE:ZEBRA_INTERFACE_ADD%s[%d]",ifp->name,ifp->vrf_id);for(ALL_
LIST_ELEMENTS(zebrad.client_list,node,nnode,client))if(client->ifinfo){client->i
fadd_cnt++;zsend_interface_add(client,ifp);zsend_interface_link_params(client,if
p);}}voidzebra_interface_delete_update(structinterface*ifp){structlistnode*node,
*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("MESSAGE:ZEBRA_INTE
RFACE_DELETE%s",ifp->name);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,c
lient)){client->ifdel_cnt++;zsend_interface_delete(client,ifp);}}/*Interfaceaddr
essaddition.*/voidzebra_interface_address_add_update(structinterface*ifp,structc
onnected*ifc){structlistnode*node,*nnode;structzserv*client;structprefix*p;if(IS
_ZEBRA_DEBUG_EVENT){charbuf[PREFIX_STRLEN];p=ifc->address;zlog_debug("MESSAGE:ZE
BRA_INTERFACE_ADDRESS_ADD%son%s",prefix2str(p,buf,sizeof(buf)),ifc->ifp->name);}
if(!CHECK_FLAG(ifc->conf,ZEBRA_IFC_REAL))zlog_warn("WARNING:advertisingaddressto
clientsthatisnotyetusable.");zebra_vxlan_add_del_gw_macip(ifp,ifc->address,1);ro
uter_id_add_address(ifc);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,cli
ent))if(CHECK_FLAG(ifc->conf,ZEBRA_IFC_REAL)){client->connected_rt_add_cnt++;zse
nd_interface_address(ZEBRA_INTERFACE_ADDRESS_ADD,client,ifp,ifc);}}/*Interfacead
dressdeletion.*/voidzebra_interface_address_delete_update(structinterface*ifp,st
ructconnected*ifc){structlistnode*node,*nnode;structzserv*client;structprefix*p;
if(IS_ZEBRA_DEBUG_EVENT){charbuf[PREFIX_STRLEN];p=ifc->address;zlog_debug("MESSA
GE:ZEBRA_INTERFACE_ADDRESS_DELETE%son%s",prefix2str(p,buf,sizeof(buf)),ifc->ifp-
>name);}zebra_vxlan_add_del_gw_macip(ifp,ifc->address,0);router_id_del_address(i
fc);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,client))if(CHECK_FLAG(if
c->conf,ZEBRA_IFC_REAL)){client->connected_rt_del_cnt++;zsend_interface_address(
ZEBRA_INTERFACE_ADDRESS_DELETE,client,ifp,ifc);}}/*InterfaceVRFchange.Mayneedtod
eletefromclientsnotinterestedin*thenewVRF.Notethatthisfunctionisinvoked*prior*to
theVRFchange.*/voidzebra_interface_vrf_update_del(structinterface*ifp,vrf_id_tne
w_vrf_id){structlistnode*node,*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVENT)
zlog_debug("MESSAGE:ZEBRA_INTERFACE_VRF_UPDATE/DEL%sVRFId%u->%u",ifp->name,ifp->
vrf_id,new_vrf_id);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,client)){
/*Needtodeleteiftheclientisnotinterestedinthenew*VRF.*/zsend_interface_update(ZE
BRA_INTERFACE_DOWN,client,ifp);client->ifdel_cnt++;zsend_interface_delete(client
,ifp);zsend_interface_vrf_update(client,ifp,new_vrf_id);}}/*InterfaceVRFchange.T
hisfunctionisinvoked*post*VRFchangeandsendsan*addtoclientswhoareinterestedinthen
ewVRFbutnotintheoldVRF.*/voidzebra_interface_vrf_update_add(structinterface*ifp,
vrf_id_told_vrf_id){structlistnode*node,*nnode;structzserv*client;if(IS_ZEBRA_DE
BUG_EVENT)zlog_debug("MESSAGE:ZEBRA_INTERFACE_VRF_UPDATE/ADD%sVRFId%u->%u",ifp->
name,old_vrf_id,ifp->vrf_id);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode
,client)){/*NeedtoaddiftheclientisinterestedinthenewVRF.*/client->ifadd_cnt++;zs
end_interface_add(client,ifp);zsend_interface_addresses(client,ifp);}}intzebra_a
dd_import_table_entry(structroute_node*rn,structroute_entry*re,constchar*rmap_na
me){structroute_entry*newre;structroute_entry*same;structprefixp;route_map_resul
t_tret=RMAP_MATCH;afi_tafi;afi=family2afi(rn->p.family);if(rmap_name)ret=zebra_i
mport_table_route_map_check(afi,re->type,&rn->p,re->ng.nexthop,re->vrf_id,re->ta
g,rmap_name);if(ret!=RMAP_MATCH){zebra_del_import_table_entry(rn,re);return0;}pr
efix_copy(&p,&rn->p);RNODE_FOREACH_RE(rn,same){if(CHECK_FLAG(same->status,ROUTE_
ENTRY_REMOVED))continue;if(same->type==re->type&&same->instance==re->instance&&s
ame->table==re->table&&same->type!=ZEBRA_ROUTE_CONNECT)break;}if(same)zebra_del_
import_table_entry(rn,same);newre=XCALLOC(MTYPE_RE,sizeof(structroute_entry));ne
wre->type=ZEBRA_ROUTE_TABLE;newre->distance=zebra_import_table_distance[afi][re-
>table];newre->flags=re->flags;newre->metric=re->metric;newre->mtu=re->mtu;newre
->table=zebrad.rtm_table_default;newre->nexthop_num=0;newre->uptime=time(NULL);n
ewre->instance=re->table;route_entry_copy_nexthops(newre,re->ng.nexthop);rib_add
_multipath(afi,SAFI_UNICAST,&p,NULL,newre);return0;}intzebra_del_import_table_en
try(structroute_node*rn,structroute_entry*re){structprefixp;afi_tafi;afi=family2
afi(rn->p.family);prefix_copy(&p,&rn->p);rib_delete(afi,SAFI_UNICAST,re->vrf_id,
ZEBRA_ROUTE_TABLE,re->table,re->flags,&p,NULL,re->ng.nexthop,zebrad.rtm_table_de
fault,re->metric,false,NULL);return0;}/*Assumingnoonecallsthiswiththemainrouting
table*/intzebra_import_table(afi_tafi,uint32_ttable_id,uint32_tdistance,constcha
r*rmap_name,intadd){structroute_table*table;structroute_entry*re;structroute_nod
e*rn;if(!is_zebra_valid_kernel_table(table_id)||((table_id==RT_TABLE_MAIN)||(tab
le_id==zebrad.rtm_table_default)))return(-1);if(afi>=AFI_MAX)return(-1);table=ze
bra_vrf_other_route_table(afi,table_id,VRF_DEFAULT);if(table==NULL){return0;}els
eif(IS_ZEBRA_DEBUG_RIB){zlog_debug("%sroutesfromtable%d",add?"Importing":"Unimpo
rting",table_id);}if(add){if(rmap_name)zebra_add_import_table_route_map(afi,rmap
_name,table_id);else{rmap_name=zebra_get_import_table_route_map(afi,table_id);if
(rmap_name)zebra_del_import_table_route_map(afi,table_id);}zebra_import_table_us
ed[afi][table_id]=1;zebra_import_table_distance[afi][table_id]=distance;}else{ze
bra_import_table_used[afi][table_id]=0;zebra_import_table_distance[afi][table_id
]=ZEBRA_TABLE_DISTANCE_DEFAULT;rmap_name=zebra_get_import_table_route_map(afi,ta
ble_id);if(rmap_name)zebra_del_import_table_route_map(afi,table_id);}for(rn=rout
e_top(table);rn;rn=route_next(rn)){/*Foreachentryinthenon-defaultroutingtable,*a
ddtheentryinthemaintable*/if(!rn->info)continue;RNODE_FOREACH_RE(rn,re){if(CHECK
_FLAG(re->status,ROUTE_ENTRY_REMOVED))continue;break;}if(!re)continue;if(((afi==
AFI_IP)&&(rn->p.family==AF_INET))||((afi==AFI_IP6)&&(rn->p.family==AF_INET6))){i
f(add)zebra_add_import_table_entry(rn,re,rmap_name);elsezebra_del_import_table_e
ntry(rn,re);}}return0;}intzebra_import_table_config(structvty*vty){inti;afi_tafi
;intwrite=0;charafi_str[AFI_MAX][10]={"","ip","ipv6","ethernet"};constchar*rmap_
name;for(afi=AFI_IP;afi<AFI_MAX;afi++){for(i=1;i<ZEBRA_KERNEL_TABLE_MAX;i++){if(
!is_zebra_import_table_enabled(afi,i))continue;if(zebra_import_table_distance[af
i][i]!=ZEBRA_TABLE_DISTANCE_DEFAULT){vty_out(vty,"%simport-table%ddistance%d",af
i_str[afi],i,zebra_import_table_distance[afi][i]);}else{vty_out(vty,"%simport-ta
ble%d",afi_str[afi],i);}rmap_name=zebra_get_import_table_route_map(afi,i);if(rma
p_name)vty_out(vty,"route-map%s",rmap_name);vty_out(vty,"\n");write=1;}}returnwr
ite;}voidzebra_import_table_rm_update(){afi_tafi;inti;structroute_table*table;st
ructroute_entry*re;structroute_node*rn;constchar*rmap_name;for(afi=AFI_IP;afi<AF
I_MAX;afi++){for(i=1;i<ZEBRA_KERNEL_TABLE_MAX;i++){if(!is_zebra_import_table_ena
bled(afi,i))continue;rmap_name=zebra_get_import_table_route_map(afi,i);if(!rmap_
name)return;table=zebra_vrf_other_route_table(afi,i,VRF_DEFAULT);for(rn=route_to
p(table);rn;rn=route_next(rn)){/*Foreachentryinthenon-default*routingtable,*addt
heentryinthemaintable*/if(!rn->info)continue;RNODE_FOREACH_RE(rn,re){if(CHECK_FL
AG(re->status,ROUTE_ENTRY_REMOVED))continue;break;}if(!re)continue;if(((afi==AFI
_IP)&&(rn->p.family==AF_INET))||((afi==AFI_IP6)&&(rn->p.family==AF_INET6)))zebra
_add_import_table_entry(rn,re,rmap_name);}}}return;}/*Interfaceparametersupdate*
/voidzebra_interface_parameters_update(structinterface*ifp){structlistnode*node,
*nnode;structzserv*client;if(IS_ZEBRA_DEBUG_EVENT)zlog_debug("MESSAGE:ZEBRA_INTE
RFACE_LINK_PARAMS%s",ifp->name);for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nn
ode,client))if(client->ifinfo)zsend_interface_link_params(client,ifp);}