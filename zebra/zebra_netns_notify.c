/**ZebraNScollectorandnotifierforNetworkNameSpaces*Copyright(C)20176WIND**Thispr
ogramisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGene
ralPublicLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicen
se,or(atyouroption)*anylaterversion.**Thisprogramisdistributedinthehopethatitwil
lbeuseful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYo
r*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Yo
ushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethe
fileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor
,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefHAVE_NETLINK#ifdefHAVE_NETNS#und
ef_GNU_SOURCE#define_GNU_SOURCE#include<sched.h>#endif#include<dirent.h>#include
<sys/inotify.h>#include<sys/stat.h>#include"thread.h"#include"ns.h"#include"comm
and.h"#include"memory.h"#include"zserv.h"#include"zebra_memory.h"#endif/*defined
(HAVE_NETLINK)*/#include"zebra_netns_notify.h"#include"zebra_netns_id.h"#ifdefHA
VE_NETLINK/*uponcreationoffolderunder/var/run/netns,*waitthatnetnscontextisbound
to*thatfolder10seconds*/#defineZEBRA_NS_POLLING_INTERVAL_MSEC1000#defineZEBRA_NS
_POLLING_MAX_RETRIES200DEFINE_MTYPE_STATIC(ZEBRA,NETNS_MISC,"ZebraNetNSInfo")sta
ticstructthread*zebra_netns_notify_current;structzebra_netns_info{constchar*netn
spath;unsignedintretries;};staticintzebra_ns_ready_read(structthread*t);staticvo
idzebra_ns_notify_create_context_from_entry_name(constchar*name);staticintzebra_
ns_continue_read(structzebra_netns_info*zns_info,intstop_retry);staticintzebra_n
s_notify_read(structthread*t);staticvoidzebra_ns_notify_create_context_from_entr
y_name(constchar*name){char*netnspath=ns_netns_pathname(NULL,name);structvrf*vrf
;intret;ns_id_tns_id;if(netnspath==NULL)return;if(zserv_privs.change(ZPRIVS_RAIS
E))zlog_err("Can'traiseprivileges");ns_id=zebra_ns_id_get(netnspath);if(zserv_pr
ivs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");/*ifVRFwithNSIDalready
present*/vrf=vrf_lookup_by_id((vrf_id_t)ns_id);if(vrf){zlog_warn("NSnotify:sameN
SIDusedbyVRF%s.IgnoreNS%screation",vrf->name,netnspath);return;}if(vrf_handler_c
reate(NULL,name,&vrf)!=CMD_SUCCESS){zlog_warn("NSnotify:failedtocreateVRF%s",nam
e);return;}if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");
ret=vrf_netns_handler_create(NULL,vrf,netnspath,ns_id);if(zserv_privs.change(ZPR
IVS_LOWER))zlog_err("Can'tlowerprivileges");if(ret!=CMD_SUCCESS){zlog_warn("NSno
tify:failedtocreateNS%s",netnspath);return;}zlog_info("NSnotify:createdVRF%sNS%s
",name,netnspath);}staticintzebra_ns_continue_read(structzebra_netns_info*zns_in
fo,intstop_retry){void*ns_path_ptr=(void*)zns_info->netnspath;if(stop_retry){XFR
EE(MTYPE_NETNS_MISC,ns_path_ptr);XFREE(MTYPE_NETNS_MISC,zns_info);return0;}threa
d_add_timer_msec(zebrad.master,zebra_ns_ready_read,(void*)zns_info,ZEBRA_NS_POLL
ING_INTERVAL_MSEC,NULL);return0;}staticintzebra_ns_delete(char*name){structvrf*v
rf=vrf_lookup_by_name(name);structns*ns;if(!vrf){zlog_warn("NSnotify:noVRFfoundu
singNS%s",name);return0;}/*Clearconfiguredflagandinvokedelete.*/UNSET_FLAG(vrf->
status,VRF_CONFIGURED);ns=(structns*)vrf->ns_ctxt;/*thedeletionorderisthesame*as
theoneusedwhensigingsignalisreceived*/vrf_delete(vrf);if(ns)ns_delete(ns);zlog_i
nfo("NSnotify:deletedVRF%s",name);return0;}staticintzebra_ns_ready_read(structth
read*t){structzebra_netns_info*zns_info=THREAD_ARG(t);constchar*netnspath;interr
,stop_retry=0;if(!zns_info)return0;if(!zns_info->netnspath){XFREE(MTYPE_NETNS_MI
SC,zns_info);return0;}netnspath=zns_info->netnspath;if(--zns_info->retries==0)st
op_retry=1;if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traiseprivileges");
err=ns_switch_to_netns(netnspath);if(zserv_privs.change(ZPRIVS_LOWER))zlog_err("
Can'tlowerprivileges");if(err<0)returnzebra_ns_continue_read(zns_info,stop_retry
);/*gobacktodefaultns*/if(zserv_privs.change(ZPRIVS_RAISE))zlog_err("Can'traisep
rivileges");err=ns_switchback_to_initial();if(zserv_privs.change(ZPRIVS_LOWER))z
log_err("Can'tlowerprivileges");if(err<0)returnzebra_ns_continue_read(zns_info,s
top_retry);/*success:closefdandcreateznscontext*/zebra_ns_notify_create_context_
from_entry_name(basename(netnspath));returnzebra_ns_continue_read(zns_info,1);}s
taticintzebra_ns_notify_read(structthread*t){intfd_monitor=THREAD_FD(t);structin
otify_event*event;charbuf[BUFSIZ];ssize_tlen;zebra_netns_notify_current=thread_a
dd_read(zebrad.master,zebra_ns_notify_read,NULL,fd_monitor,NULL);len=read(fd_mon
itor,buf,sizeof(buf));if(len<0){zlog_warn("NSnotifyread:failedtoread(%s)",safe_s
trerror(errno));return0;}for(event=(structinotify_event*)buf;(char*)event<&buf[l
en];event=(structinotify_event*)((char*)event+sizeof(*event)+event->len)){char*n
etnspath;structzebra_netns_info*netnsinfo;if(!(event->mask&(IN_CREATE|IN_DELETE)
))continue;if(event->mask&IN_DELETE)returnzebra_ns_delete(event->name);netnspath
=ns_netns_pathname(NULL,event->name);if(!netnspath)continue;netnspath=XSTRDUP(MT
YPE_NETNS_MISC,netnspath);netnsinfo=XCALLOC(MTYPE_NETNS_MISC,sizeof(structzebra_
netns_info));netnsinfo->retries=ZEBRA_NS_POLLING_MAX_RETRIES;netnsinfo->netnspat
h=netnspath;thread_add_timer_msec(zebrad.master,zebra_ns_ready_read,(void*)netns
info,0,NULL);}return0;}voidzebra_ns_notify_parse(void){structdirent*dent;DIR*src
dir=opendir(NS_RUN_DIR);if(srcdir==NULL){zlog_warn("NSparsinginit:failedtoparse%
s",NS_RUN_DIR);return;}while((dent=readdir(srcdir))!=NULL){structstatst;if(strcm
p(dent->d_name,".")==0||strcmp(dent->d_name,"..")==0)continue;if(fstatat(dirfd(s
rcdir),dent->d_name,&st,0)<0){zlog_warn("NSparsinginit:failedtoparseentry%s",den
t->d_name);continue;}if(S_ISDIR(st.st_mode)){zlog_warn("NSparsinginit:%sisnotaNS
",dent->d_name);continue;}zebra_ns_notify_create_context_from_entry_name(dent->d
_name);}closedir(srcdir);}voidzebra_ns_notify_init(void){intfd_monitor;zebra_net
ns_notify_current=NULL;fd_monitor=inotify_init();if(fd_monitor<0){zlog_warn("NSn
otifyinit:failedtoinitializeinotify(%s)",safe_strerror(errno));}if(inotify_add_w
atch(fd_monitor,NS_RUN_DIR,IN_CREATE|IN_DELETE)<0){zlog_warn("NSnotifywatch:fail
edtoaddwatch(%s)",safe_strerror(errno));}zebra_netns_notify_current=thread_add_r
ead(zebrad.master,zebra_ns_notify_read,NULL,fd_monitor,NULL);}voidzebra_ns_notif
y_close(void){if(zebra_netns_notify_current==NULL)return;intfd=0;if(zebra_netns_
notify_current->u.fd>0)fd=zebra_netns_notify_current->u.fd;thread_cancel(zebra_n
etns_notify_current);/*auto-removalofinotifyitems*/if(fd>0)close(fd);}#elsevoidz
ebra_ns_notify_parse(void){}voidzebra_ns_notify_init(void){}voidzebra_ns_notify_
close(void){}#endif/*!HAVE_NETLINK*/