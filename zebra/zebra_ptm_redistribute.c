/***@copyrightCopyright(C)2015CumulusNetworks,Inc.**ThisfileispartofGNUZebra.**G
NUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGe
neralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyo
uroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but
*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORA
PARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavere
ceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;i
fnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA021
10-1301USA*/#include<zebra.h>#include"prefix.h"#include"vty.h"#include"stream.h"
#include"zebra/zserv.h"#include"zebra/zebra_ptm_redistribute.h"#include"zebra/ze
bra_memory.h"staticintzsend_interface_bfd_update(intcmd,structzserv*client,struc
tinterface*ifp,structprefix*dp,structprefix*sp,intstatus,vrf_id_tvrf_id){intblen
;structstream*s;/*Checkthisclientneedinterfaceinformation.*/if(!client->ifinfo)r
eturn0;s=stream_new(ZEBRA_MAX_PACKET_SIZ);zclient_create_header(s,cmd,vrf_id);if
(ifp)stream_putl(s,ifp->ifindex);elsestream_putl(s,0);/*BFDdestinationprefixinfo
rmation.*/stream_putc(s,dp->family);blen=prefix_blen(dp);stream_put(s,&dp->u.pre
fix,blen);stream_putc(s,dp->prefixlen);/*BFDstatus*/stream_putl(s,status);/*BFDs
ourceprefixinformation.*/stream_putc(s,sp->family);blen=prefix_blen(sp);stream_p
ut(s,&sp->u.prefix,blen);stream_putc(s,sp->prefixlen);/*Writepacketsize.*/stream
_putw_at(s,0,stream_get_endp(s));client->if_bfd_cnt++;returnzebra_server_send_me
ssage(client,s);}voidzebra_interface_bfd_update(structinterface*ifp,structprefix
*dp,structprefix*sp,intstatus,vrf_id_tvrf_id){structlistnode*node,*nnode;structz
serv*client;for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,client)){/*Suppo
rtingforOSPF,BGPandPIM*/if(client->proto!=ZEBRA_ROUTE_OSPF&&client->proto!=ZEBRA
_ROUTE_BGP&&client->proto!=ZEBRA_ROUTE_OSPF6&&client->proto!=ZEBRA_ROUTE_PIM)con
tinue;/*Notifytotheprotocoldaemons.*/zsend_interface_bfd_update(ZEBRA_INTERFACE_
BFD_DEST_UPDATE,client,ifp,dp,sp,status,vrf_id);}}staticintzsend_bfd_peer_replay
(intcmd,structzserv*client){structstream*s;s=stream_new(ZEBRA_MAX_PACKET_SIZ);zc
lient_create_header(s,cmd,VRF_DEFAULT);/*Writepacketsize.*/stream_putw_at(s,0,st
ream_get_endp(s));client->bfd_peer_replay_cnt++;returnzebra_server_send_message(
client,s);}voidzebra_bfd_peer_replay_req(void){structlistnode*node,*nnode;struct
zserv*client;for(ALL_LIST_ELEMENTS(zebrad.client_list,node,nnode,client)){/*Supp
ortingforBGP*/if((client->proto!=ZEBRA_ROUTE_BGP)&&(client->proto!=ZEBRA_ROUTE_O
SPF)&&(client->proto!=ZEBRA_ROUTE_OSPF6)&&(client->proto!=ZEBRA_ROUTE_PIM))conti
nue;/*Notifytotheprotocoldaemons.*/zsend_bfd_peer_replay(ZEBRA_BFD_DEST_REPLAY,c
lient);}}