/**RIPngroutesfunction.*Copyright(C)1998KunihiroIshiguro**ThisfileispartofGNUZeb
ra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofth
eGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,o
r(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeusef
ul,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNE
SSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshould
havereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOP
YING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston
,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"table.h"#include"m
emory.h"#include"if.h"#include"vty.h"#include"ripngd/ripngd.h"#include"ripngd/ri
png_route.h"staticstructripng_aggregate*ripng_aggregate_new(void){structripng_ag
gregate*new;new=XCALLOC(MTYPE_RIPNG_AGGREGATE,sizeof(structripng_aggregate));ret
urnnew;}voidripng_aggregate_free(structripng_aggregate*aggregate){XFREE(MTYPE_RI
PNG_AGGREGATE,aggregate);}/*Aggregatecountincrementcheck.*/voidripng_aggregate_i
ncrement(structroute_node*child,structripng_info*rinfo){structroute_node*np;stru
ctripng_aggregate*aggregate;for(np=child;np;np=np->parent)if((aggregate=np->aggr
egate)!=NULL){aggregate->count++;rinfo->suppress++;}}/*Aggregatecountdecrementch
eck.*/voidripng_aggregate_decrement(structroute_node*child,structripng_info*rinf
o){structroute_node*np;structripng_aggregate*aggregate;for(np=child;np;np=np->pa
rent)if((aggregate=np->aggregate)!=NULL){aggregate->count--;rinfo->suppress--;}}
/*Aggregatecountdecrementcheckforalist.*/voidripng_aggregate_decrement_list(stru
ctroute_node*child,structlist*list){structroute_node*np;structripng_aggregate*ag
gregate;structripng_info*rinfo=NULL;structlistnode*node=NULL;for(np=child;np;np=
np->parent)if((aggregate=np->aggregate)!=NULL)aggregate->count-=listcount(list);
for(ALL_LIST_ELEMENTS_RO(list,node,rinfo))rinfo->suppress--;}/*RIPngroutestreatm
ent.*/intripng_aggregate_add(structprefix*p){structroute_node*top;structroute_no
de*rp;structripng_info*rinfo;structripng_aggregate*aggregate;structripng_aggrega
te*sub;structlist*list=NULL;structlistnode*node=NULL;/*Gettopnodeforaggregation.
*/top=route_node_get(ripng->table,p);/*Allocatenewaggregate.*/aggregate=ripng_ag
gregate_new();aggregate->metric=1;top->aggregate=aggregate;/*Suppressroutesmatch
totheaggregate.*/for(rp=route_lock_node(top);rp;rp=route_next_until(rp,top)){/*S
uppressnormalroute.*/if((list=rp->info)!=NULL)for(ALL_LIST_ELEMENTS_RO(list,node
,rinfo)){aggregate->count++;rinfo->suppress++;}/*Suppressaggregateroute.Thismayn
otneed.*/if(rp!=top&&(sub=rp->aggregate)!=NULL){aggregate->count++;sub->suppress
++;}}return0;}/*DeleteRIPngstaticroute.*/intripng_aggregate_delete(structprefix*
p){structroute_node*top;structroute_node*rp;structripng_info*rinfo;structripng_a
ggregate*aggregate;structripng_aggregate*sub;structlist*list=NULL;structlistnode
*node=NULL;/*Gettopnodeforaggregation.*/top=route_node_get(ripng->table,p);/*All
ocatenewaggregate.*/aggregate=top->aggregate;/*Suppressroutesmatchtotheaggregate
.*/for(rp=route_lock_node(top);rp;rp=route_next_until(rp,top)){/*Suppressnormalr
oute.*/if((list=rp->info)!=NULL)for(ALL_LIST_ELEMENTS_RO(list,node,rinfo)){aggre
gate->count--;rinfo->suppress--;}if(rp!=top&&(sub=rp->aggregate)!=NULL){aggregat
e->count--;sub->suppress--;}}top->aggregate=NULL;ripng_aggregate_free(aggregate)
;route_unlock_node(top);route_unlock_node(top);return0;}