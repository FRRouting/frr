/*RIPngroutemap.*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebra.**GN
UZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGen
eralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyou
roption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*
WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAP
ARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaverec
eivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;if
not,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA0211
0-1301USA*/#include<zebra.h>#include"if.h"#include"memory.h"#include"prefix.h"#i
nclude"vty.h"#include"routemap.h"#include"command.h"#include"sockunion.h"#includ
e"ripngd/ripngd.h"structrip_metric_modifier{enum{metric_increment,metric_decreme
nt,metric_absolute}type;boolused;uint8_tmetric;};/*`matchmetricMETRIC'*//*Matchf
unctionreturn1ifmatchissuccesselsereturnzero.*/staticroute_map_result_troute_mat
ch_metric(void*rule,structprefix*prefix,route_map_object_ttype,void*object){uint
32_t*metric;structripng_info*rinfo;if(type==RMAP_RIPNG){metric=rule;rinfo=object
;if(rinfo->metric==*metric)returnRMAP_MATCH;elsereturnRMAP_NOMATCH;}returnRMAP_N
OMATCH;}/*Routemap`matchmetric'matchstatement.`arg'isMETRICvalue*/staticvoid*rou
te_match_metric_compile(constchar*arg){uint32_t*metric;metric=XMALLOC(MTYPE_ROUT
E_MAP_COMPILED,sizeof(uint32_t));*metric=atoi(arg);if(*metric>0)returnmetric;XFR
EE(MTYPE_ROUTE_MAP_COMPILED,metric);returnNULL;}/*Freeroutemap'scompiled`matchme
tric'value.*/staticvoidroute_match_metric_free(void*rule){XFREE(MTYPE_ROUTE_MAP_
COMPILED,rule);}/*Routemapcommandsformetricmatching.*/staticstructroute_map_rule
_cmdroute_match_metric_cmd={"metric",route_match_metric,route_match_metric_compi
le,route_match_metric_free};/*`matchinterfaceIFNAME'*//*Matchfunctionreturn1ifma
tchissuccesselsereturnzero.*/staticroute_map_result_troute_match_interface(void*
rule,structprefix*prefix,route_map_object_ttype,void*object){structripng_info*ri
nfo;structinterface*ifp;char*ifname;if(type==RMAP_RIPNG){ifname=rule;ifp=if_look
up_by_name(ifname,VRF_DEFAULT);if(!ifp)returnRMAP_NOMATCH;rinfo=object;if(rinfo-
>ifindex==ifp->ifindex)returnRMAP_MATCH;elsereturnRMAP_NOMATCH;}returnRMAP_NOMAT
CH;}/*Routemap`matchinterface'matchstatement.`arg'isIFNAMEvalue*/staticvoid*rout
e_match_interface_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,
arg);}staticvoidroute_match_interface_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMP
ILED,rule);}staticstructroute_map_rule_cmdroute_match_interface_cmd={"interface"
,route_match_interface,route_match_interface_compile,route_match_interface_free}
;/*`matchtagTAG'*//*Matchfunctionreturn1ifmatchissuccesselsereturnzero.*/staticr
oute_map_result_troute_match_tag(void*rule,structprefix*prefix,route_map_object_
ttype,void*object){route_tag_t*tag;structripng_info*rinfo;route_tag_trinfo_tag;i
f(type==RMAP_RIPNG){tag=rule;rinfo=object;/*Theinformationstoredbyrinfoishostord
ered.*/rinfo_tag=rinfo->tag;if(rinfo_tag==*tag)returnRMAP_MATCH;elsereturnRMAP_N
OMATCH;}returnRMAP_NOMATCH;}staticstructroute_map_rule_cmdroute_match_tag_cmd={"
tag",route_match_tag,route_map_rule_tag_compile,route_map_rule_tag_free,};/*`set
metricMETRIC'*//*Setmetrictoattribute.*/staticroute_map_result_troute_set_metric
(void*rule,structprefix*prefix,route_map_object_ttype,void*object){if(type==RMAP
_RIPNG){structrip_metric_modifier*mod;structripng_info*rinfo;mod=rule;rinfo=obje
ct;if(!mod->used)returnRMAP_OKAY;if(mod->type==metric_increment)rinfo->metric_ou
t+=mod->metric;elseif(mod->type==metric_decrement)rinfo->metric_out-=mod->metric
;elseif(mod->type==metric_absolute)rinfo->metric_out=mod->metric;if(rinfo->metri
c_out<1)rinfo->metric_out=1;if(rinfo->metric_out>RIPNG_METRIC_INFINITY)rinfo->me
tric_out=RIPNG_METRIC_INFINITY;rinfo->metric_set=1;}returnRMAP_OKAY;}/*setmetric
compilation.*/staticvoid*route_set_metric_compile(constchar*arg){intlen;constcha
r*pnt;longmetric;char*endptr=NULL;structrip_metric_modifier*mod;len=strlen(arg);
pnt=arg;mod=XMALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(structrip_metric_modifier));
mod->used=false;if(len==0)returnmod;/*Examinefirstcharacter.*/if(arg[0]=='+'){mo
d->type=metric_increment;pnt++;}elseif(arg[0]=='-'){mod->type=metric_decrement;p
nt++;}elsemod->type=metric_absolute;/*Checkbeginningwithdigitstring.*/if(*pnt<'0
'||*pnt>'9')returnmod;/*Convertstringtointeger.*/metric=strtol(pnt,&endptr,10);i
f(*endptr!='\0'||metric<0)returnmod;if(metric>RIPNG_METRIC_INFINITY){zlog_info("
%s:Metricspecified:%ldisbeingconvertedintoMETRIC_INFINITY",__PRETTY_FUNCTION__,m
etric);mod->metric=RIPNG_METRIC_INFINITY;}elsemod->metric=metric;mod->used=true;
returnmod;}/*Freeroutemap'scompiled`setmetric'value.*/staticvoidroute_set_metric
_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructroute_map_rul
e_cmdroute_set_metric_cmd={"metric",route_set_metric,route_set_metric_compile,ro
ute_set_metric_free,};/*`setipv6next-hoplocalIP_ADDRESS'*//*Setnexthoptoobject.o
jbectmustbepointertostructattr.*/staticroute_map_result_troute_set_ipv6_nexthop_
local(void*rule,structprefix*prefix,route_map_object_ttype,void*object){structin
6_addr*address;structripng_info*rinfo;if(type==RMAP_RIPNG){/*Fetchroutemap'srule
information.*/address=rule;rinfo=object;/*Setnexthopvalue.*/rinfo->nexthop_out=*
address;}returnRMAP_OKAY;}/*Routemap`ipv6nexthoplocal'compilefunction.Givenstrin
gisconvertedtostructin6_addrstructure.*/staticvoid*route_set_ipv6_nexthop_local_
compile(constchar*arg){intret;structin6_addr*address;address=XMALLOC(MTYPE_ROUTE
_MAP_COMPILED,sizeof(structin6_addr));ret=inet_pton(AF_INET6,arg,address);if(ret
==0){XFREE(MTYPE_ROUTE_MAP_COMPILED,address);returnNULL;}returnaddress;}/*Freero
utemap'scompiled`ipv6nexthoplocal'value.*/staticvoidroute_set_ipv6_nexthop_local
_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routemapcommandsforipv6
nexthoplocalset.*/staticstructroute_map_rule_cmdroute_set_ipv6_nexthop_local_cmd
={"ipv6next-hoplocal",route_set_ipv6_nexthop_local,route_set_ipv6_nexthop_local_
compile,route_set_ipv6_nexthop_local_free};/*`settagTAG'*//*Settagtoobject.ojbec
tmustbepointertostructattr.*/staticroute_map_result_troute_set_tag(void*rule,str
uctprefix*prefix,route_map_object_ttype,void*object){route_tag_t*tag;structripng
_info*rinfo;if(type==RMAP_RIPNG){/*Fetchroutemap'sruleinformation.*/tag=rule;rin
fo=object;/*Setnexthopvalue.*/rinfo->tag_out=*tag;}returnRMAP_OKAY;}/*Routemapco
mmandsfortagset.*/staticstructroute_map_rule_cmdroute_set_tag_cmd={"tag",route_s
et_tag,route_map_rule_tag_compile,route_map_rule_tag_free};#defineMATCH_STR"Matc
hvaluesfromroutingtable\n"#defineSET_STR"Setvaluesindestinationroutingprotocol\n
"voidripng_route_map_reset(){/*XXX???*/;}voidripng_route_map_init(){route_map_in
it();route_map_match_interface_hook(generic_match_add);route_map_no_match_interf
ace_hook(generic_match_delete);route_map_match_metric_hook(generic_match_add);ro
ute_map_no_match_metric_hook(generic_match_delete);route_map_match_tag_hook(gene
ric_match_add);route_map_no_match_tag_hook(generic_match_delete);route_map_set_i
pv6_nexthop_local_hook(generic_set_add);route_map_no_set_ipv6_nexthop_local_hook
(generic_set_delete);route_map_set_metric_hook(generic_set_add);route_map_no_set
_metric_hook(generic_set_delete);route_map_set_tag_hook(generic_set_add);route_m
ap_no_set_tag_hook(generic_set_delete);route_map_install_match(&route_match_metr
ic_cmd);route_map_install_match(&route_match_interface_cmd);route_map_install_ma
tch(&route_match_tag_cmd);route_map_install_set(&route_set_metric_cmd);route_map
_install_set(&route_set_ipv6_nexthop_local_cmd);route_map_install_set(&route_set
_tag_cmd);}