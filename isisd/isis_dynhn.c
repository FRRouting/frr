/**IS-ISRout(e)ingprotocol-isis_dynhn.c*Dynamichostnamecache*Copyright(C)2001,20
02SampoSaaristo*TampereUniversityofTechnology*InstituteofCommunicationsEngineeri
ng**Thisprogramisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsof
theGNUGeneralPublicLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2
oftheLicense,or(atyouroption)*anylaterversion.**Thisprogramisdistributedinthehop
ethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHA
NTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*morede
tails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprog
ram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,
FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"vty.h"#include"link
list.h"#include"memory.h"#include"log.h"#include"stream.h"#include"command.h"#in
clude"if.h"#include"thread.h"#include"isisd/dict.h"#include"isisd/isis_constants
.h"#include"isisd/isis_common.h"#include"isisd/isis_flags.h"#include"isisd/isis_
circuit.h"#include"isisd/isisd.h"#include"isisd/isis_dynhn.h"#include"isisd/isis
_misc.h"#include"isisd/isis_constants.h"externstructhosthost;structlist*dyn_cach
e=NULL;staticintdyn_cache_cleanup(structthread*);voiddyn_cache_init(void){if(dyn
_cache==NULL)dyn_cache=list_new();thread_add_timer(master,dyn_cache_cleanup,NULL
,120,&isis->t_dync_clean);return;}staticintdyn_cache_cleanup(structthread*thread
){structlistnode*node,*nnode;structisis_dynhn*dyn;time_tnow=time(NULL);isis->t_d
ync_clean=NULL;for(ALL_LIST_ELEMENTS(dyn_cache,node,nnode,dyn)){if((now-dyn->ref
resh)<MAX_LSP_LIFETIME)continue;list_delete_node(dyn_cache,node);XFREE(MTYPE_ISI
S_DYNHN,dyn);}thread_add_timer(master,dyn_cache_cleanup,NULL,120,&isis->t_dync_c
lean);returnISIS_OK;}structisis_dynhn*dynhn_find_by_id(constuint8_t*id){structli
stnode*node=NULL;structisis_dynhn*dyn=NULL;for(ALL_LIST_ELEMENTS_RO(dyn_cache,no
de,dyn))if(memcmp(dyn->id,id,ISIS_SYS_ID_LEN)==0)returndyn;returnNULL;}structisi
s_dynhn*dynhn_find_by_name(constchar*hostname){structlistnode*node=NULL;structis
is_dynhn*dyn=NULL;for(ALL_LIST_ELEMENTS_RO(dyn_cache,node,dyn))if(strncmp(dyn->h
ostname,hostname,255)==0)returndyn;returnNULL;}voidisis_dynhn_insert(constuint8_
t*id,constchar*hostname,intlevel){structisis_dynhn*dyn;dyn=dynhn_find_by_id(id);
if(!dyn){dyn=XCALLOC(MTYPE_ISIS_DYNHN,sizeof(structisis_dynhn));memcpy(dyn->id,i
d,ISIS_SYS_ID_LEN);dyn->level=level;listnode_add(dyn_cache,dyn);}snprintf(dyn->h
ostname,sizeof(dyn->hostname),"%s",hostname);dyn->refresh=time(NULL);}voidisis_d
ynhn_remove(constuint8_t*id){structisis_dynhn*dyn;dyn=dynhn_find_by_id(id);if(!d
yn)return;listnode_delete(dyn_cache,dyn);XFREE(MTYPE_ISIS_DYNHN,dyn);}/**LevelSy
stemIDDynamicHostname(notag)*20000.0000.0001foo-gw*20000.0000.0002bar-gw**0000.0
000.0004this-gw*/voiddynhn_print_all(structvty*vty){structlistnode*node;structis
is_dynhn*dyn;vty_out(vty,"LevelSystemIDDynamicHostname\n");for(ALL_LIST_ELEMENTS
_RO(dyn_cache,node,dyn)){vty_out(vty,"%-7d",dyn->level);vty_out(vty,"%-15s%-15s\
n",sysid_print(dyn->id),dyn->hostname);}vty_out(vty,"*%s%s\n",sysid_print(isis->
sysid),cmd_hostname_get());return;}