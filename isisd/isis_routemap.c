/**IS-ISRout(e)ingprotocol-isis_routemap.c**Copyright(C)2013-2015ChristianFranke
<chris@opensourcerouting.org>**Thisprogramisfreesoftware;youcanredistributeitand
/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*Softwa
reFoundation;eitherversion2oftheLicense,or(atyouroption)*anylaterversion.**Thisp
rogramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteve
ntheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGen
eralPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPubl
icLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Fo
undation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#
include"command.h"#include"filter.h"#include"hash.h"#include"if.h"#include"linkl
ist.h"#include"log.h"#include"memory.h"#include"prefix.h"#include"plist.h"#inclu
de"routemap.h"#include"table.h"#include"thread.h"#include"vty.h"#include"isis_co
nstants.h"#include"isis_common.h"#include"isis_flags.h"#include"dict.h"#include"
isisd.h"#include"isis_misc.h"#include"isis_adjacency.h"#include"isis_circuit.h"#
include"isis_pdu.h"#include"isis_lsp.h"#include"isis_spf.h"#include"isis_route.h
"#include"isis_zebra.h"#include"isis_routemap.h"staticroute_map_result_troute_ma
tch_ip_address(void*rule,structprefix*prefix,route_map_object_ttype,void*object)
{structaccess_list*alist;if(type!=RMAP_ISIS)returnRMAP_NOMATCH;alist=access_list
_lookup(AFI_IP,(char*)rule);if(access_list_apply(alist,prefix)!=FILTER_DENY)retu
rnRMAP_MATCH;returnRMAP_NOMATCH;}staticvoid*route_match_ip_address_compile(const
char*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}staticvoidroute_match_ip_
address_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructroute_
map_rule_cmdroute_match_ip_address_cmd={"ipaddress",route_match_ip_address,route
_match_ip_address_compile,route_match_ip_address_free};/*-----------------------
-------------------------------------*/staticroute_map_result_troute_match_ip_ad
dress_prefix_list(void*rule,structprefix*prefix,route_map_object_ttype,void*obje
ct){structprefix_list*plist;if(type!=RMAP_ISIS)returnRMAP_NOMATCH;plist=prefix_l
ist_lookup(AFI_IP,(char*)rule);if(prefix_list_apply(plist,prefix)!=PREFIX_DENY)r
eturnRMAP_MATCH;returnRMAP_NOMATCH;}staticvoid*route_match_ip_address_prefix_lis
t_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}staticvoid
route_match_ip_address_prefix_list_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILE
D,rule);}structroute_map_rule_cmdroute_match_ip_address_prefix_list_cmd={"ipaddr
essprefix-list",route_match_ip_address_prefix_list,route_match_ip_address_prefix
_list_compile,route_match_ip_address_prefix_list_free};/*-----------------------
-------------------------------------*/staticroute_map_result_troute_match_ipv6_
address(void*rule,structprefix*prefix,route_map_object_ttype,void*object){struct
access_list*alist;if(type!=RMAP_ISIS)returnRMAP_NOMATCH;alist=access_list_lookup
(AFI_IP6,(char*)rule);if(access_list_apply(alist,prefix)!=FILTER_DENY)returnRMAP
_MATCH;returnRMAP_NOMATCH;}staticvoid*route_match_ipv6_address_compile(constchar
*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}staticvoidroute_match_ipv6_ad
dress_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructroute_ma
p_rule_cmdroute_match_ipv6_address_cmd={"ipv6address",route_match_ipv6_address,r
oute_match_ipv6_address_compile,route_match_ipv6_address_free};/*---------------
---------------------------------------------*/staticroute_map_result_troute_mat
ch_ipv6_address_prefix_list(void*rule,structprefix*prefix,route_map_object_ttype
,void*object){structprefix_list*plist;if(type!=RMAP_ISIS)returnRMAP_NOMATCH;plis
t=prefix_list_lookup(AFI_IP6,(char*)rule);if(prefix_list_apply(plist,prefix)!=PR
EFIX_DENY)returnRMAP_MATCH;returnRMAP_NOMATCH;}staticvoid*route_match_ipv6_addre
ss_prefix_list_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg
);}staticvoidroute_match_ipv6_address_prefix_list_free(void*rule){XFREE(MTYPE_RO
UTE_MAP_COMPILED,rule);}structroute_map_rule_cmdroute_match_ipv6_address_prefix_
list_cmd={"ipv6addressprefix-list",route_match_ipv6_address_prefix_list,route_ma
tch_ipv6_address_prefix_list_compile,route_match_ipv6_address_prefix_list_free};
/*------------------------------------------------------------*/staticroute_map_
result_troute_set_metric(void*rule,structprefix*prefix,route_map_object_ttype,vo
id*object){uint32_t*metric;structisis_ext_info*info;if(type==RMAP_ISIS){metric=r
ule;info=object;info->metric=*metric;}returnRMAP_OKAY;}staticvoid*route_set_metr
ic_compile(constchar*arg){unsignedlongmetric;char*endp;uint32_t*ret;metric=strto
ul(arg,&endp,10);if(arg[0]=='\0'||*endp!='\0'||metric>MAX_WIDE_PATH_METRIC)retur
nNULL;ret=XCALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(*ret));*ret=metric;returnret;}
staticvoidroute_set_metric_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);
}staticstructroute_map_rule_cmdroute_set_metric_cmd={"metric",route_set_metric,r
oute_set_metric_compile,route_set_metric_free};voidisis_route_map_init(void){rou
te_map_init();route_map_match_ip_address_hook(generic_match_add);route_map_no_ma
tch_ip_address_hook(generic_match_delete);route_map_match_ip_address_prefix_list
_hook(generic_match_add);route_map_no_match_ip_address_prefix_list_hook(generic_
match_delete);route_map_match_ipv6_address_hook(generic_match_add);route_map_no_
match_ipv6_address_hook(generic_match_delete);route_map_match_ipv6_address_prefi
x_list_hook(generic_match_add);route_map_no_match_ipv6_address_prefix_list_hook(
generic_match_delete);route_map_set_metric_hook(generic_set_add);route_map_no_se
t_metric_hook(generic_set_delete);route_map_install_match(&route_match_ip_addres
s_cmd);route_map_install_match(&route_match_ip_address_prefix_list_cmd);route_ma
p_install_match(&route_match_ipv6_address_cmd);route_map_install_match(&route_ma
tch_ipv6_address_prefix_list_cmd);route_map_install_set(&route_set_metric_cmd);}
