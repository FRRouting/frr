/**IS-ISRout(e)ingprotocol-isisd.c**Copyright(C)2001,2002SampoSaaristo*TampereUn
iversityofTechnology*InstituteofCommunicationsEngineering**Thisprogramisfreesoft
ware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicens
easpublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(atyouropt
ion)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,butWI
THOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPA
RTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshouldhaverece
ivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifn
ot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110
-1301USA*/#include<zebra.h>#include"thread.h"#include"vty.h"#include"command.h"#
include"log.h"#include"memory.h"#include"time.h"#include"linklist.h"#include"if.
h"#include"hash.h"#include"stream.h"#include"prefix.h"#include"table.h"#include"
qobj.h"#include"spf_backoff.h"#include"isisd/dict.h"#include"isisd/isis_constant
s.h"#include"isisd/isis_common.h"#include"isisd/isis_flags.h"#include"isisd/isis
_circuit.h"#include"isisd/isis_csm.h"#include"isisd/isisd.h"#include"isisd/isis_
dynhn.h"#include"isisd/isis_adjacency.h"#include"isisd/isis_pdu.h"#include"isisd
/isis_misc.h"#include"isisd/isis_constants.h"#include"isisd/isis_lsp.h"#include"
isisd/isis_spf.h"#include"isisd/isis_route.h"#include"isisd/isis_zebra.h"#includ
e"isisd/isis_events.h"#include"isisd/isis_te.h"#include"isisd/isis_mt.h"structis
is*isis=NULL;DEFINE_QOBJ_TYPE(isis)DEFINE_QOBJ_TYPE(isis_area)/**Prototypes.*/in
tisis_area_get(structvty*,constchar*);intisis_area_destroy(structvty*,constchar*
);intarea_net_title(structvty*,constchar*);intarea_clear_net_title(structvty*,co
nstchar*);intshow_isis_interface_common(structvty*,constchar*ifname,char);intsho
w_isis_neighbor_common(structvty*,constchar*id,char);intclear_isis_neighbor_comm
on(structvty*,constchar*id);intisis_config_write(structvty*);voidisis_new(unsign
edlongprocess_id){isis=XCALLOC(MTYPE_ISIS,sizeof(structisis));/**Defaultvalues*/
isis->max_area_addrs=3;isis->process_id=process_id;isis->router_id=0;isis->area_
list=list_new();isis->init_circ_list=list_new();isis->uptime=time(NULL);isis->ne
xthops=list_new();isis->nexthops6=list_new();dyn_cache_init();/**uncommentthenex
tlineforfulldebugs*//*isis->debugs=0xFFFF;*/isisMplsTE.status=disable;/*Onlysupp
ortTEmetric*/QOBJ_REG(isis,isis);}structisis_area*isis_area_create(constchar*are
a_tag){structisis_area*area;area=XCALLOC(MTYPE_ISIS_AREA,sizeof(structisis_area)
);/**Thefirstinstanceislevel-1-2restarelevel-1,unlessotherwise*configured*/if(li
stcount(isis->area_list)>0)area->is_type=IS_LEVEL_1;elsearea->is_type=IS_LEVEL_1
_AND_2;/**intializethedatabases*/if(area->is_type&IS_LEVEL_1){area->lspdb[0]=lsp
_db_init();area->route_table[0]=route_table_init();area->route_table6[0]=route_t
able_init();}if(area->is_type&IS_LEVEL_2){area->lspdb[1]=lsp_db_init();area->rou
te_table[1]=route_table_init();area->route_table6[1]=route_table_init();}spftree
_area_init(area);area->circuit_list=list_new();area->area_addrs=list_new();threa
d_add_timer(master,lsp_tick,area,1,&area->t_tick);flags_initialize(&area->flags)
;/**Defaultvalues*/area->max_lsp_lifetime[0]=DEFAULT_LSP_LIFETIME;/*1200*/area->
max_lsp_lifetime[1]=DEFAULT_LSP_LIFETIME;/*1200*/area->lsp_refresh[0]=DEFAULT_MA
X_LSP_GEN_INTERVAL;/*900*/area->lsp_refresh[1]=DEFAULT_MAX_LSP_GEN_INTERVAL;/*90
0*/area->lsp_gen_interval[0]=DEFAULT_MIN_LSP_GEN_INTERVAL;area->lsp_gen_interval
[1]=DEFAULT_MIN_LSP_GEN_INTERVAL;area->min_spf_interval[0]=MINIMUM_SPF_INTERVAL;
area->min_spf_interval[1]=MINIMUM_SPF_INTERVAL;area->dynhostname=1;area->oldmetr
ic=0;area->newmetric=1;area->lsp_frag_threshold=90;area->lsp_mtu=DEFAULT_LSP_MTU
;area_mt_init(area);area->area_tag=strdup(area_tag);listnode_add(isis->area_list
,area);area->isis=isis;QOBJ_REG(area,isis_area);returnarea;}structisis_area*isis
_area_lookup(constchar*area_tag){structisis_area*area;structlistnode*node;for(AL
L_LIST_ELEMENTS_RO(isis->area_list,node,area))if((area->area_tag==NULL&&area_tag
==NULL)||(area->area_tag&&area_tag&&strcmp(area->area_tag,area_tag)==0))returnar
ea;returnNULL;}intisis_area_get(structvty*vty,constchar*area_tag){structisis_are
a*area;area=isis_area_lookup(area_tag);if(area){VTY_PUSH_CONTEXT(ISIS_NODE,area)
;returnCMD_SUCCESS;}area=isis_area_create(area_tag);if(isis->debugs&DEBUG_EVENTS
)zlog_debug("NewIS-ISareainstance%s",area->area_tag);VTY_PUSH_CONTEXT(ISIS_NODE,
area);returnCMD_SUCCESS;}intisis_area_destroy(structvty*vty,constchar*area_tag){
structisis_area*area;structlistnode*node,*nnode;structisis_circuit*circuit;struc
tarea_addr*addr;area=isis_area_lookup(area_tag);if(area==NULL){vty_out(vty,"Can'
tfindISISinstance\n");returnCMD_ERR_NO_MATCH;}QOBJ_UNREG(area);if(area->circuit_
list){for(ALL_LIST_ELEMENTS(area->circuit_list,node,nnode,circuit)){circuit->ip_
router=0;circuit->ipv6_router=0;isis_csm_state_change(ISIS_DISABLE,circuit,area)
;}list_delete_and_null(&area->circuit_list);}if(area->lspdb[0]!=NULL){lsp_db_des
troy(area->lspdb[0]);area->lspdb[0]=NULL;}if(area->lspdb[1]!=NULL){lsp_db_destro
y(area->lspdb[1]);area->lspdb[1]=NULL;}spftree_area_del(area);THREAD_TIMER_OFF(a
rea->spf_timer[0]);THREAD_TIMER_OFF(area->spf_timer[1]);spf_backoff_free(area->s
pf_delay_ietf[0]);spf_backoff_free(area->spf_delay_ietf[1]);/*invalidateandvalid
atewoulddeleteallroutesfromzebra*/isis_route_invalidate(area);isis_route_validat
e(area);if(area->route_table[0]){route_table_finish(area->route_table[0]);area->
route_table[0]=NULL;}if(area->route_table[1]){route_table_finish(area->route_tab
le[1]);area->route_table[1]=NULL;}if(area->route_table6[0]){route_table_finish(a
rea->route_table6[0]);area->route_table6[0]=NULL;}if(area->route_table6[1]){rout
e_table_finish(area->route_table6[1]);area->route_table6[1]=NULL;}isis_redist_ar
ea_finish(area);for(ALL_LIST_ELEMENTS(area->area_addrs,node,nnode,addr)){list_de
lete_node(area->area_addrs,node);XFREE(MTYPE_ISIS_AREA_ADDR,addr);}area->area_ad
drs=NULL;THREAD_TIMER_OFF(area->t_tick);THREAD_TIMER_OFF(area->t_lsp_refresh[0])
;THREAD_TIMER_OFF(area->t_lsp_refresh[1]);thread_cancel_event(master,area);listn
ode_delete(isis->area_list,area);free(area->area_tag);area_mt_finish(area);XFREE
(MTYPE_ISIS_AREA,area);if(listcount(isis->area_list)==0){memset(isis->sysid,0,IS
IS_SYS_ID_LEN);isis->sysid_set=0;}returnCMD_SUCCESS;}staticvoidarea_set_mt_enabl
ed(structisis_area*area,uint16_tmtid,boolenabled){structisis_area_mt_setting*set
ting;setting=area_get_mt_setting(area,mtid);if(setting->enabled!=enabled){settin
g->enabled=enabled;lsp_regenerate_schedule(area,IS_LEVEL_1|IS_LEVEL_2,0);}}stati
cvoidarea_set_mt_overload(structisis_area*area,uint16_tmtid,booloverload){struct
isis_area_mt_setting*setting;setting=area_get_mt_setting(area,mtid);if(setting->
overload!=overload){setting->overload=overload;if(setting->enabled)lsp_regenerat
e_schedule(area,IS_LEVEL_1|IS_LEVEL_2,0);}}intarea_net_title(structvty*vty,const
char*net_title){VTY_DECLVAR_CONTEXT(isis_area,area);structarea_addr*addr;structa
rea_addr*addrp;structlistnode*node;uint8_tbuff[255];/*Wecheckthatwearenotoverthe
maximalnumberofaddresses*/if(listcount(area->area_addrs)>=isis->max_area_addrs){
vty_out(vty,"Maximumofareaaddresses(%d)alreadyreached\n",isis->max_area_addrs);r
eturnCMD_ERR_NOTHING_TODO;}addr=XMALLOC(MTYPE_ISIS_AREA_ADDR,sizeof(structarea_a
ddr));addr->addr_len=dotformat2buff(buff,net_title);memcpy(addr->area_addr,buff,
addr->addr_len);#ifdefEXTREME_DEBUGzlog_debug("addedareaaddress%sforarea%s(addre
sslength%d)",net_title,area->area_tag,addr->addr_len);#endif/*EXTREME_DEBUG*/if(
addr->addr_len<8||addr->addr_len>20){vty_out(vty,"areaaddressmustbeatleast8..20o
ctetslong(%d)\n",addr->addr_len);XFREE(MTYPE_ISIS_AREA_ADDR,addr);returnCMD_WARN
ING_CONFIG_FAILED;}if(addr->area_addr[addr->addr_len-1]!=0){vty_out(vty,"nselbyt
e(lastbyte)inareaaddressmustbe0\n");XFREE(MTYPE_ISIS_AREA_ADDR,addr);returnCMD_W
ARNING_CONFIG_FAILED;}if(isis->sysid_set==0){/**Firstareaaddress-gettheSystemIDf
orthisrouter*/memcpy(isis->sysid,GETSYSID(addr),ISIS_SYS_ID_LEN);isis->sysid_set
=1;if(isis->debugs&DEBUG_EVENTS)zlog_debug("RouterhasSystemID%s",sysid_print(isi
s->sysid));}else{/**CheckthattheSystemIDportionsmatch*/if(memcmp(isis->sysid,GET
SYSID(addr),ISIS_SYS_ID_LEN)){vty_out(vty,"SystemIDmustnotchangewhendefiningaddi
tionalareaaddresses\n");XFREE(MTYPE_ISIS_AREA_ADDR,addr);returnCMD_WARNING_CONFI
G_FAILED;}/*nowweseethatwedon'talreadyhavethisaddress*/for(ALL_LIST_ELEMENTS_RO(
area->area_addrs,node,addrp)){if((addrp->addr_len+ISIS_SYS_ID_LEN+ISIS_NSEL_LEN)
!=(addr->addr_len))continue;if(!memcmp(addrp->area_addr,addr->area_addr,addr->ad
dr_len)){XFREE(MTYPE_ISIS_AREA_ADDR,addr);returnCMD_SUCCESS;/*silentfail*/}}}/**
ForgetthesystemIDpartoftheaddress*/addr->addr_len-=(ISIS_SYS_ID_LEN+ISIS_NSEL_LE
N);listnode_add(area->area_addrs,addr);/*onlynowwecansafelygenerateourLSPsforthi
sarea*/if(listcount(area->area_addrs)>0){if(area->is_type&IS_LEVEL_1)lsp_generat
e(area,IS_LEVEL_1);if(area->is_type&IS_LEVEL_2)lsp_generate(area,IS_LEVEL_2);}re
turnCMD_SUCCESS;}intarea_clear_net_title(structvty*vty,constchar*net_title){VTY_
DECLVAR_CONTEXT(isis_area,area);structarea_addraddr,*addrp=NULL;structlistnode*n
ode;uint8_tbuff[255];addr.addr_len=dotformat2buff(buff,net_title);if(addr.addr_l
en<8||addr.addr_len>20){vty_out(vty,"Unsupportedareaaddresslength%d,shouldbe8...
20\n",addr.addr_len);returnCMD_WARNING_CONFIG_FAILED;}memcpy(addr.area_addr,buff
,(int)addr.addr_len);for(ALL_LIST_ELEMENTS_RO(area->area_addrs,node,addrp))if((a
ddrp->addr_len+ISIS_SYS_ID_LEN+1)==addr.addr_len&&!memcmp(addrp->area_addr,addr.
area_addr,addr.addr_len))break;if(!addrp){vty_out(vty,"Noareaaddress%sforarea%s\
n",net_title,area->area_tag);returnCMD_ERR_NO_MATCH;}listnode_delete(area->area_
addrs,addrp);XFREE(MTYPE_ISIS_AREA_ADDR,addrp);/**Lastareaaddress-resettheSystem
IDforthisrouter*/if(listcount(area->area_addrs)==0){memset(isis->sysid,0,ISIS_SY
S_ID_LEN);isis->sysid_set=0;if(isis->debugs&DEBUG_EVENTS)zlog_debug("Routerhasno
SystemID");}returnCMD_SUCCESS;}/**'showisisinterface'command*/intshow_isis_inter
face_common(structvty*vty,constchar*ifname,chardetail){structlistnode*anode,*cno
de;structisis_area*area;structisis_circuit*circuit;if(!isis){vty_out(vty,"IS-ISR
outingProcessnotenabled\n");returnCMD_SUCCESS;}for(ALL_LIST_ELEMENTS_RO(isis->ar
ea_list,anode,area)){vty_out(vty,"Area%s:\n",area->area_tag);if(detail==ISIS_UI_
LEVEL_BRIEF)vty_out(vty,"InterfaceCircIdStateTypeLevel\n");for(ALL_LIST_ELEMENTS
_RO(area->circuit_list,cnode,circuit))if(!ifname)isis_circuit_print_vty(circuit,
vty,detail);elseif(strcmp(circuit->interface->name,ifname)==0)isis_circuit_print
_vty(circuit,vty,detail);}returnCMD_SUCCESS;}DEFUN(show_isis_interface,show_isis
_interface_cmd,"showisisinterface",SHOW_STR"ISISnetworkinformation\n""ISISinterf
ace\n"){returnshow_isis_interface_common(vty,NULL,ISIS_UI_LEVEL_BRIEF);}DEFUN(sh
ow_isis_interface_detail,show_isis_interface_detail_cmd,"showisisinterfacedetail
",SHOW_STR"ISISnetworkinformation\n""ISISinterface\n""showdetailedinformation\n"
){returnshow_isis_interface_common(vty,NULL,ISIS_UI_LEVEL_DETAIL);}DEFUN(show_is
is_interface_arg,show_isis_interface_arg_cmd,"showisisinterfaceWORD",SHOW_STR"IS
ISnetworkinformation\n""ISISinterface\n""ISISinterfacename\n"){intidx_word=3;ret
urnshow_isis_interface_common(vty,argv[idx_word]->arg,ISIS_UI_LEVEL_DETAIL);}/**
'showisisneighbor'command*/intshow_isis_neighbor_common(structvty*vty,constchar*
id,chardetail){structlistnode*anode,*cnode,*node;structisis_area*area;structisis
_circuit*circuit;structlist*adjdb;structisis_adjacency*adj;structisis_dynhn*dynh
n;uint8_tsysid[ISIS_SYS_ID_LEN];inti;if(!isis){vty_out(vty,"IS-ISRoutingProcessn
otenabled\n");returnCMD_SUCCESS;}memset(sysid,0,ISIS_SYS_ID_LEN);if(id){if(sysid
2buff(sysid,id)==0){dynhn=dynhn_find_by_name(id);if(dynhn==NULL){vty_out(vty,"In
validsystemid%s\n",id);returnCMD_SUCCESS;}memcpy(sysid,dynhn->id,ISIS_SYS_ID_LEN
);}}for(ALL_LIST_ELEMENTS_RO(isis->area_list,anode,area)){vty_out(vty,"Area%s:\n
",area->area_tag);if(detail==ISIS_UI_LEVEL_BRIEF)vty_out(vty,"SystemIdInterfaceL
StateHoldtimeSNPA\n");for(ALL_LIST_ELEMENTS_RO(area->circuit_list,cnode,circuit)
){if(circuit->circ_type==CIRCUIT_T_BROADCAST){for(i=0;i<2;i++){adjdb=circuit->u.
bc.adjdb[i];if(adjdb&&adjdb->count){for(ALL_LIST_ELEMENTS_RO(adjdb,node,adj))if(
!id||!memcmp(adj->sysid,sysid,ISIS_SYS_ID_LEN))isis_adj_print_vty(adj,vty,detail
);}}}elseif(circuit->circ_type==CIRCUIT_T_P2P&&circuit->u.p2p.neighbor){adj=circ
uit->u.p2p.neighbor;if(!id||!memcmp(adj->sysid,sysid,ISIS_SYS_ID_LEN))isis_adj_p
rint_vty(adj,vty,detail);}}}returnCMD_SUCCESS;}/**'clearisisneighbor'command*/in
tclear_isis_neighbor_common(structvty*vty,constchar*id){structlistnode*anode,*cn
ode,*cnextnode,*node,*nnode;structisis_area*area;structisis_circuit*circuit;stru
ctlist*adjdb;structisis_adjacency*adj;structisis_dynhn*dynhn;uint8_tsysid[ISIS_S
YS_ID_LEN];inti;if(!isis){vty_out(vty,"IS-ISRoutingProcessnotenabled\n");returnC
MD_SUCCESS;}memset(sysid,0,ISIS_SYS_ID_LEN);if(id){if(sysid2buff(sysid,id)==0){d
ynhn=dynhn_find_by_name(id);if(dynhn==NULL){vty_out(vty,"Invalidsystemid%s\n",id
);returnCMD_SUCCESS;}memcpy(sysid,dynhn->id,ISIS_SYS_ID_LEN);}}for(ALL_LIST_ELEM
ENTS_RO(isis->area_list,anode,area)){for(ALL_LIST_ELEMENTS(area->circuit_list,cn
ode,cnextnode,circuit)){if(circuit->circ_type==CIRCUIT_T_BROADCAST){for(i=0;i<2;
i++){adjdb=circuit->u.bc.adjdb[i];if(adjdb&&adjdb->count){for(ALL_LIST_ELEMENTS(
adjdb,node,nnode,adj))if(!id||!memcmp(adj->sysid,sysid,ISIS_SYS_ID_LEN))isis_adj
_state_change(adj,ISIS_ADJ_DOWN,"clearuserrequest");}}}elseif(circuit->circ_type
==CIRCUIT_T_P2P&&circuit->u.p2p.neighbor){adj=circuit->u.p2p.neighbor;if(!id||!m
emcmp(adj->sysid,sysid,ISIS_SYS_ID_LEN))isis_adj_state_change(adj,ISIS_ADJ_DOWN,
"clearuserrequest");}}}returnCMD_SUCCESS;}DEFUN(show_isis_neighbor,show_isis_nei
ghbor_cmd,"showisisneighbor",SHOW_STR"ISISnetworkinformation\n""ISISneighboradja
cencies\n"){returnshow_isis_neighbor_common(vty,NULL,ISIS_UI_LEVEL_BRIEF);}DEFUN
(show_isis_neighbor_detail,show_isis_neighbor_detail_cmd,"showisisneighbordetail
",SHOW_STR"ISISnetworkinformation\n""ISISneighboradjacencies\n""showdetailedinfo
rmation\n"){returnshow_isis_neighbor_common(vty,NULL,ISIS_UI_LEVEL_DETAIL);}DEFU
N(show_isis_neighbor_arg,show_isis_neighbor_arg_cmd,"showisisneighborWORD",SHOW_
STR"ISISnetworkinformation\n""ISISneighboradjacencies\n""Systemid\n"){intidx_wor
d=3;returnshow_isis_neighbor_common(vty,argv[idx_word]->arg,ISIS_UI_LEVEL_DETAIL
);}DEFUN(clear_isis_neighbor,clear_isis_neighbor_cmd,"clearisisneighbor",CLEAR_S
TR"ResetISISnetworkinformation\n""ResetISISneighboradjacencies\n"){returnclear_i
sis_neighbor_common(vty,NULL);}DEFUN(clear_isis_neighbor_arg,clear_isis_neighbor
_arg_cmd,"clearisisneighborWORD",CLEAR_STR"ISISnetworkinformation\n""ISISneighbo
radjacencies\n""Systemid\n"){intidx_word=3;returnclear_isis_neighbor_common(vty,
argv[idx_word]->arg);}/**'isisdebug','showdebugging'*/voidprint_debug(structvty*
vty,intflags,intonoff){charonoffs[4];if(onoff)strcpy(onoffs,"on");elsestrcpy(ono
ffs,"off");if(flags&DEBUG_ADJ_PACKETS)vty_out(vty,"IS-ISAdjacencyrelatedpacketsd
ebuggingis%s\n",onoffs);if(flags&DEBUG_CHECKSUM_ERRORS)vty_out(vty,"IS-ISchecksu
merrorsdebuggingis%s\n",onoffs);if(flags&DEBUG_LOCAL_UPDATES)vty_out(vty,"IS-ISl
ocalupdatesdebuggingis%s\n",onoffs);if(flags&DEBUG_PROTOCOL_ERRORS)vty_out(vty,"
IS-ISprotocolerrorsdebuggingis%s\n",onoffs);if(flags&DEBUG_SNP_PACKETS)vty_out(v
ty,"IS-ISCSNP/PSNPpacketsdebuggingis%s\n",onoffs);if(flags&DEBUG_SPF_EVENTS)vty_
out(vty,"IS-ISSPFeventsdebuggingis%s\n",onoffs);if(flags&DEBUG_SPF_STATS)vty_out
(vty,"IS-ISSPFTimingandStatisticsDatadebuggingis%s\n",onoffs);if(flags&DEBUG_SPF
_TRIGGERS)vty_out(vty,"IS-ISSPFtriggeringeventsdebuggingis%s\n",onoffs);if(flags
&DEBUG_UPDATE_PACKETS)vty_out(vty,"IS-ISUpdaterelatedpacketdebuggingis%s\n",onof
fs);if(flags&DEBUG_RTE_EVENTS)vty_out(vty,"IS-ISRouterelateddebugginis%s\n",onof
fs);if(flags&DEBUG_EVENTS)vty_out(vty,"IS-ISEventdebuggingis%s\n",onoffs);if(fla
gs&DEBUG_PACKET_DUMP)vty_out(vty,"IS-ISPacketdumpdebuggingis%s\n",onoffs);if(fla
gs&DEBUG_LSP_GEN)vty_out(vty,"IS-ISLSPgenerationdebuggingis%s\n",onoffs);if(flag
s&DEBUG_LSP_SCHED)vty_out(vty,"IS-ISLSPschedulingdebuggingis%s\n",onoffs);}DEFUN
_NOSH(show_debugging,show_debugging_isis_cmd,"showdebugging[isis]",SHOW_STR"Stat
eofeachdebuggingoption\n"ISIS_STR){vty_out(vty,"IS-ISdebuggingstatus:\n");if(isi
s->debugs)print_debug(vty,isis->debugs,1);returnCMD_SUCCESS;}/*Debugnode.*/stati
cstructcmd_nodedebug_node={DEBUG_NODE,"",1};staticintconfig_write_debug(structvt
y*vty){intwrite=0;intflags=isis->debugs;if(flags&DEBUG_ADJ_PACKETS){vty_out(vty,
"debugisisadj-packets\n");write++;}if(flags&DEBUG_CHECKSUM_ERRORS){vty_out(vty,"
debugisischecksum-errors\n");write++;}if(flags&DEBUG_LOCAL_UPDATES){vty_out(vty,
"debugisislocal-updates\n");write++;}if(flags&DEBUG_PROTOCOL_ERRORS){vty_out(vty
,"debugisisprotocol-errors\n");write++;}if(flags&DEBUG_SNP_PACKETS){vty_out(vty,
"debugisissnp-packets\n");write++;}if(flags&DEBUG_SPF_EVENTS){vty_out(vty,"debug
isisspf-events\n");write++;}if(flags&DEBUG_SPF_STATS){vty_out(vty,"debugisisspf-
statistics\n");write++;}if(flags&DEBUG_SPF_TRIGGERS){vty_out(vty,"debugisisspf-t
riggers\n");write++;}if(flags&DEBUG_UPDATE_PACKETS){vty_out(vty,"debugisisupdate
-packets\n");write++;}if(flags&DEBUG_RTE_EVENTS){vty_out(vty,"debugisisroute-eve
nts\n");write++;}if(flags&DEBUG_EVENTS){vty_out(vty,"debugisisevents\n");write++
;}if(flags&DEBUG_PACKET_DUMP){vty_out(vty,"debugisispacket-dump\n");write++;}if(
flags&DEBUG_LSP_GEN){vty_out(vty,"debugisislsp-gen\n");write++;}if(flags&DEBUG_L
SP_SCHED){vty_out(vty,"debugisislsp-sched\n");write++;}write+=spf_backoff_write_
config(vty);returnwrite;}DEFUN(debug_isis_adj,debug_isis_adj_cmd,"debugisisadj-p
ackets",DEBUG_STR"IS-ISinformation\n""IS-ISAdjacencyrelatedpackets\n"){isis->deb
ugs|=DEBUG_ADJ_PACKETS;print_debug(vty,DEBUG_ADJ_PACKETS,1);returnCMD_SUCCESS;}D
EFUN(no_debug_isis_adj,no_debug_isis_adj_cmd,"nodebugisisadj-packets",NO_STRUNDE
BUG_STR"IS-ISinformation\n""IS-ISAdjacencyrelatedpackets\n"){isis->debugs&=~DEBU
G_ADJ_PACKETS;print_debug(vty,DEBUG_ADJ_PACKETS,0);returnCMD_SUCCESS;}DEFUN(debu
g_isis_csum,debug_isis_csum_cmd,"debugisischecksum-errors",DEBUG_STR"IS-ISinform
ation\n""IS-ISLSPchecksumerrors\n"){isis->debugs|=DEBUG_CHECKSUM_ERRORS;print_de
bug(vty,DEBUG_CHECKSUM_ERRORS,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_csum,no_
debug_isis_csum_cmd,"nodebugisischecksum-errors",NO_STRUNDEBUG_STR"IS-ISinformat
ion\n""IS-ISLSPchecksumerrors\n"){isis->debugs&=~DEBUG_CHECKSUM_ERRORS;print_deb
ug(vty,DEBUG_CHECKSUM_ERRORS,0);returnCMD_SUCCESS;}DEFUN(debug_isis_lupd,debug_i
sis_lupd_cmd,"debugisislocal-updates",DEBUG_STR"IS-ISinformation\n""IS-ISlocalup
datepackets\n"){isis->debugs|=DEBUG_LOCAL_UPDATES;print_debug(vty,DEBUG_LOCAL_UP
DATES,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_lupd,no_debug_isis_lupd_cmd,"nod
ebugisislocal-updates",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-ISlocalupdatepac
kets\n"){isis->debugs&=~DEBUG_LOCAL_UPDATES;print_debug(vty,DEBUG_LOCAL_UPDATES,
0);returnCMD_SUCCESS;}DEFUN(debug_isis_err,debug_isis_err_cmd,"debugisisprotocol
-errors",DEBUG_STR"IS-ISinformation\n""IS-ISLSPprotocolerrors\n"){isis->debugs|=
DEBUG_PROTOCOL_ERRORS;print_debug(vty,DEBUG_PROTOCOL_ERRORS,1);returnCMD_SUCCESS
;}DEFUN(no_debug_isis_err,no_debug_isis_err_cmd,"nodebugisisprotocol-errors",NO_
STRUNDEBUG_STR"IS-ISinformation\n""IS-ISLSPprotocolerrors\n"){isis->debugs&=~DEB
UG_PROTOCOL_ERRORS;print_debug(vty,DEBUG_PROTOCOL_ERRORS,0);returnCMD_SUCCESS;}D
EFUN(debug_isis_snp,debug_isis_snp_cmd,"debugisissnp-packets",DEBUG_STR"IS-ISinf
ormation\n""IS-ISCSNP/PSNPpackets\n"){isis->debugs|=DEBUG_SNP_PACKETS;print_debu
g(vty,DEBUG_SNP_PACKETS,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_snp,no_debug_i
sis_snp_cmd,"nodebugisissnp-packets",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-IS
CSNP/PSNPpackets\n"){isis->debugs&=~DEBUG_SNP_PACKETS;print_debug(vty,DEBUG_SNP_
PACKETS,0);returnCMD_SUCCESS;}DEFUN(debug_isis_upd,debug_isis_upd_cmd,"debugisis
update-packets",DEBUG_STR"IS-ISinformation\n""IS-ISUpdaterelatedpackets\n"){isis
->debugs|=DEBUG_UPDATE_PACKETS;print_debug(vty,DEBUG_UPDATE_PACKETS,1);returnCMD
_SUCCESS;}DEFUN(no_debug_isis_upd,no_debug_isis_upd_cmd,"nodebugisisupdate-packe
ts",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-ISUpdaterelatedpackets\n"){isis->de
bugs&=~DEBUG_UPDATE_PACKETS;print_debug(vty,DEBUG_UPDATE_PACKETS,0);returnCMD_SU
CCESS;}DEFUN(debug_isis_spfevents,debug_isis_spfevents_cmd,"debugisisspf-events"
,DEBUG_STR"IS-ISinformation\n""IS-ISShortestPathFirstEvents\n"){isis->debugs|=DE
BUG_SPF_EVENTS;print_debug(vty,DEBUG_SPF_EVENTS,1);returnCMD_SUCCESS;}DEFUN(no_d
ebug_isis_spfevents,no_debug_isis_spfevents_cmd,"nodebugisisspf-events",NO_STRUN
DEBUG_STR"IS-ISinformation\n""IS-ISShortestPathFirstEvents\n"){isis->debugs&=~DE
BUG_SPF_EVENTS;print_debug(vty,DEBUG_SPF_EVENTS,0);returnCMD_SUCCESS;}DEFUN(debu
g_isis_spfstats,debug_isis_spfstats_cmd,"debugisisspf-statistics",DEBUG_STR"IS-I
Sinformation\n""IS-ISSPFTimingandStatisticData\n"){isis->debugs|=DEBUG_SPF_STATS
;print_debug(vty,DEBUG_SPF_STATS,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_spfst
ats,no_debug_isis_spfstats_cmd,"nodebugisisspf-statistics",NO_STRUNDEBUG_STR"IS-
ISinformation\n""IS-ISSPFTimingandStatisticData\n"){isis->debugs&=~DEBUG_SPF_STA
TS;print_debug(vty,DEBUG_SPF_STATS,0);returnCMD_SUCCESS;}DEFUN(debug_isis_spftri
gg,debug_isis_spftrigg_cmd,"debugisisspf-triggers",DEBUG_STR"IS-ISinformation\n"
"IS-ISSPFtriggeringevents\n"){isis->debugs|=DEBUG_SPF_TRIGGERS;print_debug(vty,D
EBUG_SPF_TRIGGERS,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_spftrigg,no_debug_is
is_spftrigg_cmd,"nodebugisisspf-triggers",NO_STRUNDEBUG_STR"IS-ISinformation\n""
IS-ISSPFtriggeringevents\n"){isis->debugs&=~DEBUG_SPF_TRIGGERS;print_debug(vty,D
EBUG_SPF_TRIGGERS,0);returnCMD_SUCCESS;}DEFUN(debug_isis_rtevents,debug_isis_rte
vents_cmd,"debugisisroute-events",DEBUG_STR"IS-ISinformation\n""IS-ISRouterelate
devents\n"){isis->debugs|=DEBUG_RTE_EVENTS;print_debug(vty,DEBUG_RTE_EVENTS,1);r
eturnCMD_SUCCESS;}DEFUN(no_debug_isis_rtevents,no_debug_isis_rtevents_cmd,"nodeb
ugisisroute-events",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-ISRouterelatedevent
s\n"){isis->debugs&=~DEBUG_RTE_EVENTS;print_debug(vty,DEBUG_RTE_EVENTS,0);return
CMD_SUCCESS;}DEFUN(debug_isis_events,debug_isis_events_cmd,"debugisisevents",DEB
UG_STR"IS-ISinformation\n""IS-ISEvents\n"){isis->debugs|=DEBUG_EVENTS;print_debu
g(vty,DEBUG_EVENTS,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_events,no_debug_isi
s_events_cmd,"nodebugisisevents",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-ISEven
ts\n"){isis->debugs&=~DEBUG_EVENTS;print_debug(vty,DEBUG_EVENTS,0);returnCMD_SUC
CESS;}DEFUN(debug_isis_packet_dump,debug_isis_packet_dump_cmd,"debugisispacket-d
ump",DEBUG_STR"IS-ISinformation\n""IS-ISpacketdump\n"){isis->debugs|=DEBUG_PACKE
T_DUMP;print_debug(vty,DEBUG_PACKET_DUMP,1);returnCMD_SUCCESS;}DEFUN(no_debug_is
is_packet_dump,no_debug_isis_packet_dump_cmd,"nodebugisispacket-dump",NO_STRUNDE
BUG_STR"IS-ISinformation\n""IS-ISpacketdump\n"){isis->debugs&=~DEBUG_PACKET_DUMP
;print_debug(vty,DEBUG_PACKET_DUMP,0);returnCMD_SUCCESS;}DEFUN(debug_isis_lsp_ge
n,debug_isis_lsp_gen_cmd,"debugisislsp-gen",DEBUG_STR"IS-ISinformation\n""IS-ISg
enerationofownLSPs\n"){isis->debugs|=DEBUG_LSP_GEN;print_debug(vty,DEBUG_LSP_GEN
,1);returnCMD_SUCCESS;}DEFUN(no_debug_isis_lsp_gen,no_debug_isis_lsp_gen_cmd,"no
debugisislsp-gen",NO_STRUNDEBUG_STR"IS-ISinformation\n""IS-ISgenerationofownLSPs
\n"){isis->debugs&=~DEBUG_LSP_GEN;print_debug(vty,DEBUG_LSP_GEN,0);returnCMD_SUC
CESS;}DEFUN(debug_isis_lsp_sched,debug_isis_lsp_sched_cmd,"debugisislsp-sched",D
EBUG_STR"IS-ISinformation\n""IS-ISschedulingofLSPgeneration\n"){isis->debugs|=DE
BUG_LSP_SCHED;print_debug(vty,DEBUG_LSP_SCHED,1);returnCMD_SUCCESS;}DEFUN(no_deb
ug_isis_lsp_sched,no_debug_isis_lsp_sched_cmd,"nodebugisislsp-sched",NO_STRUNDEB
UG_STR"IS-ISinformation\n""IS-ISschedulingofLSPgeneration\n"){isis->debugs&=~DEB
UG_LSP_SCHED;print_debug(vty,DEBUG_LSP_SCHED,0);returnCMD_SUCCESS;}DEFUN(show_ho
stname,show_hostname_cmd,"showisishostname",SHOW_STR"IS-ISinformation\n""IS-ISDy
namichostnamemapping\n"){dynhn_print_all(vty);returnCMD_SUCCESS;}DEFUN(show_isis
_spf_ietf,show_isis_spf_ietf_cmd,"showisisspf-delay-ietf",SHOW_STR"IS-ISinformat
ion\n""IS-ISSPFdelayIETFinformation\n"){if(!isis){vty_out(vty,"ISISisnotrunning\
n");returnCMD_SUCCESS;}structlistnode*node;structisis_area*area;for(ALL_LIST_ELE
MENTS_RO(isis->area_list,node,area)){vty_out(vty,"Area%s:\n",area->area_tag?area
->area_tag:"null");for(intlevel=ISIS_LEVEL1;level<=ISIS_LEVELS;level++){if((area
->is_type&level)==0)continue;vty_out(vty,"Level-%d:\n",level);vty_out(vty,"SPFde
laystatus:");if(area->spf_timer[level-1]){structtimevalremain=thread_timer_remai
n(area->spf_timer[level-1]);vty_out(vty,"Pending,duein%lldmsec\n",(longlong)rema
in.tv_sec*1000+remain.tv_usec/1000);}else{vty_out(vty,"Notscheduled\n");}if(area
->spf_delay_ietf[level-1]){vty_out(vty,"Usingdraft-ietf-rtgwg-backoff-algo-04\n"
);spf_backoff_show(area->spf_delay_ietf[level-1],vty,"");}else{vty_out(vty,"Usin
glegacybackoffalgo\n");}}}returnCMD_SUCCESS;}DEFUN(show_isis_summary,show_isis_s
ummary_cmd,"showisissummary",SHOW_STR"IS-ISinformation\n""IS-ISsummary\n"){struc
tlistnode*node,*node2;structisis_area*area;intlevel;if(isis==NULL){vty_out(vty,"
ISISisnotrunning\n");returnCMD_SUCCESS;}vty_out(vty,"ProcessId:%ld\n",isis->proc
ess_id);if(isis->sysid_set)vty_out(vty,"SystemId:%s\n",sysid_print(isis->sysid))
;vty_out(vty,"Uptime:");vty_out_timestr(vty,isis->uptime);vty_out(vty,"\n");if(i
sis->area_list)vty_out(vty,"Numberofareas:%d\n",isis->area_list->count);for(ALL_
LIST_ELEMENTS_RO(isis->area_list,node,area)){vty_out(vty,"Area%s:\n",area->area_
tag?area->area_tag:"null");if(listcount(area->area_addrs)>0){structarea_addr*are
a_addr;for(ALL_LIST_ELEMENTS_RO(area->area_addrs,node2,area_addr)){vty_out(vty,"
Net:%s\n",isonet_print(area_addr->area_addr,area_addr->addr_len+ISIS_SYS_ID_LEN+
1));}}for(level=ISIS_LEVEL1;level<=ISIS_LEVELS;level++){if((area->is_type&level)
==0)continue;vty_out(vty,"Level-%d:\n",level);if(area->spf_timer[level-1])vty_ou
t(vty,"SPF:(pending)\n");elsevty_out(vty,"SPF:\n");vty_out(vty,"minimuminterval:
%d",area->min_spf_interval[level-1]);if(area->spf_delay_ietf[level-1])vty_out(vt
y,"(notused,IETFSPFdelayactivated)");vty_out(vty,"\n");vty_out(vty,"IPv4routecom
putation:\n");isis_spf_print(area->spftree[level-1],vty);vty_out(vty,"IPv6routec
omputation:\n");isis_spf_print(area->spftree6[level-1],vty);}}vty_out(vty,"\n");
returnCMD_SUCCESS;}/**Thisfunctionsupportsfollowingdisplayoptions:*[showisisdata
base[detail]]*[showisisdatabase<sysid>[detail]]*[showisisdatabase<hostname>[deta
il]]*[showisisdatabase<sysid>.<pseudo-id>[detail]]*[showisisdatabase<hostname>.<
pseudo-id>[detail]]*[showisisdatabase<sysid>.<pseudo-id>-<fragment-number>[detai
l]]*[showisisdatabase<hostname>.<pseudo-id>-<fragment-number>[detail]]*[showisis
databasedetail<sysid>]*[showisisdatabasedetail<hostname>]*[showisisdatabasedetai
l<sysid>.<pseudo-id>]*[showisisdatabasedetail<hostname>.<pseudo-id>]*[showisisda
tabasedetail<sysid>.<pseudo-id>-<fragment-number>]*[showisisdatabasedetail<hostn
ame>.<pseudo-id>-<fragment-number>]*/staticintshow_isis_database(structvty*vty,c
onstchar*argv,intui_level){structlistnode*node;structisis_area*area;structisis_l
sp*lsp;structisis_dynhn*dynhn;constchar*pos=argv;uint8_tlspid[ISIS_SYS_ID_LEN+2]
;charsysid[255];uint8_tnumber[3];intlevel,lsp_count;if(isis->area_list->count==0
)returnCMD_SUCCESS;memset(&lspid,0,ISIS_SYS_ID_LEN);memset(&sysid,0,255);/**extr
actfragmentandpseudoidfromthestringargv*intheforms:*(a)<systemid/hostname>.<pseu
do-id>-<framenent>or*(b)<systemid/hostname>.<pseudo-id>or*(c)<systemid/hostname>
or*Wheresystemidisintheform:*xxxx.xxxx.xxxx*/if(argv)strncpy(sysid,argv,254);if(
argv&&strlen(argv)>3){pos=argv+strlen(argv)-3;if(strncmp(pos,"-",1)==0){memcpy(n
umber,++pos,2);lspid[ISIS_SYS_ID_LEN+1]=(uint8_t)strtol((char*)number,NULL,16);p
os-=4;if(strncmp(pos,".",1)!=0)returnCMD_WARNING;}if(strncmp(pos,".",1)==0){memc
py(number,++pos,2);lspid[ISIS_SYS_ID_LEN]=(uint8_t)strtol((char*)number,NULL,16)
;sysid[pos-argv-1]='\0';}}for(ALL_LIST_ELEMENTS_RO(isis->area_list,node,area)){v
ty_out(vty,"Area%s:\n",area->area_tag?area->area_tag:"null");for(level=0;level<I
SIS_LEVELS;level++){if(area->lspdb[level]&&dict_count(area->lspdb[level])>0){lsp
=NULL;if(argv!=NULL){/**Trytofindthelsp-idiftheargv*stringisin*theform*hostname.
<pseudo-id>-<fragment>*/if(sysid2buff(lspid,sysid)){lsp=lsp_search(lspid,area->l
spdb[level]);}elseif((dynhn=dynhn_find_by_name(sysid))){memcpy(lspid,dynhn->id,I
SIS_SYS_ID_LEN);lsp=lsp_search(lspid,area->lspdb[level]);}elseif(strncmp(cmd_hos
tname_get(),sysid,15)==0){memcpy(lspid,isis->sysid,ISIS_SYS_ID_LEN);lsp=lsp_sear
ch(lspid,area->lspdb[level]);}}if(lsp!=NULL||argv==NULL){vty_out(vty,"IS-ISLevel
-%dlink-statedatabase:\n",level+1);/*printthetitleinallcases*/vty_out(vty,"LSPID
PduLenSeqNumberChksumHoldtimeATT/P/OL\n");}if(lsp){if(ui_level==ISIS_UI_LEVEL_DE
TAIL)lsp_print_detail(lsp,vty,area->dynhostname);elselsp_print(lsp,vty,area->dyn
hostname);}elseif(argv==NULL){lsp_count=lsp_print_all(vty,area->lspdb[level],ui_
level,area->dynhostname);vty_out(vty,"%uLSPs\n\n",lsp_count);}}}}returnCMD_SUCCE
SS;}DEFUN(show_database,show_database_cmd,"showisisdatabase[detail][WORD]",SHOW_
STR"IS-ISinformation\n""IS-ISlinkstatedatabase\n""Detailedinformation\n""LSPID\n
"){intidx=0;intuilevel=argv_find(argv,argc,"detail",&idx)?ISIS_UI_LEVEL_DETAIL:I
SIS_UI_LEVEL_BRIEF;char*id=argv_find(argv,argc,"WORD",&idx)?argv[idx]->arg:NULL;
returnshow_isis_database(vty,id,uilevel);}/**'routerisis'command*/DEFUN_NOSH(rou
ter_isis,router_isis_cmd,"routerisisWORD",ROUTER_STR"ISOIS-IS\n""ISORoutingareat
ag\n"){intidx_word=2;returnisis_area_get(vty,argv[idx_word]->arg);}/**'norouteri
sis'command*/DEFUN(no_router_isis,no_router_isis_cmd,"norouterisisWORD","no\n"RO
UTER_STR"ISOIS-IS\n""ISORoutingareatag\n"){intidx_word=3;returnisis_area_destroy
(vty,argv[idx_word]->arg);}/**'net'command*/DEFUN(net,net_cmd,"netWORD","ANetwor
kEntityTitleforthisprocess(OSIonly)\n""XX.XXXX.....XXX.XXNetworkentitytitle(NET)
\n"){intidx_word=1;returnarea_net_title(vty,argv[idx_word]->arg);}/**'nonet'comm
and*/DEFUN(no_net,no_net_cmd,"nonetWORD",NO_STR"ANetworkEntityTitleforthisproces
s(OSIonly)\n""XX.XXXX.....XXX.XXNetworkentitytitle(NET)\n"){intidx_word=2;return
area_clear_net_title(vty,argv[idx_word]->arg);}DEFUN(isis_topology,isis_topology
_cmd,"topology"ISIS_MT_NAMES"[overload]","ConfigureIS-IStopologies\n"ISIS_MT_DES
CRIPTIONS"Setoverloadbitfortopology\n"){VTY_DECLVAR_CONTEXT(isis_area,area);cons
tchar*arg=argv[1]->arg;uint16_tmtid=isis_str2mtid(arg);if(area->oldmetric){vty_o
ut(vty,"MultitopologyIS-IScanonlybeusedwithwidemetrics\n");returnCMD_WARNING_CON
FIG_FAILED;}if(mtid==(uint16_t)-1){vty_out(vty,"Don'tknowtopology'%s'\n",arg);re
turnCMD_WARNING_CONFIG_FAILED;}if(mtid==ISIS_MT_IPV4_UNICAST){vty_out(vty,"Canno
tconfigureIPv4unicasttopology\n");returnCMD_WARNING_CONFIG_FAILED;}area_set_mt_e
nabled(area,mtid,true);area_set_mt_overload(area,mtid,(argc==3));returnCMD_SUCCE
SS;}DEFUN(no_isis_topology,no_isis_topology_cmd,"notopology"ISIS_MT_NAMES"[overl
oad]",NO_STR"ConfigureIS-IStopologies\n"ISIS_MT_DESCRIPTIONS"Setoverloadbitforto
pology\n"){VTY_DECLVAR_CONTEXT(isis_area,area);constchar*arg=argv[2]->arg;uint16
_tmtid=isis_str2mtid(arg);if(area->oldmetric){vty_out(vty,"MultitopologyIS-IScan
onlybeusedwithwidemetrics\n");returnCMD_WARNING_CONFIG_FAILED;}if(mtid==(uint16_
t)-1){vty_out(vty,"Don'tknowtopology'%s'\n",arg);returnCMD_WARNING_CONFIG_FAILED
;}if(mtid==ISIS_MT_IPV4_UNICAST){vty_out(vty,"CannotconfigureIPv4unicasttopology
\n");returnCMD_WARNING_CONFIG_FAILED;}area_set_mt_enabled(area,mtid,false);area_
set_mt_overload(area,mtid,false);returnCMD_SUCCESS;}voidisis_area_lsp_mtu_set(st
ructisis_area*area,unsignedintlsp_mtu){area->lsp_mtu=lsp_mtu;lsp_regenerate_sche
dule(area,IS_LEVEL_1_AND_2,1);}staticintisis_area_passwd_set(structisis_area*are
a,intlevel,uint8_tpasswd_type,constchar*passwd,uint8_tsnp_auth){structisis_passw
d*dest;structisis_passwdmodified;intlen;assert((level==IS_LEVEL_1)||(level==IS_L
EVEL_2));dest=(level==IS_LEVEL_1)?&area->area_passwd:&area->domain_passwd;memset
(&modified,0,sizeof(modified));if(passwd_type!=ISIS_PASSWD_TYPE_UNUSED){if(!pass
wd)return-1;len=strlen(passwd);if(len>254)return-1;modified.len=len;strncpy((cha
r*)modified.passwd,passwd,255);modified.type=passwd_type;modified.snp_auth=snp_a
uth;}if(memcmp(&modified,dest,sizeof(modified))){memcpy(dest,&modified,sizeof(mo
dified));lsp_regenerate_schedule(area,IS_LEVEL_1|IS_LEVEL_2,1);}return0;}intisis
_area_passwd_unset(structisis_area*area,intlevel){returnisis_area_passwd_set(are
a,level,ISIS_PASSWD_TYPE_UNUSED,NULL,0);}intisis_area_passwd_cleartext_set(struc
tisis_area*area,intlevel,constchar*passwd,uint8_tsnp_auth){returnisis_area_passw
d_set(area,level,ISIS_PASSWD_TYPE_CLEARTXT,passwd,snp_auth);}intisis_area_passwd
_hmac_md5_set(structisis_area*area,intlevel,constchar*passwd,uint8_tsnp_auth){re
turnisis_area_passwd_set(area,level,ISIS_PASSWD_TYPE_HMAC_MD5,passwd,snp_auth);}
staticvoidarea_resign_level(structisis_area*area,intlevel){if(area->lspdb[level-
1]){lsp_db_destroy(area->lspdb[level-1]);area->lspdb[level-1]=NULL;}if(area->spf
tree[level-1]){isis_spftree_del(area->spftree[level-1]);area->spftree[level-1]=N
ULL;}if(area->spftree6[level-1]){isis_spftree_del(area->spftree6[level-1]);area-
>spftree6[level-1]=NULL;}THREAD_TIMER_OFF(area->spf_timer[level-1]);if(area->rou
te_table[level-1]){route_table_finish(area->route_table[level-1]);area->route_ta
ble[level-1]=NULL;}if(area->route_table6[level-1]){route_table_finish(area->rout
e_table6[level-1]);area->route_table6[level-1]=NULL;}sched_debug("ISIS(%s):Resig
nedfromL%d-cancelingLSPregenerationtimer.",area->area_tag,level);THREAD_TIMER_OF
F(area->t_lsp_refresh[level-1]);area->lsp_regenerate_pending[level-1]=0;}voidisi
s_area_is_type_set(structisis_area*area,intis_type){structlistnode*node;structis
is_circuit*circuit;if(isis->debugs&DEBUG_EVENTS)zlog_debug("ISIS-Evt(%s)systemty
pechange%s->%s",area->area_tag,circuit_t2string(area->is_type),circuit_t2string(
is_type));if(area->is_type==is_type)return;/*Nochange*/switch(area->is_type){cas
eIS_LEVEL_1:if(is_type==IS_LEVEL_2)area_resign_level(area,IS_LEVEL_1);if(area->l
spdb[1]==NULL)area->lspdb[1]=lsp_db_init();if(area->route_table[1]==NULL)area->r
oute_table[1]=route_table_init();if(area->route_table6[1]==NULL)area->route_tabl
e6[1]=route_table_init();break;caseIS_LEVEL_1_AND_2:if(is_type==IS_LEVEL_1)area_
resign_level(area,IS_LEVEL_2);elsearea_resign_level(area,IS_LEVEL_1);break;caseI
S_LEVEL_2:if(is_type==IS_LEVEL_1)area_resign_level(area,IS_LEVEL_2);if(area->lsp
db[0]==NULL)area->lspdb[0]=lsp_db_init();if(area->route_table[0]==NULL)area->rou
te_table[0]=route_table_init();if(area->route_table6[0]==NULL)area->route_table6
[0]=route_table_init();break;default:break;}area->is_type=is_type;/*overridecirc
uit'sis_type*/if(area->is_type!=IS_LEVEL_1_AND_2){for(ALL_LIST_ELEMENTS_RO(area-
>circuit_list,node,circuit))isis_circuit_is_type_set(circuit,is_type);}spftree_a
rea_init(area);if(listcount(area->area_addrs)>0){if(is_type&IS_LEVEL_1)lsp_gener
ate(area,IS_LEVEL_1);if(is_type&IS_LEVEL_2)lsp_generate(area,IS_LEVEL_2);}lsp_re
generate_schedule(area,IS_LEVEL_1|IS_LEVEL_2,1);return;}voidisis_area_metricstyl
e_set(structisis_area*area,boolold_metric,boolnew_metric){if(area->oldmetric!=ol
d_metric||area->newmetric!=new_metric){area->oldmetric=old_metric;area->newmetri
c=new_metric;lsp_regenerate_schedule(area,IS_LEVEL_1|IS_LEVEL_2,1);}}voidisis_ar
ea_overload_bit_set(structisis_area*area,booloverload_bit){charnew_overload_bit=
overload_bit?LSPBIT_OL:0;if(new_overload_bit!=area->overload_bit){area->overload
_bit=new_overload_bit;lsp_regenerate_schedule(area,IS_LEVEL_1|IS_LEVEL_2,1);}}vo
idisis_area_attached_bit_set(structisis_area*area,boolattached_bit){charnew_atta
ched_bit=attached_bit?LSPBIT_ATT:0;if(new_attached_bit!=area->attached_bit){area
->attached_bit=new_attached_bit;lsp_regenerate_schedule(area,IS_LEVEL_1|IS_LEVEL
_2,1);}}voidisis_area_dynhostname_set(structisis_area*area,booldynhostname){if(a
rea->dynhostname!=dynhostname){area->dynhostname=dynhostname;lsp_regenerate_sche
dule(area,IS_LEVEL_1|IS_LEVEL_2,0);}}voidisis_area_max_lsp_lifetime_set(structis
is_area*area,intlevel,uint16_tmax_lsp_lifetime){assert((level==IS_LEVEL_1)||(lev
el==IS_LEVEL_2));if(area->max_lsp_lifetime[level-1]==max_lsp_lifetime)return;are
a->max_lsp_lifetime[level-1]=max_lsp_lifetime;lsp_regenerate_schedule(area,level
,1);}voidisis_area_lsp_refresh_set(structisis_area*area,intlevel,uint16_tlsp_ref
resh){assert((level==IS_LEVEL_1)||(level==IS_LEVEL_2));if(area->lsp_refresh[leve
l-1]==lsp_refresh)return;area->lsp_refresh[level-1]=lsp_refresh;lsp_regenerate_s
chedule(area,level,1);}DEFUN(log_adj_changes,log_adj_changes_cmd,"log-adjacency-
changes","Logchangesinadjacencystate\n"){VTY_DECLVAR_CONTEXT(isis_area,area);are
a->log_adj_changes=1;returnCMD_SUCCESS;}DEFUN(no_log_adj_changes,no_log_adj_chan
ges_cmd,"nolog-adjacency-changes",NO_STR"Stoploggingchangesinadjacencystate\n"){
VTY_DECLVAR_CONTEXT(isis_area,area);area->log_adj_changes=0;returnCMD_SUCCESS;}/
*IS-ISconfigurationwritefunction*/intisis_config_write(structvty*vty){intwrite=0
;if(isis!=NULL){structisis_area*area;structlistnode*node,*node2;for(ALL_LIST_ELE
MENTS_RO(isis->area_list,node,area)){/*ISIS-Areaname*/vty_out(vty,"routerisis%s\
n",area->area_tag);write++;/*ISIS-Net*/if(listcount(area->area_addrs)>0){structa
rea_addr*area_addr;for(ALL_LIST_ELEMENTS_RO(area->area_addrs,node2,area_addr)){v
ty_out(vty,"net%s\n",isonet_print(area_addr->area_addr,area_addr->addr_len+ISIS_
SYS_ID_LEN+1));write++;}}/*ISIS-Dynamichostname-Defaultstotruesoonly*displayif*f
alse.*/if(!area->dynhostname){vty_out(vty,"nohostnamedynamic\n");write++;}/*ISIS
-Metric-Style-whentruedisplayswide*/if(area->newmetric){if(!area->oldmetric)vty_
out(vty,"metric-stylewide\n");elsevty_out(vty,"metric-styletransition\n");write+
+;}else{vty_out(vty,"metric-stylenarrow\n");write++;}/*ISIS-overload-bit*/if(are
a->overload_bit){vty_out(vty,"set-overload-bit\n");write++;}/*ISIS-Areais-type(l
evel-1-2isdefault)*/if(area->is_type==IS_LEVEL_1){vty_out(vty,"is-typelevel-1\n"
);write++;}elseif(area->is_type==IS_LEVEL_2){vty_out(vty,"is-typelevel-2-only\n"
);write++;}write+=isis_redist_config_write(vty,area,AF_INET);write+=isis_redist_
config_write(vty,area,AF_INET6);/*ISIS-Lspgenerationinterval*/if(area->lsp_gen_i
nterval[0]==area->lsp_gen_interval[1]){if(area->lsp_gen_interval[0]!=DEFAULT_MIN
_LSP_GEN_INTERVAL){vty_out(vty,"lsp-gen-interval%d\n",area->lsp_gen_interval[0])
;write++;}}else{if(area->lsp_gen_interval[0]!=DEFAULT_MIN_LSP_GEN_INTERVAL){vty_
out(vty,"lsp-gen-intervallevel-1%d\n",area->lsp_gen_interval[0]);write++;}if(are
a->lsp_gen_interval[1]!=DEFAULT_MIN_LSP_GEN_INTERVAL){vty_out(vty,"lsp-gen-inter
vallevel-2%d\n",area->lsp_gen_interval[1]);write++;}}/*ISIS-LSPlifetime*/if(area
->max_lsp_lifetime[0]==area->max_lsp_lifetime[1]){if(area->max_lsp_lifetime[0]!=
DEFAULT_LSP_LIFETIME){vty_out(vty,"max-lsp-lifetime%u\n",area->max_lsp_lifetime[
0]);write++;}}else{if(area->max_lsp_lifetime[0]!=DEFAULT_LSP_LIFETIME){vty_out(v
ty,"max-lsp-lifetimelevel-1%u\n",area->max_lsp_lifetime[0]);write++;}if(area->ma
x_lsp_lifetime[1]!=DEFAULT_LSP_LIFETIME){vty_out(vty,"max-lsp-lifetimelevel-2%u\
n",area->max_lsp_lifetime[1]);write++;}}/*ISIS-LSPrefreshinterval*/if(area->lsp_
refresh[0]==area->lsp_refresh[1]){if(area->lsp_refresh[0]!=DEFAULT_MAX_LSP_GEN_I
NTERVAL){vty_out(vty,"lsp-refresh-interval%u\n",area->lsp_refresh[0]);write++;}}
else{if(area->lsp_refresh[0]!=DEFAULT_MAX_LSP_GEN_INTERVAL){vty_out(vty,"lsp-ref
resh-intervallevel-1%u\n",area->lsp_refresh[0]);write++;}if(area->lsp_refresh[1]
!=DEFAULT_MAX_LSP_GEN_INTERVAL){vty_out(vty,"lsp-refresh-intervallevel-2%u\n",ar
ea->lsp_refresh[1]);write++;}}if(area->lsp_mtu!=DEFAULT_LSP_MTU){vty_out(vty,"ls
p-mtu%u\n",area->lsp_mtu);write++;}/*MinimumSPFinterval.*/if(area->min_spf_inter
val[0]==area->min_spf_interval[1]){if(area->min_spf_interval[0]!=MINIMUM_SPF_INT
ERVAL){vty_out(vty,"spf-interval%d\n",area->min_spf_interval[0]);write++;}}else{
if(area->min_spf_interval[0]!=MINIMUM_SPF_INTERVAL){vty_out(vty,"spf-intervallev
el-1%d\n",area->min_spf_interval[0]);write++;}if(area->min_spf_interval[1]!=MINI
MUM_SPF_INTERVAL){vty_out(vty,"spf-intervallevel-2%d\n",area->min_spf_interval[1
]);write++;}}/*IETFSPFinterval*/if(area->spf_delay_ietf[0]){vty_out(vty,"spf-del
ay-ietfinit-delay%ldshort-delay%ldlong-delay%ldholddown%ldtime-to-learn%ld\n",sp
f_backoff_init_delay(area->spf_delay_ietf[0]),spf_backoff_short_delay(area->spf_
delay_ietf[0]),spf_backoff_long_delay(area->spf_delay_ietf[0]),spf_backoff_holdd
own(area->spf_delay_ietf[0]),spf_backoff_timetolearn(area->spf_delay_ietf[0]));w
rite++;}/*Authenticationpasswords.*/if(area->area_passwd.type==ISIS_PASSWD_TYPE_
HMAC_MD5){vty_out(vty,"area-passwordmd5%s",area->area_passwd.passwd);if(CHECK_FL
AG(area->area_passwd.snp_auth,SNP_AUTH_SEND)){vty_out(vty,"authenticatesnp");if(
CHECK_FLAG(area->area_passwd.snp_auth,SNP_AUTH_RECV))vty_out(vty,"validate");els
evty_out(vty,"send-only");}vty_out(vty,"\n");write++;}elseif(area->area_passwd.t
ype==ISIS_PASSWD_TYPE_CLEARTXT){vty_out(vty,"area-passwordclear%s",area->area_pa
sswd.passwd);if(CHECK_FLAG(area->area_passwd.snp_auth,SNP_AUTH_SEND)){vty_out(vt
y,"authenticatesnp");if(CHECK_FLAG(area->area_passwd.snp_auth,SNP_AUTH_RECV))vty
_out(vty,"validate");elsevty_out(vty,"send-only");}vty_out(vty,"\n");write++;}if
(area->domain_passwd.type==ISIS_PASSWD_TYPE_HMAC_MD5){vty_out(vty,"domain-passwo
rdmd5%s",area->domain_passwd.passwd);if(CHECK_FLAG(area->domain_passwd.snp_auth,
SNP_AUTH_SEND)){vty_out(vty,"authenticatesnp");if(CHECK_FLAG(area->domain_passwd
.snp_auth,SNP_AUTH_RECV))vty_out(vty,"validate");elsevty_out(vty,"send-only");}v
ty_out(vty,"\n");write++;}elseif(area->domain_passwd.type==ISIS_PASSWD_TYPE_CLEA
RTXT){vty_out(vty,"domain-passwordclear%s",area->domain_passwd.passwd);if(CHECK_
FLAG(area->domain_passwd.snp_auth,SNP_AUTH_SEND)){vty_out(vty,"authenticatesnp")
;if(CHECK_FLAG(area->domain_passwd.snp_auth,SNP_AUTH_RECV))vty_out(vty,"validate
");elsevty_out(vty,"send-only");}vty_out(vty,"\n");write++;}if(area->log_adj_cha
nges){vty_out(vty,"log-adjacency-changes\n");write++;}write+=area_write_mt_setti
ngs(area,vty);}isis_mpls_te_config_write_router(vty);}returnwrite;}structcmd_nod
eisis_node={ISIS_NODE,"%s(config-router)#",1};voidisis_init(){/*InstallIS-IStopn
ode*/install_node(&isis_node,isis_config_write);install_element(VIEW_NODE,&show_
isis_summary_cmd);install_element(VIEW_NODE,&show_isis_spf_ietf_cmd);install_ele
ment(VIEW_NODE,&show_isis_interface_cmd);install_element(VIEW_NODE,&show_isis_in
terface_detail_cmd);install_element(VIEW_NODE,&show_isis_interface_arg_cmd);inst
all_element(VIEW_NODE,&show_isis_neighbor_cmd);install_element(VIEW_NODE,&show_i
sis_neighbor_detail_cmd);install_element(VIEW_NODE,&show_isis_neighbor_arg_cmd);
install_element(VIEW_NODE,&clear_isis_neighbor_cmd);install_element(VIEW_NODE,&c
lear_isis_neighbor_arg_cmd);install_element(VIEW_NODE,&show_hostname_cmd);instal
l_element(VIEW_NODE,&show_database_cmd);install_element(ENABLE_NODE,&show_debugg
ing_isis_cmd);install_node(&debug_node,config_write_debug);install_element(ENABL
E_NODE,&debug_isis_adj_cmd);install_element(ENABLE_NODE,&no_debug_isis_adj_cmd);
install_element(ENABLE_NODE,&debug_isis_csum_cmd);install_element(ENABLE_NODE,&n
o_debug_isis_csum_cmd);install_element(ENABLE_NODE,&debug_isis_lupd_cmd);install
_element(ENABLE_NODE,&no_debug_isis_lupd_cmd);install_element(ENABLE_NODE,&debug
_isis_err_cmd);install_element(ENABLE_NODE,&no_debug_isis_err_cmd);install_eleme
nt(ENABLE_NODE,&debug_isis_snp_cmd);install_element(ENABLE_NODE,&no_debug_isis_s
np_cmd);install_element(ENABLE_NODE,&debug_isis_upd_cmd);install_element(ENABLE_
NODE,&no_debug_isis_upd_cmd);install_element(ENABLE_NODE,&debug_isis_spfevents_c
md);install_element(ENABLE_NODE,&no_debug_isis_spfevents_cmd);install_element(EN
ABLE_NODE,&debug_isis_spfstats_cmd);install_element(ENABLE_NODE,&no_debug_isis_s
pfstats_cmd);install_element(ENABLE_NODE,&debug_isis_spftrigg_cmd);install_eleme
nt(ENABLE_NODE,&no_debug_isis_spftrigg_cmd);install_element(ENABLE_NODE,&debug_i
sis_rtevents_cmd);install_element(ENABLE_NODE,&no_debug_isis_rtevents_cmd);insta
ll_element(ENABLE_NODE,&debug_isis_events_cmd);install_element(ENABLE_NODE,&no_d
ebug_isis_events_cmd);install_element(ENABLE_NODE,&debug_isis_packet_dump_cmd);i
nstall_element(ENABLE_NODE,&no_debug_isis_packet_dump_cmd);install_element(ENABL
E_NODE,&debug_isis_lsp_gen_cmd);install_element(ENABLE_NODE,&no_debug_isis_lsp_g
en_cmd);install_element(ENABLE_NODE,&debug_isis_lsp_sched_cmd);install_element(E
NABLE_NODE,&no_debug_isis_lsp_sched_cmd);install_element(CONFIG_NODE,&debug_isis
_adj_cmd);install_element(CONFIG_NODE,&no_debug_isis_adj_cmd);install_element(CO
NFIG_NODE,&debug_isis_csum_cmd);install_element(CONFIG_NODE,&no_debug_isis_csum_
cmd);install_element(CONFIG_NODE,&debug_isis_lupd_cmd);install_element(CONFIG_NO
DE,&no_debug_isis_lupd_cmd);install_element(CONFIG_NODE,&debug_isis_err_cmd);ins
tall_element(CONFIG_NODE,&no_debug_isis_err_cmd);install_element(CONFIG_NODE,&de
bug_isis_snp_cmd);install_element(CONFIG_NODE,&no_debug_isis_snp_cmd);install_el
ement(CONFIG_NODE,&debug_isis_upd_cmd);install_element(CONFIG_NODE,&no_debug_isi
s_upd_cmd);install_element(CONFIG_NODE,&debug_isis_spfevents_cmd);install_elemen
t(CONFIG_NODE,&no_debug_isis_spfevents_cmd);install_element(CONFIG_NODE,&debug_i
sis_spfstats_cmd);install_element(CONFIG_NODE,&no_debug_isis_spfstats_cmd);insta
ll_element(CONFIG_NODE,&debug_isis_spftrigg_cmd);install_element(CONFIG_NODE,&no
_debug_isis_spftrigg_cmd);install_element(CONFIG_NODE,&debug_isis_rtevents_cmd);
install_element(CONFIG_NODE,&no_debug_isis_rtevents_cmd);install_element(CONFIG_
NODE,&debug_isis_events_cmd);install_element(CONFIG_NODE,&no_debug_isis_events_c
md);install_element(CONFIG_NODE,&debug_isis_packet_dump_cmd);install_element(CON
FIG_NODE,&no_debug_isis_packet_dump_cmd);install_element(CONFIG_NODE,&debug_isis
_lsp_gen_cmd);install_element(CONFIG_NODE,&no_debug_isis_lsp_gen_cmd);install_el
ement(CONFIG_NODE,&debug_isis_lsp_sched_cmd);install_element(CONFIG_NODE,&no_deb
ug_isis_lsp_sched_cmd);install_element(CONFIG_NODE,&router_isis_cmd);install_ele
ment(CONFIG_NODE,&no_router_isis_cmd);install_default(ISIS_NODE);install_element
(ISIS_NODE,&net_cmd);install_element(ISIS_NODE,&no_net_cmd);install_element(ISIS
_NODE,&isis_topology_cmd);install_element(ISIS_NODE,&no_isis_topology_cmd);insta
ll_element(ISIS_NODE,&log_adj_changes_cmd);install_element(ISIS_NODE,&no_log_adj
_changes_cmd);spf_backoff_cmd_init();}