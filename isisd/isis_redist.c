/**IS-ISRout(e)ingprotocol-isis_redist.c**Copyright(C)2013-2015ChristianFranke<c
hris@opensourcerouting.org>**Thisprogramisfreesoftware;youcanredistributeitand/o
rmodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*Software
Foundation;eitherversion2oftheLicense,or(atyouroption)*anylaterversion.**Thispro
gramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withoutevent
heimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGener
alPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublic
Licensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foun
dation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#in
clude"command.h"#include"if.h"#include"linklist.h"#include"memory.h"#include"isi
s_memory.h"#include"prefix.h"#include"routemap.h"#include"stream.h"#include"tabl
e.h"#include"vty.h"#include"isisd/dict.h"#include"isisd/isis_constants.h"#includ
e"isisd/isis_common.h"#include"isisd/isis_flags.h"#include"isisd/isis_misc.h"#in
clude"isisd/isis_circuit.h"#include"isisd/isisd.h"#include"isisd/isis_lsp.h"#inc
lude"isisd/isis_route.h"#include"isisd/isis_zebra.h"staticintredist_protocol(int
family){if(family==AF_INET)return0;if(family==AF_INET6)return1;assert(!"Unsuppor
tedaddressfamily!");return0;}staticafi_tafi_for_redist_protocol(intprotocol){if(
protocol==0)returnAFI_IP;if(protocol==1)returnAFI_IP6;assert(!"Unknownredistprot
ocol!");returnAFI_IP;}staticstructroute_table*get_ext_info(structisis*i,intfamil
y){intprotocol=redist_protocol(family);returni->ext_info[protocol];}staticstruct
isis_redist*get_redist_settings(structisis_area*area,intfamily,inttype,intlevel)
{intprotocol=redist_protocol(family);return&area->redist_settings[protocol][type
][level-1];}structroute_table*get_ext_reach(structisis_area*area,intfamily,intle
vel){intprotocol=redist_protocol(family);returnarea->ext_reach[protocol][level-1
];}staticstructroute_node*isis_redist_route_node_create(route_table_delegate_t*d
elegate,structroute_table*table){structroute_node*node;node=XCALLOC(MTYPE_ISIS_E
XT_ROUTE,sizeof(*node));returnnode;}staticvoidisis_redist_route_node_destroy(rou
te_table_delegate_t*delegate,structroute_table*table,structroute_node*node){if(n
ode->info)XFREE(MTYPE_ISIS_EXT_INFO,node->info);XFREE(MTYPE_ISIS_EXT_ROUTE,node)
;}staticroute_table_delegate_tisis_redist_rt_delegate={.create_node=isis_redist_
route_node_create,.destroy_node=isis_redist_route_node_destroy};/*Installexterna
lreachabilityinformationintoa*specificareaforaspecificlevel.*Scheduleanlspregene
rateifnecessary*/staticvoidisis_redist_install(structisis_area*area,intlevel,str
uctprefix*p,structisis_ext_info*info){intfamily=p->family;structroute_table*er_t
able=get_ext_reach(area,family,level);structroute_node*er_node;if(!er_table){zlo
g_warn("%s:Externalreachabilitytableofarea%s""isnotinitialized.",__func__,area->
area_tag);return;}er_node=route_node_get(er_table,p);if(er_node->info){route_unl
ock_node(er_node);/*Don'tupdate/reschedulelspgenerationifnothingchanged.*/if(!me
mcmp(er_node->info,info,sizeof(*info)))return;}else{er_node->info=XMALLOC(MTYPE_
ISIS_EXT_INFO,sizeof(*info));}memcpy(er_node->info,info,sizeof(*info));lsp_regen
erate_schedule(area,level,0);}/*Removeexternalreachabilityinformationfroma*speci
ficareaforaspecificlevel.*Scheduleanlspregenerateifnecessary.*/staticvoidisis_re
dist_uninstall(structisis_area*area,intlevel,structprefix*p){intfamily=p->family
;structroute_table*er_table=get_ext_reach(area,family,level);structroute_node*er
_node;if(!er_table){zlog_warn("%s:Externalreachabilitytableofarea%s""isnotinitia
lized.",__func__,area->area_tag);return;}er_node=route_node_lookup(er_table,p);i
f(!er_node)return;elseroute_unlock_node(er_node);if(!er_node->info)return;XFREE(
MTYPE_ISIS_EXT_INFO,er_node->info);route_unlock_node(er_node);lsp_regenerate_sch
edule(area,level,0);}/*Updateexternalreachabilityinfoofareaforagivenlevel*andpre
fix,usingthegivenredistributionsettings.*/staticvoidisis_redist_update_ext_reach
(structisis_area*area,intlevel,structisis_redist*redist,structprefix*p,structisi
s_ext_info*info){structisis_ext_infoarea_info;route_map_result_tmap_ret;memcpy(&
area_info,info,sizeof(area_info));if(redist->metric!=0xffffffff)area_info.metric
=redist->metric;if(redist->map_name){map_ret=route_map_apply(redist->map,p,RMAP_
ISIS,&area_info);if(map_ret==RMAP_DENYMATCH)area_info.distance=255;}/*Allowsynth
esizeddefaultroutesonlyonalwaysorignate*/if(area_info.origin==DEFAULT_ROUTE&&red
ist->redist!=DEFAULT_ORIGINATE_ALWAYS)area_info.distance=255;if(area_info.distan
ce<255)isis_redist_install(area,level,p,&area_info);elseisis_redist_uninstall(ar
ea,level,p);}staticvoidisis_redist_ensure_default(structisis*isis,intfamily){str
uctprefixp;structroute_table*ei_table=get_ext_info(isis,family);structroute_node
*ei_node;structisis_ext_info*info;if(family==AF_INET){p.family=AF_INET;p.prefixl
en=0;memset(&p.u.prefix4,0,sizeof(p.u.prefix4));}elseif(family==AF_INET6){p.fami
ly=AF_INET6;p.prefixlen=0;memset(&p.u.prefix6,0,sizeof(p.u.prefix6));}elseassert
(!"Unknownfamily!");ei_node=route_node_get(ei_table,&p);if(ei_node->info){route_
unlock_node(ei_node);return;}ei_node->info=XCALLOC(MTYPE_ISIS_EXT_INFO,sizeof(st
ructisis_ext_info));info=ei_node->info;info->origin=DEFAULT_ROUTE;info->distance
=254;info->metric=MAX_WIDE_PATH_METRIC;}/*Handlenotificationaboutroutebeingadded
*/voidisis_redist_add(inttype,structprefix*p,uint8_tdistance,uint32_tmetric){int
family=p->family;structroute_table*ei_table=get_ext_info(isis,family);structrout
e_node*ei_node;structisis_ext_info*info;structlistnode*node;structisis_area*area
;intlevel;structisis_redist*redist;chardebug_buf[BUFSIZ];prefix2str(p,debug_buf,
sizeof(debug_buf));zlog_debug("%s:Newroute%sfrom%s:distance%d.",__func__,debug_b
uf,zebra_route_string(type),distance);if(!ei_table){zlog_warn("%s:Externalinform
ationtablenotinitialized.",__func__);return;}ei_node=route_node_get(ei_table,p);
if(ei_node->info)route_unlock_node(ei_node);elseei_node->info=XCALLOC(MTYPE_ISIS
_EXT_INFO,sizeof(structisis_ext_info));info=ei_node->info;info->origin=type;info
->distance=distance;info->metric=metric;if(is_default_prefix(p))type=DEFAULT_ROU
TE;for(ALL_LIST_ELEMENTS_RO(isis->area_list,node,area))for(level=1;level<=ISIS_L
EVELS;level++){redist=get_redist_settings(area,family,type,level);if(!redist->re
dist)continue;isis_redist_update_ext_reach(area,level,redist,p,info);}}voidisis_
redist_delete(inttype,structprefix*p){intfamily=p->family;structroute_table*ei_t
able=get_ext_info(isis,family);structroute_node*ei_node;structlistnode*node;stru
ctisis_area*area;intlevel;structisis_redist*redist;chardebug_buf[BUFSIZ];prefix2
str(p,debug_buf,sizeof(debug_buf));zlog_debug("%s:Removingroute%sfrom%s.",__func
__,debug_buf,zebra_route_string(type));if(is_default_prefix(p)){/*Don'tremovedef
aultroutebutaddsyntheticrouteforuse*by"default-informationoriginatealways".Areas
withoutthe*"always"settingwillignorerouteswithorigin*DEFAULT_ROUTE.*/isis_redist
_add(DEFAULT_ROUTE,p,254,MAX_WIDE_PATH_METRIC);return;}if(!ei_table){zlog_warn("
%s:Externalinformationtablenotinitialized.",__func__);return;}ei_node=route_node
_lookup(ei_table,p);if(!ei_node||!ei_node->info){charbuf[BUFSIZ];prefix2str(p,bu
f,sizeof(buf));zlog_warn("%s:Gotadeletefor%sroute%s,butthatroute""wasneveradded.
",__func__,zebra_route_string(type),buf);if(ei_node)route_unlock_node(ei_node);r
eturn;}route_unlock_node(ei_node);for(ALL_LIST_ELEMENTS_RO(isis->area_list,node,
area))for(level=1;level<ISIS_LEVELS;level++){redist=get_redist_settings(area,fam
ily,type,level);if(!redist->redist)continue;isis_redist_uninstall(area,level,p);
}XFREE(MTYPE_ISIS_EXT_INFO,ei_node->info);route_unlock_node(ei_node);}staticvoid
isis_redist_routemap_set(structisis_redist*redist,constchar*routemap){if(redist-
>map_name){XFREE(MTYPE_ISIS,redist->map_name);redist->map=NULL;}if(routemap&&str
len(routemap)){redist->map_name=XSTRDUP(MTYPE_ISIS,routemap);redist->map=route_m
ap_lookup_by_name(routemap);}}staticvoidisis_redist_update_zebra_subscriptions(s
tructisis*isis){structlistnode*node;structisis_area*area;inttype;intlevel;intpro
tocol;chardo_subscribe[REDIST_PROTOCOL_COUNT][ZEBRA_ROUTE_MAX+1];memset(do_subsc
ribe,0,sizeof(do_subscribe));for(ALL_LIST_ELEMENTS_RO(isis->area_list,node,area)
)for(protocol=0;protocol<REDIST_PROTOCOL_COUNT;protocol++)for(type=0;type<ZEBRA_
ROUTE_MAX+1;type++)for(level=0;level<ISIS_LEVELS;level++)if(area->redist_setting
s[protocol][type][level].redist)do_subscribe[protocol][type]=1;for(protocol=0;pr
otocol<REDIST_PROTOCOL_COUNT;protocol++)for(type=0;type<ZEBRA_ROUTE_MAX+1;type++
){/*Thisfieldisactuallycontrollingtransmissionof*theIS-IS*routestoZebraandhasnot
hingtodowith*redistribution,*soskipit.*/if(type==ZEBRA_ROUTE_ISIS)continue;afi_t
afi=afi_for_redist_protocol(protocol);if(do_subscribe[protocol][type])isis_zebra
_redistribute_set(afi,type);elseisis_zebra_redistribute_unset(afi,type);}}static
voidisis_redist_set(structisis_area*area,intlevel,intfamily,inttype,uint32_tmetr
ic,constchar*routemap,intoriginate_type){intprotocol=redist_protocol(family);str
uctisis_redist*redist=get_redist_settings(area,family,type,level);inti;structrou
te_table*ei_table;structroute_node*rn;structisis_ext_info*info;redist->redist=(t
ype==DEFAULT_ROUTE)?originate_type:1;redist->metric=metric;isis_redist_routemap_
set(redist,routemap);if(!area->ext_reach[protocol][level-1]){area->ext_reach[pro
tocol][level-1]=route_table_init_with_delegate(&isis_redist_rt_delegate);}for(i=
0;i<REDIST_PROTOCOL_COUNT;i++)if(!area->isis->ext_info[i]){area->isis->ext_info[
i]=route_table_init_with_delegate(&isis_redist_rt_delegate);}isis_redist_update_
zebra_subscriptions(area->isis);if(type==DEFAULT_ROUTE&&originate_type==DEFAULT_
ORIGINATE_ALWAYS)isis_redist_ensure_default(area->isis,family);ei_table=get_ext_
info(area->isis,family);for(rn=route_top(ei_table);rn;rn=route_next(rn)){if(!rn-
>info)continue;info=rn->info;if(type==DEFAULT_ROUTE){if(!is_default_prefix(&rn->
p))continue;}else{if(info->origin!=type)continue;}isis_redist_update_ext_reach(a
rea,level,redist,&rn->p,info);}}staticvoidisis_redist_unset(structisis_area*area
,intlevel,intfamily,inttype){structisis_redist*redist=get_redist_settings(area,f
amily,type,level);structroute_table*er_table=get_ext_reach(area,family,level);st
ructroute_node*rn;structisis_ext_info*info;if(!redist->redist)return;redist->red
ist=0;if(!er_table){zlog_warn("%s:Externalreachabilitytableuninitialized.",__fun
c__);return;}for(rn=route_top(er_table);rn;rn=route_next(rn)){if(!rn->info)conti
nue;info=rn->info;if(type==DEFAULT_ROUTE){if(!is_default_prefix(&rn->p))continue
;}else{if(info->origin!=type)continue;}XFREE(MTYPE_ISIS_EXT_INFO,rn->info);route
_unlock_node(rn);}lsp_regenerate_schedule(area,level,0);isis_redist_update_zebra
_subscriptions(area->isis);}voidisis_redist_area_finish(structisis_area*area){in
tprotocol;intlevel;inttype;for(protocol=0;protocol<REDIST_PROTOCOL_COUNT;protoco
l++)for(level=0;level<ISIS_LEVELS;level++){for(type=0;type<ZEBRA_ROUTE_MAX+1;typ
e++){structisis_redist*redist;redist=&area->redist_settings[protocol][type][leve
l];redist->redist=0;if(redist->map_name)XFREE(MTYPE_ISIS,redist->map_name);}rout
e_table_finish(area->ext_reach[protocol][level]);}isis_redist_update_zebra_subsc
riptions(area->isis);}DEFUN(isis_redistribute,isis_redistribute_cmd,"redistribut
e<ipv4|ipv6>"FRR_REDIST_STR_ISISD"<level-1|level-2>[<metric(0-16777215)|route-ma
pWORD>]",REDIST_STR"RedistributeIPv4routes\n""RedistributeIPv6routes\n"FRR_REDIS
T_HELP_STR_ISISD"Redistributeintolevel-1\n""Redistributeintolevel-2\n""Metricfor
redistributedroutes\n""ISISdefaultmetric\n""Routemapreference\n""Pointertoroute-
mapentries\n"){intidx_afi=1;intidx_protocol=2;intidx_level=3;intidx_metric_rmap=
4;VTY_DECLVAR_CONTEXT(isis_area,area);intfamily;intafi;inttype;intlevel;unsigned
longmetric;constchar*routemap=NULL;family=str2family(argv[idx_afi]->text);if(fam
ily<0)returnCMD_WARNING_CONFIG_FAILED;afi=family2afi(family);if(!afi)returnCMD_W
ARNING_CONFIG_FAILED;type=proto_redistnum(afi,argv[idx_protocol]->text);if(type<
0)returnCMD_WARNING_CONFIG_FAILED;if(!strcmp("level-1",argv[idx_level]->arg))lev
el=1;elseif(!strcmp("level-2",argv[idx_level]->arg))level=2;elsereturnCMD_WARNIN
G_CONFIG_FAILED;if((area->is_type&level)!=level){vty_out(vty,"Nodeisnotalevel-%d
IS\n",level);returnCMD_WARNING_CONFIG_FAILED;}metric=0xffffffff;routemap=NULL;if
(argc>idx_metric_rmap+1){if(argv[idx_metric_rmap+1]->arg[0]=='\0')returnCMD_WARN
ING_CONFIG_FAILED;if(strmatch(argv[idx_metric_rmap]->text,"metric")){char*endp;m
etric=strtoul(argv[idx_metric_rmap+1]->arg,&endp,10);if(*endp!='\0')returnCMD_WA
RNING_CONFIG_FAILED;}else{routemap=argv[idx_metric_rmap+1]->arg;}}isis_redist_se
t(area,level,family,type,metric,routemap,0);return0;}DEFUN(no_isis_redistribute,
no_isis_redistribute_cmd,"noredistribute<ipv4|ipv6>"FRR_REDIST_STR_ISISD"<level-
1|level-2>",NO_STRREDIST_STR"RedistributeIPv4routes\n""RedistributeIPv6routes\n"
FRR_REDIST_HELP_STR_ISISD"Redistributeintolevel-1\n""Redistributeintolevel-2\n")
{intidx_afi=2;intidx_protocol=3;intidx_level=4;VTY_DECLVAR_CONTEXT(isis_area,are
a);inttype;intlevel;intfamily;intafi;family=str2family(argv[idx_afi]->arg);if(fa
mily<0)returnCMD_WARNING_CONFIG_FAILED;afi=family2afi(family);if(!afi)returnCMD_
WARNING_CONFIG_FAILED;type=proto_redistnum(afi,argv[idx_protocol]->text);if(type
<0)returnCMD_WARNING_CONFIG_FAILED;level=strmatch("level-1",argv[idx_level]->tex
t)?1:2;isis_redist_unset(area,level,family,type);return0;}DEFUN(isis_default_ori
ginate,isis_default_originate_cmd,"default-informationoriginate<ipv4|ipv6><level
-1|level-2>[always][<metric(0-16777215)|route-mapWORD>]","Controldistributionofd
efaultinformation\n""Distributeadefaultroute\n""DistributedefaultrouteforIPv4\n"
"DistributedefaultrouteforIPv6\n""Distributedefaultrouteintolevel-1\n""Distribut
edefaultrouteintolevel-2\n""Alwaysadvertisedefaultroute\n""Metricfordefaultroute
\n""ISISdefaultmetric\n""Routemapreference\n""Pointertoroute-mapentries\n"){inti
dx_afi=2;intidx_level=3;intidx_always=4;intidx_metric_rmap=4;VTY_DECLVAR_CONTEXT
(isis_area,area);intfamily;intoriginate_type=DEFAULT_ORIGINATE;intlevel;unsigned
longmetric=0xffffffff;constchar*routemap=NULL;family=str2family(argv[idx_afi]->t
ext);if(family<0)returnCMD_WARNING_CONFIG_FAILED;level=strmatch("level-1",argv[i
dx_level]->text)?1:2;if((area->is_type&level)!=level){vty_out(vty,"Nodeisnotalev
el-%dIS\n",level);returnCMD_WARNING_CONFIG_FAILED;}if(argc>idx_always&&strmatch(
argv[idx_always]->text,"always")){originate_type=DEFAULT_ORIGINATE_ALWAYS;idx_me
tric_rmap++;}if(argc>idx_metric_rmap){if(strmatch(argv[idx_metric_rmap]->text,"m
etric"))metric=strtoul(argv[idx_metric_rmap+1]->arg,NULL,10);elseroutemap=argv[i
dx_metric_rmap+1]->arg;}if(family==AF_INET6&&originate_type!=DEFAULT_ORIGINATE_A
LWAYS){vty_out(vty,"Zebradoesn'timplementdefault-originateforIPv6yet\n");vty_out
(vty,"sousewithcareorusedefault-originatealways.\n");}isis_redist_set(area,level
,family,DEFAULT_ROUTE,metric,routemap,originate_type);return0;}DEFUN(no_isis_def
ault_originate,no_isis_default_originate_cmd,"nodefault-informationoriginate<ipv
4|ipv6><level-1|level-2>",NO_STR"Controldistributionofdefaultinformation\n""Dist
ributeadefaultroute\n""DistributedefaultrouteforIPv4\n""Distributedefaultroutefo
rIPv6\n""Distributedefaultrouteintolevel-1\n""Distributedefaultrouteintolevel-2\
n"){intidx_afi=3;intidx_level=4;VTY_DECLVAR_CONTEXT(isis_area,area);intfamily;in
tlevel;family=str2family(argv[idx_afi]->text);if(family<0)returnCMD_WARNING_CONF
IG_FAILED;if(strmatch("level-1",argv[idx_level]->text))level=1;elseif(strmatch("
level-2",argv[idx_level]->text))level=2;elsereturnCMD_WARNING_CONFIG_FAILED;isis
_redist_unset(area,level,family,DEFAULT_ROUTE);return0;}intisis_redist_config_wr
ite(structvty*vty,structisis_area*area,intfamily){inttype;intlevel;intwrite=0;st
ructisis_redist*redist;constchar*family_str;if(family==AF_INET)family_str="ipv4"
;elseif(family==AF_INET6)family_str="ipv6";elsereturn0;for(type=0;type<ZEBRA_ROU
TE_MAX;type++){if(type==ZEBRA_ROUTE_ISIS)continue;for(level=1;level<=ISIS_LEVELS
;level++){redist=get_redist_settings(area,family,type,level);if(!redist->redist)
continue;vty_out(vty,"redistribute%s%slevel-%d",family_str,zebra_route_string(ty
pe),level);if(redist->metric!=0xffffffff)vty_out(vty,"metric%u",redist->metric);
if(redist->map_name)vty_out(vty,"route-map%s",redist->map_name);vty_out(vty,"\n"
);write++;}}for(level=1;level<=ISIS_LEVELS;level++){redist=get_redist_settings(a
rea,family,DEFAULT_ROUTE,level);if(!redist->redist)continue;vty_out(vty,"default
-informationoriginate%slevel-%d",family_str,level);if(redist->redist==DEFAULT_OR
IGINATE_ALWAYS)vty_out(vty,"always");if(redist->metric!=0xffffffff)vty_out(vty,"
metric%u",redist->metric);if(redist->map_name)vty_out(vty,"route-map%s",redist->
map_name);vty_out(vty,"\n");write++;}returnwrite;}voidisis_redist_init(void){ins
tall_element(ISIS_NODE,&isis_redistribute_cmd);install_element(ISIS_NODE,&no_isi
s_redistribute_cmd);install_element(ISIS_NODE,&isis_default_originate_cmd);insta
ll_element(ISIS_NODE,&no_isis_default_originate_cmd);}