/**IS-ISRout(e)ingprotocol-isis_pfpacket.c**Copyright(C)2001,2002SampoSaaristo*T
ampereUniversityofTechnology*InstituteofCommunicationsEngineering**Thisprogramis
freesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPubl
icLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(a
tyouroption)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeusef
ul,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNE
SSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshould
havereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOP
YING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston
,MA02110-1301USA*/#include<zebra.h>#ifISIS_METHOD==ISIS_METHOD_PFPACKET#include<
net/ethernet.h>/*theL2protocols*/#include<netpacket/packet.h>#include<linux/filt
er.h>#include"log.h"#include"network.h"#include"stream.h"#include"if.h"#include"
isisd/dict.h"#include"isisd/isis_constants.h"#include"isisd/isis_common.h"#inclu
de"isisd/isis_circuit.h"#include"isisd/isis_flags.h"#include"isisd/isisd.h"#incl
ude"isisd/isis_constants.h"#include"isisd/isis_circuit.h"#include"isisd/isis_net
work.h"#include"privs.h"/*tcpdump-ieth0'isis'-dd*/staticstructsock_filterisisfil
ter[]={/*NB:we'reinSOCK_DGRAM,sosrc/dstmac+lengtharestripped*off!*(OTOHit'sabitm
orelower-layeragnosticandmightwork*overGRE?)*//*{0x28,0,0,0x0000000c-14},*//*{0x
25,5,0,0x000005dc},*/{0x28,0,0,0x0000000e-14},{0x15,0,3,0x0000fefe},{0x30,0,0,0x
00000011-14},{0x15,0,1,0x00000083},{0x6,0,0,0x00040000},{0x6,0,0,0x00000000},};s
taticstructsock_fprogbpf={.len=array_size(isisfilter),.filter=isisfilter,};/**Ta
ble9-ArchitecturalconstantsforusewithISO8802subnetworks*ISO10589-8.4.8*/uint8_tA
LL_L1_ISS[6]={0x01,0x80,0xC2,0x00,0x00,0x14};uint8_tALL_L2_ISS[6]={0x01,0x80,0xC
2,0x00,0x00,0x15};uint8_tALL_ISS[6]={0x09,0x00,0x2B,0x00,0x00,0x05};uint8_tALL_E
SS[6]={0x09,0x00,0x2B,0x00,0x00,0x04};staticuint8_tdiscard_buff[8192];staticuint
8_tsock_buff[8192];/**iflevelis0wearejoiningp2pmulticast*FIXME:andthep2pmulticas
tbeing???*/staticintisis_multicast_join(intfd,intregisterto,intif_num){structpac
ket_mreqmreq;memset(&mreq,0,sizeof(mreq));mreq.mr_ifindex=if_num;if(registerto){
mreq.mr_type=PACKET_MR_MULTICAST;mreq.mr_alen=ETH_ALEN;if(registerto==1)memcpy(&
mreq.mr_address,ALL_L1_ISS,ETH_ALEN);elseif(registerto==2)memcpy(&mreq.mr_addres
s,ALL_L2_ISS,ETH_ALEN);elseif(registerto==3)memcpy(&mreq.mr_address,ALL_ISS,ETH_
ALEN);elsememcpy(&mreq.mr_address,ALL_ESS,ETH_ALEN);}else{mreq.mr_type=PACKET_MR
_ALLMULTI;}#ifdefEXTREME_DEBUGzlog_debug("isis_multicast_join():fd=%d,reg_to=%d,
if_num=%d,""address=%02x:%02x:%02x:%02x:%02x:%02x",fd,registerto,if_num,mreq.mr_
address[0],mreq.mr_address[1],mreq.mr_address[2],mreq.mr_address[3],mreq.mr_addr
ess[4],mreq.mr_address[5]);#endif/*EXTREME_DEBUG*/if(setsockopt(fd,SOL_PACKET,PA
CKET_ADD_MEMBERSHIP,&mreq,sizeof(structpacket_mreq))){zlog_warn("isis_multicast_
join():setsockopt():%s",safe_strerror(errno));returnISIS_WARNING;}returnISIS_OK;
}staticintopen_packet_socket(structisis_circuit*circuit){structsockaddr_lls_addr
;intfd,retval=ISIS_OK;fd=socket(PF_PACKET,SOCK_DGRAM,htons(ETH_P_ALL));if(fd<0){
zlog_warn("open_packet_socket():socket()failed%s",safe_strerror(errno));returnIS
IS_WARNING;}if(setsockopt(fd,SOL_SOCKET,SO_ATTACH_FILTER,&bpf,sizeof(bpf))){zlog
_warn("open_packet_socket():SO_ATTACH_FILTERfailed:%s",safe_strerror(errno));}/*
*Bindtothephysicalinterface*/memset(&s_addr,0,sizeof(structsockaddr_ll));s_addr.
sll_family=AF_PACKET;s_addr.sll_protocol=htons(ETH_P_ALL);s_addr.sll_ifindex=cir
cuit->interface->ifindex;if(bind(fd,(structsockaddr*)(&s_addr),sizeof(structsock
addr_ll))<0){zlog_warn("open_packet_socket():bind()failed:%s",safe_strerror(errn
o));close(fd);returnISIS_WARNING;}circuit->fd=fd;if(if_is_broadcast(circuit->int
erface)){/**Jointomulticastgroups*accordingto*8.4.2-BroadcastsubnetworkIIHPDUs*F
IXME:isthereacaseonlyonewillfail??*//*joiningALL_L1_ISS*/retval|=isis_multicast_
join(circuit->fd,1,circuit->interface->ifindex);/*joiningALL_L2_ISS*/retval|=isi
s_multicast_join(circuit->fd,2,circuit->interface->ifindex);/*joiningALL_ISS(use
dinRFC5309p2p-over-lanaswell)*/retval|=isis_multicast_join(circuit->fd,3,circuit
->interface->ifindex);}else{retval=isis_multicast_join(circuit->fd,0,circuit->in
terface->ifindex);}returnretval;}/**Createthesocketandsetthetx/rxfuncs*/intisis_
sock_init(structisis_circuit*circuit){intretval=ISIS_OK;if(isisd_privs.change(ZP
RIVS_RAISE))zlog_err("%s:couldnotraiseprivs,%s",__func__,safe_strerror(errno));r
etval=open_packet_socket(circuit);if(retval!=ISIS_OK){zlog_warn("%s:couldnotinit
ializethesocket",__func__);gotoend;}/*AssignRxandTxcallbacksarebasedonrealiftype
*/if(if_is_broadcast(circuit->interface)){circuit->tx=isis_send_pdu_bcast;circui
t->rx=isis_recv_pdu_bcast;}elseif(if_is_pointopoint(circuit->interface)){circuit
->tx=isis_send_pdu_p2p;circuit->rx=isis_recv_pdu_p2p;}else{zlog_warn("isis_sock_
init():unknowncircuittype");retval=ISIS_WARNING;gotoend;}end:if(isisd_privs.chan
ge(ZPRIVS_LOWER))zlog_err("%s:couldnotlowerprivs,%s",__func__,safe_strerror(errn
o));returnretval;}staticinlineintllc_check(uint8_t*llc){if(*llc!=ISO_SAP||*(llc+
1)!=ISO_SAP||*(llc+2)!=3)return0;return1;}intisis_recv_pdu_bcast(structisis_circ
uit*circuit,uint8_t*ssnpa){intbytesread,addr_len;structsockaddr_lls_addr;uint8_t
llc[LLC_LEN];addr_len=sizeof(s_addr);memset(&s_addr,0,sizeof(structsockaddr_ll))
;bytesread=recvfrom(circuit->fd,(void*)&llc,LLC_LEN,MSG_PEEK,(structsockaddr*)&s
_addr,(socklen_t*)&addr_len);if((bytesread<0)||(s_addr.sll_ifindex!=(int)circuit
->interface->ifindex)){if(bytesread<0){zlog_warn("isis_recv_packet_bcast():ifnam
e%s,fd%d,""bytesread%d,recvfrom():%s",circuit->interface->name,circuit->fd,bytes
read,safe_strerror(errno));}if(s_addr.sll_ifindex!=(int)circuit->interface->ifin
dex){zlog_warn("packetisreceivedonmultipleinterfaces:""socketinterface%d,circuit
interface%d,""packettype%u",s_addr.sll_ifindex,circuit->interface->ifindex,s_add
r.sll_pkttype);}/*getridofthepacket*/bytesread=recvfrom(circuit->fd,discard_buff
,sizeof(discard_buff),MSG_DONTWAIT,(structsockaddr*)&s_addr,(socklen_t*)&addr_le
n);if(bytesread<0)zlog_warn("isis_recv_pdu_bcast():recvfrom()failed");returnISIS
_WARNING;}/**Filteringbyllcfield,discardpacketssentbythishost(other*circuit)*/if
(!llc_check(llc)||s_addr.sll_pkttype==PACKET_OUTGOING){/*Readthepacketintodiscar
dbuff*/bytesread=recvfrom(circuit->fd,discard_buff,sizeof(discard_buff),MSG_DONT
WAIT,(structsockaddr*)&s_addr,(socklen_t*)&addr_len);if(bytesread<0)zlog_warn("i
sis_recv_pdu_bcast():recvfrom()failed");returnISIS_WARNING;}/*onlanwehavetoreadt
othestaticbufffirst*/bytesread=recvfrom(circuit->fd,sock_buff,sizeof(sock_buff),
MSG_DONTWAIT,(structsockaddr*)&s_addr,(socklen_t*)&addr_len);if(bytesread<0){zlo
g_warn("isis_recv_pdu_bcast():recvfrom()failed");returnISIS_WARNING;}/*thenwelos
etheLLC*/stream_write(circuit->rcv_stream,sock_buff+LLC_LEN,bytesread-LLC_LEN);m
emcpy(ssnpa,&s_addr.sll_addr,s_addr.sll_halen);returnISIS_OK;}intisis_recv_pdu_p
2p(structisis_circuit*circuit,uint8_t*ssnpa){intbytesread,addr_len;structsockadd
r_lls_addr;memset(&s_addr,0,sizeof(structsockaddr_ll));addr_len=sizeof(s_addr);/
*wecanreaddirectlytothestream*/stream_recvfrom(circuit->rcv_stream,circuit->fd,c
ircuit->interface->mtu,0,(structsockaddr*)&s_addr,(socklen_t*)&addr_len);if(s_ad
dr.sll_pkttype==PACKET_OUTGOING){/*Readthepacketintodiscardbuff*/bytesread=recvf
rom(circuit->fd,discard_buff,sizeof(discard_buff),MSG_DONTWAIT,(structsockaddr*)
&s_addr,(socklen_t*)&addr_len);if(bytesread<0)zlog_warn("isis_recv_pdu_p2p():rec
vfrom()failed");returnISIS_WARNING;}/*Ifwedon'thaveprotocoltype0x00FEwhichis*ISO
overGREweexitwithpain:)*/if(ntohs(s_addr.sll_protocol)!=0x00FE){zlog_warn("isis_
recv_pdu_p2p():protocolmismatch():%X",ntohs(s_addr.sll_protocol));returnISIS_WAR
NING;}memcpy(ssnpa,&s_addr.sll_addr,s_addr.sll_halen);returnISIS_OK;}intisis_sen
d_pdu_bcast(structisis_circuit*circuit,intlevel){structmsghdrmsg;structioveciov[
2];/*weneedtodotheLLCinherebecauseofP2Pcircuits,whichwill*notneedit*/structsocka
ddr_llsa;stream_set_getp(circuit->snd_stream,0);memset(&sa,0,sizeof(structsockad
dr_ll));sa.sll_family=AF_PACKET;size_tframe_size=stream_get_endp(circuit->snd_st
ream)+LLC_LEN;sa.sll_protocol=htons(isis_ethertype(frame_size));sa.sll_ifindex=c
ircuit->interface->ifindex;sa.sll_halen=ETH_ALEN;/*RFC5309section4.1recommendsAL
L_ISS*/if(circuit->circ_type==CIRCUIT_T_P2P)memcpy(&sa.sll_addr,ALL_ISS,ETH_ALEN
);elseif(level==1)memcpy(&sa.sll_addr,ALL_L1_ISS,ETH_ALEN);elsememcpy(&sa.sll_ad
dr,ALL_L2_ISS,ETH_ALEN);/*onabroadcastcircuit*//*firstweputtheLLCin*/sock_buff[0
]=0xFE;sock_buff[1]=0xFE;sock_buff[2]=0x03;memset(&msg,0,sizeof(msg));msg.msg_na
me=&sa;msg.msg_namelen=sizeof(structsockaddr_ll);msg.msg_iov=iov;msg.msg_iovlen=
2;iov[0].iov_base=sock_buff;iov[0].iov_len=LLC_LEN;iov[1].iov_base=circuit->snd_
stream->data;iov[1].iov_len=stream_get_endp(circuit->snd_stream);if(sendmsg(circ
uit->fd,&msg,0)<0){zlog_warn("IS-ISpfpacket:couldnottransmitpacketon%s:%s",circu
it->interface->name,safe_strerror(errno));if(ERRNO_IO_RETRY(errno))returnISIS_WA
RNING;returnISIS_ERROR;}returnISIS_OK;}intisis_send_pdu_p2p(structisis_circuit*c
ircuit,intlevel){structsockaddr_llsa;ssize_trv;stream_set_getp(circuit->snd_stre
am,0);memset(&sa,0,sizeof(structsockaddr_ll));sa.sll_family=AF_PACKET;sa.sll_ifi
ndex=circuit->interface->ifindex;sa.sll_halen=ETH_ALEN;if(level==1)memcpy(&sa.sl
l_addr,ALL_L1_ISS,ETH_ALEN);elsememcpy(&sa.sll_addr,ALL_L2_ISS,ETH_ALEN);/*letst
rycorrectingtheprotocol*/sa.sll_protocol=htons(0x00FE);rv=sendto(circuit->fd,cir
cuit->snd_stream->data,stream_get_endp(circuit->snd_stream),0,(structsockaddr*)&
sa,sizeof(structsockaddr_ll));if(rv<0){zlog_warn("IS-ISpfpacket:couldnottransmit
packeton%s:%s",circuit->interface->name,safe_strerror(errno));if(ERRNO_IO_RETRY(
errno))returnISIS_WARNING;returnISIS_ERROR;}returnISIS_OK;}#endif/*ISIS_METHOD==
ISIS_METHOD_PFPACKET*/