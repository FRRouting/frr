/**IS-ISRout(e)ingprotocol-isis_circuit.h**Copyright(C)2001,2002SampoSaaristo*Ta
mpereUniversityofTechnology*InstituteofCommunicationsEngineering**Thisprogramisf
reesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPubli
cLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(at
youroption)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeusefu
l,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNES
SFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#include<zebra.h>#ifdefGNU_LINUX#include<net/ethernet.h>#else#i
nclude<netinet/if_ether.h>#endif#include"log.h"#include"memory.h"#include"vrf.h"
#include"if.h"#include"linklist.h"#include"command.h"#include"thread.h"#include"
vty.h"#include"hash.h"#include"prefix.h"#include"stream.h"#include"qobj.h"#inclu
de"isisd/dict.h"#include"isisd/isis_constants.h"#include"isisd/isis_common.h"#in
clude"isisd/isis_flags.h"#include"isisd/isis_circuit.h"#include"isisd/isis_lsp.h
"#include"isisd/isis_lsp_hash.h"#include"isisd/isis_pdu.h"#include"isisd/isis_ne
twork.h"#include"isisd/isis_misc.h"#include"isisd/isis_constants.h"#include"isis
d/isis_adjacency.h"#include"isisd/isis_dr.h"#include"isisd/isisd.h"#include"isis
d/isis_csm.h"#include"isisd/isis_events.h"#include"isisd/isis_te.h"#include"isis
d/isis_mt.h"DEFINE_QOBJ_TYPE(isis_circuit)/**Prototypes.*/intisis_interface_conf
ig_write(structvty*);intisis_if_new_hook(structinterface*);intisis_if_delete_hoo
k(structinterface*);structisis_circuit*isis_circuit_new(){structisis_circuit*cir
cuit;inti;circuit=XCALLOC(MTYPE_ISIS_CIRCUIT,sizeof(structisis_circuit));if(circ
uit==NULL){zlog_err("Can'tmallocisiscircuit");returnNULL;}/**Defaultvalues*/circ
uit->is_type=IS_LEVEL_1_AND_2;circuit->flags=0;circuit->pad_hellos=1;for(i=0;i<2
;i++){circuit->hello_interval[i]=DEFAULT_HELLO_INTERVAL;circuit->hello_multiplie
r[i]=DEFAULT_HELLO_MULTIPLIER;circuit->csnp_interval[i]=DEFAULT_CSNP_INTERVAL;ci
rcuit->psnp_interval[i]=DEFAULT_PSNP_INTERVAL;circuit->priority[i]=DEFAULT_PRIOR
ITY;circuit->metric[i]=DEFAULT_CIRCUIT_METRIC;circuit->te_metric[i]=DEFAULT_CIRC
UIT_METRIC;}circuit->mtc=mpls_te_circuit_new();circuit_mt_init(circuit);QOBJ_REG
(circuit,isis_circuit);returncircuit;}voidisis_circuit_del(structisis_circuit*ci
rcuit){if(!circuit)return;QOBJ_UNREG(circuit);isis_circuit_if_unbind(circuit,cir
cuit->interface);circuit_mt_finish(circuit);/*andlastlythecircuititself*/XFREE(M
TYPE_ISIS_CIRCUIT,circuit);return;}voidisis_circuit_configure(structisis_circuit
*circuit,structisis_area*area){assert(area);circuit->area=area;/**Whenevertheis-
typeofanareaischanged,theis-typeofeach*circuit*inthatareaisupdatedtoanon-emptysu
bsetoftheareais-type.*Inversely,whenconfiguringanewcircuit,thispropertyshouldbe*
ensuredaswell.*/if(area->is_type!=IS_LEVEL_1_AND_2)circuit->is_type=area->is_typ
e;/**Addthecircuitintoarea*/listnode_add(area->circuit_list,circuit);circuit->id
x=flags_get_index(&area->flags);return;}voidisis_circuit_deconfigure(structisis_
circuit*circuit,structisis_area*area){/*FreetheindexofSRMandSSNflags*/flags_free
_index(&area->flags,circuit->idx);circuit->idx=0;/*Removecircuitfromarea*/assert
(circuit->area==area);listnode_delete(area->circuit_list,circuit);circuit->area=
NULL;return;}structisis_circuit*circuit_lookup_by_ifp(structinterface*ifp,struct
list*list){structisis_circuit*circuit=NULL;structlistnode*node;if(!list)returnNU
LL;for(ALL_LIST_ELEMENTS_RO(list,node,circuit))if(circuit->interface==ifp){asser
t(ifp->info==circuit);returncircuit;}returnNULL;}structisis_circuit*circuit_scan
_by_ifp(structinterface*ifp){structisis_area*area;structlistnode*node;structisis
_circuit*circuit;if(ifp->info)return(structisis_circuit*)ifp->info;if(isis->area
_list){for(ALL_LIST_ELEMENTS_RO(isis->area_list,node,area)){circuit=circuit_look
up_by_ifp(ifp,area->circuit_list);if(circuit)returncircuit;}}returncircuit_looku
p_by_ifp(ifp,isis->init_circ_list);}voidisis_circuit_add_addr(structisis_circuit
*circuit,structconnected*connected){structlistnode*node;structprefix_ipv4*ipv4;#
ifdefined(EXTREME_DEBUG)charbuf[PREFIX2STR_BUFFER];#endifstructprefix_ipv6*ipv6;
if(connected->address->family==AF_INET){uint32_taddr=connected->address->u.prefi
x4.s_addr;addr=ntohl(addr);if(IPV4_NET0(addr)||IPV4_NET127(addr)||IN_CLASSD(addr
)||IPV4_LINKLOCAL(addr))return;for(ALL_LIST_ELEMENTS_RO(circuit->ip_addrs,node,i
pv4))if(prefix_same((structprefix*)ipv4,connected->address))return;ipv4=prefix_i
pv4_new();ipv4->prefixlen=connected->address->prefixlen;ipv4->prefix=connected->
address->u.prefix4;listnode_add(circuit->ip_addrs,ipv4);/*UpdateMPLSTELocalIPadd
ressparameter*/set_circuitparams_local_ipaddr(circuit->mtc,ipv4->prefix);if(circ
uit->area)lsp_regenerate_schedule(circuit->area,circuit->is_type,0);#ifdefEXTREM
E_DEBUGprefix2str(connected->address,buf,sizeof(buf));zlog_debug("AddedIPaddress
%stocircuit%s",buf,circuit->interface->name);#endif/*EXTREME_DEBUG*/}if(connecte
d->address->family==AF_INET6){if(IN6_IS_ADDR_LOOPBACK(&connected->address->u.pre
fix6))return;for(ALL_LIST_ELEMENTS_RO(circuit->ipv6_link,node,ipv6))if(prefix_sa
me((structprefix*)ipv6,connected->address))return;for(ALL_LIST_ELEMENTS_RO(circu
it->ipv6_non_link,node,ipv6))if(prefix_same((structprefix*)ipv6,connected->addre
ss))return;ipv6=prefix_ipv6_new();ipv6->prefixlen=connected->address->prefixlen;
ipv6->prefix=connected->address->u.prefix6;if(IN6_IS_ADDR_LINKLOCAL(&ipv6->prefi
x))listnode_add(circuit->ipv6_link,ipv6);elselistnode_add(circuit->ipv6_non_link
,ipv6);if(circuit->area)lsp_regenerate_schedule(circuit->area,circuit->is_type,0
);#ifdefEXTREME_DEBUGprefix2str(connected->address,buf,sizeof(buf));zlog_debug("
AddedIPv6address%stocircuit%s",buf,circuit->interface->name);#endif/*EXTREME_DEB
UG*/}return;}voidisis_circuit_del_addr(structisis_circuit*circuit,structconnecte
d*connected){structprefix_ipv4*ipv4,*ip=NULL;structlistnode*node;charbuf[PREFIX2
STR_BUFFER];structprefix_ipv6*ipv6,*ip6=NULL;intfound=0;if(connected->address->f
amily==AF_INET){ipv4=prefix_ipv4_new();ipv4->prefixlen=connected->address->prefi
xlen;ipv4->prefix=connected->address->u.prefix4;for(ALL_LIST_ELEMENTS_RO(circuit
->ip_addrs,node,ip))if(prefix_same((structprefix*)ip,(structprefix*)ipv4))break;
if(ip){listnode_delete(circuit->ip_addrs,ip);prefix_ipv4_free(ip);if(circuit->ar
ea)lsp_regenerate_schedule(circuit->area,circuit->is_type,0);}else{prefix2str(co
nnected->address,buf,sizeof(buf));zlog_warn("Nonexistentipaddress%sremovalattemp
tfrom\circuit%s",buf,circuit->interface->name);zlog_warn("Currentipaddresseson%s
:",circuit->interface->name);for(ALL_LIST_ELEMENTS_RO(circuit->ip_addrs,node,ip)
){prefix2str(ip,buf,sizeof(buf));zlog_warn("%s",buf);}zlog_warn("Endofaddresses"
);}prefix_ipv4_free(ipv4);}if(connected->address->family==AF_INET6){ipv6=prefix_
ipv6_new();ipv6->prefixlen=connected->address->prefixlen;ipv6->prefix=connected-
>address->u.prefix6;if(IN6_IS_ADDR_LINKLOCAL(&ipv6->prefix)){for(ALL_LIST_ELEMEN
TS_RO(circuit->ipv6_link,node,ip6)){if(prefix_same((structprefix*)ip6,(structpre
fix*)ipv6))break;}if(ip6){listnode_delete(circuit->ipv6_link,ip6);prefix_ipv6_fr
ee(ip6);found=1;}}else{for(ALL_LIST_ELEMENTS_RO(circuit->ipv6_non_link,node,ip6)
){if(prefix_same((structprefix*)ip6,(structprefix*)ipv6))break;}if(ip6){listnode
_delete(circuit->ipv6_non_link,ip6);prefix_ipv6_free(ip6);found=1;}}if(!found){p
refix2str(connected->address,buf,sizeof(buf));zlog_warn("Nonexistentipaddress%sr
emovalattemptfrom\circuit%s",buf,circuit->interface->name);zlog_warn("Currentipa
ddresseson%s:",circuit->interface->name);for(ALL_LIST_ELEMENTS_RO(circuit->ipv6_
link,node,ip6)){prefix2str((structprefix*)ip6,(char*)buf,BUFSIZ);zlog_warn("%s",
buf);}zlog_warn("-----");for(ALL_LIST_ELEMENTS_RO(circuit->ipv6_non_link,node,ip
6)){prefix2str((structprefix*)ip6,(char*)buf,BUFSIZ);zlog_warn("%s",buf);}zlog_w
arn("Endofaddresses");}elseif(circuit->area)lsp_regenerate_schedule(circuit->are
a,circuit->is_type,0);prefix_ipv6_free(ipv6);}return;}staticuint8_tisis_circuit_
id_gen(structisis*isis,structinterface*ifp){/*CircuitidsMUSTbeuniqueforanybroadc
astcircuits.Otherwise,*Pseudo-NodeLSPscannotbegeneratedcorrectly.**Currently,all
ocateonecircuitIDforanycircuit,limitingthetotal*numerofcircuitsIS-IScanrunonto25
5.**Weshouldrevisitthiswhenimplementing3-wayadjacenciesforp2p,since*wethenhaveex
tendedinterfaceIDsavailable.*/uint8_tid=ifp->ifindex;unsignedinti;for(i=0;i<256;
i++){if(id&&!_ISIS_CHECK_FLAG(isis->circuit_ids_used,id))break;id++;}if(i==256){
zlog_warn("Couldnotallocateacircuitidfor'%s'",ifp->name);return0;}_ISIS_SET_FLAG
(isis->circuit_ids_used,id);returnid;}voidisis_circuit_if_add(structisis_circuit
*circuit,structinterface*ifp){structlistnode*node,*nnode;structconnected*conn;is
is_circuit_if_bind(circuit,ifp);if(if_is_broadcast(ifp)){if(circuit->circ_type_c
onfig==CIRCUIT_T_P2P)circuit->circ_type=CIRCUIT_T_P2P;elsecircuit->circ_type=CIR
CUIT_T_BROADCAST;}elseif(if_is_pointopoint(ifp)){circuit->circ_type=CIRCUIT_T_P2
P;}elseif(if_is_loopback(ifp)){circuit->circ_type=CIRCUIT_T_LOOPBACK;circuit->is
_passive=1;}else{/*It'snormalincaseofloopbacketc.*/if(isis->debugs&DEBUG_EVENTS)
zlog_debug("isis_circuit_if_add:unsupportedmedia");circuit->circ_type=CIRCUIT_T_
UNKNOWN;}circuit->ip_addrs=list_new();circuit->ipv6_link=list_new();circuit->ipv
6_non_link=list_new();for(ALL_LIST_ELEMENTS(ifp->connected,node,nnode,conn))isis
_circuit_add_addr(circuit,conn);}voidisis_circuit_if_del(structisis_circuit*circ
uit,structinterface*ifp){structlistnode*node,*nnode;structconnected*conn;assert(
circuit->interface==ifp);/*destroyaddresses*/for(ALL_LIST_ELEMENTS(ifp->connecte
d,node,nnode,conn))isis_circuit_del_addr(circuit,conn);if(circuit->ip_addrs){ass
ert(listcount(circuit->ip_addrs)==0);list_delete_and_null(&circuit->ip_addrs);}i
f(circuit->ipv6_link){assert(listcount(circuit->ipv6_link)==0);list_delete_and_n
ull(&circuit->ipv6_link);}if(circuit->ipv6_non_link){assert(listcount(circuit->i
pv6_non_link)==0);list_delete_and_null(&circuit->ipv6_non_link);}circuit->circ_t
ype=CIRCUIT_T_UNKNOWN;}voidisis_circuit_if_bind(structisis_circuit*circuit,struc
tinterface*ifp){assert(circuit!=NULL);assert(ifp!=NULL);if(circuit->interface)as
sert(circuit->interface==ifp);elsecircuit->interface=ifp;if(ifp->info)assert(ifp
->info==circuit);elseifp->info=circuit;isis_link_params_update(circuit,ifp);}voi
disis_circuit_if_unbind(structisis_circuit*circuit,structinterface*ifp){assert(c
ircuit!=NULL);assert(ifp!=NULL);assert(circuit->interface==ifp);assert(ifp->info
==circuit);circuit->interface=NULL;ifp->info=NULL;}staticvoidisis_circuit_update
_all_srmflags(structisis_circuit*circuit,intis_set){structisis_area*area;structi
sis_lsp*lsp;dnode_t*dnode,*dnode_next;intlevel;assert(circuit);area=circuit->are
a;assert(area);for(level=ISIS_LEVEL1;level<=ISIS_LEVEL2;level++){if(level&circui
t->is_type){if(area->lspdb[level-1]&&dict_count(area->lspdb[level-1])>0){for(dno
de=dict_first(area->lspdb[level-1]);dnode!=NULL;dnode=dnode_next){dnode_next=dic
t_next(area->lspdb[level-1],dnode);lsp=dnode_get(dnode);if(is_set){ISIS_SET_FLAG
(lsp->SRMflags,circuit);}else{ISIS_CLEAR_FLAG(lsp->SRMflags,circuit);}}}}}}size_
tisis_circuit_pdu_size(structisis_circuit*circuit){returnISO_MTU(circuit);}voidi
sis_circuit_stream(structisis_circuit*circuit,structstream**stream){size_tstream
_size=isis_circuit_pdu_size(circuit);if(!*stream){*stream=stream_new(stream_size
);}else{if(STREAM_SIZE(*stream)!=stream_size)stream_resize(*stream,stream_size);
stream_reset(*stream);}}voidisis_circuit_prepare(structisis_circuit*circuit){#if
ISIS_METHOD!=ISIS_METHOD_DLPIthread_add_read(master,isis_receive,circuit,circuit
->fd,&circuit->t_read);#elsethread_add_timer_msec(master,isis_receive,circuit,li
stcount(circuit->area->circuit_list)*100,&circuit->t_read);#endif}intisis_circui
t_up(structisis_circuit*circuit){intretv;/*Settheflagsforallthelspsofthecircuit.
*/isis_circuit_update_all_srmflags(circuit,1);if(circuit->state==C_STATE_UP)retu
rnISIS_OK;if(circuit->is_passive)returnISIS_OK;if(circuit->area->lsp_mtu>isis_ci
rcuit_pdu_size(circuit)){zlog_err("InterfaceMTU%zuon%sistoolowtosupportarealspmt
u%u!",isis_circuit_pdu_size(circuit),circuit->interface->name,circuit->area->lsp
_mtu);isis_circuit_update_all_srmflags(circuit,0);returnISIS_ERROR;}if(circuit->
circ_type==CIRCUIT_T_BROADCAST){circuit->circuit_id=isis_circuit_id_gen(isis,cir
cuit->interface);if(!circuit->circuit_id){zlog_err("Therearealready255broadcastc
ircuitsactive!");returnISIS_ERROR;}/**GettheHardwareAddress*/if(circuit->interfa
ce->hw_addr_len!=ETH_ALEN){zlog_warn("unsupportedlinklayer");}else{memcpy(circui
t->u.bc.snpa,circuit->interface->hw_addr,ETH_ALEN);}#ifdefEXTREME_DEGUGzlog_debu
g("isis_circuit_if_add:if_id%d,isomtu%dsnpa%s",circuit->interface->ifindex,ISO_M
TU(circuit),snpa_print(circuit->u.bc.snpa));#endif/*EXTREME_DEBUG*/circuit->u.bc
.adjdb[0]=list_new();circuit->u.bc.adjdb[1]=list_new();/**ISO10589-8.4.1Enabling
ofbroadcastcircuits*//*initilizingthehellosendingthreads*forabroadcastIF*//*8.4.
1a)commencesendingofIIHPDUs*/if(circuit->is_type&IS_LEVEL_1){thread_add_event(ma
ster,send_lan_l1_hello,circuit,0,NULL);circuit->u.bc.lan_neighs[0]=list_new();}i
f(circuit->is_type&IS_LEVEL_2){thread_add_event(master,send_lan_l2_hello,circuit
,0,NULL);circuit->u.bc.lan_neighs[1]=list_new();}/*8.4.1b)FIXME:solicitES-8.4.6*
//*8.4.1c)FIXME:listenforESHPDUs*//*8.4.1d)*//*drelectionwillcommencein...*/if(c
ircuit->is_type&IS_LEVEL_1)thread_add_timer(master,isis_run_dr_l1,circuit,2*circ
uit->hello_interval[0],&circuit->u.bc.t_run_dr[0]);if(circuit->is_type&IS_LEVEL_
2)thread_add_timer(master,isis_run_dr_l2,circuit,2*circuit->hello_interval[1],&c
ircuit->u.bc.t_run_dr[1]);}else{/*initializingthehellosendthreads*foraptpIF*/cir
cuit->u.p2p.neighbor=NULL;thread_add_event(master,send_p2p_hello,circuit,0,NULL)
;}/*initializingPSNPtimers*/if(circuit->is_type&IS_LEVEL_1)thread_add_timer(mast
er,send_l1_psnp,circuit,isis_jitter(circuit->psnp_interval[0],PSNP_JITTER),&circ
uit->t_send_psnp[0]);if(circuit->is_type&IS_LEVEL_2)thread_add_timer(master,send
_l2_psnp,circuit,isis_jitter(circuit->psnp_interval[1],PSNP_JITTER),&circuit->t_
send_psnp[1]);/*unifiedinitforcircuits;ignorewarningsbelowthislevel*/retv=isis_s
ock_init(circuit);if(retv!=ISIS_OK){isis_circuit_down(circuit);returnretv;}/*ini
tializethecircuitstreamsafteropeningconnection*/isis_circuit_stream(circuit,&cir
cuit->rcv_stream);isis_circuit_stream(circuit,&circuit->snd_stream);isis_circuit
_prepare(circuit);circuit->lsp_queue=list_new();circuit->lsp_hash=isis_lsp_hash_
new();circuit->lsp_queue_last_push[0]=circuit->lsp_queue_last_push[1]=monotime(N
ULL);returnISIS_OK;}voidisis_circuit_down(structisis_circuit*circuit){if(circuit
->state!=C_STATE_UP)return;/*Cleartheflagsforallthelspsofthecircuit.*/isis_circu
it_update_all_srmflags(circuit,0);if(circuit->circ_type==CIRCUIT_T_BROADCAST){/*
destroyneighbourlists*/if(circuit->u.bc.lan_neighs[0]){list_delete_and_null(&cir
cuit->u.bc.lan_neighs[0]);circuit->u.bc.lan_neighs[0]=NULL;}if(circuit->u.bc.lan
_neighs[1]){list_delete_and_null(&circuit->u.bc.lan_neighs[1]);circuit->u.bc.lan
_neighs[1]=NULL;}/*destroyadjacencydatabases*/if(circuit->u.bc.adjdb[0]){circuit
->u.bc.adjdb[0]->del=isis_delete_adj;list_delete_and_null(&circuit->u.bc.adjdb[0
]);circuit->u.bc.adjdb[0]=NULL;}if(circuit->u.bc.adjdb[1]){circuit->u.bc.adjdb[1
]->del=isis_delete_adj;list_delete_and_null(&circuit->u.bc.adjdb[1]);circuit->u.
bc.adjdb[1]=NULL;}if(circuit->u.bc.is_dr[0]){isis_dr_resign(circuit,1);circuit->
u.bc.is_dr[0]=0;}memset(circuit->u.bc.l1_desig_is,0,ISIS_SYS_ID_LEN+1);if(circui
t->u.bc.is_dr[1]){isis_dr_resign(circuit,2);circuit->u.bc.is_dr[1]=0;}memset(cir
cuit->u.bc.l2_desig_is,0,ISIS_SYS_ID_LEN+1);memset(circuit->u.bc.snpa,0,ETH_ALEN
);THREAD_TIMER_OFF(circuit->u.bc.t_send_lan_hello[0]);THREAD_TIMER_OFF(circuit->
u.bc.t_send_lan_hello[1]);THREAD_TIMER_OFF(circuit->u.bc.t_run_dr[0]);THREAD_TIM
ER_OFF(circuit->u.bc.t_run_dr[1]);THREAD_TIMER_OFF(circuit->u.bc.t_refresh_pseud
o_lsp[0]);THREAD_TIMER_OFF(circuit->u.bc.t_refresh_pseudo_lsp[1]);circuit->lsp_r
egenerate_pending[0]=0;circuit->lsp_regenerate_pending[1]=0;_ISIS_CLEAR_FLAG(isi
s->circuit_ids_used,circuit->circuit_id);circuit->circuit_id=0;}elseif(circuit->
circ_type==CIRCUIT_T_P2P){isis_delete_adj(circuit->u.p2p.neighbor);circuit->u.p2
p.neighbor=NULL;THREAD_TIMER_OFF(circuit->u.p2p.t_send_p2p_hello);}/*Cancelallac
tivethreads*/THREAD_TIMER_OFF(circuit->t_send_csnp[0]);THREAD_TIMER_OFF(circuit-
>t_send_csnp[1]);THREAD_TIMER_OFF(circuit->t_send_psnp[0]);THREAD_TIMER_OFF(circ
uit->t_send_psnp[1]);THREAD_OFF(circuit->t_send_lsp);THREAD_OFF(circuit->t_read)
;if(circuit->lsp_queue){list_delete_and_null(&circuit->lsp_queue);}if(circuit->l
sp_hash){isis_lsp_hash_free(circuit->lsp_hash);circuit->lsp_hash=NULL;}/*sendone
gratuitoushellotospeadupconvergence*/if(circuit->is_type&IS_LEVEL_1)send_hello(c
ircuit,IS_LEVEL_1);if(circuit->is_type&IS_LEVEL_2)send_hello(circuit,IS_LEVEL_2)
;circuit->upadjcount[0]=0;circuit->upadjcount[1]=0;/*closethesocket*/if(circuit-
>fd){close(circuit->fd);circuit->fd=0;}if(circuit->rcv_stream!=NULL){stream_free
(circuit->rcv_stream);circuit->rcv_stream=NULL;}if(circuit->snd_stream!=NULL){st
ream_free(circuit->snd_stream);circuit->snd_stream=NULL;}thread_cancel_event(mas
ter,circuit);return;}voidcircuit_update_nlpids(structisis_circuit*circuit){circu
it->nlpids.count=0;if(circuit->ip_router){circuit->nlpids.nlpids[0]=NLPID_IP;cir
cuit->nlpids.count++;}if(circuit->ipv6_router){circuit->nlpids.nlpids[circuit->n
lpids.count]=NLPID_IPV6;circuit->nlpids.count++;}return;}voidisis_circuit_print_
vty(structisis_circuit*circuit,structvty*vty,chardetail){if(detail==ISIS_UI_LEVE
L_BRIEF){vty_out(vty,"%-12s",circuit->interface->name);vty_out(vty,"0x%-7x",circ
uit->circuit_id);vty_out(vty,"%-9s",circuit_state2string(circuit->state));vty_ou
t(vty,"%-9s",circuit_type2string(circuit->circ_type));vty_out(vty,"%-9s",circuit
_t2string(circuit->is_type));vty_out(vty,"\n");}if(detail==ISIS_UI_LEVEL_DETAIL)
{structlistnode*node;structprefix*ip_addr;charbuf[BUFSIZ];vty_out(vty,"Interface
:%s",circuit->interface->name);vty_out(vty,",State:%s",circuit_state2string(circ
uit->state));if(circuit->is_passive)vty_out(vty,",Passive");elsevty_out(vty,",Ac
tive");vty_out(vty,",CircuitId:0x%x",circuit->circuit_id);vty_out(vty,"\n");vty_
out(vty,"Type:%s",circuit_type2string(circuit->circ_type));vty_out(vty,",Level:%
s",circuit_t2string(circuit->is_type));if(circuit->circ_type==CIRCUIT_T_BROADCAS
T)vty_out(vty,",SNPA:%-10s",snpa_print(circuit->u.bc.snpa));vty_out(vty,"\n");if
(circuit->is_type&IS_LEVEL_1){vty_out(vty,"Level-1Information:\n");if(circuit->a
rea->newmetric)vty_out(vty,"Metric:%d",circuit->te_metric[0]);elsevty_out(vty,"M
etric:%d",circuit->metric[0]);if(!circuit->is_passive){vty_out(vty,",Activeneigh
bors:%u\n",circuit->upadjcount[0]);vty_out(vty,"Hellointerval:%u,""Holddowncount
:%u%s\n",circuit->hello_interval[0],circuit->hello_multiplier[0],(circuit->pad_h
ellos?"(pad)":"(no-pad)"));vty_out(vty,"CNSPinterval:%u,""PSNPinterval:%u\n",cir
cuit->csnp_interval[0],circuit->psnp_interval[0]);if(circuit->circ_type==CIRCUIT
_T_BROADCAST)vty_out(vty,"LANPriority:%u,%s\n",circuit->priority[0],(circuit->u.
bc.is_dr[0]?"isDIS":"isnotDIS"));}else{vty_out(vty,"\n");}}if(circuit->is_type&I
S_LEVEL_2){vty_out(vty,"Level-2Information:\n");if(circuit->area->newmetric)vty_
out(vty,"Metric:%d",circuit->te_metric[1]);elsevty_out(vty,"Metric:%d",circuit->
metric[1]);if(!circuit->is_passive){vty_out(vty,",Activeneighbors:%u\n",circuit-
>upadjcount[1]);vty_out(vty,"Hellointerval:%u,""Holddowncount:%u%s\n",circuit->h
ello_interval[1],circuit->hello_multiplier[1],(circuit->pad_hellos?"(pad)":"(no-
pad)"));vty_out(vty,"CNSPinterval:%u,""PSNPinterval:%u\n",circuit->csnp_interval
[1],circuit->psnp_interval[1]);if(circuit->circ_type==CIRCUIT_T_BROADCAST)vty_ou
t(vty,"LANPriority:%u,%s\n",circuit->priority[1],(circuit->u.bc.is_dr[1]?"isDIS"
:"isnotDIS"));}else{vty_out(vty,"\n");}}if(circuit->ip_addrs&&listcount(circuit-
>ip_addrs)>0){vty_out(vty,"IPPrefix(es):\n");for(ALL_LIST_ELEMENTS_RO(circuit->i
p_addrs,node,ip_addr)){prefix2str(ip_addr,buf,sizeof(buf)),vty_out(vty,"%s\n",bu
f);}}if(circuit->ipv6_link&&listcount(circuit->ipv6_link)>0){vty_out(vty,"IPv6Li
nk-Locals:\n");for(ALL_LIST_ELEMENTS_RO(circuit->ipv6_link,node,ip_addr)){prefix
2str(ip_addr,(char*)buf,BUFSIZ),vty_out(vty,"%s\n",buf);}}if(circuit->ipv6_non_l
ink&&listcount(circuit->ipv6_non_link)>0){vty_out(vty,"IPv6Prefixes:\n");for(ALL
_LIST_ELEMENTS_RO(circuit->ipv6_non_link,node,ip_addr)){prefix2str(ip_addr,(char
*)buf,BUFSIZ),vty_out(vty,"%s\n",buf);}}vty_out(vty,"\n");}return;}intisis_inter
face_config_write(structvty*vty){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);int
write=0;structlistnode*node;structinterface*ifp;structisis_area*area;structisis_
circuit*circuit;inti;FOR_ALL_INTERFACES(vrf,ifp){/*IFname*/vty_frame(vty,"interf
ace%s\n",ifp->name);write++;/*IFdesc*/if(ifp->desc){vty_out(vty,"description%s\n
",ifp->desc);write++;}/*ISISCircuit*/for(ALL_LIST_ELEMENTS_RO(isis->area_list,no
de,area)){circuit=circuit_lookup_by_ifp(ifp,area->circuit_list);if(circuit==NULL
)continue;if(circuit->ip_router){vty_out(vty,"iprouterisis%s\n",area->area_tag);
write++;}if(circuit->is_passive){vty_out(vty,"isispassive\n");write++;}if(circui
t->circ_type_config==CIRCUIT_T_P2P){vty_out(vty,"isisnetworkpoint-to-point\n");w
rite++;}if(circuit->ipv6_router){vty_out(vty,"ipv6routerisis%s\n",area->area_tag
);write++;}/*ISIS-circuittype*/if(circuit->is_type==IS_LEVEL_1){vty_out(vty,"isi
scircuit-typelevel-1\n");write++;}else{if(circuit->is_type==IS_LEVEL_2){vty_out(
vty,"isiscircuit-typelevel-2-only\n");write++;}}/*ISIS-CSNPinterval*/if(circuit-
>csnp_interval[0]==circuit->csnp_interval[1]){if(circuit->csnp_interval[0]!=DEFA
ULT_CSNP_INTERVAL){vty_out(vty,"isiscsnp-interval%d\n",circuit->csnp_interval[0]
);write++;}}else{for(i=0;i<2;i++){if(circuit->csnp_interval[i]!=DEFAULT_CSNP_INT
ERVAL){vty_out(vty,"isiscsnp-interval%dlevel-%d\n",circuit->csnp_interval[i],i+1
);write++;}}}/*ISIS-PSNPinterval*/if(circuit->psnp_interval[0]==circuit->psnp_in
terval[1]){if(circuit->psnp_interval[0]!=DEFAULT_PSNP_INTERVAL){vty_out(vty,"isi
spsnp-interval%d\n",circuit->psnp_interval[0]);write++;}}else{for(i=0;i<2;i++){i
f(circuit->psnp_interval[i]!=DEFAULT_PSNP_INTERVAL){vty_out(vty,"isispsnp-interv
al%dlevel-%d\n",circuit->psnp_interval[i],i+1);write++;}}}/*ISIS-Hellopadding-De
faultstotruesoonly*displayiffalse*/if(circuit->pad_hellos==0){vty_out(vty,"noisi
shellopadding\n");write++;}if(circuit->disable_threeway_adj){vty_out(vty,"noisis
three-way-handshake\n");write++;}/*ISIS-Hellointerval*/if(circuit->hello_interva
l[0]==circuit->hello_interval[1]){if(circuit->hello_interval[0]!=DEFAULT_HELLO_I
NTERVAL){vty_out(vty,"isishello-interval%d\n",circuit->hello_interval[0]);write+
+;}}else{for(i=0;i<2;i++){if(circuit->hello_interval[i]!=DEFAULT_HELLO_INTERVAL)
{vty_out(vty,"isishello-interval%dlevel-%d\n",circuit->hello_interval[i],i+1);wr
ite++;}}}/*ISIS-HelloMultiplier*/if(circuit->hello_multiplier[0]==circuit->hello
_multiplier[1]){if(circuit->hello_multiplier[0]!=DEFAULT_HELLO_MULTIPLIER){vty_o
ut(vty,"isishello-multiplier%d\n",circuit->hello_multiplier[0]);write++;}}else{f
or(i=0;i<2;i++){if(circuit->hello_multiplier[i]!=DEFAULT_HELLO_MULTIPLIER){vty_o
ut(vty,"isishello-multiplier%dlevel-%d\n",circuit->hello_multiplier[i],i+1);writ
e++;}}}/*ISIS-Priority*/if(circuit->priority[0]==circuit->priority[1]){if(circui
t->priority[0]!=DEFAULT_PRIORITY){vty_out(vty,"isispriority%d\n",circuit->priori
ty[0]);write++;}}else{for(i=0;i<2;i++){if(circuit->priority[i]!=DEFAULT_PRIORITY
){vty_out(vty,"isispriority%dlevel-%d\n",circuit->priority[i],i+1);write++;}}}/*
ISIS-Metric*/if(circuit->te_metric[0]==circuit->te_metric[1]){if(circuit->te_met
ric[0]!=DEFAULT_CIRCUIT_METRIC){vty_out(vty,"isismetric%d\n",circuit->te_metric[
0]);write++;}}else{for(i=0;i<2;i++){if(circuit->te_metric[i]!=DEFAULT_CIRCUIT_ME
TRIC){vty_out(vty,"isismetric%dlevel-%d\n",circuit->te_metric[i],i+1);write++;}}
}if(circuit->passwd.type==ISIS_PASSWD_TYPE_HMAC_MD5){vty_out(vty,"isispasswordmd
5%s\n",circuit->passwd.passwd);write++;}elseif(circuit->passwd.type==ISIS_PASSWD
_TYPE_CLEARTXT){vty_out(vty,"isispasswordclear%s\n",circuit->passwd.passwd);writ
e++;}write+=circuit_write_mt_settings(circuit,vty);}vty_endframe(vty,"!\n");}ret
urnwrite;}structisis_circuit*isis_circuit_create(structisis_area*area,structinte
rface*ifp){structisis_circuit*circuit=circuit_scan_by_ifp(ifp);if(circuit&&circu
it->area)returnNULL;circuit=isis_csm_state_change(ISIS_ENABLE,circuit,area);if(c
ircuit->state!=C_STATE_CONF&&circuit->state!=C_STATE_UP)returncircuit;isis_circu
it_if_bind(circuit,ifp);returncircuit;}voidisis_circuit_af_set(structisis_circui
t*circuit,boolip_router,boolipv6_router){structisis_area*area=circuit->area;bool
change=circuit->ip_router!=ip_router||circuit->ipv6_router!=ipv6_router;area->ip
_circuits+=ip_router-circuit->ip_router;area->ipv6_circuits+=ipv6_router-circuit
->ipv6_router;circuit->ip_router=ip_router;circuit->ipv6_router=ipv6_router;if(!
change)return;circuit_update_nlpids(circuit);if(!ip_router&&!ipv6_router)isis_cs
m_state_change(ISIS_DISABLE,circuit,area);elselsp_regenerate_schedule(circuit->a
rea,circuit->is_type,0);}ferr_risis_circuit_passive_set(structisis_circuit*circu
it,boolpassive){if(circuit->is_passive==passive)returnferr_ok();if(if_is_loopbac
k(circuit->interface)&&!passive)returnferr_cfg_invalid("loopbackisalwayspassive"
);if(circuit->state!=C_STATE_UP){circuit->is_passive=passive;}else{structisis_ar
ea*area=circuit->area;isis_csm_state_change(ISIS_DISABLE,circuit,area);circuit->
is_passive=passive;isis_csm_state_change(ISIS_ENABLE,circuit,area);}returnferr_o
k();}ferr_risis_circuit_metric_set(structisis_circuit*circuit,intlevel,intmetric
){assert(level==IS_LEVEL_1||level==IS_LEVEL_2);if(metric>MAX_WIDE_LINK_METRIC)re
turnferr_cfg_invalid("metric%dtoolargeforwidemetric",metric);if(circuit->area&&c
ircuit->area->oldmetric&&metric>MAX_NARROW_LINK_METRIC)returnferr_cfg_invalid("m
etric%dtoolargefornarrowmetric",metric);circuit->te_metric[level-1]=metric;circu
it->metric[level-1]=metric;if(circuit->area)lsp_regenerate_schedule(circuit->are
a,level,0);returnferr_ok();}ferr_risis_circuit_passwd_unset(structisis_circuit*c
ircuit){memset(&circuit->passwd,0,sizeof(circuit->passwd));returnferr_ok();}stat
icintisis_circuit_passwd_set(structisis_circuit*circuit,uint8_tpasswd_type,const
char*passwd){intlen;if(!passwd)returnferr_code_bug("nocircuitpasswordgiven");len
=strlen(passwd);if(len>254)returnferr_code_bug("circuitpasswordtoolong(max254cha
rs)");circuit->passwd.len=len;strncpy((char*)circuit->passwd.passwd,passwd,255);
circuit->passwd.type=passwd_type;returnferr_ok();}ferr_risis_circuit_passwd_clea
rtext_set(structisis_circuit*circuit,constchar*passwd){returnisis_circuit_passwd
_set(circuit,ISIS_PASSWD_TYPE_CLEARTXT,passwd);}ferr_risis_circuit_passwd_hmac_m
d5_set(structisis_circuit*circuit,constchar*passwd){returnisis_circuit_passwd_se
t(circuit,ISIS_PASSWD_TYPE_HMAC_MD5,passwd);}structcmd_nodeinterface_node={INTER
FACE_NODE,"%s(config-if)#",1,};ferr_risis_circuit_circ_type_set(structisis_circu
it*circuit,intcirc_type){if(circuit->circ_type==circ_type)returnferr_ok();/*Chan
gingthenetworktypeto/ofloopbackorunknowninterfaces*isnotsupported.*/if(circ_type
==CIRCUIT_T_UNKNOWN||circ_type==CIRCUIT_T_LOOPBACK||circuit->circ_type==CIRCUIT_
T_LOOPBACK){returnferr_cfg_invalid("cannotchangenetworktypeonunknowninterface");
}if(circuit->state!=C_STATE_UP){circuit->circ_type=circ_type;circuit->circ_type_
config=circ_type;}else{structisis_area*area=circuit->area;if(circ_type==CIRCUIT_
T_BROADCAST&&!if_is_broadcast(circuit->interface))returnferr_cfg_reality("cannot
configurenon-broadcastinterfaceforbroadcastoperation");isis_csm_state_change(ISI
S_DISABLE,circuit,area);circuit->circ_type=circ_type;circuit->circ_type_config=c
irc_type;isis_csm_state_change(ISIS_ENABLE,circuit,area);}returnferr_ok();}intis
is_circuit_mt_enabled_set(structisis_circuit*circuit,uint16_tmtid,boolenabled){s
tructisis_circuit_mt_setting*setting;setting=circuit_get_mt_setting(circuit,mtid
);if(setting->enabled!=enabled){setting->enabled=enabled;lsp_regenerate_schedule
(circuit->area,IS_LEVEL_1|IS_LEVEL_2,0);}returnCMD_SUCCESS;}intisis_if_new_hook(
structinterface*ifp){return0;}intisis_if_delete_hook(structinterface*ifp){struct
isis_circuit*circuit;/*Cleanupthecircuitdata*/if(ifp&&ifp->info){circuit=ifp->in
fo;isis_csm_state_change(IF_DOWN_FROM_Z,circuit,circuit->area);isis_csm_state_ch
ange(ISIS_DISABLE,circuit,circuit->area);}return0;}voidisis_circuit_init(){/*Ini
tializeZebrainterfacedatastructure*/hook_register_prio(if_add,0,isis_if_new_hook
);hook_register_prio(if_del,0,isis_if_delete_hook);/*Installinterfacenode*/insta
ll_node(&interface_node,isis_interface_config_write);if_cmd_init();isis_vty_init
();}voidisis_circuit_schedule_lsp_send(structisis_circuit*circuit){if(circuit->t
_send_lsp)return;circuit->t_send_lsp=thread_add_event(master,send_lsp,circuit,0,
NULL);}voidisis_circuit_queue_lsp(structisis_circuit*circuit,structisis_lsp*lsp)
{if(isis_lsp_hash_lookup(circuit->lsp_hash,lsp))return;listnode_add(circuit->lsp
_queue,lsp);isis_lsp_hash_add(circuit->lsp_hash,lsp);isis_circuit_schedule_lsp_s
end(circuit);}voidisis_circuit_lsp_queue_clean(structisis_circuit*circuit){if(!c
ircuit->lsp_queue)return;list_delete_all_node(circuit->lsp_queue);isis_lsp_hash_
clean(circuit->lsp_hash);}voidisis_circuit_cancel_queued_lsp(structisis_circuit*
circuit,structisis_lsp*lsp){if(!circuit->lsp_queue)return;listnode_delete(circui
t->lsp_queue,lsp);isis_lsp_hash_release(circuit->lsp_hash,lsp);}structisis_lsp*i
sis_circuit_lsp_queue_pop(structisis_circuit*circuit){if(!circuit->lsp_queue)ret
urnNULL;structlistnode*node=listhead(circuit->lsp_queue);if(!node)returnNULL;str
uctisis_lsp*rv=listgetdata(node);list_delete_node(circuit->lsp_queue,node);isis_
lsp_hash_release(circuit->lsp_hash,rv);returnrv;}