/**IS-ISRout(e)ingprotocol-isis_pdu.c*PDUprocessing**Copyright(C)2001,2002SampoS
aaristo*TampereUniversityofTechnology*InstituteofCommunicationsEngineering**This
programisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGe
neralPublicLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLic
ense,or(atyouroption)*anylaterversion.**Thisprogramisdistributedinthehopethatitw
illbeuseful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILIT
Yor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**
YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seet
hefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFlo
or,Boston,MA02110-1301USA*/#include<zebra.h>#include"memory.h"#include"thread.h"
#include"linklist.h"#include"log.h"#include"stream.h"#include"vty.h"#include"has
h.h"#include"prefix.h"#include"if.h"#include"checksum.h"#include"md5.h"#include"
isisd/dict.h"#include"isisd/isis_constants.h"#include"isisd/isis_common.h"#inclu
de"isisd/isis_flags.h"#include"isisd/isis_adjacency.h"#include"isisd/isis_circui
t.h"#include"isisd/isis_network.h"#include"isisd/isis_misc.h"#include"isisd/isis
_dr.h"#include"isisd/isisd.h"#include"isisd/isis_dynhn.h"#include"isisd/isis_lsp
.h"#include"isisd/isis_pdu.h"#include"isisd/iso_checksum.h"#include"isisd/isis_c
sm.h"#include"isisd/isis_events.h"#include"isisd/isis_te.h"#include"isisd/isis_m
t.h"#include"isisd/isis_tlvs.h"staticintack_lsp(structisis_lsp_hdr*hdr,structisi
s_circuit*circuit,intlevel){unsignedlonglenp;intretval;uint16_tlength;uint8_tpdu
_type=(level==IS_LEVEL_1)?L1_PARTIAL_SEQ_NUM:L2_PARTIAL_SEQ_NUM;isis_circuit_str
eam(circuit,&circuit->snd_stream);fill_fixed_hdr(pdu_type,circuit->snd_stream);l
enp=stream_get_endp(circuit->snd_stream);stream_putw(circuit->snd_stream,0);/*PD
Ulength*/stream_put(circuit->snd_stream,isis->sysid,ISIS_SYS_ID_LEN);stream_putc
(circuit->snd_stream,circuit->idx);stream_putc(circuit->snd_stream,9);/*code*/st
ream_putc(circuit->snd_stream,16);/*len*/stream_putw(circuit->snd_stream,hdr->re
m_lifetime);stream_put(circuit->snd_stream,hdr->lsp_id,ISIS_SYS_ID_LEN+2);stream
_putl(circuit->snd_stream,hdr->seqno);stream_putw(circuit->snd_stream,hdr->check
sum);length=(uint16_t)stream_get_endp(circuit->snd_stream);/*UpdatePDUlength*/st
ream_putw_at(circuit->snd_stream,lenp,length);retval=circuit->tx(circuit,level);
if(retval!=ISIS_OK)zlog_err("ISIS-Upd(%s):SendL%dLSPPSNPon%sfailed",circuit->are
a->area_tag,level,circuit->interface->name);returnretval;}/**RECEIVESIDE*/struct
iih_info{structisis_circuit*circuit;uint8_t*ssnpa;intlevel;uint8_tcirc_type;uint
8_tsys_id[ISIS_SYS_ID_LEN];uint16_tholdtime;uint16_tpdu_len;uint8_tcircuit_id;ui
nt8_tpriority;uint8_tdis[ISIS_SYS_ID_LEN+1];boolv4_usable;boolv6_usable;structis
is_tlvs*tlvs;};staticintprocess_p2p_hello(structiih_info*iih){structisis_threewa
y_adj*tw_adj=iih->tlvs->threeway_adj;if(tw_adj){if(tw_adj->state>ISIS_THREEWAY_D
OWN){if(isis->debugs&DEBUG_ADJ_PACKETS){zlog_debug("ISIS-Adj(%s):RcvdP2PIIHfrom(
%s)withinvalidthree-waystate:%d\n",iih->circuit->area->area_tag,iih->circuit->in
terface->name,tw_adj->state);}returnISIS_WARNING;}if(tw_adj->neighbor_set&&(memc
mp(tw_adj->neighbor_id,isis->sysid,ISIS_SYS_ID_LEN)||tw_adj->neighbor_circuit_id
!=(uint32_t)iih->circuit->idx)){if(isis->debugs&DEBUG_ADJ_PACKETS){zlog_debug("I
SIS-Adj(%s):RcvdP2PIIHfrom(%s)whichlistsIS/Circuitdifferentfromusasneighbor.\n",
iih->circuit->area->area_tag,iih->circuit->interface->name);}returnISIS_WARNING;
}}/**MyinterpertationoftheISO,ifnoadjexistswewillcreateonefor*thecircuit*/struct
isis_adjacency*adj=iih->circuit->u.p2p.neighbor;/*Ifanadjacencyexists,checkitisw
iththesourceofthehello*packets*/if(adj){if(memcmp(iih->sys_id,adj->sysid,ISIS_SY
S_ID_LEN)){zlog_debug("hellosourceandadjacencydonotmatch,setadjdown\n");isis_adj
_state_change(adj,ISIS_ADJ_DOWN,"adjdonotexist");returnISIS_OK;}}if(!adj||adj->l
evel!=iih->circ_type){if(!adj){adj=isis_new_adj(iih->sys_id,NULL,iih->circ_type,
iih->circuit);}else{adj->level=iih->circ_type;}iih->circuit->u.p2p.neighbor=adj;
/*Buildlspwiththenewneighborentrywhenanew*adjacencyisformed.Setadjacencycircuitt
ypeto*IIHPDUheadercircuittypebeforelspisregenerated*whenanadjacencyisup.Thiswill
resultinthenew*adjacencyentrygettingaddedtothelsptlvneighborlist.*/adj->circuit_
t=iih->circ_type;isis_adj_state_change(adj,ISIS_ADJ_INITIALIZING,NULL);adj->sys_
type=ISIS_SYSTYPE_UNKNOWN;}if(tw_adj&&adj->threeway_state==ISIS_THREEWAY_DOWN)ad
j->ext_circuit_id=tw_adj->local_circuit_id;/*8.2.6Monitoringpoint-to-pointadjace
ncies*/adj->hold_time=iih->holdtime;adj->last_upd=time(NULL);boolchanged;isis_tl
vs_to_adj(iih->tlvs,adj,&changed);changed|=tlvs_to_adj_mt_set(iih->tlvs,iih->v4_
usable,iih->v6_usable,adj);/*UpdateMPLSTERemoteIPaddressparameterifpossible*/if(
IS_MPLS_TE(isisMplsTE)&&iih->circuit->mtc&&IS_CIRCUIT_TE(iih->circuit->mtc)&&adj
->ipv4_address_count)set_circuitparams_rmt_ipaddr(iih->circuit->mtc,adj->ipv4_ad
dresses[0]);/*letstakecareoftheexpiry*/THREAD_TIMER_OFF(adj->t_expire);thread_ad
d_timer(master,isis_adj_expire,adj,(long)adj->hold_time,&adj->t_expire);/*8.2.5.
2a)amatchwasdetected*/if(isis_tlvs_area_addresses_match(iih->tlvs,iih->circuit->
area->area_addrs)){/*8.2.5.2a)2)IfthesystemisL1-table5*/if(iih->circuit->area->i
s_type==IS_LEVEL_1){switch(iih->circ_type){caseIS_LEVEL_1:caseIS_LEVEL_1_AND_2:i
f(adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISIS_ADJ_LEVEL1){isis_adj_process
_threeway(adj,tw_adj,ISIS_ADJ_LEVEL1);}break;caseIS_LEVEL_2:if(adj->adj_state!=I
SIS_ADJ_UP){/*(7)reject-wrongsystemtypeevent*/zlog_warn("wrongSystemType");retur
nISIS_WARNING;}elseif(adj->adj_usage==ISIS_ADJ_LEVEL1){/*(6)down-wrongsystem*/is
is_adj_state_change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;}}/*8.2.5.2a)3)Ifthe
systemisL1L2-table6*/if(iih->circuit->area->is_type==IS_LEVEL_1_AND_2){switch(ii
h->circ_type){caseIS_LEVEL_1:if(adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISI
S_ADJ_LEVEL1){isis_adj_process_threeway(adj,tw_adj,ISIS_ADJ_LEVEL1);}elseif((adj
->adj_usage==ISIS_ADJ_LEVEL1AND2)||(adj->adj_usage==ISIS_ADJ_LEVEL2)){/*(8)down-
wrongsystem*/isis_adj_state_change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;caseI
S_LEVEL_2:if(adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISIS_ADJ_LEVEL2){isis_
adj_process_threeway(adj,tw_adj,ISIS_ADJ_LEVEL2);}elseif((adj->adj_usage==ISIS_A
DJ_LEVEL1)||(adj->adj_usage==ISIS_ADJ_LEVEL1AND2)){/*(8)down-wrongsystem*/isis_a
dj_state_change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;caseIS_LEVEL_1_AND_2:if(
adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISIS_ADJ_LEVEL1AND2){isis_adj_proce
ss_threeway(adj,tw_adj,ISIS_ADJ_LEVEL1AND2);}elseif((adj->adj_usage==ISIS_ADJ_LE
VEL1)||(adj->adj_usage==ISIS_ADJ_LEVEL2)){/*(8)down-wrongsystem*/isis_adj_state_
change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;}}/*8.2.5.2a)4)IfthesystemisL2-ta
ble7*/if(iih->circuit->area->is_type==IS_LEVEL_2){switch(iih->circ_type){caseIS_
LEVEL_1:if(adj->adj_state!=ISIS_ADJ_UP){/*(5)reject-wrongsystemtypeevent*/zlog_w
arn("wrongSystemType");returnISIS_WARNING;}elseif((adj->adj_usage==ISIS_ADJ_LEVE
L1AND2)||(adj->adj_usage==ISIS_ADJ_LEVEL2)){/*(6)down-wrongsystem*/isis_adj_stat
e_change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;caseIS_LEVEL_1_AND_2:caseIS_LEV
EL_2:if(adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISIS_ADJ_LEVEL2){isis_adj_p
rocess_threeway(adj,tw_adj,ISIS_ADJ_LEVEL2);}elseif(adj->adj_usage==ISIS_ADJ_LEV
EL1AND2){/*(6)down-wrongsystem*/isis_adj_state_change(adj,ISIS_ADJ_DOWN,"WrongSy
stem");}break;}}}/*8.2.5.2b)ifnomatchwasdetected*/elseif(listcount(iih->circuit-
>area->area_addrs)>0){if(iih->circuit->area->is_type==IS_LEVEL_1){/*8.2.5.2b)1)i
s_typeL1andadjisnotup*/if(adj->adj_state!=ISIS_ADJ_UP){isis_adj_state_change(adj
,ISIS_ADJ_DOWN,"AreaMismatch");/*8.2.5.2b)2)is_typeL1andadjisup*/}else{isis_adj_
state_change(adj,ISIS_ADJ_DOWN,"Down-AreaMismatch");}}/*8.2.5.2b3IfthesystemisL2
orL1L2-table8*/else{switch(iih->circ_type){caseIS_LEVEL_1:if(adj->adj_state!=ISI
S_ADJ_UP){/*(6)reject-AreaMismatchevent*/zlog_warn("AreaMismatch");returnISIS_WA
RNING;}elseif(adj->adj_usage==ISIS_ADJ_LEVEL1){/*(7)down-areamismatch*/isis_adj_
state_change(adj,ISIS_ADJ_DOWN,"AreaMismatch");}elseif((adj->adj_usage==ISIS_ADJ
_LEVEL1AND2)||(adj->adj_usage==ISIS_ADJ_LEVEL2)){/*(7)down-wrongsystem*/isis_adj
_state_change(adj,ISIS_ADJ_DOWN,"WrongSystem");}break;caseIS_LEVEL_1_AND_2:caseI
S_LEVEL_2:if(adj->adj_state!=ISIS_ADJ_UP||adj->adj_usage==ISIS_ADJ_LEVEL2){isis_
adj_process_threeway(adj,tw_adj,ISIS_ADJ_LEVEL2);}elseif(adj->adj_usage==ISIS_AD
J_LEVEL1){/*(7)down-wrongsystem*/isis_adj_state_change(adj,ISIS_ADJ_DOWN,"WrongS
ystem");}elseif(adj->adj_usage==ISIS_ADJ_LEVEL1AND2){if(iih->circ_type==IS_LEVEL
_2){/*(7)down-wrongsystem*/isis_adj_state_change(adj,ISIS_ADJ_DOWN,"WrongSystem"
);}else{/*(7)down-areamismatch*/isis_adj_state_change(adj,ISIS_ADJ_DOWN,"AreaMis
match");}}break;}}}else{/*down-areamismatch*/isis_adj_state_change(adj,ISIS_ADJ_
DOWN,"AreaMismatch");}if(adj->adj_state==ISIS_ADJ_UP&&changed){lsp_regenerate_sc
hedule(adj->circuit->area,isis_adj_usage2levels(adj->adj_usage),0);}/*8.2.5.2c)i
ftheactionwasup-comparingcircuitIDs*//*FIXME-Missingparts*//*someofmyownundersta
ndingoftheISO,whytheheckdoes*itnotsaywhatshouldIchangethesystem_typeto...*/switc
h(adj->adj_usage){caseISIS_ADJ_LEVEL1:adj->sys_type=ISIS_SYSTYPE_L1_IS;break;cas
eISIS_ADJ_LEVEL2:adj->sys_type=ISIS_SYSTYPE_L2_IS;break;caseISIS_ADJ_LEVEL1AND2:
adj->sys_type=ISIS_SYSTYPE_L2_IS;break;caseISIS_ADJ_NONE:adj->sys_type=ISIS_SYST
YPE_UNKNOWN;break;}if(isis->debugs&DEBUG_ADJ_PACKETS){zlog_debug("ISIS-Adj(%s):R
cvdP2PIIHfrom(%s),cirtype%s,""cirid%hhu,length%"PRIu16,iih->circuit->area->area_
tag,iih->circuit->interface->name,circuit_t2string(iih->circuit->is_type),iih->c
ircuit->circuit_id,iih->pdu_len);}returnISIS_OK;}staticintprocess_lan_hello(stru
ctiih_info*iih){structisis_adjacency*adj;adj=isis_adj_lookup(iih->sys_id,iih->ci
rcuit->u.bc.adjdb[iih->level-1]);if((adj==NULL)||(memcmp(adj->snpa,iih->ssnpa,ET
H_ALEN))||(adj->level!=iih->level)){if(!adj){/*Doasin8.4.2.5*/adj=isis_new_adj(i
ih->sys_id,iih->ssnpa,iih->level,iih->circuit);}else{if(iih->ssnpa){memcpy(adj->
snpa,iih->ssnpa,6);}else{memset(adj->snpa,'',6);}adj->level=iih->level;}isis_adj
_state_change(adj,ISIS_ADJ_INITIALIZING,NULL);if(iih->level==IS_LEVEL_1)adj->sys
_type=ISIS_SYSTYPE_L1_IS;elseadj->sys_type=ISIS_SYSTYPE_L2_IS;list_delete_all_no
de(iih->circuit->u.bc.lan_neighs[iih->level-1]);isis_adj_build_neigh_list(iih->c
ircuit->u.bc.adjdb[iih->level-1],iih->circuit->u.bc.lan_neighs[iih->level-1]);}i
f(adj->dis_record[iih->level-1].dis==ISIS_IS_DIS){uint8_t*dis=(iih->level==1)?ii
h->circuit->u.bc.l1_desig_is:iih->circuit->u.bc.l2_desig_is;if(memcmp(dis,iih->d
is,ISIS_SYS_ID_LEN+1)){thread_add_event(master,isis_event_dis_status_change,iih-
>circuit,0,NULL);memcpy(dis,iih->dis,ISIS_SYS_ID_LEN+1);}}adj->circuit_t=iih->ci
rc_type;adj->hold_time=iih->holdtime;adj->last_upd=time(NULL);adj->prio[iih->lev
el-1]=iih->priority;memcpy(adj->lanid,iih->dis,ISIS_SYS_ID_LEN+1);boolchanged;is
is_tlvs_to_adj(iih->tlvs,adj,&changed);changed|=tlvs_to_adj_mt_set(iih->tlvs,iih
->v4_usable,iih->v6_usable,adj);/*letstakecareoftheexpiry*/THREAD_TIMER_OFF(adj-
>t_expire);thread_add_timer(master,isis_adj_expire,adj,(long)adj->hold_time,&adj
->t_expire);/**IfthesnpaforthiscircuitisfoundfromLANNeighboursTLV*wehavetwo-wayc
ommunication->adjacencycanbeputtostate"up"*/boolown_snpa_found=isis_tlvs_own_snp
a_found(iih->tlvs,iih->circuit->u.bc.snpa);if(adj->adj_state!=ISIS_ADJ_UP){if(ow
n_snpa_found){isis_adj_state_change(adj,ISIS_ADJ_UP,"ownSNPAfoundinLANNeighbours
TLV");}}else{if(!own_snpa_found){isis_adj_state_change(adj,ISIS_ADJ_INITIALIZING
,"ownSNPAnotfoundinLANNeighboursTLV");}}if(adj->adj_state==ISIS_ADJ_UP&&changed)
lsp_regenerate_schedule(adj->circuit->area,iih->level,0);if(isis->debugs&DEBUG_A
DJ_PACKETS){zlog_debug("ISIS-Adj(%s):RcvdL%dLANIIHfrom%son%s,cirType%s,cirID%u,l
ength%zd",iih->circuit->area->area_tag,iih->level,snpa_print(iih->ssnpa),iih->ci
rcuit->interface->name,circuit_t2string(iih->circuit->is_type),iih->circuit->cir
cuit_id,stream_get_endp(iih->circuit->rcv_stream));}returnISIS_OK;}staticintpdu_
len_validate(uint16_tpdu_len,structisis_circuit*circuit){if(pdu_len<stream_get_g
etp(circuit->rcv_stream)||pdu_len>ISO_MTU(circuit)||pdu_len>stream_get_endp(circ
uit->rcv_stream))return1;if(pdu_len<stream_get_endp(circuit->rcv_stream))stream_
set_endp(circuit->rcv_stream,pdu_len);return0;}staticintprocess_hello(uint8_tpdu
_type,structisis_circuit*circuit,uint8_t*ssnpa){boolp2p_hello=(pdu_type==P2P_HEL
LO);intlevel=p2p_hello?0:(pdu_type==L1_LAN_HELLO)?ISIS_LEVEL1:ISIS_LEVEL2;constc
har*pdu_name=p2p_hello?"P2PIIH":(level==ISIS_LEVEL1)?"L1LANIIH":"L2LANIIH";if(is
is->debugs&DEBUG_ADJ_PACKETS){zlog_debug("ISIS-Adj(%s):Rcvd%son%s,cirType%s,cirI
D%u",circuit->area->area_tag,pdu_name,circuit->interface->name,circuit_t2string(
circuit->is_type),circuit->circuit_id);if(isis->debugs&DEBUG_PACKET_DUMP)zlog_du
mp_data(STREAM_DATA(circuit->rcv_stream),stream_get_endp(circuit->rcv_stream));}
if(p2p_hello){if(circuit->circ_type!=CIRCUIT_T_P2P){zlog_warn("p2phelloonnonp2pc
ircuit");returnISIS_WARNING;}}else{if(circuit->circ_type!=CIRCUIT_T_BROADCAST){z
log_warn("lanhelloonnonbroadcastcircuit");returnISIS_WARNING;}if(circuit->ext_do
main){zlog_debug("level%dLANHelloreceivedovercircuitwithexternalDomain=true",lev
el);returnISIS_WARNING;}if(!(circuit->is_type&level)){if(isis->debugs&DEBUG_ADJ_
PACKETS){zlog_debug("ISIS-Adj(%s):Interfacelevelmismatch,%s",circuit->area->area
_tag,circuit->interface->name);}returnISIS_WARNING;}}structiih_infoiih={.circuit
=circuit,.ssnpa=ssnpa,.level=level};/*GenericIIHHeader*/iih.circ_type=stream_get
c(circuit->rcv_stream)&0x03;stream_get(iih.sys_id,circuit->rcv_stream,ISIS_SYS_I
D_LEN);iih.holdtime=stream_getw(circuit->rcv_stream);iih.pdu_len=stream_getw(cir
cuit->rcv_stream);if(p2p_hello){iih.circuit_id=stream_getc(circuit->rcv_stream);
}else{iih.priority=stream_getc(circuit->rcv_stream);stream_get(iih.dis,circuit->
rcv_stream,ISIS_SYS_ID_LEN+1);}if(pdu_len_validate(iih.pdu_len,circuit)){zlog_wa
rn("ISIS-Adj(%s):Rcvd%sfrom(%s)withinvalidpdulength%"PRIu16,circuit->area->area_
tag,pdu_name,circuit->interface->name,iih.pdu_len);returnISIS_WARNING;}if(!p2p_h
ello&&!(level&iih.circ_type)){zlog_err("Level%dLANHellowithCircuitType%d",level,
iih.circ_type);returnISIS_ERROR;}constchar*error_log;intretval=ISIS_WARNING;if(i
sis_unpack_tlvs(STREAM_READABLE(circuit->rcv_stream),circuit->rcv_stream,&iih.tl
vs,&error_log)){zlog_warn("isis_unpack_tlvs()failed:%s",error_log);gotoout;}if(!
iih.tlvs->area_addresses.count){zlog_warn("NoAreaaddressesTLVin%s",pdu_name);got
oout;}if(!iih.tlvs->protocols_supported.count){zlog_warn("NosupportedprotocolsTL
Vin%s",pdu_name);gotoout;}if(!isis_tlvs_auth_is_valid(iih.tlvs,&circuit->passwd,
circuit->rcv_stream,false)){isis_event_auth_failure(circuit->area->area_tag,"IIH
authenticationfailure",iih.sys_id);gotoout;}if(!memcmp(iih.sys_id,isis->sysid,IS
IS_SYS_ID_LEN)){zlog_warn("ISIS-Adj(%s):ReceivedIIHwithownsysid-discard",circuit
->area->area_tag);gotoout;}if(!p2p_hello&&(listcount(circuit->area->area_addrs)=
=0||(level==ISIS_LEVEL1&&!isis_tlvs_area_addresses_match(iih.tlvs,circuit->area-
>area_addrs)))){if(isis->debugs&DEBUG_ADJ_PACKETS){zlog_debug("ISIS-Adj(%s):Area
mismatch,level%dIIHon%s",circuit->area->area_tag,level,circuit->interface->name)
;}gotoout;}iih.v4_usable=(circuit->ip_addrs&&listcount(circuit->ip_addrs)&&iih.t
lvs->ipv4_address.count);iih.v6_usable=(circuit->ipv6_link&&listcount(circuit->i
pv6_link)&&iih.tlvs->ipv6_address.count);if(!iih.v4_usable&&!iih.v6_usable)gotoo
ut;retval=p2p_hello?process_p2p_hello(&iih):process_lan_hello(&iih);out:isis_fre
e_tlvs(iih.tlvs);returnretval;}/**ProcessLevel1/2LinkState*ISO-10589*Section7.3.
15.1-ActiononreceiptofalinkstatePDU*/staticintprocess_lsp(uint8_tpdu_type,struct
isis_circuit*circuit,constuint8_t*ssnpa){intlevel=(pdu_type==L1_LINK_STATE)?ISIS
_LEVEL1:ISIS_LEVEL2;if(isis->debugs&DEBUG_UPDATE_PACKETS){zlog_debug("ISIS-Upd(%
s):RcvdL%dLSPon%s,cirType%s,cirID%u",circuit->area->area_tag,level,circuit->inte
rface->name,circuit_t2string(circuit->is_type),circuit->circuit_id);if(isis->deb
ugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circuit->rcv_stream),stream_get
_endp(circuit->rcv_stream));}structisis_lsp_hdrhdr={};hdr.pdu_len=stream_getw(ci
rcuit->rcv_stream);hdr.rem_lifetime=stream_getw(circuit->rcv_stream);stream_get(
hdr.lsp_id,circuit->rcv_stream,sizeof(hdr.lsp_id));hdr.seqno=stream_getl(circuit
->rcv_stream);hdr.checksum=stream_getw(circuit->rcv_stream);hdr.lsp_bits=stream_
getc(circuit->rcv_stream);if(pdu_len_validate(hdr.pdu_len,circuit)){zlog_debug("
ISIS-Upd(%s):LSP%sinvalidLSPlength%"PRIu16,circuit->area->area_tag,rawlspid_prin
t(hdr.lsp_id),hdr.pdu_len);returnISIS_WARNING;}if(isis->debugs&DEBUG_UPDATE_PACK
ETS){zlog_debug("ISIS-Upd(%s):RcvdL%dLSP%s,seq0x%08"PRIx32",cksum0x%04"PRIx16",l
ifetime%"PRIu16"s,len%"PRIu16",on%s",circuit->area->area_tag,level,rawlspid_prin
t(hdr.lsp_id),hdr.seqno,hdr.checksum,hdr.rem_lifetime,hdr.pdu_len,circuit->inter
face->name);}/*lspis_typecheck*/if((hdr.lsp_bits&IS_LEVEL_1)!=IS_LEVEL_1){zlog_d
ebug("ISIS-Upd(%s):LSP%sinvalidLSPistype0x%"PRIx8,circuit->area->area_tag,rawlsp
id_print(hdr.lsp_id),hdr.lsp_bits&IS_LEVEL_1_AND_2);/*continueasperRFC1122Belibe
ralinwhatyouaccept,and*conservativeinwhatyousend*/}/*Checksumsanitycheck-FIXME:m
ovetocorrectplace*//*12=sysid+pdu+remtime*/if(iso_csum_verify(STREAM_DATA(circui
t->rcv_stream)+12,hdr.pdu_len-12,hdr.checksum,12)){zlog_debug("ISIS-Upd(%s):LSP%
sinvalidLSPchecksum0x%04"PRIx16,circuit->area->area_tag,rawlspid_print(hdr.lsp_i
d),hdr.checksum);returnISIS_WARNING;}/*7.3.15.1a)1-externaldomaincircuitwilldisc
ardlsps*/if(circuit->ext_domain){zlog_debug("ISIS-Upd(%s):LSP%sreceivedatlevel%d
overcircuitwith""externalDomain=true",circuit->area->area_tag,rawlspid_print(hdr
.lsp_id),level);returnISIS_WARNING;}/*7.3.15.1a)2,3-manualL2OnlyModenotimplement
ed*/if(!(circuit->is_type&level)){zlog_debug("ISIS-Upd(%s):LSP%sreceivedatlevel%
dovercircuitof""type%s",circuit->area->area_tag,rawlspid_print(hdr.lsp_id),level
,circuit_t2string(circuit->is_type));returnISIS_WARNING;}structisis_tlvs*tlvs=NU
LL;intretval=ISIS_WARNING;constchar*error_log;if(isis_unpack_tlvs(STREAM_READABL
E(circuit->rcv_stream),circuit->rcv_stream,&tlvs,&error_log)){zlog_warn("Somethi
ngwentwrongunpackingtheLSP:%s",error_log);gotoout;}/*7.3.15.1a)4-needtomakesureI
DLengthmatches*//*7.3.15.1a)5-maximumareamatch,canbeommitedsinceweonlyuse*3*//*7
.3.15.1a)7-passwordcheck*/structisis_passwd*passwd=(level==ISIS_LEVEL1)?&circuit
->area->area_passwd:&circuit->area->domain_passwd;if(!isis_tlvs_auth_is_valid(tl
vs,passwd,circuit->rcv_stream,true)){isis_event_auth_failure(circuit->area->area
_tag,"LSPauthenticationfailure",hdr.lsp_id);gotoout;}/*FindtheLSPinourdatabasean
dcompareittothisLinkStateheader*/structisis_lsp*lsp=lsp_search(hdr.lsp_id,circui
t->area->lspdb[level-1]);intcomp=0;if(lsp)comp=lsp_compare(circuit->area->area_t
ag,lsp,hdr.seqno,hdr.checksum,hdr.rem_lifetime);if(lsp&&(lsp->own_lsp))gotodontc
heckadj;/*7.3.15.1a)6-Mustcheckthatwehaveanadjacencyofthesame*level*//*forbroadc
astcircuits,snpashouldbecompared*/if(circuit->circ_type==CIRCUIT_T_BROADCAST){if
(!isis_adj_lookup_snpa(ssnpa,circuit->u.bc.adjdb[level-1])){zlog_debug("(%s):DS=
======LSP%s,seq0x%08"PRIx32",cksum0x%04"PRIx16",lifetime%"PRIu16"son%s",circuit-
>area->area_tag,rawlspid_print(hdr.lsp_id),hdr.seqno,hdr.checksum,hdr.rem_lifeti
me,circuit->interface->name);gotoout;/*Silentlydiscard*/}}/*fornonbroadcast,weju
stneedtofindsameleveladj*/else{/*Ifnoadj,ornosharingoflevel*/if(!circuit->u.p2p.
neighbor){retval=ISIS_OK;gotoout;}else{if(((level==IS_LEVEL_1)&&(circuit->u.p2p.
neighbor->adj_usage==ISIS_ADJ_LEVEL2))||((level==IS_LEVEL_2)&&(circuit->u.p2p.ne
ighbor->adj_usage==ISIS_ADJ_LEVEL1)))gotoout;}}boollsp_confusion;dontcheckadj:/*
7.3.15.1a)7-Passwordsforlevel1-notimplemented*//*7.3.15.1a)8-Passwordsforlevel2-
notimplemented*//*7.3.15.1a)9-OriginatingLSPBufferSize-notimplementedFIXME:do*it
*//*7.3.16.2-IfthisisanLSPfromanotherISwithidenticalseq_num*but*wrongchecksum,in
itiateapurge.*/if(lsp&&(lsp->hdr.seqno==hdr.seqno)&&(lsp->hdr.checksum!=hdr.chec
ksum)){zlog_warn("ISIS-Upd(%s):LSP%sseq0x%08"PRIx32"withconfusedchecksumreceived
.",circuit->area->area_tag,rawlspid_print(hdr.lsp_id),hdr.seqno);hdr.rem_lifetim
e=0;lsp_confusion=true;}elselsp_confusion=false;/*7.3.15.1b)-Iftheremaininglifet
imeis0,weperform7.3.16.4*/if(hdr.rem_lifetime==0){if(!lsp){/*7.3.16.4a)1)NoLSPin
db->sendanack,butdon't*save*//*onlyneededonexplicitupdate,eg-p2p*/if(circuit->ci
rc_type==CIRCUIT_T_P2P)ack_lsp(&hdr,circuit,level);gotoout;/*FIXME:doweneedapurg
e?*/}else{if(memcmp(hdr.lsp_id,isis->sysid,ISIS_SYS_ID_LEN)){/*LSPbysomeothersys
tem->do7.3.16.4b)*//*7.3.16.4b)1)*/if(comp==LSP_NEWER){lsp_update(lsp,&hdr,tlvs,
circuit->rcv_stream,circuit->area,level,lsp_confusion);tlvs=NULL;/*ii*/lsp_set_a
ll_srmflags(lsp);/*v*/ISIS_FLAGS_CLEAR_ALL(lsp->SSNflags);/*FIXME:OTHERthanc*//*
Forthecaseoflspconfusion,flood*thepurgebacktoits*originatorsothatitcanreact.*Oth
erwise,don'treflood*throughincomingcircuitasusual*/if(!lsp_confusion){/*iii*/ISI
S_CLEAR_FLAG(lsp->SRMflags,circuit);/*iv*/if(circuit->circ_type!=CIRCUIT_T_BROAD
CAST)ISIS_SET_FLAG(lsp->SSNflags,circuit);}}/*7.3.16.4b)2)*/elseif(comp==LSP_EQU
AL){/*i*/ISIS_CLEAR_FLAG(lsp->SRMflags,circuit);/*ii*/if(circuit->circ_type!=CIR
CUIT_T_BROADCAST)ISIS_SET_FLAG(lsp->SSNflags,circuit);}/*7.3.16.4b)3)*/else{ISIS
_SET_FLAG(lsp->SRMflags,circuit);ISIS_CLEAR_FLAG(lsp->SSNflags,circuit);}}elseif
(lsp->hdr.rem_lifetime!=0){/*ourownLSP->7.3.16.4c)*/if(comp==LSP_NEWER){lsp_inc_
seqno(lsp,hdr.seqno);lsp_set_all_srmflags(lsp);}else{ISIS_SET_FLAG(lsp->SRMflags
,circuit);ISIS_CLEAR_FLAG(lsp->SSNflags,circuit);}if(isis->debugs&DEBUG_UPDATE_P
ACKETS)zlog_debug("ISIS-Upd(%s):(1)re-originatingLSP%snewseq0x%08"PRIx32,circuit
->area->area_tag,rawlspid_print(hdr.lsp_id),lsp->hdr.seqno);}}gotoout;}/*7.3.15.
1c)-Ifthisisourownlspandwedon'thaveitinitiatea*purge*/if(memcmp(hdr.lsp_id,isis-
>sysid,ISIS_SYS_ID_LEN)==0){if(!lsp){/*7.3.16.4:initiateapurge*/lsp_purge_non_ex
ist(level,&hdr,circuit->area);retval=ISIS_OK;gotoout;}/*7.3.15.1d)-Ifthisisourow
nlspandwehaveit*//*In7.3.16.1,IfanIntermediatesystemRsomewhereinthe*domain*hasin
formationthatthecurrentsequencenumberforsourceS*is*"greater"thanthatheldbyS,...*
/if(hdr.seqno>lsp->hdr.seqno){/*7.3.16.1*/lsp_inc_seqno(lsp,hdr.seqno);if(isis->
debugs&DEBUG_UPDATE_PACKETS)zlog_debug("ISIS-Upd(%s):(2)re-originatingLSP%snewse
q0x%08"PRIx32,circuit->area->area_tag,rawlspid_print(hdr.lsp_id),lsp->hdr.seqno)
;}/*IfthereceivedLSPisolderorequal,*resendtheLSPwhichwillactasACK*/lsp_set_all_s
rmflags(lsp);}else{/*7.3.15.1e)-Thislsporiginatedonanothersystem*//*7.3.15.1e)1)
LSPnewerthantheoneindbornoLSPindb*/if((!lsp||comp==LSP_NEWER)){/**Ifthislspisafr
ag,needtoseeifwehavezero*lsppresent*/structisis_lsp*lsp0=NULL;if(LSP_FRAGMENT(hd
r.lsp_id)!=0){uint8_tlspid[ISIS_SYS_ID_LEN+2];memcpy(lspid,hdr.lsp_id,ISIS_SYS_I
D_LEN+1);LSP_FRAGMENT(lspid)=0;lsp0=lsp_search(lspid,circuit->area->lspdb[level-
1]);if(!lsp0){zlog_debug("Gotlspfrag,whilezerolspnotindatabase");returnISIS_OK;}
}/*i*/if(!lsp){lsp=lsp_new_from_recv(&hdr,tlvs,circuit->rcv_stream,lsp0,circuit-
>area,level);tlvs=NULL;lsp_insert(lsp,circuit->area->lspdb[level-1]);}else/*exis
ts,soweoverwrite*/{lsp_update(lsp,&hdr,tlvs,circuit->rcv_stream,circuit->area,le
vel,false);tlvs=NULL;}/*ii*/lsp_set_all_srmflags(lsp);/*iii*/ISIS_CLEAR_FLAG(lsp
->SRMflags,circuit);/*iv*/if(circuit->circ_type!=CIRCUIT_T_BROADCAST)ISIS_SET_FL
AG(lsp->SSNflags,circuit);/*FIXME:v)*/}/*7.3.15.1e)2)LSPequaltotheoneindb*/elsei
f(comp==LSP_EQUAL){ISIS_CLEAR_FLAG(lsp->SRMflags,circuit);lsp_update(lsp,&hdr,tl
vs,circuit->rcv_stream,circuit->area,level,false);tlvs=NULL;if(circuit->circ_typ
e!=CIRCUIT_T_BROADCAST)ISIS_SET_FLAG(lsp->SSNflags,circuit);}/*7.3.15.1e)3)LSPol
derthantheoneindb*/else{ISIS_SET_FLAG(lsp->SRMflags,circuit);ISIS_CLEAR_FLAG(lsp
->SSNflags,circuit);}}retval=ISIS_OK;out:isis_free_tlvs(tlvs);returnretval;}/**P
rocessSequenceNumbers*ISO-10589*Section7.3.15.2-Actiononreceiptofasequencenumber
sPDU*/staticintprocess_snp(uint8_tpdu_type,structisis_circuit*circuit,constuint8
_t*ssnpa){boolis_csnp=(pdu_type==L1_COMPLETE_SEQ_NUM||pdu_type==L2_COMPLETE_SEQ_
NUM);chartypechar=is_csnp?'C':'P';intlevel=(pdu_type==L1_COMPLETE_SEQ_NUM||pdu_t
ype==L1_PARTIAL_SEQ_NUM)?ISIS_LEVEL1:ISIS_LEVEL2;uint16_tpdu_len=stream_getw(cir
cuit->rcv_stream);uint8_trem_sys_id[ISIS_SYS_ID_LEN];stream_get(rem_sys_id,circu
it->rcv_stream,ISIS_SYS_ID_LEN);stream_forward_getp(circuit->rcv_stream,1);/*Cir
cuitID-unused*/uint8_tstart_lsp_id[ISIS_SYS_ID_LEN+2]={};uint8_tstop_lsp_id[ISIS
_SYS_ID_LEN+2]={};if(is_csnp){stream_get(start_lsp_id,circuit->rcv_stream,ISIS_S
YS_ID_LEN+2);stream_get(stop_lsp_id,circuit->rcv_stream,ISIS_SYS_ID_LEN+2);}if(p
du_len_validate(pdu_len,circuit)){zlog_warn("ReceivedaCSNPwithboguslength%d",pdu
_len);returnISIS_WARNING;}if(isis->debugs&DEBUG_SNP_PACKETS){zlog_debug("ISIS-Sn
p(%s):RcvdL%d%cSNPon%s,cirType%s,cirID%u",circuit->area->area_tag,level,typechar
,circuit->interface->name,circuit_t2string(circuit->is_type),circuit->circuit_id
);if(isis->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circuit->rcv_stre
am),stream_get_endp(circuit->rcv_stream));}/*7.3.15.2a)1-externaldomaincircuitwi
lldiscardsnppdu*/if(circuit->ext_domain){zlog_debug("ISIS-Snp(%s):RcvdL%d%cSNPon
%s,""skipping:circuitexternalDomain=true",circuit->area->area_tag,level,typechar
,circuit->interface->name);returnISIS_OK;}/*7.3.15.2a)2,3-manualL2OnlyModenotimp
lemented*/if(!(circuit->is_type&level)){zlog_debug("ISIS-Snp(%s):RcvdL%d%cSNPon%
s,""skipping:circuittype%sdoesnotmatchlevel%d",circuit->area->area_tag,level,typ
echar,circuit->interface->name,circuit_t2string(circuit->is_type),level);returnI
SIS_OK;}/*7.3.15.2a)4-notapplicableforCSNPonlyPSNPsonbroadcast*/if(!is_csnp&&(ci
rcuit->circ_type==CIRCUIT_T_BROADCAST)&&!circuit->u.bc.is_dr[level-1]){zlog_debu
g("ISIS-Snp(%s):RcvdL%d%cSNPfrom%son%s,""skipping:wearenottheDIS",circuit->area-
>area_tag,level,typechar,snpa_print(ssnpa),circuit->interface->name);returnISIS_
OK;}/*7.3.15.2a)5-needtomakesureIDLengthmatches-alreadychecked*//*7.3.15.2a)6-ma
ximumareamatch,canbeommitedsinceweonlyuse*3*-alreadychecked*//*7.3.15.2a)7-Mustc
heckthatwehaveanadjacencyofthesame*level*//*forbroadcastcircuits,snpashouldbecom
pared*//*FIXME:DoweneedtocheckSNPA?*/if(circuit->circ_type==CIRCUIT_T_BROADCAST)
{if(!isis_adj_lookup(rem_sys_id,circuit->u.bc.adjdb[level-1]))returnISIS_OK;/*Si
lentlydiscard*/}else{if(!circuit->u.p2p.neighbor){zlog_warn("nop2pneighboroncirc
uit%s",circuit->interface->name);returnISIS_OK;/*Silentlydiscard*/}}structisis_t
lvs*tlvs;intretval=ISIS_WARNING;constchar*error_log;if(isis_unpack_tlvs(STREAM_R
EADABLE(circuit->rcv_stream),circuit->rcv_stream,&tlvs,&error_log)){zlog_warn("S
omethingwentwrongunpackingtheSNP:%s",error_log);gotoout;}structisis_passwd*passw
d=(level==IS_LEVEL_1)?&circuit->area->area_passwd:&circuit->area->domain_passwd;
if(CHECK_FLAG(passwd->snp_auth,SNP_AUTH_RECV)&&!isis_tlvs_auth_is_valid(tlvs,pas
swd,circuit->rcv_stream,false)){isis_event_auth_failure(circuit->area->area_tag,
"SNPauthenticationfailure",rem_sys_id);gotoout;}structisis_lsp_entry*entry_head=
(structisis_lsp_entry*)tlvs->lsp_entries.head;/*debugisissnp-packets*/if(isis->d
ebugs&DEBUG_SNP_PACKETS){zlog_debug("ISIS-Snp(%s):RcvdL%d%cSNPfrom%son%s",circui
t->area->area_tag,level,typechar,snpa_print(ssnpa),circuit->interface->name);for
(structisis_lsp_entry*entry=entry_head;entry;entry=entry->next){zlog_debug("ISIS
-Snp(%s):%cSNPentry%s,seq0x%08"PRIx32",cksum0x%04"PRIx16",lifetime%"PRIu16"s",ci
rcuit->area->area_tag,typechar,rawlspid_print(entry->id),entry->seqno,entry->che
cksum,entry->rem_lifetime);}}/*7.3.15.2b)ActionsonLSP_ENTRIESreported*/for(struc
tisis_lsp_entry*entry=entry_head;entry;entry=entry->next){structisis_lsp*lsp=lsp
_search(entry->id,circuit->area->lspdb[level-1]);boolown_lsp=!memcmp(entry->id,i
sis->sysid,ISIS_SYS_ID_LEN);if(lsp){/*7.3.15.2b)1)isthisLSPnewer*/intcmp=lsp_com
pare(circuit->area->area_tag,lsp,entry->seqno,entry->checksum,entry->rem_lifetim
e);/*7.3.15.2b)2)ifitequals,clearSRMonp2p*/if(cmp==LSP_EQUAL){/*if(circuit->circ
_type!=*CIRCUIT_T_BROADCAST)*/ISIS_CLEAR_FLAG(lsp->SRMflags,circuit);}/*7.3.15.2
b)3)ifitisolder,clearSSNandsetSRM*/elseif(cmp==LSP_OLDER){ISIS_CLEAR_FLAG(lsp->S
SNflags,circuit);ISIS_SET_FLAG(lsp->SRMflags,circuit);}/*7.3.15.2b)4)ifitisnewer
,setSSNandclearSRMonp2p*/else{if(own_lsp){lsp_inc_seqno(lsp,entry->seqno);ISIS_S
ET_FLAG(lsp->SRMflags,circuit);}else{ISIS_SET_FLAG(lsp->SSNflags,circuit);/*if(c
ircuit->circ_type!=*CIRCUIT_T_BROADCAST)*/ISIS_CLEAR_FLAG(lsp->SRMflags,circuit)
;}}}else{/*7.3.15.2b)5)ifitwasnotfound,andallofthose*arenot0,*insertitandsetSSNo
nit*/if(entry->rem_lifetime&&entry->checksum&&entry->seqno&&memcmp(entry->id,isi
s->sysid,ISIS_SYS_ID_LEN)){structisis_lsp*lsp0=NULL;if(LSP_FRAGMENT(entry->id)){
uint8_tlspid[ISIS_SYS_ID_LEN+2];memcpy(lspid,entry->id,ISIS_SYS_ID_LEN+1);LSP_FR
AGMENT(lspid)=0;lsp0=lsp_search(lspid,circuit->area->lspdb[level-1]);if(!lsp0){z
log_debug("Gotlspfraginsnp,whilezeronotindatabase");continue;}}structisis_lsp*ls
p=lsp_new(circuit->area,entry->id,entry->rem_lifetime,0,0,entry->checksum,lsp0,l
evel);lsp_insert(lsp,circuit->area->lspdb[level-1]);ISIS_FLAGS_CLEAR_ALL(lsp->SR
Mflags);ISIS_SET_FLAG(lsp->SSNflags,circuit);}}}/*7.3.15.2c)onCSNPsetSRMforallin
rangewhichwerenotreported*/if(is_csnp){/**BuildalistfromourownLSPdbboundedwith*s
tart_lsp_idandstop_lsp_id*/structlist*lsp_list=list_new();lsp_build_list_nonzero
_ht(start_lsp_id,stop_lsp_id,lsp_list,circuit->area->lspdb[level-1]);/*Fixme:Fin
dabettersolution*/structlistnode*node,*nnode;structisis_lsp*lsp;for(structisis_l
sp_entry*entry=entry_head;entry;entry=entry->next){for(ALL_LIST_ELEMENTS(lsp_lis
t,node,nnode,lsp)){if(lsp_id_cmp(lsp->hdr.lsp_id,entry->id)==0){list_delete_node
(lsp_list,node);break;}}}/*onremainingLSPswesetSRM(neighborknewnotof)*/for(ALL_L
IST_ELEMENTS_RO(lsp_list,node,lsp))ISIS_SET_FLAG(lsp->SRMflags,circuit);/*letsfr
eeit*/list_delete_and_null(&lsp_list);}retval=ISIS_OK;out:isis_free_tlvs(tlvs);r
eturnretval;}staticintpdu_size(uint8_tpdu_type,uint8_t*size){switch(pdu_type){ca
seL1_LAN_HELLO:caseL2_LAN_HELLO:*size=ISIS_LANHELLO_HDRLEN;break;caseP2P_HELLO:*
size=ISIS_P2PHELLO_HDRLEN;break;caseL1_LINK_STATE:caseL2_LINK_STATE:*size=ISIS_L
SP_HDR_LEN;break;caseL1_COMPLETE_SEQ_NUM:caseL2_COMPLETE_SEQ_NUM:*size=ISIS_CSNP
_HDRLEN;break;caseL1_PARTIAL_SEQ_NUM:caseL2_PARTIAL_SEQ_NUM:*size=ISIS_PSNP_HDRL
EN;break;default:return1;}*size+=ISIS_FIXED_HDR_LEN;return0;}/**PDUDispatcher*/i
ntisis_handle_pdu(structisis_circuit*circuit,uint8_t*ssnpa){intretval=ISIS_OK;/*
Verifythatatleastthe8bytesfixedheaderhavebeenreceived*/if(stream_get_endp(circui
t->rcv_stream)<ISIS_FIXED_HDR_LEN){zlog_err("PDUistooshorttobeIS-IS.");returnISI
S_ERROR;}uint8_tidrp=stream_getc(circuit->rcv_stream);uint8_tlength=stream_getc(
circuit->rcv_stream);uint8_tversion1=stream_getc(circuit->rcv_stream);uint8_tid_
len=stream_getc(circuit->rcv_stream);uint8_tpdu_type=stream_getc(circuit->rcv_st
ream)&0x1f;/*bits6-8arereserved*/uint8_tversion2=stream_getc(circuit->rcv_stream
);stream_forward_getp(circuit->rcv_stream,1);/*reserved*/uint8_tmax_area_addrs=s
tream_getc(circuit->rcv_stream);if(idrp==ISO9542_ESIS){zlog_err("NosupportforES-
ISpacketIDRP=%"PRIx8,idrp);returnISIS_ERROR;}if(idrp!=ISO10589_ISIS){zlog_err("N
otanIS-ISpacketIDRP=%"PRIx8,idrp);returnISIS_ERROR;}if(version1!=1){zlog_warn("U
nsupportedISISversion%"PRIu8,version1);returnISIS_WARNING;}if(id_len!=0&&id_len!
=ISIS_SYS_ID_LEN){zlog_err("IDFieldLengthMismatch:IDLengthfieldinareceivedPDU%"P
RIu8",whiletheparameterforthisISis%u",id_len,ISIS_SYS_ID_LEN);returnISIS_ERROR;}
uint8_texpected_length;if(pdu_size(pdu_type,&expected_length)){zlog_warn("Unsupp
ortedISISPDU%"PRIu8,pdu_type);returnISIS_WARNING;}if(length!=expected_length){zl
og_err("Exepectedfixedheaderlength=%"PRIu8"butgot%"PRIu8,expected_length,length)
;returnISIS_ERROR;}if(stream_get_endp(circuit->rcv_stream)<length){zlog_err("PDU
istooshorttocontainfixedheaderofgivenPDUtype.");returnISIS_ERROR;}if(version2!=1
){zlog_warn("UnsupportedISISPDUversion%"PRIu8,version2);returnISIS_WARNING;}if(c
ircuit->is_passive){zlog_warn("ReceivedISISPDUonpassivecircuit%s",circuit->inter
face->name);returnISIS_WARNING;}/*either3or0*/if(max_area_addrs!=0&&max_area_add
rs!=isis->max_area_addrs){zlog_err("maximumAreaAddressesMismatch:maximumAreaAdre
ssesinareceivedPDU%"PRIu8"whiletheparameterforthisISis%u",max_area_addrs,isis->m
ax_area_addrs);returnISIS_ERROR;}switch(pdu_type){caseL1_LAN_HELLO:caseL2_LAN_HE
LLO:caseP2P_HELLO:retval=process_hello(pdu_type,circuit,ssnpa);break;caseL1_LINK
_STATE:caseL2_LINK_STATE:retval=process_lsp(pdu_type,circuit,ssnpa);break;caseL1
_COMPLETE_SEQ_NUM:caseL2_COMPLETE_SEQ_NUM:caseL1_PARTIAL_SEQ_NUM:caseL2_PARTIAL_
SEQ_NUM:retval=process_snp(pdu_type,circuit,ssnpa);break;default:returnISIS_ERRO
R;}returnretval;}intisis_receive(structthread*thread){structisis_circuit*circuit
;uint8_tssnpa[ETH_ALEN];intretval;/**Getthecircuit*/circuit=THREAD_ARG(thread);a
ssert(circuit);circuit->t_read=NULL;isis_circuit_stream(circuit,&circuit->rcv_st
ream);retval=circuit->rx(circuit,ssnpa);#ifISIS_METHOD!=ISIS_METHOD_BPFif(retval
==ISIS_OK)retval=isis_handle_pdu(circuit,ssnpa);#endif//ISIS_METHOD!=ISIS_METHOD
_BPF/**preparefornextpacket.*/if(!circuit->is_passive)isis_circuit_prepare(circu
it);returnretval;}/**SENDSIDE*/voidfill_fixed_hdr(uint8_tpdu_type,structstream*s
tream){uint8_tlength;if(pdu_size(pdu_type,&length))assert(!"UnknownPDUType");str
eam_putc(stream,ISO10589_ISIS);/*IDRP*/stream_putc(stream,length);/*Lengthoffixe
dheader*/stream_putc(stream,1);/*Version/ProtocolIDExtension1*/stream_putc(strea
m,0);/*IDLength,0=>6*/stream_putc(stream,pdu_type);stream_putc(stream,1);/*Subve
rsion*/stream_putc(stream,0);/*Reserved*/stream_putc(stream,0);/*MaxAreaAddresse
s0=>3*/}staticvoidput_hello_hdr(structisis_circuit*circuit,intlevel,size_t*len_p
ointer){uint8_tpdu_type;if(circuit->circ_type==CIRCUIT_T_BROADCAST)pdu_type=(lev
el==IS_LEVEL_1)?L1_LAN_HELLO:L2_LAN_HELLO;elsepdu_type=P2P_HELLO;isis_circuit_st
ream(circuit,&circuit->snd_stream);fill_fixed_hdr(pdu_type,circuit->snd_stream);
stream_putc(circuit->snd_stream,circuit->is_type);stream_put(circuit->snd_stream
,circuit->area->isis->sysid,ISIS_SYS_ID_LEN);uint32_tholdtime=circuit->hello_mul
tiplier[level-1]*circuit->hello_interval[level-1];if(holdtime>0xffff)holdtime=0x
ffff;stream_putw(circuit->snd_stream,holdtime);*len_pointer=stream_get_endp(circ
uit->snd_stream);stream_putw(circuit->snd_stream,0);/*lengthisfilledinlater*/if(
circuit->circ_type==CIRCUIT_T_BROADCAST){uint8_t*desig_is=(level==IS_LEVEL_1)?ci
rcuit->u.bc.l1_desig_is:circuit->u.bc.l2_desig_is;stream_putc(circuit->snd_strea
m,circuit->priority[level-1]);stream_put(circuit->snd_stream,desig_is,ISIS_SYS_I
D_LEN+1);}else{stream_putc(circuit->snd_stream,circuit->circuit_id);}}intsend_he
llo(structisis_circuit*circuit,intlevel){size_tlen_pointer;intretval;if(circuit-
>is_passive)returnISIS_OK;if(circuit->interface->mtu==0){zlog_warn("circuithasze
roMTU");returnISIS_WARNING;}put_hello_hdr(circuit,level,&len_pointer);structisis
_tlvs*tlvs=isis_alloc_tlvs();isis_tlvs_add_auth(tlvs,&circuit->passwd);if(!listc
ount(circuit->area->area_addrs)){isis_free_tlvs(tlvs);returnISIS_WARNING;}isis_t
lvs_add_area_addresses(tlvs,circuit->area->area_addrs);if(circuit->circ_type==CI
RCUIT_T_BROADCAST){isis_tlvs_add_lan_neighbors(tlvs,circuit->u.bc.lan_neighs[lev
el-1]);}elseif(circuit->circ_type==CIRCUIT_T_P2P&&!circuit->disable_threeway_adj
){uint32_text_circuit_id=circuit->idx;if(circuit->u.p2p.neighbor){isis_tlvs_add_
threeway_adj(tlvs,circuit->u.p2p.neighbor->threeway_state,ext_circuit_id,circuit
->u.p2p.neighbor->sysid,circuit->u.p2p.neighbor->ext_circuit_id);}else{isis_tlvs
_add_threeway_adj(tlvs,ISIS_THREEWAY_DOWN,ext_circuit_id,NULL,0);}}isis_tlvs_set
_protocols_supported(tlvs,&circuit->nlpids);/**MTSupportedTLV**TLVgetsincludedif
notopologyisenabledontheinterface,*ifonetopologyotherthan#0isenabled,orifmultipl
etopologies*areenabled.*/structisis_circuit_mt_setting**mt_settings;unsignedintm
t_count;mt_settings=circuit_mt_settings(circuit,&mt_count);if(mt_count==0&&area_
is_mt(circuit->area)){tlvs->mt_router_info_empty=true;}elseif((mt_count==1&&mt_s
ettings[0]->mtid!=ISIS_MT_IPV4_UNICAST)||(mt_count>1)){for(unsignedinti=0;i<mt_c
ount;i++)isis_tlvs_add_mt_router_info(tlvs,mt_settings[i]->mtid,false,false);}if
(circuit->ip_router&&circuit->ip_addrs)isis_tlvs_add_ipv4_addresses(tlvs,circuit
->ip_addrs);if(circuit->ipv6_router&&circuit->ipv6_link)isis_tlvs_add_ipv6_addre
sses(tlvs,circuit->ipv6_link);if(isis_pack_tlvs(tlvs,circuit->snd_stream,len_poi
nter,circuit->pad_hellos,false)){isis_free_tlvs(tlvs);returnISIS_WARNING;/*XXX:M
aybeLogTLVstructure?*/}if(isis->debugs&DEBUG_ADJ_PACKETS){if(circuit->circ_type=
=CIRCUIT_T_BROADCAST){zlog_debug("ISIS-Adj(%s):SendingL%dLANIIHon%s,length%zd",c
ircuit->area->area_tag,level,circuit->interface->name,stream_get_endp(circuit->s
nd_stream));}else{zlog_debug("ISIS-Adj(%s):SendingP2PIIHon%s,length%zd",circuit-
>area->area_tag,circuit->interface->name,stream_get_endp(circuit->snd_stream));}
if(isis->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circuit->snd_stream
),stream_get_endp(circuit->snd_stream));}isis_free_tlvs(tlvs);retval=circuit->tx
(circuit,level);if(retval!=ISIS_OK)zlog_err("ISIS-Adj(%s):SendL%dIIHon%sfailed",
circuit->area->area_tag,level,circuit->interface->name);returnretval;}intsend_la
n_l1_hello(structthread*thread){structisis_circuit*circuit;intretval;circuit=THR
EAD_ARG(thread);assert(circuit);circuit->u.bc.t_send_lan_hello[0]=NULL;if(!(circ
uit->area->is_type&IS_LEVEL_1)){zlog_warn("ISIS-Hello(%s):TryingtosendL1IIHinL2-
onlyarea",circuit->area->area_tag);return1;}if(circuit->u.bc.run_dr_elect[0])isi
s_dr_elect(circuit,1);retval=send_hello(circuit,1);/*setnexttimerthread*/thread_
add_timer(master,send_lan_l1_hello,circuit,isis_jitter(circuit->hello_interval[0
],IIH_JITTER),&circuit->u.bc.t_send_lan_hello[0]);returnretval;}intsend_lan_l2_h
ello(structthread*thread){structisis_circuit*circuit;intretval;circuit=THREAD_AR
G(thread);assert(circuit);circuit->u.bc.t_send_lan_hello[1]=NULL;if(!(circuit->a
rea->is_type&IS_LEVEL_2)){zlog_warn("ISIS-Hello(%s):TryingtosendL2IIHinL1area",c
ircuit->area->area_tag);return1;}if(circuit->u.bc.run_dr_elect[1])isis_dr_elect(
circuit,2);retval=send_hello(circuit,2);/*setnexttimerthread*/thread_add_timer(m
aster,send_lan_l2_hello,circuit,isis_jitter(circuit->hello_interval[1],IIH_JITTE
R),&circuit->u.bc.t_send_lan_hello[1]);returnretval;}intsend_p2p_hello(structthr
ead*thread){structisis_circuit*circuit;circuit=THREAD_ARG(thread);assert(circuit
);circuit->u.p2p.t_send_p2p_hello=NULL;send_hello(circuit,1);/*setnexttimerthrea
d*/thread_add_timer(master,send_p2p_hello,circuit,isis_jitter(circuit->hello_int
erval[1],IIH_JITTER),&circuit->u.p2p.t_send_p2p_hello);returnISIS_OK;}/**Countth
emaximumnumberoflspsthatcanbeaccomodatedbyagivensize.*/#defineLSP_ENTRIES_LEN(10
+ISIS_SYS_ID_LEN)staticuint16_tget_max_lsp_count(uint16_tsize){uint16_ttlv_count
;uint16_tlsp_count;uint16_tremaining_size;/*FirstcountthefullsizeTLVs*/tlv_count
=size/MAX_LSP_ENTRIES_TLV_SIZE;lsp_count=tlv_count*(MAX_LSP_ENTRIES_TLV_SIZE/LSP
_ENTRIES_LEN);/*ThelastTLV,ifany*/remaining_size=size%MAX_LSP_ENTRIES_TLV_SIZE;i
f(remaining_size-2>=LSP_ENTRIES_LEN)lsp_count+=(remaining_size-2)/LSP_ENTRIES_LE
N;returnlsp_count;}intsend_csnp(structisis_circuit*circuit,intlevel){if(circuit-
>area->lspdb[level-1]==NULL||dict_count(circuit->area->lspdb[level-1])==0)return
ISIS_OK;isis_circuit_stream(circuit,&circuit->snd_stream);fill_fixed_hdr((level=
=ISIS_LEVEL1)?L1_COMPLETE_SEQ_NUM:L2_COMPLETE_SEQ_NUM,circuit->snd_stream);size_
tlen_pointer=stream_get_endp(circuit->snd_stream);stream_putw(circuit->snd_strea
m,0);stream_put(circuit->snd_stream,isis->sysid,ISIS_SYS_ID_LEN);/*withzerocircu
itid-ref9.10,9.11*/stream_putc(circuit->snd_stream,0);size_tstart_pointer=stream
_get_endp(circuit->snd_stream);stream_put(circuit->snd_stream,0,ISIS_SYS_ID_LEN+
2);size_tend_pointer=stream_get_endp(circuit->snd_stream);stream_put(circuit->sn
d_stream,0,ISIS_SYS_ID_LEN+2);structisis_passwd*passwd=(level==ISIS_LEVEL1)?&cir
cuit->area->area_passwd:&circuit->area->domain_passwd;structisis_tlvs*tlvs=isis_
alloc_tlvs();if(CHECK_FLAG(passwd->snp_auth,SNP_AUTH_SEND))isis_tlvs_add_auth(tl
vs,passwd);size_ttlv_start=stream_get_endp(circuit->snd_stream);if(isis_pack_tlv
s(tlvs,circuit->snd_stream,len_pointer,false,false)){isis_free_tlvs(tlvs);return
ISIS_WARNING;}isis_free_tlvs(tlvs);uint16_tnum_lsps=get_max_lsp_count(STREAM_WRI
TEABLE(circuit->snd_stream));uint8_tstart[ISIS_SYS_ID_LEN+2];memset(start,0x00,I
SIS_SYS_ID_LEN+2);uint8_tstop[ISIS_SYS_ID_LEN+2];memset(stop,0xff,ISIS_SYS_ID_LE
N+2);boolloop=true;while(loop){tlvs=isis_alloc_tlvs();if(CHECK_FLAG(passwd->snp_
auth,SNP_AUTH_SEND))isis_tlvs_add_auth(tlvs,passwd);structisis_lsp*last_lsp;isis
_tlvs_add_csnp_entries(tlvs,start,stop,num_lsps,circuit->area->lspdb[level-1],&l
ast_lsp);/**Updatethestoplsp_idbeforeencodingthisCSNP.*/if(tlvs->lsp_entries.cou
nt<num_lsps){memset(stop,0xff,ISIS_SYS_ID_LEN+2);}else{memcpy(stop,last_lsp->hdr
.lsp_id,sizeof(stop));}memcpy(STREAM_DATA(circuit->snd_stream)+start_pointer,sta
rt,ISIS_SYS_ID_LEN+2);memcpy(STREAM_DATA(circuit->snd_stream)+end_pointer,stop,I
SIS_SYS_ID_LEN+2);stream_set_endp(circuit->snd_stream,tlv_start);if(isis_pack_tl
vs(tlvs,circuit->snd_stream,len_pointer,false,false)){isis_free_tlvs(tlvs);retur
nISIS_WARNING;}if(isis->debugs&DEBUG_SNP_PACKETS){zlog_debug("ISIS-Snp(%s):Sendi
ngL%dCSNPon%s,length%zd",circuit->area->area_tag,level,circuit->interface->name,
stream_get_endp(circuit->snd_stream));log_multiline(LOG_DEBUG,"","%s",isis_forma
t_tlvs(tlvs));if(isis->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circu
it->snd_stream),stream_get_endp(circuit->snd_stream));}intretval=circuit->tx(cir
cuit,level);if(retval!=ISIS_OK){zlog_err("ISIS-Snp(%s):SendL%dCSNPon%sfailed",ci
rcuit->area->area_tag,level,circuit->interface->name);isis_free_tlvs(tlvs);retur
nretval;}/**Startlsp_idofthenextCSNPshouldbeoneplusthe*stoplsp_idinthiscurrentCS
NP.*/memcpy(start,stop,ISIS_SYS_ID_LEN+2);loop=0;for(inti=ISIS_SYS_ID_LEN+1;i>=0
;--i){if(start[i]<(uint8_t)0xff){start[i]+=1;loop=1;break;}}memset(stop,0xff,ISI
S_SYS_ID_LEN+2);isis_free_tlvs(tlvs);}returnISIS_OK;}intsend_l1_csnp(structthrea
d*thread){structisis_circuit*circuit;intretval=ISIS_OK;circuit=THREAD_ARG(thread
);assert(circuit);circuit->t_send_csnp[0]=NULL;if(circuit->circ_type==CIRCUIT_T_
BROADCAST&&circuit->u.bc.is_dr[0]){send_csnp(circuit,1);}/*setnexttimerthread*/t
hread_add_timer(master,send_l1_csnp,circuit,isis_jitter(circuit->csnp_interval[0
],CSNP_JITTER),&circuit->t_send_csnp[0]);returnretval;}intsend_l2_csnp(structthr
ead*thread){structisis_circuit*circuit;intretval=ISIS_OK;circuit=THREAD_ARG(thre
ad);assert(circuit);circuit->t_send_csnp[1]=NULL;if(circuit->circ_type==CIRCUIT_
T_BROADCAST&&circuit->u.bc.is_dr[1]){send_csnp(circuit,2);}/*setnexttimerthread*
/thread_add_timer(master,send_l2_csnp,circuit,isis_jitter(circuit->csnp_interval
[1],CSNP_JITTER),&circuit->t_send_csnp[1]);returnretval;}/**7.3.15.4actiononexpi
rationofpartialSNPinterval*level1*/staticintsend_psnp(intlevel,structisis_circui
t*circuit){if(circuit->circ_type==CIRCUIT_T_BROADCAST&&circuit->u.bc.is_dr[level
-1])returnISIS_OK;if(circuit->area->lspdb[level-1]==NULL||dict_count(circuit->ar
ea->lspdb[level-1])==0)returnISIS_OK;if(!circuit->snd_stream)returnISIS_ERROR;is
is_circuit_stream(circuit,&circuit->snd_stream);fill_fixed_hdr((level==ISIS_LEVE
L1)?L1_PARTIAL_SEQ_NUM:L2_PARTIAL_SEQ_NUM,circuit->snd_stream);size_tlen_pointer
=stream_get_endp(circuit->snd_stream);stream_putw(circuit->snd_stream,0);/*lengt
hisfilledinlater*/stream_put(circuit->snd_stream,isis->sysid,ISIS_SYS_ID_LEN);st
ream_putc(circuit->snd_stream,circuit->idx);structisis_passwd*passwd=(level==ISI
S_LEVEL1)?&circuit->area->area_passwd:&circuit->area->domain_passwd;structisis_t
lvs*tlvs=isis_alloc_tlvs();if(CHECK_FLAG(passwd->snp_auth,SNP_AUTH_SEND))isis_tl
vs_add_auth(tlvs,passwd);size_ttlv_start=stream_get_endp(circuit->snd_stream);if
(isis_pack_tlvs(tlvs,circuit->snd_stream,len_pointer,false,false)){isis_free_tlv
s(tlvs);returnISIS_WARNING;}isis_free_tlvs(tlvs);uint16_tnum_lsps=get_max_lsp_co
unt(STREAM_WRITEABLE(circuit->snd_stream));while(1){tlvs=isis_alloc_tlvs();if(CH
ECK_FLAG(passwd->snp_auth,SNP_AUTH_SEND))isis_tlvs_add_auth(tlvs,passwd);for(dno
de_t*dnode=dict_first(circuit->area->lspdb[level-1]);dnode;dnode=dict_next(circu
it->area->lspdb[level-1],dnode)){structisis_lsp*lsp=dnode_get(dnode);if(ISIS_CHE
CK_FLAG(lsp->SSNflags,circuit))isis_tlvs_add_lsp_entry(tlvs,lsp);if(tlvs->lsp_en
tries.count==num_lsps)break;}if(!tlvs->lsp_entries.count){isis_free_tlvs(tlvs);r
eturnISIS_OK;}stream_set_endp(circuit->snd_stream,tlv_start);if(isis_pack_tlvs(t
lvs,circuit->snd_stream,len_pointer,false,false)){isis_free_tlvs(tlvs);returnISI
S_WARNING;}if(isis->debugs&DEBUG_SNP_PACKETS){zlog_debug("ISIS-Snp(%s):SendingL%
dPSNPon%s,length%zd",circuit->area->area_tag,level,circuit->interface->name,stre
am_get_endp(circuit->snd_stream));log_multiline(LOG_DEBUG,"","%s",isis_format_tl
vs(tlvs));if(isis->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circuit->
snd_stream),stream_get_endp(circuit->snd_stream));}intretval=circuit->tx(circuit
,level);if(retval!=ISIS_OK){zlog_err("ISIS-Snp(%s):SendL%dPSNPon%sfailed",circui
t->area->area_tag,level,circuit->interface->name);isis_free_tlvs(tlvs);returnret
val;}/**sendingsucceeded,wecanclearSSNflagsofthiscircuit*fortheLSPsinlist*/struc
tisis_lsp_entry*entry_head;entry_head=(structisis_lsp_entry*)tlvs->lsp_entries.h
ead;for(structisis_lsp_entry*entry=entry_head;entry;entry=entry->next)ISIS_CLEAR
_FLAG(entry->lsp->SSNflags,circuit);isis_free_tlvs(tlvs);}returnISIS_OK;}intsend
_l1_psnp(structthread*thread){structisis_circuit*circuit;intretval=ISIS_OK;circu
it=THREAD_ARG(thread);assert(circuit);circuit->t_send_psnp[0]=NULL;send_psnp(1,c
ircuit);/*setnexttimerthread*/thread_add_timer(master,send_l1_psnp,circuit,isis_
jitter(circuit->psnp_interval[0],PSNP_JITTER),&circuit->t_send_psnp[0]);returnre
tval;}/**7.3.15.4actiononexpirationofpartialSNPinterval*level2*/intsend_l2_psnp(
structthread*thread){structisis_circuit*circuit;intretval=ISIS_OK;circuit=THREAD
_ARG(thread);assert(circuit);circuit->t_send_psnp[1]=NULL;send_psnp(2,circuit);/
*setnexttimerthread*/thread_add_timer(master,send_l2_psnp,circuit,isis_jitter(ci
rcuit->psnp_interval[1],PSNP_JITTER),&circuit->t_send_psnp[1]);returnretval;}/**
ISO10589-7.3.14.3*/intsend_lsp(structthread*thread){structisis_circuit*circuit;s
tructisis_lsp*lsp;intclear_srm=1;intretval=ISIS_OK;circuit=THREAD_ARG(thread);as
sert(circuit);circuit->t_send_lsp=NULL;lsp=isis_circuit_lsp_queue_pop(circuit);i
f(!lsp)returnISIS_OK;if(!list_isempty(circuit->lsp_queue)){isis_circuit_schedule
_lsp_send(circuit);}if(circuit->state!=C_STATE_UP||circuit->is_passive==1)gotoou
t;/**Donotsendiflevelsdonotmatch*/if(!(lsp->level&circuit->is_type))gotoout;/**D
onotsendifwedonothaveadjacenciesinstateuponthecircuit*/if(circuit->upadjcount[ls
p->level-1]==0)gotoout;/*stream_copywillassertandstopprogramexecutionifLSPislarg
er*than*thecircuit'sMTU.Sohandleandlogthiscasehere.*/if(stream_get_endp(lsp->pdu
)>stream_get_size(circuit->snd_stream)){zlog_err("ISIS-Upd(%s):Can'tsendL%dLSP%s
,seq0x%08"PRIx32",cksum0x%04"PRIx16",lifetime%"PRIu16"son%s.LSPSizeis%zuwhileint
erfacestreamsizeis%zu.",circuit->area->area_tag,lsp->level,rawlspid_print(lsp->h
dr.lsp_id),lsp->hdr.seqno,lsp->hdr.checksum,lsp->hdr.rem_lifetime,circuit->inter
face->name,stream_get_endp(lsp->pdu),stream_get_size(circuit->snd_stream));if(is
is->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(lsp->pdu),stream_get_end
p(lsp->pdu));retval=ISIS_ERROR;gotoout;}/*copyourlsptothesendbuffer*/stream_copy
(circuit->snd_stream,lsp->pdu);if(isis->debugs&DEBUG_UPDATE_PACKETS){zlog_debug(
"ISIS-Upd(%s):SendingL%dLSP%s,seq0x%08"PRIx32",cksum0x%04"PRIx16",lifetime%"PRIu
16"son%s",circuit->area->area_tag,lsp->level,rawlspid_print(lsp->hdr.lsp_id),lsp
->hdr.seqno,lsp->hdr.checksum,lsp->hdr.rem_lifetime,circuit->interface->name);if
(isis->debugs&DEBUG_PACKET_DUMP)zlog_dump_data(STREAM_DATA(circuit->snd_stream),
stream_get_endp(circuit->snd_stream));}clear_srm=0;retval=circuit->tx(circuit,ls
p->level);if(retval!=ISIS_OK){zlog_err("ISIS-Upd(%s):SendL%dLSPon%sfailed%s",cir
cuit->area->area_tag,lsp->level,circuit->interface->name,(retval==ISIS_WARNING)?
"temporarily":"permanently");}out:if(clear_srm||(retval==ISIS_OK&&circuit->circ_
type==CIRCUIT_T_BROADCAST)||(retval!=ISIS_OK&&retval!=ISIS_WARNING)){/*SRMflagwi
lltriggerretransmission.Wewillnotretransmit*ifwe*encounteredafatalerror.*Onsucce
ss,theyshouldonlybeclearedifit'sabroadcast*circuit.*OnaP2Pcircuit,wewillwaitfort
heackfromtheneighbor*toclear*thefag.*/ISIS_CLEAR_FLAG(lsp->SRMflags,circuit);}re
turnretval;}