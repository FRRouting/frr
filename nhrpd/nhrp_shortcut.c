/*NHRPshortcutrelatedfunctions*Copyright(c)2014-2015TimoTerÃ¤s**Thisfileisfreesof
tware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLi
censeaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyo
uroption)anylaterversion.*/#include"nhrpd.h"#include"table.h"#include"memory.h"#
include"thread.h"#include"log.h"#include"nhrp_protocol.h"DEFINE_MTYPE_STATIC(NHR
PD,NHRP_SHORTCUT,"NHRPshortcut")staticstructroute_table*shortcut_rib[AFI_MAX];st
aticintnhrp_shortcut_do_purge(structthread*t);staticvoidnhrp_shortcut_delete(str
uctnhrp_shortcut*s);staticvoidnhrp_shortcut_send_resolution_req(structnhrp_short
cut*s);staticvoidnhrp_shortcut_check_use(structnhrp_shortcut*s){charbuf[PREFIX_S
TRLEN];if(s->expiring&&s->cache&&s->cache->used){debugf(NHRP_DEBUG_ROUTE,"Shortc
ut%susedandexpiring",prefix2str(s->p,buf,sizeofbuf));nhrp_shortcut_send_resoluti
on_req(s);}}staticintnhrp_shortcut_do_expire(structthread*t){structnhrp_shortcut
*s=THREAD_ARG(t);s->t_timer=NULL;thread_add_timer(master,nhrp_shortcut_do_purge,
s,s->holding_time/3,&s->t_timer);s->expiring=1;nhrp_shortcut_check_use(s);return
0;}staticvoidnhrp_shortcut_cache_notify(structnotifier_block*n,unsignedlongcmd){
structnhrp_shortcut*s=container_of(n,structnhrp_shortcut,cache_notifier);switch(
cmd){caseNOTIFY_CACHE_UP:if(!s->route_installed){nhrp_route_announce(1,s->type,s
->p,NULL,&s->cache->remote_addr,0);s->route_installed=1;}break;caseNOTIFY_CACHE_
USED:nhrp_shortcut_check_use(s);break;caseNOTIFY_CACHE_DOWN:caseNOTIFY_CACHE_DEL
ETE:if(s->route_installed){nhrp_route_announce(0,NHRP_CACHE_INVALID,s->p,NULL,NU
LL,0);s->route_installed=0;}if(cmd==NOTIFY_CACHE_DELETE)nhrp_shortcut_delete(s);
break;}}staticvoidnhrp_shortcut_update_binding(structnhrp_shortcut*s,enumnhrp_ca
che_typetype,structnhrp_cache*c,intholding_time){s->type=type;if(c!=s->cache){if
(s->cache){nhrp_cache_notify_del(s->cache,&s->cache_notifier);s->cache=NULL;}s->
cache=c;if(s->cache){nhrp_cache_notify_add(s->cache,&s->cache_notifier,nhrp_shor
tcut_cache_notify);if(s->cache->route_installed){/*ForcerenewalofZebraannounceon
prefix*change*/s->route_installed=0;nhrp_shortcut_cache_notify(&s->cache_notifie
r,NOTIFY_CACHE_UP);}}if(!s->cache||!s->cache->route_installed)nhrp_shortcut_cach
e_notify(&s->cache_notifier,NOTIFY_CACHE_DOWN);}if(s->type==NHRP_CACHE_NEGATIVE&
&!s->route_installed){nhrp_route_announce(1,s->type,s->p,NULL,NULL,0);s->route_i
nstalled=1;}elseif(s->type==NHRP_CACHE_INVALID&&s->route_installed){nhrp_route_a
nnounce(0,NHRP_CACHE_INVALID,s->p,NULL,NULL,0);s->route_installed=0;}THREAD_OFF(
s->t_timer);if(holding_time){s->expiring=0;s->holding_time=holding_time;thread_a
dd_timer(master,nhrp_shortcut_do_expire,s,2*holding_time/3,&s->t_timer);}}static
voidnhrp_shortcut_delete(structnhrp_shortcut*s){structroute_node*rn;afi_tafi=fam
ily2afi(PREFIX_FAMILY(s->p));charbuf[PREFIX_STRLEN];THREAD_OFF(s->t_timer);nhrp_
reqid_free(&nhrp_packet_reqid,&s->reqid);debugf(NHRP_DEBUG_ROUTE,"Shortcut%spurg
ed",prefix2str(s->p,buf,sizeofbuf));nhrp_shortcut_update_binding(s,NHRP_CACHE_IN
VALID,NULL,0);/*Deletenode*/rn=route_node_lookup(shortcut_rib[afi],s->p);if(rn){
XFREE(MTYPE_NHRP_SHORTCUT,rn->info);rn->info=NULL;route_unlock_node(rn);route_un
lock_node(rn);}}staticintnhrp_shortcut_do_purge(structthread*t){structnhrp_short
cut*s=THREAD_ARG(t);s->t_timer=NULL;nhrp_shortcut_delete(s);return0;}staticstruc
tnhrp_shortcut*nhrp_shortcut_get(structprefix*p){structnhrp_shortcut*s;structrou
te_node*rn;charbuf[PREFIX_STRLEN];afi_tafi=family2afi(PREFIX_FAMILY(p));if(!shor
tcut_rib[afi])return0;rn=route_node_get(shortcut_rib[afi],p);if(!rn->info){s=rn-
>info=XCALLOC(MTYPE_NHRP_SHORTCUT,sizeof(structnhrp_shortcut));s->type=NHRP_CACH
E_INVALID;s->p=&rn->p;debugf(NHRP_DEBUG_ROUTE,"Shortcut%screated",prefix2str(s->
p,buf,sizeofbuf));}else{s=rn->info;route_unlock_node(rn);}returns;}staticvoidnhr
p_shortcut_recv_resolution_rep(structnhrp_reqid*reqid,void*arg){structnhrp_packe
t_parser*pp=arg;structnhrp_shortcut*s=container_of(reqid,structnhrp_shortcut,req
id);structnhrp_shortcut*ps;structnhrp_extension_header*ext;structnhrp_cie_header
*cie;structnhrp_cache*c=NULL;unionsockunion*proto,cie_proto,*nbma,*nbma_natoa,ci
e_nbma,nat_nbma;structprefixprefix,route_prefix;structzbufextpl;charbufp[PREFIX_
STRLEN],buf[3][SU_ADDRSTRLEN];intholding_time=pp->if_ad->holdtime;nhrp_reqid_fre
e(&nhrp_packet_reqid,&s->reqid);THREAD_OFF(s->t_timer);thread_add_timer(master,n
hrp_shortcut_do_purge,s,1,&s->t_timer);if(pp->hdr->type!=NHRP_PACKET_RESOLUTION_
REPLY){if(pp->hdr->type==NHRP_PACKET_ERROR_INDICATION&&pp->hdr->u.error.code==NH
RP_ERROR_PROTOCOL_ADDRESS_UNREACHABLE){debugf(NHRP_DEBUG_COMMON,"Shortcut:Resolu
tion:Protocoladdressunreachable");nhrp_shortcut_update_binding(s,NHRP_CACHE_NEGA
TIVE,NULL,holding_time);}else{debugf(NHRP_DEBUG_COMMON,"Shortcut:Resolutionfaile
d");}return;}/*Parseextensions*/memset(&nat_nbma,0,sizeofnat_nbma);while((ext=nh
rp_ext_pull(&pp->extensions,&extpl))!=NULL){switch(htons(ext->type)&~NHRP_EXTENS
ION_FLAG_COMPULSORY){caseNHRP_EXTENSION_NAT_ADDRESS:nhrp_cie_pull(&extpl,pp->hdr
,&nat_nbma,&cie_proto);break;}}/*Minorsanitycheck*/prefix2sockunion(s->p,&cie_pr
oto);if(!sockunion_same(&cie_proto,&pp->dst_proto)){debugf(NHRP_DEBUG_COMMON,"Sh
ortcut:Warningdst_protoalteredfrom%sto%s",sockunion2str(&cie_proto,buf[0],sizeof
buf[0]),sockunion2str(&pp->dst_proto,buf[1],sizeofbuf[1]));}/*OneormoreCIEsshoul
dbegivenasreply,wesupportonlyone*/cie=nhrp_cie_pull(&pp->payload,pp->hdr,&cie_nb
ma,&cie_proto);if(!cie||cie->code!=NHRP_CODE_SUCCESS){debugf(NHRP_DEBUG_COMMON,"
Shortcut:CIEcode%d",cie?cie->code:-1);return;}proto=sockunion_family(&cie_proto)
!=AF_UNSPEC?&cie_proto:&pp->dst_proto;if(cie->holding_time)holding_time=htons(ci
e->holding_time);prefix=*s->p;prefix.prefixlen=cie->prefix_length;/*Sanitycheckp
refixlength*/if(prefix.prefixlen>=8*prefix_blen(&prefix)||prefix.prefixlen==0){p
refix.prefixlen=8*prefix_blen(&prefix);}elseif(nhrp_route_address(NULL,&pp->dst_
proto,&route_prefix,NULL)==NHRP_ROUTE_NBMA_NEXTHOP){if(prefix.prefixlen<route_pr
efix.prefixlen)prefix.prefixlen=route_prefix.prefixlen;}debugf(NHRP_DEBUG_COMMON
,"Shortcut:%sisatproto%scie-nbma%snat-nbma%scie-holdtime%d",prefix2str(&prefix,b
ufp,sizeofbufp),sockunion2str(proto,buf[0],sizeofbuf[0]),sockunion2str(&cie_nbma
,buf[1],sizeofbuf[1]),sockunion2str(&nat_nbma,buf[2],sizeofbuf[2]),htons(cie->ho
lding_time));/*Updatecacheentryfortheprotocoltonbmabinding*/if(sockunion_family(
&nat_nbma)!=AF_UNSPEC){nbma=&nat_nbma;nbma_natoa=&cie_nbma;}else{nbma=&cie_nbma;
nbma_natoa=NULL;}if(sockunion_family(nbma)){c=nhrp_cache_get(pp->ifp,proto,1);if
(c){nhrp_cache_update_binding(c,NHRP_CACHE_CACHED,holding_time,nhrp_peer_get(pp-
>ifp,nbma),htons(cie->mtu),nbma_natoa);}}/*Updateshortcutentryforsubnettoprotoco
lgwbinding*/if(c&&!sockunion_same(proto,&pp->dst_proto)){ps=nhrp_shortcut_get(&p
refix);if(ps){ps->addr=s->addr;nhrp_shortcut_update_binding(ps,NHRP_CACHE_CACHED
,c,holding_time);}}debugf(NHRP_DEBUG_COMMON,"Shortcut:Resolutionreplyhandled");}
staticvoidnhrp_shortcut_send_resolution_req(structnhrp_shortcut*s){structzbuf*zb
;structnhrp_packet_header*hdr;structinterface*ifp;structnhrp_interface*nifp;stru
ctnhrp_peer*peer;if(nhrp_route_address(NULL,&s->addr,NULL,&peer)!=NHRP_ROUTE_NBM
A_NEXTHOP)return;if(s->type==NHRP_CACHE_INVALID||s->type==NHRP_CACHE_NEGATIVE)s-
>type=NHRP_CACHE_INCOMPLETE;ifp=peer->ifp;nifp=ifp->info;/*Createrequest*/zb=zbu
f_alloc(1500);hdr=nhrp_packet_push(zb,NHRP_PACKET_RESOLUTION_REQUEST,&nifp->nbma
,&nifp->afi[family2afi(sockunion_family(&s->addr))].addr,&s->addr);hdr->u.reques
t_id=htonl(nhrp_reqid_alloc(&nhrp_packet_reqid,&s->reqid,nhrp_shortcut_recv_reso
lution_rep));hdr->flags=htons(NHRP_FLAG_RESOLUTION_SOURCE_IS_ROUTER|NHRP_FLAG_RE
SOLUTION_AUTHORATIVE|NHRP_FLAG_RESOLUTION_SOURCE_STABLE);/*RFC2332-OneorzeroCIEs
,ifCIEispresentcontains:*-Prefixlength:widestacceptableprefixweaccept(ifUset,0xf
f)*-MTU:MTUofthesourcestation*-HoldingTime:Maxtimetocachethesourceinformation**/
/*FIXME:Sendholdingtime,andMTU*/nhrp_ext_request(zb,hdr,ifp);/*CiscoNATdetection
extension*/hdr->flags|=htons(NHRP_FLAG_RESOLUTION_NAT);nhrp_ext_push(zb,hdr,NHRP
_EXTENSION_NAT_ADDRESS);nhrp_packet_complete(zb,hdr);nhrp_peer_send(peer,zb);nhr
p_peer_unref(peer);zbuf_free(zb);}voidnhrp_shortcut_initiate(unionsockunion*addr
){structprefixp;structnhrp_shortcut*s;sockunion2hostprefix(addr,&p);s=nhrp_short
cut_get(&p);if(s&&s->type!=NHRP_CACHE_INCOMPLETE){s->addr=*addr;THREAD_OFF(s->t_
timer);thread_add_timer(master,nhrp_shortcut_do_purge,s,30,&s->t_timer);nhrp_sho
rtcut_send_resolution_req(s);}}voidnhrp_shortcut_init(void){shortcut_rib[AFI_IP]
=route_table_init();shortcut_rib[AFI_IP6]=route_table_init();}voidnhrp_shortcut_
terminate(void){route_table_finish(shortcut_rib[AFI_IP]);route_table_finish(shor
tcut_rib[AFI_IP6]);}voidnhrp_shortcut_foreach(afi_tafi,void(*cb)(structnhrp_shor
tcut*,void*),void*ctx){structroute_table*rt=shortcut_rib[afi];structroute_node*r
n;route_table_iter_titer;if(!rt)return;route_table_iter_init(&iter,rt);while((rn
=route_table_iter_next(&iter))!=NULL){if(rn->info)cb(rn->info,ctx);}route_table_
iter_cleanup(&iter);}structpurge_ctx{conststructprefix*p;intdeleted;};voidnhrp_s
hortcut_purge(structnhrp_shortcut*s,intforce){THREAD_OFF(s->t_timer);nhrp_reqid_
free(&nhrp_packet_reqid,&s->reqid);if(force){/*Immediatepurgeonroutewithdraworpe
ndingshortcut*/thread_add_timer_msec(master,nhrp_shortcut_do_purge,s,5,&s->t_tim
er);}else{/*Softexpire-forceimmediaterenewal,butpurge*infewsecondstomakesurestal
erouteisnot*usedtoolong.Inpracticemostpurgesarecaused*byhubbgpchange,buttargetus
uallystayssame.*Thisallowstokeepnhrprouteup,andtonot*causetemporaryreroutingviah
ubscausinglatency*jitter.*/thread_add_timer_msec(master,nhrp_shortcut_do_purge,s
,3000,&s->t_timer);s->expiring=1;nhrp_shortcut_check_use(s);}}staticvoidnhrp_sho
rtcut_purge_prefix(structnhrp_shortcut*s,void*ctx){structpurge_ctx*pctx=ctx;if(p
refix_match(pctx->p,s->p))nhrp_shortcut_purge(s,pctx->deleted||!s->cache);}voidn
hrp_shortcut_prefix_change(conststructprefix*p,intdeleted){structpurge_ctxpctx={
.p=p,.deleted=deleted,};nhrp_shortcut_foreach(family2afi(PREFIX_FAMILY(p)),nhrp_
shortcut_purge_prefix,&pctx);}