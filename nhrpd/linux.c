/*NHRPdaemonLinuxspecificglue*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoft
ware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLic
enseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyou
roption)anylaterversion.*/#include<fcntl.h>#include<stdio.h>#include<unistd.h>#i
nclude<string.h>#include<sys/ioctl.h>#include<sys/socket.h>#include<sys/types.h>
#include<asm/types.h>#include<arpa/inet.h>#include<linux/netlink.h>#include<linu
x/rtnetlink.h>#include<linux/ip.h>#include<linux/if_arp.h>#include<linux/if_tunn
el.h>#include"nhrp_protocol.h"#include"os.h"#include"netlink.h"staticintnhrp_soc
ket_fd=-1;intos_socket(void){if(nhrp_socket_fd<0)nhrp_socket_fd=socket(PF_PACKET
,SOCK_DGRAM,htons(ETH_P_NHRP));returnnhrp_socket_fd;}intos_sendmsg(constuint8_t*
buf,size_tlen,intifindex,constuint8_t*addr,size_taddrlen){structsockaddr_lllladd
r;structioveciov={.iov_base=(void*)buf,.iov_len=len,};structmsghdrmsg={.msg_name
=&lladdr,.msg_namelen=sizeof(lladdr),.msg_iov=&iov,.msg_iovlen=1,};intstatus;if(
addrlen>sizeof(lladdr.sll_addr))return-1;memset(&lladdr,0,sizeof(lladdr));lladdr
.sll_family=AF_PACKET;lladdr.sll_protocol=htons(ETH_P_NHRP);lladdr.sll_ifindex=i
findex;lladdr.sll_halen=addrlen;memcpy(lladdr.sll_addr,addr,addrlen);status=send
msg(nhrp_socket_fd,&msg,0);if(status<0)return-1;return0;}intos_recvmsg(uint8_t*b
uf,size_t*len,int*ifindex,uint8_t*addr,size_t*addrlen){structsockaddr_lllladdr;s
tructioveciov={.iov_base=buf,.iov_len=*len,};structmsghdrmsg={.msg_name=&lladdr,
.msg_namelen=sizeof(lladdr),.msg_iov=&iov,.msg_iovlen=1,};intr;r=recvmsg(nhrp_so
cket_fd,&msg,MSG_DONTWAIT);if(r<0)returnr;*len=r;*ifindex=lladdr.sll_ifindex;if(
*addrlen<=(size_t)lladdr.sll_addr){if(memcmp(lladdr.sll_addr,"\x00\x00\x00\x00",
4)!=0){memcpy(addr,lladdr.sll_addr,lladdr.sll_halen);*addrlen=lladdr.sll_halen;}
else{*addrlen=0;}}return0;}staticintlinux_configure_arp(constchar*iface,inton){s
tructifreqifr;strncpy(ifr.ifr_name,iface,IFNAMSIZ-1);if(ioctl(nhrp_socket_fd,SIO
CGIFFLAGS,&ifr))return-1;if(on)ifr.ifr_flags&=~IFF_NOARP;elseifr.ifr_flags|=IFF_
NOARP;if(ioctl(nhrp_socket_fd,SIOCSIFFLAGS,&ifr))return-1;return0;}staticintlinu
x_icmp_redirect_off(constchar*iface){charfname[256];intfd,ret=-1;sprintf(fname,"
/proc/sys/net/ipv4/conf/%s/send_redirects",iface);fd=open(fname,O_WRONLY);if(fd<
0)return-1;if(write(fd,"0\n",2)==2)ret=0;close(fd);returnret;}intos_configure_dm
vpn(unsignedintifindex,constchar*ifname,intaf){intret=0;switch(af){caseAF_INET:r
et|=linux_icmp_redirect_off("all");ret|=linux_icmp_redirect_off(ifname);break;}r
et|=linux_configure_arp(ifname,1);ret|=netlink_configure_arp(ifindex,af);returnr
et;}