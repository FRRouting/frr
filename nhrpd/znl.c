/*Netlinkhelpersforzbuf*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoftware:y
oumaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseas
publishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyouroptio
n)anylaterversion.*/#include<fcntl.h>#include<errno.h>#include<string.h>#include
<unistd.h>#include<sys/types.h>#include<sys/socket.h>#include<linux/netlink.h>#i
nclude<linux/rtnetlink.h>#include"znl.h"#defineZNL_ALIGN(len)(((len)+3)&~3)void*
znl_push(structzbuf*zb,size_tn){returnzbuf_pushn(zb,ZNL_ALIGN(n));}void*znl_pull
(structzbuf*zb,size_tn){returnzbuf_pulln(zb,ZNL_ALIGN(n));}structnlmsghdr*znl_nl
msg_push(structzbuf*zb,uint16_ttype,uint16_tflags){structnlmsghdr*n;n=znl_push(z
b,sizeof(*n));if(!n)returnNULL;*n=(structnlmsghdr){.nlmsg_type=type,.nlmsg_flags
=flags,};returnn;}voidznl_nlmsg_complete(structzbuf*zb,structnlmsghdr*n){n->nlms
g_len=zb->tail-(uint8_t*)n;}structnlmsghdr*znl_nlmsg_pull(structzbuf*zb,structzb
uf*payload){structnlmsghdr*n;size_tplen;n=znl_pull(zb,sizeof(*n));if(!n)returnNU
LL;plen=n->nlmsg_len-sizeof(*n);zbuf_init(payload,znl_pull(zb,plen),plen,plen);z
buf_may_pulln(zb,ZNL_ALIGN(plen)-plen);returnn;}structrtattr*znl_rta_push(struct
zbuf*zb,uint16_ttype,constvoid*val,size_tlen){structrtattr*rta;uint8_t*dst;rta=z
nl_push(zb,ZNL_ALIGN(sizeof(*rta))+ZNL_ALIGN(len));if(!rta)returnNULL;*rta=(stru
ctrtattr){.rta_type=type,.rta_len=ZNL_ALIGN(sizeof(*rta))+len,};dst=(uint8_t*)(r
ta+1);memcpy(dst,val,len);memset(dst+len,0,ZNL_ALIGN(len)-len);returnrta;}struct
rtattr*znl_rta_push_u32(structzbuf*zb,uint16_ttype,uint32_tval){returnznl_rta_pu
sh(zb,type,&val,sizeof(val));}structrtattr*znl_rta_nested_push(structzbuf*zb,uin
t16_ttype){structrtattr*rta;rta=znl_push(zb,sizeof(*rta));if(!rta)returnNULL;*rt
a=(structrtattr){.rta_type=type,};returnrta;}voidznl_rta_nested_complete(structz
buf*zb,structrtattr*rta){size_tlen=zb->tail-(uint8_t*)rta;size_talign=ZNL_ALIGN(
len)-len;if(align){void*dst=zbuf_pushn(zb,align);if(dst)memset(dst,0,align);}rta
->rta_len=len;}structrtattr*znl_rta_pull(structzbuf*zb,structzbuf*payload){struc
trtattr*rta;size_tplen;rta=znl_pull(zb,sizeof(*rta));if(!rta)returnNULL;if(rta->
rta_len>sizeof(*rta)){plen=rta->rta_len-sizeof(*rta);zbuf_init(payload,znl_pull(
zb,plen),plen,plen);}else{zbuf_init(payload,NULL,0,0);}returnrta;}intznl_open(in
tprotocol,intgroups){structsockaddr_nladdr;intfd,buf=128*1024;fd=socket(AF_NETLI
NK,SOCK_RAW,protocol);if(fd<0)return-1;if(fcntl(fd,F_SETFL,fcntl(fd,F_GETFL,0)|O
_NONBLOCK)<0)gotoerror;if(fcntl(fd,F_SETFD,FD_CLOEXEC)<0)gotoerror;if(setsockopt
(fd,SOL_SOCKET,SO_RCVBUF,&buf,sizeof(buf))<0)gotoerror;memset(&addr,0,sizeof(add
r));addr.nl_family=AF_NETLINK;addr.nl_groups=groups;if(bind(fd,(structsockaddr*)
&addr,sizeof(addr))<0)gotoerror;returnfd;error:close(fd);return-1;}