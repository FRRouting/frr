/*NHRPinterface*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoftware:youmaycop
y,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseaspublishe
dby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyouroption)anylat
erversion.*/#include<net/if_arp.h>#include"zebra.h"#include"linklist.h"#include"
memory.h"#include"thread.h"#include"nhrpd.h"#include"os.h"#include"netlink.h"DEF
INE_MTYPE_STATIC(NHRPD,NHRP_IF,"NHRPinterface")staticintnhrp_if_new_hook(structi
nterface*ifp){structnhrp_interface*nifp;afi_tafi;nifp=XCALLOC(MTYPE_NHRP_IF,size
of(structnhrp_interface));if(!nifp)return0;ifp->info=nifp;nifp->ifp=ifp;notifier
_init(&nifp->notifier_list);for(afi=0;afi<AFI_MAX;afi++){structnhrp_afi_data*ad=
&nifp->afi[afi];ad->holdtime=NHRPD_DEFAULT_HOLDTIME;list_init(&ad->nhslist_head)
;}return0;}staticintnhrp_if_delete_hook(structinterface*ifp){XFREE(MTYPE_NHRP_IF
,ifp->info);return0;}voidnhrp_interface_init(void){hook_register_prio(if_add,0,n
hrp_if_new_hook);hook_register_prio(if_del,0,nhrp_if_delete_hook);}voidnhrp_inte
rface_update_mtu(structinterface*ifp,afi_tafi){structnhrp_interface*nifp=ifp->in
fo;structnhrp_afi_data*if_ad=&nifp->afi[afi];unsignedshortnew_mtu;if(if_ad->conf
igured_mtu<0)new_mtu=nifp->nbmaifp?nifp->nbmaifp->mtu:0;elsenew_mtu=if_ad->confi
gured_mtu;if(new_mtu>=1500)new_mtu=0;if(new_mtu!=if_ad->mtu){debugf(NHRP_DEBUG_I
F,"%s:MTUchangedto%d",ifp->name,new_mtu);if_ad->mtu=new_mtu;notifier_call(&nifp-
>notifier_list,NOTIFY_INTERFACE_MTU_CHANGED);}}staticvoidnhrp_interface_update_s
ource(structinterface*ifp){structnhrp_interface*nifp=ifp->info;if(!nifp->source|
|!nifp->nbmaifp||(ifindex_t)nifp->linkidx==nifp->nbmaifp->ifindex)return;nifp->l
inkidx=nifp->nbmaifp->ifindex;debugf(NHRP_DEBUG_IF,"%s:bounddeviceindexchangedto
%d",ifp->name,nifp->linkidx);netlink_gre_set_link(ifp->ifindex,nifp->linkidx);}s
taticvoidnhrp_interface_interface_notifier(structnotifier_block*n,unsignedlongcm
d){structnhrp_interface*nifp=container_of(n,structnhrp_interface,nbmanifp_notifi
er);structinterface*nbmaifp=nifp->nbmaifp;structnhrp_interface*nbmanifp=nbmaifp-
>info;charbuf[SU_ADDRSTRLEN];switch(cmd){caseNOTIFY_INTERFACE_CHANGED:nhrp_inter
face_update_mtu(nifp->ifp,AFI_IP);nhrp_interface_update_source(nifp->ifp);break;
caseNOTIFY_INTERFACE_ADDRESS_CHANGED:nifp->nbma=nbmanifp->afi[AFI_IP].addr;nhrp_
interface_update(nifp->ifp);notifier_call(&nifp->notifier_list,NOTIFY_INTERFACE_
NBMA_CHANGED);debugf(NHRP_DEBUG_IF,"%s:NBMAchange:address%s",nifp->ifp->name,soc
kunion2str(&nifp->nbma,buf,sizeofbuf));break;}}staticvoidnhrp_interface_update_n
bma(structinterface*ifp){structnhrp_interface*nifp=ifp->info,*nbmanifp=NULL;stru
ctinterface*nbmaifp=NULL;unionsockunionnbma;sockunion_family(&nbma)=AF_UNSPEC;if
(nifp->source)nbmaifp=if_lookup_by_name(nifp->source,VRF_DEFAULT);switch(ifp->ll
_type){caseZEBRA_LLT_IPGRE:{structin_addrsaddr={0};netlink_gre_get_info(ifp->ifi
ndex,&nifp->grekey,&nifp->linkidx,&saddr);debugf(NHRP_DEBUG_IF,"%s:GRE:%x%x%x",i
fp->name,nifp->grekey,nifp->linkidx,saddr.s_addr);if(saddr.s_addr)sockunion_set(
&nbma,AF_INET,(uint8_t*)&saddr.s_addr,sizeof(saddr.s_addr));elseif(!nbmaifp&&nif
p->linkidx!=IFINDEX_INTERNAL)nbmaifp=if_lookup_by_index(nifp->linkidx,VRF_DEFAUL
T);}break;default:break;}if(nbmaifp)nbmanifp=nbmaifp->info;if(nbmaifp!=nifp->nbm
aifp){if(nifp->nbmaifp)notifier_del(&nifp->nbmanifp_notifier);nifp->nbmaifp=nbma
ifp;if(nbmaifp){notifier_add(&nifp->nbmanifp_notifier,&nbmanifp->notifier_list,n
hrp_interface_interface_notifier);debugf(NHRP_DEBUG_IF,"%s:boundto%s",ifp->name,
nbmaifp->name);}}if(nbmaifp){if(sockunion_family(&nbma)==AF_UNSPEC)nbma=nbmanifp
->afi[AFI_IP].addr;nhrp_interface_update_mtu(ifp,AFI_IP);nhrp_interface_update_s
ource(ifp);}if(!sockunion_same(&nbma,&nifp->nbma)){nifp->nbma=nbma;nhrp_interfac
e_update(nifp->ifp);debugf(NHRP_DEBUG_IF,"%s:NBMAaddresschanged",ifp->name);noti
fier_call(&nifp->notifier_list,NOTIFY_INTERFACE_NBMA_CHANGED);}nhrp_interface_up
date(ifp);}staticvoidnhrp_interface_update_address(structinterface*ifp,afi_tafi,
intforce){constintfamily=afi2family(afi);structnhrp_interface*nifp=ifp->info;str
uctnhrp_afi_data*if_ad=&nifp->afi[afi];structnhrp_cache*nc;structconnected*c,*be
st;structlistnode*cnode;unionsockunionaddr;charbuf[PREFIX_STRLEN];/*Selectnewbes
tmatchpreferringprimaryaddress*/best=NULL;for(ALL_LIST_ELEMENTS_RO(ifp->connecte
d,cnode,c)){if(PREFIX_FAMILY(c->address)!=family)continue;if(best==NULL){best=c;
continue;}if((best->flags&ZEBRA_IFA_SECONDARY)&&!(c->flags&ZEBRA_IFA_SECONDARY))
{best=c;continue;}if(!(best->flags&ZEBRA_IFA_SECONDARY)&&(c->flags&ZEBRA_IFA_SEC
ONDARY))continue;if(best->address->prefixlen>c->address->prefixlen){best=c;conti
nue;}if(best->address->prefixlen<c->address->prefixlen)continue;}/*OnNHRPinterfa
cesahostprefixisrequired*/if(best&&if_ad->configured&&best->address->prefixlen!=
8*prefix_blen(best->address)){zlog_notice("%s:%sisnotahostprefix",ifp->name,pref
ix2str(best->address,buf,sizeofbuf));best=NULL;}/*Updateaddressifitchanged*/if(b
est)prefix2sockunion(best->address,&addr);elsememset(&addr,0,sizeof(addr));if(!f
orce&&sockunion_same(&if_ad->addr,&addr))return;if(sockunion_family(&if_ad->addr
)!=AF_UNSPEC){nc=nhrp_cache_get(ifp,&if_ad->addr,0);if(nc)nhrp_cache_update_bind
ing(nc,NHRP_CACHE_LOCAL,-1,NULL,0,NULL);}debugf(NHRP_DEBUG_KERNEL,"%s:IPv%daddre
sschangedto%s",ifp->name,afi==AFI_IP?4:6,best?prefix2str(best->address,buf,sizeo
fbuf):"(none)");if_ad->addr=addr;if(if_ad->configured&&sockunion_family(&if_ad->
addr)!=AF_UNSPEC){nc=nhrp_cache_get(ifp,&addr,1);if(nc)nhrp_cache_update_binding
(nc,NHRP_CACHE_LOCAL,0,NULL,0,NULL);}notifier_call(&nifp->notifier_list,NOTIFY_I
NTERFACE_ADDRESS_CHANGED);}voidnhrp_interface_update(structinterface*ifp){struct
nhrp_interface*nifp=ifp->info;structnhrp_afi_data*if_ad;afi_tafi;intenabled=0;no
tifier_call(&nifp->notifier_list,NOTIFY_INTERFACE_CHANGED);for(afi=0;afi<AFI_MAX
;afi++){if_ad=&nifp->afi[afi];if(sockunion_family(&nifp->nbma)==AF_UNSPEC||ifp->
ifindex==IFINDEX_INTERNAL||!if_is_up(ifp)||!if_ad->network_id){if(if_ad->configu
red){if_ad->configured=0;nhrp_interface_update_address(ifp,afi,1);}continue;}if(
!if_ad->configured){os_configure_dmvpn(ifp->ifindex,ifp->name,afi2family(afi));i
f_ad->configured=1;nhrp_interface_update_address(ifp,afi,1);}enabled=1;}if(enabl
ed!=nifp->enabled){nifp->enabled=enabled;notifier_call(&nifp->notifier_list,enab
led?NOTIFY_INTERFACE_UP:NOTIFY_INTERFACE_DOWN);}}intnhrp_interface_add(intcmd,st
ructzclient*client,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;/*read
andaddtheinterfaceintheiflist.*/ifp=zebra_interface_add_read(client->ibuf,vrf_id
);if(ifp==NULL)return0;debugf(NHRP_DEBUG_IF,"if-add:%s,ifindex:%u,hw_type:%d%s",
ifp->name,ifp->ifindex,ifp->ll_type,if_link_type_str(ifp->ll_type));nhrp_interfa
ce_update_nbma(ifp);return0;}intnhrp_interface_delete(intcmd,structzclient*clien
t,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structstream*s;s=client
->ibuf;ifp=zebra_interface_state_read(s,vrf_id);if(ifp==NULL)return0;debugf(NHRP
_DEBUG_IF,"if-delete:%s",ifp->name);if_set_index(ifp,ifp->ifindex);nhrp_interfac
e_update(ifp);/*if_delete(ifp);*/return0;}intnhrp_interface_up(intcmd,structzcli
ent*client,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;ifp=zebra_inte
rface_state_read(client->ibuf,vrf_id);if(ifp==NULL)return0;debugf(NHRP_DEBUG_IF,
"if-up:%s",ifp->name);nhrp_interface_update_nbma(ifp);return0;}intnhrp_interface
_down(intcmd,structzclient*client,zebra_size_tlength,vrf_id_tvrf_id){structinter
face*ifp;ifp=zebra_interface_state_read(client->ibuf,vrf_id);if(ifp==NULL)return
0;debugf(NHRP_DEBUG_IF,"if-down:%s",ifp->name);nhrp_interface_update(ifp);return
0;}intnhrp_interface_address_add(intcmd,structzclient*client,zebra_size_tlength,
vrf_id_tvrf_id){structconnected*ifc;charbuf[PREFIX_STRLEN];ifc=zebra_interface_a
ddress_read(cmd,client->ibuf,vrf_id);if(ifc==NULL)return0;debugf(NHRP_DEBUG_IF,"
if-addr-add:%s:%s",ifc->ifp->name,prefix2str(ifc->address,buf,sizeofbuf));nhrp_i
nterface_update_address(ifc->ifp,family2afi(PREFIX_FAMILY(ifc->address)),0);retu
rn0;}intnhrp_interface_address_delete(intcmd,structzclient*client,zebra_size_tle
ngth,vrf_id_tvrf_id){structconnected*ifc;charbuf[PREFIX_STRLEN];ifc=zebra_interf
ace_address_read(cmd,client->ibuf,vrf_id);if(ifc==NULL)return0;debugf(NHRP_DEBUG
_IF,"if-addr-del:%s:%s",ifc->ifp->name,prefix2str(ifc->address,buf,sizeofbuf));n
hrp_interface_update_address(ifc->ifp,family2afi(PREFIX_FAMILY(ifc->address)),0)
;connected_free(ifc);return0;}voidnhrp_interface_notify_add(structinterface*ifp,
structnotifier_block*n,notifier_fn_tfn){structnhrp_interface*nifp=ifp->info;noti
fier_add(n,&nifp->notifier_list,fn);}voidnhrp_interface_notify_del(structinterfa
ce*ifp,structnotifier_block*n){notifier_del(n);}voidnhrp_interface_set_protectio
n(structinterface*ifp,constchar*profile,constchar*fallback_profile){structnhrp_i
nterface*nifp=ifp->info;if(nifp->ipsec_profile)free(nifp->ipsec_profile);nifp->i
psec_profile=profile?strdup(profile):NULL;if(nifp->ipsec_fallback_profile)free(n
ifp->ipsec_fallback_profile);nifp->ipsec_fallback_profile=fallback_profile?strdu
p(fallback_profile):NULL;notifier_call(&nifp->notifier_list,NOTIFY_INTERFACE_ADD
RESS_CHANGED);}voidnhrp_interface_set_source(structinterface*ifp,constchar*ifnam
e){structnhrp_interface*nifp=ifp->info;if(nifp->source)free(nifp->source);nifp->
source=ifname?strdup(ifname):NULL;nhrp_interface_update_nbma(ifp);}