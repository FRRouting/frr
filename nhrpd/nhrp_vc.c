/*NHRPvirtualconnection*Copyright(c)2014-2015TimoTerÃ¤s**Thisfileisfreesoftware:y
oumaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseas
publishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyouroptio
n)anylaterversion.*/#include"zebra.h"#include"memory.h"#include"stream.h"#includ
e"hash.h"#include"thread.h"#include"jhash.h"#include"nhrpd.h"#include"os.h"DEFIN
E_MTYPE_STATIC(NHRPD,NHRP_VC,"NHRPvirtualconnection")structchild_sa{uint32_tid;s
tructnhrp_vc*vc;structlist_headchildlist_entry;};staticstructhash*nhrp_vc_hash;s
taticstructlist_headchildlist_head[512];staticunsignedintnhrp_vc_key(void*peer_d
ata){structnhrp_vc*vc=peer_data;returnjhash_2words(sockunion_hash(&vc->local.nbm
a),sockunion_hash(&vc->remote.nbma),0);}staticintnhrp_vc_cmp(constvoid*cache_dat
a,constvoid*key_data){conststructnhrp_vc*a=cache_data;conststructnhrp_vc*b=key_d
ata;returnsockunion_same(&a->local.nbma,&b->local.nbma)&&sockunion_same(&a->remo
te.nbma,&b->remote.nbma);}staticvoid*nhrp_vc_alloc(void*data){structnhrp_vc*vc,*
key=data;vc=XMALLOC(MTYPE_NHRP_VC,sizeof(structnhrp_vc));if(vc){*vc=(structnhrp_
vc){.local.nbma=key->local.nbma,.remote.nbma=key->remote.nbma,.notifier_list=NOT
IFIER_LIST_INITIALIZER(&vc->notifier_list),};}returnvc;}staticvoidnhrp_vc_free(v
oid*data){XFREE(MTYPE_NHRP_VC,data);}structnhrp_vc*nhrp_vc_get(constunionsockuni
on*src,constunionsockunion*dst,intcreate){structnhrp_vckey;key.local.nbma=*src;k
ey.remote.nbma=*dst;returnhash_get(nhrp_vc_hash,&key,create?nhrp_vc_alloc:0);}st
aticvoidnhrp_vc_check_delete(structnhrp_vc*vc){if(vc->updating||vc->ipsec||notif
ier_active(&vc->notifier_list))return;hash_release(nhrp_vc_hash,vc);nhrp_vc_free
(vc);}staticvoidnhrp_vc_update(structnhrp_vc*vc,longcmd){vc->updating=1;notifier
_call(&vc->notifier_list,cmd);vc->updating=0;nhrp_vc_check_delete(vc);}staticvoi
dnhrp_vc_ipsec_reset(structnhrp_vc*vc){vc->local.id[0]=0;vc->local.certlen=0;vc-
>remote.id[0]=0;vc->remote.certlen=0;}intnhrp_vc_ipsec_updown(uint32_tchild_id,s
tructnhrp_vc*vc){charbuf[2][SU_ADDRSTRLEN];structchild_sa*sa=NULL,*lsa;uint32_tc
hild_hash=child_id%ZEBRA_NUM_OF(childlist_head);intabort_migration=0;list_for_ea
ch_entry(lsa,&childlist_head[child_hash],childlist_entry){if(lsa->id==child_id){
sa=lsa;break;}}if(!sa){if(!vc)return0;sa=XMALLOC(MTYPE_NHRP_VC,sizeof(structchil
d_sa));if(!sa)return0;*sa=(structchild_sa){.id=child_id,.childlist_entry=LIST_IN
ITIALIZER(sa->childlist_entry),.vc=NULL,};list_add_tail(&sa->childlist_entry,&ch
ildlist_head[child_hash]);}if(sa->vc==vc)return0;if(vc){/*AttachfirsttonewVC*/vc
->ipsec++;nhrp_vc_update(vc,NOTIFY_VC_IPSEC_CHANGED);}if(sa->vc&&vc){/*Notifyold
VCofmigration*/sa->vc->abort_migration=0;debugf(NHRP_DEBUG_COMMON,"IPsecNBMAchan
geof%sto%s",sockunion2str(&sa->vc->remote.nbma,buf[0],sizeofbuf[0]),sockunion2st
r(&vc->remote.nbma,buf[1],sizeofbuf[1]));nhrp_vc_update(sa->vc,NOTIFY_VC_IPSEC_U
PDATE_NBMA);abort_migration=sa->vc->abort_migration;}if(sa->vc){/*DeattacholdVC*
/sa->vc->ipsec--;if(!sa->vc->ipsec)nhrp_vc_ipsec_reset(sa->vc);nhrp_vc_update(sa
->vc,NOTIFY_VC_IPSEC_CHANGED);}/*Update*/sa->vc=vc;if(!vc){list_del(&sa->childli
st_entry);XFREE(MTYPE_NHRP_VC,sa);}returnabort_migration;}voidnhrp_vc_notify_add
(structnhrp_vc*vc,structnotifier_block*n,notifier_fn_taction){notifier_add(n,&vc
->notifier_list,action);}voidnhrp_vc_notify_del(structnhrp_vc*vc,structnotifier_
block*n){notifier_del(n);nhrp_vc_check_delete(vc);}structnhrp_vc_iterator_ctx{vo
id(*cb)(structnhrp_vc*,void*);void*ctx;};staticvoidnhrp_vc_iterator(structhash_b
acket*b,void*ctx){structnhrp_vc_iterator_ctx*ic=ctx;ic->cb(b->data,ic->ctx);}voi
dnhrp_vc_foreach(void(*cb)(structnhrp_vc*,void*),void*ctx){structnhrp_vc_iterato
r_ctxic={.cb=cb,.ctx=ctx,};hash_iterate(nhrp_vc_hash,nhrp_vc_iterator,&ic);}void
nhrp_vc_init(void){size_ti;nhrp_vc_hash=hash_create(nhrp_vc_key,nhrp_vc_cmp,"NHR
PVChash");for(i=0;i<ZEBRA_NUM_OF(childlist_head);i++)list_init(&childlist_head[i
]);}voidnhrp_vc_reset(void){structchild_sa*sa,*n;size_ti;for(i=0;i<ZEBRA_NUM_OF(
childlist_head);i++){list_for_each_entry_safe(sa,n,&childlist_head[i],childlist_
entry)nhrp_vc_ipsec_updown(sa->id,0);}}voidnhrp_vc_terminate(void){nhrp_vc_reset
();hash_clean(nhrp_vc_hash,nhrp_vc_free);}