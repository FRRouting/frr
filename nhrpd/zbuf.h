/*Stream/packetbufferAPI*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoftware:
youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLicensea
spublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyouropti
on)anylaterversion.*/#ifndefZBUF_H#defineZBUF_H#include<stdint.h>#include<string
.h>#include<endian.h>#include<sys/types.h>#include"zassert.h"#include"list.h"str
uctzbuf{structlist_headqueue_list;unsignedallocated:1;unsignederror:1;uint8_t*bu
f,*end;uint8_t*head,*tail;};structzbuf_queue{structlist_headqueue_head;};structz
buf*zbuf_alloc(size_tsize);voidzbuf_init(structzbuf*zb,void*buf,size_tlen,size_t
datalen);voidzbuf_free(structzbuf*zb);staticinlinesize_tzbuf_size(structzbuf*zb)
{returnzb->end-zb->buf;}staticinlinesize_tzbuf_used(structzbuf*zb){returnzb->tai
l-zb->head;}staticinlinesize_tzbuf_tailroom(structzbuf*zb){returnzb->end-zb->tai
l;}staticinlinesize_tzbuf_headroom(structzbuf*zb){returnzb->head-zb->buf;}voidzb
uf_reset(structzbuf*zb);voidzbuf_reset_head(structzbuf*zb,void*ptr);ssize_tzbuf_
read(structzbuf*zb,intfd,size_tmaxlen);ssize_tzbuf_write(structzbuf*zb,intfd);ss
ize_tzbuf_recv(structzbuf*zb,intfd);ssize_tzbuf_send(structzbuf*zb,intfd);static
inlinevoidzbuf_set_rerror(structzbuf*zb){zb->error=1;zb->head=zb->tail;}staticin
linevoidzbuf_set_werror(structzbuf*zb){zb->error=1;zb->tail=zb->end;}staticinlin
evoid*__zbuf_pull(structzbuf*zb,size_tsize,interror){void*head=zb->head;if(size>
zbuf_used(zb)){if(error)zbuf_set_rerror(zb);returnNULL;}zb->head+=size;returnhea
d;}#definezbuf_pull(zb,type)((type*)__zbuf_pull(zb,sizeof(type),1))#definezbuf_p
ulln(zb,sz)((void*)__zbuf_pull(zb,sz,1))#definezbuf_may_pull(zb,type)((type*)__z
buf_pull(zb,sizeof(type),0))#definezbuf_may_pulln(zb,sz)((void*)__zbuf_pull(zb,s
z,0))void*zbuf_may_pull_until(structzbuf*zb,constchar*sep,structzbuf*msg);static
inlinevoidzbuf_get(structzbuf*zb,void*dst,size_tlen){void*src=zbuf_pulln(zb,len)
;if(src)memcpy(dst,src,len);}staticinlineuint8_tzbuf_get8(structzbuf*zb){uint8_t
*src=zbuf_pull(zb,uint8_t);if(src)return*src;return0;}staticinlineuint32_tzbuf_g
et32(structzbuf*zb){structunaligned32{uint32_tvalue;}__attribute__((packed));str
uctunaligned32*v=zbuf_pull(zb,structunaligned32);if(v)returnv->value;return0;}st
aticinlineuint16_tzbuf_get_be16(structzbuf*zb){structunaligned16{uint16_tvalue;}
__attribute__((packed));structunaligned16*v=zbuf_pull(zb,structunaligned16);if(v
)returnbe16toh(v->value);return0;}staticinlineuint32_tzbuf_get_be32(structzbuf*z
b){returnbe32toh(zbuf_get32(zb));}staticinlinevoid*__zbuf_push(structzbuf*zb,siz
e_tsize,interror){void*tail=zb->tail;if(size>zbuf_tailroom(zb)){if(error)zbuf_se
t_werror(zb);returnNULL;}zb->tail+=size;returntail;}#definezbuf_push(zb,type)((t
ype*)__zbuf_push(zb,sizeof(type),1))#definezbuf_pushn(zb,sz)((void*)__zbuf_push(
zb,sz,1))#definezbuf_may_push(zb,type)((type*)__zbuf_may_push(zb,sizeof(type),0)
)#definezbuf_may_pushn(zb,sz)((void*)__zbuf_push(zb,sz,0))staticinlinevoidzbuf_p
ut(structzbuf*zb,constvoid*src,size_tlen){void*dst=zbuf_pushn(zb,len);if(dst)mem
cpy(dst,src,len);}staticinlinevoidzbuf_put8(structzbuf*zb,uint8_tval){uint8_t*ds
t=zbuf_push(zb,uint8_t);if(dst)*dst=val;}staticinlinevoidzbuf_put_be16(structzbu
f*zb,uint16_tval){structunaligned16{uint16_tvalue;}__attribute__((packed));struc
tunaligned16*v=zbuf_push(zb,structunaligned16);if(v)v->value=htobe16(val);}stati
cinlinevoidzbuf_put_be32(structzbuf*zb,uint32_tval){structunaligned32{uint32_tva
lue;}__attribute__((packed));structunaligned32*v=zbuf_push(zb,structunaligned32)
;if(v)v->value=htobe32(val);}voidzbuf_copy(structzbuf*zb,structzbuf*src,size_tle
n);voidzbufq_init(structzbuf_queue*);voidzbufq_reset(structzbuf_queue*);voidzbuf
q_queue(structzbuf_queue*,structzbuf*);intzbufq_write(structzbuf_queue*,int);#en
dif