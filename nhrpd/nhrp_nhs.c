/*NHRPNHCnexthopserverfunctions(registration)*Copyright(c)2014-2015TimoTerÃ¤s**Th
isfileisfreesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNU
GeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheL
icense,or*(atyouroption)anylaterversion.*/#include"zebra.h"#include"zbuf.h"#incl
ude"memory.h"#include"thread.h"#include"nhrpd.h"#include"nhrp_protocol.h"DEFINE_
MTYPE_STATIC(NHRPD,NHRP_NHS,"NHRPnexthopserver")DEFINE_MTYPE_STATIC(NHRPD,NHRP_R
EGISTRATION,"NHRPregistrationentries")staticintnhrp_nhs_resolve(structthread*t);
staticintnhrp_reg_send_req(structthread*t);staticvoidnhrp_reg_reply(structnhrp_r
eqid*reqid,void*arg){structnhrp_packet_parser*p=arg;structnhrp_registration*r=co
ntainer_of(reqid,structnhrp_registration,reqid);structnhrp_nhs*nhs=r->nhs;struct
interface*ifp=nhs->ifp;structnhrp_interface*nifp=ifp->info;structnhrp_extension_
header*ext;structnhrp_cie_header*cie;structnhrp_cache*c;structzbufextpl;unionsoc
kunioncie_nbma,cie_proto,*proto;charbuf[64];intok=0,holdtime;nhrp_reqid_free(&nh
rp_packet_reqid,&r->reqid);if(p->hdr->type!=NHRP_PACKET_REGISTRATION_REPLY){debu
gf(NHRP_DEBUG_COMMON,"NHS:Registrationfailed");return;}debugf(NHRP_DEBUG_COMMON,
"NHS:Reg.replyreceived");ok=1;while((cie=nhrp_cie_pull(&p->payload,p->hdr,&cie_n
bma,&cie_proto))!=NULL){proto=sockunion_family(&cie_proto)!=AF_UNSPEC?&cie_proto
:&p->src_proto;debugf(NHRP_DEBUG_COMMON,"NHS:CIEregistration:%s:%d",sockunion2st
r(proto,buf,sizeof(buf)),cie->code);if(!((cie->code==NHRP_CODE_SUCCESS)||(cie->c
ode==NHRP_CODE_ADMINISTRATIVELY_PROHIBITED&&nhs->hub)))ok=0;}if(!ok)return;/*Par
seextensions*/sockunion_family(&nifp->nat_nbma)=AF_UNSPEC;while((ext=nhrp_ext_pu
ll(&p->extensions,&extpl))!=NULL){switch(htons(ext->type)&~NHRP_EXTENSION_FLAG_C
OMPULSORY){caseNHRP_EXTENSION_NAT_ADDRESS:/*NHSaddssecondCIEifNATisdetected*/if(
nhrp_cie_pull(&extpl,p->hdr,&cie_nbma,&cie_proto)&&nhrp_cie_pull(&extpl,p->hdr,&
cie_nbma,&cie_proto)){nifp->nat_nbma=cie_nbma;debugf(NHRP_DEBUG_IF,"%s:NATdetect
ed,realNBMAaddress:%s",ifp->name,sockunion2str(&nifp->nbma,buf,sizeof(buf)));}br
eak;}}/*Success-schedulenextregistration,androuteNHS*/r->timeout=2;holdtime=nifp
->afi[nhs->afi].holdtime;THREAD_OFF(r->t_register);/*RFC23325.2.3-Registrationis
recommendtoberenewed*everyonethirdofholdtime*/thread_add_timer(master,nhrp_reg_s
end_req,r,holdtime/3,&r->t_register);r->proto_addr=p->dst_proto;c=nhrp_cache_get
(ifp,&p->dst_proto,1);if(c)nhrp_cache_update_binding(c,NHRP_CACHE_NHS,holdtime,n
hrp_peer_ref(r->peer),0,NULL);}staticintnhrp_reg_timeout(structthread*t){structn
hrp_registration*r=THREAD_ARG(t);structnhrp_cache*c;r->t_register=NULL;if(r->tim
eout>=16&&sockunion_family(&r->proto_addr)!=AF_UNSPEC){nhrp_reqid_free(&nhrp_pac
ket_reqid,&r->reqid);c=nhrp_cache_get(r->nhs->ifp,&r->proto_addr,0);if(c)nhrp_ca
che_update_binding(c,NHRP_CACHE_NHS,-1,NULL,0,NULL);sockunion_family(&r->proto_a
ddr)=AF_UNSPEC;}r->timeout<<=1;if(r->timeout>64)r->timeout=2;thread_add_timer_ms
ec(master,nhrp_reg_send_req,r,10,&r->t_register);return0;}staticvoidnhrp_reg_pee
r_notify(structnotifier_block*n,unsignedlongcmd){structnhrp_registration*r=conta
iner_of(n,structnhrp_registration,peer_notifier);charbuf[SU_ADDRSTRLEN];switch(c
md){caseNOTIFY_PEER_UP:caseNOTIFY_PEER_DOWN:caseNOTIFY_PEER_IFCONFIG_CHANGED:cas
eNOTIFY_PEER_MTU_CHANGED:debugf(NHRP_DEBUG_COMMON,"NHS:Flushtimerfor%s",sockunio
n2str(&r->peer->vc->remote.nbma,buf,sizeofbuf));THREAD_TIMER_OFF(r->t_register);
thread_add_timer_msec(master,nhrp_reg_send_req,r,10,&r->t_register);break;}}stat
icintnhrp_reg_send_req(structthread*t){structnhrp_registration*r=THREAD_ARG(t);s
tructnhrp_nhs*nhs=r->nhs;charbuf1[SU_ADDRSTRLEN],buf2[SU_ADDRSTRLEN];structinter
face*ifp=nhs->ifp;structnhrp_interface*nifp=ifp->info;structnhrp_afi_data*if_ad=
&nifp->afi[nhs->afi];unionsockunion*dst_proto;structzbuf*zb;structnhrp_packet_he
ader*hdr;structnhrp_extension_header*ext;structnhrp_cie_header*cie;r->t_register
=NULL;if(!nhrp_peer_check(r->peer,2)){debugf(NHRP_DEBUG_COMMON,"NHS:Waitinglinkf
or%s",sockunion2str(&r->peer->vc->remote.nbma,buf1,sizeofbuf1));thread_add_timer
(master,nhrp_reg_send_req,r,120,&r->t_register);return0;}thread_add_timer(master
,nhrp_reg_timeout,r,r->timeout,&r->t_register);/*RFC23325.2.3NHCusesit'sownaddre
ssasdstifNHSisunknown*/dst_proto=&nhs->proto_addr;if(sockunion_family(dst_proto)
==AF_UNSPEC)dst_proto=&if_ad->addr;sockunion2str(&if_ad->addr,buf1,sizeof(buf1))
;sockunion2str(dst_proto,buf2,sizeof(buf2));debugf(NHRP_DEBUG_COMMON,"NHS:Regist
er%s->%s(timeout%d)",buf1,buf2,r->timeout);/*Noprotocoladdressconfiguredfortunne
linterface*/if(sockunion_family(&if_ad->addr)==AF_UNSPEC)return0;zb=zbuf_alloc(1
400);hdr=nhrp_packet_push(zb,NHRP_PACKET_REGISTRATION_REQUEST,&nifp->nbma,&if_ad
->addr,dst_proto);hdr->hop_count=1;if(!(if_ad->flags&NHRP_IFF_REG_NO_UNIQUE))hdr
->flags|=htons(NHRP_FLAG_REGISTRATION_UNIQUE);hdr->u.request_id=htonl(nhrp_reqid
_alloc(&nhrp_packet_reqid,&r->reqid,nhrp_reg_reply));/*FIXME:pushCIEforeachlocal
protocoladdress*/cie=nhrp_cie_push(zb,NHRP_CODE_SUCCESS,NULL,NULL);cie->prefix_l
ength=0xff;cie->holding_time=htons(if_ad->holdtime);cie->mtu=htons(if_ad->mtu);n
hrp_ext_request(zb,hdr,ifp);/*CiscoNATdetectionextension*/hdr->flags|=htons(NHRP
_FLAG_REGISTRATION_NAT);ext=nhrp_ext_push(zb,hdr,NHRP_EXTENSION_NAT_ADDRESS);cie
=nhrp_cie_push(zb,NHRP_CODE_SUCCESS,&nifp->nbma,&if_ad->addr);cie->prefix_length
=8*sockunion_get_addrlen(&if_ad->addr);nhrp_ext_complete(zb,ext);nhrp_packet_com
plete(zb,hdr);nhrp_peer_send(r->peer,zb);zbuf_free(zb);return0;}staticvoidnhrp_r
eg_delete(structnhrp_registration*r){nhrp_peer_notify_del(r->peer,&r->peer_notif
ier);nhrp_peer_unref(r->peer);list_del(&r->reglist_entry);THREAD_OFF(r->t_regist
er);XFREE(MTYPE_NHRP_REGISTRATION,r);}staticstructnhrp_registration*nhrp_reg_by_
nbma(structnhrp_nhs*nhs,constunionsockunion*nbma_addr){structnhrp_registration*r
;list_for_each_entry(r,&nhs->reglist_head,reglist_entry)if(sockunion_same(&r->pe
er->vc->remote.nbma,nbma_addr))returnr;returnNULL;}staticvoidnhrp_nhs_resolve_cb
(structresolver_query*q,intn,unionsockunion*addrs){structnhrp_nhs*nhs=container_
of(q,structnhrp_nhs,dns_resolve);structnhrp_interface*nifp=nhs->ifp->info;struct
nhrp_registration*reg,*regn;inti;nhs->t_resolve=NULL;if(n<0){/*Failed,retryinamo
ment*/thread_add_timer(master,nhrp_nhs_resolve,nhs,5,&nhs->t_resolve);return;}th
read_add_timer(master,nhrp_nhs_resolve,nhs,2*60*60,&nhs->t_resolve);list_for_eac
h_entry(reg,&nhs->reglist_head,reglist_entry)reg->mark=1;nhs->hub=0;for(i=0;i<n;
i++){if(sockunion_same(&addrs[i],&nifp->nbma)){nhs->hub=1;continue;}reg=nhrp_reg
_by_nbma(nhs,&addrs[i]);if(reg){reg->mark=0;continue;}reg=XCALLOC(MTYPE_NHRP_REG
ISTRATION,sizeof(*reg));reg->peer=nhrp_peer_get(nhs->ifp,&addrs[i]);reg->nhs=nhs
;reg->timeout=1;list_init(&reg->reglist_entry);list_add_tail(&reg->reglist_entry
,&nhs->reglist_head);nhrp_peer_notify_add(reg->peer,&reg->peer_notifier,nhrp_reg
_peer_notify);thread_add_timer_msec(master,nhrp_reg_send_req,reg,50,&reg->t_regi
ster);}list_for_each_entry_safe(reg,regn,&nhs->reglist_head,reglist_entry){if(re
g->mark)nhrp_reg_delete(reg);}}staticintnhrp_nhs_resolve(structthread*t){structn
hrp_nhs*nhs=THREAD_ARG(t);resolver_resolve(&nhs->dns_resolve,AF_INET,nhs->nbma_f
qdn,nhrp_nhs_resolve_cb);return0;}intnhrp_nhs_add(structinterface*ifp,afi_tafi,u
nionsockunion*proto_addr,constchar*nbma_fqdn){structnhrp_interface*nifp=ifp->inf
o;structnhrp_nhs*nhs;if(sockunion_family(proto_addr)!=AF_UNSPEC&&sockunion_famil
y(proto_addr)!=afi2family(afi))returnNHRP_ERR_PROTOCOL_ADDRESS_MISMATCH;list_for
_each_entry(nhs,&nifp->afi[afi].nhslist_head,nhslist_entry){if(sockunion_family(
&nhs->proto_addr)!=AF_UNSPEC&&sockunion_family(proto_addr)!=AF_UNSPEC&&sockunion
_same(&nhs->proto_addr,proto_addr))returnNHRP_ERR_ENTRY_EXISTS;if(strcmp(nhs->nb
ma_fqdn,nbma_fqdn)==0)returnNHRP_ERR_ENTRY_EXISTS;}nhs=XMALLOC(MTYPE_NHRP_NHS,si
zeof(structnhrp_nhs));if(!nhs)returnNHRP_ERR_NO_MEMORY;*nhs=(structnhrp_nhs){.af
i=afi,.ifp=ifp,.proto_addr=*proto_addr,.nbma_fqdn=strdup(nbma_fqdn),.reglist_hea
d=LIST_INITIALIZER(nhs->reglist_head),};list_add_tail(&nhs->nhslist_entry,&nifp-
>afi[afi].nhslist_head);thread_add_timer_msec(master,nhrp_nhs_resolve,nhs,1000,&
nhs->t_resolve);returnNHRP_OK;}intnhrp_nhs_del(structinterface*ifp,afi_tafi,unio
nsockunion*proto_addr,constchar*nbma_fqdn){structnhrp_interface*nifp=ifp->info;s
tructnhrp_nhs*nhs,*nnhs;intret=NHRP_ERR_ENTRY_NOT_FOUND;if(sockunion_family(prot
o_addr)!=AF_UNSPEC&&sockunion_family(proto_addr)!=afi2family(afi))returnNHRP_ERR
_PROTOCOL_ADDRESS_MISMATCH;list_for_each_entry_safe(nhs,nnhs,&nifp->afi[afi].nhs
list_head,nhslist_entry){if(!sockunion_same(&nhs->proto_addr,proto_addr))continu
e;if(strcmp(nhs->nbma_fqdn,nbma_fqdn)!=0)continue;nhrp_nhs_free(nhs);ret=NHRP_OK
;}returnret;}intnhrp_nhs_free(structnhrp_nhs*nhs){structnhrp_registration*r,*rn;
list_for_each_entry_safe(r,rn,&nhs->reglist_head,reglist_entry)nhrp_reg_delete(r
);THREAD_OFF(nhs->t_resolve);list_del(&nhs->nhslist_entry);free((void*)nhs->nbma
_fqdn);XFREE(MTYPE_NHRP_NHS,nhs);return0;}voidnhrp_nhs_terminate(void){structvrf
*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp;structnhrp_interface*nifp
;structnhrp_nhs*nhs,*tmp;afi_tafi;FOR_ALL_INTERFACES(vrf,ifp){nifp=ifp->info;for
(afi=0;afi<AFI_MAX;afi++){list_for_each_entry_safe(nhs,tmp,&nifp->afi[afi].nhsli
st_head,nhslist_entry)nhrp_nhs_free(nhs);}}}voidnhrp_nhs_foreach(structinterface
*ifp,afi_tafi,void(*cb)(structnhrp_nhs*,structnhrp_registration*,void*),void*ctx
){structnhrp_interface*nifp=ifp->info;structnhrp_nhs*nhs;structnhrp_registration
*reg;list_for_each_entry(nhs,&nifp->afi[afi].nhslist_head,nhslist_entry){if(!lis
t_empty(&nhs->reglist_head)){list_for_each_entry(reg,&nhs->reglist_head,reglist_
entry)cb(nhs,reg,ctx);}elsecb(nhs,0,ctx);}}