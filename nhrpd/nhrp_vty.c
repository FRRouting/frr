/*NHRPvtyhandling*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoftware:youmayc
opy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseaspublis
hedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyouroption)anyl
aterversion.*/#include"zebra.h"#include"command.h"#include"zclient.h"#include"st
ream.h"#include"filter.h"#include"nhrpd.h"#include"netlink.h"staticstructcmd_nod
ezebra_node={.node=ZEBRA_NODE,.prompt="%s(config-router)#",.vtysh=1,};staticstru
ctcmd_nodenhrp_interface_node={.node=INTERFACE_NODE,.prompt="%s(config-if)#",.vt
ysh=1,};#defineNHRP_DEBUG_FLAGS_CMD"<all|common|event|interface|kernel|route|vic
i>"#defineNHRP_DEBUG_FLAGS_STR\"Allmessages\n"\"Commonmessages(default)\n"\"Even
tmanagermessages\n"\"Interfacemessages\n"\"Kernelmessages\n"\"Routemessages\n"\"
VICImessages\n"staticconststructmessagedebug_flags_desc[]={{NHRP_DEBUG_ALL,"all"
},{NHRP_DEBUG_COMMON,"common"},{NHRP_DEBUG_IF,"interface"},{NHRP_DEBUG_KERNEL,"k
ernel"},{NHRP_DEBUG_ROUTE,"route"},{NHRP_DEBUG_VICI,"vici"},{NHRP_DEBUG_EVENT,"e
vent"},{0}};staticconststructmessageinterface_flags_desc[]={{NHRP_IFF_SHORTCUT,"
shortcut"},{NHRP_IFF_REDIRECT,"redirect"},{NHRP_IFF_REG_NO_UNIQUE,"registrationn
o-unique"},{0}};staticintnhrp_vty_return(structvty*vty,intret){staticconstchar*c
onsterrmsgs[]={[NHRP_ERR_FAIL]="Commandfailed",[NHRP_ERR_NO_MEMORY]="Outofmemory
",[NHRP_ERR_UNSUPPORTED_INTERFACE]="NHRPnotsupportedonthisinterface",[NHRP_ERR_N
HRP_NOT_ENABLED]="NHRPnotenabled(set'nhrpnetwork-id'first)",[NHRP_ERR_ENTRY_EXIS
TS]="Entryexistsalready",[NHRP_ERR_ENTRY_NOT_FOUND]="Entrynotfound",[NHRP_ERR_PR
OTOCOL_ADDRESS_MISMATCH]="Protocoladdressfamilydoesnotmatchcommand(ip/ipv6mismat
ch)",};constchar*str=NULL;charbuf[256];if(ret==NHRP_OK)returnCMD_SUCCESS;if(ret>
0&&ret<=NHRP_ERR_MAX)if(errmsgs[ret])str=errmsgs[ret];if(!str){str=buf;snprintf(
buf,sizeof(buf),"Unknownerror%d",ret);}vty_out(vty,"%%%s\n",str);returnCMD_WARNI
NG_CONFIG_FAILED;;}staticinttoggle_flag(structvty*vty,conststructmessage*flag_de
sc,constchar*name,inton_off,unsigned*flags){inti;for(i=0;flag_desc[i].str!=NULL;
i++){if(strcmp(flag_desc[i].str,name)!=0)continue;if(on_off)*flags|=flag_desc[i]
.key;else*flags&=~flag_desc[i].key;returnCMD_SUCCESS;}vty_out(vty,"%%Invalidvalu
e%s\n",name);returnCMD_WARNING_CONFIG_FAILED;;}#ifndefNO_DEBUGDEFUN_NOSH(show_de
bugging_nhrp,show_debugging_nhrp_cmd,"showdebugging[nhrp]",SHOW_STR"Debugginginf
ormation\n""NHRPconfiguration\n"){inti;vty_out(vty,"NHRPdebuggingstatus:\n");for
(i=0;debug_flags_desc[i].str!=NULL;i++){if(debug_flags_desc[i].key==NHRP_DEBUG_A
LL)continue;if(!(debug_flags_desc[i].key&debug_flags))continue;vty_out(vty,"NHRP
%sdebuggingison\n",debug_flags_desc[i].str);}returnCMD_SUCCESS;}DEFUN(debug_nhrp
,debug_nhrp_cmd,"debugnhrp"NHRP_DEBUG_FLAGS_CMD,"Enabledebugmessagesforspecifico
rallparts.\n""NHRPinformation\n"NHRP_DEBUG_FLAGS_STR){returntoggle_flag(vty,debu
g_flags_desc,argv[2]->text,1,&debug_flags);}DEFUN(no_debug_nhrp,no_debug_nhrp_cm
d,"nodebugnhrp"NHRP_DEBUG_FLAGS_CMD,NO_STR"Disabledebugmessagesforspecificorallp
arts.\n""NHRPinformation\n"NHRP_DEBUG_FLAGS_STR){returntoggle_flag(vty,debug_fla
gs_desc,argv[3]->text,0,&debug_flags);}#endif/*NO_DEBUG*/staticintnhrp_config_wr
ite(structvty*vty){#ifndefNO_DEBUGif(debug_flags==NHRP_DEBUG_ALL){vty_out(vty,"d
ebugnhrpall\n");}else{inti;for(i=0;debug_flags_desc[i].str!=NULL;i++){if(debug_f
lags_desc[i].key==NHRP_DEBUG_ALL)continue;if(!(debug_flags&debug_flags_desc[i].k
ey))continue;vty_out(vty,"debugnhrp%s\n",debug_flags_desc[i].str);}}vty_out(vty,
"!\n");#endif/*NO_DEBUG*/if(nhrp_event_socket_path){vty_out(vty,"nhrpeventsocket
%s\n",nhrp_event_socket_path);}if(netlink_nflog_group){vty_out(vty,"nhrpnflog-gr
oup%d\n",netlink_nflog_group);}return0;}#defineIP_STR"IPinformation\n"#defineIPV
6_STR"IPv6information\n"#defineAFI_CMD"<ip|ipv6>"#defineAFI_STRIP_STRIPV6_STR#de
fineNHRP_STR"NextHopResolutionProtocolfunctions\n"staticafi_tcmd_to_afi(conststr
uctcmd_token*tok){returnstrcmp(tok->text,"ipv6")==0?AFI_IP6:AFI_IP;}staticconstc
har*afi_to_cmd(afi_tafi){if(afi==AFI_IP6)return"ipv6";return"ip";}DEFUN(nhrp_eve
nt_socket,nhrp_event_socket_cmd,"nhrpeventsocketSOCKET",NHRP_STR"EventManagercom
mands\n""EventManagerunixsocketpath\n""Unixpathforthesocket\n"){evmgr_set_socket
(argv[3]->arg);returnCMD_SUCCESS;}DEFUN(no_nhrp_event_socket,no_nhrp_event_socke
t_cmd,"nonhrpeventsocket[SOCKET]",NO_STRNHRP_STR"EventManagercommands\n""EventMa
nagerunixsocketpath\n""Unixpathforthesocket\n"){evmgr_set_socket(NULL);returnCMD
_SUCCESS;}DEFUN(nhrp_nflog_group,nhrp_nflog_group_cmd,"nhrpnflog-group(1-65535)"
,NHRP_STR"SpecifyNFLOGgroupnumber\n""NFLOGgroupnumber\n"){uint32_tnfgroup;nfgrou
p=strtoul(argv[2]->arg,NULL,10);netlink_set_nflog_group(nfgroup);returnCMD_SUCCE
SS;}DEFUN(no_nhrp_nflog_group,no_nhrp_nflog_group_cmd,"nonhrpnflog-group[(1-6553
5)]",NO_STRNHRP_STR"SpecifyNFLOGgroupnumber\n""NFLOGgroupnumber\n"){netlink_set_
nflog_group(0);returnCMD_SUCCESS;}DEFUN(tunnel_protection,tunnel_protection_cmd,
"tunnelprotectionviciprofilePROFILE[fallback-profileFALLBACK]","NHRP/GREintegrat
ion\n""IPsecprotection\n""VICI(StrongSwan)\n""IPsecprofile\n""IPsecprofilename\n
""FallbackIPsecprofile\n""FallbackIPsecprofilename\n"){VTY_DECLVAR_CONTEXT(inter
face,ifp);nhrp_interface_set_protection(ifp,argv[4]->arg,argc>6?argv[6]->arg:NUL
L);returnCMD_SUCCESS;}DEFUN(no_tunnel_protection,no_tunnel_protection_cmd,"notun
nelprotection",NO_STR"NHRP/GREintegration\n""IPsecprotection\n"){VTY_DECLVAR_CON
TEXT(interface,ifp);nhrp_interface_set_protection(ifp,NULL,NULL);returnCMD_SUCCE
SS;}DEFUN(tunnel_source,tunnel_source_cmd,"tunnelsourceINTERFACE","NHRP/GREinteg
ration\n""Tunneldevicebindingtracking\n""Interfacename\n"){VTY_DECLVAR_CONTEXT(i
nterface,ifp);nhrp_interface_set_source(ifp,argv[2]->arg);returnCMD_SUCCESS;}DEF
UN(no_tunnel_source,no_tunnel_source_cmd,"notunnelsource","NHRP/GREintegration\n
""Tunneldevicebindingtracking\n""Interfacename\n"){VTY_DECLVAR_CONTEXT(interface
,ifp);nhrp_interface_set_source(ifp,NULL);returnCMD_SUCCESS;}DEFUN(if_nhrp_netwo
rk_id,if_nhrp_network_id_cmd,AFI_CMD"nhrpnetwork-id(1-4294967295)",AFI_STRNHRP_S
TR"EnableNHRPandspecifynetwork-id\n""SystemlocalIDtospecifyinterfacegroup\n"){VT
Y_DECLVAR_CONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;afi_tafi=cm
d_to_afi(argv[0]);nifp->afi[afi].network_id=strtoul(argv[3]->arg,NULL,10);nhrp_i
nterface_update(ifp);returnCMD_SUCCESS;}DEFUN(if_no_nhrp_network_id,if_no_nhrp_n
etwork_id_cmd,"no"AFI_CMD"nhrpnetwork-id[(1-4294967295)]",NO_STRAFI_STRNHRP_STR"
EnableNHRPandspecifynetwork-id\n""SystemlocalIDtospecifyinterfacegroup\n"){VTY_D
ECLVAR_CONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;afi_tafi=cmd_t
o_afi(argv[1]);nifp->afi[afi].network_id=0;nhrp_interface_update(ifp);returnCMD_
SUCCESS;}DEFUN(if_nhrp_flags,if_nhrp_flags_cmd,AFI_CMD"nhrp<shortcut|redirect>",
AFI_STRNHRP_STR"Allowshortcutestablishment\n""Sendredirectnotifications\n"){VTY_
DECLVAR_CONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;afi_tafi=cmd_
to_afi(argv[0]);returntoggle_flag(vty,interface_flags_desc,argv[2]->text,1,&nifp
->afi[afi].flags);}DEFUN(if_no_nhrp_flags,if_no_nhrp_flags_cmd,"no"AFI_CMD"nhrp<
shortcut|redirect>",NO_STRAFI_STRNHRP_STR"Allowshortcutestablishment\n""Sendredi
rectnotifications\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structnhrp_interface*ni
fp=ifp->info;afi_tafi=cmd_to_afi(argv[1]);returntoggle_flag(vty,interface_flags_
desc,argv[3]->text,0,&nifp->afi[afi].flags);}DEFUN(if_nhrp_reg_flags,if_nhrp_reg
_flags_cmd,AFI_CMD"nhrpregistrationno-unique",AFI_STRNHRP_STR"Registrationconfig
uration\n""Don'tsetuniqueflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structnhrp_
interface*nifp=ifp->info;afi_tafi=cmd_to_afi(argv[0]);charname[256];snprintf(nam
e,sizeof(name),"registration%s",argv[3]->text);returntoggle_flag(vty,interface_f
lags_desc,name,1,&nifp->afi[afi].flags);}DEFUN(if_no_nhrp_reg_flags,if_no_nhrp_r
eg_flags_cmd,"no"AFI_CMD"nhrpregistrationno-unique",NO_STRAFI_STRNHRP_STR"Regist
rationconfiguration\n""Don'tsetuniqueflag\n"){VTY_DECLVAR_CONTEXT(interface,ifp)
;structnhrp_interface*nifp=ifp->info;afi_tafi=cmd_to_afi(argv[1]);charname[256];
snprintf(name,sizeof(name),"registration%s",argv[4]->text);returntoggle_flag(vty
,interface_flags_desc,name,0,&nifp->afi[afi].flags);}DEFUN(if_nhrp_holdtime,if_n
hrp_holdtime_cmd,AFI_CMD"nhrpholdtime(1-65000)",AFI_STRNHRP_STR"SpecifyNBMAaddre
ssvaliditytime\n""TimeinsecondsthatNBMAaddressesareadvertisedvalid\n"){VTY_DECLV
AR_CONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;afi_tafi=cmd_to_af
i(argv[0]);nifp->afi[afi].holdtime=strtoul(argv[3]->arg,NULL,10);nhrp_interface_
update(ifp);returnCMD_SUCCESS;}DEFUN(if_no_nhrp_holdtime,if_no_nhrp_holdtime_cmd
,"no"AFI_CMD"nhrpholdtime[(1-65000)]",NO_STRAFI_STRNHRP_STR"SpecifyNBMAaddressva
liditytime\n""TimeinsecondsthatNBMAaddressesareadvertisedvalid\n"){VTY_DECLVAR_C
ONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;afi_tafi=cmd_to_afi(ar
gv[1]);nifp->afi[afi].holdtime=NHRPD_DEFAULT_HOLDTIME;nhrp_interface_update(ifp)
;returnCMD_SUCCESS;}DEFUN(if_nhrp_mtu,if_nhrp_mtu_cmd,"ipnhrpmtu<(576-1500)|open
nhrp>",IP_STRNHRP_STR"ConfigureNHRPadvertisedMTU\n""MTUvalue\n""Advertiseboundin
terfaceMTUsimilartoOpenNHRP\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structnhrp_in
terface*nifp=ifp->info;if(argv[3]->arg[0]=='o'){nifp->afi[AFI_IP].configured_mtu
=-1;}else{nifp->afi[AFI_IP].configured_mtu=strtoul(argv[3]->arg,NULL,10);}nhrp_i
nterface_update_mtu(ifp,AFI_IP);returnCMD_SUCCESS;}DEFUN(if_no_nhrp_mtu,if_no_nh
rp_mtu_cmd,"noipnhrpmtu[(576-1500)|opennhrp]",NO_STRIP_STRNHRP_STR"ConfigureNHRP
advertisedMTU\n""MTUvalue\n""AdvertiseboundinterfaceMTUsimilartoOpenNHRP\n"){VTY
_DECLVAR_CONTEXT(interface,ifp);structnhrp_interface*nifp=ifp->info;nifp->afi[AF
I_IP].configured_mtu=0;nhrp_interface_update_mtu(ifp,AFI_IP);returnCMD_SUCCESS;}
DEFUN(if_nhrp_map,if_nhrp_map_cmd,AFI_CMD"nhrpmap<A.B.C.D|X:X::X:X><A.B.C.D|loca
l>",AFI_STRNHRP_STR"NexthopServerconfiguration\n""IPv4protocoladdress\n""IPv6pro
tocoladdress\n""IPv4NBMAaddress\n""Handleprotocoladdresslocally\n"){VTY_DECLVAR_
CONTEXT(interface,ifp);afi_tafi=cmd_to_afi(argv[0]);unionsockunionproto_addr,nbm
a_addr;structnhrp_cache*c;if(str2sockunion(argv[3]->arg,&proto_addr)<0||afi2fami
ly(afi)!=sockunion_family(&proto_addr))returnnhrp_vty_return(vty,NHRP_ERR_PROTOC
OL_ADDRESS_MISMATCH);c=nhrp_cache_get(ifp,&proto_addr,1);if(!c)returnnhrp_vty_re
turn(vty,NHRP_ERR_FAIL);c->map=1;if(strmatch(argv[4]->text,"local")){nhrp_cache_
update_binding(c,NHRP_CACHE_LOCAL,0,NULL,0,NULL);}else{if(str2sockunion(argv[4]-
>arg,&nbma_addr)<0)returnnhrp_vty_return(vty,NHRP_ERR_FAIL);nhrp_cache_update_bi
nding(c,NHRP_CACHE_STATIC,0,nhrp_peer_get(ifp,&nbma_addr),0,NULL);}returnCMD_SUC
CESS;}DEFUN(if_no_nhrp_map,if_no_nhrp_map_cmd,"no"AFI_CMD"nhrpmap<A.B.C.D|X:X::X
:X>",NO_STRAFI_STRNHRP_STR"NexthopServerconfiguration\n""IPv4protocoladdress\n""
IPv6protocoladdress\n"){VTY_DECLVAR_CONTEXT(interface,ifp);afi_tafi=cmd_to_afi(a
rgv[1]);unionsockunionproto_addr;structnhrp_cache*c;if(str2sockunion(argv[4]->ar
g,&proto_addr)<0||afi2family(afi)!=sockunion_family(&proto_addr))returnnhrp_vty_
return(vty,NHRP_ERR_PROTOCOL_ADDRESS_MISMATCH);c=nhrp_cache_get(ifp,&proto_addr,
0);if(!c||!c->map)returnnhrp_vty_return(vty,NHRP_ERR_ENTRY_NOT_FOUND);nhrp_cache
_update_binding(c,c->cur.type,-1,NULL,0,NULL);returnCMD_SUCCESS;}DEFUN(if_nhrp_n
hs,if_nhrp_nhs_cmd,AFI_CMD"nhrpnhs<A.B.C.D|X:X::X:X|dynamic>nbma<A.B.C.D|FQDN>",
AFI_STRNHRP_STR"NexthopServerconfiguration\n""IPv4protocoladdress\n""IPv6protoco
laddress\n""Automaticdetectionofprotocoladdress\n""NBMAaddress\n""IPv4NBMAaddres
s\n""FullyqualifieddomainnameforNBMAaddress(es)\n"){VTY_DECLVAR_CONTEXT(interfac
e,ifp);afi_tafi=cmd_to_afi(argv[0]);unionsockunionproto_addr;intret;if(str2socku
nion(argv[3]->arg,&proto_addr)<0)sockunion_family(&proto_addr)=AF_UNSPEC;ret=nhr
p_nhs_add(ifp,afi,&proto_addr,argv[5]->arg);returnnhrp_vty_return(vty,ret);}DEFU
N(if_no_nhrp_nhs,if_no_nhrp_nhs_cmd,"no"AFI_CMD"nhrpnhs<A.B.C.D|X:X::X:X|dynamic
>nbma<A.B.C.D|FQDN>",NO_STRAFI_STRNHRP_STR"NexthopServerconfiguration\n""IPv4pro
tocoladdress\n""IPv6protocoladdress\n""Automaticdetectionofprotocoladdress\n""NB
MAaddress\n""IPv4NBMAaddress\n""FullyqualifieddomainnameforNBMAaddress(es)\n"){V
TY_DECLVAR_CONTEXT(interface,ifp);afi_tafi=cmd_to_afi(argv[1]);unionsockunionpro
to_addr;intret;if(str2sockunion(argv[4]->arg,&proto_addr)<0)sockunion_family(&pr
oto_addr)=AF_UNSPEC;ret=nhrp_nhs_del(ifp,afi,&proto_addr,argv[6]->arg);returnnhr
p_vty_return(vty,ret);}structinfo_ctx{structvty*vty;afi_tafi;intcount;};staticvo
idshow_ip_nhrp_cache(structnhrp_cache*c,void*pctx){structinfo_ctx*ctx=pctx;struc
tvty*vty=ctx->vty;charbuf[2][SU_ADDRSTRLEN];if(ctx->afi!=family2afi(sockunion_fa
mily(&c->remote_addr)))return;if(!ctx->count){vty_out(vty,"%-8s%-8s%-24s%-24s%-6
s%s\n","Iface","Type","Protocol","NBMA","Flags","Identity");}ctx->count++;vty_ou
t(ctx->vty,"%-8s%-8s%-24s%-24s%c%c%c%s\n",c->ifp->name,nhrp_cache_type_str[c->cu
r.type],sockunion2str(&c->remote_addr,buf[0],sizeofbuf[0]),c->cur.peer?sockunion
2str(&c->cur.peer->vc->remote.nbma,buf[1],sizeofbuf[1]):"-",c->used?'U':'',c->t_
timeout?'T':'',c->t_auth?'A':'',c->cur.peer?c->cur.peer->vc->remote.id:"-");}sta
ticvoidshow_ip_nhrp_nhs(structnhrp_nhs*n,structnhrp_registration*reg,void*pctx){
structinfo_ctx*ctx=pctx;structvty*vty=ctx->vty;charbuf[2][SU_ADDRSTRLEN];if(!ctx
->count){vty_out(vty,"%-8s%-24s%-16s%-16s\n","Iface","FQDN","NBMA","Protocol");}
ctx->count++;vty_out(vty,"%-8s%-24s%-16s%-16s\n",n->ifp->name,n->nbma_fqdn,(reg&
&reg->peer)?sockunion2str(&reg->peer->vc->remote.nbma,buf[0],sizeofbuf[0]):"-",s
ockunion2str(reg?&reg->proto_addr:&n->proto_addr,buf[1],sizeofbuf[1]));}staticvo
idshow_ip_nhrp_shortcut(structnhrp_shortcut*s,void*pctx){structinfo_ctx*ctx=pctx
;structnhrp_cache*c;structvty*vty=ctx->vty;charbuf1[PREFIX_STRLEN],buf2[SU_ADDRS
TRLEN];if(!ctx->count){vty_out(vty,"%-8s%-24s%-24s%s\n","Type","Prefix","Via","I
dentity");}ctx->count++;c=s->cache;vty_out(ctx->vty,"%-8s%-24s%-24s%s\n",nhrp_ca
che_type_str[s->type],prefix2str(s->p,buf1,sizeofbuf1),c?sockunion2str(&c->remot
e_addr,buf2,sizeofbuf2):"",(c&&c->cur.peer)?c->cur.peer->vc->remote.id:"");}stat
icvoidshow_ip_opennhrp_cache(structnhrp_cache*c,void*pctx){structinfo_ctx*ctx=pc
tx;charbuf[SU_ADDRSTRLEN];if(ctx->afi!=family2afi(sockunion_family(&c->remote_ad
dr)))return;vty_out(ctx->vty,"Type:%s\n""Flags:%s%s\n""Protocol-Address:%s/%zu\n
",nhrp_cache_type_str[c->cur.type],(c->cur.peer&&c->cur.peer->online)?"up":"",c-
>used?"used":"",sockunion2str(&c->remote_addr,buf,sizeofbuf),8*family2addrsize(s
ockunion_family(&c->remote_addr)));if(c->cur.peer){vty_out(ctx->vty,"NBMA-Addres
s:%s\n",sockunion2str(&c->cur.peer->vc->remote.nbma,buf,sizeofbuf));}if(sockunio
n_family(&c->cur.remote_nbma_natoa)!=AF_UNSPEC){vty_out(ctx->vty,"NBMA-NAT-OA-Ad
dress:%s\n",sockunion2str(&c->cur.remote_nbma_natoa,buf,sizeofbuf));}vty_out(ctx
->vty,"\n\n");}DEFUN(show_ip_nhrp,show_ip_nhrp_cmd,"show"AFI_CMD"nhrp[cache|nhs|
shortcut|opennhrp]",SHOW_STRAFI_STR"NHRPinformation\n""Forwardingcacheinformatio
n\n""Nexthopserverinformation\n""Shortcutinformation\n""opennhrpctlstylecachedum
p\n"){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp;structinfo
_ctxctx={.vty=vty,.afi=cmd_to_afi(argv[1]),};if(argc<=3||argv[3]->text[0]=='c'){
FOR_ALL_INTERFACES(vrf,ifp)nhrp_cache_foreach(ifp,show_ip_nhrp_cache,&ctx);}else
if(argv[3]->text[0]=='n'){FOR_ALL_INTERFACES(vrf,ifp)nhrp_nhs_foreach(ifp,ctx.af
i,show_ip_nhrp_nhs,&ctx);}elseif(argv[3]->text[0]=='s'){nhrp_shortcut_foreach(ct
x.afi,show_ip_nhrp_shortcut,&ctx);}else{vty_out(vty,"Status:ok\n\n");ctx.count++
;FOR_ALL_INTERFACES(vrf,ifp)nhrp_cache_foreach(ifp,show_ip_opennhrp_cache,&ctx);
}if(!ctx.count){vty_out(vty,"%%Noentries\n");returnCMD_WARNING;}returnCMD_SUCCES
S;}staticvoidshow_dmvpn_entry(structnhrp_vc*vc,void*ctx){structvty*vty=ctx;charb
uf[2][SU_ADDRSTRLEN];vty_out(vty,"%-24s%-24s%c%-4d%-24s\n",sockunion2str(&vc->lo
cal.nbma,buf[0],sizeofbuf[0]),sockunion2str(&vc->remote.nbma,buf[1],sizeofbuf[1]
),notifier_active(&vc->notifier_list)?'n':'',vc->ipsec,vc->remote.id);}DEFUN(sho
w_dmvpn,show_dmvpn_cmd,"showdmvpn",SHOW_STR"DMVPNinformation\n"){vty_out(vty,"%-
24s%-24s%-6s%-4s%-24s\n","Src","Dst","Flags","SAs","Identity");nhrp_vc_foreach(s
how_dmvpn_entry,vty);returnCMD_SUCCESS;}staticvoidclear_nhrp_cache(structnhrp_ca
che*c,void*data){structinfo_ctx*ctx=data;if(c->cur.type<=NHRP_CACHE_CACHED){nhrp
_cache_update_binding(c,c->cur.type,-1,NULL,0,NULL);ctx->count++;}}staticvoidcle
ar_nhrp_shortcut(structnhrp_shortcut*s,void*data){structinfo_ctx*ctx=data;nhrp_s
hortcut_purge(s,1);ctx->count++;}DEFUN(clear_nhrp,clear_nhrp_cmd,"clear"AFI_CMD"
nhrp<cache|shortcut>",CLEAR_STRAFI_STRNHRP_STR"Dynamiccacheentries\n""Shortcuten
tries\n"){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp;struct
info_ctxctx={.vty=vty,.afi=cmd_to_afi(argv[1]),.count=0,};if(argc<=3||argv[3]->t
ext[0]=='c'){FOR_ALL_INTERFACES(vrf,ifp)nhrp_cache_foreach(ifp,clear_nhrp_cache,
&ctx);}else{nhrp_shortcut_foreach(ctx.afi,clear_nhrp_shortcut,&ctx);}if(!ctx.cou
nt){vty_out(vty,"%%Noentries\n");returnCMD_WARNING;}vty_out(vty,"%%%dentriesclea
red\n",ctx.count);returnCMD_SUCCESS;}structwrite_map_ctx{structvty*vty;intfamily
;constchar*aficmd;};staticvoidinterface_config_write_nhrp_map(structnhrp_cache*c
,void*data){structwrite_map_ctx*ctx=data;structvty*vty=ctx->vty;charbuf[2][SU_AD
DRSTRLEN];if(!c->map)return;if(sockunion_family(&c->remote_addr)!=ctx->family)re
turn;vty_out(vty,"%snhrpmap%s%s\n",ctx->aficmd,sockunion2str(&c->remote_addr,buf
[0],sizeofbuf[0]),c->cur.type==NHRP_CACHE_LOCAL?"local":sockunion2str(&c->cur.pe
er->vc->remote.nbma,buf[1],sizeofbuf[1]));}staticintinterface_config_write(struc
tvty*vty){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structwrite_map_ctxmapctx;
structinterface*ifp;structnhrp_interface*nifp;structnhrp_nhs*nhs;constchar*aficm
d;afi_tafi;charbuf[SU_ADDRSTRLEN];inti;FOR_ALL_INTERFACES(vrf,ifp){vty_frame(vty
,"interface%s\n",ifp->name);if(ifp->desc)vty_out(vty,"description%s\n",ifp->desc
);nifp=ifp->info;if(nifp->ipsec_profile){vty_out(vty,"tunnelprotectionviciprofil
e%s",nifp->ipsec_profile);if(nifp->ipsec_fallback_profile)vty_out(vty,"fallback-
profile%s",nifp->ipsec_fallback_profile);vty_out(vty,"\n");}if(nifp->source)vty_
out(vty,"tunnelsource%s\n",nifp->source);for(afi=0;afi<AFI_MAX;afi++){structnhrp
_afi_data*ad=&nifp->afi[afi];aficmd=afi_to_cmd(afi);if(ad->network_id)vty_out(vt
y,"%snhrpnetwork-id%u\n",aficmd,ad->network_id);if(ad->holdtime!=NHRPD_DEFAULT_H
OLDTIME)vty_out(vty,"%snhrpholdtime%u\n",aficmd,ad->holdtime);if(ad->configured_
mtu<0)vty_out(vty,"%snhrpmtuopennhrp\n",aficmd);elseif(ad->configured_mtu)vty_ou
t(vty,"%snhrpmtu%u\n",aficmd,ad->configured_mtu);for(i=0;interface_flags_desc[i]
.str!=NULL;i++){if(!(ad->flags&interface_flags_desc[i].key))continue;vty_out(vty
,"%snhrp%s\n",aficmd,interface_flags_desc[i].str);}mapctx=(structwrite_map_ctx){
.vty=vty,.family=afi2family(afi),.aficmd=aficmd,};nhrp_cache_foreach(ifp,interfa
ce_config_write_nhrp_map,&mapctx);list_for_each_entry(nhs,&ad->nhslist_head,nhsl
ist_entry){vty_out(vty,"%snhrpnhs%snbma%s\n",aficmd,sockunion_family(&nhs->proto
_addr)==AF_UNSPEC?"dynamic":sockunion2str(&nhs->proto_addr,buf,sizeofbuf),nhs->n
bma_fqdn);}}vty_endframe(vty,"!\n");}return0;}voidnhrp_config_init(void){install
_node(&zebra_node,nhrp_config_write);install_default(ZEBRA_NODE);/*access-listco
mmands*/access_list_init();/*globalcommands*/install_element(VIEW_NODE,&show_deb
ugging_nhrp_cmd);install_element(VIEW_NODE,&show_ip_nhrp_cmd);install_element(VI
EW_NODE,&show_dmvpn_cmd);install_element(ENABLE_NODE,&clear_nhrp_cmd);install_el
ement(ENABLE_NODE,&debug_nhrp_cmd);install_element(ENABLE_NODE,&no_debug_nhrp_cm
d);install_element(CONFIG_NODE,&debug_nhrp_cmd);install_element(CONFIG_NODE,&no_
debug_nhrp_cmd);install_element(CONFIG_NODE,&nhrp_event_socket_cmd);install_elem
ent(CONFIG_NODE,&no_nhrp_event_socket_cmd);install_element(CONFIG_NODE,&nhrp_nfl
og_group_cmd);install_element(CONFIG_NODE,&no_nhrp_nflog_group_cmd);/*interfaces
pecificcommands*/install_node(&nhrp_interface_node,interface_config_write);if_cm
d_init();install_element(INTERFACE_NODE,&tunnel_protection_cmd);install_element(
INTERFACE_NODE,&no_tunnel_protection_cmd);install_element(INTERFACE_NODE,&tunnel
_source_cmd);install_element(INTERFACE_NODE,&no_tunnel_source_cmd);install_eleme
nt(INTERFACE_NODE,&if_nhrp_network_id_cmd);install_element(INTERFACE_NODE,&if_no
_nhrp_network_id_cmd);install_element(INTERFACE_NODE,&if_nhrp_holdtime_cmd);inst
all_element(INTERFACE_NODE,&if_no_nhrp_holdtime_cmd);install_element(INTERFACE_N
ODE,&if_nhrp_mtu_cmd);install_element(INTERFACE_NODE,&if_no_nhrp_mtu_cmd);instal
l_element(INTERFACE_NODE,&if_nhrp_flags_cmd);install_element(INTERFACE_NODE,&if_
no_nhrp_flags_cmd);install_element(INTERFACE_NODE,&if_nhrp_reg_flags_cmd);instal
l_element(INTERFACE_NODE,&if_no_nhrp_reg_flags_cmd);install_element(INTERFACE_NO
DE,&if_nhrp_map_cmd);install_element(INTERFACE_NODE,&if_no_nhrp_map_cmd);install
_element(INTERFACE_NODE,&if_nhrp_nhs_cmd);install_element(INTERFACE_NODE,&if_no_
nhrp_nhs_cmd);}