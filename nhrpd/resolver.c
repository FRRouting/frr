/*C-AresintegrationtoQuaggamainloop*Copyright(c)2014-2015TimoTer√§s**Thisfileisfr
eesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPub
licLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*
(atyouroption)anylaterversion.*/#include<ares.h>#include<ares_version.h>#include
"vector.h"#include"thread.h"#include"nhrpd.h"structresolver_state{ares_channelch
annel;structthread*timeout;vectorread_threads,write_threads;};staticstructresolv
er_statestate;#defineTHREAD_RUNNING((structthread*)-1)staticvoidresolver_update_
timeouts(structresolver_state*r);staticintresolver_cb_timeout(structthread*t){st
ructresolver_state*r=THREAD_ARG(t);r->timeout=THREAD_RUNNING;ares_process(r->cha
nnel,NULL,NULL);r->timeout=NULL;resolver_update_timeouts(r);return0;}staticintre
solver_cb_socket_readable(structthread*t){structresolver_state*r=THREAD_ARG(t);i
ntfd=THREAD_FD(t);vector_set_index(r->read_threads,fd,THREAD_RUNNING);ares_proce
ss_fd(r->channel,fd,ARES_SOCKET_BAD);if(vector_lookup(r->read_threads,fd)==THREA
D_RUNNING){t=NULL;thread_add_read(master,resolver_cb_socket_readable,r,fd,&t);ve
ctor_set_index(r->read_threads,fd,t);}resolver_update_timeouts(r);return0;}stati
cintresolver_cb_socket_writable(structthread*t){structresolver_state*r=THREAD_AR
G(t);intfd=THREAD_FD(t);vector_set_index(r->write_threads,fd,THREAD_RUNNING);are
s_process_fd(r->channel,ARES_SOCKET_BAD,fd);if(vector_lookup(r->write_threads,fd
)==THREAD_RUNNING){t=NULL;thread_add_write(master,resolver_cb_socket_writable,r,
fd,&t);vector_set_index(r->write_threads,fd,t);}resolver_update_timeouts(r);retu
rn0;}staticvoidresolver_update_timeouts(structresolver_state*r){structtimeval*tv
,tvbuf;if(r->timeout==THREAD_RUNNING)return;THREAD_OFF(r->timeout);tv=ares_timeo
ut(r->channel,NULL,&tvbuf);if(tv){unsignedinttimeoutms=tv->tv_sec*1000+tv->tv_us
ec/1000;thread_add_timer_msec(master,resolver_cb_timeout,r,timeoutms,&r->timeout
);}}staticvoidares_socket_cb(void*data,ares_socket_tfd,intreadable,intwritable){
structresolver_state*r=(structresolver_state*)data;structthread*t;if(readable){t
=vector_lookup_ensure(r->read_threads,fd);if(!t){thread_add_read(master,resolver
_cb_socket_readable,r,fd,&t);vector_set_index(r->read_threads,fd,t);}}else{t=vec
tor_lookup(r->read_threads,fd);if(t){if(t!=THREAD_RUNNING){THREAD_OFF(t);}vector
_unset(r->read_threads,fd);}}if(writable){t=vector_lookup_ensure(r->write_thread
s,fd);if(!t){thread_add_read(master,resolver_cb_socket_writable,r,fd,&t);vector_
set_index(r->write_threads,fd,t);}}else{t=vector_lookup(r->write_threads,fd);if(
t){if(t!=THREAD_RUNNING){THREAD_OFF(t);}vector_unset(r->write_threads,fd);}}}voi
dresolver_init(void){structares_optionsares_opts;state.read_threads=vector_init(
1);state.write_threads=vector_init(1);ares_opts=(structares_options){.sock_state
_cb=&ares_socket_cb,.sock_state_cb_data=&state,.timeout=2,.tries=3,};ares_init_o
ptions(&state.channel,&ares_opts,ARES_OPT_SOCK_STATE_CB|ARES_OPT_TIMEOUT|ARES_OP
T_TRIES);}staticvoidares_address_cb(void*arg,intstatus,inttimeouts,structhostent
*he){structresolver_query*query=(structresolver_query*)arg;unionsockunionaddr[16
];size_ti;if(status!=ARES_SUCCESS){debugf(NHRP_DEBUG_COMMON,"[%p]Resolvingfailed
",query);query->callback(query,-1,NULL);query->callback=NULL;return;}for(i=0;he-
>h_addr_list[i]!=NULL&&i<ZEBRA_NUM_OF(addr);i++){memset(&addr[i],0,sizeof(addr[i
]));addr[i].sa.sa_family=he->h_addrtype;switch(he->h_addrtype){caseAF_INET:memcp
y(&addr[i].sin.sin_addr,(uint8_t*)he->h_addr_list[i],he->h_length);break;caseAF_
INET6:memcpy(&addr[i].sin6.sin6_addr,(uint8_t*)he->h_addr_list[i],he->h_length);
break;}}debugf(NHRP_DEBUG_COMMON,"[%p]Resolvedwith%dresults",query,(int)i);query
->callback(query,i,&addr[0]);query->callback=NULL;}voidresolver_resolve(structre
solver_query*query,intaf,constchar*hostname,void(*callback)(structresolver_query
*,int,unionsockunion*)){if(query->callback!=NULL){zlog_err("Tryingtoresolve'%s',
butpreviousquerywasnotfinishedyet",hostname);return;}debugf(NHRP_DEBUG_COMMON,"[
%p]Resolving'%s'",query,hostname);query->callback=callback;ares_gethostbyname(st
ate.channel,hostname,af,ares_address_cb,query);resolver_update_timeouts(&state);
}