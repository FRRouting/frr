/*NHRPdaemoninternalstructuresandfunctionprototypes*Copyright(c)2014-2015TimoTer
Ã¤s**Thisfileisfreesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsof
theGNUGeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2
oftheLicense,or*(atyouroption)anylaterversion.*/#ifndefNHRPD_H#defineNHRPD_H#inc
lude"list.h"#include"zbuf.h"#include"zclient.h"#include"debug.h"#include"memory.
h"DECLARE_MGROUP(NHRPD)#defineNHRPD_DEFAULT_HOLDTIME7200#defineNHRP_VTY_PORT2610
#defineNHRP_DEFAULT_CONFIG"nhrpd.conf"externstructthread_master*master;enum{NHRP
_OK=0,NHRP_ERR_FAIL,NHRP_ERR_NO_MEMORY,NHRP_ERR_UNSUPPORTED_INTERFACE,NHRP_ERR_N
HRP_NOT_ENABLED,NHRP_ERR_ENTRY_EXISTS,NHRP_ERR_ENTRY_NOT_FOUND,NHRP_ERR_PROTOCOL
_ADDRESS_MISMATCH,__NHRP_ERR_MAX};#defineNHRP_ERR_MAX(__NHRP_ERR_MAX-1)structnot
ifier_block;typedefvoid(*notifier_fn_t)(structnotifier_block*,unsignedlong);stru
ctnotifier_block{structlist_headnotifier_entry;notifier_fn_taction;};structnotif
ier_list{structlist_headnotifier_head;};#defineNOTIFIER_LIST_INITIALIZER(l)\{\.n
otifier_head=LIST_INITIALIZER((l)->notifier_head)\}staticinlinevoidnotifier_init
(structnotifier_list*l){list_init(&l->notifier_head);}staticinlinevoidnotifier_a
dd(structnotifier_block*n,structnotifier_list*l,notifier_fn_taction){n->action=a
ction;list_add_tail(&n->notifier_entry,&l->notifier_head);}staticinlinevoidnotif
ier_del(structnotifier_block*n){list_del(&n->notifier_entry);}staticinlinevoidno
tifier_call(structnotifier_list*l,intcmd){structnotifier_block*n,*nn;list_for_ea
ch_entry_safe(n,nn,&l->notifier_head,notifier_entry)n->action(n,cmd);}staticinli
neintnotifier_active(structnotifier_list*l){return!list_empty(&l->notifier_head)
;}structresolver_query{void(*callback)(structresolver_query*,intn,unionsockunion
*);};voidresolver_init(void);voidresolver_resolve(structresolver_query*query,int
af,constchar*hostname,void(*cb)(structresolver_query*,int,unionsockunion*));void
nhrp_zebra_init(void);voidnhrp_zebra_terminate(void);structzbuf;structnhrp_vc;st
ructnhrp_cache;structnhrp_nhs;structnhrp_interface;#defineMAX_ID_LENGTH64#define
MAX_CERT_LENGTH2048enumnhrp_notify_type{NOTIFY_INTERFACE_UP,NOTIFY_INTERFACE_DOW
N,NOTIFY_INTERFACE_CHANGED,NOTIFY_INTERFACE_ADDRESS_CHANGED,NOTIFY_INTERFACE_NBM
A_CHANGED,NOTIFY_INTERFACE_MTU_CHANGED,NOTIFY_VC_IPSEC_CHANGED,NOTIFY_VC_IPSEC_U
PDATE_NBMA,NOTIFY_PEER_UP,NOTIFY_PEER_DOWN,NOTIFY_PEER_IFCONFIG_CHANGED,NOTIFY_P
EER_MTU_CHANGED,NOTIFY_PEER_NBMA_CHANGING,NOTIFY_CACHE_UP,NOTIFY_CACHE_DOWN,NOTI
FY_CACHE_DELETE,NOTIFY_CACHE_USED,NOTIFY_CACHE_BINDING_CHANGE,};structnhrp_vc{st
ructnotifier_listnotifier_list;uint8_tipsec;uint8_tupdating;uint8_tabort_migrati
on;structnhrp_vc_peer{unionsockunionnbma;charid[MAX_ID_LENGTH];uint16_tcertlen;u
int8_tcert[MAX_CERT_LENGTH];}local,remote;};enumnhrp_route_type{NHRP_ROUTE_BLACK
HOLE,NHRP_ROUTE_LOCAL,NHRP_ROUTE_NBMA_NEXTHOP,NHRP_ROUTE_OFF_NBMA,};structnhrp_p
eer{unsignedintref;unsignedonline:1;unsignedrequested:1;unsignedfallback_request
ed:1;unsignedprio:1;structnotifier_listnotifier_list;structinterface*ifp;structn
hrp_vc*vc;structthread*t_fallback;structnotifier_blockvc_notifier,ifp_notifier;}
;structnhrp_packet_parser{structinterface*ifp;structnhrp_afi_data*if_ad;structnh
rp_peer*peer;structzbuf*pkt;structzbufpayload;structzbufextensions;structnhrp_pa
cket_header*hdr;enumnhrp_route_typeroute_type;structprefixroute_prefix;unionsock
unionsrc_nbma,src_proto,dst_proto;};structnhrp_reqid_pool{structhash*reqid_hash;
uint32_tnext_request_id;};structnhrp_reqid{uint32_trequest_id;void(*cb)(structnh
rp_reqid*,void*);};externstructnhrp_reqid_poolnhrp_packet_reqid;externstructnhrp
_reqid_poolnhrp_event_reqid;enumnhrp_cache_type{NHRP_CACHE_INVALID=0,NHRP_CACHE_
INCOMPLETE,NHRP_CACHE_NEGATIVE,NHRP_CACHE_CACHED,NHRP_CACHE_DYNAMIC,NHRP_CACHE_N
HS,NHRP_CACHE_STATIC,NHRP_CACHE_LOCAL,NHRP_CACHE_NUM_TYPES};externconstchar*cons
tnhrp_cache_type_str[];externunsignedlongnhrp_cache_counts[NHRP_CACHE_NUM_TYPES]
;structnhrp_cache{structinterface*ifp;unionsockunionremote_addr;unsignedmap:1;un
signedused:1;unsignedroute_installed:1;unsignednhrp_route_installed:1;structnoti
fier_blockpeer_notifier;structnotifier_blocknewpeer_notifier;structnotifier_list
notifier_list;structnhrp_reqideventid;structthread*t_timeout;structthread*t_auth
;struct{enumnhrp_cache_typetype;unionsockunionremote_nbma_natoa;structnhrp_peer*
peer;time_texpires;uint32_tmtu;}cur,new;};structnhrp_shortcut{structprefix*p;uni
onsockunionaddr;structnhrp_reqidreqid;structthread*t_timer;enumnhrp_cache_typety
pe;unsignedintholding_time;unsignedroute_installed:1;unsignedexpiring:1;structnh
rp_cache*cache;structnotifier_blockcache_notifier;};structnhrp_nhs{structinterfa
ce*ifp;structlist_headnhslist_entry;unsignedhub:1;afi_tafi;unionsockunionproto_a
ddr;constchar*nbma_fqdn;/*IP-addressorFQDN*/structthread*t_resolve;structresolve
r_querydns_resolve;structlist_headreglist_head;};structnhrp_registration{structl
ist_headreglist_entry;structthread*t_register;structnhrp_nhs*nhs;structnhrp_reqi
dreqid;unsignedinttimeout;unsignedmark:1;unionsockunionproto_addr;structnhrp_pee
r*peer;structnotifier_blockpeer_notifier;};#defineNHRP_IFF_SHORTCUT0x0001#define
NHRP_IFF_REDIRECT0x0002#defineNHRP_IFF_REG_NO_UNIQUE0x0100structnhrp_interface{s
tructinterface*ifp;unsignedenabled:1;char*ipsec_profile,*ipsec_fallback_profile,
*source;unionsockunionnbma;unionsockunionnat_nbma;unsignedintlinkidx;uint32_tgre
key;structhash*peer_hash;structhash*cache_hash;structnotifier_listnotifier_list;
structinterface*nbmaifp;structnotifier_blocknbmanifp_notifier;structnhrp_afi_dat
a{unsignedflags;unsignedshortconfigured:1;unionsockunionaddr;uint32_tnetwork_id;
shortconfigured_mtu;unsignedshortmtu;unsignedintholdtime;structlist_headnhslist_
head;}afi[AFI_MAX];};externstructzebra_privs_tnhrpd_privs;intsock_open_unix(cons
tchar*path);voidnhrp_interface_init(void);voidnhrp_interface_update(structinterf
ace*ifp);voidnhrp_interface_update_mtu(structinterface*ifp,afi_tafi);intnhrp_int
erface_add(intcmd,structzclient*client,zebra_size_tlength,vrf_id_tvrf_id);intnhr
p_interface_delete(intcmd,structzclient*client,zebra_size_tlength,vrf_id_tvrf_id
);intnhrp_interface_up(intcmd,structzclient*client,zebra_size_tlength,vrf_id_tvr
f_id);intnhrp_interface_down(intcmd,structzclient*client,zebra_size_tlength,vrf_
id_tvrf_id);intnhrp_interface_address_add(intcmd,structzclient*client,zebra_size
_tlength,vrf_id_tvrf_id);intnhrp_interface_address_delete(intcmd,structzclient*c
lient,zebra_size_tlength,vrf_id_tvrf_id);voidnhrp_interface_notify_add(structint
erface*ifp,structnotifier_block*n,notifier_fn_tfn);voidnhrp_interface_notify_del
(structinterface*ifp,structnotifier_block*n);voidnhrp_interface_set_protection(s
tructinterface*ifp,constchar*profile,constchar*fallback_profile);voidnhrp_interf
ace_set_source(structinterface*ifp,constchar*ifname);intnhrp_nhs_add(structinter
face*ifp,afi_tafi,unionsockunion*proto_addr,constchar*nbma_fqdn);intnhrp_nhs_del
(structinterface*ifp,afi_tafi,unionsockunion*proto_addr,constchar*nbma_fqdn);int
nhrp_nhs_free(structnhrp_nhs*nhs);voidnhrp_nhs_terminate(void);voidnhrp_nhs_fore
ach(structinterface*ifp,afi_tafi,void(*cb)(structnhrp_nhs*,structnhrp_registrati
on*,void*),void*ctx);voidnhrp_route_update_nhrp(conststructprefix*p,structinterf
ace*ifp);voidnhrp_route_announce(intadd,enumnhrp_cache_typetype,conststructprefi
x*p,structinterface*ifp,constunionsockunion*nexthop,uint32_tmtu);intnhrp_route_r
ead(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id);intnhrp_
route_get_nexthop(constunionsockunion*addr,structprefix*p,unionsockunion*via,str
uctinterface**ifp);enumnhrp_route_typenhrp_route_address(structinterface*in_ifp,
unionsockunion*addr,structprefix*p,structnhrp_peer**peer);voidnhrp_config_init(v
oid);voidnhrp_shortcut_init(void);voidnhrp_shortcut_terminate(void);voidnhrp_sho
rtcut_initiate(unionsockunion*addr);voidnhrp_shortcut_foreach(afi_tafi,void(*cb)
(structnhrp_shortcut*,void*),void*ctx);voidnhrp_shortcut_purge(structnhrp_shortc
ut*s,intforce);voidnhrp_shortcut_prefix_change(conststructprefix*p,intdeleted);s
tructnhrp_cache*nhrp_cache_get(structinterface*ifp,unionsockunion*remote_addr,in
tcreate);voidnhrp_cache_foreach(structinterface*ifp,void(*cb)(structnhrp_cache*,
void*),void*ctx);voidnhrp_cache_set_used(structnhrp_cache*,int);intnhrp_cache_up
date_binding(structnhrp_cache*,enumnhrp_cache_typetype,intholding_time,structnhr
p_peer*p,uint32_tmtu,unionsockunion*nbma_natoa);voidnhrp_cache_notify_add(struct
nhrp_cache*c,structnotifier_block*,notifier_fn_t);voidnhrp_cache_notify_del(stru
ctnhrp_cache*c,structnotifier_block*);voidnhrp_vc_init(void);voidnhrp_vc_termina
te(void);structnhrp_vc*nhrp_vc_get(constunionsockunion*src,constunionsockunion*d
st,intcreate);intnhrp_vc_ipsec_updown(uint32_tchild_id,structnhrp_vc*vc);voidnhr
p_vc_notify_add(structnhrp_vc*,structnotifier_block*,notifier_fn_t);voidnhrp_vc_
notify_del(structnhrp_vc*,structnotifier_block*);voidnhrp_vc_foreach(void(*cb)(s
tructnhrp_vc*,void*),void*ctx);voidnhrp_vc_reset(void);voidvici_init(void);voidv
ici_terminate(void);voidvici_request_vc(constchar*profile,unionsockunion*src,uni
onsockunion*dst,intprio);externconstchar*nhrp_event_socket_path;voidevmgr_init(v
oid);voidevmgr_terminate(void);voidevmgr_set_socket(constchar*socket);voidevmgr_
notify(constchar*name,structnhrp_cache*c,void(*cb)(structnhrp_reqid*,void*));str
uctnhrp_packet_header*nhrp_packet_push(structzbuf*zb,uint8_ttype,constunionsocku
nion*src_nbma,constunionsockunion*src_proto,constunionsockunion*dst_proto);voidn
hrp_packet_complete(structzbuf*zb,structnhrp_packet_header*hdr);uint16_tnhrp_pac
ket_calculate_checksum(constuint8_t*pdu,uint16_tlen);structnhrp_packet_header*nh
rp_packet_pull(structzbuf*zb,unionsockunion*src_nbma,unionsockunion*src_proto,un
ionsockunion*dst_proto);structnhrp_cie_header*nhrp_cie_push(structzbuf*zb,uint8_
tcode,constunionsockunion*nbma,constunionsockunion*proto);structnhrp_cie_header*
nhrp_cie_pull(structzbuf*zb,structnhrp_packet_header*hdr,unionsockunion*nbma,uni
onsockunion*proto);structnhrp_extension_header*nhrp_ext_push(structzbuf*zb,struc
tnhrp_packet_header*hdr,uint16_ttype);voidnhrp_ext_complete(structzbuf*zb,struct
nhrp_extension_header*ext);structnhrp_extension_header*nhrp_ext_pull(structzbuf*
zb,structzbuf*payload);voidnhrp_ext_request(structzbuf*zb,structnhrp_packet_head
er*hdr,structinterface*);intnhrp_ext_reply(structzbuf*zb,structnhrp_packet_heade
r*hdr,structinterface*ifp,structnhrp_extension_header*ext,structzbuf*extpayload)
;uint32_tnhrp_reqid_alloc(structnhrp_reqid_pool*,structnhrp_reqid*r,void(*cb)(st
ructnhrp_reqid*,void*));voidnhrp_reqid_free(structnhrp_reqid_pool*,structnhrp_re
qid*r);structnhrp_reqid*nhrp_reqid_lookup(structnhrp_reqid_pool*,uint32_treqid);
intnhrp_packet_init(void);structnhrp_peer*nhrp_peer_get(structinterface*ifp,cons
tunionsockunion*remote_nbma);structnhrp_peer*nhrp_peer_ref(structnhrp_peer*p);vo
idnhrp_peer_unref(structnhrp_peer*p);intnhrp_peer_check(structnhrp_peer*p,intest
ablish);voidnhrp_peer_notify_add(structnhrp_peer*p,structnotifier_block*,notifie
r_fn_t);voidnhrp_peer_notify_del(structnhrp_peer*p,structnotifier_block*);voidnh
rp_peer_recv(structnhrp_peer*p,structzbuf*zb);voidnhrp_peer_send(structnhrp_peer
*p,structzbuf*zb);voidnhrp_peer_send_indication(structinterface*ifp,uint16_t,str
uctzbuf*);#endif