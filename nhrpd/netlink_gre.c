/*NHRPnetlink/GREtunnelconfigurationcode*Copyright(c)2014-2016TimoTer√§s**Thisfil
eisfreesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGener
alPublicLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicens
e,or*(atyouroption)anylaterversion.*/#include<sys/socket.h>#include<linux/netlin
k.h>#include<linux/rtnetlink.h>#include<linux/in.h>#include<linux/if.h>#include<
linux/ip.h>#include<linux/ipv6.h>#include<linux/if_tunnel.h>#include"debug.h"#in
clude"netlink.h"#include"znl.h"staticint__netlink_gre_get_data(structzbuf*zb,str
uctzbuf*data,intifindex){structnlmsghdr*n;structifinfomsg*ifi;structzbufpayload,
rtapayload;structrtattr*rta;debugf(NHRP_DEBUG_KERNEL,"netlink-link-gre:get-info%
u",ifindex);n=znl_nlmsg_push(zb,RTM_GETLINK,NLM_F_REQUEST);ifi=znl_push(zb,sizeo
f(*ifi));*ifi=(structifinfomsg){.ifi_index=ifindex,};znl_nlmsg_complete(zb,n);if
(zbuf_send(zb,netlink_req_fd)<0||zbuf_recv(zb,netlink_req_fd)<0)return-1;n=znl_n
lmsg_pull(zb,&payload);if(!n)return-1;if(n->nlmsg_type!=RTM_NEWLINK)return-1;ifi
=znl_pull(&payload,sizeof(structifinfomsg));if(!ifi)return-1;debugf(NHRP_DEBUG_K
ERNEL,"netlink-link-gre:ifindex%u,receivemsg_type%u,msg_flags%u",ifi->ifi_index,
n->nlmsg_type,n->nlmsg_flags);if(ifi->ifi_index!=ifindex)return-1;while((rta=znl
_rta_pull(&payload,&rtapayload))!=NULL)if(rta->rta_type==IFLA_LINKINFO)break;if(
!rta)return-1;payload=rtapayload;while((rta=znl_rta_pull(&payload,&rtapayload))!
=NULL)if(rta->rta_type==IFLA_INFO_DATA)break;if(!rta)return-1;*data=rtapayload;r
eturn0;}voidnetlink_gre_get_info(unsignedintifindex,uint32_t*gre_key,unsignedint
*link_index,structin_addr*saddr){structzbuf*zb=zbuf_alloc(8192),data,rtapl;struc
trtattr*rta;*link_index=0;*gre_key=0;saddr->s_addr=0;if(__netlink_gre_get_data(z
b,&data,ifindex)<0)gotoerr;while((rta=znl_rta_pull(&data,&rtapl))!=NULL){switch(
rta->rta_type){caseIFLA_GRE_LINK:*link_index=zbuf_get32(&rtapl);break;caseIFLA_G
RE_IKEY:caseIFLA_GRE_OKEY:*gre_key=zbuf_get32(&rtapl);break;caseIFLA_GRE_LOCAL:s
addr->s_addr=zbuf_get32(&rtapl);break;}}err:zbuf_free(zb);}voidnetlink_gre_set_l
ink(unsignedintifindex,unsignedintlink_index){structnlmsghdr*n;structifinfomsg*i
fi;structrtattr*rta_info,*rta_data,*rta;structzbuf*zr=zbuf_alloc(8192),data,rtap
l;structzbuf*zb=zbuf_alloc(8192);size_tlen;if(__netlink_gre_get_data(zr,&data,if
index)<0)gotoerr;n=znl_nlmsg_push(zb,RTM_NEWLINK,NLM_F_REQUEST);ifi=znl_push(zb,
sizeof(*ifi));*ifi=(structifinfomsg){.ifi_index=ifindex,};rta_info=znl_rta_neste
d_push(zb,IFLA_LINKINFO);znl_rta_push(zb,IFLA_INFO_KIND,"gre",3);rta_data=znl_rt
a_nested_push(zb,IFLA_INFO_DATA);znl_rta_push_u32(zb,IFLA_GRE_LINK,link_index);w
hile((rta=znl_rta_pull(&data,&rtapl))!=NULL){if(rta->rta_type==IFLA_GRE_LINK)con
tinue;len=zbuf_used(&rtapl);znl_rta_push(zb,rta->rta_type,zbuf_pulln(&rtapl,len)
,len);}znl_rta_nested_complete(zb,rta_data);znl_rta_nested_complete(zb,rta_info)
;znl_nlmsg_complete(zb,n);zbuf_send(zb,netlink_req_fd);zbuf_recv(zb,netlink_req_
fd);err:zbuf_free(zb);zbuf_free(zr);}