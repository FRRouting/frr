/*NHRPpackethandlingfunctions*Copyright(c)2014-2015TimoTer√§s**Thisfileisfreesoft
ware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPublicLic
enseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*(atyou
roption)anylaterversion.*/#include<netinet/if_ether.h>#include"nhrpd.h"#include"
zbuf.h"#include"thread.h"#include"hash.h"#include"nhrp_protocol.h"#include"os.h"
structnhrp_reqid_poolnhrp_packet_reqid;staticuint16_tfamily2proto(intfamily){swi
tch(family){caseAF_INET:returnETH_P_IP;caseAF_INET6:returnETH_P_IPV6;}return0;}s
taticintproto2family(uint16_tproto){switch(proto){caseETH_P_IP:returnAF_INET;cas
eETH_P_IPV6:returnAF_INET6;}returnAF_UNSPEC;}structnhrp_packet_header*nhrp_packe
t_push(structzbuf*zb,uint8_ttype,constunionsockunion*src_nbma,constunionsockunio
n*src_proto,constunionsockunion*dst_proto){structnhrp_packet_header*hdr;hdr=zbuf
_push(zb,structnhrp_packet_header);if(!hdr)returnNULL;*hdr=(structnhrp_packet_he
ader){.afnum=htons(family2afi(sockunion_family(src_nbma))),.protocol_type=htons(
family2proto(sockunion_family(src_proto))),.version=NHRP_VERSION_RFC2332,.type=t
ype,.hop_count=64,.src_nbma_address_len=sockunion_get_addrlen(src_nbma),.src_pro
tocol_address_len=sockunion_get_addrlen(src_proto),.dst_protocol_address_len=soc
kunion_get_addrlen(dst_proto),};zbuf_put(zb,sockunion_get_addr(src_nbma),hdr->sr
c_nbma_address_len);zbuf_put(zb,sockunion_get_addr(src_proto),hdr->src_protocol_
address_len);zbuf_put(zb,sockunion_get_addr(dst_proto),hdr->dst_protocol_address
_len);returnhdr;}structnhrp_packet_header*nhrp_packet_pull(structzbuf*zb,unionso
ckunion*src_nbma,unionsockunion*src_proto,unionsockunion*dst_proto){structnhrp_p
acket_header*hdr;hdr=zbuf_pull(zb,structnhrp_packet_header);if(!hdr)returnNULL;s
ockunion_set(src_nbma,afi2family(htons(hdr->afnum)),zbuf_pulln(zb,hdr->src_nbma_
address_len+hdr->src_nbma_subaddress_len),hdr->src_nbma_address_len+hdr->src_nbm
a_subaddress_len);sockunion_set(src_proto,proto2family(htons(hdr->protocol_type)
),zbuf_pulln(zb,hdr->src_protocol_address_len),hdr->src_protocol_address_len);so
ckunion_set(dst_proto,proto2family(htons(hdr->protocol_type)),zbuf_pulln(zb,hdr-
>dst_protocol_address_len),hdr->dst_protocol_address_len);returnhdr;}uint16_tnhr
p_packet_calculate_checksum(constuint8_t*pdu,uint16_tlen){constuint16_t*pdu16=(c
onstuint16_t*)pdu;uint32_tcsum=0;inti;for(i=0;i<len/2;i++)csum+=pdu16[i];if(len&
1)csum+=htons(pdu[len-1]);while(csum&0xffff0000)csum=(csum&0xffff)+(csum>>16);re
turn(~csum)&0xffff;}voidnhrp_packet_complete(structzbuf*zb,structnhrp_packet_hea
der*hdr){unsignedshortsize;if(hdr->extension_offset)nhrp_ext_push(zb,hdr,NHRP_EX
TENSION_END|NHRP_EXTENSION_FLAG_COMPULSORY);size=zb->tail-(uint8_t*)hdr;hdr->pac
ket_size=htons(size);hdr->checksum=0;hdr->checksum=nhrp_packet_calculate_checksu
m((uint8_t*)hdr,size);}structnhrp_cie_header*nhrp_cie_push(structzbuf*zb,uint8_t
code,constunionsockunion*nbma,constunionsockunion*proto){structnhrp_cie_header*c
ie;cie=zbuf_push(zb,structnhrp_cie_header);*cie=(structnhrp_cie_header){.code=co
de,};if(nbma){cie->nbma_address_len=sockunion_get_addrlen(nbma);zbuf_put(zb,sock
union_get_addr(nbma),cie->nbma_address_len);}if(proto){cie->protocol_address_len
=sockunion_get_addrlen(proto);zbuf_put(zb,sockunion_get_addr(proto),cie->protoco
l_address_len);}returncie;}structnhrp_cie_header*nhrp_cie_pull(structzbuf*zb,str
uctnhrp_packet_header*hdr,unionsockunion*nbma,unionsockunion*proto){structnhrp_c
ie_header*cie;cie=zbuf_pull(zb,structnhrp_cie_header);if(!cie)returnNULL;if(cie-
>nbma_address_len+cie->nbma_subaddress_len){sockunion_set(nbma,afi2family(htons(
hdr->afnum)),zbuf_pulln(zb,cie->nbma_address_len+cie->nbma_subaddress_len),cie->
nbma_address_len+cie->nbma_subaddress_len);}else{sockunion_family(nbma)=AF_UNSPE
C;}if(cie->protocol_address_len){sockunion_set(proto,proto2family(htons(hdr->pro
tocol_type)),zbuf_pulln(zb,cie->protocol_address_len),cie->protocol_address_len)
;}else{sockunion_family(proto)=AF_UNSPEC;}returncie;}structnhrp_extension_header
*nhrp_ext_push(structzbuf*zb,structnhrp_packet_header*hdr,uint16_ttype){structnh
rp_extension_header*ext;ext=zbuf_push(zb,structnhrp_extension_header);if(!ext)re
turnNULL;if(!hdr->extension_offset)hdr->extension_offset=htons(zb->tail-(uint8_t
*)hdr-sizeof(structnhrp_extension_header));*ext=(structnhrp_extension_header){.t
ype=htons(type),.length=0,};returnext;}voidnhrp_ext_complete(structzbuf*zb,struc
tnhrp_extension_header*ext){ext->length=htons(zb->tail-(uint8_t*)ext-sizeof(stru
ctnhrp_extension_header));}structnhrp_extension_header*nhrp_ext_pull(structzbuf*
zb,structzbuf*payload){structnhrp_extension_header*ext;uint16_tplen;ext=zbuf_pul
l(zb,structnhrp_extension_header);if(!ext)returnNULL;plen=htons(ext->length);zbu
f_init(payload,zbuf_pulln(zb,plen),plen,plen);returnext;}voidnhrp_ext_request(st
ructzbuf*zb,structnhrp_packet_header*hdr,structinterface*ifp){/*Placeholdersfors
tandardextensions*/nhrp_ext_push(zb,hdr,NHRP_EXTENSION_FORWARD_TRANSIT_NHS|NHRP_
EXTENSION_FLAG_COMPULSORY);nhrp_ext_push(zb,hdr,NHRP_EXTENSION_REVERSE_TRANSIT_N
HS|NHRP_EXTENSION_FLAG_COMPULSORY);nhrp_ext_push(zb,hdr,NHRP_EXTENSION_RESPONDER
_ADDRESS|NHRP_EXTENSION_FLAG_COMPULSORY);}intnhrp_ext_reply(structzbuf*zb,struct
nhrp_packet_header*hdr,structinterface*ifp,structnhrp_extension_header*ext,struc
tzbuf*extpayload){structnhrp_interface*nifp=ifp->info;structnhrp_afi_data*ad=&ni
fp->afi[htons(hdr->afnum)];structnhrp_extension_header*dst;structnhrp_cie_header
*cie;uint16_ttype;type=htons(ext->type)&~NHRP_EXTENSION_FLAG_COMPULSORY;if(type=
=NHRP_EXTENSION_END)return0;dst=nhrp_ext_push(zb,hdr,htons(ext->type));if(!dst)g
otoerr;switch(type){caseNHRP_EXTENSION_RESPONDER_ADDRESS:cie=nhrp_cie_push(zb,NH
RP_CODE_SUCCESS,&nifp->nbma,&ad->addr);if(!cie)gotoerr;cie->holding_time=htons(a
d->holdtime);break;default:if(type&NHRP_EXTENSION_FLAG_COMPULSORY)gotoerr;/*fall
thru*/caseNHRP_EXTENSION_FORWARD_TRANSIT_NHS:caseNHRP_EXTENSION_REVERSE_TRANSIT_
NHS:/*Supportedcompulsoryextensions,andany*non-compulsorythatisnotexplicitlyhand
led,*shouldbejustcopied.*/zbuf_copy(zb,extpayload,zbuf_used(extpayload));break;}
nhrp_ext_complete(zb,dst);return0;err:zbuf_set_werror(zb);return-1;}staticintnhr
p_packet_recvraw(structthread*t){intfd=THREAD_FD(t),ifindex;structzbuf*zb;struct
interface*ifp;structnhrp_peer*p;unionsockunionremote_nbma;uint8_taddr[64];size_t
len,addrlen;thread_add_read(master,nhrp_packet_recvraw,0,fd,NULL);zb=zbuf_alloc(
1500);if(!zb)return0;len=zbuf_size(zb);addrlen=sizeof(addr);if(os_recvmsg(zb->bu
f,&len,&ifindex,addr,&addrlen)<0)gotoerr;zb->head=zb->buf;zb->tail=zb->buf+len;s
witch(addrlen){case4:sockunion_set(&remote_nbma,AF_INET,addr,addrlen);break;defa
ult:gotoerr;}ifp=if_lookup_by_index(ifindex,VRF_DEFAULT);if(!ifp)gotoerr;p=nhrp_
peer_get(ifp,&remote_nbma);if(!p)gotoerr;nhrp_peer_recv(p,zb);nhrp_peer_unref(p)
;return0;err:zbuf_free(zb);return0;}intnhrp_packet_init(void){thread_add_read(ma
ster,nhrp_packet_recvraw,0,os_socket(),NULL);return0;}