/*NHRPnetlink/neighbortablearpdcode*Copyright(c)2014-2016TimoTer√§s**Thisfileisfr
eesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNUGeneralPub
licLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheLicense,or*
(atyouroption)anylaterversion.*/#include<fcntl.h>#include<net/if.h>#include<neti
net/if_ether.h>#include<linux/netlink.h>#include<linux/neighbour.h>#include<linu
x/netfilter/nfnetlink_log.h>#include"thread.h"#include"nhrpd.h"#include"netlink.
h"#include"znl.h"intnetlink_req_fd=-1;intnetlink_nflog_group;staticintnetlink_lo
g_fd=-1;staticstructthread*netlink_log_thread;staticintnetlink_listen_fd=-1;type
defvoid(*netlink_dispatch_f)(structnlmsghdr*msg,structzbuf*zb);voidnetlink_updat
e_binding(structinterface*ifp,unionsockunion*proto,unionsockunion*nbma){structnl
msghdr*n;structndmsg*ndm;structzbuf*zb=zbuf_alloc(512);n=znl_nlmsg_push(zb,nbma?
RTM_NEWNEIGH:RTM_DELNEIGH,NLM_F_REQUEST|NLM_F_REPLACE|NLM_F_CREATE);ndm=znl_push
(zb,sizeof(*ndm));*ndm=(structndmsg){.ndm_family=sockunion_family(proto),.ndm_if
index=ifp->ifindex,.ndm_type=RTN_UNICAST,.ndm_state=nbma?NUD_REACHABLE:NUD_FAILE
D,};znl_rta_push(zb,NDA_DST,sockunion_get_addr(proto),family2addrsize(sockunion_
family(proto)));if(nbma)znl_rta_push(zb,NDA_LLADDR,sockunion_get_addr(nbma),fami
ly2addrsize(sockunion_family(nbma)));znl_nlmsg_complete(zb,n);zbuf_send(zb,netli
nk_req_fd);zbuf_recv(zb,netlink_req_fd);zbuf_free(zb);}staticvoidnetlink_neigh_m
sg(structnlmsghdr*msg,structzbuf*zb){structndmsg*ndm;structrtattr*rta;structnhrp
_cache*c;structinterface*ifp;structzbufpayload;unionsockunionaddr;size_tlen;char
buf[SU_ADDRSTRLEN];intstate;ndm=znl_pull(zb,sizeof(*ndm));if(!ndm)return;sockuni
on_family(&addr)=AF_UNSPEC;while((rta=znl_rta_pull(zb,&payload))!=NULL){len=zbuf
_used(&payload);switch(rta->rta_type){caseNDA_DST:sockunion_set(&addr,ndm->ndm_f
amily,zbuf_pulln(&payload,len),len);break;}}ifp=if_lookup_by_index(ndm->ndm_ifin
dex,VRF_DEFAULT);if(!ifp||sockunion_family(&addr)==AF_UNSPEC)return;c=nhrp_cache
_get(ifp,&addr,0);if(!c)return;if(msg->nlmsg_type==RTM_GETNEIGH){debugf(NHRP_DEB
UG_KERNEL,"Netlink:who-has%sdev%s",sockunion2str(&addr,buf,sizeofbuf),ifp->name)
;if(c->cur.type>=NHRP_CACHE_CACHED){nhrp_cache_set_used(c,1);netlink_update_bind
ing(ifp,&addr,&c->cur.peer->vc->remote.nbma);}}else{debugf(NHRP_DEBUG_KERNEL,"Ne
tlink:update%sdev%snud%x",sockunion2str(&addr,buf,sizeofbuf),ifp->name,ndm->ndm_
state);state=(msg->nlmsg_type==RTM_NEWNEIGH)?ndm->ndm_state:NUD_FAILED;nhrp_cach
e_set_used(c,state==NUD_REACHABLE);}}staticintnetlink_route_recv(structthread*t)
{uint8_tbuf[ZNL_BUFFER_SIZE];intfd=THREAD_FD(t);structzbufpayload,zb;structnlmsg
hdr*n;zbuf_init(&zb,buf,sizeof(buf),0);while(zbuf_recv(&zb,fd)>0){while((n=znl_n
lmsg_pull(&zb,&payload))!=0){debugf(NHRP_DEBUG_KERNEL,"Netlink:Receivedmsg_type%
u,msg_flags%u",n->nlmsg_type,n->nlmsg_flags);switch(n->nlmsg_type){caseRTM_GETNE
IGH:caseRTM_NEWNEIGH:caseRTM_DELNEIGH:netlink_neigh_msg(n,&payload);break;}}}thr
ead_add_read(master,netlink_route_recv,0,fd,NULL);return0;}staticvoidnetlink_log
_register(intfd,intgroup){structnlmsghdr*n;structnfgenmsg*nf;structnfulnl_msg_co
nfig_cmdcmd;structzbuf*zb=zbuf_alloc(512);n=znl_nlmsg_push(zb,(NFNL_SUBSYS_ULOG<
<8)|NFULNL_MSG_CONFIG,NLM_F_REQUEST|NLM_F_ACK);nf=znl_push(zb,sizeof(*nf));*nf=(
structnfgenmsg){.nfgen_family=AF_UNSPEC,.version=NFNETLINK_V0,.res_id=htons(grou
p),};cmd.command=NFULNL_CFG_CMD_BIND;znl_rta_push(zb,NFULA_CFG_CMD,&cmd,sizeof(c
md));znl_nlmsg_complete(zb,n);zbuf_send(zb,fd);zbuf_free(zb);}staticvoidnetlink_
log_indication(structnlmsghdr*msg,structzbuf*zb){structnfgenmsg*nf;structrtattr*
rta;structzbufrtapl,pktpl;structinterface*ifp;structnfulnl_msg_packet_hdr*pkthdr
=NULL;uint32_t*in_ndx=NULL;nf=znl_pull(zb,sizeof(*nf));if(!nf)return;memset(&pkt
pl,0,sizeof(pktpl));while((rta=znl_rta_pull(zb,&rtapl))!=NULL){switch(rta->rta_t
ype){caseNFULA_PACKET_HDR:pkthdr=znl_pull(&rtapl,sizeof(*pkthdr));break;caseNFUL
A_IFINDEX_INDEV:in_ndx=znl_pull(&rtapl,sizeof(*in_ndx));break;caseNFULA_PAYLOAD:
pktpl=rtapl;break;/*NFULA_HWHDRexistsandissupposedtocontainsource*hardwareaddres
s.However,forip_greitseemstobe*thenexthopdestinationaddressifthepacketmatches*ro
ute.*/}}if(!pkthdr||!in_ndx||!zbuf_used(&pktpl))return;ifp=if_lookup_by_index(ht
onl(*in_ndx),VRF_DEFAULT);if(!ifp)return;nhrp_peer_send_indication(ifp,htons(pkt
hdr->hw_protocol),&pktpl);}staticintnetlink_log_recv(structthread*t){uint8_tbuf[
ZNL_BUFFER_SIZE];intfd=THREAD_FD(t);structzbufpayload,zb;structnlmsghdr*n;netlin
k_log_thread=NULL;zbuf_init(&zb,buf,sizeof(buf),0);while(zbuf_recv(&zb,fd)>0){wh
ile((n=znl_nlmsg_pull(&zb,&payload))!=0){debugf(NHRP_DEBUG_KERNEL,"Netlink-log:R
eceivedmsg_type%u,msg_flags%u",n->nlmsg_type,n->nlmsg_flags);switch(n->nlmsg_typ
e){case(NFNL_SUBSYS_ULOG<<8)|NFULNL_MSG_PACKET:netlink_log_indication(n,&payload
);break;}}}thread_add_read(master,netlink_log_recv,0,netlink_log_fd,&netlink_log
_thread);return0;}voidnetlink_set_nflog_group(intnlgroup){if(netlink_log_fd>=0){
THREAD_OFF(netlink_log_thread);close(netlink_log_fd);netlink_log_fd=-1;}netlink_
nflog_group=nlgroup;if(nlgroup){netlink_log_fd=znl_open(NETLINK_NETFILTER,0);if(
netlink_log_fd<0)return;netlink_log_register(netlink_log_fd,nlgroup);thread_add_
read(master,netlink_log_recv,0,netlink_log_fd,&netlink_log_thread);}}voidnetlink
_init(void){netlink_req_fd=znl_open(NETLINK_ROUTE,0);if(netlink_req_fd<0)return;
netlink_listen_fd=znl_open(NETLINK_ROUTE,RTMGRP_NEIGH);if(netlink_listen_fd<0)re
turn;thread_add_read(master,netlink_route_recv,0,netlink_listen_fd,NULL);}intnet
link_configure_arp(unsignedintifindex,intpf){structnlmsghdr*n;structndtmsg*ndtm;
structrtattr*rta;structzbuf*zb=zbuf_alloc(512);intr;n=znl_nlmsg_push(zb,RTM_SETN
EIGHTBL,NLM_F_REQUEST|NLM_F_REPLACE);ndtm=znl_push(zb,sizeof(*ndtm));*ndtm=(stru
ctndtmsg){.ndtm_family=pf,};znl_rta_push(zb,NDTA_NAME,pf==AF_INET?"arp_cache":"n
disc_cache",10);rta=znl_rta_nested_push(zb,NDTA_PARMS);znl_rta_push_u32(zb,NDTPA
_IFINDEX,ifindex);znl_rta_push_u32(zb,NDTPA_APP_PROBES,1);znl_rta_push_u32(zb,ND
TPA_MCAST_PROBES,0);znl_rta_push_u32(zb,NDTPA_UCAST_PROBES,0);znl_rta_nested_com
plete(zb,rta);znl_nlmsg_complete(zb,n);r=zbuf_send(zb,netlink_req_fd);zbuf_recv(
zb,netlink_req_fd);zbuf_free(zb);returnr;}