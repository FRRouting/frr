/*strongSwanVICIprotocolimplementationforNHRP*Copyright(c)2014-2015TimoTer√§s**Th
isfileisfreesoftware:youmaycopy,redistributeand/ormodify*itunderthetermsoftheGNU
GeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation,eitherversion2oftheL
icense,or*(atyouroption)anylaterversion.*/#include<string.h>#include<sys/socket.
h>#include<sys/un.h>#include"thread.h"#include"zbuf.h"#include"log.h"#include"nh
rpd.h"#include"vici.h"#defineERRNO_IO_RETRY(EN)(((EN)==EAGAIN)||((EN)==EWOULDBLO
CK)||((EN)==EINTR))structblob{char*ptr;intlen;};staticintblob_equal(conststructb
lob*b,constchar*str){if(!b||b->len!=(int)strlen(str))return0;returnmemcmp(b->ptr
,str,b->len)==0;}staticintblob2buf(conststructblob*b,char*buf,size_tn){if(!b||b-
>len>=(int)n)return0;memcpy(buf,b->ptr,b->len);buf[b->len]=0;return1;}structvici
_conn{structthread*t_reconnect,*t_read,*t_write;structzbufibuf;structzbuf_queueo
buf;intfd;uint8_tibuf_data[VICI_MAX_MSGLEN];};structvici_message_ctx{constchar*s
ections[8];intnsections;};staticintvici_reconnect(structthread*t);staticvoidvici
_submit_request(structvici_conn*vici,constchar*name,...);staticvoidvici_zbuf_put
s(structzbuf*obuf,constchar*str){size_tlen=strlen(str);zbuf_put8(obuf,len);zbuf_
put(obuf,str,len);}staticvoidvici_connection_error(structvici_conn*vici){nhrp_vc
_reset();THREAD_OFF(vici->t_read);THREAD_OFF(vici->t_write);zbuf_reset(&vici->ib
uf);zbufq_reset(&vici->obuf);close(vici->fd);vici->fd=-1;thread_add_timer(master
,vici_reconnect,vici,2,&vici->t_reconnect);}staticvoidvici_parse_message(structv
ici_conn*vici,structzbuf*msg,void(*parser)(structvici_message_ctx*ctx,enumvici_t
ype_tmsgtype,conststructblob*key,conststructblob*val),structvici_message_ctx*ctx
){uint8_t*type;structblobkey={0};structblobval={0};while((type=zbuf_may_pull(msg
,uint8_t))!=NULL){switch(*type){caseVICI_SECTION_START:key.len=zbuf_get8(msg);ke
y.ptr=zbuf_pulln(msg,key.len);debugf(NHRP_DEBUG_VICI,"VICI:Sectionstart'%.*s'",k
ey.len,key.ptr);parser(ctx,*type,&key,NULL);ctx->nsections++;break;caseVICI_SECT
ION_END:debugf(NHRP_DEBUG_VICI,"VICI:Sectionend");parser(ctx,*type,NULL,NULL);ct
x->nsections--;break;caseVICI_KEY_VALUE:key.len=zbuf_get8(msg);key.ptr=zbuf_pull
n(msg,key.len);val.len=zbuf_get_be16(msg);val.ptr=zbuf_pulln(msg,val.len);debugf
(NHRP_DEBUG_VICI,"VICI:Key'%.*s'='%.*s'",key.len,key.ptr,val.len,val.ptr);parser
(ctx,*type,&key,&val);break;caseVICI_LIST_START:key.len=zbuf_get8(msg);key.ptr=z
buf_pulln(msg,key.len);debugf(NHRP_DEBUG_VICI,"VICI:Liststart'%.*s'",key.len,key
.ptr);break;caseVICI_LIST_ITEM:val.len=zbuf_get_be16(msg);val.ptr=zbuf_pulln(msg
,val.len);debugf(NHRP_DEBUG_VICI,"VICI:Listitem:'%.*s'",val.len,val.ptr);parser(
ctx,*type,&key,&val);break;caseVICI_LIST_END:debugf(NHRP_DEBUG_VICI,"VICI:Listen
d");break;default:debugf(NHRP_DEBUG_VICI,"VICI:Unsupportedmessagecomponenttype%d
",*type);return;}}}structhandle_sa_ctx{structvici_message_ctxmsgctx;intevent;int
child_ok;intkill_ikesa;uint32_tchild_uniqueid,ike_uniqueid;struct{unionsockunion
host;structblobid,cert;}local,remote;};staticvoidparse_sa_message(structvici_mes
sage_ctx*ctx,enumvici_type_tmsgtype,conststructblob*key,conststructblob*val){str
ucthandle_sa_ctx*sactx=container_of(ctx,structhandle_sa_ctx,msgctx);structnhrp_v
c*vc;charbuf[512];switch(msgtype){caseVICI_SECTION_START:if(ctx->nsections==3){/
*Beginofchild-sasection,resetchildvars*/sactx->child_uniqueid=0;sactx->child_ok=
0;}break;caseVICI_SECTION_END:if(ctx->nsections==3){/*Endofchild-sasection,updat
enhrp_vc*/intup=sactx->child_ok||sactx->event==1;if(up){vc=nhrp_vc_get(&sactx->l
ocal.host,&sactx->remote.host,up);if(vc){blob2buf(&sactx->local.id,vc->local.id,
sizeof(vc->local.id));if(blob2buf(&sactx->local.cert,(char*)vc->local.cert,sizeo
f(vc->local.cert)))vc->local.certlen=sactx->local.cert.len;blob2buf(&sactx->remo
te.id,vc->remote.id,sizeof(vc->remote.id));if(blob2buf(&sactx->remote.cert,(char
*)vc->remote.cert,sizeof(vc->remote.cert)))vc->remote.certlen=sactx->remote.cert
.len;sactx->kill_ikesa|=nhrp_vc_ipsec_updown(sactx->child_uniqueid,vc);}}else{nh
rp_vc_ipsec_updown(sactx->child_uniqueid,0);}}break;default:if(!key)break;switch
(key->ptr[0]){case'l':if(blob_equal(key,"local-host")&&ctx->nsections==1){if(blo
b2buf(val,buf,sizeof(buf)))if(str2sockunion(buf,&sactx->local.host)<0)zlog_err("
VICI:badstrongSwanlocal-host:%s",buf);}elseif(blob_equal(key,"local-id")&&ctx->n
sections==1){sactx->local.id=*val;}elseif(blob_equal(key,"local-cert-data")&&ctx
->nsections==1){sactx->local.cert=*val;}break;case'r':if(blob_equal(key,"remote-
host")&&ctx->nsections==1){if(blob2buf(val,buf,sizeof(buf)))if(str2sockunion(buf
,&sactx->remote.host)<0)zlog_err("VICI:badstrongSwanremote-host:%s",buf);}elseif
(blob_equal(key,"remote-id")&&ctx->nsections==1){sactx->remote.id=*val;}elseif(b
lob_equal(key,"remote-cert-data")&&ctx->nsections==1){sactx->remote.cert=*val;}b
reak;case'u':if(blob_equal(key,"uniqueid")&&blob2buf(val,buf,sizeof(buf))){if(ct
x->nsections==3)sactx->child_uniqueid=strtoul(buf,NULL,0);elseif(ctx->nsections=
=1)sactx->ike_uniqueid=strtoul(buf,NULL,0);}break;case's':if(blob_equal(key,"sta
te")&&ctx->nsections==3){sactx->child_ok=(sactx->event==0&&(blob_equal(val,"INST
ALLED")||blob_equal(val,"REKEYED")));}break;}break;}}staticvoidparse_cmd_respons
e(structvici_message_ctx*ctx,enumvici_type_tmsgtype,conststructblob*key,conststr
uctblob*val){charbuf[512];switch(msgtype){caseVICI_KEY_VALUE:if(blob_equal(key,"
errmsg")&&blob2buf(val,buf,sizeof(buf)))zlog_err("VICI:strongSwan:%s",buf);break
;default:break;}}staticvoidvici_recv_sa(structvici_conn*vici,structzbuf*msg,inte
vent){charbuf[32];structhandle_sa_ctxctx={.event=event,};vici_parse_message(vici
,msg,parse_sa_message,&ctx.msgctx);if(ctx.kill_ikesa&&ctx.ike_uniqueid){debugf(N
HRP_DEBUG_COMMON,"VICI:DeletingIKE_SA%u",ctx.ike_uniqueid);snprintf(buf,sizeofbu
f,"%u",ctx.ike_uniqueid);vici_submit_request(vici,"terminate",VICI_KEY_VALUE,"ik
e-id",strlen(buf),buf,VICI_END);}}staticvoidvici_recv_message(structvici_conn*vi
ci,structzbuf*msg){uint32_tmsglen;uint8_tmsgtype;structblobname;structvici_messa
ge_ctxctx;msglen=zbuf_get_be32(msg);msgtype=zbuf_get8(msg);debugf(NHRP_DEBUG_VIC
I,"VICI:Message%d,%dbytes",msgtype,msglen);switch(msgtype){caseVICI_EVENT:name.l
en=zbuf_get8(msg);name.ptr=zbuf_pulln(msg,name.len);debugf(NHRP_DEBUG_VICI,"VICI
:Event'%.*s'",name.len,name.ptr);if(blob_equal(&name,"list-sa")||blob_equal(&nam
e,"child-updown")||blob_equal(&name,"child-rekey"))vici_recv_sa(vici,msg,0);else
if(blob_equal(&name,"child-state-installed")||blob_equal(&name,"child-state-reke
yed"))vici_recv_sa(vici,msg,1);elseif(blob_equal(&name,"child-state-destroying")
)vici_recv_sa(vici,msg,2);break;caseVICI_CMD_RESPONSE:vici_parse_message(vici,ms
g,parse_cmd_response,&ctx);break;caseVICI_EVENT_UNKNOWN:caseVICI_CMD_UNKNOWN:zlo
g_err("VICI:StrongSwandoesnotsupportmandatoryevents(unpatched?)");break;caseVICI
_EVENT_CONFIRM:break;default:zlog_notice("VICI:Unrecognizedmessagetype%d",msgtyp
e);break;}}staticintvici_read(structthread*t){structvici_conn*vici=THREAD_ARG(t)
;structzbuf*ibuf=&vici->ibuf;structzbufpktbuf;vici->t_read=NULL;if(zbuf_read(ibu
f,vici->fd,(size_t)-1)<0){vici_connection_error(vici);return0;}/*Processallmessa
gesinbuffer*/do{uint32_t*hdrlen=zbuf_may_pull(ibuf,uint32_t);if(!hdrlen)break;if
(!zbuf_may_pulln(ibuf,ntohl(*hdrlen))){zbuf_reset_head(ibuf,hdrlen);break;}/*Han
dlepacket*/zbuf_init(&pktbuf,hdrlen,htonl(*hdrlen)+4,htonl(*hdrlen)+4);vici_recv
_message(vici,&pktbuf);}while(1);thread_add_read(master,vici_read,vici,vici->fd,
&vici->t_read);return0;}staticintvici_write(structthread*t){structvici_conn*vici
=THREAD_ARG(t);intr;vici->t_write=NULL;r=zbufq_write(&vici->obuf,vici->fd);if(r>
0){thread_add_write(master,vici_write,vici,vici->fd,&vici->t_write);}elseif(r<0)
{vici_connection_error(vici);}return0;}staticvoidvici_submit(structvici_conn*vic
i,structzbuf*obuf){if(vici->fd<0){zbuf_free(obuf);return;}zbufq_queue(&vici->obu
f,obuf);thread_add_write(master,vici_write,vici,vici->fd,&vici->t_write);}static
voidvici_submit_request(structvici_conn*vici,constchar*name,...){structzbuf*obuf
;uint32_t*hdrlen;va_listva;size_tlen;inttype;obuf=zbuf_alloc(256);if(!obuf)retur
n;hdrlen=zbuf_push(obuf,uint32_t);zbuf_put8(obuf,VICI_CMD_REQUEST);vici_zbuf_put
s(obuf,name);va_start(va,name);for(type=va_arg(va,int);type!=VICI_END;type=va_ar
g(va,int)){zbuf_put8(obuf,type);switch(type){caseVICI_KEY_VALUE:vici_zbuf_puts(o
buf,va_arg(va,constchar*));len=va_arg(va,size_t);zbuf_put_be16(obuf,len);zbuf_pu
t(obuf,va_arg(va,void*),len);break;default:break;}}va_end(va);*hdrlen=htonl(zbuf
_used(obuf)-4);vici_submit(vici,obuf);}staticvoidvici_register_event(structvici_
conn*vici,constchar*name){structzbuf*obuf;uint32_t*hdrlen;uint8_tnamelen;namelen
=strlen(name);obuf=zbuf_alloc(4+1+1+namelen);if(!obuf)return;hdrlen=zbuf_push(ob
uf,uint32_t);zbuf_put8(obuf,VICI_EVENT_REGISTER);zbuf_put8(obuf,namelen);zbuf_pu
t(obuf,name,namelen);*hdrlen=htonl(zbuf_used(obuf)-4);vici_submit(vici,obuf);}st
aticintvici_reconnect(structthread*t){structvici_conn*vici=THREAD_ARG(t);intfd;v
ici->t_reconnect=NULL;if(vici->fd>=0)return0;fd=sock_open_unix("/var/run/charon.
vici");if(fd<0){debugf(NHRP_DEBUG_VICI,"%s:failureconnectingVICIsocket:%s",__PRE
TTY_FUNCTION__,strerror(errno));thread_add_timer(master,vici_reconnect,vici,2,&v
ici->t_reconnect);return0;}debugf(NHRP_DEBUG_COMMON,"VICI:Connected");vici->fd=f
d;thread_add_read(master,vici_read,vici,vici->fd,&vici->t_read);/*Sendeventsubsc
ribtions*///vici_register_event(vici,"child-updown");//vici_register_event(vici,
"child-rekey");vici_register_event(vici,"child-state-installed");vici_register_e
vent(vici,"child-state-rekeyed");vici_register_event(vici,"child-state-destroyin
g");vici_register_event(vici,"list-sa");vici_submit_request(vici,"list-sas",VICI
_END);return0;}staticstructvici_connvici_connection;voidvici_init(void){structvi
ci_conn*vici=&vici_connection;vici->fd=-1;zbuf_init(&vici->ibuf,vici->ibuf_data,
sizeof(vici->ibuf_data),0);zbufq_init(&vici->obuf);thread_add_timer_msec(master,
vici_reconnect,vici,10,&vici->t_reconnect);}voidvici_terminate(void){}voidvici_r
equest_vc(constchar*profile,unionsockunion*src,unionsockunion*dst,intprio){struc
tvici_conn*vici=&vici_connection;charbuf[2][SU_ADDRSTRLEN];sockunion2str(src,buf
[0],sizeofbuf[0]);sockunion2str(dst,buf[1],sizeofbuf[1]);vici_submit_request(vic
i,"initiate",VICI_KEY_VALUE,"child",strlen(profile),profile,VICI_KEY_VALUE,"time
out",(size_t)2,"-1",VICI_KEY_VALUE,"async",(size_t)1,"1",VICI_KEY_VALUE,"init-li
mits",(size_t)1,prio?"0":"1",VICI_KEY_VALUE,"my-host",strlen(buf[0]),buf[0],VICI
_KEY_VALUE,"other-host",strlen(buf[1]),buf[1],VICI_END);}intsock_open_unix(const
char*path){intret,fd;structsockaddr_unaddr;fd=socket(AF_UNIX,SOCK_STREAM,0);if(f
d<0)return-1;memset(&addr,0,sizeof(structsockaddr_un));addr.sun_family=AF_UNIX;s
trncpy(addr.sun_path,path,sizeof(addr.sun_path)-1);ret=connect(fd,(structsockadd
r*)&addr,sizeof(addr.sun_family)+strlen(addr.sun_path));if(ret<0){close(fd);retu
rn-1;}ret=fcntl(fd,F_SETFL,fcntl(fd,F_GETFL,0)|O_NONBLOCK);if(ret<0){close(fd);r
eturn-1;}returnfd;}