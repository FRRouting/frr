/*BGPEVPNinternaldefinitions*Copyright(C)2017CumulusNetworks,Inc.**Thisfileispar
tofFRR.**FRRisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofthe
GNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or
(atyouroption)any*laterversion.**FRRisdistributedinthehopethatitwillbeuseful,but
*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORA
PARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavere
ceivedacopyoftheGNUGeneralPublicLicense*alongwithFRR;seethefileCOPYING.Ifnot,wri
tetotheFree*SoftwareFoundation,Inc.,59TemplePlace-Suite330,Boston,MA*02111-1307,
USA.*/#ifndef_BGP_EVPN_PRIVATE_H#define_BGP_EVPN_PRIVATE_H#include"vxlan.h"#incl
ude"zebra.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_ecommunity.h"#defineRT_ADDRST
RLEN28/*EVPNprefixlengths.Thisreprsentthesizeofstructprefix_evpn*/#defineEVPN_TY
PE_2_ROUTE_PREFIXLEN224#defineEVPN_TYPE_3_ROUTE_PREFIXLEN224#defineEVPN_TYPE_5_R
OUTE_PREFIXLEN224/*EVPNroutetypes.*/typedefenum{BGP_EVPN_AD_ROUTE=1,/*EthernetAu
to-Discovery(A-D)route*/BGP_EVPN_MAC_IP_ROUTE,/*MAC/IPAdvertisementroute*/BGP_EV
PN_IMET_ROUTE,/*InclusiveMulticastEthernetTagroute*/BGP_EVPN_ES_ROUTE,/*Ethernet
Segmentroute*/BGP_EVPN_IP_PREFIX_ROUTE,/*IPPrefixroute*/}bgp_evpn_route_type;/**
HashtableofEVIs.Rightnow,theonlytypeofEVIsupportediswith*VxLANencapsulation,henc
eeachEVIcorrespondstoaL2VNI.*TheVNIsarenot"created"throughBGPbutthroughsomeother
interface*onthesystem.ThistablestoresVNIsthatBGPcomestoknowaspresent*onthesystem
(throughinteractionwithzebra)aswellaspre-configured*VNIs(whichneedtobedefinedint
hesystemtobecome"live").*/structbgpevpn{vni_tvni;vrf_id_ttenant_vrf_id;uint32_tf
lags;#defineVNI_FLAG_CFGD0x1/*VNIisuserconfigured*/#defineVNI_FLAG_LIVE0x2/*VNIi
s"live"*/#defineVNI_FLAG_RD_CFGD0x4/*RDisuserconfigured.*/#defineVNI_FLAG_IMPRT_
CFGD0x8/*ImportRTisuserconfigured*/#defineVNI_FLAG_EXPRT_CFGD0x10/*ExportRTisuse
rconfigured*/#defineVNI_FLAG_USE_TWO_LABELS0x20/*AttachbothL2-VNIandL3-VNIifneed
edforthisVPN*/structbgp*bgp_vrf;/*backpointertothevrfinstance*//*Flagtoindicatei
fweare*advertisingtheg/wmacipfor*thisVNI*/uint8_tadvertise_gw_macip;/*Flagtoindi
cateifweare*advertisingsubnetforthisVNI*/uint8_tadvertise_subnet;/*Idforderiving
theRD*automaticallyforthisVNI*/uint16_trd_id;/*RDforthisVNI.*/structprefix_rdprd
;/*Routetype3field*/structin_addroriginator_ip;/*ImportandExportRTs.*/structlist
*import_rtl;structlist*export_rtl;/*RoutetableforEVPNroutesfor*thisVNI.*/structb
gp_table*route_table;QOBJ_FIELDS};DECLARE_QOBJ_TYPE(bgpevpn)/*MappingofImportRTt
oVNIs.*TheImportRTsofallVNIsaremaintainedinahashtablewitheach*RTlinkingtoallVNIs
thatwillimportroutesmatchingthisRT.*/structirt_node{/*RT*/structecommunity_valrt
;/*ListofVNIsimportingroutesmatchingthisRT.*/structlist*vnis;};/*MappingofImport
RTtoVRFs.*TheImportRTsofallVRFssaremaintainedinahashtablewitheach*RTlinkingtoall
VRFsthatwillimportroutesmatchingthisRT.*/structvrf_irt_node{/*RT*/structecommuni
ty_valrt;/*ListofVNIsimportingroutesmatchingthisRT.*/structlist*vrfs;};#defineRT
_TYPE_IMPORT1#defineRT_TYPE_EXPORT2#defineRT_TYPE_BOTH3staticinlineintis_vrf_rd_
configured(structbgp*bgp_vrf){return(CHECK_FLAG(bgp_vrf->vrf_flags,BGP_VRF_RD_CF
GD));}staticinlineintbgp_evpn_vrf_rd_matches_existing(structbgp*bgp_vrf,structpr
efix_rd*prd){return(memcmp(&bgp_vrf->vrf_prd.val,prd->val,ECOMMUNITY_SIZE)==0);}
staticinlinevni_tbgpevpn_get_l3vni(structbgpevpn*vpn){returnvpn->bgp_vrf?vpn->bg
p_vrf->l3vni:0;}staticinlinevoidbgpevpn_get_rmac(structbgpevpn*vpn,structethaddr
*rmac){memset(rmac,0,sizeof(structethaddr));if(!vpn->bgp_vrf)return;memcpy(rmac,
&vpn->bgp_vrf->rmac,sizeof(structethaddr));}staticinlinestructlist*bgpevpn_get_v
rf_export_rtl(structbgpevpn*vpn){if(!vpn->bgp_vrf)returnNULL;returnvpn->bgp_vrf-
>vrf_export_rtl;}staticinlinestructlist*bgpevpn_get_vrf_import_rtl(structbgpevpn
*vpn){if(!vpn->bgp_vrf)returnNULL;returnvpn->bgp_vrf->vrf_import_rtl;}staticinli
nevoidbgpevpn_unlink_from_l3vni(structbgpevpn*vpn){/*bailifvpnisnotassociatedtob
gp_vrf*/if(!vpn->bgp_vrf)return;UNSET_FLAG(vpn->flags,VNI_FLAG_USE_TWO_LABELS);l
istnode_delete(vpn->bgp_vrf->l2vnis,vpn);/*removethebackpointertothevrfinstance*
/vpn->bgp_vrf=NULL;}staticinlinevoidbgpevpn_link_to_l3vni(structbgpevpn*vpn){str
uctbgp*bgp_vrf=NULL;/*bailifvpnisalreadyassociatedtovrf*/if(vpn->bgp_vrf)return;
bgp_vrf=bgp_lookup_by_vrf_id(vpn->tenant_vrf_id);if(!bgp_vrf)return;/*associatet
hevpntothebgp_vrfinstance*/vpn->bgp_vrf=bgp_vrf;listnode_add_sort(bgp_vrf->l2vni
s,vpn);/*checkifweareadvertisingtwolabelsforthisvpn*/if(!CHECK_FLAG(bgp_vrf->vrf
_flags,BGP_VRF_L3VNI_PREFIX_ROUTES_ONLY))SET_FLAG(vpn->flags,VNI_FLAG_USE_TWO_LA
BELS);}staticinlineintis_vni_configured(structbgpevpn*vpn){return(CHECK_FLAG(vpn
->flags,VNI_FLAG_CFGD));}staticinlineintis_vni_live(structbgpevpn*vpn){return(CH
ECK_FLAG(vpn->flags,VNI_FLAG_LIVE));}staticinlineintis_rd_configured(structbgpev
pn*vpn){return(CHECK_FLAG(vpn->flags,VNI_FLAG_RD_CFGD));}staticinlineintbgp_evpn
_rd_matches_existing(structbgpevpn*vpn,structprefix_rd*prd){return(memcmp(&vpn->
prd.val,prd->val,ECOMMUNITY_SIZE)==0);}staticinlineintis_import_rt_configured(st
ructbgpevpn*vpn){return(CHECK_FLAG(vpn->flags,VNI_FLAG_IMPRT_CFGD));}staticinlin
eintis_export_rt_configured(structbgpevpn*vpn){return(CHECK_FLAG(vpn->flags,VNI_
FLAG_EXPRT_CFGD));}staticinlineintis_vni_param_configured(structbgpevpn*vpn){ret
urn(is_rd_configured(vpn)||is_import_rt_configured(vpn)||is_export_rt_configured
(vpn));}staticinlinevoidencode_rmac_extcomm(structecommunity_val*eval,structetha
ddr*rmac){memset(eval,0,sizeof(*eval));eval->val[0]=ECOMMUNITY_ENCODE_EVPN;eval-
>val[1]=ECOMMUNITY_EVPN_SUBTYPE_ROUTERMAC;memcpy(&eval->val[2],rmac,ETH_ALEN);}s
taticinlinevoidencode_default_gw_extcomm(structecommunity_val*eval){memset(eval,
0,sizeof(*eval));eval->val[0]=ECOMMUNITY_ENCODE_OPAQUE;eval->val[1]=ECOMMUNITY_E
VPN_SUBTYPE_DEF_GW;}staticinlinevoidencode_mac_mobility_extcomm(intstatic_mac,ui
nt32_tseq,structecommunity_val*eval){memset(eval,0,sizeof(*eval));eval->val[0]=E
COMMUNITY_ENCODE_EVPN;eval->val[1]=ECOMMUNITY_EVPN_SUBTYPE_MACMOBILITY;if(static
_mac)eval->val[2]=ECOMMUNITY_EVPN_SUBTYPE_MACMOBILITY_FLAG_STICKY;eval->val[4]=(
seq>>24)&0xff;eval->val[5]=(seq>>16)&0xff;eval->val[6]=(seq>>8)&0xff;eval->val[7
]=seq&0xff;}staticinlinevoidip_prefix_from_type5_prefix(structprefix_evpn*evp,st
ructprefix*ip){memset(ip,0,sizeof(structprefix));if(IS_EVPN_PREFIX_IPADDR_V4(evp
)){ip->family=AF_INET;ip->prefixlen=evp->prefix.ip_prefix_length;memcpy(&(ip->u.
prefix4),&(evp->prefix.ip.ip),IPV4_MAX_BYTELEN);}elseif(IS_EVPN_PREFIX_IPADDR_V6
(evp)){ip->family=AF_INET6;ip->prefixlen=evp->prefix.ip_prefix_length;memcpy(&(i
p->u.prefix6),&(evp->prefix.ip.ip),IPV6_MAX_BYTELEN);}}staticinlineintis_evpn_pr
efix_default(structprefix*evp){if(evp->family!=AF_EVPN)return0;return((evp->u.pr
efix_evpn.ip_prefix_length==0)?1:0);}staticinlinevoidip_prefix_from_type2_prefix
(structprefix_evpn*evp,structprefix*ip){memset(ip,0,sizeof(structprefix));if(IS_
EVPN_PREFIX_IPADDR_V4(evp)){ip->family=AF_INET;ip->prefixlen=IPV4_MAX_BITLEN;mem
cpy(&(ip->u.prefix4),&(evp->prefix.ip.ip),IPV4_MAX_BYTELEN);}elseif(IS_EVPN_PREF
IX_IPADDR_V6(evp)){ip->family=AF_INET6;ip->prefixlen=IPV6_MAX_BITLEN;memcpy(&(ip
->u.prefix6),&(evp->prefix.ip.ip),IPV6_MAX_BYTELEN);}}staticinlinevoidbuild_evpn
_type2_prefix(structprefix_evpn*p,structethaddr*mac,structipaddr*ip){memset(p,0,
sizeof(structprefix_evpn));p->family=AF_EVPN;p->prefixlen=EVPN_TYPE_2_ROUTE_PREF
IXLEN;p->prefix.route_type=BGP_EVPN_MAC_IP_ROUTE;memcpy(&p->prefix.mac.octet,mac
->octet,ETH_ALEN);p->prefix.ip.ipa_type=IPADDR_NONE;if(ip)memcpy(&p->prefix.ip,i
p,sizeof(*ip));}staticinlinevoidbuild_type5_prefix_from_ip_prefix(structprefix_e
vpn*evp,structprefix*ip_prefix){structipaddrip;memset(&ip,0,sizeof(structipaddr)
);if(ip_prefix->family==AF_INET){ip.ipa_type=IPADDR_V4;memcpy(&ip.ipaddr_v4,&ip_
prefix->u.prefix4,sizeof(structin_addr));}else{ip.ipa_type=IPADDR_V6;memcpy(&ip.
ipaddr_v6,&ip_prefix->u.prefix6,sizeof(structin6_addr));}memset(evp,0,sizeof(str
uctprefix_evpn));evp->family=AF_EVPN;evp->prefixlen=EVPN_TYPE_5_ROUTE_PREFIXLEN;
evp->prefix.ip_prefix_length=ip_prefix->prefixlen;evp->prefix.route_type=BGP_EVP
N_IP_PREFIX_ROUTE;evp->prefix.ip.ipa_type=ip.ipa_type;memcpy(&evp->prefix.ip,&ip
,sizeof(structipaddr));}staticinlinevoidbuild_evpn_type3_prefix(structprefix_evp
n*p,structin_addroriginator_ip){memset(p,0,sizeof(structprefix_evpn));p->family=
AF_EVPN;p->prefixlen=EVPN_TYPE_3_ROUTE_PREFIXLEN;p->prefix.route_type=BGP_EVPN_I
MET_ROUTE;p->prefix.ip.ipa_type=IPADDR_V4;p->prefix.ip.ipaddr_v4=originator_ip;}
staticinlineintevpn_default_originate_set(structbgp*bgp,afi_tafi,safi_tsafi){if(
afi==AFI_IP&&CHECK_FLAG(bgp->af_flags[AFI_L2VPN][SAFI_EVPN],BGP_L2VPN_EVPN_DEFAU
LT_ORIGINATE_IPV4))return1;elseif(afi==AFI_IP6&&CHECK_FLAG(bgp->af_flags[AFI_L2V
PN][SAFI_EVPN],BGP_L2VPN_EVPN_DEFAULT_ORIGINATE_IPV6))return1;return0;}externvoi
devpn_rt_delete_auto(structbgp*,vni_t,structlist*);externvoidbgp_evpn_configure_
export_rt_for_vrf(structbgp*bgp_vrf,structecommunity*ecomadd);externvoidbgp_evpn
_unconfigure_export_rt_for_vrf(structbgp*bgp_vrf,structecommunity*ecomdel);exter
nvoidbgp_evpn_configure_import_rt_for_vrf(structbgp*bgp_vrf,structecommunity*eco
madd);externvoidbgp_evpn_unconfigure_import_rt_for_vrf(structbgp*bgp_vrf,structe
community*ecomdel);externintbgp_evpn_handle_export_rt_change(structbgp*bgp,struc
tbgpevpn*vpn);externvoidbgp_evpn_handle_vrf_rd_change(structbgp*bgp_vrf,intwithd
raw);externvoidbgp_evpn_handle_rd_change(structbgp*bgp,structbgpevpn*vpn,intwith
draw);externintbgp_evpn_install_routes(structbgp*bgp,structbgpevpn*vpn);externin
tbgp_evpn_uninstall_routes(structbgp*bgp,structbgpevpn*vpn);externvoidbgp_evpn_m
ap_vrf_to_its_rts(structbgp*bgp_vrf);externvoidbgp_evpn_unmap_vrf_from_its_rts(s
tructbgp*bgp_vrf);externvoidbgp_evpn_map_vni_to_its_rts(structbgp*bgp,structbgpe
vpn*vpn);externvoidbgp_evpn_unmap_vni_from_its_rts(structbgp*bgp,structbgpevpn*v
pn);externvoidbgp_evpn_derive_auto_rt_import(structbgp*bgp,structbgpevpn*vpn);ex
ternvoidbgp_evpn_derive_auto_rt_export(structbgp*bgp,structbgpevpn*vpn);externvo
idbgp_evpn_derive_auto_rd(structbgp*bgp,structbgpevpn*vpn);externvoidbgp_evpn_de
rive_auto_rd_for_vrf(structbgp*bgp);externstructbgpevpn*bgp_evpn_lookup_vni(stru
ctbgp*bgp,vni_tvni);externstructbgpevpn*bgp_evpn_new(structbgp*bgp,vni_tvni,stru
ctin_addroriginator_ip,vrf_id_ttenant_vrf_id);externvoidbgp_evpn_free(structbgp*
bgp,structbgpevpn*vpn);#endif/*_BGP_EVPN_PRIVATE_H*/