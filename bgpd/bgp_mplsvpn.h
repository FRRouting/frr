/*MPLS-VPN*Copyright(C)2000KunihiroIshiguro<kunihiro@zebra.org>**Thisfileisparto
fGxNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthet
ermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherve
rsion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwi
llbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILIT
YorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Y
oushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seeth
efileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloo
r,Boston,MA02110-1301USA*/#ifndef_QUAGGA_BGP_MPLSVPN_H#define_QUAGGA_BGP_MPLSVPN
_H#include"bgpd/bgp_route.h"#include"bgpd/bgp_rd.h"#include"bgpd/bgp_zebra.h"#de
fineMPLS_LABEL_IS_SPECIAL(label)((label)<=MPLS_LABEL_EXTENSION)#defineMPLS_LABEL
_IS_NULL(label)\((label)==MPLS_LABEL_IPV4_EXPLICIT_NULL\||(label)==MPLS_LABEL_IP
V6_EXPLICIT_NULL\||(label)==MPLS_LABEL_IMPLICIT_NULL)#defineBGP_VPNVX_HELP_STR\"
AddressFamily\n"\"AddressFamily\n"#defineV4_HEADER\"NetworkNextHopMetricLocPrfWe
ightPath\n"#defineV4_HEADER_TAG"NetworkNextHopIntag/Outtag\n"#defineV4_HEADER_OV
ERLAY\"NetworkNextHopEthTagOverlayIndexRouterMac\n"externvoidbgp_mplsvpn_init(vo
id);externintbgp_nlri_parse_vpn(structpeer*,structattr*,structbgp_nlri*);externu
int32_tdecode_label(mpls_label_t*);externvoidencode_label(mpls_label_t,mpls_labe
l_t*);externintargv_find_and_parse_vpnvx(structcmd_token**argv,intargc,int*index
,afi_t*afi);externintbgp_show_mpls_vpn(structvty*vty,afi_tafi,structprefix_rd*pr
d,enumbgp_show_typetype,void*output_arg,inttags,uint8_tuse_json);externvoidvpn_l
eak_from_vrf_update(structbgp*bgp_vpn,structbgp*bgp_vrf,structbgp_info*info_vrf)
;externvoidvpn_leak_from_vrf_withdraw(structbgp*bgp_vpn,structbgp*bgp_vrf,struct
bgp_info*info_vrf);externvoidvpn_leak_from_vrf_withdraw_all(structbgp*bgp_vpn,st
ructbgp*bgp_vrf,afi_tafi);externvoidvpn_leak_from_vrf_update_all(structbgp*bgp_v
pn,structbgp*bgp_vrf,afi_tafi);externvoidvpn_leak_to_vrf_withdraw_all(structbgp*
bgp_vrf,afi_tafi);externvoidvpn_leak_to_vrf_update_all(structbgp*bgp_vrf,structb
gp*bgp_vpn,afi_tafi);externvoidvpn_leak_to_vrf_update(structbgp*bgp_vpn,structbg
p_info*info_vpn);externvoidvpn_leak_to_vrf_withdraw(structbgp*bgp_vpn,structbgp_
info*info_vpn);externvoidvpn_leak_zebra_vrf_label_update(structbgp*bgp,afi_tafi)
;externvoidvpn_leak_zebra_vrf_label_withdraw(structbgp*bgp,afi_tafi);staticinlin
eintvpn_leak_to_vpn_active(structbgp*bgp_vrf,afi_tafi,constchar**pmsg){if(bgp_vr
f->inst_type!=BGP_INSTANCE_TYPE_VRF&&bgp_vrf->inst_type!=BGP_INSTANCE_TYPE_DEFAU
LT){if(pmsg)*pmsg="sourcebgpinstanceneithervrfnordefault";return0;}/*Isvrfconfig
uredtoexporttovpn?*/if(!CHECK_FLAG(bgp_vrf->af_flags[afi][SAFI_UNICAST],BGP_CONF
IG_VRF_TO_MPLSVPN_EXPORT)){if(pmsg)*pmsg="exportnotset";return0;}/*IsthereanRTli
stset?*/if(!bgp_vrf->vpn_policy[afi].rtlist[BGP_VPN_POLICY_DIR_TOVPN]){if(pmsg)*
pmsg="rtlisttovpnnotdefined";return0;}/*IsthereanRDset?*/if(!CHECK_FLAG(bgp_vrf-
>vpn_policy[afi].flags,BGP_VPN_POLICY_TOVPN_RD_SET)){if(pmsg)*pmsg="rdnotdefined
";return0;}return1;}staticinlineintvpn_leak_from_vpn_active(structbgp*bgp_vrf,af
i_tafi,constchar**pmsg){if(bgp_vrf->inst_type!=BGP_INSTANCE_TYPE_VRF&&bgp_vrf->i
nst_type!=BGP_INSTANCE_TYPE_DEFAULT){if(pmsg)*pmsg="destinationbgpinstanceneithe
rvrfnordefault";return0;}/*Isvrfconfiguredtoimportfromvpn?*/if(!CHECK_FLAG(bgp_v
rf->af_flags[afi][SAFI_UNICAST],BGP_CONFIG_MPLSVPN_TO_VRF_IMPORT)){if(pmsg)*pmsg
="importnotset";return0;}if(!bgp_vrf->vpn_policy[afi].rtlist[BGP_VPN_POLICY_DIR_
FROMVPN]){if(pmsg)*pmsg="rtlistfromvpnnotdefined";return0;}return1;}staticinline
voidvpn_leak_prechange(vpn_policy_direction_tdirection,afi_tafi,structbgp*bgp_vp
n,structbgp*bgp_vrf){if((direction==BGP_VPN_POLICY_DIR_FROMVPN)&&vpn_leak_from_v
pn_active(bgp_vrf,afi,NULL)){vpn_leak_to_vrf_withdraw_all(bgp_vrf,afi);}if((dire
ction==BGP_VPN_POLICY_DIR_TOVPN)&&vpn_leak_to_vpn_active(bgp_vrf,afi,NULL)){vpn_
leak_from_vrf_withdraw_all(bgp_vpn,bgp_vrf,afi);}}staticinlinevoidvpn_leak_postc
hange(vpn_policy_direction_tdirection,afi_tafi,structbgp*bgp_vpn,structbgp*bgp_v
rf){if(direction==BGP_VPN_POLICY_DIR_FROMVPN)vpn_leak_to_vrf_update_all(bgp_vrf,
bgp_vpn,afi);if(direction==BGP_VPN_POLICY_DIR_TOVPN){if(bgp_vrf->vpn_policy[afi]
.tovpn_label!=bgp_vrf->vpn_policy[afi].tovpn_zebra_vrf_label_last_sent){vpn_leak
_zebra_vrf_label_update(bgp_vrf,afi);}vpn_leak_from_vrf_update_all(bgp_vpn,bgp_v
rf,afi);}}externvoidvpn_policy_routemap_event(constchar*rmap_name);externvrf_id_
tget_first_vrf_for_redirect_with_rt(structecommunity*eckey);#endif/*_QUAGGA_BGP_
MPLSVPN_H*/