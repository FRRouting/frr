/*BGPNexthoptracking*Copyright(C)2013CumulusNetworks,Inc.**ThisfileispartofGNUZe
bra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoft
heGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,
or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuse
ful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITN
ESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshoul
dhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCO
PYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bosto
n,MA02110-1301USA*/#include<zebra.h>#include"command.h"#include"thread.h"#includ
e"prefix.h"#include"zclient.h"#include"stream.h"#include"network.h"#include"log.
h"#include"memory.h"#include"nexthop.h"#include"vrf.h"#include"filter.h"#include
"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgpd/bgp_route.h"#include"bgpd/b
gp_attr.h"#include"bgpd/bgp_nexthop.h"#include"bgpd/bgp_debug.h"#include"bgpd/bg
p_nht.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_zebra.h"externstructzclient*zc
lient;staticvoidregister_zebra_rnh(structbgp_nexthop_cache*bnc,intis_bgp_static_
route);staticvoidunregister_zebra_rnh(structbgp_nexthop_cache*bnc,intis_bgp_stat
ic_route);staticvoidevaluate_paths(structbgp_nexthop_cache*bnc);staticintmake_pr
efix(intafi,structbgp_info*ri,structprefix*p);staticvoidpath_nh_map(structbgp_in
fo*path,structbgp_nexthop_cache*bnc,intkeep);staticintbgp_isvalid_nexthop(struct
bgp_nexthop_cache*bnc){return(bgp_zebra_num_connects()==0||(bnc&&CHECK_FLAG(bnc-
>flags,BGP_NEXTHOP_VALID)));}intbgp_find_nexthop(structbgp_info*path,intconnecte
d){structbgp_nexthop_cache*bnc=path->nexthop;if(!bnc)return0;/**Wearecheatingher
e.Viewshavenoassociatedunderlying*abilitytodetectnexthops.Sowhenwehaveaview*just
telleveryonethenexthopisvalid*/if(path->peer&&path->peer->bgp->inst_type==BGP_IN
STANCE_TYPE_VIEW)return1;if(connected&&!(CHECK_FLAG(bnc->flags,BGP_NEXTHOP_CONNE
CTED)))return0;return(bgp_isvalid_nexthop(bnc));}staticvoidbgp_unlink_nexthop_ch
eck(structbgp_nexthop_cache*bnc){if(LIST_EMPTY(&(bnc->paths))&&!bnc->nht_info){i
f(BGP_DEBUG(nht,NHT)){charbuf[PREFIX2STR_BUFFER];zlog_debug("bgp_unlink_nexthop:
freeingbnc%s",bnc_str(bnc,buf,PREFIX2STR_BUFFER));}unregister_zebra_rnh(bnc,CHEC
K_FLAG(bnc->flags,BGP_STATIC_ROUTE));bnc->node->info=NULL;bgp_unlock_node(bnc->n
ode);bnc->node=NULL;bnc_free(bnc);}}voidbgp_unlink_nexthop(structbgp_info*path){
structbgp_nexthop_cache*bnc=path->nexthop;if(!bnc)return;path_nh_map(path,NULL,0
);bgp_unlink_nexthop_check(bnc);}voidbgp_unlink_nexthop_by_peer(structpeer*peer)
{structprefixp;structbgp_node*rn;structbgp_nexthop_cache*bnc;afi_tafi=family2afi
(peer->su.sa.sa_family);if(!sockunion2hostprefix(&peer->su,&p))return;rn=bgp_nod
e_get(peer->bgp->nexthop_cache_table[afi],&p);if(!rn->info)return;bnc=rn->info;/
*cleanupthepeerreference*/bnc->nht_info=NULL;bgp_unlink_nexthop_check(bnc);}intb
gp_find_or_add_nexthop(structbgp*bgp,afi_tafi,structbgp_info*ri,structpeer*peer,
intconnected){structbgp_node*rn;structbgp_nexthop_cache*bnc;structprefixp;intis_
bgp_static_route=0;if(ri){is_bgp_static_route=((ri->type==ZEBRA_ROUTE_BGP)&&(ri-
>sub_type==BGP_ROUTE_STATIC))?1:0;/*SinceExtendedNext-hopEncoding(RFC5549)suppor
t,wewanttoderiveaddress-familyfromthenext-hop.*/if(!is_bgp_static_route)afi=BGP_
ATTR_NEXTHOP_AFI_IP6(ri->attr)?AFI_IP6:AFI_IP;/*ThiswillreturnTRUEiftheglobalIPv
6NHisalinklocal*addr*/if(make_prefix(afi,ri,&p)<0)return1;}elseif(peer){/*Don'tr
egisterlinklocalNH*/if(afi==AFI_IP6&&IN6_IS_ADDR_LINKLOCAL(&peer->su.sin6.sin6_a
ddr))return1;if(!sockunion2hostprefix(&peer->su,&p)){if(BGP_DEBUG(nht,NHT)){zlog
_debug("%s:AttemptingtoregisterwithunknownAFI%d(not%dor%d)",__FUNCTION__,afi,AFI
_IP,AFI_IP6);}return0;}}elsereturn0;if(is_bgp_static_route)rn=bgp_node_get(bgp->
import_check_table[afi],&p);elsern=bgp_node_get(bgp->nexthop_cache_table[afi],&p
);if(!rn->info){bnc=bnc_new();rn->info=bnc;bnc->node=rn;bnc->bgp=bgp;bgp_lock_no
de(rn);if(BGP_DEBUG(nht,NHT)){charbuf[PREFIX2STR_BUFFER];zlog_debug("Allocatedbn
c%speer%p",bnc_str(bnc,buf,PREFIX2STR_BUFFER),peer);}}bnc=rn->info;bgp_unlock_no
de(rn);if(is_bgp_static_route){SET_FLAG(bnc->flags,BGP_STATIC_ROUTE);/*Ifwe'reto
gglingthetype,re-register*/if((bgp_flag_check(bgp,BGP_FLAG_IMPORT_CHECK))&&!CHEC
K_FLAG(bnc->flags,BGP_STATIC_ROUTE_EXACT_MATCH)){SET_FLAG(bnc->flags,BGP_STATIC_
ROUTE_EXACT_MATCH);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_REGISTERED);UNSET_FLAG(bnc-
>flags,BGP_NEXTHOP_VALID);}elseif((!bgp_flag_check(bgp,BGP_FLAG_IMPORT_CHECK))&&
CHECK_FLAG(bnc->flags,BGP_STATIC_ROUTE_EXACT_MATCH)){UNSET_FLAG(bnc->flags,BGP_S
TATIC_ROUTE_EXACT_MATCH);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_REGISTERED);UNSET_FLA
G(bnc->flags,BGP_NEXTHOP_VALID);}}/*Whennexthopisalreadyknown,butnowrequires'con
nected'*resolution,*re-registerit.Thereversescenariowherethenexthopcurrently*req
uires*'connected'resolutiondoesnotneedare-register(i.e.,wetreat*'connected-requi
red'asanoverride)exceptinthescenariowhere*this*isactuallyacaseoftrackingapeerfor
connectivity(e.g.,after*disableconnected-check).*NOTE:Wedon'ttrackthenumberofpat
hsseparatelyfor'connected-*required'vs'connected-not-required'asthischangeisnota
common*scenario.*/elseif(connected&&!CHECK_FLAG(bnc->flags,BGP_NEXTHOP_CONNECTED
)){SET_FLAG(bnc->flags,BGP_NEXTHOP_CONNECTED);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_
REGISTERED);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_VALID);}elseif(peer&&!connected&&C
HECK_FLAG(bnc->flags,BGP_NEXTHOP_CONNECTED)){UNSET_FLAG(bnc->flags,BGP_NEXTHOP_C
ONNECTED);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_REGISTERED);UNSET_FLAG(bnc->flags,BG
P_NEXTHOP_VALID);}if(bgp->inst_type==BGP_INSTANCE_TYPE_VIEW){bnc->flags|=BGP_NEX
THOP_REGISTERED;bnc->flags|=BGP_NEXTHOP_VALID;}elseif(!CHECK_FLAG(bnc->flags,BGP
_NEXTHOP_REGISTERED))register_zebra_rnh(bnc,is_bgp_static_route);if(ri&&ri->next
hop!=bnc){/*Unlinkfromexistingnexthopcache,ifany.Thiswillalso*free*thenexthopcac
heentry,ifappropriate.*/bgp_unlink_nexthop(ri);path_nh_map(ri,bnc,1);/*updatesNH
Trilistreference*/if(CHECK_FLAG(bnc->flags,BGP_NEXTHOP_VALID)&&bnc->metric)(bgp_
info_extra_get(ri))->igpmetric=bnc->metric;elseif(ri->extra)ri->extra->igpmetric
=0;}elseif(peer)bnc->nht_info=(void*)peer;/*NHTpeerreference*//**Wearecheatinghe
re.Viewshavenoassociatedunderlying*abilitytodetectnexthops.Sowhenwehaveaview*jus
ttelleveryonethenexthopisvalid*/if(bgp->inst_type==BGP_INSTANCE_TYPE_VIEW)return
1;elsereturn(bgp_isvalid_nexthop(bnc));}voidbgp_delete_connected_nexthop(afi_taf
i,structpeer*peer){structbgp_node*rn;structbgp_nexthop_cache*bnc;structprefixp;i
f(!peer)return;/*Wedon'tregisterlinklocaladdressforNHT*/if(afi==AFI_IP6&&IN6_IS_
ADDR_LINKLOCAL(&peer->su.sin6.sin6_addr))return;if(!sockunion2hostprefix(&peer->
su,&p))return;rn=bgp_node_lookup(peer->bgp->nexthop_cache_table[family2afi(p.fam
ily)],&p);if(!rn||!rn->info){if(BGP_DEBUG(nht,NHT))zlog_debug("Cannotfindconnect
edNHTnodeforpeer%s",peer->host);if(rn)bgp_unlock_node(rn);return;}bnc=rn->info;b
gp_unlock_node(rn);if(bnc->nht_info!=peer){if(BGP_DEBUG(nht,NHT))zlog_debug("Con
nectedNHT%pnodeforpeer%spointsto%p",bnc,peer->host,bnc->nht_info);return;}bnc->n
ht_info=NULL;if(LIST_EMPTY(&(bnc->paths))){if(BGP_DEBUG(nht,NHT))zlog_debug("Fre
eingconnectedNHTnode%pforpeer%s",bnc,peer->host);unregister_zebra_rnh(bnc,0);bnc
->node->info=NULL;bgp_unlock_node(bnc->node);bnc_free(bnc);}}voidbgp_parse_nexth
op_update(intcommand,vrf_id_tvrf_id){structbgp_node*rn=NULL;structbgp_nexthop_ca
che*bnc;structnexthop*nexthop;structnexthop*oldnh;structnexthop*nhlist_head=NULL
;structnexthop*nhlist_tail=NULL;inti;structbgp*bgp;structzapi_routenhr;bgp=bgp_l
ookup_by_vrf_id(vrf_id);if(!bgp){zlog_err("parsenexthopupdate:instancenotfoundfo
rvrf_id%u",vrf_id);return;}if(!zapi_nexthop_update_decode(zclient->ibuf,&nhr)){i
f(BGP_DEBUG(nht,NHT))zlog_debug("%s:Failuretodecodenexthopupdate",__PRETTY_FUNCT
ION__);return;}if(command==ZEBRA_NEXTHOP_UPDATE)rn=bgp_node_lookup(bgp->nexthop_
cache_table[family2afi(nhr.prefix.family)],&nhr.prefix);elseif(command==ZEBRA_IM
PORT_CHECK_UPDATE)rn=bgp_node_lookup(bgp->import_check_table[family2afi(nhr.pref
ix.family)],&nhr.prefix);if(!rn||!rn->info){if(BGP_DEBUG(nht,NHT)){charbuf[PREFI
X2STR_BUFFER];prefix2str(&nhr.prefix,buf,sizeof(buf));zlog_debug("parsenexthopup
date(%s):rnnotfound",buf);}if(rn)bgp_unlock_node(rn);return;}bnc=rn->info;bgp_un
lock_node(rn);bnc->last_update=bgp_clock();bnc->change_flags=0;/*debugprintthein
put*/if(BGP_DEBUG(nht,NHT)){charbuf[PREFIX2STR_BUFFER];prefix2str(&nhr.prefix,bu
f,sizeof(buf));zlog_debug("%u:RcvdNHupdate%s-metric%d/%d#nhops%d/%dflags0x%x",vr
f_id,buf,nhr.metric,bnc->metric,nhr.nexthop_num,bnc->nexthop_num,bnc->flags);}if
(nhr.metric!=bnc->metric)bnc->change_flags|=BGP_NEXTHOP_METRIC_CHANGED;if(nhr.ne
xthop_num!=bnc->nexthop_num)bnc->change_flags|=BGP_NEXTHOP_CHANGED;if(nhr.nextho
p_num){/*notifybgpfsmifnbripgoesfrominvalid->valid*/if(!bnc->nexthop_num)UNSET_F
LAG(bnc->flags,BGP_NEXTHOP_PEER_NOTIFIED);bnc->flags|=BGP_NEXTHOP_VALID;bnc->met
ric=nhr.metric;bnc->nexthop_num=nhr.nexthop_num;for(i=0;i<nhr.nexthop_num;i++){n
exthop=nexthop_from_zapi_nexthop(&nhr.nexthops[i]);if(BGP_DEBUG(nht,NHT)){charbu
f[NEXTHOP_STRLEN];zlog_debug("nhopvia%s",nexthop2str(nexthop,buf,sizeof(buf)));}
if(nhlist_tail){nhlist_tail->next=nexthop;nhlist_tail=nexthop;}else{nhlist_tail=
nexthop;nhlist_head=nexthop;}/*Noneedtoevaluatethenexthopifwehavealready*determi
ned*thattherehasbeenachange.*/if(bnc->change_flags&BGP_NEXTHOP_CHANGED)continue;
for(oldnh=bnc->nexthop;oldnh;oldnh=oldnh->next)if(nexthop_same_no_recurse(oldnh,
nexthop))break;if(!oldnh)bnc->change_flags|=BGP_NEXTHOP_CHANGED;}bnc_nexthop_fre
e(bnc);bnc->nexthop=nhlist_head;}else{bnc->flags&=~BGP_NEXTHOP_VALID;bnc->nextho
p_num=nhr.nexthop_num;/*notifybgpfsmifnbripgoesfromvalid->invalid*/UNSET_FLAG(bn
c->flags,BGP_NEXTHOP_PEER_NOTIFIED);bnc_nexthop_free(bnc);bnc->nexthop=NULL;}eva
luate_paths(bnc);}/**CleanupnexthopregistrationandstatusinformationforBGPnexthop
s*pertainingtothisVRF.ThisisinvokeduponVRFdeletion.*/voidbgp_cleanup_nexthops(st
ructbgp*bgp){afi_tafi;structbgp_node*rn;structbgp_nexthop_cache*bnc;for(afi=AFI_
IP;afi<AFI_MAX;afi++){if(!bgp->nexthop_cache_table[afi])continue;for(rn=bgp_tabl
e_top(bgp->nexthop_cache_table[afi]);rn;rn=bgp_route_next(rn)){bnc=rn->info;if(!
bnc)continue;/*Clearrelevantflags.*/UNSET_FLAG(bnc->flags,BGP_NEXTHOP_VALID);UNS
ET_FLAG(bnc->flags,BGP_NEXTHOP_REGISTERED);UNSET_FLAG(bnc->flags,BGP_NEXTHOP_PEE
R_NOTIFIED);}}}/***make_prefix-makeaprefixstructurefromthepath(essentially*path'
snode.*/staticintmake_prefix(intafi,structbgp_info*ri,structprefix*p){intis_bgp_
static=((ri->type==ZEBRA_ROUTE_BGP)&&(ri->sub_type==BGP_ROUTE_STATIC))?1:0;memse
t(p,0,sizeof(structprefix));switch(afi){caseAFI_IP:p->family=AF_INET;if(is_bgp_s
tatic){p->u.prefix4=ri->net->p.u.prefix4;p->prefixlen=ri->net->p.prefixlen;}else
{p->u.prefix4=ri->attr->nexthop;p->prefixlen=IPV4_MAX_BITLEN;}break;caseAFI_IP6:
/*Wedon'tregisterlinklocalNH*/if(ri->attr->mp_nexthop_len!=BGP_ATTR_NHLEN_IPV6_G
LOBAL||IN6_IS_ADDR_LINKLOCAL(&ri->attr->mp_nexthop_global))return-1;p->family=AF
_INET6;if(is_bgp_static){p->u.prefix6=ri->net->p.u.prefix6;p->prefixlen=ri->net-
>p.prefixlen;}else{p->u.prefix6=ri->attr->mp_nexthop_global;p->prefixlen=IPV6_MA
X_BITLEN;}break;default:if(BGP_DEBUG(nht,NHT)){zlog_debug("%s:Attemptingtomakepr
efixwithunknownAFI%d(not%dor%d)",__FUNCTION__,afi,AFI_IP,AFI_IP6);}break;}return
0;}/***sendmsg_zebra_rnh--Formatandsendanexthopregister/Unregister*commandtoZebr
a.*ARGUMENTS:*structbgp_nexthop_cache*bnc--thenexthopstructure.*intcommand--comm
andtosendtozebra*RETURNS:*void.*/staticvoidsendmsg_zebra_rnh(structbgp_nexthop_c
ache*bnc,intcommand){structprefix*p;boolexact_match=false;intret;if(!zclient)ret
urn;/*Don'ttrytoregisterifZebradoesn'tknowofthisinstance.*/if(!IS_BGP_INST_KNOWN
_TO_ZEBRA(bnc->bgp))return;p=&(bnc->node->p);if((command==ZEBRA_NEXTHOP_REGISTER
||command==ZEBRA_IMPORT_ROUTE_REGISTER)&&(CHECK_FLAG(bnc->flags,BGP_NEXTHOP_CONN
ECTED)||CHECK_FLAG(bnc->flags,BGP_STATIC_ROUTE_EXACT_MATCH)))exact_match=true;re
t=zclient_send_rnh(zclient,command,p,exact_match,bnc->bgp->vrf_id);/*TBD:handlet
hefailure*/if(ret<0)zlog_warn("sendmsg_nexthop:zclient_send_message()failed");if
((command==ZEBRA_NEXTHOP_REGISTER)||(command==ZEBRA_IMPORT_ROUTE_REGISTER))SET_F
LAG(bnc->flags,BGP_NEXTHOP_REGISTERED);elseif((command==ZEBRA_NEXTHOP_UNREGISTER
)||(command==ZEBRA_IMPORT_ROUTE_UNREGISTER))UNSET_FLAG(bnc->flags,BGP_NEXTHOP_RE
GISTERED);return;}/***register_zebra_rnh-registeraNH/routewithZebrafornotificati
on*whentherouteortheroutetothenexthopchanges.*ARGUMENTS:*structbgp_nexthop_cache
*bnc*RETURNS:*void.*/staticvoidregister_zebra_rnh(structbgp_nexthop_cache*bnc,in
tis_bgp_import_route){/*Checkifwehavealreadyregistered*/if(bnc->flags&BGP_NEXTHO
P_REGISTERED)return;if(is_bgp_import_route)sendmsg_zebra_rnh(bnc,ZEBRA_IMPORT_RO
UTE_REGISTER);elsesendmsg_zebra_rnh(bnc,ZEBRA_NEXTHOP_REGISTER);}/***unregister_
zebra_rnh--Unregistertheroute/nexthopfromZebra.*ARGUMENTS:*structbgp_nexthop_cac
he*bnc*RETURNS:*void.*/staticvoidunregister_zebra_rnh(structbgp_nexthop_cache*bn
c,intis_bgp_import_route){/*Checkifwehavealreadyregistered*/if(!CHECK_FLAG(bnc->
flags,BGP_NEXTHOP_REGISTERED))return;if(is_bgp_import_route)sendmsg_zebra_rnh(bn
c,ZEBRA_IMPORT_ROUTE_UNREGISTER);elsesendmsg_zebra_rnh(bnc,ZEBRA_NEXTHOP_UNREGIS
TER);}/***evaluate_paths-Evaluatethepaths/netsassociatedwithanexthop.*ARGUMENTS:
*structbgp_nexthop_cache*bnc--thenexthopstructure.*RETURNS:*void.*/staticvoideva
luate_paths(structbgp_nexthop_cache*bnc){structbgp_node*rn;structbgp_info*path;s
tructbgp*bgp=bnc->bgp;intafi;structpeer*peer=(structpeer*)bnc->nht_info;structbg
p_table*table;safi_tsafi;if(BGP_DEBUG(nht,NHT)){charbuf[PREFIX2STR_BUFFER];bnc_s
tr(bnc,buf,PREFIX2STR_BUFFER);zlog_debug("NHupdatefor%s-flags0x%xchgflags0x%x-ev
aluatepaths",buf,bnc->flags,bnc->change_flags);}LIST_FOREACH(path,&(bnc->paths),
nh_thread){if(!(path->type==ZEBRA_ROUTE_BGP&&((path->sub_type==BGP_ROUTE_NORMAL)
||(path->sub_type==BGP_ROUTE_STATIC))))continue;rn=path->net;assert(rn&&bgp_node
_table(rn));afi=family2afi(rn->p.family);table=bgp_node_table(rn);safi=table->sa
fi;/*Pathbecomesvalid/invaliddependingonwhetherthenexthop*reachable/unreachable.
*/if((CHECK_FLAG(path->flags,BGP_INFO_VALID)?1:0)!=(bgp_isvalid_nexthop(bnc)?1:0
)){if(CHECK_FLAG(path->flags,BGP_INFO_VALID)){bgp_aggregate_decrement(bgp,&rn->p
,path,afi,safi);bgp_info_unset_flag(rn,path,BGP_INFO_VALID);}else{bgp_info_set_f
lag(rn,path,BGP_INFO_VALID);bgp_aggregate_increment(bgp,&rn->p,path,afi,safi);}}
/*Copythemetrictothepath.Willbeusedforbestpath*computation*/if(bgp_isvalid_nexth
op(bnc)&&bnc->metric)(bgp_info_extra_get(path))->igpmetric=bnc->metric;elseif(pa
th->extra)path->extra->igpmetric=0;if(CHECK_FLAG(bnc->change_flags,BGP_NEXTHOP_M
ETRIC_CHANGED)||CHECK_FLAG(bnc->change_flags,BGP_NEXTHOP_CHANGED))SET_FLAG(path-
>flags,BGP_INFO_IGP_CHANGED);bgp_process(bgp,rn,afi,safi);}if(peer&&!CHECK_FLAG(
bnc->flags,BGP_NEXTHOP_PEER_NOTIFIED)){if(BGP_DEBUG(nht,NHT))zlog_debug("%s:Upda
tingpeer(%s)statuswithNHT",__FUNCTION__,peer->host);bgp_fsm_nht_update(peer,bgp_
isvalid_nexthop(bnc));SET_FLAG(bnc->flags,BGP_NEXTHOP_PEER_NOTIFIED);}RESET_FLAG
(bnc->change_flags);}/***path_nh_map-makeorbreakpath-to-nexthopassociation.*ARGU
MENTS:*path-pointertothepathstructure*bnc-pointertothenexthopstructure*make-ifse
t,maketheassociation.ifunset,justbreaktheexisting*association.*/staticvoidpath_n
h_map(structbgp_info*path,structbgp_nexthop_cache*bnc,intmake){if(path->nexthop)
{LIST_REMOVE(path,nh_thread);path->nexthop->path_count--;path->nexthop=NULL;}if(
make){LIST_INSERT_HEAD(&(bnc->paths),path,nh_thread);path->nexthop=bnc;path->nex
thop->path_count++;}}