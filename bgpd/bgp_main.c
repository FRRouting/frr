/*Mainroutineofbgpd.*Copyright(C)1996,97,98,1999KunihiroIshiguro**Thisfileispart
ofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthet
ermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherve
rsion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwi
llbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILIT
YorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Y
oushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seeth
efileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloo
r,Boston,MA02110-1301USA*/#include<zebra.h>#include<pthread.h>#include"vector.h"
#include"command.h"#include"getopt.h"#include"thread.h"#include<lib/version.h>#i
nclude"memory.h"#include"memory_vty.h"#include"prefix.h"#include"log.h"#include"
privs.h"#include"sigevent.h"#include"zclient.h"#include"routemap.h"#include"filt
er.h"#include"plist.h"#include"stream.h"#include"queue.h"#include"vrf.h"#include
"bfd.h"#include"libfrr.h"#include"ns.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_at
tr.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_mplsvpn.h"#include"bgpd/bgp_asp
ath.h"#include"bgpd/bgp_dump.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_nexth
op.h"#include"bgpd/bgp_regex.h"#include"bgpd/bgp_clist.h"#include"bgpd/bgp_debug
.h"#include"bgpd/bgp_filter.h"#include"bgpd/bgp_zebra.h"#include"bgpd/bgp_packet
.h"#include"bgpd/bgp_keepalives.h"#include"bgpd/bgp_network.h"#ifdefENABLE_BGP_V
NC#include"bgpd/rfapi/rfapi_backend.h"#endif/*bgpdoptions,weuseGNUgetoptlibrary.
*/staticconststructoptionlongopts[]={{"bgp_port",required_argument,NULL,'p'},{"l
istenon",required_argument,NULL,'l'},{"retain",no_argument,NULL,'r'},{"no_kernel
",no_argument,NULL,'n'},{"skip_runas",no_argument,NULL,'S'},{"ecmp",required_arg
ument,NULL,'e'},{0}};/*signaldefinitions*/voidsighup(void);voidsigint(void);void
sigusr1(void);staticvoidbgp_exit(int);staticvoidbgp_vrf_terminate(void);staticst
ructquagga_signal_tbgp_signals[]={{.signal=SIGHUP,.handler=&sighup,},{.signal=SI
GUSR1,.handler=&sigusr1,},{.signal=SIGINT,.handler=&sigint,},{.signal=SIGTERM,.h
andler=&sigint,},};/*Routeretainmodeflag.*/staticintretain_mode=0;/*privileges*/
staticzebra_capabilities_t_caps_p[]={ZCAP_BIND,ZCAP_NET_RAW,ZCAP_NET_ADMIN,ZCAP_
SYS_ADMIN};structzebra_privs_tbgpd_privs={#ifdefined(FRR_USER)&&defined(FRR_GROU
P).user=FRR_USER,.group=FRR_GROUP,#endif#ifdefVTY_GROUP.vty_group=VTY_GROUP,#end
if.caps_p=_caps_p,.cap_num_p=array_size(_caps_p),.cap_num_i=0,};staticstructfrr_
daemon_infobgpd_di;/*SIGHUPhandler.*/voidsighup(void){zlog_info("SIGHUPreceived"
);/*Terminateallthread.*/bgp_terminate();bgp_reset();zlog_info("bgpdrestarting!"
);/*Reloadconfigfile.*/vty_read_config(bgpd_di.config_file,config_default);/*Try
toreturntonormaloperation.*/}/*SIGINThandler.*/__attribute__((__noreturn__))void
sigint(void){zlog_notice("Terminatingonsignal");if(!retain_mode)bgp_terminate();
bgp_exit(0);exit(0);}/*SIGUSR1handler.*/voidsigusr1(void){zlog_rotate();}/*Tryto
freeupallocationsweknowaboutsothatdiagnostictoolssuchasvalgrindareabletobetteril
luminateleaks.Zebrarouteremovalandprotocolteardownarenotmeanttobedonehere.Forexa
mple,"retain_mode"maybeset.*/static__attribute__((__noreturn__))voidbgp_exit(int
status){structbgp*bgp;structlistnode*node,*nnode;/*itonlymakessenseforthistobeca
lledonacleanexit*/assert(status==0);frr_early_fini();bfd_gbl_exit();bgp_close();
/*reversebgp_master_init*/for(ALL_LIST_ELEMENTS(bm->bgp,node,nnode,bgp))bgp_dele
te(bgp);/*reversebgp_dump_init*/bgp_dump_finish();/*reversebgp_route_init*/bgp_r
oute_finish();/*cleanuproutemaps*/bgp_route_map_terminate();/*reversebgp_attr_in
it*/bgp_attr_finish();/*stoppthreads*/bgp_pthreads_finish();/*reverseaccess_list
_init*/access_list_add_hook(NULL);access_list_delete_hook(NULL);access_list_rese
t();/*reversebgp_filter_init*/as_list_add_hook(NULL);as_list_delete_hook(NULL);b
gp_filter_reset();/*reverseprefix_list_init*/prefix_list_add_hook(NULL);prefix_l
ist_delete_hook(NULL);prefix_list_reset();/*reversecommunity_list_init*/communit
y_list_terminate(bgp_clist);bgp_vrf_terminate();#ifENABLE_BGP_VNCvnc_zebra_destr
oy();#endifbgp_zebra_destroy();bf_free(bm->rd_idspace);list_delete_and_null(&bm-
>bgp);memset(bm,0,sizeof(*bm));frr_fini();exit(status);}staticintbgp_vrf_new(str
uctvrf*vrf){if(BGP_DEBUG(zebra,ZEBRA))zlog_debug("VRFCreated:%s(%u)",vrf->name,v
rf->vrf_id);return0;}staticintbgp_vrf_delete(structvrf*vrf){if(BGP_DEBUG(zebra,Z
EBRA))zlog_debug("VRFDeletion:%s(%u)",vrf->name,vrf->vrf_id);return0;}staticintb
gp_vrf_enable(structvrf*vrf){structbgp*bgp;vrf_id_told_vrf_id;if(BGP_DEBUG(zebra
,ZEBRA))zlog_debug("VRFenableadd%sid%u",vrf->name,vrf->vrf_id);bgp=bgp_lookup_by
_name(vrf->name);if(bgp){old_vrf_id=bgp->vrf_id;/*Wehaveinstanceconfigured,linkt
oVRFandmakeit"up".*/bgp_vrf_link(bgp,vrf);bgp_handle_socket(bgp,vrf,old_vrf_id,t
rue);/*Updateanyredistributevrfbitmapsifthevrf_idchanged*/if(old_vrf_id!=bgp->vr
f_id)bgp_update_redist_vrf_bitmaps(bgp,old_vrf_id);bgp_instance_up(bgp);vpn_leak
_zebra_vrf_label_update(bgp,AFI_IP);vpn_leak_zebra_vrf_label_update(bgp,AFI_IP6)
;}return0;}staticintbgp_vrf_disable(structvrf*vrf){structbgp*bgp;vrf_id_told_vrf
_id;if(vrf->vrf_id==VRF_DEFAULT)return0;if(BGP_DEBUG(zebra,ZEBRA))zlog_debug("VR
Fdisable%sid%d",vrf->name,vrf->vrf_id);bgp=bgp_lookup_by_name(vrf->name);if(bgp)
{vpn_leak_zebra_vrf_label_withdraw(bgp,AFI_IP);vpn_leak_zebra_vrf_label_withdraw
(bgp,AFI_IP6);old_vrf_id=bgp->vrf_id;bgp_handle_socket(bgp,vrf,VRF_UNKNOWN,false
);/*Wehaveinstanceconfigured,unlinkfromVRFandmakeit*"down".*/bgp_vrf_unlink(bgp,
vrf);/*Updateanyredistributevrfbitmapsifthevrf_idchanged*/if(old_vrf_id!=bgp->vr
f_id)bgp_update_redist_vrf_bitmaps(bgp,old_vrf_id);bgp_instance_down(bgp);}/*Not
e:Thisisacallback,theVRFwillbedeletedbythecaller.*/return0;}staticvoidbgp_vrf_in
it(void){vrf_init(bgp_vrf_new,bgp_vrf_enable,bgp_vrf_disable,bgp_vrf_delete);}st
aticvoidbgp_vrf_terminate(void){vrf_terminate();}FRR_DAEMON_INFO(bgpd,BGP,.vty_p
ort=BGP_VTY_PORT,.proghelp="ImplementationoftheBGProutingprotocol.",.signals=bgp
_signals,.n_signals=array_size(bgp_signals),.privs=&bgpd_privs,)/*Mainroutineofb
gpd.Treatmentofargumentandstartbgpfinitestatemachineishandledathere.*/intmain(in
targc,char**argv){intopt;inttmp_port;intbgp_port=BGP_PORT_DEFAULT;char*bgp_addre
ss=NULL;intno_fib_flag=0;intskip_runas=0;frr_preinit(&bgpd_di,argc,argv);frr_opt
_add("p:l:rSne:",longopts,"-p,--bgp_portSetbgpprotocol'sportnumber\n""-l,--liste
nonListenonspecifiedaddress(implies-n)\n""-r,--retainWhenprogramterminates,retai
naddedroutebybgpd.\n""-n,--no_kernelDonotinstallroutetokernel.\n""-S,--skip_runa
sSkipcapabilitieschecks,andchanginguserandgroupIDs.\n""-e,--ecmpSpecifyECMPtouse
.\n");/*Commandlineargumenttreatment.*/while(1){opt=frr_getopt(argc,argv,0);if(o
pt==EOF)break;switch(opt){case0:break;case'p':tmp_port=atoi(optarg);if(tmp_port<
=0||tmp_port>0xffff)bgp_port=BGP_PORT_DEFAULT;elsebgp_port=tmp_port;break;case'e
':multipath_num=atoi(optarg);if(multipath_num>MULTIPATH_NUM||multipath_num<=0){z
log_err("MultipathNumberspecifiedmustbelessthan%dandgreaterthan0",MULTIPATH_NUM)
;return1;}break;case'r':retain_mode=1;break;case'l':bgp_address=optarg;/*listeno
nimplies-n*//*fallthru*/case'n':no_fib_flag=1;break;case'S':skip_runas=1;break;d
efault:frr_help_exit(1);break;}}if(skip_runas)memset(&bgpd_privs,0,sizeof(bgpd_p
rivs));/*BGPmasterinit.*/bgp_master_init(frr_init());bm->port=bgp_port;bm->addre
ss=bgp_address;if(no_fib_flag)bgp_option_set(BGP_OPT_NO_FIB);/*Initializations.*
/bgp_vrf_init();/*BGPrelatedinitialization.*/bgp_init();snprintf(bgpd_di.startin
fo,sizeof(bgpd_di.startinfo),",bgp@%s:%d",(bm->address?bm->address:"<all>"),bm->
port);frr_config_fork();/*mustbecalledafterfork()*/bgp_pthreads_run();frr_run(bm
->master);/*Notreached.*/return(0);}