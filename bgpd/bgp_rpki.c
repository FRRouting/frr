/**BGPRPKI*Copyright(C)2013MichaelMester(m.mester@fu-berlin.de),forFUBerlin*Copy
right(C)2014-2017AndreasReuter(andreas.reuter@fu-berlin.de),forFU*Berlin*Copyrig
ht(C)2016-2017ColinSames(colin.sames@haw-hamburg.de),forHAW*Hamburg*Copyright(C)
2017MarcelRÃ¶thke(marcel.roethke@haw-hamburg.de),forHAW*Hamburg**Thisfileispartof
FRRouting.**Thisprogramisfreesoftware;youcanredistributeitand/ormodifyit*underth
etermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*SoftwareFoundation;either
version2oftheLicense,or(atyouroption)*anylaterversion.**Thisprogramisdistributed
inthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarranty
ofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefo
r*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*with
thisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Fra
nklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<pthread.h>#
include<time.h>#include<stdbool.h>#include<stdlib.h>#include"prefix.h"#include"l
og.h"#include"command.h"#include"linklist.h"#include"memory.h"#include"thread.h"
#include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgp_ad
vertise.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_a
spath.h"#include"bgpd/bgp_route.h"#include"rtrlib/rtrlib.h"#include"rtrlib/rtr_m
gr.h"#include"rtrlib/lib/ip.h"#include"rtrlib/transport/tcp/tcp_transport.h"#ifd
efined(FOUND_SSH)#include"rtrlib/transport/ssh/ssh_transport.h"#endif#include"ho
ok.h"#include"libfrr.h"#include"version.h"#ifndefVTYSH_EXTRACT_PL#include"bgpd/b
gp_rpki_clippy.c"#endifDEFINE_MTYPE_STATIC(BGPD,BGP_RPKI_CACHE,"BGPRPKICacheserv
er")DEFINE_MTYPE_STATIC(BGPD,BGP_RPKI_CACHE_GROUP,"BGPRPKICacheservergroup")#def
ineRPKI_VALID1#defineRPKI_NOTFOUND2#defineRPKI_INVALID3#definePOLLING_PERIOD_DEF
AULT3600#defineEXPIRE_INTERVAL_DEFAULT7200#defineRETRY_INTERVAL_DEFAULT600#defin
eTIMEOUT_DEFAULT600#defineINITIAL_SYNCHRONISATION_TIMEOUT_DEFAULT30#defineRPKI_D
EBUG(...)\if(rpki_debug){\zlog_debug("RPKI:"__VA_ARGS__);\}#defineRPKI_OUTPUT_ST
RING"Controlrpkispecificsettings\n"structcache{enum{TCP,SSH}type;structtr_socket
*tr_socket;union{structtr_tcp_config*tcp_config;structtr_ssh_config*ssh_config;}
tr_config;structrtr_socket*rtr_socket;uint8_tpreference;};enumreturn_values{SUCC
ESS=0,ERROR=-1};structrpki_for_each_record_arg{structvty*vty;unsignedint*prefix_
amount;};staticintstart(void);staticvoidstop(void);staticintreset(boolforce);sta
ticstructrtr_mgr_group*get_connected_group(void);staticvoidprint_prefix_table(st
ructvty*vty);staticvoidinstall_cli_commands(void);staticintconfig_write(structvt
y*vty);staticvoidoverwrite_exit_commands(void);staticvoidfree_cache(structcache*
cache);staticstructrtr_mgr_group*get_groups(void);#ifdefined(FOUND_SSH)staticint
add_ssh_cache(constchar*host,constunsignedintport,constchar*username,constchar*c
lient_privkey_path,constchar*client_pubkey_path,constchar*server_pubkey_path,con
stuint8_tpreference);#endifstaticstructrtr_socket*create_rtr_socket(structtr_soc
ket*tr_socket);staticstructcache*find_cache(constuint8_tpreference);staticintadd
_tcp_cache(constchar*host,constchar*port,constuint8_tpreference);staticvoidprint
_record(conststructpfx_record*record,void*data);staticintis_synchronized(void);s
taticintis_running(void);staticvoidroute_match_free(void*rule);staticroute_map_r
esult_troute_match(void*rule,structprefix*prefix,route_map_object_ttype,void*obj
ect);staticvoid*route_match_compile(constchar*arg);staticstructrtr_mgr_config*rt
r_config;staticstructlist*cache_list;staticintrtr_is_running;staticintrpki_debug
;staticunsignedintpolling_period;staticunsignedintexpire_interval;staticunsigned
intretry_interval;staticunsignedinttimeout;staticunsignedintinitial_synchronisat
ion_timeout;staticstructcmd_noderpki_node={RPKI_NODE,"%s(config-rpki)#",1};stati
cstructroute_map_rule_cmdroute_match_rpki_cmd={"rpki",route_match,route_match_co
mpile,route_match_free};staticvoid*malloc_wrapper(size_tsize){returnXMALLOC(MTYP
E_BGP_RPKI_CACHE,size);}staticvoid*realloc_wrapper(void*ptr,size_tsize){returnXR
EALLOC(MTYPE_BGP_RPKI_CACHE,ptr,size);}staticvoidfree_wrapper(void*ptr){XFREE(MT
YPE_BGP_RPKI_CACHE,ptr);}staticintrpki_validate_prefix(structpeer*peer,structatt
r*attr,structprefix*prefix);staticroute_map_result_troute_match(void*rule,struct
prefix*prefix,route_map_object_ttype,void*object){int*rpki_status=rule;structbgp
_info*bgp_info;if(type==RMAP_BGP){bgp_info=object;if(rpki_validate_prefix(bgp_in
fo->peer,bgp_info->attr,prefix)==*rpki_status){returnRMAP_MATCH;}}returnRMAP_NOM
ATCH;}staticvoid*route_match_compile(constchar*arg){int*rpki_status;rpki_status=
XMALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(uint8_t));if(strcmp(arg,"valid")==0)*rpk
i_status=RPKI_VALID;elseif(strcmp(arg,"invalid")==0)*rpki_status=RPKI_INVALID;el
se*rpki_status=RPKI_NOTFOUND;returnrpki_status;}staticvoidroute_match_free(void*
rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}staticstructrtr_socket*create_rtr_so
cket(structtr_socket*tr_socket){structrtr_socket*rtr_socket=XMALLOC(MTYPE_BGP_RP
KI_CACHE,sizeof(structrtr_socket));rtr_socket->tr_socket=tr_socket;returnrtr_soc
ket;}staticstructcache*find_cache(constuint8_tpreference){structlistnode*cache_n
ode;structcache*cache;for(ALL_LIST_ELEMENTS_RO(cache_list,cache_node,cache)){if(
cache->preference==preference)returncache;}returnNULL;}staticvoidprint_record(co
nststructpfx_record*record,void*data){charip[INET6_ADDRSTRLEN];structrpki_for_ea
ch_record_arg*arg=data;structvty*vty=arg->vty;(*arg->prefix_amount)++;lrtr_ip_ad
dr_to_str(&record->prefix,ip,sizeof(ip));vty_out(vty,"%-40s%3u-%3u%10u\n",ip,rec
ord->min_len,record->max_len,record->asn);}staticstructrtr_mgr_group*get_groups(
void){structlistnode*cache_node;structrtr_mgr_group*rtr_mgr_groups;structcache*c
ache;intgroup_count=listcount(cache_list);if(group_count==0)returnNULL;rtr_mgr_g
roups=XMALLOC(MTYPE_BGP_RPKI_CACHE_GROUP,group_count*sizeof(structrtr_mgr_group)
);size_ti=0;for(ALL_LIST_ELEMENTS_RO(cache_list,cache_node,cache)){rtr_mgr_group
s[i].sockets=&cache->rtr_socket;rtr_mgr_groups[i].sockets_len=1;rtr_mgr_groups[i
].preference=cache->preference;if(cache->type==TCP)tr_tcp_init(cache->tr_config.
tcp_config,cache->tr_socket);#ifdefined(FOUND_SSH)elsetr_ssh_init(cache->tr_conf
ig.ssh_config,cache->tr_socket);#endifi++;}returnrtr_mgr_groups;}inlineintis_syn
chronized(void){returnrtr_is_running&&rtr_mgr_conf_in_sync(rtr_config);}inlinein
tis_running(void){returnrtr_is_running;}staticintbgp_rpki_init(structthread_mast
er*master){rpki_debug=0;rtr_is_running=0;cache_list=list_new();cache_list->del=(
void(*)(void*))&free_cache;polling_period=POLLING_PERIOD_DEFAULT;expire_interval
=EXPIRE_INTERVAL_DEFAULT;retry_interval=RETRY_INTERVAL_DEFAULT;timeout=TIMEOUT_D
EFAULT;initial_synchronisation_timeout=INITIAL_SYNCHRONISATION_TIMEOUT_DEFAULT;i
nstall_cli_commands();return0;}staticintbgp_rpki_fini(void){stop();list_delete_a
nd_null(&cache_list);return0;}staticintbgp_rpki_module_init(void){lrtr_set_alloc
_functions(malloc_wrapper,realloc_wrapper,free_wrapper);hook_register(frr_late_i
nit,bgp_rpki_init);hook_register(frr_early_fini,&bgp_rpki_fini);return0;}statici
ntstart(void){unsignedintwaiting_time=0;intret;if(list_isempty(cache_list)){RPKI
_DEBUG("Nocacheswerefoundinconfig.Prefixvalidationisoff.");returnERROR;}RPKI_DEB
UG("Initrtr_mgr.");intgroups_len=listcount(cache_list);structrtr_mgr_group*group
s=get_groups();ret=rtr_mgr_init(&rtr_config,groups,groups_len,polling_period,exp
ire_interval,retry_interval,NULL,NULL,NULL,NULL);if(ret==RTR_ERROR){RPKI_DEBUG("
Initrtr_mgrfailed.");returnERROR;}RPKI_DEBUG("Startingrtr_mgr.");ret=rtr_mgr_sta
rt(rtr_config);if(ret==RTR_ERROR){RPKI_DEBUG("Startingrtr_mgrfailed.");rtr_mgr_f
ree(rtr_config);returnERROR;}rtr_is_running=1;RPKI_DEBUG("Waitingforrtrconnectio
ntosynchronize.");while(waiting_time++<=initial_synchronisation_timeout){if(rtr_
mgr_conf_in_sync(rtr_config))break;sleep(1);}if(rtr_mgr_conf_in_sync(rtr_config)
){RPKI_DEBUG("GotsynchronisationwithatleastoneRPKIcache!");}else{RPKI_DEBUG("Tim
eoutexpired!ProceedingwithoutRPKIvalidationdata.");}XFREE(MTYPE_BGP_RPKI_CACHE_G
ROUP,groups);returnSUCCESS;}staticvoidstop(void){if(rtr_is_running){rtr_mgr_stop
(rtr_config);rtr_mgr_free(rtr_config);rtr_is_running=0;}}staticintreset(boolforc
e){if(rtr_is_running&&!force)returnSUCCESS;RPKI_DEBUG("ResettingRPKISession");st
op();returnstart();}staticstructrtr_mgr_group*get_connected_group(void){if(list_
isempty(cache_list))returnNULL;returnrtr_mgr_get_first_group(rtr_config);}static
voidprint_prefix_table(structvty*vty){structrpki_for_each_record_argarg;unsigned
intnumber_of_ipv4_prefixes=0;unsignedintnumber_of_ipv6_prefixes=0;structrtr_mgr_
group*group=get_connected_group();arg.vty=vty;if(!group)return;structpfx_table*p
fx_table=group->sockets[0]->pfx_table;vty_out(vty,"RPKI/RTRprefixtable\n");vty_o
ut(vty,"%-40s%s%s\n","Prefix","PrefixLength","Origin-AS");arg.prefix_amount=&num
ber_of_ipv4_prefixes;pfx_table_for_each_ipv4_record(pfx_table,print_record,&arg)
;arg.prefix_amount=&number_of_ipv6_prefixes;pfx_table_for_each_ipv6_record(pfx_t
able,print_record,&arg);vty_out(vty,"NumberofIPv4Prefixes:%u\n",number_of_ipv4_p
refixes);vty_out(vty,"NumberofIPv6Prefixes:%u\n",number_of_ipv6_prefixes);}stati
cintrpki_validate_prefix(structpeer*peer,structattr*attr,structprefix*prefix){st
ructassegment*as_segment;as_tas_number=0;structlrtr_ip_addrip_addr_prefix;enumpf
xv_stateresult;charbuf[BUFSIZ];constchar*prefix_string;if(!is_synchronized())ret
urn0;//NoaspathmeansroutecomesfromiBGPif(!attr->aspath||!attr->aspath->segments)
{//Setownasnumberas_number=peer->bgp->as;}else{as_segment=attr->aspath->segments
;//FindlastAsSegmentwhile(as_segment->next)as_segment=as_segment->next;if(as_seg
ment->type==AS_SEQUENCE){//Getrightmostasnas_number=as_segment->as[as_segment->l
ength-1];}elseif(as_segment->type==AS_CONFED_SEQUENCE||as_segment->type==AS_CONF
ED_SET){//Setownasnumberas_number=peer->bgp->as;}else{//RFCsays:"Takedistinguish
edvalueNONEasasn"//whichmeansstateisunknownreturnRPKI_NOTFOUND;}}//Gettheprefixi
nrequestedformatswitch(prefix->family){caseAF_INET:ip_addr_prefix.ver=LRTR_IPV4;
ip_addr_prefix.u.addr4.addr=ntohl(prefix->u.prefix4.s_addr);break;#ifdefHAVE_IPV
6caseAF_INET6:ip_addr_prefix.ver=LRTR_IPV6;ipv6_addr_to_host_byte_order(prefix->
u.prefix6.s6_addr32,ip_addr_prefix.u.addr6.addr);break;#endif/*HAVE_IPV6*/defaul
t:return0;}//Dotheactualvalidationrtr_mgr_validate(rtr_config,as_number,&ip_addr
_prefix,prefix->prefixlen,&result);//PrintDebugoutputprefix_string=inet_ntop(pre
fix->family,&prefix->u.prefix,buf,BUFSIZ);switch(result){caseBGP_PFXV_STATE_VALI
D:RPKI_DEBUG("ValidatingPrefix%s/%hhufromasn%uResult:VALID",prefix_string,prefix
->prefixlen,as_number);returnRPKI_VALID;caseBGP_PFXV_STATE_NOT_FOUND:RPKI_DEBUG(
"ValidatingPrefix%s/%hhufromasn%uResult:NOTFOUND",prefix_string,prefix->prefixle
n,as_number);returnRPKI_NOTFOUND;caseBGP_PFXV_STATE_INVALID:RPKI_DEBUG("Validati
ngPrefix%s/%hhufromasn%uResult:INVALID",prefix_string,prefix->prefixlen,as_numbe
r);returnRPKI_INVALID;default:RPKI_DEBUG("ValidatingPrefix%s/%hhufromasn%uResult
:CANNOTVALIDATE",prefix_string,prefix->prefixlen,as_number);break;}return0;}stat
icintadd_cache(structcache*cache){uint8_tpreference=cache->preference;structrtr_
mgr_groupgroup;group.preference=preference;group.sockets_len=1;group.sockets=&ca
che->rtr_socket;listnode_add(cache_list,cache);if(rtr_is_running&&rtr_mgr_add_gr
oup(rtr_config,&group)!=RTR_SUCCESS){returnERROR;}returnSUCCESS;}staticintadd_tc
p_cache(constchar*host,constchar*port,constuint8_tpreference){structrtr_socket*r
tr_socket;structtr_tcp_config*tcp_config=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof(str
ucttr_tcp_config));structtr_socket*tr_socket=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof
(structtr_socket));structcache*cache=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof(structc
ache));tcp_config->host=XSTRDUP(MTYPE_BGP_RPKI_CACHE,host);tcp_config->port=XSTR
DUP(MTYPE_BGP_RPKI_CACHE,port);tcp_config->bindaddr=NULL;rtr_socket=create_rtr_s
ocket(tr_socket);cache->type=TCP;cache->tr_socket=tr_socket;cache->tr_config.tcp
_config=tcp_config;cache->rtr_socket=rtr_socket;cache->preference=preference;ret
urnadd_cache(cache);}#ifdefined(FOUND_SSH)staticintadd_ssh_cache(constchar*host,
constunsignedintport,constchar*username,constchar*client_privkey_path,constchar*
client_pubkey_path,constchar*server_pubkey_path,constuint8_tpreference){structtr
_ssh_config*ssh_config=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof(structtr_ssh_config))
;structcache*cache=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof(structcache));structtr_so
cket*tr_socket=XMALLOC(MTYPE_BGP_RPKI_CACHE,sizeof(structtr_socket));structrtr_s
ocket*rtr_socket;ssh_config->port=port;ssh_config->host=XSTRDUP(MTYPE_BGP_RPKI_C
ACHE,host);ssh_config->bindaddr=NULL;ssh_config->username=XSTRDUP(MTYPE_BGP_RPKI
_CACHE,username);ssh_config->client_privkey_path=XSTRDUP(MTYPE_BGP_RPKI_CACHE,cl
ient_privkey_path);ssh_config->server_hostkey_path=XSTRDUP(MTYPE_BGP_RPKI_CACHE,
server_pubkey_path);rtr_socket=create_rtr_socket(tr_socket);cache->type=SSH;cach
e->tr_socket=tr_socket;cache->tr_config.ssh_config=ssh_config;cache->rtr_socket=
rtr_socket;cache->preference=preference;returnadd_cache(cache);}#endifstaticvoid
free_cache(structcache*cache){if(cache->type==TCP){XFREE(MTYPE_BGP_RPKI_CACHE,ca
che->tr_config.tcp_config->host);XFREE(MTYPE_BGP_RPKI_CACHE,cache->tr_config.tcp
_config->port);XFREE(MTYPE_BGP_RPKI_CACHE,cache->tr_config.tcp_config);}#ifdefin
ed(FOUND_SSH)else{XFREE(MTYPE_BGP_RPKI_CACHE,cache->tr_config.ssh_config->host);
XFREE(MTYPE_BGP_RPKI_CACHE,cache->tr_config.ssh_config->username);XFREE(MTYPE_BG
P_RPKI_CACHE,cache->tr_config.ssh_config->client_privkey_path);XFREE(MTYPE_BGP_R
PKI_CACHE,cache->tr_config.ssh_config->server_hostkey_path);XFREE(MTYPE_BGP_RPKI
_CACHE,cache->tr_config.ssh_config);}#endifXFREE(MTYPE_BGP_RPKI_CACHE,cache->tr_
socket);XFREE(MTYPE_BGP_RPKI_CACHE,cache->rtr_socket);XFREE(MTYPE_BGP_RPKI_CACHE
,cache);}staticintconfig_write(structvty*vty){structlistnode*cache_node;structca
che*cache;if(listcount(cache_list)){if(rpki_debug)vty_out(vty,"debugrpki\n");vty
_out(vty,"!\n");vty_out(vty,"rpki\n");vty_out(vty,"rpkipolling_period%d\n",polli
ng_period);vty_out(vty,"rpkitimeout%d\n",timeout);vty_out(vty,"rpkiinitial-synch
ronisation-timeout%d\n",initial_synchronisation_timeout);for(ALL_LIST_ELEMENTS_R
O(cache_list,cache_node,cache)){switch(cache->type){structtr_tcp_config*tcp_conf
ig;#ifdefined(FOUND_SSH)structtr_ssh_config*ssh_config;#endifcaseTCP:tcp_config=
cache->tr_config.tcp_config;vty_out(vty,"rpkicache%s%s",tcp_config->host,tcp_con
fig->port);break;#ifdefined(FOUND_SSH)caseSSH:ssh_config=cache->tr_config.ssh_co
nfig;vty_out(vty,"rpkicache%s%u%s%s%s",ssh_config->host,ssh_config->port,ssh_con
fig->username,ssh_config->client_privkey_path,ssh_config->server_hostkey_path!=N
ULL?ssh_config->server_hostkey_path:"");break;#endifdefault:break;}vty_out(vty,"
preference%hhu\n",cache->preference);}vty_out(vty,"exit\n");return1;}else{return
0;}}DEFUN_NOSH(rpki,rpki_cmd,"rpki","Enablerpkiandenterrpkiconfigurationmode\n")
{vty->node=RPKI_NODE;returnCMD_SUCCESS;}DEFUN(bgp_rpki_start,bgp_rpki_start_cmd,
"rpkistart",RPKI_OUTPUT_STRING"startrpkisupport\n"){if(listcount(cache_list)==0)
vty_out(vty,"Couldnotstartrpkibecausenocachesareconfigured\n");if(!is_running())
{if(start()==ERROR){RPKI_DEBUG("RPKIfailedtostart");returnCMD_WARNING;}}returnCM
D_SUCCESS;}DEFUN(bgp_rpki_stop,bgp_rpki_stop_cmd,"rpkistop",RPKI_OUTPUT_STRING"s
tartrpkisupport\n"){if(is_running())stop();returnCMD_SUCCESS;}DEFPY(rpki_polling
_period,rpki_polling_period_cmd,"rpkipolling_period(1-86400)$pp",RPKI_OUTPUT_STR
ING"Setpollingperiod\n""Pollingperiodvalue\n"){polling_period=pp;returnCMD_SUCCE
SS;}DEFUN(no_rpki_polling_period,no_rpki_polling_period_cmd,"norpkipolling_perio
d",NO_STRRPKI_OUTPUT_STRING"Setpollingperiodbacktodefault\n"){polling_period=POL
LING_PERIOD_DEFAULT;returnCMD_SUCCESS;}DEFPY(rpki_expire_interval,rpki_expire_in
terval_cmd,"rpkiexpire_interval(600-172800)$tmp",RPKI_OUTPUT_STRING"Setexpireint
erval\n""Expireintervalvalue\n"){if((unsignedint)tmp>=polling_period){expire_int
erval=tmp;returnCMD_SUCCESS;}vty_out(vty,"%%Expiryintervalmustbepollingperiodorl
arger\n");returnCMD_WARNING_CONFIG_FAILED;}DEFUN(no_rpki_expire_interval,no_rpki
_expire_interval_cmd,"norpkiexpire_interval",NO_STRRPKI_OUTPUT_STRING"Setexpirei
ntervalbacktodefault\n"){expire_interval=polling_period*2;returnCMD_SUCCESS;}DEF
PY(rpki_retry_interval,rpki_retry_interval_cmd,"rpkiretry_interval(1-7200)$tmp",
RPKI_OUTPUT_STRING"Setretryinterval\n""retryintervalvalue\n"){retry_interval=tmp
;returnCMD_SUCCESS;}DEFUN(no_rpki_retry_interval,no_rpki_retry_interval_cmd,"nor
pkiretry_interval",NO_STRRPKI_OUTPUT_STRING"Setretryintervalbacktodefault\n"){re
try_interval=RETRY_INTERVAL_DEFAULT;returnCMD_SUCCESS;}DEFPY(rpki_timeout,rpki_t
imeout_cmd,"rpkitimeout(1-4294967295)$to_arg",RPKI_OUTPUT_STRING"Settimeout\n""T
imeoutvalue\n"){timeout=to_arg;returnCMD_SUCCESS;}DEFUN(no_rpki_timeout,no_rpki_
timeout_cmd,"norpkitimeout",NO_STRRPKI_OUTPUT_STRING"Settimeoutbacktodefault\n")
{timeout=TIMEOUT_DEFAULT;returnCMD_SUCCESS;}DEFPY(rpki_synchronisation_timeout,r
pki_synchronisation_timeout_cmd,"rpkiinitial-synchronisation-timeout(1-429496729
5)$ito_arg",RPKI_OUTPUT_STRING"Setatimeoutfortheinitialsynchronisationofprefixva
lidationdata\n""Timeoutvalue\n"){initial_synchronisation_timeout=ito_arg;returnC
MD_SUCCESS;}DEFUN(no_rpki_synchronisation_timeout,no_rpki_synchronisation_timeou
t_cmd,"norpkiinitial-synchronisation-timeout",NO_STRRPKI_OUTPUT_STRING"Settheini
tialsynchronisationtimeoutbacktodefault(30sec.)\n"){initial_synchronisation_time
out=INITIAL_SYNCHRONISATION_TIMEOUT_DEFAULT;returnCMD_SUCCESS;}DEFPY(rpki_cache,
rpki_cache_cmd,"rpkicache<A.B.C.D|WORD>""<TCPPORT|(1-65535)$sshportSSH_UNAMESSH_
PRIVKEYSSH_PUBKEY[SERVER_PUBKEY]>""preference(1-255)",RPKI_OUTPUT_STRING"Install
acacheservertocurrentgroup\n""IPaddressofcacheserver\nHostnameofcacheserver\n""T
CPportnumber\n""SSHportnumber\n""SSHusername\n""PathtoownSSHprivatekey\n""Pathto
ownSSHpublickey\n""PathtoPublickeyofcacheserver\n""Preferenceofthecacheserver\n"
"Preferencevalue\n"){intreturn_value=SUCCESS;//usesshconnectionif(ssh_uname){#if
defined(FOUND_SSH)return_value=add_ssh_cache(cache,sshport,ssh_uname,ssh_privkey
,ssh_pubkey,server_pubkey,preference);#elsevty_out(vty,"sshsocketsarenotsupporte
d.""Pleaserecompilertrlibandfrrwithsshsupport.""Ifyouwanttouseit");#endif}else{/
/usetcpconnectionreturn_value=add_tcp_cache(cache,tcpport,preference);}if(return
_value==ERROR){vty_out(vty,"Couldnotcreatenewrpkicache\n");returnCMD_WARNING;}re
turnCMD_SUCCESS;}DEFPY(no_rpki_cache,no_rpki_cache_cmd,"norpkicache<A.B.C.D|WORD
><TCPPORT|(1-65535)$sshport>preference(1-255)$preference",NO_STRRPKI_OUTPUT_STRI
NG"Removeacacheserver\n""IPaddressofcacheserver\nHostnameofcacheserver\n""TCPpor
tnumber\n""SSHportnumber\n""Preferenceofthecacheserver\n""Preferencevalue\n"){st
ructcache*cache_p=find_cache(preference);if(!cache){vty_out(vty,"Couldnotfindcac
he%ld\n",preference);returnCMD_WARNING;}if(rtr_is_running){if(rtr_mgr_remove_gro
up(rtr_config,preference)==RTR_ERROR){vty_out(vty,"Couldnotremovecache%ld",prefe
rence);if(listcount(cache_list)==1)vty_out(vty,"becauseitisthelastcache");vty_ou
t(vty,"\n");returnCMD_WARNING;}}listnode_delete(cache_list,cache_p);free_cache(c
ache_p);returnCMD_SUCCESS;}DEFUN(show_rpki_prefix_table,show_rpki_prefix_table_c
md,"showrpkiprefix-table",SHOW_STRRPKI_OUTPUT_STRING"Showvalidatedprefixeswhichw
erereceivedfromRPKICache\n"){structlistnode*cache_node;structcache*cache;for(ALL
_LIST_ELEMENTS_RO(cache_list,cache_node,cache)){vty_out(vty,"host:%sport:%s\n",c
ache->tr_config.tcp_config->host,cache->tr_config.tcp_config->port);}if(is_synch
ronized())print_prefix_table(vty);elsevty_out(vty,"NoconnectiontoRPKIcacheserver
.\n");returnCMD_SUCCESS;}DEFUN(show_rpki_cache_server,show_rpki_cache_server_cmd
,"showrpkicache-server",SHOW_STRRPKI_OUTPUT_STRING"SHOWconfiguredcacheserver\n")
{structlistnode*cache_node;structcache*cache;for(ALL_LIST_ELEMENTS_RO(cache_list
,cache_node,cache)){vty_out(vty,"host:%sport:%s\n",cache->tr_config.tcp_config->
host,cache->tr_config.tcp_config->port);}returnCMD_SUCCESS;}DEFUN(show_rpki_cach
e_connection,show_rpki_cache_connection_cmd,"showrpkicache-connection",SHOW_STRR
PKI_OUTPUT_STRING"ShowtowhichRPKICacheServerswehaveaconnection\n"){if(is_synchro
nized()){structlistnode*cache_node;structcache*cache;structrtr_mgr_group*group=g
et_connected_group();if(!group){vty_out(vty,"Cannotfindaconnectedgroup.\n");retu
rnCMD_SUCCESS;}vty_out(vty,"Connectedtogroup%d\n",group->preference);for(ALL_LIS
T_ELEMENTS_RO(cache_list,cache_node,cache)){if(cache->preference==group->prefere
nce){structtr_tcp_config*tcp_config;#ifdefined(FOUND_SSH)structtr_ssh_config*ssh
_config;#endifswitch(cache->type){caseTCP:tcp_config=cache->tr_config.tcp_config
;vty_out(vty,"rpkitcpcache%s%spref%hhu\n",tcp_config->host,tcp_config->port,cach
e->preference);break;#ifdefined(FOUND_SSH)caseSSH:ssh_config=cache->tr_config.ss
h_config;vty_out(vty,"rpkisshcache%s%upref%hhu\n",ssh_config->host,ssh_config->p
ort,cache->preference);break;#endifdefault:break;}}}}else{vty_out(vty,"Noconnect
iontoRPKIcacheserver.\n");}returnCMD_SUCCESS;}DEFUN_NOSH(rpki_exit,rpki_exit_cmd
,"exit","Exitrpkiconfigurationandrestartrpkisession\n"){intret=reset(false);vty-
>node=CONFIG_NODE;returnret==SUCCESS?CMD_SUCCESS:CMD_WARNING;}DEFUN_NOSH(rpki_qu
it,rpki_quit_cmd,"quit","Exitrpkiconfigurationmode\n"){returnrpki_exit(self,vty,
argc,argv);}DEFUN_NOSH(rpki_end,rpki_end_cmd,"end","Endrpkiconfiguration,restart
rpkisessionandchangetoenablemode.\n"){intret=reset(false);vty_config_unlock(vty)
;vty->node=ENABLE_NODE;returnret==SUCCESS?CMD_SUCCESS:CMD_WARNING;}DEFUN(rpki_re
set,rpki_reset_cmd,"rpkireset",RPKI_OUTPUT_STRING"resetrpki\n"){returnreset(true
)==SUCCESS?CMD_SUCCESS:CMD_WARNING;}DEFUN(debug_rpki,debug_rpki_cmd,"debugrpki",
DEBUG_STR"Enabledebuggingforrpki\n"){rpki_debug=1;returnCMD_SUCCESS;}DEFUN(no_de
bug_rpki,no_debug_rpki_cmd,"nodebugrpki",NO_STRDEBUG_STR"Disabledebuggingforrpki
\n"){rpki_debug=0;returnCMD_SUCCESS;}DEFUN(match_rpki,match_rpki_cmd,"matchrpki<
valid|invalid|notfound>",MATCH_STRRPKI_OUTPUT_STRING"Validprefix\n""Invalidprefi
x\n""Prefixnotfound\n"){VTY_DECLVAR_CONTEXT(route_map_index,index);intret;ret=ro
ute_map_add_match(index,"rpki",argv[2]->arg);if(ret){switch(ret){caseRMAP_RULE_M
ISSING:vty_out(vty,"%%BGPCan'tfindrule.\n");returnCMD_WARNING_CONFIG_FAILED;case
RMAP_COMPILE_ERROR:vty_out(vty,"%%BGPArgumentismalformed.\n");returnCMD_WARNING_
CONFIG_FAILED;}}returnCMD_SUCCESS;}DEFUN(no_match_rpki,no_match_rpki_cmd,"nomatc
hrpki<valid|invalid|notfound>",NO_STRMATCH_STRRPKI_OUTPUT_STRING"Validprefix\n""
Invalidprefix\n""Prefixnotfound\n"){VTY_DECLVAR_CONTEXT(route_map_index,index);i
ntret;ret=route_map_delete_match(index,"rpki",argv[3]->arg);if(ret){switch(ret){
caseRMAP_RULE_MISSING:vty_out(vty,"%%BGPCan'tfindrule.\n");break;caseRMAP_COMPIL
E_ERROR:vty_out(vty,"%%BGPArgumentismalformed.\n");break;}returnCMD_WARNING_CONF
IG_FAILED;}returnCMD_SUCCESS;}staticvoidoverwrite_exit_commands(void){unsignedin
ti;vectorcmd_vector=rpki_node.cmd_vector;for(i=0;i<cmd_vector->active;++i){struc
tcmd_element*cmd=vector_lookup(cmd_vector,i);if(strcmp(cmd->string,"exit")==0||s
trcmp(cmd->string,"quit")==0||strcmp(cmd->string,"end")==0){uninstall_element(RP
KI_NODE,cmd);}}install_element(RPKI_NODE,&rpki_exit_cmd);install_element(RPKI_NO
DE,&rpki_quit_cmd);install_element(RPKI_NODE,&rpki_end_cmd);}staticvoidinstall_c
li_commands(void){//TODO:makeconfigwriteworkinstall_node(&rpki_node,&config_writ
e);install_default(RPKI_NODE);overwrite_exit_commands();install_element(CONFIG_N
ODE,&rpki_cmd);install_element(VIEW_NODE,&rpki_cmd);install_element(ENABLE_NODE,
&bgp_rpki_start_cmd);install_element(ENABLE_NODE,&bgp_rpki_stop_cmd);/*Installrp
kiresetcommand*/install_element(RPKI_NODE,&rpki_reset_cmd);/*Installrpkipollingp
eriodcommands*/install_element(RPKI_NODE,&rpki_polling_period_cmd);install_eleme
nt(RPKI_NODE,&no_rpki_polling_period_cmd);/*Installrpkiexpireintervalcommands*/i
nstall_element(RPKI_NODE,&rpki_expire_interval_cmd);install_element(RPKI_NODE,&n
o_rpki_expire_interval_cmd);/*Installrpkiretryintervalcommands*/install_element(
RPKI_NODE,&rpki_retry_interval_cmd);install_element(RPKI_NODE,&no_rpki_retry_int
erval_cmd);/*Installrpkitimeoutcommands*/install_element(RPKI_NODE,&rpki_timeout
_cmd);install_element(RPKI_NODE,&no_rpki_timeout_cmd);/*Installrpkisynchronisati
ontimeoutcommands*/install_element(RPKI_NODE,&rpki_synchronisation_timeout_cmd);
install_element(RPKI_NODE,&no_rpki_synchronisation_timeout_cmd);/*Installrpkicac
hecommands*/install_element(RPKI_NODE,&rpki_cache_cmd);install_element(RPKI_NODE
,&no_rpki_cache_cmd);/*Installshowcommands*/install_element(ENABLE_NODE,&show_rp
ki_prefix_table_cmd);install_element(ENABLE_NODE,&show_rpki_cache_connection_cmd
);install_element(ENABLE_NODE,&show_rpki_cache_server_cmd);/*Installdebugcommand
s*/install_element(CONFIG_NODE,&debug_rpki_cmd);install_element(ENABLE_NODE,&deb
ug_rpki_cmd);install_element(CONFIG_NODE,&no_debug_rpki_cmd);install_element(ENA
BLE_NODE,&no_debug_rpki_cmd);/*Installroutematch*/route_map_install_match(&route
_match_rpki_cmd);install_element(RMAP_NODE,&match_rpki_cmd);install_element(RMAP
_NODE,&no_match_rpki_cmd);}FRR_MODULE_SETUP(.name="bgpd_rpki",.version="0.3.6",.
description="EnableRPKIsupportforFRR.",.init=bgp_rpki_module_init)