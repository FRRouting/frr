/*BGP-4dumproutine*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebra.**
GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUG
eneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(aty
ouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,bu
t*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFOR
APARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaver
eceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;
ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02
110-1301USA*/#include<zebra.h>#include"log.h"#include"stream.h"#include"sockunio
n.h"#include"command.h"#include"prefix.h"#include"thread.h"#include"linklist.h"#
include"queue.h"#include"memory.h"#include"filter.h"#include"bgpd/bgp_table.h"#i
nclude"bgpd/bgpd.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_attr.h"#include"b
gpd/bgp_dump.h"enumbgp_dump_type{BGP_DUMP_ALL,BGP_DUMP_ALL_ET,BGP_DUMP_UPDATES,B
GP_DUMP_UPDATES_ET,BGP_DUMP_ROUTES};staticconststructbgp_dump_type_map{enumbgp_d
ump_typetype;constchar*str;}bgp_dump_type_map[]={{BGP_DUMP_ALL,"all"},{BGP_DUMP_
ALL_ET,"all-et"},{BGP_DUMP_UPDATES,"updates"},{BGP_DUMP_UPDATES_ET,"updates-et"}
,{BGP_DUMP_ROUTES,"routes-mrt"},{0,NULL},};enumMRT_MSG_TYPES{MSG_NULL,MSG_START,
/*senderisstartingup*/MSG_DIE,/*receivershouldshutdown*/MSG_I_AM_DEAD,/*senderis
shuttingdown*/MSG_PEER_DOWN,/*sender'speerisdown*/MSG_PROTOCOL_BGP,/*msgisaBGPpa
cket*/MSG_PROTOCOL_RIP,/*msgisaRIPpacket*/MSG_PROTOCOL_IDRP,/*msgisanIDRPpacket*
/MSG_PROTOCOL_RIPNG,/*msgisaRIPNGpacket*/MSG_PROTOCOL_BGP4PLUS,/*msgisaBGP4+pack
et*/MSG_PROTOCOL_BGP4PLUS_01,/*msgisaBGP4+(draft01)packet*/MSG_PROTOCOL_OSPF,/*m
sgisanOSPFpacket*/MSG_TABLE_DUMP,/*routingtabledump*/MSG_TABLE_DUMP_V2/*routingt
abledump,version2*/};structbgp_dump{enumbgp_dump_typetype;char*filename;FILE*fp;
unsignedintinterval;char*interval_str;structthread*t_interval;};staticintbgp_dum
p_unset(structbgp_dump*bgp_dump);staticintbgp_dump_interval_func(structthread*);
/*BGPpacketdumpoutputbuffer.*/structstream*bgp_dump_obuf;/*BGPdumpstrucuturefor'
dumpbgpall'*/structbgp_dumpbgp_dump_all;/*BGPdumpstructurefor'dumpbgpupdates'*/s
tructbgp_dumpbgp_dump_updates;/*BGPdumpstructurefor'dumpbgproutes'*/structbgp_du
mpbgp_dump_routes;staticFILE*bgp_dump_open_file(structbgp_dump*bgp_dump){intret;
time_tclock;structtm*tm;charfullpath[MAXPATHLEN];charrealpath[MAXPATHLEN];mode_t
oldumask;time(&clock);tm=localtime(&clock);if(bgp_dump->filename[0]!=DIRECTORY_S
EP){sprintf(fullpath,"%s/%s",vty_get_cwd(),bgp_dump->filename);ret=strftime(real
path,MAXPATHLEN,fullpath,tm);}elseret=strftime(realpath,MAXPATHLEN,bgp_dump->fil
ename,tm);if(ret==0){zlog_warn("bgp_dump_open_file:strftimeerror");returnNULL;}i
f(bgp_dump->fp)fclose(bgp_dump->fp);oldumask=umask(0777&~LOGFILE_MASK);bgp_dump-
>fp=fopen(realpath,"w");if(bgp_dump->fp==NULL){zlog_warn("bgp_dump_open_file:%s:
%s",realpath,strerror(errno));umask(oldumask);returnNULL;}umask(oldumask);return
bgp_dump->fp;}staticintbgp_dump_interval_add(structbgp_dump*bgp_dump,intinterval
){intsecs_into_day;time_tt;structtm*tm;if(interval>0){/*Periodicdumpeveryinterva
lseconds*/if((interval<86400)&&((86400%interval)==0)){/*Dumpatpredictabletimes:i
fadayhasawhole*numberof*intervals,dumpeveryintervalsecondsstartingfrom*midnight*
/(void)time(&t);tm=localtime(&t);secs_into_day=tm->tm_sec+60*tm->tm_min+60*60*tm
->tm_hour;interval=interval-secs_into_day%interval;/*always>0*/}bgp_dump->t_inte
rval=NULL;thread_add_timer(bm->master,bgp_dump_interval_func,bgp_dump,interval,&
bgp_dump->t_interval);}else{/*One-offdump:executeimmediately,don'taffectanysched
uled*dumps*/bgp_dump->t_interval=NULL;thread_add_event(bm->master,bgp_dump_inter
val_func,bgp_dump,0,&bgp_dump->t_interval);}return0;}/*Dumpcommonheader.*/static
voidbgp_dump_header(structstream*obuf,inttype,intsubtype,intdump_type){structtim
evalclock;longmsecs;time_tsecs;if((dump_type==BGP_DUMP_ALL_ET||dump_type==BGP_DU
MP_UPDATES_ET)&&type==MSG_PROTOCOL_BGP4MP)type=MSG_PROTOCOL_BGP4MP_ET;gettimeofd
ay(&clock,NULL);secs=clock.tv_sec;msecs=clock.tv_usec;/*Putdumppacketheader.*/st
ream_putl(obuf,secs);stream_putw(obuf,type);stream_putw(obuf,subtype);stream_put
l(obuf,0);/*len*//*AddingmicrosecondsfortheMRTExtendedHeader*/if(type==MSG_PROTO
COL_BGP4MP_ET)stream_putl(obuf,msecs);}staticvoidbgp_dump_set_size(structstream*
s,inttype){/**TheBGP_DUMP_HEADER_SIZEstayat12eventwhenET:*"TheMicrosecondTimesta
mpisincludedinthecomputation*oftheLengthfieldvalue."(RFC63962011)*/stream_putl_a
t(s,8,stream_get_endp(s)-BGP_DUMP_HEADER_SIZE);}staticvoidbgp_dump_routes_index_
table(structbgp*bgp){structpeer*peer;structlistnode*node;uint16_tpeerno=1;struct
stream*obuf;obuf=bgp_dump_obuf;stream_reset(obuf);/*MRTheader*/bgp_dump_header(o
buf,MSG_TABLE_DUMP_V2,TABLE_DUMP_V2_PEER_INDEX_TABLE,BGP_DUMP_ROUTES);/*Collecto
rBGPID*/stream_put_in_addr(obuf,&bgp->router_id);/*Viewname*/if(bgp->name){strea
m_putw(obuf,strlen(bgp->name));stream_put(obuf,bgp->name,strlen(bgp->name));}els
e{stream_putw(obuf,0);}/*Peercount(plusoneextrainternalpeer)*/stream_putw(obuf,l
istcount(bgp->peer)+1);/*Populatefakepeeratindex0,forlocallyoriginatedroutes*//*
Peertype(IPv4)*/stream_putc(obuf,TABLE_DUMP_V2_PEER_INDEX_TABLE_AS4+TABLE_DUMP_V
2_PEER_INDEX_TABLE_IP);/*PeerBGPID(0.0.0.0)*/stream_putl(obuf,0);/*PeerIPaddress
(0.0.0.0)*/stream_putl(obuf,0);/*PeerASN(0)*/stream_putl(obuf,0);/*Walkdownallpe
ers*/for(ALL_LIST_ELEMENTS_RO(bgp->peer,node,peer)){/*Peer'stype*/if(sockunion_f
amily(&peer->su)==AF_INET){stream_putc(obuf,TABLE_DUMP_V2_PEER_INDEX_TABLE_AS4+T
ABLE_DUMP_V2_PEER_INDEX_TABLE_IP);}elseif(sockunion_family(&peer->su)==AF_INET6)
{stream_putc(obuf,TABLE_DUMP_V2_PEER_INDEX_TABLE_AS4+TABLE_DUMP_V2_PEER_INDEX_TA
BLE_IP6);}/*Peer'sBGPID*/stream_put_in_addr(obuf,&peer->remote_id);/*Peer'sIPadd
ress*/if(sockunion_family(&peer->su)==AF_INET){stream_put_in_addr(obuf,&peer->su
.sin.sin_addr);}elseif(sockunion_family(&peer->su)==AF_INET6){stream_write(obuf,
(uint8_t*)&peer->su.sin6.sin6_addr,IPV6_MAX_BYTELEN);}/*Peer'sASnumber.*//*Notet
hat,asthisisanAS4compliantquagga,theRIBis*alwaysAS4*/stream_putl(obuf,peer->as);
/*Storethepeernumberforthispeer*/peer->table_dump_index=peerno;peerno++;}bgp_dum
p_set_size(obuf,MSG_TABLE_DUMP_V2);fwrite(STREAM_DATA(obuf),stream_get_endp(obuf
),1,bgp_dump_routes.fp);fflush(bgp_dump_routes.fp);}staticstructbgp_info*bgp_dum
p_route_node_record(intafi,structbgp_node*rn,structbgp_info*info,unsignedintseq)
{structstream*obuf;size_tsizep;size_tendp;obuf=bgp_dump_obuf;stream_reset(obuf);
/*MRTheader*/if(afi==AFI_IP)bgp_dump_header(obuf,MSG_TABLE_DUMP_V2,TABLE_DUMP_V2
_RIB_IPV4_UNICAST,BGP_DUMP_ROUTES);elseif(afi==AFI_IP6)bgp_dump_header(obuf,MSG_
TABLE_DUMP_V2,TABLE_DUMP_V2_RIB_IPV6_UNICAST,BGP_DUMP_ROUTES);/*Sequencenumber*/
stream_putl(obuf,seq);/*Prefixlength*/stream_putc(obuf,rn->p.prefixlen);/*Prefix
*/if(afi==AFI_IP){/*We'lldumponlytheusefulbits(thosenot0),buthaveto*alignon8bits
*/stream_write(obuf,(uint8_t*)&rn->p.u.prefix4,(rn->p.prefixlen+7)/8);}elseif(af
i==AFI_IP6){/*We'lldumponlytheusefulbits(thosenot0),buthaveto*alignon8bits*/stre
am_write(obuf,(uint8_t*)&rn->p.u.prefix6,(rn->p.prefixlen+7)/8);}/*Savewherewear
enow,sowecanoverwridetheentrycountlater*/sizep=stream_get_endp(obuf);/*Entrycoun
t*/uint16_tentry_count=0;/*Entrycount,notethatthisisoverwrittenlater*/stream_put
w(obuf,0);endp=stream_get_endp(obuf);for(;info;info=info->next){size_tcur_endp;/
*Peerindex*/stream_putw(obuf,info->peer->table_dump_index);/*Originated*/stream_
putl(obuf,time(NULL)-(bgp_clock()-info->uptime));/*Dumpattribute.*//*Skipprefix&
AFI/SAFIforMP_NLRI*/bgp_dump_routes_attr(obuf,info->attr,&rn->p);cur_endp=stream
_get_endp(obuf);if(cur_endp>BGP_MAX_PACKET_SIZE+BGP_DUMP_MSG_HEADER+BGP_DUMP_HEA
DER_SIZE){stream_set_endp(obuf,endp);break;}entry_count++;endp=cur_endp;}/*Overw
ritetheentrycount,nowthatweknowtherightnumber*/stream_putw_at(obuf,sizep,entry_c
ount);bgp_dump_set_size(obuf,MSG_TABLE_DUMP_V2);fwrite(STREAM_DATA(obuf),stream_
get_endp(obuf),1,bgp_dump_routes.fp);returninfo;}/*Runsunderchildprocess.*/stati
cunsignedintbgp_dump_routes_func(intafi,intfirst_run,unsignedintseq){structbgp_i
nfo*info;structbgp_node*rn;structbgp*bgp;structbgp_table*table;bgp=bgp_get_defau
lt();if(!bgp)returnseq;if(bgp_dump_routes.fp==NULL)returnseq;/*Notethatbgp_dump_
routes_index_tablewilldoipv4andipv6peers,sothisshouldonlybedoneonthefirstcalltob
gp_dump_routes_func.(thisfunctionwillbecalledonceforipv4andonceforipv6)*/if(firs
t_run)bgp_dump_routes_index_table(bgp);/*WalkdowneachBGProute.*/table=bgp->rib[a
fi][SAFI_UNICAST];for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn)){info=rn-
>info;while(info){info=bgp_dump_route_node_record(afi,rn,info,seq);seq++;}}fflus
h(bgp_dump_routes.fp);returnseq;}staticintbgp_dump_interval_func(structthread*t)
{structbgp_dump*bgp_dump;bgp_dump=THREAD_ARG(t);bgp_dump->t_interval=NULL;/*Resc
heduledumpeveniffilecouldn'tbeopenedthistime...*/if(bgp_dump_open_file(bgp_dump)
!=NULL){/*Incaseofbgp_dump_routes,weneedspecialroutedump*function.*/if(bgp_dump-
>type==BGP_DUMP_ROUTES){unsignedintseq=bgp_dump_routes_func(AFI_IP,1,0);bgp_dump
_routes_func(AFI_IP6,0,seq);/*Closethefilenow.ForaRIBdumpthere'snopoint*inleavin
g*itopenuntilthenextscheduleddumpstarts.*/fclose(bgp_dump->fp);bgp_dump->fp=NULL
;}}/*ifintervalissetreschedule*/if(bgp_dump->interval>0)bgp_dump_interval_add(bg
p_dump,bgp_dump->interval);return0;}/*Dumpcommoninformation.*/staticvoidbgp_dump
_common(structstream*obuf,structpeer*peer,intforceas4){charempty[16]={0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0};/*SourceASnumberandDestinationASnumber.*/if(forceas4||CHE
CK_FLAG(peer->cap,PEER_CAP_AS4_RCV)){stream_putl(obuf,peer->as);stream_putl(obuf
,peer->local_as);}else{stream_putw(obuf,peer->as);stream_putw(obuf,peer->local_a
s);}if(peer->su.sa.sa_family==AF_INET){stream_putw(obuf,peer->ifp?peer->ifp->ifi
ndex:0);stream_putw(obuf,AFI_IP);stream_put(obuf,&peer->su.sin.sin_addr,IPV4_MAX
_BYTELEN);if(peer->su_local)stream_put(obuf,&peer->su_local->sin.sin_addr,IPV4_M
AX_BYTELEN);elsestream_put(obuf,empty,IPV4_MAX_BYTELEN);}elseif(peer->su.sa.sa_f
amily==AF_INET6){/*InterfaceIndexandAddressfamily.*/stream_putw(obuf,peer->ifp?p
eer->ifp->ifindex:0);stream_putw(obuf,AFI_IP6);/*SourceIPAddressandDestinationIP
Address.*/stream_put(obuf,&peer->su.sin6.sin6_addr,IPV6_MAX_BYTELEN);if(peer->su
_local)stream_put(obuf,&peer->su_local->sin6.sin6_addr,IPV6_MAX_BYTELEN);elsestr
eam_put(obuf,empty,IPV6_MAX_BYTELEN);}}/*DumpBGPstatuschange.*/voidbgp_dump_stat
e(structpeer*peer,intstatus_old,intstatus_new){structstream*obuf;/*Ifdumpfilepoi
nterisdisabledreturnimmediately.*/if(bgp_dump_all.fp==NULL)return;/*Makedumpstre
am.*/obuf=bgp_dump_obuf;stream_reset(obuf);bgp_dump_header(obuf,MSG_PROTOCOL_BGP
4MP,BGP4MP_STATE_CHANGE_AS4,bgp_dump_all.type);bgp_dump_common(obuf,peer,1);/*fo
rcethisinas4speak*/stream_putw(obuf,status_old);stream_putw(obuf,status_new);/*S
etlength.*/bgp_dump_set_size(obuf,MSG_PROTOCOL_BGP4MP);/*Writetothestream.*/fwri
te(STREAM_DATA(obuf),stream_get_endp(obuf),1,bgp_dump_all.fp);fflush(bgp_dump_al
l.fp);}staticvoidbgp_dump_packet_func(structbgp_dump*bgp_dump,structpeer*peer,st
ructstream*packet){structstream*obuf;/*Ifdumpfilepointerisdisabledreturnimmediat
ely.*/if(bgp_dump->fp==NULL)return;/*Makedumpstream.*/obuf=bgp_dump_obuf;stream_
reset(obuf);/*Dumpheaderandcommonpart.*/if(CHECK_FLAG(peer->cap,PEER_CAP_AS4_RCV
)){bgp_dump_header(obuf,MSG_PROTOCOL_BGP4MP,BGP4MP_MESSAGE_AS4,bgp_dump->type);}
else{bgp_dump_header(obuf,MSG_PROTOCOL_BGP4MP,BGP4MP_MESSAGE,bgp_dump->type);}bg
p_dump_common(obuf,peer,0);/*Packetcontents.*/stream_put(obuf,STREAM_DATA(packet
),stream_get_endp(packet));/*Setlength.*/bgp_dump_set_size(obuf,MSG_PROTOCOL_BGP
4MP);/*Writetothestream.*/fwrite(STREAM_DATA(obuf),stream_get_endp(obuf),1,bgp_d
ump->fp);fflush(bgp_dump->fp);}/*Calledfrombgp_packet.cwhenBGPpacketisreceived.*
/voidbgp_dump_packet(structpeer*peer,inttype,structstream*packet){/*bgp_dump_all
.*/bgp_dump_packet_func(&bgp_dump_all,peer,packet);/*bgp_dump_updates.*/if(type=
=BGP_MSG_UPDATE)bgp_dump_packet_func(&bgp_dump_updates,peer,packet);}staticunsig
nedintbgp_dump_parse_time(constchar*str){inti;intlen;intseen_h;intseen_m;inttime
;unsignedinttotal;time=0;total=0;seen_h=0;seen_m=0;len=strlen(str);for(i=0;i<len
;i++){if(isdigit((int)str[i])){time*=10;time+=str[i]-'0';}elseif(str[i]=='H'||st
r[i]=='h'){if(seen_h)return0;if(seen_m)return0;total+=time*60*60;time=0;seen_h=1
;}elseif(str[i]=='M'||str[i]=='m'){if(seen_m)return0;total+=time*60;time=0;seen_
m=1;}elsereturn0;}returntotal+time;}staticintbgp_dump_set(structvty*vty,structbg
p_dump*bgp_dump,enumbgp_dump_typetype,constchar*path,constchar*interval_str){uns
ignedintinterval;/*Don'tscheduleduplicatedumpsifthedumpcommandisgiventwice*/if(b
gp_dump->filename&&strcmp(path,bgp_dump->filename)==0&&type==bgp_dump->type){if(
interval_str){if(bgp_dump->interval_str&&strcmp(bgp_dump->interval_str,interval_
str)==0)returnCMD_SUCCESS;}else{if(!bgp_dump->interval_str)returnCMD_SUCCESS;}}/
*Removingpreviousconfig*/bgp_dump_unset(bgp_dump);if(interval_str){/*Checkinterv
alstring.*/interval=bgp_dump_parse_time(interval_str);if(interval==0){vty_out(vt
y,"Malformedintervalstring\n");returnCMD_WARNING_CONFIG_FAILED;}/*Settinginterva
lstring*/bgp_dump->interval_str=XSTRDUP(MTYPE_BGP_DUMP_STR,interval_str);}else{i
nterval=0;}/*Settype.*/bgp_dump->type=type;/*Setinterval*/bgp_dump->interval=int
erval;/*Setfilename.*/bgp_dump->filename=XSTRDUP(MTYPE_BGP_DUMP_STR,path);/*Crea
teintervalthread.*/bgp_dump_interval_add(bgp_dump,interval);/*Thisshouldbecalled
whenintervalisexpired.*/bgp_dump_open_file(bgp_dump);returnCMD_SUCCESS;}staticin
tbgp_dump_unset(structbgp_dump*bgp_dump){/*Removingfilename.*/if(bgp_dump->filen
ame){XFREE(MTYPE_BGP_DUMP_STR,bgp_dump->filename);bgp_dump->filename=NULL;}/*Clo
singfile.*/if(bgp_dump->fp){fclose(bgp_dump->fp);bgp_dump->fp=NULL;}/*Removingin
tervalthread.*/if(bgp_dump->t_interval){thread_cancel(bgp_dump->t_interval);bgp_
dump->t_interval=NULL;}bgp_dump->interval=0;/*Removingintervalstring.*/if(bgp_du
mp->interval_str){XFREE(MTYPE_BGP_DUMP_STR,bgp_dump->interval_str);bgp_dump->int
erval_str=NULL;}returnCMD_SUCCESS;}DEFUN(dump_bgp_all,dump_bgp_all_cmd,"dumpbgp<
all|all-et|updates|updates-et|routes-mrt>PATH[INTERVAL]","Dumppacket\n""BGPpacke
tdump\n""DumpallBGPpackets\nDumpallBGPpackets(ExtendedTimestampHeader)\n""DumpBG
Pupdatesonly\nDumpBGPupdatesonly(ExtendedTimestampHeader)\n""DumpwholeBGProuting
table\n""Outputfilename\n""Intervalofoutput\n"){intidx_dump_routes=2;intidx_path
=3;intidx_interval=4;intbgp_dump_type=0;constchar*interval=NULL;structbgp_dump*b
gp_dump_struct=NULL;conststructbgp_dump_type_map*map=NULL;for(map=bgp_dump_type_
map;map->str;map++)if(strmatch(argv[idx_dump_routes]->text,map->str))bgp_dump_ty
pe=map->type;switch(bgp_dump_type){caseBGP_DUMP_ALL:caseBGP_DUMP_ALL_ET:bgp_dump
_struct=&bgp_dump_all;break;caseBGP_DUMP_UPDATES:caseBGP_DUMP_UPDATES_ET:bgp_dum
p_struct=&bgp_dump_updates;break;caseBGP_DUMP_ROUTES:default:bgp_dump_struct=&bg
p_dump_routes;break;}/*Whenanintervalisgiven*/if(argc==idx_interval+1)interval=a
rgv[idx_interval]->arg;returnbgp_dump_set(vty,bgp_dump_struct,bgp_dump_type,argv
[idx_path]->arg,interval);}DEFUN(no_dump_bgp_all,no_dump_bgp_all_cmd,"nodumpbgp<
all|all-et|updates|updates-et|routes-mrt>[PATH[INTERVAL]]",NO_STR"Stopdumppacket
\n""StopBGPpacketdump\n""Stopdumpprocessall\n""Stopdumpprocessall-et\n""Stopdump
processupdates\n""Stopdumpprocessupdates-et\n""Stopdumpprocessroute-mrt\n""Outpu
tfilename\n""Intervalofoutput\n"){intidx_dump_routes=3;intbgp_dump_type=0;consts
tructbgp_dump_type_map*map=NULL;structbgp_dump*bgp_dump_struct=NULL;for(map=bgp_
dump_type_map;map->str;map++)if(strmatch(argv[idx_dump_routes]->text,map->str))b
gp_dump_type=map->type;switch(bgp_dump_type){caseBGP_DUMP_ALL:caseBGP_DUMP_ALL_E
T:bgp_dump_struct=&bgp_dump_all;break;caseBGP_DUMP_UPDATES:caseBGP_DUMP_UPDATES_
ET:bgp_dump_struct=&bgp_dump_updates;break;caseBGP_DUMP_ROUTES:default:bgp_dump_
struct=&bgp_dump_routes;break;}returnbgp_dump_unset(bgp_dump_struct);}/*BGPnodes
tructure.*/staticstructcmd_nodebgp_dump_node={DUMP_NODE,"",1};#if0char*config_ti
me2str(unsignedintinterval){staticcharbuf[BUFSIZ];buf[0]='\0';if(interval/3600){
sprintf(buf,"%dh",interval/3600);interval%=3600;}if(interval/60){sprintf(buf+str
len(buf),"%dm",interval/60);interval%=60;}if(interval){sprintf(buf+strlen(buf),"
%d",interval);}returnbuf;}#endifstaticintconfig_write_bgp_dump(structvty*vty){if
(bgp_dump_all.filename){constchar*type_str="all";if(bgp_dump_all.type==BGP_DUMP_
ALL_ET)type_str="all-et";if(bgp_dump_all.interval_str)vty_out(vty,"dumpbgp%s%s%s
\n",type_str,bgp_dump_all.filename,bgp_dump_all.interval_str);elsevty_out(vty,"d
umpbgp%s%s\n",type_str,bgp_dump_all.filename);}if(bgp_dump_updates.filename){con
stchar*type_str="updates";if(bgp_dump_updates.type==BGP_DUMP_UPDATES_ET)type_str
="updates-et";if(bgp_dump_updates.interval_str)vty_out(vty,"dumpbgp%s%s%s\n",typ
e_str,bgp_dump_updates.filename,bgp_dump_updates.interval_str);elsevty_out(vty,"
dumpbgp%s%s\n",type_str,bgp_dump_updates.filename);}if(bgp_dump_routes.filename)
{if(bgp_dump_routes.interval_str)vty_out(vty,"dumpbgproutes-mrt%s%s\n",bgp_dump_
routes.filename,bgp_dump_routes.interval_str);elsevty_out(vty,"dumpbgproutes-mrt
%s\n",bgp_dump_routes.filename);}return0;}/*InitializeBGPpacketdumpfunctionality
.*/voidbgp_dump_init(void){memset(&bgp_dump_all,0,sizeof(structbgp_dump));memset
(&bgp_dump_updates,0,sizeof(structbgp_dump));memset(&bgp_dump_routes,0,sizeof(st
ructbgp_dump));bgp_dump_obuf=stream_new((BGP_MAX_PACKET_SIZE<<1)+BGP_DUMP_MSG_HE
ADER+BGP_DUMP_HEADER_SIZE);install_node(&bgp_dump_node,config_write_bgp_dump);in
stall_element(CONFIG_NODE,&dump_bgp_all_cmd);install_element(CONFIG_NODE,&no_dum
p_bgp_all_cmd);}voidbgp_dump_finish(void){bgp_dump_unset(&bgp_dump_all);bgp_dump
_unset(&bgp_dump_updates);bgp_dump_unset(&bgp_dump_routes);stream_free(bgp_dump_
obuf);bgp_dump_obuf=NULL;}