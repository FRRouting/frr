/***bgp_updgrp.c:BGPupdategroupstructures**@copyrightCopyright(C)2014CumulusNetw
orks,Inc.**@authorAvneeshSachdev<avneesh@sproute.net>*@authorRajeshVaradarajan<r
ajesh@sproute.net>*@authorPradoshMohapatra<pradosh@sproute.net>**Thisfileisparto
fGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthete
rmsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherver
sion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwil
lbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITY
orFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yo
ushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethe
fileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor
,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"thread.h"#i
nclude"buffer.h"#include"stream.h"#include"command.h"#include"sockunion.h"#inclu
de"network.h"#include"memory.h"#include"filter.h"#include"routemap.h"#include"lo
g.h"#include"plist.h"#include"linklist.h"#include"workqueue.h"#include"hash.h"#i
nclude"jhash.h"#include"queue.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#
include"bgpd/bgp_debug.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_advertise.h"#
include"bgpd/bgp_packet.h"#include"bgpd/bgp_updgrp.h"#include"bgpd/bgp_route.h"#
include"bgpd/bgp_filter.h"#include"bgpd/bgp_io.h"/*********************PRIVATEFU
NCTIONS********************//***assignauniqueIDtoupdategroupandsubgroup.Mostlyfo
rdisplay/*debuggingpurposes.It'sa64-bitspace-usedleisurelywithouta*worryaboutits
wrappingandaboutfillinggaps.Whileatit,timestamp*thecreation.*/staticvoidupdate_g
roup_checkin(structupdate_group*updgrp){updgrp->id=++bm->updgrp_idspace;updgrp->
uptime=bgp_clock();}staticvoidupdate_subgroup_checkin(structupdate_subgroup*subg
rp,structupdate_group*updgrp){subgrp->id=++bm->subgrp_idspace;subgrp->uptime=bgp
_clock();}staticvoidsync_init(structupdate_subgroup*subgrp){subgrp->sync=XCALLOC
(MTYPE_BGP_SYNCHRONISE,sizeof(structbgp_synchronize));BGP_ADV_FIFO_INIT(&subgrp-
>sync->update);BGP_ADV_FIFO_INIT(&subgrp->sync->withdraw);BGP_ADV_FIFO_INIT(&sub
grp->sync->withdraw_low);subgrp->hash=hash_create(baa_hash_key,baa_hash_cmp,"BGP
SubGroupHash");/*Weusealargerbufferforsubgrp->workintheeventthat:*-WeRXaBGP_UPDA
TEwheretheattributesalonearejust*underBGP_MAX_PACKET_SIZE*-Theuserconfiguresanou
tboundroute-mapthatdoesmanyas-path*prependsoraddsmanycommunities.Atmosttheycanha
ve*CMD_ARGC_MAX*argsinaroute-mapsothereisafinitelimitonhowlargethey*can*makethea
ttributes.**HavingabufferwithBGP_MAX_PACKET_SIZE_OVERFLOWallowsustoavoid*bounds*
checkingforeverysingleattributeasweconstructanUPDATE.*/subgrp->work=stream_new(B
GP_MAX_PACKET_SIZE+BGP_MAX_PACKET_SIZE_OVERFLOW);subgrp->scratch=stream_new(BGP_
MAX_PACKET_SIZE);}staticvoidsync_delete(structupdate_subgroup*subgrp){if(subgrp-
>sync)XFREE(MTYPE_BGP_SYNCHRONISE,subgrp->sync);subgrp->sync=NULL;if(subgrp->has
h)hash_free(subgrp->hash);subgrp->hash=NULL;if(subgrp->work)stream_free(subgrp->
work);subgrp->work=NULL;if(subgrp->scratch)stream_free(subgrp->scratch);subgrp->
scratch=NULL;}/***conf_copy**copyonlythosefieldsthatarerelevanttoupdategroupmatc
h*/staticvoidconf_copy(structpeer*dst,structpeer*src,afi_tafi,safi_tsafi){struct
bgp_filter*srcfilter;structbgp_filter*dstfilter;srcfilter=&src->filter[afi][safi
];dstfilter=&dst->filter[afi][safi];dst->bgp=src->bgp;dst->sort=src->sort;dst->a
s=src->as;dst->v_routeadv=src->v_routeadv;dst->flags=src->flags;dst->af_flags[af
i][safi]=src->af_flags[afi][safi];if(dst->host)XFREE(MTYPE_BGP_PEER_HOST,dst->ho
st);dst->host=XSTRDUP(MTYPE_BGP_PEER_HOST,src->host);dst->cap=src->cap;dst->af_c
ap[afi][safi]=src->af_cap[afi][safi];dst->afc_nego[afi][safi]=src->afc_nego[afi]
[safi];dst->orf_plist[afi][safi]=src->orf_plist[afi][safi];dst->local_as=src->lo
cal_as;dst->change_local_as=src->change_local_as;dst->shared_network=src->shared
_network;memcpy(&(dst->nexthop),&(src->nexthop),sizeof(structbgp_nexthop));dst->
group=src->group;if(src->default_rmap[afi][safi].name){dst->default_rmap[afi][sa
fi].name=XSTRDUP(MTYPE_ROUTE_MAP_NAME,src->default_rmap[afi][safi].name);dst->de
fault_rmap[afi][safi].map=src->default_rmap[afi][safi].map;}if(DISTRIBUTE_OUT_NA
ME(srcfilter)){DISTRIBUTE_OUT_NAME(dstfilter)=XSTRDUP(MTYPE_BGP_FILTER_NAME,DIST
RIBUTE_OUT_NAME(srcfilter));DISTRIBUTE_OUT(dstfilter)=DISTRIBUTE_OUT(srcfilter);
}if(PREFIX_LIST_OUT_NAME(srcfilter)){PREFIX_LIST_OUT_NAME(dstfilter)=XSTRDUP(MTY
PE_BGP_FILTER_NAME,PREFIX_LIST_OUT_NAME(srcfilter));PREFIX_LIST_OUT(dstfilter)=P
REFIX_LIST_OUT(srcfilter);}if(FILTER_LIST_OUT_NAME(srcfilter)){FILTER_LIST_OUT_N
AME(dstfilter)=XSTRDUP(MTYPE_BGP_FILTER_NAME,FILTER_LIST_OUT_NAME(srcfilter));FI
LTER_LIST_OUT(dstfilter)=FILTER_LIST_OUT(srcfilter);}if(ROUTE_MAP_OUT_NAME(srcfi
lter)){ROUTE_MAP_OUT_NAME(dstfilter)=XSTRDUP(MTYPE_BGP_FILTER_NAME,ROUTE_MAP_OUT
_NAME(srcfilter));ROUTE_MAP_OUT(dstfilter)=ROUTE_MAP_OUT(srcfilter);}if(UNSUPPRE
SS_MAP_NAME(srcfilter)){UNSUPPRESS_MAP_NAME(dstfilter)=XSTRDUP(MTYPE_BGP_FILTER_
NAME,UNSUPPRESS_MAP_NAME(srcfilter));UNSUPPRESS_MAP(dstfilter)=UNSUPPRESS_MAP(sr
cfilter);}}/***sincewedidabunchofXSTRDUP'sinconf_copy,timetofreethemup*/staticvo
idconf_release(structpeer*src,afi_tafi,safi_tsafi){structbgp_filter*srcfilter;sr
cfilter=&src->filter[afi][safi];if(src->default_rmap[afi][safi].name)XFREE(MTYPE
_ROUTE_MAP_NAME,src->default_rmap[afi][safi].name);if(srcfilter->dlist[FILTER_OU
T].name)XFREE(MTYPE_BGP_FILTER_NAME,srcfilter->dlist[FILTER_OUT].name);if(srcfil
ter->plist[FILTER_OUT].name)XFREE(MTYPE_BGP_FILTER_NAME,srcfilter->plist[FILTER_
OUT].name);if(srcfilter->aslist[FILTER_OUT].name)XFREE(MTYPE_BGP_FILTER_NAME,src
filter->aslist[FILTER_OUT].name);if(srcfilter->map[RMAP_OUT].name)XFREE(MTYPE_BG
P_FILTER_NAME,srcfilter->map[RMAP_OUT].name);if(srcfilter->usmap.name)XFREE(MTYP
E_BGP_FILTER_NAME,srcfilter->usmap.name);if(src->host)XFREE(MTYPE_BGP_PEER_HOST,
src->host);src->host=NULL;}staticvoidpeer2_updgrp_copy(structupdate_group*updgrp
,structpeer_af*paf){structpeer*src;structpeer*dst;if(!updgrp||!paf)return;src=pa
f->peer;dst=updgrp->conf;if(!src||!dst)return;updgrp->afi=paf->afi;updgrp->safi=
paf->safi;updgrp->afid=paf->afid;updgrp->bgp=src->bgp;conf_copy(dst,src,paf->afi
,paf->safi);}/***auxiliaryfunctionstomaintainthehashtable.*-updgrp_hash_alloc-to
createanewentry,passedtohash_get*-updgrp_hash_key_make-makesthekeyforupdategroup
search*-updgrp_hash_cmp-comparetwoupdategroups.*/staticvoid*updgrp_hash_alloc(vo
id*p){structupdate_group*updgrp;conststructupdate_group*in;in=(conststructupdate
_group*)p;updgrp=XCALLOC(MTYPE_BGP_UPDGRP,sizeof(structupdate_group));memcpy(upd
grp,in,sizeof(structupdate_group));updgrp->conf=XCALLOC(MTYPE_BGP_PEER,sizeof(st
ructpeer));conf_copy(updgrp->conf,in->conf,in->afi,in->safi);returnupdgrp;}/***T
hehashvalueforapeeriscomputedfromthefollowingvariables:*v=f(*1.IBGP(1)orEBGP(2)*
2.FLAGSbasedonconfiguration:*LOCAL_AS_NO_PREPEND*LOCAL_AS_REPLACE_AS*3.AF_FLAGSb
asedonconfiguration:*Refertodefinitioninbgp_updgrp.h*4.(AF-independent)Capabilit
yflags:*AS4_RCVcapability*5.(AF-dependent)Capabilityflags:*ORF_PREFIX_SM_RCV(pee
rcansendprefixORF)*6.MRAI*7.peer-groupname*8.Outboundroute-mapname(neighborroute
-map<>out)*9.Outbounddistribute-listname(neighbordistribute-list<>out)*10.Outbou
ndprefix-listname(neighborprefix-list<>out)*11.Outboundas-listname(neighborfilte
r-list<>out)*12.Unsuppressmapname(neighborunsuppress-map<>)*13.defaultrmapname(n
eighbordefault-originateroute-map<>)*14.encodingbothglobalandlink-localnexthop?*
15.Ifpeerisconfiguredtobealonesoul,peeripaddress*16.Local-asshouldmatch,ifconfig
ured.*)*/staticunsignedintupdgrp_hash_key_make(void*p){conststructupdate_group*u
pdgrp;conststructpeer*peer;conststructbgp_filter*filter;uint32_tflags;uint32_tke
y;afi_tafi;safi_tsafi;#defineSEED1999331#defineSEED22147483647updgrp=p;peer=updg
rp->conf;afi=updgrp->afi;safi=updgrp->safi;flags=peer->af_flags[afi][safi];filte
r=&peer->filter[afi][safi];key=0;key=jhash_1word(peer->sort,key);/*EBGPorIBGP*/k
ey=jhash_1word((peer->flags&PEER_UPDGRP_FLAGS),key);key=jhash_1word((flags&PEER_
UPDGRP_AF_FLAGS),key);key=jhash_1word((peer->cap&PEER_UPDGRP_CAP_FLAGS),key);key
=jhash_1word((peer->af_cap[afi][safi]&PEER_UPDGRP_AF_CAP_FLAGS),key);key=jhash_1
word(peer->v_routeadv,key);key=jhash_1word(peer->change_local_as,key);if(peer->g
roup)key=jhash_1word(jhash(peer->group->name,strlen(peer->group->name),SEED1),ke
y);if(filter->map[RMAP_OUT].name)key=jhash_1word(jhash(filter->map[RMAP_OUT].nam
e,strlen(filter->map[RMAP_OUT].name),SEED1),key);if(filter->dlist[FILTER_OUT].na
me)key=jhash_1word(jhash(filter->dlist[FILTER_OUT].name,strlen(filter->dlist[FIL
TER_OUT].name),SEED1),key);if(filter->plist[FILTER_OUT].name)key=jhash_1word(jha
sh(filter->plist[FILTER_OUT].name,strlen(filter->plist[FILTER_OUT].name),SEED1),
key);if(filter->aslist[FILTER_OUT].name)key=jhash_1word(jhash(filter->aslist[FIL
TER_OUT].name,strlen(filter->aslist[FILTER_OUT].name),SEED1),key);if(filter->usm
ap.name)key=jhash_1word(jhash(filter->usmap.name,strlen(filter->usmap.name),SEED
1),key);if(peer->default_rmap[afi][safi].name)key=jhash_1word(jhash(peer->defaul
t_rmap[afi][safi].name,strlen(peer->default_rmap[afi][safi].name),SEED1),key);/*
IfpeerisonasharednetworkandisexchangingIPv6prefixes,*itneedstoincludelink-locala
ddress.That'sdifferentfrom*non-shared-networkpeers(nexthopencodedwith32bytesvs16
*bytes).Wecreatedifferentupdategroupstotakecareofthat.*/key=jhash_1word((peer->s
hared_network&&peer_afi_active_nego(peer,AFI_IP6)),key);/**Therearecertainpeerst
hatmustgettheirownupdate-group:*-lonesoulpeers*-peersthatnegotiatedORF*/if(CHECK
_FLAG(peer->flags,PEER_FLAG_LONESOUL)||CHECK_FLAG(peer->af_cap[afi][safi],PEER_C
AP_ORF_PREFIX_SM_RCV)||CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM
_OLD_RCV))key=jhash_1word(jhash(peer->host,strlen(peer->host),SEED2),key);return
key;}staticintupdgrp_hash_cmp(constvoid*p1,constvoid*p2){conststructupdate_group
*grp1;conststructupdate_group*grp2;conststructpeer*pe1;conststructpeer*pe2;uint3
2_tflags1;uint32_tflags2;conststructbgp_filter*fl1;conststructbgp_filter*fl2;afi
_tafi;safi_tsafi;if(!p1||!p2)return0;grp1=p1;grp2=p2;pe1=grp1->conf;pe2=grp2->co
nf;afi=grp1->afi;safi=grp1->safi;flags1=pe1->af_flags[afi][safi];flags2=pe2->af_
flags[afi][safi];fl1=&pe1->filter[afi][safi];fl2=&pe2->filter[afi][safi];/*putEB
GPandIBGPpeersindifferentupdategroups*/if(pe1->sort!=pe2->sort)return0;/*checkpe
erflags*/if((pe1->flags&PEER_UPDGRP_FLAGS)!=(pe2->flags&PEER_UPDGRP_FLAGS))retur
n0;/*Ifthereis'local-as'configured,itshouldmatch.*/if(pe1->change_local_as!=pe2-
>change_local_as)return0;/*flagslikeroutereflectorclient*/if((flags1&PEER_UPDGRP
_AF_FLAGS)!=(flags2&PEER_UPDGRP_AF_FLAGS))return0;if((pe1->cap&PEER_UPDGRP_CAP_F
LAGS)!=(pe2->cap&PEER_UPDGRP_CAP_FLAGS))return0;if((pe1->af_cap[afi][safi]&PEER_
UPDGRP_AF_CAP_FLAGS)!=(pe2->af_cap[afi][safi]&PEER_UPDGRP_AF_CAP_FLAGS))return0;
if(pe1->v_routeadv!=pe2->v_routeadv)return0;if(pe1->group!=pe2->group)return0;/*
route-mapnamesshouldbethesame*/if((fl1->map[RMAP_OUT].name&&!fl2->map[RMAP_OUT].
name)||(!fl1->map[RMAP_OUT].name&&fl2->map[RMAP_OUT].name)||(fl1->map[RMAP_OUT].
name&&fl2->map[RMAP_OUT].name&&strcmp(fl1->map[RMAP_OUT].name,fl2->map[RMAP_OUT]
.name)))return0;if((fl1->dlist[FILTER_OUT].name&&!fl2->dlist[FILTER_OUT].name)||
(!fl1->dlist[FILTER_OUT].name&&fl2->dlist[FILTER_OUT].name)||(fl1->dlist[FILTER_
OUT].name&&fl2->dlist[FILTER_OUT].name&&strcmp(fl1->dlist[FILTER_OUT].name,fl2->
dlist[FILTER_OUT].name)))return0;if((fl1->plist[FILTER_OUT].name&&!fl2->plist[FI
LTER_OUT].name)||(!fl1->plist[FILTER_OUT].name&&fl2->plist[FILTER_OUT].name)||(f
l1->plist[FILTER_OUT].name&&fl2->plist[FILTER_OUT].name&&strcmp(fl1->plist[FILTE
R_OUT].name,fl2->plist[FILTER_OUT].name)))return0;if((fl1->aslist[FILTER_OUT].na
me&&!fl2->aslist[FILTER_OUT].name)||(!fl1->aslist[FILTER_OUT].name&&fl2->aslist[
FILTER_OUT].name)||(fl1->aslist[FILTER_OUT].name&&fl2->aslist[FILTER_OUT].name&&
strcmp(fl1->aslist[FILTER_OUT].name,fl2->aslist[FILTER_OUT].name)))return0;if((f
l1->usmap.name&&!fl2->usmap.name)||(!fl1->usmap.name&&fl2->usmap.name)||(fl1->us
map.name&&fl2->usmap.name&&strcmp(fl1->usmap.name,fl2->usmap.name)))return0;if((
pe1->default_rmap[afi][safi].name&&!pe2->default_rmap[afi][safi].name)||(!pe1->d
efault_rmap[afi][safi].name&&pe2->default_rmap[afi][safi].name)||(pe1->default_r
map[afi][safi].name&&pe2->default_rmap[afi][safi].name&&strcmp(pe1->default_rmap
[afi][safi].name,pe2->default_rmap[afi][safi].name)))return0;if((afi==AFI_IP6)&&
(pe1->shared_network!=pe2->shared_network))return0;if((CHECK_FLAG(pe1->flags,PEE
R_FLAG_LONESOUL)||CHECK_FLAG(pe1->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_RCV)|
|CHECK_FLAG(pe1->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_OLD_RCV))&&!sockunion_
same(&pe1->su,&pe2->su))return0;return1;}staticvoidpeer_lonesoul_or_not(structpe
er*peer,intset){/*nochangeinstatus?*/if(set==(CHECK_FLAG(peer->flags,PEER_FLAG_L
ONESOUL)>0))return;if(set)SET_FLAG(peer->flags,PEER_FLAG_LONESOUL);elseUNSET_FLA
G(peer->flags,PEER_FLAG_LONESOUL);update_group_adjust_peer_afs(peer);}/**subgrou
p_total_packets_enqueued**Returnsthetotalnumberofpacketsenqueuedtoasubgroup.*/st
aticunsignedintsubgroup_total_packets_enqueued(structupdate_subgroup*subgrp){str
uctbpacket*pkt;pkt=bpacket_queue_last(SUBGRP_PKTQ(subgrp));returnpkt->ver-1;}sta
ticintupdate_group_show_walkcb(structupdate_group*updgrp,void*arg){structupdwalk
_context*ctx=arg;structvty*vty;structupdate_subgroup*subgrp;structpeer_af*paf;st
ructbgp_filter*filter;intmatch=0;if(!ctx)returnCMD_SUCCESS;if(ctx->subgrp_id){UP
DGRP_FOREACH_SUBGRP(updgrp,subgrp){if(ctx->subgrp_id&&(ctx->subgrp_id!=subgrp->i
d))continue;else{match=1;break;}}}else{match=1;}if(!match){/*Sincethisroutineisi
nvokedfromawalk,wecannotsignal*any*//*errorhere,canonlyreturn.*/returnCMD_SUCCES
S;}vty=ctx->vty;vty_out(vty,"Update-group%"PRIu64":\n",updgrp->id);vty_out(vty,"
Created:%s",timestamp_string(updgrp->uptime));filter=&updgrp->conf->filter[updgr
p->afi][updgrp->safi];if(filter->map[RMAP_OUT].name)vty_out(vty,"Outgoingroutema
p:%s%s\n",filter->map[RMAP_OUT].map?"X":"",filter->map[RMAP_OUT].name);vty_out(v
ty,"MRAIvalue(seconds):%d\n",updgrp->conf->v_routeadv);if(updgrp->conf->change_l
ocal_as)vty_out(vty,"LocalAS%u%s%s\n",updgrp->conf->change_local_as,CHECK_FLAG(u
pdgrp->conf->flags,PEER_FLAG_LOCAL_AS_NO_PREPEND)?"no-prepend":"",CHECK_FLAG(upd
grp->conf->flags,PEER_FLAG_LOCAL_AS_REPLACE_AS)?"replace-as":"");UPDGRP_FOREACH_
SUBGRP(updgrp,subgrp){if(ctx->subgrp_id&&(ctx->subgrp_id!=subgrp->id))continue;v
ty_out(vty,"\n");vty_out(vty,"Update-subgroup%"PRIu64":\n",subgrp->id);vty_out(v
ty,"Created:%s",timestamp_string(subgrp->uptime));if(subgrp->split_from.update_g
roup_id||subgrp->split_from.subgroup_id){vty_out(vty,"Splitfromgroupid:%"PRIu64"
\n",subgrp->split_from.update_group_id);vty_out(vty,"Splitfromsubgroupid:%"PRIu6
4"\n",subgrp->split_from.subgroup_id);}vty_out(vty,"Joinevents:%u\n",subgrp->joi
n_events);vty_out(vty,"Pruneevents:%u\n",subgrp->prune_events);vty_out(vty,"Merg
eevents:%u\n",subgrp->merge_events);vty_out(vty,"Splitevents:%u\n",subgrp->split
_events);vty_out(vty,"Updategroupswitchevents:%u\n",subgrp->updgrp_switch_events
);vty_out(vty,"Peerrefreshescombined:%u\n",subgrp->peer_refreshes_combined);vty_
out(vty,"Mergecheckstriggered:%u\n",subgrp->merge_checks_triggered);vty_out(vty,
"Version:%"PRIu64"\n",subgrp->version);vty_out(vty,"Packetqueuelength:%d\n",bpac
ket_queue_length(SUBGRP_PKTQ(subgrp)));vty_out(vty,"Totalpacketsenqueued:%u\n",s
ubgroup_total_packets_enqueued(subgrp));vty_out(vty,"Packetqueuehighwatermark:%d
\n",bpacket_queue_hwm_length(SUBGRP_PKTQ(subgrp)));vty_out(vty,"Adj-outlistcount
:%u\n",subgrp->adj_count);vty_out(vty,"Advertiselist:%s\n",advertise_list_is_emp
ty(subgrp)?"empty":"notempty");vty_out(vty,"Flags:%s\n",CHECK_FLAG(subgrp->flags
,SUBGRP_FLAG_NEEDS_REFRESH)?"R":"");if(subgrp->peer_count>0){vty_out(vty,"Peers:
\n");SUBGRP_FOREACH_PEER(subgrp,paf)vty_out(vty,"-%s\n",paf->peer->host);}}retur
nUPDWALK_CONTINUE;}/**Helperfunctiontoshowthepacketqueueforeachsubgroupofupdateg
roup.*Willbeconstrainedtoaparticularsubgroupidifid!=0*/staticintupdgrp_show_pack
et_queue_walkcb(structupdate_group*updgrp,void*arg){structupdwalk_context*ctx=ar
g;structupdate_subgroup*subgrp;structvty*vty;vty=ctx->vty;UPDGRP_FOREACH_SUBGRP(
updgrp,subgrp){if(ctx->subgrp_id&&(ctx->subgrp_id!=subgrp->id))continue;vty_out(
vty,"updategroup%"PRIu64",subgroup%"PRIu64"\n",updgrp->id,subgrp->id);bpacket_qu
eue_show_vty(SUBGRP_PKTQ(subgrp),vty);}returnUPDWALK_CONTINUE;}/**Showthepacketq
ueueforeachsubgroupofupdategroup.Willbe*constrainedtoaparticularsubgroupidifid!=
0*/voidupdate_group_show_packet_queue(structbgp*bgp,afi_tafi,safi_tsafi,structvt
y*vty,uint64_tid){structupdwalk_contextctx;memset(&ctx,0,sizeof(ctx));ctx.vty=vt
y;ctx.subgrp_id=id;ctx.flags=0;update_group_af_walk(bgp,afi,safi,updgrp_show_pac
ket_queue_walkcb,&ctx);}staticstructupdate_group*update_group_find(structpeer_af
*paf){structupdate_group*updgrp;structupdate_grouptmp;structpeertmp_conf;if(!pee
r_established(PAF_PEER(paf)))returnNULL;memset(&tmp,0,sizeof(tmp));memset(&tmp_c
onf,0,sizeof(tmp_conf));tmp.conf=&tmp_conf;peer2_updgrp_copy(&tmp,paf);updgrp=ha
sh_lookup(paf->peer->bgp->update_groups[paf->afid],&tmp);conf_release(&tmp_conf,
paf->afi,paf->safi);returnupdgrp;}staticstructupdate_group*update_group_create(s
tructpeer_af*paf){structupdate_group*updgrp;structupdate_grouptmp;structpeertmp_
conf;memset(&tmp,0,sizeof(tmp));memset(&tmp_conf,0,sizeof(tmp_conf));tmp.conf=&t
mp_conf;peer2_updgrp_copy(&tmp,paf);updgrp=hash_get(paf->peer->bgp->update_group
s[paf->afid],&tmp,updgrp_hash_alloc);if(!updgrp)returnNULL;update_group_checkin(
updgrp);if(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("createupdategroup%
"PRIu64,updgrp->id);UPDGRP_GLOBAL_STAT(updgrp,updgrps_created)+=1;conf_release(&
tmp_conf,paf->afi,paf->safi);returnupdgrp;}staticvoidupdate_group_delete(structu
pdate_group*updgrp){if(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("delete
updategroup%"PRIu64,updgrp->id);UPDGRP_GLOBAL_STAT(updgrp,updgrps_deleted)+=1;ha
sh_release(updgrp->bgp->update_groups[updgrp->afid],updgrp);conf_release(updgrp-
>conf,updgrp->afi,updgrp->safi);if(updgrp->conf->host)XFREE(MTYPE_BGP_PEER_HOST,
updgrp->conf->host);updgrp->conf->host=NULL;if(updgrp->conf->ifname)XFREE(MTYPE_
BGP_PEER_IFNAME,updgrp->conf->ifname);XFREE(MTYPE_BGP_PEER,updgrp->conf);XFREE(M
TYPE_BGP_UPDGRP,updgrp);}staticvoidupdate_group_add_subgroup(structupdate_group*
updgrp,structupdate_subgroup*subgrp){if(!updgrp||!subgrp)return;LIST_INSERT_HEAD
(&(updgrp->subgrps),subgrp,updgrp_train);subgrp->update_group=updgrp;}staticvoid
update_group_remove_subgroup(structupdate_group*updgrp,structupdate_subgroup*sub
grp){if(!updgrp||!subgrp)return;LIST_REMOVE(subgrp,updgrp_train);subgrp->update_
group=NULL;if(LIST_EMPTY(&(updgrp->subgrps)))update_group_delete(updgrp);}static
structupdate_subgroup*update_subgroup_create(structupdate_group*updgrp){structup
date_subgroup*subgrp;subgrp=XCALLOC(MTYPE_BGP_UPD_SUBGRP,sizeof(structupdate_sub
group));update_subgroup_checkin(subgrp,updgrp);subgrp->v_coalesce=(UPDGRP_INST(u
pdgrp))->coalesce_time;sync_init(subgrp);bpacket_queue_init(SUBGRP_PKTQ(subgrp))
;bpacket_queue_add(SUBGRP_PKTQ(subgrp),NULL,NULL);TAILQ_INIT(&(subgrp->adjq));if
(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("createsubgroupu%"PRIu64":s%"
PRIu64,updgrp->id,subgrp->id);update_group_add_subgroup(updgrp,subgrp);UPDGRP_IN
CR_STAT(updgrp,subgrps_created);returnsubgrp;}staticvoidupdate_subgroup_delete(s
tructupdate_subgroup*subgrp){if(!subgrp)return;if(subgrp->update_group)UPDGRP_IN
CR_STAT(subgrp->update_group,subgrps_deleted);if(subgrp->t_merge_check)THREAD_OF
F(subgrp->t_merge_check);if(subgrp->t_coalesce)THREAD_TIMER_OFF(subgrp->t_coales
ce);bpacket_queue_cleanup(SUBGRP_PKTQ(subgrp));subgroup_clear_table(subgrp);if(s
ubgrp->t_coalesce)THREAD_TIMER_OFF(subgrp->t_coalesce);sync_delete(subgrp);if(BG
P_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("deletesubgroupu%"PRIu64":s%"PRI
u64,subgrp->update_group->id,subgrp->id);update_group_remove_subgroup(subgrp->up
date_group,subgrp);XFREE(MTYPE_BGP_UPD_SUBGRP,subgrp);}voidupdate_subgroup_inher
it_info(structupdate_subgroup*to,structupdate_subgroup*from){if(!to||!from)retur
n;to->sflags=from->sflags;}/**update_subgroup_check_delete**Deleteasubgroupifiti
sreadytobedeleted.**ReturnsTRUEifthesubgroupwasdeleted.*/staticintupdate_subgrou
p_check_delete(structupdate_subgroup*subgrp){if(!subgrp)return0;if(!LIST_EMPTY(&
(subgrp->peers)))return0;update_subgroup_delete(subgrp);return1;}/**update_subgr
oup_add_peer**@paramsend_enqueued_packetsIftrueallcurrentlyenqueuedpacketswill*a
lsobesenttothepeer.*/staticvoidupdate_subgroup_add_peer(structupdate_subgroup*su
bgrp,structpeer_af*paf,intsend_enqueued_pkts){structbpacket*pkt;if(!subgrp||!paf
)return;LIST_INSERT_HEAD(&(subgrp->peers),paf,subgrp_train);paf->subgroup=subgrp
;subgrp->peer_count++;if(bgp_debug_peer_updout_enabled(paf->peer->host)){UPDGRP_
PEER_DBG_EN(subgrp->update_group);}SUBGRP_INCR_STAT(subgrp,join_events);if(send_
enqueued_pkts){pkt=bpacket_queue_first(SUBGRP_PKTQ(subgrp));}else{/**Hangthepeer
offofthelast,placeholder,packetinthe*queue.Thismeansitwon'tseeanyofthepacketstha
tare*currentlythequeue.*/pkt=bpacket_queue_last(SUBGRP_PKTQ(subgrp));assert(pkt-
>buffer==NULL);}bpacket_add_peer(pkt,paf);bpacket_queue_sanity_check(SUBGRP_PKTQ
(subgrp));}/**update_subgroup_remove_peer_internal**Internalfunctionthatremovesa
peerfromasubgroup,butdoesnot*deletethesubgroup.Acalltothisfunctionmustalmostalwa
ysbe*followedbyacalltoupdate_subgroup_check_delete().**@seeupdate_subgroup_remov
e_peer*/staticvoidupdate_subgroup_remove_peer_internal(structupdate_subgroup*sub
grp,structpeer_af*paf){assert(subgrp&&paf);if(bgp_debug_peer_updout_enabled(paf-
>peer->host)){UPDGRP_PEER_DBG_DIS(subgrp->update_group);}bpacket_queue_remove_pe
er(paf);LIST_REMOVE(paf,subgrp_train);paf->subgroup=NULL;subgrp->peer_count--;SU
BGRP_INCR_STAT(subgrp,prune_events);}/**update_subgroup_remove_peer*/voidupdate_
subgroup_remove_peer(structupdate_subgroup*subgrp,structpeer_af*paf){if(!subgrp|
|!paf)return;update_subgroup_remove_peer_internal(subgrp,paf);if(update_subgroup
_check_delete(subgrp))return;/**Thedeletionofthepeermayhavecausedsomepacketstobe
*deletedfromthesubgrouppacketqueue.Checkifthesubgroupcan*bemergednow.*/update_su
bgroup_check_merge(subgrp,"removedpeerfromsubgroup");}staticstructupdate_subgrou
p*update_subgroup_find(structupdate_group*updgrp,structpeer_af*paf){structupdate
_subgroup*subgrp=NULL;uint64_tversion;if(paf->subgroup){assert(0);returnNULL;}el
seversion=0;if(!peer_established(PAF_PEER(paf)))returnNULL;UPDGRP_FOREACH_SUBGRP
(updgrp,subgrp){if(subgrp->version!=version||CHECK_FLAG(subgrp->sflags,SUBGRP_ST
ATUS_DEFAULT_ORIGINATE))continue;/**Theversionnumberisnotmeaningfulonasubgroupth
atneeds*arefresh.*/if(update_subgroup_needs_refresh(subgrp))continue;break;}retu
rnsubgrp;}/**update_subgroup_ready_for_merge**ReturnsTRUEifthissubgroupisinastat
ethatallowsittobe*mergedintoanothersubgroup.*/staticintupdate_subgroup_ready_for
_merge(structupdate_subgroup*subgrp){/**Notreadyifthereareanyencodedpacketswaiti
ngtobewritten*outtopeers.*/if(!bpacket_queue_is_empty(SUBGRP_PKTQ(subgrp)))retur
n0;/**Notreadyifthereenqueuedupdateswaitingtobeencoded.*/if(!advertise_list_is_e
mpty(subgrp))return0;/**Don'tattempttomergeasubgroupthatneedsarefresh.Forone,*we
can'tdetermineiftheadj_outofsuchagroupmatchesthatof*anothergroup.*/if(update_sub
group_needs_refresh(subgrp))return0;return1;}/**update_subgrp_can_merge_into**Re
turnsTRUEifthefirstsubgroupcanmergeintothesecond*subgroup.*/staticintupdate_subg
roup_can_merge_into(structupdate_subgroup*subgrp,structupdate_subgroup*target){i
f(subgrp==target)return0;/**BothmusthaveprocessedtheBRIBtothesamepointinorderto*
bemerged.*/if(subgrp->version!=target->version)return0;if(CHECK_FLAG(subgrp->sfl
ags,SUBGRP_STATUS_DEFAULT_ORIGINATE)!=CHECK_FLAG(target->sflags,SUBGRP_STATUS_DE
FAULT_ORIGINATE))return0;if(subgrp->adj_count!=target->adj_count)return0;returnu
pdate_subgroup_ready_for_merge(target);}/**update_subgroup_merge**Mergethefirsts
ubgroupintothesecondone.*/staticvoidupdate_subgroup_merge(structupdate_subgroup*
subgrp,structupdate_subgroup*target,constchar*reason){structpeer_af*paf;intresul
t;intpeer_count;assert(subgrp->adj_count==target->adj_count);peer_count=subgrp->
peer_count;while(1){paf=LIST_FIRST(&subgrp->peers);if(!paf)break;update_subgroup
_remove_peer_internal(subgrp,paf);/**Addthepeertothetargetsubgroup,whilemakingsu
rethat*anycurrentlyenqueuedpacketswon'tbesenttoit.Enqueued*packetscould,forexamp
le,resultinanunnecessarywithdraw*followedbyanadvertise.*/update_subgroup_add_pee
r(target,paf,0);}SUBGRP_INCR_STAT(target,merge_events);if(BGP_DEBUG(update_group
s,UPDATE_GROUPS))zlog_debug("u%"PRIu64":s%"PRIu64"(%dpeers)mergedintou%"PRIu64":
s%"PRIu64",""trigger:%s",subgrp->update_group->id,subgrp->id,peer_count,target->
update_group->id,target->id,reason?reason:"unknown");result=update_subgroup_chec
k_delete(subgrp);assert(result);}/**update_subgroup_check_merge**Mergethissubgro
upintoanothersubgroupifpossible.**ReturnsTRUEifthesubgrouphasbeenmerged.Thesubgr
ouppointer*shouldnotbeaccessedinthiscase.*/intupdate_subgroup_check_merge(struct
update_subgroup*subgrp,constchar*reason){structupdate_subgroup*target;if(!update
_subgroup_ready_for_merge(subgrp))return0;/**Lookforasubgrouptomergeinto.*/UPDGR
P_FOREACH_SUBGRP(subgrp->update_group,target){if(update_subgroup_can_merge_into(
subgrp,target))break;}if(!target)return0;update_subgroup_merge(subgrp,target,rea
son);return1;}/**update_subgroup_merge_check_thread_cb*/staticintupdate_subgroup
_merge_check_thread_cb(structthread*thread){structupdate_subgroup*subgrp;subgrp=
THREAD_ARG(thread);subgrp->t_merge_check=NULL;update_subgroup_check_merge(subgrp
,"triggeredmergecheck");return0;}/**update_subgroup_trigger_merge_check**Trigger
sacalltoupdate_subgroup_check_merge()onacleancontext.**@paramforceIftrue,themerg
echeckwillbetriggeredevenifthe*subgroupdoesn'tcurrentlylookreadyforamerge.**Retu
rnsTRUEifamergecheckwillbeperformedshortly.*/intupdate_subgroup_trigger_merge_ch
eck(structupdate_subgroup*subgrp,intforce){if(subgrp->t_merge_check)return1;if(!
force&&!update_subgroup_ready_for_merge(subgrp))return0;subgrp->t_merge_check=NU
LL;thread_add_timer_msec(bm->master,update_subgroup_merge_check_thread_cb,subgrp
,0,&subgrp->t_merge_check);SUBGRP_INCR_STAT(subgrp,merge_checks_triggered);retur
n1;}/**update_subgroup_copy_adj_out**Helperfunctionthatclonestheadjout(stateabou
tadvertised*routes)fromonesubgrouptoanother.Itassumesthattheadjout*ofthetargetsu
bgroupisempty.*/staticvoidupdate_subgroup_copy_adj_out(structupdate_subgroup*sou
rce,structupdate_subgroup*dest){structbgp_adj_out*aout,*aout_copy;SUBGRP_FOREACH
_ADJ(source,aout){/**Copytheadjout.*/aout_copy=bgp_adj_out_alloc(dest,aout->rn,a
out->addpath_tx_id);aout_copy->attr=aout->attr?bgp_attr_intern(aout->attr):NULL;
}}/**update_subgroup_copy_packets**Copypacketsafterandincludingthegivenpackettot
hesubgroup*'dest'.**Returnsthenumberofpacketscopied.*/staticintupdate_subgroup_c
opy_packets(structupdate_subgroup*dest,structbpacket*pkt){intcount;count=0;while
(pkt&&pkt->buffer){bpacket_queue_add(SUBGRP_PKTQ(dest),stream_dup(pkt->buffer),&
pkt->arr);count++;pkt=bpacket_next(pkt);}bpacket_queue_sanity_check(SUBGRP_PKTQ(
dest));returncount;}staticintupdgrp_prefix_list_update(structupdate_group*updgrp
,constchar*name){structpeer*peer;structbgp_filter*filter;peer=UPDGRP_PEER(updgrp
);filter=&peer->filter[UPDGRP_AFI(updgrp)][UPDGRP_SAFI(updgrp)];if(PREFIX_LIST_O
UT_NAME(filter)&&(strcmp(name,PREFIX_LIST_OUT_NAME(filter))==0)){PREFIX_LIST_OUT
(filter)=prefix_list_lookup(UPDGRP_AFI(updgrp),PREFIX_LIST_OUT_NAME(filter));ret
urn1;}return0;}staticintupdgrp_filter_list_update(structupdate_group*updgrp,cons
tchar*name){structpeer*peer;structbgp_filter*filter;peer=UPDGRP_PEER(updgrp);fil
ter=&peer->filter[UPDGRP_AFI(updgrp)][UPDGRP_SAFI(updgrp)];if(FILTER_LIST_OUT_NA
ME(filter)&&(strcmp(name,FILTER_LIST_OUT_NAME(filter))==0)){FILTER_LIST_OUT(filt
er)=as_list_lookup(FILTER_LIST_OUT_NAME(filter));return1;}return0;}staticintupdg
rp_distribute_list_update(structupdate_group*updgrp,constchar*name){structpeer*p
eer;structbgp_filter*filter;peer=UPDGRP_PEER(updgrp);filter=&peer->filter[UPDGRP
_AFI(updgrp)][UPDGRP_SAFI(updgrp)];if(DISTRIBUTE_OUT_NAME(filter)&&(strcmp(name,
DISTRIBUTE_OUT_NAME(filter))==0)){DISTRIBUTE_OUT(filter)=access_list_lookup(UPDG
RP_AFI(updgrp),DISTRIBUTE_OUT_NAME(filter));return1;}return0;}staticintupdgrp_ro
ute_map_update(structupdate_group*updgrp,constchar*name,int*def_rmap_changed){st
ructpeer*peer;structbgp_filter*filter;intchanged=0;afi_tafi;safi_tsafi;peer=UPDG
RP_PEER(updgrp);afi=UPDGRP_AFI(updgrp);safi=UPDGRP_SAFI(updgrp);filter=&peer->fi
lter[afi][safi];if(ROUTE_MAP_OUT_NAME(filter)&&(strcmp(name,ROUTE_MAP_OUT_NAME(f
ilter))==0)){ROUTE_MAP_OUT(filter)=route_map_lookup_by_name(name);changed=1;}if(
UNSUPPRESS_MAP_NAME(filter)&&(strcmp(name,UNSUPPRESS_MAP_NAME(filter))==0)){UNSU
PPRESS_MAP(filter)=route_map_lookup_by_name(name);changed=1;}/*processdefault-or
iginateroute-map*/if(peer->default_rmap[afi][safi].name&&(strcmp(name,peer->defa
ult_rmap[afi][safi].name)==0)){peer->default_rmap[afi][safi].map=route_map_looku
p_by_name(name);if(def_rmap_changed)*def_rmap_changed=1;}returnchanged;}/**hashi
terationcallbackfunctiontoprocessapolicychangeforan*updategroup.Checkifthechange
dpolicymatchestheupdgrp's*outboundroute-maporunsuppress-mapordefault-originatema
por*filter-listorprefix-listordistribute-list.*Triggerupdategenerationaccordingl
y.*/staticintupdgrp_policy_update_walkcb(structupdate_group*updgrp,void*arg){str
uctupdwalk_context*ctx=arg;structupdate_subgroup*subgrp;intchanged=0;intdef_chan
ged=0;if(!updgrp||!ctx||!ctx->policy_name)returnUPDWALK_CONTINUE;switch(ctx->pol
icy_type){caseBGP_POLICY_ROUTE_MAP:changed=updgrp_route_map_update(updgrp,ctx->p
olicy_name,&def_changed);break;caseBGP_POLICY_FILTER_LIST:changed=updgrp_filter_
list_update(updgrp,ctx->policy_name);break;caseBGP_POLICY_PREFIX_LIST:changed=up
dgrp_prefix_list_update(updgrp,ctx->policy_name);break;caseBGP_POLICY_DISTRIBUTE
_LIST:changed=updgrp_distribute_list_update(updgrp,ctx->policy_name);break;defau
lt:break;}/*Ifnotdoingrouteupdate,returnafterupdating"config"*/if(!ctx->policy_r
oute_update)returnUPDWALK_CONTINUE;/*Ifnothinghaschanged,returnafterupdating"con
fig"*/if(!changed&&!def_changed)returnUPDWALK_CONTINUE;/**Ifsomethinghaschanged,
atthebeginningofaroute-map*modification*event,markeachsubgroup'sneeds-refreshbit
.Forone,itsignalsto*whoeverthatthesubgroupneedsarefresh.Second,itprevents*premat
ure*mergeofthissubgroupwithanotherbeforeacomplete(outbound)*refresh.*/if(ctx->po
licy_event_start_flag){UPDGRP_FOREACH_SUBGRP(updgrp,subgrp){update_subgroup_set_
needs_refresh(subgrp,1);}returnUPDWALK_CONTINUE;}UPDGRP_FOREACH_SUBGRP(updgrp,su
bgrp){if(changed){if(bgp_debug_update(NULL,NULL,updgrp,0))zlog_debug("u%"PRIu64"
:s%"PRIu64"announcingroutesuponpolicy%s(type%d)change",updgrp->id,subgrp->id,ctx
->policy_name,ctx->policy_type);subgroup_announce_route(subgrp);}if(def_changed)
{if(bgp_debug_update(NULL,NULL,updgrp,0))zlog_debug("u%"PRIu64":s%"PRIu64"announ
cingdefaultupondefaultroutemap%schange",updgrp->id,subgrp->id,ctx->policy_name);
subgroup_default_originate(subgrp,0);}update_subgroup_set_needs_refresh(subgrp,0
);}returnUPDWALK_CONTINUE;}staticintupdate_group_walkcb(structhash_backet*backet
,void*arg){structupdate_group*updgrp=backet->data;structupdwalk_context*wctx=arg
;intret=(*wctx->cb)(updgrp,wctx->context);returnret;}staticintupdate_group_perio
dic_merge_walkcb(structupdate_group*updgrp,void*arg){structupdate_subgroup*subgr
p;structupdate_subgroup*tmp_subgrp;constchar*reason=arg;UPDGRP_FOREACH_SUBGRP_SA
FE(updgrp,subgrp,tmp_subgrp)update_subgroup_check_merge(subgrp,reason);returnUPD
WALK_CONTINUE;}/*********************PUBLICFUNCTIONS********************//**trig
gerfunctionwhenapolicy(route-map/filter-list/prefix-list/*distribute-listetc.)co
ntentchanges.Gothroughallthe*updategroupsandprocessthechange.**bgp:thebgpinstanc
e*ptype:thetypeofpolicythatgotmodified,seebgpd.h*pname:nameofthepolicy*route_upd
ate:flagtocontrolifanautomaticupdategenerationshould*occur*start_event:flagthati
ndicatesifit'sthebeginningofthechange.*Esp.whentheuserischangingthecontentintera
ctively*overmultiplestatements.Usefultosetdirtyflagon*updategroups.*/voidupdate_
group_policy_update(structbgp*bgp,bgp_policy_type_eptype,constchar*pname,introut
e_update,intstart_event){structupdwalk_contextctx;memset(&ctx,0,sizeof(ctx));ctx
.policy_type=ptype;ctx.policy_name=pname;ctx.policy_route_update=route_update;ct
x.policy_event_start_flag=start_event;ctx.flags=0;update_group_walk(bgp,updgrp_p
olicy_update_walkcb,&ctx);}/**update_subgroup_split_peer**Ensurethatthegivenpeer
isinasubgroupofitsowninthe*specifiedupdategroup.*/voidupdate_subgroup_split_peer
(structpeer_af*paf,structupdate_group*updgrp){structupdate_subgroup*old_subgrp,*
subgrp;uint64_told_id;old_subgrp=paf->subgroup;if(!updgrp)updgrp=old_subgrp->upd
ate_group;/**Ifthepeerisaloneinitssubgroup,reusetheexisting*subgroup.*/if(old_su
bgrp->peer_count==1){if(updgrp==old_subgrp->update_group)return;subgrp=old_subgr
p;old_id=old_subgrp->update_group->id;if(bgp_debug_peer_updout_enabled(paf->peer
->host)){UPDGRP_PEER_DBG_DIS(old_subgrp->update_group);}update_group_remove_subg
roup(old_subgrp->update_group,old_subgrp);update_group_add_subgroup(updgrp,subgr
p);if(bgp_debug_peer_updout_enabled(paf->peer->host)){UPDGRP_PEER_DBG_EN(updgrp)
;}if(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("u%"PRIu64":s%"PRIu64"pee
r%smovedtou%"PRIu64":s%"PRIu64,old_id,subgrp->id,paf->peer->host,updgrp->id,subg
rp->id);/**Thestateofthesubgroup(adj_out,advs,packetqueueetc)*isconsistentintern
ally,butmaynotbeidenticaltoother*subgroupsinthenewupdategroupeveniftheversionnum
ber*matchesup.Makesureafullrefreshisdonebeforethe*subgroupismergedwithanother.*/
update_subgroup_set_needs_refresh(subgrp,1);SUBGRP_INCR_STAT(subgrp,updgrp_switc
h_events);return;}/**Createanewsubgroupunderthespecifiedupdategroup,andcopy*over
relevantstatetoit.*/subgrp=update_subgroup_create(updgrp);update_subgroup_inheri
t_info(subgrp,old_subgrp);subgrp->split_from.update_group_id=old_subgrp->update_
group->id;subgrp->split_from.subgroup_id=old_subgrp->id;/**Copyoutrelevantstatef
romtheoldsubgroup.*/update_subgroup_copy_adj_out(paf->subgroup,subgrp);update_su
bgroup_copy_packets(subgrp,paf->next_pkt_to_send);if(BGP_DEBUG(update_groups,UPD
ATE_GROUPS))zlog_debug("u%"PRIu64":s%"PRIu64"peer%ssplitandmovedintou%"PRIu64":s
%"PRIu64,paf->subgroup->update_group->id,paf->subgroup->id,paf->peer->host,updgr
p->id,subgrp->id);SUBGRP_INCR_STAT(paf->subgroup,split_events);/**Sincequeuedadv
swereleftbehind,thisnewsubgroupneedsa*refresh.*/update_subgroup_set_needs_refres
h(subgrp,1);/**Removepeerfromoldsubgroup,andaddittothenewone.*/update_subgroup_r
emove_peer(paf->subgroup,paf);update_subgroup_add_peer(subgrp,paf,1);}voidupdate
_bgp_group_init(structbgp*bgp){intafid;AF_FOREACH(afid)bgp->update_groups[afid]=
hash_create(updgrp_hash_key_make,updgrp_hash_cmp,"BGPUpdateGroupHash");}voidupda
te_bgp_group_free(structbgp*bgp){intafid;AF_FOREACH(afid){if(bgp->update_groups[
afid]){hash_free(bgp->update_groups[afid]);bgp->update_groups[afid]=NULL;}}}void
update_group_show(structbgp*bgp,afi_tafi,safi_tsafi,structvty*vty,uint64_tsubgrp
_id){structupdwalk_contextctx;memset(&ctx,0,sizeof(ctx));ctx.vty=vty;ctx.subgrp_
id=subgrp_id;update_group_af_walk(bgp,afi,safi,update_group_show_walkcb,&ctx);}/
**update_group_show_stats**Showglobalstatisticsaboutupdategroups.*/voidupdate_gr
oup_show_stats(structbgp*bgp,structvty*vty){vty_out(vty,"Updategroupscreated:%u\
n",bgp->update_group_stats.updgrps_created);vty_out(vty,"Updategroupsdeleted:%u\
n",bgp->update_group_stats.updgrps_deleted);vty_out(vty,"Updatesubgroupscreated:
%u\n",bgp->update_group_stats.subgrps_created);vty_out(vty,"Updatesubgroupsdelet
ed:%u\n",bgp->update_group_stats.subgrps_deleted);vty_out(vty,"Joinevents:%u\n",
bgp->update_group_stats.join_events);vty_out(vty,"Pruneevents:%u\n",bgp->update_
group_stats.prune_events);vty_out(vty,"Mergeevents:%u\n",bgp->update_group_stats
.merge_events);vty_out(vty,"Splitevents:%u\n",bgp->update_group_stats.split_even
ts);vty_out(vty,"Updategroupswitchevents:%u\n",bgp->update_group_stats.updgrp_sw
itch_events);vty_out(vty,"Peerrouterefreshescombined:%u\n",bgp->update_group_sta
ts.peer_refreshes_combined);vty_out(vty,"Mergecheckstriggered:%u\n",bgp->update_
group_stats.merge_checks_triggered);}/**update_group_adjust_peer*/voidupdate_gro
up_adjust_peer(structpeer_af*paf){structupdate_group*updgrp;structupdate_subgrou
p*subgrp,*old_subgrp;structpeer*peer;if(!paf)return;peer=PAF_PEER(paf);if(!peer_
established(peer)){return;}if(!CHECK_FLAG(peer->flags,PEER_FLAG_CONFIG_NODE)){re
turn;}if(!peer->afc_nego[paf->afi][paf->safi]){return;}updgrp=update_group_find(
paf);if(!updgrp){updgrp=update_group_create(paf);if(!updgrp){zlog_err("couldn'tc
reateupdategroupforpeer%s",paf->peer->host);return;}}old_subgrp=paf->subgroup;if
(old_subgrp){/**Iftheupdategroupofthepeerisunchanged,thepeercan*stay*initsexisti
ngsubgroupandwe'redone.*/if(old_subgrp->update_group==updgrp)return;/**Thepeeris
switchingbetweenupdategroups.Putitinits*ownsubgroupunderthenewupdategroup.*/upda
te_subgroup_split_peer(paf,updgrp);return;}subgrp=update_subgroup_find(updgrp,pa
f);if(!subgrp){subgrp=update_subgroup_create(updgrp);if(!subgrp)return;}update_s
ubgroup_add_peer(subgrp,paf,1);if(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_de
bug("u%"PRIu64":s%"PRIu64"addpeer%s",updgrp->id,subgrp->id,paf->peer->host);retu
rn;}intupdate_group_adjust_soloness(structpeer*peer,intset){structpeer_group*gro
up;structlistnode*node,*nnode;if(!CHECK_FLAG(peer->sflags,PEER_STATUS_GROUP)){pe
er_lonesoul_or_not(peer,set);if(peer->status==Established)bgp_announce_route_all
(peer);}else{group=peer->group;for(ALL_LIST_ELEMENTS(group->peer,node,nnode,peer
)){peer_lonesoul_or_not(peer,set);if(peer->status==Established)bgp_announce_rout
e_all(peer);}}return0;}/**update_subgroup_rib*/structbgp_table*update_subgroup_r
ib(structupdate_subgroup*subgrp){structbgp*bgp;bgp=SUBGRP_INST(subgrp);if(!bgp)r
eturnNULL;returnbgp->rib[SUBGRP_AFI(subgrp)][SUBGRP_SAFI(subgrp)];}voidupdate_gr
oup_af_walk(structbgp*bgp,afi_tafi,safi_tsafi,updgrp_walkcbcb,void*ctx){structup
dwalk_contextwctx;intafid;if(!bgp)return;afid=afindex(afi,safi);if(afid>=BGP_AF_
MAX)return;memset(&wctx,0,sizeof(wctx));wctx.cb=cb;wctx.context=ctx;if(bgp->upda
te_groups[afid])hash_walk(bgp->update_groups[afid],update_group_walkcb,&wctx);}v
oidupdate_group_walk(structbgp*bgp,updgrp_walkcbcb,void*ctx){afi_tafi;safi_tsafi
;FOREACH_AFI_SAFI(afi,safi){update_group_af_walk(bgp,afi,safi,cb,ctx);}}voidupda
te_group_periodic_merge(structbgp*bgp){charreason[]="periodicmergecheck";update_
group_walk(bgp,update_group_periodic_merge_walkcb,(void*)reason);}staticintupdat
e_group_default_originate_route_map_walkcb(structupdate_group*updgrp,void*arg){s
tructupdate_subgroup*subgrp;structpeer*peer;afi_tafi;safi_tsafi;UPDGRP_FOREACH_S
UBGRP(updgrp,subgrp){peer=SUBGRP_PEER(subgrp);afi=SUBGRP_AFI(subgrp);safi=SUBGRP
_SAFI(subgrp);if(peer->default_rmap[afi][safi].name){subgroup_default_originate(
subgrp,0);}}returnUPDWALK_CONTINUE;}intupdate_group_refresh_default_originate_ro
ute_map(structthread*thread){structbgp*bgp;charreason[]="refreshdefault-originat
eroute-map";bgp=THREAD_ARG(thread);update_group_walk(bgp,update_group_default_or
iginate_route_map_walkcb,reason);THREAD_TIMER_OFF(bgp->t_rmap_def_originate_eval
);bgp_unlock(bgp);return(0);}/**peer_af_announce_route**Refreshesroutesouttoapee
r_afimmediately.**IfthecombineparameterisTRUE,thenthisfunctionwilltryto*gatherot
herpeersinthesubgroupforwhicharouteannouncement*ispendingandefficentlyannouncero
utestoallofthem.**Fornow,the'combine'optionhasaneffectonlyifallpeersin*thesubgro
uphavearouteannouncementpending.*/voidpeer_af_announce_route(structpeer_af*paf,i
ntcombine){structupdate_subgroup*subgrp;structpeer_af*cur_paf;intall_pending;sub
grp=paf->subgroup;all_pending=0;if(combine){/**Ifthereareotherpeersintheoldsubgr
oupthatalsoneed*routestobeannounced,pullthemintothepeer'snew*subgroup.*Combinero
uteannouncementwithotherpeersifpossible.**Fornow,wecombineonlyifallpeersinthesub
grouphavean*announcementpending.*/all_pending=1;SUBGRP_FOREACH_PEER(subgrp,cur_p
af){if(cur_paf==paf)continue;if(cur_paf->t_announce_route)continue;all_pending=0
;break;}}/**Announcetothepeeraloneifwewerenotaskedtocombinepeers,*orifsomepeersd
on'thavearouteannoucementpending.*/if(!combine||!all_pending){update_subgroup_sp
lit_peer(paf,NULL);if(!paf->subgroup)return;if(bgp_debug_update(paf->peer,NULL,s
ubgrp->update_group,0))zlog_debug("u%"PRIu64":s%"PRIu64"%sannouncingroutes",subg
rp->update_group->id,subgrp->id,paf->peer->host);subgroup_announce_route(paf->su
bgroup);return;}/**Wewillannounceroutestheentiresubgroup.**Firststoprefreshtimer
sonalltheotherpeers.*/SUBGRP_FOREACH_PEER(subgrp,cur_paf){if(cur_paf==paf)contin
ue;bgp_stop_announce_route_timer(cur_paf);}if(bgp_debug_update(paf->peer,NULL,su
bgrp->update_group,0))zlog_debug("u%"PRIu64":s%"PRIu64"announcingroutesto%s,comb
inedinto%dpeers",subgrp->update_group->id,subgrp->id,paf->peer->host,subgrp->pee
r_count);subgroup_announce_route(subgrp);SUBGRP_INCR_STAT_BY(subgrp,peer_refresh
es_combined,subgrp->peer_count-1);}voidsubgroup_trigger_write(structupdate_subgr
oup*subgrp){structpeer_af*paf;/**Foreachpeerinthesubgroup,scheduleajobtopullpack
etsfrom*thesubgroupoutputqueueintotheirownoutputqueue.Thisaction*willtriggerawri
tejobontheI/Othread.*/SUBGRP_FOREACH_PEER(subgrp,paf)if(paf->peer->status==Estab
lished)thread_add_timer_msec(bm->master,bgp_generate_updgrp_packets,paf->peer,0,
&paf->peer->t_generate_updgrp_packets);}intupdate_group_clear_update_dbg(structu
pdate_group*updgrp,void*arg){UPDGRP_PEER_DBG_OFF(updgrp);returnUPDWALK_CONTINUE;
}/*ReturntrueifweshouldaddpathencodeNLRItothispeer*/intbgp_addpath_encode_tx(str
uctpeer*peer,afi_tafi,safi_tsafi){return(CHECK_FLAG(peer->af_cap[afi][safi],PEER
_CAP_ADDPATH_AF_TX_ADV)&&CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_
RX_RCV));}/**Returntrueifthisisapathweshouldadvertiseduetoa*configuredaddpath-tx
knob*/intbgp_addpath_tx_path(structpeer*peer,afi_tafi,safi_tsafi,structbgp_info*
ri){if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ADDPATH_TX_ALL_PATHS))retu
rn1;if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ADDPATH_TX_BESTPATH_PER_AS
)&&CHECK_FLAG(ri->flags,BGP_INFO_DMED_SELECTED))return1;return0;}