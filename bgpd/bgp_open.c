/*BGPopenmessagehandling*Copyright(C)1998,1999KunihiroIshiguro**Thisfileispartof
GNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheter
msoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eithervers
ion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwill
beuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYo
rFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**You
shouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethef
ileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,
Boston,MA02110-1301USA*/#include<zebra.h>#include"linklist.h"#include"prefix.h"#
include"stream.h"#include"thread.h"#include"log.h"#include"command.h"#include"me
mory.h"#include"queue.h"#include"filter.h"#include"lib/json.h"#include"bgpd/bgpd
.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_fsm.h"#i
nclude"bgpd/bgp_packet.h"#include"bgpd/bgp_open.h"#include"bgpd/bgp_aspath.h"#in
clude"bgpd/bgp_vty.h"#include"bgpd/bgp_memory.h"/*BGP-4MultiprotocolExtentionsle
adustothecomplexworld.Wecannegotiateremotepeersupportsextentionsornot.Butifremot
e-peerdoesn'tsupportsnegotiationprocessitself.Wewouldliketodomanualconfiguration
.Sothereismanyconfigurablepoint.Firstofallwewantseteachpeerwhetherwesendcapabili
tynegotiationtothepeerornot.Next,ifwesendcapabilitytothepeerwewanttosetmycapabil
tyinforationateachpeer.*/voidbgp_capability_vty_out(structvty*vty,structpeer*pee
r,uint8_tuse_json,json_object*json_neigh){char*pnt;char*end;structcapability_mp_
datampc;structcapability_header*hdr;json_object*json_cap=NULL;if(use_json)json_c
ap=json_object_new_object();pnt=peer->notify.data;end=pnt+peer->notify.length;wh
ile(pnt<end){if(pnt+sizeof(structcapability_mp_data)+2>end)return;hdr=(structcap
ability_header*)pnt;if(pnt+hdr->length+2>end)return;memcpy(&mpc,pnt+2,sizeof(str
uctcapability_mp_data));if(hdr->code==CAPABILITY_CODE_MP){afi_tafi;safi_tsafi;bg
p_map_afi_safi_iana2int(ntohs(mpc.afi),mpc.safi,&afi,&safi);if(use_json){switch(
afi){caseAFI_IP:json_object_string_add(json_cap,"capabilityErrorMultiProtocolAfi
","IPv4");break;caseAFI_IP6:json_object_string_add(json_cap,"capabilityErrorMult
iProtocolAfi","IPv6");break;caseAFI_L2VPN:json_object_string_add(json_cap,"capab
ilityErrorMultiProtocolAfi","L2VPN");break;default:json_object_int_add(json_cap,
"capabilityErrorMultiProtocolAfiUnknown",ntohs(mpc.afi));break;}switch(safi){cas
eSAFI_UNICAST:json_object_string_add(json_cap,"capabilityErrorMultiProtocolSafi"
,"unicast");break;caseSAFI_MULTICAST:json_object_string_add(json_cap,"capability
ErrorMultiProtocolSafi","multicast");break;caseSAFI_LABELED_UNICAST:json_object_
string_add(json_cap,"capabilityErrorMultiProtocolSafi","labeled-unicast");break;
caseSAFI_MPLS_VPN:json_object_string_add(json_cap,"capabilityErrorMultiProtocolS
afi","MPLS-labeledVPN");break;caseSAFI_ENCAP:json_object_string_add(json_cap,"ca
pabilityErrorMultiProtocolSafi","encap");break;caseSAFI_EVPN:json_object_string_
add(json_cap,"capabilityErrorMultiProtocolSafi","EVPN");break;caseSAFI_FLOWSPEC:
json_object_string_add(json_cap,"capabilityErrorMultiProtocolSafi","flowspec");b
reak;default:json_object_int_add(json_cap,"capabilityErrorMultiProtocolSafiUnkno
wn",mpc.safi);break;}}else{vty_out(vty,"Capabilityerrorfor:Multiprotocol");switc
h(afi){caseAFI_IP:vty_out(vty,"AFIIPv4,");break;caseAFI_IP6:vty_out(vty,"AFIIPv6
,");break;caseAFI_L2VPN:vty_out(vty,"AFIL2VPN,");break;default:vty_out(vty,"AFIU
nknown%d,",ntohs(mpc.afi));break;}switch(safi){caseSAFI_UNICAST:vty_out(vty,"SAF
IUnicast");break;caseSAFI_MULTICAST:vty_out(vty,"SAFIMulticast");break;caseSAFI_
LABELED_UNICAST:vty_out(vty,"SAFILabeled-unicast");break;caseSAFI_MPLS_VPN:vty_o
ut(vty,"SAFIMPLS-labeledVPN");break;caseSAFI_ENCAP:vty_out(vty,"SAFIENCAP");brea
k;caseSAFI_FLOWSPEC:vty_out(vty,"SAFIFLOWSPEC");break;caseSAFI_EVPN:vty_out(vty,
"SAFIEVPN");break;default:vty_out(vty,"SAFIUnknown%d",mpc.safi);break;}vty_out(v
ty,"\n");}}elseif(hdr->code>=128){if(use_json)json_object_int_add(json_cap,"capa
bilityErrorVendorSpecificCapabilityCode",hdr->code);elsevty_out(vty,"Capabilitye
rror:vendorspecificcapabilitycode%d",hdr->code);}else{if(use_json)json_object_in
t_add(json_cap,"capabilityErrorUnknownCapabilityCode",hdr->code);elsevty_out(vty
,"Capabilityerror:unknowncapabilitycode%d",hdr->code);}pnt+=hdr->length+2;}if(us
e_json)json_object_object_add(json_neigh,"capabilityErrors",json_cap);}staticvoi
dbgp_capability_mp_data(structstream*s,structcapability_mp_data*mpc){mpc->afi=st
ream_getw(s);mpc->reserved=stream_getc(s);mpc->safi=stream_getc(s);}/*Setnegotia
tedcapabilityvalue.*/staticintbgp_capability_mp(structpeer*peer,structcapability
_header*hdr){structcapability_mp_datampc;structstream*s=BGP_INPUT(peer);afi_tafi
;safi_tsafi;/*Verifylengthis4*/if(hdr->length!=4){zlog_warn("MPCap:Receivedinval
idlength%d,non-multipleof4",hdr->length);return-1;}bgp_capability_mp_data(s,&mpc
);if(bgp_debug_neighbor_events(peer))zlog_debug("%sOPENhasMP_EXTCAPforafi/safi:%
u/%u",peer->host,mpc.afi,mpc.safi);/*ConvertAFI,SAFItointernalvalues,check.*/if(
bgp_map_afi_safi_iana2int(mpc.afi,mpc.safi,&afi,&safi))return-1;/*Nowsafiremappe
d,andafi/safiarevalidarrayindices*/peer->afc_recv[afi][safi]=1;if(peer->afc[afi]
[safi])peer->afc_nego[afi][safi]=1;elsereturn-1;return0;}staticvoidbgp_capabilit
y_orf_not_support(structpeer*peer,iana_afi_tafi,iana_safi_tsafi,uint8_ttype,uint
8_tmode){if(bgp_debug_neighbor_events(peer))zlog_debug("%sAddr-family%d/%dhasORF
type/mode%d/%dnotsupported",peer->host,afi,safi,type,mode);}staticconststructmes
sageorf_type_str[]={{ORF_TYPE_PREFIX,"Prefixlist"},{ORF_TYPE_PREFIX_OLD,"Prefixl
ist(old)"},{0}};staticconststructmessageorf_mode_str[]={{ORF_MODE_RECEIVE,"Recei
ve"},{ORF_MODE_SEND,"Send"},{ORF_MODE_BOTH,"Both"},{0}};staticintbgp_capability_
orf_entry(structpeer*peer,structcapability_header*hdr){structstream*s=BGP_INPUT(
peer);structcapability_mp_datampc;uint8_tnum;iana_afi_tpkt_afi;afi_tafi;iana_saf
i_tpkt_safi;safi_tsafi;uint8_ttype;uint8_tmode;uint16_tsm_cap=0;/*capabilitysend
-modereceive*/uint16_trm_cap=0;/*capabilityreceive-modereceive*/inti;/*ORFEntryh
eader*/bgp_capability_mp_data(s,&mpc);num=stream_getc(s);pkt_afi=mpc.afi;pkt_saf
i=mpc.safi;if(bgp_debug_neighbor_events(peer))zlog_debug("%sORFCapentryforafi/sa
fi:%u/%u",peer->host,mpc.afi,mpc.safi);/*ConvertAFI,SAFItointernalvalues,check.*
/if(bgp_map_afi_safi_iana2int(pkt_afi,pkt_safi,&afi,&safi)){zlog_info("%sAddr-fa
mily%d/%dnotsupported.""IgnoringtheORFcapability",peer->host,pkt_afi,pkt_safi);r
eturn0;}mpc.afi=pkt_afi;mpc.safi=safi;/*validatenumberfield*/if(CAPABILITY_CODE_
ORF_LEN+(num*2)>hdr->length){zlog_info("%sORFCapabilityentrylengtherror,""Caplen
gth%u,num%u",peer->host,hdr->length,num);bgp_notify_send(peer,BGP_NOTIFY_OPEN_ER
R,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1;}for(i=0;i<num;i++){type=stream_getc(
s);mode=stream_getc(s);/*ORFModeerrorcheck*/switch(mode){caseORF_MODE_BOTH:caseO
RF_MODE_SEND:caseORF_MODE_RECEIVE:break;default:bgp_capability_orf_not_support(p
eer,pkt_afi,pkt_safi,type,mode);continue;}/*ORFTypeandafi/safierrorchecks*//*cap
codeversustype*/switch(hdr->code){caseCAPABILITY_CODE_ORF:switch(type){caseORF_T
YPE_PREFIX:break;default:bgp_capability_orf_not_support(peer,pkt_afi,pkt_safi,ty
pe,mode);continue;}break;caseCAPABILITY_CODE_ORF_OLD:switch(type){caseORF_TYPE_P
REFIX_OLD:break;default:bgp_capability_orf_not_support(peer,pkt_afi,pkt_safi,typ
e,mode);continue;}break;default:bgp_capability_orf_not_support(peer,pkt_afi,pkt_
safi,type,mode);continue;}/*AFIvsSAFI*/if(!((afi==AFI_IP&&safi==SAFI_UNICAST)||(
afi==AFI_IP&&safi==SAFI_MULTICAST)||(afi==AFI_IP6&&safi==SAFI_UNICAST))){bgp_cap
ability_orf_not_support(peer,pkt_afi,pkt_safi,type,mode);continue;}if(bgp_debug_
neighbor_events(peer))zlog_debug("%sOPENhas%sORFcapability""as%sforafi/safi:%d/%
d",peer->host,lookup_msg(orf_type_str,type,NULL),lookup_msg(orf_mode_str,mode,NU
LL),pkt_afi,pkt_safi);if(hdr->code==CAPABILITY_CODE_ORF){sm_cap=PEER_CAP_ORF_PRE
FIX_SM_RCV;rm_cap=PEER_CAP_ORF_PREFIX_RM_RCV;}elseif(hdr->code==CAPABILITY_CODE_
ORF_OLD){sm_cap=PEER_CAP_ORF_PREFIX_SM_OLD_RCV;rm_cap=PEER_CAP_ORF_PREFIX_RM_OLD
_RCV;}else{bgp_capability_orf_not_support(peer,pkt_afi,pkt_safi,type,mode);conti
nue;}switch(mode){caseORF_MODE_BOTH:SET_FLAG(peer->af_cap[afi][safi],sm_cap);SET
_FLAG(peer->af_cap[afi][safi],rm_cap);break;caseORF_MODE_SEND:SET_FLAG(peer->af_
cap[afi][safi],sm_cap);break;caseORF_MODE_RECEIVE:SET_FLAG(peer->af_cap[afi][saf
i],rm_cap);break;}}return0;}staticintbgp_capability_restart(structpeer*peer,stru
ctcapability_header*caphdr){structstream*s=BGP_INPUT(peer);uint16_trestart_flag_
time;size_tend=stream_get_getp(s)+caphdr->length;/*Verifylengthisamultipleof4*/i
f((caphdr->length-2)%4){zlog_warn("RestartCap:Receivedinvalidlength%d,non-multip
leof4",caphdr->length);return-1;}SET_FLAG(peer->cap,PEER_CAP_RESTART_RCV);restar
t_flag_time=stream_getw(s);if(CHECK_FLAG(restart_flag_time,RESTART_R_BIT))SET_FL
AG(peer->cap,PEER_CAP_RESTART_BIT_RCV);UNSET_FLAG(restart_flag_time,0xF000);peer
->v_gr_restart=restart_flag_time;if(bgp_debug_neighbor_events(peer)){zlog_debug(
"%sOPENhasGracefulRestartcapability",peer->host);zlog_debug("%sPeerhas%srestarte
d.RestartTime:%d",peer->host,CHECK_FLAG(peer->cap,PEER_CAP_RESTART_BIT_RCV)?"":"
not",peer->v_gr_restart);}while(stream_get_getp(s)+4<=end){afi_tafi;safi_tsafi;i
ana_afi_tpkt_afi=stream_getw(s);iana_safi_tpkt_safi=stream_getc(s);uint8_tflag=s
tream_getc(s);/*ConvertAFI,SAFItointernalvalues,check.*/if(bgp_map_afi_safi_iana
2int(pkt_afi,pkt_safi,&afi,&safi)){if(bgp_debug_neighbor_events(peer))zlog_debug
("%sAddr-family%d/%d(afi/safi)notsupported.""IgnoretheGracefulRestartcapabilityf
orthisAFI/SAFI",peer->host,pkt_afi,pkt_safi);}elseif(!peer->afc[afi][safi]){if(b
gp_debug_neighbor_events(peer))zlog_debug("%sAddr-family%d/%d(afi/safi)notenable
d.""IgnoretheGracefulRestartcapability",peer->host,pkt_afi,pkt_safi);}else{if(bg
p_debug_neighbor_events(peer))zlog_debug("%sAddressfamily%sis%spreserved",peer->
host,afi_safi_print(afi,safi),CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_RESTAR
T_AF_PRESERVE_RCV)?"":"not");SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_RESTART_A
F_RCV);if(CHECK_FLAG(flag,RESTART_F_BIT))SET_FLAG(peer->af_cap[afi][safi],PEER_C
AP_RESTART_AF_PRESERVE_RCV);}}return0;}/*Unlikeothercapabilityparsingroutines,th
isonereturns0onerror*/staticas_tbgp_capability_as4(structpeer*peer,structcapabil
ity_header*hdr){SET_FLAG(peer->cap,PEER_CAP_AS4_RCV);if(hdr->length!=CAPABILITY_
CODE_AS4_LEN){zlog_err("%sAS4capabilityhasincorrectdatalength%d",peer->host,hdr-
>length);return0;}as_tas4=stream_getl(BGP_INPUT(peer));if(BGP_DEBUG(as4,AS4))zlo
g_debug("%s[AS4]abouttosetcapPEER_CAP_AS4_RCV,gotas4%u",peer->host,as4);returnas
4;}staticintbgp_capability_addpath(structpeer*peer,structcapability_header*hdr){
structstream*s=BGP_INPUT(peer);size_tend=stream_get_getp(s)+hdr->length;SET_FLAG
(peer->cap,PEER_CAP_ADDPATH_RCV);/*Verifylengthisamultipleof4*/if(hdr->length%4)
{zlog_warn("AddPath:Receivedinvalidlength%d,non-multipleof4",hdr->length);return
-1;}while(stream_get_getp(s)+4<=end){afi_tafi;safi_tsafi;iana_afi_tpkt_afi=strea
m_getw(s);iana_safi_tpkt_safi=stream_getc(s);uint8_tsend_receive=stream_getc(s);
if(bgp_debug_neighbor_events(peer))zlog_debug("%sOPENhasAddPathCAPforafi/safi:%u
/%u%s%s",peer->host,pkt_afi,pkt_safi,(send_receive&BGP_ADDPATH_RX)?",receive":""
,(send_receive&BGP_ADDPATH_TX)?",transmit":"");/*ConvertAFI,SAFItointernalvalues
,check.*/if(bgp_map_afi_safi_iana2int(pkt_afi,pkt_safi,&afi,&safi)){if(bgp_debug
_neighbor_events(peer))zlog_debug("%sAddr-family%d/%d(afi/safi)notsupported.""Ig
noretheAddpathAttributeforthisAFI/SAFI",peer->host,pkt_afi,pkt_safi);continue;}e
lseif(!peer->afc[afi][safi]){if(bgp_debug_neighbor_events(peer))zlog_debug("%sAd
dr-family%d/%d(afi/safi)notenabled.""IgnoretheAddPathcapabilityforthisAFI/SAFI",
peer->host,pkt_afi,pkt_safi);continue;}if(send_receive&BGP_ADDPATH_RX)SET_FLAG(p
eer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_RX_RCV);if(send_receive&BGP_ADDPATH_T
X)SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_TX_RCV);}return0;}statici
ntbgp_capability_enhe(structpeer*peer,structcapability_header*hdr){structstream*
s=BGP_INPUT(peer);size_tend=stream_get_getp(s)+hdr->length;/*Verifylengthisamult
ipleof4*/if(hdr->length%6){zlog_warn("ExtendedNH:Receivedinvalidlength%d,non-mul
tipleof6",hdr->length);return-1;}while(stream_get_getp(s)+6<=end){iana_afi_tpkt_
afi=stream_getw(s);afi_tafi;iana_safi_tpkt_safi=stream_getw(s);safi_tsafi;iana_a
fi_tpkt_nh_afi=stream_getw(s);afi_tnh_afi;if(bgp_debug_neighbor_events(peer))zlo
g_debug("%sReceivedwithafi/safi/next-hopafi:%u/%u/%u",peer->host,pkt_afi,pkt_saf
i,pkt_nh_afi);/*ConvertAFI,SAFItointernalvalues,check.*/if(bgp_map_afi_safi_iana
2int(pkt_afi,pkt_safi,&afi,&safi)){if(bgp_debug_neighbor_events(peer))zlog_debug
("%sAddr-family%d/%d(afi/safi)notsupported.""IgnoretheENHEAttributeforthisAFI/SA
FI",peer->host,pkt_afi,pkt_safi);continue;}/*RFC5549specifiesuseofthiscapability
onlyforIPv4AFI,*with*theNexthopAFIbeingIPv6.Afuturespecmayintroduceother*possibi
lities,soweignoreothervalueswithalog.Also,*only*SAFI_UNICASTandSAFI_LABELED_UNIC
ASTarecurrentlysupported*(andexpected).*/nh_afi=afi_iana2int(pkt_nh_afi);if(afi!
=AFI_IP||nh_afi!=AFI_IP6||!(safi==SAFI_UNICAST||safi==SAFI_LABELED_UNICAST)){zlo
g_warn("%sUnexpectedafi/safi/next-hopafi:%u/%u/%u""inExtendedNext-hopcapability,
ignoring",peer->host,pkt_afi,pkt_safi,pkt_nh_afi);continue;}SET_FLAG(peer->af_ca
p[afi][safi],PEER_CAP_ENHE_AF_RCV);if(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CA
P_ENHE_AF_ADV))SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ENHE_AF_NEGO);}SET_FLAG
(peer->cap,PEER_CAP_ENHE_RCV);return0;}staticintbgp_capability_hostname(structpe
er*peer,structcapability_header*hdr){structstream*s=BGP_INPUT(peer);charstr[BGP_
MAX_HOSTNAME+1];size_tend=stream_get_getp(s)+hdr->length;uint8_tlen;SET_FLAG(pee
r->cap,PEER_CAP_HOSTNAME_RCV);len=stream_getc(s);if(stream_get_getp(s)+len>end){
zlog_warn("%s:Receivedmalformedhostnamecapabilityfrompeer%s",__FUNCTION__,peer->
host);return-1;}if(len>BGP_MAX_HOSTNAME){stream_get(str,s,BGP_MAX_HOSTNAME);stre
am_forward_getp(s,len-BGP_MAX_HOSTNAME);len=BGP_MAX_HOSTNAME;/*tosetthe'\0'below
*/}elseif(len)stream_get(str,s,len);if(len){str[len]='\0';if(peer->hostname!=NUL
L){XFREE(MTYPE_BGP_PEER_HOST,peer->hostname);peer->hostname=NULL;}if(peer->domai
nname!=NULL){XFREE(MTYPE_BGP_PEER_HOST,peer->domainname);peer->domainname=NULL;}
peer->hostname=XSTRDUP(MTYPE_BGP_PEER_HOST,str);}if(stream_get_getp(s)+1>end){zl
og_warn("%s:Receivedinvaliddomainnamelen(hostnamecapability)frompeer%s",__FUNCTI
ON__,peer->host);return-1;}len=stream_getc(s);if(stream_get_getp(s)+len>end){zlo
g_warn("%s:Receivedruntdomainname(hostnamecapability)frompeer%s",__FUNCTION__,pe
er->host);return-1;}if(len>BGP_MAX_HOSTNAME){stream_get(str,s,BGP_MAX_HOSTNAME);
stream_forward_getp(s,len-BGP_MAX_HOSTNAME);len=BGP_MAX_HOSTNAME;/*tosetthe'\0'b
elow*/}elseif(len)stream_get(str,s,len);if(len){str[len]='\0';peer->domainname=X
STRDUP(MTYPE_BGP_PEER_HOST,str);}if(bgp_debug_neighbor_events(peer)){zlog_debug(
"%sreceivedhostname%s,domainname%s",peer->host,peer->hostname,peer->domainname);
}return0;}staticconststructmessagecapcode_str[]={{CAPABILITY_CODE_MP,"MultiProto
colExtensions"},{CAPABILITY_CODE_REFRESH,"RouteRefresh"},{CAPABILITY_CODE_ORF,"C
ooperativeRouteFiltering"},{CAPABILITY_CODE_RESTART,"GracefulRestart"},{CAPABILI
TY_CODE_AS4,"4-octetASnumber"},{CAPABILITY_CODE_ADDPATH,"AddPath"},{CAPABILITY_C
ODE_DYNAMIC,"Dynamic"},{CAPABILITY_CODE_ENHE,"ExtendedNextHopEncoding"},{CAPABIL
ITY_CODE_DYNAMIC_OLD,"Dynamic(Old)"},{CAPABILITY_CODE_REFRESH_OLD,"RouteRefresh(
Old)"},{CAPABILITY_CODE_ORF_OLD,"ORF(Old)"},{CAPABILITY_CODE_FQDN,"FQDN"},{0}};/
*Minimumsizesforlengthfieldofeachcap(sonotinc.theheader)*/staticconstsize_tcap_m
insizes[]={[CAPABILITY_CODE_MP]=CAPABILITY_CODE_MP_LEN,[CAPABILITY_CODE_REFRESH]
=CAPABILITY_CODE_REFRESH_LEN,[CAPABILITY_CODE_ORF]=CAPABILITY_CODE_ORF_LEN,[CAPA
BILITY_CODE_RESTART]=CAPABILITY_CODE_RESTART_LEN,[CAPABILITY_CODE_AS4]=CAPABILIT
Y_CODE_AS4_LEN,[CAPABILITY_CODE_ADDPATH]=CAPABILITY_CODE_ADDPATH_LEN,[CAPABILITY
_CODE_DYNAMIC]=CAPABILITY_CODE_DYNAMIC_LEN,[CAPABILITY_CODE_DYNAMIC_OLD]=CAPABIL
ITY_CODE_DYNAMIC_LEN,[CAPABILITY_CODE_ENHE]=CAPABILITY_CODE_ENHE_LEN,[CAPABILITY
_CODE_REFRESH_OLD]=CAPABILITY_CODE_REFRESH_LEN,[CAPABILITY_CODE_ORF_OLD]=CAPABIL
ITY_CODE_ORF_LEN,[CAPABILITY_CODE_FQDN]=CAPABILITY_CODE_MIN_FQDN_LEN,};/*valueth
ecapabilitymustbeamultipleof.*0-datacapabilitieswon'tbecheckedagainstthis.*Other
capabilitieswhosedatadoesn'tfallonconvenientboundariesforthis*tableshouldbesetto
1.*/staticconstsize_tcap_modsizes[]={[CAPABILITY_CODE_MP]=4,[CAPABILITY_CODE_REF
RESH]=1,[CAPABILITY_CODE_ORF]=1,[CAPABILITY_CODE_RESTART]=1,[CAPABILITY_CODE_AS4
]=4,[CAPABILITY_CODE_ADDPATH]=4,[CAPABILITY_CODE_DYNAMIC]=1,[CAPABILITY_CODE_DYN
AMIC_OLD]=1,[CAPABILITY_CODE_ENHE]=6,[CAPABILITY_CODE_REFRESH_OLD]=1,[CAPABILITY
_CODE_ORF_OLD]=1,[CAPABILITY_CODE_FQDN]=1,};/***Parsegivencapability.*XXX:Thisis
readingintoastream,butnotusingstreamAPI**@param[out]mp_capabilitySetto1onreturni
ffoneormoreMultiprotocol*capabilitieswereencountered.*/staticintbgp_capability_p
arse(structpeer*peer,size_tlength,int*mp_capability,uint8_t**error){intret;struc
tstream*s=BGP_INPUT(peer);size_tend=stream_get_getp(s)+length;assert(STREAM_READ
ABLE(s)>=length);while(stream_get_getp(s)<end){size_tstart;uint8_t*sp=stream_pnt
(s);structcapability_headercaphdr;ret=0;/*Weneedatleastcapabilitycodeandcapabili
tylength.*/if(stream_get_getp(s)+2>end){zlog_info("%sCapabilitylengtherror(<head
er)",peer->host);bgp_notify_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFOR
MED_ATTR);return-1;}caphdr.code=stream_getc(s);caphdr.length=stream_getc(s);star
t=stream_get_getp(s);/*Capabilitylengthchecksanitycheck.*/if(start+caphdr.length
>end){zlog_info("%sCapabilitylengtherror(<length)",peer->host);bgp_notify_send(p
eer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1;}if(bgp_debug_n
eighbor_events(peer))zlog_debug("%sOPENhas%scapability(%u),length%u",peer->host,
lookup_msg(capcode_str,caphdr.code,NULL),caphdr.code,caphdr.length);/*Lengthsani
tycheck,type-specific,forknowncapabilities*/switch(caphdr.code){caseCAPABILITY_C
ODE_MP:caseCAPABILITY_CODE_REFRESH:caseCAPABILITY_CODE_REFRESH_OLD:caseCAPABILIT
Y_CODE_ORF:caseCAPABILITY_CODE_ORF_OLD:caseCAPABILITY_CODE_RESTART:caseCAPABILIT
Y_CODE_AS4:caseCAPABILITY_CODE_ADDPATH:caseCAPABILITY_CODE_DYNAMIC:caseCAPABILIT
Y_CODE_DYNAMIC_OLD:caseCAPABILITY_CODE_ENHE:caseCAPABILITY_CODE_FQDN:/*Checkleng
th.*/if(caphdr.length<cap_minsizes[caphdr.code]){zlog_info("%s%sCapabilitylength
error:got%u,""expectedatleast%u",peer->host,lookup_msg(capcode_str,caphdr.code,N
ULL),caphdr.length,(unsigned)cap_minsizes[caphdr.code]);bgp_notify_send(peer,BGP
_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1;}if(caphdr.length&&cap
hdr.length%cap_modsizes[caphdr.code]!=0){zlog_info("%s%sCapabilitylengtherror:go
t%u,""expectedamultipleof%u",peer->host,lookup_msg(capcode_str,caphdr.code,NULL)
,caphdr.length,(unsigned)cap_modsizes[caphdr.code]);bgp_notify_send(peer,BGP_NOT
IFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1;}/*wedeliberatelyignoreunk
nowncodes,seebelow*/default:break;}switch(caphdr.code){caseCAPABILITY_CODE_MP:{*
mp_capability=1;/*Ignorecapabilitywhenoverride-capabilityisset.*/if(!CHECK_FLAG(
peer->flags,PEER_FLAG_OVERRIDE_CAPABILITY)){/*Setnegotiatedvalue.*/ret=bgp_capab
ility_mp(peer,&caphdr);/*UnsupportedCapability.*/if(ret<0){/*Storereturndata.*/m
emcpy(*error,sp,caphdr.length+2);*error+=caphdr.length+2;}ret=0;/*Don'treturnerr
orforthis*/}}break;caseCAPABILITY_CODE_REFRESH:caseCAPABILITY_CODE_REFRESH_OLD:{
/*BGPrefreshcapability*/if(caphdr.code==CAPABILITY_CODE_REFRESH_OLD)SET_FLAG(pee
r->cap,PEER_CAP_REFRESH_OLD_RCV);elseSET_FLAG(peer->cap,PEER_CAP_REFRESH_NEW_RCV
);}break;caseCAPABILITY_CODE_ORF:caseCAPABILITY_CODE_ORF_OLD:ret=bgp_capability_
orf_entry(peer,&caphdr);break;caseCAPABILITY_CODE_RESTART:ret=bgp_capability_res
tart(peer,&caphdr);break;caseCAPABILITY_CODE_DYNAMIC:caseCAPABILITY_CODE_DYNAMIC
_OLD:SET_FLAG(peer->cap,PEER_CAP_DYNAMIC_RCV);break;caseCAPABILITY_CODE_AS4:/*Al
readyhandledasaspecial-caseparsingofthe*capabilities*atthebeginningofOPENprocess
ing.Sowecarenota*jot*forthevaluereally,onlyerrorcase.*/if(!bgp_capability_as4(pe
er,&caphdr))ret=-1;break;caseCAPABILITY_CODE_ADDPATH:ret=bgp_capability_addpath(
peer,&caphdr);break;caseCAPABILITY_CODE_ENHE:ret=bgp_capability_enhe(peer,&caphd
r);break;caseCAPABILITY_CODE_FQDN:ret=bgp_capability_hostname(peer,&caphdr);brea
k;default:if(caphdr.code>128){/*Wedon'tsendNotificationforunknownvendorspecificc
apabilities.Itseemsreasonablefornow...*/zlog_warn("%sVendorspecificcapability%d"
,peer->host,caphdr.code);}else{zlog_warn("%sunrecognizedcapabilitycode:%d-ignore
d",peer->host,caphdr.code);memcpy(*error,sp,caphdr.length+2);*error+=caphdr.leng
th+2;}}if(ret<0){bgp_notify_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFOR
MED_ATTR);return-1;}if(stream_get_getp(s)!=(start+caphdr.length)){if(stream_get_
getp(s)>(start+caphdr.length))zlog_warn("%sCap-parserfor%sreadpastcap-length,%u!
",peer->host,lookup_msg(capcode_str,caphdr.code,NULL),caphdr.length);stream_set_
getp(s,start+caphdr.length);}}return0;}staticintbgp_auth_parse(structpeer*peer,s
ize_tlength){bgp_notify_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_AUTH_FAILU
RE);return-1;}staticintstrict_capability_same(structpeer*peer){inti,j;for(i=AFI_
IP;i<AFI_MAX;i++)for(j=SAFI_UNICAST;j<SAFI_MAX;j++)if(peer->afc[i][j]!=peer->afc
_nego[i][j])return0;return1;}/*peekintooption,storesASNto*as4iftheAS4capabilityw
asfound.*Returns0ifnoas4found,as4capvalueotherwise.*/as_tpeek_for_as4_capability
(structpeer*peer,uint8_tlength){structstream*s=BGP_INPUT(peer);size_torig_getp=s
tream_get_getp(s);size_tend=orig_getp+length;as_tas4=0;if(BGP_DEBUG(as4,AS4))zlo
g_info("%s[AS4]rcvOPENw/OPTIONparameterlen:%u,""peekingforas4",peer->host,length
);/*theerrorcasesweDONThandle,weONLYtrytoreadas4outof*correctlyformattedoptions.
*/while(stream_get_getp(s)<end){uint8_topt_type;uint8_topt_length;/*Checktheleng
th.*/if(stream_get_getp(s)+2>end)gotoend;/*Fetchoptiontypeandlength.*/opt_type=s
tream_getc(s);opt_length=stream_getc(s);/*Optionlengthcheck.*/if(stream_get_getp
(s)+opt_length>end)gotoend;if(opt_type==BGP_OPEN_OPT_CAP){unsignedlongcapd_start
=stream_get_getp(s);unsignedlongcapd_end=capd_start+opt_length;assert(capd_end<=
end);while(stream_get_getp(s)<capd_end){structcapability_headerhdr;if(stream_get
_getp(s)+2>capd_end)gotoend;hdr.code=stream_getc(s);hdr.length=stream_getc(s);if
((stream_get_getp(s)+hdr.length)>capd_end)gotoend;if(hdr.code==CAPABILITY_CODE_A
S4){if(BGP_DEBUG(as4,AS4))zlog_info("[AS4]foundAS4capability,abouttoparse");as4=
bgp_capability_as4(peer,&hdr);gotoend;}stream_forward_getp(s,hdr.length);}}}end:
stream_set_getp(s,orig_getp);returnas4;}/***Parseopenoption.**@param[out]mp_capa
bility@seebgp_capability_parse()forsemantics.*/intbgp_open_option_parse(structpe
er*peer,uint8_tlength,int*mp_capability){intret=0;uint8_t*error;uint8_terror_dat
a[BGP_MAX_PACKET_SIZE];structstream*s=BGP_INPUT(peer);size_tend=stream_get_getp(
s)+length;error=error_data;if(bgp_debug_neighbor_events(peer))zlog_debug("%srcvO
PENw/OPTIONparameterlen:%u",peer->host,length);while(stream_get_getp(s)<end){uin
t8_topt_type;uint8_topt_length;/*MusthaveatleastanOPENoptionheader*/if(STREAM_RE
ADABLE(s)<2){zlog_info("%sOptionlengtherror",peer->host);bgp_notify_send(peer,BG
P_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1;}/*Fetchoptiontypeand
length.*/opt_type=stream_getc(s);opt_length=stream_getc(s);/*Optionlengthcheck.*
/if(STREAM_READABLE(s)<opt_length){zlog_info("%sOptionlengtherror",peer->host);b
gp_notify_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);return-1
;}if(bgp_debug_neighbor_events(peer))zlog_debug("%srcvdOPENw/optionalparameterty
pe%u(%s)len%u",peer->host,opt_type,opt_type==BGP_OPEN_OPT_AUTH?"Authentication":
opt_type==BGP_OPEN_OPT_CAP?"Capability":"Unknown",opt_length);switch(opt_type){c
aseBGP_OPEN_OPT_AUTH:ret=bgp_auth_parse(peer,opt_length);break;caseBGP_OPEN_OPT_
CAP:ret=bgp_capability_parse(peer,opt_length,mp_capability,&error);break;default
:bgp_notify_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_UNSUP_PARAM);ret=-1;br
eak;}/*Parseerror.Toaccumulateallunsupportedcapabilitycodes,bgp_capability_parse
doesnotreturn-1whenencounterunsupportedcapabilitycode.Todetectthat,pleasechecker
roranderro_datapointer,likebelow.*/if(ret<0)return-1;}/*AllOPENoptionisparsed.Ch
eckcapabilitywhenstrictcompareflagisenabled.*/if(CHECK_FLAG(peer->flags,PEER_FLA
G_STRICT_CAP_MATCH)){/*IfUnsupportedCapabilityexists.*/if(error!=error_data){bgp
_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_UNSUP_CAPBL,erro
r_data,error-error_data);return-1;}/*Checklocalcapabilitydoesnotnegotiatedwithre
motepeer.*/if(!strict_capability_same(peer)){bgp_notify_send(peer,BGP_NOTIFY_OPE
N_ERR,BGP_NOTIFY_OPEN_UNSUP_CAPBL);return-1;}}/*ChecktherearenocommonAFI/SAFIsan
dsendUnsupportedCapabilityerror.*/if(*mp_capability&&!CHECK_FLAG(peer->flags,PEE
R_FLAG_OVERRIDE_CAPABILITY)){if(!peer->afc_nego[AFI_IP][SAFI_UNICAST]&&!peer->af
c_nego[AFI_IP][SAFI_MULTICAST]&&!peer->afc_nego[AFI_IP][SAFI_LABELED_UNICAST]&&!
peer->afc_nego[AFI_IP][SAFI_MPLS_VPN]&&!peer->afc_nego[AFI_IP][SAFI_ENCAP]&&!pee
r->afc_nego[AFI_IP][SAFI_FLOWSPEC]&&!peer->afc_nego[AFI_IP6][SAFI_UNICAST]&&!pee
r->afc_nego[AFI_IP6][SAFI_MULTICAST]&&!peer->afc_nego[AFI_IP6][SAFI_LABELED_UNIC
AST]&&!peer->afc_nego[AFI_IP6][SAFI_MPLS_VPN]&&!peer->afc_nego[AFI_IP6][SAFI_ENC
AP]&&!peer->afc_nego[AFI_IP6][SAFI_FLOWSPEC]&&!peer->afc_nego[AFI_L2VPN][SAFI_EV
PN]){zlog_err("%s[Error]ConfiguredAFI/SAFIsdonot""overlapwithreceivedMPcapabilit
ies",peer->host);if(error!=error_data)bgp_notify_send_with_data(peer,BGP_NOTIFY_
OPEN_ERR,BGP_NOTIFY_OPEN_UNSUP_CAPBL,error_data,error-error_data);elsebgp_notify
_send(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_UNSUP_CAPBL);return-1;}}return0;}
staticvoidbgp_open_capability_orf(structstream*s,structpeer*peer,afi_tafi,safi_t
safi,uint8_tcode){uint8_tcap_len;uint8_torf_len;unsignedlongcapp;unsignedlongorf
p;unsignedlongnumberp;intnumber_of_orfs=0;iana_afi_tpkt_afi;iana_safi_tpkt_safi;
/*ConvertAFI,SAFItovaluesforpacket.*/bgp_map_afi_safi_int2iana(afi,safi,&pkt_afi
,&pkt_safi);stream_putc(s,BGP_OPEN_OPT_CAP);capp=stream_get_endp(s);/*SetCapabil
ityLenPointer*/stream_putc(s,0);/*CapabilityLength*/stream_putc(s,code);/*Capabi
lityCode*/orfp=stream_get_endp(s);/*SetORFLenPointer*/stream_putc(s,0);/*ORFLeng
th*/stream_putw(s,pkt_afi);stream_putc(s,0);stream_putc(s,pkt_safi);numberp=stre
am_get_endp(s);/*SetNumberPointer*/stream_putc(s,0);/*NumberofORFs*//*AddressPre
fixORF*/if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ORF_PREFIX_SM)||CHECK_
FLAG(peer->af_flags[afi][safi],PEER_FLAG_ORF_PREFIX_RM)){stream_putc(s,(code==CA
PABILITY_CODE_ORF?ORF_TYPE_PREFIX:ORF_TYPE_PREFIX_OLD));if(CHECK_FLAG(peer->af_f
lags[afi][safi],PEER_FLAG_ORF_PREFIX_SM)&&CHECK_FLAG(peer->af_flags[afi][safi],P
EER_FLAG_ORF_PREFIX_RM)){SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM
_ADV);SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_ADV);stream_putc(s
,ORF_MODE_BOTH);}elseif(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ORF_PREFI
X_SM)){SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_ADV);stream_putc(
s,ORF_MODE_SEND);}else{SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_A
DV);stream_putc(s,ORF_MODE_RECEIVE);}number_of_orfs++;}/*TotalNumberofORFs.*/str
eam_putc_at(s,numberp,number_of_orfs);/*TotalORFLen.*/orf_len=stream_get_endp(s)
-orfp-1;stream_putc_at(s,orfp,orf_len);/*TotalCapabilityLen.*/cap_len=stream_get
_endp(s)-capp-1;stream_putc_at(s,capp,cap_len);}/*Fillincapabilityopenoptiontoth
epacket.*/voidbgp_open_capability(structstream*s,structpeer*peer){uint8_tlen;uns
ignedlongcp,capp,rcapp;iana_afi_tpkt_afi;afi_tafi;safi_tsafi;iana_safi_tpkt_safi
;as_tlocal_as;uint32_trestart_time;uint8_tafi_safi_count=0;intadv_addpath_tx=0;/
*RemembercurrentpointerforOptParmLen.*/cp=stream_get_endp(s);/*OptParmLen.*/stre
am_putc(s,0);/*Donotsendcapability.*/if(!CHECK_FLAG(peer->sflags,PEER_STATUS_CAP
ABILITY_OPEN)||CHECK_FLAG(peer->flags,PEER_FLAG_DONT_CAPABILITY))return;/*MPcapa
bilityforconfiguredAFI,SAFI*/FOREACH_AFI_SAFI(afi,safi){if(peer->afc[afi][safi])
{/*ConvertAFI,SAFItovaluesforpacket.*/bgp_map_afi_safi_int2iana(afi,safi,&pkt_af
i,&pkt_safi);peer->afc_adv[afi][safi]=1;stream_putc(s,BGP_OPEN_OPT_CAP);stream_p
utc(s,CAPABILITY_CODE_MP_LEN+2);stream_putc(s,CAPABILITY_CODE_MP);stream_putc(s,
CAPABILITY_CODE_MP_LEN);stream_putw(s,pkt_afi);stream_putc(s,0);stream_putc(s,pk
t_safi);/*Extendednexthopcapability-currently*supportingRFC-5549for*Link-Localpe
eringonly*/if(CHECK_FLAG(peer->flags,PEER_FLAG_CAPABILITY_ENHE)&&peer->su.sa.sa_
family==AF_INET6&&IN6_IS_ADDR_LINKLOCAL(&peer->su.sin6.sin6_addr)&&afi==AFI_IP&&
(safi==SAFI_UNICAST||safi==SAFI_LABELED_UNICAST)){/*RFC5549ExtendedNextHopEncodi
ng*/SET_FLAG(peer->cap,PEER_CAP_ENHE_ADV);stream_putc(s,BGP_OPEN_OPT_CAP);stream
_putc(s,CAPABILITY_CODE_ENHE_LEN+2);stream_putc(s,CAPABILITY_CODE_ENHE);stream_p
utc(s,CAPABILITY_CODE_ENHE_LEN);SET_FLAG(peer->af_cap[AFI_IP][safi],PEER_CAP_ENH
E_AF_ADV);stream_putw(s,pkt_afi);stream_putw(s,pkt_safi);stream_putw(s,afi_int2i
ana(AFI_IP6));if(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ENHE_AF_RCV))SET_FL
AG(peer->af_cap[afi][safi],PEER_CAP_ENHE_AF_NEGO);}}}/*Routerefresh.*/SET_FLAG(p
eer->cap,PEER_CAP_REFRESH_ADV);stream_putc(s,BGP_OPEN_OPT_CAP);stream_putc(s,CAP
ABILITY_CODE_REFRESH_LEN+2);stream_putc(s,CAPABILITY_CODE_REFRESH_OLD);stream_pu
tc(s,CAPABILITY_CODE_REFRESH_LEN);stream_putc(s,BGP_OPEN_OPT_CAP);stream_putc(s,
CAPABILITY_CODE_REFRESH_LEN+2);stream_putc(s,CAPABILITY_CODE_REFRESH);stream_put
c(s,CAPABILITY_CODE_REFRESH_LEN);/*AS4*/SET_FLAG(peer->cap,PEER_CAP_AS4_ADV);str
eam_putc(s,BGP_OPEN_OPT_CAP);stream_putc(s,CAPABILITY_CODE_AS4_LEN+2);stream_put
c(s,CAPABILITY_CODE_AS4);stream_putc(s,CAPABILITY_CODE_AS4_LEN);if(peer->change_
local_as)local_as=peer->change_local_as;elselocal_as=peer->local_as;stream_putl(
s,local_as);/*AddPath*/FOREACH_AFI_SAFI(afi,safi){if(peer->afc[afi][safi]){afi_s
afi_count++;/*OnlyadvertiseaddpathTXifafeaturethat*willuseitis*configured*/if(CH
ECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ADDPATH_TX_ALL_PATHS)||CHECK_FLAG(p
eer->af_flags[afi][safi],PEER_FLAG_ADDPATH_TX_BESTPATH_PER_AS))adv_addpath_tx=1;
}}SET_FLAG(peer->cap,PEER_CAP_ADDPATH_ADV);stream_putc(s,BGP_OPEN_OPT_CAP);strea
m_putc(s,(CAPABILITY_CODE_ADDPATH_LEN*afi_safi_count)+2);stream_putc(s,CAPABILIT
Y_CODE_ADDPATH);stream_putc(s,CAPABILITY_CODE_ADDPATH_LEN*afi_safi_count);FOREAC
H_AFI_SAFI(afi,safi){if(peer->afc[afi][safi]){/*ConvertAFI,SAFItovaluesforpacket
.*/bgp_map_afi_safi_int2iana(afi,safi,&pkt_afi,&pkt_safi);stream_putw(s,pkt_afi)
;stream_putc(s,pkt_safi);if(adv_addpath_tx){stream_putc(s,BGP_ADDPATH_RX|BGP_ADD
PATH_TX);SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_RX_ADV);SET_FLAG(p
eer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_TX_ADV);}else{stream_putc(s,BGP_ADDPA
TH_RX);SET_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_RX_ADV);UNSET_FLAG(p
eer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_TX_ADV);}}}/*ORFcapability.*/FOREACH_
AFI_SAFI(afi,safi){if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ORF_PREFIX_
SM)||CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ORF_PREFIX_RM)){bgp_open_cap
ability_orf(s,peer,afi,safi,CAPABILITY_CODE_ORF_OLD);bgp_open_capability_orf(s,p
eer,afi,safi,CAPABILITY_CODE_ORF);}}/*Dynamiccapability.*/if(CHECK_FLAG(peer->fl
ags,PEER_FLAG_DYNAMIC_CAPABILITY)){SET_FLAG(peer->cap,PEER_CAP_DYNAMIC_ADV);stre
am_putc(s,BGP_OPEN_OPT_CAP);stream_putc(s,CAPABILITY_CODE_DYNAMIC_LEN+2);stream_
putc(s,CAPABILITY_CODE_DYNAMIC_OLD);stream_putc(s,CAPABILITY_CODE_DYNAMIC_LEN);s
tream_putc(s,BGP_OPEN_OPT_CAP);stream_putc(s,CAPABILITY_CODE_DYNAMIC_LEN+2);stre
am_putc(s,CAPABILITY_CODE_DYNAMIC);stream_putc(s,CAPABILITY_CODE_DYNAMIC_LEN);}/
*Hostnamecapability*/if(cmd_hostname_get()){SET_FLAG(peer->cap,PEER_CAP_HOSTNAME
_ADV);stream_putc(s,BGP_OPEN_OPT_CAP);rcapp=stream_get_endp(s);/*Ptrtolengthplac
eholder*/stream_putc(s,0);/*dummylenfornow*/stream_putc(s,CAPABILITY_CODE_FQDN);
capp=stream_get_endp(s);stream_putc(s,0);/*dummylenfornow*/len=strlen(cmd_hostna
me_get());if(len>BGP_MAX_HOSTNAME)len=BGP_MAX_HOSTNAME;stream_putc(s,len);stream
_put(s,cmd_hostname_get(),len);if(cmd_domainname_get()){len=strlen(cmd_domainnam
e_get());if(len>BGP_MAX_HOSTNAME)len=BGP_MAX_HOSTNAME;stream_putc(s,len);stream_
put(s,cmd_domainname_get(),len);}elsestream_putc(s,0);/*0length*//*Setthelengths
straight*/len=stream_get_endp(s)-rcapp-1;stream_putc_at(s,rcapp,len);len=stream_
get_endp(s)-capp-1;stream_putc_at(s,capp,len);if(bgp_debug_neighbor_events(peer)
)zlog_debug("%sSendinghostnamecapwithhn=%s,dn=%s",peer->host,cmd_hostname_get(),
cmd_domainname_get());}/*Sendingbasegraceful-restartcapabilityirrespectiveofthec
onfig*/SET_FLAG(peer->cap,PEER_CAP_RESTART_ADV);stream_putc(s,BGP_OPEN_OPT_CAP);
capp=stream_get_endp(s);/*SetCapabilityLenPointer*/stream_putc(s,0);/*Capability
Length*/stream_putc(s,CAPABILITY_CODE_RESTART);rcapp=stream_get_endp(s);/*SetRes
tartCapabilityLenPointer*/stream_putc(s,0);restart_time=peer->bgp->restart_time;
if(peer->bgp->t_startup){SET_FLAG(restart_time,RESTART_R_BIT);SET_FLAG(peer->cap
,PEER_CAP_RESTART_BIT_ADV);}stream_putw(s,restart_time);/*Sendaddress-familyspec
ificgraceful-restartcapabilityonlywhenGRconfigispresent*/if(bgp_flag_check(peer-
>bgp,BGP_FLAG_GRACEFUL_RESTART)){FOREACH_AFI_SAFI(afi,safi){if(peer->afc[afi][sa
fi]){/*ConvertAFI,SAFItovaluesfor*packet.*/bgp_map_afi_safi_int2iana(afi,safi,&p
kt_afi,&pkt_safi);stream_putw(s,pkt_afi);stream_putc(s,pkt_safi);if(bgp_flag_che
ck(peer->bgp,BGP_FLAG_GR_PRESERVE_FWD))stream_putc(s,RESTART_F_BIT);elsestream_p
utc(s,0);}}}/*TotalGracefulrestartcapabilityLen.*/len=stream_get_endp(s)-rcapp-1
;stream_putc_at(s,rcapp,len);/*TotalCapabilityLen.*/len=stream_get_endp(s)-capp-
1;stream_putc_at(s,capp,len);/*TotalOptParmLen.*/len=stream_get_endp(s)-cp-1;str
eam_putc_at(s,cp,len);}