/*BGPFlowSpecUtilities*Portions:*Copyright(C)2017ChinaTelecomSDNGroup*Copyright(
C)20186WIND**FRRoutingisfreesoftware;youcanredistributeitand/ormodifyit*underthe
termsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherv
ersion2,or(atyouroption)any*laterversion.**FRRoutingisdistributedinthehopethatit
willbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABIL
ITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.*
*YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;see
thefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFl
oor,Boston,MA02110-1301USA*/#include"zebra.h"#include"prefix.h"#include"bgp_tabl
e.h"#include"bgp_flowspec_util.h"#include"bgp_flowspec_private.h"staticvoidhex2b
in(uint8_t*hex,int*bin){intremainder=*hex;inti=0;while(remainder>=1&&i<8){bin[7-
i]=remainder%2;remainder=remainder/2;i++;}for(;i<8;i++)bin[7-i]=0;}staticinthexs
tr2num(uint8_t*hexstr,intlen){inti=0;intnum=0;for(i=0;i<len;i++)num=hexstr[i]+16
*16*num;returnnum;}/**handletheflowspecaddresssrc/dstorgenericaddressNLRI*return
numberofbytesanalysed(>=0).*/intbgp_flowspec_ip_address(enumbgp_flowspec_util_nl
ri_ttype,uint8_t*nlri_ptr,uint32_tmax_len,void*result,int*error){char*display=(c
har*)result;/*forreturn_string*/structprefix*prefix=(structprefix*)result;uint32
_toffset=0;structprefixprefix_local;intpsize;*error=0;memset(&prefix_local,0,siz
eof(structprefix));/*readtheprefixlength*/prefix_local.prefixlen=nlri_ptr[offset
];psize=PSIZE(prefix_local.prefixlen);offset++;/*TODOFlowspecIPv6Support*/prefix
_local.family=AF_INET;/*Prefixlengthcheck.*/if(prefix_local.prefixlen>prefix_ble
n(&prefix_local)*8)*error=-1;/*Whenpacketoverflowoccurreturnimmediately.*/if(psi
ze+offset>max_len)*error=-1;/*Defensivecoding,double-check*thepsizefitsinastruct
prefix*/if(psize>(ssize_t)sizeof(prefix_local.u))*error=-1;memcpy(&prefix_local.
u.prefix,&nlri_ptr[offset],psize);offset+=psize;switch(type){caseBGP_FLOWSPEC_RE
TURN_STRING:prefix2str(&prefix_local,display,BGP_FLOWSPEC_STRING_DISPLAY_MAX);br
eak;caseBGP_FLOWSPEC_CONVERT_TO_NON_OPAQUE:PREFIX_COPY_IPV4(prefix,&prefix_local
)break;caseBGP_FLOWSPEC_VALIDATE_ONLY:default:break;}returnoffset;}/**handlethef
lowspecoperatorNLRI*returnnumberofbytesanalysed*ifthereisanerror,thepassederrorp
aramisusedtogiveerror:*-1ifdecodingerror,*ifresultisastring,itsassumedlength*isB
GP_FLOWSPEC_STRING_DISPLAY_MAX*/intbgp_flowspec_op_decode(enumbgp_flowspec_util_
nlri_ttype,uint8_t*nlri_ptr,uint32_tmax_len,void*result,int*error){intop[8];intl
en,value,value_size;intloop=0;char*ptr=(char*)result;/*forreturn_string*/uint32_
toffset=0;intlen_string=BGP_FLOWSPEC_STRING_DISPLAY_MAX;intlen_written;*error=0;
do{hex2bin(&nlri_ptr[offset],op);offset++;len=2*op[2]+op[3];value_size=1<<len;va
lue=hexstr2num(&nlri_ptr[offset],value_size);/*cannotbe<and>atthesametime*/if(op
[5]==1&&op[6]==1)*error=-1;/*iffirstelement,ANDbitcannotbeset*/if(op[1]==1&&loop
==0)*error=-1;switch(type){caseBGP_FLOWSPEC_RETURN_STRING:if(loop){len_written=s
nprintf(ptr,len_string,",");len_string-=len_written;ptr+=len_written;}if(op[5]==
1){len_written=snprintf(ptr,len_string,"<");len_string-=len_written;ptr+=len_wri
tten;}if(op[6]==1){len_written=snprintf(ptr,len_string,">");len_string-=len_writ
ten;ptr+=len_written;}if(op[7]==1){len_written=snprintf(ptr,len_string,"=");len_
string-=len_written;ptr+=len_written;}len_written=snprintf(ptr,len_string,"%d",v
alue);len_string-=len_written;ptr+=len_written;break;caseBGP_FLOWSPEC_CONVERT_TO
_NON_OPAQUE:/*TODO:FSOPAQUE*/break;caseBGP_FLOWSPEC_VALIDATE_ONLY:default:/*noac
tion*/break;}offset+=value_size;loop++;}while(op[0]==0&&offset<max_len-1);if(off
set>max_len)*error=-1;/*useerrorparametertocountthenumberofentries*/if(*error==0
)*error=loop;returnoffset;}/**handletheflowspectcpflagsfield*returnnumberofbytes
analysed*ifthereisanerror,thepassederrorparamisusedtogiveerror:*-1ifdecodingerro
r,*ifresultisastring,itsassumedlength*isBGP_FLOWSPEC_STRING_DISPLAY_MAX*/intbgp_
flowspec_tcpflags_decode(enumbgp_flowspec_util_nlri_ttype,uint8_t*nlri_ptr,uint3
2_tmax_len,void*result,int*error){intop[8];intlen,value_size,loop=0,value;char*p
tr=(char*)result;/*forreturn_string*/uint32_toffset=0;intlen_string=BGP_FLOWSPEC
_STRING_DISPLAY_MAX;intlen_written;*error=0;do{hex2bin(&nlri_ptr[offset],op);/*i
ffirstelement,ANDbitcannotbeset*/if(op[1]==1&&loop==0)*error=-1;offset++;len=2*o
p[2]+op[3];value_size=1<<len;value=hexstr2num(&nlri_ptr[offset],value_size);swit
ch(type){caseBGP_FLOWSPEC_RETURN_STRING:if(op[1]==1&&loop!=0){len_written=snprin
tf(ptr,len_string,",and");len_string-=len_written;ptr+=len_written;}elseif(op[1]
==0&&loop!=0){len_written=snprintf(ptr,len_string,",or");len_string-=len_written
;ptr+=len_written;}len_written=snprintf(ptr,len_string,"tcpflagsis");len_string-
=len_written;ptr+=len_written;if(op[6]==1){ptr+=snprintf(ptr,len_string,"not");l
en_string-=len_written;ptr+=len_written;}if(op[7]==1){ptr+=snprintf(ptr,len_stri
ng,"exactlymatch");len_string-=len_written;ptr+=len_written;}ptr+=snprintf(ptr,l
en_string,"%d",value);len_string-=len_written;ptr+=len_written;break;caseBGP_FLO
WSPEC_CONVERT_TO_NON_OPAQUE:/*TODO:FSOPAQUE*/break;caseBGP_FLOWSPEC_VALIDATE_ONL
Y:default:/*noaction*/break;}offset+=value_size;loop++;}while(op[0]==0&&offset<m
ax_len-1);if(offset>max_len)*error=-1;/*useerrorparametertocountthenumberofentri
es*/if(*error==0)*error=loop;returnoffset;}/**handletheflowspecfragmenttypefield
*returnerror(returnedvaluesareinvalid)ornumberofbytesanalysed*-1iferrorindecodin
g*>=0:numberofbytesanalysed(ok).*/intbgp_flowspec_fragment_type_decode(enumbgp_f
lowspec_util_nlri_ttype,uint8_t*nlri_ptr,uint32_tmax_len,void*result,int*error){
intop[8];intlen,value,value_size,loop=0;char*ptr=(char*)result;/*forreturn_strin
g*/uint32_toffset=0;intlen_string=BGP_FLOWSPEC_STRING_DISPLAY_MAX;intlen_written
;*error=0;do{hex2bin(&nlri_ptr[offset],op);offset++;len=2*op[2]+op[3];value_size
=1<<len;value=hexstr2num(&nlri_ptr[offset],value_size);if(value!=1&&value!=2&&va
lue!=4&&value!=8)*error=-1;offset+=value_size;/*TODO:asperRFC5574:firstFragmentb
itsareReserved*doesthatmeanthatitisnotpossible*tohandlemultipleoccurences?*asoft
oday,weonlygrabthefirstTCPfragment*/if(loop){*error=-2;loop++;continue;}switch(t
ype){caseBGP_FLOWSPEC_RETURN_STRING:switch(value){case1:len_written=snprintf(ptr
,len_string,"dont-fragment");len_string-=len_written;ptr+=len_written;break;case
2:len_written=snprintf(ptr,len_string,"is-fragment");len_string-=len_written;ptr
+=len_written;break;case4:len_written=snprintf(ptr,len_string,"first-fragment");
len_string-=len_written;ptr+=len_written;break;case8:len_written=snprintf(ptr,le
n_string,"last-fragment");len_string-=len_written;ptr+=len_written;break;default
:{}}break;caseBGP_FLOWSPEC_CONVERT_TO_NON_OPAQUE:/*TODO:FSOPAQUE*/break;caseBGP_
FLOWSPEC_VALIDATE_ONLY:default:/*noaction*/break;}loop++;}while(op[0]==0&&offset
<max_len-1);if(offset>max_len)*error=-1;returnoffset;}staticboolbgp_flowspec_con
tains_prefix(structprefix*pfs,structprefix*input,intprefix_check){uint32_toffset
=0;inttype;intret=0,error=0;uint8_t*nlri_content=(uint8_t*)pfs->u.prefix_flowspe
c.ptr;size_tlen=pfs->u.prefix_flowspec.prefixlen;structprefixcompare;error=0;whi
le(offset<len-1&&error>=0){type=nlri_content[offset];offset++;switch(type){caseF
LOWSPEC_DEST_PREFIX:caseFLOWSPEC_SRC_PREFIX:memset(&compare,0,sizeof(structprefi
x));ret=bgp_flowspec_ip_address(BGP_FLOWSPEC_CONVERT_TO_NON_OPAQUE,nlri_content+
offset,len-offset,&compare,&error);if(ret<=0)break;if(prefix_check&&compare.pref
ixlen!=input->prefixlen)break;if(compare.family!=input->family)break;if((input->
family==AF_INET)&&IPV4_ADDR_SAME(&input->u.prefix4,&compare.u.prefix4))returntru
e;if((input->family==AF_INET6)&&IPV6_ADDR_SAME(&input->u.prefix6.s6_addr,&compar
e.u.prefix6.s6_addr))returntrue;break;caseFLOWSPEC_IP_PROTOCOL:caseFLOWSPEC_PORT
:caseFLOWSPEC_DEST_PORT:caseFLOWSPEC_SRC_PORT:caseFLOWSPEC_ICMP_TYPE:caseFLOWSPE
C_ICMP_CODE:ret=bgp_flowspec_op_decode(BGP_FLOWSPEC_VALIDATE_ONLY,nlri_content+o
ffset,len-offset,NULL,&error);break;caseFLOWSPEC_TCP_FLAGS:ret=bgp_flowspec_tcpf
lags_decode(BGP_FLOWSPEC_VALIDATE_ONLY,nlri_content+offset,len-offset,NULL,&erro
r);break;caseFLOWSPEC_PKT_LEN:caseFLOWSPEC_DSCP:ret=bgp_flowspec_op_decode(BGP_F
LOWSPEC_VALIDATE_ONLY,nlri_content+offset,len-offset,NULL,&error);break;caseFLOW
SPEC_FRAGMENT:ret=bgp_flowspec_fragment_type_decode(BGP_FLOWSPEC_VALIDATE_ONLY,n
lri_content+offset,len-offset,NULL,&error);break;default:error=-1;break;}offset+
=ret;}returnfalse;}structbgp_node*bgp_flowspec_get_match_per_ip(afi_tafi,structb
gp_table*rib,structprefix*match,intprefix_check){structbgp_node*rn;structprefix*
prefix;for(rn=bgp_table_top(rib);rn;rn=bgp_route_next(rn)){prefix=&rn->p;if(pref
ix->family!=AF_FLOWSPEC)continue;if(bgp_flowspec_contains_prefix(prefix,match,pr
efix_check))returnrn;}returnNULL;}