/*BGPdumptoasciiconverter*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZ
ebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsof
theGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2
,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeus
eful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFIT
NESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshou
ldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileC
OPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bost
on,MA02110-1301USA*/#include<zebra.h>#include"zebra.h"#include"stream.h"#include
"log.h"#include"prefix.h"#include"command.h"#include"memory.h"#include"privs.h"#
include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_dump.h"#include"bgpd/bgp
_attr.h"#include"bgpd/bgp_aspath.h"/*privileges*/staticzebra_capabilities_t_caps
_p[]={ZCAP_BIND,ZCAP_NET_RAW,ZCAP_NET_ADMIN,};structzebra_privs_tbgpd_privs={#if
defined(FRR_USER)&&defined(FRR_GROUP).user=FRR_USER,.group=FRR_GROUP,#endif#ifde
fVTY_GROUP.vty_group=VTY_GROUP,#endif.caps_p=_caps_p,.cap_num_p=array_size(_caps
_p),.cap_num_i=0,};enumMRT_MSG_TYPES{MSG_NULL,MSG_START,/*senderisstartingup*/MS
G_DIE,/*receivershouldshutdown*/MSG_I_AM_DEAD,/*senderisshuttingdown*/MSG_PEER_D
OWN,/*sender'speerisdown*/MSG_PROTOCOL_BGP,/*msgisaBGPpacket*/MSG_PROTOCOL_RIP,/
*msgisaRIPpacket*/MSG_PROTOCOL_IDRP,/*msgisanIDRPpacket*/MSG_PROTOCOL_RIPNG,/*ms
gisaRIPNGpacket*/MSG_PROTOCOL_BGP4PLUS,/*msgisaBGP4+packet*/MSG_PROTOCOL_BGP4PLU
S_01,/*msgisaBGP4+(draft01)packet*/MSG_PROTOCOL_OSPF,/*msgisanOSPFpacket*/MSG_TA
BLE_DUMP/*routingtabledump*/};staticintattr_parse(structstream*s,uint16_tlen){un
signedintflag;unsignedinttype;uint16_tlength;uint16_tlim;lim=s->getp+len;printf(
"attr_parses->getp%zd,len%d,lim%d\n",s->getp,len,lim);while(s->getp<lim){flag=st
ream_getc(s);type=stream_getc(s);if(flag&BGP_ATTR_FLAG_EXTLEN)length=stream_getw
(s);elselength=stream_getc(s);printf("FLAG:%d\n",flag);printf("TYPE:%d\n",type);
printf("Len:%d\n",length);switch(type){caseBGP_ATTR_ORIGIN:{uint8_torigin;origin
=stream_getc(s);printf("ORIGIN:%d\n",origin);}break;caseBGP_ATTR_AS_PATH:{struct
aspath*aspath;aspath=aspath_parse(s,length,1);printf("ASPATH:%s\n",aspath->str);
aspath_free(aspath);}break;caseBGP_ATTR_NEXT_HOP:{structin_addrnexthop;nexthop.s
_addr=stream_get_ipv4(s);printf("NEXTHOP:%s\n",inet_ntoa(nexthop));}break;defaul
t:stream_getw_from(s,length);break;}}return0;}intmain(intargc,char**argv){intret
;FILE*fp;structstream*s;time_tnow;inttype;intsubtype;size_tlen;intsource_as;intd
est_as;ifindex_tifindex;intfamily;structin_addrsip;structin_addrdip;uint16_tview
no,seq_num;structprefix_ipv4p;s=stream_new(10000);if(argc!=2){fprintf(stderr,"Us
age:%sFILENAME\n",argv[0]);exit(1);}fp=fopen(argv[1],"r");if(!fp){fprintf(stdout
,"%%Can'topenconfigurationfile%sdueto'%s'.\n",argv[1],safe_strerror(errno));exit
(1);}while(1){stream_reset(s);ret=fread(s->data,12,1,fp);if(!ret||feof(fp)){prin
tf("ENDOFFILE\n");break;}if(ferror(fp)){printf("ERROROFFREAD\n");break;}/*Extrac
theader.*/now=stream_getl(s);type=stream_getw(s);subtype=stream_getw(s);len=stre
am_getl(s);printf("TIME:%s",ctime(&now));/*printf("TYPE:%d/%d\n",type,subtype);*
/if(type==MSG_PROTOCOL_BGP4MP)printf("TYPE:BGP4MP");elseif(type==MSG_PROTOCOL_BG
P4MP_ET)printf("TYPE:BGP4MP_ET");elseif(type==MSG_TABLE_DUMP)printf("TYPE:MSG_TA
BLE_DUMP");elseprintf("TYPE:Unknown%d",type);if(type==MSG_TABLE_DUMP)switch(subt
ype){caseAFI_IP:printf("/AFI_IP\n");break;caseAFI_IP6:printf("/AFI_IP6\n");break
;default:printf("/UNKNOWN%d",subtype);break;}else{switch(subtype){caseBGP4MP_STA
TE_CHANGE:printf("/CHANGE\n");break;caseBGP4MP_MESSAGE:printf("/MESSAGE\n");brea
k;caseBGP4MP_ENTRY:printf("/ENTRY\n");break;caseBGP4MP_SNAPSHOT:printf("/SNAPSHO
T\n");break;default:printf("/UNKNOWN%d",subtype);break;}}printf("len:%zd\n",len)
;fread(s->data+12,len,1,fp);if(feof(fp)){printf("ENDOFFILE2\n");break;}if(ferror
(fp)){printf("ERROROFFREAD2\n");break;}/*printf("nowread%d\n",len);*/if(type==MS
G_TABLE_DUMP){uint8_tstatus;time_toriginated;structin_addrpeer;uint16_tattrlen;v
iewno=stream_getw(s);seq_num=stream_getw(s);printf("VIEW:%d\n",viewno);printf("S
EQUENCE:%d\n",seq_num);/*start*/while(s->getp<len-16){p.prefix.s_addr=stream_get
_ipv4(s);p.prefixlen=stream_getc(s);printf("PREFIX:%s/%d\n",inet_ntoa(p.prefix),
p.prefixlen);status=stream_getc(s);originated=stream_getl(s);peer.s_addr=stream_
get_ipv4(s);source_as=stream_getw(s);printf("FROM:%sAS%d\n",inet_ntoa(peer),sour
ce_as);printf("ORIGINATED:%s",ctime(&originated));attrlen=stream_getw(s);printf(
"ATTRLEN:%d\n",attrlen);attr_parse(s,attrlen);printf("STATUS:0x%x\n",status);}}e
lse{source_as=stream_getw(s);dest_as=stream_getw(s);printf("source_as:%d\n",sour
ce_as);printf("dest_as:%d\n",dest_as);ifindex=stream_getw(s);family=stream_getw(
s);printf("ifindex:%d\n",ifindex);printf("family:%d\n",family);sip.s_addr=stream
_get_ipv4(s);dip.s_addr=stream_get_ipv4(s);printf("saddr:%s\n",inet_ntoa(sip));p
rintf("daddr:%s\n",inet_ntoa(dip));printf("\n");}}fclose(fp);return0;}