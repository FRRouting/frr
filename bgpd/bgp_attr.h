/*BGPattributes.*Copyright(C)1996,97,98KunihiroIshiguro**ThisfileispartofGNUZebr
a.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofthe
GNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or
(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#ifndef_QUAGGA_BGP_ATTR_H#define_QUAGGA_BGP_ATTR_H#include"mpls
.h"#include"bgp_attr_evpn.h"/*Simplebitmapping.*/#defineBITMAP_NBBY8#defineSET_B
ITMAP(MAP,NUM)\SET_FLAG(MAP[(NUM)/BITMAP_NBBY],1<<((NUM)%BITMAP_NBBY))#defineCHE
CK_BITMAP(MAP,NUM)\CHECK_FLAG(MAP[(NUM)/BITMAP_NBBY],1<<((NUM)%BITMAP_NBBY))#def
ineBGP_MED_MAXUINT32_MAX/*BGPAttributetyperange.*/#defineBGP_ATTR_TYPE_RANGE256#
defineBGP_ATTR_BITMAP_SIZE(BGP_ATTR_TYPE_RANGE/BITMAP_NBBY)/*BGPAttributeflags.*
/#defineBGP_ATTR_FLAG_OPTIONAL0x80/*Attributeisoptional.*/#defineBGP_ATTR_FLAG_T
RANS0x40/*Attributeistransitive.*/#defineBGP_ATTR_FLAG_PARTIAL0x20/*Attributeisp
artial.*/#defineBGP_ATTR_FLAG_EXTLEN0x10/*Extendedlengthflag.*//*BGPattributehea
dermustbiggerthan2.*/#defineBGP_ATTR_MIN_LEN3/*Attributeflag,typelength.*/#defin
eBGP_ATTR_DEFAULT_WEIGHT32768/*Validlengthsformp_nexthop_len*/#defineBGP_ATTR_NH
LEN_IPV4IPV4_MAX_BYTELEN#defineBGP_ATTR_NHLEN_VPNV48+IPV4_MAX_BYTELEN#defineBGP_
ATTR_NHLEN_IPV6_GLOBALIPV6_MAX_BYTELEN#defineBGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL(I
PV6_MAX_BYTELEN*2)#defineBGP_ATTR_NHLEN_VPNV6_GLOBAL8+IPV6_MAX_BYTELEN#defineBGP
_ATTR_NHLEN_VPNV6_GLOBAL_AND_LL((8+IPV6_MAX_BYTELEN)*2)/*PrefixSIDtypes*/#define
BGP_PREFIX_SID_LABEL_INDEX1#defineBGP_PREFIX_SID_IPV62#defineBGP_PREFIX_SID_ORIG
INATOR_SRGB3#defineBGP_PREFIX_SID_LABEL_INDEX_LENGTH7#defineBGP_PREFIX_SID_IPV6_
LENGTH19#defineBGP_PREFIX_SID_ORIGINATOR_SRGB_LENGTH6/*PMSItunneltypes(RFC6514)*
/structbgp_attr_encap_subtlv{structbgp_attr_encap_subtlv*next;/*forchaining*//*R
eferencecountofthisattribute.*/unsignedlongrefcnt;uint16_ttype;uint16_tlength;ui
nt8_tvalue[0];/*willbeextended*/};#ifENABLE_BGP_VNC/**oldrfp<->rfapirepresentati
on*/structbgp_tea_options{structbgp_tea_options*next;uint8_toptions_count;uint16
_toptions_length;/*eachTLVmaybe256inlength*/uint8_ttype;uint8_tlength;void*value
;/*pointertodata*/};#endif/*OverlayIndexInfo*/structoverlay_index{structeth_segm
ent_ideth_s_id;uniongw_addrgw_ip;};enumpta_type{PMSI_TNLTYPE_NO_INFO=0,PMSI_TNLT
YPE_RSVP_TE_P2MP,PMSI_TNLTYPE_MLDP_P2MP,PMSI_TNLTYPE_PIM_SSM,PMSI_TNLTYPE_PIM_SM
,PMSI_TNLTYPE_PIM_BIDIR,PMSI_TNLTYPE_INGR_REPL,PMSI_TNLTYPE_MLDP_MP2MP,PMSI_TNLT
YPE_MAX=PMSI_TNLTYPE_MLDP_MP2MP};/*BGPcoreattributestructure.*/structattr{/*ASPa
thstructure*/structaspath*aspath;/*Communitystructure*/structcommunity*community
;/*Referencecountofthisattribute.*/unsignedlongrefcnt;/*Flagofattributeissetorno
t.*/uint64_tflag;/*Apartfromin6_addr,theremainingstaticattributes*/structin_addr
nexthop;uint32_tmed;uint32_tlocal_pref;ifindex_tnh_ifindex;/*Pathoriginattribute
*/uint8_torigin;/*PMSItunneltype(RFC6514).*/enumpta_typepmsi_tnl_type;/*hasthero
ute-mapchangedanyattribute?Usedonthepeeroutboundside.*/uint32_trmap_change_flags
;/*Multi-ProtocolNexthop,AFIIPv6*/structin6_addrmp_nexthop_global;structin6_addr
mp_nexthop_local;/*ExtendedCommunitiesattribute.*/structecommunity*ecommunity;/*
LargeCommunitiesattribute.*/structlcommunity*lcommunity;/*Route-ReflectorCluster
attribute*/structcluster_list*cluster;/*Unknowntransitiveattribute.*/structtrans
it*transit;structin_addrmp_nexthop_global_in;/*AggregatorRouterIDattribute*/stru
ctin_addraggregator_addr;/*RouteReflectorOriginatorattribute*/structin_addrorigi
nator_id;/*Localweight,notactuallyanattribute*/uint32_tweight;/*AggregatorASN*/a
s_taggregator_as;/*MPNexthoplength*/uint8_tmp_nexthop_len;/*MPNexthoppreference*
/uint8_tmp_nexthop_prefer_global;/*StaticMACforEVPN*/uint8_tsticky;/*Flagfordefa
ultgatewayextendedcommunityinEVPN*/uint8_tdefault_gw;/*routetag*/route_tag_ttag;
/*Labelindex*/uint32_tlabel_index;/*MPLSlabel*/mpls_label_tlabel;uint16_tencap_t
unneltype;/*grr*/structbgp_attr_encap_subtlv*encap_subtlvs;/*rfc5512*/#ifENABLE_
BGP_VNCstructbgp_attr_encap_subtlv*vnc_subtlvs;/*VNC-specific*/#endif/*EVPN*/str
uctoverlay_indexevpn_overlay;/*EVPNMACMobilitysequencenumber,ifany.*/uint32_tmm_
seqnum;/*EVPNlocalrouter-mac*/structethaddrrmac;};/*rmap_change_flagsdefinition*
/#defineBATTR_RMAP_IPV4_NHOP_CHANGED(1<<0)#defineBATTR_RMAP_NEXTHOP_PEER_ADDRESS
(1<<1)#defineBATTR_REFLECTED(1<<2)#defineBATTR_RMAP_NEXTHOP_UNCHANGED(1<<3)#defi
neBATTR_RMAP_IPV6_GLOBAL_NHOP_CHANGED(1<<4)#defineBATTR_RMAP_IPV6_LL_NHOP_CHANGE
D(1<<5)#defineBATTR_RMAP_IPV6_PREFER_GLOBAL_CHANGED(1<<6)/*RouterReflectorrelate
dstructure.*/structcluster_list{unsignedlongrefcnt;intlength;structin_addr*list;
};/*Unknowntransitattribute.*/structtransit{unsignedlongrefcnt;intlength;uint8_t
*val;};/*"(void)0"willgenerateacompilererror.thisisasafetycheckto*ensurewe'renot
usingavaluethatexceedsthebitsizeofattr->flag.*/#defineATTR_FLAG_BIT(X)\__builtin
_choose_expr((X)>=1&&(X)<=64,1ULL<<((X)-1),(void)0)#defineBGP_CLUSTER_LIST_LENGT
H(attr)\(((attr)->flag&ATTR_FLAG_BIT(BGP_ATTR_CLUSTER_LIST))\?(attr)->cluster->l
ength\:0)typedefenum{BGP_ATTR_PARSE_PROCEED=0,BGP_ATTR_PARSE_ERROR=-1,BGP_ATTR_P
ARSE_WITHDRAW=-2,/*onlyusedinternally,sendnotify+converttoBGP_ATTR_PARSE_ERROR*/
BGP_ATTR_PARSE_ERROR_NOTIFYPLS=-3,BGP_ATTR_PARSE_EOR=-4,}bgp_attr_parse_ret_t;st
ructbpacket_attr_vec_arr;/*Prototypes.*/externvoidbgp_attr_init(void);externvoid
bgp_attr_finish(void);externbgp_attr_parse_ret_tbgp_attr_parse(structpeer*,struc
tattr*,bgp_size_t,structbgp_nlri*,structbgp_nlri*);externvoidbgp_attr_dup(struct
attr*,structattr*);externvoidbgp_attr_undup(structattr*new,structattr*old);exter
nstructattr*bgp_attr_intern(structattr*attr);externvoidbgp_attr_unintern_sub(str
uctattr*);externvoidbgp_attr_unintern(structattr**);externvoidbgp_attr_flush(str
uctattr*);externstructattr*bgp_attr_default_set(structattr*attr,uint8_t);externs
tructattr*bgp_attr_aggregate_intern(structbgp*,uint8_t,structaspath*,structcommu
nity*,intas_set,uint8_t);externbgp_size_tbgp_packet_attribute(structbgp*bgp,stru
ctpeer*,structstream*,structattr*,structbpacket_attr_vec_arr*vecarr,structprefix
*,afi_t,safi_t,structpeer*,structprefix_rd*,mpls_label_t*,uint32_t,int,uint32_t)
;externvoidbgp_dump_routes_attr(structstream*,structattr*,structprefix*);externi
ntattrhash_cmp(constvoid*,constvoid*);externunsignedintattrhash_key_make(void*);
externvoidattr_show_all(structvty*);externunsignedlongintattr_count(void);extern
unsignedlongintattr_unknown_count(void);/*Clusterlistprototypes.*/externintclust
er_loop_check(structcluster_list*,structin_addr);externvoidcluster_unintern(stru
ctcluster_list*);/*Transitattributeprototypes.*/voidtransit_unintern(structtrans
it*);/*Belowexportedforunit-testpurposesonly*/structbgp_attr_parser_args{structp
eer*peer;bgp_size_tlength;/*attributedatalength;*/bgp_size_ttotal;/*totallength,
incheader*/structattr*attr;uint8_ttype;uint8_tflags;uint8_t*startp;};externintbg
p_mp_reach_parse(structbgp_attr_parser_args*args,structbgp_nlri*);externintbgp_m
p_unreach_parse(structbgp_attr_parser_args*args,structbgp_nlri*);externstructbgp
_attr_encap_subtlv*encap_tlv_dup(structbgp_attr_encap_subtlv*orig);externvoidbgp
_attr_flush_encap(structattr*attr);/***SetoffunctionstoencodeMP_REACH_NLRIandMP_
UNREACH_NLRIattributes.*Typicalcallsequenceistocall_start(),followedbymultiple_p
refix(),*oneforeachNLRIthatneedstobeencodedintotheUPDATEmessage,and*finallythe_e
nd()function.*/externsize_tbgp_packet_mpattr_start(structstream*s,structpeer*pee
r,afi_tafi,safi_tsafi,structbpacket_attr_vec_arr*vecarr,structattr*attr);externv
oidbgp_packet_mpattr_prefix(structstream*s,afi_tafi,safi_tsafi,structprefix*p,st
ructprefix_rd*prd,mpls_label_t*label,uint32_tnum_labels,intaddpath_encode,uint32
_taddpath_tx_id,structattr*);externsize_tbgp_packet_mpattr_prefix_size(afi_tafi,
safi_tsafi,structprefix*p);externvoidbgp_packet_mpattr_end(structstream*s,size_t
sizep);externsize_tbgp_packet_mpunreach_start(structstream*s,afi_tafi,safi_tsafi
);externvoidbgp_packet_mpunreach_prefix(structstream*s,structprefix*p,afi_tafi,s
afi_tsafi,structprefix_rd*prd,mpls_label_t*,uint32_t,int,uint32_t,structattr*);e
xternvoidbgp_packet_mpunreach_end(structstream*s,size_tattrlen_pnt);staticinline
intbgp_rmap_nhop_changed(uint32_tout_rmap_flags,uint32_tin_rmap_flags){return((C
HECK_FLAG(out_rmap_flags,BATTR_RMAP_NEXTHOP_PEER_ADDRESS)||CHECK_FLAG(out_rmap_f
lags,BATTR_RMAP_NEXTHOP_UNCHANGED)||CHECK_FLAG(out_rmap_flags,BATTR_RMAP_IPV4_NH
OP_CHANGED)||CHECK_FLAG(out_rmap_flags,BATTR_RMAP_IPV6_GLOBAL_NHOP_CHANGED)||CHE
CK_FLAG(out_rmap_flags,BATTR_RMAP_IPV6_PREFER_GLOBAL_CHANGED)||CHECK_FLAG(out_rm
ap_flags,BATTR_RMAP_IPV6_LL_NHOP_CHANGED)||CHECK_FLAG(in_rmap_flags,BATTR_RMAP_N
EXTHOP_UNCHANGED))?1:0);}staticinlineuint32_tmac_mobility_seqnum(structattr*attr
){return(attr)?attr->mm_seqnum:0;}#endif/*_QUAGGA_BGP_ATTR_H*/