/*BGPnexthopscan*Copyright(C)2000KunihiroIshiguro**ThisfileispartofGNUZebra.**GN
UZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGen
eralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyou
roption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*
WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAP
ARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaverec
eivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;if
not,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA0211
0-1301USA*/#include<zebra.h>#include"command.h"#include"thread.h"#include"prefix
.h"#include"zclient.h"#include"stream.h"#include"network.h"#include"log.h"#inclu
de"memory.h"#include"hash.h"#include"jhash.h"#include"nexthop.h"#include"queue.h
"#include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgpd/
bgp_route.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_nexthop.h"#include"bgpd/b
gp_nht.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_damp.h"#include"bgpd/bgp_fs
m.h"#include"bgpd/bgp_vty.h"#include"zebra/rib.h"#include"zebra/zserv.h"/*ForZEB
RA_SERV_PATH.*/char*bnc_str(structbgp_nexthop_cache*bnc,char*buf,intsize){prefix
2str(&(bnc->node->p),buf,size);returnbuf;}voidbnc_nexthop_free(structbgp_nexthop
_cache*bnc){nexthops_free(bnc->nexthop);}structbgp_nexthop_cache*bnc_new(void){s
tructbgp_nexthop_cache*bnc;bnc=XCALLOC(MTYPE_BGP_NEXTHOP_CACHE,sizeof(structbgp_
nexthop_cache));LIST_INIT(&(bnc->paths));returnbnc;}voidbnc_free(structbgp_nexth
op_cache*bnc){bnc_nexthop_free(bnc);XFREE(MTYPE_BGP_NEXTHOP_CACHE,bnc);}/*Reseta
ndfreeallBGPnexthopcache.*/staticvoidbgp_nexthop_cache_reset(structbgp_table*tab
le){structbgp_node*rn;structbgp_nexthop_cache*bnc;for(rn=bgp_table_top(table);rn
;rn=bgp_route_next(rn))if((bnc=rn->info)!=NULL){bnc_free(bnc);rn->info=NULL;bgp_
unlock_node(rn);}}staticvoid*bgp_tip_hash_alloc(void*p){conststructin_addr*val=(
conststructin_addr*)p;structtip_addr*addr;addr=XMALLOC(MTYPE_TIP_ADDR,sizeof(str
ucttip_addr));addr->refcnt=0;addr->addr.s_addr=val->s_addr;returnaddr;}staticvoi
dbgp_tip_hash_free(void*addr){XFREE(MTYPE_TIP_ADDR,addr);}staticunsignedintbgp_t
ip_hash_key_make(void*p){conststructtip_addr*addr=p;returnjhash_1word(addr->addr
.s_addr,0);}staticintbgp_tip_hash_cmp(constvoid*p1,constvoid*p2){conststructtip_
addr*addr1=p1;conststructtip_addr*addr2=p2;returnaddr1->addr.s_addr==addr2->addr
.s_addr;}voidbgp_tip_hash_init(structbgp*bgp){bgp->tip_hash=hash_create(bgp_tip_
hash_key_make,bgp_tip_hash_cmp,"BGPTIPhash");}voidbgp_tip_hash_destroy(structbgp
*bgp){if(bgp->tip_hash==NULL)return;hash_clean(bgp->tip_hash,bgp_tip_hash_free);
hash_free(bgp->tip_hash);bgp->tip_hash=NULL;}voidbgp_tip_add(structbgp*bgp,struc
tin_addr*tip){structtip_addrtmp;structtip_addr*addr;tmp.addr=*tip;addr=hash_get(
bgp->tip_hash,&tmp,bgp_tip_hash_alloc);if(!addr)return;addr->refcnt++;}voidbgp_t
ip_del(structbgp*bgp,structin_addr*tip){structtip_addrtmp;structtip_addr*addr;tm
p.addr=*tip;addr=hash_lookup(bgp->tip_hash,&tmp);/*mayhavebeendeletedearlierbybg
p_interface_down()*/if(addr==NULL)return;addr->refcnt--;if(addr->refcnt==0){hash
_release(bgp->tip_hash,addr);XFREE(MTYPE_TIP_ADDR,addr);}}staticvoid*bgp_address
_hash_alloc(void*p){conststructin_addr*val=(conststructin_addr*)p;structbgp_addr
*addr;addr=XMALLOC(MTYPE_BGP_ADDR,sizeof(structbgp_addr));addr->refcnt=0;addr->a
ddr.s_addr=val->s_addr;returnaddr;}staticvoidbgp_address_hash_free(void*addr){XF
REE(MTYPE_BGP_ADDR,addr);}staticunsignedintbgp_address_hash_key_make(void*p){con
ststructbgp_addr*addr=p;returnjhash_1word(addr->addr.s_addr,0);}staticintbgp_add
ress_hash_cmp(constvoid*p1,constvoid*p2){conststructbgp_addr*addr1=p1;conststruc
tbgp_addr*addr2=p2;returnaddr1->addr.s_addr==addr2->addr.s_addr;}voidbgp_address
_init(structbgp*bgp){bgp->address_hash=hash_create(bgp_address_hash_key_make,bgp
_address_hash_cmp,"BGPAddressHash");}voidbgp_address_destroy(structbgp*bgp){if(b
gp->address_hash==NULL)return;hash_clean(bgp->address_hash,bgp_address_hash_free
);hash_free(bgp->address_hash);bgp->address_hash=NULL;}staticvoidbgp_address_add
(structbgp*bgp,structprefix*p){structbgp_addrtmp;structbgp_addr*addr;tmp.addr=p-
>u.prefix4;addr=hash_get(bgp->address_hash,&tmp,bgp_address_hash_alloc);if(!addr
)return;addr->refcnt++;}staticvoidbgp_address_del(structbgp*bgp,structprefix*p){
structbgp_addrtmp;structbgp_addr*addr;tmp.addr=p->u.prefix4;addr=hash_lookup(bgp
->address_hash,&tmp);/*mayhavebeendeletedearlierbybgp_interface_down()*/if(addr=
=NULL)return;addr->refcnt--;if(addr->refcnt==0){hash_release(bgp->address_hash,a
ddr);XFREE(MTYPE_BGP_ADDR,addr);}}structbgp_connected_ref{unsignedintrefcnt;};vo
idbgp_connected_add(structbgp*bgp,structconnected*ifc){structprefixp;structprefi
x*addr;structbgp_node*rn;structbgp_connected_ref*bc;structlistnode*node,*nnode;s
tructpeer*peer;addr=ifc->address;p=*(CONNECTED_PREFIX(ifc));if(addr->family==AF_
INET){apply_mask_ipv4((structprefix_ipv4*)&p);if(prefix_ipv4_any((structprefix_i
pv4*)&p))return;bgp_address_add(bgp,addr);rn=bgp_node_get(bgp->connected_table[A
FI_IP],(structprefix*)&p);if(rn->info){bc=rn->info;bc->refcnt++;}else{bc=XCALLOC
(MTYPE_BGP_CONN,sizeof(structbgp_connected_ref));bc->refcnt=1;rn->info=bc;}for(A
LL_LIST_ELEMENTS(bgp->peer,node,nnode,peer)){if(peer->conf_if&&(strcmp(peer->con
f_if,ifc->ifp->name)==0)&&peer->status!=Established&&!CHECK_FLAG(peer->flags,PEE
R_FLAG_IFPEER_V6ONLY)){if(peer_active(peer))BGP_EVENT_ADD(peer,BGP_Stop);BGP_EVE
NT_ADD(peer,BGP_Start);}}}elseif(addr->family==AF_INET6){apply_mask_ipv6((struct
prefix_ipv6*)&p);if(IN6_IS_ADDR_UNSPECIFIED(&p.u.prefix6))return;if(IN6_IS_ADDR_
LINKLOCAL(&p.u.prefix6))return;rn=bgp_node_get(bgp->connected_table[AFI_IP6],(st
ructprefix*)&p);if(rn->info){bc=rn->info;bc->refcnt++;}else{bc=XCALLOC(MTYPE_BGP
_CONN,sizeof(structbgp_connected_ref));bc->refcnt=1;rn->info=bc;}}}voidbgp_conne
cted_delete(structbgp*bgp,structconnected*ifc){structprefixp;structprefix*addr;s
tructbgp_node*rn;structbgp_connected_ref*bc;addr=ifc->address;p=*(CONNECTED_PREF
IX(ifc));if(addr->family==AF_INET){apply_mask_ipv4((structprefix_ipv4*)&p);if(pr
efix_ipv4_any((structprefix_ipv4*)&p))return;bgp_address_del(bgp,addr);rn=bgp_no
de_lookup(bgp->connected_table[AFI_IP],&p);if(!rn)return;bc=rn->info;bc->refcnt-
-;if(bc->refcnt==0){XFREE(MTYPE_BGP_CONN,bc);rn->info=NULL;}bgp_unlock_node(rn);
bgp_unlock_node(rn);}elseif(addr->family==AF_INET6){apply_mask_ipv6((structprefi
x_ipv6*)&p);if(IN6_IS_ADDR_UNSPECIFIED(&p.u.prefix6))return;if(IN6_IS_ADDR_LINKL
OCAL(&p.u.prefix6))return;rn=bgp_node_lookup(bgp->connected_table[AFI_IP6],(stru
ctprefix*)&p);if(!rn)return;bc=rn->info;bc->refcnt--;if(bc->refcnt==0){XFREE(MTY
PE_BGP_CONN,bc);rn->info=NULL;}bgp_unlock_node(rn);bgp_unlock_node(rn);}}intbgp_
nexthop_self(structbgp*bgp,structin_addrnh_addr){structbgp_addrtmp,*addr;structt
ip_addrtmp_tip,*tip;tmp.addr=nh_addr;addr=hash_lookup(bgp->address_hash,&tmp);if
(addr)return1;tmp_tip.addr=nh_addr;tip=hash_lookup(bgp->tip_hash,&tmp_tip);if(ti
p)return1;return0;}intbgp_multiaccess_check_v4(structin_addrnexthop,structpeer*p
eer){structbgp_node*rn1;structbgp_node*rn2;structprefixp;intret;p.family=AF_INET
;p.prefixlen=IPV4_MAX_BITLEN;p.u.prefix4=nexthop;rn1=bgp_node_match(peer->bgp->c
onnected_table[AFI_IP],&p);if(!rn1)return0;p.family=AF_INET;p.prefixlen=IPV4_MAX
_BITLEN;p.u.prefix4=peer->su.sin.sin_addr;rn2=bgp_node_match(peer->bgp->connecte
d_table[AFI_IP],&p);if(!rn2){bgp_unlock_node(rn1);return0;}ret=(rn1==rn2)?1:0;bg
p_unlock_node(rn1);bgp_unlock_node(rn2);return(ret);}intbgp_subgrp_multiaccess_c
heck_v4(structin_addrnexthop,structupdate_subgroup*subgrp){structbgp_node*rn1,*r
n2;structpeer_af*paf;structprefixp,np;structbgp*bgp=NULL;np.family=AF_INET;np.pr
efixlen=IPV4_MAX_BITLEN;np.u.prefix4=nexthop;p.family=AF_INET;p.prefixlen=IPV4_M
AX_BITLEN;rn1=rn2=NULL;bgp=SUBGRP_INST(subgrp);rn1=bgp_node_match(bgp->connected
_table[AFI_IP],&np);if(!rn1)return0;SUBGRP_FOREACH_PEER(subgrp,paf){p.u.prefix4=
paf->peer->su.sin.sin_addr;rn2=bgp_node_match(bgp->connected_table[AFI_IP],&p);i
f(rn1==rn2){bgp_unlock_node(rn1);bgp_unlock_node(rn2);return1;}if(rn2)bgp_unlock
_node(rn2);}bgp_unlock_node(rn1);return0;}staticvoidbgp_show_nexthops_detail(str
uctvty*vty,structbgp*bgp,structbgp_nexthop_cache*bnc){charbuf[PREFIX2STR_BUFFER]
;structnexthop*nexthop;for(nexthop=bnc->nexthop;nexthop;nexthop=nexthop->next)sw
itch(nexthop->type){caseNEXTHOP_TYPE_IPV6:vty_out(vty,"gate%s\n",inet_ntop(AF_IN
ET6,&nexthop->gate.ipv6,buf,sizeof(buf)));break;caseNEXTHOP_TYPE_IPV6_IFINDEX:vt
y_out(vty,"gate%s,if%s\n",inet_ntop(AF_INET6,&nexthop->gate.ipv6,buf,sizeof(buf)
),ifindex2ifname(nexthop->ifindex,bgp->vrf_id));break;caseNEXTHOP_TYPE_IPV4:vty_
out(vty,"gate%s\n",inet_ntop(AF_INET,&nexthop->gate.ipv4,buf,sizeof(buf)));break
;caseNEXTHOP_TYPE_IFINDEX:vty_out(vty,"if%s\n",ifindex2ifname(nexthop->ifindex,b
gp->vrf_id));break;caseNEXTHOP_TYPE_IPV4_IFINDEX:vty_out(vty,"gate%s,if%s\n",ine
t_ntop(AF_INET,&nexthop->gate.ipv4,buf,sizeof(buf)),ifindex2ifname(nexthop->ifin
dex,bgp->vrf_id));break;caseNEXTHOP_TYPE_BLACKHOLE:vty_out(vty,"blackhole\n");br
eak;default:vty_out(vty,"invalidnexthoptype%u\n",nexthop->type);}}staticvoidbgp_
show_nexthops(structvty*vty,structbgp*bgp,intdetail){structbgp_node*rn;structbgp
_nexthop_cache*bnc;charbuf[PREFIX2STR_BUFFER];time_ttbuf;afi_tafi;vty_out(vty,"C
urrentBGPnexthopcache:\n");for(afi=AFI_IP;afi<AFI_MAX;afi++){if(!bgp->nexthop_ca
che_table[afi])continue;for(rn=bgp_table_top(bgp->nexthop_cache_table[afi]);rn;r
n=bgp_route_next(rn)){if((bnc=rn->info)!=NULL){if(CHECK_FLAG(bnc->flags,BGP_NEXT
HOP_VALID)){vty_out(vty,"%svalid[IGPmetric%d],#paths%d\n",inet_ntop(rn->p.family
,&rn->p.u.prefix,buf,sizeof(buf)),bnc->metric,bnc->path_count);if(!detail)contin
ue;bgp_show_nexthops_detail(vty,bgp,bnc);}else{vty_out(vty,"%sinvalid\n",inet_nt
op(rn->p.family,&rn->p.u.prefix,buf,sizeof(buf)));if(CHECK_FLAG(bnc->flags,BGP_N
EXTHOP_CONNECTED))vty_out(vty,"MustbeConnected\n");}tbuf=time(NULL)-(bgp_clock()
-bnc->last_update);vty_out(vty,"Lastupdate:%s",ctime(&tbuf));vty_out(vty,"\n");}
}}}staticintshow_ip_bgp_nexthop_table(structvty*vty,constchar*name,intdetail){st
ructbgp*bgp;if(name)bgp=bgp_lookup_by_name(name);elsebgp=bgp_get_default();if(!b
gp){vty_out(vty,"%%NosuchBGPinstanceexist\n");returnCMD_WARNING;}bgp_show_nextho
ps(vty,bgp,detail);returnCMD_SUCCESS;}staticvoidbgp_show_all_instances_nexthops_
vty(structvty*vty){structlistnode*node,*nnode;structbgp*bgp;for(ALL_LIST_ELEMENT
S(bm->bgp,node,nnode,bgp)){vty_out(vty,"\nInstance%s:\n",(bgp->inst_type==BGP_IN
STANCE_TYPE_DEFAULT)?"Default":bgp->name);bgp_show_nexthops(vty,bgp,0);}}DEFUN(s
how_ip_bgp_nexthop,show_ip_bgp_nexthop_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]ne
xthop[detail]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STR"BGPnexthoptable\n""Sho
wdetailedinformation\n"){intidx=0;char*vrf=NULL;if(argv_find(argv,argc,"view",&i
dx)||argv_find(argv,argc,"vrf",&idx))vrf=argv[++idx]->arg;intdetail=argv_find(ar
gv,argc,"detail",&idx)?1:0;returnshow_ip_bgp_nexthop_table(vty,vrf,detail);}DEFU
N(show_ip_bgp_instance_all_nexthop,show_ip_bgp_instance_all_nexthop_cmd,"show[ip
]bgp<view|vrf>allnexthop",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_ALL_HELP_STR"BGPnext
hoptable\n"){bgp_show_all_instances_nexthops_vty(vty);returnCMD_SUCCESS;}voidbgp
_scan_init(structbgp*bgp){afi_tafi;for(afi=AFI_IP;afi<AFI_MAX;afi++){bgp->nextho
p_cache_table[afi]=bgp_table_init(afi,SAFI_UNICAST);bgp->connected_table[afi]=bg
p_table_init(afi,SAFI_UNICAST);bgp->import_check_table[afi]=bgp_table_init(afi,S
AFI_UNICAST);}}voidbgp_scan_vty_init(void){install_element(VIEW_NODE,&show_ip_bg
p_nexthop_cmd);install_element(VIEW_NODE,&show_ip_bgp_instance_all_nexthop_cmd);
}voidbgp_scan_finish(structbgp*bgp){afi_tafi;for(afi=AFI_IP;afi<AFI_MAX;afi++){/
*Onlythecurrentoneneedstobereset.*/bgp_nexthop_cache_reset(bgp->nexthop_cache_ta
ble[afi]);bgp_table_unlock(bgp->nexthop_cache_table[afi]);bgp->nexthop_cache_tab
le[afi]=NULL;bgp_table_unlock(bgp->connected_table[afi]);bgp->connected_table[af
i]=NULL;bgp_table_unlock(bgp->import_check_table[afi]);bgp->import_check_table[a
fi]=NULL;}}