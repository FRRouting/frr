/*BGPRDdefinitionsforBGP-basedVPNs(IP/EVPN)*--broughtoverfrombgpd/bgp_mplsvpn.c*
Copyright(C)2000KunihiroIshiguro<kunihiro@zebra.org>**ThisfileispartofFRR.**FRRi
sfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPub
licLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption
)any*laterversion.**FRRisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWA
RRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPUR
POSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyof
theGNUGeneralPublicLicense*alongwithFRR;seethefileCOPYING.Ifnot,writetotheFree*S
oftwareFoundation,Inc.,59TemplePlace-Suite330,Boston,MA*02111-1307,USA.*/#includ
e<zebra.h>#include"command.h"#include"log.h"#include"prefix.h"#include"memory.h"
#include"stream.h"#include"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_rd.h"
#include"bgpd/bgp_attr.h"#ifENABLE_BGP_VNC#include"bgpd/rfapi/rfapi_backend.h"#e
ndifuint16_tdecode_rd_type(uint8_t*pnt){uint16_tv;v=((uint16_t)*pnt++<<8);#ifENA
BLE_BGP_VNC/**VNCL2storesLHIinlowerbyte,soomitit*/if(v!=RD_TYPE_VNC_ETH)v|=(uint
16_t)*pnt;#else/*duplicatecodeforclarity*/v|=(uint16_t)*pnt;#endifreturnv;}voide
ncode_rd_type(uint16_tv,uint8_t*pnt){*((uint16_t*)pnt)=htons(v);}/*type==RD_TYPE
_AS*/voiddecode_rd_as(uint8_t*pnt,structrd_as*rd_as){rd_as->as=(uint16_t)*pnt++<
<8;rd_as->as|=(uint16_t)*pnt++;ptr_get_be32(pnt,&rd_as->val);}/*type==RD_TYPE_AS
4*/voiddecode_rd_as4(uint8_t*pnt,structrd_as*rd_as){pnt=ptr_get_be32(pnt,&rd_as-
>as);rd_as->val=((uint16_t)*pnt++<<8);rd_as->val|=(uint16_t)*pnt;}/*type==RD_TYP
E_IP*/voiddecode_rd_ip(uint8_t*pnt,structrd_ip*rd_ip){memcpy(&rd_ip->ip,pnt,4);p
nt+=4;rd_ip->val=((uint16_t)*pnt++<<8);rd_ip->val|=(uint16_t)*pnt;}#ifENABLE_BGP
_VNC/*type==RD_TYPE_VNC_ETH*/voiddecode_rd_vnc_eth(uint8_t*pnt,structrd_vnc_eth*
rd_vnc_eth){rd_vnc_eth->type=RD_TYPE_VNC_ETH;rd_vnc_eth->local_nve_id=pnt[1];mem
cpy(rd_vnc_eth->macaddr.octet,pnt+2,ETH_ALEN);}#endifintstr2prefix_rd(constchar*
str,structprefix_rd*prd){intret;/*retofcalledfunctions*/intlret;/*localret,ofthi
sfunc*/char*p;char*p2;structstream*s=NULL;char*half=NULL;structin_addraddr;s=str
eam_new(8);prd->family=AF_UNSPEC;prd->prefixlen=64;lret=0;p=strchr(str,':');if(!
p)gotoout;if(!all_digit(p+1))gotoout;half=XMALLOC(MTYPE_TMP,(p-str)+1);memcpy(ha
lf,str,(p-str));half[p-str]='\0';p2=strchr(str,'.');if(!p2){unsignedlongas_val;i
f(!all_digit(half))gotoout;as_val=atol(half);if(as_val>0xffff){stream_putw(s,RD_
TYPE_AS4);stream_putl(s,as_val);stream_putw(s,atol(p+1));}else{stream_putw(s,RD_
TYPE_AS);stream_putw(s,as_val);stream_putl(s,atol(p+1));}}else{ret=inet_aton(hal
f,&addr);if(!ret)gotoout;stream_putw(s,RD_TYPE_IP);stream_put_in_addr(s,&addr);s
tream_putw(s,atol(p+1));}memcpy(prd->val,s->data,8);lret=1;out:if(s)stream_free(
s);if(half)XFREE(MTYPE_TMP,half);returnlret;}char*prefix_rd2str(structprefix_rd*
prd,char*buf,size_tsize){uint8_t*pnt;uint16_ttype;structrd_asrd_as;structrd_iprd
_ip;assert(size>=RD_ADDRSTRLEN);pnt=prd->val;type=decode_rd_type(pnt);if(type==R
D_TYPE_AS){decode_rd_as(pnt+2,&rd_as);snprintf(buf,size,"%u:%d",rd_as.as,rd_as.v
al);returnbuf;}elseif(type==RD_TYPE_AS4){decode_rd_as4(pnt+2,&rd_as);snprintf(bu
f,size,"%u:%d",rd_as.as,rd_as.val);returnbuf;}elseif(type==RD_TYPE_IP){decode_rd
_ip(pnt+2,&rd_ip);snprintf(buf,size,"%s:%d",inet_ntoa(rd_ip.ip),rd_ip.val);retur
nbuf;}#ifENABLE_BGP_VNCelseif(type==RD_TYPE_VNC_ETH){snprintf(buf,size,"LHI:%d,%
02x:%02x:%02x:%02x:%02x:%02x",*(pnt+1),/*LHI*/*(pnt+2),/*MAC[0]*/*(pnt+3),*(pnt+
4),*(pnt+5),*(pnt+6),*(pnt+7));returnbuf;}#endifsnprintf(buf,size,"UnknownType:%
d",type);returnbuf;}