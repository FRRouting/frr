/*BGPpacketmanagementroutine.*Containsutilityfunctionsforconstructingandconsumin
gBGPmessages.*Copyright(C)2017CumulusNetworks*Copyright(C)1999KunihiroIshiguro**
ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodi
fyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFound
ation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedint
hehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*
MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseform
oredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthi
sprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Frankl
inSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<sys/time.h>#in
clude"thread.h"#include"stream.h"#include"network.h"#include"prefix.h"#include"c
ommand.h"#include"log.h"#include"memory.h"#include"sockunion.h"/*forinet_ntop()*
/#include"sockopt.h"#include"linklist.h"#include"plist.h"#include"queue.h"#inclu
de"filter.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgpd/bgp_dum
p.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_fsm.h"#
include"bgpd/bgp_route.h"#include"bgpd/bgp_packet.h"#include"bgpd/bgp_open.h"#in
clude"bgpd/bgp_aspath.h"#include"bgpd/bgp_community.h"#include"bgpd/bgp_ecommuni
ty.h"#include"bgpd/bgp_lcommunity.h"#include"bgpd/bgp_network.h"#include"bgpd/bg
p_mplsvpn.h"#include"bgpd/bgp_evpn.h"#include"bgpd/bgp_advertise.h"#include"bgpd
/bgp_vty.h"#include"bgpd/bgp_updgrp.h"#include"bgpd/bgp_label.h"#include"bgpd/bg
p_io.h"#include"bgpd/bgp_keepalives.h"#include"bgpd/bgp_flowspec.h"/***Setsmarke
randtypefieldsforaBGPmessage.**@paramsthestreamcontainingthepacket*@paramtypethe
packettype*@returnthesizeofthestream*/intbgp_packet_set_marker(structstream*s,ui
nt8_ttype){inti;/*Fillinmarker.*/for(i=0;i<BGP_MARKER_SIZE;i++)stream_putc(s,0xf
f);/*Dummytotallength.Thisfieldisshouldbefilledinlateron.*/stream_putw(s,0);/*BG
Ppackettype.*/stream_putc(s,type);/*Returncurrentstreamsize.*/returnstream_get_e
ndp(s);}/***SetssizefieldforaBGPmessage.**Sizefieldissettothesizeofthestreampass
ed.**@paramsthestreamcontainingthepacket*@returnthesizeofthestream*/intbgp_packe
t_set_size(structstream*s){intcp;/*Preservecurrentpointer.*/cp=stream_get_endp(s
);stream_putw_at(s,BGP_MARKER_SIZE,cp);returncp;}/**Pushapacketontothebeginningo
fthepeer'soutputqueue.*Thisfunctionacquiresthepeer'swritemutexbeforeproceeding.*
/staticvoidbgp_packet_add(structpeer*peer,structstream*s){pthread_mutex_lock(&pe
er->io_mtx);stream_fifo_push(peer->obuf,s);pthread_mutex_unlock(&peer->io_mtx);}
staticstructstream*bgp_update_packet_eor(structpeer*peer,afi_tafi,safi_tsafi){st
ructstream*s;iana_afi_tpkt_afi;iana_safi_tpkt_safi;if(DISABLE_BGP_ANNOUNCE)retur
nNULL;if(bgp_debug_neighbor_events(peer))zlog_debug("sendEnd-of-RIBfor%sto%s",af
i_safi_print(afi,safi),peer->host);s=stream_new(BGP_MAX_PACKET_SIZE);/*MakeBGPup
datepacket.*/bgp_packet_set_marker(s,BGP_MSG_UPDATE);/*UnfeasibleRoutesLength*/s
tream_putw(s,0);if(afi==AFI_IP&&safi==SAFI_UNICAST){/*TotalPathAttributeLength*/
stream_putw(s,0);}else{/*ConvertAFI,SAFItovaluesforpacket.*/bgp_map_afi_safi_int
2iana(afi,safi,&pkt_afi,&pkt_safi);/*TotalPathAttributeLength*/stream_putw(s,6);
stream_putc(s,BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_MP_UNREACH_NLRI);st
ream_putc(s,3);stream_putw(s,pkt_afi);stream_putc(s,pkt_safi);}bgp_packet_set_si
ze(s);returns;}/*CalledwhenthereisachangeintheEOR(implicitorexplicit)statusofa*p
eer.Endstheupdate-delayifallexpectedpeersaredonewithEORs.*/voidbgp_check_update_
delay(structbgp*bgp){structlistnode*node,*nnode;structpeer*peer=NULL;if(bgp_debu
g_neighbor_events(peer))zlog_debug("Checkingupdatedelay,T:%dR:%dI:%dE:%d",bgp->e
stablished,bgp->restarted_peers,bgp->implicit_eors,bgp->explicit_eors);if(bgp->e
stablished<=bgp->restarted_peers+bgp->implicit_eors+bgp->explicit_eors){/**Thisi
sanextrasanitychecktomakesurewewaitforall*theeligibleconfiguredpeers.Thischeckis
performedif*establishwaittimerison,orestablishwaitoptionisnot*givenwiththeupdate
-delaycommand*/if(bgp->t_establish_wait||(bgp->v_establish_wait==bgp->v_update_d
elay))for(ALL_LIST_ELEMENTS(bgp->peer,node,nnode,peer)){if(CHECK_FLAG(peer->flag
s,PEER_FLAG_CONFIG_NODE)&&!CHECK_FLAG(peer->flags,PEER_FLAG_SHUTDOWN)&&!peer->up
date_delay_over){if(bgp_debug_neighbor_events(peer))zlog_debug("Peer%spending,co
ntinuingread-onlymode",peer->host);return;}}zlog_info("Updatedelayended,restarte
d:%d,EORsimplicit:%d,explicit:%d",bgp->restarted_peers,bgp->implicit_eors,bgp->e
xplicit_eors);bgp_update_delay_end(bgp);}}/**Calledifpeerisknowntohaverestarted.
Therestart-statebitin*Graceful-Restartcapabilityisusedforthat*/voidbgp_update_re
started_peers(structpeer*peer){if(!bgp_update_delay_active(peer->bgp))return;/*B
GPupdatedelayhasended*/if(peer->update_delay_over)return;/*Thispeerhasalreadybee
nconsidered*/if(bgp_debug_neighbor_events(peer))zlog_debug("Peer%s:Checkingresta
rted",peer->host);if(peer->status==Established){peer->update_delay_over=1;peer->
bgp->restarted_peers++;bgp_check_update_delay(peer->bgp);}}/**Calledaspeerreceiv
esakeep-alive.Determinesifthisoccurencecanbe*takenasanimplicitEORforthispeer.*NO
TE:Theveryfirstkeep-aliveaftertheEstablishedstateofapeeris*consideredimplicitEOR
fortheupdate-delaypurposes*/voidbgp_update_implicit_eors(structpeer*peer){if(!bg
p_update_delay_active(peer->bgp))return;/*BGPupdatedelayhasended*/if(peer->updat
e_delay_over)return;/*Thispeerhasalreadybeenconsidered*/if(bgp_debug_neighbor_ev
ents(peer))zlog_debug("Peer%s:CheckingimplicitEORs",peer->host);if(peer->status=
=Established){peer->update_delay_over=1;peer->bgp->implicit_eors++;bgp_check_upd
ate_delay(peer->bgp);}}/**ShouldbecalledonlywhenthereisachangeintheEOR_RECEIVEDs
tatus*foranyafi/safionapeer.*/staticvoidbgp_update_explicit_eors(structpeer*peer
){afi_tafi;safi_tsafi;if(!bgp_update_delay_active(peer->bgp))return;/*BGPupdated
elayhasended*/if(peer->update_delay_over)return;/*Thispeerhasalreadybeenconsider
ed*/if(bgp_debug_neighbor_events(peer))zlog_debug("Peer%s:CheckingexplicitEORs",
peer->host);for(afi=AFI_IP;afi<AFI_MAX;afi++)for(safi=SAFI_UNICAST;safi<SAFI_MAX
;safi++){if(peer->afc_nego[afi][safi]&&!CHECK_FLAG(peer->af_sflags[afi][safi],PE
ER_STATUS_EOR_RECEIVED)){if(bgp_debug_neighbor_events(peer))zlog_debug("afi%dsaf
i%ddidntreceiveEOR",afi,safi);return;}}peer->update_delay_over=1;peer->bgp->expl
icit_eors++;bgp_check_update_delay(peer->bgp);}/***FrontendforNLRIparsing,tofan-
outtoAFI/SAFIspecificparsers.**mp_withdraw,ifset,isusedtonullifyattrstructureonm
ostofthe*callingsafifunctionandforevpn,passedasparameter*/intbgp_nlri_parse(stru
ctpeer*peer,structattr*attr,structbgp_nlri*packet,intmp_withdraw){switch(packet-
>safi){caseSAFI_UNICAST:caseSAFI_MULTICAST:returnbgp_nlri_parse_ip(peer,mp_withd
raw?NULL:attr,packet);caseSAFI_LABELED_UNICAST:returnbgp_nlri_parse_label(peer,m
p_withdraw?NULL:attr,packet);caseSAFI_MPLS_VPN:returnbgp_nlri_parse_vpn(peer,mp_
withdraw?NULL:attr,packet);caseSAFI_EVPN:returnbgp_nlri_parse_evpn(peer,attr,pac
ket,mp_withdraw);caseSAFI_FLOWSPEC:returnbgp_nlri_parse_flowspec(peer,attr,packe
t,mp_withdraw);}return-1;}/**Checksavarietyofconditionstodeterminewhetherthepeer
needstobe*rescheduledforpacketgenerationagain,anddoessoifnecessary.**@parampeert
ocheckforrescheduling*/staticvoidbgp_write_proceed_actions(structpeer*peer){afi_
tafi;safi_tsafi;structpeer_af*paf;structbpacket*next_pkt;structupdate_subgroup*s
ubgrp;FOREACH_AFI_SAFI(afi,safi){paf=peer_af_find(peer,afi,safi);if(!paf)continu
e;subgrp=paf->subgroup;if(!subgrp)continue;next_pkt=paf->next_pkt_to_send;if(nex
t_pkt&&next_pkt->buffer){BGP_TIMER_ON(peer->t_generate_updgrp_packets,bgp_genera
te_updgrp_packets,0);return;}/*NopacketsreadilyavailableforAFI/SAFI,arethere*sub
grouppackets*thatneedtobegenerated?*/if(bpacket_queue_is_full(SUBGRP_INST(subgrp
),SUBGRP_PKTQ(subgrp))||subgroup_packets_to_build(subgrp)){BGP_TIMER_ON(peer->t_
generate_updgrp_packets,bgp_generate_updgrp_packets,0);return;}/*Nopacketstosend
,seeifEORispending*/if(CHECK_FLAG(peer->cap,PEER_CAP_RESTART_RCV)){if(!subgrp->t
_coalesce&&peer->afc_nego[afi][safi]&&peer->synctime&&!CHECK_FLAG(peer->af_sflag
s[afi][safi],PEER_STATUS_EOR_SEND)&&safi!=SAFI_MPLS_VPN){BGP_TIMER_ON(peer->t_ge
nerate_updgrp_packets,bgp_generate_updgrp_packets,0);return;}}}}/**Generateadver
tisementinformation(withdraws,updates,EOR)fromeach*updategroupapeerbelongsto,enc
odethisinformationintopackets,and*enqueuethepacketsontothepeer'soutputbuffer.*/i
ntbgp_generate_updgrp_packets(structthread*thread){structpeer*peer=THREAD_ARG(th
read);structstream*s;structpeer_af*paf;structbpacket*next_pkt;uint32_twpq;uint32
_tgenerated=0;afi_tafi;safi_tsafi;wpq=atomic_load_explicit(&peer->bgp->wpkt_quan
ta,memory_order_relaxed);/**Thecodebeyondthispartdealswithupdatepackets,proceedo
nly*ifpeerisEstablishedandupdatesarenotonhold(aspartof*update-delaypostprocessin
g).*/if(peer->status!=Established)return0;if(peer->bgp->main_peers_update_hold)r
eturn0;do{s=NULL;FOREACH_AFI_SAFI(afi,safi){paf=peer_af_find(peer,afi,safi);if(!
paf||!PAF_SUBGRP(paf))continue;next_pkt=paf->next_pkt_to_send;/**Trytogenerateap
acketforthepeerifweareat*theendofthelist.Alwaystrytopushout*WITHDRAWsfirst.*/if(
!next_pkt||!next_pkt->buffer){next_pkt=subgroup_withdraw_packet(PAF_SUBGRP(paf))
;if(!next_pkt||!next_pkt->buffer)subgroup_update_packet(PAF_SUBGRP(paf));next_pk
t=paf->next_pkt_to_send;}/**Ifwestilldon'thaveapackettosendtothepeer,*thentrytof
indoutoutifwehavetosendeoror*ifnot,skiptothenextAFI,SAFI.Don'tsendthe*EORprematu
rely;ifthesubgroup'scoalescetimeris*running,theadjacency-outstructureisnotcreate
d*yet.*/if(!next_pkt||!next_pkt->buffer){if(CHECK_FLAG(peer->cap,PEER_CAP_RESTAR
T_RCV)){if(!(PAF_SUBGRP(paf))->t_coalesce&&peer->afc_nego[afi][safi]&&peer->sync
time&&!CHECK_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_EOR_SEND)){SET_FLAG(pee
r->af_sflags[afi][safi],PEER_STATUS_EOR_SEND);if((s=bgp_update_packet_eor(peer,a
fi,safi))){bgp_packet_add(peer,s);}}}continue;}/*Foundapackettemplatetosend,over
write*packetwithappropriateattributesfrompeer*andadvancepeer*/s=bpacket_reformat
_for_peer(next_pkt,paf);bgp_packet_add(peer,s);bpacket_queue_advance_peer(paf);}
}while(s&&(++generated<wpq));if(generated)bgp_writes_on(peer);bgp_write_proceed_
actions(peer);return0;}/**CreatesaBGPKeepalivepacketandappendsittothepeer'soutpu
tqueue.*/voidbgp_keepalive_send(structpeer*peer){structstream*s;s=stream_new(BGP
_MAX_PACKET_SIZE);/*Makekeepalivepacket.*/bgp_packet_set_marker(s,BGP_MSG_KEEPAL
IVE);/*Setpacketsize.*/(void)bgp_packet_set_size(s);/*Dumppacketifdebugoptioniss
et.*//*bgp_packet_dump(s);*/if(bgp_debug_keepalive(peer))zlog_debug("%ssendingKE
EPALIVE",peer->host);/*Addpackettothepeer.*/bgp_packet_add(peer,s);bgp_writes_on
(peer);}/**CreatesaBGPOpenpacketandappendsittothepeer'soutputqueue.*Setscapabili
tiesasnecessary.*/voidbgp_open_send(structpeer*peer){structstream*s;uint16_tsend
_holdtime;as_tlocal_as;if(PEER_OR_GROUP_TIMER_SET(peer))send_holdtime=peer->hold
time;elsesend_holdtime=peer->bgp->default_holdtime;/*local-asChange*/if(peer->ch
ange_local_as)local_as=peer->change_local_as;elselocal_as=peer->local_as;s=strea
m_new(BGP_MAX_PACKET_SIZE);/*Makeopenpacket.*/bgp_packet_set_marker(s,BGP_MSG_OP
EN);/*Setopenpacketvalues.*/stream_putc(s,BGP_VERSION_4);/*BGPversion*/stream_pu
tw(s,(local_as<=BGP_AS_MAX)?(uint16_t)local_as:BGP_AS_TRANS);stream_putw(s,send_
holdtime);/*HoldTime*/stream_put_in_addr(s,&peer->local_id);/*BGPIdentifier*//*S
etcapabilitycode.*/bgp_open_capability(s,peer);/*SetBGPpacketlength.*/(void)bgp_
packet_set_size(s);if(bgp_debug_neighbor_events(peer))zlog_debug("%ssendingOPEN,
version%d,myas%u,holdtime%d,id%s",peer->host,BGP_VERSION_4,local_as,send_holdtim
e,inet_ntoa(peer->local_id));/*Dumppacketifdebugoptionisset.*//*bgp_packet_dump(
s);*//*Addpackettothepeer.*/bgp_packet_add(peer,s);bgp_writes_on(peer);}/**Write
sNOTIFICATIONmessagedirectlytoapeersocketwithoutwaitingfor*theI/Othread.**Therem
ustbeexactlyonestreamonthepeer->obufFIFO,andthedatawithin*thisstreammustmatchthe
formatofaBGPNOTIFICATIONmessage.*Transmissionisbest-effort.**@requirespeer->io_m
tx*@parampeer*@return0*/staticintbgp_write_notify(structpeer*peer){intret,val;ui
nt8_ttype;structstream*s;/*Thereshouldbeatleastonepacket.*/s=stream_fifo_pop(pee
r->obuf);if(!s)return0;assert(stream_get_endp(s)>=BGP_HEADER_SIZE);/*Stopcollect
ingdatawithinthesocket*/sockopt_cork(peer->fd,0);/**socketisinnonblockingmode,if
wecan'tdelivertheNOTIFY,well,*weonlycareaboutgettingacleanshutdownatthispoint.*/
ret=write(peer->fd,STREAM_DATA(s),stream_get_endp(s));/**onlyconnectionreset/clo
segetscountedasTCP_fatal_error,failure*towritetheentireNOTIFYdoesn'tgetdifferent
FSMtreatment*/if(ret<=0){stream_free(s);BGP_EVENT_ADD(peer,TCP_fatal_error);retu
rn0;}/*DisableNagle,makeNOTIFYpacketgooutrightaway*/val=1;(void)setsockopt(peer-
>fd,IPPROTO_TCP,TCP_NODELAY,(char*)&val,sizeof(val));/*RetrieveBGPpackettype.*/s
tream_set_getp(s,BGP_MARKER_SIZE+2);type=stream_getc(s);assert(type==BGP_MSG_NOT
IFY);/*Typeshouldbenotify.*/atomic_fetch_add_explicit(&peer->notify_out,1,memory
_order_relaxed);peer->notify_out++;/*Doublestarttimer.*/peer->v_start*=2;/*Overf
lowcheck.*/if(peer->v_start>=(60*2))peer->v_start=(60*2);/**HandleGracefulRestar
tcasewherethestatechangesto*ConnectinsteadofIdle*/BGP_EVENT_ADD(peer,BGP_Stop);s
tream_free(s);return0;}/**CreatesaBGPNotifyandappendsittothepeer'soutputqueue.**
Thisfunctionattemptstowritethepacketfromthethreaditiscalled*from,toensurethepack
etgetsoutASAP.**Thisfunctionmaybecalledfrommultiplethreads.Sincethefunction*modi
fiesI/Obuffer(s)inthepeer,thesearelockedforthedurationofthe*calltopreventtamperi
ngfromotherthreads.**DeliveryoftheNOTIFICATIONisattemptedonceandisbest-effort.Af
ter*return,thepeerstructure*must*bereset;noassumptionsaboutsession*statearevalid
.**@parampeer*@paramcodeBGPerrorcode*@paramsub_codeBGPerrorsubcode*@paramdataDat
aportion*@paramdatalenlengthofdataportion*/voidbgp_notify_send_with_data(structp
eer*peer,uint8_tcode,uint8_tsub_code,uint8_t*data,size_tdatalen){structstream*s;
intlength;/*LockI/Omutextopreventotherthreadsfrompushingpackets*/pthread_mutex_l
ock(&peer->io_mtx);/*==============================================*//*Allocaten
ewstream.*/s=stream_new(BGP_MAX_PACKET_SIZE);/*Makenotifypacket.*/bgp_packet_set
_marker(s,BGP_MSG_NOTIFY);/*Setnotifypacketvalues.*/stream_putc(s,code);/*BGPnot
ifycode*/stream_putc(s,sub_code);/*BGPnotifysub_code*//*Ifnotifydataispresent.*/
if(data)stream_write(s,data,datalen);/*SetBGPpacketlength.*/length=bgp_packet_se
t_size(s);/*wipeoutputbuffer*/stream_fifo_clean(peer->obuf);/**Ifpossible,storel
astpacketfordebuggingpurposes.Thischeckis*inplacebecausewearesometimescalledwith
adoppelgangerpeer,*whotendstohaveaplethoraoffieldsnulledout.*/if(peer->curr&&pee
r->last_reset_cause_size){size_tpacketsize=stream_get_endp(peer->curr);assert(pa
cketsize<=peer->last_reset_cause_size);memcpy(peer->last_reset_cause,peer->curr-
>data,packetsize);peer->last_reset_cause_size=packetsize;}/*Fordebug*/{structbgp
_notifybgp_notify;intfirst=0;inti;charc[4];bgp_notify.code=code;bgp_notify.subco
de=sub_code;bgp_notify.data=NULL;bgp_notify.length=length-BGP_MSG_NOTIFY_MIN_SIZ
E;bgp_notify.raw_data=data;peer->notify.code=bgp_notify.code;peer->notify.subcod
e=bgp_notify.subcode;if(bgp_notify.length){bgp_notify.data=XMALLOC(MTYPE_TMP,bgp
_notify.length*3);for(i=0;i<bgp_notify.length;i++)if(first){sprintf(c,"%02x",dat
a[i]);strcat(bgp_notify.data,c);}else{first=1;sprintf(c,"%02x",data[i]);strcpy(b
gp_notify.data,c);}}bgp_notify_print(peer,&bgp_notify,"sending");if(bgp_notify.d
ata){XFREE(MTYPE_TMP,bgp_notify.data);bgp_notify.data=NULL;bgp_notify.length=0;}
}/*peerresetcause*/if(code==BGP_NOTIFY_CEASE){if(sub_code==BGP_NOTIFY_CEASE_ADMI
N_RESET)peer->last_reset=PEER_DOWN_USER_RESET;elseif(sub_code==BGP_NOTIFY_CEASE_
ADMIN_SHUTDOWN)peer->last_reset=PEER_DOWN_USER_SHUTDOWN;elsepeer->last_reset=PEE
R_DOWN_NOTIFY_SEND;}elsepeer->last_reset=PEER_DOWN_NOTIFY_SEND;/*Addpackettopeer
'soutputqueue*/stream_fifo_push(peer->obuf,s);bgp_write_notify(peer);/*=========
=====================================*/pthread_mutex_unlock(&peer->io_mtx);}/**C
reatesaBGPNotifyandappendsittothepeer'soutputqueue.**Thisfunctionattemptstowrite
thepacketfromthethreaditiscalled*from,toensurethepacketgetsoutASAP.**@parampeer*
@paramcodeBGPerrorcode*@paramsub_codeBGPerrorsubcode*/voidbgp_notify_send(struct
peer*peer,uint8_tcode,uint8_tsub_code){bgp_notify_send_with_data(peer,code,sub_c
ode,NULL,0);}/**CreatesBGPRouteRefreshpacketandappendsittothepeer'soutputqueue.*
*@parampeer*@paramafiAddressFamilyIdentifier*@paramsafiSubsequentAddressFamilyId
entifier*@paramorf_typeOutboundRouteFilteringtype*@paramwhen_to_refreshWhetherto
refreshimmediatelyordefer*@paramremoveWhethertoremoveORFforspecifiedAFI/SAFI*/vo
idbgp_route_refresh_send(structpeer*peer,afi_tafi,safi_tsafi,uint8_torf_type,uin
t8_twhen_to_refresh,intremove){structstream*s;structbgp_filter*filter;intorf_ref
resh=0;iana_afi_tpkt_afi;iana_safi_tpkt_safi;if(DISABLE_BGP_ANNOUNCE)return;filt
er=&peer->filter[afi][safi];/*ConvertAFI,SAFItovaluesforpacket.*/bgp_map_afi_saf
i_int2iana(afi,safi,&pkt_afi,&pkt_safi);s=stream_new(BGP_MAX_PACKET_SIZE);/*Make
BGPupdatepacket.*/if(CHECK_FLAG(peer->cap,PEER_CAP_REFRESH_NEW_RCV))bgp_packet_s
et_marker(s,BGP_MSG_ROUTE_REFRESH_NEW);elsebgp_packet_set_marker(s,BGP_MSG_ROUTE
_REFRESH_OLD);/*EncodeRouteRefreshmessage.*/stream_putw(s,pkt_afi);stream_putc(s
,0);stream_putc(s,pkt_safi);if(orf_type==ORF_TYPE_PREFIX||orf_type==ORF_TYPE_PRE
FIX_OLD)if(remove||filter->plist[FILTER_IN].plist){uint16_torf_len;unsignedlongo
rfp;orf_refresh=1;stream_putc(s,when_to_refresh);stream_putc(s,orf_type);orfp=st
ream_get_endp(s);stream_putw(s,0);if(remove){UNSET_FLAG(peer->af_sflags[afi][saf
i],PEER_STATUS_ORF_PREFIX_SEND);stream_putc(s,ORF_COMMON_PART_REMOVE_ALL);if(bgp
_debug_neighbor_events(peer))zlog_debug("%ssendingREFRESH_REQtoremoveORF(%d)(%s)
forafi/safi:%d/%d",peer->host,orf_type,(when_to_refresh==REFRESH_DEFER?"defer":"
immediate"),pkt_afi,pkt_safi);}else{SET_FLAG(peer->af_sflags[afi][safi],PEER_STA
TUS_ORF_PREFIX_SEND);prefix_bgp_orf_entry(s,filter->plist[FILTER_IN].plist,ORF_C
OMMON_PART_ADD,ORF_COMMON_PART_PERMIT,ORF_COMMON_PART_DENY);if(bgp_debug_neighbo
r_events(peer))zlog_debug("%ssendingREFRESH_REQwithpfxlistORF(%d)(%s)forafi/safi
:%d/%d",peer->host,orf_type,(when_to_refresh==REFRESH_DEFER?"defer":"immediate")
,pkt_afi,pkt_safi);}/*TotalORFEntryLen.*/orf_len=stream_get_endp(s)-orfp-2;strea
m_putw_at(s,orfp,orf_len);}/*Setpacketsize.*/(void)bgp_packet_set_size(s);if(bgp
_debug_neighbor_events(peer)){if(!orf_refresh)zlog_debug("%ssendingREFRESH_REQfo
rafi/safi:%d/%d",peer->host,pkt_afi,pkt_safi);}/*Addpackettothepeer.*/bgp_packet
_add(peer,s);bgp_writes_on(peer);}/**CreateaBGPCapabilitypacketandappendittothep
eer'soutputqueue.**@parampeer*@paramafiAddressFamilyIdentifier*@paramsafiSubsequ
entAddressFamilyIdentifier*@paramcapability_codeBGPCapabilityCode*@paramactionSe
torRemovecapability*/voidbgp_capability_send(structpeer*peer,afi_tafi,safi_tsafi
,intcapability_code,intaction){structstream*s;iana_afi_tpkt_afi;iana_safi_tpkt_s
afi;/*ConvertAFI,SAFItovaluesforpacket.*/bgp_map_afi_safi_int2iana(afi,safi,&pkt
_afi,&pkt_safi);s=stream_new(BGP_MAX_PACKET_SIZE);/*MakeBGPupdatepacket.*/bgp_pa
cket_set_marker(s,BGP_MSG_CAPABILITY);/*EncodeMP_EXTcapability.*/if(capability_c
ode==CAPABILITY_CODE_MP){stream_putc(s,action);stream_putc(s,CAPABILITY_CODE_MP)
;stream_putc(s,CAPABILITY_CODE_MP_LEN);stream_putw(s,pkt_afi);stream_putc(s,0);s
tream_putc(s,pkt_safi);if(bgp_debug_neighbor_events(peer))zlog_debug("%ssendingC
APABILITYhas%sMP_EXTCAPforafi/safi:%d/%d",peer->host,action==CAPABILITY_ACTION_S
ET?"Advertising":"Removing",pkt_afi,pkt_safi);}/*Setpacketsize.*/(void)bgp_packe
t_set_size(s);/*Addpackettothepeer.*/bgp_packet_add(peer,s);bgp_writes_on(peer);
}/*RFC17716.8Connectioncollisiondetection.*/staticintbgp_collision_detect(struct
peer*new,structin_addrremote_id){structpeer*peer;/*UponreceiptofanOPENmessage,th
elocalsystemmustexamineallofitsconnectionsthatareintheOpenConfirmstate.ABGPspeak
ermayalsoexamineconnectionsinanOpenSentstateifitknowstheBGPIdentifierofthepeerby
meansoutsideoftheprotocol.IfamongtheseconnectionsthereisaconnectiontoaremoteBGPs
peakerwhoseBGPIdentifierequalstheoneintheOPENmessage,thenthelocalsystemperformst
hefollowingcollisionresolutionprocedure:*/if((peer=new->doppelganger)!=NULL){/*D
onotacceptthenewconnectioninEstablishedorClearing*states.*NotethatapeerGRishandl
edbyclosingtheexisting*connection*uponreceiptofnewone.*/if(peer->status==Establi
shed||peer->status==Clearing){bgp_notify_send(new,BGP_NOTIFY_CEASE,BGP_NOTIFY_CE
ASE_COLLISION_RESOLUTION);return(-1);}elseif((peer->status==OpenConfirm)||(peer-
>status==OpenSent)){/*1.TheBGPIdentifierofthelocalsystemiscomparedtotheBGPIdenti
fieroftheremotesystem(asspecifiedintheOPENmessage).*/if(ntohl(peer->local_id.s_a
ddr)<ntohl(remote_id.s_addr))if(!CHECK_FLAG(peer->sflags,PEER_STATUS_ACCEPT_PEER
)){/*2.IfthevalueofthelocalBGPIdentifierislessthantheremoteone,thelocalsystemclo
sesBGPconnectionthatalreadyexists(theonethatisalreadyintheOpenConfirmstate),anda
cceptsBGPconnectioninitiatedbytheremotesystem.*/bgp_notify_send(peer,BGP_NOTIFY_
CEASE,BGP_NOTIFY_CEASE_COLLISION_RESOLUTION);return1;}else{bgp_notify_send(new,B
GP_NOTIFY_CEASE,BGP_NOTIFY_CEASE_COLLISION_RESOLUTION);return-1;}else{/*3.Otherw
ise,thelocalsystemclosesnewlycreatedBGPconnection(theoneassociatedwiththenewlyre
ceivedOPENmessage),andcontinuestousetheexistingone(theonethatisalreadyintheOpenC
onfirmstate).*/if(CHECK_FLAG(peer->sflags,PEER_STATUS_ACCEPT_PEER)){bgp_notify_s
end(peer,BGP_NOTIFY_CEASE,BGP_NOTIFY_CEASE_COLLISION_RESOLUTION);return1;}else{b
gp_notify_send(new,BGP_NOTIFY_CEASE,BGP_NOTIFY_CEASE_COLLISION_RESOLUTION);retur
n-1;}}}}return0;}/*Packetprocessingroutines-------------------------------------
---------*//**Thisisafamilyoffunctionsdesignedtobecalledfrom*bgp_process_packet(
).Thesefunctionsallsharesimilarbehaviorandshould*adheretothefollowinginvariantsa
ndrestrictions:**Returncodes*------------*Thereturncodeofanyoneofthosefunctionss
houldbeoneoftheFSMevent*codesspecifiedinbgpd.h.IfaNOTIFYwassent,thiseventcodeMUS
Tbe*BGP_Stop.Otherwise,thecodeSHOULDcorrespondtothefunction'sexpected*packettype
.Forexample,bgp_open_receive()shouldreturnBGP_Stopupon*errorandReceive_OPEN_mess
ageotherwise.**Ifnoactionisnecessary,thecorrectreturncodeisBGP_PACKET_NOOPas*def
inedbelow.**Sideeffects*------------*-MaysendNOTIFYmessages*-Maynotmodifypeer->s
tatus*-Maynotcallbgp_event_update()*/#defineBGP_PACKET_NOOP0/***ProcessBGPOPENme
ssageforpeer.**IfanyerrorsareencounteredintheOPENmessage,immediatelysendsNOTIFY*
andreturnsBGP_Stop.**@parampeer*@paramsizesizeofthepacket*@returnasinsummary*/st
aticintbgp_open_receive(structpeer*peer,bgp_size_tsize){intret;uint8_tversion;ui
nt8_toptlen;uint16_tholdtime;uint16_tsend_holdtime;as_tremote_as;as_tas4=0;struc
tin_addrremote_id;intmp_capability;uint8_tnotify_data_remote_as[2];uint8_tnotify
_data_remote_as4[4];uint8_tnotify_data_remote_id[4];uint16_t*holdtime_ptr;/*Pars
eopenpacket.*/version=stream_getc(peer->curr);memcpy(notify_data_remote_as,strea
m_pnt(peer->curr),2);remote_as=stream_getw(peer->curr);holdtime_ptr=(uint16_t*)s
tream_pnt(peer->curr);holdtime=stream_getw(peer->curr);memcpy(notify_data_remote
_id,stream_pnt(peer->curr),4);remote_id.s_addr=stream_get_ipv4(peer->curr);/*Rec
eiveOPENmessagelog*/if(bgp_debug_neighbor_events(peer))zlog_debug("%srcvOPEN,ver
sion%d,remote-as(inopen)%u,""holdtime%d,id%s",peer->host,version,remote_as,holdt
ime,inet_ntoa(remote_id));/*BEGINtoreadthecapabilityhere,butdontdoityet*/mp_capa
bility=0;optlen=stream_getc(peer->curr);if(optlen!=0){/*Ifnotenoughbytes,itisane
rror.*/if(STREAM_READABLE(peer->curr)<optlen){bgp_notify_send(peer,BGP_NOTIFY_OP
EN_ERR,BGP_NOTIFY_OPEN_MALFORMED_ATTR);returnBGP_Stop;}/*Weneedtheas4capabilityv
alue*rightnow*because*ifitisthere,wehavenotgottheremote_asyet,and*without*thatwe
donotknowwhichpeerisconnectingtousnow.*/as4=peek_for_as4_capability(peer,optlen)
;memcpy(notify_data_remote_as4,&as4,4);}/*JustincasewehaveasillypeerwhosendsAS4c
apabilitysetto0*/if(CHECK_FLAG(peer->cap,PEER_CAP_AS4_RCV)&&!as4){zlog_err("%sba
dOPEN,gotAS4capability,butAS4setto0",peer->host);bgp_notify_send_with_data(peer,
BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_BAD_PEER_AS,notify_data_remote_as4,4);return
BGP_Stop;}if(remote_as==BGP_AS_TRANS){/*TaketheAS4fromthecapability.Wemusthavere
ceivedthe*capabilitynow!Otherwisewehaveaasn16peerwhouses*BGP_AS_TRANS,forsomeunk
nownreason.*/if(as4==BGP_AS_TRANS){zlog_err("%s[AS4]NEWspeakerusingAS_TRANSforAS
4,notallowed",peer->host);bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP
_NOTIFY_OPEN_BAD_PEER_AS,notify_data_remote_as4,4);returnBGP_Stop;}if(!as4&&BGP_
DEBUG(as4,AS4))zlog_debug("%s[AS4]OPENremote_asisAS_TRANS,butnoAS4.""Odd,butproc
eeding.",peer->host);elseif(as4<BGP_AS_MAX&&BGP_DEBUG(as4,AS4))zlog_debug("%s[AS
4]OPENremote_asisAS_TRANS,butAS4(%u)fits""in2-bytes,veryoddpeer.",peer->host,as4
);if(as4)remote_as=as4;}else{/*WemayhaveapartnerwithAS4whohasanasno<BGP_AS_MAX*/
/*Ifwehavegotthecapability,peer->as4capmustmatch*remote_as*/if(CHECK_FLAG(peer->
cap,PEER_CAP_AS4_RCV)&&as4!=remote_as){/*raiseerror,logthis,closesession*/zlog_e
rr("%sbadOPEN,gotAS4capability,butremote_as%u""mismatchwith16bit'myasn'%uinopen"
,peer->host,as4,remote_as);bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BG
P_NOTIFY_OPEN_BAD_PEER_AS,notify_data_remote_as4,4);returnBGP_Stop;}}/*remoterou
ter-idcheck.*/if(remote_id.s_addr==0||IPV4_CLASS_DE(ntohl(remote_id.s_addr))||nt
ohl(peer->local_id.s_addr)==ntohl(remote_id.s_addr)){if(bgp_debug_neighbor_event
s(peer))zlog_debug("%sbadOPEN,wrongrouteridentifier%s",peer->host,inet_ntoa(remo
te_id));bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_BAD_B
GP_IDENT,notify_data_remote_id,4);returnBGP_Stop;}/*Setremoterouter-id*/peer->re
mote_id=remote_id;/*PeerBGPversioncheck.*/if(version!=BGP_VERSION_4){uint16_tmax
ver=htons(BGP_VERSION_4);/*XXXthisreplymaynotbecorrectifversion<4XXX*/if(bgp_deb
ug_neighbor_events(peer))zlog_debug("%sbadprotocolversion,remoterequested%d,loca
lrequest%d",peer->host,version,BGP_VERSION_4);/*Datamustbeinnetworkbyteorderhere
*/bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_UNSUP_VERSI
ON,(uint8_t*)&maxver,2);returnBGP_Stop;}/*Checkneighborasnumber.*/if(peer->as_ty
pe==AS_UNSPECIFIED){if(bgp_debug_neighbor_events(peer))zlog_debug("%sbadOPEN,rem
oteASisunspecifiedcurrently",peer->host);bgp_notify_send_with_data(peer,BGP_NOTI
FY_OPEN_ERR,BGP_NOTIFY_OPEN_BAD_PEER_AS,notify_data_remote_as,2);returnBGP_Stop;
}elseif(peer->as_type==AS_INTERNAL){if(remote_as!=peer->bgp->as){if(bgp_debug_ne
ighbor_events(peer))zlog_debug("%sbadOPEN,remoteASis%u,internalspecified",peer->
host,remote_as);bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OP
EN_BAD_PEER_AS,notify_data_remote_as,2);returnBGP_Stop;}peer->as=peer->local_as;
}elseif(peer->as_type==AS_EXTERNAL){if(remote_as==peer->bgp->as){if(bgp_debug_ne
ighbor_events(peer))zlog_debug("%sbadOPEN,remoteASis%u,externalspecified",peer->
host,remote_as);bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OP
EN_BAD_PEER_AS,notify_data_remote_as,2);returnBGP_Stop;}peer->as=remote_as;}else
if((peer->as_type==AS_SPECIFIED)&&(remote_as!=peer->as)){if(bgp_debug_neighbor_e
vents(peer))zlog_debug("%sbadOPEN,remoteASis%u,expected%u",peer->host,remote_as,
peer->as);bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN_ERR,BGP_NOTIFY_OPEN_BAD
_PEER_AS,notify_data_remote_as,2);returnBGP_Stop;}/*Fromtherfc:UponreceiptofanOP
ENmessage,aBGPspeakerMUSTcalculatethevalueoftheHoldTimerbyusingthesmallerofitsco
nfiguredHoldTimeandtheHoldTimereceivedintheOPENmessage.TheHoldTimeMUSTbeeitherze
rooratleastthreeseconds.AnimplementationmayrejectconnectionsonthebasisoftheHoldT
ime.*/if(holdtime<3&&holdtime!=0){bgp_notify_send_with_data(peer,BGP_NOTIFY_OPEN
_ERR,BGP_NOTIFY_OPEN_UNACEP_HOLDTIME,(uint8_t*)holdtime_ptr,2);returnBGP_Stop;}/
*Fromtherfc:AreasonablemaximumtimebetweenKEEPALIVEmessageswouldbeonethirdoftheHo
ldTimeinterval.KEEPALIVEmessagesMUSTNOTbesentmorefrequentlythanonepersecond.Anim
plementationMAYadjusttherateatwhichitsendsKEEPALIVEmessagesasafunctionoftheHoldT
imeinterval.*/if(PEER_OR_GROUP_TIMER_SET(peer))send_holdtime=peer->holdtime;else
send_holdtime=peer->bgp->default_holdtime;if(holdtime<send_holdtime)peer->v_hold
time=holdtime;elsepeer->v_holdtime=send_holdtime;if((PEER_OR_GROUP_TIMER_SET(pee
r))&&(peer->keepalive<peer->v_holdtime/3))peer->v_keepalive=peer->keepalive;else
peer->v_keepalive=peer->v_holdtime/3;/*Openoptionpartparse.*/if(optlen!=0){if((r
et=bgp_open_option_parse(peer,optlen,&mp_capability))<0)returnBGP_Stop;}else{if(
bgp_debug_neighbor_events(peer))zlog_debug("%srcvdOPENw/OPTIONparameterlen:0",pe
er->host);}/**Assumethatthepeersupportsthelocallyconfiguredsetof*AFI/SAFIsifthep
eerdidnotsendusanyMulitiprotocol*capabilities,orif'override-capability'isconfigu
red.*/if(!mp_capability||CHECK_FLAG(peer->flags,PEER_FLAG_OVERRIDE_CAPABILITY)){
peer->afc_nego[AFI_IP][SAFI_UNICAST]=peer->afc[AFI_IP][SAFI_UNICAST];peer->afc_n
ego[AFI_IP][SAFI_MULTICAST]=peer->afc[AFI_IP][SAFI_MULTICAST];peer->afc_nego[AFI
_IP][SAFI_LABELED_UNICAST]=peer->afc[AFI_IP][SAFI_LABELED_UNICAST];peer->afc_neg
o[AFI_IP][SAFI_FLOWSPEC]=peer->afc[AFI_IP][SAFI_FLOWSPEC];peer->afc_nego[AFI_IP6
][SAFI_UNICAST]=peer->afc[AFI_IP6][SAFI_UNICAST];peer->afc_nego[AFI_IP6][SAFI_MU
LTICAST]=peer->afc[AFI_IP6][SAFI_MULTICAST];peer->afc_nego[AFI_IP6][SAFI_LABELED
_UNICAST]=peer->afc[AFI_IP6][SAFI_LABELED_UNICAST];peer->afc_nego[AFI_L2VPN][SAF
I_EVPN]=peer->afc[AFI_L2VPN][SAFI_EVPN];peer->afc_nego[AFI_IP6][SAFI_FLOWSPEC]=p
eer->afc[AFI_IP6][SAFI_FLOWSPEC];}/*Whencollisionisdetectedandthispeerisclosed.R
etrunimmidiately.*/ret=bgp_collision_detect(peer,remote_id);if(ret<0)returnBGP_S
top;/*Getsockname.*/if((ret=bgp_getsockname(peer))<0){zlog_err("%s:bgp_getsockna
me()failedforpeer:%s",__FUNCTION__,peer->host);returnBGP_Stop;}/*Verifyvalidloca
laddresspresentbasedonnegotiated*address-families.*/if(peer->afc_nego[AFI_IP][SA
FI_UNICAST]||peer->afc_nego[AFI_IP][SAFI_LABELED_UNICAST]||peer->afc_nego[AFI_IP
][SAFI_MULTICAST]||peer->afc_nego[AFI_IP][SAFI_MPLS_VPN]||peer->afc_nego[AFI_IP]
[SAFI_ENCAP]){if(!peer->nexthop.v4.s_addr){#ifdefined(HAVE_CUMULUS)zlog_err("%s:
NolocalIPv4addrresettingconnection,fd%d",peer->host,peer->fd);bgp_notify_send(pe
er,BGP_NOTIFY_CEASE,BGP_NOTIFY_SUBCODE_UNSPECIFIC);returnBGP_Stop;#endif}}if(pee
r->afc_nego[AFI_IP6][SAFI_UNICAST]||peer->afc_nego[AFI_IP6][SAFI_LABELED_UNICAST
]||peer->afc_nego[AFI_IP6][SAFI_MULTICAST]||peer->afc_nego[AFI_IP6][SAFI_MPLS_VP
N]||peer->afc_nego[AFI_IP6][SAFI_ENCAP]){if(IN6_IS_ADDR_UNSPECIFIED(&peer->nexth
op.v6_global)){#ifdefined(HAVE_CUMULUS)zlog_err("%s:NolocalIPv6addrresettingconn
ection,fd%d",peer->host,peer->fd);bgp_notify_send(peer,BGP_NOTIFY_CEASE,BGP_NOTI
FY_SUBCODE_UNSPECIFIC);returnBGP_Stop;#endif}}peer->rtt=sockopt_tcp_rtt(peer->fd
);returnReceive_OPEN_message;}/***ProcessBGPKEEPALIVEmessageforpeer.**@parampeer
*@paramsizesizeofthepacket*@returnasinsummary*/staticintbgp_keepalive_receive(st
ructpeer*peer,bgp_size_tsize){if(bgp_debug_keepalive(peer))zlog_debug("%sKEEPALI
VErcvd",peer->host);bgp_update_implicit_eors(peer);returnReceive_KEEPALIVE_messa
ge;}/***ProcessBGPUPDATEmessageforpeer.**ParsesUPDATEandcreatesattributeobject.*
*@parampeer*@paramsizesizeofthepacket*@returnasinsummary*/staticintbgp_update_re
ceive(structpeer*peer,bgp_size_tsize){intret,nlri_ret;uint8_t*end;structstream*s
;structattrattr;bgp_size_tattribute_len;bgp_size_tupdate_len;bgp_size_twithdraw_
len;enumNLRI_TYPES{NLRI_UPDATE,NLRI_WITHDRAW,NLRI_MP_UPDATE,NLRI_MP_WITHDRAW,NLR
I_TYPE_MAX};structbgp_nlrinlris[NLRI_TYPE_MAX];/*StatusmustbeEstablished.*/if(pe
er->status!=Established){zlog_err("%s[FSM]Updatepacketreceivedunderstatus%s",pee
r->host,lookup_msg(bgp_status_msg,peer->status,NULL));bgp_notify_send(peer,BGP_N
OTIFY_FSM_ERR,0);returnBGP_Stop;}/*Setinitialvalues.*/memset(&attr,0,sizeof(stru
ctattr));attr.label_index=BGP_INVALID_LABEL_INDEX;attr.label=MPLS_INVALID_LABEL;
memset(&nlris,0,sizeof(nlris));memset(peer->rcvd_attr_str,0,BUFSIZ);peer->rcvd_a
ttr_printed=0;s=peer->curr;end=stream_pnt(s)+size;/*RFC17716.3IftheUnfeasibleRou
tesLengthorTotalAttributeLengthistoolarge(i.e.,ifUnfeasibleRoutesLength+TotalAtt
ributeLength+23exceedsthemessageLength),thentheErrorSubcodeissettoMalformedAttri
buteList.*/if(stream_pnt(s)+2>end){zlog_err("%s[Error]Updatepacketerror""(packet
lengthisshortforunfeasiblelength)",peer->host);bgp_notify_send(peer,BGP_NOTIFY_U
PDATE_ERR,BGP_NOTIFY_UPDATE_MAL_ATTR);returnBGP_Stop;}/*UnfeasibleRouteLength.*/
withdraw_len=stream_getw(s);/*UnfeasibleRouteLengthcheck.*/if(stream_pnt(s)+with
draw_len>end){zlog_err("%s[Error]Updatepacketerror""(packetunfeasiblelengthoverf
low%d)",peer->host,withdraw_len);bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_
NOTIFY_UPDATE_MAL_ATTR);returnBGP_Stop;}/*UnfeasibleRoutepacketformatcheck.*/if(
withdraw_len>0){nlris[NLRI_WITHDRAW].afi=AFI_IP;nlris[NLRI_WITHDRAW].safi=SAFI_U
NICAST;nlris[NLRI_WITHDRAW].nlri=stream_pnt(s);nlris[NLRI_WITHDRAW].length=withd
raw_len;stream_forward_getp(s,withdraw_len);}/*Attributetotallengthcheck.*/if(st
ream_pnt(s)+2>end){zlog_warn("%s[Error]PacketError""(updatepacketisshortforattri
butelength)",peer->host);bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_U
PDATE_MAL_ATTR);returnBGP_Stop;}/*Fetchattributetotallength.*/attribute_len=stre
am_getw(s);/*Attributelengthcheck.*/if(stream_pnt(s)+attribute_len>end){zlog_war
n("%s[Error]PacketError""(updatepacketattributelengthoverflow%d)",peer->host,att
ribute_len);bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_MAL_ATT
R);returnBGP_Stop;}/*Certainattributeparsingerrorsshouldnotbeconsideredbadenough
*toresetthesessionfor,mostparticularlyanypartial/optional*attributesthathave'tun
neled'overspeakersthatdon'tunderstand*them.Insteadwewithdrawonlytheprefixconcern
ed.**Complicatestheflowalittlethough..*/bgp_attr_parse_ret_tattr_parse_ret=BGP_A
TTR_PARSE_PROCEED;/*Thisdefinemorphstheupdatecaseintoawithdrawwhenlowerlevels*ha
vesignalledanerrorconditionwherethisisbest.*/#defineNLRI_ATTR_ARG(attr_parse_ret
!=BGP_ATTR_PARSE_WITHDRAW?&attr:NULL)/*Parseattributewhenitexists.*/if(attribute
_len){attr_parse_ret=bgp_attr_parse(peer,&attr,attribute_len,&nlris[NLRI_MP_UPDA
TE],&nlris[NLRI_MP_WITHDRAW]);if(attr_parse_ret==BGP_ATTR_PARSE_ERROR){bgp_attr_
unintern_sub(&attr);returnBGP_Stop;}}/*Loggingtheattribute.*/if(attr_parse_ret==
BGP_ATTR_PARSE_WITHDRAW||BGP_DEBUG(update,UPDATE_IN)||BGP_DEBUG(update,UPDATE_PR
EFIX)){ret=bgp_dump_attr(&attr,peer->rcvd_attr_str,BUFSIZ);if(attr_parse_ret==BG
P_ATTR_PARSE_WITHDRAW)zlog_err("%srcvdUPDATEwitherrorsinattr(s)!!Withdrawingrout
e.",peer->host);if(ret&&bgp_debug_update(peer,NULL,NULL,1)){zlog_debug("%srcvdUP
DATEw/attr:%s",peer->host,peer->rcvd_attr_str);peer->rcvd_attr_printed=1;}}/*Net
workLayerReachabilityInformation.*/update_len=end-stream_pnt(s);if(update_len){/
*SetNLRIportiontostructure.*/nlris[NLRI_UPDATE].afi=AFI_IP;nlris[NLRI_UPDATE].sa
fi=SAFI_UNICAST;nlris[NLRI_UPDATE].nlri=stream_pnt(s);nlris[NLRI_UPDATE].length=
update_len;stream_forward_getp(s,update_len);}if(BGP_DEBUG(update,UPDATE_IN))zlo
g_debug("%srcvdUPDATEwlen%dattrlen%dalen%d",peer->host,withdraw_len,attribute_le
n,update_len);/*ParseanygivenNLRIs*/for(inti=NLRI_UPDATE;i<NLRI_TYPE_MAX;i++){if
(!nlris[i].nlri)continue;/*NLRIisprocessediffthepeerifconfiguredforthespecific*a
fi/safi*/if(!peer->afc[nlris[i].afi][nlris[i].safi]){zlog_info("%s[Info]UPDATEfo
rnon-enabledAFI/SAFI%u/%u",peer->host,nlris[i].afi,nlris[i].safi);continue;}/*Eo
Rhandledlater*/if(nlris[i].length==0)continue;switch(i){caseNLRI_UPDATE:caseNLRI
_MP_UPDATE:nlri_ret=bgp_nlri_parse(peer,NLRI_ATTR_ARG,&nlris[i],0);break;caseNLR
I_WITHDRAW:caseNLRI_MP_WITHDRAW:nlri_ret=bgp_nlri_parse(peer,&attr,&nlris[i],1);
break;default:nlri_ret=-1;}if(nlri_ret<0){zlog_err("%s[Error]ErrorparsingNLRI",p
eer->host);if(peer->status==Established)bgp_notify_send(peer,BGP_NOTIFY_UPDATE_E
RR,i<=NLRI_WITHDRAW?BGP_NOTIFY_UPDATE_INVAL_NETWORK:BGP_NOTIFY_UPDATE_OPT_ATTR_E
RR);bgp_attr_unintern_sub(&attr);returnBGP_Stop;}}/*EoRchecks**Non-MPIPv4/Unicas
tEoRisacompletelyemptyUPDATE*andMPEoRshouldhaveonlyanemptyMP_UNREACH*/if((!updat
e_len&&!withdraw_len&&nlris[NLRI_MP_UPDATE].length==0)||(attr_parse_ret==BGP_ATT
R_PARSE_EOR)){afi_tafi=0;safi_tsafi;/*Non-MPIPv4/UnicastisacompletelyemtpyUPDATE
-already*checked*updateandwithdrawNLRIlengthsare0.*/if(!attribute_len){afi=AFI_I
P;safi=SAFI_UNICAST;}elseif(attr.flag&ATTR_FLAG_BIT(BGP_ATTR_MP_UNREACH_NLRI)&&n
lris[NLRI_MP_WITHDRAW].length==0){afi=nlris[NLRI_MP_WITHDRAW].afi;safi=nlris[NLR
I_MP_WITHDRAW].safi;}elseif(attr_parse_ret==BGP_ATTR_PARSE_EOR){afi=nlris[NLRI_M
P_UPDATE].afi;safi=nlris[NLRI_MP_UPDATE].safi;}if(afi&&peer->afc[afi][safi]){/*E
nd-of-RIBreceived*/if(!CHECK_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_EOR_REC
EIVED)){SET_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_EOR_RECEIVED);bgp_update
_explicit_eors(peer);}/*NSFdeletestaleroute*/if(peer->nsf[afi][safi])bgp_clear_s
tale_route(peer,afi,safi);if(bgp_debug_neighbor_events(peer)){zlog_debug("rcvdEn
d-of-RIBfor%sfrom%s",afi_safi_print(afi,safi),peer->host);}}}/*Everythingisdone.
Weuninterntemporarystructureswhichinternedinbgp_attr_parse().*/bgp_attr_unintern
_sub(&attr);peer->update_time=bgp_clock();/*Rearmholdtimetimer*/BGP_TIMER_OFF(pe
er->t_holdtime);bgp_timer_set(peer);returnReceive_UPDATE_message;}/***ProcessBGP
NOTIFYmessageforpeer.**@parampeer*@paramsizesizeofthepacket*@returnasinsummary*/
staticintbgp_notify_receive(structpeer*peer,bgp_size_tsize){structbgp_notifybgp_
notify;if(peer->notify.data){XFREE(MTYPE_TMP,peer->notify.data);peer->notify.dat
a=NULL;peer->notify.length=0;}bgp_notify.code=stream_getc(peer->curr);bgp_notify
.subcode=stream_getc(peer->curr);bgp_notify.length=size-2;bgp_notify.data=NULL;/
*Preservnotifycodeandsubcode.*/peer->notify.code=bgp_notify.code;peer->notify.su
bcode=bgp_notify.subcode;/*ForfurtherdiagnosticrecordreturnedData.*/if(bgp_notif
y.length){peer->notify.length=size-2;peer->notify.data=XMALLOC(MTYPE_TMP,size-2)
;memcpy(peer->notify.data,stream_pnt(peer->curr),size-2);}/*Fordebug*/{inti;intf
irst=0;charc[4];if(bgp_notify.length){bgp_notify.data=XMALLOC(MTYPE_TMP,bgp_noti
fy.length*3);for(i=0;i<bgp_notify.length;i++)if(first){sprintf(c,"%02x",stream_g
etc(peer->curr));strcat(bgp_notify.data,c);}else{first=1;sprintf(c,"%02x",stream
_getc(peer->curr));strcpy(bgp_notify.data,c);}bgp_notify.raw_data=(uint8_t*)peer
->notify.data;}bgp_notify_print(peer,&bgp_notify,"received");if(bgp_notify.data)
{XFREE(MTYPE_TMP,bgp_notify.data);bgp_notify.data=NULL;bgp_notify.length=0;}}/*p
eercountupdate*/atomic_fetch_add_explicit(&peer->notify_in,1,memory_order_relaxe
d);peer->last_reset=PEER_DOWN_NOTIFY_RECEIVED;/*WehavetocheckforNotifywithUnsupp
ortedOptionalParameter.inthatcasewefallbacktoopenwithoutthecapabilityoption.Butt
hisdoneinbgp_stop.Wejustmarkitheretoavoidchangingthefsmtables.*/if(bgp_notify.co
de==BGP_NOTIFY_OPEN_ERR&&bgp_notify.subcode==BGP_NOTIFY_OPEN_UNSUP_PARAM)UNSET_F
LAG(peer->sflags,PEER_STATUS_CAPABILITY_OPEN);returnReceive_NOTIFICATION_message
;}/***ProcessBGPROUTEREFRESHmessageforpeer.**@parampeer*@paramsizesizeofthepacke
t*@returnasinsummary*/staticintbgp_route_refresh_receive(structpeer*peer,bgp_siz
e_tsize){iana_afi_tpkt_afi;afi_tafi;iana_safi_tpkt_safi;safi_tsafi;structstream*
s;structpeer_af*paf;structupdate_group*updgrp;structpeer*updgrp_peer;/*Ifpeerdoe
snothavethecapability,sendnotification.*/if(!CHECK_FLAG(peer->cap,PEER_CAP_REFRE
SH_ADV)){zlog_err("%s[Error]BGProuterefreshisnotenabled",peer->host);bgp_notify_
send(peer,BGP_NOTIFY_HEADER_ERR,BGP_NOTIFY_HEADER_BAD_MESTYPE);returnBGP_Stop;}/
*StatusmustbeEstablished.*/if(peer->status!=Established){zlog_err("%s[Error]Rout
erefreshpacketreceivedunderstatus%s",peer->host,lookup_msg(bgp_status_msg,peer->
status,NULL));bgp_notify_send(peer,BGP_NOTIFY_FSM_ERR,0);returnBGP_Stop;}s=peer-
>curr;/*Parsepacket.*/pkt_afi=stream_getw(s);(void)stream_getc(s);pkt_safi=strea
m_getc(s);if(bgp_debug_update(peer,NULL,NULL,0))zlog_debug("%srcvdREFRESH_REQfor
afi/safi:%d/%d",peer->host,pkt_afi,pkt_safi);/*ConvertAFI,SAFItointernalvaluesan
dcheck.*/if(bgp_map_afi_safi_iana2int(pkt_afi,pkt_safi,&afi,&safi)){zlog_info("%
sREFRESH_REQforunrecognizedafi/safi:%d/%d-ignored",peer->host,pkt_afi,pkt_safi);
returnBGP_PACKET_NOOP;}if(size!=BGP_MSG_ROUTE_REFRESH_MIN_SIZE-BGP_HEADER_SIZE){
uint8_t*end;uint8_twhen_to_refresh;uint8_torf_type;uint16_torf_len;if(size-(BGP_
MSG_ROUTE_REFRESH_MIN_SIZE-BGP_HEADER_SIZE)<5){zlog_info("%sORFrouterefreshlengt
herror",peer->host);bgp_notify_send(peer,BGP_NOTIFY_CEASE,0);returnBGP_Stop;}whe
n_to_refresh=stream_getc(s);end=stream_pnt(s)+(size-5);while((stream_pnt(s)+2)<e
nd){orf_type=stream_getc(s);orf_len=stream_getw(s);/*orf_leninbounds?*/if((strea
m_pnt(s)+orf_len)>end)break;/*XXX:Notifyinstead??*/if(orf_type==ORF_TYPE_PREFIX|
|orf_type==ORF_TYPE_PREFIX_OLD){uint8_t*p_pnt=stream_pnt(s);uint8_t*p_end=stream
_pnt(s)+orf_len;structorf_prefixorfp;uint8_tcommon=0;uint32_tseq;intpsize;charna
me[BUFSIZ];intret=CMD_SUCCESS;if(bgp_debug_neighbor_events(peer)){zlog_debug("%s
rcvdPrefixlistORF(%d)length%d",peer->host,orf_type,orf_len);}/*we'regoingtoreada
tleast1byteofcommon*ORFheader,*and7bytesofORFAddress-filterentryfrom*thestream*/
if(orf_len<7)break;/*ORFprefix-listname*/sprintf(name,"%s.%d.%d",peer->host,afi,
safi);while(p_pnt<p_end){/*IftheORFentryismalformed,want*toreadasmuchofit*asposs
iblewithoutgoingbeyondthe*boundsoftheentry,*tomaximisedebuginformation.*/intok;m
emset(&orfp,0,sizeof(structorf_prefix));common=*p_pnt++;/*after++:p_pnt<=p_end*/
if(common&ORF_COMMON_PART_REMOVE_ALL){if(bgp_debug_neighbor_events(peer))zlog_de
bug("%srcvdRemove-AllpfxlistORFrequest",peer->host);prefix_bgp_orf_remove_all(af
i,name);break;}ok=((uint32_t)(p_end-p_pnt)>=sizeof(uint32_t));if(ok){memcpy(&seq
,p_pnt,sizeof(uint32_t));p_pnt+=sizeof(uint32_t);orfp.seq=ntohl(seq);}elsep_pnt=
p_end;if((ok=(p_pnt<p_end)))orfp.ge=*p_pnt++;/*valuecheckedinprefix_bgp_orf_set(
)*/if((ok=(p_pnt<p_end)))orfp.le=*p_pnt++;/*valuecheckedinprefix_bgp_orf_set()*/
if((ok=(p_pnt<p_end)))orfp.p.prefixlen=*p_pnt++;orfp.p.family=afi2family(afi);/*
aficheckedalready*/psize=PSIZE(orfp.p.prefixlen);/*0ifnotok*/if(psize>prefix_ble
n(&orfp.p))/*validforfamily?*/{ok=0;psize=prefix_blen(&orfp.p);}if(psize>(p_end-
p_pnt))/*validforpacket?*/{ok=0;psize=p_end-p_pnt;}if(psize>0)memcpy(&orfp.p.u.p
refix,p_pnt,psize);p_pnt+=psize;if(bgp_debug_neighbor_events(peer)){charbuf[INET
6_BUFSIZ];zlog_debug("%srcvd%s%sseq%u%s/%dge%dle%d%s",peer->host,(common&ORF_COM
MON_PART_REMOVE?"Remove":"Add"),(common&ORF_COMMON_PART_DENY?"deny":"permit"),or
fp.seq,inet_ntop(orfp.p.family,&orfp.p.u.prefix,buf,INET6_BUFSIZ),orfp.p.prefixl
en,orfp.ge,orfp.le,ok?"":"MALFORMED");}if(ok)ret=prefix_bgp_orf_set(name,afi,&or
fp,(common&ORF_COMMON_PART_DENY?0:1),(common&ORF_COMMON_PART_REMOVE?0:1));if(!ok
||(ok&&ret!=CMD_SUCCESS)){zlog_info("%sReceivedmisformattedprefixlistORF.""Remov
eAllpfxlist",peer->host);prefix_bgp_orf_remove_all(afi,name);break;}}peer->orf_p
list[afi][safi]=prefix_bgp_orf_lookup(afi,name);}stream_forward_getp(s,orf_len);
}if(bgp_debug_neighbor_events(peer))zlog_debug("%srcvdRefresh%sORFrequest",peer-
>host,when_to_refresh==REFRESH_DEFER?"Defer":"Immediate");if(when_to_refresh==RE
FRESH_DEFER)returnBGP_PACKET_NOOP;}/*FirstupdateisdeferreduntilORForROUTE-REFRES
Hisreceived*/if(CHECK_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_ORF_WAIT_REFRE
SH))UNSET_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_ORF_WAIT_REFRESH);paf=peer
_af_find(peer,afi,safi);if(paf&&paf->subgroup){if(peer->orf_plist[afi][safi]){up
dgrp=PAF_UPDGRP(paf);updgrp_peer=UPDGRP_PEER(updgrp);updgrp_peer->orf_plist[afi]
[safi]=peer->orf_plist[afi][safi];}/*Ifthepeerisconfiguredfordefault-originatecl
earthe*SUBGRP_STATUS_DEFAULT_ORIGINATEflagsothatwewill*re-advertisethe*default*/
if(CHECK_FLAG(paf->subgroup->sflags,SUBGRP_STATUS_DEFAULT_ORIGINATE))UNSET_FLAG(
paf->subgroup->sflags,SUBGRP_STATUS_DEFAULT_ORIGINATE);}/*Performrouterefreshmen
ttothepeer*/bgp_announce_route(peer,afi,safi);/*NoFSMactionnecessary*/returnBGP_
PACKET_NOOP;}/***ParseBGPCAPABILITYmessageforpeer.**@parampeer*@paramsizesizeoft
hepacket*@returnasinsummary*/staticintbgp_capability_msg_parse(structpeer*peer,u
int8_t*pnt,bgp_size_tlength){uint8_t*end;structcapability_mp_datampc;structcapab
ility_header*hdr;uint8_taction;iana_afi_tpkt_afi;afi_tafi;iana_safi_tpkt_safi;sa
fi_tsafi;end=pnt+length;while(pnt<end){/*Weneedatleastaction,capabilitycodeandca
pability*length.*/if(pnt+3>end){zlog_info("%sCapabilitylengtherror",peer->host);
bgp_notify_send(peer,BGP_NOTIFY_CEASE,0);returnBGP_Stop;}action=*pnt;hdr=(struct
capability_header*)(pnt+1);/*Actionvaluecheck.*/if(action!=CAPABILITY_ACTION_SET
&&action!=CAPABILITY_ACTION_UNSET){zlog_info("%sCapabilityActionValueerror%d",pe
er->host,action);bgp_notify_send(peer,BGP_NOTIFY_CEASE,0);returnBGP_Stop;}if(bgp
_debug_neighbor_events(peer))zlog_debug("%sCAPABILITYhasaction:%d,code:%u,length
%u",peer->host,action,hdr->code,hdr->length);/*Capabilitylengthcheck.*/if((pnt+h
dr->length+3)>end){zlog_info("%sCapabilitylengtherror",peer->host);bgp_notify_se
nd(peer,BGP_NOTIFY_CEASE,0);returnBGP_Stop;}/*Fetchstructuretothebytestream.*/me
mcpy(&mpc,pnt+3,sizeof(structcapability_mp_data));pnt+=hdr->length+3;/*WeknowMPC
apabilityCode.*/if(hdr->code==CAPABILITY_CODE_MP){pkt_afi=ntohs(mpc.afi);pkt_saf
i=mpc.safi;/*Ignorecapabilitywhenoverride-capabilityisset.*/if(CHECK_FLAG(peer->
flags,PEER_FLAG_OVERRIDE_CAPABILITY))continue;/*ConvertAFI,SAFItointernalvalues.
*/if(bgp_map_afi_safi_iana2int(pkt_afi,pkt_safi,&afi,&safi)){if(bgp_debug_neighb
or_events(peer))zlog_debug("%sDynamicCapabilityMP_EXTafi/safiinvalid""(%u/%u)",p
eer->host,pkt_afi,pkt_safi);continue;}/*Addressfamilycheck.*/if(bgp_debug_neighb
or_events(peer))zlog_debug("%sCAPABILITYhas%sMP_EXTCAPforafi/safi:%u/%u",peer->h
ost,action==CAPABILITY_ACTION_SET?"Advertising":"Removing",pkt_afi,pkt_safi);if(
action==CAPABILITY_ACTION_SET){peer->afc_recv[afi][safi]=1;if(peer->afc[afi][saf
i]){peer->afc_nego[afi][safi]=1;bgp_announce_route(peer,afi,safi);}}else{peer->a
fc_recv[afi][safi]=0;peer->afc_nego[afi][safi]=0;if(peer_active_nego(peer))bgp_c
lear_route(peer,afi,safi);elsereturnBGP_Stop;}}else{zlog_warn("%sunrecognizedcap
abilitycode:%d-ignored",peer->host,hdr->code);}}/*NoFSMactionnecessary*/returnBG
P_PACKET_NOOP;}/***ParseBGPCAPABILITYmessageforpeer.**Exportedforunittesting.**@
parampeer*@paramsizesizeofthepacket*@returnasinsummary*/intbgp_capability_receiv
e(structpeer*peer,bgp_size_tsize){uint8_t*pnt;/*Fetchpointer.*/pnt=stream_pnt(pe
er->curr);if(bgp_debug_neighbor_events(peer))zlog_debug("%srcvCAPABILITY",peer->
host);/*Ifpeerdoesnothavethecapability,sendnotification.*/if(!CHECK_FLAG(peer->c
ap,PEER_CAP_DYNAMIC_ADV)){zlog_err("%s[Error]BGPdynamiccapabilityisnotenabled",p
eer->host);bgp_notify_send(peer,BGP_NOTIFY_HEADER_ERR,BGP_NOTIFY_HEADER_BAD_MEST
YPE);returnBGP_Stop;}/*StatusmustbeEstablished.*/if(peer->status!=Established){z
log_err("%s[Error]Dynamiccapabilitypacketreceivedunderstatus%s",peer->host,looku
p_msg(bgp_status_msg,peer->status,NULL));bgp_notify_send(peer,BGP_NOTIFY_FSM_ERR
,0);returnBGP_Stop;}/*Parsepacket.*/returnbgp_capability_msg_parse(peer,pnt,size
);}/***Processesapeer'sinputbuffer.**Thisfunctionsidestepstheeventloopanddirectl
ycallsbgp_event_update()*afterprocessingeachBGPmessage.Thisisnecessarytoensurepr
oper*orderingofFSMeventsandunifiesthebehaviorthatwaspresentpreviously,*wherebyso
meofthepackethandlingfunctionswouldupdatetheFSMandsome*wouldnot,makingeventflowd
ifficulttounderstand.Pleasethinktwice*beforehackingthis.**Threadtype:THREAD_EVEN
T*@paramthread*@return0*/intbgp_process_packet(structthread*thread){/*Yesfirstof
allgetpeerpointer.*/structpeer*peer;//peeruint32_trpkt_quanta_old;//howmanypacke
tstoreadintfsm_update_result;//returncodeofbgp_event_update()intmprc;//messagepr
ocessingreturncodepeer=THREAD_ARG(thread);rpkt_quanta_old=atomic_load_explicit(&
peer->bgp->rpkt_quanta,memory_order_relaxed);fsm_update_result=0;/*Guardagainsts
cheduledeventsthatoccurafterpeerdeletion.*/if(peer->status==Deleted||peer->statu
s==Clearing)return0;unsignedintprocessed=0;while(processed<rpkt_quanta_old){uint
8_ttype=0;bgp_size_tsize;charnotify_data_length[2];pthread_mutex_lock(&peer->io_
mtx);{peer->curr=stream_fifo_pop(peer->ibuf);}pthread_mutex_unlock(&peer->io_mtx
);if(peer->curr==NULL)//nopacketstoprocess,hmm...return0;/*skipthemarkerandcopyt
hepacketlength*/stream_forward_getp(peer->curr,BGP_MARKER_SIZE);memcpy(notify_da
ta_length,stream_pnt(peer->curr),2);/*readinthepacketlengthandtype*/size=stream_
getw(peer->curr);type=stream_getc(peer->curr);/*BGPpacketdumpfunction.*/bgp_dump
_packet(peer,type,peer->curr);/*adjustsizetoexcludethemarker+length+type*/size-=
BGP_HEADER_SIZE;/*Readrestofthepacketandcalleachsortofpacketroutine*/switch(type
){caseBGP_MSG_OPEN:atomic_fetch_add_explicit(&peer->open_in,1,memory_order_relax
ed);mprc=bgp_open_receive(peer,size);if(mprc==BGP_Stop)zlog_err("%s:BGPOPENrecei
ptfailedforpeer:%s",__FUNCTION__,peer->host);break;caseBGP_MSG_UPDATE:atomic_fet
ch_add_explicit(&peer->update_in,1,memory_order_relaxed);peer->readtime=monotime
(NULL);mprc=bgp_update_receive(peer,size);if(mprc==BGP_Stop)zlog_err("%s:BGPUPDA
TEreceiptfailedforpeer:%s",__FUNCTION__,peer->host);break;caseBGP_MSG_NOTIFY:ato
mic_fetch_add_explicit(&peer->notify_in,1,memory_order_relaxed);mprc=bgp_notify_
receive(peer,size);if(mprc==BGP_Stop)zlog_err("%s:BGPNOTIFYreceiptfailedforpeer:
%s",__FUNCTION__,peer->host);break;caseBGP_MSG_KEEPALIVE:peer->readtime=monotime
(NULL);atomic_fetch_add_explicit(&peer->keepalive_in,1,memory_order_relaxed);mpr
c=bgp_keepalive_receive(peer,size);if(mprc==BGP_Stop)zlog_err("%s:BGPKEEPALIVEre
ceiptfailedforpeer:%s",__FUNCTION__,peer->host);break;caseBGP_MSG_ROUTE_REFRESH_
NEW:caseBGP_MSG_ROUTE_REFRESH_OLD:atomic_fetch_add_explicit(&peer->refresh_in,1,
memory_order_relaxed);mprc=bgp_route_refresh_receive(peer,size);if(mprc==BGP_Sto
p)zlog_err("%s:BGPROUTEREFRESHreceiptfailedforpeer:%s",__FUNCTION__,peer->host);
break;caseBGP_MSG_CAPABILITY:atomic_fetch_add_explicit(&peer->dynamic_cap_in,1,m
emory_order_relaxed);mprc=bgp_capability_receive(peer,size);if(mprc==BGP_Stop)zl
og_err("%s:BGPCAPABILITYreceiptfailedforpeer:%s",__FUNCTION__,peer->host);break;
default:/**Themessagetypeshouldhavebeensanitizedbefore*weevergothere.Receiptofam
essagewithan*invalidheaderatthispointisindicativeofa*securityissue.*/assert(!"Me
ssageofinvalidtypereceivedduringinputprocessing");}/*deleteprocessedpacket*/stre
am_free(peer->curr);peer->curr=NULL;processed++;/*UpdateFSM*/if(mprc!=BGP_PACKET
_NOOP)fsm_update_result=bgp_event_update(peer,mprc);elsecontinue;/**Ifpeerwasdel
eted,donotprocessanymorepackets.This*isusuallyduetoexecutingBGP_Stoporastubdelet
ion.*/if(fsm_update_result==FSM_PEER_TRANSFERRED||fsm_update_result==FSM_PEER_ST
OPPED)break;}if(fsm_update_result!=FSM_PEER_TRANSFERRED&&fsm_update_result!=FSM_
PEER_STOPPED){pthread_mutex_lock(&peer->io_mtx);{//moreworktodo,comebacklaterif(
peer->ibuf->count>0)thread_add_timer_msec(bm->master,bgp_process_packet,peer,0,&
peer->t_process_packet);}pthread_mutex_unlock(&peer->io_mtx);}return0;}