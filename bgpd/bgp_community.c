/*Communityattributerelatedfunctions.*Copyright(C)1998,2001KunihiroIshiguro**Thi
sfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyi
t*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundati
on;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedintheh
opethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MER
CHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformore
details.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispr
ogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinS
t,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"command.h"#includ
e"hash.h"#include"memory.h"#include"jhash.h"#include"bgpd/bgp_memory.h"#include"
bgpd/bgp_community.h"/*Hashofcommunityattribute.*/staticstructhash*comhash;/*All
ocateanewcommunitiesvalue.*/staticstructcommunity*community_new(void){return(str
uctcommunity*)XCALLOC(MTYPE_COMMUNITY,sizeof(structcommunity));}/*Freecommunitie
svalue.*/voidcommunity_free(structcommunity*com){if(com->val)XFREE(MTYPE_COMMUNI
TY_VAL,com->val);if(com->str)XFREE(MTYPE_COMMUNITY_STR,com->str);if(com->json){j
son_object_free(com->json);com->json=NULL;}XFREE(MTYPE_COMMUNITY,com);}/*Addonec
ommunityvaluetothecommunity.*/staticvoidcommunity_add_val(structcommunity*com,ui
nt32_tval){com->size++;if(com->val)com->val=XREALLOC(MTYPE_COMMUNITY_VAL,com->va
l,com_length(com));elsecom->val=XMALLOC(MTYPE_COMMUNITY_VAL,com_length(com));val
=htonl(val);memcpy(com_lastval(com),&val,sizeof(uint32_t));}/*Deleteonecommunity
.*/voidcommunity_del_val(structcommunity*com,uint32_t*val){inti=0;intc=0;if(!com
->val)return;while(i<com->size){if(memcmp(com->val+i,val,sizeof(uint32_t))==0){c
=com->size-i-1;if(c>0)memmove(com->val+i,com->val+(i+1),c*sizeof(*val));com->siz
e--;if(com->size>0)com->val=XREALLOC(MTYPE_COMMUNITY_VAL,com->val,com_length(com
));else{XFREE(MTYPE_COMMUNITY_VAL,com->val);com->val=NULL;}return;}i++;}}/*Delet
eallcommunitieslistedincom2fromcom1*/structcommunity*community_delete(structcomm
unity*com1,structcommunity*com2){inti=0;while(i<com2->size){community_del_val(co
m1,com2->val+i);i++;}returncom1;}/*Callbackfunctionfromqsort().*/staticintcommun
ity_compare(constvoid*a1,constvoid*a2){uint32_tv1;uint32_tv2;memcpy(&v1,a1,sizeo
f(uint32_t));memcpy(&v2,a2,sizeof(uint32_t));v1=ntohl(v1);v2=ntohl(v2);if(v1<v2)
return-1;if(v1>v2)return1;return0;}intcommunity_include(structcommunity*com,uint
32_tval){inti;val=htonl(val);for(i=0;i<com->size;i++)if(memcmp(&val,com_nthval(c
om,i),sizeof(uint32_t))==0)return1;return0;}uint32_tcommunity_val_get(structcomm
unity*com,inti){uint8_t*p;uint32_tval;p=(uint8_t*)com->val;p+=(i*4);memcpy(&val,
p,sizeof(uint32_t));returnntohl(val);}/*Sortanduniqgivencommunity.*/structcommun
ity*community_uniq_sort(structcommunity*com){inti;structcommunity*new;uint32_tva
l;if(!com)returnNULL;new=community_new();new->json=NULL;for(i=0;i<com->size;i++)
{val=community_val_get(com,i);if(!community_include(new,val))community_add_val(n
ew,val);}qsort(new->val,new->size,sizeof(uint32_t),community_compare);returnnew;
}/*Convertcommunitiesattributetostring.ForWell-knowncommunitiesvalue,belowkeywor
disused.0x0"internet"0xFFFFFF01"no-export"0xFFFFFF02"no-advertise"0xFFFFFF03"loc
al-AS"0xFFFF0000"graceful-shutdown"Forothervalues,"AS:VAL"formatisused.*/staticv
oidset_community_string(structcommunity*com,boolmake_json){inti;char*str;char*pn
t;intlen;intfirst;uint32_tcomval;uint16_tas;uint16_tval;json_object*json_communi
ty_list=NULL;json_object*json_string=NULL;if(!com)return;if(make_json){com->json
=json_object_new_object();json_community_list=json_object_new_array();}/*Whencom
munitiesattributeisempty.*/if(com->size==0){str=XMALLOC(MTYPE_COMMUNITY_STR,1);s
tr[0]='\0';if(make_json){json_object_string_add(com->json,"string","");json_obje
ct_object_add(com->json,"list",json_community_list);}com->str=str;return;}/*Memo
ryallocationistimeconsumingwork.Sowecalculaterequiredstringlengthfirst.*/len=0;f
or(i=0;i<com->size;i++){memcpy(&comval,com_nthval(com,i),sizeof(uint32_t));comva
l=ntohl(comval);switch(comval){caseCOMMUNITY_INTERNET:len+=strlen("internet");br
eak;caseCOMMUNITY_NO_EXPORT:len+=strlen("no-export");break;caseCOMMUNITY_NO_ADVE
RTISE:len+=strlen("no-advertise");break;caseCOMMUNITY_LOCAL_AS:len+=strlen("loca
l-AS");break;caseCOMMUNITY_GSHUT:len+=strlen("graceful-shutdown");break;default:
len+=strlen("65536:65535");break;}}/*Allocatememory.*/str=pnt=XMALLOC(MTYPE_COMM
UNITY_STR,len);first=1;/*Fillinstring.*/for(i=0;i<com->size;i++){memcpy(&comval,
com_nthval(com,i),sizeof(uint32_t));comval=ntohl(comval);if(first)first=0;else*p
nt++='';switch(comval){caseCOMMUNITY_INTERNET:strcpy(pnt,"internet");pnt+=strlen
("internet");if(make_json){json_string=json_object_new_string("internet");json_o
bject_array_add(json_community_list,json_string);}break;caseCOMMUNITY_NO_EXPORT:
strcpy(pnt,"no-export");pnt+=strlen("no-export");if(make_json){json_string=json_
object_new_string("noExport");json_object_array_add(json_community_list,json_str
ing);}break;caseCOMMUNITY_NO_ADVERTISE:strcpy(pnt,"no-advertise");pnt+=strlen("n
o-advertise");if(make_json){json_string=json_object_new_string("noAdvertise");js
on_object_array_add(json_community_list,json_string);}break;caseCOMMUNITY_LOCAL_
AS:strcpy(pnt,"local-AS");pnt+=strlen("local-AS");if(make_json){json_string=json
_object_new_string("localAs");json_object_array_add(json_community_list,json_str
ing);}break;caseCOMMUNITY_GSHUT:strcpy(pnt,"graceful-shutdown");pnt+=strlen("gra
ceful-shutdown");if(make_json){json_string=json_object_new_string("gracefulShutd
own");json_object_array_add(json_community_list,json_string);}break;default:as=(
comval>>16)&0xFFFF;val=comval&0xFFFF;sprintf(pnt,"%u:%d",as,val);if(make_json){j
son_string=json_object_new_string(pnt);json_object_array_add(json_community_list
,json_string);}pnt+=strlen(pnt);break;}}*pnt='\0';if(make_json){json_object_stri
ng_add(com->json,"string",str);json_object_object_add(com->json,"list",json_comm
unity_list);}com->str=str;}/*Interncommunitiesattribute.*/structcommunity*commun
ity_intern(structcommunity*com){structcommunity*find;/*Assertthiscommunitystruct
ureisnotinterned.*/assert(com->refcnt==0);/*Lookupcommunityhash.*/find=(structco
mmunity*)hash_get(comhash,com,hash_alloc_intern);/*Arguemntcomisallocatedtempora
ry.Sowhenitisnotusedinhash,itshouldbefreed.*/if(find!=com)community_free(com);/*
Incrementrefrencecounter.*/find->refcnt++;/*Makestring.*/if(!find->str)set_commu
nity_string(find,false);returnfind;}/*Freecommunityattribute.*/voidcommunity_uni
ntern(structcommunity**com){structcommunity*ret;if((*com)->refcnt)(*com)->refcnt
--;/*Pullofffromhash.*/if((*com)->refcnt==0){/*Communityvaluecommustexistinhash.
*/ret=(structcommunity*)hash_release(comhash,*com);assert(ret!=NULL);community_f
ree(*com);*com=NULL;}}/*Createnewcommunityattribute.*/structcommunity*community_
parse(uint32_t*pnt,unsignedshortlength){structcommunitytmp;structcommunity*new;/
*IflengthismalformedreturnNULL.*/if(length%4)returnNULL;/*Maketemporarycommunity
forhashlookup.*/tmp.size=length/4;tmp.val=pnt;new=community_uniq_sort(&tmp);retu
rncommunity_intern(new);}structcommunity*community_dup(structcommunity*com){stru
ctcommunity*new;new=XCALLOC(MTYPE_COMMUNITY,sizeof(structcommunity));new->size=c
om->size;if(new->size){new->val=XMALLOC(MTYPE_COMMUNITY_VAL,com->size*4);memcpy(
new->val,com->val,com->size*4);}elsenew->val=NULL;returnnew;}/*Retrunstringrepre
sentationofcommunitiesattribute.*/char*community_str(structcommunity*com,boolmak
e_json){if(!com)returnNULL;if(make_json&&!com->json&&com->str)XFREE(MTYPE_COMMUN
ITY_STR,com->str);if(!com->str)set_community_string(com,make_json);returncom->st
r;}/*Makehashvalueofcommunityattribute.Thisfunctionisusedbyhashpackage.*/unsigne
dintcommunity_hash_make(structcommunity*com){uint32_t*pnt=(uint32_t*)com->val;re
turnjhash2(pnt,com->size,0x43ea96c1);}intcommunity_match(conststructcommunity*co
m1,conststructcommunity*com2){inti=0;intj=0;if(com1==NULL&&com2==NULL)return1;if
(com1==NULL||com2==NULL)return0;if(com1->size<com2->size)return0;/*Everycommunit
yoncom2needstobeoncom1forthistomatch*/while(i<com1->size&&j<com2->size){if(memcm
p(com1->val+i,com2->val+j,sizeof(uint32_t))==0)j++;i++;}if(j==com2->size)return1
;elsereturn0;}/*Iftwoaspathhavesamevaluethenreturn1elsereturn0.Thisfunctionisuse
dbyhashpackage.*/intcommunity_cmp(conststructcommunity*com1,conststructcommunity
*com2){if(com1==NULL&&com2==NULL)return1;if(com1==NULL||com2==NULL)return0;if(co
m1->size==com2->size)if(memcmp(com1->val,com2->val,com1->size*4)==0)return1;retu
rn0;}/*Addcom2totheendofcom1.*/structcommunity*community_merge(structcommunity*c
om1,structcommunity*com2){if(com1->val)com1->val=XREALLOC(MTYPE_COMMUNITY_VAL,co
m1->val,(com1->size+com2->size)*4);elsecom1->val=XMALLOC(MTYPE_COMMUNITY_VAL,(co
m1->size+com2->size)*4);memcpy(com1->val+com1->size,com2->val,com2->size*4);com1
->size+=com2->size;returncom1;}/*Communitytokenenum.*/enumcommunity_token{commun
ity_token_val,community_token_no_export,community_token_no_advertise,community_t
oken_local_as,community_token_gshut,community_token_unknown};/*Getnextcommunityt
okenfromstring.*/staticconstchar*community_gettoken(constchar*buf,enumcommunity_
token*token,uint32_t*val){constchar*p=buf;/*Skipwhitespace.*/while(isspace((int)
*p))p++;/*Checktheendoftheline.*/if(*p=='\0')returnNULL;/*Wellknowncommunitystri
ngcheck.*/if(isalpha((int)*p)){if(strncmp(p,"internet",strlen("internet"))==0){*
val=COMMUNITY_INTERNET;*token=community_token_no_export;p+=strlen("internet");re
turnp;}if(strncmp(p,"no-export",strlen("no-export"))==0){*val=COMMUNITY_NO_EXPOR
T;*token=community_token_no_export;p+=strlen("no-export");returnp;}if(strncmp(p,
"no-advertise",strlen("no-advertise"))==0){*val=COMMUNITY_NO_ADVERTISE;*token=co
mmunity_token_no_advertise;p+=strlen("no-advertise");returnp;}if(strncmp(p,"loca
l-AS",strlen("local-AS"))==0){*val=COMMUNITY_LOCAL_AS;*token=community_token_loc
al_as;p+=strlen("local-AS");returnp;}if(strncmp(p,"graceful-shutdown",strlen("gr
aceful-shutdown"))==0){*val=COMMUNITY_GSHUT;*token=community_token_gshut;p+=strl
en("graceful-shutdown");returnp;}/*Unknownstring.*/*token=community_token_unknow
n;returnNULL;}/*Communityvalue.*/if(isdigit((int)*p)){intseparator=0;intdigit=0;
uint32_tcommunity_low=0;uint32_tcommunity_high=0;while(isdigit((int)*p)||*p==':'
){if(*p==':'){if(separator){*token=community_token_unknown;returnNULL;}else{sepa
rator=1;digit=0;if(community_low>UINT16_MAX){*token=community_token_unknown;retu
rnNULL;}community_high=community_low<<16;community_low=0;}}else{digit=1;communit
y_low*=10;community_low+=(*p-'0');}p++;}if(!digit){*token=community_token_unknow
n;returnNULL;}if(community_low>UINT16_MAX){*token=community_token_unknown;return
NULL;}*val=community_high+community_low;*token=community_token_val;returnp;}*tok
en=community_token_unknown;returnNULL;}/*convertstringtocommunitystructure*/stru
ctcommunity*community_str2com(constchar*str){structcommunity*com=NULL;structcomm
unity*com_sort=NULL;uint32_tval=0;enumcommunity_tokentoken=community_token_unkno
wn;do{str=community_gettoken(str,&token,&val);switch(token){casecommunity_token_
val:casecommunity_token_no_export:casecommunity_token_no_advertise:casecommunity
_token_local_as:casecommunity_token_gshut:if(com==NULL){com=community_new();com-
>json=NULL;}community_add_val(com,val);break;casecommunity_token_unknown:default
:if(com)community_free(com);returnNULL;}}while(str);if(!com)returnNULL;com_sort=
community_uniq_sort(com);community_free(com);returncom_sort;}/*Returncommunities
hashentrycount.*/unsignedlongcommunity_count(void){returncomhash->count;}/*Retur
ncommunitieshash.*/structhash*community_hash(void){returncomhash;}/*Initializeco
mminityrelatedhash.*/voidcommunity_init(void){comhash=hash_create((unsignedint(*
)(void*))community_hash_make,(int(*)(constvoid*,constvoid*))community_cmp,"BGPCo
mmunityHash");}voidcommunity_finish(void){hash_free(comhash);comhash=NULL;}