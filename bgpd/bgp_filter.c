/*ASpathfilterlist.*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebra.*
*GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNU
GeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(at
youroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,b
ut*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFO
RAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhave
receivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING
;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA0
2110-1301USA*/#include<zebra.h>#include"command.h"#include"log.h"#include"memory
.h"#include"buffer.h"#include"queue.h"#include"filter.h"#include"bgpd/bgpd.h"#in
clude"bgpd/bgp_aspath.h"#include"bgpd/bgp_regex.h"#include"bgpd/bgp_filter.h"/*L
istofASfilterlist.*/structas_list_list{structas_list*head;structas_list*tail;};/
*ASpathfiltermaster.*/structas_list_master{/*Listofaccess_listwhichnameisnumber.
*/structas_list_listnum;/*Listofaccess_listwhichnameisstring.*/structas_list_lis
tstr;/*Hookfunctionwhichisexecutedwhennewaccess_listisadded.*/void(*add_hook)(ch
ar*);/*Hookfunctionwhichisexecutedwhenaccess_listisdeleted.*/void(*delete_hook)(
constchar*);};/*ElementofASpathfilter.*/structas_filter{structas_filter*next;str
uctas_filter*prev;enumas_filter_typetype;regex_t*reg;char*reg_str;};/*ASpathfilt
erlist.*/structas_list{char*name;enumaccess_typetype;structas_list*next;structas
_list*prev;structas_filter*head;structas_filter*tail;};/*ipas-pathaccess-list10p
ermitAS1.*/staticstructas_list_masteras_list_master={{NULL,NULL},{NULL,NULL},NUL
L,NULL};/*AllocatenewASfilter.*/staticstructas_filter*as_filter_new(void){return
XCALLOC(MTYPE_AS_FILTER,sizeof(structas_filter));}/*FreeallocatedASfilter.*/stat
icvoidas_filter_free(structas_filter*asfilter){if(asfilter->reg)bgp_regex_free(a
sfilter->reg);if(asfilter->reg_str)XFREE(MTYPE_AS_FILTER_STR,asfilter->reg_str);
XFREE(MTYPE_AS_FILTER,asfilter);}/*MakenewASfilter.*/staticstructas_filter*as_fi
lter_make(regex_t*reg,constchar*reg_str,enumas_filter_typetype){structas_filter*
asfilter;asfilter=as_filter_new();asfilter->reg=reg;asfilter->type=type;asfilter
->reg_str=XSTRDUP(MTYPE_AS_FILTER_STR,reg_str);returnasfilter;}staticstructas_fi
lter*as_filter_lookup(structas_list*aslist,constchar*reg_str,enumas_filter_typet
ype){structas_filter*asfilter;for(asfilter=aslist->head;asfilter;asfilter=asfilt
er->next)if(strcmp(reg_str,asfilter->reg_str)==0)returnasfilter;returnNULL;}stat
icvoidas_list_filter_add(structas_list*aslist,structas_filter*asfilter){asfilter
->next=NULL;asfilter->prev=aslist->tail;if(aslist->tail)aslist->tail->next=asfil
ter;elseaslist->head=asfilter;aslist->tail=asfilter;/*Runhookfunction.*/if(as_li
st_master.add_hook)(*as_list_master.add_hook)(aslist->name);}/*Lookupas_listfrom
listofas_listbyname.*/structas_list*as_list_lookup(constchar*name){structas_list
*aslist;if(name==NULL)returnNULL;for(aslist=as_list_master.num.head;aslist;aslis
t=aslist->next)if(strcmp(aslist->name,name)==0)returnaslist;for(aslist=as_list_m
aster.str.head;aslist;aslist=aslist->next)if(strcmp(aslist->name,name)==0)return
aslist;returnNULL;}staticstructas_list*as_list_new(void){returnXCALLOC(MTYPE_AS_
LIST,sizeof(structas_list));}staticvoidas_list_free(structas_list*aslist){if(asl
ist->name){XFREE(MTYPE_AS_STR,aslist->name);aslist->name=NULL;}XFREE(MTYPE_AS_LI
ST,aslist);}/*InsertnewASlisttolistofas_list.Eachas_listissortedbythename.*/stat
icstructas_list*as_list_insert(constchar*name){size_ti;longnumber;structas_list*
aslist;structas_list*point;structas_list_list*list;/*Allocatenewaccess_listandco
pygivenname.*/aslist=as_list_new();aslist->name=XSTRDUP(MTYPE_AS_STR,name);asser
t(aslist->name);/*Ifnameismadebyalldigitcharacter.Wetreatitasnumber.*/for(number
=0,i=0;i<strlen(name);i++){if(isdigit((int)name[i]))number=(number*10)+(name[i]-
'0');elsebreak;}/*Incaseofnameisalldigitcharacter*/if(i==strlen(name)){aslist->t
ype=ACCESS_TYPE_NUMBER;/*Setaccess_listtonumberlist.*/list=&as_list_master.num;f
or(point=list->head;point;point=point->next)if(atol(point->name)>=number)break;}
else{aslist->type=ACCESS_TYPE_STRING;/*Setaccess_listtostringlist.*/list=&as_lis
t_master.str;/*Setpointtoinsertionpoint.*/for(point=list->head;point;point=point
->next)if(strcmp(point->name,name)>=0)break;}/*Incaseofthisisthefirstelementofma
ster.*/if(list->head==NULL){list->head=list->tail=aslist;returnaslist;}/*Incaseo
finsertionismadeatthetailofaccess_list.*/if(point==NULL){aslist->prev=list->tail
;list->tail->next=aslist;list->tail=aslist;returnaslist;}/*Incaseofinsertionisma
deattheheadofaccess_list.*/if(point==list->head){aslist->next=list->head;list->h
ead->prev=aslist;list->head=aslist;returnaslist;}/*Insertionismadeatmiddleofthea
ccess_list.*/aslist->next=point;aslist->prev=point->prev;if(point->prev)point->p
rev->next=aslist;point->prev=aslist;returnaslist;}staticstructas_list*as_list_ge
t(constchar*name){structas_list*aslist;aslist=as_list_lookup(name);if(aslist==NU
LL)aslist=as_list_insert(name);returnaslist;}staticconstchar*filter_type_str(enu
mas_filter_typetype){switch(type){caseAS_FILTER_PERMIT:return"permit";caseAS_FIL
TER_DENY:return"deny";default:return"";}}staticvoidas_list_delete(structas_list*
aslist){structas_list_list*list;structas_filter*filter,*next;for(filter=aslist->
head;filter;filter=next){next=filter->next;as_filter_free(filter);}if(aslist->ty
pe==ACCESS_TYPE_NUMBER)list=&as_list_master.num;elselist=&as_list_master.str;if(
aslist->next)aslist->next->prev=aslist->prev;elselist->tail=aslist->prev;if(asli
st->prev)aslist->prev->next=aslist->next;elselist->head=aslist->next;as_list_fre
e(aslist);}staticintas_list_empty(structas_list*aslist){if(aslist->head==NULL&&a
slist->tail==NULL)return1;elsereturn0;}staticvoidas_list_filter_delete(structas_
list*aslist,structas_filter*asfilter){char*name=XSTRDUP(MTYPE_AS_STR,aslist->nam
e);if(asfilter->next)asfilter->next->prev=asfilter->prev;elseaslist->tail=asfilt
er->prev;if(asfilter->prev)asfilter->prev->next=asfilter->next;elseaslist->head=
asfilter->next;as_filter_free(asfilter);/*Ifaccess_listbecomesemptydeleteitfroma
ccess_master.*/if(as_list_empty(aslist))as_list_delete(aslist);/*Runhookfunction
.*/if(as_list_master.delete_hook)(*as_list_master.delete_hook)(name);if(name)XFR
EE(MTYPE_AS_STR,name);}staticintas_filter_match(structas_filter*asfilter,structa
spath*aspath){if(bgp_regexec(asfilter->reg,aspath)!=REG_NOMATCH)return1;return0;
}/*ApplyASpathfiltertoAS.*/enumas_filter_typeas_list_apply(structas_list*aslist,
void*object){structas_filter*asfilter;structaspath*aspath;aspath=(structaspath*)
object;if(aslist==NULL)returnAS_FILTER_DENY;for(asfilter=aslist->head;asfilter;a
sfilter=asfilter->next){if(as_filter_match(asfilter,aspath))returnasfilter->type
;}returnAS_FILTER_DENY;}/*Addhookfunction.*/voidas_list_add_hook(void(*func)(cha
r*)){as_list_master.add_hook=func;}/*Deletehookfunction.*/voidas_list_delete_hoo
k(void(*func)(constchar*)){as_list_master.delete_hook=func;}staticintas_list_dup
_check(structas_list*aslist,structas_filter*new){structas_filter*asfilter;for(as
filter=aslist->head;asfilter;asfilter=asfilter->next){if(asfilter->type==new->ty
pe&&strcmp(asfilter->reg_str,new->reg_str)==0)return1;}return0;}DEFUN(ip_as_path
,ip_as_path_cmd,"ipas-pathaccess-listWORD<deny|permit>LINE...",IP_STR"BGPautonom
oussystempathfilter\n""Specifyanaccesslistname\n""Regularexpressionaccesslistnam
e\n""Specifypacketstoreject\n""Specifypacketstoforward\n""Aregular-expressiontom
atchtheBGPASpaths\n"){intidx=0;enumas_filter_typetype;structas_filter*asfilter;s
tructas_list*aslist;regex_t*regex;char*regstr;/*Retrieveaccesslistname*/argv_fin
d(argv,argc,"WORD",&idx);char*alname=argv[idx]->arg;/*Checkthefiltertype.*/type=
argv_find(argv,argc,"deny",&idx)?AS_FILTER_DENY:AS_FILTER_PERMIT;/*CheckASpathre
gex.*/argv_find(argv,argc,"LINE",&idx);regstr=argv_concat(argv,argc,idx);regex=b
gp_regcomp(regstr);if(!regex){vty_out(vty,"can'tcompileregexp%s\n",regstr);XFREE
(MTYPE_TMP,regstr);returnCMD_WARNING_CONFIG_FAILED;}asfilter=as_filter_make(rege
x,regstr,type);XFREE(MTYPE_TMP,regstr);/*Installnewfiltertotheaccess_list.*/asli
st=as_list_get(alname);/*Duplicateinsertioncheck.*/;if(as_list_dup_check(aslist,
asfilter))as_filter_free(asfilter);elseas_list_filter_add(aslist,asfilter);retur
nCMD_SUCCESS;}DEFUN(no_ip_as_path,no_ip_as_path_cmd,"noipas-pathaccess-listWORD<
deny|permit>LINE...",NO_STRIP_STR"BGPautonomoussystempathfilter\n""Specifyanacce
sslistname\n""Regularexpressionaccesslistname\n""Specifypacketstoreject\n""Speci
fypacketstoforward\n""Aregular-expressiontomatchtheBGPASpaths\n"){intidx=0;enuma
s_filter_typetype;structas_filter*asfilter;structas_list*aslist;char*regstr;rege
x_t*regex;char*aslistname=argv_find(argv,argc,"WORD",&idx)?argv[idx]->arg:NULL;/
*LookupASlistfromASpathlist.*/aslist=as_list_lookup(aslistname);if(aslist==NULL)
{vty_out(vty,"ipas-pathaccess-list%sdoesn'texist\n",aslistname);returnCMD_WARNIN
G_CONFIG_FAILED;}/*Checkthefiltertype.*/if(argv_find(argv,argc,"permit",&idx))ty
pe=AS_FILTER_PERMIT;elseif(argv_find(argv,argc,"deny",&idx))type=AS_FILTER_DENY;
else{vty_out(vty,"filtertypemustbe[permit|deny]\n");returnCMD_WARNING_CONFIG_FAI
LED;}/*CompileASpath.*/argv_find(argv,argc,"LINE",&idx);regstr=argv_concat(argv,
argc,idx);regex=bgp_regcomp(regstr);if(!regex){vty_out(vty,"can'tcompileregexp%s
\n",regstr);XFREE(MTYPE_TMP,regstr);returnCMD_WARNING_CONFIG_FAILED;}/*Lookupasf
ilter.*/asfilter=as_filter_lookup(aslist,regstr,type);XFREE(MTYPE_TMP,regstr);bg
p_regex_free(regex);if(asfilter==NULL){vty_out(vty,"\n");returnCMD_WARNING_CONFI
G_FAILED;}as_list_filter_delete(aslist,asfilter);returnCMD_SUCCESS;}DEFUN(no_ip_
as_path_all,no_ip_as_path_all_cmd,"noipas-pathaccess-listWORD",NO_STRIP_STR"BGPa
utonomoussystempathfilter\n""Specifyanaccesslistname\n""Regularexpressionaccessl
istname\n"){intidx_word=4;structas_list*aslist;aslist=as_list_lookup(argv[idx_wo
rd]->arg);if(aslist==NULL){vty_out(vty,"ipas-pathaccess-list%sdoesn'texist\n",ar
gv[idx_word]->arg);returnCMD_WARNING_CONFIG_FAILED;}as_list_delete(aslist);/*Run
hookfunction.*/if(as_list_master.delete_hook)(*as_list_master.delete_hook)(argv[
idx_word]->arg);returnCMD_SUCCESS;}staticvoidas_list_show(structvty*vty,structas
_list*aslist){structas_filter*asfilter;vty_out(vty,"ASpathaccesslist%s\n",aslist
->name);for(asfilter=aslist->head;asfilter;asfilter=asfilter->next){vty_out(vty,
"%s%s\n",filter_type_str(asfilter->type),asfilter->reg_str);}}staticvoidas_list_
show_all(structvty*vty){structas_list*aslist;structas_filter*asfilter;for(aslist
=as_list_master.num.head;aslist;aslist=aslist->next){vty_out(vty,"ASpathaccessli
st%s\n",aslist->name);for(asfilter=aslist->head;asfilter;asfilter=asfilter->next
){vty_out(vty,"%s%s\n",filter_type_str(asfilter->type),asfilter->reg_str);}}for(
aslist=as_list_master.str.head;aslist;aslist=aslist->next){vty_out(vty,"ASpathac
cesslist%s\n",aslist->name);for(asfilter=aslist->head;asfilter;asfilter=asfilter
->next){vty_out(vty,"%s%s\n",filter_type_str(asfilter->type),asfilter->reg_str);
}}}DEFUN(show_ip_as_path_access_list,show_ip_as_path_access_list_cmd,"showipas-p
ath-access-listWORD",SHOW_STRIP_STR"ListASpathaccesslists\n""ASpathaccesslistnam
e\n"){intidx_word=3;structas_list*aslist;aslist=as_list_lookup(argv[idx_word]->a
rg);if(aslist)as_list_show(vty,aslist);returnCMD_SUCCESS;}DEFUN(show_ip_as_path_
access_list_all,show_ip_as_path_access_list_all_cmd,"showipas-path-access-list",
SHOW_STRIP_STR"ListASpathaccesslists\n"){as_list_show_all(vty);returnCMD_SUCCESS
;}staticintconfig_write_as_list(structvty*vty){structas_list*aslist;structas_fil
ter*asfilter;intwrite=0;for(aslist=as_list_master.num.head;aslist;aslist=aslist-
>next)for(asfilter=aslist->head;asfilter;asfilter=asfilter->next){vty_out(vty,"i
pas-pathaccess-list%s%s%s\n",aslist->name,filter_type_str(asfilter->type),asfilt
er->reg_str);write++;}for(aslist=as_list_master.str.head;aslist;aslist=aslist->n
ext)for(asfilter=aslist->head;asfilter;asfilter=asfilter->next){vty_out(vty,"ipa
s-pathaccess-list%s%s%s\n",aslist->name,filter_type_str(asfilter->type),asfilter
->reg_str);write++;}returnwrite;}staticstructcmd_nodeas_list_node={AS_LIST_NODE,
"",1};/*Registerfunctions.*/voidbgp_filter_init(void){install_node(&as_list_node
,config_write_as_list);install_element(CONFIG_NODE,&ip_as_path_cmd);install_elem
ent(CONFIG_NODE,&no_ip_as_path_cmd);install_element(CONFIG_NODE,&no_ip_as_path_a
ll_cmd);install_element(VIEW_NODE,&show_ip_as_path_access_list_cmd);install_elem
ent(VIEW_NODE,&show_ip_as_path_access_list_all_cmd);}voidbgp_filter_reset(void){
structas_list*aslist;structas_list*next;for(aslist=as_list_master.num.head;aslis
t;aslist=next){next=aslist->next;as_list_delete(aslist);}for(aslist=as_list_mast
er.str.head;aslist;aslist=next){next=aslist->next;as_list_delete(aslist);}assert
(as_list_master.num.head==NULL);assert(as_list_master.num.tail==NULL);assert(as_
list_master.str.head==NULL);assert(as_list_master.str.tail==NULL);}