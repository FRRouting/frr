/*BGPcommunity-listandextcommunity-list.*Copyright(C)1999KunihiroIshiguro**Thisf
ileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*
underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation
;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehop
ethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCH
ANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformorede
tails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprog
ram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,
FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"command.h"#include"
prefix.h"#include"memory.h"#include"queue.h"#include"filter.h"#include"stream.h"
#include"bgpd/bgpd.h"#include"bgpd/bgp_community.h"#include"bgpd/bgp_ecommunity.
h"#include"bgpd/bgp_lcommunity.h"#include"bgpd/bgp_aspath.h"#include"bgpd/bgp_re
gex.h"#include"bgpd/bgp_clist.h"/*Lookupmasterstructureforcommunity-listorextcom
munity-list.*/structcommunity_list_master*community_list_master_lookup(structcom
munity_list_handler*ch,intmaster){if(ch)switch(master){caseCOMMUNITY_LIST_MASTER
:return&ch->community_list;caseEXTCOMMUNITY_LIST_MASTER:return&ch->extcommunity_
list;caseLARGE_COMMUNITY_LIST_MASTER:return&ch->lcommunity_list;}returnNULL;}/*A
llocateanewcommunitylistentry.*/staticstructcommunity_entry*community_entry_new(
void){returnXCALLOC(MTYPE_COMMUNITY_LIST_ENTRY,sizeof(structcommunity_entry));}/
*Freecommunitylistentry.*/staticvoidcommunity_entry_free(structcommunity_entry*e
ntry){switch(entry->style){caseCOMMUNITY_LIST_STANDARD:if(entry->u.com)community
_free(entry->u.com);break;caseLARGE_COMMUNITY_LIST_STANDARD:if(entry->u.lcom)lco
mmunity_free(&entry->u.lcom);break;caseEXTCOMMUNITY_LIST_STANDARD:/*Incaseofstan
dardextcommunity-list,configurationstringismadebyecommunity_ecom2str().*/if(entr
y->config)XFREE(MTYPE_ECOMMUNITY_STR,entry->config);if(entry->u.ecom)ecommunity_
free(&entry->u.ecom);break;caseCOMMUNITY_LIST_EXPANDED:caseEXTCOMMUNITY_LIST_EXP
ANDED:caseLARGE_COMMUNITY_LIST_EXPANDED:if(entry->config)XFREE(MTYPE_COMMUNITY_L
IST_CONFIG,entry->config);if(entry->reg)bgp_regex_free(entry->reg);default:break
;}XFREE(MTYPE_COMMUNITY_LIST_ENTRY,entry);}/*Allocateanewcommunity-list.*/static
structcommunity_list*community_list_new(void){returnXCALLOC(MTYPE_COMMUNITY_LIST
,sizeof(structcommunity_list));}/*Freecommunity-list.*/staticvoidcommunity_list_
free(structcommunity_list*list){if(list->name)XFREE(MTYPE_COMMUNITY_LIST_NAME,li
st->name);XFREE(MTYPE_COMMUNITY_LIST,list);}staticstructcommunity_list*community
_list_insert(structcommunity_list_handler*ch,constchar*name,intmaster){size_ti;l
ongnumber;structcommunity_list*new;structcommunity_list*point;structcommunity_li
st_list*list;structcommunity_list_master*cm;/*Lookupcommunity-listmaster.*/cm=co
mmunity_list_master_lookup(ch,master);if(!cm)returnNULL;/*Allocatenewcommunity_l
istandcopygivenname.*/new=community_list_new();new->name=XSTRDUP(MTYPE_COMMUNITY
_LIST_NAME,name);/*Ifnameismadebyalldigitcharacter.Wetreatitasnumber.*/for(numbe
r=0,i=0;i<strlen(name);i++){if(isdigit((int)name[i]))number=(number*10)+(name[i]
-'0');elsebreak;}/*Incaseofnameisalldigitcharacter*/if(i==strlen(name)){new->sor
t=COMMUNITY_LIST_NUMBER;/*Setaccess_listtonumberlist.*/list=&cm->num;for(point=l
ist->head;point;point=point->next)if(atol(point->name)>=number)break;}else{new->
sort=COMMUNITY_LIST_STRING;/*Setaccess_listtostringlist.*/list=&cm->str;/*Setpoi
nttoinsertionpoint.*/for(point=list->head;point;point=point->next)if(strcmp(poin
t->name,name)>=0)break;}/*Linktoupperlist.*/new->parent=list;/*Incaseofthisisthe
firstelementofmaster.*/if(list->head==NULL){list->head=list->tail=new;returnnew;
}/*Incaseofinsertionismadeatthetailofaccess_list.*/if(point==NULL){new->prev=lis
t->tail;list->tail->next=new;list->tail=new;returnnew;}/*Incaseofinsertionismade
attheheadofaccess_list.*/if(point==list->head){new->next=list->head;list->head->
prev=new;list->head=new;returnnew;}/*Insertionismadeatmiddleoftheaccess_list.*/n
ew->next=point;new->prev=point->prev;if(point->prev)point->prev->next=new;point-
>prev=new;returnnew;}structcommunity_list*community_list_lookup(structcommunity_
list_handler*ch,constchar*name,intmaster){structcommunity_list*list;structcommun
ity_list_master*cm;if(!name)returnNULL;cm=community_list_master_lookup(ch,master
);if(!cm)returnNULL;for(list=cm->num.head;list;list=list->next)if(strcmp(list->n
ame,name)==0)returnlist;for(list=cm->str.head;list;list=list->next)if(strcmp(lis
t->name,name)==0)returnlist;returnNULL;}staticstructcommunity_list*community_lis
t_get(structcommunity_list_handler*ch,constchar*name,intmaster){structcommunity_
list*list;list=community_list_lookup(ch,name,master);if(!list)list=community_lis
t_insert(ch,name,master);returnlist;}staticvoidcommunity_list_delete(structcommu
nity_list*list){structcommunity_list_list*clist;structcommunity_entry*entry,*nex
t;for(entry=list->head;entry;entry=next){next=entry->next;community_entry_free(e
ntry);}clist=list->parent;if(list->next)list->next->prev=list->prev;elseclist->t
ail=list->prev;if(list->prev)list->prev->next=list->next;elseclist->head=list->n
ext;community_list_free(list);}staticintcommunity_list_empty_p(structcommunity_l
ist*list){return(list->head==NULL&&list->tail==NULL)?1:0;}/*Addcommunity-listent
rytothelist.*/staticvoidcommunity_list_entry_add(structcommunity_list*list,struc
tcommunity_entry*entry){entry->next=NULL;entry->prev=list->tail;if(list->tail)li
st->tail->next=entry;elselist->head=entry;list->tail=entry;}/*Deletecommunity-li
stentryfromthelist.*/staticvoidcommunity_list_entry_delete(structcommunity_list*
list,structcommunity_entry*entry,intstyle){if(entry->next)entry->next->prev=entr
y->prev;elselist->tail=entry->prev;if(entry->prev)entry->prev->next=entry->next;
elselist->head=entry->next;community_entry_free(entry);if(community_list_empty_p
(list))community_list_delete(list);}/*Lookupcommunity-listentryfromthelist.*/sta
ticstructcommunity_entry*community_list_entry_lookup(structcommunity_list*list,c
onstvoid*arg,intdirect){structcommunity_entry*entry;for(entry=list->head;entry;e
ntry=entry->next){switch(entry->style){caseCOMMUNITY_LIST_STANDARD:if(entry->dir
ect==direct&&community_cmp(entry->u.com,arg))returnentry;break;caseEXTCOMMUNITY_
LIST_STANDARD:if(entry->direct==direct&&ecommunity_cmp(entry->u.ecom,arg))return
entry;break;caseLARGE_COMMUNITY_LIST_STANDARD:if(entry->direct==direct&&lcommuni
ty_cmp(entry->u.lcom,arg))returnentry;break;caseCOMMUNITY_LIST_EXPANDED:caseEXTC
OMMUNITY_LIST_EXPANDED:caseLARGE_COMMUNITY_LIST_EXPANDED:if(entry->direct==direc
t&&strcmp(entry->config,arg)==0)returnentry;break;default:break;}}returnNULL;}st
aticchar*community_str_get(structcommunity*com,inti){intlen;uint32_tcomval;uint1
6_tas;uint16_tval;char*str;char*pnt;memcpy(&comval,com_nthval(com,i),sizeof(uint
32_t));comval=ntohl(comval);switch(comval){caseCOMMUNITY_INTERNET:len=strlen("in
ternet");break;caseCOMMUNITY_NO_EXPORT:len=strlen("no-export");break;caseCOMMUNI
TY_NO_ADVERTISE:len=strlen("no-advertise");break;caseCOMMUNITY_LOCAL_AS:len=strl
en("local-AS");break;caseCOMMUNITY_GSHUT:len=strlen("graceful-shutdown");break;d
efault:len=strlen("65536:65535");break;}/*Allocatememory.*/str=pnt=XMALLOC(MTYPE
_COMMUNITY_STR,len);switch(comval){caseCOMMUNITY_INTERNET:strcpy(pnt,"internet")
;pnt+=strlen("internet");break;caseCOMMUNITY_NO_EXPORT:strcpy(pnt,"no-export");p
nt+=strlen("no-export");break;caseCOMMUNITY_NO_ADVERTISE:strcpy(pnt,"no-advertis
e");pnt+=strlen("no-advertise");break;caseCOMMUNITY_LOCAL_AS:strcpy(pnt,"local-A
S");pnt+=strlen("local-AS");break;caseCOMMUNITY_GSHUT:strcpy(pnt,"graceful-shutd
own");pnt+=strlen("graceful-shutdown");break;default:as=(comval>>16)&0xFFFF;val=
comval&0xFFFF;sprintf(pnt,"%u:%d",as,val);pnt+=strlen(pnt);break;}*pnt='\0';retu
rnstr;}/*Internalfunctiontoperformregularexpressionmatchfor*asinglecommunity.*/s
taticintcommunity_regexp_include(regex_t*reg,structcommunity*com,inti){char*str;
intrv;/*Whenthereisnocommunitiesattributeitistreatedasemptystring.*/if(com==NULL
||com->size==0)str=XSTRDUP(MTYPE_COMMUNITY_STR,"");elsestr=community_str_get(com
,i);/*Regularexpressionmatch.*/rv=regexec(reg,str,0,NULL,0);XFREE(MTYPE_COMMUNIT
Y_STR,str);if(rv==0)return1;/*Nomatch.*/return0;}/*Internalfunctiontoperformregu
larexpressionmatchforcommunityattribute.*/staticintcommunity_regexp_match(struct
community*com,regex_t*reg){constchar*str;/*Whenthereisnocommunitiesattributeitis
treatedasemptystring.*/if(com==NULL||com->size==0)str="";elsestr=community_str(c
om,false);/*Regularexpressionmatch.*/if(regexec(reg,str,0,NULL,0)==0)return1;/*N
omatch.*/return0;}staticchar*lcommunity_str_get(structlcommunity*lcom,inti){stru
ctlcommunity_vallcomval;uint32_tglobaladmin;uint32_tlocaldata1;uint32_tlocaldata
2;char*str;uint8_t*ptr;char*pnt;ptr=lcom->val+(i*LCOMMUNITY_SIZE);memcpy(&lcomva
l,ptr,LCOMMUNITY_SIZE);/*Allocatememory.48bytestakenoffbgp_lcommunity.c*/str=pnt
=XMALLOC(MTYPE_LCOMMUNITY_STR,48);ptr=(uint8_t*)lcomval.val;ptr=ptr_get_be32(ptr
,&globaladmin);ptr=ptr_get_be32(ptr,&localdata1);ptr=ptr_get_be32(ptr,&localdata
2);(void)ptr;/*consumevalue*/sprintf(pnt,"%u:%u:%u",globaladmin,localdata1,local
data2);pnt+=strlen(pnt);*pnt='\0';returnstr;}/*Internalfunctiontoperformregulare
xpressionmatchfor*asinglecommunity.*/staticintlcommunity_regexp_include(regex_t*
reg,structlcommunity*lcom,inti){char*str;/*Whenthereisnocommunitiesattributeitis
treatedasemptystring.*/if(lcom==NULL||lcom->size==0)str=XSTRDUP(MTYPE_LCOMMUNITY
_STR,"");elsestr=lcommunity_str_get(lcom,i);/*Regularexpressionmatch.*/if(regexe
c(reg,str,0,NULL,0)==0){XFREE(MTYPE_LCOMMUNITY_STR,str);return1;}XFREE(MTYPE_LCO
MMUNITY_STR,str);/*Nomatch.*/return0;}staticintlcommunity_regexp_match(structlco
mmunity*com,regex_t*reg){constchar*str;/*Whenthereisnocommunitiesattributeitistr
eatedasemptystring.*/if(com==NULL||com->size==0)str="";elsestr=lcommunity_str(co
m);/*Regularexpressionmatch.*/if(regexec(reg,str,0,NULL,0)==0)return1;/*Nomatch.
*/return0;}staticintecommunity_regexp_match(structecommunity*ecom,regex_t*reg){c
onstchar*str;/*Whenthereisnocommunitiesattributeitistreatedasemptystring.*/if(ec
om==NULL||ecom->size==0)str="";elsestr=ecommunity_str(ecom);/*Regularexpressionm
atch.*/if(regexec(reg,str,0,NULL,0)==0)return1;/*Nomatch.*/return0;}#if0/*Delete
communityattributeusingregularexpressionmatch.Returnmodifiedcommunitesattribute.
*/staticstructcommunity*community_regexp_delete(structcommunity*com,regex_t*reg)
{inti;uint32_tcomval;/*Maximumis"65535:65535"+'\0'.*/charc[12];constchar*str;if(
!com)returnNULL;i=0;while(i<com->size){memcpy(&comval,com_nthval(com,i),sizeof(u
int32_t));comval=ntohl(comval);switch(comval){caseCOMMUNITY_INTERNET:str="intern
et";break;caseCOMMUNITY_NO_EXPORT:str="no-export";break;caseCOMMUNITY_NO_ADVERTI
SE:str="no-advertise";break;caseCOMMUNITY_LOCAL_AS:str="local-AS";break;default:
sprintf(c,"%d:%d",(comval>>16)&0xFFFF,comval&0xFFFF);str=c;break;}if(regexec(reg
,str,0,NULL,0)==0)community_del_val(com,com_nthval(com,i));elsei++;}returncom;}#
endif/*Whengivencommunityattributematchestothecommunity-listreturn1elsereturn0.*
/intcommunity_list_match(structcommunity*com,structcommunity_list*list){structco
mmunity_entry*entry;for(entry=list->head;entry;entry=entry->next){if(entry->any)
returnentry->direct==COMMUNITY_PERMIT?1:0;if(entry->style==COMMUNITY_LIST_STANDA
RD){if(community_include(entry->u.com,COMMUNITY_INTERNET))returnentry->direct==C
OMMUNITY_PERMIT?1:0;if(community_match(com,entry->u.com))returnentry->direct==CO
MMUNITY_PERMIT?1:0;}elseif(entry->style==COMMUNITY_LIST_EXPANDED){if(community_r
egexp_match(com,entry->reg))returnentry->direct==COMMUNITY_PERMIT?1:0;}}return0;
}intlcommunity_list_match(structlcommunity*lcom,structcommunity_list*list){struc
tcommunity_entry*entry;for(entry=list->head;entry;entry=entry->next){if(entry->a
ny)returnentry->direct==COMMUNITY_PERMIT?1:0;if(entry->style==LARGE_COMMUNITY_LI
ST_STANDARD){if(lcommunity_match(lcom,entry->u.lcom))returnentry->direct==COMMUN
ITY_PERMIT?1:0;}elseif(entry->style==LARGE_COMMUNITY_LIST_EXPANDED){if(lcommunit
y_regexp_match(lcom,entry->reg))returnentry->direct==COMMUNITY_PERMIT?1:0;}}retu
rn0;}intecommunity_list_match(structecommunity*ecom,structcommunity_list*list){s
tructcommunity_entry*entry;for(entry=list->head;entry;entry=entry->next){if(entr
y->any)returnentry->direct==COMMUNITY_PERMIT?1:0;if(entry->style==EXTCOMMUNITY_L
IST_STANDARD){if(ecommunity_match(ecom,entry->u.ecom))returnentry->direct==COMMU
NITY_PERMIT?1:0;}elseif(entry->style==EXTCOMMUNITY_LIST_EXPANDED){if(ecommunity_
regexp_match(ecom,entry->reg))returnentry->direct==COMMUNITY_PERMIT?1:0;}}return
0;}/*Performexactmatching.Incaseofexpandedcommunity-list,dosamethingascommunity_
list_match().*/intcommunity_list_exact_match(structcommunity*com,structcommunity
_list*list){structcommunity_entry*entry;for(entry=list->head;entry;entry=entry->
next){if(entry->any)returnentry->direct==COMMUNITY_PERMIT?1:0;if(entry->style==C
OMMUNITY_LIST_STANDARD){if(community_include(entry->u.com,COMMUNITY_INTERNET))re
turnentry->direct==COMMUNITY_PERMIT?1:0;if(community_cmp(com,entry->u.com))retur
nentry->direct==COMMUNITY_PERMIT?1:0;}elseif(entry->style==COMMUNITY_LIST_EXPAND
ED){if(community_regexp_match(com,entry->reg))returnentry->direct==COMMUNITY_PER
MIT?1:0;}}return0;}/*Deleteallpermittedcommunitiesinthelistfromcom.*/structcommu
nity*community_list_match_delete(structcommunity*com,structcommunity_list*list){
structcommunity_entry*entry;uint32_tval;uint32_tcom_index_to_delete[com->size];i
ntdelete_index=0;inti;/*Loopovereachcommunityvalueandevaluateeachagainstthe*comm
unity-list.Ifweneedtodeleteacommunityvalueadditsindex*tocom_index_to_delete.*/fo
r(i=0;i<com->size;i++){val=community_val_get(com,i);for(entry=list->head;entry;e
ntry=entry->next){if(entry->any){if(entry->direct==COMMUNITY_PERMIT){com_index_t
o_delete[delete_index]=i;delete_index++;}break;}elseif((entry->style==COMMUNITY_
LIST_STANDARD)&&(community_include(entry->u.com,COMMUNITY_INTERNET)||community_i
nclude(entry->u.com,val))){if(entry->direct==COMMUNITY_PERMIT){com_index_to_dele
te[delete_index]=i;delete_index++;}break;}elseif((entry->style==COMMUNITY_LIST_E
XPANDED)&&community_regexp_include(entry->reg,com,i)){if(entry->direct==COMMUNIT
Y_PERMIT){com_index_to_delete[delete_index]=i;delete_index++;}break;}}}/*Deletea
llofthecommunitiesweflaggedfordeletion*/for(i=delete_index-1;i>=0;i--){val=commu
nity_val_get(com,com_index_to_delete[i]);community_del_val(com,&val);}returncom;
}/*Toavoidduplicatedentryinthecommunity-list,thisfunctioncomparesspecifiedentryt
oexistingentry.*/staticintcommunity_list_dup_check(structcommunity_list*list,str
uctcommunity_entry*new){structcommunity_entry*entry;for(entry=list->head;entry;e
ntry=entry->next){if(entry->style!=new->style)continue;if(entry->direct!=new->di
rect)continue;if(entry->any!=new->any)continue;if(entry->any)return1;switch(entr
y->style){caseCOMMUNITY_LIST_STANDARD:if(community_cmp(entry->u.com,new->u.com))
return1;break;caseLARGE_COMMUNITY_LIST_STANDARD:if(lcommunity_cmp(entry->u.lcom,
new->u.lcom))return1;break;caseEXTCOMMUNITY_LIST_STANDARD:if(ecommunity_cmp(entr
y->u.ecom,new->u.ecom))return1;break;caseCOMMUNITY_LIST_EXPANDED:caseEXTCOMMUNIT
Y_LIST_EXPANDED:caseLARGE_COMMUNITY_LIST_EXPANDED:if(strcmp(entry->config,new->c
onfig)==0)return1;break;default:break;}}return0;}/*Setcommunity-list.*/intcommun
ity_list_set(structcommunity_list_handler*ch,constchar*name,constchar*str,intdir
ect,intstyle){structcommunity_entry*entry=NULL;structcommunity_list*list;structc
ommunity*com=NULL;regex_t*regex=NULL;/*Getcommunitylist.*/list=community_list_ge
t(ch,name,COMMUNITY_LIST_MASTER);/*Whencommunity-listalreadyhasentry,newentrysho
uldhavesamestyle.Ifyouwanttohavemixedstylecommunity-list,youcancommentoutthische
ck.*/if(!community_list_empty_p(list)){structcommunity_entry*first;first=list->h
ead;if(style!=first->style){return(first->style==COMMUNITY_LIST_STANDARD?COMMUNI
TY_LIST_ERR_STANDARD_CONFLICT:COMMUNITY_LIST_ERR_EXPANDED_CONFLICT);}}if(str){if
(style==COMMUNITY_LIST_STANDARD)com=community_str2com(str);elseregex=bgp_regcomp
(str);if(!com&&!regex)returnCOMMUNITY_LIST_ERR_MALFORMED_VAL;}entry=community_en
try_new();entry->direct=direct;entry->style=style;entry->any=(str?0:1);entry->u.
com=com;entry->reg=regex;entry->config=(regex?XSTRDUP(MTYPE_COMMUNITY_LIST_CONFI
G,str):NULL);/*Donotputduplicatedcommunityentry.*/if(community_list_dup_check(li
st,entry))community_entry_free(entry);else{community_list_entry_add(list,entry);
route_map_notify_dependencies(name,RMAP_EVENT_CLIST_ADDED);}return0;}/*Unsetcomm
unity-list*/intcommunity_list_unset(structcommunity_list_handler*ch,constchar*na
me,constchar*str,intdirect,intstyle,intdelete_all){structcommunity_entry*entry=N
ULL;structcommunity_list*list;structcommunity*com=NULL;/*Lookupcommunitylist.*/l
ist=community_list_lookup(ch,name,COMMUNITY_LIST_MASTER);if(list==NULL)returnCOM
MUNITY_LIST_ERR_CANT_FIND_LIST;/*Deleteallofentrybelongstothiscommunity-list.*/i
f(delete_all){community_list_delete(list);route_map_notify_dependencies(name,RMA
P_EVENT_CLIST_DELETED);return0;}if(style==COMMUNITY_LIST_STANDARD){if(str)com=co
mmunity_str2com(str);}if(com){entry=community_list_entry_lookup(list,com,direct)
;community_free(com);}elseentry=community_list_entry_lookup(list,str,direct);if(
!entry)returnCOMMUNITY_LIST_ERR_CANT_FIND_LIST;community_list_entry_delete(list,
entry,style);route_map_notify_dependencies(name,RMAP_EVENT_CLIST_DELETED);return
0;}/*Deleteallpermittedlargecommunitiesinthelistfromcom.*/structlcommunity*lcomm
unity_list_match_delete(structlcommunity*lcom,structcommunity_list*list){structc
ommunity_entry*entry;uint32_tcom_index_to_delete[lcom->size];uint8_t*ptr;intdele
te_index=0;inti;/*Loopovereachlcommunityvalueandevaluateeachagainstthe*community
-list.Ifweneedtodeleteacommunityvalueadditsindex*tocom_index_to_delete.*/for(i=0
;i<lcom->size;i++){ptr=lcom->val+(i*LCOMMUNITY_SIZE);for(entry=list->head;entry;
entry=entry->next){if(entry->any){if(entry->direct==COMMUNITY_PERMIT){com_index_
to_delete[delete_index]=i;delete_index++;}break;}elseif((entry->style==LARGE_COM
MUNITY_LIST_STANDARD)&&lcommunity_include(entry->u.lcom,ptr)){if(entry->direct==
COMMUNITY_PERMIT){com_index_to_delete[delete_index]=i;delete_index++;}break;}els
eif((entry->style==LARGE_COMMUNITY_LIST_EXPANDED)&&lcommunity_regexp_include(ent
ry->reg,lcom,i)){if(entry->direct==COMMUNITY_PERMIT){com_index_to_delete[delete_
index]=i;delete_index++;}break;}}}/*Deleteallofthecommunitiesweflaggedfordeletio
n*/for(i=delete_index-1;i>=0;i--){ptr=lcom->val+(com_index_to_delete[i]*LCOMMUNI
TY_SIZE);lcommunity_del_val(lcom,ptr);}returnlcom;}/*Setlcommunity-list.*/intlco
mmunity_list_set(structcommunity_list_handler*ch,constchar*name,constchar*str,in
tdirect,intstyle){structcommunity_entry*entry=NULL;structcommunity_list*list;str
uctlcommunity*lcom=NULL;regex_t*regex=NULL;/*Getcommunitylist.*/list=community_l
ist_get(ch,name,LARGE_COMMUNITY_LIST_MASTER);/*Whencommunity-listalreadyhasentry
,newentryshouldhavesamestyle.Ifyouwanttohavemixedstylecommunity-list,youcancomme
ntoutthischeck.*/if(!community_list_empty_p(list)){structcommunity_entry*first;f
irst=list->head;if(style!=first->style){return(first->style==COMMUNITY_LIST_STAN
DARD?COMMUNITY_LIST_ERR_STANDARD_CONFLICT:COMMUNITY_LIST_ERR_EXPANDED_CONFLICT);
}}if(str){if(style==LARGE_COMMUNITY_LIST_STANDARD)lcom=lcommunity_str2com(str);e
lseregex=bgp_regcomp(str);if(!lcom&&!regex)returnCOMMUNITY_LIST_ERR_MALFORMED_VA
L;}entry=community_entry_new();entry->direct=direct;entry->style=style;entry->an
y=(str?0:1);entry->u.lcom=lcom;entry->reg=regex;if(lcom)entry->config=lcommunity
_lcom2str(lcom,LCOMMUNITY_FORMAT_COMMUNITY_LIST);elseif(regex)entry->config=XSTR
DUP(MTYPE_COMMUNITY_LIST_CONFIG,str);elseentry->config=NULL;/*Donotputduplicated
communityentry.*/if(community_list_dup_check(list,entry))community_entry_free(en
try);elsecommunity_list_entry_add(list,entry);return0;}/*Unsetcommunity-list.Whe
nstrisNULL,deleteallofcommunity-listentrybelongstothespecifiedname.*/intlcommuni
ty_list_unset(structcommunity_list_handler*ch,constchar*name,constchar*str,intdi
rect,intstyle){structcommunity_entry*entry=NULL;structcommunity_list*list;struct
lcommunity*lcom=NULL;regex_t*regex=NULL;/*Lookupcommunitylist.*/list=community_l
ist_lookup(ch,name,LARGE_COMMUNITY_LIST_MASTER);if(list==NULL)returnCOMMUNITY_LI
ST_ERR_CANT_FIND_LIST;/*Deleteallofentrybelongstothiscommunity-list.*/if(!str){c
ommunity_list_delete(list);return0;}if(style==LARGE_COMMUNITY_LIST_STANDARD)lcom
=lcommunity_str2com(str);elseregex=bgp_regcomp(str);if(!lcom&&!regex)returnCOMMU
NITY_LIST_ERR_MALFORMED_VAL;if(lcom)entry=community_list_entry_lookup(list,lcom,
direct);elseentry=community_list_entry_lookup(list,str,direct);if(lcom)lcommunit
y_free(&lcom);if(regex)bgp_regex_free(regex);if(!entry)returnCOMMUNITY_LIST_ERR_
CANT_FIND_LIST;community_list_entry_delete(list,entry,style);return0;}/*Setextco
mmunity-list.*/intextcommunity_list_set(structcommunity_list_handler*ch,constcha
r*name,constchar*str,intdirect,intstyle){structcommunity_entry*entry=NULL;struct
community_list*list;structecommunity*ecom=NULL;regex_t*regex=NULL;entry=NULL;/*G
etcommunitylist.*/list=community_list_get(ch,name,EXTCOMMUNITY_LIST_MASTER);/*Wh
encommunity-listalreadyhasentry,newentryshouldhavesamestyle.Ifyouwanttohavemixed
stylecommunity-list,youcancommentoutthischeck.*/if(!community_list_empty_p(list)
){structcommunity_entry*first;first=list->head;if(style!=first->style){return(fi
rst->style==EXTCOMMUNITY_LIST_STANDARD?COMMUNITY_LIST_ERR_STANDARD_CONFLICT:COMM
UNITY_LIST_ERR_EXPANDED_CONFLICT);}}if(style==EXTCOMMUNITY_LIST_STANDARD)ecom=ec
ommunity_str2com(str,0,1);elseregex=bgp_regcomp(str);if(!ecom&&!regex)returnCOMM
UNITY_LIST_ERR_MALFORMED_VAL;if(ecom)ecom->str=ecommunity_ecom2str(ecom,ECOMMUNI
TY_FORMAT_DISPLAY,0);entry=community_entry_new();entry->direct=direct;entry->sty
le=style;entry->any=(str?0:1);if(ecom)entry->config=ecommunity_ecom2str(ecom,ECO
MMUNITY_FORMAT_COMMUNITY_LIST,0);elseif(regex)entry->config=XSTRDUP(MTYPE_COMMUN
ITY_LIST_CONFIG,str);entry->u.ecom=ecom;entry->reg=regex;/*Donotputduplicatedcom
munityentry.*/if(community_list_dup_check(list,entry))community_entry_free(entry
);else{community_list_entry_add(list,entry);route_map_notify_dependencies(name,R
MAP_EVENT_ECLIST_ADDED);}return0;}/*Unsetextcommunity-list.WhenstrisNULL,deletea
llofextcommunity-listentrybelongstothespecifiedname.*/intextcommunity_list_unset
(structcommunity_list_handler*ch,constchar*name,constchar*str,intdirect,intstyle
,intdelete_all){structcommunity_entry*entry=NULL;structcommunity_list*list;struc
tecommunity*ecom=NULL;/*Lookupextcommunitylist.*/list=community_list_lookup(ch,n
ame,EXTCOMMUNITY_LIST_MASTER);if(list==NULL)returnCOMMUNITY_LIST_ERR_CANT_FIND_L
IST;/*Deleteallofentrybelongstothisextcommunity-list.*/if(delete_all){community_
list_delete(list);route_map_notify_dependencies(name,RMAP_EVENT_ECLIST_DELETED);
return0;}if(style==EXTCOMMUNITY_LIST_STANDARD){if(str)ecom=ecommunity_str2com(st
r,0,1);}if(ecom){entry=community_list_entry_lookup(list,ecom,direct);ecommunity_
free(&ecom);}elseentry=community_list_entry_lookup(list,str,direct);if(!entry)re
turnCOMMUNITY_LIST_ERR_CANT_FIND_LIST;community_list_entry_delete(list,entry,sty
le);route_map_notify_dependencies(name,RMAP_EVENT_ECLIST_DELETED);return0;}/*Ini
tializacommunity-list.Returncommunity-listhandler.*/structcommunity_list_handler
*community_list_init(void){structcommunity_list_handler*ch;ch=XCALLOC(MTYPE_COMM
UNITY_LIST_HANDLER,sizeof(structcommunity_list_handler));returnch;}/*Terminateco
mmunity-list.*/voidcommunity_list_terminate(structcommunity_list_handler*ch){str
uctcommunity_list_master*cm;structcommunity_list*list;cm=&ch->community_list;whi
le((list=cm->num.head)!=NULL)community_list_delete(list);while((list=cm->str.hea
d)!=NULL)community_list_delete(list);cm=&ch->lcommunity_list;while((list=cm->num
.head)!=NULL)community_list_delete(list);while((list=cm->str.head)!=NULL)communi
ty_list_delete(list);cm=&ch->extcommunity_list;while((list=cm->num.head)!=NULL)c
ommunity_list_delete(list);while((list=cm->str.head)!=NULL)community_list_delete
(list);XFREE(MTYPE_COMMUNITY_LIST_HANDLER,ch);}