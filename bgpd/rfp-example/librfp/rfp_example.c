/***Copyright2015-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*
stubrfp*/#include"rfp_internal.h"#include"bgpd/rfapi/rfapi.h"#include"lib/comman
d.h"structrfp_instance_t{structrfapi_rfp_cfgrfapi_config;structrfapi_rfp_cb_meth
odsrfapi_callbacks;structthread_master*master;uint32_tconfig_var;};structrfp_ins
tance_tglobal_rfi;/*dynamicallyallocateinfullimplementation*//******************
******************************************************SampleVTY/internalfunction
**********************************************************************/#defineRF
P_SHOW_STR"RFPinformation\n"DEFUN(rfp_example_config_value,rfp_example_config_va
lue_cmd,"rfpexample-config-valueVALUE",RFP_SHOW_STR"Examplevaluetobeconfigured\n
""Valuetodisplay\n"){uint32_tvalue=0;structrfp_instance_t*rfi=NULL;rfi=rfapi_get
_rfp_start_val(VTY_GET_CONTEXT(bgp));/*BGP_NODE*/assert(rfi!=NULL);value=strtoul
(argv[2]->arg,NULL,10);if(rfi)rfi->config_var=value;returnCMD_SUCCESS;}staticvoi
drfp_vty_install(){staticintinstalled=0;if(installed)/*dothisonlyonce*/return;in
stalled=1;/*exampleofnewclicommand*/install_element(BGP_NODE,&rfp_example_config
_value_cmd);}/******************************************************************
******RFAPICallbacks************************************************************
**********//*------------------------------------------*rfp_response_cb**Callbac
ksofthistypeareusedtoprovideasynchronous*routeupdatesfromRFAPItotheRFPclient.**r
esponse_cb*calledtonotifytherfpclientthatanexthoplist*thathaspreviouslybeenprovi
dedinresponsetoan*rfapi_querycallhasbeenupdated.Deletedroutesareindicated*withli
fetime==RFAPI_REMOVE_RESPONSE_LIFETIME.**Bydefault,theroutesanNVEreceivesviathis
callbackinclude*itsownroutes(thatithasregistered).However,thesemaybe*filteredout
iftheglobalBGP_VNC_CONFIG_FILTER_SELF_FROM_RSP*flagisset.**input:*next_hopsalist
ofpossiblenexthops.*Thisisalinkedlistallocatedwithinthe*rfapi.Theresponse_cbcall
backfunctionisresponsible*forfreeingthismemoryviarfapi_free_next_hop_list()*inor
dertoavoidmemoryleaks.**userdatavalue(cookie)originallyspecifiedincallto*rfapi_o
pen()**------------------------------------------*/staticvoidrfp_response_cb(str
uctrfapi_next_hop_entry*next_hops,void*userdata){/**IdentifyNVEbasedonuserdata,w
hichisavaluepassed*toRFAPIintherfapi_opencall*//*processlistofnext_hops*//*freen
exthops*/rfapi_free_next_hop_list(next_hops);return;}/*-------------------------
-----------------*rfp_local_cb**Callbacksofthistypeareusedtoprovideasynchronous*
routeupdatesfromRFAPItotheRFPclient.**local_cb*calledtonotifytherfpclientthatalo
calroute*hasbeenaddedordeleted.Deletedroutesareindicated*withlifetime==RFAPI_REM
OVE_RESPONSE_LIFETIME.**input:*next_hopsalistofpossiblenexthops.*Thisisalinkedli
stallocatedwithinthe*rfapi.Thelocal_cbcallbackfunctionisresponsible*forfreeingth
ismemoryviarfapi_free_next_hop_list()*inordertoavoidmemoryleaks.**userdatavalue(
cookie)originallyspecifiedincallto*rfapi_open()**-------------------------------
-----------*/staticvoidrfp_local_cb(structrfapi_next_hop_entry*next_hops,void*us
erdata){/**IdentifyNVEbasedonuserdata,whichisavaluepassed*toRFAPIintherfapi_open
call*//*processlistoflocalnext_hops*//*freenexthops*/rfapi_free_next_hop_list(ne
xt_hops);return;}/*------------------------------------------*rfp_close_cb**Call
backsusedtoprovideasynchronous*notificationthatanrfapi_handlewasinvalidated**inp
ut:*pHandleFirmerlyvalidrfapi_handlereturnedto*clientviarfapi_open().**reasonEID
RMhandleadministrativelyclosed(clearnve...)*ESTALEhandleinvalidatedbyconfigurati
onchange**------------------------------------------*/staticvoidrfp_close_cb(rfa
pi_handlepHandle,intreason){/*close/invalidateNVEwiththepHandlereturnedbytherfap
i_open*call*/return;}/*------------------------------------------*rfp_cfg_write_
cb**Thiscallbackisusedtogenerateoutputforanyconfigparameters*thatmaysupportedbyR
FPviaRFPdefinedvtycommandsatthebgp*level.Seeloglevelasanexample.**input:*vty--qu
aggavtycontext*rfp_start_val--valuereturnedbyrfp_start**output:*tovty,rfprelated
configuration**returnvalue:*lineswritten----------------------------------------
----*/staticintrfp_cfg_write_cb(structvty*vty,void*rfp_start_val){structrfp_inst
ance_t*rfi=rfp_start_val;intwrite=0;assert(rfp_start_val!=NULL);if(rfi->config_v
ar!=0){vty_out(vty,"rfpexample-config-value%u",rfi->config_var);vty_out(vty,"\n"
);write++;}returnwrite;}/*******************************************************
*****************RFAPIrequiredfunctions*****************************************
*****************************//*------------------------------------------*rfp_s
tart**ThisfunctionwillstarttheRFPcode**input:*masterquaggathread_mastertotieinto
bgpdthreads**output:*cfgpPointertorfapi_rfp_cfg(null=usedefaults),*copiedbycalle
r,updatedviarfp_set_configuration*cbmpPointertorfapi_rfp_cb_methods,maybenull*co
piedbycaller,updatedviarfapi_rfp_set_cb_methods**returnvalue:*rfp_start_valrfpre
turnedvaluepassedonrfp_stopandrfp_cfg_write*------------------------------------
--------*/void*rfp_start(structthread_master*master,structrfapi_rfp_cfg**cfgp,st
ructrfapi_rfp_cb_methods**cbmp){memset(&global_rfi,0,sizeof(structrfp_instance_t
));global_rfi.master=master;/*forBGPDthreads*//*initilizestructrfapi_rfp_cfg,see
rfapi.h*/global_rfi.rfapi_config.download_type=RFAPI_RFP_DOWNLOAD_FULL;/*default
=partial*/global_rfi.rfapi_config.ftd_advertisement_interval=RFAPI_RFP_CFG_DEFAU
LT_FTD_ADVERTISEMENT_INTERVAL;global_rfi.rfapi_config.holddown_factor=0;/*defaul
t:RFAPI_RFP_CFG_DEFAULT_HOLDDOWN_FACTOR*/global_rfi.rfapi_config.use_updated_res
ponse=1;/*0=no*/global_rfi.rfapi_config.use_removes=1;/*0=no*//*initilizestructr
fapi_rfp_cb_methods,seerfapi.h*/global_rfi.rfapi_callbacks.cfg_cb=rfp_cfg_write_
cb;/*nogroupconfig*/global_rfi.rfapi_callbacks.response_cb=rfp_response_cb;globa
l_rfi.rfapi_callbacks.local_cb=rfp_local_cb;global_rfi.rfapi_callbacks.close_cb=
rfp_close_cb;if(cfgp!=NULL)*cfgp=&global_rfi.rfapi_config;if(cbmp!=NULL)*cbmp=&g
lobal_rfi.rfapi_callbacks;rfp_vty_install();return&global_rfi;}/*---------------
---------------------------*rfp_stop**ThisfunctioniscalledonshutdowntotriggerRFP
cleanup**input:*none**output:*none**returnvalue:*rfp_start_val------------------
--------------------------*/voidrfp_stop(void*rfp_start_val){assert(rfp_start_va
l!=NULL);}/*TOBEREMOVED*/voidrfp_clear_vnc_nve_all(void){return;}