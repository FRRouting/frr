/*BGPFlowSpecforpackethandling*Portions:*Copyright(C)2017ChinaTelecomSDNGroup*Co
pyright(C)20186WIND**FRRoutingisfreesoftware;youcanredistributeitand/ormodifyit*
underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation
;eitherversion2,or(atyouroption)any*laterversion.**FRRoutingisdistributedintheho
pethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERC
HANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformored
etails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispro
gram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt
,FifthFloor,Boston,MA02110-1301USA*/#include"math.h"#include<zebra.h>#include"pr
efix.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_flowspec
.h"#include"bgpd/bgp_flowspec_util.h"#include"bgpd/bgp_flowspec_private.h"#inclu
de"bgpd/bgp_ecommunity.h"#include"bgpd/bgp_debug.h"staticintbgp_fs_nlri_validate
(uint8_t*nlri_content,uint32_tlen){uint32_toffset=0;inttype;intret=0,error=0;whi
le(offset<len-1){type=nlri_content[offset];offset++;switch(type){caseFLOWSPEC_DE
ST_PREFIX:caseFLOWSPEC_SRC_PREFIX:ret=bgp_flowspec_ip_address(BGP_FLOWSPEC_VALID
ATE_ONLY,nlri_content+offset,len-offset,NULL,&error);break;caseFLOWSPEC_IP_PROTO
COL:caseFLOWSPEC_PORT:caseFLOWSPEC_DEST_PORT:caseFLOWSPEC_SRC_PORT:caseFLOWSPEC_
ICMP_TYPE:caseFLOWSPEC_ICMP_CODE:ret=bgp_flowspec_op_decode(BGP_FLOWSPEC_VALIDAT
E_ONLY,nlri_content+offset,len-offset,NULL,&error);break;caseFLOWSPEC_TCP_FLAGS:
ret=bgp_flowspec_tcpflags_decode(BGP_FLOWSPEC_VALIDATE_ONLY,nlri_content+offset,
len-offset,NULL,&error);break;caseFLOWSPEC_PKT_LEN:caseFLOWSPEC_DSCP:ret=bgp_flo
wspec_op_decode(BGP_FLOWSPEC_VALIDATE_ONLY,nlri_content+offset,len-offset,NULL,&
error);break;caseFLOWSPEC_FRAGMENT:ret=bgp_flowspec_fragment_type_decode(BGP_FLO
WSPEC_VALIDATE_ONLY,nlri_content+offset,len-offset,NULL,&error);break;default:er
ror=-1;break;}offset+=ret;if(error<0)break;}returnerror;}intbgp_nlri_parse_flows
pec(structpeer*peer,structattr*attr,structbgp_nlri*packet,intwithdraw){uint8_t*p
nt;uint8_t*lim;afi_tafi;safi_tsafi;intpsize=0;uint8_trlen;structprefixp;intret;v
oid*temp;/*StartprocessingtheNLRI-theremaybemultipleintheMP_REACH*/pnt=packet->n
lri;lim=pnt+packet->length;afi=packet->afi;safi=packet->safi;if(afi==AFI_IP6){zl
og_err("BGPflowspecIPv6notsupported");return-1;}if(packet->length>=FLOWSPEC_NLRI
_SIZELIMIT){zlog_err("BGPflowspecnlrilengthmaximumreached(%u)",packet->length);r
eturn-1;}for(;pnt<lim;pnt+=psize){/*Clearprefixstructure.*/memset(&p,0,sizeof(st
ructprefix));/*AllFlowSpecNLRIbeginwithlength.*/if(pnt+1>lim)return-1;psize=rlen
=*pnt++;/*Whenpacketoverflowoccurreturnimmediately.*/if(pnt+psize>lim){zlog_err(
"FlowspecNLRIlengthinconsistent(size%useen)",psize);return-1;}if(bgp_fs_nlri_val
idate(pnt,psize)<0){zlog_err("BadflowspecformatorNLRIoptionsnotsupported");retur
n-1;}p.family=AF_FLOWSPEC;p.prefixlen=0;/*Flowspecencodingisinbytes*/p.u.prefix_
flowspec.prefixlen=psize;temp=XCALLOC(MTYPE_TMP,psize);memcpy(temp,pnt,psize);p.
u.prefix_flowspec.ptr=(uintptr_t)temp;if(BGP_DEBUG(flowspec,FLOWSPEC)){charretur
n_string[BGP_FLOWSPEC_NLRI_STRING_MAX];charlocal_string[BGP_FLOWSPEC_NLRI_STRING
_MAX];charec_string[BGP_FLOWSPEC_NLRI_STRING_MAX];char*s=NULL;bgp_fs_nlri_get_st
ring((unsignedchar*)p.u.prefix_flowspec.ptr,p.u.prefix_flowspec.prefixlen,return
_string,NLRI_STRING_FORMAT_MIN,NULL);snprintf(ec_string,BGP_FLOWSPEC_NLRI_STRING
_MAX,"EC{none}");if(attr&&attr->ecommunity){s=ecommunity_ecom2str(attr->ecommuni
ty,ECOMMUNITY_FORMAT_ROUTE_MAP,0);snprintf(ec_string,BGP_FLOWSPEC_NLRI_STRING_MA
X,"EC{%s}",s==NULL?"none":s);}snprintf(local_string,BGP_FLOWSPEC_NLRI_STRING_MAX
,"FSRx%s%s%s%s",withdraw?"Withdraw":"Update",afi2str(afi),return_string,attr!=NU
LL?ec_string:"");zlog_info("%s",local_string);}/*Processtheroute.*/if(!withdraw)
ret=bgp_update(peer,&p,0,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,NULL,NUL
L,0,0,NULL);elseret=bgp_withdraw(peer,&p,0,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROU
TE_NORMAL,NULL,NULL,0,NULL);if(ret){zlog_err("FlowspecNLRIfailedtobe%s.",attr?"a
dded":"withdrawn");return-1;}}return0;}