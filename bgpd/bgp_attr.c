/*BGPattributesmanagementroutines.*Copyright(C)1996,97,98,1999KunihiroIshiguro**
ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodi
fyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFound
ation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedint
hehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*
MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseform
oredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthi
sprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Frankl
inSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"linklist.h"#in
clude"prefix.h"#include"memory.h"#include"vector.h"#include"stream.h"#include"lo
g.h"#include"hash.h"#include"jhash.h"#include"queue.h"#include"table.h"#include"
filter.h"#include"command.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_attr.h"#inclu
de"bgpd/bgp_route.h"#include"bgpd/bgp_aspath.h"#include"bgpd/bgp_community.h"#in
clude"bgpd/bgp_debug.h"#include"bgpd/bgp_label.h"#include"bgpd/bgp_packet.h"#inc
lude"bgpd/bgp_ecommunity.h"#include"bgpd/bgp_lcommunity.h"#include"bgpd/bgp_updg
rp.h"#include"bgpd/bgp_encap_types.h"#ifENABLE_BGP_VNC#include"bgpd/rfapi/bgp_rf
api_cfg.h"#include"bgp_encap_types.h"#include"bgp_vnc_types.h"#endif#include"bgp
_encap_types.h"#include"bgp_evpn.h"#include"bgp_flowspec_private.h"/*Attributest
ringsforlogging.*/staticconststructmessageattr_str[]={{BGP_ATTR_ORIGIN,"ORIGIN"}
,{BGP_ATTR_AS_PATH,"AS_PATH"},{BGP_ATTR_NEXT_HOP,"NEXT_HOP"},{BGP_ATTR_MULTI_EXI
T_DISC,"MULTI_EXIT_DISC"},{BGP_ATTR_LOCAL_PREF,"LOCAL_PREF"},{BGP_ATTR_ATOMIC_AG
GREGATE,"ATOMIC_AGGREGATE"},{BGP_ATTR_AGGREGATOR,"AGGREGATOR"},{BGP_ATTR_COMMUNI
TIES,"COMMUNITY"},{BGP_ATTR_ORIGINATOR_ID,"ORIGINATOR_ID"},{BGP_ATTR_CLUSTER_LIS
T,"CLUSTER_LIST"},{BGP_ATTR_DPA,"DPA"},{BGP_ATTR_ADVERTISER,"ADVERTISER"},{BGP_A
TTR_RCID_PATH,"RCID_PATH"},{BGP_ATTR_MP_REACH_NLRI,"MP_REACH_NLRI"},{BGP_ATTR_MP
_UNREACH_NLRI,"MP_UNREACH_NLRI"},{BGP_ATTR_EXT_COMMUNITIES,"EXT_COMMUNITIES"},{B
GP_ATTR_AS4_PATH,"AS4_PATH"},{BGP_ATTR_AS4_AGGREGATOR,"AS4_AGGREGATOR"},{BGP_ATT
R_AS_PATHLIMIT,"AS_PATHLIMIT"},{BGP_ATTR_PMSI_TUNNEL,"PMSI_TUNNEL_ATTRIBUTE"},{B
GP_ATTR_ENCAP,"ENCAP"},#ifENABLE_BGP_VNC{BGP_ATTR_VNC,"VNC"},#endif{BGP_ATTR_LAR
GE_COMMUNITIES,"LARGE_COMMUNITY"},{BGP_ATTR_PREFIX_SID,"PREFIX_SID"},{0}};static
conststructmessageattr_flag_str[]={{BGP_ATTR_FLAG_OPTIONAL,"Optional"},{BGP_ATTR
_FLAG_TRANS,"Transitive"},{BGP_ATTR_FLAG_PARTIAL,"Partial"},/*bgp_attr_flags_dia
gnose()reliesonthisbitbeinglastinthislist*/{BGP_ATTR_FLAG_EXTLEN,"ExtendedLength
"},{0}};staticstructhash*cluster_hash;staticvoid*cluster_hash_alloc(void*p){cons
tstructcluster_list*val=(conststructcluster_list*)p;structcluster_list*cluster;c
luster=XMALLOC(MTYPE_CLUSTER,sizeof(structcluster_list));cluster->length=val->le
ngth;if(cluster->length){cluster->list=XMALLOC(MTYPE_CLUSTER_VAL,val->length);me
mcpy(cluster->list,val->list,val->length);}elsecluster->list=NULL;cluster->refcn
t=0;returncluster;}/*Clusterlistrelatedfunctions.*/staticstructcluster_list*clus
ter_parse(structin_addr*pnt,intlength){structcluster_listtmp;structcluster_list*
cluster;tmp.length=length;tmp.list=pnt;cluster=hash_get(cluster_hash,&tmp,cluste
r_hash_alloc);cluster->refcnt++;returncluster;}intcluster_loop_check(structclust
er_list*cluster,structin_addroriginator){inti;for(i=0;i<cluster->length/4;i++)if
(cluster->list[i].s_addr==originator.s_addr)return1;return0;}staticunsignedintcl
uster_hash_key_make(void*p){conststructcluster_list*cluster=p;returnjhash(cluste
r->list,cluster->length,0);}staticintcluster_hash_cmp(constvoid*p1,constvoid*p2)
{conststructcluster_list*cluster1=p1;conststructcluster_list*cluster2=p2;return(
cluster1->length==cluster2->length&&memcmp(cluster1->list,cluster2->list,cluster
1->length)==0);}staticvoidcluster_free(structcluster_list*cluster){if(cluster->l
ist)XFREE(MTYPE_CLUSTER_VAL,cluster->list);XFREE(MTYPE_CLUSTER,cluster);}statics
tructcluster_list*cluster_intern(structcluster_list*cluster){structcluster_list*
find;find=hash_get(cluster_hash,cluster,cluster_hash_alloc);find->refcnt++;retur
nfind;}voidcluster_unintern(structcluster_list*cluster){if(cluster->refcnt)clust
er->refcnt--;if(cluster->refcnt==0){hash_release(cluster_hash,cluster);cluster_f
ree(cluster);}}staticvoidcluster_init(void){cluster_hash=hash_create(cluster_has
h_key_make,cluster_hash_cmp,"BGPCluster");}staticvoidcluster_finish(void){hash_c
lean(cluster_hash,(void(*)(void*))cluster_free);hash_free(cluster_hash);cluster_
hash=NULL;}staticstructhash*encap_hash=NULL;#ifENABLE_BGP_VNCstaticstructhash*vn
c_hash=NULL;#endifstructbgp_attr_encap_subtlv*encap_tlv_dup(structbgp_attr_encap
_subtlv*orig){structbgp_attr_encap_subtlv*new;structbgp_attr_encap_subtlv*tail;s
tructbgp_attr_encap_subtlv*p;for(p=orig,tail=new=NULL;p;p=p->next){intsize=sizeo
f(structbgp_attr_encap_subtlv)+p->length;if(tail){tail->next=XCALLOC(MTYPE_ENCAP
_TLV,size);tail=tail->next;}else{tail=new=XCALLOC(MTYPE_ENCAP_TLV,size);}assert(
tail);memcpy(tail,p,size);tail->next=NULL;}returnnew;}staticvoidencap_free(struc
tbgp_attr_encap_subtlv*p){structbgp_attr_encap_subtlv*next;while(p){next=p->next
;p->next=NULL;XFREE(MTYPE_ENCAP_TLV,p);p=next;}}voidbgp_attr_flush_encap(structa
ttr*attr){if(!attr)return;if(attr->encap_subtlvs){encap_free(attr->encap_subtlvs
);attr->encap_subtlvs=NULL;}#ifENABLE_BGP_VNCif(attr->vnc_subtlvs){encap_free(at
tr->vnc_subtlvs);attr->vnc_subtlvs=NULL;}#endif}/**Compareencapsub-tlvchains**1=
equivalent*0=notequivalent**Thisalgorithmcouldbemadefasterifneeded*/staticintenc
ap_same(structbgp_attr_encap_subtlv*h1,structbgp_attr_encap_subtlv*h2){structbgp
_attr_encap_subtlv*p;structbgp_attr_encap_subtlv*q;if(h1==h2)return1;if(h1==NULL
||h2==NULL)return0;for(p=h1;p;p=p->next){for(q=h2;q;q=q->next){if((p->type==q->t
ype)&&(p->length==q->length)&&!memcmp(p->value,q->value,p->length)){break;}}if(!
q)return0;}for(p=h2;p;p=p->next){for(q=h1;q;q=q->next){if((p->type==q->type)&&(p
->length==q->length)&&!memcmp(p->value,q->value,p->length)){break;}}if(!q)return
0;}return1;}staticvoid*encap_hash_alloc(void*p){/*Encapstructureisalreadyallocat
ed.*/returnp;}typedefenum{ENCAP_SUBTLV_TYPE,#ifENABLE_BGP_VNCVNC_SUBTLV_TYPE#end
if}encap_subtlv_type;staticstructbgp_attr_encap_subtlv*encap_intern(structbgp_at
tr_encap_subtlv*encap,encap_subtlv_typetype){structbgp_attr_encap_subtlv*find;st
ructhash*hash=encap_hash;#ifENABLE_BGP_VNCif(type==VNC_SUBTLV_TYPE)hash=vnc_hash
;#endiffind=hash_get(hash,encap,encap_hash_alloc);if(find!=encap)encap_free(enca
p);find->refcnt++;returnfind;}staticvoidencap_unintern(structbgp_attr_encap_subt
lv**encapp,encap_subtlv_typetype){structbgp_attr_encap_subtlv*encap=*encapp;if(e
ncap->refcnt)encap->refcnt--;if(encap->refcnt==0){structhash*hash=encap_hash;#if
ENABLE_BGP_VNCif(type==VNC_SUBTLV_TYPE)hash=vnc_hash;#endifhash_release(hash,enc
ap);encap_free(encap);*encapp=NULL;}}staticunsignedintencap_hash_key_make(void*p
){conststructbgp_attr_encap_subtlv*encap=p;returnjhash(encap->value,encap->lengt
h,0);}staticintencap_hash_cmp(constvoid*p1,constvoid*p2){returnencap_same((struc
tbgp_attr_encap_subtlv*)p1,(structbgp_attr_encap_subtlv*)p2);}staticvoidencap_in
it(void){encap_hash=hash_create(encap_hash_key_make,encap_hash_cmp,"BGPEncapHash
");#ifENABLE_BGP_VNCvnc_hash=hash_create(encap_hash_key_make,encap_hash_cmp,"BGP
VNCHash");#endif}staticvoidencap_finish(void){hash_clean(encap_hash,(void(*)(voi
d*))encap_free);hash_free(encap_hash);encap_hash=NULL;#ifENABLE_BGP_VNChash_clea
n(vnc_hash,(void(*)(void*))encap_free);hash_free(vnc_hash);vnc_hash=NULL;#endif}
staticbooloverlay_index_same(conststructattr*a1,conststructattr*a2){if(!a1&&a2)r
eturnfalse;if(!a2&&a1)returnfalse;if(!a1&&!a2)returntrue;return!memcmp(&(a1->evp
n_overlay),&(a2->evpn_overlay),sizeof(structoverlay_index));}/*Unknowntransitatt
ribute.*/staticstructhash*transit_hash;staticvoidtransit_free(structtransit*tran
sit){if(transit->val)XFREE(MTYPE_TRANSIT_VAL,transit->val);XFREE(MTYPE_TRANSIT,t
ransit);}staticvoid*transit_hash_alloc(void*p){/*Transitstructureisalreadyalloca
ted.*/returnp;}staticstructtransit*transit_intern(structtransit*transit){structt
ransit*find;find=hash_get(transit_hash,transit,transit_hash_alloc);if(find!=tran
sit)transit_free(transit);find->refcnt++;returnfind;}voidtransit_unintern(struct
transit*transit){if(transit->refcnt)transit->refcnt--;if(transit->refcnt==0){has
h_release(transit_hash,transit);transit_free(transit);}}staticunsignedinttransit
_hash_key_make(void*p){conststructtransit*transit=p;returnjhash(transit->val,tra
nsit->length,0);}staticinttransit_hash_cmp(constvoid*p1,constvoid*p2){conststruc
ttransit*transit1=p1;conststructtransit*transit2=p2;return(transit1->length==tra
nsit2->length&&memcmp(transit1->val,transit2->val,transit1->length)==0);}staticv
oidtransit_init(void){transit_hash=hash_create(transit_hash_key_make,transit_has
h_cmp,"BGPTransitHash");}staticvoidtransit_finish(void){hash_clean(transit_hash,
(void(*)(void*))transit_free);hash_free(transit_hash);transit_hash=NULL;}/*Attri
butehashroutines.*/staticstructhash*attrhash;/*Shallowcopyofanattribute*Though,n
otsoshallowthatitdoesn'tcopythecontents*oftheattr_extrapointedtoby'extra'*/voidb
gp_attr_dup(structattr*new,structattr*orig){*new=*orig;}unsignedlongintattr_coun
t(void){returnattrhash->count;}unsignedlongintattr_unknown_count(void){returntra
nsit_hash->count;}unsignedintattrhash_key_make(void*p){conststructattr*attr=(str
uctattr*)p;uint32_tkey=0;#defineMIX(val)key=jhash_1word(val,key)#defineMIX3(a,b,
c)key=jhash_3words((a),(b),(c),key)MIX3(attr->origin,attr->nexthop.s_addr,attr->
med);MIX3(attr->local_pref,attr->aggregator_as,attr->aggregator_addr.s_addr);MIX
3(attr->weight,attr->mp_nexthop_global_in.s_addr,attr->originator_id.s_addr);MIX
3(attr->tag,attr->label,attr->label_index);if(attr->aspath)MIX(aspath_key_make(a
ttr->aspath));if(attr->community)MIX(community_hash_make(attr->community));if(at
tr->lcommunity)MIX(lcommunity_hash_make(attr->lcommunity));if(attr->ecommunity)M
IX(ecommunity_hash_make(attr->ecommunity));if(attr->cluster)MIX(cluster_hash_key
_make(attr->cluster));if(attr->transit)MIX(transit_hash_key_make(attr->transit))
;if(attr->encap_subtlvs)MIX(encap_hash_key_make(attr->encap_subtlvs));#ifENABLE_
BGP_VNCif(attr->vnc_subtlvs)MIX(encap_hash_key_make(attr->vnc_subtlvs));#endifMI
X(attr->mp_nexthop_len);key=jhash(attr->mp_nexthop_global.s6_addr,IPV6_MAX_BYTEL
EN,key);key=jhash(attr->mp_nexthop_local.s6_addr,IPV6_MAX_BYTELEN,key);returnkey
;}intattrhash_cmp(constvoid*p1,constvoid*p2){conststructattr*attr1=p1;conststruc
tattr*attr2=p2;if(attr1->flag==attr2->flag&&attr1->origin==attr2->origin&&attr1-
>nexthop.s_addr==attr2->nexthop.s_addr&&attr1->aspath==attr2->aspath&&attr1->com
munity==attr2->community&&attr1->med==attr2->med&&attr1->local_pref==attr2->loca
l_pref&&attr1->rmap_change_flags==attr2->rmap_change_flags){if(attr1->aggregator
_as==attr2->aggregator_as&&attr1->aggregator_addr.s_addr==attr2->aggregator_addr
.s_addr&&attr1->weight==attr2->weight&&attr1->tag==attr2->tag&&attr1->label_inde
x==attr2->label_index&&attr1->mp_nexthop_len==attr2->mp_nexthop_len&&attr1->ecom
munity==attr2->ecommunity&&attr1->lcommunity==attr2->lcommunity&&attr1->cluster=
=attr2->cluster&&attr1->transit==attr2->transit&&(attr1->encap_tunneltype==attr2
->encap_tunneltype)&&encap_same(attr1->encap_subtlvs,attr2->encap_subtlvs)#ifENA
BLE_BGP_VNC&&encap_same(attr1->vnc_subtlvs,attr2->vnc_subtlvs)#endif&&IPV6_ADDR_
SAME(&attr1->mp_nexthop_global,&attr2->mp_nexthop_global)&&IPV6_ADDR_SAME(&attr1
->mp_nexthop_local,&attr2->mp_nexthop_local)&&IPV4_ADDR_SAME(&attr1->mp_nexthop_
global_in,&attr2->mp_nexthop_global_in)&&IPV4_ADDR_SAME(&attr1->originator_id,&a
ttr2->originator_id)&&overlay_index_same(attr1,attr2))return1;}return0;}staticvo
idattrhash_init(void){attrhash=hash_create(attrhash_key_make,attrhash_cmp,"BGPAt
tributes");}/**specialforhash_cleanbelow*/staticvoidattr_vfree(void*attr){XFREE(
MTYPE_ATTR,attr);}staticvoidattrhash_finish(void){hash_clean(attrhash,attr_vfree
);hash_free(attrhash);attrhash=NULL;}staticvoidattr_show_all_iterator(structhash
_backet*backet,structvty*vty){structattr*attr=backet->data;vty_out(vty,"attr[%ld
]nexthop%s\n",attr->refcnt,inet_ntoa(attr->nexthop));}voidattr_show_all(structvt
y*vty){hash_iterate(attrhash,(void(*)(structhash_backet*,void*))attr_show_all_it
erator,vty);}staticvoid*bgp_attr_hash_alloc(void*p){structattr*val=(structattr*)
p;structattr*attr;attr=XMALLOC(MTYPE_ATTR,sizeof(structattr));*attr=*val;if(val-
>encap_subtlvs){val->encap_subtlvs=NULL;}#ifENABLE_BGP_VNCif(val->vnc_subtlvs){v
al->vnc_subtlvs=NULL;}#endifattr->refcnt=0;returnattr;}/*Internetargumentattribu
te.*/structattr*bgp_attr_intern(structattr*attr){structattr*find;/*Internreferen
cedstrucutre.*/if(attr->aspath){if(!attr->aspath->refcnt)attr->aspath=aspath_int
ern(attr->aspath);elseattr->aspath->refcnt++;}if(attr->community){if(!attr->comm
unity->refcnt)attr->community=community_intern(attr->community);elseattr->commun
ity->refcnt++;}if(attr->ecommunity){if(!attr->ecommunity->refcnt)attr->ecommunit
y=ecommunity_intern(attr->ecommunity);elseattr->ecommunity->refcnt++;}if(attr->l
community){if(!attr->lcommunity->refcnt)attr->lcommunity=lcommunity_intern(attr-
>lcommunity);elseattr->lcommunity->refcnt++;}if(attr->cluster){if(!attr->cluster
->refcnt)attr->cluster=cluster_intern(attr->cluster);elseattr->cluster->refcnt++
;}if(attr->transit){if(!attr->transit->refcnt)attr->transit=transit_intern(attr-
>transit);elseattr->transit->refcnt++;}if(attr->encap_subtlvs){if(!attr->encap_s
ubtlvs->refcnt)attr->encap_subtlvs=encap_intern(attr->encap_subtlvs,ENCAP_SUBTLV
_TYPE);elseattr->encap_subtlvs->refcnt++;}#ifENABLE_BGP_VNCif(attr->vnc_subtlvs)
{if(!attr->vnc_subtlvs->refcnt)attr->vnc_subtlvs=encap_intern(attr->vnc_subtlvs,
VNC_SUBTLV_TYPE);elseattr->vnc_subtlvs->refcnt++;}#endif/*Atthispoint,attronlyco
ntainsintern'dpointers.thatmeans*ifwefinditinattrhash,ithasallthesamepointersand
we*correctlyupdatedtherefcountsonthese.*Ifwedon'tfindit,weneedtoallocateaonebeca
useinall*casesthisreturnsanewreferencetoahashedattr,buttheinput*wasn'tonhash.*/f
ind=(structattr*)hash_get(attrhash,attr,bgp_attr_hash_alloc);find->refcnt++;retu
rnfind;}/*Makenetworkstatement'sattribute.*/structattr*bgp_attr_default_set(stru
ctattr*attr,uint8_torigin){memset(attr,0,sizeof(structattr));attr->origin=origin
;attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_ORIGIN);attr->aspath=aspath_empty();attr->fl
ag|=ATTR_FLAG_BIT(BGP_ATTR_AS_PATH);attr->weight=BGP_ATTR_DEFAULT_WEIGHT;attr->t
ag=0;attr->label_index=BGP_INVALID_LABEL_INDEX;attr->label=MPLS_INVALID_LABEL;at
tr->flag|=ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP);attr->mp_nexthop_len=IPV6_MAX_BYTELEN
;returnattr;}/*Createtheattributesforanaggregate*/structattr*bgp_attr_aggregate_
intern(structbgp*bgp,uint8_torigin,structaspath*aspath,structcommunity*community
,intas_set,uint8_tatomic_aggregate){structattrattr;structattr*new;memset(&attr,0
,sizeof(structattr));/*Originattribute.*/attr.origin=origin;attr.flag|=ATTR_FLAG
_BIT(BGP_ATTR_ORIGIN);/*ASpathattribute.*/if(aspath)attr.aspath=aspath_intern(as
path);elseattr.aspath=aspath_empty();attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_AS_PATH);
/*Nexthopattribute.*/attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP);if(community){u
int32_tgshut=COMMUNITY_GSHUT;/*Ifwearenotshuttingdownourselvesandweare*aggregati
ngaroutethatcontainstheGSHUTcommunitywe*needtoremovethatcommunitywhencreatingthe
aggregate*/if(!bgp_flag_check(bgp,BGP_FLAG_GRACEFUL_SHUTDOWN)&&community_include
(community,gshut)){community_del_val(community,&gshut);}attr.community=community
;attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_COMMUNITIES);}if(bgp_flag_check(bgp,BGP_FLAG_
GRACEFUL_SHUTDOWN)){bgp_attr_add_gshut_community(&attr);}attr.label_index=BGP_IN
VALID_LABEL_INDEX;attr.label=MPLS_INVALID_LABEL;attr.weight=BGP_ATTR_DEFAULT_WEI
GHT;attr.mp_nexthop_len=IPV6_MAX_BYTELEN;if(!as_set||atomic_aggregate)attr.flag|
=ATTR_FLAG_BIT(BGP_ATTR_ATOMIC_AGGREGATE);attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_AGGR
EGATOR);if(CHECK_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION))attr.aggregator_as=b
gp->confed_id;elseattr.aggregator_as=bgp->as;attr.aggregator_addr=bgp->router_id
;attr.label_index=BGP_INVALID_LABEL_INDEX;attr.label=MPLS_INVALID_LABEL;new=bgp_
attr_intern(&attr);aspath_unintern(&new->aspath);returnnew;}/*Uninternjustthesub
-componentsoftheattr,butnottheattr*/voidbgp_attr_unintern_sub(structattr*attr){/
*aspathrefcountshoudbedecrement.*/if(attr->aspath)aspath_unintern(&attr->aspath)
;UNSET_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_AS_PATH));if(attr->community)commu
nity_unintern(&attr->community);UNSET_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_COM
MUNITIES));if(attr->ecommunity)ecommunity_unintern(&attr->ecommunity);UNSET_FLAG
(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES));if(attr->lcommunity)lcommun
ity_unintern(&attr->lcommunity);UNSET_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_LAR
GE_COMMUNITIES));if(attr->cluster)cluster_unintern(attr->cluster);UNSET_FLAG(att
r->flag,ATTR_FLAG_BIT(BGP_ATTR_CLUSTER_LIST));if(attr->transit)transit_unintern(
attr->transit);if(attr->encap_subtlvs)encap_unintern(&attr->encap_subtlvs,ENCAP_
SUBTLV_TYPE);#ifENABLE_BGP_VNCif(attr->vnc_subtlvs)encap_unintern(&attr->vnc_sub
tlvs,VNC_SUBTLV_TYPE);#endif}/**Wehavesomeshowcommandsthatletyouexperimentally*a
pplyaroute-map.Whenweapplytheroute-map*weareresetingvaluesbutnotsavingthemfor*po
sterityviaintern'ing(becauseroute-mapsdon't*dothat)butatthispointintimeweneed*to
comparethenewattrtotheoldandifthe*routemaphaschangeditweneedto,asSnoopDogsays,*D
ropitlikeit'shot*/voidbgp_attr_undup(structattr*new,structattr*old){if(new->aspa
th!=old->aspath)aspath_free(new->aspath);if(new->community!=old->community)commu
nity_free(new->community);if(new->ecommunity!=old->ecommunity)ecommunity_free(&n
ew->ecommunity);if(new->lcommunity!=old->lcommunity)lcommunity_free(&new->lcommu
nity);}/*Freebgpattributeandaspath.*/voidbgp_attr_unintern(structattr**pattr){st
ructattr*attr=*pattr;structattr*ret;structattrtmp;/*Decrementattributereference.
*/attr->refcnt--;tmp=*attr;/*Ifreferencebecomeszerothenfreeattributeobject.*/if(
attr->refcnt==0){ret=hash_release(attrhash,attr);assert(ret!=NULL);XFREE(MTYPE_A
TTR,attr);*pattr=NULL;}bgp_attr_unintern_sub(&tmp);}voidbgp_attr_flush(structatt
r*attr){if(attr->aspath&&!attr->aspath->refcnt){aspath_free(attr->aspath);attr->
aspath=NULL;}if(attr->community&&!attr->community->refcnt){community_free(attr->
community);attr->community=NULL;}if(attr->ecommunity&&!attr->ecommunity->refcnt)
ecommunity_free(&attr->ecommunity);if(attr->lcommunity&&!attr->lcommunity->refcn
t)lcommunity_free(&attr->lcommunity);if(attr->cluster&&!attr->cluster->refcnt){c
luster_free(attr->cluster);attr->cluster=NULL;}if(attr->transit&&!attr->transit-
>refcnt){transit_free(attr->transit);attr->transit=NULL;}if(attr->encap_subtlvs&
&!attr->encap_subtlvs->refcnt){encap_free(attr->encap_subtlvs);attr->encap_subtl
vs=NULL;}#ifENABLE_BGP_VNCif(attr->vnc_subtlvs&&!attr->vnc_subtlvs->refcnt){enca
p_free(attr->vnc_subtlvs);attr->vnc_subtlvs=NULL;}#endif}/*Implementdraft-scudde
r-idr-optional-transitivebehaviourand*avoidresettingsessionsformalformedattribut
eswhichare*arepartial/optionalandhencewheretheerrorlikelywasnot*introducedbythes
endingneighbour.*/staticbgp_attr_parse_ret_tbgp_attr_malformed(structbgp_attr_pa
rser_args*args,uint8_tsubcode,bgp_size_tlength){structpeer*constpeer=args->peer;
constuint8_tflags=args->flags;/*startpandlengthmustbespecial-cased,aswhetherorno
tto*sendtheattributedatawiththeNOTIFYdependsontheerror,*thecallerthereforesignal
sthiswiththeseperatelengthargument*/uint8_t*notify_datap=(length>0?args->startp:
NULL);/*OnlyrelaxerrorhandlingforeBGPpeers*/if(peer->sort!=BGP_PEER_EBGP){bgp_no
tify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,subcode,notify_datap,length);retu
rnBGP_ATTR_PARSE_ERROR;}/*Adjustthestreamgetptotheendoftheattribute,incasewecan*
stillproceedbutthecallerhasn'treadalltheattribute.*/stream_set_getp(BGP_INPUT(pe
er),(args->startp-STREAM_DATA(BGP_INPUT(peer)))+args->total);switch(args->type){
/*whereanattributeisrelativelyinconsequential,e.g.itdoesnot*affectrouteselection
,andcanbesafelyignored,thenanysuch*attributeswhicharemalformedshouldjustbeignore
dandtheroute*processedasnormal.*/caseBGP_ATTR_AS4_AGGREGATOR:caseBGP_ATTR_AGGREG
ATOR:caseBGP_ATTR_ATOMIC_AGGREGATE:returnBGP_ATTR_PARSE_PROCEED;/*Coreattributes
,particularlyoneswhichmayinfluenceroute*selection,shouldalwayscausesessionresets
*/caseBGP_ATTR_ORIGIN:caseBGP_ATTR_AS_PATH:caseBGP_ATTR_NEXT_HOP:caseBGP_ATTR_MU
LTI_EXIT_DISC:caseBGP_ATTR_LOCAL_PREF:caseBGP_ATTR_COMMUNITIES:caseBGP_ATTR_ORIG
INATOR_ID:caseBGP_ATTR_CLUSTER_LIST:caseBGP_ATTR_MP_REACH_NLRI:caseBGP_ATTR_MP_U
NREACH_NLRI:caseBGP_ATTR_EXT_COMMUNITIES:bgp_notify_send_with_data(peer,BGP_NOTI
FY_UPDATE_ERR,subcode,notify_datap,length);returnBGP_ATTR_PARSE_ERROR;}/*Partial
optionalattributesthataremalformedshouldnotcause*thewholesessiontobereset.Instea
dtreatitasawithdrawal*oftheroutes,ifpossible.*/if(CHECK_FLAG(flags,BGP_ATTR_FLAG
_TRANS)&&CHECK_FLAG(flags,BGP_ATTR_FLAG_OPTIONAL)&&CHECK_FLAG(flags,BGP_ATTR_FLA
G_PARTIAL))returnBGP_ATTR_PARSE_WITHDRAW;/*defaulttoreset*/returnBGP_ATTR_PARSE_
ERROR_NOTIFYPLS;}/*Findoutwhatiswrongwiththepathattributeflagbitsandlogtheerror.
"Flagbits"herestandforOptional,TransitiveandPartial,butnotforExtendedLength.Chec
kingO/T/Pbitsatonceimplies,thattheattributebeingdiagnosedisdefinedbyRFCaseithera
"well-known"oran"optional,non-transitive"attribute.*/staticvoidbgp_attr_flags_di
agnose(structbgp_attr_parser_args*args,uint8_tdesired_flags/*howRFCsaysitmustbe*
/){uint8_tseen=0,i;uint8_treal_flags=args->flags;constuint8_tattr_code=args->typ
e;desired_flags&=~BGP_ATTR_FLAG_EXTLEN;real_flags&=~BGP_ATTR_FLAG_EXTLEN;for(i=0
;i<=2;i++)/*O,T,P,butnotE*/if(CHECK_FLAG(desired_flags,attr_flag_str[i].key)!=CH
ECK_FLAG(real_flags,attr_flag_str[i].key)){zlog_err("%sattributemust%sbeflaggeda
s\"%s\"",lookup_msg(attr_str,attr_code,NULL),CHECK_FLAG(desired_flags,attr_flag_
str[i].key)?"":"not",attr_flag_str[i].str);seen=1;}if(!seen){zlog_debug("Strange
,%scalledforattr%s,butnoproblemfoundwithflags""(realflags0x%x,desired0x%x)",__fu
nc__,lookup_msg(attr_str,attr_code,NULL),real_flags,desired_flags);}}/*Requiredf
lagsforattributes.EXTLENwillbemaskedoffwhentesting,*aswillPARTIALforoptional+tra
nsitiveattributes.*/constuint8_tattr_flags_values[]={[BGP_ATTR_ORIGIN]=BGP_ATTR_
FLAG_TRANS,[BGP_ATTR_AS_PATH]=BGP_ATTR_FLAG_TRANS,[BGP_ATTR_NEXT_HOP]=BGP_ATTR_F
LAG_TRANS,[BGP_ATTR_MULTI_EXIT_DISC]=BGP_ATTR_FLAG_OPTIONAL,[BGP_ATTR_LOCAL_PREF
]=BGP_ATTR_FLAG_TRANS,[BGP_ATTR_ATOMIC_AGGREGATE]=BGP_ATTR_FLAG_TRANS,[BGP_ATTR_
AGGREGATOR]=BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_OPTIONAL,[BGP_ATTR_COMMUNITIES]=BG
P_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_OPTIONAL,[BGP_ATTR_ORIGINATOR_ID]=BGP_ATTR_FLAG_
OPTIONAL,[BGP_ATTR_CLUSTER_LIST]=BGP_ATTR_FLAG_OPTIONAL,[BGP_ATTR_MP_REACH_NLRI]
=BGP_ATTR_FLAG_OPTIONAL,[BGP_ATTR_MP_UNREACH_NLRI]=BGP_ATTR_FLAG_OPTIONAL,[BGP_A
TTR_EXT_COMMUNITIES]=BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS,[BGP_ATTR_AS4_PA
TH]=BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS,[BGP_ATTR_AS4_AGGREGATOR]=BGP_ATT
R_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS,[BGP_ATTR_PMSI_TUNNEL]=BGP_ATTR_FLAG_OPTIONA
L|BGP_ATTR_FLAG_TRANS,[BGP_ATTR_LARGE_COMMUNITIES]=BGP_ATTR_FLAG_OPTIONAL|BGP_AT
TR_FLAG_TRANS,[BGP_ATTR_PREFIX_SID]=BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS,}
;staticconstsize_tattr_flags_values_max=array_size(attr_flags_values)-1;staticin
tbgp_attr_flag_invalid(structbgp_attr_parser_args*args){uint8_tmask=BGP_ATTR_FLA
G_EXTLEN;constuint8_tflags=args->flags;constuint8_tattr_code=args->type;/*therem
aybeattributeswedon'tknowabout*/if(attr_code>attr_flags_values_max)return0;if(at
tr_flags_values[attr_code]==0)return0;/*RFC4271,"Forwell-knownattributes,theTran
sitivebitMUSTbeset*to*1."*/if(!CHECK_FLAG(BGP_ATTR_FLAG_OPTIONAL,flags)&&!CHECK_
FLAG(BGP_ATTR_FLAG_TRANS,flags)){zlog_err("%swell-knownattributesmusthavetransit
iveflagset(%x)",lookup_msg(attr_str,attr_code,NULL),flags);return1;}/*"Forwell-k
nownattributesandforoptionalnon-transitive*attributes,*thePartialbitMUSTbesetto0
."*/if(CHECK_FLAG(flags,BGP_ATTR_FLAG_PARTIAL)){if(!CHECK_FLAG(flags,BGP_ATTR_FL
AG_OPTIONAL)){zlog_err("%swell-knownattribute""mustNOThavethepartialflagset(%x)"
,lookup_msg(attr_str,attr_code,NULL),flags);return1;}if(CHECK_FLAG(flags,BGP_ATT
R_FLAG_OPTIONAL)&&!CHECK_FLAG(flags,BGP_ATTR_FLAG_TRANS)){zlog_err("%soptional+t
ransitiveattribute""mustNOThavethepartialflagset(%x)",lookup_msg(attr_str,attr_c
ode,NULL),flags);return1;}}/*Optionaltransitiveattributesmaygothroughspeakerstha
tdon't*reocgnisethemandsetthePartialbit.*/if(CHECK_FLAG(flags,BGP_ATTR_FLAG_OPTI
ONAL)&&CHECK_FLAG(flags,BGP_ATTR_FLAG_TRANS))SET_FLAG(mask,BGP_ATTR_FLAG_PARTIAL
);if((flags&~mask)==attr_flags_values[attr_code])return0;bgp_attr_flags_diagnose
(args,attr_flags_values[attr_code]);return1;}/*Getoriginattributeoftheupdatemess
age.*/staticbgp_attr_parse_ret_tbgp_attr_origin(structbgp_attr_parser_args*args)
{structpeer*constpeer=args->peer;structattr*constattr=args->attr;constbgp_size_t
length=args->length;/*IfanyrecognizedattributehasAttributeLengththatconflictswit
htheexpectedlength(basedontheattributetypecode),thentheErrorSubcodeissettoAttrib
uteLengthError.TheDatafieldcontainstheerroneousattribute(type,lengthandvalue).*/
if(length!=1){zlog_err("Originattributelengthisnotone%d",length);returnbgp_attr_
malformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}/*Fetchoriginattrib
ute.*/attr->origin=stream_getc(BGP_INPUT(peer));/*IftheORIGINattributehasanundef
inedvalue,thentheErrorSubcodeissettoInvalidOriginAttribute.TheDatafieldcontainst
heunrecognizedattribute(type,lengthandvalue).*/if((attr->origin!=BGP_ORIGIN_IGP)
&&(attr->origin!=BGP_ORIGIN_EGP)&&(attr->origin!=BGP_ORIGIN_INCOMPLETE)){zlog_er
r("Originattributevalueisinvalid%d",attr->origin);returnbgp_attr_malformed(args,
BGP_NOTIFY_UPDATE_INVAL_ORIGIN,args->total);}/*Setoringattributeflag.*/attr->fla
g|=ATTR_FLAG_BIT(BGP_ATTR_ORIGIN);return0;}/*ParseASpathinformation.Thisfunction
iswrapperofaspath_parse.*/staticintbgp_attr_aspath(structbgp_attr_parser_args*ar
gs){structattr*constattr=args->attr;structpeer*constpeer=args->peer;constbgp_siz
e_tlength=args->length;/**peerwithAS4=>willget4ByteASnums*otherwise,willget16Bit
*/attr->aspath=aspath_parse(peer->curr,length,CHECK_FLAG(peer->cap,PEER_CAP_AS4_
RCV));/*IncaseofIBGP,lengthwillbezero.*/if(!attr->aspath){zlog_err("MalformedASp
athfrom%s,lengthis%d",peer->host,length);returnbgp_attr_malformed(args,BGP_NOTIF
Y_UPDATE_MAL_AS_PATH,0);}/*Setaspathattributeflag.*/attr->flag|=ATTR_FLAG_BIT(BG
P_ATTR_AS_PATH);returnBGP_ATTR_PARSE_PROCEED;}staticbgp_attr_parse_ret_tbgp_attr
_aspath_check(structpeer*constpeer,structattr*constattr){/*Thesecheckswerepartof
bgp_attr_aspath,butwith*as4weshouldtocheckaspaththingswhen*aspathsynthesizingwit
has4_pathhasalreadytakenplace.*OtherwisewecheckASPATHandusethesynthesizedthing,a
ndthatis*notright.*Sodothecheckslater,i.e.here*/structbgp*bgp=peer->bgp;structas
path*aspath;/*Confederationsanitycheck.*/if((peer->sort==BGP_PEER_CONFED&&!aspat
h_left_confed_check(attr->aspath))||(peer->sort==BGP_PEER_EBGP&&aspath_confed_ch
eck(attr->aspath))){zlog_err("MalformedASpathfrom%s",peer->host);bgp_notify_send
(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_MAL_AS_PATH);returnBGP_ATTR_PARSE_
ERROR;}/*FirstAScheckforEBGP.*/if(bgp!=NULL&&bgp_flag_check(bgp,BGP_FLAG_ENFORCE
_FIRST_AS)){if(peer->sort==BGP_PEER_EBGP&&!aspath_firstas_check(attr->aspath,pee
r->as)){zlog_err("%sincorrectfirstAS(mustbe%u)",peer->host,peer->as);bgp_notify_
send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_MAL_AS_PATH);returnBGP_ATTR_PA
RSE_ERROR;}}/*local-asprepend*/if(peer->change_local_as&&!CHECK_FLAG(peer->flags
,PEER_FLAG_LOCAL_AS_NO_PREPEND)){aspath=aspath_dup(attr->aspath);aspath=aspath_a
dd_seq(aspath,peer->change_local_as);aspath_unintern(&attr->aspath);attr->aspath
=aspath_intern(aspath);}returnBGP_ATTR_PARSE_PROCEED;}/*ParseAS4pathinformation.
Thisfunctionisanotherwrapperofaspath_parse.*/staticintbgp_attr_as4_path(structbg
p_attr_parser_args*args,structaspath**as4_path){structpeer*constpeer=args->peer;
structattr*constattr=args->attr;constbgp_size_tlength=args->length;*as4_path=asp
ath_parse(peer->curr,length,1);/*IncaseofIBGP,lengthwillbezero.*/if(!*as4_path){
zlog_err("MalformedAS4pathfrom%s,lengthis%d",peer->host,length);returnbgp_attr_m
alformed(args,BGP_NOTIFY_UPDATE_MAL_AS_PATH,0);}/*Setaspathattributeflag.*/attr-
>flag|=ATTR_FLAG_BIT(BGP_ATTR_AS4_PATH);returnBGP_ATTR_PARSE_PROCEED;}/*Nexthopa
ttribute.*/staticbgp_attr_parse_ret_tbgp_attr_nexthop(structbgp_attr_parser_args
*args){structpeer*constpeer=args->peer;structattr*constattr=args->attr;constbgp_
size_tlength=args->length;in_addr_tnexthop_h,nexthop_n;/*Checknexthopattributele
ngth.*/if(length!=4){zlog_err("Nexthopattributelengthisn'tfour[%d]",length);retu
rnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}/*Accord
ingtosection6.3ofRFC4271,syntacticallyincorrectNEXT_HOPattributemustresultinaNOT
IFICATIONmessage(thisisimplementedbelow).Atthesametime,semanticallyincorrectNEXT
_HOPismorelikelytobejustloggedlocally(thisisimplementedsomewhereelse).TheUPDATEm
essagegetsignoredinanyofthesecases.*/nexthop_n=stream_get_ipv4(peer->curr);nexth
op_h=ntohl(nexthop_n);if((IPV4_NET0(nexthop_h)||IPV4_NET127(nexthop_h)||IPV4_CLA
SS_DE(nexthop_h))&&!BGP_DEBUG(allow_martians,ALLOW_MARTIANS))/*loopbacksmaybeuse
dintesting*/{charbuf[INET_ADDRSTRLEN];inet_ntop(AF_INET,&nexthop_n,buf,INET_ADDR
STRLEN);zlog_err("Martiannexthop%s",buf);returnbgp_attr_malformed(args,BGP_NOTIF
Y_UPDATE_INVAL_NEXT_HOP,args->total);}attr->nexthop.s_addr=nexthop_n;attr->flag|
=ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP);returnBGP_ATTR_PARSE_PROCEED;}/*MEDatrribute.*
/staticbgp_attr_parse_ret_tbgp_attr_med(structbgp_attr_parser_args*args){structp
eer*constpeer=args->peer;structattr*constattr=args->attr;constbgp_size_tlength=a
rgs->length;/*Lengthcheck.*/if(length!=4){zlog_err("MEDattributelengthisn'tfour[
%d]",length);returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args-
>total);}attr->med=stream_getl(peer->curr);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_MU
LTI_EXIT_DISC);returnBGP_ATTR_PARSE_PROCEED;}/*Localpreferenceattribute.*/static
bgp_attr_parse_ret_tbgp_attr_local_pref(structbgp_attr_parser_args*args){structp
eer*constpeer=args->peer;structattr*constattr=args->attr;constbgp_size_tlength=a
rgs->length;/*Lengthcheck.*/if(length!=4){zlog_err("LOCAL_PREFattributelengthisn
't4[%u]",length);returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,a
rgs->total);}/*IfitiscontainedinanUPDATEmessagethatisreceivedfromanexternalpeer,
thenthisattributeMUSTbeignoredbythereceivingspeaker.*/if(peer->sort==BGP_PEER_EB
GP){stream_forward_getp(peer->curr,length);returnBGP_ATTR_PARSE_PROCEED;}attr->l
ocal_pref=stream_getl(peer->curr);/*Setthelocal-prefflag.*/attr->flag|=ATTR_FLAG
_BIT(BGP_ATTR_LOCAL_PREF);returnBGP_ATTR_PARSE_PROCEED;}/*Atomicaggregate.*/stat
icintbgp_attr_atomic(structbgp_attr_parser_args*args){structattr*constattr=args-
>attr;constbgp_size_tlength=args->length;/*Lengthcheck.*/if(length!=0){zlog_err(
"ATOMIC_AGGREGATEattributelengthisn't0[%u]",length);returnbgp_attr_malformed(arg
s,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}/*Setatomicaggregateflag.*/attr-
>flag|=ATTR_FLAG_BIT(BGP_ATTR_ATOMIC_AGGREGATE);returnBGP_ATTR_PARSE_PROCEED;}/*
Aggregatorattribute*/staticintbgp_attr_aggregator(structbgp_attr_parser_args*arg
s){structpeer*constpeer=args->peer;structattr*constattr=args->attr;constbgp_size
_tlength=args->length;intwantedlen=6;/*peerwithAS4willsend4ByteAS,peerwithoutwil
lsend2Byte*/if(CHECK_FLAG(peer->cap,PEER_CAP_AS4_RCV))wantedlen=8;if(length!=wan
tedlen){zlog_err("AGGREGATORattributelengthisn't%u[%u]",wantedlen,length);return
bgp_attr_malformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}if(CHECK_F
LAG(peer->cap,PEER_CAP_AS4_RCV))attr->aggregator_as=stream_getl(peer->curr);else
attr->aggregator_as=stream_getw(peer->curr);attr->aggregator_addr.s_addr=stream_
get_ipv4(peer->curr);/*Setatomicaggregateflag.*/attr->flag|=ATTR_FLAG_BIT(BGP_AT
TR_AGGREGATOR);returnBGP_ATTR_PARSE_PROCEED;}/*NewAggregatorattribute*/staticbgp
_attr_parse_ret_tbgp_attr_as4_aggregator(structbgp_attr_parser_args*args,as_t*as
4_aggregator_as,structin_addr*as4_aggregator_addr){structpeer*constpeer=args->pe
er;structattr*constattr=args->attr;constbgp_size_tlength=args->length;if(length!
=8){zlog_err("NewAggregatorlengthisnot8[%d]",length);returnbgp_attr_malformed(ar
gs,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,0);}*as4_aggregator_as=stream_getl(peer->curr
);as4_aggregator_addr->s_addr=stream_get_ipv4(peer->curr);attr->flag|=ATTR_FLAG_
BIT(BGP_ATTR_AS4_AGGREGATOR);returnBGP_ATTR_PARSE_PROCEED;}/*MungeAggregatorandN
ew-Aggregator,AS_PATHandNEW_AS_PATH.*/staticbgp_attr_parse_ret_tbgp_attr_munge_a
s4_attrs(structpeer*constpeer,structattr*constattr,structaspath*as4_path,as_tas4
_aggregator,structin_addr*as4_aggregator_addr){intignore_as4_path=0;structaspath
*newpath;if(!attr->aspath){/*NULLaspathshouldn'tbepossibleasbgp_attr_parseshould
*have*checkedthatallwell-known,mandatoryattributeswere*present.**Canonlybeaprobl
emwithpeeritself-harderror*/returnBGP_ATTR_PARSE_ERROR;}if(CHECK_FLAG(peer->cap,
PEER_CAP_AS4_RCV)){/*peercandoAS4,soweignoreAS4_PATHandAS4_AGGREGATOR*ifgiven.*I
tisworthawarningthough,becausethepeerreally*shouldnotsendthem*/if(BGP_DEBUG(as4,
AS4)){if(attr->flag&(ATTR_FLAG_BIT(BGP_ATTR_AS4_PATH)))zlog_debug("[AS4]%s%sAS4_
PATH",peer->host,"AS4capablepeer,yetitsent");if(attr->flag&(ATTR_FLAG_BIT(BGP_AT
TR_AS4_AGGREGATOR)))zlog_debug("[AS4]%s%sAS4_AGGREGATOR",peer->host,"AS4capablep
eer,yetitsent");}returnBGP_ATTR_PARSE_PROCEED;}/*Wehaveaasn16peer.First,lookforA
S4_AGGREGATOR*becausethatmayoverrideAS4_PATH*/if(attr->flag&(ATTR_FLAG_BIT(BGP_A
TTR_AS4_AGGREGATOR))){if(attr->flag&(ATTR_FLAG_BIT(BGP_ATTR_AGGREGATOR))){/*rece
ivedboth.*iftheas_numberinaggregatorisnotAS_TRANS,*thenAS4_AGGREGATORandAS4_PATH
shallbeignored*andtheAggregatorshallbetakenas*infoontheaggregatingnode,andtheAS_
PATH*shallbetakenastheAS_PATH*otherwise*theAggregatorshallbeignoredandthe*AS4_AG
GREGATORshallbetakenasthe*AggregatingnodeandtheAS_PATHistobe*constructed"asinall
othercases"*/if(attr->aggregator_as!=BGP_AS_TRANS){/*ignore*/if(BGP_DEBUG(as4,AS
4))zlog_debug("[AS4]%sBGPnotAS4capablepeer""sendAGGREGATOR!=AS_TRANSand""AS4_AGG
REGATOR,soignore""AS4_AGGREGATORandAS4_PATH",peer->host);ignore_as4_path=1;}else
{/*"New_aggregatorshallbetakenasaggregator"*/attr->aggregator_as=as4_aggregator;
attr->aggregator_addr.s_addr=as4_aggregator_addr->s_addr;}}else{/*WereceivedaAS4
_AGGREGATORbutnoAGGREGATOR.*Thatisbogus-butreadingtheconditions*wehavetohandleAS
4_AGGREGATORasifitwere*AGGREGATORinthatcase*/if(BGP_DEBUG(as4,AS4))zlog_debug("[
AS4]%sBGPnotAS4capablepeersend""AS4_AGGREGATORbutnoAGGREGATOR,willtake""itasifAG
GREGATORwithAS_TRANShadbeenthere",peer->host);attr->aggregator_as=as4_aggregator
;/*sweepitunderthecarpetandsimulatea"good"*AGGREGATOR*/attr->flag|=(ATTR_FLAG_BI
T(BGP_ATTR_AGGREGATOR));}}/*needtoreconcileNEW_AS_PATHandAS_PATH*/if(!ignore_as4
_path&&(attr->flag&(ATTR_FLAG_BIT(BGP_ATTR_AS4_PATH)))){newpath=aspath_reconcile
_as4(attr->aspath,as4_path);aspath_unintern(&attr->aspath);attr->aspath=aspath_i
ntern(newpath);}returnBGP_ATTR_PARSE_PROCEED;}/*Communityattribute.*/staticbgp_a
ttr_parse_ret_tbgp_attr_community(structbgp_attr_parser_args*args){structpeer*co
nstpeer=args->peer;structattr*constattr=args->attr;constbgp_size_tlength=args->l
ength;if(length==0){attr->community=NULL;returnBGP_ATTR_PARSE_PROCEED;}attr->com
munity=community_parse((uint32_t*)stream_pnt(peer->curr),length);/*XXX:fixcommun
ity_parsetousestreamAPIandremovethis*/stream_forward_getp(peer->curr,length);if(
!attr->community)returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_OPT_ATTR_ERR,ar
gs->total);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_COMMUNITIES);returnBGP_ATTR_PARSE_
PROCEED;}/*OriginatorIDattribute.*/staticbgp_attr_parse_ret_tbgp_attr_originator
_id(structbgp_attr_parser_args*args){structpeer*constpeer=args->peer;structattr*
constattr=args->attr;constbgp_size_tlength=args->length;/*Lengthcheck.*/if(lengt
h!=4){zlog_err("BadoriginatorIDlength%d",length);returnbgp_attr_malformed(args,B
GP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}attr->originator_id.s_addr=stream_g
et_ipv4(peer->curr);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID);returnBGP_
ATTR_PARSE_PROCEED;}/*Clusterlistattribute.*/staticbgp_attr_parse_ret_tbgp_attr_
cluster_list(structbgp_attr_parser_args*args){structpeer*constpeer=args->peer;st
ructattr*constattr=args->attr;constbgp_size_tlength=args->length;/*Checklength.*
/if(length%4){zlog_err("Badclusterlistlength%d",length);returnbgp_attr_malformed
(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}attr->cluster=cluster_parse(
(structin_addr*)stream_pnt(peer->curr),length);/*XXX:Fixcluster_parsetousestream
APIandthenremovethis*/stream_forward_getp(peer->curr,length);attr->flag|=ATTR_FL
AG_BIT(BGP_ATTR_CLUSTER_LIST);returnBGP_ATTR_PARSE_PROCEED;}/*Multiprotocolreach
abilityinformationparse.*/intbgp_mp_reach_parse(structbgp_attr_parser_args*args,
structbgp_nlri*mp_update){iana_afi_tpkt_afi;afi_tafi;iana_safi_tpkt_safi;safi_ts
afi;bgp_size_tnlri_len;size_tstart;structstream*s;structpeer*constpeer=args->pee
r;structattr*constattr=args->attr;constbgp_size_tlength=args->length;/*Setendofp
acket.*/s=BGP_INPUT(peer);start=stream_get_getp(s);/*safetoreadstaticallysizedhe
ader?*/#defineBGP_MP_REACH_MIN_SIZE5#defineLEN_LEFT(length-(stream_get_getp(s)-s
tart))if((length>STREAM_READABLE(s))||(length<BGP_MP_REACH_MIN_SIZE)){zlog_info(
"%s:%ssentinvalidlength,%lu",__func__,peer->host,(unsignedlong)length);returnBGP
_ATTR_PARSE_ERROR_NOTIFYPLS;}/*LoadAFI,SAFI.*/pkt_afi=stream_getw(s);pkt_safi=st
ream_getc(s);/*ConvertAFI,SAFItointernalvalues,check.*/if(bgp_map_afi_safi_iana2
int(pkt_afi,pkt_safi,&afi,&safi)){/*LogifAFIorSAFIisunrecognized.Thisisnotanerro
r*unless*theattributeisotherwisemalformed.*/if(bgp_debug_update(peer,NULL,NULL,0
))zlog_debug("%s:MP_REACHreceivedAFI%uorSAFI%uisunrecognized",peer->host,pkt_afi
,pkt_safi);returnBGP_ATTR_PARSE_ERROR;}/*Getnexthoplength.*/attr->mp_nexthop_len
=stream_getc(s);if(LEN_LEFT<attr->mp_nexthop_len){zlog_info("%s:%s,MPnexthopleng
th,%u,goespastendofattribute",__func__,peer->host,attr->mp_nexthop_len);returnBG
P_ATTR_PARSE_ERROR_NOTIFYPLS;}/*Nexthoplengthcheck.*/switch(attr->mp_nexthop_len
){case0:if(safi!=SAFI_FLOWSPEC){zlog_info("%s:(%s)Wrongmultiprotocolnexthoplengt
h:%d",__func__,peer->host,attr->mp_nexthop_len);returnBGP_ATTR_PARSE_ERROR_NOTIF
YPLS;}break;caseBGP_ATTR_NHLEN_VPNV4:stream_getl(s);/*RDhigh*/stream_getl(s);/*R
Dlow*//**NOTE:intentionalfallthrough*-forconsistencyinrxprocessing**Thefollowing
commentistosignalGCCthisintention*andsupressthewarning*//*FALLTHRU*/caseBGP_ATTR
_NHLEN_IPV4:stream_get(&attr->mp_nexthop_global_in,s,IPV4_MAX_BYTELEN);/*Probabl
yneededforRFC2283*/if(attr->nexthop.s_addr==0)memcpy(&attr->nexthop.s_addr,&attr
->mp_nexthop_global_in,IPV4_MAX_BYTELEN);break;caseBGP_ATTR_NHLEN_IPV6_GLOBAL:ca
seBGP_ATTR_NHLEN_VPNV6_GLOBAL:if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_VPNV6_GLOB
AL){stream_getl(s);/*RDhigh*/stream_getl(s);/*RDlow*/}stream_get(&attr->mp_nexth
op_global,s,IPV6_MAX_BYTELEN);break;caseBGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL:caseBG
P_ATTR_NHLEN_VPNV6_GLOBAL_AND_LL:if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_VPNV6_G
LOBAL_AND_LL){stream_getl(s);/*RDhigh*/stream_getl(s);/*RDlow*/}stream_get(&attr
->mp_nexthop_global,s,IPV6_MAX_BYTELEN);if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_
VPNV6_GLOBAL_AND_LL){stream_getl(s);/*RDhigh*/stream_getl(s);/*RDlow*/}stream_ge
t(&attr->mp_nexthop_local,s,IPV6_MAX_BYTELEN);if(!IN6_IS_ADDR_LINKLOCAL(&attr->m
p_nexthop_local)){charbuf1[INET6_ADDRSTRLEN];charbuf2[INET6_ADDRSTRLEN];if(bgp_d
ebug_update(peer,NULL,NULL,1))zlog_debug("%srcvdnexthops%s,%s--ignoringnon-LLval
ue",peer->host,inet_ntop(AF_INET6,&attr->mp_nexthop_global,buf1,INET6_ADDRSTRLEN
),inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf2,INET6_ADDRSTRLEN));attr->mp_ne
xthop_len=IPV6_MAX_BYTELEN;}break;default:zlog_info("%s:(%s)Wrongmultiprotocolne
xthoplength:%d",__func__,peer->host,attr->mp_nexthop_len);returnBGP_ATTR_PARSE_E
RROR_NOTIFYPLS;}if(!LEN_LEFT){zlog_info("%s:(%s)FailedtoreadSNPAandNLRI(s)",__fu
nc__,peer->host);returnBGP_ATTR_PARSE_ERROR_NOTIFYPLS;}{uint8_tval;if((val=strea
m_getc(s)))zlog_warn("%ssentnon-zerovalue,%u,fordefunctSNPA-lengthfield",peer->h
ost,val);}/*musthavenrli_len,whatisleftoftheattribute*/nlri_len=LEN_LEFT;if(nlri
_len>STREAM_READABLE(s)){zlog_info("%s:(%s)FailedtoreadNLRI",__func__,peer->host
);returnBGP_ATTR_PARSE_ERROR_NOTIFYPLS;}if(!nlri_len){zlog_info("%s:(%s)NoReacha
bility,TreatingasaEORmarker",__func__,peer->host);mp_update->afi=afi;mp_update->
safi=safi;returnBGP_ATTR_PARSE_EOR;}mp_update->afi=afi;mp_update->safi=safi;mp_u
pdate->nlri=stream_pnt(s);mp_update->length=nlri_len;stream_forward_getp(s,nlri_
len);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_MP_REACH_NLRI);returnBGP_ATTR_PARSE_PROC
EED;#undefLEN_LEFT}/*Multiprotocolunreachableparse*/intbgp_mp_unreach_parse(stru
ctbgp_attr_parser_args*args,structbgp_nlri*mp_withdraw){structstream*s;iana_afi_
tpkt_afi;afi_tafi;iana_safi_tpkt_safi;safi_tsafi;uint16_twithdraw_len;structpeer
*constpeer=args->peer;structattr*constattr=args->attr;constbgp_size_tlength=args
->length;s=peer->curr;#defineBGP_MP_UNREACH_MIN_SIZE3if((length>STREAM_READABLE(
s))||(length<BGP_MP_UNREACH_MIN_SIZE))returnBGP_ATTR_PARSE_ERROR_NOTIFYPLS;pkt_a
fi=stream_getw(s);pkt_safi=stream_getc(s);/*ConvertAFI,SAFItointernalvalues,chec
k.*/if(bgp_map_afi_safi_iana2int(pkt_afi,pkt_safi,&afi,&safi)){/*LogifAFIorSAFIi
sunrecognized.Thisisnotanerror*unless*theattributeisotherwisemalformed.*/if(bgp_
debug_update(peer,NULL,NULL,0))zlog_debug("%s:MP_UNREACHreceivedAFI%uorSAFI%uisu
nrecognized",peer->host,pkt_afi,pkt_safi);returnBGP_ATTR_PARSE_ERROR;}withdraw_l
en=length-BGP_MP_UNREACH_MIN_SIZE;mp_withdraw->afi=afi;mp_withdraw->safi=safi;mp
_withdraw->nlri=stream_pnt(s);mp_withdraw->length=withdraw_len;stream_forward_ge
tp(s,withdraw_len);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_MP_UNREACH_NLRI);returnBGP
_ATTR_PARSE_PROCEED;}/*LargeCommunityattribute.*/staticbgp_attr_parse_ret_tbgp_a
ttr_large_community(structbgp_attr_parser_args*args){structpeer*constpeer=args->
peer;structattr*constattr=args->attr;constbgp_size_tlength=args->length;/**Large
communityfollowsnewattributeformat.*/if(length==0){attr->lcommunity=NULL;/*Empty
extcommdoesn'tseemtobeinvalidperse*/returnBGP_ATTR_PARSE_PROCEED;}attr->lcommuni
ty=lcommunity_parse((uint8_t*)stream_pnt(peer->curr),length);/*XXX:fixecommunity
_parsetousestreamAPI*/stream_forward_getp(peer->curr,length);if(!attr->lcommunit
y)returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_OPT_ATTR_ERR,args->total);attr
->flag|=ATTR_FLAG_BIT(BGP_ATTR_LARGE_COMMUNITIES);returnBGP_ATTR_PARSE_PROCEED;}
/*ExtendedCommunityattribute.*/staticbgp_attr_parse_ret_tbgp_attr_ext_communitie
s(structbgp_attr_parser_args*args){structpeer*constpeer=args->peer;structattr*co
nstattr=args->attr;constbgp_size_tlength=args->length;uint8_tsticky=0;if(length=
=0){attr->ecommunity=NULL;/*Emptyextcommdoesn'tseemtobeinvalidperse*/returnBGP_A
TTR_PARSE_PROCEED;}attr->ecommunity=ecommunity_parse((uint8_t*)stream_pnt(peer->
curr),length);/*XXX:fixecommunity_parsetousestreamAPI*/stream_forward_getp(peer-
>curr,length);if(!attr->ecommunity)returnbgp_attr_malformed(args,BGP_NOTIFY_UPDA
TE_OPT_ATTR_ERR,args->total);attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES)
;/*ExtractMACmobilitysequencenumber,ifany.*/attr->mm_seqnum=bgp_attr_mac_mobilit
y_seqnum(attr,&sticky);attr->sticky=sticky;/*CheckifthisisaGatewayMAC-IPadvertis
ement*/attr->default_gw=bgp_attr_default_gw(attr);/*ExtracttheRmac,ifany*/bgp_at
tr_rmac(attr,&attr->rmac);returnBGP_ATTR_PARSE_PROCEED;}/*ParseTunnelEncapattrib
uteinanUPDATE*/staticintbgp_attr_encap(uint8_ttype,structpeer*peer,/*IN*/bgp_siz
e_tlength,/*IN:attr'slengthfield*/structattr*attr,/*IN:calleralreadyallocated*/u
int8_tflag,/*IN:attr'sflagsfield*/uint8_t*startp){bgp_size_ttotal;uint16_ttunnel
type=0;total=length+(CHECK_FLAG(flag,BGP_ATTR_FLAG_EXTLEN)?4:3);if(!CHECK_FLAG(f
lag,BGP_ATTR_FLAG_TRANS)||!CHECK_FLAG(flag,BGP_ATTR_FLAG_OPTIONAL)){zlog_info("T
unnelEncapattributeflagisn'toptionalandtransitive%d",flag);bgp_notify_send_with_
data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_ATTR_FLAG_ERR,startp,total);re
turn-1;}if(BGP_ATTR_ENCAP==type){/*readouterTLVtypeandlength*/uint16_ttlv_length
;if(length<4){zlog_info("TunnelEncapattributenotlongenoughtocontainouterT,L");bg
p_notify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_OPT_ATTR_ER
R,startp,total);return-1;}tunneltype=stream_getw(BGP_INPUT(peer));tlv_length=str
eam_getw(BGP_INPUT(peer));length-=4;if(tlv_length!=length){zlog_info("%s:tlv_len
gth(%d)!=length(%d)",__func__,tlv_length,length);}}while(length>=4){uint16_tsubt
ype=0;uint16_tsublength=0;structbgp_attr_encap_subtlv*tlv;if(BGP_ATTR_ENCAP==typ
e){subtype=stream_getc(BGP_INPUT(peer));sublength=stream_getc(BGP_INPUT(peer));l
ength-=2;#ifENABLE_BGP_VNC}else{subtype=stream_getw(BGP_INPUT(peer));sublength=s
tream_getw(BGP_INPUT(peer));length-=4;#endif}if(sublength>length){zlog_info("Tun
nelEncapattributesub-tlvlength%dexceedsremaininglength%d",sublength,length);bgp_
notify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_OPT_ATTR_ERR,
startp,total);return-1;}/*allocandcopysub-tlv*//*TBDmakesurethesearefreedwhenatt
ributesarereleased*/tlv=XCALLOC(MTYPE_ENCAP_TLV,sizeof(structbgp_attr_encap_subt
lv)+sublength);tlv->type=subtype;tlv->length=sublength;stream_get(tlv->value,pee
r->curr,sublength);length-=sublength;/*attachtlvtoencapchain*/if(BGP_ATTR_ENCAP=
=type){structbgp_attr_encap_subtlv*stlv_last;for(stlv_last=attr->encap_subtlvs;s
tlv_last&&stlv_last->next;stlv_last=stlv_last->next);if(stlv_last){stlv_last->ne
xt=tlv;}else{attr->encap_subtlvs=tlv;}#ifENABLE_BGP_VNC}else{structbgp_attr_enca
p_subtlv*stlv_last;for(stlv_last=attr->vnc_subtlvs;stlv_last&&stlv_last->next;st
lv_last=stlv_last->next);if(stlv_last){stlv_last->next=tlv;}else{attr->vnc_subtl
vs=tlv;}#endif}}if(BGP_ATTR_ENCAP==type){attr->encap_tunneltype=tunneltype;}if(l
ength){/*spuriousleftoverdata*/zlog_info("TunnelEncapattributelengthisbad:%dleft
overoctets",length);bgp_notify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOT
IFY_UPDATE_OPT_ATTR_ERR,startp,total);return-1;}return0;}/*PrefixSIDattribute*dr
aft-ietf-idr-bgp-prefix-sid-05*/staticbgp_attr_parse_ret_tbgp_attr_prefix_sid(st
ructbgp_attr_parser_args*args,structbgp_nlri*mp_update){structpeer*constpeer=arg
s->peer;structattr*constattr=args->attr;inttype;intlength;uint32_tlabel_index;st
ructin6_addripv6_sid;uint32_tsrgb_base;uint32_tsrgb_range;intsrgb_count;attr->fl
ag|=ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);type=stream_getc(peer->curr);length=strea
m_getw(peer->curr);if(type==BGP_PREFIX_SID_LABEL_INDEX){if(length!=BGP_PREFIX_SI
D_LABEL_INDEX_LENGTH){zlog_err("PrefixSIDlabelindexlengthis%dinsteadof%d",length
,BGP_PREFIX_SID_LABEL_INDEX_LENGTH);returnbgp_attr_malformed(args,BGP_NOTIFY_UPD
ATE_ATTR_LENG_ERR,args->total);}/*Ignoreflagsandreserved*/stream_getc(peer->curr
);stream_getw(peer->curr);/*Fetchthelabelindexandseeifitisvalid.*/label_index=st
ream_getl(peer->curr);if(label_index==BGP_INVALID_LABEL_INDEX)returnbgp_attr_mal
formed(args,BGP_NOTIFY_UPDATE_OPT_ATTR_ERR,args->total);/*Storelabelindex;subseq
uently,we'llcheckon*address-family*/attr->label_index=label_index;/**IgnoretheLa
belindexattributeunlessreceivedfor*labeled-unicast*SAFI.*/if(!mp_update->length|
|mp_update->safi!=SAFI_LABELED_UNICAST)attr->label_index=BGP_INVALID_LABEL_INDEX
;}/*PlaceholdercodefortheIPv6SIDtype*/elseif(type==BGP_PREFIX_SID_IPV6){if(lengt
h!=BGP_PREFIX_SID_IPV6_LENGTH){zlog_err("PrefixSIDIPv6lengthis%dinsteadof%d",len
gth,BGP_PREFIX_SID_IPV6_LENGTH);returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_
ATTR_LENG_ERR,args->total);}/*Ignorereserved*/stream_getc(peer->curr);stream_get
w(peer->curr);stream_get(&ipv6_sid,peer->curr,16);}/*PlaceholdercodefortheOrigin
atorSRGBtype*/elseif(type==BGP_PREFIX_SID_ORIGINATOR_SRGB){/*Ignoreflags*/stream
_getw(peer->curr);length-=2;if(length%BGP_PREFIX_SID_ORIGINATOR_SRGB_LENGTH){zlo
g_err("PrefixSIDOriginatorSRGBlengthis%d,itmustbeamultipleof%d",length,BGP_PREFI
X_SID_ORIGINATOR_SRGB_LENGTH);returnbgp_attr_malformed(args,BGP_NOTIFY_UPDATE_AT
TR_LENG_ERR,args->total);}srgb_count=length/BGP_PREFIX_SID_ORIGINATOR_SRGB_LENGT
H;for(inti=0;i<srgb_count;i++){stream_get(&srgb_base,peer->curr,3);stream_get(&s
rgb_range,peer->curr,3);}}returnBGP_ATTR_PARSE_PROCEED;}/*PMSItunnelattribute(RF
C6514)*Basicvalidationchecksdonehere.*/staticbgp_attr_parse_ret_tbgp_attr_pmsi_t
unnel(structbgp_attr_parser_args*args){structpeer*constpeer=args->peer;structatt
r*constattr=args->attr;constbgp_size_tlength=args->length;uint8_ttnl_type;/*Veri
fythatthereceiverisexpecting"ingressreplication"aswe*canonlysupportthat.*/if(len
gth<2){zlog_err("BadPMSItunnelattributelength%d",length);returnbgp_attr_malforme
d(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}stream_getc(peer->curr);/*F
lags*/tnl_type=stream_getc(peer->curr);if(tnl_type>PMSI_TNLTYPE_MAX){zlog_err("I
nvalidPMSItunnelattributetype%d",tnl_type);returnbgp_attr_malformed(args,BGP_NOT
IFY_UPDATE_OPT_ATTR_ERR,args->total);}if(tnl_type==PMSI_TNLTYPE_INGR_REPL){if(le
ngth!=9){zlog_err("BadPMSItunnelattributelength%dforIR",length);returnbgp_attr_m
alformed(args,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR,args->total);}}attr->flag|=ATTR_FL
AG_BIT(BGP_ATTR_PMSI_TUNNEL);attr->pmsi_tnl_type=tnl_type;/*Forwardreadpointerof
inputstream.*/stream_forward_getp(peer->curr,length-2);returnBGP_ATTR_PARSE_PROC
EED;}/*BGPunknownattributetreatment.*/staticbgp_attr_parse_ret_tbgp_attr_unknown
(structbgp_attr_parser_args*args){bgp_size_ttotal=args->total;structtransit*tran
sit;structpeer*constpeer=args->peer;structattr*constattr=args->attr;uint8_t*cons
tstartp=args->startp;constuint8_ttype=args->type;constuint8_tflag=args->flags;co
nstbgp_size_tlength=args->length;if(bgp_debug_update(peer,NULL,NULL,1))zlog_debu
g("%sUnknownattributeisreceived(type%d,length%d)",peer->host,type,length);/*Forw
ardreadpointerofinputstream.*/stream_forward_getp(peer->curr,length);/*Ifanyofth
emandatorywell-knownattributesarenotrecognized,thentheErrorSubcodeissettoUnrecog
nizedWell-knownAttribute.TheDatafieldcontainstheunrecognizedattribute(type,lengt
handvalue).*/if(!CHECK_FLAG(flag,BGP_ATTR_FLAG_OPTIONAL)){returnbgp_attr_malform
ed(args,BGP_NOTIFY_UPDATE_UNREC_ATTR,args->total);}/*Unrecognizednon-transitiveo
ptionalattributesmustbequietlyignoredandnotpassedalongtootherBGPpeers.*/if(!CHEC
K_FLAG(flag,BGP_ATTR_FLAG_TRANS))returnBGP_ATTR_PARSE_PROCEED;/*Ifapathwithrecog
nizedtransitiveoptionalattributeisacceptedandpassedalongtootherBGPpeersandthePar
tialbitintheAttributeFlagsoctetissetto1bysomepreviousAS,itisnotsetbackto0bythecu
rrentAS.*/SET_FLAG(*startp,BGP_ATTR_FLAG_PARTIAL);/*Storetransitiveattributetoth
eendofattr->transit.*/if(!attr->transit)attr->transit=XCALLOC(MTYPE_TRANSIT,size
of(structtransit));transit=attr->transit;if(transit->val)transit->val=XREALLOC(M
TYPE_TRANSIT_VAL,transit->val,transit->length+total);elsetransit->val=XMALLOC(MT
YPE_TRANSIT_VAL,total);memcpy(transit->val+transit->length,startp,total);transit
->length+=total;returnBGP_ATTR_PARSE_PROCEED;}/*Well-knownattributecheck.*/stati
cintbgp_attr_check(structpeer*peer,structattr*attr){uint8_ttype=0;/*BGPGraceful-
RestartEnd-of-RIBforIPv4unicastissignaledasan*emptyUPDATE.*/if(CHECK_FLAG(peer->
cap,PEER_CAP_RESTART_RCV)&&!attr->flag)returnBGP_ATTR_PARSE_PROCEED;/*"AnUPDATEm
essagethatcontainstheMP_UNREACH_NLRIisnotrequiredtocarryanyotherpathattributes."
,thoughifMP_REACH_NLRIorNLRIarepresent,itshould.Checkforanyotherattributebeingpr
esentinstead.*/if(attr->flag==ATTR_FLAG_BIT(BGP_ATTR_MP_UNREACH_NLRI))returnBGP_
ATTR_PARSE_PROCEED;if(!CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_ORIGIN)))typ
e=BGP_ATTR_ORIGIN;if(!CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_AS_PATH)))typ
e=BGP_ATTR_AS_PATH;/*RFC2858makesNext-Hopoptional/ignored,ifMP_REACH_NLRIisprese
nt*and*NLRIisempty.Wecan'teasilycheckNLRIemptyherethough.*/if(!CHECK_FLAG(attr->
flag,ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP))&&!CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP
_ATTR_MP_REACH_NLRI)))type=BGP_ATTR_NEXT_HOP;if(peer->sort==BGP_PEER_IBGP&&!CHEC
K_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)))type=BGP_ATTR_LOCAL_PREF;i
f(type){zlog_warn("%sMissingwell-knownattribute%s.",peer->host,lookup_msg(attr_s
tr,type,NULL));bgp_notify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_U
PDATE_MISS_ATTR,&type,1);returnBGP_ATTR_PARSE_ERROR;}returnBGP_ATTR_PARSE_PROCEE
D;}/*Readattributeofupdatepacket.Thisfunctioniscalledfrombgp_update_receive()inb
gp_packet.c.*/bgp_attr_parse_ret_tbgp_attr_parse(structpeer*peer,structattr*attr
,bgp_size_tsize,structbgp_nlri*mp_update,structbgp_nlri*mp_withdraw){intret;uint
8_tflag=0;uint8_ttype=0;bgp_size_tlength;uint8_t*startp,*endp;uint8_t*attr_endp;
uint8_tseen[BGP_ATTR_BITMAP_SIZE];/*weneedtheas4_pathonlyuntilwehavesynthesizedt
heas_pathwith*it*//*samegoesforas4_aggregator*/structaspath*as4_path=NULL;as_tas
4_aggregator=0;structin_addras4_aggregator_addr={.s_addr=0};/*Initializebitmap.*
/memset(seen,0,BGP_ATTR_BITMAP_SIZE);/*EndpointerofBGPattribute.*/endp=BGP_INPUT
_PNT(peer)+size;/*Getattributestotheendofattributelength.*/while(BGP_INPUT_PNT(p
eer)<endp){/*Checkremaininglengthcheck.*/if(endp-BGP_INPUT_PNT(peer)<BGP_ATTR_MI
N_LEN){/*XXXwarning:longintformat,intarg(arg5)*/zlog_warn("%s:errorBGPattributel
ength%luissmallerthanminlen",peer->host,(unsignedlong)(endp-stream_pnt(BGP_INPUT
(peer))));bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_ATTR_LENG
_ERR);returnBGP_ATTR_PARSE_ERROR;}/*Fetchattributeflagandtype.*/startp=BGP_INPUT
_PNT(peer);/*"Thelower-orderfourbitsoftheAttributeFlagsoctetareunused.TheyMUSTbe
zerowhensentandMUSTbeignoredwhenreceived."*/flag=0xF0&stream_getc(BGP_INPUT(peer
));type=stream_getc(BGP_INPUT(peer));/*CheckwhetherExtended-Lengthappliesandisin
bounds*/if(CHECK_FLAG(flag,BGP_ATTR_FLAG_EXTLEN)&&((endp-startp)<(BGP_ATTR_MIN_L
EN+1))){zlog_warn("%s:Extendedlengthset,butjust%lubytesofattrheader",peer->host,
(unsignedlong)(endp-stream_pnt(BGP_INPUT(peer))));bgp_notify_send(peer,BGP_NOTIF
Y_UPDATE_ERR,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR);returnBGP_ATTR_PARSE_ERROR;}/*Chec
kextendedattribuelengthbit.*/if(CHECK_FLAG(flag,BGP_ATTR_FLAG_EXTLEN))length=str
eam_getw(BGP_INPUT(peer));elselength=stream_getc(BGP_INPUT(peer));/*Ifanyattribu
teappearsmorethanonceintheUPDATEmessage,thentheErrorSubcodeissettoMalformedAttri
buteList.*/if(CHECK_BITMAP(seen,type)){zlog_warn("%s:errorBGPattributetype%dappe
arstwiceinamessage",peer->host,type);bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,
BGP_NOTIFY_UPDATE_MAL_ATTR);returnBGP_ATTR_PARSE_ERROR;}/*Settypetobitmaptocheck
duplicateattribute.`type'isunsignedcharsoitneveroverflowbitmaprange.*/SET_BITMAP
(seen,type);/*Overflowcheck.*/attr_endp=BGP_INPUT_PNT(peer)+length;if(attr_endp>
endp){zlog_warn("%s:BGPtype%dlength%distoolarge,attributetotallengthis%d.attr_en
dpis%p.endpis%p",peer->host,type,length,size,attr_endp,endp);/**RFC42716.3*Ifany
recognizedattributehasanAttribute*Lengththatconflictswiththeexpectedlength*(base
dontheattributetypecode),thenthe*ErrorSubcodeMUSTbesettoAttributeLength*Error.Th
eDatafieldMUSTcontaintheerroneous*attribute(type,length,andvalue).*----------*We
donotcurrentlyhaveagoodwaytodeterminethe*lengthoftheattributeindependentofthelen
gth*receivedinthemessage.Insteadwesendthe*minimumbetweentheamountofdatawehaveand
the*amountspecifiedbytheattributelengthfield.**Insteadofdirectlypassinginthepack
etbufferand*offsetweusethestream_get*functionstoreadinto*astackbuffer,sincetheyp
erformboundschecking*andweareworkingwithuntrusteddata.*/unsignedcharndata[BGP_MA
X_PACKET_SIZE];memset(ndata,0x00,sizeof(ndata));size_tlfl=CHECK_FLAG(flag,BGP_AT
TR_FLAG_EXTLEN)?2:1;/*Rewindtoendofflagfield*/stream_forward_getp(BGP_INPUT(peer
),-(1+lfl));/*Type*/stream_get(&ndata[0],BGP_INPUT(peer),1);/*Length*/stream_get
(&ndata[1],BGP_INPUT(peer),lfl);/*Value*/size_tatl=attr_endp-startp;size_tndl=MI
N(atl,STREAM_READABLE(BGP_INPUT(peer)));stream_get(&ndata[lfl+1],BGP_INPUT(peer)
,ndl);bgp_notify_send_with_data(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_ATT
R_LENG_ERR,ndata,ndl+lfl+1);returnBGP_ATTR_PARSE_ERROR;}structbgp_attr_parser_ar
gsattr_args={.peer=peer,.length=length,.attr=attr,.type=type,.flags=flag,.startp
=startp,.total=attr_endp-startp,};/*IfanyrecognizedattributehasAttributeFlagstha
tconflictwiththeAttributeTypeCode,thentheErrorSubcodeissettoAttributeFlagsError.
TheDatafieldcontainstheerroneousattribute(type,lengthandvalue).*/if(bgp_attr_fla
g_invalid(&attr_args)){bgp_attr_parse_ret_tret;ret=bgp_attr_malformed(&attr_args
,BGP_NOTIFY_UPDATE_ATTR_FLAG_ERR,attr_args.total);if(ret==BGP_ATTR_PARSE_PROCEED
)continue;returnret;}/*OKcheckattributeandstoreit'svalue.*/switch(type){caseBGP_
ATTR_ORIGIN:ret=bgp_attr_origin(&attr_args);break;caseBGP_ATTR_AS_PATH:ret=bgp_a
ttr_aspath(&attr_args);break;caseBGP_ATTR_AS4_PATH:ret=bgp_attr_as4_path(&attr_a
rgs,&as4_path);break;caseBGP_ATTR_NEXT_HOP:ret=bgp_attr_nexthop(&attr_args);brea
k;caseBGP_ATTR_MULTI_EXIT_DISC:ret=bgp_attr_med(&attr_args);break;caseBGP_ATTR_L
OCAL_PREF:ret=bgp_attr_local_pref(&attr_args);break;caseBGP_ATTR_ATOMIC_AGGREGAT
E:ret=bgp_attr_atomic(&attr_args);break;caseBGP_ATTR_AGGREGATOR:ret=bgp_attr_agg
regator(&attr_args);break;caseBGP_ATTR_AS4_AGGREGATOR:ret=bgp_attr_as4_aggregato
r(&attr_args,&as4_aggregator,&as4_aggregator_addr);break;caseBGP_ATTR_COMMUNITIE
S:ret=bgp_attr_community(&attr_args);break;caseBGP_ATTR_LARGE_COMMUNITIES:ret=bg
p_attr_large_community(&attr_args);break;caseBGP_ATTR_ORIGINATOR_ID:ret=bgp_attr
_originator_id(&attr_args);break;caseBGP_ATTR_CLUSTER_LIST:ret=bgp_attr_cluster_
list(&attr_args);break;caseBGP_ATTR_MP_REACH_NLRI:ret=bgp_mp_reach_parse(&attr_a
rgs,mp_update);break;caseBGP_ATTR_MP_UNREACH_NLRI:ret=bgp_mp_unreach_parse(&attr
_args,mp_withdraw);break;caseBGP_ATTR_EXT_COMMUNITIES:ret=bgp_attr_ext_communiti
es(&attr_args);break;#ifENABLE_BGP_VNCcaseBGP_ATTR_VNC:#endifcaseBGP_ATTR_ENCAP:
ret=bgp_attr_encap(type,peer,length,attr,flag,startp);break;caseBGP_ATTR_PREFIX_
SID:ret=bgp_attr_prefix_sid(&attr_args,mp_update);break;caseBGP_ATTR_PMSI_TUNNEL
:ret=bgp_attr_pmsi_tunnel(&attr_args);break;default:ret=bgp_attr_unknown(&attr_a
rgs);break;}if(ret==BGP_ATTR_PARSE_ERROR_NOTIFYPLS){bgp_notify_send(peer,BGP_NOT
IFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_MAL_ATTR);ret=BGP_ATTR_PARSE_ERROR;}if(ret==BGP
_ATTR_PARSE_EOR){if(as4_path)aspath_unintern(&as4_path);returnret;}/*Ifharderror
occuredimmediatelyreturntothecaller.*/if(ret==BGP_ATTR_PARSE_ERROR){zlog_warn("%
s:Attribute%s,parseerror",peer->host,lookup_msg(attr_str,type,NULL));if(as4_path
)aspath_unintern(&as4_path);returnret;}if(ret==BGP_ATTR_PARSE_WITHDRAW){zlog_war
n("%s:Attribute%s,parseerror-treatingaswithdrawal",peer->host,lookup_msg(attr_st
r,type,NULL));if(as4_path)aspath_unintern(&as4_path);returnret;}/*Checkthefetche
dlength.*/if(BGP_INPUT_PNT(peer)!=attr_endp){zlog_warn("%s:BGPattribute%s,fetche
rror",peer->host,lookup_msg(attr_str,type,NULL));bgp_notify_send(peer,BGP_NOTIFY
_UPDATE_ERR,BGP_NOTIFY_UPDATE_ATTR_LENG_ERR);if(as4_path)aspath_unintern(&as4_pa
th);returnBGP_ATTR_PARSE_ERROR;}}/*Checkfinalreadpointerissameasendpointer.*/if(
BGP_INPUT_PNT(peer)!=endp){zlog_warn("%s:BGPattribute%s,lengthmismatch",peer->ho
st,lookup_msg(attr_str,type,NULL));bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BG
P_NOTIFY_UPDATE_ATTR_LENG_ERR);if(as4_path)aspath_unintern(&as4_path);returnBGP_
ATTR_PARSE_ERROR;}/*Checkallmandatorywell-knownattributesarepresent*/{bgp_attr_p
arse_ret_tret;if((ret=bgp_attr_check(peer,attr))<0){if(as4_path)aspath_unintern(
&as4_path);returnret;}}/**AtthisplacewecanseewhetherwegotAS4_PATHand/or*AS4_AGGR
EGATORfroma16Bitpeerandactaccordingly.*Wecannotdothisbeforewe'vereadallattribute
sbecause*theas4handlingdoesnotsaywhetherAS4_PATHhastobesent*afterAS_PATHornot-an
dwhenAS4_AGGREGATORwillbesend*inrelationshiptoAGGREGATOR.*So,tobedefensive,weare
notrelyingonanyorderandread*allattributesfirst,includingthese32bitones,andnow,*a
fterwards,welookwhatandifsomethingistobedoneforas4.**ItispossibletonothaveAS_PAT
H,e.g.GREoRandsole*MP_UNREACH_NLRI.*//*actually...thisdoesn'teverreturnfailurecu
rrently,but*bettersafethansorry*/if(CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR
_AS_PATH))&&bgp_attr_munge_as4_attrs(peer,attr,as4_path,as4_aggregator,&as4_aggr
egator_addr)){bgp_notify_send(peer,BGP_NOTIFY_UPDATE_ERR,BGP_NOTIFY_UPDATE_MAL_A
TTR);if(as4_path)aspath_unintern(&as4_path);returnBGP_ATTR_PARSE_ERROR;}/*Atthis
stage,wehavedoneallfiddlingwithas4,andthe*resultinginfoisinattr->aggregatorresp.
attr->aspath*sowecanchuckas4_aggregatorandas4_pathalltogetherin*ordertosavememor
y*/if(as4_path){aspath_unintern(&as4_path);/*unintern-itisinthehash*//*Theflagth
atwegotthisisstillthere,butthatdoesnot*doanytrouble*/}/**The"rest"ofthecodedoesn
othingwithas4_aggregator.*thereisnomemoryattachedspecificallywhichisnotpart*ofth
eattr.*soignoringjustmeansdonothing.*//**Finallydothechecksontheaspathwedidnotdo
yet*becausewewaitedforapotentiallysynthesizedaspath.*/if(attr->flag&(ATTR_FLAG_B
IT(BGP_ATTR_AS_PATH))){ret=bgp_attr_aspath_check(peer,attr);if(ret!=BGP_ATTR_PAR
SE_PROCEED)returnret;}/*Finallyinternunknownattribute.*/if(attr->transit)attr->t
ransit=transit_intern(attr->transit);if(attr->encap_subtlvs)attr->encap_subtlvs=
encap_intern(attr->encap_subtlvs,ENCAP_SUBTLV_TYPE);#ifENABLE_BGP_VNCif(attr->vn
c_subtlvs)attr->vnc_subtlvs=encap_intern(attr->vnc_subtlvs,VNC_SUBTLV_TYPE);#end
ifreturnBGP_ATTR_PARSE_PROCEED;}size_tbgp_packet_mpattr_start(structstream*s,str
uctpeer*peer,afi_tafi,safi_tsafi,structbpacket_attr_vec_arr*vecarr,structattr*at
tr){size_tsizep;iana_afi_tpkt_afi;iana_safi_tpkt_safi;afi_tnh_afi;/*Setextendedb
italwaystoencodetheattributelengthas2bytes*/stream_putc(s,BGP_ATTR_FLAG_OPTIONAL
|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_ATTR_MP_REACH_NLRI);sizep=stream_get_en
dp(s);stream_putw(s,0);/*Marker:Attributelength.*//*ConvertAFI,SAFItovaluesforpa
cket.*/bgp_map_afi_safi_int2iana(afi,safi,&pkt_afi,&pkt_safi);stream_putw(s,pkt_
afi);/*AFI*/stream_putc(s,pkt_safi);/*SAFI*//*NexthopAFI*/if(afi==AFI_IP&&(safi=
=SAFI_UNICAST||safi==SAFI_LABELED_UNICAST))nh_afi=peer_cap_enhe(peer,afi,safi)?A
FI_IP6:AFI_IP;elsenh_afi=BGP_NEXTHOP_AFI_FROM_NHLEN(attr->mp_nexthop_len);/*Next
hop*/bpacket_attr_vec_arr_set_vec(vecarr,BGP_ATTR_VEC_NH,s,attr);switch(nh_afi){
caseAFI_IP:switch(safi){caseSAFI_UNICAST:caseSAFI_MULTICAST:caseSAFI_LABELED_UNI
CAST:stream_putc(s,4);stream_put_ipv4(s,attr->nexthop.s_addr);break;caseSAFI_MPL
S_VPN:stream_putc(s,12);stream_putl(s,0);/*RD=0,perRFC*/stream_putl(s,0);stream_
put(s,&attr->mp_nexthop_global_in,4);break;caseSAFI_ENCAP:caseSAFI_EVPN:stream_p
utc(s,4);stream_put(s,&attr->mp_nexthop_global_in,4);break;caseSAFI_FLOWSPEC:str
eam_putc(s,0);/*nonexthopforflowspec*/default:break;}break;caseAFI_IP6:switch(sa
fi){caseSAFI_UNICAST:caseSAFI_MULTICAST:caseSAFI_LABELED_UNICAST:caseSAFI_EVPN:{
if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL){stream_putc(s,BGP_AT
TR_NHLEN_IPV6_GLOBAL_AND_LL);stream_put(s,&attr->mp_nexthop_global,IPV6_MAX_BYTE
LEN);stream_put(s,&attr->mp_nexthop_local,IPV6_MAX_BYTELEN);}else{stream_putc(s,
IPV6_MAX_BYTELEN);stream_put(s,&attr->mp_nexthop_global,IPV6_MAX_BYTELEN);}}brea
k;caseSAFI_MPLS_VPN:{if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL){stream
_putc(s,24);stream_putl(s,0);/*RD=0,perRFC*/stream_putl(s,0);stream_put(s,&attr-
>mp_nexthop_global,IPV6_MAX_BYTELEN);}elseif(attr->mp_nexthop_len==BGP_ATTR_NHLE
N_IPV6_GLOBAL_AND_LL){stream_putc(s,48);stream_putl(s,0);/*RD=0,perRFC*/stream_p
utl(s,0);stream_put(s,&attr->mp_nexthop_global,IPV6_MAX_BYTELEN);stream_putl(s,0
);/*RD=0,perRFC*/stream_putl(s,0);stream_put(s,&attr->mp_nexthop_local,IPV6_MAX_
BYTELEN);}}break;caseSAFI_ENCAP:stream_putc(s,IPV6_MAX_BYTELEN);stream_put(s,&at
tr->mp_nexthop_global,IPV6_MAX_BYTELEN);break;caseSAFI_FLOWSPEC:stream_putc(s,0)
;/*nonexthopforflowspec*/default:break;}break;default:if(safi!=SAFI_FLOWSPEC)zlo
g_err("Badnexthopwhensendingto%s,AFI%uSAFI%unhlen%d",peer->host,afi,safi,attr->m
p_nexthop_len);break;}/*SNPA*/stream_putc(s,0);returnsizep;}voidbgp_packet_mpatt
r_prefix(structstream*s,afi_tafi,safi_tsafi,structprefix*p,structprefix_rd*prd,m
pls_label_t*label,uint32_tnum_labels,intaddpath_encode,uint32_taddpath_tx_id,str
uctattr*attr){if(safi==SAFI_MPLS_VPN){if(addpath_encode)stream_putl(s,addpath_tx
_id);/*Label,RD,Prefixwrite.*/stream_putc(s,p->prefixlen+88);stream_put(s,label,
BGP_LABEL_BYTES);stream_put(s,prd->val,8);stream_put(s,&p->u.prefix,PSIZE(p->pre
fixlen));}elseif(afi==AFI_L2VPN&&safi==SAFI_EVPN){/*EVPNprefix-contentsdependont
ype*/bgp_evpn_encode_prefix(s,p,prd,label,num_labels,attr,addpath_encode,addpath
_tx_id);}elseif(safi==SAFI_LABELED_UNICAST){/*Prefixwritewithlabel.*/stream_put_
labeled_prefix(s,p,label);}elseif(safi==SAFI_FLOWSPEC){if(PSIZE(p->prefixlen)+2<
FLOWSPEC_NLRI_SIZELIMIT)stream_putc(s,PSIZE(p->prefixlen)+2);elsestream_putw(s,(
PSIZE(p->prefixlen)+2)|(0xf<<12));stream_putc(s,2);/*Filtertype*/stream_putc(s,p
->prefixlen);/*Prefixlength*/stream_put(s,&p->u.prefix,PSIZE(p->prefixlen));}els
estream_put_prefix_addpath(s,p,addpath_encode,addpath_tx_id);}size_tbgp_packet_m
pattr_prefix_size(afi_tafi,safi_tsafi,structprefix*p){intsize=PSIZE(p->prefixlen
);if(safi==SAFI_MPLS_VPN)size+=88;elseif(afi==AFI_L2VPN&&safi==SAFI_EVPN)size+=2
32;//TODO:Maximumpossiblefortype-2,type-3and//type-5returnsize;}/**Encodesthetun
nelencapsulationattribute,*andwithENABLE_BGP_VNCtheVNCattributewhichuses*almostt
hesameTLVformat*/staticvoidbgp_packet_mpattr_tea(structbgp*bgp,structpeer*peer,s
tructstream*s,structattr*attr,uint8_tattrtype){unsignedintattrlenfield=0;unsigne
dintattrhdrlen=0;structbgp_attr_encap_subtlv*subtlvs;structbgp_attr_encap_subtlv
*st;constchar*attrname;if(!attr||(attrtype==BGP_ATTR_ENCAP&&(!attr->encap_tunnel
type||attr->encap_tunneltype==BGP_ENCAP_TYPE_MPLS)))return;switch(attrtype){case
BGP_ATTR_ENCAP:attrname="TunnelEncap";subtlvs=attr->encap_subtlvs;if(subtlvs==NU
LL)/*nothingtodo*/return;/**Thetunnelencapattrhasan"outer"tlv.*T=tunneltype,*L=t
otallengthofsubtlvs,*V=concatenatedsubtlvs.*/attrlenfield=2+2;/*T+L*/attrhdrlen=
1+1;/*subTLVT+L*/break;#ifENABLE_BGP_VNCcaseBGP_ATTR_VNC:attrname="VNC";subtlvs=
attr->vnc_subtlvs;if(subtlvs==NULL)/*nothingtodo*/return;attrlenfield=0;/*nooute
rT+L*/attrhdrlen=2+2;/*subTLVT+L*/break;#endifdefault:assert(0);}/*computeattrle
ngth*/for(st=subtlvs;st;st=st->next){attrlenfield+=(attrhdrlen+st->length);}if(a
ttrlenfield>0xffff){zlog_info("%sattributeistoolong(length=%d),can'tsendit",attr
name,attrlenfield);return;}if(attrlenfield>0xff){/*2-octetlengthfield*/stream_pu
tc(s,BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_EXTLEN);stream_put
c(s,attrtype);stream_putw(s,attrlenfield&0xffff);}else{/*1-octetlengthfield*/str
eam_putc(s,BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,attrtype);s
tream_putc(s,attrlenfield&0xff);}if(attrtype==BGP_ATTR_ENCAP){/*writeouterT+L*/s
tream_putw(s,attr->encap_tunneltype);stream_putw(s,attrlenfield-4);}/*writeeachs
ub-tlv*/for(st=subtlvs;st;st=st->next){if(attrtype==BGP_ATTR_ENCAP){stream_putc(
s,st->type);stream_putc(s,st->length);#ifENABLE_BGP_VNC}else{stream_putw(s,st->t
ype);stream_putw(s,st->length);#endif}stream_put(s,st->value,st->length);}}voidb
gp_packet_mpattr_end(structstream*s,size_tsizep){/*SetMPattributelength.Don'tcou
ntthe(2)bytesusedtoencodetheattrlength*/stream_putw_at(s,sizep,(stream_get_endp(
s)-sizep)-2);}/*Makeattributepacket.*/bgp_size_tbgp_packet_attribute(structbgp*b
gp,structpeer*peer,structstream*s,structattr*attr,structbpacket_attr_vec_arr*vec
arr,structprefix*p,afi_tafi,safi_tsafi,structpeer*from,structprefix_rd*prd,mpls_
label_t*label,uint32_tnum_labels,intaddpath_encode,uint32_taddpath_tx_id){size_t
cp;size_taspath_sizep;structaspath*aspath;intsend_as4_path=0;intsend_as4_aggrega
tor=0;intuse32bit=(CHECK_FLAG(peer->cap,PEER_CAP_AS4_RCV))?1:0;if(!bgp)bgp=peer-
>bgp;/*Remembercurrentpointer.*/cp=stream_get_endp(s);if(p&&!((afi==AFI_IP&&safi
==SAFI_UNICAST)&&!peer_cap_enhe(peer,afi,safi))){size_tmpattrlen_pos=0;mpattrlen
_pos=bgp_packet_mpattr_start(s,peer,afi,safi,vecarr,attr);bgp_packet_mpattr_pref
ix(s,afi,safi,p,prd,label,num_labels,addpath_encode,addpath_tx_id,attr);bgp_pack
et_mpattr_end(s,mpattrlen_pos);}/*Originattribute.*/stream_putc(s,BGP_ATTR_FLAG_
TRANS);stream_putc(s,BGP_ATTR_ORIGIN);stream_putc(s,1);stream_putc(s,attr->origi
n);/*ASpathattribute.*//*Ifremote-peerisEBGP*/if(peer->sort==BGP_PEER_EBGP&&(!CH
ECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_AS_PATH_UNCHANGED)||attr->aspath->s
egments==NULL)&&(!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_RSERVER_CLIENT)
)){aspath=aspath_dup(attr->aspath);/*Eventhoughwemaynotbeconfiguredforconfederat
ionswe*mayhave*RXedanAS_PATHwithAS_CONFED_SEQUENCEorAS_CONFED_SET*/aspath=aspath
_delete_confed_seq(aspath);if(CHECK_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION)){
/*StuffourpathCONFED_IDonthefront*/aspath=aspath_add_seq(aspath,bgp->confed_id);
}else{if(peer->change_local_as){/*Ifreplace-asisspecified,weonlyusethechange_loc
al_aswhenadvertisingroutes.*/if(!CHECK_FLAG(peer->flags,PEER_FLAG_LOCAL_AS_REPLA
CE_AS)){aspath=aspath_add_seq(aspath,peer->local_as);}aspath=aspath_add_seq(aspa
th,peer->change_local_as);}else{aspath=aspath_add_seq(aspath,peer->local_as);}}}
elseif(peer->sort==BGP_PEER_CONFED){/*Aconfedmember,soweneedtodotheAS_CONFED_SEQ
UENCE*thing*/aspath=aspath_dup(attr->aspath);aspath=aspath_add_confed_seq(aspath
,peer->local_as);}elseaspath=attr->aspath;/*IfpeerisnotAS4capable,then:*-sendthe
createdAS_PATHoutasAS4_PATH(optional,transitive),*butensurethatnoAS_CONFED_SEQUE
NCEandAS_CONFED_SETpath*segment*typesareinit(i.e.excludethemiftheyarethere)*ANDd
othisonlyifthereisatleastoneasnum>65535inthe*path!*-sendanAS_PATHout,butput16Bit
ASnumsinit,not32bit,and*change*allASnums>65535toBGP_AS_TRANS*/stream_putc(s,BGP_
ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_ATTR_AS_PATH);aspath_siz
ep=stream_get_endp(s);stream_putw(s,0);stream_putw_at(s,aspath_sizep,aspath_put(
s,aspath,use32bit));/*OLDsessionmayneedNEW_AS_PATHsent,ifthereare4-byteASNs*inth
epath*/if(!use32bit&&aspath_has_as4(aspath))send_as4_path=1;/*we'lldothislater,a
tthecorrectplace*//*Nexthopattribute.*/if(afi==AFI_IP&&safi==SAFI_UNICAST&&!peer
_cap_enhe(peer,afi,safi)){if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP)){stream
_putc(s,BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_NEXT_HOP);bpacket_attr_vec_a
rr_set_vec(vecarr,BGP_ATTR_VEC_NH,s,attr);stream_putc(s,4);stream_put_ipv4(s,att
r->nexthop.s_addr);}elseif(peer_cap_enhe(from,afi,safi)){/**Likelythisisthecasew
henanIPv4prefixwas*receivedwith*ExtendedNext-hopcapabilityandnowbeingadvertised*
to*non-ENHEpeers.*Settingthemandatory(ipv4)next-hopattributehere*toenable*implic
itnext-hopselfwithcorrect(ipv4address*family).*/stream_putc(s,BGP_ATTR_FLAG_TRAN
S);stream_putc(s,BGP_ATTR_NEXT_HOP);bpacket_attr_vec_arr_set_vec(vecarr,BGP_ATTR
_VEC_NH,s,NULL);stream_putc(s,4);stream_put_ipv4(s,0);}}/*MEDattribute.*/if(attr
->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC)||bgp->maxmed_active){stream_putc(
s,BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_MULTI_EXIT_DISC);stream_putc(s,
4);stream_putl(s,(bgp->maxmed_active?bgp->maxmed_value:attr->med));}/*Localprefe
rence.*/if(peer->sort==BGP_PEER_IBGP||peer->sort==BGP_PEER_CONFED){stream_putc(s
,BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_LOCAL_PREF);stream_putc(s,4);stream
_putl(s,attr->local_pref);}/*Atomicaggregate.*/if(attr->flag&ATTR_FLAG_BIT(BGP_A
TTR_ATOMIC_AGGREGATE)){stream_putc(s,BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR
_ATOMIC_AGGREGATE);stream_putc(s,0);}/*Aggregator.*/if(attr->flag&ATTR_FLAG_BIT(
BGP_ATTR_AGGREGATOR)){/*CommontoBGP_ATTR_AGGREGATOR,regardlessofASNsize*/stream_
putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_AGGREG
ATOR);if(use32bit){/*AS4capablepeer*/stream_putc(s,8);stream_putl(s,attr->aggreg
ator_as);}else{/*2-byteASpeer*/stream_putc(s,6);/*IsASNrepresentablein2-bytes?Or
mustAS_TRANSbe*used?*/if(attr->aggregator_as>65535){stream_putw(s,BGP_AS_TRANS);
/*wehavetosendAS4_AGGREGATOR,too.*we'lldothatlaterinordertosend*attributesinasce
nding*order.*/send_as4_aggregator=1;}elsestream_putw(s,(uint16_t)attr->aggregato
r_as);}stream_put_ipv4(s,attr->aggregator_addr.s_addr);}/*Communityattribute.*/i
f(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_SEND_COMMUNITY)&&(attr->flag&AT
TR_FLAG_BIT(BGP_ATTR_COMMUNITIES))){if(attr->community->size*4>255){stream_putc(
s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s
,BGP_ATTR_COMMUNITIES);stream_putw(s,attr->community->size*4);}else{stream_putc(
s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_COMMUNITIES
);stream_putc(s,attr->community->size*4);}stream_put(s,attr->community->val,attr
->community->size*4);}/**LargeCommunityattribute.*/if(CHECK_FLAG(peer->af_flags[
afi][safi],PEER_FLAG_SEND_LARGE_COMMUNITY)&&(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_L
ARGE_COMMUNITIES))){if(lcom_length(attr->lcommunity)>255){stream_putc(s,BGP_ATTR
_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_ATTR_
LARGE_COMMUNITIES);stream_putw(s,lcom_length(attr->lcommunity));}else{stream_put
c(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_LARGE_COM
MUNITIES);stream_putc(s,lcom_length(attr->lcommunity));}stream_put(s,attr->lcomm
unity->val,lcom_length(attr->lcommunity));}/*RouteReflector.*/if(peer->sort==BGP
_PEER_IBGP&&from&&from->sort==BGP_PEER_IBGP){/*OriginatorID.*/stream_putc(s,BGP_
ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_ORIGINATOR_ID);stream_putc(s,4);if(at
tr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID))stream_put_in_addr(s,&attr->origi
nator_id);elsestream_put_in_addr(s,&from->remote_id);/*Clusterlist.*/stream_putc
(s,BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_CLUSTER_LIST);if(attr->cluster
){stream_putc(s,attr->cluster->length+4);/*Ifthispeerconfiguration'sparentBGPhas
*cluster_id.*/if(bgp->config&BGP_CONFIG_CLUSTER_ID)stream_put_in_addr(s,&bgp->cl
uster_id);elsestream_put_in_addr(s,&bgp->router_id);stream_put(s,attr->cluster->
list,attr->cluster->length);}else{stream_putc(s,4);/*Ifthispeerconfiguration'spa
rentBGPhas*cluster_id.*/if(bgp->config&BGP_CONFIG_CLUSTER_ID)stream_put_in_addr(
s,&bgp->cluster_id);elsestream_put_in_addr(s,&bgp->router_id);}}/*ExtendedCommun
itiesattribute.*/if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_SEND_EXT_COMM
UNITY)&&(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES))){if(peer->sort==BGP
_PEER_IBGP||peer->sort==BGP_PEER_CONFED){if(attr->ecommunity->size*8>255){stream
_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_
putc(s,BGP_ATTR_EXT_COMMUNITIES);stream_putw(s,attr->ecommunity->size*8);}else{s
tream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_
EXT_COMMUNITIES);stream_putc(s,attr->ecommunity->size*8);}stream_put(s,attr->eco
mmunity->val,attr->ecommunity->size*8);}else{uint8_t*pnt;inttbit;intecom_tr_size
=0;inti;for(i=0;i<attr->ecommunity->size;i++){pnt=attr->ecommunity->val+(i*8);tb
it=*pnt;if(CHECK_FLAG(tbit,ECOMMUNITY_FLAG_NON_TRANSITIVE))continue;ecom_tr_size
++;}if(ecom_tr_size){if(ecom_tr_size*8>255){stream_putc(s,BGP_ATTR_FLAG_OPTIONAL
|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_ATTR_EXT_COMMUNITIE
S);stream_putw(s,ecom_tr_size*8);}else{stream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_
ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_EXT_COMMUNITIES);stream_putc(s,ecom_tr_s
ize*8);}for(i=0;i<attr->ecommunity->size;i++){pnt=attr->ecommunity->val+(i*8);tb
it=*pnt;if(CHECK_FLAG(tbit,ECOMMUNITY_FLAG_NON_TRANSITIVE))continue;stream_put(s
,pnt,8);}}}}/*Labelindexattribute.*/if(safi==SAFI_LABELED_UNICAST){if(attr->flag
&ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID)){uint32_tlabel_index;label_index=attr->label
_index;if(label_index!=BGP_INVALID_LABEL_INDEX){stream_putc(s,BGP_ATTR_FLAG_OPTI
ONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_PREFIX_SID);stream_putc(s,10);s
tream_putc(s,BGP_PREFIX_SID_LABEL_INDEX);stream_putw(s,BGP_PREFIX_SID_LABEL_INDE
X_LENGTH);stream_putc(s,0);//reservedstream_putw(s,0);//flagsstream_putl(s,label
_index);}}}if(send_as4_path){/*IfthepeerisNOTAs4capable,AND*//*thereareASnums>65
535inpathTHEN*giveoutAS4_PATH*//*GetridofallAS_CONFED_SEQUENCEandAS_CONFED_SET*p
athsegments!*Hm,Iwonder...confederationthings*should*onlybeat*thebeginningofanas
path,right?Thenweshoulduse*aspath_delete_confed_seqforthis,becauseitisalready*th
ere!(JK)*Folks,talktome:whatisreasonablehere!?*/aspath=aspath_delete_confed_seq(
aspath);stream_putc(s,BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_E
XTLEN);stream_putc(s,BGP_ATTR_AS4_PATH);aspath_sizep=stream_get_endp(s);stream_p
utw(s,0);stream_putw_at(s,aspath_sizep,aspath_put(s,aspath,1));}if(aspath!=attr-
>aspath)aspath_free(aspath);if(send_as4_aggregator){/*sendAS4_AGGREGATOR,atthisp
lace*//*thissectionofcodemovedhereinordertoensurethe*correct**ascending*orderofa
ttributes*/stream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc
(s,BGP_ATTR_AS4_AGGREGATOR);stream_putc(s,8);stream_putl(s,attr->aggregator_as);
stream_put_ipv4(s,attr->aggregator_addr.s_addr);}if(((afi==AFI_IP||afi==AFI_IP6)
&&(safi==SAFI_ENCAP||safi==SAFI_MPLS_VPN))||(afi==AFI_L2VPN&&safi==SAFI_EVPN)){/
*TunnelEncapattribute*/bgp_packet_mpattr_tea(bgp,peer,s,attr,BGP_ATTR_ENCAP);#if
ENABLE_BGP_VNC/*VNCattribute*/bgp_packet_mpattr_tea(bgp,peer,s,attr,BGP_ATTR_VNC
);#endif}/*PMSITunnel*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_PMSI_TUNNEL)){stream
_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_PMSI_
TUNNEL);stream_putc(s,9);//Lengthstream_putc(s,0);//Flagsstream_putc(s,PMSI_TNLT
YPE_INGR_REPL);//IR(6)stream_put(s,&(attr->label),BGP_LABEL_BYTES);//MPLSLabel/V
XLANVNIstream_put_ipv4(s,attr->nexthop.s_addr);//UnicasttunnelendpointIPaddress}
/*Unknowntransitattribute.*/if(attr->transit)stream_put(s,attr->transit->val,att
r->transit->length);/*Returntotalsizeofattribute.*/returnstream_get_endp(s)-cp;}
size_tbgp_packet_mpunreach_start(structstream*s,afi_tafi,safi_tsafi){unsignedlon
gattrlen_pnt;iana_afi_tpkt_afi;iana_safi_tpkt_safi;/*Setextendedbitalwaystoencod
etheattributelengthas2bytes*/stream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_
EXTLEN);stream_putc(s,BGP_ATTR_MP_UNREACH_NLRI);attrlen_pnt=stream_get_endp(s);s
tream_putw(s,0);/*Lengthofthisattribute.*//*ConvertAFI,SAFItovaluesforpacket.*/b
gp_map_afi_safi_int2iana(afi,safi,&pkt_afi,&pkt_safi);stream_putw(s,pkt_afi);str
eam_putc(s,pkt_safi);returnattrlen_pnt;}voidbgp_packet_mpunreach_prefix(structst
ream*s,structprefix*p,afi_tafi,safi_tsafi,structprefix_rd*prd,mpls_label_t*label
,uint32_tnum_labels,intaddpath_encode,uint32_taddpath_tx_id,structattr*attr){uin
t8_twlabel[3]={0x80,0x00,0x00};if(safi==SAFI_LABELED_UNICAST){label=(mpls_label_
t*)wlabel;num_labels=1;}returnbgp_packet_mpattr_prefix(s,afi,safi,p,prd,label,nu
m_labels,addpath_encode,addpath_tx_id,attr);}voidbgp_packet_mpunreach_end(struct
stream*s,size_tattrlen_pnt){bgp_packet_mpattr_end(s,attrlen_pnt);}/*Initializati
onofattribute.*/voidbgp_attr_init(void){aspath_init();attrhash_init();community_
init();ecommunity_init();lcommunity_init();cluster_init();transit_init();encap_i
nit();}voidbgp_attr_finish(void){aspath_finish();attrhash_finish();community_fin
ish();ecommunity_finish();lcommunity_finish();cluster_finish();transit_finish();
encap_finish();}/*Makeattributepacket.*/voidbgp_dump_routes_attr(structstream*s,
structattr*attr,structprefix*prefix){unsignedlongcp;unsignedlonglen;size_taspath
_lenp;structaspath*aspath;intaddpath_encode=0;uint32_taddpath_tx_id=0;/*Remember
currentpointer.*/cp=stream_get_endp(s);/*Placeholderoflength.*/stream_putw(s,0);
/*Originattribute.*/stream_putc(s,BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_OR
IGIN);stream_putc(s,1);stream_putc(s,attr->origin);aspath=attr->aspath;stream_pu
tc(s,BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_ATTR_AS_PATH);a
spath_lenp=stream_get_endp(s);stream_putw(s,0);stream_putw_at(s,aspath_lenp,aspa
th_put(s,aspath,1));/*Nexthopattribute.*//*Ifit'sanIPv6prefix,don'tdumptheIPv4ne
xthoptosavespace*/if(prefix!=NULL&&prefix->family!=AF_INET6){stream_putc(s,BGP_A
TTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_NEXT_HOP);stream_putc(s,4);stream_put_ipv
4(s,attr->nexthop.s_addr);}/*MEDattribute.*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR
_MULTI_EXIT_DISC)){stream_putc(s,BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_
MULTI_EXIT_DISC);stream_putc(s,4);stream_putl(s,attr->med);}/*Localpreference.*/
if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)){stream_putc(s,BGP_ATTR_FLAG_TR
ANS);stream_putc(s,BGP_ATTR_LOCAL_PREF);stream_putc(s,4);stream_putl(s,attr->loc
al_pref);}/*Atomicaggregate.*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ATOMIC_AGGREG
ATE)){stream_putc(s,BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_ATOMIC_AGGREGATE
);stream_putc(s,0);}/*Aggregator.*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_AGGREGAT
OR)){stream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP
_ATTR_AGGREGATOR);stream_putc(s,8);stream_putl(s,attr->aggregator_as);stream_put
_ipv4(s,attr->aggregator_addr.s_addr);}/*Communityattribute.*/if(attr->flag&ATTR
_FLAG_BIT(BGP_ATTR_COMMUNITIES)){if(attr->community->size*4>255){stream_putc(s,B
GP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BG
P_ATTR_COMMUNITIES);stream_putw(s,attr->community->size*4);}else{stream_putc(s,B
GP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_COMMUNITIES);s
tream_putc(s,attr->community->size*4);}stream_put(s,attr->community->val,attr->c
ommunity->size*4);}/*LargeCommunityattribute.*/if(attr->flag&ATTR_FLAG_BIT(BGP_A
TTR_LARGE_COMMUNITIES)){if(lcom_length(attr->lcommunity)>255){stream_putc(s,BGP_
ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS|BGP_ATTR_FLAG_EXTLEN);stream_putc(s,BGP_A
TTR_LARGE_COMMUNITIES);stream_putw(s,lcom_length(attr->lcommunity));}else{stream
_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);stream_putc(s,BGP_ATTR_LARGE
_COMMUNITIES);stream_putc(s,lcom_length(attr->lcommunity));}stream_put(s,attr->l
community->val,lcom_length(attr->lcommunity));}/*AddaMP_NLRIattributetodumptheIP
v6nexthop*/if(prefix!=NULL&&prefix->family==AF_INET6&&(attr->mp_nexthop_len==BGP
_ATTR_NHLEN_IPV6_GLOBAL||attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL
)){intsizep;stream_putc(s,BGP_ATTR_FLAG_OPTIONAL);stream_putc(s,BGP_ATTR_MP_REAC
H_NLRI);sizep=stream_get_endp(s);/*MPheader*/stream_putc(s,0);/*Marker:Attribute
length.*/stream_putw(s,AFI_IP6);/*AFI*/stream_putc(s,SAFI_UNICAST);/*SAFI*//*Nex
thop*/stream_putc(s,attr->mp_nexthop_len);stream_put(s,&attr->mp_nexthop_global,
IPV6_MAX_BYTELEN);if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL)str
eam_put(s,&attr->mp_nexthop_local,IPV6_MAX_BYTELEN);/*SNPA*/stream_putc(s,0);/*P
refix*/stream_put_prefix_addpath(s,prefix,addpath_encode,addpath_tx_id);/*SetMPa
ttributelength.*/stream_putc_at(s,sizep,(stream_get_endp(s)-sizep)-1);}/*PrefixS
ID*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID)){if(attr->label_index!=BGP_
INVALID_LABEL_INDEX){stream_putc(s,BGP_ATTR_FLAG_OPTIONAL|BGP_ATTR_FLAG_TRANS);s
tream_putc(s,BGP_ATTR_PREFIX_SID);stream_putc(s,10);stream_putc(s,BGP_PREFIX_SID
_LABEL_INDEX);stream_putc(s,BGP_PREFIX_SID_LABEL_INDEX_LENGTH);stream_putc(s,0);
//reservedstream_putw(s,0);//flagsstream_putl(s,attr->label_index);}}/*Returntot
alsizeofattribute.*/len=stream_get_endp(s)-cp-2;stream_putw_at(s,cp,len);}