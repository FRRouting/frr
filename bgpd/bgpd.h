/*BGPmessagedefinitionheader.*Copyright(C)1996,97,98,99,2000KunihiroIshiguro**Th
isfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify
it*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundat
ion;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthe
hopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*ME
RCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformor
edetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisp
rogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Franklin
St,FifthFloor,Boston,MA02110-1301USA*/#ifndef_QUAGGA_BGPD_H#define_QUAGGA_BGPD_H
#include"qobj.h"#include<pthread.h>#include"lib/json.h"#include"vrf.h"#include"v
ty.h"/*Forunionsockunion.*/#include"queue.h"#include"sockunion.h"#include"routem
ap.h"#include"linklist.h"#include"defaults.h"#include"bgp_memory.h"#include"bitf
ield.h"#include"vxlan.h"#defineBGP_MAX_HOSTNAME64/*Linuxmax,islargerthanmostothe
rsys*/#defineBGP_PEER_MAX_HASH_SIZE16384/*DefaultintervalforIPv6RAswhentriggered
byBGPunnumberedneighbor.*/#defineBGP_UNNUM_DEFAULT_RA_INTERVAL10structupdate_sub
group;structbpacket;/**AllowtheneighborXXXXremote-astotakeinternalorexternal*AS_
SPECIFIEDiszerotoauto-inheritoriginalnon-feature/enhancement*behavior*inthesyste
m.*/enum{AS_UNSPECIFIED=0,AS_SPECIFIED,AS_INTERNAL,AS_EXTERNAL,};/*TypedefBGPspe
cifictypes.*/typedefuint32_tas_t;typedefuint16_tas16_t;/*wemaystillencounter16Bi
tasnums*/typedefuint16_tbgp_size_t;#definemax(a,b)\({\__typeof__(a)_a=(a);\__typ
eof__(b)_b=(b);\_a>_b?_a:_b;\})enumbgp_af_index{BGP_AF_START,BGP_AF_IPV4_UNICAST
=BGP_AF_START,BGP_AF_IPV4_MULTICAST,BGP_AF_IPV4_VPN,BGP_AF_IPV6_UNICAST,BGP_AF_I
PV6_MULTICAST,BGP_AF_IPV6_VPN,BGP_AF_IPV4_ENCAP,BGP_AF_IPV6_ENCAP,BGP_AF_L2VPN_E
VPN,BGP_AF_IPV4_LBL_UNICAST,BGP_AF_IPV6_LBL_UNICAST,BGP_AF_IPV4_FLOWSPEC,BGP_AF_
IPV6_FLOWSPEC,BGP_AF_MAX};#defineAF_FOREACH(af)for((af)=BGP_AF_START;(af)<BGP_AF
_MAX;(af)++)#defineFOREACH_AFI_SAFI(afi,safi)\for(afi=AFI_IP;afi<AFI_MAX;afi++)\
for(safi=SAFI_UNICAST;safi<SAFI_MAX;safi++)/*BGPmasterforsystemwideconfiguration
sandvariables.*/structbgp_master{/*BGPinstancelist.*/structlist*bgp;/*BGPthreadm
aster.*/structthread_master*master;/*BGPpthreads.*/#definePTHREAD_IO(1<<1)#defin
ePTHREAD_KEEPALIVES(1<<2)/*workqueues*/structwork_queue*process_main_queue;/*Lis
teningsockets*/structlist*listen_sockets;/*BGPportnumber.*/uint16_tport;/*Listen
eraddress*/char*address;/*BGPstarttime.*/time_tstart_time;/*VariousBGPglobalconf
iguration.*/uint8_toptions;#defineBGP_OPT_NO_FIB(1<<0)#defineBGP_OPT_MULTIPLE_IN
STANCE(1<<1)#defineBGP_OPT_CONFIG_CISCO(1<<2)#defineBGP_OPT_NO_LISTEN(1<<3)uint6
4_tupdgrp_idspace;uint64_tsubgrp_idspace;/*timertodampenroutemapchanges*/structt
hread*t_rmap_update;/*Handleroutemapupdates*/uint32_trmap_update_timer;/*Routema
pupdatetimer*/#defineRMAP_DEFAULT_UPDATE_TIMER5/*disabledbydefault*//*Idspacefor
automaticRDderivationforanEVI/VRF*/bitfield_trd_idspace;QOBJ_FIELDS};DECLARE_QOB
J_TYPE(bgp_master)/*BGProute-mapstructure.*/structbgp_rmap{char*name;structroute
_map*map;};structbgp_redist{unsignedshortinstance;/*BGPredistributemetricconfigu
ration.*/uint8_tredist_metric_flag;uint32_tredist_metric;/*BGPredistributeroute-
map.*/structbgp_rmaprmap;};typedefenum{BGP_VPN_POLICY_DIR_FROMVPN=0,BGP_VPN_POLI
CY_DIR_TOVPN=1,BGP_VPN_POLICY_DIR_MAX=2}vpn_policy_direction_t;/**Typeof'structb
gp'.*-Default:Thedefaultinstance*-VRF:Aspecific(non-default)VRF*-View:Aninstance
usedforrouteexchange*The"default"instanceistreatedseparatelytosimplifythecode.No
te*thatifdeployedinaMulti-VRFenvironment,itmaynotexist.*/enumbgp_instance_type{B
GP_INSTANCE_TYPE_DEFAULT,BGP_INSTANCE_TYPE_VRF,BGP_INSTANCE_TYPE_VIEW};/*BGPinst
ancestructure.*/structbgp{/*ASnumberofthisBGPinstance.*/as_tas;/*NameofthisBGPin
stance.*/char*name;/*TypeofinstanceandVRFid.*/enumbgp_instance_typeinst_type;vrf
_id_tvrf_id;/*Referencecounttoallowpeer_deletetofinishafterbgp_delete*/intlock;/
*Selfpeer.*/structpeer*peer_self;/*BGPpeer.*/structlist*peer;structhash*peerhash
;/*BGPpeergroup.*/structlist*group;/*ThemaximumnumberofBGPdynamicneighborsthatca
nbecreated*/intdynamic_neighbors_limit;/*ThecurrentnumberofBGPdynamicneighbors*/
intdynamic_neighbors_count;structhash*update_groups[BGP_AF_MAX];/**Globalstatist
icsforupdategroups.*/struct{uint32_tjoin_events;uint32_tprune_events;uint32_tmer
ge_events;uint32_tsplit_events;uint32_tupdgrp_switch_events;uint32_tpeer_refresh
es_combined;uint32_tadj_count;uint32_tmerge_checks_triggered;uint32_tupdgrps_cre
ated;uint32_tupdgrps_deleted;uint32_tsubgrps_created;uint32_tsubgrps_deleted;}up
date_group_stats;/*BGPconfiguration.*/uint16_tconfig;#defineBGP_CONFIG_CLUSTER_I
D(1<<0)#defineBGP_CONFIG_CONFEDERATION(1<<1)/*BGProuteridentifier.*/structin_add
rrouter_id;structin_addrrouter_id_static;structin_addrrouter_id_zebra;/*BGProute
reflectorclusterID.*/structin_addrcluster_id;/*BGPconfederationinformation.*/as_
tconfed_id;as_t*confed_peers;intconfed_peers_cnt;structthread*t_startup;/*start-
uptimerononlyonceatthebeginning*/uint32_tv_maxmed_onstartup;/*Durationofmax-medo
nstart-up*/#defineBGP_MAXMED_ONSTARTUP_UNCONFIGURED0/*0meansoff,itsthedefault*/u
int32_tmaxmed_onstartup_value;/*Max-medvaluewhenactiveonstart-up*/structthread*t
_maxmed_onstartup;/*non-nullwhenmax-medonstartupison*/uint8_tmaxmed_onstartup_ov
er;/*Flagtomakeiteffectiveonlyonce*/uint8_tv_maxmed_admin;/*1/0ifmax-medadminist
rativeison/off*/#defineBGP_MAXMED_ADMIN_UNCONFIGURED0/*Offbydefault*/uint32_tmax
med_admin_value;/*Max-medvaluewhenadministrativeinon*/#defineBGP_MAXMED_VALUE_DE
FAULT4294967294/*Maximumbydefault*/uint8_tmaxmed_active;/*1/0ifmax-medisactiveor
not*/uint32_tmaxmed_value;/*Max-medvaluewhenitsactive*//*BGPupdatedelayonstartup
*/structthread*t_update_delay;structthread*t_establish_wait;uint8_tupdate_delay_
over;uint8_tmain_zebra_update_hold;uint8_tmain_peers_update_hold;uint16_tv_updat
e_delay;uint16_tv_establish_wait;charupdate_delay_begin_time[64];charupdate_dela
y_end_time[64];charupdate_delay_zebra_resume_time[64];charupdate_delay_peers_res
ume_time[64];uint32_testablished;uint32_trestarted_peers;uint32_timplicit_eors;u
int32_texplicit_eors;#defineBGP_UPDATE_DELAY_DEF0#defineBGP_UPDATE_DELAY_MIN0#de
fineBGP_UPDATE_DELAY_MAX3600/*BGPflags.*/uint32_tflags;#defineBGP_FLAG_ALWAYS_CO
MPARE_MED(1<<0)#defineBGP_FLAG_DETERMINISTIC_MED(1<<1)#defineBGP_FLAG_MED_MISSIN
G_AS_WORST(1<<2)#defineBGP_FLAG_MED_CONFED(1<<3)#defineBGP_FLAG_NO_DEFAULT_IPV4(
1<<4)#defineBGP_FLAG_NO_CLIENT_TO_CLIENT(1<<5)#defineBGP_FLAG_ENFORCE_FIRST_AS(1
<<6)#defineBGP_FLAG_COMPARE_ROUTER_ID(1<<7)#defineBGP_FLAG_ASPATH_IGNORE(1<<8)#d
efineBGP_FLAG_IMPORT_CHECK(1<<9)#defineBGP_FLAG_NO_FAST_EXT_FAILOVER(1<<10)#defi
neBGP_FLAG_LOG_NEIGHBOR_CHANGES(1<<11)#defineBGP_FLAG_GRACEFUL_RESTART(1<<12)#de
fineBGP_FLAG_ASPATH_CONFED(1<<13)#defineBGP_FLAG_ASPATH_MULTIPATH_RELAX(1<<14)#d
efineBGP_FLAG_RR_ALLOW_OUTBOUND_POLICY(1<<15)#defineBGP_FLAG_DISABLE_NH_CONNECTE
D_CHK(1<<16)#defineBGP_FLAG_MULTIPATH_RELAX_AS_SET(1<<17)#defineBGP_FLAG_FORCE_S
TATIC_PROCESS(1<<18)#defineBGP_FLAG_SHOW_HOSTNAME(1<<19)#defineBGP_FLAG_GR_PRESE
RVE_FWD(1<<20)#defineBGP_FLAG_GRACEFUL_SHUTDOWN(1<<21)/*BGPPerAFflags*/uint16_ta
f_flags[AFI_MAX][SAFI_MAX];#defineBGP_CONFIG_DAMPENING(1<<0)#defineBGP_CONFIG_VR
F_TO_MPLSVPN_EXPORT(1<<1)#defineBGP_CONFIG_MPLSVPN_TO_VRF_IMPORT(1<<2)/*l2vpnevp
nflags-1<<0isusedforDAMPENNG*/#defineBGP_L2VPN_EVPN_ADVERTISE_IPV4_UNICAST(1<<1)
#defineBGP_L2VPN_EVPN_ADVERTISE_IPV6_UNICAST(1<<2)#defineBGP_L2VPN_EVPN_DEFAULT_
ORIGINATE_IPV4(1<<3)#defineBGP_L2VPN_EVPN_DEFAULT_ORIGINATE_IPV6(1<<4)/*Routetab
lefornext-hoplookupcache.*/structbgp_table*nexthop_cache_table[AFI_MAX];/*Routet
ableforimport-check*/structbgp_table*import_check_table[AFI_MAX];structbgp_table
*connected_table[AFI_MAX];structhash*address_hash;/*DBforalllocaltunnel-ips-used
mainlyformartianchecksCurrentlyitonlyhasallVxLantunnelIPs*/structhash*tip_hash;/
*Staticrouteconfiguration.*/structbgp_table*route[AFI_MAX][SAFI_MAX];/*Aggregate
addressconfiguration.*/structbgp_table*aggregate[AFI_MAX][SAFI_MAX];/*BGProuting
informationbase.*/structbgp_table*rib[AFI_MAX][SAFI_MAX];/*BGPtableroute-map.*/s
tructbgp_rmaptable_map[AFI_MAX][SAFI_MAX];/*BGPredistributeconfiguration.*/struc
tlist*redist[AFI_MAX][ZEBRA_ROUTE_MAX];/*AllocateMPLSlabels*/uint8_tallocate_mpl
s_labels[AFI_MAX][SAFI_MAX];/*timertore-evaluateneighbordefault-originateroute-m
aps*/structthread*t_rmap_def_originate_eval;#defineRMAP_DEFAULT_ORIGINATE_EVAL_T
IMER5/*BGPdistanceconfiguration.*/uint8_tdistance_ebgp[AFI_MAX][SAFI_MAX];uint8_
tdistance_ibgp[AFI_MAX][SAFI_MAX];uint8_tdistance_local[AFI_MAX][SAFI_MAX];/*BGP
defaultlocal-preference.*/uint32_tdefault_local_pref;/*BGPdefaultsubgrouppktqueu
emax*/uint32_tdefault_subgroup_pkt_queue_max;/*BGPdefaulttimer.*/uint32_tdefault
_holdtime;uint32_tdefault_keepalive;/*BGPgracefulrestart*/uint32_trestart_time;u
int32_tstalepath_time;/*Maximum-pathsconfiguration*/structbgp_maxpaths_cfg{uint1
6_tmaxpaths_ebgp;uint16_tmaxpaths_ibgp;uint16_tibgp_flags;#defineBGP_FLAG_IBGP_M
ULTIPATH_SAME_CLUSTERLEN(1<<0)}maxpaths[AFI_MAX][SAFI_MAX];_Atomicuint32_twpkt_q
uanta;//max#packetstowriteperi/ocycle_Atomicuint32_trpkt_quanta;//max#packetstor
eadperi/ocycle/*Automaticcoalesceadjuston/off*/boolheuristic_coalesce;/*Actualco
alescetime*/uint32_tcoalesce_time;/*Auto-shutdownnewpeers*/boolautoshutdown;uint
32_taddpath_tx_id;intaddpath_tx_used[AFI_MAX][SAFI_MAX];#ifENABLE_BGP_VNCstructr
fapi_cfg*rfapi_cfg;structrfapi*rfapi;#endif/*EVPNrelatedinformation*//*EVIhashta
ble*/structhash*vnihash;/*EVPNenable-advertisegatewaymaciproutes*/intadvertise_g
w_macip;/*EVPNenable-advertiselocalVNIsandtheirMACsetc.*/intadvertise_all_vni;/*
HashtableofImportRTstoEVIs*/structhash*import_rt_hash;/*HashtableofVRFimportRTst
oVRFs*/structhash*vrf_import_rt_hash;/*L3-VNIcorrespondingtothisvrf*/vni_tl3vni;
/*router-mactobeusedinmac-iproutesforthisvrf*/structethaddrrmac;/*originatorip-t
obeusedasNHfortype-5routes*/structin_addroriginator_ip;/*vrfflags*/uint32_tvrf_f
lags;#defineBGP_VRF_AUTO(1<<0)#defineBGP_VRF_IMPORT_RT_CFGD(1<<1)#defineBGP_VRF_
EXPORT_RT_CFGD(1<<2)#defineBGP_VRF_RD_CFGD(1<<3)#defineBGP_VRF_L3VNI_PREFIX_ROUT
ES_ONLY(1<<4)/*uniqueIDforautoderivationofRDforthisvrf*/uint16_tvrf_rd_id;/*RDfo
rthisVRF*/structprefix_rdvrf_prd;/*importrtlistforthevrfinstance*/structlist*vrf
_import_rtl;/*exportrtlistforthevrfinstance*/structlist*vrf_export_rtl;/*listofc
orrespondingl2vnis(structbgpevpn)*/structlist*l2vnis;/*routemapforadvertiseipv4/
ipv6unicast(type-5routes)*/structbgp_rmapadv_cmd_rmap[AFI_MAX][SAFI_MAX];/*vpn-p
olicy*/struct{structecommunity*rtlist[BGP_VPN_POLICY_DIR_MAX];structecommunity*i
mport_redirect_rtlist;char*rmap_name[BGP_VPN_POLICY_DIR_MAX];structroute_map*rma
p[BGP_VPN_POLICY_DIR_MAX];/*shouldbempls_label_t?*/uint32_ttovpn_label;/*maybeMP
LS_LABEL_NONE*/uint32_ttovpn_zebra_vrf_label_last_sent;structprefix_rdtovpn_rd;s
tructprefixtovpn_nexthop;/*unset=>setto0*/uint32_tflags;#defineBGP_VPN_POLICY_TO
VPN_RD_SET0x00000004#defineBGP_VPN_POLICY_TOVPN_NEXTHOP_SET0x00000008}vpn_policy
[AFI_MAX];QOBJ_FIELDS};DECLARE_QOBJ_TYPE(bgp)#defineBGP_ROUTE_ADV_HOLD(bgp)(bgp-
>main_peers_update_hold)#defineIS_BGP_INST_KNOWN_TO_ZEBRA(bgp)\(bgp->inst_type==
BGP_INSTANCE_TYPE_DEFAULT\||(bgp->inst_type==BGP_INSTANCE_TYPE_VRF\&&bgp->vrf_id
!=VRF_UNKNOWN))/*BGPpeer-groupsupport.*/structpeer_group{/*Nameofthepeer-group.*
/char*name;/*PointertoBGP.*/structbgp*bgp;/*Peer-groupclientlist.*/structlist*pe
er;/**Dynamicneighborlisteningranges*/structlist*listen_range[AFI_MAX];/*Peer-gr
oupconfig*/structpeer*conf;};/*BGPNotifymessageformat.*/structbgp_notify{uint8_t
code;uint8_tsubcode;char*data;bgp_size_tlength;uint8_t*raw_data;};/*Nexthopselfa
ddress.*/structbgp_nexthop{structinterface*ifp;structin_addrv4;structin6_addrv6_
global;structin6_addrv6_local;};/*BGPaddpathvalues*/#defineBGP_ADDPATH_RX1#defin
eBGP_ADDPATH_TX2#defineBGP_ADDPATH_ID_LEN4#defineBGP_ADDPATH_TX_ID_FOR_DEFAULT_O
RIGINATE1/*BGProuterdistinguishervalue.*/#defineBGP_RD_SIZE8structbgp_rd{uint8_t
val[BGP_RD_SIZE];};#defineRMAP_IN0#defineRMAP_OUT1#defineRMAP_MAX2#include"filte
r.h"/*BGPfilterstructure.*/structbgp_filter{/*Distribute-list.*/struct{char*name
;structaccess_list*alist;}dlist[FILTER_MAX];/*Prefix-list.*/struct{char*name;str
uctprefix_list*plist;}plist[FILTER_MAX];/*Filter-list.*/struct{char*name;structa
s_list*aslist;}aslist[FILTER_MAX];/*Route-map.*/struct{char*name;structroute_map
*map;}map[RMAP_MAX];/*Unsuppress-map.*/struct{char*name;structroute_map*map;}usm
ap;};/*IBGP/EBGPidentifier.WealsohaveaCONFEDpeer,whichistosay,apeerwho'sASispart
ofourConfederation.*/typedefenum{BGP_PEER_IBGP=1,BGP_PEER_EBGP,BGP_PEER_INTERNAL
,BGP_PEER_CONFED,}bgp_peer_sort_t;/*BGPmessageheaderandpacketsize.*/#defineBGP_M
ARKER_SIZE16#defineBGP_HEADER_SIZE19#defineBGP_MAX_PACKET_SIZE4096#defineBGP_MAX
_PACKET_SIZE_OVERFLOW1024/**Triggerdelayforbgp_announce_route().*/#defineBGP_ANN
OUNCE_ROUTE_SHORT_DELAY_MS100#defineBGP_ANNOUNCE_ROUTE_DELAY_MS500structpeer_af{
/*backpointertothepeer*/structpeer*peer;/*whichsubgroupthepeer_afbelongsto*/stru
ctupdate_subgroup*subgroup;/*forbeingpartofanupdatesubgroup'speerlist*/LIST_ENTR
Y(peer_af)subgrp_train;/*forbeingpartofapacket'speerlist*/LIST_ENTRY(peer_af)pkt
_train;structbpacket*next_pkt_to_send;/**Triggertimerforbgp_announce_route().*/s
tructthread*t_announce_route;afi_tafi;safi_tsafi;intafid;};/*BGPneighborstructur
e.*/structpeer{/*BGPstructure.*/structbgp*bgp;/*referencecount,primarilytoallowb
gp_process'ingofroute_node's*tobedoneafterastructpeerisdeleted.**named'lock'forh
ystericalreasonswithinQuagga.*/intlock;/*BGPpeergroup.*/structpeer_group*group;u
int64_tversion[AFI_MAX][SAFI_MAX];/*BGPpeer_afstructures,perconfiguredAFonthispe
er*/structpeer_af*peer_af_array[BGP_AF_MAX];/*Peer'sremoteASnumber.*/intas_type;
as_tas;/*Peer'slocalASnumber.*/as_tlocal_as;bgp_peer_sort_tsort;/*Peer'sChangelo
calASnumber.*/as_tchange_local_as;/*RemoterouterID.*/structin_addrremote_id;/*Lo
calrouterID.*/structin_addrlocal_id;/*Packetreceiveandsendbuffer.*/pthread_mutex
_tio_mtx;//guardsibuf,obufstructstream_fifo*ibuf;//packetswaitingtobeprocessedst
ructstream_fifo*obuf;//packetswaitingtobewrittenstructringbuf*ibuf_work;//WiPbuf
ferusedbybgp_read()onlystructstream*obuf_work;//WiPbufferusedtoconstructpacketss
tructstream*curr;//thecurrentpacketbeingparsed/*WeuseaseparatestreamtoencodeMP_R
EACH_NLRIforefficient*NLRIpacking.peer->obuf_workstoresalltheotherattributes.The
*actualpacketisthenconstructedbyconcatenatingthetwo.*/structstream*scratch;/*the
doppelgangerpeerstructure,duetodualTCPconnsetup*/structpeer*doppelganger;/*Statu
softhepeer.*/intstatus;intostatus;/*FSMevents,storedfordebugpurposes.*Note:uchar
usedforreducedmemoryusage.*/unsignedcharcur_event;unsignedcharlast_event;unsigne
dcharlast_major_event;/*Peerindex,usedfordumpingTABLE_DUMP_V2format*/uint16_ttab
le_dump_index;/*Peerinformation*/intfd;/*Filedescriptor*/intttl;/*TTLofTCPconnec
tiontothepeer.*/intrtt;/*Estimatedround-trip-timefromTCP_INFO*/intgtsm_hops;/*mi
nimumhopcounttopeer*/char*desc;/*Descriptionofthepeer.*/unsignedshortport;/*Dest
inationportforpeer*/char*host;/*Printableaddressofthepeer.*/unionsockunionsu;/*S
ockunionaddressofthepeer.*/#defineBGP_PEER_SU_UNSPEC(peer)(peer->su.sa.sa_family
==AF_UNSPEC)time_tuptime;/*LastUp/Downtime*/time_treadtime;/*Lastreadtime*/time_
tresettime;/*Lastresettime*/char*conf_if;/*neighborinterfaceconfigname.*/structi
nterface*ifp;/*correspondinginterface*/char*ifname;/*bindinterfacename.*/char*up
date_if;unionsockunion*update_source;unionsockunion*su_local;/*Sockunionoflocala
ddress.*/unionsockunion*su_remote;/*Sockunionofremoteaddress.*/intshared_network
;/*Isthispeersharedsamenetwork.*/structbgp_nexthopnexthop;/*Nexthop*//*Peeraddre
ssfamilyconfiguration.*/uint8_tafc[AFI_MAX][SAFI_MAX];uint8_tafc_nego[AFI_MAX][S
AFI_MAX];uint8_tafc_adv[AFI_MAX][SAFI_MAX];uint8_tafc_recv[AFI_MAX][SAFI_MAX];/*
Capabilityflags(resetinbgp_stop)*/uint32_tcap;#definePEER_CAP_REFRESH_ADV(1<<0)/
*refreshadvertised*/#definePEER_CAP_REFRESH_OLD_RCV(1<<1)/*refresholdreceived*/#
definePEER_CAP_REFRESH_NEW_RCV(1<<2)/*refreshrfcreceived*/#definePEER_CAP_DYNAMI
C_ADV(1<<3)/*dynamicadvertised*/#definePEER_CAP_DYNAMIC_RCV(1<<4)/*dynamicreceiv
ed*/#definePEER_CAP_RESTART_ADV(1<<5)/*restartadvertised*/#definePEER_CAP_RESTAR
T_RCV(1<<6)/*restartreceived*/#definePEER_CAP_AS4_ADV(1<<7)/*as4advertised*/#def
inePEER_CAP_AS4_RCV(1<<8)/*as4received*/#definePEER_CAP_RESTART_BIT_ADV(1<<9)/*s
entrestartstate*/#definePEER_CAP_RESTART_BIT_RCV(1<<10)/*peerrestartstate*/#defi
nePEER_CAP_ADDPATH_ADV(1<<11)/*addpathadvertised*/#definePEER_CAP_ADDPATH_RCV(1<
<12)/*addpathreceived*/#definePEER_CAP_ENHE_ADV(1<<13)/*Extendednexthopadvertise
d*/#definePEER_CAP_ENHE_RCV(1<<14)/*Extendednexthopreceived*/#definePEER_CAP_HOS
TNAME_ADV(1<<15)/*hostnameadvertised*/#definePEER_CAP_HOSTNAME_RCV(1<<16)/*hostn
amereceived*//*Capabilityflags(resetinbgp_stop)*/uint32_taf_cap[AFI_MAX][SAFI_MA
X];#definePEER_CAP_ORF_PREFIX_SM_ADV(1<<0)/*send-modeadvertised*/#definePEER_CAP
_ORF_PREFIX_RM_ADV(1<<1)/*receive-modeadvertised*/#definePEER_CAP_ORF_PREFIX_SM_
RCV(1<<2)/*send-modereceived*/#definePEER_CAP_ORF_PREFIX_RM_RCV(1<<3)/*receive-m
odereceived*/#definePEER_CAP_ORF_PREFIX_SM_OLD_RCV(1<<4)/*send-modereceived*/#de
finePEER_CAP_ORF_PREFIX_RM_OLD_RCV(1<<5)/*receive-modereceived*/#definePEER_CAP_
RESTART_AF_RCV(1<<6)/*gracefulrestartafi/safireceived*/#definePEER_CAP_RESTART_A
F_PRESERVE_RCV(1<<7)/*gracefulrestartafi/safiF-bitreceived*/#definePEER_CAP_ADDP
ATH_AF_TX_ADV(1<<8)/*addpathtxadvertised*/#definePEER_CAP_ADDPATH_AF_TX_RCV(1<<9
)/*addpathtxreceived*/#definePEER_CAP_ADDPATH_AF_RX_ADV(1<<10)/*addpathrxadverti
sed*/#definePEER_CAP_ADDPATH_AF_RX_RCV(1<<11)/*addpathrxreceived*/#definePEER_CA
P_ENHE_AF_ADV(1<<12)/*Extendednexthopiafi/safiadvertised*/#definePEER_CAP_ENHE_A
F_RCV(1<<13)/*Extendednexthopafi/safireceived*/#definePEER_CAP_ENHE_AF_NEGO(1<<1
4)/*Extendednexthopafi/safinegotiated*//*Globalconfigurationflags.*/uint32_tflag
s;#definePEER_FLAG_PASSIVE(1<<0)/*passivemode*/#definePEER_FLAG_SHUTDOWN(1<<1)/*
shutdown*/#definePEER_FLAG_DONT_CAPABILITY(1<<2)/*dont-capability*/#definePEER_F
LAG_OVERRIDE_CAPABILITY(1<<3)/*override-capability*/#definePEER_FLAG_STRICT_CAP_
MATCH(1<<4)/*strict-match*/#definePEER_FLAG_DYNAMIC_CAPABILITY(1<<5)/*dynamiccap
ability*/#definePEER_FLAG_DISABLE_CONNECTED_CHECK(1<<6)/*disable-connected-check
*/#definePEER_FLAG_LOCAL_AS_NO_PREPEND(1<<7)/*local-asno-prepend*/#definePEER_FL
AG_LOCAL_AS_REPLACE_AS(1<<8)/*local-asno-prependreplace-as*/#definePEER_FLAG_DEL
ETE(1<<9)/*markthepeerfordeleting*/#definePEER_FLAG_CONFIG_NODE(1<<10)/*thenodet
oupdateconfigson*/#definePEER_FLAG_LONESOUL(1<<11)#definePEER_FLAG_DYNAMIC_NEIGH
BOR(1<<12)/*dynamicneighbor*/#definePEER_FLAG_CAPABILITY_ENHE(1<<13)/*Extendedne
xt-hop(rfc5549)*/#definePEER_FLAG_IFPEER_V6ONLY(1<<14)/*if-basedpeerisv6only*/#d
efinePEER_FLAG_IS_RFAPI_HD(1<<15)/*attachedtorfapiHD*//*outgoingmessagesentinCEA
SE_ADMIN_SHUTDOWNnotify*/char*tx_shutdown_message;/*NSFmode(gracefulrestart)*/ui
nt8_tnsf[AFI_MAX][SAFI_MAX];/*PerAFconfigurationflags.*/uint32_taf_flags[AFI_MAX
][SAFI_MAX];#definePEER_FLAG_SEND_COMMUNITY(1<<0)/*send-community*/#definePEER_F
LAG_SEND_EXT_COMMUNITY(1<<1)/*send-communityext.*/#definePEER_FLAG_NEXTHOP_SELF(
1<<2)/*next-hop-self*/#definePEER_FLAG_REFLECTOR_CLIENT(1<<3)/*reflector-client*
/#definePEER_FLAG_RSERVER_CLIENT(1<<4)/*route-server-client*/#definePEER_FLAG_SO
FT_RECONFIG(1<<5)/*soft-reconfiguration*/#definePEER_FLAG_AS_PATH_UNCHANGED(1<<6
)/*transparent-as*/#definePEER_FLAG_NEXTHOP_UNCHANGED(1<<7)/*transparent-next-ho
p*/#definePEER_FLAG_MED_UNCHANGED(1<<8)/*transparent-next-hop*/#definePEER_FLAG_
DEFAULT_ORIGINATE(1<<9)/*default-originate*/#definePEER_FLAG_REMOVE_PRIVATE_AS(1
<<10)/*remove-private-as*/#definePEER_FLAG_ALLOWAS_IN(1<<11)/*setallowas-in*/#de
finePEER_FLAG_ORF_PREFIX_SM(1<<12)/*orfcapabilitysend-mode*/#definePEER_FLAG_ORF
_PREFIX_RM(1<<13)/*orfcapabilityreceive-mode*/#definePEER_FLAG_MAX_PREFIX(1<<14)
/*maximumprefix*/#definePEER_FLAG_MAX_PREFIX_WARNING(1<<15)/*maximumprefixwarnin
g-only*/#definePEER_FLAG_NEXTHOP_LOCAL_UNCHANGED(1<<16)/*leavelink-localnexthopu
nchanged*/#definePEER_FLAG_FORCE_NEXTHOP_SELF(1<<17)/*next-hop-selfforce*/#defin
ePEER_FLAG_REMOVE_PRIVATE_AS_ALL(1<<18)/*remove-private-asall*/#definePEER_FLAG_
REMOVE_PRIVATE_AS_REPLACE(1<<19)/*remove-private-asreplace-as*/#definePEER_FLAG_
AS_OVERRIDE(1<<20)/*as-override*/#definePEER_FLAG_REMOVE_PRIVATE_AS_ALL_REPLACE(
1<<21)/*remove-private-asallreplace-as*/#definePEER_FLAG_ADDPATH_TX_ALL_PATHS(1<
<22)/*addpath-tx-all-paths*/#definePEER_FLAG_ADDPATH_TX_BESTPATH_PER_AS(1<<23)/*
addpath-tx-bestpath-per-AS*/#definePEER_FLAG_WEIGHT(1<<24)/*weight*/#definePEER_
FLAG_ALLOWAS_IN_ORIGIN(1<<25)/*allowas-inorigin*/#definePEER_FLAG_SEND_LARGE_COM
MUNITY(1<<26)/*SendlargeCommunities*//*MD5password*/char*password;/*default-orig
inateroute-map.*/struct{char*name;structroute_map*map;}default_rmap[AFI_MAX][SAF
I_MAX];/*Peerstatusflags.*/uint16_tsflags;#definePEER_STATUS_ACCEPT_PEER(1<<0)/*
acceptpeer*/#definePEER_STATUS_PREFIX_OVERFLOW(1<<1)/*prefix-overflow*/#definePE
ER_STATUS_CAPABILITY_OPEN(1<<2)/*capabilityopensend*/#definePEER_STATUS_HAVE_ACC
EPT(1<<3)/*acceptpeer'sparent*/#definePEER_STATUS_GROUP(1<<4)/*peer-groupconf*/#
definePEER_STATUS_NSF_MODE(1<<5)/*NSFawarepeer*/#definePEER_STATUS_NSF_WAIT(1<<6
)/*waitcomebackpeer*//*Peerstatusafflags(resetinbgp_stop)*/uint16_taf_sflags[AFI
_MAX][SAFI_MAX];#definePEER_STATUS_ORF_PREFIX_SEND(1<<0)/*prefix-listsendpeer*/#
definePEER_STATUS_ORF_WAIT_REFRESH(1<<1)/*waitrefreshreceivedpeer*/#definePEER_S
TATUS_PREFIX_THRESHOLD(1<<2)/*exceedprefix-threshold*/#definePEER_STATUS_PREFIX_
LIMIT(1<<3)/*exceedprefix-limit*/#definePEER_STATUS_EOR_SEND(1<<4)/*end-of-ribse
ndtopeer*/#definePEER_STATUS_EOR_RECEIVED(1<<5)/*end-of-ribreceivedfrompeer*//*D
efaultattributevalueforthepeer.*/uint32_tconfig;#definePEER_CONFIG_TIMER(1<<0)/*
keepalive&holdtime*/#definePEER_CONFIG_CONNECT(1<<1)/*connect*/#definePEER_CONFI
G_ROUTEADV(1<<2)/*routeadvertise*/#definePEER_GROUP_CONFIG_TIMER(1<<3)/*timersfr
ompeer-group*/#definePEER_OR_GROUP_TIMER_SET(peer)\(CHECK_FLAG(peer->config,PEER
_CONFIG_TIMER)\||CHECK_FLAG(peer->config,PEER_GROUP_CONFIG_TIMER))_Atomicuint32_
tholdtime;_Atomicuint32_tkeepalive;_Atomicuint32_tconnect;_Atomicuint32_troutead
v;/*Timervalues.*/_Atomicuint32_tv_start;_Atomicuint32_tv_connect;_Atomicuint32_
tv_holdtime;_Atomicuint32_tv_keepalive;_Atomicuint32_tv_routeadv;_Atomicuint32_t
v_pmax_restart;_Atomicuint32_tv_gr_restart;/*Threads.*/structthread*t_read;struc
tthread*t_write;structthread*t_start;structthread*t_connect_check_r;structthread
*t_connect_check_w;structthread*t_connect;structthread*t_holdtime;structthread*t
_routeadv;structthread*t_pmax_restart;structthread*t_gr_restart;structthread*t_g
r_stale;structthread*t_generate_updgrp_packets;structthread*t_process_packet;/*T
hreadflags.*/_Atomicuint16_tthread_flags;#definePEER_THREAD_WRITES_ON(1<<0)#defi
nePEER_THREAD_READS_ON(1<<1)#definePEER_THREAD_KEEPALIVES_ON(1<<2)/*workqueues*/
structwork_queue*clear_node_queue;#definePEER_TOTAL_RX(peer)\atomic_load_explici
t(&peer->open_in,memory_order_relaxed)\+atomic_load_explicit(&peer->update_in,me
mory_order_relaxed)\+atomic_load_explicit(&peer->notify_in,memory_order_relaxed)
\+atomic_load_explicit(&peer->refresh_in,\memory_order_relaxed)\+atomic_load_exp
licit(&peer->keepalive_in,\memory_order_relaxed)\+atomic_load_explicit(&peer->dy
namic_cap_in,\memory_order_relaxed)#definePEER_TOTAL_TX(peer)\atomic_load_explic
it(&peer->open_out,memory_order_relaxed)\+atomic_load_explicit(&peer->update_out
,\memory_order_relaxed)\+atomic_load_explicit(&peer->notify_out,\memory_order_re
laxed)\+atomic_load_explicit(&peer->refresh_out,\memory_order_relaxed)\+atomic_l
oad_explicit(&peer->keepalive_out,\memory_order_relaxed)\+atomic_load_explicit(&
peer->dynamic_cap_out,\memory_order_relaxed)/*Statisticsfield*/_Atomicuint32_top
en_in;/*Openmessageinputcount*/_Atomicuint32_topen_out;/*Openmessageoutputcount*
/_Atomicuint32_tupdate_in;/*Updatemessageinputcount*/_Atomicuint32_tupdate_out;/
*Updatemessageouputcount*/_Atomictime_tupdate_time;/*Updatemessagereceivedtime.*
/_Atomicuint32_tkeepalive_in;/*Keepaliveinputcount*/_Atomicuint32_tkeepalive_out
;/*Keepaliveoutputcount*/_Atomicuint32_tnotify_in;/*Notifyinputcount*/_Atomicuin
t32_tnotify_out;/*Notifyoutputcount*/_Atomicuint32_trefresh_in;/*RouteRefreshinp
utcount*/_Atomicuint32_trefresh_out;/*RouteRefreshoutputcount*/_Atomicuint32_tdy
namic_cap_in;/*DynamicCapabilityinputcount.*/_Atomicuint32_tdynamic_cap_out;/*Dy
namicCapabilityoutputcount.*//*BGPstatecount*/uint32_testablished;/*Established*
/uint32_tdropped;/*Dropped*//*Updatedelayrelatedfields*/uint8_tupdate_delay_over
;/*Whenthisisset,BGPisnomorewaitingforEOR*//*Syncronizationlistandtime.*/structb
gp_synchronize*sync[AFI_MAX][SAFI_MAX];time_tsynctime;/*timestampwhenthelastUPDA
TEmsgwaswritten*/_Atomictime_tlast_write;/*timestampwhenthelastmsgwaswritten*/_A
tomictime_tlast_update;/*Sendprefixcount.*/unsignedlongscount[AFI_MAX][SAFI_MAX]
;/*Notifydata.*/structbgp_notifynotify;/*Filterstructure.*/structbgp_filterfilte
r[AFI_MAX][SAFI_MAX];/*ORFPrefix-list*/structprefix_list*orf_plist[AFI_MAX][SAFI
_MAX];/*Textdescriptionoflastattributercvd*/charrcvd_attr_str[BUFSIZ];/*Trackifw
eprintedtheattributeindebugs*/intrcvd_attr_printed;/*Prefixcount.*/unsignedlongp
count[AFI_MAX][SAFI_MAX];/*Maxprefixcount.*/unsignedlongpmax[AFI_MAX][SAFI_MAX];
uint8_tpmax_threshold[AFI_MAX][SAFI_MAX];uint16_tpmax_restart[AFI_MAX][SAFI_MAX]
;#defineMAXIMUM_PREFIX_THRESHOLD_DEFAULT75/*allowas-in.*/charallowas_in[AFI_MAX]
[SAFI_MAX];/*weight*/unsignedlongweight[AFI_MAX][SAFI_MAX];/*peerresetcause*/cha
rlast_reset;#definePEER_DOWN_RID_CHANGE1/*bgprouter-idcommand*/#definePEER_DOWN_
REMOTE_AS_CHANGE2/*neighborremote-ascommand*/#definePEER_DOWN_LOCAL_AS_CHANGE3/*
neighborlocal-ascommand*/#definePEER_DOWN_CLID_CHANGE4/*bgpcluster-idcommand*/#d
efinePEER_DOWN_CONFED_ID_CHANGE5/*bgpconfederationidentifiercommand*/#definePEER
_DOWN_CONFED_PEER_CHANGE6/*bgpconfederationpeercommand*/#definePEER_DOWN_RR_CLIE
NT_CHANGE7/*neighborroute-reflector-clientcommand*/#definePEER_DOWN_RS_CLIENT_CH
ANGE8/*neighborroute-server-clientcommand*/#definePEER_DOWN_UPDATE_SOURCE_CHANGE
9/*neighborupdate-sourcecommand*/#definePEER_DOWN_AF_ACTIVATE10/*neighboractivat
ecommand*/#definePEER_DOWN_USER_SHUTDOWN11/*neighborshutdowncommand*/#definePEER
_DOWN_USER_RESET12/*clearipbgpcommand*/#definePEER_DOWN_NOTIFY_RECEIVED13/*notif
icationreceived*/#definePEER_DOWN_NOTIFY_SEND14/*notificationsend*/#definePEER_D
OWN_CLOSE_SESSION15/*tcpsessionclose*/#definePEER_DOWN_NEIGHBOR_DELETE16/*neghbo
rdelete*/#definePEER_DOWN_RMAP_BIND17/*neghborpeer-groupcommand*/#definePEER_DOW
N_RMAP_UNBIND18/*noneighborpeer-groupcommand*/#definePEER_DOWN_CAPABILITY_CHANGE
19/*neighborcapabilitycommand*/#definePEER_DOWN_PASSIVE_CHANGE20/*neighborpassiv
ecommand*/#definePEER_DOWN_MULTIHOP_CHANGE21/*neighbormultihopcommand*/#definePE
ER_DOWN_NSF_CLOSE_SESSION22/*NSFtcpsessionclose*/#definePEER_DOWN_V6ONLY_CHANGE2
3/*if-basedpeeringv6onlytoggled*/#definePEER_DOWN_BFD_DOWN24/*BFDdown*/#definePE
ER_DOWN_IF_DOWN25/*Interfacedown*/#definePEER_DOWN_NBR_ADDR_DEL26/*Peeraddresslo
st*/unsignedlonglast_reset_cause_size;uint8_tlast_reset_cause[BGP_MAX_PACKET_SIZ
E];/*Thekindofroute-mapFlags.*/uint8_trmap_type;#definePEER_RMAP_TYPE_IN(1<<0)/*
neighborroute-mapin*/#definePEER_RMAP_TYPE_OUT(1<<1)/*neighborroute-mapout*/#def
inePEER_RMAP_TYPE_NETWORK(1<<2)/*networkroute-map*/#definePEER_RMAP_TYPE_REDISTR
IBUTE(1<<3)/*redistributeroute-map*/#definePEER_RMAP_TYPE_DEFAULT(1<<4)/*default
-originateroute-map*/#definePEER_RMAP_TYPE_NOSET(1<<5)/*notallowtosetcommands*/#
definePEER_RMAP_TYPE_IMPORT(1<<6)/*neighborroute-mapimport*/#definePEER_RMAP_TYP
E_EXPORT(1<<7)/*neighborroute-mapexport*//*peerspecificBFDinformation*/structbfd
_info*bfd_info;/*hostnameanddomainnameadvertisedbyhost*/char*hostname;char*domai
nname;QOBJ_FIELDS};DECLARE_QOBJ_TYPE(peer)/*Checkifsuppressstart/restartofsessio
nstopeer.*/#defineBGP_PEER_START_SUPPRESSED(P)\(CHECK_FLAG((P)->flags,PEER_FLAG_
SHUTDOWN)\||CHECK_FLAG((P)->sflags,PEER_STATUS_PREFIX_OVERFLOW))#definePEER_PASS
WORD_MINLEN(1)#definePEER_PASSWORD_MAXLEN(80)/*Thisstructure'smemberdirectlypoin
tsincomingpacketdatastream.*/structbgp_nlri{/*AFI.*/uint16_tafi;/*iana_afi_t*//*
SAFI.*/uint8_tsafi;/*iana_safi_t*//*PointertoNLRIbytestream.*/uint8_t*nlri;/*Len
gthofwholeNLRI.*/bgp_size_tlength;};/*BGPversions.*/#defineBGP_VERSION_44/*Defau
ltBGPportnumber.*/#defineBGP_PORT_DEFAULT179/*BGPminimummessagesize.*/#defineBGP
_MSG_OPEN_MIN_SIZE(BGP_HEADER_SIZE+10)#defineBGP_MSG_UPDATE_MIN_SIZE(BGP_HEADER_
SIZE+4)#defineBGP_MSG_NOTIFY_MIN_SIZE(BGP_HEADER_SIZE+2)#defineBGP_MSG_KEEPALIVE
_MIN_SIZE(BGP_HEADER_SIZE+0)#defineBGP_MSG_ROUTE_REFRESH_MIN_SIZE(BGP_HEADER_SIZ
E+4)#defineBGP_MSG_CAPABILITY_MIN_SIZE(BGP_HEADER_SIZE+3)/*BGPmessagetypes.*/#de
fineBGP_MSG_OPEN1#defineBGP_MSG_UPDATE2#defineBGP_MSG_NOTIFY3#defineBGP_MSG_KEEP
ALIVE4#defineBGP_MSG_ROUTE_REFRESH_NEW5#defineBGP_MSG_CAPABILITY6#defineBGP_MSG_
ROUTE_REFRESH_OLD128/*BGPopenoptionalparameter.*/#defineBGP_OPEN_OPT_AUTH1#defin
eBGP_OPEN_OPT_CAP2/*BGP4attributetypecodes.*/#defineBGP_ATTR_ORIGIN1#defineBGP_A
TTR_AS_PATH2#defineBGP_ATTR_NEXT_HOP3#defineBGP_ATTR_MULTI_EXIT_DISC4#defineBGP_
ATTR_LOCAL_PREF5#defineBGP_ATTR_ATOMIC_AGGREGATE6#defineBGP_ATTR_AGGREGATOR7#def
ineBGP_ATTR_COMMUNITIES8#defineBGP_ATTR_ORIGINATOR_ID9#defineBGP_ATTR_CLUSTER_LI
ST10#defineBGP_ATTR_DPA11#defineBGP_ATTR_ADVERTISER12#defineBGP_ATTR_RCID_PATH13
#defineBGP_ATTR_MP_REACH_NLRI14#defineBGP_ATTR_MP_UNREACH_NLRI15#defineBGP_ATTR_
EXT_COMMUNITIES16#defineBGP_ATTR_AS4_PATH17#defineBGP_ATTR_AS4_AGGREGATOR18#defi
neBGP_ATTR_AS_PATHLIMIT21#defineBGP_ATTR_PMSI_TUNNEL22#defineBGP_ATTR_ENCAP23#de
fineBGP_ATTR_LARGE_COMMUNITIES32#defineBGP_ATTR_PREFIX_SID40#ifENABLE_BGP_VNC#de
fineBGP_ATTR_VNC255#endif/*BGPupdateorigin.*/#defineBGP_ORIGIN_IGP0#defineBGP_OR
IGIN_EGP1#defineBGP_ORIGIN_INCOMPLETE2/*BGPnotifymessagecodes.*/#defineBGP_NOTIF
Y_HEADER_ERR1#defineBGP_NOTIFY_OPEN_ERR2#defineBGP_NOTIFY_UPDATE_ERR3#defineBGP_
NOTIFY_HOLD_ERR4#defineBGP_NOTIFY_FSM_ERR5#defineBGP_NOTIFY_CEASE6#defineBGP_NOT
IFY_CAPABILITY_ERR7#defineBGP_NOTIFY_SUBCODE_UNSPECIFIC0/*BGP_NOTIFY_HEADER_ERRs
ubcodes.*/#defineBGP_NOTIFY_HEADER_NOT_SYNC1#defineBGP_NOTIFY_HEADER_BAD_MESLEN2
#defineBGP_NOTIFY_HEADER_BAD_MESTYPE3/*BGP_NOTIFY_OPEN_ERRsubcodes.*/#defineBGP_
NOTIFY_OPEN_MALFORMED_ATTR0#defineBGP_NOTIFY_OPEN_UNSUP_VERSION1#defineBGP_NOTIF
Y_OPEN_BAD_PEER_AS2#defineBGP_NOTIFY_OPEN_BAD_BGP_IDENT3#defineBGP_NOTIFY_OPEN_U
NSUP_PARAM4#defineBGP_NOTIFY_OPEN_AUTH_FAILURE5#defineBGP_NOTIFY_OPEN_UNACEP_HOL
DTIME6#defineBGP_NOTIFY_OPEN_UNSUP_CAPBL7/*BGP_NOTIFY_UPDATE_ERRsubcodes.*/#defi
neBGP_NOTIFY_UPDATE_MAL_ATTR1#defineBGP_NOTIFY_UPDATE_UNREC_ATTR2#defineBGP_NOTI
FY_UPDATE_MISS_ATTR3#defineBGP_NOTIFY_UPDATE_ATTR_FLAG_ERR4#defineBGP_NOTIFY_UPD
ATE_ATTR_LENG_ERR5#defineBGP_NOTIFY_UPDATE_INVAL_ORIGIN6#defineBGP_NOTIFY_UPDATE
_AS_ROUTE_LOOP7#defineBGP_NOTIFY_UPDATE_INVAL_NEXT_HOP8#defineBGP_NOTIFY_UPDATE_
OPT_ATTR_ERR9#defineBGP_NOTIFY_UPDATE_INVAL_NETWORK10#defineBGP_NOTIFY_UPDATE_MA
L_AS_PATH11/*BGP_NOTIFY_CEASEsubcodes(RFC4486).*/#defineBGP_NOTIFY_CEASE_MAX_PRE
FIX1#defineBGP_NOTIFY_CEASE_ADMIN_SHUTDOWN2#defineBGP_NOTIFY_CEASE_PEER_UNCONFIG
3#defineBGP_NOTIFY_CEASE_ADMIN_RESET4#defineBGP_NOTIFY_CEASE_CONNECT_REJECT5#def
ineBGP_NOTIFY_CEASE_CONFIG_CHANGE6#defineBGP_NOTIFY_CEASE_COLLISION_RESOLUTION7#
defineBGP_NOTIFY_CEASE_OUT_OF_RESOURCE8/*BGP_NOTIFY_CAPABILITY_ERRsubcodes(draft
-ietf-idr-dynamic-cap-02).*/#defineBGP_NOTIFY_CAPABILITY_INVALID_ACTION1#defineB
GP_NOTIFY_CAPABILITY_INVALID_LENGTH2#defineBGP_NOTIFY_CAPABILITY_MALFORMED_CODE3
/*BGPfinitestatemachinestatus.*/#defineIdle1#defineConnect2#defineActive3#define
OpenSent4#defineOpenConfirm5#defineEstablished6#defineClearing7#defineDeleted8#d
efineBGP_STATUS_MAX9/*BGPfinitestatemachineevents.*/#defineBGP_Start1#defineBGP_
Stop2#defineTCP_connection_open3#defineTCP_connection_closed4#defineTCP_connecti
on_open_failed5#defineTCP_fatal_error6#defineConnectRetry_timer_expired7#defineH
old_Timer_expired8#defineKeepAlive_timer_expired9#defineReceive_OPEN_message10#d
efineReceive_KEEPALIVE_message11#defineReceive_UPDATE_message12#defineReceive_NO
TIFICATION_message13#defineClearing_Completed14#defineBGP_EVENTS_MAX15/*BGPtimer
sdefaultvalue.*//*note:theDFLT_onesdependoncompile-time"defaults"selection*/#def
ineBGP_INIT_START_TIMER1#defineBGP_DEFAULT_HOLDTIMEDFLT_BGP_HOLDTIME#defineBGP_D
EFAULT_KEEPALIVEDFLT_BGP_KEEPALIVE#defineBGP_DEFAULT_EBGP_ROUTEADV0#defineBGP_DE
FAULT_IBGP_ROUTEADV0#defineBGP_DEFAULT_CONNECT_RETRYDFLT_BGP_TIMERS_CONNECT/*BGP
defaultlocalpreference.*/#defineBGP_DEFAULT_LOCAL_PREF100/*BGPlocal-preferenceto
sendwhen'bgpgraceful-shutdown'*isconfigured*/#defineBGP_GSHUT_LOCAL_PREF0/*BGPde
faultsubgrouppacketqueuemax.*/#defineBGP_DEFAULT_SUBGROUP_PKT_QUEUE_MAX40/*BGPgr
acefulrestart*/#defineBGP_DEFAULT_RESTART_TIME120#defineBGP_DEFAULT_STALEPATH_TI
ME360/*BGPuptimestringlength.*/#defineBGP_UPTIME_LEN25/*Defaultconfigurationsett
ingsforbgpd.*/#defineBGP_VTY_PORT2605#defineBGP_DEFAULT_CONFIG"bgpd.conf"/*Check
ASpathloopwhenwesendNLRI.*//*#defineBGP_SEND_ASPATH_CHECK*//*BGPDynamicNeighbors
feature*/#defineBGP_DYNAMIC_NEIGHBORS_LIMIT_DEFAULT100#defineBGP_DYNAMIC_NEIGHBO
RS_LIMIT_MIN1#defineBGP_DYNAMIC_NEIGHBORS_LIMIT_MAX5000/*Flagforpeer_clear_soft(
).*/enumbgp_clear_type{BGP_CLEAR_SOFT_NONE,BGP_CLEAR_SOFT_OUT,BGP_CLEAR_SOFT_IN,
BGP_CLEAR_SOFT_BOTH,BGP_CLEAR_SOFT_IN_ORF_PREFIX};/*Macros.*/#defineBGP_INPUT(P)
((P)->curr)#defineBGP_INPUT_PNT(P)(stream_pnt(BGP_INPUT(P)))#defineBGP_IS_VALID_
STATE_FOR_NOTIF(S)\(((S)==OpenSent)||((S)==OpenConfirm)||((S)==Established))/*BG
Perrorcodes.*/#defineBGP_SUCCESS0#defineBGP_ERR_INVALID_VALUE-1#defineBGP_ERR_IN
VALID_FLAG-2#defineBGP_ERR_INVALID_AS-3#defineBGP_ERR_INVALID_BGP-4#defineBGP_ER
R_PEER_GROUP_MEMBER-5#defineBGP_ERR_MULTIPLE_INSTANCE_USED-6#defineBGP_ERR_PEER_
GROUP_NO_REMOTE_AS-7#defineBGP_ERR_PEER_GROUP_CANT_CHANGE-8#defineBGP_ERR_PEER_G
ROUP_MISMATCH-9#defineBGP_ERR_PEER_GROUP_PEER_TYPE_DIFFERENT-10#defineBGP_ERR_MU
LTIPLE_INSTANCE_NOT_SET-11#defineBGP_ERR_AS_MISMATCH-12#defineBGP_ERR_PEER_FLAG_
CONFLICT-13#defineBGP_ERR_PEER_GROUP_SHUTDOWN-14#defineBGP_ERR_PEER_FILTER_CONFL
ICT-15#defineBGP_ERR_NOT_INTERNAL_PEER-16#defineBGP_ERR_REMOVE_PRIVATE_AS-17#def
ineBGP_ERR_AF_UNCONFIGURED-18#defineBGP_ERR_SOFT_RECONFIG_UNCONFIGURED-19#define
BGP_ERR_INSTANCE_MISMATCH-20#defineBGP_ERR_LOCAL_AS_ALLOWED_ONLY_FOR_EBGP-21#def
ineBGP_ERR_CANNOT_HAVE_LOCAL_AS_SAME_AS-22#defineBGP_ERR_TCPSIG_FAILED-23#define
BGP_ERR_NO_EBGP_MULTIHOP_WITH_TTLHACK-24#defineBGP_ERR_NO_IBGP_WITH_TTLHACK-25#d
efineBGP_ERR_NO_INTERFACE_CONFIG-26#defineBGP_ERR_CANNOT_HAVE_LOCAL_AS_SAME_AS_R
EMOTE_AS-27#defineBGP_ERR_AS_OVERRIDE-28#defineBGP_ERR_INVALID_DYNAMIC_NEIGHBORS
_LIMIT-29#defineBGP_ERR_DYNAMIC_NEIGHBORS_RANGE_EXISTS-30#defineBGP_ERR_DYNAMIC_
NEIGHBORS_RANGE_NOT_FOUND-31#defineBGP_ERR_INVALID_FOR_DYNAMIC_PEER-32#defineBGP
_ERR_MAX-33#defineBGP_ERR_INVALID_FOR_DIRECT_PEER-34#defineBGP_ERR_PEER_SAFI_CON
FLICT-35/**Enumerationofdifferentpolicykindsapeercanbeconfiguredwith.*/typedefen
um{BGP_POLICY_ROUTE_MAP,BGP_POLICY_FILTER_LIST,BGP_POLICY_PREFIX_LIST,BGP_POLICY
_DISTRIBUTE_LIST,}bgp_policy_type_e;externstructbgp_master*bm;externunsignedintm
ultipath_num;/*Prototypes.*/externvoidbgp_terminate(void);externvoidbgp_reset(vo
id);externtime_tbgp_clock(void);externvoidbgp_zclient_reset(void);externintbgp_n
exthop_set(unionsockunion*,unionsockunion*,structbgp_nexthop*,structpeer*);exter
nstructbgp*bgp_get_default(void);externstructbgp*bgp_lookup(as_t,constchar*);ext
ernstructbgp*bgp_lookup_by_name(constchar*);externstructbgp*bgp_lookup_by_vrf_id
(vrf_id_t);externstructpeer*peer_lookup(structbgp*,unionsockunion*);externstruct
peer*peer_lookup_by_conf_if(structbgp*,constchar*);externstructpeer*peer_lookup_
by_hostname(structbgp*,constchar*);externvoidbgp_peer_conf_if_to_su_update(struc
tpeer*);externintpeer_group_listen_range_del(structpeer_group*,structprefix*);ex
ternstructpeer_group*peer_group_lookup(structbgp*,constchar*);externstructpeer_g
roup*peer_group_get(structbgp*,constchar*);externstructpeer*peer_create_bind_dyn
amic_neighbor(structbgp*,unionsockunion*,structpeer_group*);externstructprefix*p
eer_group_lookup_dynamic_neighbor_range(structpeer_group*,structprefix*);externs
tructpeer_group*peer_group_lookup_dynamic_neighbor(structbgp*,structprefix*,stru
ctprefix**);externstructpeer*peer_lookup_dynamic_neighbor(structbgp*,unionsockun
ion*);externvoidpeer_drop_dynamic_neighbor(structpeer*);/**Peersareincrediblyeas
ytomemoryleak*duetothevariouswaysthattheyareactuallyused*Providesomefunctionalit
ytodebuglocksandunlocks*/externstructpeer*peer_lock_with_caller(constchar*,struc
tpeer*);externstructpeer*peer_unlock_with_caller(constchar*,structpeer*);#define
peer_unlock(A)peer_unlock_with_caller(__FUNCTION__,(A))#definepeer_lock(B)peer_l
ock_with_caller(__FUNCTION__,(B))externbgp_peer_sort_tpeer_sort(structpeer*peer)
;externintpeer_active(structpeer*);externintpeer_active_nego(structpeer*);extern
voidbgp_recalculate_all_bestpaths(structbgp*bgp);externstructpeer*peer_create(un
ionsockunion*,constchar*,structbgp*,as_t,as_t,int,afi_t,safi_t,structpeer_group*
);externstructpeer*peer_create_accept(structbgp*);externvoidpeer_xfer_config(str
uctpeer*dst,structpeer*src);externchar*peer_uptime(time_t,char*,size_t,uint8_t,j
son_object*);externintbgp_config_write(structvty*);externvoidbgp_master_init(str
uctthread_master*master);externvoidbgp_init(void);externvoidbgp_pthreads_run(voi
d);externvoidbgp_pthreads_finish(void);externvoidbgp_route_map_init(void);extern
voidbgp_session_reset(structpeer*);externintbgp_option_set(int);externintbgp_opt
ion_unset(int);externintbgp_option_check(int);externintbgp_get(structbgp**,as_t*
,constchar*,enumbgp_instance_type);externvoidbgp_instance_up(structbgp*);externv
oidbgp_instance_down(structbgp*);externintbgp_delete(structbgp*);externintbgp_ha
ndle_socket(structbgp*bgp,structvrf*vrf,vrf_id_told_vrf_id,boolcreate);externint
bgp_flag_set(structbgp*,int);externintbgp_flag_unset(structbgp*,int);externintbg
p_flag_check(structbgp*,int);externvoidbgp_router_id_zebra_bump(vrf_id_t,constst
ructprefix*);externintbgp_router_id_static_set(structbgp*,structin_addr);externi
ntbgp_cluster_id_set(structbgp*,structin_addr*);externintbgp_cluster_id_unset(st
ructbgp*);externintbgp_confederation_id_set(structbgp*,as_t);externintbgp_confed
eration_id_unset(structbgp*);externintbgp_confederation_peers_check(structbgp*,a
s_t);externintbgp_confederation_peers_add(structbgp*,as_t);externintbgp_confeder
ation_peers_remove(structbgp*,as_t);externintbgp_timers_set(structbgp*,uint32_tk
eepalive,uint32_tholdtime);externintbgp_timers_unset(structbgp*);externintbgp_de
fault_local_preference_set(structbgp*,uint32_t);externintbgp_default_local_prefe
rence_unset(structbgp*);externintbgp_default_subgroup_pkt_queue_max_set(structbg
p*bgp,uint32_t);externintbgp_default_subgroup_pkt_queue_max_unset(structbgp*bgp)
;externintbgp_listen_limit_set(structbgp*,int);externintbgp_listen_limit_unset(s
tructbgp*);externintbgp_update_delay_active(structbgp*);externintbgp_update_dela
y_configured(structbgp*);externintbgp_afi_safi_peer_exists(structbgp*bgp,afi_taf
i,safi_tsafi);externvoidpeer_as_change(structpeer*,as_t,int);externintpeer_remot
e_as(structbgp*,unionsockunion*,constchar*,as_t*,int,afi_t,safi_t);externintpeer
_group_remote_as(structbgp*,constchar*,as_t*,int);externintpeer_delete(structpee
r*peer);externintpeer_group_delete(structpeer_group*);externintpeer_group_remote
_as_delete(structpeer_group*);externintpeer_group_listen_range_add(structpeer_gr
oup*,structprefix*);externintpeer_activate(structpeer*,afi_t,safi_t);externintpe
er_deactivate(structpeer*,afi_t,safi_t);externintpeer_afc_set(structpeer*,afi_t,
safi_t,int);externintpeer_group_bind(structbgp*,unionsockunion*,structpeer*,stru
ctpeer_group*,as_t*);externintpeer_group_unbind(structbgp*,structpeer*,structpee
r_group*);externintpeer_flag_set(structpeer*,uint32_t);externintpeer_flag_unset(
structpeer*,uint32_t);externintpeer_af_flag_set(structpeer*,afi_t,safi_t,uint32_
t);externintpeer_af_flag_unset(structpeer*,afi_t,safi_t,uint32_t);externintpeer_
af_flag_check(structpeer*,afi_t,safi_t,uint32_t);externintpeer_ebgp_multihop_set
(structpeer*,int);externintpeer_ebgp_multihop_unset(structpeer*);externintis_ebg
p_multihop_configured(structpeer*peer);externintpeer_description_set(structpeer*
,constchar*);externintpeer_description_unset(structpeer*);externintpeer_update_s
ource_if_set(structpeer*,constchar*);externintpeer_update_source_addr_set(struct
peer*,constunionsockunion*);externintpeer_update_source_unset(structpeer*);exter
nintpeer_default_originate_set(structpeer*,afi_t,safi_t,constchar*);externintpee
r_default_originate_unset(structpeer*,afi_t,safi_t);externintpeer_port_set(struc
tpeer*,uint16_t);externintpeer_port_unset(structpeer*);externintpeer_weight_set(
structpeer*,afi_t,safi_t,uint16_t);externintpeer_weight_unset(structpeer*,afi_t,
safi_t);externintpeer_timers_set(structpeer*,uint32_tkeepalive,uint32_tholdtime)
;externintpeer_timers_unset(structpeer*);externintpeer_timers_connect_set(struct
peer*,uint32_t);externintpeer_timers_connect_unset(structpeer*);externintpeer_ad
vertise_interval_set(structpeer*,uint32_t);externintpeer_advertise_interval_unse
t(structpeer*);externvoidpeer_interface_set(structpeer*,constchar*);externvoidpe
er_interface_unset(structpeer*);externintpeer_distribute_set(structpeer*,afi_t,s
afi_t,int,constchar*);externintpeer_distribute_unset(structpeer*,afi_t,safi_t,in
t);externintpeer_allowas_in_set(structpeer*,afi_t,safi_t,int,int);externintpeer_
allowas_in_unset(structpeer*,afi_t,safi_t);externintpeer_local_as_set(structpeer
*,as_t,int,int);externintpeer_local_as_unset(structpeer*);externintpeer_prefix_l
ist_set(structpeer*,afi_t,safi_t,int,constchar*);externintpeer_prefix_list_unset
(structpeer*,afi_t,safi_t,int);externintpeer_aslist_set(structpeer*,afi_t,safi_t
,int,constchar*);externintpeer_aslist_unset(structpeer*,afi_t,safi_t,int);extern
intpeer_route_map_set(structpeer*,afi_t,safi_t,int,constchar*);externintpeer_rou
te_map_unset(structpeer*,afi_t,safi_t,int);externintpeer_unsuppress_map_set(stru
ctpeer*,afi_t,safi_t,constchar*);externintpeer_password_set(structpeer*,constcha
r*);externintpeer_password_unset(structpeer*);externintpeer_unsuppress_map_unset
(structpeer*,afi_t,safi_t);externintpeer_maximum_prefix_set(structpeer*,afi_t,sa
fi_t,uint32_t,uint8_t,int,uint16_t);externintpeer_maximum_prefix_unset(structpee
r*,afi_t,safi_t);externintpeer_clear(structpeer*,structlistnode**);externintpeer
_clear_soft(structpeer*,afi_t,safi_t,enumbgp_clear_type);externintpeer_ttl_secur
ity_hops_set(structpeer*,int);externintpeer_ttl_security_hops_unset(structpeer*)
;externintpeer_tx_shutdown_message_set(structpeer*,constchar*msg);externintpeer_
tx_shutdown_message_unset(structpeer*);externintbgp_route_map_update_timer(struc
tthread*thread);externvoidbgp_route_map_terminate(void);externintpeer_cmp(struct
peer*p1,structpeer*p2);externintbgp_map_afi_safi_iana2int(iana_afi_tpkt_afi,iana
_safi_tpkt_safi,afi_t*afi,safi_t*safi);externintbgp_map_afi_safi_int2iana(afi_ta
fi,safi_tsafi,iana_afi_t*pkt_afi,iana_safi_t*pkt_safi);externstructpeer_af*peer_
af_create(structpeer*,afi_t,safi_t);externstructpeer_af*peer_af_find(structpeer*
,afi_t,safi_t);externintpeer_af_delete(structpeer*,afi_t,safi_t);externvoidbgp_c
lose(void);externvoidbgp_free(structbgp*);staticinlinestructbgp*bgp_lock(structb
gp*bgp){bgp->lock++;returnbgp;}staticinlinevoidbgp_unlock(structbgp*bgp){assert(
bgp->lock>0);if(--bgp->lock==0)bgp_free(bgp);}staticinlineintafindex(afi_tafi,sa
fi_tsafi){switch(afi){caseAFI_IP:switch(safi){caseSAFI_UNICAST:returnBGP_AF_IPV4
_UNICAST;break;caseSAFI_MULTICAST:returnBGP_AF_IPV4_MULTICAST;break;caseSAFI_LAB
ELED_UNICAST:returnBGP_AF_IPV4_LBL_UNICAST;break;caseSAFI_MPLS_VPN:returnBGP_AF_
IPV4_VPN;break;caseSAFI_ENCAP:returnBGP_AF_IPV4_ENCAP;break;caseSAFI_FLOWSPEC:re
turnBGP_AF_IPV4_FLOWSPEC;default:returnBGP_AF_MAX;break;}break;caseAFI_IP6:switc
h(safi){caseSAFI_UNICAST:returnBGP_AF_IPV6_UNICAST;break;caseSAFI_MULTICAST:retu
rnBGP_AF_IPV6_MULTICAST;break;caseSAFI_LABELED_UNICAST:returnBGP_AF_IPV6_LBL_UNI
CAST;break;caseSAFI_MPLS_VPN:returnBGP_AF_IPV6_VPN;break;caseSAFI_ENCAP:returnBG
P_AF_IPV6_ENCAP;break;caseSAFI_FLOWSPEC:returnBGP_AF_IPV6_FLOWSPEC;default:retur
nBGP_AF_MAX;break;}break;caseAFI_L2VPN:switch(safi){caseSAFI_EVPN:returnBGP_AF_L
2VPN_EVPN;break;default:returnBGP_AF_MAX;break;}default:returnBGP_AF_MAX;break;}
}/*Ifthepeerisnotapeer-groupbutisboundtoapeer-groupreturn1*/staticinlineintpeer_
group_active(structpeer*peer){if(!CHECK_FLAG(peer->sflags,PEER_STATUS_GROUP)&&pe
er->group)return1;return0;}/*Ifpeerisnegotiatedatleastoneaddressfamilyreturn1.*/
staticinlineintpeer_afi_active_nego(conststructpeer*peer,afi_tafi){if(peer->afc_
nego[afi][SAFI_UNICAST]||peer->afc_nego[afi][SAFI_MULTICAST]||peer->afc_nego[afi
][SAFI_LABELED_UNICAST]||peer->afc_nego[afi][SAFI_MPLS_VPN]||peer->afc_nego[afi]
[SAFI_ENCAP]||peer->afc_nego[afi][SAFI_FLOWSPEC]||peer->afc_nego[afi][SAFI_EVPN]
)return1;return0;}/*Ifatleastoneaddressfamilyactivatedforgroup,return1.*/statici
nlineintpeer_group_af_configured(structpeer_group*group){structpeer*peer=group->
conf;if(peer->afc[AFI_IP][SAFI_UNICAST]||peer->afc[AFI_IP][SAFI_MULTICAST]||peer
->afc[AFI_IP][SAFI_LABELED_UNICAST]||peer->afc[AFI_IP][SAFI_FLOWSPEC]||peer->afc
[AFI_IP][SAFI_MPLS_VPN]||peer->afc[AFI_IP][SAFI_ENCAP]||peer->afc[AFI_IP6][SAFI_
UNICAST]||peer->afc[AFI_IP6][SAFI_MULTICAST]||peer->afc[AFI_IP6][SAFI_LABELED_UN
ICAST]||peer->afc[AFI_IP6][SAFI_MPLS_VPN]||peer->afc[AFI_IP6][SAFI_ENCAP]||peer-
>afc[AFI_IP6][SAFI_FLOWSPEC]||peer->afc[AFI_L2VPN][SAFI_EVPN])return1;return0;}s
taticinlinechar*timestamp_string(time_tts){time_ttbuf;tbuf=time(NULL)-(bgp_clock
()-ts);returnctime(&tbuf);}staticinlineintpeer_established(structpeer*peer){if(p
eer->status==Established)return1;return0;}staticinlineintpeer_dynamic_neighbor(s
tructpeer*peer){return(CHECK_FLAG(peer->flags,PEER_FLAG_DYNAMIC_NEIGHBOR))?1:0;}
staticinlineintpeer_cap_enhe(structpeer*peer,afi_tafi,safi_tsafi){return(CHECK_F
LAG(peer->af_cap[afi][safi],PEER_CAP_ENHE_AF_NEGO));}/*LookupVRFforBGPinstanceba
sedonitstype.*/staticinlinestructvrf*bgp_vrf_lookup_by_instance_type(structbgp*b
gp){structvrf*vrf;if(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)vrf=vrf_lookup_by
_id(VRF_DEFAULT);elseif(bgp->inst_type==BGP_INSTANCE_TYPE_VRF)vrf=vrf_lookup_by_
name(bgp->name);elsevrf=NULL;returnvrf;}/*LinkBGPinstancetoVRF.*/staticinlinevoi
dbgp_vrf_link(structbgp*bgp,structvrf*vrf){bgp->vrf_id=vrf->vrf_id;if(vrf->info!
=(void*)bgp)vrf->info=(void*)bgp_lock(bgp);}/*UnlinkBGPinstancefromVRF.*/statici
nlinevoidbgp_vrf_unlink(structbgp*bgp,structvrf*vrf){if(vrf->info==(void*)bgp){v
rf->info=NULL;bgp_unlock(bgp);}bgp->vrf_id=VRF_UNKNOWN;}externvoidbgp_update_red
ist_vrf_bitmaps(structbgp*,vrf_id_t);/*Forbenefitofrfapi*/externstructpeer*peer_
new(structbgp*bgp);#endif/*_QUAGGA_BGPD_H*/