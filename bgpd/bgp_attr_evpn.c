/*Ethernet-VPNAttributehandlingfile*Copyright(C)20166WIND**ThisfileispartofFRRou
ting.**FRRoutingisfreesoftware;youcanredistributeitand/ormodifyit*underthetermso
ftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion
2,or(atyouroption)any*laterversion.**FRRoutingisdistributedinthehopethatitwillbe
useful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorF
ITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yoush
ouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefil
eCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bo
ston,MA02110-1301USA*/#include<zebra.h>#include"command.h"#include"filter.h"#inc
lude"prefix.h"#include"log.h"#include"memory.h"#include"stream.h"#include"bgpd/b
gpd.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_attr_
evpn.h"#include"bgpd/bgp_ecommunity.h"#include"bgpd/bgp_evpn.h"#include"bgpd/bgp
_evpn_private.h"voidbgp_add_routermac_ecom(structattr*attr,structethaddr*routerm
ac){structecommunity_valroutermac_ecom;memset(&routermac_ecom,0,sizeof(structeco
mmunity_val));routermac_ecom.val[0]=ECOMMUNITY_ENCODE_EVPN;routermac_ecom.val[1]
=ECOMMUNITY_EVPN_SUBTYPE_ROUTERMAC;memcpy(&routermac_ecom.val[2],routermac->octe
t,ETH_ALEN);if(!attr->ecommunity)attr->ecommunity=ecommunity_new();ecommunity_ad
d_val(attr->ecommunity,&routermac_ecom);ecommunity_str(attr->ecommunity);}/*conv
ertstoanesi*returns1onsuccess,0otherwise*formataccepted:AA:BB:CC:DD:EE:FF:GG:HH:
II:JJ*ifidisnull,checkonlyisdone*/intstr2esi(constchar*str,structeth_segment_id*
id){unsignedinta[ESI_LEN];inti;if(!str)return0;if(sscanf(str,"%2x:%2x:%2x:%2x:%2
x:%2x:%2x:%2x:%2x:%2x",a+0,a+1,a+2,a+3,a+4,a+5,a+6,a+7,a+8,a+9)!=ESI_LEN){/*erro
rinincomingstrlength*/return0;}/*validmacaddress*/if(!id)return1;for(i=0;i<ESI_L
EN;++i)id->val[i]=a[i]&0xff;return1;}char*esi2str(structeth_segment_id*id){char*
ptr;uint8_t*val;if(!id)returnNULL;val=id->val;ptr=(char*)XMALLOC(MTYPE_TMP,(ESI_
LEN*2+ESI_LEN-1+1)*sizeof(char));snprintf(ptr,(ESI_LEN*2+ESI_LEN-1+1),"%02x:%02x
:%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x",val[0],val[1],val[2],val[3],val[4],val
[5],val[6],val[7],val[8],val[9]);returnptr;}char*ecom_mac2str(char*ecom_mac){cha
r*en;en=ecom_mac;en+=2;returnprefix_mac2str((structethaddr*)en,NULL,0);}/*Fetchr
outer-macfromextendedcommunity*/voidbgp_attr_rmac(structattr*attr,structethaddr*
rmac){inti=0;structecommunity*ecom;ecom=attr->ecommunity;if(!ecom||!ecom->size)r
eturn;/*Ifthereisaroutermacextendedcommunity,setRMACinattr*/for(i=0;i<ecom->size
;i++){uint8_t*pnt=NULL;uint8_ttype=0;uint8_tsub_type=0;pnt=(ecom->val+(i*ECOMMUN
ITY_SIZE));type=*pnt++;sub_type=*pnt++;if(!(type==ECOMMUNITY_ENCODE_EVPN&&sub_ty
pe==ECOMMUNITY_EVPN_SUBTYPE_ROUTERMAC))continue;memcpy(rmac,pnt,ETH_ALEN);}}/**r
eturntrueifattrcontainsdefaultgwextendedcommunity*/uint8_tbgp_attr_default_gw(st
ructattr*attr){structecommunity*ecom;inti;ecom=attr->ecommunity;if(!ecom||!ecom-
>size)return0;/*Ifthereisadefaultgwextenddcommunityreturntrueotherwise*return0*/
for(i=0;i<ecom->size;i++){uint8_t*pnt;uint8_ttype,sub_type;pnt=(ecom->val+(i*ECO
MMUNITY_SIZE));type=*pnt++;sub_type=*pnt++;if((type==ECOMMUNITY_ENCODE_OPAQUE&&s
ub_type==ECOMMUNITY_EVPN_SUBTYPE_DEF_GW))return1;}return0;}/**Fetchandreturnthes
equencenumberfromMACMobilityextended*community,ifpresent,else0.*/uint32_tbgp_att
r_mac_mobility_seqnum(structattr*attr,uint8_t*sticky){structecommunity*ecom;inti
;uint8_tflags=0;ecom=attr->ecommunity;if(!ecom||!ecom->size)return0;/*Ifthereisa
MACMobilityextendedcommunity,returnits*sequencenumber.*TODO:RFCissilentonhandlin
gofmultipleMACmobilityextended*communitiesforthesameroute.Wewillbailoutuponthefi
rst*one.*/for(i=0;i<ecom->size;i++){uint8_t*pnt;uint8_ttype,sub_type;uint32_tseq
_num;pnt=(ecom->val+(i*ECOMMUNITY_SIZE));type=*pnt++;sub_type=*pnt++;if(!(type==
ECOMMUNITY_ENCODE_EVPN&&sub_type==ECOMMUNITY_EVPN_SUBTYPE_MACMOBILITY))continue;
flags=*pnt++;if(flags&ECOMMUNITY_EVPN_SUBTYPE_MACMOBILITY_FLAG_STICKY)*sticky=1;
else*sticky=0;pnt++;pnt=ptr_get_be32(pnt,&seq_num);(void)pnt;/*consumevalue*/ret
urnseq_num;}return0;}/*dstprefixmustbeAF_INETorAF_INET6prefix,toforgeEVPNprefix*
/externintbgp_build_evpn_prefix(intevpn_type,uint32_teth_tag,structprefix*dst){s
tructevpn_addr*p_evpn_p;structprefixp2;structprefix*src=&p2;if(!dst||dst->family
==0)return-1;/*storeinitialprefixinsrc*/prefix_copy(src,dst);memset(dst,0,sizeof
(structprefix));p_evpn_p=&(dst->u.prefix_evpn);dst->family=AF_EVPN;p_evpn_p->rou
te_type=evpn_type;if(evpn_type==BGP_EVPN_IP_PREFIX_ROUTE){p_evpn_p->eth_tag=eth_
tag;p_evpn_p->ip_prefix_length=p2.prefixlen;if(src->family==AF_INET){SET_IPADDR_
V4(&p_evpn_p->ip);memcpy(&p_evpn_p->ip.ipaddr_v4,&src->u.prefix4,sizeof(structin
_addr));dst->prefixlen=(uint8_t)PREFIX_LEN_ROUTE_TYPE_5_IPV4;}else{SET_IPADDR_V6
(&p_evpn_p->ip);memcpy(&p_evpn_p->ip.ipaddr_v6,&src->u.prefix6,sizeof(structin6_
addr));dst->prefixlen=(uint8_t)PREFIX_LEN_ROUTE_TYPE_5_IPV6;}}elsereturn-1;retur
n0;}