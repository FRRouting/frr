/*BGPnetworkrelatedfucntions*Copyright(C)1999KunihiroIshiguro**ThisfileispartofG
NUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheterm
softheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversi
on2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillb
euseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include"thread.h"#include"sockunion.h"#
include"sockopt.h"#include"memory.h"#include"log.h"#include"if.h"#include"prefix
.h"#include"command.h"#include"privs.h"#include"linklist.h"#include"network.h"#i
nclude"queue.h"#include"hash.h"#include"filter.h"#include"ns.h"#include"bgpd/bgp
d.h"#include"bgpd/bgp_open.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_attr.h"#i
nclude"bgpd/bgp_debug.h"#include"bgpd/bgp_network.h"externstructzebra_privs_tbgp
d_privs;staticchar*bgp_get_bound_name(structpeer*peer);/*BGPlisteningsocket.*/st
ructbgp_listener{intfd;unionsockunionsu;structthread*thread;structbgp*bgp;};/**S
etMD5keyforthesocket,forthegivenIPv4peeraddress.*IfthepasswordisNULLorzero-lengt
h,theoptionwillbedisabled.*/staticintbgp_md5_set_socket(intsocket,unionsockunion
*su,constchar*password){intret=-1;inten=ENOSYS;#ifHAVE_DECL_TCP_MD5SIGunionsocku
nionsu2;#endif/*HAVE_TCP_MD5SIG*/assert(socket>=0);#ifHAVE_DECL_TCP_MD5SIG/*Ensu
rethereisnoextraneousportinformation.*/memcpy(&su2,su,sizeof(unionsockunion));if
(su2.sa.sa_family==AF_INET)su2.sin.sin_port=0;elsesu2.sin6.sin6_port=0;ret=socko
pt_tcp_signature(socket,&su2,password);en=errno;#endif/*HAVE_TCP_MD5SIG*/if(ret<
0)zlog_warn("can'tsetTCP_MD5SIGoptiononsocket%d:%s",socket,safe_strerror(en));re
turnret;}/*Helperforbgp_connect*/staticintbgp_md5_set_connect(intsocket,unionsoc
kunion*su,constchar*password){intret=-1;#ifHAVE_DECL_TCP_MD5SIGif(bgpd_privs.cha
nge(ZPRIVS_RAISE)){zlog_err("%s:couldnotraiseprivs",__func__);returnret;}ret=bgp
_md5_set_socket(socket,su,password);if(bgpd_privs.change(ZPRIVS_LOWER))zlog_err(
"%s:couldnotlowerprivs",__func__);#endif/*HAVE_TCP_MD5SIG*/returnret;}staticintb
gp_md5_set_password(structpeer*peer,constchar*password){structlistnode*node;intr
et=0;structbgp_listener*listener;if(bgpd_privs.change(ZPRIVS_RAISE)){zlog_err("%
s:couldnotraiseprivs",__func__);return-1;}/*Setorunsetthepasswordonthelistensock
et(s).Outbound*connections*aretakencareofinbgp_connect()below.*/for(ALL_LIST_ELE
MENTS_RO(bm->listen_sockets,node,listener))if(listener->su.sa.sa_family==peer->s
u.sa.sa_family){ret=bgp_md5_set_socket(listener->fd,&peer->su,password);break;}i
f(bgpd_privs.change(ZPRIVS_LOWER))zlog_err("%s:couldnotlowerprivs",__func__);ret
urnret;}intbgp_md5_set(structpeer*peer){/*Setthepasswordfromlistensocket.*/retur
nbgp_md5_set_password(peer,peer->password);}intbgp_md5_unset(structpeer*peer){/*
Unsetthepasswordfromlistensocket.*/returnbgp_md5_set_password(peer,NULL);}intbgp
_set_socket_ttl(structpeer*peer,intbgp_sock){charbuf[INET_ADDRSTRLEN];intret=0;/
*IncaseofpeerisEBGP,weshouldsetTTLforthisconnection.*/if(!peer->gtsm_hops&&(peer
_sort(peer)==BGP_PEER_EBGP)){ret=sockopt_ttl(peer->su.sa.sa_family,bgp_sock,peer
->ttl);if(ret){zlog_err("%s:Can'tsetTxTTLonpeer(rtrid%s)socket,err=%d",__func__,
inet_ntop(AF_INET,&peer->remote_id,buf,sizeof(buf)),errno);returnret;}}elseif(pe
er->gtsm_hops){/*OnLinux,settingminttlwithoutsettingttlseemstomesswiththeoutgoin
gttl.Thereforesettingboth.*/ret=sockopt_ttl(peer->su.sa.sa_family,bgp_sock,MAXTT
L);if(ret){zlog_err("%s:Can'tsetTxTTLonpeer(rtrid%s)socket,err=%d",__func__,inet
_ntop(AF_INET,&peer->remote_id,buf,sizeof(buf)),errno);returnret;}ret=sockopt_mi
nttl(peer->su.sa.sa_family,bgp_sock,MAXTTL+1-peer->gtsm_hops);if(ret){zlog_err("
%s:Can'tsetMinTTLonpeer(rtrid%s)socket,err=%d",__func__,inet_ntop(AF_INET,&peer-
>remote_id,buf,sizeof(buf)),errno);returnret;}}returnret;}/**ObtaintheBGPinstanc
ethattheincomingconnectionshouldbeprocessed*against.Thisisimportantbecausemoreth
anoneVRFcouldbeusingthe*sameIPaddressspace.Theinstanceisgotbyobtainingthedevicet
o*whichtheincomingconnectionisboundto.ThiscouldeitherbeaVRF*oritcouldbeaninterfa
ce,whichinturndeterminestheVRF.*/staticintbgp_get_instance_for_inc_conn(intsock,
structbgp**bgp_inst){#ifndefSO_BINDTODEVICE/*onlyLinuxhasSO_BINDTODEVICE,butwe'r
einLinux-specificcodehere*anywaysincetheassumptionisthattheinterfacenamereturned
by*getsockopt()isusefulinidentifyingtheVRF,particularlywith*Linux's*VRFl3masterd
evice.ThewholemechanismisspecifictoLinux,so...*whenotherplatformsaddVRFsupport,t
hiswillneedhandlinghereas*well.(or,somerestructuring)*/*bgp_inst=bgp_get_default
();return!*bgp_inst;#elsecharname[VRF_NAMSIZ+1];socklen_tname_len=VRF_NAMSIZ;str
uctbgp*bgp;intrc;structlistnode*node,*nnode;*bgp_inst=NULL;name[0]='\0';rc=getso
ckopt(sock,SOL_SOCKET,SO_BINDTODEVICE,name,&name_len);if(rc!=0){#ifdefined(HAVE_
CUMULUS)zlog_err("[Error]BGPSO_BINDTODEVICEgetfailed(%s),sock%d",safe_strerror(e
rrno),sock);return-1;#endif}if(!strlen(name)){*bgp_inst=bgp_get_default();return
0;/*defaultinstance.*/}/*Firsttrymatchtoinstance;ifthatfails,checkforinterfaces.
*/bgp=bgp_lookup_by_name(name);if(bgp){if(!bgp->vrf_id)//unexpectedreturn-1;*bgp
_inst=bgp;return0;}/*TODO-ThiswillbeoptimizedonceinterfacesmoveintotheNS*/for(AL
L_LIST_ELEMENTS(bm->bgp,node,nnode,bgp)){structinterface*ifp;if(bgp->inst_type==
BGP_INSTANCE_TYPE_VIEW)continue;ifp=if_lookup_by_name(name,bgp->vrf_id);if(ifp){
*bgp_inst=bgp;return0;}}/*Wedidn'tmatchtoeitheraninstanceoraninterface.*/return-
1;#endif}/*Acceptbgpconnection.*/staticintbgp_accept(structthread*thread){intbgp
_sock;intaccept_sock;unionsockunionsu;structbgp_listener*listener=THREAD_ARG(thr
ead);structpeer*peer;structpeer*peer1;charbuf[SU_ADDRSTRLEN];structbgp*bgp=NULL;
sockunion_init(&su);/*Registeracceptthread.*/accept_sock=THREAD_FD(thread);if(ac
cept_sock<0){zlog_err("accept_sockisnevativevalue%d",accept_sock);return-1;}list
ener->thread=NULL;thread_add_read(bm->master,bgp_accept,listener,accept_sock,&li
stener->thread);/*Acceptclientconnection.*/bgp_sock=sockunion_accept(accept_sock
,&su);if(bgp_sock<0){zlog_err("[Error]BGPsocketacceptfailed(%s)",safe_strerror(e
rrno));return-1;}set_nonblocking(bgp_sock);/*ObtainBGPinstancethisconnectionisme
antfor.*-ifitisaVRFnetnssock,thenBGPisinlistenerstructure*-otherwise,thebgpinsta
nceneedtobedemultiplexed*/if(listener->bgp)bgp=listener->bgp;elseif(bgp_get_inst
ance_for_inc_conn(bgp_sock,&bgp)){if(bgp_debug_neighbor_events(NULL))zlog_debug(
"[Event]Couldnotgetinstanceforincomingconnfrom%s",inet_sutop(&su,buf));close(bgp
_sock);return-1;}/*Setsocketsendbuffersize*/setsockopt_so_sendbuf(bgp_sock,BGP_S
OCKET_SNDBUF_SIZE);/*CheckremoteIPaddress*/peer1=peer_lookup(bgp,&su);if(!peer1)
{peer1=peer_lookup_dynamic_neighbor(bgp,&su);if(peer1){/*Dynamicneighborhasbeenc
reated,letitproceed*/peer1->fd=bgp_sock;bgp_fsm_change_status(peer1,Active);BGP_
TIMER_OFF(peer1->t_start);/*createdinpeer_create()*/if(peer_active(peer1))BGP_EV
ENT_ADD(peer1,TCP_connection_open);return0;}}if(!peer1){if(bgp_debug_neighbor_ev
ents(NULL)){zlog_debug("[Event]%sconnectionrejected-notconfigured""andnotvalidfo
rdynamic",inet_sutop(&su,buf));}close(bgp_sock);return-1;}if(CHECK_FLAG(peer1->f
lags,PEER_FLAG_SHUTDOWN)){if(bgp_debug_neighbor_events(peer1))zlog_debug("[Event
]connectionfrom%srejectedduetoadminshutdown",inet_sutop(&su,buf));close(bgp_sock
);return-1;}/**DonotacceptincomingconnectionsinClearingstate.Thiscanresult*ininc
orectstatetransitions-e.g.,theconnectiongoesbackto*EstablishedandthentheClearing
_Completedeventisgenerated.Also,*blockincomingconnectioninDeletedstate.*/if(peer
1->status==Clearing||peer1->status==Deleted){if(bgp_debug_neighbor_events(peer1)
)zlog_debug("[Event]Closingincomingconnfor%s(%p)state%d",peer1->host,peer1,peer1
->status);close(bgp_sock);return-1;}/*CheckthatatleastoneAFisactivatedforthepeer
.*/if(!peer_active(peer1)){if(bgp_debug_neighbor_events(peer1))zlog_debug("%s-in
comingconnrejected-noAFactivatedforpeer",peer1->host);close(bgp_sock);return-1;}
if(bgp_debug_neighbor_events(peer1))zlog_debug("[Event]BGPconnectionfromhost%sfd
%d",inet_sutop(&su,buf),bgp_sock);if(peer1->doppelganger){/*Wehaveanexistingconn
ection.Killtheexistingoneandrunwiththisone.*/if(bgp_debug_neighbor_events(peer1)
)zlog_debug("[Event]Newactiveconnectionfrompeer%s,Killing""previousactiveconnect
ion",peer1->host);peer_delete(peer1->doppelganger);}if(bgp_set_socket_ttl(peer1,
bgp_sock)<0)if(bgp_debug_neighbor_events(peer1))zlog_debug("[Event]Unabletosetmi
n/maxTTLonpeer%s,Continuing",peer1->host);peer=peer_create(&su,peer1->conf_if,pe
er1->bgp,peer1->local_as,peer1->as,peer1->as_type,0,0,NULL);peer->su=su;hash_rel
ease(peer->bgp->peerhash,peer);hash_get(peer->bgp->peerhash,peer,hash_alloc_inte
rn);peer_xfer_config(peer,peer1);UNSET_FLAG(peer->flags,PEER_FLAG_CONFIG_NODE);p
eer->doppelganger=peer1;peer1->doppelganger=peer;peer->fd=bgp_sock;vrf_bind(peer
->bgp->vrf_id,bgp_sock,bgp_get_bound_name(peer));bgp_fsm_change_status(peer,Acti
ve);BGP_TIMER_OFF(peer->t_start);/*createdinpeer_create()*/SET_FLAG(peer->sflags
,PEER_STATUS_ACCEPT_PEER);/*MakedummypeeruntilreadOpenpacket.*/if(peer1->status=
=Established&&CHECK_FLAG(peer1->sflags,PEER_STATUS_NSF_MODE)){/*Ifwehaveanexisti
ngestablishedconnectionwithgraceful*restart*capabilityannouncedwithoneormoreaddr
essfamilies,then*drop*existingestablishedconnectionandmovestatetoconnect.*/peer1
->last_reset=PEER_DOWN_NSF_CLOSE_SESSION;SET_FLAG(peer1->sflags,PEER_STATUS_NSF_
WAIT);bgp_event_update(peer1,TCP_connection_closed);}if(peer_active(peer)){BGP_E
VENT_ADD(peer,TCP_connection_open);}return0;}/*BGPsocketbind.*/staticchar*bgp_ge
t_bound_name(structpeer*peer){char*name=NULL;if(!peer)returnNULL;if((peer->bgp->
vrf_id==VRF_DEFAULT)&&!peer->ifname&&!peer->conf_if)returnNULL;if(peer->su.sa.sa
_family!=AF_INET&&peer->su.sa.sa_family!=AF_INET6)returnNULL;//unexpected/*ForIP
v6peering,interface(unnumberedorlink-localwithinterface)*takesprecedenceoverVRF.
ForIPv4peering,explicitinterfaceor*VRFarethesituationstobind.*/if(peer->su.sa.sa
_family==AF_INET6)name=(peer->conf_if?peer->conf_if:(peer->ifname?peer->ifname:p
eer->bgp->name));elsename=peer->ifname?peer->ifname:peer->bgp->name;returnname;}
staticintbgp_update_address(structinterface*ifp,constunionsockunion*dst,unionsoc
kunion*addr){structprefix*p,*sel,d;structconnected*connected;structlistnode*node
;intcommon;sockunion2hostprefix(dst,&d);sel=NULL;common=-1;for(ALL_LIST_ELEMENTS
_RO(ifp->connected,node,connected)){p=connected->address;if(p->family!=d.family)
continue;if(prefix_common_bits(p,&d)>common){sel=p;common=prefix_common_bits(sel
,&d);}}if(!sel)return1;prefix2sockunion(sel,addr);return0;}/*Updatesourceselecti
on.*/staticintbgp_update_source(structpeer*peer){structinterface*ifp;unionsockun
ionaddr;intret=0;sockunion_init(&addr);/*Sourceisspecifiedwithinterfacename.*/if
(peer->update_if){ifp=if_lookup_by_name(peer->update_if,peer->bgp->vrf_id);if(!i
fp)return-1;if(bgp_update_address(ifp,&peer->su,&addr))return-1;ret=sockunion_bi
nd(peer->fd,&addr,0,&addr);}/*SourceisspecifiedwithIPaddress.*/if(peer->update_s
ource)ret=sockunion_bind(peer->fd,peer->update_source,0,peer->update_source);ret
urnret;}#defineDATAPLANE_MARK254/*maintableID*//*BGPtrytoconnecttothepeer.*/intb
gp_connect(structpeer*peer){assert(!CHECK_FLAG(peer->thread_flags,PEER_THREAD_WR
ITES_ON));assert(!CHECK_FLAG(peer->thread_flags,PEER_THREAD_READS_ON));ifindex_t
ifindex=0;if(peer->conf_if&&BGP_PEER_SU_UNSPEC(peer)){zlog_debug("Peeraddressnot
learnt:Returningfromconnect");return0;}if(bgpd_privs.change(ZPRIVS_RAISE))zlog_e
rr("Can'traiseprivileges");/*Makesocketforthepeer.*/peer->fd=vrf_sockunion_socke
t(&peer->su,peer->bgp->vrf_id,bgp_get_bound_name(peer));if(bgpd_privs.change(ZPR
IVS_LOWER))zlog_err("Can'tlowerprivileges");if(peer->fd<0)return-1;set_nonblocki
ng(peer->fd);/*Setsocketsendbuffersize*/setsockopt_so_sendbuf(peer->fd,BGP_SOCKE
T_SNDBUF_SIZE);if(bgp_set_socket_ttl(peer,peer->fd)<0)return-1;sockopt_reuseaddr
(peer->fd);sockopt_reuseport(peer->fd);if(sockopt_mark_default(peer->fd,DATAPLAN
E_MARK,&bgpd_privs)<0)zlog_warn("UnabletosetmarkonFDforpeer%s,err=%s",peer->host
,safe_strerror(errno));#ifdefIPTOS_PREC_INTERNETCONTROLif(bgpd_privs.change(ZPRI
VS_RAISE))zlog_err("%s:couldnotraiseprivs",__func__);if(sockunion_family(&peer->
su)==AF_INET)setsockopt_ipv4_tos(peer->fd,IPTOS_PREC_INTERNETCONTROL);elseif(soc
kunion_family(&peer->su)==AF_INET6)setsockopt_ipv6_tclass(peer->fd,IPTOS_PREC_IN
TERNETCONTROL);if(bgpd_privs.change(ZPRIVS_LOWER))zlog_err("%s:couldnotlowerpriv
s",__func__);#endifif(peer->password)bgp_md5_set_connect(peer->fd,&peer->su,peer
->password);/*Updatesourcebind.*/if(bgp_update_source(peer)<0){returnconnect_err
or;}if(peer->conf_if||peer->ifname)ifindex=ifname2ifindex(peer->conf_if?peer->co
nf_if:peer->ifname,peer->bgp->vrf_id);if(bgp_debug_neighbor_events(peer))zlog_de
bug("%s[Event]Connectstartto%sfd%d",peer->host,peer->host,peer->fd);/*Connecttot
heremotepeer.*/returnsockunion_connect(peer->fd,&peer->su,htons(peer->port),ifin
dex);}/*AfterTCPconnectionisestablished.Getlocaladdressandport.*/intbgp_getsockn
ame(structpeer*peer){if(peer->su_local){sockunion_free(peer->su_local);peer->su_
local=NULL;}if(peer->su_remote){sockunion_free(peer->su_remote);peer->su_remote=
NULL;}peer->su_local=sockunion_getsockname(peer->fd);if(!peer->su_local)return-1
;peer->su_remote=sockunion_getpeername(peer->fd);if(!peer->su_remote)return-1;if
(bgp_nexthop_set(peer->su_local,peer->su_remote,&peer->nexthop,peer)){#ifdefined
(HAVE_CUMULUS)zlog_err("%s:nexthop_setfailed,resettingconnection-intf%p",peer->h
ost,peer->nexthop.ifp);return-1;#endif}return0;}staticintbgp_listener(intsock,st
ructsockaddr*sa,socklen_tsalen,structbgp*bgp){structbgp_listener*listener;intret
,en;sockopt_reuseaddr(sock);sockopt_reuseport(sock);if(bgpd_privs.change(ZPRIVS_
RAISE))zlog_err("%s:couldnotraiseprivs",__func__);#ifdefIPTOS_PREC_INTERNETCONTR
OLif(sa->sa_family==AF_INET)setsockopt_ipv4_tos(sock,IPTOS_PREC_INTERNETCONTROL)
;elseif(sa->sa_family==AF_INET6)setsockopt_ipv6_tclass(sock,IPTOS_PREC_INTERNETC
ONTROL);#endifsockopt_v6only(sa->sa_family,sock);ret=bind(sock,sa,salen);en=errn
o;if(bgpd_privs.change(ZPRIVS_LOWER))zlog_err("%s:couldnotlowerprivs",__func__);
if(ret<0){zlog_err("bind:%s",safe_strerror(en));returnret;}ret=listen(sock,SOMAX
CONN);if(ret<0){zlog_err("listen:%s",safe_strerror(errno));returnret;}listener=X
CALLOC(MTYPE_BGP_LISTENER,sizeof(*listener));listener->fd=sock;/*thissocketneeds
achangeofns.recordbgpbackpointer*/if(bgp->vrf_id!=VRF_DEFAULT&&vrf_is_mapped_on_
netns(bgp->vrf_id))listener->bgp=bgp;memcpy(&listener->su,sa,salen);listener->th
read=NULL;thread_add_read(bm->master,bgp_accept,listener,sock,&listener->thread)
;listnode_add(bm->listen_sockets,listener);return0;}/*IPv6supportedversionofBGPs
erversocketsetup.*/intbgp_socket(structbgp*bgp,unsignedshortport,constchar*addre
ss){structaddrinfo*ainfo;structaddrinfo*ainfo_save;staticconststructaddrinforeq=
{.ai_family=AF_UNSPEC,.ai_flags=AI_PASSIVE,.ai_socktype=SOCK_STREAM,};intret,cou
nt;charport_str[BUFSIZ];snprintf(port_str,sizeof(port_str),"%d",port);port_str[s
izeof(port_str)-1]='\0';if(bgpd_privs.change(ZPRIVS_RAISE))zlog_err("Can'traisep
rivileges");ret=vrf_getaddrinfo(address,port_str,&req,&ainfo_save,bgp->vrf_id);i
f(bgpd_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerprivileges");if(ret!=0){zl
og_err("getaddrinfo:%s",gai_strerror(ret));return-1;}count=0;for(ainfo=ainfo_sav
e;ainfo;ainfo=ainfo->ai_next){intsock;if(ainfo->ai_family!=AF_INET&&ainfo->ai_fa
mily!=AF_INET6)continue;if(bgpd_privs.change(ZPRIVS_RAISE))zlog_err("Can'traisep
rivileges");sock=vrf_socket(ainfo->ai_family,ainfo->ai_socktype,ainfo->ai_protoc
ol,bgp->vrf_id,NULL);if(bgpd_privs.change(ZPRIVS_LOWER))zlog_err("Can'tlowerpriv
ileges");if(sock<0){zlog_err("socket:%s",safe_strerror(errno));continue;}/*ifwei
ntendtoimplementttl-security,thissocketneeds*ttl=255*/sockopt_ttl(ainfo->ai_fami
ly,sock,MAXTTL);ret=bgp_listener(sock,ainfo->ai_addr,ainfo->ai_addrlen,bgp);if(r
et==0)++count;elseclose(sock);}freeaddrinfo(ainfo_save);if(count==0){zlog_err("%
s:nousableaddressespleasecheckotherprogramsusageofspecifiedport%d",__func__,port
);zlog_err("%s:Programcannotcontinue",__func__);exit(-1);}return0;}/*thisfunctio
nclosesvrfsocket*thisshouldbecalledonlyforvrfsocketwithnetnsbackend*/voidbgp_clo
se_vrf_socket(structbgp*bgp){structlistnode*node,*next;structbgp_listener*listen
er;if(!bgp)return;if(bm->listen_sockets==NULL)return;for(ALL_LIST_ELEMENTS(bm->l
isten_sockets,node,next,listener)){if(listener->bgp==bgp){thread_cancel(listener
->thread);close(listener->fd);listnode_delete(bm->listen_sockets,listener);XFREE
(MTYPE_BGP_LISTENER,listener);}}}/*thisfunctionclosesmainsocket*/voidbgp_close(v
oid){structlistnode*node,*next;structbgp_listener*listener;if(bm->listen_sockets
==NULL)return;for(ALL_LIST_ELEMENTS(bm->listen_sockets,node,next,listener)){if(l
istener->bgp)continue;thread_cancel(listener->thread);close(listener->fd);listno
de_delete(bm->listen_sockets,listener);XFREE(MTYPE_BGP_LISTENER,listener);}}