/***bgp_updgrp_adv.c:BGPupdategroupadvertisementandadjacency*maintenance***@copy
rightCopyright(C)2014CumulusNetworks,Inc.**@authorAvneeshSachdev<avneesh@sproute
.net>*@authorRajeshVaradarajan<rajesh@sproute.net>*@authorPradoshMohapatra<prado
sh@sproute.net>**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistr
ibuteitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*
FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebr
aisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventhei
mpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*General
PublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLic
ensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundat
ion,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#inclu
de"command.h"#include"memory.h"#include"prefix.h"#include"hash.h"#include"thread
.h"#include"queue.h"#include"routemap.h"#include"filter.h"#include"bgpd/bgpd.h"#
include"bgpd/bgp_table.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_route.h"#in
clude"bgpd/bgp_advertise.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_aspath.h"#
include"bgpd/bgp_packet.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_mplsvpn.h"#i
nclude"bgpd/bgp_updgrp.h"#include"bgpd/bgp_advertise.h"/*********************PRI
VATEFUNCTIONS********************/staticinlinestructbgp_adj_out*adj_lookup(struc
tbgp_node*rn,structupdate_subgroup*subgrp,uint32_taddpath_tx_id){structbgp_adj_o
ut*adj;structpeer*peer;afi_tafi;safi_tsafi;intaddpath_capable;if(!rn||!subgrp)re
turnNULL;peer=SUBGRP_PEER(subgrp);afi=SUBGRP_AFI(subgrp);safi=SUBGRP_SAFI(subgrp
);addpath_capable=bgp_addpath_encode_tx(peer,afi,safi);/*update-groupsthatdonots
upportaddpathwillpass0for*addpath_tx_idsodonotbothmatchingagainstit*/for(adj=rn-
>adj_out;adj;adj=adj->next){if(adj->subgroup==subgrp){if(addpath_capable){if(adj
->addpath_tx_id==addpath_tx_id){break;}}else{break;}}}returnadj;}staticvoidadj_f
ree(structbgp_adj_out*adj){TAILQ_REMOVE(&(adj->subgroup->adjq),adj,subgrp_adj_tr
ain);SUBGRP_DECR_STAT(adj->subgroup,adj_count);XFREE(MTYPE_BGP_ADJ_OUT,adj);}sta
ticintgroup_announce_route_walkcb(structupdate_group*updgrp,void*arg){structupdw
alk_context*ctx=arg;structupdate_subgroup*subgrp;structbgp_info*ri;afi_tafi;safi
_tsafi;structpeer*peer;structbgp_adj_out*adj,*adj_next;intaddpath_capable;afi=UP
DGRP_AFI(updgrp);safi=UPDGRP_SAFI(updgrp);peer=UPDGRP_PEER(updgrp);addpath_capab
le=bgp_addpath_encode_tx(peer,afi,safi);if(BGP_DEBUG(update,UPDATE_OUT)){charbuf
_prefix[PREFIX_STRLEN];prefix2str(&ctx->rn->p,buf_prefix,sizeof(buf_prefix));zlo
g_debug("%s:afi=%s,safi=%s,p=%s",__func__,afi2str(afi),safi2str(safi),buf_prefix
);}UPDGRP_FOREACH_SUBGRP(updgrp,subgrp){/**Skipthesubgroupsthathavecoalescetimer
running.Wewill*walktheentireprefixtableforthosesubgroupswhenthe*coalescetimerfir
es.*/if(!subgrp->t_coalesce){/*Anupdate-groupthatusesaddpath*/if(addpath_capable
){/*Lookthroughallofthepathswehave*advertisedforthisrnand*sendawithdrawfortheone
sthatareno*longerpresent*/for(adj=ctx->rn->adj_out;adj;adj=adj_next){adj_next=ad
j->next;if(adj->subgroup==subgrp){for(ri=ctx->rn->info;ri;ri=ri->next){if(ri->ad
dpath_tx_id==adj->addpath_tx_id){break;}}if(!ri){subgroup_process_announce_selec
ted(subgrp,NULL,ctx->rn,adj->addpath_tx_id);}}}for(ri=ctx->rn->info;ri;ri=ri->ne
xt){/*Skipthebestpathfornow*/if(ri==ctx->ri)continue;subgroup_process_announce_s
elected(subgrp,ri,ctx->rn,ri->addpath_tx_id);}/*Processthebestpathlastsothe"show
[ip]*bgpneighborx.x.x.xadvertised"*outputshowstheattributesfromthebestpath*/if(c
tx->ri)subgroup_process_announce_selected(subgrp,ctx->ri,ctx->rn,ctx->ri->addpat
h_tx_id);}/*Anupdate-groupthatdoesnotuseaddpath*/else{if(ctx->ri){subgroup_proce
ss_announce_selected(subgrp,ctx->ri,ctx->rn,ctx->ri->addpath_tx_id);}else{/*Find
theaddpath_tx_idofthepathwe*hadadvertisedand*sendawithdraw*/for(adj=ctx->rn->adj
_out;adj;adj=adj_next){adj_next=adj->next;if(adj->subgroup==subgrp){subgroup_pro
cess_announce_selected(subgrp,NULL,ctx->rn,adj->addpath_tx_id);}}}}}}returnUPDWA
LK_CONTINUE;}staticvoidsubgrp_show_adjq_vty(structupdate_subgroup*subgrp,structv
ty*vty,uint8_tflags){structbgp_table*table;structbgp_adj_out*adj;unsignedlongout
put_count;structbgp_node*rn;intheader1=1;structbgp*bgp;intheader2=1;bgp=SUBGRP_I
NST(subgrp);if(!bgp)return;table=bgp->rib[SUBGRP_AFI(subgrp)][SUBGRP_SAFI(subgrp
)];output_count=0;for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn))for(adj=r
n->adj_out;adj;adj=adj->next)if(adj->subgroup==subgrp){if(header1){vty_out(vty,"
BGPtableversionis%"PRIu64",localrouterIDis%s\n",table->version,inet_ntoa(bgp->ro
uter_id));vty_out(vty,BGP_SHOW_SCODE_HEADER);vty_out(vty,BGP_SHOW_OCODE_HEADER);
header1=0;}if(header2){vty_out(vty,BGP_SHOW_HEADER);header2=0;}if((flags&UPDWALK
_FLAGS_ADVQUEUE)&&adj->adv&&adj->adv->baa){route_vty_out_tmp(vty,&rn->p,adj->adv
->baa->attr,SUBGRP_SAFI(subgrp),0,NULL);output_count++;}if((flags&UPDWALK_FLAGS_
ADVERTISED)&&adj->attr){route_vty_out_tmp(vty,&rn->p,adj->attr,SUBGRP_SAFI(subgr
p),0,NULL);output_count++;}}if(output_count!=0)vty_out(vty,"\nTotalnumberofprefi
xes%ld\n",output_count);}staticintupdgrp_show_adj_walkcb(structupdate_group*updg
rp,void*arg){structupdwalk_context*ctx=arg;structupdate_subgroup*subgrp;structvt
y*vty;vty=ctx->vty;UPDGRP_FOREACH_SUBGRP(updgrp,subgrp){if(ctx->subgrp_id&&(ctx-
>subgrp_id!=subgrp->id))continue;vty_out(vty,"updategroup%"PRIu64",subgroup%"PRI
u64"\n",updgrp->id,subgrp->id);subgrp_show_adjq_vty(subgrp,vty,ctx->flags);}retu
rnUPDWALK_CONTINUE;}staticvoidupdgrp_show_adj(structbgp*bgp,afi_tafi,safi_tsafi,
structvty*vty,uint64_tid,uint8_tflags){structupdwalk_contextctx;memset(&ctx,0,si
zeof(ctx));ctx.vty=vty;ctx.subgrp_id=id;ctx.flags=flags;update_group_af_walk(bgp
,afi,safi,updgrp_show_adj_walkcb,&ctx);}staticintsubgroup_coalesce_timer(structt
hread*thread){structupdate_subgroup*subgrp;subgrp=THREAD_ARG(thread);if(bgp_debu
g_update(NULL,NULL,subgrp->update_group,0))zlog_debug("u%"PRIu64":s%"PRIu64"anno
uncingroutesuponcoalescetimerexpiry",(SUBGRP_UPDGRP(subgrp))->id,subgrp->id);sub
grp->t_coalesce=NULL;subgrp->v_coalesce=0;subgroup_announce_route(subgrp);/*Whil
etheannounce_route()maykickofftherouteadvertisementtimer*for*themembersofthesubg
roup,we'dliketosendtheinitialupdates*much*faster(i.e.,withoutenforcingMRAI).Also
,iftherewerenoroutes*to*announce,thisisthemethodcurrentlyemployedtotriggertheEOR
.*/if(!bgp_update_delay_active(SUBGRP_INST(subgrp))){structpeer_af*paf;structpee
r*peer;SUBGRP_FOREACH_PEER(subgrp,paf){peer=PAF_PEER(paf);BGP_TIMER_OFF(peer->t_
routeadv);BGP_TIMER_ON(peer->t_routeadv,bgp_routeadv_timer,0);}}return0;}statici
ntupdate_group_announce_walkcb(structupdate_group*updgrp,void*arg){structupdate_
subgroup*subgrp;UPDGRP_FOREACH_SUBGRP(updgrp,subgrp){subgroup_announce_all(subgr
p);}returnUPDWALK_CONTINUE;}staticintupdate_group_announce_rrc_walkcb(structupda
te_group*updgrp,void*arg){structupdate_subgroup*subgrp;afi_tafi;safi_tsafi;struc
tpeer*peer;afi=UPDGRP_AFI(updgrp);safi=UPDGRP_SAFI(updgrp);peer=UPDGRP_PEER(updg
rp);/*Onlyannounceifthisisagroupofroute-reflector-clients*/if(CHECK_FLAG(peer->a
f_flags[afi][safi],PEER_FLAG_REFLECTOR_CLIENT)){UPDGRP_FOREACH_SUBGRP(updgrp,sub
grp){subgroup_announce_all(subgrp);}}returnUPDWALK_CONTINUE;}/******************
***PUBLICFUNCTIONS********************//***Allocateanadj-outobject.Doproperiniti
alizationofitsfields,*primarilyitsassociationwiththesubgroupandtheprefix.*/struc
tbgp_adj_out*bgp_adj_out_alloc(structupdate_subgroup*subgrp,structbgp_node*rn,ui
nt32_taddpath_tx_id){structbgp_adj_out*adj;adj=XCALLOC(MTYPE_BGP_ADJ_OUT,sizeof(
structbgp_adj_out));adj->subgroup=subgrp;if(rn){BGP_ADJ_OUT_ADD(rn,adj);bgp_lock
_node(rn);adj->rn=rn;}adj->addpath_tx_id=addpath_tx_id;TAILQ_INSERT_TAIL(&(subgr
p->adjq),adj,subgrp_adj_train);SUBGRP_INCR_STAT(subgrp,adj_count);returnadj;}str
uctbgp_advertise*bgp_advertise_clean_subgroup(structupdate_subgroup*subgrp,struc
tbgp_adj_out*adj){structbgp_advertise*adv;structbgp_advertise_attr*baa;structbgp
_advertise*next;structbgp_advertise_fifo*fhead;adv=adj->adv;baa=adv->baa;next=NU
LL;if(baa){fhead=&subgrp->sync->update;/*UnlinkmyselffromadvertiseattributeFIFO.
*/bgp_advertise_delete(baa,adv);/*Fetchnextadvertisecandidate.*/next=baa->adv;/*
UninternBGPadvertiseattribute.*/bgp_advertise_unintern(subgrp->hash,baa);}elsefh
ead=&subgrp->sync->withdraw;/*UnlinkmyselffromadvertisementFIFO.*/BGP_ADV_FIFO_D
EL(fhead,adv);/*Freememory.*/bgp_advertise_free(adj->adv);adj->adv=NULL;returnne
xt;}voidbgp_adj_out_set_subgroup(structbgp_node*rn,structupdate_subgroup*subgrp,
structattr*attr,structbgp_info*binfo){structbgp_adj_out*adj=NULL;structbgp_adver
tise*adv;if(DISABLE_BGP_ANNOUNCE)return;/*Lookforadjacencyinformation.*/adj=adj_
lookup(rn,subgrp,binfo->addpath_tx_id);if(!adj){adj=bgp_adj_out_alloc(subgrp,rn,
binfo->addpath_tx_id);if(!adj)return;}if(adj->adv)bgp_advertise_clean_subgroup(s
ubgrp,adj);adj->adv=bgp_advertise_new();adv=adj->adv;adv->rn=rn;assert(adv->binf
o==NULL);adv->binfo=bgp_info_lock(binfo);/*bgp_infoadj_outreference*/if(attr)adv
->baa=bgp_advertise_intern(subgrp->hash,attr);elseadv->baa=baa_new();adv->adj=ad
j;/*Addnewadvertisementtoadvertisementattributelist.*/bgp_advertise_add(adv->baa
,adv);/**Iftheupdateadvlistisempty,triggerthememberpeers'*mraitimerssothesocketw
ritescanhappen.*/if(BGP_ADV_FIFO_EMPTY(&subgrp->sync->update)){structpeer_af*paf
;SUBGRP_FOREACH_PEER(subgrp,paf){bgp_adjust_routeadv(PAF_PEER(paf));}}BGP_ADV_FI
FO_ADD(&subgrp->sync->update,&adv->fifo);subgrp->version=max(subgrp->version,rn-
>version);}/*Theonlytime'withdraw'willbefalseisifwearesending*the"neighborx.x.x.
xdefault-originate"defaultandneedtoclear*bgp_adj_outforthe0.0.0.0/0routeintheBGP
table.*/voidbgp_adj_out_unset_subgroup(structbgp_node*rn,structupdate_subgroup*s
ubgrp,charwithdraw,uint32_taddpath_tx_id){structbgp_adj_out*adj;structbgp_advert
ise*adv;booltrigger_write;if(DISABLE_BGP_ANNOUNCE)return;/*Lookupexistingadjacen
cy*/if((adj=adj_lookup(rn,subgrp,addpath_tx_id))!=NULL){/*Cleanuppreviousadverti
sement.*/if(adj->adv)bgp_advertise_clean_subgroup(subgrp,adj);if(adj->attr&&with
draw){/*Weneedadvertisementstructure.*/adj->adv=bgp_advertise_new();adv=adj->adv
;adv->rn=rn;adv->adj=adj;/*Noteifweneedtotriggerapacketwrite*/trigger_write=BGP_
ADV_FIFO_EMPTY(&subgrp->sync->withdraw);/*Addtosynchronizationentryforwithdraw*a
nnouncement.*/BGP_ADV_FIFO_ADD(&subgrp->sync->withdraw,&adv->fifo);if(trigger_wr
ite)subgroup_trigger_write(subgrp);}else{/*Removemyselffromadjacency.*/BGP_ADJ_O
UT_DEL(rn,adj);/*Freeallocatedinformation.*/adj_free(adj);bgp_unlock_node(rn);}}
subgrp->version=max(subgrp->version,rn->version);}voidbgp_adj_out_remove_subgrou
p(structbgp_node*rn,structbgp_adj_out*adj,structupdate_subgroup*subgrp){if(adj->
attr)bgp_attr_unintern(&adj->attr);if(adj->adv)bgp_advertise_clean_subgroup(subg
rp,adj);BGP_ADJ_OUT_DEL(rn,adj);adj_free(adj);}/**Gothroughalltheroutesandcleanu
ptheadj/advstructurescorresponding*tothesubgroup.*/voidsubgroup_clear_table(stru
ctupdate_subgroup*subgrp){structbgp_adj_out*aout,*taout;SUBGRP_FOREACH_ADJ_SAFE(
subgrp,aout,taout){structbgp_node*rn=aout->rn;bgp_adj_out_remove_subgroup(rn,aou
t,subgrp);bgp_unlock_node(rn);}}/**subgroup_announce_table*/voidsubgroup_announc
e_table(structupdate_subgroup*subgrp,structbgp_table*table){structbgp_node*rn;st
ructbgp_info*ri;structattrattr;structpeer*peer;afi_tafi;safi_tsafi;intaddpath_ca
pable;peer=SUBGRP_PEER(subgrp);afi=SUBGRP_AFI(subgrp);safi=SUBGRP_SAFI(subgrp);a
ddpath_capable=bgp_addpath_encode_tx(peer,afi,safi);if(safi==SAFI_LABELED_UNICAS
T)safi=SAFI_UNICAST;if(!table)table=peer->bgp->rib[afi][safi];if(safi!=SAFI_MPLS
_VPN&&safi!=SAFI_ENCAP&&safi!=SAFI_EVPN&&CHECK_FLAG(peer->af_flags[afi][safi],PE
ER_FLAG_DEFAULT_ORIGINATE))subgroup_default_originate(subgrp,0);for(rn=bgp_table
_top(table);rn;rn=bgp_route_next(rn))for(ri=rn->info;ri;ri=ri->next)if(CHECK_FLA
G(ri->flags,BGP_INFO_SELECTED)||(addpath_capable&&bgp_addpath_tx_path(peer,afi,s
afi,ri))){if(subgroup_announce_check(rn,ri,subgrp,&rn->p,&attr))bgp_adj_out_set_
subgroup(rn,subgrp,&attr,ri);elsebgp_adj_out_unset_subgroup(rn,subgrp,1,ri->addp
ath_tx_id);}/**Wewalkedthroughthewholetable--makesureourversionnumber*isconsiste
ntwiththeoneonthetable.Thisshouldallow*subgroupstomergesoonerifapeercomesupwhent
heroutenode*withthelargestversionisnolongerinthetable.Thisalso*coversthepatholog
icalcasewhereallroutesinthetablehave*nowbeendeleted.*/subgrp->version=max(subgrp
->version,table->version);/**Startatasktomergethesubgroupifnecessary.*/update_su
bgroup_trigger_merge_check(subgrp,0);}/**subgroup_announce_route**Refreshallrout
esouttoasubgroup.*/voidsubgroup_announce_route(structupdate_subgroup*subgrp){str
uctbgp_node*rn;structbgp_table*table;structpeer*onlypeer;if(update_subgroup_need
s_refresh(subgrp)){update_subgroup_set_needs_refresh(subgrp,0);}/**Firstupdateis
deferreduntilORForROUTE-REFRESHisreceived*/onlypeer=((SUBGRP_PCOUNT(subgrp)==1)?
(SUBGRP_PFIRST(subgrp))->peer:NULL);if(onlypeer&&CHECK_FLAG(onlypeer->af_sflags[
SUBGRP_AFI(subgrp)][SUBGRP_SAFI(subgrp)],PEER_STATUS_ORF_WAIT_REFRESH))return;if
(SUBGRP_SAFI(subgrp)!=SAFI_MPLS_VPN&&SUBGRP_SAFI(subgrp)!=SAFI_ENCAP&&SUBGRP_SAF
I(subgrp)!=SAFI_EVPN)subgroup_announce_table(subgrp,NULL);elsefor(rn=bgp_table_t
op(update_subgroup_rib(subgrp));rn;rn=bgp_route_next(rn))if((table=(rn->info))!=
NULL)subgroup_announce_table(subgrp,table);}voidsubgroup_default_originate(struc
tupdate_subgroup*subgrp,intwithdraw){structbgp*bgp;structattrattr;structaspath*a
spath;structprefixp;structpeer*from;structbgp_node*rn;structbgp_info*ri;structpe
er*peer;intret=RMAP_DENYMATCH;afi_tafi;safi_tsafi;if(!subgrp)return;peer=SUBGRP_
PEER(subgrp);afi=SUBGRP_AFI(subgrp);safi=SUBGRP_SAFI(subgrp);if(!(afi==AFI_IP||a
fi==AFI_IP6))return;bgp=peer->bgp;from=bgp->peer_self;bgp_attr_default_set(&attr
,BGP_ORIGIN_IGP);aspath=attr.aspath;attr.local_pref=bgp->default_local_pref;mems
et(&p,0,sizeof(p));p.family=afi2family(afi);p.prefixlen=0;if((afi==AFI_IP6)||pee
r_cap_enhe(peer,afi,safi)){/*IPv6globalnexthopmustbeincluded.*/attr.mp_nexthop_l
en=BGP_ATTR_NHLEN_IPV6_GLOBAL;/*Ifthepeerisonsharednextworkandwehavelink-localne
xthopsetit.*/if(peer->shared_network&&!IN6_IS_ADDR_UNSPECIFIED(&peer->nexthop.v6
_local))attr.mp_nexthop_len=BGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL;}if(peer->default_
rmap[afi][safi].name){SET_FLAG(bgp->peer_self->rmap_type,PEER_RMAP_TYPE_DEFAULT)
;for(rn=bgp_table_top(bgp->rib[afi][safi]);rn;rn=bgp_route_next(rn)){for(ri=rn->
info;ri;ri=ri->next){structattrdummy_attr;structbgp_infoinfo;/*Providedummysothe
route-mapcan'tmodify*theattributes*/bgp_attr_dup(&dummy_attr,ri->attr);info.peer
=ri->peer;info.attr=&dummy_attr;ret=route_map_apply(peer->default_rmap[afi][safi
].map,&rn->p,RMAP_BGP,&info);/*Theroutemapmighthavesetattributes.If*wedon'tflush
them*here,theywillbeleaked.*/bgp_attr_flush(&dummy_attr);if(ret!=RMAP_DENYMATCH)
break;}if(ret!=RMAP_DENYMATCH)break;}bgp->peer_self->rmap_type=0;if(ret==RMAP_DE
NYMATCH)withdraw=1;}if(withdraw){if(CHECK_FLAG(subgrp->sflags,SUBGRP_STATUS_DEFA
ULT_ORIGINATE))subgroup_default_withdraw_packet(subgrp);UNSET_FLAG(subgrp->sflag
s,SUBGRP_STATUS_DEFAULT_ORIGINATE);}else{if(!CHECK_FLAG(subgrp->sflags,SUBGRP_ST
ATUS_DEFAULT_ORIGINATE)){if(bgp_flag_check(bgp,BGP_FLAG_GRACEFUL_SHUTDOWN)){bgp_
attr_add_gshut_community(&attr);}SET_FLAG(subgrp->sflags,SUBGRP_STATUS_DEFAULT_O
RIGINATE);subgroup_default_update_packet(subgrp,&attr,from);/*The'neighborx.x.x.
xdefault-originate'defaultwill*actasan*implicitwithdrawforanypreviousUPDATEssent
for*0.0.0.0/0so*clearadj_outforthe0.0.0.0/0prefixintheBGP*table.*/memset(&p,0,si
zeof(p));p.family=afi2family(afi);p.prefixlen=0;rn=bgp_afi_node_get(bgp->rib[afi
][safi],afi,safi,&p,NULL);bgp_adj_out_unset_subgroup(rn,subgrp,0,BGP_ADDPATH_TX_
ID_FOR_DEFAULT_ORIGINATE);}}aspath_unintern(&aspath);}/**AnnouncetheBGPtabletoas
ubgroup.**Atstartup,wetrytooptimizerouteannouncementbycoalescingthe*peer-upevent
s.Thisisdoneonlythefirsttime-fromthenon,*subgrp->v_coalescewillbesettozeroandthe
normallogic*prevails.*/voidsubgroup_announce_all(structupdate_subgroup*subgrp){i
f(!subgrp)return;/**Ifcoalescetimervalueisnotset,announceroutesimmediately.*/if(
!subgrp->v_coalesce){if(bgp_debug_update(NULL,NULL,subgrp->update_group,0))zlog_
debug("u%"PRIu64":s%"PRIu64"announcingallroutes",subgrp->update_group->id,subgrp
->id);subgroup_announce_route(subgrp);return;}/**Weshouldwaitforthecoalescetimer
.Armthetimerifnotdone.*/if(!subgrp->t_coalesce){thread_add_timer_msec(bm->master
,subgroup_coalesce_timer,subgrp,subgrp->v_coalesce,&subgrp->t_coalesce);}}/**Got
hroughallupdatesubgroupsandsetuptheadvqueueforthe*inputroute.*/voidgroup_announc
e_route(structbgp*bgp,afi_tafi,safi_tsafi,structbgp_node*rn,structbgp_info*ri){s
tructupdwalk_contextctx;ctx.ri=ri;ctx.rn=rn;update_group_af_walk(bgp,afi,safi,gr
oup_announce_route_walkcb,&ctx);}voidupdate_group_show_adj_queue(structbgp*bgp,a
fi_tafi,safi_tsafi,structvty*vty,uint64_tid){updgrp_show_adj(bgp,afi,safi,vty,id
,UPDWALK_FLAGS_ADVQUEUE);}voidupdate_group_show_advertised(structbgp*bgp,afi_taf
i,safi_tsafi,structvty*vty,uint64_tid){updgrp_show_adj(bgp,afi,safi,vty,id,UPDWA
LK_FLAGS_ADVERTISED);}voidupdate_group_announce(structbgp*bgp){update_group_walk
(bgp,update_group_announce_walkcb,NULL);}voidupdate_group_announce_rrclients(str
uctbgp*bgp){update_group_walk(bgp,update_group_announce_rrc_walkcb,NULL);}