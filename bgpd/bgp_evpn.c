/*Ethernet-VPNPacketandvtyProcessingFile*Copyright(C)20166WIND*Copyright(C)2017C
umulusNetworks,Inc.**ThisfileispartofFRR.**FRRoutingisfreesoftware;youcanredistr
ibuteitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*
FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**FRRouti
ngisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventhe
impliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*Genera
lPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLi
censealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Founda
tion,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#incl
ude"command.h"#include"filter.h"#include"prefix.h"#include"log.h"#include"memory
.h"#include"stream.h"#include"hash.h"#include"jhash.h"#include"bitfield.h"#inclu
de"zclient.h"#include"bgpd/bgp_attr_evpn.h"#include"bgpd/bgpd.h"#include"bgpd/bg
p_table.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_m
plsvpn.h"#include"bgpd/bgp_label.h"#include"bgpd/bgp_evpn.h"#include"bgpd/bgp_ev
pn_private.h"#include"bgpd/bgp_ecommunity.h"#include"bgpd/bgp_encap_types.h"#inc
lude"bgpd/bgp_debug.h"#include"bgpd/bgp_aspath.h"#include"bgpd/bgp_zebra.h"#incl
ude"bgpd/bgp_nexthop.h"/**Definitionsandexternaldeclarations.*/externstructzclie
nt*zclient;DEFINE_QOBJ_TYPE(bgpevpn)/**Staticfunctiondeclarations*/staticvoiddel
ete_evpn_route_entry(structbgp*bgp,structbgpevpn*vpn,afi_tafi,safi_tsafi,structb
gp_node*rn,structbgp_info**ri);staticintdelete_all_vni_routes(structbgp*bgp,stru
ctbgpevpn*vpn);/**Privatefunctions.*//**Makevnihashkey.*/staticunsignedintvni_ha
sh_key_make(void*p){structbgpevpn*vpn=p;return(jhash_1word(vpn->vni,0));}/**Comp
arisonfunctionforvnihash*/staticintvni_hash_cmp(constvoid*p1,constvoid*p2){const
structbgpevpn*vpn1=p1;conststructbgpevpn*vpn2=p2;if(!vpn1&&!vpn2)return1;if(!vpn
1||!vpn2)return0;return(vpn1->vni==vpn2->vni);}/**Makevrfimportroutetargethashke
y.*/staticunsignedintvrf_import_rt_hash_key_make(void*p){structvrf_irt_node*irt=
p;char*pnt=irt->rt.val;returnjhash(pnt,8,0x5abc1234);}/**Comparisonfunctionforvr
fimportrthash*/staticintvrf_import_rt_hash_cmp(constvoid*p1,constvoid*p2){consts
tructvrf_irt_node*irt1=p1;conststructvrf_irt_node*irt2=p2;if(irt1==NULL&&irt2==N
ULL)return1;if(irt1==NULL||irt2==NULL)return0;return(memcmp(irt1->rt.val,irt2->r
t.val,ECOMMUNITY_SIZE)==0);}/**Createanewvrfimport_rtindefaultinstance*/staticst
ructvrf_irt_node*vrf_import_rt_new(structecommunity_val*rt){structbgp*bgp_def=NU
LL;structvrf_irt_node*irt;bgp_def=bgp_get_default();if(!bgp_def){zlog_err("vrfim
portrtnew-definstancenotcreatedyet");returnNULL;}irt=XCALLOC(MTYPE_BGP_EVPN_VRF_
IMPORT_RT,sizeof(structvrf_irt_node));if(!irt)returnNULL;irt->rt=*rt;irt->vrfs=l
ist_new();/*Addtohash*/if(!hash_get(bgp_def->vrf_import_rt_hash,irt,hash_alloc_i
ntern)){XFREE(MTYPE_BGP_EVPN_VRF_IMPORT_RT,irt);returnNULL;}returnirt;}/**Freeth
evrfimportrtnode*/staticvoidvrf_import_rt_free(structvrf_irt_node*irt){structbgp
*bgp_def=NULL;bgp_def=bgp_get_default();if(!bgp_def){zlog_err("vrfimportrtfree-d
efinstancenotcreatedyet");return;}hash_release(bgp_def->vrf_import_rt_hash,irt);
XFREE(MTYPE_BGP_EVPN_VRF_IMPORT_RT,irt);}/**FunctiontolookupImportRTnode-usedtom
apaRTtosetof*VNIsimportingrouteswiththatRT.*/staticstructvrf_irt_node*lookup_vrf
_import_rt(structecommunity_val*rt){structbgp*bgp_def=NULL;structvrf_irt_node*ir
t;structvrf_irt_nodetmp;bgp_def=bgp_get_default();if(!bgp_def){zlog_err("vrfimpo
rtrtlookup-definstancenotcreatedyet");returnNULL;}memset(&tmp,0,sizeof(structvrf
_irt_node));memcpy(&tmp.rt,rt,ECOMMUNITY_SIZE);irt=hash_lookup(bgp_def->vrf_impo
rt_rt_hash,&tmp);returnirt;}/**IsspecifiedVRFpresentontheRT'slistof"importing"VR
Fs?*/staticintis_vrf_present_in_irt_vrfs(structlist*vrfs,structbgp*bgp_vrf){stru
ctlistnode*node=NULL,*nnode=NULL;structbgp*tmp_bgp_vrf=NULL;for(ALL_LIST_ELEMENT
S(vrfs,node,nnode,tmp_bgp_vrf)){if(tmp_bgp_vrf==bgp_vrf)return1;}return0;}/**Mak
eimportroutetargethashkey.*/staticunsignedintimport_rt_hash_key_make(void*p){str
uctirt_node*irt=p;char*pnt=irt->rt.val;returnjhash(pnt,8,0xdeadbeef);}/**Compari
sonfunctionforimportrthash*/staticintimport_rt_hash_cmp(constvoid*p1,constvoid*p
2){conststructirt_node*irt1=p1;conststructirt_node*irt2=p2;if(irt1==NULL&&irt2==
NULL)return1;if(irt1==NULL||irt2==NULL)return0;return(memcmp(irt1->rt.val,irt2->
rt.val,ECOMMUNITY_SIZE)==0);}/**Createanewimport_rt*/staticstructirt_node*import
_rt_new(structbgp*bgp,structecommunity_val*rt){structirt_node*irt;if(!bgp)return
NULL;irt=XCALLOC(MTYPE_BGP_EVPN_IMPORT_RT,sizeof(structirt_node));if(!irt)return
NULL;irt->rt=*rt;irt->vnis=list_new();/*Addtohash*/if(!hash_get(bgp->import_rt_h
ash,irt,hash_alloc_intern)){XFREE(MTYPE_BGP_EVPN_IMPORT_RT,irt);returnNULL;}retu
rnirt;}/**Freetheimportrtnode*/staticvoidimport_rt_free(structbgp*bgp,structirt_
node*irt){hash_release(bgp->import_rt_hash,irt);XFREE(MTYPE_BGP_EVPN_IMPORT_RT,i
rt);}/**FunctiontolookupImportRTnode-usedtomapaRTtosetof*VNIsimportingrouteswith
thatRT.*/staticstructirt_node*lookup_import_rt(structbgp*bgp,structecommunity_va
l*rt){structirt_node*irt;structirt_nodetmp;memset(&tmp,0,sizeof(structirt_node))
;memcpy(&tmp.rt,rt,ECOMMUNITY_SIZE);irt=hash_lookup(bgp->import_rt_hash,&tmp);re
turnirt;}/**IsspecifiedVNIpresentontheRT'slistof"importing"VNIs?*/staticintis_vn
i_present_in_irt_vnis(structlist*vnis,structbgpevpn*vpn){structlistnode*node,*nn
ode;structbgpevpn*tmp_vpn;for(ALL_LIST_ELEMENTS(vnis,node,nnode,tmp_vpn)){if(tmp
_vpn==vpn)return1;}return0;}/**CompareRouteTargets.*/staticintevpn_route_target_
cmp(structecommunity*ecom1,structecommunity*ecom2){if(ecom1&&!ecom2)return-1;if(
!ecom1&&ecom2)return1;if(!ecom1&&!ecom2)return0;if(ecom1->str&&!ecom2->str)retur
n-1;if(!ecom1->str&&ecom2->str)return1;if(!ecom1->str&&!ecom2->str)return0;retur
nstrcmp(ecom1->str,ecom2->str);}/**Maskoffglobal-adminfieldofspecifiedextendedco
mmunity(RT),*justretainthelocal-adminfield.*/staticinlinevoidmask_ecom_global_ad
min(structecommunity_val*dst,structecommunity_val*src){uint8_ttype;type=src->val
[0];dst->val[0]=0;if(type==ECOMMUNITY_ENCODE_AS){dst->val[2]=dst->val[3]=0;}else
if(type==ECOMMUNITY_ENCODE_AS4||type==ECOMMUNITY_ENCODE_IP){dst->val[2]=dst->val
[3]=0;dst->val[4]=dst->val[5]=0;}}/**MaponeRTtospecifiedVRF.*bgp_vrf=BGPvrfinsta
nce*/staticvoidmap_vrf_to_rt(structbgp*bgp_vrf,structecommunity_val*eval){struct
vrf_irt_node*irt=NULL;structecommunity_valeval_tmp;/*Ifusing"automatic"RT,*weonl
ycareaboutthelocal-adminsub-field.*ThisistofacilitateusingL3VNI(VRF-VNI)*astheRT
forEBGPpeeringtoo.*/memcpy(&eval_tmp,eval,ECOMMUNITY_SIZE);if(!CHECK_FLAG(bgp_vr
f->vrf_flags,BGP_VRF_IMPORT_RT_CFGD))mask_ecom_global_admin(&eval_tmp,eval);irt=
lookup_vrf_import_rt(&eval_tmp);if(irt&&is_vrf_present_in_irt_vrfs(irt->vrfs,bgp
_vrf))/*Alreadymapped.*/return;if(!irt)irt=vrf_import_rt_new(&eval_tmp);/*AddVRF
tothelistforthisRT.*/listnode_add(irt->vrfs,bgp_vrf);}/**UnmapspecifiedVRFfromsp
ecifiedRT.Iftherearenoother*VRFsforthisRT,thentheRThashisdeleted.*bgp_vrf:BGPVRF
specificinstance*/staticvoidunmap_vrf_from_rt(structbgp*bgp_vrf,structvrf_irt_no
de*irt){/*DeleteVRFfromlistforthisRT.*/listnode_delete(irt->vrfs,bgp_vrf);if(!li
stnode_head(irt->vrfs)){list_delete_and_null(&irt->vrfs);vrf_import_rt_free(irt)
;}}/**MaponeRTtospecifiedVNI.*/staticvoidmap_vni_to_rt(structbgp*bgp,structbgpev
pn*vpn,structecommunity_val*eval){structirt_node*irt;structecommunity_valeval_tm
p;/*Ifusing"automatic"RT,weonlycareaboutthelocal-admin*sub-field.*Thisistofacili
tateusingVNIastheRTforEBGPpeeringtoo.*/memcpy(&eval_tmp,eval,ECOMMUNITY_SIZE);if
(!is_import_rt_configured(vpn))mask_ecom_global_admin(&eval_tmp,eval);irt=lookup
_import_rt(bgp,&eval_tmp);if(irt&&irt->vnis)if(is_vni_present_in_irt_vnis(irt->v
nis,vpn))/*Alreadymapped.*/return;if(!irt){irt=import_rt_new(bgp,&eval_tmp);asse
rt(irt);}/*AddVNItothehashlistforthisRT.*/listnode_add(irt->vnis,vpn);}/**Unmaps
pecifiedVNIfromspecifiedRT.Iftherearenoother*VNIsforthisRT,thentheRThashisdelete
d.*/staticvoidunmap_vni_from_rt(structbgp*bgp,structbgpevpn*vpn,structirt_node*i
rt){/*DeleteVNIfromhashlistforthisRT.*/listnode_delete(irt->vnis,vpn);if(!listno
de_head(irt->vnis)){list_delete_and_null(&irt->vnis);import_rt_free(bgp,irt);}}/
**CreateRTextendedcommunityautomaticallyfrompassedinformation:*oftheformAS:VNI.*
NOTE:Weuseonlythelower16bitsoftheAS.Thisissufficientas*theneedistogetaRTvaluetha
twillbeuniqueacrossdifferent*VNIsbutthesameacrossrouters(inthesameAS)foraparticu
lar*VNI.*/staticvoidform_auto_rt(structbgp*bgp,vni_tvni,structlist*rtl){structec
ommunity_valeval;structecommunity*ecomadd;encode_route_target_as((bgp->as&0xFFFF
),vni,&eval);ecomadd=ecommunity_new();ecommunity_add_val(ecomadd,&eval);listnode
_add_sort(rtl,ecomadd);}/**DeriveRDandRTforaVNIautomatically.Invokedatthetimeof*
creationofaVNI.*/staticvoidderive_rd_rt_for_vni(structbgp*bgp,structbgpevpn*vpn)
{bgp_evpn_derive_auto_rd(bgp,vpn);bgp_evpn_derive_auto_rt_import(bgp,vpn);bgp_ev
pn_derive_auto_rt_export(bgp,vpn);}/**Convertnexthop(remoteVTEPIP)intoanIPv6addr
ess.*/staticvoidevpn_convert_nexthop_to_ipv6(structattr*attr){if(BGP_ATTR_NEXTHO
P_AFI_IP6(attr))return;ipv4_to_ipv4_mapped_ipv6(&attr->mp_nexthop_global,attr->n
exthop);attr->mp_nexthop_len=IPV6_MAX_BYTELEN;}/**Add(update)ordeleteMACIPfromze
bra.*/staticintbgp_zebra_send_remote_macip(structbgp*bgp,structbgpevpn*vpn,struc
tprefix_evpn*p,structin_addrremote_vtep_ip,intadd,uint8_tflags){structstream*s;i
ntipa_len;charbuf1[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];charbuf3[INET6_
ADDRSTRLEN];/*Checksocket.*/if(!zclient||zclient->sock<0)return0;/*Don'ttrytoreg
isterifZebradoesn'tknowofthisinstance.*/if(!IS_BGP_INST_KNOWN_TO_ZEBRA(bgp))retu
rn0;s=zclient->obuf;stream_reset(s);zclient_create_header(s,add?ZEBRA_REMOTE_MAC
IP_ADD:ZEBRA_REMOTE_MACIP_DEL,bgp->vrf_id);stream_putl(s,vpn->vni);stream_put(s,
&p->prefix.mac.octet,ETH_ALEN);/*MacAddr*//*IPaddresslengthandIPaddress,ifany.*/
if(IS_EVPN_PREFIX_IPADDR_NONE(p))stream_putl(s,0);else{ipa_len=IS_EVPN_PREFIX_IP
ADDR_V4(p)?IPV4_MAX_BYTELEN:IPV6_MAX_BYTELEN;stream_putl(s,ipa_len);stream_put(s
,&p->prefix.ip.ip.addr,ipa_len);}stream_put_in_addr(s,&remote_vtep_ip);/*TXflags
-MACstickystatusand/orgatewaymac*/if(add)stream_putc(s,flags);stream_putw_at(s,0
,stream_get_endp(s));if(bgp_debug_zebra(NULL))zlog_debug("Tx%sMACIP,VNI%uMAC%sIP
%s(flags:0x%x)remoteVTEP%s",add?"ADD":"DEL",vpn->vni,prefix_mac2str(&p->prefix.m
ac,buf1,sizeof(buf1)),ipaddr2str(&p->prefix.ip,buf3,sizeof(buf3)),flags,inet_nto
p(AF_INET,&remote_vtep_ip,buf2,sizeof(buf2)));returnzclient_send_message(zclient
);}/**Add(update)ordeleteremoteVTEPfromzebra.*/staticintbgp_zebra_send_remote_vt
ep(structbgp*bgp,structbgpevpn*vpn,structprefix_evpn*p,intadd){structstream*s;/*
Checksocket.*/if(!zclient||zclient->sock<0)return0;/*Don'ttrytoregisterifZebrado
esn'tknowofthisinstance.*/if(!IS_BGP_INST_KNOWN_TO_ZEBRA(bgp))return0;s=zclient-
>obuf;stream_reset(s);zclient_create_header(s,add?ZEBRA_REMOTE_VTEP_ADD:ZEBRA_RE
MOTE_VTEP_DEL,bgp->vrf_id);stream_putl(s,vpn->vni);if(IS_EVPN_PREFIX_IPADDR_V4(p
))stream_put_in_addr(s,&p->prefix.ip.ipaddr_v4);elseif(IS_EVPN_PREFIX_IPADDR_V6(
p)){zlog_err("BadremoteIPwhentryingto%sremoteVTEPforVNI%u",add?"ADD":"DEL",vpn->
vni);return-1;}stream_putw_at(s,0,stream_get_endp(s));if(bgp_debug_zebra(NULL))z
log_debug("Tx%sRemoteVTEP,VNI%uremoteVTEP%s",add?"ADD":"DEL",vpn->vni,inet_ntoa(
p->prefix.ip.ipaddr_v4));returnzclient_send_message(zclient);}/**Buildextendedco
mmunitiesforEVPNprefixroute.*/staticvoidbuild_evpn_type5_route_extcomm(structbgp
*bgp_vrf,structattr*attr){structecommunityecom_encap;structecommunityecom_rmac;s
tructecommunity_valeval;structecommunity_valeval_rmac;bgp_encap_typestnl_type;st
ructlistnode*node,*nnode;structecommunity*ecom;structlist*vrf_export_rtl=NULL;/*
Encap*/tnl_type=BGP_ENCAP_TYPE_VXLAN;memset(&ecom_encap,0,sizeof(ecom_encap));en
code_encap_extcomm(tnl_type,&eval);ecom_encap.size=1;ecom_encap.val=(uint8_t*)ev
al.val;/*AddEncap*/attr->ecommunity=ecommunity_dup(&ecom_encap);/*AddtheexportRT
sforL3VNI/VRF*/vrf_export_rtl=bgp_vrf->vrf_export_rtl;if(vrf_export_rtl&&!list_i
sempty(vrf_export_rtl)){for(ALL_LIST_ELEMENTS(vrf_export_rtl,node,nnode,ecom))at
tr->ecommunity=ecommunity_merge(attr->ecommunity,ecom);}/*addtheroutermacextende
dcommunity*/if(!is_zero_mac(&attr->rmac)){memset(&ecom_rmac,0,sizeof(ecom_rmac))
;encode_rmac_extcomm(&eval_rmac,&attr->rmac);ecom_rmac.size=1;ecom_rmac.val=(uin
t8_t*)eval_rmac.val;attr->ecommunity=ecommunity_merge(attr->ecommunity,&ecom_rma
c);}attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES);}/**Buildextendedcommuni
tiesforEVPNroute.*Thisfunctionisapplicablefortype-2andtype-3routes.Thelayer-2RT*
andENCAPextendedcommunitiesareapplicableforallroutes.*Thedefaultgatewayextendedc
ommunityandMACmobility(sticky)extended*communityareaddedasneededbasedonpassedset
tings-onlyfortype-2*routes.Likewise,thelayer-3RTandRouterMACextendedcommunitiesa
re*added,ifpresent,basedonpassedsettings-onlyfornon-link-local*type-2routes.*/st
aticvoidbuild_evpn_route_extcomm(structbgpevpn*vpn,structattr*attr,intadd_l3_eco
mm){structecommunityecom_encap;structecommunityecom_sticky;structecommunityecom_
default_gw;structecommunityecom_rmac;structecommunity_valeval;structecommunity_v
aleval_sticky;structecommunity_valeval_default_gw;structecommunity_valeval_rmac;
bgp_encap_typestnl_type;structlistnode*node,*nnode;structecommunity*ecom;uint32_
tseqnum;structlist*vrf_export_rtl=NULL;/*Encap*/tnl_type=BGP_ENCAP_TYPE_VXLAN;me
mset(&ecom_encap,0,sizeof(ecom_encap));encode_encap_extcomm(tnl_type,&eval);ecom
_encap.size=1;ecom_encap.val=(uint8_t*)eval.val;/*AddEncap*/attr->ecommunity=eco
mmunity_dup(&ecom_encap);/*AddtheexportRTsforL2VNI*/for(ALL_LIST_ELEMENTS(vpn->e
xport_rtl,node,nnode,ecom))attr->ecommunity=ecommunity_merge(attr->ecommunity,ec
om);/*AddtheexportRTsforL3VNIiftoldto-callerdetermines*whenthisshouldbedone.*/if
(add_l3_ecomm){vrf_export_rtl=bgpevpn_get_vrf_export_rtl(vpn);if(vrf_export_rtl&
&!list_isempty(vrf_export_rtl)){for(ALL_LIST_ELEMENTS(vrf_export_rtl,node,nnode,
ecom))attr->ecommunity=ecommunity_merge(attr->ecommunity,ecom);}}/*AddMACmobilit
y(sticky)ifneeded.*/if(attr->sticky){seqnum=0;memset(&ecom_sticky,0,sizeof(ecom_
sticky));encode_mac_mobility_extcomm(1,seqnum,&eval_sticky);ecom_sticky.size=1;e
com_sticky.val=(uint8_t*)eval_sticky.val;attr->ecommunity=ecommunity_merge(attr-
>ecommunity,&ecom_sticky);}/*AddRMAC,iftoldto.*/if(add_l3_ecomm){memset(&ecom_rm
ac,0,sizeof(ecom_rmac));encode_rmac_extcomm(&eval_rmac,&attr->rmac);ecom_rmac.si
ze=1;ecom_rmac.val=(uint8_t*)eval_rmac.val;attr->ecommunity=ecommunity_merge(att
r->ecommunity,&ecom_rmac);}/*Adddefaultgateway,ifneeded.*/if(attr->default_gw){m
emset(&ecom_default_gw,0,sizeof(ecom_default_gw));encode_default_gw_extcomm(&eva
l_default_gw);ecom_default_gw.size=1;ecom_default_gw.val=(uint8_t*)eval_default_
gw.val;attr->ecommunity=ecommunity_merge(attr->ecommunity,&ecom_default_gw);}att
r->flag|=ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES);}/**AddMACmobilityextendedcommu
nitytoattribute.*/staticvoidadd_mac_mobility_to_attr(uint32_tseq_num,structattr*
attr){structecommunityecom_tmp;structecommunity_valeval;uint8_t*ecom_val_ptr;int
i;uint8_t*pnt;inttype=0;intsub_type=0;/*BuildMM*/encode_mac_mobility_extcomm(0,s
eq_num,&eval);/*FindcurrentMMecommunity*/ecom_val_ptr=NULL;if(attr->ecommunity){
for(i=0;i<attr->ecommunity->size;i++){pnt=attr->ecommunity->val+(i*8);type=*pnt+
+;sub_type=*pnt++;if(type==ECOMMUNITY_ENCODE_EVPN&&sub_type==ECOMMUNITY_EVPN_SUB
TYPE_MACMOBILITY){ecom_val_ptr=(uint8_t*)(attr->ecommunity->val+(i*8));break;}}}
/*UpdatetheexistingMMecommunity*/if(ecom_val_ptr){memcpy(ecom_val_ptr,eval.val,s
izeof(char)*ECOMMUNITY_SIZE);}/*AddMMtoexisting*/else{memset(&ecom_tmp,0,sizeof(
ecom_tmp));ecom_tmp.size=1;ecom_tmp.val=(uint8_t*)eval.val;attr->ecommunity=ecom
munity_merge(attr->ecommunity,&ecom_tmp);}}/*InstallEVPNrouteintozebra.*/statici
ntevpn_zebra_install(structbgp*bgp,structbgpevpn*vpn,structprefix_evpn*p,structi
n_addrremote_vtep_ip,uint8_tflags){intret;if(p->prefix.route_type==BGP_EVPN_MAC_
IP_ROUTE)ret=bgp_zebra_send_remote_macip(bgp,vpn,p,remote_vtep_ip,1,flags);elser
et=bgp_zebra_send_remote_vtep(bgp,vpn,p,1);returnret;}/*UninstallEVPNroutefromze
bra.*/staticintevpn_zebra_uninstall(structbgp*bgp,structbgpevpn*vpn,structprefix
_evpn*p,structin_addrremote_vtep_ip){intret;if(p->prefix.route_type==BGP_EVPN_MA
C_IP_ROUTE)ret=bgp_zebra_send_remote_macip(bgp,vpn,p,remote_vtep_ip,0,0);elseret
=bgp_zebra_send_remote_vtep(bgp,vpn,p,0);returnret;}/**DuetoMACmobility,theprior
"local"bestroutehasbeensupplanted*bya"remote"bestroute.Thepriorroutehastobedelet
edandwithdrawn*frompeers.*/staticvoidevpn_delete_old_local_route(structbgp*bgp,s
tructbgpevpn*vpn,structbgp_node*rn,structbgp_info*old_local){structbgp_node*glob
al_rn;structbgp_info*ri;afi_tafi=AFI_L2VPN;safi_tsafi=SAFI_EVPN;/*Locateroutenod
eintheglobalEVPNroutingtable.Notethat*thistableisa2-leveltree(RD-level+Prefix-le
vel)similarto*L3VPNroutes.*/global_rn=bgp_afi_node_lookup(bgp->rib[afi][safi],af
i,safi,(structprefix*)&rn->p,&vpn->prd);if(global_rn){/*Deleterouteentryintheglo
balEVPNtable.*/delete_evpn_route_entry(bgp,vpn,afi,safi,global_rn,&ri);/*Schedul
eforprocessing-withdrawstopeershappenfrom*thistable.*/if(ri)bgp_process(bgp,glob
al_rn,afi,safi);bgp_unlock_node(global_rn);}/*DeleterouteentryintheVNIroutetable
,callertoremove.*/bgp_info_delete(rn,old_local);}/**CalculatethebestpathforanEVP
Nroute.Install/updatebestpathinzebra,*ifappropriate.*/staticintevpn_route_select
_install(structbgp*bgp,structbgpevpn*vpn,structbgp_node*rn){structbgp_info*old_s
elect,*new_select;structbgp_info_pairold_and_new;afi_tafi=AFI_L2VPN;safi_tsafi=S
AFI_EVPN;intret=0;uint8_tflags=0;/*Computethebestpath.*/bgp_best_selection(bgp,r
n,&bgp->maxpaths[afi][safi],&old_and_new,afi,safi);old_select=old_and_new.old;ne
w_select=old_and_new.new;/*Ifthebestpathhasn'tchanged-seeifthereisstillsomething
to*update*tozebraRIB.*/if(old_select&&old_select==new_select&&old_select->type==
ZEBRA_ROUTE_BGP&&old_select->sub_type==BGP_ROUTE_IMPORTED&&!CHECK_FLAG(rn->flags
,BGP_NODE_USER_CLEAR)&&!CHECK_FLAG(old_select->flags,BGP_INFO_ATTR_CHANGED)&&!bg
p->addpath_tx_used[afi][safi]){if(bgp_zebra_has_route_changed(rn,old_select)){if
(old_select->attr->sticky)SET_FLAG(flags,ZEBRA_MACIP_TYPE_STICKY);if(old_select-
>attr->default_gw)SET_FLAG(flags,ZEBRA_MACIP_TYPE_GW);ret=evpn_zebra_install(bgp
,vpn,(structprefix_evpn*)&rn->p,old_select->attr->nexthop,flags);}UNSET_FLAG(old
_select->flags,BGP_INFO_MULTIPATH_CHG);bgp_zebra_clear_route_change_flags(rn);re
turnret;}/*Iftheuserdida"clear"thisflagwillbeset*/UNSET_FLAG(rn->flags,BGP_NODE_
USER_CLEAR);/*bestpathhaschanged;updaterelevantfieldsandinstalloruninstall*intot
hezebraRIB.*/if(old_select||new_select)bgp_bump_version(rn);if(old_select)bgp_in
fo_unset_flag(rn,old_select,BGP_INFO_SELECTED);if(new_select){bgp_info_set_flag(
rn,new_select,BGP_INFO_SELECTED);bgp_info_unset_flag(rn,new_select,BGP_INFO_ATTR
_CHANGED);UNSET_FLAG(new_select->flags,BGP_INFO_MULTIPATH_CHG);}if(new_select&&n
ew_select->type==ZEBRA_ROUTE_BGP&&new_select->sub_type==BGP_ROUTE_IMPORTED){flag
s=0;if(new_select->attr->sticky)SET_FLAG(flags,ZEBRA_MACIP_TYPE_STICKY);if(new_s
elect->attr->default_gw)SET_FLAG(flags,ZEBRA_MACIP_TYPE_GW);ret=evpn_zebra_insta
ll(bgp,vpn,(structprefix_evpn*)&rn->p,new_select->attr->nexthop,flags);/*Ifanold
bestexistedanditwasa"local"route,theonly*reason*itwouldbesupplantedisduetoMACmob
ilityprocedures.So,*we*needtodoanimplicitdeleteandwithdrawthatroutefrom*peers.*/
if(old_select&&old_select->peer==bgp->peer_self&&old_select->type==ZEBRA_ROUTE_B
GP&&old_select->sub_type==BGP_ROUTE_STATIC)evpn_delete_old_local_route(bgp,vpn,r
n,old_select);}else{if(old_select&&old_select->type==ZEBRA_ROUTE_BGP&&old_select
->sub_type==BGP_ROUTE_IMPORTED)ret=evpn_zebra_uninstall(bgp,vpn,(structprefix_ev
pn*)&rn->p,old_select->attr->nexthop);}/*Clearanyroutechangeflags.*/bgp_zebra_cl
ear_route_change_flags(rn);/*Reapoldselectbgp_info,ifithasbeenremoved*/if(old_se
lect&&CHECK_FLAG(old_select->flags,BGP_INFO_REMOVED))bgp_info_reap(rn,old_select
);returnret;}/**Returntrueifthelocalriforthisrnisoftypegatewaymac*/staticintevpn
_route_is_def_gw(structbgp*bgp,structbgp_node*rn){structbgp_info*tmp_ri=NULL;str
uctbgp_info*local_ri=NULL;local_ri=NULL;for(tmp_ri=rn->info;tmp_ri;tmp_ri=tmp_ri
->next){if(tmp_ri->peer==bgp->peer_self&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->
sub_type==BGP_ROUTE_STATIC)local_ri=tmp_ri;}if(!local_ri)return0;returnlocal_ri-
>attr->default_gw;}/**Returntrueifthelocalriforthisrnhasstickyset*/staticintevpn
_route_is_sticky(structbgp*bgp,structbgp_node*rn){structbgp_info*tmp_ri;structbg
p_info*local_ri;local_ri=NULL;for(tmp_ri=rn->info;tmp_ri;tmp_ri=tmp_ri->next){if
(tmp_ri->peer==bgp->peer_self&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->sub_type==
BGP_ROUTE_STATIC)local_ri=tmp_ri;}if(!local_ri)return0;returnlocal_ri->attr->sti
cky;}staticintupdate_evpn_type5_route_entry(structbgp*bgp_def,structbgp*bgp_vrf,
afi_tafi,safi_tsafi,structbgp_node*rn,structattr*attr,int*route_changed){structa
ttr*attr_new=NULL;structbgp_info*ri=NULL;mpls_label_tlabel=MPLS_INVALID_LABEL;st
ructbgp_info*local_ri=NULL;structbgp_info*tmp_ri=NULL;*route_changed=0;/*locatet
helocalrouteentryifany*/for(tmp_ri=rn->info;tmp_ri;tmp_ri=tmp_ri->next){if(tmp_r
i->peer==bgp_def->peer_self&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->sub_type==BG
P_ROUTE_STATIC)local_ri=tmp_ri;}/*createanewrouteentryifonedoesntexist.Otherwise
seeifrouteattrhaschanged*/if(!local_ri){/*routehaschangedasthisisthefirstentry*/
*route_changed=1;/*Add(orupdate)attributetohash.*/attr_new=bgp_attr_intern(attr)
;/*createtherouteinfofromattribute*/ri=info_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_STATI
C,0,bgp_def->peer_self,attr_new,rn);SET_FLAG(ri->flags,BGP_INFO_VALID);/*Type-5r
outesadvertisetheL3-VNI*/bgp_info_extra_get(ri);vni2label(bgp_vrf->l3vni,&label)
;memcpy(&ri->extra->label,&label,sizeof(label));ri->extra->num_labels=1;/*addthe
routeentrytoroutenode*/bgp_info_add(rn,ri);}else{tmp_ri=local_ri;if(!attrhash_cm
p(tmp_ri->attr,attr)){/*attributechanged*/*route_changed=1;/*Theattributehaschan
ged.*//*Add(orupdate)attributetohash.*/attr_new=bgp_attr_intern(attr);bgp_info_s
et_flag(rn,tmp_ri,BGP_INFO_ATTR_CHANGED);/*Restoreroute,ifneeded.*/if(CHECK_FLAG
(tmp_ri->flags,BGP_INFO_REMOVED))bgp_info_restore(rn,tmp_ri);/*Uninternexisting,
settonew.*/bgp_attr_unintern(&tmp_ri->attr);tmp_ri->attr=attr_new;tmp_ri->uptime
=bgp_clock();}}return0;}/*updateevpntype-5routeentry*/staticintupdate_evpn_type5
_route(structbgp*bgp_vrf,structprefix_evpn*evp,structattr*src_attr){afi_tafi=AFI
_L2VPN;safi_tsafi=SAFI_EVPN;structattrattr;structbgp_node*rn=NULL;structbgp*bgp_
def=NULL;introute_changed=0;bgp_def=bgp_get_default();if(!bgp_def)return0;/*Buil
dpathattributeforthisroute-usethesourceattr,if*present,elsetreataslocallyorigina
ted.*/if(src_attr)bgp_attr_dup(&attr,src_attr);else{memset(&attr,0,sizeof(struct
attr));bgp_attr_default_set(&attr,BGP_ORIGIN_IGP);}/*Setnexthoptoourselvesandfil
lintheRouterMAC.*/attr.nexthop=bgp_vrf->originator_ip;attr.mp_nexthop_global_in=
bgp_vrf->originator_ip;attr.mp_nexthop_len=BGP_ATTR_NHLEN_IPV4;memcpy(&attr.rmac
,&bgp_vrf->rmac,sizeof(structethaddr));/*SetupRTandencapextendedcommunity*/build
_evpn_type5_route_extcomm(bgp_vrf,&attr);/*gettheroutenodeinglobaltable*/rn=bgp_
afi_node_get(bgp_def->rib[afi][safi],afi,safi,(structprefix*)evp,&bgp_vrf->vrf_p
rd);assert(rn);/*createorupdatetherouteentrywithintheroutenode*/update_evpn_type
5_route_entry(bgp_def,bgp_vrf,afi,safi,rn,&attr,&route_changed);/*scheduleforpro
cessingandunlocknode*/if(route_changed){bgp_process(bgp_def,rn,afi,safi);bgp_unl
ock_node(rn);}/*unintentemporary*/if(!src_attr)aspath_unintern(&attr.aspath);ret
urn0;}/**CreateorupdateEVPNrouteentry.ThiscouldbeintheVNIroutetable*ortheglobalr
outetable.*/staticintupdate_evpn_route_entry(structbgp*bgp,structbgpevpn*vpn,afi
_tafi,safi_tsafi,structbgp_node*rn,structattr*attr,intadd,intvni_table,structbgp
_info**ri,uint8_tflags){structbgp_info*tmp_ri;structbgp_info*local_ri,*remote_ri
;structattr*attr_new;mpls_label_tlabel[BGP_MAX_LABELS];uint32_tnum_labels=1;intr
oute_change=1;uint8_tsticky=0;structprefix_evpn*evp;*ri=NULL;evp=(structprefix_e
vpn*)&rn->p;memset(&label,0,sizeof(label));/*Seeifthisisanupdateofanexistingrout
e,oranewadd.Also,*identifyifalreadyknownfromremote,andifso,theonewiththe*highest
sequencenumber;thisisonlywhenaddingtotheVNIrouting*table.*/local_ri=remote_ri=NU
LL;for(tmp_ri=rn->info;tmp_ri;tmp_ri=tmp_ri->next){if(tmp_ri->peer==bgp->peer_se
lf&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->sub_type==BGP_ROUTE_STATIC)local_ri=t
mp_ri;if(vni_table){if(tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->sub_type==BGP_ROUT
E_IMPORTED&&CHECK_FLAG(tmp_ri->flags,BGP_INFO_VALID)){if(!remote_ri)remote_ri=tm
p_ri;elseif(mac_mobility_seqnum(tmp_ri->attr)>mac_mobility_seqnum(remote_ri->att
r))remote_ri=tmp_ri;}}}/*Ifroutedoesn'texistalready,createanewone,iftoldto.*Othe
rwiseactbasedonwhethertheattributesoftheroutehave*changedornot.*/if(!local_ri&&!
add)return0;if(!local_ri){/*Whenlearntlocallyforthefirsttimebutalreadyknownfrom*
remote,wehavetoinitiateappropriateMACmobilitysteps.*This*isapplicablewhenupdatin
gtheVNIroutingtable.*Weneedtoskipmobilitystepsforg/wmacs(localmacong/w*SVI)adver
tisedinEVPN.*Thiswillensurethatlocalroutesarepreferredforg/wmacs*/if(remote_ri&&
!CHECK_FLAG(flags,ZEBRA_MACIP_TYPE_GW)){uint32_tcur_seqnum;/*AddMMextendedcommun
itytoroute.*/cur_seqnum=mac_mobility_seqnum(remote_ri->attr);add_mac_mobility_to
_attr(cur_seqnum+1,attr);}/*Add(orupdate)attributetohash.*/attr_new=bgp_attr_int
ern(attr);/*ExtractMACmobilitysequencenumber,ifany.*/attr_new->mm_seqnum=bgp_att
r_mac_mobility_seqnum(attr_new,&sticky);attr_new->sticky=sticky;/*Createnewroute
withitsattribute.*/tmp_ri=info_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_STATIC,0,bgp->peer
_self,attr_new,rn);SET_FLAG(tmp_ri->flags,BGP_INFO_VALID);bgp_info_extra_get(tmp
_ri);/*TheVNIgoesintothe'label'fieldoftheroute*/vni2label(vpn->vni,&label[0]);/*
Type-2routesmaycarryasecondVNI-theL3-VNI.*Onlyattachsecondlabelifweareadvertisin
gtwolabelsfor*type-2routes.*/if(evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE&&C
HECK_FLAG(vpn->flags,VNI_FLAG_USE_TWO_LABELS)){vni_tl3vni;l3vni=bgpevpn_get_l3vn
i(vpn);if(l3vni){vni2label(l3vni,&label[1]);num_labels++;}}memcpy(&tmp_ri->extra
->label,label,sizeof(label));tmp_ri->extra->num_labels=num_labels;bgp_info_add(r
n,tmp_ri);}else{tmp_ri=local_ri;if(attrhash_cmp(tmp_ri->attr,attr)&&!CHECK_FLAG(
tmp_ri->flags,BGP_INFO_REMOVED))route_change=0;else{/**Theattributeshavechanged,
type-2routesneedsto*beadvertisedwithrightlabels.*/vni2label(vpn->vni,&label[0]);
if(evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE&&CHECK_FLAG(vpn->flags,VNI_FLAG
_USE_TWO_LABELS)){vni_tl3vni;l3vni=bgpevpn_get_l3vni(vpn);if(l3vni){vni2label(l3
vni,&label[1]);num_labels++;}}memcpy(&tmp_ri->extra->label,label,sizeof(label));
tmp_ri->extra->num_labels=num_labels;/*Theattributehaschanged.*//*Add(orupdate)a
ttributetohash.*/attr_new=bgp_attr_intern(attr);bgp_info_set_flag(rn,tmp_ri,BGP_
INFO_ATTR_CHANGED);/*Restoreroute,ifneeded.*/if(CHECK_FLAG(tmp_ri->flags,BGP_INF
O_REMOVED))bgp_info_restore(rn,tmp_ri);/*Uninternexisting,settonew.*/bgp_attr_un
intern(&tmp_ri->attr);tmp_ri->attr=attr_new;tmp_ri->uptime=bgp_clock();}}/*Retur
nbacktherouteentry.*/*ri=tmp_ri;returnroute_change;}/**CreateorupdateEVPNroute(o
ftypebasedonprefix)forspecifiedVNI*andscheduleforprocessing.*/staticintupdate_ev
pn_route(structbgp*bgp,structbgpevpn*vpn,structprefix_evpn*p,uint8_tflags){struc
tbgp_node*rn;structattrattr;structattr*attr_new;intadd_l3_ecomm=0;structbgp_info
*ri;afi_tafi=AFI_L2VPN;safi_tsafi=SAFI_EVPN;introute_change;memset(&attr,0,sizeo
f(structattr));/*Buildpath-attributeforthisroute.*/bgp_attr_default_set(&attr,BG
P_ORIGIN_IGP);attr.nexthop=vpn->originator_ip;attr.mp_nexthop_global_in=vpn->ori
ginator_ip;attr.mp_nexthop_len=BGP_ATTR_NHLEN_IPV4;attr.sticky=CHECK_FLAG(flags,
ZEBRA_MACIP_TYPE_STICKY)?1:0;attr.default_gw=CHECK_FLAG(flags,ZEBRA_MACIP_TYPE_G
W)?1:0;/*PMSIisonlyneededfortype-3routes*/if(p->prefix.route_type==BGP_EVPN_IMET
_ROUTE)attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_PMSI_TUNNEL);/*routermacisonlyneededfor
type-2routeshere.*/if(p->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE)bgpevpn_get_rm
ac(vpn,&attr.rmac);vni2label(vpn->vni,&(attr.label));/*IncludeL3VNIrelatedRTsand
RMACfortype-2routes,ifthey're*IPv4orIPv6globaladdressesandwe'readvertisingL3VNIw
ith*theseroutes.*/if(p->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE&&(IS_EVPN_PREFI
X_IPADDR_V4(p)||!IN6_IS_ADDR_LINKLOCAL(&p->prefix.ip.ipaddr_v6))&&CHECK_FLAG(vpn
->flags,VNI_FLAG_USE_TWO_LABELS))add_l3_ecomm=1;/*Setupextendedcommunity.*/build
_evpn_route_extcomm(vpn,&attr,add_l3_ecomm);/*First,create(orfetch)routenodewith
intheVNI.*//*NOTE:ThereisnoRDhere.*/rn=bgp_node_get(vpn->route_table,(structpref
ix*)p);/*Createorupdaterouteentry.*/route_change=update_evpn_route_entry(bgp,vpn
,afi,safi,rn,&attr,1,1,&ri,flags);assert(ri);attr_new=ri->attr;/*Performroutesel
ection;thisisjusttosettheflagscorrectly*aslocalrouteintheVNIalwayswins.*/evpn_ro
ute_select_install(bgp,vpn,rn);bgp_unlock_node(rn);/*Ifthisisanewrouteorsomeattr
ibutehaschanged,exportthe*routetotheglobaltable.Theroutewillbeadvertisedtopeers*
fromthere.Notethatthistableisa2-leveltree(RD-level+*Prefix-level)similartoL3VPNr
outes.*/if(route_change){structbgp_info*global_ri;rn=bgp_afi_node_get(bgp->rib[a
fi][safi],afi,safi,(structprefix*)p,&vpn->prd);update_evpn_route_entry(bgp,vpn,a
fi,safi,rn,attr_new,1,0,&global_ri,flags);/*Scheduleforprocessingandunlocknode.*
/bgp_process(bgp,rn,afi,safi);bgp_unlock_node(rn);}/*Uninterntemporary.*/aspath_
unintern(&attr.aspath);return0;}/*DeleteEVPNtype5routeentryfromglobaltable*/stat
icvoiddelete_evpn_type5_route_entry(structbgp*bgp_def,structbgp*bgp_vrf,afi_tafi
,safi_tsafi,structbgp_node*rn,structbgp_info**ri){structbgp_info*tmp_ri=NULL;*ri
=NULL;/*findthematchingrouteentry*/for(tmp_ri=rn->info;tmp_ri;tmp_ri=tmp_ri->nex
t)if(tmp_ri->peer==bgp_def->peer_self&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_ri->su
b_type==BGP_ROUTE_STATIC)break;*ri=tmp_ri;/*Markroutefordelete.*/if(tmp_ri)bgp_i
nfo_delete(rn,tmp_ri);}/*DeleteEVPNtype5route*/staticintdelete_evpn_type5_route(
structbgp*bgp_vrf,structprefix_evpn*evp){afi_tafi=AFI_L2VPN;safi_tsafi=SAFI_EVPN
;structbgp_node*rn=NULL;structbgp_info*ri=NULL;structbgp*bgp_def=NULL;/*defaultb
gpinstance*/bgp_def=bgp_get_default();if(!bgp_def)return0;/*locatetheglobalroute
entryforthistype-5prefix*/rn=bgp_afi_node_lookup(bgp_def->rib[afi][safi],afi,saf
i,(structprefix*)evp,&bgp_vrf->vrf_prd);if(!rn)return0;delete_evpn_type5_route_e
ntry(bgp_def,bgp_vrf,afi,safi,rn,&ri);if(ri)bgp_process(bgp_def,rn,afi,safi);bgp
_unlock_node(rn);return0;}/**DeleteEVPNrouteentry.ThiscouldbeintheVNIroutetable*
ortheglobalroutetable.*/staticvoiddelete_evpn_route_entry(structbgp*bgp,structbg
pevpn*vpn,afi_tafi,safi_tsafi,structbgp_node*rn,structbgp_info**ri){structbgp_in
fo*tmp_ri;*ri=NULL;/*Now,findmatchingroute.*/for(tmp_ri=rn->info;tmp_ri;tmp_ri=t
mp_ri->next)if(tmp_ri->peer==bgp->peer_self&&tmp_ri->type==ZEBRA_ROUTE_BGP&&tmp_
ri->sub_type==BGP_ROUTE_STATIC)break;*ri=tmp_ri;/*Markroutefordelete.*/if(tmp_ri
)bgp_info_delete(rn,tmp_ri);}/**DeleteEVPNroute(oftypebasedonprefix)forspecified
VNIand*scheduleforprocessing.*/staticintdelete_evpn_route(structbgp*bgp,structbg
pevpn*vpn,structprefix_evpn*p){structbgp_node*rn,*global_rn;structbgp_info*ri;af
i_tafi=AFI_L2VPN;safi_tsafi=SAFI_EVPN;/*First,locatetheroutenodewithintheVNI.Ifi
tdoesn'texist,*there*isnothingfurthertodo.*//*NOTE:ThereisnoRDhere.*/rn=bgp_node
_lookup(vpn->route_table,(structprefix*)p);if(!rn)return0;/*Next,locateroutenode
intheglobalEVPNroutingtable.Notethat*thistableisa2-leveltree(RD-level+Prefix-lev
el)similarto*L3VPNroutes.*/global_rn=bgp_afi_node_lookup(bgp->rib[afi][safi],afi
,safi,(structprefix*)p,&vpn->prd);if(global_rn){/*DeleterouteentryintheglobalEVP
Ntable.*/delete_evpn_route_entry(bgp,vpn,afi,safi,global_rn,&ri);/*Scheduleforpr
ocessing-withdrawstopeershappenfrom*thistable.*/if(ri)bgp_process(bgp,global_rn,
afi,safi);bgp_unlock_node(global_rn);}/*DeleterouteentryintheVNIroutetable.Thisc
anjustberemoved.*/delete_evpn_route_entry(bgp,vpn,afi,safi,rn,&ri);if(ri)bgp_inf
o_reap(rn,ri);bgp_unlock_node(rn);return0;}/**Updatealltype-2(MACIP)localroutesf
orthisVNI-theseshouldalso*bescheduledforadvertisetopeers.*/staticintupdate_all_t
ype2_routes(structbgp*bgp,structbgpevpn*vpn){afi_tafi;safi_tsafi;structbgp_node*
rn;structbgp_info*ri;structattrattr;structattrattr_sticky;structattrattr_def_gw;
structattrattr_ip6_ll;structattr*attr_new;intadd_l3_ecomm=0;afi=AFI_L2VPN;safi=S
AFI_EVPN;memset(&attr,0,sizeof(structattr));memset(&attr_sticky,0,sizeof(structa
ttr));memset(&attr_def_gw,0,sizeof(structattr));memset(&attr_ip6_ll,0,sizeof(str
uctattr));/*Buildpath-attribute-multipletype-2routesforthisVNIwillshare*thesamep
athattribute,butweneedseparatestructuresforsticky*MACs,defaultgatewayandIPv6link
-localaddresses(noL3RT/RMAC).*/bgp_attr_default_set(&attr,BGP_ORIGIN_IGP);bgp_at
tr_default_set(&attr_sticky,BGP_ORIGIN_IGP);bgp_attr_default_set(&attr_def_gw,BG
P_ORIGIN_IGP);attr.nexthop=vpn->originator_ip;attr.mp_nexthop_global_in=vpn->ori
ginator_ip;attr.mp_nexthop_len=BGP_ATTR_NHLEN_IPV4;bgpevpn_get_rmac(vpn,&attr.rm
ac);attr_sticky.nexthop=vpn->originator_ip;attr_sticky.mp_nexthop_global_in=vpn-
>originator_ip;attr_sticky.mp_nexthop_len=BGP_ATTR_NHLEN_IPV4;attr_sticky.sticky
=1;bgpevpn_get_rmac(vpn,&attr_sticky.rmac);attr_def_gw.nexthop=vpn->originator_i
p;attr_def_gw.mp_nexthop_global_in=vpn->originator_ip;attr_def_gw.mp_nexthop_len
=BGP_ATTR_NHLEN_IPV4;attr_def_gw.default_gw=1;bgpevpn_get_rmac(vpn,&attr_def_gw.
rmac);bgp_attr_default_set(&attr_ip6_ll,BGP_ORIGIN_IGP);attr_ip6_ll.nexthop=vpn-
>originator_ip;attr_ip6_ll.mp_nexthop_global_in=vpn->originator_ip;attr_ip6_ll.m
p_nexthop_len=BGP_ATTR_NHLEN_IPV4;/*AddL3VNIRTsandRMACfornonIPv6link-localattrib
utesif*usingL3VNIfortype-2routesalso.*/if(CHECK_FLAG(vpn->flags,VNI_FLAG_USE_TWO
_LABELS))add_l3_ecomm=1;build_evpn_route_extcomm(vpn,&attr,add_l3_ecomm);build_e
vpn_route_extcomm(vpn,&attr_sticky,add_l3_ecomm);build_evpn_route_extcomm(vpn,&a
ttr_def_gw,add_l3_ecomm);build_evpn_route_extcomm(vpn,&attr_ip6_ll,0);/*Walkthis
VNI'sroutetableandupdatelocaltype-2routes.Forany*routesupdated,updatecorrespondi
ngentryintheglobaltabletoo.*/for(rn=bgp_table_top(vpn->route_table);rn;rn=bgp_ro
ute_next(rn)){structprefix_evpn*evp=(structprefix_evpn*)&rn->p;structbgp_node*rd
_rn;structbgp_info*global_ri;if(evp->prefix.route_type!=BGP_EVPN_MAC_IP_ROUTE)co
ntinue;if(IS_EVPN_PREFIX_IPADDR_V6(evp)&&IN6_IS_ADDR_LINKLOCAL(&evp->prefix.ip.i
paddr_v6))update_evpn_route_entry(bgp,vpn,afi,safi,rn,&attr_ip6_ll,0,1,&ri,0);el
se{if(evpn_route_is_sticky(bgp,rn))update_evpn_route_entry(bgp,vpn,afi,safi,rn,&
attr_sticky,0,1,&ri,0);elseif(evpn_route_is_def_gw(bgp,rn))update_evpn_route_ent
ry(bgp,vpn,afi,safi,rn,&attr_def_gw,0,1,&ri,0);elseupdate_evpn_route_entry(bgp,v
pn,afi,safi,rn,&attr,0,1,&ri,0);}/*Ifalocalrouteexistsforthisprefix,weneedtoupda
te*theglobalroutingtabletoo.*/if(!ri)continue;/*Performrouteselection;thisisjust
tosettheflags*correctly*aslocalrouteintheVNIalwayswins.*/evpn_route_select_insta
ll(bgp,vpn,rn);attr_new=ri->attr;/*Updaterouteinglobalroutingtable.*/rd_rn=bgp_a
fi_node_get(bgp->rib[afi][safi],afi,safi,(structprefix*)evp,&vpn->prd);assert(rd
_rn);update_evpn_route_entry(bgp,vpn,afi,safi,rd_rn,attr_new,0,0,&global_ri,0);/
*Scheduleforprocessingandunlocknode.*/bgp_process(bgp,rd_rn,afi,safi);bgp_unlock
_node(rd_rn);}/*Uninterntemporary.*/aspath_unintern(&attr.aspath);aspath_uninter
n(&attr_sticky.aspath);aspath_unintern(&attr_def_gw.aspath);aspath_unintern(&att
r_ip6_ll.aspath);return0;}/**Deletealltype-2(MACIP)localroutesforthisVNI-onlyfro
mthe*globalroutingtable.Thesearealsoscheduledforwithdrawfrompeers.*/staticintdel
ete_global_type2_routes(structbgp*bgp,structbgpevpn*vpn){afi_tafi;safi_tsafi;str
uctbgp_node*rdrn,*rn;structbgp_table*table;structbgp_info*ri;afi=AFI_L2VPN;safi=
SAFI_EVPN;rdrn=bgp_node_lookup(bgp->rib[afi][safi],(structprefix*)&vpn->prd);if(
rdrn&&rdrn->info){table=(structbgp_table*)rdrn->info;for(rn=bgp_table_top(table)
;rn;rn=bgp_route_next(rn)){structprefix_evpn*evp=(structprefix_evpn*)&rn->p;if(e
vp->prefix.route_type!=BGP_EVPN_MAC_IP_ROUTE)continue;delete_evpn_route_entry(bg
p,vpn,afi,safi,rn,&ri);if(ri)bgp_process(bgp,rn,afi,safi);}}/*UnlockRDnode.*/if(
rdrn)bgp_unlock_node(rdrn);return0;}/**Deletealltype-2(MACIP)localroutesforthisV
NI-fromtheglobal*tableaswellastheper-VNIroutetable.*/staticintdelete_all_type2_r
outes(structbgp*bgp,structbgpevpn*vpn){afi_tafi;safi_tsafi;structbgp_node*rn;str
uctbgp_info*ri;afi=AFI_L2VPN;safi=SAFI_EVPN;/*First,walktheglobalroutetableforth
isVNI'stype-2local*routes.*EVPNroutesarea2-leveltable,firstgettheRDtable.*/delet
e_global_type2_routes(bgp,vpn);/*Next,walkthisVNI'sroutetableanddeletelocaltype-
2routes.*/for(rn=bgp_table_top(vpn->route_table);rn;rn=bgp_route_next(rn)){struc
tprefix_evpn*evp=(structprefix_evpn*)&rn->p;if(evp->prefix.route_type!=BGP_EVPN_
MAC_IP_ROUTE)continue;delete_evpn_route_entry(bgp,vpn,afi,safi,rn,&ri);/*Routeen
tryinlocaltablegetsdeletedimmediately.*/if(ri)bgp_info_reap(rn,ri);}return0;}/**
Deleteallroutesintheper-VNIroutetable.*/staticintdelete_all_vni_routes(structbgp
*bgp,structbgpevpn*vpn){structbgp_node*rn;structbgp_info*ri,*nextri;/*WalkthisVN
I'sroutetableanddeleteallroutes.*/for(rn=bgp_table_top(vpn->route_table);rn;rn=b
gp_route_next(rn)){for(ri=rn->info;(ri!=NULL)&&(nextri=ri->next,1);ri=nextri){bg
p_info_delete(rn,ri);bgp_info_reap(rn,ri);}}return0;}/**Update(andadvertise)loca
lroutesforaVNI.InvokedupontheVNI*exportRTgettingmodifiedorchangetotunnelIP.Notet
hatthese*situationsneedtherouteintheper-VNItableaswellastheglobal*tabletobeupdat
ed(asattributeschange).*/staticintupdate_routes_for_vni(structbgp*bgp,structbgpe
vpn*vpn){intret;structprefix_evpnp;/*Updateandadvertisethetype-3route(onlyone)fo
llowedbythe*locallylearnttype-2routes(MACIP)-forthisVNI.*/build_evpn_type3_prefi
x(&p,vpn->originator_ip);ret=update_evpn_route(bgp,vpn,&p,0);if(ret)returnret;re
turnupdate_all_type2_routes(bgp,vpn);}/**Delete(andwithdraw)localroutesforspecif
iedVNIfromtheglobal*tableandper-VNItable.Afterthis,removeallotherroutesfrom*thep
er-VNItable.InvokedupontheVNIbeingdeletedorEVPN*(advertise-all-vni)beingdisabled
.*/staticintdelete_routes_for_vni(structbgp*bgp,structbgpevpn*vpn){intret;struct
prefix_evpnp;/*Deleteandwithdrawlocallylearnttype-2routes(MACIP)*followedbytype-
3routes(onlyone)-forthisVNI.*/ret=delete_all_type2_routes(bgp,vpn);if(ret)return
ret;build_evpn_type3_prefix(&p,vpn->originator_ip);ret=delete_evpn_route(bgp,vpn
,&p);if(ret)returnret;/*Deleteallroutesfromtheper-VNItable.*/returndelete_all_vn
i_routes(bgp,vpn);}/**ThereisatunnelendpointIPaddresschangeforthisVNI,delete*pri
ortype-3route(ifneeded)andupdate.*Note:Routere-advertisementhappenselsewhereafte
rotherprocessing*otherchanges.*/staticinthandle_tunnel_ip_change(structbgp*bgp,s
tructbgpevpn*vpn,structin_addroriginator_ip){structprefix_evpnp;/*IfVNIisnotlive
,weonlyneedtoupdatetheoriginatorip*/if(!is_vni_live(vpn)){vpn->originator_ip=ori
ginator_ip;return0;}/*Updatethetunnel-iphash*/bgp_tip_del(bgp,&vpn->originator_i
p);bgp_tip_add(bgp,&originator_ip);/*filterroutesasmartiannexthopdbhaschanged*/b
gp_filter_evpn_routes_upon_martian_nh_change(bgp);/*Needtowithdrawtype-3routeast
heoriginatorIPispart*ofthekey.*/build_evpn_type3_prefix(&p,vpn->originator_ip);d
elete_evpn_route(bgp,vpn,&p);/*UpdatethetunnelIPandre-advertiseallroutesforthisV
NI.*/vpn->originator_ip=originator_ip;return0;}/**InstallrouteentryintotheVRFrou
tingtableandinvokerouteselection.*/staticintinstall_evpn_route_entry_in_vrf(stru
ctbgp*bgp_vrf,structprefix_evpn*evp,structbgp_info*parent_ri){structbgp_node*rn;
structbgp_info*ri;structattrattr;structattr*attr_new;intret=0;structprefixp;stru
ctprefix*pp=&p;afi_tafi=0;safi_tsafi=0;charbuf[PREFIX_STRLEN];charbuf1[PREFIX_ST
RLEN];memset(pp,0,sizeof(structprefix));if(evp->prefix.route_type==BGP_EVPN_MAC_
IP_ROUTE)ip_prefix_from_type2_prefix(evp,pp);elseif(evp->prefix.route_type==BGP_
EVPN_IP_PREFIX_ROUTE)ip_prefix_from_type5_prefix(evp,pp);if(bgp_debug_zebra(NULL
)){zlog_debug("installingevpnprefix%sasipprefix%sinvrf%s",prefix2str(evp,buf,siz
eof(buf)),prefix2str(pp,buf1,sizeof(buf)),vrf_id_to_name(bgp_vrf->vrf_id));}/*Cr
eate(orfetch)routewithintheVRF.*//*NOTE:ThereisnoRDhere.*/if(IS_EVPN_PREFIX_IPAD
DR_V4(evp)){afi=AFI_IP;safi=SAFI_UNICAST;rn=bgp_node_get(bgp_vrf->rib[afi][safi]
,pp);}elseif(IS_EVPN_PREFIX_IPADDR_V6(evp)){afi=AFI_IP6;safi=SAFI_UNICAST;rn=bgp
_node_get(bgp_vrf->rib[afi][safi],pp);}elsereturn0;/*EVPNroutescurrentlyonlysupp
ortaIPv4nexthopwhichcorresponds*totheremoteVTEP.WhenimportingintoaVRF,ifitisIPv6
host*route,wehavetoconvertthenexthoptoanIPv4-mappedaddress*fortherestofthecodeto
flowthrough.*/bgp_attr_dup(&attr,parent_ri->attr);if(afi==AFI_IP6)evpn_convert_n
exthop_to_ipv6(&attr);/*Checkifrouteentryisalreadypresent.*/for(ri=rn->info;ri;r
i=ri->next)if(ri->extra&&(structbgp_info*)ri->extra->parent==parent_ri)break;if(
!ri){/*Add(orupdate)attributetohash.*/attr_new=bgp_attr_intern(&attr);/*Createne
wroutewithitsattribute.*/ri=info_make(parent_ri->type,BGP_ROUTE_IMPORTED,0,paren
t_ri->peer,attr_new,rn);SET_FLAG(ri->flags,BGP_INFO_VALID);bgp_info_extra_get(ri
);ri->extra->parent=parent_ri;if(parent_ri->extra){memcpy(&ri->extra->label,&par
ent_ri->extra->label,sizeof(ri->extra->label));ri->extra->num_labels=parent_ri->
extra->num_labels;}bgp_info_add(rn,ri);}else{if(attrhash_cmp(ri->attr,&attr)&&!C
HECK_FLAG(ri->flags,BGP_INFO_REMOVED)){bgp_unlock_node(rn);return0;}/*Theattribu
tehaschanged.*//*Add(orupdate)attributetohash.*/attr_new=bgp_attr_intern(&attr);
/*Restoreroute,ifneeded.*/if(CHECK_FLAG(ri->flags,BGP_INFO_REMOVED))bgp_info_res
tore(rn,ri);/*Markifnexthophaschanged.*/if((afi==AFI_IP&&!IPV4_ADDR_SAME(&ri->at
tr->nexthop,&attr_new->nexthop))||(afi==AFI_IP6&&!IPV6_ADDR_SAME(&ri->attr->mp_n
exthop_global,&attr_new->mp_nexthop_global)))SET_FLAG(ri->flags,BGP_INFO_IGP_CHA
NGED);/*Uninternexisting,settonew.*/bgp_attr_unintern(&ri->attr);ri->attr=attr_n
ew;ri->uptime=bgp_clock();}/*Performrouteselectionandupdatezebra,ifrequired.*/bg
p_process(bgp_vrf,rn,afi,safi);returnret;}/**InstallrouteentryintotheVNIroutingt
ableandinvokerouteselection.*/staticintinstall_evpn_route_entry(structbgp*bgp,st
ructbgpevpn*vpn,structprefix_evpn*p,structbgp_info*parent_ri){structbgp_node*rn;
structbgp_info*ri;structattr*attr_new;intret;/*Create(orfetch)routewithintheVNI.
*//*NOTE:ThereisnoRDhere.*/rn=bgp_node_get(vpn->route_table,(structprefix*)p);/*
Checkifrouteentryisalreadypresent.*/for(ri=rn->info;ri;ri=ri->next)if(ri->extra&
&(structbgp_info*)ri->extra->parent==parent_ri)break;if(!ri){/*Add(orupdate)attr
ibutetohash.*/attr_new=bgp_attr_intern(parent_ri->attr);/*Createnewroutewithitsa
ttribute.*/ri=info_make(parent_ri->type,BGP_ROUTE_IMPORTED,0,parent_ri->peer,att
r_new,rn);SET_FLAG(ri->flags,BGP_INFO_VALID);bgp_info_extra_get(ri);ri->extra->p
arent=parent_ri;if(parent_ri->extra){memcpy(&ri->extra->label,&parent_ri->extra-
>label,sizeof(ri->extra->label));ri->extra->num_labels=parent_ri->extra->num_lab
els;}bgp_info_add(rn,ri);}else{if(attrhash_cmp(ri->attr,parent_ri->attr)&&!CHECK
_FLAG(ri->flags,BGP_INFO_REMOVED)){bgp_unlock_node(rn);return0;}/*Theattributeha
schanged.*//*Add(orupdate)attributetohash.*/attr_new=bgp_attr_intern(parent_ri->
attr);/*Restoreroute,ifneeded.*/if(CHECK_FLAG(ri->flags,BGP_INFO_REMOVED))bgp_in
fo_restore(rn,ri);/*Markifnexthophaschanged.*/if(!IPV4_ADDR_SAME(&ri->attr->next
hop,&attr_new->nexthop))SET_FLAG(ri->flags,BGP_INFO_IGP_CHANGED);/*Uninternexist
ing,settonew.*/bgp_attr_unintern(&ri->attr);ri->attr=attr_new;ri->uptime=bgp_clo
ck();}/*Performrouteselectionandupdatezebra,ifrequired.*/ret=evpn_route_select_i
nstall(bgp,vpn,rn);returnret;}/**UninstallrouteentryfromtheVRFroutingtableandsen
dmessage*tozebra,ifappropriate.*/staticintuninstall_evpn_route_entry_in_vrf(stru
ctbgp*bgp_vrf,structprefix_evpn*evp,structbgp_info*parent_ri){structbgp_node*rn;
structbgp_info*ri;intret=0;structprefixp;structprefix*pp=&p;afi_tafi=0;safi_tsaf
i=0;charbuf[PREFIX_STRLEN];charbuf1[PREFIX_STRLEN];memset(pp,0,sizeof(structpref
ix));if(evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE)ip_prefix_from_type2_prefi
x(evp,pp);elseif(evp->prefix.route_type==BGP_EVPN_IP_PREFIX_ROUTE)ip_prefix_from
_type5_prefix(evp,pp);if(bgp_debug_zebra(NULL)){zlog_debug("uninstallingevpnpref
ix%sasipprefix%sinvrf%s",prefix2str(evp,buf,sizeof(buf)),prefix2str(pp,buf1,size
of(buf)),vrf_id_to_name(bgp_vrf->vrf_id));}/*LocateroutewithintheVRF.*//*NOTE:Th
ereisnoRDhere.*/if(IS_EVPN_PREFIX_IPADDR_V4(evp)){afi=AFI_IP;safi=SAFI_UNICAST;r
n=bgp_node_lookup(bgp_vrf->rib[afi][safi],pp);}else{afi=AFI_IP6;safi=SAFI_UNICAS
T;rn=bgp_node_lookup(bgp_vrf->rib[afi][safi],pp);}if(!rn)return0;/*Findmatchingr
outeentry.*/for(ri=rn->info;ri;ri=ri->next)if(ri->extra&&(structbgp_info*)ri->ex
tra->parent==parent_ri)break;if(!ri)return0;/*Markentryfordeletion*/bgp_info_del
ete(rn,ri);/*Performrouteselectionandupdatezebra,ifrequired.*/bgp_process(bgp_vr
f,rn,afi,safi);/*Unlockroutenode.*/bgp_unlock_node(rn);returnret;}/**Uninstallro
uteentryfromtheVNIroutingtableandsendmessage*tozebra,ifappropriate.*/staticintun
install_evpn_route_entry(structbgp*bgp,structbgpevpn*vpn,structprefix_evpn*p,str
uctbgp_info*parent_ri){structbgp_node*rn;structbgp_info*ri;intret;/*Locateroutew
ithintheVNI.*//*NOTE:ThereisnoRDhere.*/rn=bgp_node_lookup(vpn->route_table,(stru
ctprefix*)p);if(!rn)return0;/*Findmatchingrouteentry.*/for(ri=rn->info;ri;ri=ri-
>next)if(ri->extra&&(structbgp_info*)ri->extra->parent==parent_ri)break;if(!ri)r
eturn0;/*Markentryfordeletion*/bgp_info_delete(rn,ri);/*Performrouteselectionand
updatezebra,ifrequired.*/ret=evpn_route_select_install(bgp,vpn,rn);/*Unlockroute
node.*/bgp_unlock_node(rn);returnret;}/**GivenarouteentryandaVRF,seeifthisroutee
ntryshouldbe*importedintotheVRFi.e.,RTsmatch.*/staticintis_route_matching_for_vr
f(structbgp*bgp_vrf,structbgp_info*ri){structattr*attr=ri->attr;structecommunity
*ecom;inti;assert(attr);/*RouteshouldhavevalidRTtobeevenconsidered.*/if(!(attr->
flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES)))return0;ecom=attr->ecommunity;if(!
ecom||!ecom->size)return0;/*ForeachextendedcommunityRT,seeifitmatchesthisVNI.Ifa
nyRT*matches,we'redone.*/for(i=0;i<ecom->size;i++){uint8_t*pnt;uint8_ttype,sub_t
ype;structecommunity_val*eval;structecommunity_valeval_tmp;structvrf_irt_node*ir
t;/*OnlydealwithRTs*/pnt=(ecom->val+(i*ECOMMUNITY_SIZE));eval=(structecommunity_
val*)(ecom->val+(i*ECOMMUNITY_SIZE));type=*pnt++;sub_type=*pnt++;if(sub_type!=EC
OMMUNITY_ROUTE_TARGET)continue;/*SeeifthisRTmatchesspecifiedVNIsimportRTs*/irt=l
ookup_vrf_import_rt(eval);if(irt&&irt->vrfs)if(is_vrf_present_in_irt_vrfs(irt->v
rfs,bgp_vrf))return1;/*Alsocheckfornon-exactmatch.Inthis,wemaskouttheAS*and*only
checkonthelocal-adminsub-field.Thisisto*facilitateusing*VNIastheRTforEBGPpeering
too.*/irt=NULL;if(type==ECOMMUNITY_ENCODE_AS||type==ECOMMUNITY_ENCODE_AS4||type=
=ECOMMUNITY_ENCODE_IP){memcpy(&eval_tmp,eval,ECOMMUNITY_SIZE);mask_ecom_global_a
dmin(&eval_tmp,eval);irt=lookup_vrf_import_rt(&eval_tmp);}if(irt&&irt->vrfs)if(i
s_vrf_present_in_irt_vrfs(irt->vrfs,bgp_vrf))return1;}return0;}/**Givenarouteent
ryandaVNI,seeifthisrouteentryshouldbe*importedintotheVNIi.e.,RTsmatch.*/staticin
tis_route_matching_for_vni(structbgp*bgp,structbgpevpn*vpn,structbgp_info*ri){st
ructattr*attr=ri->attr;structecommunity*ecom;inti;assert(attr);/*Routeshouldhave
validRTtobeevenconsidered.*/if(!(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITI
ES)))return0;ecom=attr->ecommunity;if(!ecom||!ecom->size)return0;/*Foreachextend
edcommunityRT,seeifitmatchesthisVNI.IfanyRT*matches,we'redone.*/for(i=0;i<ecom->
size;i++){uint8_t*pnt;uint8_ttype,sub_type;structecommunity_val*eval;structecomm
unity_valeval_tmp;structirt_node*irt;/*OnlydealwithRTs*/pnt=(ecom->val+(i*ECOMMU
NITY_SIZE));eval=(structecommunity_val*)(ecom->val+(i*ECOMMUNITY_SIZE));type=*pn
t++;sub_type=*pnt++;if(sub_type!=ECOMMUNITY_ROUTE_TARGET)continue;/*SeeifthisRTm
atchesspecifiedVNIsimportRTs*/irt=lookup_import_rt(bgp,eval);if(irt&&irt->vnis)i
f(is_vni_present_in_irt_vnis(irt->vnis,vpn))return1;/*Alsocheckfornon-exactmatch
.Inthis,wemaskouttheAS*and*onlycheckonthelocal-adminsub-field.Thisisto*facilitat
eusing*VNIastheRTforEBGPpeeringtoo.*/irt=NULL;if(type==ECOMMUNITY_ENCODE_AS||typ
e==ECOMMUNITY_ENCODE_AS4||type==ECOMMUNITY_ENCODE_IP){memcpy(&eval_tmp,eval,ECOM
MUNITY_SIZE);mask_ecom_global_admin(&eval_tmp,eval);irt=lookup_import_rt(bgp,&ev
al_tmp);}if(irt&&irt->vnis)if(is_vni_present_in_irt_vnis(irt->vnis,vpn))return1;
}return0;}/**Installoruninstallmac-iproutesareappropriateforthis*particularVRF.*
/staticintinstall_uninstall_routes_for_vrf(structbgp*bgp_vrf,intinstall){afi_taf
i;safi_tsafi;structbgp_node*rd_rn,*rn;structbgp_table*table;structbgp_info*ri;in
tret;charbuf[PREFIX_STRLEN];structbgp*bgp_def=NULL;afi=AFI_L2VPN;safi=SAFI_EVPN;
bgp_def=bgp_get_default();if(!bgp_def)return-1;/*Walkentireglobalroutingtableand
evaluaterouteswhichcouldbe*importedintothisVRF.Notethatweneedtoloopthroughallglo
bal*routestodeterminewhichroutematchestheimportrtonvrf*/for(rd_rn=bgp_table_top(
bgp_def->rib[afi][safi]);rd_rn;rd_rn=bgp_route_next(rd_rn)){table=(structbgp_tab
le*)(rd_rn->info);if(!table)continue;for(rn=bgp_table_top(table);rn;rn=bgp_route
_next(rn)){structprefix_evpn*evp=(structprefix_evpn*)&rn->p;/*ifnotmac-iproutesk
ipthisroute*/if(!(evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE||evp->prefix.rou
te_type==BGP_EVPN_IP_PREFIX_ROUTE))continue;/*ifnotamac+iprouteskipthisroute*/if
(!(IS_EVPN_PREFIX_IPADDR_V4(evp)||IS_EVPN_PREFIX_IPADDR_V6(evp)))continue;for(ri
=rn->info;ri;ri=ri->next){/*Consider"valid"remoteroutesapplicablefor*thisVRF.*/i
f(!(CHECK_FLAG(ri->flags,BGP_INFO_VALID)&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_typ
e==BGP_ROUTE_NORMAL))continue;if(is_route_matching_for_vrf(bgp_vrf,ri)){if(insta
ll)ret=install_evpn_route_entry_in_vrf(bgp_vrf,evp,ri);elseret=uninstall_evpn_ro
ute_entry_in_vrf(bgp_vrf,evp,ri);if(ret){zlog_err("Failedto%sEVPN%srouteinVRF%s"
,install?"install":"uninstall",prefix2str(evp,buf,sizeof(buf)),vrf_id_to_name(bg
p_vrf->vrf_id));returnret;}}}}}return0;}/**Installoruninstallroutesofspecifiedty
pethatareappropriateforthis*particularVNI.*/staticintinstall_uninstall_routes_fo
r_vni(structbgp*bgp,structbgpevpn*vpn,bgp_evpn_route_typertype,intinstall){afi_t
afi;safi_tsafi;structbgp_node*rd_rn,*rn;structbgp_table*table;structbgp_info*ri;
intret;afi=AFI_L2VPN;safi=SAFI_EVPN;/*Walkentireglobalroutingtableandevaluaterou
teswhichcouldbe*importedintothisVPN.Notethatwecannotjustlookattheroutes*for*theV
NI'sRD-remoteroutesapplicableforthisVNIcouldhaveany*RD.*//*EVPNroutesarea2-level
table.*/for(rd_rn=bgp_table_top(bgp->rib[afi][safi]);rd_rn;rd_rn=bgp_route_next(
rd_rn)){table=(structbgp_table*)(rd_rn->info);if(!table)continue;for(rn=bgp_tabl
e_top(table);rn;rn=bgp_route_next(rn)){structprefix_evpn*evp=(structprefix_evpn*
)&rn->p;if(evp->prefix.route_type!=rtype)continue;for(ri=rn->info;ri;ri=ri->next
){/*Consider"valid"remoteroutesapplicablefor*thisVNI.*/if(!(CHECK_FLAG(ri->flags
,BGP_INFO_VALID)&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_NORMAL))con
tinue;if(is_route_matching_for_vni(bgp,vpn,ri)){if(install)ret=install_evpn_rout
e_entry(bgp,vpn,evp,ri);elseret=uninstall_evpn_route_entry(bgp,vpn,evp,ri);if(re
t){zlog_err("%u:Failedto%sEVPN%srouteinVNI%u",bgp->vrf_id,install?"install":"uni
nstall",rtype==BGP_EVPN_MAC_IP_ROUTE?"MACIP":"IMET",vpn->vni);returnret;}}}}}ret
urn0;}/*InstallanyexistingremoteroutesapplicableforthisVRFintoVRFRIB.This*isinvo
keduponl3vni-addorl3vniimportrtchange*/staticintinstall_routes_for_vrf(structbgp
*bgp_vrf){install_uninstall_routes_for_vrf(bgp_vrf,1);return0;}/**Installanyexis
tingremoteroutesapplicableforthisVNIintoits*routingtable.ThisisinvokedwhenaVNIbe
comes"live"oritsImport*RTischanged.*/staticintinstall_routes_for_vni(structbgp*b
gp,structbgpevpn*vpn){intret;/*Installtype-3routesfollowedbytype-2routes-theones
applicable*forthisVNI.*/ret=install_uninstall_routes_for_vni(bgp,vpn,BGP_EVPN_IM
ET_ROUTE,1);if(ret)returnret;returninstall_uninstall_routes_for_vni(bgp,vpn,BGP_
EVPN_MAC_IP_ROUTE,1);}/*uninstallroutesfroml3vnivrf.*/staticintuninstall_routes_
for_vrf(structbgp*bgp_vrf){install_uninstall_routes_for_vrf(bgp_vrf,0);return0;}
/**UninstallanyexistingremoteroutesforthisVNI.Onescenarioinwhich*thisisinvokedis
uponanimportRTchange.*/staticintuninstall_routes_for_vni(structbgp*bgp,structbgp
evpn*vpn){intret;/*Uninstalltype-2routesfollowedbytype-3routes-theones*applicabl
e*forthisVNI.*/ret=install_uninstall_routes_for_vni(bgp,vpn,BGP_EVPN_MAC_IP_ROUT
E,0);if(ret)returnret;returninstall_uninstall_routes_for_vni(bgp,vpn,BGP_EVPN_IM
ET_ROUTE,0);}/**InstalloruninstallrouteinmatchingVRFs(list).*/staticintinstall_u
ninstall_route_in_vrfs(structbgp*bgp_def,afi_tafi,safi_tsafi,structprefix_evpn*e
vp,structbgp_info*ri,structlist*vrfs,intinstall){charbuf[PREFIX2STR_BUFFER];stru
ctbgp*bgp_vrf;structlistnode*node,*nnode;/*Onlytype-2/type-5routesgointoaVRF*/if
(!(evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE||evp->prefix.route_type==BGP_EV
PN_IP_PREFIX_ROUTE))return0;/*ifitistype-2routeandnotamac+iprouteskipthisroute*/
if((evp->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE)&&!(IS_EVPN_PREFIX_IPADDR_V4(e
vp)||IS_EVPN_PREFIX_IPADDR_V6(evp)))return0;for(ALL_LIST_ELEMENTS(vrfs,node,nnod
e,bgp_vrf)){intret;if(install)ret=install_evpn_route_entry_in_vrf(bgp_vrf,evp,ri
);elseret=uninstall_evpn_route_entry_in_vrf(bgp_vrf,evp,ri);if(ret){zlog_err("%u
:Failedto%sprefix%sinVRF%s",bgp_def->vrf_id,install?"install":"uninstall",prefix
2str(evp,buf,sizeof(buf)),vrf_id_to_name(bgp_vrf->vrf_id));returnret;}}return0;}
/**InstalloruninstallrouteinmatchingVNIs(list).*/staticintinstall_uninstall_rout
e_in_vnis(structbgp*bgp,afi_tafi,safi_tsafi,structprefix_evpn*evp,structbgp_info
*ri,structlist*vnis,intinstall){structbgpevpn*vpn;structlistnode*node,*nnode;for
(ALL_LIST_ELEMENTS(vnis,node,nnode,vpn)){intret;if(!is_vni_live(vpn))continue;if
(install)ret=install_evpn_route_entry(bgp,vpn,evp,ri);elseret=uninstall_evpn_rou
te_entry(bgp,vpn,evp,ri);if(ret){zlog_err("%u:Failedto%sEVPN%srouteinVNI%u",bgp-
>vrf_id,install?"install":"uninstall",evp->prefix.route_type==BGP_EVPN_MAC_IP_RO
UTE?"MACIP":"IMET",vpn->vni);returnret;}}return0;}/**Installoruninstallroutefora
ppropriateVNIs.*/staticintinstall_uninstall_evpn_route(structbgp*bgp,afi_tafi,sa
fi_tsafi,structprefix*p,structbgp_info*ri,intimport){structprefix_evpn*evp=(stru
ctprefix_evpn*)p;structattr*attr=ri->attr;structecommunity*ecom;inti;assert(attr
);/*Onlytype-2andtype-3andtype-5aresupportedcurrently*/if(!(evp->prefix.route_ty
pe==BGP_EVPN_MAC_IP_ROUTE||evp->prefix.route_type==BGP_EVPN_IMET_ROUTE||evp->pre
fix.route_type==BGP_EVPN_IP_PREFIX_ROUTE))return0;/*Ifwedon'thaveRouteTarget,not
hingmuchtodo.*/if(!(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES)))return0;
ecom=attr->ecommunity;if(!ecom||!ecom->size)return-1;/*ForeachextendedcommunityR
T,seewhichVNIs/VRFsmatchandimport*therouteintomatchingVNIs/VRFs.*/for(i=0;i<ecom
->size;i++){uint8_t*pnt;uint8_ttype,sub_type;structecommunity_val*eval;structeco
mmunity_valeval_tmp;structirt_node*irt;/*importrtforl2vni*/structvrf_irt_node*vr
f_irt;/*importrtforl3vni*//*OnlydealwithRTs*/pnt=(ecom->val+(i*ECOMMUNITY_SIZE))
;eval=(structecommunity_val*)(ecom->val+(i*ECOMMUNITY_SIZE));type=*pnt++;sub_typ
e=*pnt++;if(sub_type!=ECOMMUNITY_ROUTE_TARGET)continue;/*Importrouteintomatching
l2-vnis(type-2/type-3routesgo*intol2vnitable)*/irt=lookup_import_rt(bgp,eval);if
(irt&&irt->vnis)install_uninstall_route_in_vnis(bgp,afi,safi,evp,ri,irt->vnis,im
port);/*Importrouteintomatchingl3-vnis(type-2/type-5routesgo*intol3vni/vrftable)
*/vrf_irt=lookup_vrf_import_rt(eval);if(vrf_irt&&vrf_irt->vrfs)install_uninstall
_route_in_vrfs(bgp,afi,safi,evp,ri,vrf_irt->vrfs,import);/*Alsocheckfornon-exact
match.Inthis,*wemaskouttheASand*onlycheckonthelocal-adminsub-field.*Thisistofaci
litateusing*VNIastheRTforEBGPpeeringtoo.*/irt=NULL;vrf_irt=NULL;if(type==ECOMMUN
ITY_ENCODE_AS||type==ECOMMUNITY_ENCODE_AS4||type==ECOMMUNITY_ENCODE_IP){memcpy(&
eval_tmp,eval,ECOMMUNITY_SIZE);mask_ecom_global_admin(&eval_tmp,eval);irt=lookup
_import_rt(bgp,&eval_tmp);vrf_irt=lookup_vrf_import_rt(&eval_tmp);}if(irt&&irt->
vnis)install_uninstall_route_in_vnis(bgp,afi,safi,evp,ri,irt->vnis,import);if(vr
f_irt&&vrf_irt->vrfs)install_uninstall_route_in_vrfs(bgp,afi,safi,evp,ri,vrf_irt
->vrfs,import);}return0;}/*deleteandwithdrawallipv4andipv6routesinthevrftableast
ype-5*routes*/staticvoiddelete_withdraw_vrf_routes(structbgp*bgp_vrf){/*deleteal
lipv4routesandwithdrawfrompeers*/if(advertise_type5_routes(bgp_vrf,AFI_IP))bgp_e
vpn_withdraw_type5_routes(bgp_vrf,AFI_IP,SAFI_UNICAST);/*deleteallipv6routesandw
ithdrawfrompeers*/if(advertise_type5_routes(bgp_vrf,AFI_IP6))bgp_evpn_withdraw_t
ype5_routes(bgp_vrf,AFI_IP6,SAFI_UNICAST);}/*updateandadvertiseallipv4andipv6rou
tesinthrvrftableastype-5*routes*/staticvoidupdate_advertise_vrf_routes(structbgp
*bgp_vrf){/*updateallipv4routes*/if(advertise_type5_routes(bgp_vrf,AFI_IP))bgp_e
vpn_advertise_type5_routes(bgp_vrf,AFI_IP,SAFI_UNICAST);/*updateallipv6routes*/i
f(advertise_type5_routes(bgp_vrf,AFI_IP6))bgp_evpn_advertise_type5_routes(bgp_vr
f,AFI_IP6,SAFI_UNICAST);}/**updateandadvertiselocalroutesforaVRFastype-5routes.*
ThisisinvokeduponRDchangeforaVRF.Notetahttheprocessingisonly*doneintheglobalrout
etableusingtherouteswhichalreadyexistinthe*VRFroutingtable*/staticvoidupdate_rou
ter_id_vrf(structbgp*bgp_vrf){/*skipiftheRDisconfigured*/if(is_vrf_rd_configured
(bgp_vrf))return;/*derivetheRDfortheVRFbasedonnewrouter-id*/bgp_evpn_derive_auto
_rd_for_vrf(bgp_vrf);/*updateadvertiseipv4|ipv6routesastype-5routes*/update_adve
rtise_vrf_routes(bgp_vrf);}/**Deleteandwithdrawalltype-5routesfortheRDcorrespond
ingtoVRF.*ThisisinvokeduponVRFRDchange.Theprocessingisdoneonlyfromglobal*table.*
/staticvoidwithdraw_router_id_vrf(structbgp*bgp_vrf){/*skipiftheRDisconfigured*/
if(is_vrf_rd_configured(bgp_vrf))return;/*delete/withdrawipv4|ipv6routesastype-5
routes*/delete_withdraw_vrf_routes(bgp_vrf);}/**Updateandadvertiselocalroutesfor
aVNI.Invokeduponrouter-id*change.Notethattheprocessingisdoneonlyontheglobalroute
table*usingroutesthatalreadyexistintheper-VNItable.*/staticintupdate_advertise_v
ni_routes(structbgp*bgp,structbgpevpn*vpn){structprefix_evpnp;structbgp_node*rn,
*global_rn;structbgp_info*ri,*global_ri;structattr*attr;afi_tafi=AFI_L2VPN;safi_
tsafi=SAFI_EVPN;/*Locatetype-3routeforVNIintheper-VNItableanduseits*attributesto
createandadvertisethetype-3routeforthisVNI*intheglobaltable.*/build_evpn_type3_p
refix(&p,vpn->originator_ip);rn=bgp_node_lookup(vpn->route_table,(structprefix*)
&p);if(!rn)/*unexpected*/return0;for(ri=rn->info;ri;ri=ri->next)if(ri->peer==bgp
->peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_STATIC)break;if(
!ri)/*unexpected*/return0;attr=ri->attr;global_rn=bgp_afi_node_get(bgp->rib[afi]
[safi],afi,safi,(structprefix*)&p,&vpn->prd);update_evpn_route_entry(bgp,vpn,afi
,safi,global_rn,attr,1,0,&ri,0);/*Scheduleforprocessingandunlocknode.*/bgp_proce
ss(bgp,global_rn,afi,safi);bgp_unlock_node(global_rn);/*Now,walkthisVNI'srouteta
bleandusetherouteanditsattribute*tocreateandschedulerouteinglobaltable.*/for(rn=
bgp_table_top(vpn->route_table);rn;rn=bgp_route_next(rn)){structprefix_evpn*evp=
(structprefix_evpn*)&rn->p;/*IdentifyMAC-IPlocalroutes.*/if(evp->prefix.route_ty
pe!=BGP_EVPN_MAC_IP_ROUTE)continue;for(ri=rn->info;ri;ri=ri->next)if(ri->peer==b
gp->peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_STATIC)break;i
f(!ri)continue;/*Createrouteinglobalroutingtableusingthisrouteentry's*attribute.
*/attr=ri->attr;global_rn=bgp_afi_node_get(bgp->rib[afi][safi],afi,safi,(structp
refix*)evp,&vpn->prd);assert(global_rn);update_evpn_route_entry(bgp,vpn,afi,safi
,global_rn,attr,1,0,&global_ri,0);/*Scheduleforprocessingandunlocknode.*/bgp_pro
cess(bgp,global_rn,afi,safi);bgp_unlock_node(global_rn);}return0;}/**Delete(andw
ithdraw)localroutesforaVNI-onlyfromtheglobal*table.Invokeduponrouter-idchange.*/
staticintdelete_withdraw_vni_routes(structbgp*bgp,structbgpevpn*vpn){intret;stru
ctprefix_evpnp;structbgp_node*global_rn;structbgp_info*ri;afi_tafi=AFI_L2VPN;saf
i_tsafi=SAFI_EVPN;/*Deleteandwithdrawlocallylearnttype-2routes(MACIP)*forthisVNI
-fromtheglobaltable.*/ret=delete_global_type2_routes(bgp,vpn);if(ret)returnret;/
*Removetype-3routeforthisVNIfromglobaltable.*/build_evpn_type3_prefix(&p,vpn->or
iginator_ip);global_rn=bgp_afi_node_lookup(bgp->rib[afi][safi],afi,safi,(structp
refix*)&p,&vpn->prd);if(global_rn){/*DeleterouteentryintheglobalEVPNtable.*/dele
te_evpn_route_entry(bgp,vpn,afi,safi,global_rn,&ri);/*Scheduleforprocessing-with
drawstopeershappenfrom*thistable.*/if(ri)bgp_process(bgp,global_rn,afi,safi);bgp
_unlock_node(global_rn);}return0;}/**Handlerouter-idchange.Updateandadvertiseloc
alroutescorresponding*tothisVNIfrompeers.Notethatthisisinvokedafterupdatingthe*r
outer-id.Theroutesintheper-VNItableareusedtocreateroutesin*theglobaltableandsche
dulethem.*/staticvoidupdate_router_id_vni(structhash_backet*backet,structbgp*bgp
){structbgpevpn*vpn;vpn=(structbgpevpn*)backet->data;if(!vpn){zlog_warn("%s:VNIh
ashentryforVNInotfound",__FUNCTION__);return;}/*SkipVNIswithconfiguredRD.*/if(is
_rd_configured(vpn))return;bgp_evpn_derive_auto_rd(bgp,vpn);update_advertise_vni
_routes(bgp,vpn);}/**Handlerouter-idchange.Deleteandwithdrawlocalroutescorrespon
ding*tothisVNIfrompeers.Notethatthisisinvokedpriortoupdating*therouter-idandisdo
neonlyontheglobalroutetable,theroutes*areneededintheper-VNItabletore-advertisewi
thnewrouterid.*/staticvoidwithdraw_router_id_vni(structhash_backet*backet,struct
bgp*bgp){structbgpevpn*vpn;vpn=(structbgpevpn*)backet->data;if(!vpn){zlog_warn("
%s:VNIhashentryforVNInotfound",__FUNCTION__);return;}/*SkipVNIswithconfiguredRD.
*/if(is_rd_configured(vpn))return;delete_withdraw_vni_routes(bgp,vpn);}/**Proces
sreceivedEVPNtype-2route(advertiseorwithdraw).*/staticintprocess_type2_route(str
uctpeer*peer,afi_tafi,safi_tsafi,structattr*attr,uint8_t*pfx,intpsize,uint32_tad
dpath_id){structprefix_rdprd;structprefix_evpnp;uint8_tipaddr_len;uint8_tmacaddr
_len;mpls_label_tlabel[BGP_MAX_LABELS];/*holdstheVNI(s)asinpacket*/uint32_tnum_l
abels=0;intret;/*Type-2routeshouldbeeither33,37or49bytesoran*additional3bytesift
hereisasecondlabel(VNI):*RD(8),ESI(10),EthTag(4),MACAddrLen(1),*MACAddr(6),IPlen
(1),IP(0,4or16),*MPLSLbl1(3),MPLSLbl2(0or3)*/if(psize!=33&&psize!=37&&psize!=49&
&psize!=36&&psize!=40&&psize!=52){zlog_err("%u:%s-RxEVPNType-2NLRIwithinvalidlen
gth%d",peer->bgp->vrf_id,peer->host,psize);return-1;}/*Makeprefix_rd*/prd.family
=AF_UNSPEC;prd.prefixlen=64;memcpy(&prd.val,pfx,8);pfx+=8;/*MakeEVPNprefix.*/mem
set(&p,0,sizeof(structprefix_evpn));p.family=AF_EVPN;p.prefixlen=EVPN_TYPE_2_ROU
TE_PREFIXLEN;p.prefix.route_type=BGP_EVPN_MAC_IP_ROUTE;/*SkipoverEthernetSegIden
tifierfornow.*/pfx+=10;/*SkipoverEthernetTagfornow.*/pfx+=4;/*GettheMACAddrlen*/
macaddr_len=*pfx++;/*GettheMACAddr*/if(macaddr_len==(ETH_ALEN*8)){memcpy(&p.pref
ix.mac.octet,pfx,ETH_ALEN);pfx+=ETH_ALEN;}else{zlog_err("%u:%s-RxEVPNType-2NLRIw
ithunsupportedMACaddresslength%d",peer->bgp->vrf_id,peer->host,macaddr_len);retu
rn-1;}/*GettheIP.*/ipaddr_len=*pfx++;if(ipaddr_len!=0&&ipaddr_len!=IPV4_MAX_BITL
EN&&ipaddr_len!=IPV6_MAX_BITLEN){zlog_err("%u:%s-RxEVPNType-2NLRIwithunsupported
IPaddresslength%d",peer->bgp->vrf_id,peer->host,ipaddr_len);return-1;}if(ipaddr_
len){ipaddr_len/=8;/*Converttobytes.*/p.prefix.ip.ipa_type=(ipaddr_len==IPV4_MAX
_BYTELEN)?IPADDR_V4:IPADDR_V6;memcpy(&p.prefix.ip.ip.addr,pfx,ipaddr_len);}pfx+=
ipaddr_len;/*GettheVNI(s).Storedasbyteshere.*/num_labels++;memset(label,0,sizeof
(label));memcpy(&label[0],pfx,BGP_LABEL_BYTES);pfx+=BGP_LABEL_BYTES;psize-=(33+i
paddr_len);/*DowehaveasecondVNI?*/if(psize){num_labels++;memcpy(&label[1],pfx,BG
P_LABEL_BYTES);/**Ifinfuture,wearerequiredtoaccessadditionalfields,*weMUSTincrem
entpfxbyBGP_LABEL_BYTESinbeforereading*thenextfield*/}/*Processtheroute.*/if(att
r)ret=bgp_update(peer,(structprefix*)&p,addpath_id,attr,afi,safi,ZEBRA_ROUTE_BGP
,BGP_ROUTE_NORMAL,&prd,&label[0],num_labels,0,NULL);elseret=bgp_withdraw(peer,(s
tructprefix*)&p,addpath_id,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,&prd,&
label[0],num_labels,NULL);returnret;}/**ProcessreceivedEVPNtype-3route(advertise
orwithdraw).*/staticintprocess_type3_route(structpeer*peer,afi_tafi,safi_tsafi,s
tructattr*attr,uint8_t*pfx,intpsize,uint32_taddpath_id){structprefix_rdprd;struc
tprefix_evpnp;uint8_tipaddr_len;intret;/*Type-3routeshouldbeeither17or29bytes:RD
(8),EthTag(4),*IPlen(1)andIP(4or16).*/if(psize!=17&&psize!=29){zlog_err("%u:%s-R
xEVPNType-3NLRIwithinvalidlength%d",peer->bgp->vrf_id,peer->host,psize);return-1
;}/*IfPMSIispresent,logifitisanythingotherthanIR.*Note:Wejustsimplyignorethevalu
esasitisnotclearif*doinganythingelseisbetter.*/if(attr&&(attr->flag&ATTR_FLAG_BI
T(BGP_ATTR_PMSI_TUNNEL))){if(attr->pmsi_tnl_type!=PMSI_TNLTYPE_INGR_REPL){zlog_w
arn("%u:%s-RxEVPNType-3NLRIwithunsupportedPTA%d",peer->bgp->vrf_id,peer->host,at
tr->pmsi_tnl_type);}}/*Makeprefix_rd*/prd.family=AF_UNSPEC;prd.prefixlen=64;memc
py(&prd.val,pfx,8);pfx+=8;/*MakeEVPNprefix.*/memset(&p,0,sizeof(structprefix_evp
n));p.family=AF_EVPN;p.prefixlen=EVPN_TYPE_3_ROUTE_PREFIXLEN;p.prefix.route_type
=BGP_EVPN_IMET_ROUTE;/*SkipoverEthernetTagfornow.*/pfx+=4;/*GettheIP.*/ipaddr_le
n=*pfx++;if(ipaddr_len==IPV4_MAX_BITLEN){p.prefix.ip.ipa_type=IPADDR_V4;memcpy(&
p.prefix.ip.ip.addr,pfx,IPV4_MAX_BYTELEN);}else{zlog_err("%u:%s-RxEVPNType-3NLRI
withunsupportedIPaddresslength%d",peer->bgp->vrf_id,peer->host,ipaddr_len);retur
n-1;}/*Processtheroute.*/if(attr)ret=bgp_update(peer,(structprefix*)&p,addpath_i
d,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,&prd,NULL,0,0,NULL);elseret=bgp
_withdraw(peer,(structprefix*)&p,addpath_id,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_RO
UTE_NORMAL,&prd,NULL,0,NULL);returnret;}/**ProcessreceivedEVPNtype-5route(advert
iseorwithdraw).*/staticintprocess_type5_route(structpeer*peer,afi_tafi,safi_tsaf
i,structattr*attr,uint8_t*pfx,intpsize,uint32_taddpath_id,intwithdraw){structpre
fix_rdprd;structprefix_evpnp;structbgp_route_evpnevpn;uint8_tippfx_len;uint32_te
th_tag;mpls_label_tlabel;/*holdstheVNIasinthepacket*/intret;/*Type-5routeshouldb
e34or58bytes:*RD(8),ESI(10),EthTag(4),IPlen(1),IP(4or16),*GW(4or16)andVNI(3).*No
tethattheIPandGWshouldbothbeIPv4orbothIPv6.*/if(psize!=34&&psize!=58){zlog_err("
%u:%s-RxEVPNType-5NLRIwithinvalidlength%d",peer->bgp->vrf_id,peer->host,psize);r
eturn-1;}/*Makeprefix_rd*/prd.family=AF_UNSPEC;prd.prefixlen=64;memcpy(&prd.val,
pfx,8);pfx+=8;/*MakeEVPNprefix.*/memset(&p,0,sizeof(structprefix_evpn));p.family
=AF_EVPN;p.prefixlen=EVPN_TYPE_5_ROUTE_PREFIXLEN;p.prefix.route_type=BGP_EVPN_IP
_PREFIX_ROUTE;/*Additionalinformationoutsideofprefix-ESIandGWIP*/memset(&evpn,0,
sizeof(evpn));/*FetchESI*/memcpy(&evpn.eth_s_id.val,pfx,10);pfx+=10;/*FetchEther
netTag.*/memcpy(&eth_tag,pfx,4);p.prefix.eth_tag=ntohl(eth_tag);pfx+=4;/*FetchIP
prefixlength.*/ippfx_len=*pfx++;if(ippfx_len>IPV6_MAX_BITLEN){zlog_err("%u:%s-Rx
EVPNType-5NLRIwithinvalidIPPrefixlength%d",peer->bgp->vrf_id,peer->host,ippfx_le
n);return-1;}p.prefix.ip_prefix_length=ippfx_len;/*DetermineIPv4orIPv6prefix*//*
SincetheaddressandGWarefromthesamefamily,thisjustbecomes*asimplecheckonthetotals
ize.*/if(psize==34){SET_IPADDR_V4(&p.prefix.ip);memcpy(&p.prefix.ip.ipaddr_v4,pf
x,4);pfx+=4;memcpy(&evpn.gw_ip.ipv4,pfx,4);pfx+=4;}else{SET_IPADDR_V6(&p.prefix.
ip);memcpy(&p.prefix.ip.ipaddr_v6,pfx,16);pfx+=16;memcpy(&evpn.gw_ip.ipv6,pfx,16
);pfx+=16;}/*GettheVNI(inMPLSlabelfield).Storedasbyteshere.*/memset(&label,0,siz
eof(label));memcpy(&label,pfx,BGP_LABEL_BYTES);/**Ifinfuture,wearerequiredtoacce
ssadditionalfields,*weMUSTincrementpfxbyBGP_LABEL_BYTESinbeforereadingthenext*fi
eld*//*Processtheroute.*/if(!withdraw)ret=bgp_update(peer,(structprefix*)&p,addp
ath_id,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,&prd,&label,1,0,&evpn);els
eret=bgp_withdraw(peer,(structprefix*)&p,addpath_id,attr,afi,safi,ZEBRA_ROUTE_BG
P,BGP_ROUTE_NORMAL,&prd,&label,1,&evpn);returnret;}staticvoidevpn_mpattr_encode_
type5(structstream*s,structprefix*p,structprefix_rd*prd,mpls_label_t*label,uint3
2_tnum_labels,structattr*attr){intlen;chartemp[16];structevpn_addr*p_evpn_p;mems
et(&temp,0,16);if(p->family!=AF_EVPN)return;p_evpn_p=&(p->u.prefix_evpn);/*lende
nitesthetotallenofIPandGW-IPintherouteIPandGW-IPhavetobebothipv4oripv6*/if(IS_IP
ADDR_V4(&p_evpn_p->ip))len=8;/*IPandGWIParebothipv4*/elselen=32;/*IPandGWIParebo
thipv6*//*PrefixcontainsRD,ESI,EthTag,IPlength,IP,GWIPandVNI*/stream_putc(s,8+10
+4+1+len+3);stream_put(s,prd->val,8);if(attr)stream_put(s,&(attr->evpn_overlay.e
th_s_id),10);elsestream_put(s,&temp,10);stream_putl(s,p_evpn_p->eth_tag);stream_
putc(s,p_evpn_p->ip_prefix_length);if(IS_IPADDR_V4(&p_evpn_p->ip))stream_put_ipv
4(s,p_evpn_p->ip.ipaddr_v4.s_addr);elsestream_put(s,&p_evpn_p->ip.ipaddr_v6,16);
if(attr){if(IS_IPADDR_V4(&p_evpn_p->ip))stream_put_ipv4(s,attr->evpn_overlay.gw_
ip.ipv4.s_addr);elsestream_put(s,&(attr->evpn_overlay.gw_ip.ipv6),16);}else{if(I
S_IPADDR_V4(&p_evpn_p->ip))stream_put_ipv4(s,0);elsestream_put(s,&temp,16);}if(n
um_labels)stream_put(s,label,3);elsestream_put3(s,0);}/**CleanupspecificVNIuponE
VPN(advertise-all-vni)beingdisabled.*/staticvoidcleanup_vni_on_disable(structhas
h_backet*backet,structbgp*bgp){structbgpevpn*vpn=(structbgpevpn*)backet->data;/*
RemoveEVPNroutesandscheduleforprocessing.*/delete_routes_for_vni(bgp,vpn);/*Clea
r"live"flagandseeifhashneedstobefreed.*/UNSET_FLAG(vpn->flags,VNI_FLAG_LIVE);if(
!is_vni_configured(vpn))bgp_evpn_free(bgp,vpn);}/**FreeaVNIentry;iteratorfunctio
ncalledduringcleanup.*/staticvoidfree_vni_entry(structhash_backet*backet,structb
gp*bgp){structbgpevpn*vpn;vpn=(structbgpevpn*)backet->data;delete_all_vni_routes
(bgp,vpn);bgp_evpn_free(bgp,vpn);}/**DeriveAUTOimportRTforBGPVRF-L3VNI*/staticvo
idevpn_auto_rt_import_add_for_vrf(structbgp*bgp_vrf){structbgp*bgp_def=NULL;form
_auto_rt(bgp_vrf,bgp_vrf->l3vni,bgp_vrf->vrf_import_rtl);UNSET_FLAG(bgp_vrf->vrf
_flags,BGP_VRF_IMPORT_RT_CFGD);/*MapRTtoVRF*/bgp_def=bgp_get_default();if(!bgp_d
ef)return;bgp_evpn_map_vrf_to_its_rts(bgp_vrf);}/**DeleteAUTOimportRTfromBGPVRF-
L3VNI*/staticvoidevpn_auto_rt_import_delete_for_vrf(structbgp*bgp_vrf){evpn_rt_d
elete_auto(bgp_vrf,bgp_vrf->l3vni,bgp_vrf->vrf_import_rtl);}/**DeriveAUTOexportR
TforBGPVRF-L3VNI*/staticvoidevpn_auto_rt_export_add_for_vrf(structbgp*bgp_vrf){U
NSET_FLAG(bgp_vrf->vrf_flags,BGP_VRF_EXPORT_RT_CFGD);form_auto_rt(bgp_vrf,bgp_vr
f->l3vni,bgp_vrf->vrf_export_rtl);}/**DeleteAUTOexportRTfromBGPVRF-L3VNI*/static
voidevpn_auto_rt_export_delete_for_vrf(structbgp*bgp_vrf){evpn_rt_delete_auto(bg
p_vrf,bgp_vrf->l3vni,bgp_vrf->vrf_export_rtl);}staticvoidbgp_evpn_handle_export_
rt_change_for_vrf(structbgp*bgp_vrf){structbgp*bgp_def=NULL;structlistnode*node=
NULL;structbgpevpn*vpn=NULL;bgp_def=bgp_get_default();if(!bgp_def)return;/*updat
ealltype-5routes*/update_advertise_vrf_routes(bgp_vrf);/*updatealltype-2routes*/
for(ALL_LIST_ELEMENTS_RO(bgp_vrf->l2vnis,node,vpn))update_routes_for_vni(bgp_def
,vpn);}/**Publicfunctions.*//*withdrawtype-5routecorrespondingtoipprefix*/voidbg
p_evpn_withdraw_type5_route(structbgp*bgp_vrf,structprefix*p,afi_tafi,safi_tsafi
){intret=0;structprefix_evpnevp;charbuf[PREFIX_STRLEN];build_type5_prefix_from_i
p_prefix(&evp,p);ret=delete_evpn_type5_route(bgp_vrf,&evp);if(ret){zlog_err("%uf
ailedtodeletetype-5routeforprefix%sinvrf%s",bgp_vrf->vrf_id,prefix2str(p,buf,siz
eof(buf)),vrf_id_to_name(bgp_vrf->vrf_id));}}/*withdrawalltype-5routesforanaddre
ssfamily*/voidbgp_evpn_withdraw_type5_routes(structbgp*bgp_vrf,afi_tafi,safi_tsa
fi){structbgp_table*table=NULL;structbgp_node*rn=NULL;structbgp_info*ri;table=bg
p_vrf->rib[afi][safi];for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn)){/*On
lycareabout"selected"routes-non-imported.*//*TODO:SupportforAddPathforEVPN.*/for
(ri=rn->info;ri;ri=ri->next){if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)&&(!ri->e
xtra||!ri->extra->parent)){bgp_evpn_withdraw_type5_route(bgp_vrf,&rn->p,afi,safi
);break;}}}}/**AdvertiseIPprefixastype-5route.Theafi/safiandsrc_attrpassed*tothi
sfunctioncorrespondtothoseofthesourceIPprefix(best*pathinthecaseoftheattr.Inthec
aseofalocalprefix(whenwe*areadvertisinglocalsubnets),thesrc_attrwillbeNULL.*/voi
dbgp_evpn_advertise_type5_route(structbgp*bgp_vrf,structprefix*p,structattr*src_
attr,afi_tafi,safi_tsafi){intret=0;structprefix_evpnevp;charbuf[PREFIX_STRLEN];b
uild_type5_prefix_from_ip_prefix(&evp,p);ret=update_evpn_type5_route(bgp_vrf,&ev
p,src_attr);if(ret)zlog_err("%u:Failedtocreatetype-5routeforprefix%s",bgp_vrf->v
rf_id,prefix2str(p,buf,sizeof(buf)));}/*Injectallprefixesofaparticularaddress-fa
mily(currently,IPv4or*IPv6unicast)intoEVPNastype-5routes.Thisisinvokedwhenthe*ad
vertisementisenabled.*/voidbgp_evpn_advertise_type5_routes(structbgp*bgp_vrf,afi
_tafi,safi_tsafi){structbgp_table*table=NULL;structbgp_node*rn=NULL;structbgp_in
fo*ri;table=bgp_vrf->rib[afi][safi];for(rn=bgp_table_top(table);rn;rn=bgp_route_
next(rn)){/*Needtoidentifythe"selected"routeentrytouseits*attribute.Also,weonlyc
onsider"non-imported"routes.*TODO:SupportforAddPathforEVPN.*/for(ri=rn->info;ri;
ri=ri->next){if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)&&(!ri->extra||!ri->extra
->parent)){/*applytheroute-map*/if(bgp_vrf->adv_cmd_rmap[afi][safi].map){intret=
0;ret=route_map_apply(bgp_vrf->adv_cmd_rmap[afi][safi].map,&rn->p,RMAP_BGP,ri);i
f(ret==RMAP_DENYMATCH)continue;}bgp_evpn_advertise_type5_route(bgp_vrf,&rn->p,ri
->attr,afi,safi);break;}}}}voidevpn_rt_delete_auto(structbgp*bgp,vni_tvni,struct
list*rtl){structlistnode*node,*nnode,*node_to_del;structecommunity*ecom,*ecom_au
to;structecommunity_valeval;encode_route_target_as((bgp->as&0xFFFF),vni,&eval);e
com_auto=ecommunity_new();ecommunity_add_val(ecom_auto,&eval);node_to_del=NULL;f
or(ALL_LIST_ELEMENTS(rtl,node,nnode,ecom)){if(ecommunity_match(ecom,ecom_auto)){
ecommunity_free(&ecom);node_to_del=node;}}if(node_to_del)list_delete_node(rtl,no
de_to_del);ecommunity_free(&ecom_auto);}voidbgp_evpn_configure_import_rt_for_vrf
(structbgp*bgp_vrf,structecommunity*ecomadd){/*uninstallroutesfromvrf*/uninstall
_routes_for_vrf(bgp_vrf);/*CleanuptheRTtoVRFmapping*/bgp_evpn_unmap_vrf_from_its
_rts(bgp_vrf);/*RemoveautogeneratedRT*/evpn_auto_rt_import_delete_for_vrf(bgp_vr
f);/*AddthenewlyconfiguredRTtoRTlist*/listnode_add_sort(bgp_vrf->vrf_import_rtl,
ecomadd);SET_FLAG(bgp_vrf->vrf_flags,BGP_VRF_IMPORT_RT_CFGD);/*mapVRFtoitsRTs*/b
gp_evpn_map_vrf_to_its_rts(bgp_vrf);/*installroutesmatchingthenewVRF*/install_ro
utes_for_vrf(bgp_vrf);}voidbgp_evpn_unconfigure_import_rt_for_vrf(structbgp*bgp_
vrf,structecommunity*ecomdel){structlistnode*node=NULL,*nnode=NULL,*node_to_del=
NULL;structecommunity*ecom=NULL;/*uninstallroutesfromvrf*/uninstall_routes_for_v
rf(bgp_vrf);/*CleanuptheRTtoVRFmapping*/bgp_evpn_unmap_vrf_from_its_rts(bgp_vrf)
;/*removetheRTfromtheRTlist*/for(ALL_LIST_ELEMENTS(bgp_vrf->vrf_import_rtl,node,
nnode,ecom)){if(ecommunity_match(ecom,ecomdel)){ecommunity_free(&ecom);node_to_d
el=node;break;}}if(node_to_del)list_delete_node(bgp_vrf->vrf_import_rtl,node_to_
del);/*fallbacktoautoimportrt,ifthiswasthelastRT*/if(list_isempty(bgp_vrf->vrf_i
mport_rtl)){UNSET_FLAG(bgp_vrf->vrf_flags,BGP_VRF_IMPORT_RT_CFGD);evpn_auto_rt_i
mport_add_for_vrf(bgp_vrf);}/*mapVRFstoitsRTs*/bgp_evpn_map_vrf_to_its_rts(bgp_v
rf);/*installroutesmatchingthisnewRT*/install_routes_for_vrf(bgp_vrf);}voidbgp_e
vpn_configure_export_rt_for_vrf(structbgp*bgp_vrf,structecommunity*ecomadd){/*re
moveauto-generatedRT*/evpn_auto_rt_export_delete_for_vrf(bgp_vrf);/*AddthenewRTt
otheRTlist*/listnode_add_sort(bgp_vrf->vrf_export_rtl,ecomadd);SET_FLAG(bgp_vrf-
>vrf_flags,BGP_VRF_EXPORT_RT_CFGD);bgp_evpn_handle_export_rt_change_for_vrf(bgp_
vrf);}voidbgp_evpn_unconfigure_export_rt_for_vrf(structbgp*bgp_vrf,structecommun
ity*ecomdel){structlistnode*node=NULL,*nnode=NULL,*node_to_del=NULL;structecommu
nity*ecom=NULL;/*RemovetheRTfromtheRTlist*/for(ALL_LIST_ELEMENTS(bgp_vrf->vrf_ex
port_rtl,node,nnode,ecom)){if(ecommunity_match(ecom,ecomdel)){ecommunity_free(&e
com);node_to_del=node;break;}}if(node_to_del)list_delete_node(bgp_vrf->vrf_expor
t_rtl,node_to_del);/*fallbacktoauto-generatedRTifthiswasthelastRT*/if(bgp_vrf->v
rf_export_rtl&&list_isempty(bgp_vrf->vrf_export_rtl)){UNSET_FLAG(bgp_vrf->vrf_fl
ags,BGP_VRF_EXPORT_RT_CFGD);evpn_auto_rt_export_add_for_vrf(bgp_vrf);}bgp_evpn_h
andle_export_rt_change_for_vrf(bgp_vrf);}/**HandlechangetoBGProuterid.Thisisinvo
kedtwicebythechange*handler,firstbeforetherouteridhasbeenchangedandthenafter*the
routeridhasbeenchanged.Thefirstinvocationwillresultin*localroutesforallVNIs/VRFb
eingdeletedandwithdrawnandthenext*willresultintheroutesbeingre-advertised.*/void
bgp_evpn_handle_router_id_update(structbgp*bgp,intwithdraw){if(withdraw){/*delet
eandwithdrawallthetype-5routesstoredintheglobaltableforthisvrf*/withdraw_router_
id_vrf(bgp);/*deletealltheVNIroutes(type-2/type-3)routesforallthe*L2-VNIs*/hash_
iterate(bgp->vnihash,(void(*)(structhash_backet*,void*))withdraw_router_id_vni,b
gp);}else{/*advertiseallroutesinthevrfastype-5routeswiththenew*RD*/update_router
_id_vrf(bgp);/*advertisealltheVNIroutes(type-2/type-3)routeswiththe*newRD*/hash_
iterate(bgp->vnihash,(void(*)(structhash_backet*,void*))update_router_id_vni,bgp
);}}/**HandlechangetoexportRT-updateandadvertiselocalroutes.*/intbgp_evpn_handle
_export_rt_change(structbgp*bgp,structbgpevpn*vpn){returnupdate_routes_for_vni(b
gp,vpn);}voidbgp_evpn_handle_vrf_rd_change(structbgp*bgp_vrf,intwithdraw){if(wit
hdraw)delete_withdraw_vrf_routes(bgp_vrf);elseupdate_advertise_vrf_routes(bgp_vr
f);}/**HandlechangetoRD.Thisisinvokedtwicebythechangehandler,*firstbeforetheRDha
sbeenchangedandthenaftertheRDhas*beenchanged.Thefirstinvocationwillresultinlocal
routes*ofthisVNIbeingdeletedandwithdrawnandthenextwillresult*intheroutesbeingre-
advertised.*/voidbgp_evpn_handle_rd_change(structbgp*bgp,structbgpevpn*vpn,intwi
thdraw){if(withdraw)delete_withdraw_vni_routes(bgp,vpn);elseupdate_advertise_vni
_routes(bgp,vpn);}/**InstallroutesforthisVNI.InvokeduponchangetoImportRT.*/intbg
p_evpn_install_routes(structbgp*bgp,structbgpevpn*vpn){returninstall_routes_for_
vni(bgp,vpn);}/**UninstallallroutesinstalledforthisVNI.Invokeduponchange*toImpor
tRT.*/intbgp_evpn_uninstall_routes(structbgp*bgp,structbgpevpn*vpn){returnuninst
all_routes_for_vni(bgp,vpn);}/**TODO:Hardcodedforamaximumof2VNIsrightnow*/char*b
gp_evpn_label2str(mpls_label_t*label,uint32_tnum_labels,char*buf,intlen){vni_tvn
i1,vni2;vni1=label2vni(label);if(num_labels==2){vni2=label2vni(label+1);snprintf
(buf,len,"%u/%u",vni1,vni2);}elsesnprintf(buf,len,"%u",vni1);returnbuf;}/**Funct
iontoconvertevpnroutetojsonformat.*NOTE:Wedon'tuseprefix2strastheoutputhereisabi
tdifferent.*/voidbgp_evpn_route2json(structprefix_evpn*p,json_object*json){charb
uf1[ETHER_ADDR_STRLEN];charbuf2[PREFIX2STR_BUFFER];if(!json)return;if(p->prefix.
route_type==BGP_EVPN_IMET_ROUTE){json_object_int_add(json,"routeType",p->prefix.
route_type);json_object_int_add(json,"ethTag",0);json_object_int_add(json,"ipLen
",IS_EVPN_PREFIX_IPADDR_V4(p)?IPV4_MAX_BITLEN:IPV6_MAX_BITLEN);json_object_strin
g_add(json,"ip",inet_ntoa(p->prefix.ip.ipaddr_v4));}elseif(p->prefix.route_type=
=BGP_EVPN_MAC_IP_ROUTE){if(IS_EVPN_PREFIX_IPADDR_NONE(p)){json_object_int_add(js
on,"routeType",p->prefix.route_type);json_object_int_add(json,"esi",0);/*TODO:we
don'tsupportesiyet*/json_object_int_add(json,"ethTag",0);json_object_int_add(jso
n,"macLen",8*ETH_ALEN);json_object_string_add(json,"mac",prefix_mac2str(&p->pref
ix.mac,buf1,sizeof(buf1)));}else{uint8_tfamily;family=IS_EVPN_PREFIX_IPADDR_V4(p
)?AF_INET:AF_INET6;json_object_int_add(json,"routeType",p->prefix.route_type);js
on_object_int_add(json,"esi",0);/*TODO:wedon'tsupportesiyet*/json_object_int_add
(json,"ethTag",0);json_object_int_add(json,"macLen",8*ETH_ALEN);json_object_stri
ng_add(json,"mac",prefix_mac2str(&p->prefix.mac,buf1,sizeof(buf1)));json_object_
int_add(json,"ipLen",IS_EVPN_PREFIX_IPADDR_V4(p)?IPV4_MAX_BITLEN:IPV6_MAX_BITLEN
);json_object_string_add(json,"ip",inet_ntop(family,&p->prefix.ip.ip.addr,buf2,P
REFIX2STR_BUFFER));}}else{/*Currently,thisistocatertootherAF_ETHERNETcode.*/}}/*
*Functiontoconvertevpnroutetostring.*NOTE:Wedon'tuseprefix2strastheoutputhereisa
bitdifferent.*/char*bgp_evpn_route2str(structprefix_evpn*p,char*buf,intlen){char
buf1[ETHER_ADDR_STRLEN];charbuf2[PREFIX2STR_BUFFER];if(p->prefix.route_type==BGP
_EVPN_IMET_ROUTE){snprintf(buf,len,"[%d]:[0]:[%d]:[%s]",p->prefix.route_type,IS_
EVPN_PREFIX_IPADDR_V4(p)?IPV4_MAX_BITLEN:IPV6_MAX_BITLEN,inet_ntoa(p->prefix.ip.
ipaddr_v4));}elseif(p->prefix.route_type==BGP_EVPN_MAC_IP_ROUTE){if(IS_EVPN_PREF
IX_IPADDR_NONE(p))snprintf(buf,len,"[%d]:[0]:[0]:[%d]:[%s]",p->prefix.route_type
,8*ETH_ALEN,prefix_mac2str(&p->prefix.mac,buf1,sizeof(buf1)));else{uint8_tfamily
;family=IS_EVPN_PREFIX_IPADDR_V4(p)?AF_INET:AF_INET6;snprintf(buf,len,"[%d]:[0]:
[0]:[%d]:[%s]:[%d]:[%s]",p->prefix.route_type,8*ETH_ALEN,prefix_mac2str(&p->pref
ix.mac,buf1,sizeof(buf1)),family==AF_INET?IPV4_MAX_BITLEN:IPV6_MAX_BITLEN,inet_n
top(family,&p->prefix.ip.ip.addr,buf2,PREFIX2STR_BUFFER));}}elseif(p->prefix.rou
te_type==BGP_EVPN_IP_PREFIX_ROUTE){snprintf(buf,len,"[%d]:[0]:[0]:[%d]:[%s]",p->
prefix.route_type,p->prefix.ip_prefix_length,IS_EVPN_PREFIX_IPADDR_V4(p)?inet_nt
oa(p->prefix.ip.ipaddr_v4):inet6_ntoa(p->prefix.ip.ipaddr_v6));}else{/*ForEVPNro
utetypesnotsupportedyet.*/snprintf(buf,len,"(unsupportedroutetype%d)",p->prefix.
route_type);}return(buf);}/**EncodeEVPNprefixinUpdate(MP_REACH)*/voidbgp_evpn_en
code_prefix(structstream*s,structprefix*p,structprefix_rd*prd,mpls_label_t*label
,uint32_tnum_labels,structattr*attr,intaddpath_encode,uint32_taddpath_tx_id){str
uctprefix_evpn*evp=(structprefix_evpn*)p;intlen,ipa_len=0;if(addpath_encode)stre
am_putl(s,addpath_tx_id);/*Routetype*/stream_putc(s,evp->prefix.route_type);swit
ch(evp->prefix.route_type){caseBGP_EVPN_MAC_IP_ROUTE:if(IS_EVPN_PREFIX_IPADDR_V4
(evp))ipa_len=IPV4_MAX_BYTELEN;elseif(IS_EVPN_PREFIX_IPADDR_V6(evp))ipa_len=IPV6
_MAX_BYTELEN;/*RD,ESI,EthTag,MAC+len,IPlen,[IP],1VNI*/len=8+10+4+1+6+1+ipa_len+3
;if(ipa_len&&num_labels>1)/*Thereare2VNIs*/len+=3;stream_putc(s,len);stream_put(
s,prd->val,8);/*RD*/stream_put(s,0,10);/*ESI*/stream_putl(s,0);/*EthernetTagID*/
stream_putc(s,8*ETH_ALEN);/*MacAddrLen-bits*/stream_put(s,evp->prefix.mac.octet,
6);/*MacAddr*/stream_putc(s,8*ipa_len);/*IPaddressLength*/if(ipa_len)/*IP*/strea
m_put(s,&evp->prefix.ip.ip.addr,ipa_len);/*1stlabelistheL2VNI*/stream_put(s,labe
l,BGP_LABEL_BYTES);/*Include2ndlabel(L3VNI)ifadvertisingMAC+IP*/if(ipa_len&&num_
labels>1)stream_put(s,label+1,BGP_LABEL_BYTES);break;caseBGP_EVPN_IMET_ROUTE:str
eam_putc(s,17);//TODO:length-assumesIPv4addressstream_put(s,prd->val,8);/*RD*/st
ream_putl(s,0);/*EthernetTagID*/stream_putc(s,IPV4_MAX_BITLEN);/*IPaddressLength
-bits*//*OriginatingRouter'sIPAddr*/stream_put_in_addr(s,&evp->prefix.ip.ipaddr_
v4);break;caseBGP_EVPN_IP_PREFIX_ROUTE:/*TODO:AddPathsupport.*/evpn_mpattr_encod
e_type5(s,p,prd,label,num_labels,attr);break;default:break;}}intbgp_nlri_parse_e
vpn(structpeer*peer,structattr*attr,structbgp_nlri*packet,intwithdraw){uint8_t*p
nt;uint8_t*lim;afi_tafi;safi_tsafi;uint32_taddpath_id;intaddpath_encoded;intpsiz
e=0;uint8_trtype;uint8_trlen;structprefixp;/*StartprocessingtheNLRI-theremaybemu
ltipleintheMP_REACH*/pnt=packet->nlri;lim=pnt+packet->length;afi=packet->afi;saf
i=packet->safi;addpath_id=0;addpath_encoded=(CHECK_FLAG(peer->af_cap[afi][safi],
PEER_CAP_ADDPATH_AF_RX_ADV)&&CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH
_AF_TX_RCV));for(;pnt<lim;pnt+=psize){/*Clearprefixstructure.*/memset(&p,0,sizeo
f(structprefix));/*Dealwithpath-idifAddPathissupported.*/if(addpath_encoded){/*W
henpacketoverflowoccursreturnimmediately.*/if(pnt+BGP_ADDPATH_ID_LEN>lim)return-
1;addpath_id=ntohl(*((uint32_t*)pnt));pnt+=BGP_ADDPATH_ID_LEN;}/*AllEVPNNLRItype
sstartwithtypeandlength.*/if(pnt+2>lim)return-1;rtype=*pnt++;psize=rlen=*pnt++;/
*Whenpacketoverflowoccurreturnimmediately.*/if(pnt+psize>lim)return-1;switch(rty
pe){caseBGP_EVPN_MAC_IP_ROUTE:if(process_type2_route(peer,afi,safi,withdraw?NULL
:attr,pnt,psize,addpath_id)){zlog_err("%u:%s-ErrorinprocessingEVPNtype-2NLRIsize
%d",peer->bgp->vrf_id,peer->host,psize);return-1;}break;caseBGP_EVPN_IMET_ROUTE:
if(process_type3_route(peer,afi,safi,withdraw?NULL:attr,pnt,psize,addpath_id)){z
log_err("%u:%s-ErrorinprocessingEVPNtype-3NLRIsize%d",peer->bgp->vrf_id,peer->ho
st,psize);return-1;}break;caseBGP_EVPN_IP_PREFIX_ROUTE:if(process_type5_route(pe
er,afi,safi,attr,pnt,psize,addpath_id,withdraw)){zlog_err("%u:%s-Errorinprocessi
ngEVPNtype-5NLRIsize%d",peer->bgp->vrf_id,peer->host,psize);return-1;}break;defa
ult:break;}}/*Packetlengthconsistencycheck.*/if(pnt!=lim)return-1;return0;}/**Ma
ptheRTs(configuredorautomaticallyderived)ofaVRFtotheVRF.*Themappingwillbeuseddur
ingrouteprocessing.*bgp_def:defaultbgpinstance*bgp_vrf:specificbgpvrfinstanceonw
hichRTisconfigured*/voidbgp_evpn_map_vrf_to_its_rts(structbgp*bgp_vrf){inti=0;st
ructecommunity_val*eval=NULL;structlistnode*node=NULL,*nnode=NULL;structecommuni
ty*ecom=NULL;for(ALL_LIST_ELEMENTS(bgp_vrf->vrf_import_rtl,node,nnode,ecom)){for
(i=0;i<ecom->size;i++){eval=(structecommunity_val*)(ecom->val+(i*ECOMMUNITY_SIZE
));map_vrf_to_rt(bgp_vrf,eval);}}}/**UnmaptheRTs(configuredorautomaticallyderive
d)ofaVRFfromtheVRF.*/voidbgp_evpn_unmap_vrf_from_its_rts(structbgp*bgp_vrf){inti
;structecommunity_val*eval;structlistnode*node,*nnode;structecommunity*ecom;for(
ALL_LIST_ELEMENTS(bgp_vrf->vrf_import_rtl,node,nnode,ecom)){for(i=0;i<ecom->size
;i++){structvrf_irt_node*irt;structecommunity_valeval_tmp;eval=(structecommunity
_val*)(ecom->val+(i*ECOMMUNITY_SIZE));/*Ifusing"automatic"RT,weonlycareaboutthe*
local-adminsub-field.*ThisistofacilitateusingVNIastheRTforEBGP*peeringtoo.*/memc
py(&eval_tmp,eval,ECOMMUNITY_SIZE);if(!CHECK_FLAG(bgp_vrf->vrf_flags,BGP_VRF_IMP
ORT_RT_CFGD))mask_ecom_global_admin(&eval_tmp,eval);irt=lookup_vrf_import_rt(&ev
al_tmp);if(irt)unmap_vrf_from_rt(bgp_vrf,irt);}}}/**MaptheRTs(configuredorautoma
ticallyderived)ofaVNItotheVNI.*Themappingwillbeusedduringrouteprocessing.*/voidb
gp_evpn_map_vni_to_its_rts(structbgp*bgp,structbgpevpn*vpn){inti;structecommunit
y_val*eval;structlistnode*node,*nnode;structecommunity*ecom;for(ALL_LIST_ELEMENT
S(vpn->import_rtl,node,nnode,ecom)){for(i=0;i<ecom->size;i++){eval=(structecommu
nity_val*)(ecom->val+(i*ECOMMUNITY_SIZE));map_vni_to_rt(bgp,vpn,eval);}}}/**Unma
ptheRTs(configuredorautomaticallyderived)ofaVNIfromtheVNI.*/voidbgp_evpn_unmap_v
ni_from_its_rts(structbgp*bgp,structbgpevpn*vpn){inti;structecommunity_val*eval;
structlistnode*node,*nnode;structecommunity*ecom;for(ALL_LIST_ELEMENTS(vpn->impo
rt_rtl,node,nnode,ecom)){for(i=0;i<ecom->size;i++){structirt_node*irt;structecom
munity_valeval_tmp;eval=(structecommunity_val*)(ecom->val+(i*ECOMMUNITY_SIZE));/
*Ifusing"automatic"RT,weonlycareaboutthe*local-adminsub-field.*Thisistofacilitat
eusingVNIastheRTforEBGP*peeringtoo.*/memcpy(&eval_tmp,eval,ECOMMUNITY_SIZE);if(!
is_import_rt_configured(vpn))mask_ecom_global_admin(&eval_tmp,eval);irt=lookup_i
mport_rt(bgp,&eval_tmp);if(irt)unmap_vni_from_rt(bgp,vpn,irt);}}}/**DeriveImport
RTautomaticallyforVNIandmapVNItoRT.*Themappingwillbeusedduringrouteprocessing.*/
voidbgp_evpn_derive_auto_rt_import(structbgp*bgp,structbgpevpn*vpn){form_auto_rt
(bgp,vpn->vni,vpn->import_rtl);UNSET_FLAG(vpn->flags,VNI_FLAG_IMPRT_CFGD);/*MapR
TtoVNI*/bgp_evpn_map_vni_to_its_rts(bgp,vpn);}/**DeriveExportRTautomaticallyforV
NI.*/voidbgp_evpn_derive_auto_rt_export(structbgp*bgp,structbgpevpn*vpn){form_au
to_rt(bgp,vpn->vni,vpn->export_rtl);UNSET_FLAG(vpn->flags,VNI_FLAG_EXPRT_CFGD);}
/**DeriveRDautomaticallyforVNIusingpassedinformation-it*isoftheformRouterId:uniq
ue-id-for-vni.*/voidbgp_evpn_derive_auto_rd_for_vrf(structbgp*bgp){charbuf[100];
bgp->vrf_prd.family=AF_UNSPEC;bgp->vrf_prd.prefixlen=64;sprintf(buf,"%s:%hu",ine
t_ntoa(bgp->router_id),bgp->vrf_rd_id);(void)str2prefix_rd(buf,&bgp->vrf_prd);}/
**DeriveRDautomaticallyforVNIusingpassedinformation-it*isoftheformRouterId:uniqu
e-id-for-vni.*/voidbgp_evpn_derive_auto_rd(structbgp*bgp,structbgpevpn*vpn){char
buf[100];vpn->prd.family=AF_UNSPEC;vpn->prd.prefixlen=64;sprintf(buf,"%s:%hu",in
et_ntoa(bgp->router_id),vpn->rd_id);(void)str2prefix_rd(buf,&vpn->prd);UNSET_FLA
G(vpn->flags,VNI_FLAG_RD_CFGD);}/**LookupVNI.*/structbgpevpn*bgp_evpn_lookup_vni
(structbgp*bgp,vni_tvni){structbgpevpn*vpn;structbgpevpntmp;memset(&tmp,0,sizeof
(structbgpevpn));tmp.vni=vni;vpn=hash_lookup(bgp->vnihash,&tmp);returnvpn;}/**Cr
eateanewvpn-invokeduponconfigurationorzebranotification.*/structbgpevpn*bgp_evpn
_new(structbgp*bgp,vni_tvni,structin_addroriginator_ip,vrf_id_ttenant_vrf_id){st
ructbgpevpn*vpn;if(!bgp)returnNULL;vpn=XCALLOC(MTYPE_BGP_EVPN,sizeof(structbgpev
pn));if(!vpn)returnNULL;/*Setvalues-RDandRTsettodefaults.*/vpn->vni=vni;vpn->ori
ginator_ip=originator_ip;vpn->tenant_vrf_id=tenant_vrf_id;/*Initializeroute-targ
etimportandexportlists*/vpn->import_rtl=list_new();vpn->import_rtl->cmp=(int(*)(
void*,void*))evpn_route_target_cmp;vpn->export_rtl=list_new();vpn->export_rtl->c
mp=(int(*)(void*,void*))evpn_route_target_cmp;bf_assign_index(bm->rd_idspace,vpn
->rd_id);derive_rd_rt_for_vni(bgp,vpn);/*InitializeEVPNroutetable.*/vpn->route_t
able=bgp_table_init(AFI_L2VPN,SAFI_EVPN);/*Addtohash*/if(!hash_get(bgp->vnihash,
vpn,hash_alloc_intern)){XFREE(MTYPE_BGP_EVPN,vpn);returnNULL;}/*addtol2vniliston
correspondingvrf*/bgpevpn_link_to_l3vni(vpn);QOBJ_REG(vpn,bgpevpn);returnvpn;}/*
*FreeagivenVPN-calledinmultiplescenariossuchaszebra*notification,configurationbe
ingdeleted,advertise-all-vnidisabledetc.*Thisjustfreesappropriatememory,callersh
ouldhavetakenother*neededactions.*/voidbgp_evpn_free(structbgp*bgp,structbgpevpn
*vpn){bgpevpn_unlink_from_l3vni(vpn);bgp_table_unlock(vpn->route_table);bgp_evpn
_unmap_vni_from_its_rts(bgp,vpn);list_delete_and_null(&vpn->import_rtl);list_del
ete_and_null(&vpn->export_rtl);bf_release_index(bm->rd_idspace,vpn->rd_id);hash_
release(bgp->vnihash,vpn);QOBJ_UNREG(vpn);XFREE(MTYPE_BGP_EVPN,vpn);}/**Importro
uteintomatchingVNI(s).*/intbgp_evpn_import_route(structbgp*bgp,afi_tafi,safi_tsa
fi,structprefix*p,structbgp_info*ri){returninstall_uninstall_evpn_route(bgp,afi,
safi,p,ri,1);}/**UnimportroutefrommatchingVNI(s).*/intbgp_evpn_unimport_route(st
ructbgp*bgp,afi_tafi,safi_tsafi,structprefix*p,structbgp_info*ri){returninstall_
uninstall_evpn_route(bgp,afi,safi,p,ri,0);}/*filterrouteswhichhavemartiannexthop
s*/intbgp_filter_evpn_routes_upon_martian_nh_change(structbgp*bgp){afi_tafi;safi
_tsafi;structbgp_node*rd_rn,*rn;structbgp_table*table;structbgp_info*ri;afi=AFI_
L2VPN;safi=SAFI_EVPN;/*Walkentireglobalroutingtableandevaluaterouteswhichcouldbe
*importedintothisVPN.Notethatwecannotjustlookattheroutes*fortheVNI'sRD-*remotero
utesapplicableforthisVNIcouldhaveanyRD.*//*EVPNroutesarea2-leveltable.*/for(rd_r
n=bgp_table_top(bgp->rib[afi][safi]);rd_rn;rd_rn=bgp_route_next(rd_rn)){table=(s
tructbgp_table*)(rd_rn->info);if(!table)continue;for(rn=bgp_table_top(table);rn;
rn=bgp_route_next(rn)){for(ri=rn->info;ri;ri=ri->next){/*Consider"valid"remotero
utesapplicablefor*thisVNI.*/if(!(ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_RO
UTE_NORMAL))continue;if(bgp_nexthop_self(bgp,ri->attr->nexthop)){charattr_str[BU
FSIZ];charpbuf[PREFIX_STRLEN];bgp_dump_attr(ri->attr,attr_str,BUFSIZ);if(bgp_deb
ug_update(ri->peer,&rn->p,NULL,1))zlog_debug("%u:prefix%swithattr%s-DENIEDduetom
artianorselfnexthop",bgp->vrf_id,prefix2str(&rn->p,pbuf,sizeof(pbuf)),attr_str);
bgp_evpn_unimport_route(bgp,afi,safi,&rn->p,ri);bgp_rib_remove(rn,ri,ri->peer,af
i,safi);}}}}return0;}/**HandledelofalocalMACIP.*/intbgp_evpn_local_macip_del(str
uctbgp*bgp,vni_tvni,structethaddr*mac,structipaddr*ip){structbgpevpn*vpn;structp
refix_evpnp;if(!bgp->vnihash){zlog_err("%u:VNIhashnotcreated",bgp->vrf_id);retur
n-1;}/*LookupVNIhash-shouldexist.*/vpn=bgp_evpn_lookup_vni(bgp,vni);if(!vpn||!is
_vni_live(vpn)){zlog_warn("%u:VNIhashentryforVNI%u%satMACIPDEL",bgp->vrf_id,vni,
vpn?"notlive":"notfound");return-1;}/*RemoveEVPNtype-2routeandscheduleforprocess
ing.*/build_evpn_type2_prefix(&p,mac,ip);delete_evpn_route(bgp,vpn,&p);return0;}
/**HandleaddofalocalMACIP.*/intbgp_evpn_local_macip_add(structbgp*bgp,vni_tvni,s
tructethaddr*mac,structipaddr*ip,uint8_tflags){structbgpevpn*vpn;structprefix_ev
pnp;if(!bgp->vnihash){zlog_err("%u:VNIhashnotcreated",bgp->vrf_id);return-1;}/*L
ookupVNIhash-shouldexist.*/vpn=bgp_evpn_lookup_vni(bgp,vni);if(!vpn||!is_vni_liv
e(vpn)){zlog_warn("%u:VNIhashentryforVNI%u%satMACIPADD",bgp->vrf_id,vni,vpn?"not
live":"notfound");return-1;}/*CreateEVPNtype-2routeandscheduleforprocessing.*/bu
ild_evpn_type2_prefix(&p,mac,ip);if(update_evpn_route(bgp,vpn,&p,flags)){charbuf
[ETHER_ADDR_STRLEN];charbuf2[INET6_ADDRSTRLEN];zlog_err("%u:FailedtocreateType-2
route,VNI%u%sMAC%sIP%s(flags:0x%x)",bgp->vrf_id,vpn->vni,CHECK_FLAG(flags,ZEBRA_
MACIP_TYPE_STICKY)?"stickygateway":"",prefix_mac2str(mac,buf,sizeof(buf)),ipaddr
2str(ip,buf2,sizeof(buf2)),flags);return-1;}return0;}staticvoidlink_l2vni_hash_t
o_l3vni(structhash_backet*backet,structbgp*bgp_vrf){structbgpevpn*vpn=NULL;struc
tbgp*bgp_def=NULL;bgp_def=bgp_get_default();assert(bgp_def);vpn=(structbgpevpn*)
backet->data;if(vpn->tenant_vrf_id==bgp_vrf->vrf_id)bgpevpn_link_to_l3vni(vpn);}
intbgp_evpn_local_l3vni_add(vni_tl3vni,vrf_id_tvrf_id,structethaddr*rmac,structi
n_addroriginator_ip,intfilter){structbgp*bgp_vrf=NULL;/*bgpVRFinstance*/structbg
p*bgp_def=NULL;/*defaultbgpinstance*/structlistnode*node=NULL;structbgpevpn*vpn=
NULL;as_tas=0;/*getthedefaultinstamce-requiredtogettheASnumberforVRF*auto-creati
o*/bgp_def=bgp_get_default();if(!bgp_def){zlog_err("CannotprocessL3VNI%uADD-defa
ultBGPinstancenotyetcreated",l3vni);return-1;}as=bgp_def->as;/*iftheBGPvrfinstan
cedoesntexist-createone*/bgp_vrf=bgp_lookup_by_name(vrf_id_to_name(vrf_id));if(!
bgp_vrf){intret=0;ret=bgp_get(&bgp_vrf,&as,vrf_id_to_name(vrf_id),BGP_INSTANCE_T
YPE_VRF);switch(ret){caseBGP_ERR_MULTIPLE_INSTANCE_NOT_SET:zlog_err("'bgpmultipl
e-instance'notpresent\n");return-1;caseBGP_ERR_AS_MISMATCH:zlog_err("BGPisalread
yrunning;ASis%u\n",as);return-1;caseBGP_ERR_INSTANCE_MISMATCH:zlog_err("BGPinsta
ncenameandASnumbermismatch\n");return-1;}/*markasautocreated*/SET_FLAG(bgp_vrf->
vrf_flags,BGP_VRF_AUTO);}/*associatewithl3vni*/bgp_vrf->l3vni=l3vni;/*settherout
ermac-tobeusedinmac-iproutesforthisvrf*/memcpy(&bgp_vrf->rmac,rmac,sizeof(struct
ethaddr));/*settheoriginatorip*/bgp_vrf->originator_ip=originator_ip;/*settherig
htfilter-areweusingl3vnionlyforprefixroutes?*/if(filter)SET_FLAG(bgp_vrf->vrf_fl
ags,BGP_VRF_L3VNI_PREFIX_ROUTES_ONLY);/*autoderiveRD/RT*/if(!CHECK_FLAG(bgp_vrf-
>vrf_flags,BGP_VRF_IMPORT_RT_CFGD))evpn_auto_rt_import_add_for_vrf(bgp_vrf);if(!
CHECK_FLAG(bgp_vrf->vrf_flags,BGP_VRF_EXPORT_RT_CFGD))evpn_auto_rt_export_add_fo
r_vrf(bgp_vrf);bgp_evpn_derive_auto_rd_for_vrf(bgp_vrf);/*linkallcorrespondingl2
vnis*/hash_iterate(bgp_def->vnihash,(void(*)(structhash_backet*,void*))link_l2vn
i_hash_to_l3vni,bgp_vrf);/*Onlyupdateallcorrespondingtype-2routesifweareadvertis
ingtwo*labelsalongwithtype-2routes*/if(!filter)for(ALL_LIST_ELEMENTS_RO(bgp_vrf-
>l2vnis,node,vpn))update_routes_for_vni(bgp_def,vpn);/*advertisetype-5routesifne
eded*/update_advertise_vrf_routes(bgp_vrf);/*installallremoteroutesbelongingtoth
isl3vniintocorrespondng*vrf*/install_routes_for_vrf(bgp_vrf);return0;}intbgp_evp
n_local_l3vni_del(vni_tl3vni,vrf_id_tvrf_id){structbgp*bgp_vrf=NULL;/*bgpvrfinst
ance*/structbgp*bgp_def=NULL;/*defaultbgpinstance*/structlistnode*node=NULL;stru
ctbgpevpn*vpn=NULL;bgp_vrf=bgp_lookup_by_vrf_id(vrf_id);if(!bgp_vrf){zlog_err("C
annotprocessL3VNI%uDel-CouldnotfindBGPinstance",l3vni);return-1;}bgp_def=bgp_get
_default();if(!bgp_def){zlog_err("CannotprocessL3VNI%uDel-CouldnotfinddefaultBGP
instance",l3vni);return-1;}/*unimportremoteroutesfromVRF,ifitisAUTOvrfbgp_delete
will*takecareofuninstallingtheroutesfromzebra*/if(!CHECK_FLAG(bgp_vrf->vrf_flags
,BGP_VRF_AUTO))uninstall_routes_for_vrf(bgp_vrf);/*delete/withdrawalltype-5route
s*/delete_withdraw_vrf_routes(bgp_vrf);/*removethel3vnifromvrfinstance*/bgp_vrf-
>l3vni=0;/*removetheRmacfromtheBGPvrf*/memset(&bgp_vrf->rmac,0,sizeof(structetha
ddr));/*deleteRD/RT*/if(bgp_vrf->vrf_import_rtl&&!list_isempty(bgp_vrf->vrf_impo
rt_rtl)){bgp_evpn_unmap_vrf_from_its_rts(bgp_vrf);list_delete_all_node(bgp_vrf->
vrf_import_rtl);}if(bgp_vrf->vrf_export_rtl&&!list_isempty(bgp_vrf->vrf_export_r
tl)){list_delete_all_node(bgp_vrf->vrf_export_rtl);}/*updateallcorrespondingloca
lmac-iproutes*/if(!CHECK_FLAG(bgp_vrf->vrf_flags,BGP_VRF_L3VNI_PREFIX_ROUTES_ONL
Y)){for(ALL_LIST_ELEMENTS_RO(bgp_vrf->l2vnis,node,vpn)){UNSET_FLAG(vpn->flags,VN
I_FLAG_USE_TWO_LABELS);update_routes_for_vni(bgp_def,vpn);}}/*Deletetheinstancei
fitwasautocreated*/if(CHECK_FLAG(bgp_vrf->vrf_flags,BGP_VRF_AUTO))bgp_delete(bgp
_vrf);return0;}/**HandledelofalocalVNI.*/intbgp_evpn_local_vni_del(structbgp*bgp
,vni_tvni){structbgpevpn*vpn;if(!bgp->vnihash){zlog_err("%u:VNIhashnotcreated",b
gp->vrf_id);return-1;}/*LocateVNIhash*/vpn=bgp_evpn_lookup_vni(bgp,vni);if(!vpn)
{zlog_warn("%u:VNIhashentryforVNI%unotfoundatDEL",bgp->vrf_id,vni);return0;}/*Re
movealllocalEVPNroutesandscheduleforprocessing(to*withdrawfrompeers).*/delete_ro
utes_for_vni(bgp,vpn);/**tunnelisnolongeractive,deltunnelipaddressfromtip_hash*/
bgp_tip_del(bgp,&vpn->originator_ip);/*Clear"live"flagandseeifhashneedstobefreed
.*/UNSET_FLAG(vpn->flags,VNI_FLAG_LIVE);if(!is_vni_configured(vpn))bgp_evpn_free
(bgp,vpn);return0;}/**Handleadd(orupdate)ofalocalVNI.TheVNIchangeswecare*aboutar
eforthelocal-tunnel-ipandthe(tenant)VRF.*/intbgp_evpn_local_vni_add(structbgp*bg
p,vni_tvni,structin_addroriginator_ip,vrf_id_ttenant_vrf_id){structbgpevpn*vpn;s
tructprefix_evpnp;if(!bgp->vnihash){zlog_err("%u:VNIhashnotcreated",bgp->vrf_id)
;return-1;}/*LookupVNI.Ifpresentandnochange,exit.*/vpn=bgp_evpn_lookup_vni(bgp,v
ni);if(vpn){if(is_vni_live(vpn)&&IPV4_ADDR_SAME(&vpn->originator_ip,&originator_
ip)&&vpn->tenant_vrf_id==tenant_vrf_id)/*Probablysomeotherparamhaschangedthatwed
on't*careabout.*/return0;/*Updatetenant_vrf_idifithaschanged.*/if(vpn->tenant_vr
f_id!=tenant_vrf_id){bgpevpn_unlink_from_l3vni(vpn);vpn->tenant_vrf_id=tenant_vr
f_id;bgpevpn_link_to_l3vni(vpn);}/*IftunnelendpointIPhaschanged,update(anddelete
prior*type-3route,ifneeded.)*/if(!IPV4_ADDR_SAME(&vpn->originator_ip,&originator
_ip))handle_tunnel_ip_change(bgp,vpn,originator_ip);/*Updateallrouteswithnewendp
ointIPand/orexportRT*forVRFs*/if(is_vni_live(vpn))update_routes_for_vni(bgp,vpn)
;}/*Createorupdateasappropriate.*/if(!vpn){vpn=bgp_evpn_new(bgp,vni,originator_i
p,tenant_vrf_id);if(!vpn){zlog_err("%u:FailedtoallocateVNIentryforVNI%u-atAdd",b
gp->vrf_id,vni);return-1;}}/*iftheVNIislivealready,thereisnothingmoretodo*/if(is
_vni_live(vpn))return0;/*Markas"live"*/SET_FLAG(vpn->flags,VNI_FLAG_LIVE);/*tunn
elisnowactive,addtunnel-iptodb*/bgp_tip_add(bgp,&originator_ip);/*filterroutesas
nexthopdatabasehaschanged*/bgp_filter_evpn_routes_upon_martian_nh_change(bgp);/*
CreateEVPNtype-3routeandscheduleforprocessing.*/build_evpn_type3_prefix(&p,vpn->
originator_ip);if(update_evpn_route(bgp,vpn,&p,0)){zlog_err("%u:Type3routecreati
onfailureforVNI%u",bgp->vrf_id,vni);return-1;}/*Ifwehavelearntandretainedremoter
outes(VTEPs,MACs)forthis*VNI,*installthem.*/install_routes_for_vni(bgp,vpn);/*If
weareadvertisinggatewaymac-ipItneedstobeconveyedagaintozebra*/bgp_zebra_advertis
e_gw_macip(bgp,vpn->advertise_gw_macip,vpn->vni);return0;}/**CleanupEVPNinformat
ionondisable-Needtodeleteandwithdraw*EVPNroutesfrompeers.*/voidbgp_evpn_cleanup_
on_disable(structbgp*bgp){hash_iterate(bgp->vnihash,(void(*)(structhash_backet*,
void*))cleanup_vni_on_disable,bgp);}/**CleanupEVPNinformation-invokedatthetimeof
bgpdexitorwhenthe*BGPinstance(default)isbeingfreed.*/voidbgp_evpn_cleanup(struct
bgp*bgp){if(bgp->vnihash)hash_iterate(bgp->vnihash,(void(*)(structhash_backet*,v
oid*))free_vni_entry,bgp);if(bgp->import_rt_hash)hash_free(bgp->import_rt_hash);
bgp->import_rt_hash=NULL;if(bgp->vrf_import_rt_hash)hash_free(bgp->vrf_import_rt
_hash);bgp->vrf_import_rt_hash=NULL;if(bgp->vnihash)hash_free(bgp->vnihash);bgp-
>vnihash=NULL;if(bgp->vrf_import_rtl)list_delete_and_null(&bgp->vrf_import_rtl);
if(bgp->vrf_export_rtl)list_delete_and_null(&bgp->vrf_export_rtl);if(bgp->l2vnis
)list_delete_and_null(&bgp->l2vnis);bf_release_index(bm->rd_idspace,bgp->vrf_rd_
id);}/**InitializationforEVPN*Create*VNIhashtable*hashforRTtoVNI*assignauniquerd
idforautoderivationofvrf_prd*/voidbgp_evpn_init(structbgp*bgp){bgp->vnihash=hash
_create(vni_hash_key_make,vni_hash_cmp,"BGPVNIHash");bgp->import_rt_hash=hash_cr
eate(import_rt_hash_key_make,import_rt_hash_cmp,"BGPImportRTHash");bgp->vrf_impo
rt_rt_hash=hash_create(vrf_import_rt_hash_key_make,vrf_import_rt_hash_cmp,"BGPVR
FImportRTHash");bgp->vrf_import_rtl=list_new();bgp->vrf_import_rtl->cmp=(int(*)(
void*,void*))evpn_route_target_cmp;bgp->vrf_export_rtl=list_new();bgp->vrf_expor
t_rtl->cmp=(int(*)(void*,void*))evpn_route_target_cmp;bgp->l2vnis=list_new();bgp
->l2vnis->cmp=(int(*)(void*,void*))vni_hash_cmp;bf_assign_index(bm->rd_idspace,b
gp->vrf_rd_id);}voidbgp_evpn_vrf_delete(structbgp*bgp_vrf){bgp_evpn_unmap_vrf_fr
om_its_rts(bgp_vrf);}