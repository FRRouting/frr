/*BGProutinginformation*Copyright(C)1996,97,98,99KunihiroIshiguro*Copyright(C)20
16JobSnijders<job@instituut.net>**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include<math.h>#include"prefix.h"#include"linklist.h"#include"memory
.h"#include"command.h"#include"stream.h"#include"filter.h"#include"log.h"#includ
e"routemap.h"#include"buffer.h"#include"sockunion.h"#include"plist.h"#include"th
read.h"#include"workqueue.h"#include"queue.h"#include"memory.h"#include"lib/json
.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_table.h"#include"bgpd/bgp_route.h"#inc
lude"bgpd/bgp_attr.h"#include"bgpd/bgp_debug.h"#include"bgpd/bgp_aspath.h"#inclu
de"bgpd/bgp_regex.h"#include"bgpd/bgp_community.h"#include"bgpd/bgp_ecommunity.h
"#include"bgpd/bgp_lcommunity.h"#include"bgpd/bgp_clist.h"#include"bgpd/bgp_pack
et.h"#include"bgpd/bgp_filter.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_mplsvp
n.h"#include"bgpd/bgp_nexthop.h"#include"bgpd/bgp_damp.h"#include"bgpd/bgp_adver
tise.h"#include"bgpd/bgp_zebra.h"#include"bgpd/bgp_vty.h"#include"bgpd/bgp_mpath
.h"#include"bgpd/bgp_nht.h"#include"bgpd/bgp_updgrp.h"#include"bgpd/bgp_label.h"
#ifENABLE_BGP_VNC#include"bgpd/rfapi/rfapi_backend.h"#include"bgpd/rfapi/vnc_imp
ort_bgp.h"#include"bgpd/rfapi/vnc_export_bgp.h"#endif#include"bgpd/bgp_encap_typ
es.h"#include"bgpd/bgp_encap_tlv.h"#include"bgpd/bgp_evpn.h"#include"bgpd/bgp_ev
pn_vty.h"#include"bgpd/bgp_flowspec.h"#include"bgpd/bgp_flowspec_util.h"#ifndefV
TYSH_EXTRACT_PL#include"bgpd/bgp_route_clippy.c"#endif/*Externfrombgp_dump.c*/ex
ternconstchar*bgp_origin_str[];externconstchar*bgp_origin_long_str[];/*PMSIstrin
gs.*/#definePMSI_TNLTYPE_STR_NO_INFO"Noinfo"#definePMSI_TNLTYPE_STR_DEFAULTPMSI_
TNLTYPE_STR_NO_INFOstaticconststructmessagebgp_pmsi_tnltype_str[]={{PMSI_TNLTYPE
_NO_INFO,PMSI_TNLTYPE_STR_NO_INFO},{PMSI_TNLTYPE_RSVP_TE_P2MP,"RSVP-TEP2MP"},{PM
SI_TNLTYPE_MLDP_P2MP,"mLDPP2MP"},{PMSI_TNLTYPE_PIM_SSM,"PIM-SSM"},{PMSI_TNLTYPE_
PIM_SM,"PIM-SM"},{PMSI_TNLTYPE_PIM_BIDIR,"PIM-BIDIR"},{PMSI_TNLTYPE_INGR_REPL,"I
ngressReplication"},{PMSI_TNLTYPE_MLDP_MP2MP,"mLDPMP2MP"},{0}};structbgp_node*bg
p_afi_node_get(structbgp_table*table,afi_tafi,safi_tsafi,structprefix*p,structpr
efix_rd*prd){structbgp_node*rn;structbgp_node*prn=NULL;assert(table);if(!table)r
eturnNULL;if((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)){prn=b
gp_node_get(table,(structprefix*)prd);if(prn->info==NULL)prn->info=bgp_table_ini
t(afi,safi);elsebgp_unlock_node(prn);table=prn->info;}rn=bgp_node_get(table,p);i
f((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN))rn->prn=prn;retur
nrn;}structbgp_node*bgp_afi_node_lookup(structbgp_table*table,afi_tafi,safi_tsaf
i,structprefix*p,structprefix_rd*prd){structbgp_node*rn;structbgp_node*prn=NULL;
if(!table)returnNULL;if((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_E
VPN)){prn=bgp_node_lookup(table,(structprefix*)prd);if(!prn)returnNULL;if(prn->i
nfo==NULL){bgp_unlock_node(prn);returnNULL;}table=prn->info;}rn=bgp_node_lookup(
table,p);returnrn;}/*Allocatebgp_info_extra*/staticstructbgp_info_extra*bgp_info
_extra_new(void){structbgp_info_extra*new;new=XCALLOC(MTYPE_BGP_ROUTE_EXTRA,size
of(structbgp_info_extra));new->label[0]=MPLS_INVALID_LABEL;new->num_labels=0;ret
urnnew;}staticvoidbgp_info_extra_free(structbgp_info_extra**extra){if(extra&&*ex
tra){if((*extra)->damp_info)bgp_damp_info_free((*extra)->damp_info,0);(*extra)->
damp_info=NULL;XFREE(MTYPE_BGP_ROUTE_EXTRA,*extra);*extra=NULL;}}/*Getbgp_infoex
trainformationforthegivenbgp_info,lazyallocated*ifrequired.*/structbgp_info_extr
a*bgp_info_extra_get(structbgp_info*ri){if(!ri->extra)ri->extra=bgp_info_extra_n
ew();returnri->extra;}/*Allocatenewbgpinfostructure.*/structbgp_info*bgp_info_ne
w(void){returnXCALLOC(MTYPE_BGP_ROUTE,sizeof(structbgp_info));}/*Freebgprouteinf
ormation.*/staticvoidbgp_info_free(structbgp_info*binfo){if(binfo->attr)bgp_attr
_unintern(&binfo->attr);bgp_unlink_nexthop(binfo);bgp_info_extra_free(&binfo->ex
tra);bgp_info_mpath_free(&binfo->mpath);peer_unlock(binfo->peer);/*bgp_infopeerr
eference*/XFREE(MTYPE_BGP_ROUTE,binfo);}structbgp_info*bgp_info_lock(structbgp_i
nfo*binfo){binfo->lock++;returnbinfo;}structbgp_info*bgp_info_unlock(structbgp_i
nfo*binfo){assert(binfo&&binfo->lock>0);binfo->lock--;if(binfo->lock==0){#if0zlo
g_debug("%s:unlockedandfreeing",__func__);zlog_backtrace(LOG_DEBUG);#endifbgp_in
fo_free(binfo);returnNULL;}#if0if(binfo->lock==1){zlog_debug("%s:unlockedto1",__
func__);zlog_backtrace(LOG_DEBUG);}#endifreturnbinfo;}voidbgp_info_add(structbgp
_node*rn,structbgp_info*ri){structbgp_info*top;top=rn->info;ri->next=rn->info;ri
->prev=NULL;if(top)top->prev=ri;rn->info=ri;bgp_info_lock(ri);bgp_lock_node(rn);
peer_lock(ri->peer);/*bgp_infopeerreference*/}/*DotheactualremovalofinfofromRIB,
forusebybgp_processcompletioncallback*only**/voidbgp_info_reap(structbgp_node*rn
,structbgp_info*ri){if(ri->next)ri->next->prev=ri->prev;if(ri->prev)ri->prev->ne
xt=ri->next;elsern->info=ri->next;bgp_info_mpath_dequeue(ri);bgp_info_unlock(ri)
;bgp_unlock_node(rn);}voidbgp_info_delete(structbgp_node*rn,structbgp_info*ri){b
gp_info_set_flag(rn,ri,BGP_INFO_REMOVED);/*setofpreviousalreadytookcareofpcount*
/UNSET_FLAG(ri->flags,BGP_INFO_VALID);}/*undotheeffectsofapreviouscalltobgp_info
_delete;typicallycalledwhenarouteisdeletedandthenquicklyre-addedbeforethedeletio
nhasbeenprocessed*/voidbgp_info_restore(structbgp_node*rn,structbgp_info*ri){bgp
_info_unset_flag(rn,ri,BGP_INFO_REMOVED);/*unsetofpreviousalreadytookcareofpcoun
t*/SET_FLAG(ri->flags,BGP_INFO_VALID);}/*Adjustpcountasrequired*/staticvoidbgp_p
count_adjust(structbgp_node*rn,structbgp_info*ri){structbgp_table*table;assert(r
n&&bgp_node_table(rn));assert(ri&&ri->peer&&ri->peer->bgp);table=bgp_node_table(
rn);if(ri->peer==ri->peer->bgp->peer_self)return;if(!BGP_INFO_COUNTABLE(ri)&&CHE
CK_FLAG(ri->flags,BGP_INFO_COUNTED)){UNSET_FLAG(ri->flags,BGP_INFO_COUNTED);/*sl
ighthack,butmorerobustagainsterrors.*/if(ri->peer->pcount[table->afi][table->saf
i])ri->peer->pcount[table->afi][table->safi]--;else{zlog_warn("%s:Askedtodecreme
nt0prefixcountforpeer%s",__func__,ri->peer->host);zlog_backtrace(LOG_WARNING);zl
og_warn("%s:PleasereporttoQuaggabugzilla",__func__);}}elseif(BGP_INFO_COUNTABLE(
ri)&&!CHECK_FLAG(ri->flags,BGP_INFO_COUNTED)){SET_FLAG(ri->flags,BGP_INFO_COUNTE
D);ri->peer->pcount[table->afi][table->safi]++;}}staticintbgp_label_index_differ
s(structbgp_info*ri1,structbgp_info*ri2){return(!(ri1->attr->label_index==ri2->a
ttr->label_index));}/*Set/unsetbgp_infoflags,adjustinganyotherstateasneeded.*Thi
sishereprimarilytokeepprefix-countincheck.*/voidbgp_info_set_flag(structbgp_node
*rn,structbgp_info*ri,uint32_tflag){SET_FLAG(ri->flags,flag);/*earlybathifweknow
it'snotaflagthatchangescountabilitystate*/if(!CHECK_FLAG(flag,BGP_INFO_VALID|BGP
_INFO_HISTORY|BGP_INFO_REMOVED))return;bgp_pcount_adjust(rn,ri);}voidbgp_info_un
set_flag(structbgp_node*rn,structbgp_info*ri,uint32_tflag){UNSET_FLAG(ri->flags,
flag);/*earlybathifweknowit'snotaflagthatchangescountabilitystate*/if(!CHECK_FLA
G(flag,BGP_INFO_VALID|BGP_INFO_HISTORY|BGP_INFO_REMOVED))return;bgp_pcount_adjus
t(rn,ri);}/*GetMEDvalue.IfMEDvalueismissingand"bgpbestpathmissing-as-worst"isspe
cified,treatitastheworstvalue.*/staticuint32_tbgp_med_value(structattr*attr,stru
ctbgp*bgp){if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC))returnattr->med
;else{if(bgp_flag_check(bgp,BGP_FLAG_MED_MISSING_AS_WORST))returnBGP_MED_MAX;els
ereturn0;}}voidbgp_info_path_with_addpath_rx_str(structbgp_info*ri,char*buf){if(
ri->addpath_rx_id)sprintf(buf,"path%s(addpathrxid%d)",ri->peer->host,ri->addpath
_rx_id);elsesprintf(buf,"path%s",ri->peer->host);}/*Comparetwobgprouteentity.If'
new'ispreferableover'exist'return1.*/staticintbgp_info_cmp(structbgp*bgp,structb
gp_info*new,structbgp_info*exist,int*paths_eq,structbgp_maxpaths_cfg*mpath_cfg,i
ntdebug,char*pfx_buf,afi_tafi,safi_tsafi){structattr*newattr,*existattr;bgp_peer
_sort_tnew_sort;bgp_peer_sort_texist_sort;uint32_tnew_pref;uint32_texist_pref;ui
nt32_tnew_med;uint32_texist_med;uint32_tnew_weight;uint32_texist_weight;uint32_t
newm,existm;structin_addrnew_id;structin_addrexist_id;intnew_cluster;intexist_cl
uster;intinternal_as_route;intconfed_as_route;intret=0;charnew_buf[PATH_ADDPATH_
STR_BUFFER];charexist_buf[PATH_ADDPATH_STR_BUFFER];uint32_tnew_mm_seq;uint32_tex
ist_mm_seq;*paths_eq=0;/*0.Nullcheck.*/if(new==NULL){if(debug)zlog_debug("%s:new
isNULL",pfx_buf);return0;}if(debug)bgp_info_path_with_addpath_rx_str(new,new_buf
);if(exist==NULL){if(debug)zlog_debug("%s:%sistheinitialbestpath",pfx_buf,new_bu
f);return1;}if(debug){bgp_info_path_with_addpath_rx_str(exist,exist_buf);zlog_de
bug("%s:Comparing%sflags0x%xwith%sflags0x%x",pfx_buf,new_buf,new->flags,exist_bu
f,exist->flags);}newattr=new->attr;existattr=exist->attr;/*ForEVPNroutes,wecanno
tjustgobylocalvsremote,wehaveto*lookattheMACmobilitysequencenumber,ifpresent.*/i
f(safi==SAFI_EVPN){/*ThisisanerrorconditiondescribedinRFC7432Section*15.2.TheRFC
*statesthatinthisscenario"thePEMUSTalerttheoperator"*butit*doesnotstatewhatother
actiontotake.Inordertoprovide*some*consistencyinthisscenariowearegoingtopreferth
epath*withthe*stickyflag.*/if(newattr->sticky!=existattr->sticky){if(!debug){pre
fix2str(&new->net->p,pfx_buf,sizeof(*pfx_buf)*PREFIX2STR_BUFFER);bgp_info_path_w
ith_addpath_rx_str(new,new_buf);bgp_info_path_with_addpath_rx_str(exist,exist_bu
f);}if(newattr->sticky&&!existattr->sticky){zlog_warn("%s:%swinsover%sduetostick
yMACflag",pfx_buf,new_buf,exist_buf);return1;}if(!newattr->sticky&&existattr->st
icky){zlog_warn("%s:%slosesto%sduetostickyMACflag",pfx_buf,new_buf,exist_buf);re
turn0;}}new_mm_seq=mac_mobility_seqnum(newattr);exist_mm_seq=mac_mobility_seqnum
(existattr);if(new_mm_seq>exist_mm_seq){if(debug)zlog_debug("%s:%swinsover%sduet
oMMseq%u>%u",pfx_buf,new_buf,exist_buf,new_mm_seq,exist_mm_seq);return1;}if(new_
mm_seq<exist_mm_seq){if(debug)zlog_debug("%s:%slosesto%sduetoMMseq%u<%u",pfx_buf
,new_buf,exist_buf,new_mm_seq,exist_mm_seq);return0;}}/*1.Weightcheck.*/new_weig
ht=newattr->weight;exist_weight=existattr->weight;if(new_weight>exist_weight){if
(debug)zlog_debug("%s:%swinsover%sduetoweight%d>%d",pfx_buf,new_buf,exist_buf,ne
w_weight,exist_weight);return1;}if(new_weight<exist_weight){if(debug)zlog_debug(
"%s:%slosesto%sduetoweight%d<%d",pfx_buf,new_buf,exist_buf,new_weight,exist_weig
ht);return0;}/*2.Localpreferencecheck.*/new_pref=exist_pref=bgp->default_local_p
ref;if(newattr->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF))new_pref=newattr->local_
pref;if(existattr->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF))exist_pref=existattr-
>local_pref;if(new_pref>exist_pref){if(debug)zlog_debug("%s:%swinsover%sduetoloc
alpref%d>%d",pfx_buf,new_buf,exist_buf,new_pref,exist_pref);return1;}if(new_pref
<exist_pref){if(debug)zlog_debug("%s:%slosesto%sduetolocalpref%d<%d",pfx_buf,new
_buf,exist_buf,new_pref,exist_pref);return0;}/*3.Localroutecheck.Weprefer:*-BGP_
ROUTE_STATIC*-BGP_ROUTE_AGGREGATE*-BGP_ROUTE_REDISTRIBUTE*/if(!(new->sub_type==B
GP_ROUTE_NORMAL||new->sub_type==BGP_ROUTE_IMPORTED)){if(debug)zlog_debug("%s:%sw
insover%sduetopreferredBGP_ROUTEtype",pfx_buf,new_buf,exist_buf);return1;}if(!(e
xist->sub_type==BGP_ROUTE_NORMAL||new->sub_type==BGP_ROUTE_IMPORTED)){if(debug)z
log_debug("%s:%slosesto%sduetopreferredBGP_ROUTEtype",pfx_buf,new_buf,exist_buf)
;return0;}/*4.ASpathlengthcheck.*/if(!bgp_flag_check(bgp,BGP_FLAG_ASPATH_IGNORE)
){intexist_hops=aspath_count_hops(existattr->aspath);intexist_confeds=aspath_cou
nt_confeds(existattr->aspath);if(bgp_flag_check(bgp,BGP_FLAG_ASPATH_CONFED)){int
aspath_hops;aspath_hops=aspath_count_hops(newattr->aspath);aspath_hops+=aspath_c
ount_confeds(newattr->aspath);if(aspath_hops<(exist_hops+exist_confeds)){if(debu
g)zlog_debug("%s:%swinsover%sduetoaspath(withconfeds)hopcount%d<%d",pfx_buf,new_
buf,exist_buf,aspath_hops,(exist_hops+exist_confeds));return1;}if(aspath_hops>(e
xist_hops+exist_confeds)){if(debug)zlog_debug("%s:%slosesto%sduetoaspath(withcon
feds)hopcount%d>%d",pfx_buf,new_buf,exist_buf,aspath_hops,(exist_hops+exist_conf
eds));return0;}}else{intnewhops=aspath_count_hops(newattr->aspath);if(newhops<ex
ist_hops){if(debug)zlog_debug("%s:%swinsover%sduetoaspathhopcount%d<%d",pfx_buf,
new_buf,exist_buf,newhops,exist_hops);return1;}if(newhops>exist_hops){if(debug)z
log_debug("%s:%slosesto%sduetoaspathhopcount%d>%d",pfx_buf,new_buf,exist_buf,new
hops,exist_hops);return0;}}}/*5.Origincheck.*/if(newattr->origin<existattr->orig
in){if(debug)zlog_debug("%s:%swinsover%sduetoORIGIN%s<%s",pfx_buf,new_buf,exist_
buf,bgp_origin_long_str[newattr->origin],bgp_origin_long_str[existattr->origin])
;return1;}if(newattr->origin>existattr->origin){if(debug)zlog_debug("%s:%slosest
o%sduetoORIGIN%s>%s",pfx_buf,new_buf,exist_buf,bgp_origin_long_str[newattr->orig
in],bgp_origin_long_str[existattr->origin]);return0;}/*6.MEDcheck.*/internal_as_
route=(aspath_count_hops(newattr->aspath)==0&&aspath_count_hops(existattr->aspat
h)==0);confed_as_route=(aspath_count_confeds(newattr->aspath)>0&&aspath_count_co
nfeds(existattr->aspath)>0&&aspath_count_hops(newattr->aspath)==0&&aspath_count_
hops(existattr->aspath)==0);if(bgp_flag_check(bgp,BGP_FLAG_ALWAYS_COMPARE_MED)||
(bgp_flag_check(bgp,BGP_FLAG_MED_CONFED)&&confed_as_route)||aspath_cmp_left(newa
ttr->aspath,existattr->aspath)||aspath_cmp_left_confed(newattr->aspath,existattr
->aspath)||internal_as_route){new_med=bgp_med_value(new->attr,bgp);exist_med=bgp
_med_value(exist->attr,bgp);if(new_med<exist_med){if(debug)zlog_debug("%s:%swins
over%sduetoMED%d<%d",pfx_buf,new_buf,exist_buf,new_med,exist_med);return1;}if(ne
w_med>exist_med){if(debug)zlog_debug("%s:%slosesto%sduetoMED%d>%d",pfx_buf,new_b
uf,exist_buf,new_med,exist_med);return0;}}/*7.Peertypecheck.*/new_sort=new->peer
->sort;exist_sort=exist->peer->sort;if(new_sort==BGP_PEER_EBGP&&(exist_sort==BGP
_PEER_IBGP||exist_sort==BGP_PEER_CONFED)){if(debug)zlog_debug("%s:%swinsover%sdu
etoeBGPpeer>iBGPpeer",pfx_buf,new_buf,exist_buf);return1;}if(exist_sort==BGP_PEE
R_EBGP&&(new_sort==BGP_PEER_IBGP||new_sort==BGP_PEER_CONFED)){if(debug)zlog_debu
g("%s:%slosesto%sduetoiBGPpeer<eBGPpeer",pfx_buf,new_buf,exist_buf);return0;}/*8
.IGPmetriccheck.*/newm=existm=0;if(new->extra)newm=new->extra->igpmetric;if(exis
t->extra)existm=exist->extra->igpmetric;if(newm<existm){if(debug)zlog_debug("%s:
%swinsover%sduetoIGPmetric%d<%d",pfx_buf,new_buf,exist_buf,newm,existm);ret=1;}i
f(newm>existm){if(debug)zlog_debug("%s:%slosesto%sduetoIGPmetric%d>%d",pfx_buf,n
ew_buf,exist_buf,newm,existm);ret=0;}/*9.SameIGPmetric.Comparetheclusterlistleng
thasrepresentativeofIGPhopsmetric.Rewritethemetricvaluepair(newm,existm)withthec
lusterlistlength.Preferthepathwithsmallerclusterlistlength.*/if(newm==existm){if
(peer_sort(new->peer)==BGP_PEER_IBGP&&peer_sort(exist->peer)==BGP_PEER_IBGP&&(mp
ath_cfg==NULL||CHECK_FLAG(mpath_cfg->ibgp_flags,BGP_FLAG_IBGP_MULTIPATH_SAME_CLU
STERLEN))){newm=BGP_CLUSTER_LIST_LENGTH(new->attr);existm=BGP_CLUSTER_LIST_LENGT
H(exist->attr);if(newm<existm){if(debug)zlog_debug("%s:%swinsover%sduetoCLUSTER_
LISTlength%d<%d",pfx_buf,new_buf,exist_buf,newm,existm);ret=1;}if(newm>existm){i
f(debug)zlog_debug("%s:%slosesto%sduetoCLUSTER_LISTlength%d>%d",pfx_buf,new_buf,
exist_buf,newm,existm);ret=0;}}}/*10.confed-externalvs.confed-internal*/if(CHECK
_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION)){if(new_sort==BGP_PEER_CONFED&&exist
_sort==BGP_PEER_IBGP){if(debug)zlog_debug("%s:%swinsover%sduetoconfed-externalpe
er>confed-internalpeer",pfx_buf,new_buf,exist_buf);return1;}if(exist_sort==BGP_P
EER_CONFED&&new_sort==BGP_PEER_IBGP){if(debug)zlog_debug("%s:%slosesto%sduetocon
fed-internalpeer<confed-externalpeer",pfx_buf,new_buf,exist_buf);return0;}}/*11.
Maximumpathcheck.*/if(newm==existm){/*Ifonepathhasalabelbuttheotherdoesnot,donot
treat*themasequalsformultipath*/if((new->extra&&bgp_is_valid_label(&new->extra->
label[0]))!=(exist->extra&&bgp_is_valid_label(&exist->extra->label[0]))){if(debu
g)zlog_debug("%s:%sand%scannotbemultipath,onehasalabelwhiletheotherdoesnot",pfx_
buf,new_buf,exist_buf);}elseif(bgp_flag_check(bgp,BGP_FLAG_ASPATH_MULTIPATH_RELA
X)){/**Forthetwopaths,allcomparisonstepstillIGP*metric*havesucceeded-includingAS
_PATHhopcount.Since*'bgp*bestpathas-pathmultipath-relax'knobison,we*don'tneed*an
exactmatchofAS_PATH.Thus,markthepathsare*equal.*Thatwilltriggerboththesepathstog
etintothe*multipath*array.*/*paths_eq=1;if(debug)zlog_debug("%s:%sand%sareequalv
iamultipath-relax",pfx_buf,new_buf,exist_buf);}elseif(new->peer->sort==BGP_PEER_
IBGP){if(aspath_cmp(new->attr->aspath,exist->attr->aspath)){*paths_eq=1;if(debug
)zlog_debug("%s:%sand%sareequalviamatchingaspaths",pfx_buf,new_buf,exist_buf);}}
elseif(new->peer->as==exist->peer->as){*paths_eq=1;if(debug)zlog_debug("%s:%sand
%sareequalviasameremote-as",pfx_buf,new_buf,exist_buf);}}else{/**TODO:Ifunequalc
ostibgpmultipathisenabledwecan*markthepathsasequalhereinsteadofreturning*/if(deb
ug){if(ret==1)zlog_debug("%s:%swinsover%safterIGPmetriccomparison",pfx_buf,new_b
uf,exist_buf);elsezlog_debug("%s:%slosesto%safterIGPmetriccomparison",pfx_buf,ne
w_buf,exist_buf);}returnret;}/*12.Ifbothpathsareexternal,preferthepaththatwasrec
eivedfirst(theoldestone).Thisstepminimizesroute-flap,sinceanewerpathwon'tdisplac
eanolderone,evenifitwasthepreferredroutebasedontheadditionaldecisioncriteriabelo
w.*/if(!bgp_flag_check(bgp,BGP_FLAG_COMPARE_ROUTER_ID)&&new_sort==BGP_PEER_EBGP&
&exist_sort==BGP_PEER_EBGP){if(CHECK_FLAG(new->flags,BGP_INFO_SELECTED)){if(debu
g)zlog_debug("%s:%swinsover%sduetooldestexternal",pfx_buf,new_buf,exist_buf);ret
urn1;}if(CHECK_FLAG(exist->flags,BGP_INFO_SELECTED)){if(debug)zlog_debug("%s:%sl
osesto%sduetooldestexternal",pfx_buf,new_buf,exist_buf);return0;}}/*13.Router-ID
comparision.*//*Ifoneofthepathsis"stale",thecorrespondingpeerrouter-idwill*be0an
dwouldalwayswinovertheotherpath.Iforiginatoridis*usedforthecomparision,itwilldec
idewhichpathisbetter.*/if(newattr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID))ne
w_id.s_addr=newattr->originator_id.s_addr;elsenew_id.s_addr=new->peer->remote_id
.s_addr;if(existattr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID))exist_id.s_addr
=existattr->originator_id.s_addr;elseexist_id.s_addr=exist->peer->remote_id.s_ad
dr;if(ntohl(new_id.s_addr)<ntohl(exist_id.s_addr)){if(debug)zlog_debug("%s:%swin
sover%sduetoRouter-IDcomparison",pfx_buf,new_buf,exist_buf);return1;}if(ntohl(ne
w_id.s_addr)>ntohl(exist_id.s_addr)){if(debug)zlog_debug("%s:%slosesto%sduetoRou
ter-IDcomparison",pfx_buf,new_buf,exist_buf);return0;}/*14.Clusterlengthcomparis
ion.*/new_cluster=BGP_CLUSTER_LIST_LENGTH(new->attr);exist_cluster=BGP_CLUSTER_L
IST_LENGTH(exist->attr);if(new_cluster<exist_cluster){if(debug)zlog_debug("%s:%s
winsover%sduetoCLUSTER_LISTlength%d<%d",pfx_buf,new_buf,exist_buf,new_cluster,ex
ist_cluster);return1;}if(new_cluster>exist_cluster){if(debug)zlog_debug("%s:%slo
sesto%sduetoCLUSTER_LISTlength%d>%d",pfx_buf,new_buf,exist_buf,new_cluster,exist
_cluster);return0;}/*15.Neighboraddresscomparision.*//*Dothisonlyifneitherpathis
"stale"asstalepathsdonothave*validpeerinformation(astheconnectionmayormaynotbeup
).*/if(CHECK_FLAG(exist->flags,BGP_INFO_STALE)){if(debug)zlog_debug("%s:%swinsov
er%sduetolatterpathbeingSTALE",pfx_buf,new_buf,exist_buf);return1;}if(CHECK_FLAG
(new->flags,BGP_INFO_STALE)){if(debug)zlog_debug("%s:%slosesto%sduetoformerpathb
eingSTALE",pfx_buf,new_buf,exist_buf);return0;}/*locallyconfiguredroutestoadvert
isedonothavesu_remote*/if(new->peer->su_remote==NULL)return0;if(exist->peer->su_
remote==NULL)return1;ret=sockunion_cmp(new->peer->su_remote,exist->peer->su_remo
te);if(ret==1){if(debug)zlog_debug("%s:%slosesto%sduetoNeighorIPcomparison",pfx_
buf,new_buf,exist_buf);return0;}if(ret==-1){if(debug)zlog_debug("%s:%swinsover%s
duetoNeighorIPcomparison",pfx_buf,new_buf,exist_buf);return1;}if(debug)zlog_debu
g("%s:%swinsover%sduetonothinglefttocompare",pfx_buf,new_buf,exist_buf);return1;
}/*Comparetwobgprouteentity.Return-1ifnewispreferred,1ifexist*ispreferred,or0ift
heyarethesame(usuallywillonlyoccurif*multipathisenabled*Thisversioniscompatiblew
ith*/intbgp_info_cmp_compatible(structbgp*bgp,structbgp_info*new,structbgp_info*
exist,char*pfx_buf,afi_tafi,safi_tsafi){intpaths_eq;intret;ret=bgp_info_cmp(bgp,
new,exist,&paths_eq,NULL,0,pfx_buf,afi,safi);if(paths_eq)ret=0;else{if(ret==1)re
t=-1;elseret=1;}returnret;}staticenumfilter_typebgp_input_filter(structpeer*peer
,structprefix*p,structattr*attr,afi_tafi,safi_tsafi){structbgp_filter*filter;fil
ter=&peer->filter[afi][safi];#defineFILTER_EXIST_WARN(F,f,filter)\if(BGP_DEBUG(u
pdate,UPDATE_IN)&&!(F##_IN(filter)))\zlog_warn("%s:Couldnotfindconfiguredinput%s
-list%s!",\peer->host,#f,F##_IN_NAME(filter));if(DISTRIBUTE_IN_NAME(filter)){FIL
TER_EXIST_WARN(DISTRIBUTE,distribute,filter);if(access_list_apply(DISTRIBUTE_IN(
filter),p)==FILTER_DENY)returnFILTER_DENY;}if(PREFIX_LIST_IN_NAME(filter)){FILTE
R_EXIST_WARN(PREFIX_LIST,prefix,filter);if(prefix_list_apply(PREFIX_LIST_IN(filt
er),p)==PREFIX_DENY)returnFILTER_DENY;}if(FILTER_LIST_IN_NAME(filter)){FILTER_EX
IST_WARN(FILTER_LIST,as,filter);if(as_list_apply(FILTER_LIST_IN(filter),attr->as
path)==AS_FILTER_DENY)returnFILTER_DENY;}returnFILTER_PERMIT;#undefFILTER_EXIST_
WARN}staticenumfilter_typebgp_output_filter(structpeer*peer,structprefix*p,struc
tattr*attr,afi_tafi,safi_tsafi){structbgp_filter*filter;filter=&peer->filter[afi
][safi];#defineFILTER_EXIST_WARN(F,f,filter)\if(BGP_DEBUG(update,UPDATE_OUT)&&!(
F##_OUT(filter)))\zlog_warn("%s:Couldnotfindconfiguredoutput%s-list%s!",\peer->h
ost,#f,F##_OUT_NAME(filter));if(DISTRIBUTE_OUT_NAME(filter)){FILTER_EXIST_WARN(D
ISTRIBUTE,distribute,filter);if(access_list_apply(DISTRIBUTE_OUT(filter),p)==FIL
TER_DENY)returnFILTER_DENY;}if(PREFIX_LIST_OUT_NAME(filter)){FILTER_EXIST_WARN(P
REFIX_LIST,prefix,filter);if(prefix_list_apply(PREFIX_LIST_OUT(filter),p)==PREFI
X_DENY)returnFILTER_DENY;}if(FILTER_LIST_OUT_NAME(filter)){FILTER_EXIST_WARN(FIL
TER_LIST,as,filter);if(as_list_apply(FILTER_LIST_OUT(filter),attr->aspath)==AS_F
ILTER_DENY)returnFILTER_DENY;}returnFILTER_PERMIT;#undefFILTER_EXIST_WARN}/*Ifco
mmunityattributeincludesno_exportthenreturn1.*/staticintbgp_community_filter(str
uctpeer*peer,structattr*attr){if(attr->community){/*NO_ADVERTISEcheck.*/if(commu
nity_include(attr->community,COMMUNITY_NO_ADVERTISE))return1;/*NO_EXPORTcheck.*/
if(peer->sort==BGP_PEER_EBGP&&community_include(attr->community,COMMUNITY_NO_EXP
ORT))return1;/*NO_EXPORT_SUBCONFEDcheck.*/if(peer->sort==BGP_PEER_EBGP||peer->so
rt==BGP_PEER_CONFED)if(community_include(attr->community,COMMUNITY_NO_EXPORT_SUB
CONFED))return1;}return0;}/*Routereflectionloopcheck.*/staticintbgp_cluster_filt
er(structpeer*peer,structattr*attr){structin_addrcluster_id;if(attr->cluster){if
(peer->bgp->config&BGP_CONFIG_CLUSTER_ID)cluster_id=peer->bgp->cluster_id;elsecl
uster_id=peer->bgp->router_id;if(cluster_loop_check(attr->cluster,cluster_id))re
turn1;}return0;}staticintbgp_input_modifier(structpeer*peer,structprefix*p,struc
tattr*attr,afi_tafi,safi_tsafi,constchar*rmap_name){structbgp_filter*filter;stru
ctbgp_infoinfo;route_map_result_tret;structroute_map*rmap=NULL;filter=&peer->fil
ter[afi][safi];/*Applydefaultweightvalue.*/if(peer->weight[afi][safi])attr->weig
ht=peer->weight[afi][safi];if(rmap_name){rmap=route_map_lookup_by_name(rmap_name
);if(rmap==NULL)returnRMAP_DENY;}else{if(ROUTE_MAP_IN_NAME(filter)){rmap=ROUTE_M
AP_IN(filter);if(rmap==NULL)returnRMAP_DENY;}}/*Routemapapply.*/if(rmap){/*Dupli
catecurrentvaluetonewstrucutreformodification.*/info.peer=peer;info.attr=attr;SE
T_FLAG(peer->rmap_type,PEER_RMAP_TYPE_IN);/*ApplyBGProutemaptotheattribute.*/ret
=route_map_apply(rmap,p,RMAP_BGP,&info);peer->rmap_type=0;if(ret==RMAP_DENYMATCH
){/*FreenewlygeneratedASpathandcommunityby*route-map.*/bgp_attr_flush(attr);retu
rnRMAP_DENY;}}returnRMAP_PERMIT;}staticintbgp_output_modifier(structpeer*peer,st
ructprefix*p,structattr*attr,afi_tafi,safi_tsafi,constchar*rmap_name){structbgp_
infoinfo;route_map_result_tret;structroute_map*rmap=NULL;uint8_trmap_type;/**Soi
fwegettothispointandhavenormap_name*wewanttojustshowtheoutputasitcurrently*exist
s.*/if(!rmap_name)returnRMAP_PERMIT;/*Applydefaultweightvalue.*/if(peer->weight[
afi][safi])attr->weight=peer->weight[afi][safi];rmap=route_map_lookup_by_name(rm
ap_name);/**Ifwehavearoutemapnameandwedonotfind*theroutemapthatmeanswehaveanimpl
icit*deny.*/if(rmap==NULL)returnRMAP_DENY;/*Routemapapply.*//*Duplicatecurrentva
luetonewstrucutreformodification.*/info.peer=peer;info.attr=attr;rmap_type=peer-
>rmap_type;SET_FLAG(peer->rmap_type,PEER_RMAP_TYPE_OUT);/*ApplyBGProutemaptothea
ttribute.*/ret=route_map_apply(rmap,p,RMAP_BGP,&info);peer->rmap_type=rmap_type;
if(ret==RMAP_DENYMATCH)/**callerhasmultipleerrorpathswithbgp_attr_flush()*/retur
nRMAP_DENY;returnRMAP_PERMIT;}/*IfthisisanEBGPpeerwithremove-private-AS*/staticv
oidbgp_peer_remove_private_as(structbgp*bgp,afi_tafi,safi_tsafi,structpeer*peer,
structattr*attr){if(peer->sort==BGP_PEER_EBGP&&(peer_af_flag_check(peer,afi,safi
,PEER_FLAG_REMOVE_PRIVATE_AS_ALL_REPLACE)||peer_af_flag_check(peer,afi,safi,PEER
_FLAG_REMOVE_PRIVATE_AS_REPLACE)||peer_af_flag_check(peer,afi,safi,PEER_FLAG_REM
OVE_PRIVATE_AS_ALL)||peer_af_flag_check(peer,afi,safi,PEER_FLAG_REMOVE_PRIVATE_A
S))){//Takeactionontheentireaspathif(peer_af_flag_check(peer,afi,safi,PEER_FLAG_
REMOVE_PRIVATE_AS_ALL_REPLACE)||peer_af_flag_check(peer,afi,safi,PEER_FLAG_REMOV
E_PRIVATE_AS_ALL)){if(peer_af_flag_check(peer,afi,safi,PEER_FLAG_REMOVE_PRIVATE_
AS_ALL_REPLACE))attr->aspath=aspath_replace_private_asns(attr->aspath,bgp->as);/
/TheentireaspathconsistsofprivateASNssocreate//anemptyaspathelseif(aspath_privat
e_as_check(attr->aspath))attr->aspath=aspath_empty_get();//Therearesomepublicand
someprivateASNs,remove//theprivateASNselseattr->aspath=aspath_remove_private_asn
s(attr->aspath);}//'all'wasnotspecifiedsotheentireaspathmustbeprivate//ASNs//for
ustodoanythingelseif(aspath_private_as_check(attr->aspath)){if(peer_af_flag_chec
k(peer,afi,safi,PEER_FLAG_REMOVE_PRIVATE_AS_REPLACE))attr->aspath=aspath_replace
_private_asns(attr->aspath,bgp->as);elseattr->aspath=aspath_empty_get();}}}/*Ift
hisisanEBGPpeerwithas-override*/staticvoidbgp_peer_as_override(structbgp*bgp,afi
_tafi,safi_tsafi,structpeer*peer,structattr*attr){if(peer->sort==BGP_PEER_EBGP&&
peer_af_flag_check(peer,afi,safi,PEER_FLAG_AS_OVERRIDE)){if(aspath_single_asn_ch
eck(attr->aspath,peer->as))attr->aspath=aspath_replace_specific_asn(attr->aspath
,peer->as,bgp->as);}}voidbgp_attr_add_gshut_community(structattr*attr){structcom
munity*old;structcommunity*new;structcommunity*merge;structcommunity*gshut;old=a
ttr->community;gshut=community_str2com("graceful-shutdown");if(old){merge=commun
ity_merge(community_dup(old),gshut);if(old->refcnt==0)community_free(old);new=co
mmunity_uniq_sort(merge);community_free(merge);}else{new=community_dup(gshut);}c
ommunity_free(gshut);attr->community=new;attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_COMM
UNITIES);/*Whenweaddthegraceful-shutdowncommunitywemustalso*lowerthelocal-prefer
ence*/attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);attr->local_pref=BGP_GSHUT_
LOCAL_PREF;}staticvoidsubgroup_announce_reset_nhop(uint8_tfamily,structattr*attr
){if(family==AF_INET)attr->nexthop.s_addr=0;if(family==AF_INET6)memset(&attr->mp
_nexthop_global,0,IPV6_MAX_BYTELEN);}intsubgroup_announce_check(structbgp_node*r
n,structbgp_info*ri,structupdate_subgroup*subgrp,structprefix*p,structattr*attr)
{structbgp_filter*filter;structpeer*from;structpeer*peer;structpeer*onlypeer;str
uctbgp*bgp;structattr*riattr;charbuf[PREFIX_STRLEN];intret;inttransparent;intref
lect;afi_tafi;safi_tsafi;intsamepeer_safe=0;/*forsyntheticmplsvpnsroutes*/if(DIS
ABLE_BGP_ANNOUNCE)return0;afi=SUBGRP_AFI(subgrp);safi=SUBGRP_SAFI(subgrp);peer=S
UBGRP_PEER(subgrp);onlypeer=NULL;if(CHECK_FLAG(peer->flags,PEER_FLAG_LONESOUL))o
nlypeer=SUBGRP_PFIRST(subgrp)->peer;from=ri->peer;filter=&peer->filter[afi][safi
];bgp=SUBGRP_INST(subgrp);riattr=bgp_info_mpath_count(ri)?bgp_info_mpath_attr(ri
):ri->attr;#ifENABLE_BGP_VNCif(((afi==AFI_IP)||(afi==AFI_IP6))&&(safi==SAFI_MPLS
_VPN)&&((ri->type==ZEBRA_ROUTE_BGP_DIRECT)||(ri->type==ZEBRA_ROUTE_BGP_DIRECT_EX
T))){/**directanddirect_exttyperoutesoriginateinternallyeven*thoughtheycanhavepe
erpointersthatreferenceother*systems*/prefix2str(p,buf,PREFIX_STRLEN);zlog_debug
("%s:pfx%sbgp_direct->vpnroutepeersafe",__func__,buf);samepeer_safe=1;}#endifif(
((afi==AFI_IP)||(afi==AFI_IP6))&&((safi==SAFI_MPLS_VPN)||(safi==SAFI_UNICAST))&&
(ri->type==ZEBRA_ROUTE_BGP)&&(ri->sub_type==BGP_ROUTE_IMPORTED)){/*Appliestorout
esleakedvpn->vrfandvrf->vpn*/samepeer_safe=1;}/*WithaddpathwemaybeaskedtoTXallki
ndsofpathssomakesure*riisvalid*/if(!CHECK_FLAG(ri->flags,BGP_INFO_VALID)||CHECK_
FLAG(ri->flags,BGP_INFO_HISTORY)||CHECK_FLAG(ri->flags,BGP_INFO_REMOVED)){return
0;}/*Ifthisisnotthebestpaththenchecktoseeifthereisanenabled*addpath*featurethatr
equiresustoadvertiseit*/if(!CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)){if(!bgp_add
path_tx_path(peer,afi,safi,ri)){return0;}}/*Aggregate-addresssuppresscheck.*/if(
ri->extra&&ri->extra->suppress)if(!UNSUPPRESS_MAP_NAME(filter)){return0;}/*Ifit'
slabeledsafi,makesuretheroutehasavalidlabel.*/if(safi==SAFI_LABELED_UNICAST){mpl
s_label_tlabel=bgp_adv_label(rn,ri,peer,afi,safi);if(!bgp_is_valid_label(&label)
){if(bgp_debug_update(NULL,p,subgrp->update_group,0))zlog_debug("u%"PRIu64":s%"P
RIu64"%s/%disfiltered-nolabel(%p)",subgrp->update_group->id,subgrp->id,inet_ntop
(p->family,&p->u.prefix,buf,SU_ADDRSTRLEN),p->prefixlen,&label);return0;}}/*Dono
tsendbackroutetosender.*/if(onlypeer&&from==onlypeer){return0;}/*Donotsendthedef
aultrouteintheBGPtableiftheneighboris*configuredfordefault-originate*/if(CHECK_F
LAG(peer->af_flags[afi][safi],PEER_FLAG_DEFAULT_ORIGINATE)){if(p->family==AF_INE
T&&p->u.prefix4.s_addr==INADDR_ANY)return0;elseif(p->family==AF_INET6&&p->prefix
len==0)return0;}/*Transparencycheck.*/if(CHECK_FLAG(peer->af_flags[afi][safi],PE
ER_FLAG_RSERVER_CLIENT)&&CHECK_FLAG(from->af_flags[afi][safi],PEER_FLAG_RSERVER_
CLIENT))transparent=1;elsetransparent=0;/*Ifcommunityisnotdisabledchecktheno-exp
ortandlocal.*/if(!transparent&&bgp_community_filter(peer,riattr)){if(bgp_debug_u
pdate(NULL,p,subgrp->update_group,0))zlog_debug("subgrpannouncecheck:communityfi
ltercheckfail");return0;}/*Iftheattributehasoriginator-idanditissameasremotepeer
'sid.*/if(onlypeer&&riattr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID)&&(IPV4_AD
DR_SAME(&onlypeer->remote_id,&riattr->originator_id))){if(bgp_debug_update(NULL,
p,subgrp->update_group,0))zlog_debug("%s[Update:SEND]%soriginator-idissameas""re
moterouter-id",onlypeer->host,prefix2str(p,buf,sizeof(buf)));return0;}/*ORFprefi
x-listfiltercheck*/if(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_
ADV)&&(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_RCV)||CHECK_FLA
G(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_OLD_RCV)))if(peer->orf_plist[af
i][safi]){if(prefix_list_apply(peer->orf_plist[afi][safi],p)==PREFIX_DENY){if(bg
p_debug_update(NULL,p,subgrp->update_group,0))zlog_debug("%s[Update:SEND]%sisfil
teredviaORF",peer->host,prefix2str(p,buf,sizeof(buf)));return0;}}/*Outputfilterc
heck.*/if(bgp_output_filter(peer,p,riattr,afi,safi)==FILTER_DENY){if(bgp_debug_u
pdate(NULL,p,subgrp->update_group,0))zlog_debug("%s[Update:SEND]%sisfiltered",pe
er->host,prefix2str(p,buf,sizeof(buf)));return0;}#ifdefBGP_SEND_ASPATH_CHECK/*AS
pathloopcheck.*/if(onlypeer&&aspath_loop_check(riattr->aspath,onlypeer->as)){if(
bgp_debug_update(NULL,p,subgrp->update_group,0))zlog_debug("%s[Update:SEND]suppr
essannouncementtopeerAS%u""thatispartofASpath.",onlypeer->host,onlypeer->as);ret
urn0;}#endif/*BGP_SEND_ASPATH_CHECK*//*Ifwe'reaCONFEDweneedtoloopchecktheCONFEDI
Dtoo*/if(CHECK_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION)){if(aspath_loop_check(
riattr->aspath,bgp->confed_id)){if(bgp_debug_update(NULL,p,subgrp->update_group,
0))zlog_debug("%s[Update:SEND]suppressannouncementtopeerAS%u""isASpath.",peer->h
ost,bgp->confed_id);return0;}}/*Route-Reflectcheck.*/if(from->sort==BGP_PEER_IBG
P&&peer->sort==BGP_PEER_IBGP)reflect=1;elsereflect=0;/*IBGPreflectioncheck.*/if(
reflect&&!samepeer_safe){/*AroutefromaClientpeer.*/if(CHECK_FLAG(from->af_flags[
afi][safi],PEER_FLAG_REFLECTOR_CLIENT)){/*ReflecttoalltheNon-Clientpeersandalsot
otheClientpeersotherthantheoriginator.Originatorcheckisalreadydone.Sothereisnoti
ngtodo.*//*nobgpclient-to-clientreflectioncheck.*/if(bgp_flag_check(bgp,BGP_FLAG
_NO_CLIENT_TO_CLIENT))if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_REFLECTO
R_CLIENT))return0;}else{/*AroutefromaNon-clientpeer.Reflecttoallotherclients.*/i
f(!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_REFLECTOR_CLIENT))return0;}}/*
Formodifyattribute,copyittotemporarystructure.*/bgp_attr_dup(attr,riattr);/*Iflo
cal-preferenceisnotset.*/if((peer->sort==BGP_PEER_IBGP||peer->sort==BGP_PEER_CON
FED)&&(!(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)))){attr->flag|=ATTR_FLAG_
BIT(BGP_ATTR_LOCAL_PREF);attr->local_pref=bgp->default_local_pref;}/*Iforiginato
r-idisnotsetandtherouteistobereflected,settheoriginatorid*/if(reflect&&(!(attr->
flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID)))){IPV4_ADDR_COPY(&(attr->originator_
id),&(from->remote_id));SET_FLAG(attr->flag,BGP_ATTR_ORIGINATOR_ID);}/*RemoveMED
ifitsanEBGPpeer-willgetoverwrittenbyroute-maps*/if(peer->sort==BGP_PEER_EBGP&&at
tr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC)){if(from!=bgp->peer_self&&!tran
sparent&&!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_MED_UNCHANGED))attr->fl
ag&=~(ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC));}/*Sincethenexthopattributecanvar
yperpeer,itisnotexplicitly*set*inannouncecheck,onlycertainflagsandlength(ornumbe
rof*nexthops*--forIPv6/MP_REACH)aresethereinordertoguidetheupdate*formation*code
insettingthenexthop(s)onaperpeerbasisin*reformat_peer().*Typically,thesourcenext
hopintheattributeispreservedbutin*the*scenarioswhereweknowitwillalwaysbeoverwrit
ten,weresetthe*nexthopto"0"inanattempttoachievebetterUpdatepacking.An*exampleoft
hisiswhenaprefixfromeachof2IBGPpeersneedsto*be*announcedtoanEBGPpeer(andtheyhave
thesameattributesbarring*theirnexthop).*/if(reflect)SET_FLAG(attr->rmap_change_f
lags,BATTR_REFLECTED);#defineNEXTHOP_IS_V6\((safi!=SAFI_ENCAP&&safi!=SAFI_MPLS_V
PN\&&(p->family==AF_INET6||peer_cap_enhe(peer,afi,safi)))\||((safi==SAFI_ENCAP||
safi==SAFI_MPLS_VPN)\&&attr->mp_nexthop_len>=IPV6_MAX_BYTELEN))/*IPv6/MPstartswi
th1nexthop.Thelink-localaddressispassedonly*if*thepeer(group)isconfiguredtorecei
velink-localnexthop*unchanged*anditisavailableintheprefixORwe'renotreflectingthe
route*and*thepeer(group)towhomwe'regoingtoannounceisonashared*network*andthisise
itheraself-originatedrouteorthepeerisEBGP.*/if(NEXTHOP_IS_V6){attr->mp_nexthop_l
en=BGP_ATTR_NHLEN_IPV6_GLOBAL;if((CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG
_NEXTHOP_LOCAL_UNCHANGED)&&IN6_IS_ADDR_LINKLOCAL(&attr->mp_nexthop_local))||(!re
flect&&peer->shared_network&&(from==bgp->peer_self||peer->sort==BGP_PEER_EBGP)))
{attr->mp_nexthop_len=BGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL;}/*Clearofflink-localnex
thopinsource,wheneveritisnot*neededto*ensuremoreprefixessharethesameattributefor
*announcement.*/if(!(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_NEXTHOP_LOCA
L_UNCHANGED)))memset(&attr->mp_nexthop_local,0,IPV6_MAX_BYTELEN);}bgp_peer_remov
e_private_as(bgp,afi,safi,peer,attr);bgp_peer_as_override(bgp,afi,safi,peer,attr
);/*Routemap&unsuppress-mapapply.*/if(ROUTE_MAP_OUT_NAME(filter)||(ri->extra&&ri
->extra->suppress)){structbgp_infoinfo;structbgp_info_extradummy_info_extra;stru
ctattrdummy_attr;info.peer=peer;info.attr=attr;if(ri->extra){memcpy(&dummy_info_
extra,ri->extra,sizeof(structbgp_info_extra));info.extra=&dummy_info_extra;}/*do
n'tconfuseinboundandoutboundsetting*/RESET_FLAG(attr->rmap_change_flags);/**Ther
outereflectorisnotallowedtomodifytheattributes*ofthereflectedIBGProutesunlessexp
licitlyallowed.*/if((from->sort==BGP_PEER_IBGP&&peer->sort==BGP_PEER_IBGP)&&!bgp
_flag_check(bgp,BGP_FLAG_RR_ALLOW_OUTBOUND_POLICY)){bgp_attr_dup(&dummy_attr,att
r);info.attr=&dummy_attr;}SET_FLAG(peer->rmap_type,PEER_RMAP_TYPE_OUT);if(ri->ex
tra&&ri->extra->suppress)ret=route_map_apply(UNSUPPRESS_MAP(filter),p,RMAP_BGP,&
info);elseret=route_map_apply(ROUTE_MAP_OUT(filter),p,RMAP_BGP,&info);peer->rmap
_type=0;if(ret==RMAP_DENYMATCH){bgp_attr_flush(attr);return0;}}if(bgp_flag_check
(bgp,BGP_FLAG_GRACEFUL_SHUTDOWN)){if(peer->sort==BGP_PEER_IBGP||peer->sort==BGP_
PEER_CONFED){attr->flag|=ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);attr->local_pref=BGP
_GSHUT_LOCAL_PREF;}else{bgp_attr_add_gshut_community(attr);}}/*Afterroute-maphas
beenapplied,wechecktoseeifthenexthopto*becarriedintheattribute(thatisusedforthea
nnouncement)can*beclearedoffornot.Wedothisinallcaseswherewewouldbe*settingthenex
thopto"ourselves".ForIPv6,weonlyneedto*consider*theglobalnexthophere;thelink-loc
alnexthopwouldhavebeen*cleared*already,andifnot,itisrequiredbytheupdateformation
code.*Alsoseeearliercommentsinthisfunction.*//**Ifroute-maphasperformedsomeopera
tiononthenexthoporthepeer*configurationsaystopassitunchanged,wecannotresetthenex
thop*here,soonlyattempttodoitifthesearen'ttrue.Notethatthe*route-maphandleritsel
fmighthaveclearedthenexthop,iffor*example,*itisconfiguredas'peer-address'.*/if(!
bgp_rmap_nhop_changed(attr->rmap_change_flags,riattr->rmap_change_flags)&&!trans
parent&&!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_NEXTHOP_UNCHANGED)){/*We
canresetthenexthop,ifsetting(orforcing)itto*'self'*/if(CHECK_FLAG(peer->af_flags
[afi][safi],PEER_FLAG_NEXTHOP_SELF)||CHECK_FLAG(peer->af_flags[afi][safi],PEER_F
LAG_FORCE_NEXTHOP_SELF)){if(!reflect||CHECK_FLAG(peer->af_flags[afi][safi],PEER_
FLAG_FORCE_NEXTHOP_SELF))subgroup_announce_reset_nhop((peer_cap_enhe(peer,afi,sa
fi)?AF_INET6:p->family),attr);}elseif(peer->sort==BGP_PEER_EBGP){/*Canalsoresett
henexthopifannouncingtoEBGP,but*onlyif*nopeerinthesubgroupisonasharedsubnet.*Not
e:3rdpartynexthopcurrentlyimplementedfor*IPv4only.*/if(!bgp_subgrp_multiaccess_c
heck_v4(riattr->nexthop,subgrp))subgroup_announce_reset_nhop((peer_cap_enhe(peer
,afi,safi)?AF_INET6:p->family),attr);}/*IfIPv6/MPandnexthopdoesnothaveanyoverrid
eandhappens*to*bealink-localaddress,resetitsothatwedon'tpassalong*the*source'sli
nk-localIPv6addresstorecipientswhomaynotbe*on*thesameinterface.*/if(p->family==A
F_INET6||peer_cap_enhe(peer,afi,safi)){if(IN6_IS_ADDR_LINKLOCAL(&attr->mp_nextho
p_global))subgroup_announce_reset_nhop(AF_INET6,attr);}}return1;}voidbgp_best_se
lection(structbgp*bgp,structbgp_node*rn,structbgp_maxpaths_cfg*mpath_cfg,structb
gp_info_pair*result,afi_tafi,safi_tsafi){structbgp_info*new_select;structbgp_inf
o*old_select;structbgp_info*ri;structbgp_info*ri1;structbgp_info*ri2;structbgp_i
nfo*nextri=NULL;intpaths_eq,do_mpath,debug;structlistmp_list;charpfx_buf[PREFIX2
STR_BUFFER];charpath_buf[PATH_ADDPATH_STR_BUFFER];bgp_mp_list_init(&mp_list);do_
mpath=(mpath_cfg->maxpaths_ebgp>1||mpath_cfg->maxpaths_ibgp>1);debug=bgp_debug_b
estpath(&rn->p);if(debug)prefix2str(&rn->p,pfx_buf,sizeof(pfx_buf));/*bgpdetermi
nistic-med*/new_select=NULL;if(bgp_flag_check(bgp,BGP_FLAG_DETERMINISTIC_MED)){/
*ClearBGP_INFO_DMED_SELECTEDforallpaths*/for(ri1=rn->info;ri1;ri1=ri1->next)bgp_
info_unset_flag(rn,ri1,BGP_INFO_DMED_SELECTED);for(ri1=rn->info;ri1;ri1=ri1->nex
t){if(CHECK_FLAG(ri1->flags,BGP_INFO_DMED_CHECK))continue;if(BGP_INFO_HOLDDOWN(r
i1))continue;if(ri1->peer&&ri1->peer!=bgp->peer_self)if(ri1->peer->status!=Estab
lished)continue;new_select=ri1;if(ri1->next){for(ri2=ri1->next;ri2;ri2=ri2->next
){if(CHECK_FLAG(ri2->flags,BGP_INFO_DMED_CHECK))continue;if(BGP_INFO_HOLDDOWN(ri
2))continue;if(ri2->peer&&ri2->peer!=bgp->peer_self&&!CHECK_FLAG(ri2->peer->sfla
gs,PEER_STATUS_NSF_WAIT))if(ri2->peer->status!=Established)continue;if(aspath_cm
p_left(ri1->attr->aspath,ri2->attr->aspath)||aspath_cmp_left_confed(ri1->attr->a
spath,ri2->attr->aspath)){if(bgp_info_cmp(bgp,ri2,new_select,&paths_eq,mpath_cfg
,debug,pfx_buf,afi,safi)){bgp_info_unset_flag(rn,new_select,BGP_INFO_DMED_SELECT
ED);new_select=ri2;}bgp_info_set_flag(rn,ri2,BGP_INFO_DMED_CHECK);}}}bgp_info_se
t_flag(rn,new_select,BGP_INFO_DMED_CHECK);bgp_info_set_flag(rn,new_select,BGP_IN
FO_DMED_SELECTED);if(debug){bgp_info_path_with_addpath_rx_str(new_select,path_bu
f);zlog_debug("%s:%sisthebestpathfromAS%d",pfx_buf,path_buf,aspath_get_first_as(
new_select->attr->aspath));}}}/*Checkoldselectedrouteandnewselectedroute.*/old_s
elect=NULL;new_select=NULL;for(ri=rn->info;(ri!=NULL)&&(nextri=ri->next,1);ri=ne
xtri){if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED))old_select=ri;if(BGP_INFO_HOLDD
OWN(ri)){/*reapREMOVEDroutes,ifneedsbe*selectedroutemuststayforawhilelongerthoug
h*/if(CHECK_FLAG(ri->flags,BGP_INFO_REMOVED)&&(ri!=old_select))bgp_info_reap(rn,
ri);if(debug)zlog_debug("%s:ri%pinholddown",__func__,ri);continue;}if(ri->peer&&
ri->peer!=bgp->peer_self&&!CHECK_FLAG(ri->peer->sflags,PEER_STATUS_NSF_WAIT))if(
ri->peer->status!=Established){if(debug)zlog_debug("%s:ri%pnonselfpeer%snotestab
state",__func__,ri,ri->peer->host);continue;}if(bgp_flag_check(bgp,BGP_FLAG_DETE
RMINISTIC_MED)&&(!CHECK_FLAG(ri->flags,BGP_INFO_DMED_SELECTED))){bgp_info_unset_
flag(rn,ri,BGP_INFO_DMED_CHECK);if(debug)zlog_debug("%s:ri%pdmed",__func__,ri);c
ontinue;}bgp_info_unset_flag(rn,ri,BGP_INFO_DMED_CHECK);if(bgp_info_cmp(bgp,ri,n
ew_select,&paths_eq,mpath_cfg,debug,pfx_buf,afi,safi)){new_select=ri;}}/*Nowthat
weknowwhichpathisthebestpathseeifanyoftheother*paths*qualifyasmultipaths*/if(deb
ug){if(new_select)bgp_info_path_with_addpath_rx_str(new_select,path_buf);elsespr
intf(path_buf,"NONE");zlog_debug("%s:Afterpathselection,newbestis%soldbestwas%s"
,pfx_buf,path_buf,old_select?old_select->peer->host:"NONE");}if(do_mpath&&new_se
lect){for(ri=rn->info;(ri!=NULL)&&(nextri=ri->next,1);ri=nextri){if(debug)bgp_in
fo_path_with_addpath_rx_str(ri,path_buf);if(ri==new_select){if(debug)zlog_debug(
"%s:%sisthebestpath,addtothemultipathlist",pfx_buf,path_buf);bgp_mp_list_add(&mp
_list,ri);continue;}if(BGP_INFO_HOLDDOWN(ri))continue;if(ri->peer&&ri->peer!=bgp
->peer_self&&!CHECK_FLAG(ri->peer->sflags,PEER_STATUS_NSF_WAIT))if(ri->peer->sta
tus!=Established)continue;if(!bgp_info_nexthop_cmp(ri,new_select)){if(debug)zlog
_debug("%s:%shasthesamenexthopasthebestpath,skipit",pfx_buf,path_buf);continue;}
bgp_info_cmp(bgp,ri,new_select,&paths_eq,mpath_cfg,debug,pfx_buf,afi,safi);if(pa
ths_eq){if(debug)zlog_debug("%s:%sisequivalenttothebestpath,addtothemultipathlis
t",pfx_buf,path_buf);bgp_mp_list_add(&mp_list,ri);}}}bgp_info_mpath_update(rn,ne
w_select,old_select,&mp_list,mpath_cfg);bgp_info_mpath_aggregate_update(new_sele
ct,old_select);bgp_mp_list_clear(&mp_list);result->old=old_select;result->new=ne
w_select;return;}/**Anewroute/changeinbestpathofanexistingroute.Evaluatethepath*
foradvertisementtothesubgroup.*/intsubgroup_process_announce_selected(structupda
te_subgroup*subgrp,structbgp_info*selected,structbgp_node*rn,uint32_taddpath_tx_
id){structprefix*p;structpeer*onlypeer;structattrattr;afi_tafi;safi_tsafi;p=&rn-
>p;afi=SUBGRP_AFI(subgrp);safi=SUBGRP_SAFI(subgrp);onlypeer=((SUBGRP_PCOUNT(subg
rp)==1)?(SUBGRP_PFIRST(subgrp))->peer:NULL);if(BGP_DEBUG(update,UPDATE_OUT)){cha
rbuf_prefix[PREFIX_STRLEN];prefix2str(p,buf_prefix,sizeof(buf_prefix));zlog_debu
g("%s:p=%s,selected=%p",__func__,buf_prefix,selected);}/*Firstupdateisdeferredun
tilORForROUTE-REFRESHisreceived*/if(onlypeer&&CHECK_FLAG(onlypeer->af_sflags[afi
][safi],PEER_STATUS_ORF_WAIT_REFRESH))return0;memset(&attr,0,sizeof(structattr))
;/*It'sinitializedinbgp_announce_check()*//*Announcementtothesubgroup.Iftheroute
isfilteredwithdrawit.*/if(selected){if(subgroup_announce_check(rn,selected,subgr
p,p,&attr))bgp_adj_out_set_subgroup(rn,subgrp,&attr,selected);elsebgp_adj_out_un
set_subgroup(rn,subgrp,1,selected->addpath_tx_id);}/*IfselectedisNULLwemustwithd
rawthepathusingaddpath_tx_id*/else{bgp_adj_out_unset_subgroup(rn,subgrp,1,addpat
h_tx_id);}return0;}/**ClearIGPchangedflagandattributechangedflagforaroute(allpat
hs).*Thisiscalledattheendofrouteprocessing.*/voidbgp_zebra_clear_route_change_fl
ags(structbgp_node*rn){structbgp_info*ri;for(ri=rn->info;ri;ri=ri->next){if(BGP_
INFO_HOLDDOWN(ri))continue;UNSET_FLAG(ri->flags,BGP_INFO_IGP_CHANGED);UNSET_FLAG
(ri->flags,BGP_INFO_ATTR_CHANGED);}}/**HastheroutechangedfromtheRIB'sperspective
?Thisisinvokedonly*iftherouteselectionreturnsthesamebestrouteasearlier-to*determ
ineifweneedtoupdatezebraornot.*/intbgp_zebra_has_route_changed(structbgp_node*rn
,structbgp_info*selected){structbgp_info*mpinfo;/*Ifthisismultipath,checkallsele
ctedpathsforanynexthopchange*or*attributechange.Someattributechanges(e.g.,commun
ity)aren'tof*relevancetotheRIB,butwe'llupdatezebratoensurewehandlethe*caseofBGPn
exthopchange.Thisisthebehaviorwhenthebestpath*has*anattributechangeanyway.*/if(C
HECK_FLAG(selected->flags,BGP_INFO_IGP_CHANGED)||CHECK_FLAG(selected->flags,BGP_
INFO_MULTIPATH_CHG))return1;/*Ifthisismultipath,checkallselectedpathsforanynexth
opchange*/for(mpinfo=bgp_info_mpath_first(selected);mpinfo;mpinfo=bgp_info_mpath
_next(mpinfo)){if(CHECK_FLAG(mpinfo->flags,BGP_INFO_IGP_CHANGED)||CHECK_FLAG(mpi
nfo->flags,BGP_INFO_ATTR_CHANGED))return1;}/*NothinghaschangedfromtheRIB'sperspe
ctive.*/return0;}structbgp_process_queue{structbgp*bgp;STAILQ_HEAD(,bgp_node)pqu
eue;#defineBGP_PROCESS_QUEUE_EOIU_MARKER(1<<0)unsignedintflags;unsignedintqueued
;};/**old_select=Theoldbestpath*new_select=thenewbestpath**if(!old_select&&new_s
elect)*Wearesendingnewinformationon.**if(old_select&&new_select){*if(new_select!
=old_select)*Wehaveanewbestpathsendachange*else*We'vereceivedaupdatewithnewattri
butesthatneeds*tobepassedon.*}**if(old_select&&!new_select)*Wehavenoeligiblerout
ethatwecanannounceorthern*isbeingremoved.*/staticvoidbgp_process_main_one(struct
bgp*bgp,structbgp_node*rn,afi_tafi,safi_tsafi){structprefix*p=&rn->p;structbgp_i
nfo*new_select;structbgp_info*old_select;structbgp_info_pairold_and_new;charpfx_
buf[PREFIX2STR_BUFFER];intdebug=0;/*Isitendofinitialupdate?(afterstartup)*/if(!r
n){quagga_timestamp(3,bgp->update_delay_zebra_resume_time,sizeof(bgp->update_del
ay_zebra_resume_time));bgp->main_zebra_update_hold=0;FOREACH_AFI_SAFI(afi,safi){
if(bgp_fibupd_safi(safi))bgp_zebra_announce_table(bgp,afi,safi);}bgp->main_peers
_update_hold=0;bgp_start_routeadv(bgp);return;}debug=bgp_debug_bestpath(&rn->p);
if(debug){prefix2str(&rn->p,pfx_buf,sizeof(pfx_buf));zlog_debug("%s:p=%safi=%s,s
afi=%sstart",__func__,pfx_buf,afi2str(afi),safi2str(safi));}/*Bestpathselection.
*/bgp_best_selection(bgp,rn,&bgp->maxpaths[afi][safi],&old_and_new,afi,safi);old
_select=old_and_new.old;new_select=old_and_new.new;/*Doweneedtoallocateorfreelab
els?*Rightnow,sinceweonlydealwithper-prefixlabels,itisnot*necessarytodothisuponc
hangestobestpathexceptifthelabel*indexchanges*/if(bgp->allocate_mpls_labels[afi]
[safi]){if(new_select){if(!old_select||bgp_label_index_differs(new_select,old_se
lect)||new_select->sub_type!=old_select->sub_type){if(new_select->sub_type==BGP_
ROUTE_STATIC&&new_select->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID)&&new_sel
ect->attr->label_index!=BGP_INVALID_LABEL_INDEX){if(CHECK_FLAG(rn->flags,BGP_NOD
E_REGISTERED_FOR_LABEL))bgp_unregister_for_label(rn);label_ntop(MPLS_LABEL_IMPLI
CIT_NULL,1,&rn->local_label);bgp_set_valid_label(&rn->local_label);}elsebgp_regi
ster_for_label(rn,new_select);}}elseif(CHECK_FLAG(rn->flags,BGP_NODE_REGISTERED_
FOR_LABEL)){bgp_unregister_for_label(rn);}}elseif(CHECK_FLAG(rn->flags,BGP_NODE_
REGISTERED_FOR_LABEL)){bgp_unregister_for_label(rn);}if(debug){prefix2str(&rn->p
,pfx_buf,sizeof(pfx_buf));zlog_debug("%s:p=%safi=%s,safi=%s,old_select=%p,new_se
lect=%p",__func__,pfx_buf,afi2str(afi),safi2str(safi),old_select,new_select);}/*
Ifbestrouteremainsthesameandthisisnotduetouser-initiated*clear,seeexactlywhatnee
dstobedone.*/if(old_select&&old_select==new_select&&!CHECK_FLAG(rn->flags,BGP_NO
DE_USER_CLEAR)&&!CHECK_FLAG(old_select->flags,BGP_INFO_ATTR_CHANGED)&&!bgp->addp
ath_tx_used[afi][safi]){if(bgp_zebra_has_route_changed(rn,old_select)){#ifENABLE
_BGP_VNCvnc_import_bgp_add_route(bgp,p,old_select);vnc_import_bgp_exterior_add_r
oute(bgp,p,old_select);#endifif(bgp_fibupd_safi(safi)&&!bgp_option_check(BGP_OPT
_NO_FIB)){if(new_select->type==ZEBRA_ROUTE_BGP&&(new_select->sub_type==BGP_ROUTE
_NORMAL||new_select->sub_type==BGP_ROUTE_IMPORTED))bgp_zebra_announce(rn,p,old_s
elect,bgp,afi,safi);}}UNSET_FLAG(old_select->flags,BGP_INFO_MULTIPATH_CHG);bgp_z
ebra_clear_route_change_flags(rn);/*Ifthereisachangeofinteresttopeers,reannounce
the*route.*/if(CHECK_FLAG(old_select->flags,BGP_INFO_ATTR_CHANGED)||CHECK_FLAG(r
n->flags,BGP_NODE_LABEL_CHANGED)){group_announce_route(bgp,afi,safi,rn,new_selec
t);/*unicastroutesmustalsobeannoucedto*labeled-unicastupdate-groups*/if(safi==SA
FI_UNICAST)group_announce_route(bgp,afi,SAFI_LABELED_UNICAST,rn,new_select);UNSE
T_FLAG(old_select->flags,BGP_INFO_ATTR_CHANGED);UNSET_FLAG(rn->flags,BGP_NODE_LA
BEL_CHANGED);}UNSET_FLAG(rn->flags,BGP_NODE_PROCESS_SCHEDULED);return;}/*Iftheus
erdid"clearipbgpprefixx.x.x.x"thisflagwillbeset*/UNSET_FLAG(rn->flags,BGP_NODE_U
SER_CLEAR);/*bestpathhaschanged;bumpversion*/if(old_select||new_select){bgp_bump
_version(rn);if(!bgp->t_rmap_def_originate_eval){bgp_lock(bgp);thread_add_timer(
bm->master,update_group_refresh_default_originate_route_map,bgp,RMAP_DEFAULT_ORI
GINATE_EVAL_TIMER,&bgp->t_rmap_def_originate_eval);}}if(old_select)bgp_info_unse
t_flag(rn,old_select,BGP_INFO_SELECTED);if(new_select){if(debug)zlog_debug("%s:s
ettingSELECTEDflag",__func__);bgp_info_set_flag(rn,new_select,BGP_INFO_SELECTED)
;bgp_info_unset_flag(rn,new_select,BGP_INFO_ATTR_CHANGED);UNSET_FLAG(new_select-
>flags,BGP_INFO_MULTIPATH_CHG);}#ifENABLE_BGP_VNCif((afi==AFI_IP||afi==AFI_IP6)&
&(safi==SAFI_UNICAST)){if(old_select!=new_select){if(old_select){vnc_import_bgp_
exterior_del_route(bgp,p,old_select);vnc_import_bgp_del_route(bgp,p,old_select);
}if(new_select){vnc_import_bgp_exterior_add_route(bgp,p,new_select);vnc_import_b
gp_add_route(bgp,p,new_select);}}}#endifgroup_announce_route(bgp,afi,safi,rn,new
_select);/*unicastroutesmustalsobeannoucedtolabeled-unicastupdate-groups*/if(saf
i==SAFI_UNICAST)group_announce_route(bgp,afi,SAFI_LABELED_UNICAST,rn,new_select)
;/*FIBupdate.*/if(bgp_fibupd_safi(safi)&&(bgp->inst_type!=BGP_INSTANCE_TYPE_VIEW
)&&!bgp_option_check(BGP_OPT_NO_FIB)){if(new_select&&new_select->type==ZEBRA_ROU
TE_BGP&&(new_select->sub_type==BGP_ROUTE_NORMAL||new_select->sub_type==BGP_ROUTE
_AGGREGATE||new_select->sub_type==BGP_ROUTE_IMPORTED))bgp_zebra_announce(rn,p,ne
w_select,bgp,afi,safi);else{/*Withdrawtheroutefromthekernel.*/if(old_select&&old
_select->type==ZEBRA_ROUTE_BGP&&(old_select->sub_type==BGP_ROUTE_NORMAL||old_sel
ect->sub_type==BGP_ROUTE_AGGREGATE||old_select->sub_type==BGP_ROUTE_IMPORTED))bg
p_zebra_withdraw(p,old_select,bgp,safi);}}/*advertise/withdrawtype-5routes*/if((
afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST)){if(advertise_type5_routes(bgp,
afi)&&new_select&&(!new_select->extra||!new_select->extra->parent))bgp_evpn_adve
rtise_type5_route(bgp,&rn->p,new_select->attr,afi,safi);elseif(advertise_type5_r
outes(bgp,afi)&&old_select&&(!old_select->extra||!old_select->extra->parent))bgp
_evpn_withdraw_type5_route(bgp,&rn->p,afi,safi);}/*Clearanyroutechangeflags.*/bg
p_zebra_clear_route_change_flags(rn);/*Reapoldselectbgp_info,ifithasbeenremoved*
/if(old_select&&CHECK_FLAG(old_select->flags,BGP_INFO_REMOVED))bgp_info_reap(rn,
old_select);UNSET_FLAG(rn->flags,BGP_NODE_PROCESS_SCHEDULED);return;}staticwq_it
em_statusbgp_process_wq(structwork_queue*wq,void*data){structbgp_process_queue*p
qnode=data;structbgp*bgp=pqnode->bgp;structbgp_table*table;structbgp_node*rn;/*e
oiumarker*/if(CHECK_FLAG(pqnode->flags,BGP_PROCESS_QUEUE_EOIU_MARKER)){bgp_proce
ss_main_one(bgp,NULL,0,0);/*shouldalwayshavededicatedwqcall*/assert(STAILQ_FIRST
(&pqnode->pqueue)==NULL);returnWQ_SUCCESS;}while(!STAILQ_EMPTY(&pqnode->pqueue))
{rn=STAILQ_FIRST(&pqnode->pqueue);STAILQ_REMOVE_HEAD(&pqnode->pqueue,pq);STAILQ_
NEXT(rn,pq)=NULL;/*completeunlink*/table=bgp_node_table(rn);/*note,newRNsmaybead
dedaspartofprocessing*/bgp_process_main_one(bgp,rn,table->afi,table->safi);bgp_u
nlock_node(rn);bgp_table_unlock(table);}returnWQ_SUCCESS;}staticvoidbgp_processq
_del(structwork_queue*wq,void*data){structbgp_process_queue*pqnode=data;bgp_unlo
ck(pqnode->bgp);XFREE(MTYPE_BGP_PROCESS_QUEUE,pqnode);}voidbgp_process_queue_ini
t(void){if(!bm->process_main_queue){bm->process_main_queue=work_queue_new(bm->ma
ster,"process_main_queue");if(!bm->process_main_queue){zlog_err("%s:Failedtoallo
cateworkqueue",__func__);exit(1);}}bm->process_main_queue->spec.workfunc=&bgp_pr
ocess_wq;bm->process_main_queue->spec.del_item_data=&bgp_processq_del;bm->proces
s_main_queue->spec.max_retries=0;bm->process_main_queue->spec.hold=50;/*Useahigh
eryieldvalueof50msformainqueueprocessing*/bm->process_main_queue->spec.yield=50*
1000L;}staticstructbgp_process_queue*bgp_processq_alloc(structbgp*bgp){structbgp
_process_queue*pqnode;pqnode=XCALLOC(MTYPE_BGP_PROCESS_QUEUE,sizeof(structbgp_pr
ocess_queue));/*unlockedinbgp_processq_del*/pqnode->bgp=bgp_lock(bgp);STAILQ_INI
T(&pqnode->pqueue);returnpqnode;}voidbgp_process(structbgp*bgp,structbgp_node*rn
,afi_tafi,safi_tsafi){#defineARBITRARY_PROCESS_QLEN10000structwork_queue*wq=bm->
process_main_queue;structbgp_process_queue*pqnode;intpqnode_reuse=0;/*alreadysch
eduledforprocessing?*/if(CHECK_FLAG(rn->flags,BGP_NODE_PROCESS_SCHEDULED))return
;if(wq==NULL)return;/*Addroutenodestoanexistingworkqueueitemuntilreachingthelimi
tonlyifisfromthesameBGPviewandit'snotanEOIUmarker*/if(work_queue_item_count(wq))
{structwork_queue_item*item=work_queue_last_item(wq);pqnode=item->data;if(CHECK_
FLAG(pqnode->flags,BGP_PROCESS_QUEUE_EOIU_MARKER)||pqnode->bgp!=bgp||pqnode->que
ued>=ARBITRARY_PROCESS_QLEN)pqnode=bgp_processq_alloc(bgp);elsepqnode_reuse=1;}e
lsepqnode=bgp_processq_alloc(bgp);/*allunlockedinbgp_process_wq*/bgp_table_lock(
bgp_node_table(rn));SET_FLAG(rn->flags,BGP_NODE_PROCESS_SCHEDULED);bgp_lock_node
(rn);/*can'tbeenqueuedtwice*/assert(STAILQ_NEXT(rn,pq)==NULL);STAILQ_INSERT_TAIL
(&pqnode->pqueue,rn,pq);pqnode->queued++;if(!pqnode_reuse)work_queue_add(wq,pqno
de);return;}voidbgp_add_eoiu_mark(structbgp*bgp){structbgp_process_queue*pqnode;
if(bm->process_main_queue==NULL)return;pqnode=bgp_processq_alloc(bgp);SET_FLAG(p
qnode->flags,BGP_PROCESS_QUEUE_EOIU_MARKER);work_queue_add(bm->process_main_queu
e,pqnode);}staticintbgp_maximum_prefix_restart_timer(structthread*thread){struct
peer*peer;peer=THREAD_ARG(thread);peer->t_pmax_restart=NULL;if(bgp_debug_neighbo
r_events(peer))zlog_debug("%sMaximum-prefixrestarttimerexpired,restorepeering",p
eer->host);peer_clear(peer,NULL);return0;}intbgp_maximum_prefix_overflow(structp
eer*peer,afi_tafi,safi_tsafi,intalways){iana_afi_tpkt_afi;iana_safi_tpkt_safi;if
(!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_MAX_PREFIX))return0;if(peer->pc
ount[afi][safi]>peer->pmax[afi][safi]){if(CHECK_FLAG(peer->af_sflags[afi][safi],
PEER_STATUS_PREFIX_LIMIT)&&!always)return0;zlog_info("%%MAXPFXEXCEED:No.of%spref
ixreceivedfrom%s%ldexceed,""limit%ld",afi_safi_print(afi,safi),peer->host,peer->
pcount[afi][safi],peer->pmax[afi][safi]);SET_FLAG(peer->af_sflags[afi][safi],PEE
R_STATUS_PREFIX_LIMIT);if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_MAX_PRE
FIX_WARNING))return0;/*ConvertAFI,SAFItovaluesforpacket.*/pkt_afi=afi_int2iana(a
fi);pkt_safi=safi_int2iana(safi);{uint8_tndata[7];ndata[0]=(pkt_afi>>8);ndata[1]
=pkt_afi;ndata[2]=pkt_safi;ndata[3]=(peer->pmax[afi][safi]>>24);ndata[4]=(peer->
pmax[afi][safi]>>16);ndata[5]=(peer->pmax[afi][safi]>>8);ndata[6]=(peer->pmax[af
i][safi]);SET_FLAG(peer->sflags,PEER_STATUS_PREFIX_OVERFLOW);bgp_notify_send_wit
h_data(peer,BGP_NOTIFY_CEASE,BGP_NOTIFY_CEASE_MAX_PREFIX,ndata,7);}/*Dynamicpeer
swilljustclosetheirconnection.*/if(peer_dynamic_neighbor(peer))return1;/*restart
timerstart*/if(peer->pmax_restart[afi][safi]){peer->v_pmax_restart=peer->pmax_re
start[afi][safi]*60;if(bgp_debug_neighbor_events(peer))zlog_debug("%sMaximum-pre
fixrestarttimerstartedfor%dsecs",peer->host,peer->v_pmax_restart);BGP_TIMER_ON(p
eer->t_pmax_restart,bgp_maximum_prefix_restart_timer,peer->v_pmax_restart);}retu
rn1;}elseUNSET_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_PREFIX_LIMIT);if(peer
->pcount[afi][safi]>(peer->pmax[afi][safi]*peer->pmax_threshold[afi][safi]/100))
{if(CHECK_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_PREFIX_THRESHOLD)&&!always
)return0;zlog_info("%%MAXPFX:No.of%sprefixreceivedfrom%sreaches%ld,max%ld",afi_s
afi_print(afi,safi),peer->host,peer->pcount[afi][safi],peer->pmax[afi][safi]);SE
T_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_PREFIX_THRESHOLD);}elseUNSET_FLAG(
peer->af_sflags[afi][safi],PEER_STATUS_PREFIX_THRESHOLD);return0;}/*Unconditiona
llyremovetheroutefromtheRIB,withouttaking*dampingintoconsideration(eg,becausethe
sessionwentdown)*/voidbgp_rib_remove(structbgp_node*rn,structbgp_info*ri,structp
eer*peer,afi_tafi,safi_tsafi){bgp_aggregate_decrement(peer->bgp,&rn->p,ri,afi,sa
fi);if(!CHECK_FLAG(ri->flags,BGP_INFO_HISTORY))bgp_info_delete(rn,ri);/*keephist
oricalinfo*/bgp_process(peer->bgp,rn,afi,safi);}staticvoidbgp_rib_withdraw(struc
tbgp_node*rn,structbgp_info*ri,structpeer*peer,afi_tafi,safi_tsafi,structprefix_
rd*prd){intstatus=BGP_DAMP_NONE;/*applydampening,ifresultissuppressed,we'llberet
aining*thebgp_infointheRIBforhistoricalreference.*/if(CHECK_FLAG(peer->bgp->af_f
lags[afi][safi],BGP_CONFIG_DAMPENING)&&peer->sort==BGP_PEER_EBGP)if((status=bgp_
damp_withdraw(ri,rn,afi,safi,0))==BGP_DAMP_SUPPRESSED){bgp_aggregate_decrement(p
eer->bgp,&rn->p,ri,afi,safi);return;}#ifENABLE_BGP_VNCif(safi==SAFI_MPLS_VPN){st
ructbgp_node*prn=NULL;structbgp_table*table=NULL;prn=bgp_node_get(peer->bgp->rib
[afi][safi],(structprefix*)prd);if(prn->info){table=(structbgp_table*)(prn->info
);vnc_import_bgp_del_vnc_host_route_mode_resolve_nve(peer->bgp,prd,table,&rn->p,
ri);}bgp_unlock_node(prn);}if((afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST))
{if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)){vnc_import_bgp_del_route(peer->bgp,
&rn->p,ri);vnc_import_bgp_exterior_del_route(peer->bgp,&rn->p,ri);}}#endif/*Ifth
isisanEVPNroute,processforun-import.*/if(safi==SAFI_EVPN)bgp_evpn_unimport_route
(peer->bgp,afi,safi,&rn->p,ri);bgp_rib_remove(rn,ri,peer,afi,safi);}structbgp_in
fo*info_make(inttype,intsub_type,unsignedshortinstance,structpeer*peer,structatt
r*attr,structbgp_node*rn){structbgp_info*new;/*MakenewBGPinfo.*/new=XCALLOC(MTYP
E_BGP_ROUTE,sizeof(structbgp_info));new->type=type;new->instance=instance;new->s
ub_type=sub_type;new->peer=peer;new->attr=attr;new->uptime=bgp_clock();new->net=
rn;new->addpath_tx_id=++peer->bgp->addpath_tx_id;returnnew;}staticvoidoverlay_in
dex_update(structattr*attr,structeth_segment_id*eth_s_id,uniongw_addr*gw_ip){if(
!attr)return;if(eth_s_id==NULL){memset(&(attr->evpn_overlay.eth_s_id),0,sizeof(s
tructeth_segment_id));}else{memcpy(&(attr->evpn_overlay.eth_s_id),eth_s_id,sizeo
f(structeth_segment_id));}if(gw_ip==NULL){memset(&(attr->evpn_overlay.gw_ip),0,s
izeof(uniongw_addr));}else{memcpy(&(attr->evpn_overlay.gw_ip),gw_ip,sizeof(union
gw_addr));}}staticbooloverlay_index_equal(afi_tafi,structbgp_info*info,structeth
_segment_id*eth_s_id,uniongw_addr*gw_ip){structeth_segment_id*info_eth_s_id,*inf
o_eth_s_id_remote;uniongw_addr*info_gw_ip,*info_gw_ip_remote;chartemp[16];if(afi
!=AFI_L2VPN)returntrue;if(!info->attr){memset(&temp,0,16);info_eth_s_id=(structe
th_segment_id*)&temp;info_gw_ip=(uniongw_addr*)&temp;if(eth_s_id==NULL&&gw_ip==N
ULL)returntrue;}else{info_eth_s_id=&(info->attr->evpn_overlay.eth_s_id);info_gw_
ip=&(info->attr->evpn_overlay.gw_ip);}if(gw_ip==NULL)info_gw_ip_remote=(uniongw_
addr*)&temp;elseinfo_gw_ip_remote=gw_ip;if(eth_s_id==NULL)info_eth_s_id_remote=(
structeth_segment_id*)&temp;elseinfo_eth_s_id_remote=eth_s_id;if(!memcmp(info_gw
_ip,info_gw_ip_remote,sizeof(uniongw_addr)))returnfalse;return!memcmp(info_eth_s
_id,info_eth_s_id_remote,sizeof(structeth_segment_id));}/*Checkifreceivednexthop
isvalidornot.*/staticintbgp_update_martian_nexthop(structbgp*bgp,afi_tafi,safi_t
safi,structattr*attr){intret=0;/*Onlyvalidatedforunicastandmulticastcurrently.*/
/*AlsovalidforEVPNwherethenexthopisanIPaddress.*/if(safi!=SAFI_UNICAST&&safi!=SA
FI_MULTICAST&&safi!=SAFI_EVPN)return0;/*IfNEXT_HOPispresent,validateit.*/if(attr
->flag&ATTR_FLAG_BIT(BGP_ATTR_NEXT_HOP)){if(attr->nexthop.s_addr==0||IPV4_CLASS_
DE(ntohl(attr->nexthop.s_addr))||bgp_nexthop_self(bgp,attr->nexthop))return1;}/*
IfMP_NEXTHOPispresent,validateit.*//*Note:ForIPv6nexthops,weonlyvalidatethegloba
l(1st)nexthop;*thereiscodeinbgp_attr.ctoignorethelink-local(2nd)nexthopif*itisno
tanIPv6link-localaddress.*/if(attr->mp_nexthop_len){switch(attr->mp_nexthop_len)
{caseBGP_ATTR_NHLEN_IPV4:caseBGP_ATTR_NHLEN_VPNV4:ret=(attr->mp_nexthop_global_i
n.s_addr==0||IPV4_CLASS_DE(ntohl(attr->mp_nexthop_global_in.s_addr))||bgp_nextho
p_self(bgp,attr->mp_nexthop_global_in));break;caseBGP_ATTR_NHLEN_IPV6_GLOBAL:cas
eBGP_ATTR_NHLEN_IPV6_GLOBAL_AND_LL:caseBGP_ATTR_NHLEN_VPNV6_GLOBAL:ret=(IN6_IS_A
DDR_UNSPECIFIED(&attr->mp_nexthop_global)||IN6_IS_ADDR_LOOPBACK(&attr->mp_nextho
p_global)||IN6_IS_ADDR_MULTICAST(&attr->mp_nexthop_global));break;default:ret=1;
break;}}returnret;}intbgp_update(structpeer*peer,structprefix*p,uint32_taddpath_
id,structattr*attr,afi_tafi,safi_tsafi,inttype,intsub_type,structprefix_rd*prd,m
pls_label_t*label,uint32_tnum_labels,intsoft_reconfig,structbgp_route_evpn*evpn)
{intret;intaspath_loop_count=0;structbgp_node*rn;structbgp*bgp;structattrnew_att
r;structattr*attr_new;structbgp_info*ri;structbgp_info*new;structbgp_info_extra*
extra;constchar*reason;charpfx_buf[BGP_PRD_PATH_STRLEN];intconnected=0;intdo_loo
p_check=1;inthas_valid_label=0;#ifENABLE_BGP_VNCintvnc_implicit_withdraw=0;#endi
fintsame_attr=0;memset(&new_attr,0,sizeof(structattr));new_attr.label_index=BGP_
INVALID_LABEL_INDEX;new_attr.label=MPLS_INVALID_LABEL;bgp=peer->bgp;rn=bgp_afi_n
ode_get(bgp->rib[afi][safi],afi,safi,p,prd);/*TODO:Checktoseeifwecangetridof"is_
valid_label"*/if(afi==AFI_L2VPN&&safi==SAFI_EVPN)has_valid_label=(num_labels>0)?
1:0;elsehas_valid_label=bgp_is_valid_label(label);/*Whenpeer'ssoftreconfiguratio
nenabled.RecordinputpacketinAdj-RIBs-In.*/if(!soft_reconfig&&CHECK_FLAG(peer->af
_flags[afi][safi],PEER_FLAG_SOFT_RECONFIG)&&peer!=bgp->peer_self)bgp_adj_in_set(
rn,peer,attr,addpath_id);/*Checkpreviouslyreceivedroute.*/for(ri=rn->info;ri;ri=
ri->next)if(ri->peer==peer&&ri->type==type&&ri->sub_type==sub_type&&ri->addpath_
rx_id==addpath_id)break;/*ASpathlocal-asloopcheck.*/if(peer->change_local_as){if
(peer->allowas_in[afi][safi])aspath_loop_count=peer->allowas_in[afi][safi];elsei
f(!CHECK_FLAG(peer->flags,PEER_FLAG_LOCAL_AS_NO_PREPEND))aspath_loop_count=1;if(
aspath_loop_check(attr->aspath,peer->change_local_as)>aspath_loop_count){reason=
"as-pathcontainsourownAS;";gotofiltered;}}/*Ifthepeerisconfiguredfor"allowas-ino
rigin"andthelastASNin*the*as-pathisourASNthenwedonotneedtocallaspath_loop_check*
/if(CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_ALLOWAS_IN_ORIGIN))if(aspath_
get_last_as(attr->aspath)==bgp->as)do_loop_check=0;/*ASpathloopcheck.*/if(do_loo
p_check){if(aspath_loop_check(attr->aspath,bgp->as)>peer->allowas_in[afi][safi]|
|(CHECK_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION)&&aspath_loop_check(attr->aspa
th,bgp->confed_id)>peer->allowas_in[afi][safi])){reason="as-pathcontainsourownAS
;";gotofiltered;}}/*RoutereflectororiginatorIDcheck.*/if(attr->flag&ATTR_FLAG_BI
T(BGP_ATTR_ORIGINATOR_ID)&&IPV4_ADDR_SAME(&bgp->router_id,&attr->originator_id))
{reason="originatorisus;";gotofiltered;}/*RoutereflectorclusterIDcheck.*/if(bgp_
cluster_filter(peer,attr)){reason="reflectedfromthesamecluster;";gotofiltered;}/
*Applyincomingfilter.*/if(bgp_input_filter(peer,p,attr,afi,safi)==FILTER_DENY){r
eason="filter;";gotofiltered;}bgp_attr_dup(&new_attr,attr);/*Applyincomingroute-
map.*NB:new_attrmaynowcontainnewlyallocatedvaluesfromroute-map*"set"*commands,so
weneedbgp_attr_flushintheerrorpaths,untilwe*intern*theattr(whichtakesoverthememo
ryreferences)*/if(bgp_input_modifier(peer,p,&new_attr,afi,safi,NULL)==RMAP_DENY)
{reason="route-map;";bgp_attr_flush(&new_attr);gotofiltered;}if(peer->sort==BGP_
PEER_EBGP){/*Ifwereceivethegraceful-shutdowncommunityfromaneBGP*peerwemustlowerl
ocal-preference*/if(new_attr.community&&community_include(new_attr.community,COM
MUNITY_GSHUT)){new_attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);new_attr.local_
pref=BGP_GSHUT_LOCAL_PREF;/*Ifgraceful-shutdownisconfiguredthenaddtheGSHUT*commu
nitytoallpathsreceivedfromeBGPpeers*/}elseif(bgp_flag_check(peer->bgp,BGP_FLAG_G
RACEFUL_SHUTDOWN)){bgp_attr_add_gshut_community(&new_attr);}}/*nexthopcheck.*/if
(!CHECK_FLAG(peer->flags,PEER_FLAG_IS_RFAPI_HD)&&bgp_update_martian_nexthop(bgp,
afi,safi,&new_attr)){reason="martianorselfnext-hop;";bgp_attr_flush(&new_attr);g
otofiltered;}attr_new=bgp_attr_intern(&new_attr);/*Iftheupdateisimplicitwithdraw
.*/if(ri){ri->uptime=bgp_clock();same_attr=attrhash_cmp(ri->attr,attr_new);/*Sam
eattributecomesin.*/if(!CHECK_FLAG(ri->flags,BGP_INFO_REMOVED)&&attrhash_cmp(ri-
>attr,attr_new)&&(!has_valid_label||memcmp(&(bgp_info_extra_get(ri))->label,labe
l,num_labels*sizeof(mpls_label_t))==0)&&(overlay_index_equal(afi,ri,evpn==NULL?N
ULL:&evpn->eth_s_id,evpn==NULL?NULL:&evpn->gw_ip))){if(CHECK_FLAG(bgp->af_flags[
afi][safi],BGP_CONFIG_DAMPENING)&&peer->sort==BGP_PEER_EBGP&&CHECK_FLAG(ri->flag
s,BGP_INFO_HISTORY)){if(bgp_debug_update(peer,p,NULL,1)){bgp_debug_rdpfxpath2str
(afi,safi,prd,p,label,num_labels,addpath_id?1:0,addpath_id,pfx_buf,sizeof(pfx_bu
f));zlog_debug("%srcvd%s",peer->host,pfx_buf);}if(bgp_damp_update(ri,rn,afi,safi
)!=BGP_DAMP_SUPPRESSED){bgp_aggregate_increment(bgp,p,ri,afi,safi);bgp_process(b
gp,rn,afi,safi);}}else/*Duplicate-odd*/{if(bgp_debug_update(peer,p,NULL,1)){if(!
peer->rcvd_attr_printed){zlog_debug("%srcvdUPDATEw/attr:%s",peer->host,peer->rcv
d_attr_str);peer->rcvd_attr_printed=1;}bgp_debug_rdpfxpath2str(afi,safi,prd,p,la
bel,num_labels,addpath_id?1:0,addpath_id,pfx_buf,sizeof(pfx_buf));zlog_debug("%s
rcvd%s...duplicateignored",peer->host,pfx_buf);}/*gracefulrestartSTALEflagunset.
*/if(CHECK_FLAG(ri->flags,BGP_INFO_STALE)){bgp_info_unset_flag(rn,ri,BGP_INFO_ST
ALE);bgp_process(bgp,rn,afi,safi);}}bgp_unlock_node(rn);bgp_attr_unintern(&attr_
new);return0;}/*Withdraw/Announcebeforewefullyprocessedthewithdraw*/if(CHECK_FLA
G(ri->flags,BGP_INFO_REMOVED)){if(bgp_debug_update(peer,p,NULL,1)){bgp_debug_rdp
fxpath2str(afi,safi,prd,p,label,num_labels,addpath_id?1:0,addpath_id,pfx_buf,siz
eof(pfx_buf));zlog_debug("%srcvd%s,flappedquickerthanprocessing",peer->host,pfx_
buf);}bgp_info_restore(rn,ri);}/*ReceivedLogging.*/if(bgp_debug_update(peer,p,NU
LL,1)){bgp_debug_rdpfxpath2str(afi,safi,prd,p,label,num_labels,addpath_id?1:0,ad
dpath_id,pfx_buf,sizeof(pfx_buf));zlog_debug("%srcvd%s",peer->host,pfx_buf);}/*g
racefulrestartSTALEflagunset.*/if(CHECK_FLAG(ri->flags,BGP_INFO_STALE))bgp_info_
unset_flag(rn,ri,BGP_INFO_STALE);/*Theattributeischanged.*/bgp_info_set_flag(rn,
ri,BGP_INFO_ATTR_CHANGED);/*implicitwithdraw,decrementaggregateandpcounthere.*on
lyifupdateisaccepted,they'llincrementbelow.*/bgp_aggregate_decrement(bgp,p,ri,af
i,safi);/*Updatebgproutedampeninginformation.*/if(CHECK_FLAG(bgp->af_flags[afi][
safi],BGP_CONFIG_DAMPENING)&&peer->sort==BGP_PEER_EBGP){/*Thisisimplicitwithdraw
soweshouldupdatedampeninginformation.*/if(!CHECK_FLAG(ri->flags,BGP_INFO_HISTORY
))bgp_damp_withdraw(ri,rn,afi,safi,1);}#ifENABLE_BGP_VNCif(safi==SAFI_MPLS_VPN){
structbgp_node*prn=NULL;structbgp_table*table=NULL;prn=bgp_node_get(bgp->rib[afi
][safi],(structprefix*)prd);if(prn->info){table=(structbgp_table*)(prn->info);vn
c_import_bgp_del_vnc_host_route_mode_resolve_nve(bgp,prd,table,p,ri);}bgp_unlock
_node(prn);}if((afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST)){if(CHECK_FLAG(
ri->flags,BGP_INFO_SELECTED)){/**Implicitwithdrawcase.*/++vnc_implicit_withdraw;
vnc_import_bgp_del_route(bgp,p,ri);vnc_import_bgp_exterior_del_route(bgp,p,ri);}
}#endif/*SpecialhandlingforEVPNupdateofanexistingroute.Ifthe*extendedcommunityat
tributehaschanged,weneedto*un-import*therouteusingitsexistingextendedcommunity.I
twillbe*subsequentlyprocessedforimportwiththenewextended*community.*/if(safi==SA
FI_EVPN&&!same_attr){if((ri->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES))
&&(attr_new->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES))){intcmp;cmp=ecommunit
y_cmp(ri->attr->ecommunity,attr_new->ecommunity);if(!cmp){if(bgp_debug_update(pe
er,p,NULL,1))zlog_debug("ChangeinEXT-COMM,existing%snew%s",ecommunity_str(ri->at
tr->ecommunity),ecommunity_str(attr_new->ecommunity));bgp_evpn_unimport_route(bg
p,afi,safi,p,ri);}}}/*Updatetonewattribute.*/bgp_attr_unintern(&ri->attr);ri->at
tr=attr_new;/*UpdateMPLSlabel*/if(has_valid_label){extra=bgp_info_extra_get(ri);
memcpy(&extra->label,label,num_labels*sizeof(mpls_label_t));extra->num_labels=nu
m_labels;if(!(afi==AFI_L2VPN&&safi==SAFI_EVPN))bgp_set_valid_label(&extra->label
[0]);}#ifENABLE_BGP_VNCif((afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST)){if(
vnc_implicit_withdraw){/**Addbacktheroutewithitsnewattributes*(e.g.,nexthop).*Th
erouteisstillselected,untiltheroute*selection*queuedbybgp_processactuallyruns.We
have*tomakethis*updatetotheVNCsideimmediatelytoavoid*racingagainst*configuration
changes(e.g.,route-map*changes)which*triggerre-importationoftheentireRIB.*/vnc_i
mport_bgp_add_route(bgp,p,ri);vnc_import_bgp_exterior_add_route(bgp,p,ri);}}#end
if/*UpdateOverlayIndex*/if(afi==AFI_L2VPN){overlay_index_update(ri->attr,evpn==N
ULL?NULL:&evpn->eth_s_id,evpn==NULL?NULL:&evpn->gw_ip);}/*Updatebgproutedampenin
ginformation.*/if(CHECK_FLAG(bgp->af_flags[afi][safi],BGP_CONFIG_DAMPENING)&&pee
r->sort==BGP_PEER_EBGP){/*Nowwedonormalupdatedampening.*/ret=bgp_damp_update(ri,
rn,afi,safi);if(ret==BGP_DAMP_SUPPRESSED){bgp_unlock_node(rn);return0;}}/*Nextho
preachabilitycheck-forunicastand*labeled-unicast..*/if((afi==AFI_IP||afi==AFI_IP
6)&&(safi==SAFI_UNICAST||safi==SAFI_LABELED_UNICAST)){if(peer->sort==BGP_PEER_EB
GP&&peer->ttl==1&&!CHECK_FLAG(peer->flags,PEER_FLAG_DISABLE_CONNECTED_CHECK)&&!b
gp_flag_check(bgp,BGP_FLAG_DISABLE_NH_CONNECTED_CHK))connected=1;elseconnected=0
;if(bgp_find_or_add_nexthop(bgp,afi,ri,NULL,connected)||CHECK_FLAG(peer->flags,P
EER_FLAG_IS_RFAPI_HD))bgp_info_set_flag(rn,ri,BGP_INFO_VALID);else{if(BGP_DEBUG(
nht,NHT)){charbuf1[INET6_ADDRSTRLEN];inet_ntop(AF_INET,(constvoid*)&attr_new->ne
xthop,buf1,INET6_ADDRSTRLEN);zlog_debug("%s(%s):NHunresolved",__FUNCTION__,buf1)
;}bgp_info_unset_flag(rn,ri,BGP_INFO_VALID);}}elsebgp_info_set_flag(rn,ri,BGP_IN
FO_VALID);#ifENABLE_BGP_VNCif(safi==SAFI_MPLS_VPN){structbgp_node*prn=NULL;struc
tbgp_table*table=NULL;prn=bgp_node_get(bgp->rib[afi][safi],(structprefix*)prd);i
f(prn->info){table=(structbgp_table*)(prn->info);vnc_import_bgp_add_vnc_host_rou
te_mode_resolve_nve(bgp,prd,table,p,ri);}bgp_unlock_node(prn);}#endif/*Ifthisisa
nEVPNrouteandsomeattributehaschanged,*process*routeforimport.Iftheextendedcommun
ityhaschanged,we*would*havedonetheun-importearlierandtheimportwouldresult*inthe*
routegettinginjectedintoappropriateL2VNIs.Ifitis*just*someotherattributechange,t
heimportwillresultin*updating*theattributesfortherouteintheVNI(s).*/if(safi==SAF
I_EVPN&&!same_attr)bgp_evpn_import_route(bgp,afi,safi,p,ri);/*Processchange.*/bg
p_aggregate_increment(bgp,p,ri,afi,safi);bgp_process(bgp,rn,afi,safi);bgp_unlock
_node(rn);if(SAFI_UNICAST==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bgp->in
st_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_update(bgp_get_default(),
bgp,ri);}if((SAFI_MPLS_VPN==safi)&&(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){
vpn_leak_to_vrf_update(bgp,ri);}#ifENABLE_BGP_VNCif(SAFI_MPLS_VPN==safi){mpls_la
bel_tlabel_decoded=decode_label(label);rfapiProcessUpdate(peer,NULL,p,prd,attr,a
fi,safi,type,sub_type,&label_decoded);}if(SAFI_ENCAP==safi){rfapiProcessUpdate(p
eer,NULL,p,prd,attr,afi,safi,type,sub_type,NULL);}#endifreturn0;}//Endofimplicit
withdraw/*ReceivedLogging.*/if(bgp_debug_update(peer,p,NULL,1)){if(!peer->rcvd_a
ttr_printed){zlog_debug("%srcvdUPDATEw/attr:%s",peer->host,peer->rcvd_attr_str);
peer->rcvd_attr_printed=1;}bgp_debug_rdpfxpath2str(afi,safi,prd,p,label,num_labe
ls,addpath_id?1:0,addpath_id,pfx_buf,sizeof(pfx_buf));zlog_debug("%srcvd%s",peer
->host,pfx_buf);}/*MakenewBGPinfo.*/new=info_make(type,sub_type,0,peer,attr_new,
rn);/*UpdateMPLSlabel*/if(has_valid_label){extra=bgp_info_extra_get(new);memcpy(
&extra->label,label,num_labels*sizeof(mpls_label_t));extra->num_labels=num_label
s;if(!(afi==AFI_L2VPN&&safi==SAFI_EVPN))bgp_set_valid_label(&extra->label[0]);}/
*UpdateOverlayIndex*/if(afi==AFI_L2VPN){overlay_index_update(new->attr,evpn==NUL
L?NULL:&evpn->eth_s_id,evpn==NULL?NULL:&evpn->gw_ip);}/*Nexthopreachabilitycheck
.*/if((afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST||safi==SAFI_LABELED_UNICA
ST)){if(peer->sort==BGP_PEER_EBGP&&peer->ttl==1&&!CHECK_FLAG(peer->flags,PEER_FL
AG_DISABLE_CONNECTED_CHECK)&&!bgp_flag_check(bgp,BGP_FLAG_DISABLE_NH_CONNECTED_C
HK))connected=1;elseconnected=0;if(bgp_find_or_add_nexthop(bgp,afi,new,NULL,conn
ected)||CHECK_FLAG(peer->flags,PEER_FLAG_IS_RFAPI_HD))bgp_info_set_flag(rn,new,B
GP_INFO_VALID);else{if(BGP_DEBUG(nht,NHT)){charbuf1[INET6_ADDRSTRLEN];inet_ntop(
AF_INET,(constvoid*)&attr_new->nexthop,buf1,INET6_ADDRSTRLEN);zlog_debug("%s(%s)
:NHunresolved",__FUNCTION__,buf1);}bgp_info_unset_flag(rn,new,BGP_INFO_VALID);}}
elsebgp_info_set_flag(rn,new,BGP_INFO_VALID);/*AddpathID*/new->addpath_rx_id=add
path_id;/*Incrementprefix*/bgp_aggregate_increment(bgp,p,new,afi,safi);/*Registe
rnewBGPinformation.*/bgp_info_add(rn,new);/*route_node_getlock*/bgp_unlock_node(
rn);#ifENABLE_BGP_VNCif(safi==SAFI_MPLS_VPN){structbgp_node*prn=NULL;structbgp_t
able*table=NULL;prn=bgp_node_get(bgp->rib[afi][safi],(structprefix*)prd);if(prn-
>info){table=(structbgp_table*)(prn->info);vnc_import_bgp_add_vnc_host_route_mod
e_resolve_nve(bgp,prd,table,p,new);}bgp_unlock_node(prn);}#endif/*Ifmaximumprefi
xcountisconfiguredandcurrentprefixcountexeedit.*/if(bgp_maximum_prefix_overflow(
peer,afi,safi,0))return-1;/*IfthisisanEVPNroute,processforimport.*/if(safi==SAFI
_EVPN)bgp_evpn_import_route(bgp,afi,safi,p,new);/*Processchange.*/bgp_process(bg
p,rn,afi,safi);if(SAFI_UNICAST==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bg
p->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_update(bgp_get_defau
lt(),bgp,new);}if((SAFI_MPLS_VPN==safi)&&(bgp->inst_type==BGP_INSTANCE_TYPE_DEFA
ULT)){vpn_leak_to_vrf_update(bgp,new);}#ifENABLE_BGP_VNCif(SAFI_MPLS_VPN==safi){
mpls_label_tlabel_decoded=decode_label(label);rfapiProcessUpdate(peer,NULL,p,prd
,attr,afi,safi,type,sub_type,&label_decoded);}if(SAFI_ENCAP==safi){rfapiProcessU
pdate(peer,NULL,p,prd,attr,afi,safi,type,sub_type,NULL);}#endifreturn0;/*ThisBGP
updateisfiltered.LogthereasonthenupdateBGPentry.*/filtered:if(bgp_debug_update(p
eer,p,NULL,1)){if(!peer->rcvd_attr_printed){zlog_debug("%srcvdUPDATEw/attr:%s",p
eer->host,peer->rcvd_attr_str);peer->rcvd_attr_printed=1;}bgp_debug_rdpfxpath2st
r(afi,safi,prd,p,label,num_labels,addpath_id?1:0,addpath_id,pfx_buf,sizeof(pfx_b
uf));zlog_debug("%srcvdUPDATEabout%s--DENIEDdueto:%s",peer->host,pfx_buf,reason)
;}if(ri){/*IfthisisanEVPNroute,un-importitasitisnowfiltered.*/if(safi==SAFI_EVPN
)bgp_evpn_unimport_route(bgp,afi,safi,p,ri);if(SAFI_UNICAST==safi&&(bgp->inst_ty
pe==BGP_INSTANCE_TYPE_VRF||bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_
from_vrf_withdraw(bgp_get_default(),bgp,ri);}if((SAFI_MPLS_VPN==safi)&&(bgp->ins
t_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_to_vrf_withdraw(bgp,ri);}bgp_rib_re
move(rn,ri,peer,afi,safi);}bgp_unlock_node(rn);#ifENABLE_BGP_VNC/**Filteredupdat
eistreatedasanimplicitwithdrawal(see*bgp_rib_remove()*afewlinesabove)*/if((SAFI_
MPLS_VPN==safi)||(SAFI_ENCAP==safi)){rfapiProcessWithdraw(peer,NULL,p,prd,NULL,a
fi,safi,type,0);}#endifreturn0;}intbgp_withdraw(structpeer*peer,structprefix*p,u
int32_taddpath_id,structattr*attr,afi_tafi,safi_tsafi,inttype,intsub_type,struct
prefix_rd*prd,mpls_label_t*label,uint32_tnum_labels,structbgp_route_evpn*evpn){s
tructbgp*bgp;charpfx_buf[BGP_PRD_PATH_STRLEN];structbgp_node*rn;structbgp_info*r
i;#ifENABLE_BGP_VNCif((SAFI_MPLS_VPN==safi)||(SAFI_ENCAP==safi)){rfapiProcessWit
hdraw(peer,NULL,p,prd,NULL,afi,safi,type,0);}#endifbgp=peer->bgp;/*Lookupnode.*/
rn=bgp_afi_node_get(bgp->rib[afi][safi],afi,safi,p,prd);/*Ifpeerissoftreconfigur
ationenabled.Recordinputpacketfor*furthercalculation.**CiscoIOS12.4(24)T4onsessi
onestablishmentsendswithdrawsforall*routesthatarefiltered.ThistanksoutQuaggaRSpr
ettybadlydue*to*theiterationoverallRSclients.*Sinceweneedtoremovetheentryfromadj
_inanyway,dothatfirst*and*iftherewasnoentry,wedon'tneedtodoanythingmore.*/if(CHE
CK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_SOFT_RECONFIG)&&peer!=bgp->peer_self
)if(!bgp_adj_in_unset(rn,peer,addpath_id)){if(bgp_debug_update(peer,p,NULL,1)){b
gp_debug_rdpfxpath2str(afi,safi,prd,p,label,num_labels,addpath_id?1:0,addpath_id
,pfx_buf,sizeof(pfx_buf));zlog_debug("%swithdrawingroute%snotinadj-in",peer->hos
t,pfx_buf);}bgp_unlock_node(rn);return0;}/*Lookupwithdrawnroute.*/for(ri=rn->inf
o;ri;ri=ri->next)if(ri->peer==peer&&ri->type==type&&ri->sub_type==sub_type&&ri->
addpath_rx_id==addpath_id)break;/*Logging.*/if(bgp_debug_update(peer,p,NULL,1)){
bgp_debug_rdpfxpath2str(afi,safi,prd,p,label,num_labels,addpath_id?1:0,addpath_i
d,pfx_buf,sizeof(pfx_buf));zlog_debug("%srcvdUPDATEabout%s--withdrawn",peer->hos
t,pfx_buf);}/*Withdrawspecifiedroutefromroutingtable.*/if(ri&&!CHECK_FLAG(ri->fl
ags,BGP_INFO_HISTORY)){bgp_rib_withdraw(rn,ri,peer,afi,safi,prd);if(SAFI_UNICAST
==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bgp->inst_type==BGP_INSTANCE_TYP
E_DEFAULT)){vpn_leak_from_vrf_withdraw(bgp_get_default(),bgp,ri);}if((SAFI_MPLS_
VPN==safi)&&(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_to_vrf_withdra
w(bgp,ri);}}elseif(bgp_debug_update(peer,p,NULL,1)){bgp_debug_rdpfxpath2str(afi,
safi,prd,p,label,num_labels,addpath_id?1:0,addpath_id,pfx_buf,sizeof(pfx_buf));z
log_debug("%sCan'tfindtheroute%s",peer->host,pfx_buf);}/*Unlockbgp_node_get()loc
k.*/bgp_unlock_node(rn);return0;}voidbgp_default_originate(structpeer*peer,afi_t
afi,safi_tsafi,intwithdraw){structupdate_subgroup*subgrp;subgrp=peer_subgroup(pe
er,afi,safi);subgroup_default_originate(subgrp,withdraw);}/**bgp_stop_announce_r
oute_timer*/voidbgp_stop_announce_route_timer(structpeer_af*paf){if(!paf->t_anno
unce_route)return;THREAD_TIMER_OFF(paf->t_announce_route);}/**bgp_announce_route
_timer_expired**Callbackthatisinvokedwhentherouteannouncementtimerfora*peer_afex
pires.*/staticintbgp_announce_route_timer_expired(structthread*t){structpeer_af*
paf;structpeer*peer;paf=THREAD_ARG(t);peer=paf->peer;if(peer->status!=Establishe
d)return0;if(!peer->afc_nego[paf->afi][paf->safi])return0;peer_af_announce_route
(paf,1);return0;}/**bgp_announce_route***Triggers*announcementofroutesofagivenAF
I/SAFItoapeer.*/voidbgp_announce_route(structpeer*peer,afi_tafi,safi_tsafi){stru
ctpeer_af*paf;structupdate_subgroup*subgrp;paf=peer_af_find(peer,afi,safi);if(!p
af)return;subgrp=PAF_SUBGRP(paf);/**Ignoreifsubgroupdoesn'texist(impliesAFisnotn
egotiated)*orarefreshhasalreadybeentriggered.*/if(!subgrp||paf->t_announce_route
)return;/**Startatimertostagger/delaytheannounce.Thisserves*twopurposes-announce
mentcanpotentiallybecombinedfor*multiplepeersandtheannouncementdoesn'thappeninth
e*vtycontext.*/thread_add_timer_msec(bm->master,bgp_announce_route_timer_expired
,paf,(subgrp->peer_count==1)?BGP_ANNOUNCE_ROUTE_SHORT_DELAY_MS:BGP_ANNOUNCE_ROUT
E_DELAY_MS,&paf->t_announce_route);}/**AnnounceroutesfromallAFtablestoapeer.**Th
isshouldONLYbecalledwhenthereisaneedtorefreshthe*routestothepeerbasedonapolicych
angeforthispeeralone*orarouterefreshrequestreceivedfromthepeer.*Theoperationwill
resultinsplittingthepeerfromitsexisting*subgroupsandputtingitinnewsubgroups.*/vo
idbgp_announce_route_all(structpeer*peer){afi_tafi;safi_tsafi;FOREACH_AFI_SAFI(a
fi,safi)bgp_announce_route(peer,afi,safi);}staticvoidbgp_soft_reconfig_table(str
uctpeer*peer,afi_tafi,safi_tsafi,structbgp_table*table,structprefix_rd*prd){intr
et;structbgp_node*rn;structbgp_adj_in*ain;if(!table)table=peer->bgp->rib[afi][sa
fi];for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn))for(ain=rn->adj_in;ain;
ain=ain->next){if(ain->peer!=peer)continue;structbgp_info*ri=rn->info;uint32_tnu
m_labels=0;mpls_label_t*label_pnt=NULL;if(ri&&ri->extra)num_labels=ri->extra->nu
m_labels;if(num_labels)label_pnt=&ri->extra->label[0];ret=bgp_update(peer,&rn->p
,ain->addpath_rx_id,ain->attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,prd,labe
l_pnt,num_labels,1,NULL);if(ret<0){bgp_unlock_node(rn);return;}}}voidbgp_soft_re
config_in(structpeer*peer,afi_tafi,safi_tsafi){structbgp_node*rn;structbgp_table
*table;if(peer->status!=Established)return;if((safi!=SAFI_MPLS_VPN)&&(safi!=SAFI
_ENCAP)&&(safi!=SAFI_EVPN))bgp_soft_reconfig_table(peer,afi,safi,NULL,NULL);else
for(rn=bgp_table_top(peer->bgp->rib[afi][safi]);rn;rn=bgp_route_next(rn))if((tab
le=rn->info)!=NULL){structprefix_rdprd;prd.family=AF_UNSPEC;prd.prefixlen=64;mem
cpy(&prd.val,rn->p.u.val,8);bgp_soft_reconfig_table(peer,afi,safi,table,&prd);}}
structbgp_clear_node_queue{structbgp_node*rn;};staticwq_item_statusbgp_clear_rou
te_node(structwork_queue*wq,void*data){structbgp_clear_node_queue*cnq=data;struc
tbgp_node*rn=cnq->rn;structpeer*peer=wq->spec.data;structbgp_info*ri;structbgp*b
gp;afi_tafi=bgp_node_table(rn)->afi;safi_tsafi=bgp_node_table(rn)->safi;assert(r
n&&peer);bgp=peer->bgp;/*Itispossiblethatwehavemultiplepathsforaprefixfromapeer*
ifthatpeerisusingAddPath.*/for(ri=rn->info;ri;ri=ri->next){if(ri->peer!=peer)con
tinue;/*gracefulrestartSTALEflagset.*/if(CHECK_FLAG(peer->sflags,PEER_STATUS_NSF
_WAIT)&&peer->nsf[afi][safi]&&!CHECK_FLAG(ri->flags,BGP_INFO_STALE)&&!CHECK_FLAG
(ri->flags,BGP_INFO_UNUSEABLE))bgp_info_set_flag(rn,ri,BGP_INFO_STALE);else{/*If
thisisanEVPNroute,processfor*un-import.*/if(safi==SAFI_EVPN)bgp_evpn_unimport_ro
ute(bgp,afi,safi,&rn->p,ri);/*HandlewithdrawforVRFroute-leakingandL3VPN*/if(SAFI
_UNICAST==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bgp->inst_type==BGP_INST
ANCE_TYPE_DEFAULT))vpn_leak_from_vrf_withdraw(bgp_get_default(),bgp,ri);if(SAFI_
MPLS_VPN==safi&&bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)vpn_leak_to_vrf_withdr
aw(bgp,ri);bgp_rib_remove(rn,ri,peer,afi,safi);}}returnWQ_SUCCESS;}staticvoidbgp
_clear_node_queue_del(structwork_queue*wq,void*data){structbgp_clear_node_queue*
cnq=data;structbgp_node*rn=cnq->rn;structbgp_table*table=bgp_node_table(rn);bgp_
unlock_node(rn);bgp_table_unlock(table);XFREE(MTYPE_BGP_CLEAR_NODE_QUEUE,cnq);}s
taticvoidbgp_clear_node_complete(structwork_queue*wq){structpeer*peer=wq->spec.d
ata;/*TickleFSMtostartmovingagain*/BGP_EVENT_ADD(peer,Clearing_Completed);peer_u
nlock(peer);/*bgp_clear_route*/}staticvoidbgp_clear_node_queue_init(structpeer*p
eer){charwname[sizeof("clearxxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx")];snprintf(
wname,sizeof(wname),"clear%s",peer->host);#undefCLEAR_QUEUE_NAME_LENif((peer->cl
ear_node_queue=work_queue_new(bm->master,wname))==NULL){zlog_err("%s:Failedtoall
ocateworkqueue",__func__);exit(1);}peer->clear_node_queue->spec.hold=10;peer->cl
ear_node_queue->spec.workfunc=&bgp_clear_route_node;peer->clear_node_queue->spec
.del_item_data=&bgp_clear_node_queue_del;peer->clear_node_queue->spec.completion
_func=&bgp_clear_node_complete;peer->clear_node_queue->spec.max_retries=0;/*weon
ly'lock'thispeerreferencewhenthequeueisactuallyactive*/peer->clear_node_queue->s
pec.data=peer;}staticvoidbgp_clear_route_table(structpeer*peer,afi_tafi,safi_tsa
fi,structbgp_table*table){structbgp_node*rn;intforce=bm->process_main_queue?0:1;
if(!table)table=peer->bgp->rib[afi][safi];/*Ifstillnotable=>afi/safiisn'tconfigu
redatallorsmth.*/if(!table)return;for(rn=bgp_table_top(table);rn;rn=bgp_route_ne
xt(rn)){structbgp_info*ri,*next;structbgp_adj_in*ain;structbgp_adj_in*ain_next;/
*XXX:TODO:Thisissuboptimal,everynon-emptyroute_nodeis*queuedforeveryclearingpeer
,regardlessofwhetheritis*relevanttothepeerathand.**Overview:Thereare3differentin
diceswhichneedtobe*scrubbed,potentially,whenapeerisremoved:**1peer'sroutesvisibl
eviatheRIB(ieacceptedroutes)*2peer'sroutesvisiblebythe(optional)peer'sadj-ininde
x*3otherroutesvisiblebythepeer'sadj-outindex**3thereisnohurryinscrubbing,oncethe
structpeeris*removedfrombgp->peer,wecouldjustGCsuchdeletedpeer's*adj-outsatourle
isure.**1and2mustbe'scrubbed'insomeway,atleastmade*invisibleviaRIBindexbeforepee
rsessionisallowedtobe*broughtbackup.Sooneneedstoknowwhensucha'search'is*complete
.**Ideally:**-there'dbeasingleglobalqueueorasingleRIBwalker*-ratherthantrackingw
hichroute_nodesstillneedtobe*examinedonapeerbasis,we'dtrackwhichpeersstill*aren'
tcleared**Giventhatourper-peerprefix-countsnowshouldbereliable,*thismayactuallyb
eachievable.Itdoesn'tseemtobeahuge*problematthistime,**Itispossiblethatwehavemul
tiplepathsforaprefixfrom*apeer*ifthatpeerisusingAddPath.*/ain=rn->adj_in;while(a
in){ain_next=ain->next;if(ain->peer==peer){bgp_adj_in_remove(rn,ain);bgp_unlock_
node(rn);}ain=ain_next;}for(ri=rn->info;ri;ri=next){next=ri->next;if(ri->peer!=p
eer)continue;if(force)bgp_info_reap(rn,ri);else{structbgp_clear_node_queue*cnq;/
*bothunlockedinbgp_clear_node_queue_del*/bgp_table_lock(bgp_node_table(rn));bgp_
lock_node(rn);cnq=XCALLOC(MTYPE_BGP_CLEAR_NODE_QUEUE,sizeof(structbgp_clear_node
_queue));cnq->rn=rn;work_queue_add(peer->clear_node_queue,cnq);break;}}}return;}
voidbgp_clear_route(structpeer*peer,afi_tafi,safi_tsafi){structbgp_node*rn;struc
tbgp_table*table;if(peer->clear_node_queue==NULL)bgp_clear_node_queue_init(peer)
;/*bgp_fsm.ckeepssessionsinstateClearing,nottransitioningto*Idleuntilitreceivesa
Clearing_Completedevent.Thisprotects*againstpeerswhichflapfasterthanwecanweclear
,whichcould*leadto:**a)racewithroutesfromthenewsessionbeinginstalledbefore*clear
_route_nodevisitsthenode(todeletetherouteofthat*peer)*b)resourceexhaustion,clear
_route_nodelikelyleadstoanentry*ontheprocess_mainqueue.Fast-flappingcouldcauseth
atqueue*togrowandgrow.*//*lockpeerinassumptionthatclear-node-queuewillgetnodes;i
fso,*theunlockwillhappenuponwork-queuecompletion;otherwise,the*unlockhappensatth
eendofthisfunction.*/if(!peer->clear_node_queue->thread)peer_lock(peer);if(safi!
=SAFI_MPLS_VPN&&safi!=SAFI_ENCAP&&safi!=SAFI_EVPN)bgp_clear_route_table(peer,afi
,safi,NULL);elsefor(rn=bgp_table_top(peer->bgp->rib[afi][safi]);rn;rn=bgp_route_
next(rn))if((table=rn->info)!=NULL)bgp_clear_route_table(peer,afi,safi,table);/*
unlockifnonodesgotaddedtotheclear-node-queue.*/if(!peer->clear_node_queue->threa
d)peer_unlock(peer);}voidbgp_clear_route_all(structpeer*peer){afi_tafi;safi_tsaf
i;FOREACH_AFI_SAFI(afi,safi)bgp_clear_route(peer,afi,safi);#ifENABLE_BGP_VNCrfap
iProcessPeerDown(peer);#endif}voidbgp_clear_adj_in(structpeer*peer,afi_tafi,safi
_tsafi){structbgp_table*table;structbgp_node*rn;structbgp_adj_in*ain;structbgp_a
dj_in*ain_next;table=peer->bgp->rib[afi][safi];/*Itispossiblethatwehavemultiplep
athsforaprefixfromapeer*ifthatpeerisusingAddPath.*/for(rn=bgp_table_top(table);r
n;rn=bgp_route_next(rn)){ain=rn->adj_in;while(ain){ain_next=ain->next;if(ain->pe
er==peer){bgp_adj_in_remove(rn,ain);bgp_unlock_node(rn);}ain=ain_next;}}}voidbgp
_clear_stale_route(structpeer*peer,afi_tafi,safi_tsafi){structbgp_node*rn;struct
bgp_info*ri;structbgp_table*table;if(safi==SAFI_MPLS_VPN){for(rn=bgp_table_top(p
eer->bgp->rib[afi][safi]);rn;rn=bgp_route_next(rn)){structbgp_node*rm;structbgp_
info*ri;/*lookforneighborintables*/if((table=rn->info)==NULL)continue;for(rm=bgp
_table_top(table);rm;rm=bgp_route_next(rm))for(ri=rm->info;ri;ri=ri->next){if(ri
->peer!=peer)continue;if(!CHECK_FLAG(ri->flags,BGP_INFO_STALE))break;bgp_rib_rem
ove(rm,ri,peer,afi,safi);break;}}}else{for(rn=bgp_table_top(peer->bgp->rib[afi][
safi]);rn;rn=bgp_route_next(rn))for(ri=rn->info;ri;ri=ri->next){if(ri->peer!=pee
r)continue;if(!CHECK_FLAG(ri->flags,BGP_INFO_STALE))break;bgp_rib_remove(rn,ri,p
eer,afi,safi);break;}}}staticvoidbgp_cleanup_table(structbgp*bgp,structbgp_table
*table,safi_tsafi){structbgp_node*rn;structbgp_info*ri;structbgp_info*next;for(r
n=bgp_table_top(table);rn;rn=bgp_route_next(rn))for(ri=rn->info;ri;ri=next){next
=ri->next;if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)&&ri->type==ZEBRA_ROUTE_BGP&
&(ri->sub_type==BGP_ROUTE_NORMAL||ri->sub_type==BGP_ROUTE_AGGREGATE||ri->sub_typ
e==BGP_ROUTE_IMPORTED)){if(bgp_fibupd_safi(safi))bgp_zebra_withdraw(&rn->p,ri,bg
p,safi);bgp_info_reap(rn,ri);}}}/*Deleteallkernelroutes.*/voidbgp_cleanup_routes
(structbgp*bgp){afi_tafi;structbgp_node*rn;for(afi=AFI_IP;afi<AFI_MAX;++afi){if(
afi==AFI_L2VPN)continue;bgp_cleanup_table(bgp,bgp->rib[afi][SAFI_UNICAST],SAFI_U
NICAST);/**VPNandENCAPandEVPNtablesaretwo-level(RDistoplevel)*/if(afi!=AFI_L2VPN
){safi_tsafi;safi=SAFI_MPLS_VPN;for(rn=bgp_table_top(bgp->rib[afi][safi]);rn;rn=
bgp_route_next(rn)){if(rn->info){bgp_cleanup_table(bgp,(structbgp_table*)(rn->in
fo),safi);bgp_table_finish((structbgp_table**)&(rn->info));rn->info=NULL;bgp_unl
ock_node(rn);}}safi=SAFI_ENCAP;for(rn=bgp_table_top(bgp->rib[afi][safi]);rn;rn=b
gp_route_next(rn)){if(rn->info){bgp_cleanup_table(bgp,(structbgp_table*)(rn->inf
o),safi);bgp_table_finish((structbgp_table**)&(rn->info));rn->info=NULL;bgp_unlo
ck_node(rn);}}}}for(rn=bgp_table_top(bgp->rib[AFI_L2VPN][SAFI_EVPN]);rn;rn=bgp_r
oute_next(rn)){if(rn->info){bgp_cleanup_table(bgp,(structbgp_table*)(rn->info),S
AFI_EVPN);bgp_table_finish((structbgp_table**)&(rn->info));rn->info=NULL;bgp_unl
ock_node(rn);}}}voidbgp_reset(void){vty_reset();bgp_zclient_reset();access_list_
reset();prefix_list_reset();}staticintbgp_addpath_encode_rx(structpeer*peer,afi_
tafi,safi_tsafi){return(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_R
X_ADV)&&CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ADDPATH_AF_TX_RCV));}/*Parse
NLRIstream.WithdrawNLRIisrecognizedbyNULLattrvalue.*/intbgp_nlri_parse_ip(struct
peer*peer,structattr*attr,structbgp_nlri*packet){uint8_t*pnt;uint8_t*lim;structp
refixp;intpsize;intret;afi_tafi;safi_tsafi;intaddpath_encoded;uint32_taddpath_id
;pnt=packet->nlri;lim=pnt+packet->length;afi=packet->afi;safi=packet->safi;addpa
th_id=0;addpath_encoded=bgp_addpath_encode_rx(peer,afi,safi);/*RFC47716.3TheNLRI
fieldintheUPDATEmessageischeckedforsyntacticvalidity.Ifthefieldissyntacticallyin
correct,thentheErrorSubcodeissettoInvalidNetworkField.*/for(;pnt<lim;pnt+=psize)
{/*Clearprefixstructure.*/memset(&p,0,sizeof(structprefix));if(addpath_encoded){
/*Whenpacketoverflowoccursreturnimmediately.*/if(pnt+BGP_ADDPATH_ID_LEN>lim)retu
rn-1;addpath_id=ntohl(*((uint32_t*)pnt));pnt+=BGP_ADDPATH_ID_LEN;}/*Fetchprefixl
ength.*/p.prefixlen=*pnt++;/*afi/safivalidityalreadyverifiedbycaller,*bgp_update
_receive*/p.family=afi2family(afi);/*Prefixlengthcheck.*/if(p.prefixlen>prefix_b
len(&p)*8){zlog_err("%s[Error]Updatepacketerror(wrongperfixlength%dforafi%u)",pe
er->host,p.prefixlen,packet->afi);return-1;}/*Packetsizeoverflowcheck.*/psize=PS
IZE(p.prefixlen);/*Whenpacketoverflowoccurreturnimmediately.*/if(pnt+psize>lim){
zlog_err("%s[Error]Updatepacketerror(prefixlength%doverflowspacket)",peer->host,
p.prefixlen);return-1;}/*Defensivecoding,double-checkthepsizefitsinastruct*prefi
x*/if(psize>(ssize_t)sizeof(p.u)){zlog_err("%s[Error]Updatepacketerror(prefixlen
gth%dtoolargeforprefixstorage%zu)",peer->host,p.prefixlen,sizeof(p.u));return-1;
}/*FetchprefixfromNLRIpacket.*/memcpy(&p.u.prefix,pnt,psize);/*Checkaddress.*/if
(afi==AFI_IP&&safi==SAFI_UNICAST){if(IN_CLASSD(ntohl(p.u.prefix4.s_addr))){/*Fro
mRFC4271Section6.3:**IfaprefixintheNLRIfieldissemantically*incorrect*(e.g.,anune
xpectedmulticastIPaddress),*anerrorSHOULD*beloggedlocally,andtheprefixSHOULDbe*i
gnored.*/zlog_err("%s:IPv4unicastNLRIismulticastaddress%s,ignoring",peer->host,i
net_ntoa(p.u.prefix4));continue;}}/*Checkaddress.*/if(afi==AFI_IP6&&safi==SAFI_U
NICAST){if(IN6_IS_ADDR_LINKLOCAL(&p.u.prefix6)){charbuf[BUFSIZ];zlog_err("%s:IPv
6unicastNLRIislink-localaddress%s,ignoring",peer->host,inet_ntop(AF_INET6,&p.u.p
refix6,buf,BUFSIZ));continue;}if(IN6_IS_ADDR_MULTICAST(&p.u.prefix6)){charbuf[BU
FSIZ];zlog_err("%s:IPv6unicastNLRIismulticastaddress%s,ignoring",peer->host,inet
_ntop(AF_INET6,&p.u.prefix6,buf,BUFSIZ));continue;}}/*Normalprocess.*/if(attr)re
t=bgp_update(peer,&p,addpath_id,attr,afi,safi,ZEBRA_ROUTE_BGP,BGP_ROUTE_NORMAL,N
ULL,NULL,0,0,NULL);elseret=bgp_withdraw(peer,&p,addpath_id,attr,afi,safi,ZEBRA_R
OUTE_BGP,BGP_ROUTE_NORMAL,NULL,NULL,0,NULL);/*Addressfamilyconfigurationmismatch
ormaximum-prefixcountoverflow.*/if(ret<0)return-1;}/*Packetlengthconsistencychec
k.*/if(pnt!=lim){zlog_err("%s[Error]Updatepacketerror(prefixlengthmismatchwithto
tallength)",peer->host);return-1;}return0;}staticstructbgp_static*bgp_static_new
(void){returnXCALLOC(MTYPE_BGP_STATIC,sizeof(structbgp_static));}staticvoidbgp_s
tatic_free(structbgp_static*bgp_static){if(bgp_static->rmap.name)XFREE(MTYPE_ROU
TE_MAP_NAME,bgp_static->rmap.name);if(bgp_static->eth_s_id)XFREE(MTYPE_ATTR,bgp_
static->eth_s_id);XFREE(MTYPE_BGP_STATIC,bgp_static);}voidbgp_static_update(stru
ctbgp*bgp,structprefix*p,structbgp_static*bgp_static,afi_tafi,safi_tsafi){struct
bgp_node*rn;structbgp_info*ri;structbgp_info*new;structbgp_infoinfo;structattrat
tr;structattr*attr_new;intret;#ifENABLE_BGP_VNCintvnc_implicit_withdraw=0;#endif
assert(bgp_static);if(!bgp_static)return;rn=bgp_afi_node_get(bgp->rib[afi][safi]
,afi,safi,p,NULL);bgp_attr_default_set(&attr,BGP_ORIGIN_IGP);attr.nexthop=bgp_st
atic->igpnexthop;attr.med=bgp_static->igpmetric;attr.flag|=ATTR_FLAG_BIT(BGP_ATT
R_MULTI_EXIT_DISC);if(bgp_static->atomic)attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_ATOMI
C_AGGREGATE);/*Storelabelindex,ifrequired.*/if(bgp_static->label_index!=BGP_INVA
LID_LABEL_INDEX){attr.label_index=bgp_static->label_index;attr.flag|=ATTR_FLAG_B
IT(BGP_ATTR_PREFIX_SID);}/*Applyroute-map.*/if(bgp_static->rmap.name){structattr
attr_tmp=attr;info.peer=bgp->peer_self;info.attr=&attr_tmp;SET_FLAG(bgp->peer_se
lf->rmap_type,PEER_RMAP_TYPE_NETWORK);ret=route_map_apply(bgp_static->rmap.map,p
,RMAP_BGP,&info);bgp->peer_self->rmap_type=0;if(ret==RMAP_DENYMATCH){/*Freeunint
ernedattribute.*/bgp_attr_flush(&attr_tmp);/*Uninternoriginal.*/aspath_unintern(
&attr.aspath);bgp_static_withdraw(bgp,p,afi,safi);return;}if(bgp_flag_check(bgp,
BGP_FLAG_GRACEFUL_SHUTDOWN))bgp_attr_add_gshut_community(&attr_tmp);attr_new=bgp
_attr_intern(&attr_tmp);}else{if(bgp_flag_check(bgp,BGP_FLAG_GRACEFUL_SHUTDOWN))
bgp_attr_add_gshut_community(&attr);attr_new=bgp_attr_intern(&attr);}for(ri=rn->
info;ri;ri=ri->next)if(ri->peer==bgp->peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->
sub_type==BGP_ROUTE_STATIC)break;if(ri){if(attrhash_cmp(ri->attr,attr_new)&&!CHE
CK_FLAG(ri->flags,BGP_INFO_REMOVED)&&!bgp_flag_check(bgp,BGP_FLAG_FORCE_STATIC_P
ROCESS)){bgp_unlock_node(rn);bgp_attr_unintern(&attr_new);aspath_unintern(&attr.
aspath);return;}else{/*Theattributeischanged.*/bgp_info_set_flag(rn,ri,BGP_INFO_
ATTR_CHANGED);/*RewriteBGProuteinformation.*/if(CHECK_FLAG(ri->flags,BGP_INFO_RE
MOVED))bgp_info_restore(rn,ri);elsebgp_aggregate_decrement(bgp,p,ri,afi,safi);#i
fENABLE_BGP_VNCif((afi==AFI_IP||afi==AFI_IP6)&&(safi==SAFI_UNICAST)){if(CHECK_FL
AG(ri->flags,BGP_INFO_SELECTED)){/**Implicitwithdrawcase.*Wehavetodothisbeforeri
is*changed*/++vnc_implicit_withdraw;vnc_import_bgp_del_route(bgp,p,ri);vnc_impor
t_bgp_exterior_del_route(bgp,p,ri);}}#endifbgp_attr_unintern(&ri->attr);ri->attr
=attr_new;ri->uptime=bgp_clock();#ifENABLE_BGP_VNCif((afi==AFI_IP||afi==AFI_IP6)
&&(safi==SAFI_UNICAST)){if(vnc_implicit_withdraw){vnc_import_bgp_add_route(bgp,p
,ri);vnc_import_bgp_exterior_add_route(bgp,p,ri);}}#endif/*Nexthopreachabilitych
eck.*/if(bgp_flag_check(bgp,BGP_FLAG_IMPORT_CHECK)&&(safi==SAFI_UNICAST||safi==S
AFI_LABELED_UNICAST)){if(bgp_find_or_add_nexthop(bgp,afi,ri,NULL,0))bgp_info_set
_flag(rn,ri,BGP_INFO_VALID);else{if(BGP_DEBUG(nht,NHT)){charbuf1[INET6_ADDRSTRLE
N];inet_ntop(p->family,&p->u.prefix,buf1,INET6_ADDRSTRLEN);zlog_debug("%s(%s):Ro
utenotintable,notadvertising",__FUNCTION__,buf1);}bgp_info_unset_flag(rn,ri,BGP_
INFO_VALID);}}else{/*DeletetheNHTstructureifany,ifwe're*togglingbetween*enabling
/disablingimportcheck.We*deregistertheroute*fromNHTtoavoidoverloadingNHTandthe*p
rocessinteraction*/bgp_unlink_nexthop(ri);bgp_info_set_flag(rn,ri,BGP_INFO_VALID
);}/*Processchange.*/bgp_aggregate_increment(bgp,p,ri,afi,safi);bgp_process(bgp,
rn,afi,safi);if(SAFI_UNICAST==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bgp-
>inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_update(bgp_get_default
(),bgp,ri);}bgp_unlock_node(rn);aspath_unintern(&attr.aspath);return;}}/*Makenew
BGPinfo.*/new=info_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_STATIC,0,bgp->peer_self,attr_n
ew,rn);/*Nexthopreachabilitycheck.*/if(bgp_flag_check(bgp,BGP_FLAG_IMPORT_CHECK)
&&(safi==SAFI_UNICAST||safi==SAFI_LABELED_UNICAST)){if(bgp_find_or_add_nexthop(b
gp,afi,new,NULL,0))bgp_info_set_flag(rn,new,BGP_INFO_VALID);else{if(BGP_DEBUG(nh
t,NHT)){charbuf1[INET6_ADDRSTRLEN];inet_ntop(p->family,&p->u.prefix,buf1,INET6_A
DDRSTRLEN);zlog_debug("%s(%s):Routenotintable,notadvertising",__FUNCTION__,buf1)
;}bgp_info_unset_flag(rn,new,BGP_INFO_VALID);}}else{/*DeletetheNHTstructureifany
,ifwe'retogglingbetween*enabling/disablingimportcheck.Wederegistertheroute*fromN
HTtoavoidoverloadingNHTandtheprocessinteraction*/bgp_unlink_nexthop(new);bgp_inf
o_set_flag(rn,new,BGP_INFO_VALID);}/*Aggregateaddressincrement.*/bgp_aggregate_i
ncrement(bgp,p,new,afi,safi);/*RegisternewBGPinformation.*/bgp_info_add(rn,new);
/*route_node_getlock*/bgp_unlock_node(rn);/*Processchange.*/bgp_process(bgp,rn,a
fi,safi);if(SAFI_UNICAST==safi&&(bgp->inst_type==BGP_INSTANCE_TYPE_VRF||bgp->ins
t_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_update(bgp_get_default(),b
gp,new);}/*Uninternoriginal.*/aspath_unintern(&attr.aspath);}voidbgp_static_with
draw(structbgp*bgp,structprefix*p,afi_tafi,safi_tsafi){structbgp_node*rn;structb
gp_info*ri;rn=bgp_afi_node_get(bgp->rib[afi][safi],afi,safi,p,NULL);/*Checkselec
tedrouteandselfinsertedroute.*/for(ri=rn->info;ri;ri=ri->next)if(ri->peer==bgp->
peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_STATIC)break;/*Wit
hdrawstaticBGProutefromroutingtable.*/if(ri){if(SAFI_UNICAST==safi&&(bgp->inst_t
ype==BGP_INSTANCE_TYPE_VRF||bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak
_from_vrf_withdraw(bgp_get_default(),bgp,ri);}bgp_aggregate_decrement(bgp,p,ri,a
fi,safi);bgp_unlink_nexthop(ri);bgp_info_delete(rn,ri);bgp_process(bgp,rn,afi,sa
fi);}/*Unlockbgp_node_lookup.*/bgp_unlock_node(rn);}/**UsedforSAFI_MPLS_VPNandSA
FI_ENCAP*/staticvoidbgp_static_withdraw_safi(structbgp*bgp,structprefix*p,afi_ta
fi,safi_tsafi,structprefix_rd*prd){structbgp_node*rn;structbgp_info*ri;rn=bgp_af
i_node_get(bgp->rib[afi][safi],afi,safi,p,prd);/*Checkselectedrouteandselfinsert
edroute.*/for(ri=rn->info;ri;ri=ri->next)if(ri->peer==bgp->peer_self&&ri->type==
ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_STATIC)break;/*WithdrawstaticBGProutefr
omroutingtable.*/if(ri){#ifENABLE_BGP_VNCrfapiProcessWithdraw(ri->peer,NULL,p,pr
d,ri->attr,afi,safi,ri->type,1);/*Kill,sinceitisanadministrativechange*/#endifif
(SAFI_MPLS_VPN==safi&&bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT){vpn_leak_to_vrf
_withdraw(bgp,ri);}bgp_aggregate_decrement(bgp,p,ri,afi,safi);bgp_info_delete(rn
,ri);bgp_process(bgp,rn,afi,safi);}/*Unlockbgp_node_lookup.*/bgp_unlock_node(rn)
;}staticvoidbgp_static_update_safi(structbgp*bgp,structprefix*p,structbgp_static
*bgp_static,afi_tafi,safi_tsafi){structbgp_node*rn;structbgp_info*new;structattr
*attr_new;structattrattr={0};structbgp_info*ri;#ifENABLE_BGP_VNCmpls_label_tlabe
l=0;#endifuint32_tnum_labels=0;uniongw_addradd;assert(bgp_static);if(bgp_static-
>label!=MPLS_INVALID_LABEL)num_labels=1;rn=bgp_afi_node_get(bgp->rib[afi][safi],
afi,safi,p,&bgp_static->prd);bgp_attr_default_set(&attr,BGP_ORIGIN_IGP);attr.nex
thop=bgp_static->igpnexthop;attr.med=bgp_static->igpmetric;attr.flag|=ATTR_FLAG_
BIT(BGP_ATTR_MULTI_EXIT_DISC);if((safi==SAFI_EVPN)||(safi==SAFI_MPLS_VPN)||(safi
==SAFI_ENCAP)){if(afi==AFI_IP){attr.mp_nexthop_global_in=bgp_static->igpnexthop;
attr.mp_nexthop_len=IPV4_MAX_BYTELEN;}}if(afi==AFI_L2VPN){if(bgp_static->gateway
Ip.family==AF_INET)add.ipv4.s_addr=bgp_static->gatewayIp.u.prefix4.s_addr;elseif
(bgp_static->gatewayIp.family==AF_INET6)memcpy(&(add.ipv6),&(bgp_static->gateway
Ip.u.prefix6),sizeof(structin6_addr));overlay_index_update(&attr,bgp_static->eth
_s_id,&add);if(bgp_static->encap_tunneltype==BGP_ENCAP_TYPE_VXLAN){structbgp_enc
ap_type_vxlanbet;memset(&bet,0,sizeof(structbgp_encap_type_vxlan));bet.vnid=p->u
.prefix_evpn.eth_tag;bgp_encap_type_vxlan_to_tlv(&bet,&attr);}if(bgp_static->rou
ter_mac){bgp_add_routermac_ecom(&attr,bgp_static->router_mac);}}/*Applyroute-map
.*/if(bgp_static->rmap.name){structattrattr_tmp=attr;structbgp_infoinfo;intret;i
nfo.peer=bgp->peer_self;info.attr=&attr_tmp;SET_FLAG(bgp->peer_self->rmap_type,P
EER_RMAP_TYPE_NETWORK);ret=route_map_apply(bgp_static->rmap.map,p,RMAP_BGP,&info
);bgp->peer_self->rmap_type=0;if(ret==RMAP_DENYMATCH){/*Freeuninternedattribute.
*/bgp_attr_flush(&attr_tmp);/*Uninternoriginal.*/aspath_unintern(&attr.aspath);b
gp_static_withdraw_safi(bgp,p,afi,safi,&bgp_static->prd);return;}attr_new=bgp_at
tr_intern(&attr_tmp);}else{attr_new=bgp_attr_intern(&attr);}for(ri=rn->info;ri;r
i=ri->next)if(ri->peer==bgp->peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type=
=BGP_ROUTE_STATIC)break;if(ri){uniongw_addradd;memset(&add,0,sizeof(uniongw_addr
));if(attrhash_cmp(ri->attr,attr_new)&&overlay_index_equal(afi,ri,bgp_static->et
h_s_id,&add)&&!CHECK_FLAG(ri->flags,BGP_INFO_REMOVED)){bgp_unlock_node(rn);bgp_a
ttr_unintern(&attr_new);aspath_unintern(&attr.aspath);return;}else{/*Theattribut
eischanged.*/bgp_info_set_flag(rn,ri,BGP_INFO_ATTR_CHANGED);/*RewriteBGProuteinf
ormation.*/if(CHECK_FLAG(ri->flags,BGP_INFO_REMOVED))bgp_info_restore(rn,ri);els
ebgp_aggregate_decrement(bgp,p,ri,afi,safi);bgp_attr_unintern(&ri->attr);ri->att
r=attr_new;ri->uptime=bgp_clock();#ifENABLE_BGP_VNCif(ri->extra)label=decode_lab
el(&ri->extra->label[0]);#endif/*Processchange.*/bgp_aggregate_increment(bgp,p,r
i,afi,safi);bgp_process(bgp,rn,afi,safi);if(SAFI_MPLS_VPN==safi&&bgp->inst_type=
=BGP_INSTANCE_TYPE_DEFAULT){vpn_leak_to_vrf_update(bgp,ri);}#ifENABLE_BGP_VNCrfa
piProcessUpdate(ri->peer,NULL,p,&bgp_static->prd,ri->attr,afi,safi,ri->type,ri->
sub_type,&label);#endifbgp_unlock_node(rn);aspath_unintern(&attr.aspath);return;
}}/*MakenewBGPinfo.*/new=info_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_STATIC,0,bgp->peer_
self,attr_new,rn);SET_FLAG(new->flags,BGP_INFO_VALID);new->extra=bgp_info_extra_
new();if(num_labels){new->extra->label[0]=bgp_static->label;new->extra->num_labe
ls=num_labels;}#ifENABLE_BGP_VNClabel=decode_label(&bgp_static->label);#endif/*A
ggregateaddressincrement.*/bgp_aggregate_increment(bgp,p,new,afi,safi);/*Registe
rnewBGPinformation.*/bgp_info_add(rn,new);/*route_node_getlock*/bgp_unlock_node(
rn);/*Processchange.*/bgp_process(bgp,rn,afi,safi);if(SAFI_MPLS_VPN==safi&&bgp->
inst_type==BGP_INSTANCE_TYPE_DEFAULT){vpn_leak_to_vrf_update(bgp,new);}#ifENABLE
_BGP_VNCrfapiProcessUpdate(new->peer,NULL,p,&bgp_static->prd,new->attr,afi,safi,
new->type,new->sub_type,&label);#endif/*Uninternoriginal.*/aspath_unintern(&attr
.aspath);}/*ConfigurestaticBGPnetwork.Whenuserdon'trunzebra,staticrouteshouldbei
nstalledasvalid.*/staticintbgp_static_set(structvty*vty,constchar*negate,constch
ar*ip_str,afi_tafi,safi_tsafi,constchar*rmap,intbackdoor,uint32_tlabel_index){VT
Y_DECLVAR_CONTEXT(bgp,bgp);intret;structprefixp;structbgp_static*bgp_static;stru
ctbgp_node*rn;uint8_tneed_update=0;/*ConvertIPprefixstringtostructprefix.*/ret=s
tr2prefix(ip_str,&p);if(!ret){vty_out(vty,"%%Malformedprefix\n");returnCMD_WARNI
NG_CONFIG_FAILED;}if(afi==AFI_IP6&&IN6_IS_ADDR_LINKLOCAL(&p.u.prefix6)){vty_out(
vty,"%%Malformedprefix(link-localaddress)\n");returnCMD_WARNING_CONFIG_FAILED;}a
pply_mask(&p);if(negate){/*SetBGPstaticrouteconfiguration.*/rn=bgp_node_lookup(b
gp->route[afi][safi],&p);if(!rn){vty_out(vty,"%%Can'tfindstaticroutespecified\n"
);returnCMD_WARNING_CONFIG_FAILED;}bgp_static=rn->info;if((label_index!=BGP_INVA
LID_LABEL_INDEX)&&(label_index!=bgp_static->label_index)){vty_out(vty,"%%label-i
ndexdoesn'tmatchstaticroute\n");returnCMD_WARNING_CONFIG_FAILED;}if((rmap&&bgp_s
tatic->rmap.name)&&strcmp(rmap,bgp_static->rmap.name)){vty_out(vty,"%%route-mapn
amedoesn'tmatchstaticroute\n");returnCMD_WARNING_CONFIG_FAILED;}/*UpdateBGPRIB.*
/if(!bgp_static->backdoor)bgp_static_withdraw(bgp,&p,afi,safi);/*Clearconfigurat
ion.*/bgp_static_free(bgp_static);rn->info=NULL;bgp_unlock_node(rn);bgp_unlock_n
ode(rn);}else{/*SetBGPstaticrouteconfiguration.*/rn=bgp_node_get(bgp->route[afi]
[safi],&p);if(rn->info){/*Configurationchange.*/bgp_static=rn->info;/*Labelindex
cannotbechanged.*/if(bgp_static->label_index!=label_index){vty_out(vty,"%%cannot
changelabel-index\n");returnCMD_WARNING_CONFIG_FAILED;}/*Checkpreviousroutesarei
nstalledintoBGP.*/if(bgp_static->valid&&bgp_static->backdoor!=backdoor)need_upda
te=1;bgp_static->backdoor=backdoor;if(rmap){if(bgp_static->rmap.name)XFREE(MTYPE
_ROUTE_MAP_NAME,bgp_static->rmap.name);bgp_static->rmap.name=XSTRDUP(MTYPE_ROUTE
_MAP_NAME,rmap);bgp_static->rmap.map=route_map_lookup_by_name(rmap);}else{if(bgp
_static->rmap.name)XFREE(MTYPE_ROUTE_MAP_NAME,bgp_static->rmap.name);bgp_static-
>rmap.name=NULL;bgp_static->rmap.map=NULL;bgp_static->valid=0;}bgp_unlock_node(r
n);}else{/*Newconfiguration.*/bgp_static=bgp_static_new();bgp_static->backdoor=b
ackdoor;bgp_static->valid=0;bgp_static->igpmetric=0;bgp_static->igpnexthop.s_add
r=0;bgp_static->label_index=label_index;if(rmap){if(bgp_static->rmap.name)XFREE(
MTYPE_ROUTE_MAP_NAME,bgp_static->rmap.name);bgp_static->rmap.name=XSTRDUP(MTYPE_
ROUTE_MAP_NAME,rmap);bgp_static->rmap.map=route_map_lookup_by_name(rmap);}rn->in
fo=bgp_static;}bgp_static->valid=1;if(need_update)bgp_static_withdraw(bgp,&p,afi
,safi);if(!bgp_static->backdoor)bgp_static_update(bgp,&p,bgp_static,afi,safi);}r
eturnCMD_SUCCESS;}voidbgp_static_add(structbgp*bgp){afi_tafi;safi_tsafi;structbg
p_node*rn;structbgp_node*rm;structbgp_table*table;structbgp_static*bgp_static;FO
REACH_AFI_SAFI(afi,safi)for(rn=bgp_table_top(bgp->route[afi][safi]);rn;rn=bgp_ro
ute_next(rn)){if(rn->info==NULL)continue;if((safi==SAFI_MPLS_VPN)||(safi==SAFI_E
NCAP)||(safi==SAFI_EVPN)){table=rn->info;for(rm=bgp_table_top(table);rm;rm=bgp_r
oute_next(rm)){bgp_static=rm->info;bgp_static_update_safi(bgp,&rm->p,bgp_static,
afi,safi);}}else{bgp_static_update(bgp,&rn->p,rn->info,afi,safi);}}}/*Calledfrom
bgp_delete().DeleteallstaticroutesfromtheBGPinstance.*/voidbgp_static_delete(str
uctbgp*bgp){afi_tafi;safi_tsafi;structbgp_node*rn;structbgp_node*rm;structbgp_ta
ble*table;structbgp_static*bgp_static;FOREACH_AFI_SAFI(afi,safi)for(rn=bgp_table
_top(bgp->route[afi][safi]);rn;rn=bgp_route_next(rn)){if(rn->info==NULL)continue
;if((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)){table=rn->info
;for(rm=bgp_table_top(table);rm;rm=bgp_route_next(rm)){bgp_static=rm->info;bgp_s
tatic_withdraw_safi(bgp,&rm->p,AFI_IP,safi,(structprefix_rd*)&rn->p);bgp_static_
free(bgp_static);rn->info=NULL;bgp_unlock_node(rn);}}else{bgp_static=rn->info;bg
p_static_withdraw(bgp,&rn->p,afi,safi);bgp_static_free(bgp_static);rn->info=NULL
;bgp_unlock_node(rn);}}}voidbgp_static_redo_import_check(structbgp*bgp){afi_tafi
;safi_tsafi;structbgp_node*rn;structbgp_node*rm;structbgp_table*table;structbgp_
static*bgp_static;/*Usethisflagtoforcereprocessingoftheroute*/bgp_flag_set(bgp,B
GP_FLAG_FORCE_STATIC_PROCESS);FOREACH_AFI_SAFI(afi,safi){for(rn=bgp_table_top(bg
p->route[afi][safi]);rn;rn=bgp_route_next(rn)){if(rn->info==NULL)continue;if((sa
fi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)){table=rn->info;for(rm
=bgp_table_top(table);rm;rm=bgp_route_next(rm)){bgp_static=rm->info;bgp_static_u
pdate_safi(bgp,&rm->p,bgp_static,afi,safi);}}else{bgp_static=rn->info;bgp_static
_update(bgp,&rn->p,bgp_static,afi,safi);}}}bgp_flag_unset(bgp,BGP_FLAG_FORCE_STA
TIC_PROCESS);}staticvoidbgp_purge_af_static_redist_routes(structbgp*bgp,afi_tafi
,safi_tsafi){structbgp_table*table;structbgp_node*rn;structbgp_info*ri;table=bgp
->rib[afi][safi];for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn)){for(ri=rn
->info;ri;ri=ri->next){if(ri->peer==bgp->peer_self&&((ri->type==ZEBRA_ROUTE_BGP&
&ri->sub_type==BGP_ROUTE_STATIC)||(ri->type!=ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_
ROUTE_REDISTRIBUTE))){bgp_aggregate_decrement(bgp,&rn->p,ri,afi,safi);bgp_unlink
_nexthop(ri);bgp_info_delete(rn,ri);bgp_process(bgp,rn,afi,safi);}}}}/**Purgeall
networksandredistributedroutesfromroutingtable.*Invokedupontheinstancegoingdown.
*/voidbgp_purge_static_redist_routes(structbgp*bgp){afi_tafi;safi_tsafi;FOREACH_
AFI_SAFI(afi,safi)bgp_purge_af_static_redist_routes(bgp,afi,safi);}/**gpz110624*
CurrentlythisisusedtosetstaticroutesforVPNandENCAP.*Ithinkitcanprobablybefactore
dwithbgp_static_set.*/intbgp_static_set_safi(afi_tafi,safi_tsafi,structvty*vty,c
onstchar*ip_str,constchar*rd_str,constchar*label_str,constchar*rmap_str,intevpn_
type,constchar*esi,constchar*gwip,constchar*ethtag,constchar*routermac){VTY_DECL
VAR_CONTEXT(bgp,bgp);intret;structprefixp;structprefix_rdprd;structbgp_node*prn;
structbgp_node*rn;structbgp_table*table;structbgp_static*bgp_static;mpls_label_t
label=MPLS_INVALID_LABEL;structprefixgw_ip;/*validateipprefix*/ret=str2prefix(ip
_str,&p);if(!ret){vty_out(vty,"%%Malformedprefix\n");returnCMD_WARNING_CONFIG_FA
ILED;}apply_mask(&p);if((afi==AFI_L2VPN)&&(bgp_build_evpn_prefix(evpn_type,ethta
g!=NULL?atol(ethtag):0,&p))){vty_out(vty,"%%L2VPNprefixcouldnotbeforged\n");retu
rnCMD_WARNING_CONFIG_FAILED;}ret=str2prefix_rd(rd_str,&prd);if(!ret){vty_out(vty
,"%%Malformedrd\n");returnCMD_WARNING_CONFIG_FAILED;}if(label_str){unsignedlongl
abel_val;label_val=strtoul(label_str,NULL,10);encode_label(label_val,&label);}if
(safi==SAFI_EVPN){if(esi&&str2esi(esi,NULL)==0){vty_out(vty,"%%MalformedESI\n");
returnCMD_WARNING_CONFIG_FAILED;}if(routermac&&prefix_str2mac(routermac,NULL)==0
){vty_out(vty,"%%MalformedRouterMAC\n");returnCMD_WARNING_CONFIG_FAILED;}if(gwip
){memset(&gw_ip,0,sizeof(structprefix));ret=str2prefix(gwip,&gw_ip);if(!ret){vty
_out(vty,"%%MalformedGatewayIp\n");returnCMD_WARNING_CONFIG_FAILED;}if((gw_ip.fa
mily==AF_INET&&IS_EVPN_PREFIX_IPADDR_V6((structprefix_evpn*)&p))||(gw_ip.family=
=AF_INET6&&IS_EVPN_PREFIX_IPADDR_V4((structprefix_evpn*)&p))){vty_out(vty,"%%Gat
ewayIpfamilydifferswithIPprefix\n");returnCMD_WARNING_CONFIG_FAILED;}}}prn=bgp_n
ode_get(bgp->route[afi][safi],(structprefix*)&prd);if(prn->info==NULL)prn->info=
bgp_table_init(afi,safi);elsebgp_unlock_node(prn);table=prn->info;rn=bgp_node_ge
t(table,&p);if(rn->info){vty_out(vty,"%%Samenetworkconfigurationexists\n");bgp_u
nlock_node(rn);}else{/*Newconfiguration.*/bgp_static=bgp_static_new();bgp_static
->backdoor=0;bgp_static->valid=0;bgp_static->igpmetric=0;bgp_static->igpnexthop.
s_addr=0;bgp_static->label=label;bgp_static->prd=prd;if(rmap_str){if(bgp_static-
>rmap.name)XFREE(MTYPE_ROUTE_MAP_NAME,bgp_static->rmap.name);bgp_static->rmap.na
me=XSTRDUP(MTYPE_ROUTE_MAP_NAME,rmap_str);bgp_static->rmap.map=route_map_lookup_
by_name(rmap_str);}if(safi==SAFI_EVPN){if(esi){bgp_static->eth_s_id=XCALLOC(MTYP
E_ATTR,sizeof(structeth_segment_id));str2esi(esi,bgp_static->eth_s_id);}if(route
rmac){bgp_static->router_mac=XCALLOC(MTYPE_ATTR,ETH_ALEN+1);prefix_str2mac(route
rmac,bgp_static->router_mac);}if(gwip)prefix_copy(&bgp_static->gatewayIp,&gw_ip)
;}rn->info=bgp_static;bgp_static->valid=1;bgp_static_update_safi(bgp,&p,bgp_stat
ic,afi,safi);}returnCMD_SUCCESS;}/*ConfigurestaticBGPnetwork.*/intbgp_static_uns
et_safi(afi_tafi,safi_tsafi,structvty*vty,constchar*ip_str,constchar*rd_str,cons
tchar*label_str,intevpn_type,constchar*esi,constchar*gwip,constchar*ethtag){VTY_
DECLVAR_CONTEXT(bgp,bgp);intret;structprefixp;structprefix_rdprd;structbgp_node*
prn;structbgp_node*rn;structbgp_table*table;structbgp_static*bgp_static;mpls_lab
el_tlabel=MPLS_INVALID_LABEL;/*ConvertIPprefixstringtostructprefix.*/ret=str2pre
fix(ip_str,&p);if(!ret){vty_out(vty,"%%Malformedprefix\n");returnCMD_WARNING_CON
FIG_FAILED;}apply_mask(&p);if((afi==AFI_L2VPN)&&(bgp_build_evpn_prefix(evpn_type
,ethtag!=NULL?atol(ethtag):0,&p))){vty_out(vty,"%%L2VPNprefixcouldnotbeforged\n"
);returnCMD_WARNING_CONFIG_FAILED;}ret=str2prefix_rd(rd_str,&prd);if(!ret){vty_o
ut(vty,"%%Malformedrd\n");returnCMD_WARNING_CONFIG_FAILED;}if(label_str){unsigne
dlonglabel_val;label_val=strtoul(label_str,NULL,10);encode_label(label_val,&labe
l);}prn=bgp_node_get(bgp->route[afi][safi],(structprefix*)&prd);if(prn->info==NU
LL)prn->info=bgp_table_init(afi,safi);elsebgp_unlock_node(prn);table=prn->info;r
n=bgp_node_lookup(table,&p);if(rn){bgp_static_withdraw_safi(bgp,&p,afi,safi,&prd
);bgp_static=rn->info;bgp_static_free(bgp_static);rn->info=NULL;bgp_unlock_node(
rn);bgp_unlock_node(rn);}elsevty_out(vty,"%%Can'tfindtheroute\n");returnCMD_SUCC
ESS;}staticintbgp_table_map_set(structvty*vty,afi_tafi,safi_tsafi,constchar*rmap
_name){VTY_DECLVAR_CONTEXT(bgp,bgp);structbgp_rmap*rmap;rmap=&bgp->table_map[afi
][safi];if(rmap_name){if(rmap->name)XFREE(MTYPE_ROUTE_MAP_NAME,rmap->name);rmap-
>name=XSTRDUP(MTYPE_ROUTE_MAP_NAME,rmap_name);rmap->map=route_map_lookup_by_name
(rmap_name);}else{if(rmap->name)XFREE(MTYPE_ROUTE_MAP_NAME,rmap->name);rmap->nam
e=NULL;rmap->map=NULL;}if(bgp_fibupd_safi(safi))bgp_zebra_announce_table(bgp,afi
,safi);returnCMD_SUCCESS;}staticintbgp_table_map_unset(structvty*vty,afi_tafi,sa
fi_tsafi,constchar*rmap_name){VTY_DECLVAR_CONTEXT(bgp,bgp);structbgp_rmap*rmap;r
map=&bgp->table_map[afi][safi];if(rmap->name)XFREE(MTYPE_ROUTE_MAP_NAME,rmap->na
me);rmap->name=NULL;rmap->map=NULL;if(bgp_fibupd_safi(safi))bgp_zebra_announce_t
able(bgp,afi,safi);returnCMD_SUCCESS;}voidbgp_config_write_table_map(structvty*v
ty,structbgp*bgp,afi_tafi,safi_tsafi){if(bgp->table_map[afi][safi].name){vty_out
(vty,"table-map%s\n",bgp->table_map[afi][safi].name);}}DEFUN(bgp_table_map,bgp_t
able_map_cmd,"table-mapWORD","BGPtabletoRIBroutedownloadfilter\n""Nameoftheroute
map\n"){intidx_word=1;returnbgp_table_map_set(vty,bgp_node_afi(vty),bgp_node_saf
i(vty),argv[idx_word]->arg);}DEFUN(no_bgp_table_map,no_bgp_table_map_cmd,"notabl
e-mapWORD",NO_STR"BGPtabletoRIBroutedownloadfilter\n""Nameoftheroutemap\n"){inti
dx_word=2;returnbgp_table_map_unset(vty,bgp_node_afi(vty),bgp_node_safi(vty),arg
v[idx_word]->arg);}DEFPY(bgp_network,bgp_network_cmd,"[no]network\<A.B.C.D/M$pre
fix|A.B.C.D$address[maskA.B.C.D$netmask]>\[{route-mapWORD$map_name|label-index(0
-1048560)$label_index|\backdoor$backdoor}]",NO_STR"SpecifyanetworktoannounceviaB
GP\n""IPv4prefix\n""Networknumber\n""Networkmask\n""Networkmask\n""Route-maptomo
difytheattributes\n""Nameoftheroutemap\n""Labelindextoassociatewiththeprefix\n""
Labelindexvalue\n""SpecifyaBGPbackdoorroute\n"){charaddr_prefix_str[BUFSIZ];if(a
ddress_str){intret;ret=netmask_str2prefix_str(address_str,netmask_str,addr_prefi
x_str);if(!ret){vty_out(vty,"%%Inconsistentaddressandmask\n");returnCMD_WARNING_
CONFIG_FAILED;}}returnbgp_static_set(vty,no,address_str?addr_prefix_str:prefix_s
tr,AFI_IP,bgp_node_safi(vty),map_name,backdoor?1:0,label_index?(uint32_t)label_i
ndex:BGP_INVALID_LABEL_INDEX);}DEFPY(ipv6_bgp_network,ipv6_bgp_network_cmd,"[no]
networkX:X::X:X/M$prefix\[{route-mapWORD$map_name|label-index(0-1048560)$label_i
ndex}]",NO_STR"SpecifyanetworktoannounceviaBGP\n""IPv6prefix\n""Route-maptomodif
ytheattributes\n""Nameoftheroutemap\n""Labelindextoassociatewiththeprefix\n""Lab
elindexvalue\n"){returnbgp_static_set(vty,no,prefix_str,AFI_IP6,bgp_node_safi(vt
y),map_name,0,label_index?(uint32_t)label_index:BGP_INVALID_LABEL_INDEX);}/*Aggr
eageteaddress:advertise-mapSetconditiontoadvertiseattributeas-setGenerateASsetpa
thinformationattribute-mapSetattributesofaggregateroute-mapSetparametersofaggreg
atesummary-onlyFiltermorespecificroutesfromupdatessuppress-mapConditionallyfilte
rmorespecificroutesfromupdates<cr>*/structbgp_aggregate{/*Summary-onlyflag.*/uin
t8_tsummary_only;/*ASsetgeneration.*/uint8_tas_set;/*Route-mapforaggregatedroute
.*/structroute_map*map;/*Suppress-count.*/unsignedlongcount;/*SAFIconfiguration.
*/safi_tsafi;};staticstructbgp_aggregate*bgp_aggregate_new(void){returnXCALLOC(M
TYPE_BGP_AGGREGATE,sizeof(structbgp_aggregate));}staticvoidbgp_aggregate_free(st
ructbgp_aggregate*aggregate){XFREE(MTYPE_BGP_AGGREGATE,aggregate);}/*Updateanagg
regateasroutesareadded/removedfromtheBGPtable*/staticvoidbgp_aggregate_route(str
uctbgp*bgp,structprefix*p,structbgp_info*rinew,afi_tafi,safi_tsafi,structbgp_inf
o*del,structbgp_aggregate*aggregate){structbgp_table*table;structbgp_node*top;st
ructbgp_node*rn;uint8_torigin;structaspath*aspath=NULL;structaspath*asmerge=NULL
;structcommunity*community=NULL;structcommunity*commerge=NULL;#ifdefined(AGGREGA
TE_NEXTHOP_CHECK)structin_addrnexthop;uint32_tmed=0;#endifstructbgp_info*ri;stru
ctbgp_info*new;intfirst=1;unsignedlongmatch=0;uint8_tatomic_aggregate=0;/*Record
addingroute'snexthopandmed.*/if(rinew){#ifdefined(AGGREGATE_NEXTHOP_CHECK)nextho
p=rinew->attr->nexthop;med=rinew->attr->med;#endif}/*ORIGINattribute:Ifatleaston
erouteamongroutesthatareaggregatedhasORIGINwiththevalueINCOMPLETE,thentheaggrega
tedroutemusthavetheORIGINattributewiththevalueINCOMPLETE.Otherwise,ifatleastoner
outeamongroutesthatareaggregatedhasORIGINwiththevalueEGP,thentheaggregatedroutem
usthavetheoriginattributewiththevalueEGP.InallothercasethevalueoftheORIGINattrib
uteoftheaggregatedrouteisINTERNAL.*/origin=BGP_ORIGIN_IGP;table=bgp->rib[afi][sa
fi];top=bgp_node_get(table,p);for(rn=bgp_node_get(table,p);rn;rn=bgp_route_next_
until(rn,top))if(rn->p.prefixlen>p->prefixlen){match=0;for(ri=rn->info;ri;ri=ri-
>next){if(BGP_INFO_HOLDDOWN(ri))continue;if(del&&ri==del)continue;if(!rinew&&fir
st){#ifdefined(AGGREGATE_NEXTHOP_CHECK)nexthop=ri->attr->nexthop;med=ri->attr->m
ed;#endiffirst=0;}#ifdefAGGREGATE_NEXTHOP_CHECKif(!IPV4_ADDR_SAME(&ri->attr->nex
thop,&nexthop)||ri->attr->med!=med){if(aspath)aspath_free(aspath);if(community)c
ommunity_free(community);bgp_unlock_node(rn);bgp_unlock_node(top);return;}#endif
/*AGGREGATE_NEXTHOP_CHECK*/if(ri->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ATOMIC_AGGRE
GATE))atomic_aggregate=1;if(ri->sub_type!=BGP_ROUTE_AGGREGATE){if(aggregate->sum
mary_only){(bgp_info_extra_get(ri))->suppress++;bgp_info_set_flag(rn,ri,BGP_INFO
_ATTR_CHANGED);match++;}aggregate->count++;if(origin<ri->attr->origin)origin=ri-
>attr->origin;if(aggregate->as_set){if(aspath){asmerge=aspath_aggregate(aspath,r
i->attr->aspath);aspath_free(aspath);aspath=asmerge;}elseaspath=aspath_dup(ri->a
ttr->aspath);if(ri->attr->community){if(community){commerge=community_merge(comm
unity,ri->attr->community);community=community_uniq_sort(commerge);community_fre
e(commerge);}elsecommunity=community_dup(ri->attr->community);}}}}if(match)bgp_p
rocess(bgp,rn,afi,safi);}bgp_unlock_node(top);if(rinew){aggregate->count++;if(ag
gregate->summary_only)(bgp_info_extra_get(rinew))->suppress++;if(origin<rinew->a
ttr->origin)origin=rinew->attr->origin;if(aggregate->as_set){if(aspath){asmerge=
aspath_aggregate(aspath,rinew->attr->aspath);aspath_free(aspath);aspath=asmerge;
}elseaspath=aspath_dup(rinew->attr->aspath);if(rinew->attr->community){if(commun
ity){commerge=community_merge(community,rinew->attr->community);community=commun
ity_uniq_sort(commerge);community_free(commerge);}elsecommunity=community_dup(ri
new->attr->community);}}}if(aggregate->count>0){rn=bgp_node_get(table,p);new=inf
o_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_AGGREGATE,0,bgp->peer_self,bgp_attr_aggregate_i
ntern(bgp,origin,aspath,community,aggregate->as_set,atomic_aggregate),rn);SET_FL
AG(new->flags,BGP_INFO_VALID);bgp_info_add(rn,new);bgp_unlock_node(rn);bgp_proce
ss(bgp,rn,afi,safi);}else{if(aspath)aspath_free(aspath);if(community)community_f
ree(community);}}voidbgp_aggregate_delete(structbgp*,structprefix*,afi_t,safi_t,
structbgp_aggregate*);voidbgp_aggregate_increment(structbgp*bgp,structprefix*p,s
tructbgp_info*ri,afi_tafi,safi_tsafi){structbgp_node*child;structbgp_node*rn;str
uctbgp_aggregate*aggregate;structbgp_table*table;/*MPLS-VPNaggregationisnotyetsu
pported.*/if((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)||(safi
==SAFI_FLOWSPEC))return;table=bgp->aggregate[afi][safi];/*Noaggregatesconfigured
.*/if(bgp_table_top_nolock(table)==NULL)return;if(p->prefixlen==0)return;if(BGP_
INFO_HOLDDOWN(ri))return;child=bgp_node_get(table,p);/*Aggregateaddressconfigura
tioncheck.*/for(rn=child;rn;rn=bgp_node_parent_nolock(rn))if((aggregate=rn->info
)!=NULL&&rn->p.prefixlen<p->prefixlen){bgp_aggregate_delete(bgp,&rn->p,afi,safi,
aggregate);bgp_aggregate_route(bgp,&rn->p,ri,afi,safi,NULL,aggregate);}bgp_unloc
k_node(child);}voidbgp_aggregate_decrement(structbgp*bgp,structprefix*p,structbg
p_info*del,afi_tafi,safi_tsafi){structbgp_node*child;structbgp_node*rn;structbgp
_aggregate*aggregate;structbgp_table*table;/*MPLS-VPNaggregationisnotyetsupporte
d.*/if((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)||(safi==SAFI
_FLOWSPEC))return;table=bgp->aggregate[afi][safi];/*Noaggregatesconfigured.*/if(
bgp_table_top_nolock(table)==NULL)return;if(p->prefixlen==0)return;child=bgp_nod
e_get(table,p);/*Aggregateaddressconfigurationcheck.*/for(rn=child;rn;rn=bgp_nod
e_parent_nolock(rn))if((aggregate=rn->info)!=NULL&&rn->p.prefixlen<p->prefixlen)
{bgp_aggregate_delete(bgp,&rn->p,afi,safi,aggregate);bgp_aggregate_route(bgp,&rn
->p,NULL,afi,safi,del,aggregate);}bgp_unlock_node(child);}/*Calledviabgp_aggrega
te_setwhentheuserconfiguresaggregate-address*/staticvoidbgp_aggregate_add(struct
bgp*bgp,structprefix*p,afi_tafi,safi_tsafi,structbgp_aggregate*aggregate){struct
bgp_table*table;structbgp_node*top;structbgp_node*rn;structbgp_info*new;structbg
p_info*ri;unsignedlongmatch;uint8_torigin=BGP_ORIGIN_IGP;structaspath*aspath=NUL
L;structaspath*asmerge=NULL;structcommunity*community=NULL;structcommunity*comme
rge=NULL;uint8_tatomic_aggregate=0;table=bgp->rib[afi][safi];/*Sanitycheck.*/if(
afi==AFI_IP&&p->prefixlen==IPV4_MAX_BITLEN)return;if(afi==AFI_IP6&&p->prefixlen=
=IPV6_MAX_BITLEN)return;/*Ifroutesexistsbelowthisnode,generateaggregateroutes.*/
top=bgp_node_get(table,p);for(rn=bgp_node_get(table,p);rn;rn=bgp_route_next_unti
l(rn,top)){if(rn->p.prefixlen<=p->prefixlen)continue;match=0;for(ri=rn->info;ri;
ri=ri->next){if(BGP_INFO_HOLDDOWN(ri))continue;if(ri->attr->flag&ATTR_FLAG_BIT(B
GP_ATTR_ATOMIC_AGGREGATE))atomic_aggregate=1;if(ri->sub_type==BGP_ROUTE_AGGREGAT
E)continue;/*summary-onlyaggregateroutesuppress*aggregatedrouteannouncement.*/if
(aggregate->summary_only){(bgp_info_extra_get(ri))->suppress++;bgp_info_set_flag
(rn,ri,BGP_INFO_ATTR_CHANGED);match++;}/*Ifatleastonerouteamongroutesthatare*agg
regatedhasORIGINwiththevalueINCOMPLETE,*thentheaggregatedrouteMUSThavetheORIGIN*
attributewiththevalueINCOMPLETE.Otherwise,if*atleastonerouteamongroutesthatareag
gregated*hasORIGINwiththevalueEGP,thentheaggregated*routeMUSThavetheORIGINattrib
utewiththevalue*EGP.*/if(origin<ri->attr->origin)origin=ri->attr->origin;/*as-se
taggregateroutegenerateorigin,aspath,*communityaggregation.*/if(aggregate->as_se
t){if(aspath){asmerge=aspath_aggregate(aspath,ri->attr->aspath);aspath_free(aspa
th);aspath=asmerge;}elseaspath=aspath_dup(ri->attr->aspath);if(ri->attr->communi
ty){if(community){commerge=community_merge(community,ri->attr->community);commun
ity=community_uniq_sort(commerge);community_free(commerge);}elsecommunity=commun
ity_dup(ri->attr->community);}}aggregate->count++;}/*Ifthisnodeissuppressed,proc
essthechange.*/if(match)bgp_process(bgp,rn,afi,safi);}bgp_unlock_node(top);/*Add
aggregateroutetoBGPtable.*/if(aggregate->count){rn=bgp_node_get(table,p);new=inf
o_make(ZEBRA_ROUTE_BGP,BGP_ROUTE_AGGREGATE,0,bgp->peer_self,bgp_attr_aggregate_i
ntern(bgp,origin,aspath,community,aggregate->as_set,atomic_aggregate),rn);SET_FL
AG(new->flags,BGP_INFO_VALID);bgp_info_add(rn,new);bgp_unlock_node(rn);/*Process
change.*/bgp_process(bgp,rn,afi,safi);}else{if(aspath)aspath_free(aspath);if(com
munity)community_free(community);}}voidbgp_aggregate_delete(structbgp*bgp,struct
prefix*p,afi_tafi,safi_tsafi,structbgp_aggregate*aggregate){structbgp_table*tabl
e;structbgp_node*top;structbgp_node*rn;structbgp_info*ri;unsignedlongmatch;table
=bgp->rib[afi][safi];if(afi==AFI_IP&&p->prefixlen==IPV4_MAX_BITLEN)return;if(afi
==AFI_IP6&&p->prefixlen==IPV6_MAX_BITLEN)return;/*Ifroutesexistsbelowthisnode,ge
nerateaggregateroutes.*/top=bgp_node_get(table,p);for(rn=bgp_node_get(table,p);r
n;rn=bgp_route_next_until(rn,top)){if(rn->p.prefixlen<=p->prefixlen)continue;mat
ch=0;for(ri=rn->info;ri;ri=ri->next){if(BGP_INFO_HOLDDOWN(ri))continue;if(ri->su
b_type==BGP_ROUTE_AGGREGATE)continue;if(aggregate->summary_only&&ri->extra){ri->
extra->suppress--;if(ri->extra->suppress==0){bgp_info_set_flag(rn,ri,BGP_INFO_AT
TR_CHANGED);match++;}}aggregate->count--;}/*Ifthisnodewassuppressed,processthech
ange.*/if(match)bgp_process(bgp,rn,afi,safi);}bgp_unlock_node(top);/*Deleteaggre
gateroutefromBGPtable.*/rn=bgp_node_get(table,p);for(ri=rn->info;ri;ri=ri->next)
if(ri->peer==bgp->peer_self&&ri->type==ZEBRA_ROUTE_BGP&&ri->sub_type==BGP_ROUTE_
AGGREGATE)break;/*WithdrawstaticBGProutefromroutingtable.*/if(ri){bgp_info_delet
e(rn,ri);bgp_process(bgp,rn,afi,safi);}/*Unlockbgp_node_lookup.*/bgp_unlock_node
(rn);}/*Aggregaterouteattribute.*/#defineAGGREGATE_SUMMARY_ONLY1#defineAGGREGATE
_AS_SET1staticintbgp_aggregate_unset(structvty*vty,constchar*prefix_str,afi_tafi
,safi_tsafi){VTY_DECLVAR_CONTEXT(bgp,bgp);intret;structprefixp;structbgp_node*rn
;structbgp_aggregate*aggregate;if(safi==SAFI_FLOWSPEC)returnCMD_WARNING_CONFIG_F
AILED;/*Convertstringtoprefixstructure.*/ret=str2prefix(prefix_str,&p);if(!ret){
vty_out(vty,"Malformedprefix\n");returnCMD_WARNING_CONFIG_FAILED;}apply_mask(&p)
;/*Oldconfigurationcheck.*/rn=bgp_node_lookup(bgp->aggregate[afi][safi],&p);if(!
rn){vty_out(vty,"%%Thereisnoaggregate-addressconfiguration.\n");returnCMD_WARNIN
G_CONFIG_FAILED;}aggregate=rn->info;if(aggregate->safi==SAFI_UNICAST)bgp_aggrega
te_delete(bgp,&p,afi,SAFI_UNICAST,aggregate);if(aggregate->safi==SAFI_LABELED_UN
ICAST)bgp_aggregate_delete(bgp,&p,afi,SAFI_LABELED_UNICAST,aggregate);if(aggrega
te->safi==SAFI_MULTICAST)bgp_aggregate_delete(bgp,&p,afi,SAFI_MULTICAST,aggregat
e);/*Unlockaggregateaddressconfiguration.*/rn->info=NULL;bgp_aggregate_free(aggr
egate);bgp_unlock_node(rn);bgp_unlock_node(rn);returnCMD_SUCCESS;}staticintbgp_a
ggregate_set(structvty*vty,constchar*prefix_str,afi_tafi,safi_tsafi,uint8_tsumma
ry_only,uint8_tas_set){VTY_DECLVAR_CONTEXT(bgp,bgp);intret;structprefixp;structb
gp_node*rn;structbgp_aggregate*aggregate;if(safi==SAFI_FLOWSPEC)returnCMD_WARNIN
G_CONFIG_FAILED;/*Convertstringtoprefixstructure.*/ret=str2prefix(prefix_str,&p)
;if(!ret){vty_out(vty,"Malformedprefix\n");returnCMD_WARNING_CONFIG_FAILED;}appl
y_mask(&p);/*Oldconfigurationcheck.*/rn=bgp_node_get(bgp->aggregate[afi][safi],&
p);if(rn->info){vty_out(vty,"Thereisalreadysameaggregatenetwork.\n");/*trytoremo
vetheoldentry*/ret=bgp_aggregate_unset(vty,prefix_str,afi,safi);if(ret){vty_out(
vty,"Errordeletingaggregate.\n");bgp_unlock_node(rn);returnCMD_WARNING_CONFIG_FA
ILED;}}/*Makeaggregateaddressstructure.*/aggregate=bgp_aggregate_new();aggregate
->summary_only=summary_only;aggregate->as_set=as_set;aggregate->safi=safi;rn->in
fo=aggregate;/*AggregateaddressinsertintoBGProutingtable.*/if(safi==SAFI_UNICAST
)bgp_aggregate_add(bgp,&p,afi,SAFI_UNICAST,aggregate);if(safi==SAFI_LABELED_UNIC
AST)bgp_aggregate_add(bgp,&p,afi,SAFI_LABELED_UNICAST,aggregate);if(safi==SAFI_M
ULTICAST)bgp_aggregate_add(bgp,&p,afi,SAFI_MULTICAST,aggregate);returnCMD_SUCCES
S;}DEFUN(aggregate_address,aggregate_address_cmd,"aggregate-addressA.B.C.D/M[<as
-set[summary-only]|summary-only[as-set]>]","ConfigureBGPaggregateentries\n""Aggr
egateprefix\n""GenerateASsetpathinformation\n""Filtermorespecificroutesfromupdat
es\n""Filtermorespecificroutesfromupdates\n""GenerateASsetpathinformation\n"){in
tidx=0;argv_find(argv,argc,"A.B.C.D/M",&idx);char*prefix=argv[idx]->arg;intas_se
t=argv_find(argv,argc,"as-set",&idx)?AGGREGATE_AS_SET:0;idx=0;intsummary_only=ar
gv_find(argv,argc,"summary-only",&idx)?AGGREGATE_SUMMARY_ONLY:0;returnbgp_aggreg
ate_set(vty,prefix,AFI_IP,bgp_node_safi(vty),summary_only,as_set);}DEFUN(aggrega
te_address_mask,aggregate_address_mask_cmd,"aggregate-addressA.B.C.DA.B.C.D[<as-
set[summary-only]|summary-only[as-set]>]","ConfigureBGPaggregateentries\n""Aggre
gateaddress\n""Aggregatemask\n""GenerateASsetpathinformation\n""Filtermorespecif
icroutesfromupdates\n""Filtermorespecificroutesfromupdates\n""GenerateASsetpathi
nformation\n"){intidx=0;argv_find(argv,argc,"A.B.C.D",&idx);char*prefix=argv[idx
]->arg;char*mask=argv[idx+1]->arg;intas_set=argv_find(argv,argc,"as-set",&idx)?A
GGREGATE_AS_SET:0;idx=0;intsummary_only=argv_find(argv,argc,"summary-only",&idx)
?AGGREGATE_SUMMARY_ONLY:0;charprefix_str[BUFSIZ];intret=netmask_str2prefix_str(p
refix,mask,prefix_str);if(!ret){vty_out(vty,"%%Inconsistentaddressandmask\n");re
turnCMD_WARNING_CONFIG_FAILED;}returnbgp_aggregate_set(vty,prefix_str,AFI_IP,bgp
_node_safi(vty),summary_only,as_set);}DEFUN(no_aggregate_address,no_aggregate_ad
dress_cmd,"noaggregate-addressA.B.C.D/M[<as-set[summary-only]|summary-only[as-se
t]>]",NO_STR"ConfigureBGPaggregateentries\n""Aggregateprefix\n""GenerateASsetpat
hinformation\n""Filtermorespecificroutesfromupdates\n""Filtermorespecificroutesf
romupdates\n""GenerateASsetpathinformation\n"){intidx=0;argv_find(argv,argc,"A.B
.C.D/M",&idx);char*prefix=argv[idx]->arg;returnbgp_aggregate_unset(vty,prefix,AF
I_IP,bgp_node_safi(vty));}DEFUN(no_aggregate_address_mask,no_aggregate_address_m
ask_cmd,"noaggregate-addressA.B.C.DA.B.C.D[<as-set[summary-only]|summary-only[as
-set]>]",NO_STR"ConfigureBGPaggregateentries\n""Aggregateaddress\n""Aggregatemas
k\n""GenerateASsetpathinformation\n""Filtermorespecificroutesfromupdates\n""Filt
ermorespecificroutesfromupdates\n""GenerateASsetpathinformation\n"){intidx=0;arg
v_find(argv,argc,"A.B.C.D",&idx);char*prefix=argv[idx]->arg;char*mask=argv[idx+1
]->arg;charprefix_str[BUFSIZ];intret=netmask_str2prefix_str(prefix,mask,prefix_s
tr);if(!ret){vty_out(vty,"%%Inconsistentaddressandmask\n");returnCMD_WARNING_CON
FIG_FAILED;}returnbgp_aggregate_unset(vty,prefix_str,AFI_IP,bgp_node_safi(vty));
}DEFUN(ipv6_aggregate_address,ipv6_aggregate_address_cmd,"aggregate-addressX:X::
X:X/M[summary-only]","ConfigureBGPaggregateentries\n""Aggregateprefix\n""Filterm
orespecificroutesfromupdates\n"){intidx=0;argv_find(argv,argc,"X:X::X:X/M",&idx)
;char*prefix=argv[idx]->arg;intsum_only=argv_find(argv,argc,"summary-only",&idx)
?AGGREGATE_SUMMARY_ONLY:0;returnbgp_aggregate_set(vty,prefix,AFI_IP6,SAFI_UNICAS
T,sum_only,0);}DEFUN(no_ipv6_aggregate_address,no_ipv6_aggregate_address_cmd,"no
aggregate-addressX:X::X:X/M[summary-only]",NO_STR"ConfigureBGPaggregateentries\n
""Aggregateprefix\n""Filtermorespecificroutesfromupdates\n"){intidx=0;argv_find(
argv,argc,"X:X::X:X/M",&idx);char*prefix=argv[idx]->arg;returnbgp_aggregate_unse
t(vty,prefix,AFI_IP6,SAFI_UNICAST);}/*Redistributeroutetreatment.*/voidbgp_redis
tribute_add(structbgp*bgp,structprefix*p,constuniong_addr*nexthop,ifindex_tifind
ex,enumnexthop_types_tnhtype,uint32_tmetric,uint8_ttype,unsignedshortinstance,ro
ute_tag_ttag){structbgp_info*new;structbgp_info*bi;structbgp_infoinfo;structbgp_
node*bn;structattrattr;structattr*new_attr;afi_tafi;intret;structbgp_redist*red;
/*Makedefaultattribute.*/bgp_attr_default_set(&attr,BGP_ORIGIN_INCOMPLETE);switc
h(nhtype){caseNEXTHOP_TYPE_IFINDEX:break;caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_
IPV4_IFINDEX:attr.nexthop=nexthop->ipv4;break;caseNEXTHOP_TYPE_IPV6:caseNEXTHOP_
TYPE_IPV6_IFINDEX:attr.mp_nexthop_global=nexthop->ipv6;attr.mp_nexthop_len=BGP_A
TTR_NHLEN_IPV6_GLOBAL;break;caseNEXTHOP_TYPE_BLACKHOLE:switch(p->family){caseAF_
INET:attr.nexthop.s_addr=INADDR_ANY;break;caseAF_INET6:memset(&attr.mp_nexthop_g
lobal,0,sizeof(attr.mp_nexthop_global));attr.mp_nexthop_len=BGP_ATTR_NHLEN_IPV6_
GLOBAL;break;}break;}attr.nh_ifindex=ifindex;attr.med=metric;attr.flag|=ATTR_FLA
G_BIT(BGP_ATTR_MULTI_EXIT_DISC);attr.tag=tag;afi=family2afi(p->family);red=bgp_r
edist_lookup(bgp,afi,type,instance);if(red){structattrattr_new;/*Copyattributefo
rmodification.*/bgp_attr_dup(&attr_new,&attr);if(red->redist_metric_flag)attr_ne
w.med=red->redist_metric;/*Applyroute-map.*/if(red->rmap.name){info.peer=bgp->pe
er_self;info.attr=&attr_new;SET_FLAG(bgp->peer_self->rmap_type,PEER_RMAP_TYPE_RE
DISTRIBUTE);ret=route_map_apply(red->rmap.map,p,RMAP_BGP,&info);bgp->peer_self->
rmap_type=0;if(ret==RMAP_DENYMATCH){/*Freeuninternedattribute.*/bgp_attr_flush(&
attr_new);/*Uninternoriginal.*/aspath_unintern(&attr.aspath);bgp_redistribute_de
lete(bgp,p,type,instance);return;}}if(bgp_flag_check(bgp,BGP_FLAG_GRACEFUL_SHUTD
OWN))bgp_attr_add_gshut_community(&attr_new);bn=bgp_afi_node_get(bgp->rib[afi][S
AFI_UNICAST],afi,SAFI_UNICAST,p,NULL);new_attr=bgp_attr_intern(&attr_new);for(bi
=bn->info;bi;bi=bi->next)if(bi->peer==bgp->peer_self&&bi->sub_type==BGP_ROUTE_RE
DISTRIBUTE)break;if(bi){/*Ensurethe(sourceroute)typeisupdated.*/bi->type=type;if
(attrhash_cmp(bi->attr,new_attr)&&!CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){bgp_a
ttr_unintern(&new_attr);aspath_unintern(&attr.aspath);bgp_unlock_node(bn);return
;}else{/*Theattributeischanged.*/bgp_info_set_flag(bn,bi,BGP_INFO_ATTR_CHANGED);
/*RewriteBGProuteinformation.*/if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))bgp_inf
o_restore(bn,bi);elsebgp_aggregate_decrement(bgp,p,bi,afi,SAFI_UNICAST);bgp_attr
_unintern(&bi->attr);bi->attr=new_attr;bi->uptime=bgp_clock();/*Processchange.*/
bgp_aggregate_increment(bgp,p,bi,afi,SAFI_UNICAST);bgp_process(bgp,bn,afi,SAFI_U
NICAST);bgp_unlock_node(bn);aspath_unintern(&attr.aspath);if((bgp->inst_type==BG
P_INSTANCE_TYPE_VRF)||(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from
_vrf_update(bgp_get_default(),bgp,bi);}return;}}new=info_make(type,BGP_ROUTE_RED
ISTRIBUTE,instance,bgp->peer_self,new_attr,bn);SET_FLAG(new->flags,BGP_INFO_VALI
D);bgp_aggregate_increment(bgp,p,new,afi,SAFI_UNICAST);bgp_info_add(bn,new);bgp_
unlock_node(bn);bgp_process(bgp,bn,afi,SAFI_UNICAST);if((bgp->inst_type==BGP_INS
TANCE_TYPE_VRF)||(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_
update(bgp_get_default(),bgp,new);}}/*Uninternoriginal.*/aspath_unintern(&attr.a
spath);}voidbgp_redistribute_delete(structbgp*bgp,structprefix*p,uint8_ttype,uns
ignedshortinstance){afi_tafi;structbgp_node*rn;structbgp_info*ri;structbgp_redis
t*red;afi=family2afi(p->family);red=bgp_redist_lookup(bgp,afi,type,instance);if(
red){rn=bgp_afi_node_get(bgp->rib[afi][SAFI_UNICAST],afi,SAFI_UNICAST,p,NULL);fo
r(ri=rn->info;ri;ri=ri->next)if(ri->peer==bgp->peer_self&&ri->type==type)break;i
f(ri){if((bgp->inst_type==BGP_INSTANCE_TYPE_VRF)||(bgp->inst_type==BGP_INSTANCE_
TYPE_DEFAULT)){vpn_leak_from_vrf_withdraw(bgp_get_default(),bgp,ri);}bgp_aggrega
te_decrement(bgp,p,ri,afi,SAFI_UNICAST);bgp_info_delete(rn,ri);bgp_process(bgp,r
n,afi,SAFI_UNICAST);}bgp_unlock_node(rn);}}/*Withdrawspecifiedroutetype'sroute.*
/voidbgp_redistribute_withdraw(structbgp*bgp,afi_tafi,inttype,unsignedshortinsta
nce){structbgp_node*rn;structbgp_info*ri;structbgp_table*table;table=bgp->rib[af
i][SAFI_UNICAST];for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn)){for(ri=rn
->info;ri;ri=ri->next)if(ri->peer==bgp->peer_self&&ri->type==type&&ri->instance=
=instance)break;if(ri){if((bgp->inst_type==BGP_INSTANCE_TYPE_VRF)||(bgp->inst_ty
pe==BGP_INSTANCE_TYPE_DEFAULT)){vpn_leak_from_vrf_withdraw(bgp_get_default(),bgp
,ri);}bgp_aggregate_decrement(bgp,&rn->p,ri,afi,SAFI_UNICAST);bgp_info_delete(rn
,ri);bgp_process(bgp,rn,afi,SAFI_UNICAST);}}}/*Staticfunctiontodisplayroute.*/st
aticvoidroute_vty_out_route(structprefix*p,structvty*vty,json_object*json){intle
n=0;uint32_tdestination;charbuf[BUFSIZ];if(p->family==AF_INET){if(!json){len=vty
_out(vty,"%s",inet_ntop(p->family,&p->u.prefix,buf,BUFSIZ));destination=ntohl(p-
>u.prefix4.s_addr);if((IN_CLASSC(destination)&&p->prefixlen==24)||(IN_CLASSB(des
tination)&&p->prefixlen==16)||(IN_CLASSA(destination)&&p->prefixlen==8)||p->u.pr
efix4.s_addr==0){/*Whenmaskisnatural,maskisnotdisplayed.*/}elselen+=vty_out(vty,
"/%d",p->prefixlen);}else{json_object_string_add(json,"prefix",inet_ntop(p->fami
ly,&p->u.prefix,buf,BUFSIZ));json_object_int_add(json,"prefixLen",p->prefixlen);
}}elseif(p->family==AF_ETHERNET){prefix2str(p,buf,PREFIX_STRLEN);len=vty_out(vty
,"%s",buf);}elseif(p->family==AF_EVPN){#ifdefined(HAVE_CUMULUS)if(!json)len=vty_
out(vty,"%s",bgp_evpn_route2str((structprefix_evpn*)p,buf,BUFSIZ));elsebgp_evpn_
route2json((structprefix_evpn*)p,json);#elseprefix2str(p,buf,PREFIX_STRLEN);len=
vty_out(vty,"%s",buf);#endif}elseif(p->family==AF_FLOWSPEC){route_vty_out_flowsp
ec(vty,p,NULL,json?NLRI_STRING_FORMAT_JSON_SIMPLE:NLRI_STRING_FORMAT_MIN,json);}
else{if(!json)len=vty_out(vty,"%s/%d",inet_ntop(p->family,&p->u.prefix,buf,BUFSI
Z),p->prefixlen);}if(!json){len=17-len;if(len<1)vty_out(vty,"\n%*s",20,"");elsev
ty_out(vty,"%*s",len,"");}}enumbgp_display_type{normal_list,};/*Printtheshortfor
mroutestatusforabgp_info*/staticvoidroute_vty_short_status_out(structvty*vty,str
uctbgp_info*binfo,json_object*json_path){if(json_path){/*Routestatusdisplay.*/if
(CHECK_FLAG(binfo->flags,BGP_INFO_REMOVED))json_object_boolean_true_add(json_pat
h,"removed");if(CHECK_FLAG(binfo->flags,BGP_INFO_STALE))json_object_boolean_true
_add(json_path,"stale");if(binfo->extra&&binfo->extra->suppress)json_object_bool
ean_true_add(json_path,"suppressed");if(CHECK_FLAG(binfo->flags,BGP_INFO_VALID)&
&!CHECK_FLAG(binfo->flags,BGP_INFO_HISTORY))json_object_boolean_true_add(json_pa
th,"valid");/*Selected*/if(CHECK_FLAG(binfo->flags,BGP_INFO_HISTORY))json_object
_boolean_true_add(json_path,"history");if(CHECK_FLAG(binfo->flags,BGP_INFO_DAMPE
D))json_object_boolean_true_add(json_path,"damped");if(CHECK_FLAG(binfo->flags,B
GP_INFO_SELECTED))json_object_boolean_true_add(json_path,"bestpath");if(CHECK_FL
AG(binfo->flags,BGP_INFO_MULTIPATH))json_object_boolean_true_add(json_path,"mult
ipath");/*Internalroute.*/if((binfo->peer->as)&&(binfo->peer->as==binfo->peer->l
ocal_as))json_object_string_add(json_path,"pathFrom","internal");elsejson_object
_string_add(json_path,"pathFrom","external");return;}/*Routestatusdisplay.*/if(C
HECK_FLAG(binfo->flags,BGP_INFO_REMOVED))vty_out(vty,"R");elseif(CHECK_FLAG(binf
o->flags,BGP_INFO_STALE))vty_out(vty,"S");elseif(binfo->extra&&binfo->extra->sup
press)vty_out(vty,"s");elseif(CHECK_FLAG(binfo->flags,BGP_INFO_VALID)&&!CHECK_FL
AG(binfo->flags,BGP_INFO_HISTORY))vty_out(vty,"*");elsevty_out(vty,"");/*Selecte
d*/if(CHECK_FLAG(binfo->flags,BGP_INFO_HISTORY))vty_out(vty,"h");elseif(CHECK_FL
AG(binfo->flags,BGP_INFO_DAMPED))vty_out(vty,"d");elseif(CHECK_FLAG(binfo->flags
,BGP_INFO_SELECTED))vty_out(vty,">");elseif(CHECK_FLAG(binfo->flags,BGP_INFO_MUL
TIPATH))vty_out(vty,"=");elsevty_out(vty,"");/*Internalroute.*/if(binfo->peer&&(
binfo->peer->as)&&(binfo->peer->as==binfo->peer->local_as))vty_out(vty,"i");else
vty_out(vty,"");}/*calledfromterminallistcommand*/voidroute_vty_out(structvty*vt
y,structprefix*p,structbgp_info*binfo,intdisplay,safi_tsafi,json_object*json_pat
hs){structattr*attr;json_object*json_path=NULL;json_object*json_nexthops=NULL;js
on_object*json_nexthop_global=NULL;json_object*json_nexthop_ll=NULL;if(json_path
s)json_path=json_object_new_object();/*shortstatusleadtext*/route_vty_short_stat
us_out(vty,binfo,json_path);if(!json_paths){/*printprefixandmask*/if(!display)ro
ute_vty_out_route(p,vty,json_path);elsevty_out(vty,"%*s",17,"");}else{route_vty_
out_route(p,vty,json_path);}/*Printattribute*/attr=binfo->attr;if(!attr){if(json
_paths)json_object_array_add(json_paths,json_path);elsevty_out(vty,"\n");return;
}/**ForENCAPandEVPNroutes,nexthopaddressfamilyisnot*neccessarilythesameasthepref
ixaddressfamily.*BothSAFI_MPLS_VPNandSAFI_ENCAPusetheMPnexthopfield*EVPNroutesar
ealsoexchangedwithaMPnexthop.Currently,*this*isonlyIPv4,thevaluewillbepresentine
ither*attr->nexthopor*attr->mp_nexthop_global_in*/if((safi==SAFI_ENCAP)||(safi==
SAFI_MPLS_VPN)){charbuf[BUFSIZ];charnexthop[128];intaf=NEXTHOP_FAMILY(attr->mp_n
exthop_len);switch(af){caseAF_INET:sprintf(nexthop,"%s",inet_ntop(af,&attr->mp_n
exthop_global_in,buf,BUFSIZ));break;caseAF_INET6:sprintf(nexthop,"%s",inet_ntop(
af,&attr->mp_nexthop_global,buf,BUFSIZ));break;default:sprintf(nexthop,"?");brea
k;}if(json_paths){json_nexthop_global=json_object_new_object();json_object_strin
g_add(json_nexthop_global,"afi",(af==AF_INET)?"ip":"ipv6");json_object_string_ad
d(json_nexthop_global,(af==AF_INET)?"ip":"ipv6",nexthop);json_object_boolean_tru
e_add(json_nexthop_global,"used");}elsevty_out(vty,"%s",nexthop);}elseif(safi==S
AFI_EVPN){if(json_paths){json_nexthop_global=json_object_new_object();json_objec
t_string_add(json_nexthop_global,"ip",inet_ntoa(attr->nexthop));json_object_stri
ng_add(json_nexthop_global,"afi","ipv4");json_object_boolean_true_add(json_nexth
op_global,"used");}elsevty_out(vty,"%-16s",inet_ntoa(attr->nexthop));}elseif(saf
i==SAFI_FLOWSPEC){/*alreadydone*//*IPv4NextHop*/}elseif(p->family==AF_INET&&!BGP
_ATTR_NEXTHOP_AFI_IP6(attr)){if(json_paths){json_nexthop_global=json_object_new_
object();if((safi==SAFI_MPLS_VPN)||(safi==SAFI_EVPN))json_object_string_add(json
_nexthop_global,"ip",inet_ntoa(attr->mp_nexthop_global_in));elsejson_object_stri
ng_add(json_nexthop_global,"ip",inet_ntoa(attr->nexthop));json_object_string_add
(json_nexthop_global,"afi","ipv4");json_object_boolean_true_add(json_nexthop_glo
bal,"used");}else{if((safi==SAFI_MPLS_VPN)||(safi==SAFI_EVPN))vty_out(vty,"%-16s
",inet_ntoa(attr->mp_nexthop_global_in));elsevty_out(vty,"%-16s",inet_ntoa(attr-
>nexthop));}}/*IPv6NextHop*/elseif(p->family==AF_INET6||BGP_ATTR_NEXTHOP_AFI_IP6
(attr)){intlen;charbuf[BUFSIZ];if(json_paths){json_nexthop_global=json_object_ne
w_object();json_object_string_add(json_nexthop_global,"ip",inet_ntop(AF_INET6,&a
ttr->mp_nexthop_global,buf,BUFSIZ));json_object_string_add(json_nexthop_global,"
afi","ipv6");json_object_string_add(json_nexthop_global,"scope","global");/*Wedi
splaybothLL&GLifbothhavebeen*received*/if((attr->mp_nexthop_len==32)||(binfo->pe
er->conf_if)){json_nexthop_ll=json_object_new_object();json_object_string_add(js
on_nexthop_ll,"ip",inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf,BUFSIZ));json_
object_string_add(json_nexthop_ll,"afi","ipv6");json_object_string_add(json_next
hop_ll,"scope","link-local");if((IPV6_ADDR_CMP(&attr->mp_nexthop_global,&attr->m
p_nexthop_local)!=0)&&!attr->mp_nexthop_prefer_global)json_object_boolean_true_a
dd(json_nexthop_ll,"used");elsejson_object_boolean_true_add(json_nexthop_global,
"used");}elsejson_object_boolean_true_add(json_nexthop_global,"used");}else{/*Di
splayLLifLL/Globalbothintableunless*prefer-globalisset*/if(((attr->mp_nexthop_le
n==32)&&!attr->mp_nexthop_prefer_global)||(binfo->peer->conf_if)){if(binfo->peer
->conf_if){len=vty_out(vty,"%s",binfo->peer->conf_if);len=16-len;/*lenofIPv6addr
+maxlenofdefifname*/if(len<1)vty_out(vty,"\n%*s",36,"");elsevty_out(vty,"%*s",le
n,"");}else{len=vty_out(vty,"%s",inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf,
BUFSIZ));len=16-len;if(len<1)vty_out(vty,"\n%*s",36,"");elsevty_out(vty,"%*s",le
n,"");}}else{len=vty_out(vty,"%s",inet_ntop(AF_INET6,&attr->mp_nexthop_global,bu
f,BUFSIZ));len=16-len;if(len<1)vty_out(vty,"\n%*s",36,"");elsevty_out(vty,"%*s",
len,"");}}}/*MED/Metric*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC))i
f(json_paths)json_object_int_add(json_path,"med",attr->med);elsevty_out(vty,"%10
u",attr->med);elseif(!json_paths)vty_out(vty,"");/*LocalPref*/if(attr->flag&ATTR
_FLAG_BIT(BGP_ATTR_LOCAL_PREF))if(json_paths)json_object_int_add(json_path,"loca
lpref",attr->local_pref);elsevty_out(vty,"%7u",attr->local_pref);elseif(!json_pa
ths)vty_out(vty,"");if(json_paths)json_object_int_add(json_path,"weight",attr->w
eight);elsevty_out(vty,"%7u",attr->weight);if(json_paths){charbuf[BUFSIZ];json_o
bject_string_add(json_path,"peerId",sockunion2str(&binfo->peer->su,buf,SU_ADDRST
RLEN));}/*Printaspath*/if(attr->aspath){if(json_paths)json_object_string_add(jso
n_path,"aspath",attr->aspath->str);elseaspath_print_vty(vty,"%s",attr->aspath,""
);}/*Printorigin*/if(json_paths)json_object_string_add(json_path,"origin",bgp_or
igin_long_str[attr->origin]);elsevty_out(vty,"%s",bgp_origin_str[attr->origin]);
if(json_paths){if(json_nexthop_global||json_nexthop_ll){json_nexthops=json_objec
t_new_array();if(json_nexthop_global)json_object_array_add(json_nexthops,json_ne
xthop_global);if(json_nexthop_ll)json_object_array_add(json_nexthops,json_nextho
p_ll);json_object_object_add(json_path,"nexthops",json_nexthops);}json_object_ar
ray_add(json_paths,json_path);}else{vty_out(vty,"\n");#ifENABLE_BGP_VNC/*printsa
nadditionalline,indented,withVNCinfo,if*present*/if((safi==SAFI_MPLS_VPN)||(safi
==SAFI_ENCAP))rfapi_vty_out_vncinfo(vty,p,binfo,safi);#endif}}/*calledfromtermin
allistcommand*/voidroute_vty_out_tmp(structvty*vty,structprefix*p,structattr*att
r,safi_tsafi,uint8_tuse_json,json_object*json_ar){json_object*json_status=NULL;j
son_object*json_net=NULL;charbuff[BUFSIZ];/*Routestatusdisplay.*/if(use_json){js
on_status=json_object_new_object();json_net=json_object_new_object();}else{vty_o
ut(vty,"*");vty_out(vty,">");vty_out(vty,"");}/*printprefixandmask*/if(use_json)
json_object_string_add(json_net,"addrPrefix",inet_ntop(p->family,&p->u.prefix,bu
ff,BUFSIZ));elseroute_vty_out_route(p,vty,NULL);/*Printattribute*/if(attr){if(us
e_json){if(p->family==AF_INET&&(safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP||safi==SAF
I_EVPN||!BGP_ATTR_NEXTHOP_AFI_IP6(attr))){if(safi==SAFI_MPLS_VPN||safi==SAFI_ENC
AP||safi==SAFI_EVPN)json_object_string_add(json_net,"nextHop",inet_ntoa(attr->mp
_nexthop_global_in));elsejson_object_string_add(json_net,"nextHop",inet_ntoa(att
r->nexthop));}elseif(p->family==AF_INET6||BGP_ATTR_NEXTHOP_AFI_IP6(attr)){charbu
f[BUFSIZ];json_object_string_add(json_net,"netHopGloabal",inet_ntop(AF_INET6,&at
tr->mp_nexthop_global,buf,BUFSIZ));}if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_E
XIT_DISC))json_object_int_add(json_net,"metric",attr->med);if(attr->flag&ATTR_FL
AG_BIT(BGP_ATTR_LOCAL_PREF))json_object_int_add(json_net,"localPref",attr->local
_pref);json_object_int_add(json_net,"weight",attr->weight);/*Printaspath*/if(att
r->aspath)json_object_string_add(json_net,"asPath",attr->aspath->str);/*Printori
gin*/json_object_string_add(json_net,"bgpOriginCode",bgp_origin_str[attr->origin
]);}else{if(p->family==AF_INET&&(safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP||safi==SA
FI_EVPN||!BGP_ATTR_NEXTHOP_AFI_IP6(attr))){if(safi==SAFI_MPLS_VPN||safi==SAFI_EN
CAP||safi==SAFI_EVPN)vty_out(vty,"%-16s",inet_ntoa(attr->mp_nexthop_global_in));
elsevty_out(vty,"%-16s",inet_ntoa(attr->nexthop));}elseif(p->family==AF_INET6||B
GP_ATTR_NEXTHOP_AFI_IP6(attr)){intlen;charbuf[BUFSIZ];len=vty_out(vty,"%s",inet_
ntop(AF_INET6,&attr->mp_nexthop_global,buf,BUFSIZ));len=16-len;if(len<1)vty_out(
vty,"\n%*s",36,"");elsevty_out(vty,"%*s",len,"");}if(attr->flag&ATTR_FLAG_BIT(BG
P_ATTR_MULTI_EXIT_DISC))vty_out(vty,"%10u",attr->med);elsevty_out(vty,"");if(att
r->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF))vty_out(vty,"%7u",attr->local_pref);e
lsevty_out(vty,"");vty_out(vty,"%7u",attr->weight);/*Printaspath*/if(attr->aspat
h)aspath_print_vty(vty,"%s",attr->aspath,"");/*Printorigin*/vty_out(vty,"%s",bgp
_origin_str[attr->origin]);}}if(use_json){json_object_boolean_true_add(json_stat
us,"*");json_object_boolean_true_add(json_status,">");json_object_object_add(jso
n_net,"appliedStatusSymbols",json_status);charbuf_cut[BUFSIZ];json_object_object
_add(json_ar,inet_ntop(p->family,&p->u.prefix,buf_cut,BUFSIZ),json_net);}elsevty
_out(vty,"\n");}voidroute_vty_out_tag(structvty*vty,structprefix*p,structbgp_inf
o*binfo,intdisplay,safi_tsafi,json_object*json){json_object*json_out=NULL;struct
attr*attr;mpls_label_tlabel=MPLS_INVALID_LABEL;if(!binfo->extra)return;if(json)j
son_out=json_object_new_object();/*shortstatusleadtext*/route_vty_short_status_o
ut(vty,binfo,json_out);/*printprefixandmask*/if(json==NULL){if(!display)route_vt
y_out_route(p,vty,NULL);elsevty_out(vty,"%*s",17,"");}/*Printattribute*/attr=bin
fo->attr;if(attr){if(((p->family==AF_INET)&&((safi==SAFI_MPLS_VPN||safi==SAFI_EN
CAP)))||(safi==SAFI_EVPN&&!BGP_ATTR_NEXTHOP_AFI_IP6(attr))||(!BGP_ATTR_NEXTHOP_A
FI_IP6(attr))){if(safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP||safi==SAFI_EVPN){if(jso
n)json_object_string_add(json_out,"mpNexthopGlobalIn",inet_ntoa(attr->mp_nexthop
_global_in));elsevty_out(vty,"%-16s",inet_ntoa(attr->mp_nexthop_global_in));}els
e{if(json)json_object_string_add(json_out,"nexthop",inet_ntoa(attr->nexthop));el
sevty_out(vty,"%-16s",inet_ntoa(attr->nexthop));}}elseif(((p->family==AF_INET6)&
&((safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP)))||(safi==SAFI_EVPN&&BGP_ATTR_NEXTHOP_
AFI_IP6(attr))||(BGP_ATTR_NEXTHOP_AFI_IP6(attr))){charbuf_a[BUFSIZ];charbuf_b[BU
FSIZ];charbuf_c[BUFSIZ];if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL){if(
json)json_object_string_add(json_out,"mpNexthopGlobalIn",inet_ntop(AF_INET6,&att
r->mp_nexthop_global,buf_a,BUFSIZ));elsevty_out(vty,"%s",inet_ntop(AF_INET6,&att
r->mp_nexthop_global,buf_a,BUFSIZ));}elseif(attr->mp_nexthop_len==BGP_ATTR_NHLEN
_IPV6_GLOBAL_AND_LL){if(json){inet_ntop(AF_INET6,&attr->mp_nexthop_global,buf_a,
BUFSIZ);inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf_b,BUFSIZ);sprintf(buf_c,"
%s(%s)",buf_a,buf_b);json_object_string_add(json_out,"mpNexthopGlobalLocal",buf_
c);}elsevty_out(vty,"%s(%s)",inet_ntop(AF_INET6,&attr->mp_nexthop_global,buf_a,B
UFSIZ),inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf_b,BUFSIZ));}}}label=decode
_label(&binfo->extra->label[0]);if(bgp_is_valid_label(&label)){if(json){json_obj
ect_int_add(json_out,"notag",label);json_object_array_add(json,json_out);}else{v
ty_out(vty,"notag/%d",label);vty_out(vty,"\n");}}}voidroute_vty_out_overlay(stru
ctvty*vty,structprefix*p,structbgp_info*binfo,intdisplay,json_object*json_paths)
{structattr*attr;charbuf[BUFSIZ];json_object*json_path=NULL;if(json_paths)json_p
ath=json_object_new_object();if(!binfo->extra)return;/*shortstatusleadtext*/rout
e_vty_short_status_out(vty,binfo,json_path);/*printprefixandmask*/if(!display)ro
ute_vty_out_route(p,vty,NULL);elsevty_out(vty,"%*s",17,"");/*Printattribute*/att
r=binfo->attr;if(attr){charbuf1[BUFSIZ];intaf=NEXTHOP_FAMILY(attr->mp_nexthop_le
n);switch(af){caseAF_INET:vty_out(vty,"%-16s",inet_ntop(af,&attr->mp_nexthop_glo
bal_in,buf,BUFSIZ));break;caseAF_INET6:vty_out(vty,"%s(%s)",inet_ntop(af,&attr->
mp_nexthop_global,buf,BUFSIZ),inet_ntop(af,&attr->mp_nexthop_local,buf1,BUFSIZ))
;break;default:vty_out(vty,"?");}}structeth_segment_id*id=&(attr->evpn_overlay.e
th_s_id);char*str=esi2str(id);vty_out(vty,"%s",str);XFREE(MTYPE_TMP,str);if(IS_E
VPN_PREFIX_IPADDR_V4((structprefix_evpn*)p)){vty_out(vty,"/%s",inet_ntoa(attr->e
vpn_overlay.gw_ip.ipv4));}elseif(IS_EVPN_PREFIX_IPADDR_V6((structprefix_evpn*)p)
){vty_out(vty,"/%s",inet_ntop(AF_INET6,&(attr->evpn_overlay.gw_ip.ipv6),buf,BUFS
IZ));}if(attr->ecommunity){char*mac=NULL;structecommunity_val*routermac=ecommuni
ty_lookup(attr->ecommunity,ECOMMUNITY_ENCODE_EVPN,ECOMMUNITY_EVPN_SUBTYPE_ROUTER
MAC);if(routermac)mac=ecom_mac2str((char*)routermac->val);if(mac){vty_out(vty,"/
%s",(char*)mac);XFREE(MTYPE_TMP,mac);}}vty_out(vty,"\n");}/*dampeningroute*/stat
icvoiddamp_route_vty_out(structvty*vty,structprefix*p,structbgp_info*binfo,intdi
splay,safi_tsafi,uint8_tuse_json,json_object*json){structattr*attr;intlen;charti
mebuf[BGP_UPTIME_LEN];/*shortstatusleadtext*/route_vty_short_status_out(vty,binf
o,json);/*printprefixandmask*/if(!use_json){if(!display)route_vty_out_route(p,vt
y,NULL);elsevty_out(vty,"%*s",17,"");}len=vty_out(vty,"%s",binfo->peer->host);le
n=17-len;if(len<1){if(!use_json)vty_out(vty,"\n%*s",34,"");}else{if(use_json)jso
n_object_int_add(json,"peerHost",len);elsevty_out(vty,"%*s",len,"");}if(use_json
)bgp_damp_reuse_time_vty(vty,binfo,timebuf,BGP_UPTIME_LEN,use_json,json);elsevty
_out(vty,"%s",bgp_damp_reuse_time_vty(vty,binfo,timebuf,BGP_UPTIME_LEN,use_json,
json));/*Printattribute*/attr=binfo->attr;if(attr){/*Printaspath*/if(attr->aspat
h){if(use_json)json_object_string_add(json,"asPath",attr->aspath->str);elseaspat
h_print_vty(vty,"%s",attr->aspath,"");}/*Printorigin*/if(use_json)json_object_st
ring_add(json,"origin",bgp_origin_str[attr->origin]);elsevty_out(vty,"%s",bgp_or
igin_str[attr->origin]);}if(!use_json)vty_out(vty,"\n");}/*flaproute*/staticvoid
flap_route_vty_out(structvty*vty,structprefix*p,structbgp_info*binfo,intdisplay,
safi_tsafi,uint8_tuse_json,json_object*json){structattr*attr;structbgp_damp_info
*bdi;chartimebuf[BGP_UPTIME_LEN];intlen;if(!binfo->extra)return;bdi=binfo->extra
->damp_info;/*shortstatusleadtext*/route_vty_short_status_out(vty,binfo,json);/*
printprefixandmask*/if(!use_json){if(!display)route_vty_out_route(p,vty,NULL);el
sevty_out(vty,"%*s",17,"");}len=vty_out(vty,"%s",binfo->peer->host);len=16-len;i
f(len<1){if(!use_json)vty_out(vty,"\n%*s",33,"");}else{if(use_json)json_object_i
nt_add(json,"peerHost",len);elsevty_out(vty,"%*s",len,"");}len=vty_out(vty,"%d",
bdi->flap);len=5-len;if(len<1){if(!use_json)vty_out(vty,"");}else{if(use_json)js
on_object_int_add(json,"bdiFlap",len);elsevty_out(vty,"%*s",len,"");}if(use_json
)peer_uptime(bdi->start_time,timebuf,BGP_UPTIME_LEN,use_json,json);elsevty_out(v
ty,"%s",peer_uptime(bdi->start_time,timebuf,BGP_UPTIME_LEN,0,NULL));if(CHECK_FLA
G(binfo->flags,BGP_INFO_DAMPED)&&!CHECK_FLAG(binfo->flags,BGP_INFO_HISTORY)){if(
use_json)bgp_damp_reuse_time_vty(vty,binfo,timebuf,BGP_UPTIME_LEN,use_json,json)
;elsevty_out(vty,"%s",bgp_damp_reuse_time_vty(vty,binfo,timebuf,BGP_UPTIME_LEN,u
se_json,json));}else{if(!use_json)vty_out(vty,"%*s",8,"");}/*Printattribute*/att
r=binfo->attr;if(attr){/*Printaspath*/if(attr->aspath){if(use_json)json_object_s
tring_add(json,"asPath",attr->aspath->str);elseaspath_print_vty(vty,"%s",attr->a
spath,"");}/*Printorigin*/if(use_json)json_object_string_add(json,"origin",bgp_o
rigin_str[attr->origin]);elsevty_out(vty,"%s",bgp_origin_str[attr->origin]);}if(
!use_json)vty_out(vty,"\n");}staticvoidroute_vty_out_advertised_to(structvty*vty
,structpeer*peer,int*first,constchar*header,json_object*json_adv_to){charbuf1[IN
ET6_ADDRSTRLEN];json_object*json_peer=NULL;if(json_adv_to){/*'advertised-to'isad
ictionaryofpeerswehaveadvertised*this*prefixtoo.Thekeyisthepeer'sIPorswpX,theval
ueis*the*hostnameifweknowitand""ifnot.*/json_peer=json_object_new_object();if(pe
er->hostname)json_object_string_add(json_peer,"hostname",peer->hostname);if(peer
->conf_if)json_object_object_add(json_adv_to,peer->conf_if,json_peer);elsejson_o
bject_object_add(json_adv_to,sockunion2str(&peer->su,buf1,SU_ADDRSTRLEN),json_pe
er);}else{if(*first){vty_out(vty,"%s",header);*first=0;}if(peer->hostname&&bgp_f
lag_check(peer->bgp,BGP_FLAG_SHOW_HOSTNAME)){if(peer->conf_if)vty_out(vty,"%s(%s
)",peer->hostname,peer->conf_if);elsevty_out(vty,"%s(%s)",peer->hostname,sockuni
on2str(&peer->su,buf1,SU_ADDRSTRLEN));}else{if(peer->conf_if)vty_out(vty,"%s",pe
er->conf_if);elsevty_out(vty,"%s",sockunion2str(&peer->su,buf1,SU_ADDRSTRLEN));}
}}voidroute_vty_out_detail(structvty*vty,structbgp*bgp,structprefix*p,structbgp_
info*binfo,afi_tafi,safi_tsafi,json_object*json_paths){charbuf[INET6_ADDRSTRLEN]
;charbuf1[BUFSIZ];#ifdefined(HAVE_CUMULUS)charbuf2[EVPN_ROUTE_STRLEN];#endifstru
ctattr*attr;intsockunion_vty_out(structvty*,unionsockunion*);time_ttbuf;json_obj
ect*json_bestpath=NULL;json_object*json_cluster_list=NULL;json_object*json_clust
er_list_list=NULL;json_object*json_ext_community=NULL;json_object*json_lcommunit
y=NULL;json_object*json_last_update=NULL;json_object*json_pmsi=NULL;json_object*
json_nexthop_global=NULL;json_object*json_nexthop_ll=NULL;json_object*json_nexth
ops=NULL;json_object*json_path=NULL;json_object*json_peer=NULL;json_object*json_
string=NULL;json_object*json_adv_to=NULL;intfirst=0;structlistnode*node,*nnode;s
tructpeer*peer;intaddpath_capable;inthas_adj;unsignedintfirst_as;if(json_paths){
json_path=json_object_new_object();json_peer=json_object_new_object();json_nexth
op_global=json_object_new_object();}#ifdefined(HAVE_CUMULUS)if(!json_paths&&safi
==SAFI_EVPN){chartag_buf[30];bgp_evpn_route2str((structprefix_evpn*)p,buf2,sizeo
f(buf2));vty_out(vty,"Route%s",buf2);tag_buf[0]='\0';if(binfo->extra&&binfo->ext
ra->num_labels){bgp_evpn_label2str(binfo->extra->label,binfo->extra->num_labels,
tag_buf,sizeof(tag_buf));vty_out(vty,"VNI%s",tag_buf);}vty_out(vty,"\n");if(binf
o->extra&&binfo->extra->parent){structbgp_info*parent_ri;structbgp_node*rn,*prn;
parent_ri=(structbgp_info*)binfo->extra->parent;rn=parent_ri->net;if(rn&&rn->prn
){prn=rn->prn;vty_out(vty,"Importedfrom%s:%s\n",prefix_rd2str((structprefix_rd*)
&prn->p,buf1,sizeof(buf1)),buf2);}}}#endifattr=binfo->attr;if(attr){/*Line1displ
ayAS-path,Aggregator*/if(attr->aspath){if(json_paths){if(!attr->aspath->json)asp
ath_str_update(attr->aspath,true);json_object_lock(attr->aspath->json);json_obje
ct_object_add(json_path,"aspath",attr->aspath->json);}else{if(attr->aspath->segm
ents)aspath_print_vty(vty,"%s",attr->aspath,"");elsevty_out(vty,"Local");}}if(CH
ECK_FLAG(binfo->flags,BGP_INFO_REMOVED)){if(json_paths)json_object_boolean_true_
add(json_path,"removed");elsevty_out(vty,",(removed)");}if(CHECK_FLAG(binfo->fla
gs,BGP_INFO_STALE)){if(json_paths)json_object_boolean_true_add(json_path,"stale"
);elsevty_out(vty,",(stale)");}if(CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_A
GGREGATOR))){if(json_paths){json_object_int_add(json_path,"aggregatorAs",attr->a
ggregator_as);json_object_string_add(json_path,"aggregatorId",inet_ntoa(attr->ag
gregator_addr));}else{vty_out(vty,",(aggregatedby%u%s)",attr->aggregator_as,inet
_ntoa(attr->aggregator_addr));}}if(CHECK_FLAG(binfo->peer->af_flags[afi][safi],P
EER_FLAG_REFLECTOR_CLIENT)){if(json_paths)json_object_boolean_true_add(json_path
,"rxedFromRrClient");elsevty_out(vty,",(ReceivedfromaRR-client)");}if(CHECK_FLAG
(binfo->peer->af_flags[afi][safi],PEER_FLAG_RSERVER_CLIENT)){if(json_paths)json_
object_boolean_true_add(json_path,"rxedFromRsClient");elsevty_out(vty,",(Receive
dfromaRS-client)");}if(CHECK_FLAG(binfo->flags,BGP_INFO_HISTORY)){if(json_paths)
json_object_boolean_true_add(json_path,"dampeningHistoryEntry");elsevty_out(vty,
",(historyentry)");}elseif(CHECK_FLAG(binfo->flags,BGP_INFO_DAMPED)){if(json_pat
hs)json_object_boolean_true_add(json_path,"dampeningSuppressed");elsevty_out(vty
,",(suppressedduetodampening)");}if(!json_paths)vty_out(vty,"\n");/*Line2display
Next-hop,Neighbor,Router-id*//*Displaythenexthop*/if((p->family==AF_INET||p->fam
ily==AF_ETHERNET||p->family==AF_EVPN)&&(safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP||s
afi==SAFI_EVPN||!BGP_ATTR_NEXTHOP_AFI_IP6(attr))){if(safi==SAFI_MPLS_VPN||safi==
SAFI_ENCAP||safi==SAFI_EVPN){if(json_paths)json_object_string_add(json_nexthop_g
lobal,"ip",inet_ntoa(attr->mp_nexthop_global_in));elsevty_out(vty,"%s",inet_ntoa
(attr->mp_nexthop_global_in));}else{if(json_paths)json_object_string_add(json_ne
xthop_global,"ip",inet_ntoa(attr->nexthop));elsevty_out(vty,"%s",inet_ntoa(attr-
>nexthop));}if(json_paths)json_object_string_add(json_nexthop_global,"afi","ipv4
");}else{if(json_paths){json_object_string_add(json_nexthop_global,"ip",inet_nto
p(AF_INET6,&attr->mp_nexthop_global,buf,INET6_ADDRSTRLEN));json_object_string_ad
d(json_nexthop_global,"afi","ipv6");json_object_string_add(json_nexthop_global,"
scope","global");}else{vty_out(vty,"%s",inet_ntop(AF_INET6,&attr->mp_nexthop_glo
bal,buf,INET6_ADDRSTRLEN));}}/*DisplaytheIGPcostor'inaccessible'*/if(!CHECK_FLAG
(binfo->flags,BGP_INFO_VALID)){if(json_paths)json_object_boolean_false_add(json_
nexthop_global,"accessible");elsevty_out(vty,"(inaccessible)");}else{if(binfo->e
xtra&&binfo->extra->igpmetric){if(json_paths)json_object_int_add(json_nexthop_gl
obal,"metric",binfo->extra->igpmetric);elsevty_out(vty,"(metric%u)",binfo->extra
->igpmetric);}/*IGPcostis0,displaythisonlyforjson*/else{if(json_paths)json_objec
t_int_add(json_nexthop_global,"metric",0);}if(json_paths)json_object_boolean_tru
e_add(json_nexthop_global,"accessible");}/*Displaypeer"from"output*//*Thispathwa
soriginatedlocally*/if(binfo->peer==bgp->peer_self){if(safi==SAFI_EVPN||(p->fami
ly==AF_INET&&!BGP_ATTR_NEXTHOP_AFI_IP6(attr))){if(json_paths)json_object_string_
add(json_peer,"peerId","0.0.0.0");elsevty_out(vty,"from0.0.0.0");}else{if(json_p
aths)json_object_string_add(json_peer,"peerId","::");elsevty_out(vty,"from::");}
if(json_paths)json_object_string_add(json_peer,"routerId",inet_ntoa(bgp->router_
id));elsevty_out(vty,"(%s)",inet_ntoa(bgp->router_id));}/*WeRXedthispathfromoneo
fourpeers*/else{if(json_paths){json_object_string_add(json_peer,"peerId",sockuni
on2str(&binfo->peer->su,buf,SU_ADDRSTRLEN));json_object_string_add(json_peer,"ro
uterId",inet_ntop(AF_INET,&binfo->peer->remote_id,buf1,sizeof(buf1)));if(binfo->
peer->hostname)json_object_string_add(json_peer,"hostname",binfo->peer->hostname
);if(binfo->peer->domainname)json_object_string_add(json_peer,"domainname",binfo
->peer->domainname);if(binfo->peer->conf_if)json_object_string_add(json_peer,"in
terface",binfo->peer->conf_if);}else{if(binfo->peer->conf_if){if(binfo->peer->ho
stname&&bgp_flag_check(binfo->peer->bgp,BGP_FLAG_SHOW_HOSTNAME))vty_out(vty,"fro
m%s(%s)",binfo->peer->hostname,binfo->peer->conf_if);elsevty_out(vty,"from%s",bi
nfo->peer->conf_if);}else{if(binfo->peer->hostname&&bgp_flag_check(binfo->peer->
bgp,BGP_FLAG_SHOW_HOSTNAME))vty_out(vty,"from%s(%s)",binfo->peer->hostname,binfo
->peer->host);elsevty_out(vty,"from%s",sockunion2str(&binfo->peer->su,buf,SU_ADD
RSTRLEN));}if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID))vty_out(vty,"(%s)
",inet_ntoa(attr->originator_id));elsevty_out(vty,"(%s)",inet_ntop(AF_INET,&binf
o->peer->remote_id,buf1,sizeof(buf1)));}}if(!json_paths)vty_out(vty,"\n");/*disp
laythelink-localnexthop*/if(attr->mp_nexthop_len==BGP_ATTR_NHLEN_IPV6_GLOBAL_AND
_LL){if(json_paths){json_nexthop_ll=json_object_new_object();json_object_string_
add(json_nexthop_ll,"ip",inet_ntop(AF_INET6,&attr->mp_nexthop_local,buf,INET6_AD
DRSTRLEN));json_object_string_add(json_nexthop_ll,"afi","ipv6");json_object_stri
ng_add(json_nexthop_ll,"scope","link-local");json_object_boolean_true_add(json_n
exthop_ll,"accessible");if(!attr->mp_nexthop_prefer_global)json_object_boolean_t
rue_add(json_nexthop_ll,"used");elsejson_object_boolean_true_add(json_nexthop_gl
obal,"used");}else{vty_out(vty,"(%s)%s\n",inet_ntop(AF_INET6,&attr->mp_nexthop_l
ocal,buf,INET6_ADDRSTRLEN),attr->mp_nexthop_prefer_global?"(prefer-global)":"(us
ed)");}}/*Ifwedonothavealink-localnexthopthenwemustflagtheglobalas"used"*/else{i
f(json_paths)json_object_boolean_true_add(json_nexthop_global,"used");}/*Line3di
splayOrigin,Med,Locpref,Weight,Tag,valid,*Int/Ext/Local,Atomic,best*/if(json_pat
hs)json_object_string_add(json_path,"origin",bgp_origin_long_str[attr->origin]);
elsevty_out(vty,"Origin%s",bgp_origin_long_str[attr->origin]);if(attr->flag&ATTR
_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC)){if(json_paths)json_object_int_add(json_path
,"med",attr->med);elsevty_out(vty,",metric%u",attr->med);}if(attr->flag&ATTR_FLA
G_BIT(BGP_ATTR_LOCAL_PREF)){if(json_paths)json_object_int_add(json_path,"localpr
ef",attr->local_pref);elsevty_out(vty,",localpref%u",attr->local_pref);}else{if(
json_paths)json_object_int_add(json_path,"localpref",bgp->default_local_pref);el
sevty_out(vty,",localpref%u",bgp->default_local_pref);}if(attr->weight!=0){if(js
on_paths)json_object_int_add(json_path,"weight",attr->weight);elsevty_out(vty,",
weight%u",attr->weight);}if(attr->tag!=0){if(json_paths)json_object_int_add(json
_path,"tag",attr->tag);elsevty_out(vty,",tag%"ROUTE_TAG_PRI,attr->tag);}if(!CHEC
K_FLAG(binfo->flags,BGP_INFO_VALID)){if(json_paths)json_object_boolean_false_add
(json_path,"valid");elsevty_out(vty,",invalid");}elseif(!CHECK_FLAG(binfo->flags
,BGP_INFO_HISTORY)){if(json_paths)json_object_boolean_true_add(json_path,"valid"
);elsevty_out(vty,",valid");}if(binfo->peer!=bgp->peer_self){if(binfo->peer->as=
=binfo->peer->local_as){if(CHECK_FLAG(bgp->config,BGP_CONFIG_CONFEDERATION)){if(
json_paths)json_object_string_add(json_peer,"type","confed-internal");elsevty_ou
t(vty,",confed-internal");}else{if(json_paths)json_object_string_add(json_peer,"
type","internal");elsevty_out(vty,",internal");}}else{if(bgp_confederation_peers
_check(bgp,binfo->peer->as)){if(json_paths)json_object_string_add(json_peer,"typ
e","confed-external");elsevty_out(vty,",confed-external");}else{if(json_paths)js
on_object_string_add(json_peer,"type","external");elsevty_out(vty,",external");}
}}elseif(binfo->sub_type==BGP_ROUTE_AGGREGATE){if(json_paths){json_object_boolea
n_true_add(json_path,"aggregated");json_object_boolean_true_add(json_path,"local
");}else{vty_out(vty,",aggregated,local");}}elseif(binfo->type!=ZEBRA_ROUTE_BGP)
{if(json_paths)json_object_boolean_true_add(json_path,"sourced");elsevty_out(vty
,",sourced");}else{if(json_paths){json_object_boolean_true_add(json_path,"source
d");json_object_boolean_true_add(json_path,"local");}else{vty_out(vty,",sourced,
local");}}if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ATOMIC_AGGREGATE)){if(json_paths)
json_object_boolean_true_add(json_path,"atomicAggregate");elsevty_out(vty,",atom
ic-aggregate");}if(CHECK_FLAG(binfo->flags,BGP_INFO_MULTIPATH)||(CHECK_FLAG(binf
o->flags,BGP_INFO_SELECTED)&&bgp_info_mpath_count(binfo))){if(json_paths)json_ob
ject_boolean_true_add(json_path,"multipath");elsevty_out(vty,",multipath");}//Ma
rkthebestpath(s)if(CHECK_FLAG(binfo->flags,BGP_INFO_DMED_SELECTED)){first_as=asp
ath_get_first_as(attr->aspath);if(json_paths){if(!json_bestpath)json_bestpath=js
on_object_new_object();json_object_int_add(json_bestpath,"bestpathFromAs",first_
as);}else{if(first_as)vty_out(vty,",bestpath-from-AS%u",first_as);elsevty_out(vt
y,",bestpath-from-ASLocal");}}if(CHECK_FLAG(binfo->flags,BGP_INFO_SELECTED)){if(
json_paths){if(!json_bestpath)json_bestpath=json_object_new_object();json_object
_boolean_true_add(json_bestpath,"overall");}elsevty_out(vty,",best");}if(json_be
stpath)json_object_object_add(json_path,"bestpath",json_bestpath);if(!json_paths
)vty_out(vty,"\n");/*Line4displayCommunity*/if(attr->community){if(json_paths){i
f(!attr->community->json)community_str(attr->community,true);json_object_lock(at
tr->community->json);json_object_object_add(json_path,"community",attr->communit
y->json);}else{vty_out(vty,"Community:%s\n",attr->community->str);}}/*Line5displ
ayExtended-community*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES)){if(
json_paths){json_ext_community=json_object_new_object();json_object_string_add(j
son_ext_community,"string",attr->ecommunity->str);json_object_object_add(json_pa
th,"extendedCommunity",json_ext_community);}else{vty_out(vty,"ExtendedCommunity:
%s\n",attr->ecommunity->str);}}/*Line6displayLargecommunity*/if(attr->flag&ATTR_
FLAG_BIT(BGP_ATTR_LARGE_COMMUNITIES)){if(json_paths){json_lcommunity=json_object
_new_object();json_object_string_add(json_lcommunity,"string",attr->lcommunity->
str);json_object_object_add(json_path,"largeCommunity",json_lcommunity);}else{vt
y_out(vty,"LargeCommunity:%s\n",attr->lcommunity->str);}}/*Line7displayOriginato
r,Cluster-id*/if((attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORIGINATOR_ID))||(attr->flag
&ATTR_FLAG_BIT(BGP_ATTR_CLUSTER_LIST))){if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_ORI
GINATOR_ID)){if(json_paths)json_object_string_add(json_path,"originatorId",inet_
ntoa(attr->originator_id));elsevty_out(vty,"Originator:%s",inet_ntoa(attr->origi
nator_id));}if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_CLUSTER_LIST)){inti;if(json_pat
hs){json_cluster_list=json_object_new_object();json_cluster_list_list=json_objec
t_new_array();for(i=0;i<attr->cluster->length/4;i++){json_string=json_object_new
_string(inet_ntoa(attr->cluster->list[i]));json_object_array_add(json_cluster_li
st_list,json_string);}/*structcluster_listdoesnothave"str"variablelike*aspathand
communitydo.Addthissomedayifsomeone*asksforit.json_object_string_add(json_cluste
r_list,"string",attr->cluster->str);*/json_object_object_add(json_cluster_list,"
list",json_cluster_list_list);json_object_object_add(json_path,"clusterList",jso
n_cluster_list);}else{vty_out(vty,",Clusterlist:");for(i=0;i<attr->cluster->leng
th/4;i++){vty_out(vty,"%s",inet_ntoa(attr->cluster->list[i]));}}}if(!json_paths)
vty_out(vty,"\n");}if(binfo->extra&&binfo->extra->damp_info)bgp_damp_info_vty(vt
y,binfo,json_path);/*RemoteLabel*/#ifdefined(HAVE_CUMULUS)if(binfo->extra&&bgp_i
s_valid_label(&binfo->extra->label[0])&&safi!=SAFI_EVPN)#elseif(binfo->extra&&bg
p_is_valid_label(&binfo->extra->label[0]))#endif{mpls_label_tlabel=label_pton(&b
info->extra->label[0]);if(json_paths)json_object_int_add(json_path,"remoteLabel"
,label);elsevty_out(vty,"Remotelabel:%d\n",label);}/*LabelIndex*/if(attr->label_
index!=BGP_INVALID_LABEL_INDEX){if(json_paths)json_object_int_add(json_path,"lab
elIndex",attr->label_index);elsevty_out(vty,"LabelIndex:%d\n",attr->label_index)
;}/*Line8displayAddpathIDs*/if(binfo->addpath_rx_id||binfo->addpath_tx_id){if(js
on_paths){json_object_int_add(json_path,"addpathRxId",binfo->addpath_rx_id);json
_object_int_add(json_path,"addpathTxId",binfo->addpath_tx_id);}else{vty_out(vty,
"AddPathID:RX%u,TX%u\n",binfo->addpath_rx_id,binfo->addpath_tx_id);}}/*Ifweuseda
ddpathtoTXanon-bestpathweneedtodisplay*"Advertisedto"onapath-by-pathbasis*/if(bg
p->addpath_tx_used[afi][safi]){first=1;for(ALL_LIST_ELEMENTS(bgp->peer,node,nnod
e,peer)){addpath_capable=bgp_addpath_encode_tx(peer,afi,safi);has_adj=bgp_adj_ou
t_lookup(peer,binfo->net,binfo->addpath_tx_id);if((addpath_capable&&has_adj)||(!
addpath_capable&&has_adj&&CHECK_FLAG(binfo->flags,BGP_INFO_SELECTED))){if(json_p
ath&&!json_adv_to)json_adv_to=json_object_new_object();route_vty_out_advertised_
to(vty,peer,&first,"Advertisedto:",json_adv_to);}}if(json_path){if(json_adv_to){
json_object_object_add(json_path,"advertisedTo",json_adv_to);}}else{if(!first){v
ty_out(vty,"\n");}}}/*Line9displayUptime*/tbuf=time(NULL)-(bgp_clock()-binfo->up
time);if(json_paths){json_last_update=json_object_new_object();json_object_int_a
dd(json_last_update,"epoch",tbuf);json_object_string_add(json_last_update,"strin
g",ctime(&tbuf));json_object_object_add(json_path,"lastUpdate",json_last_update)
;}elsevty_out(vty,"Lastupdate:%s",ctime(&tbuf));/*Line10displayPMSItunnelattribu
te,ifpresent*/if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_PMSI_TUNNEL)){constchar*str=l
ookup_msg(bgp_pmsi_tnltype_str,attr->pmsi_tnl_type,PMSI_TNLTYPE_STR_DEFAULT);if(
json_paths){json_pmsi=json_object_new_object();json_object_string_add(json_pmsi,
"tunnelType",str);json_object_object_add(json_path,"pmsi",json_pmsi);}elsevty_ou
t(vty,"PMSITunnelType:%s\n",str);}}/*We'veconstructedthejsonobjectforthispath,ad
dittothejson*arrayofpaths*/if(json_paths){if(json_nexthop_global||json_nexthop_l
l){json_nexthops=json_object_new_array();if(json_nexthop_global)json_object_arra
y_add(json_nexthops,json_nexthop_global);if(json_nexthop_ll)json_object_array_ad
d(json_nexthops,json_nexthop_ll);json_object_object_add(json_path,"nexthops",jso
n_nexthops);}json_object_object_add(json_path,"peer",json_peer);json_object_arra
y_add(json_paths,json_path);}elsevty_out(vty,"\n");}#defineBGP_SHOW_HEADER_CSV"F
lags,Network,NextHop,Metric,LocPrf,Weight,Path"#defineBGP_SHOW_DAMP_HEADER"Netwo
rkFromReusePath\n"#defineBGP_SHOW_FLAP_HEADER"NetworkFromFlapsDurationReusePath\
n"staticintbgp_show_prefix_list(structvty*vty,structbgp*bgp,constchar*prefix_lis
t_str,afi_tafi,safi_tsafi,enumbgp_show_typetype);staticintbgp_show_filter_list(s
tructvty*vty,structbgp*bgp,constchar*filter,afi_tafi,safi_tsafi,enumbgp_show_typ
etype);staticintbgp_show_route_map(structvty*vty,structbgp*bgp,constchar*rmap_st
r,afi_tafi,safi_tsafi,enumbgp_show_typetype);staticintbgp_show_community_list(st
ructvty*vty,structbgp*bgp,constchar*com,intexact,afi_tafi,safi_tsafi);staticintb
gp_show_prefix_longer(structvty*vty,structbgp*bgp,constchar*prefix,afi_tafi,safi
_tsafi,enumbgp_show_typetype);staticintbgp_show_regexp(structvty*vty,structbgp*b
gp,constchar*regstr,afi_tafi,safi_tsafi,enumbgp_show_typetype);staticintbgp_show
_community(structvty*vty,structbgp*bgp,constchar*comstr,intexact,afi_tafi,safi_t
safi);staticintbgp_show_table(structvty*vty,structbgp*bgp,safi_tsafi,structbgp_t
able*table,enumbgp_show_typetype,void*output_arg,uint8_tuse_json,char*rd,intis_l
ast,unsignedlong*output_cum,unsignedlong*total_cum,unsignedlong*json_header_dept
h){structbgp_info*ri;structbgp_node*rn;intheader=1;intdisplay;unsignedlongoutput
_count=0;unsignedlongtotal_count=0;structprefix*p;charbuf[BUFSIZ];charbuf2[BUFSI
Z];json_object*json_paths=NULL;intfirst=1;if(output_cum&&*output_cum!=0)header=0
;if(use_json&&!*json_header_depth){vty_out(vty,"{\n\"vrfId\":%d,\n\"vrfName\":\"
%s\",\n\"tableVersion\":%"PRId64",\n\"routerId\":\"%s\",\n\"routes\":{",bgp->vrf
_id==VRF_UNKNOWN?-1:(int)bgp->vrf_id,bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT?"
Default":bgp->name,table->version,inet_ntoa(bgp->router_id));*json_header_depth=
2;if(rd){vty_out(vty,"\"routeDistinguishers\":{");++*json_header_depth;}json_pat
hs=json_object_new_object();}if(use_json&&rd){vty_out(vty,"\"%s\":{",rd);}/*Star
tprocessingofroutes.*/for(rn=bgp_table_top(table);rn;rn=bgp_route_next(rn)){if(r
n->info==NULL)continue;display=0;if(use_json)json_paths=json_object_new_array();
elsejson_paths=NULL;for(ri=rn->info;ri;ri=ri->next){total_count++;if(type==bgp_s
how_type_flap_statistics||type==bgp_show_type_flap_neighbor||type==bgp_show_type
_dampend_paths||type==bgp_show_type_damp_neighbor){if(!(ri->extra&&ri->extra->da
mp_info))continue;}if(type==bgp_show_type_regexp){regex_t*regex=output_arg;if(bg
p_regexec(regex,ri->attr->aspath)==REG_NOMATCH)continue;}if(type==bgp_show_type_
prefix_list){structprefix_list*plist=output_arg;if(prefix_list_apply(plist,&rn->
p)!=PREFIX_PERMIT)continue;}if(type==bgp_show_type_filter_list){structas_list*as
_list=output_arg;if(as_list_apply(as_list,ri->attr->aspath)!=AS_FILTER_PERMIT)co
ntinue;}if(type==bgp_show_type_route_map){structroute_map*rmap=output_arg;struct
bgp_infobinfo;structattrdummy_attr;intret;bgp_attr_dup(&dummy_attr,ri->attr);bin
fo.peer=ri->peer;binfo.attr=&dummy_attr;ret=route_map_apply(rmap,&rn->p,RMAP_BGP
,&binfo);if(ret==RMAP_DENYMATCH)continue;}if(type==bgp_show_type_neighbor||type=
=bgp_show_type_flap_neighbor||type==bgp_show_type_damp_neighbor){unionsockunion*
su=output_arg;if(ri->peer==NULL||ri->peer->su_remote==NULL||!sockunion_same(ri->
peer->su_remote,su))continue;}if(type==bgp_show_type_cidr_only){uint32_tdestinat
ion;destination=ntohl(rn->p.u.prefix4.s_addr);if(IN_CLASSC(destination)&&rn->p.p
refixlen==24)continue;if(IN_CLASSB(destination)&&rn->p.prefixlen==16)continue;if
(IN_CLASSA(destination)&&rn->p.prefixlen==8)continue;}if(type==bgp_show_type_pre
fix_longer){structprefix*p=output_arg;if(!prefix_match(p,&rn->p))continue;}if(ty
pe==bgp_show_type_community_all){if(!ri->attr->community)continue;}if(type==bgp_
show_type_community){structcommunity*com=output_arg;if(!ri->attr->community||!co
mmunity_match(ri->attr->community,com))continue;}if(type==bgp_show_type_communit
y_exact){structcommunity*com=output_arg;if(!ri->attr->community||!community_cmp(
ri->attr->community,com))continue;}if(type==bgp_show_type_community_list){struct
community_list*list=output_arg;if(!community_list_match(ri->attr->community,list
))continue;}if(type==bgp_show_type_community_list_exact){structcommunity_list*li
st=output_arg;if(!community_list_exact_match(ri->attr->community,list))continue;
}if(type==bgp_show_type_lcommunity){structlcommunity*lcom=output_arg;if(!ri->att
r->lcommunity||!lcommunity_match(ri->attr->lcommunity,lcom))continue;}if(type==b
gp_show_type_lcommunity_list){structcommunity_list*list=output_arg;if(!lcommunit
y_list_match(ri->attr->lcommunity,list))continue;}if(type==bgp_show_type_lcommun
ity_all){if(!ri->attr->lcommunity)continue;}if(type==bgp_show_type_dampend_paths
||type==bgp_show_type_damp_neighbor){if(!CHECK_FLAG(ri->flags,BGP_INFO_DAMPED)||
CHECK_FLAG(ri->flags,BGP_INFO_HISTORY))continue;}if(!use_json&&header){vty_out(v
ty,"BGPtableversionis%"PRIu64",localrouterIDis%s\n",table->version,inet_ntoa(bgp
->router_id));vty_out(vty,BGP_SHOW_SCODE_HEADER);vty_out(vty,BGP_SHOW_OCODE_HEAD
ER);if(type==bgp_show_type_dampend_paths||type==bgp_show_type_damp_neighbor)vty_
out(vty,BGP_SHOW_DAMP_HEADER);elseif(type==bgp_show_type_flap_statistics||type==
bgp_show_type_flap_neighbor)vty_out(vty,BGP_SHOW_FLAP_HEADER);elsevty_out(vty,BG
P_SHOW_HEADER);header=0;}if(rd!=NULL&&!display&&!output_count){if(!use_json)vty_
out(vty,"RouteDistinguisher:%s\n",rd);}if(type==bgp_show_type_dampend_paths||typ
e==bgp_show_type_damp_neighbor)damp_route_vty_out(vty,&rn->p,ri,display,safi,use
_json,json_paths);elseif(type==bgp_show_type_flap_statistics||type==bgp_show_typ
e_flap_neighbor)flap_route_vty_out(vty,&rn->p,ri,display,safi,use_json,json_path
s);elseroute_vty_out(vty,&rn->p,ri,display,safi,json_paths);display++;}if(displa
y){output_count++;if(!use_json)continue;p=&rn->p;sprintf(buf2,"%s/%d",inet_ntop(
p->family,&p->u.prefix,buf,BUFSIZ),p->prefixlen);if(first)vty_out(vty,"\"%s\":",
buf2);elsevty_out(vty,",\"%s\":",buf2);vty_out(vty,"%s",json_object_to_json_stri
ng(json_paths));json_object_free(json_paths);json_paths=NULL;first=0;}}if(output
_cum){output_count+=*output_cum;*output_cum=output_count;}if(total_cum){total_co
unt+=*total_cum;*total_cum=total_count;}if(use_json){if(json_paths)json_object_f
ree(json_paths);if(rd){vty_out(vty,"}%s",(is_last?"":","));}if(is_last){unsigned
longi;for(i=0;i<*json_header_depth;++i)vty_out(vty,"}");}}else{if(is_last){/*Nor
outeisdisplayed*/if(output_count==0){if(type==bgp_show_type_normal)vty_out(vty,"
NoBGPprefixesdisplayed,%ldexist\n",total_count);}elsevty_out(vty,"\nDisplayed%ld
routesand%ldtotalpaths\n",output_count,total_count);}}returnCMD_SUCCESS;}intbgp_
show_table_rd(structvty*vty,structbgp*bgp,safi_tsafi,structbgp_table*table,struc
tprefix_rd*prd_match,enumbgp_show_typetype,void*output_arg,uint8_tuse_json){stru
ctbgp_node*rn,*next;unsignedlongoutput_cum=0;unsignedlongtotal_cum=0;unsignedlon
gjson_header_depth=0;boolshow_msg;show_msg=(!use_json&&type==bgp_show_type_norma
l);for(rn=bgp_table_top(table);rn;rn=next){next=bgp_route_next(rn);if(prd_match&
&memcmp(rn->p.u.val,prd_match->val,8)!=0)continue;if(rn->info!=NULL){structprefi
x_rdprd;charrd[RD_ADDRSTRLEN];memcpy(&prd,&(rn->p),sizeof(structprefix_rd));pref
ix_rd2str(&prd,rd,sizeof(rd));bgp_show_table(vty,bgp,safi,rn->info,type,output_a
rg,use_json,rd,next==NULL,&output_cum,&total_cum,&json_header_depth);if(next==NU
LL)show_msg=false;}}if(show_msg){if(output_cum==0)vty_out(vty,"NoBGPprefixesdisp
layed,%ldexist\n",total_cum);elsevty_out(vty,"\nDisplayed%ldroutesand%ldtotalpat
hs\n",output_cum,total_cum);}returnCMD_SUCCESS;}staticintbgp_show(structvty*vty,
structbgp*bgp,afi_tafi,safi_tsafi,enumbgp_show_typetype,void*output_arg,uint8_tu
se_json){structbgp_table*table;unsignedlongjson_header_depth=0;if(bgp==NULL){bgp
=bgp_get_default();}if(bgp==NULL){if(!use_json)vty_out(vty,"NoBGPprocessisconfig
ured\n");elsevty_out(vty,"{}\n");returnCMD_WARNING;}table=bgp->rib[afi][safi];/*
useMPLSandENCAPspecificshowsuntiltheyaremerged*/if(safi==SAFI_MPLS_VPN){returnbg
p_show_table_rd(vty,bgp,safi,table,NULL,type,output_arg,use_json);}if(safi==SAFI
_FLOWSPEC&&type==bgp_show_type_detail){returnbgp_show_table_flowspec(vty,bgp,afi
,table,type,output_arg,use_json,1,NULL,NULL);}/*labeled-unicastroutesliveintheun
icasttable*/elseif(safi==SAFI_LABELED_UNICAST)safi=SAFI_UNICAST;returnbgp_show_t
able(vty,bgp,safi,table,type,output_arg,use_json,NULL,1,NULL,NULL,&json_header_d
epth);}staticvoidbgp_show_all_instances_routes_vty(structvty*vty,afi_tafi,safi_t
safi,uint8_tuse_json){structlistnode*node,*nnode;structbgp*bgp;intis_first=1;if(
use_json)vty_out(vty,"{\n");for(ALL_LIST_ELEMENTS(bm->bgp,node,nnode,bgp)){if(us
e_json){if(!is_first)vty_out(vty,",\n");elseis_first=0;vty_out(vty,"\"%s\":",(bg
p->inst_type==BGP_INSTANCE_TYPE_DEFAULT)?"Default":bgp->name);}else{vty_out(vty,
"\nInstance%s:\n",(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)?"Default":bgp->nam
e);}bgp_show(vty,bgp,afi,safi,bgp_show_type_normal,NULL,use_json);}if(use_json)v
ty_out(vty,"}\n");}/*HeaderofdetailedBGProuteinformation*/voidroute_vty_out_deta
il_header(structvty*vty,structbgp*bgp,structbgp_node*rn,structprefix_rd*prd,afi_
tafi,safi_tsafi,json_object*json){structbgp_info*ri;structprefix*p;structpeer*pe
er;structlistnode*node,*nnode;charbuf1[RD_ADDRSTRLEN];charbuf2[INET6_ADDRSTRLEN]
;#ifdefined(HAVE_CUMULUS)charbuf3[EVPN_ROUTE_STRLEN];#endifcharprefix_str[BUFSIZ
];intcount=0;intbest=0;intsuppress=0;intno_export=0;intno_advertise=0;intlocal_a
s=0;intfirst=1;inthas_valid_label=0;mpls_label_tlabel=0;json_object*json_adv_to=
NULL;p=&rn->p;has_valid_label=bgp_is_valid_label(&rn->local_label);if(has_valid_
label)label=label_pton(&rn->local_label);if(json){if(has_valid_label)json_object
_int_add(json,"localLabel",label);json_object_string_add(json,"prefix",prefix2st
r(p,prefix_str,sizeof(prefix_str)));}else{#ifdefined(HAVE_CUMULUS)if(safi==SAFI_
EVPN)vty_out(vty,"BGProutingtableentryfor%s%s%s\n",prd?prefix_rd2str(prd,buf1,si
zeof(buf1)):"",prd?":":"",bgp_evpn_route2str((structprefix_evpn*)p,buf3,sizeof(b
uf3)));elsevty_out(vty,"BGProutingtableentryfor%s%s%s/%d\n",((safi==SAFI_MPLS_VP
N||safi==SAFI_ENCAP)?prefix_rd2str(prd,buf1,sizeof(buf1)):""),safi==SAFI_MPLS_VP
N?":":"",inet_ntop(p->family,&p->u.prefix,buf2,INET6_ADDRSTRLEN),p->prefixlen);#
elseif(p->family==AF_ETHERNET)prefix2str(p,buf2,INET6_ADDRSTRLEN);elseinet_ntop(
p->family,&p->u.prefix,buf2,INET6_ADDRSTRLEN);vty_out(vty,"BGProutingtableentryf
or%s%s%s/%d\n",((safi==SAFI_MPLS_VPN||safi==SAFI_ENCAP||safi==SAFI_EVPN)?prefix_
rd2str(prd,buf1,sizeof(buf1)):""),((safi==SAFI_MPLS_VPN)||(safi==SAFI_EVPN))?":"
:"",buf2,p->prefixlen);#endifif(has_valid_label)vty_out(vty,"Locallabel:%d\n",la
bel);#ifdefined(HAVE_CUMULUS)if(bgp_labeled_safi(safi)&&safi!=SAFI_EVPN)#elseif(
bgp_labeled_safi(safi))#endifvty_out(vty,"notallocated\n");}for(ri=rn->info;ri;r
i=ri->next){count++;if(CHECK_FLAG(ri->flags,BGP_INFO_SELECTED)){best=count;if(ri
->extra&&ri->extra->suppress)suppress=1;if(ri->attr->community!=NULL){if(communi
ty_include(ri->attr->community,COMMUNITY_NO_ADVERTISE))no_advertise=1;if(communi
ty_include(ri->attr->community,COMMUNITY_NO_EXPORT))no_export=1;if(community_inc
lude(ri->attr->community,COMMUNITY_LOCAL_AS))local_as=1;}}}if(!json){vty_out(vty
,"Paths:(%davailable",count);if(best){vty_out(vty,",best#%d",best);if(safi==SAFI
_UNICAST)vty_out(vty,",table%s",(bgp->inst_type==BGP_INSTANCE_TYPE_DEFAULT)?"Def
ault-IP-Routing-Table":bgp->name);}elsevty_out(vty,",nobestpath");if(no_advertis
e)vty_out(vty,",notadvertisedtoanypeer");elseif(no_export)vty_out(vty,",notadver
tisedtoEBGPpeer");elseif(local_as)vty_out(vty,",notadvertisedoutsidelocalAS");if
(suppress)vty_out(vty,",Advertisementssuppressedbyanaggregate.");vty_out(vty,")\
n");}/*IfwearenotusingaddpaththenwecandisplayAdvertisedtoand*thatwill*showwhatpe
ersweadvertisedthebestpathto.Ifweareusing*addpath*thoughthenwemustdisplayAdverti
sedtoonapath-by-pathbasis.*/if(!bgp->addpath_tx_used[afi][safi]){for(ALL_LIST_EL
EMENTS(bgp->peer,node,nnode,peer)){if(bgp_adj_out_lookup(peer,rn,0)){if(json&&!j
son_adv_to)json_adv_to=json_object_new_object();route_vty_out_advertised_to(vty,
peer,&first,"Advertisedtononpeer-grouppeers:\n",json_adv_to);}}if(json){if(json_
adv_to){json_object_object_add(json,"advertisedTo",json_adv_to);}}else{if(first)
vty_out(vty,"Notadvertisedtoanypeer");vty_out(vty,"\n");}}}/*Displayspecifiedrou
teofBGPtable.*/staticintbgp_show_route_in_table(structvty*vty,structbgp*bgp,stru
ctbgp_table*rib,constchar*ip_str,afi_tafi,safi_tsafi,structprefix_rd*prd,intpref
ix_check,enumbgp_path_typepathtype,uint8_tuse_json){intret;intheader;intdisplay=
0;structprefixmatch;structbgp_node*rn;structbgp_node*rm;structbgp_info*ri;struct
bgp_table*table;json_object*json=NULL;json_object*json_paths=NULL;/*CheckIPaddre
ssargument.*/ret=str2prefix(ip_str,&match);if(!ret){vty_out(vty,"addressismalfor
med\n");returnCMD_WARNING;}match.family=afi2family(afi);if(use_json){json=json_o
bject_new_object();json_paths=json_object_new_array();}if(safi==SAFI_MPLS_VPN||s
afi==SAFI_ENCAP||safi==SAFI_EVPN){for(rn=bgp_table_top(rib);rn;rn=bgp_route_next
(rn)){if(prd&&memcmp(rn->p.u.val,prd->val,8)!=0)continue;if((table=rn->info)==NU
LL)continue;header=1;if((rm=bgp_node_match(table,&match))==NULL)continue;if(pref
ix_check&&rm->p.prefixlen!=match.prefixlen){bgp_unlock_node(rm);continue;}for(ri
=rm->info;ri;ri=ri->next){if(header){route_vty_out_detail_header(vty,bgp,rm,(str
uctprefix_rd*)&rn->p,AFI_IP,safi,json);header=0;}display++;if(pathtype==BGP_PATH
_ALL||(pathtype==BGP_PATH_BESTPATH&&CHECK_FLAG(ri->flags,BGP_INFO_SELECTED))||(p
athtype==BGP_PATH_MULTIPATH&&(CHECK_FLAG(ri->flags,BGP_INFO_MULTIPATH)||CHECK_FL
AG(ri->flags,BGP_INFO_SELECTED))))route_vty_out_detail(vty,bgp,&rm->p,ri,AFI_IP,
safi,json_paths);}bgp_unlock_node(rm);}}elseif(safi==SAFI_FLOWSPEC){rn=bgp_flows
pec_get_match_per_ip(afi,rib,&match,prefix_check);if(rn!=NULL){route_vty_out_flo
wspec(vty,&rn->p,rn->info,use_json?NLRI_STRING_FORMAT_JSON:NLRI_STRING_FORMAT_LA
RGE,json_paths);display++;bgp_unlock_node(rn);}}else{header=1;if((rn=bgp_node_ma
tch(rib,&match))!=NULL){if(!prefix_check||rn->p.prefixlen==match.prefixlen){for(
ri=rn->info;ri;ri=ri->next){if(header){route_vty_out_detail_header(vty,bgp,rn,NU
LL,afi,safi,json);header=0;}display++;if(pathtype==BGP_PATH_ALL||(pathtype==BGP_
PATH_BESTPATH&&CHECK_FLAG(ri->flags,BGP_INFO_SELECTED))||(pathtype==BGP_PATH_MUL
TIPATH&&(CHECK_FLAG(ri->flags,BGP_INFO_MULTIPATH)||CHECK_FLAG(ri->flags,BGP_INFO
_SELECTED))))route_vty_out_detail(vty,bgp,&rn->p,ri,afi,safi,json_paths);}}bgp_u
nlock_node(rn);}}if(use_json){if(display)json_object_object_add(json,"paths",jso
n_paths);vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING
_PRETTY));json_object_free(json);}else{if(!display){vty_out(vty,"%%Networknotint
able\n");returnCMD_WARNING;}}returnCMD_SUCCESS;}/*DisplayspecifiedrouteofMainRIB
*/staticintbgp_show_route(structvty*vty,structbgp*bgp,constchar*ip_str,afi_tafi,
safi_tsafi,structprefix_rd*prd,intprefix_check,enumbgp_path_typepathtype,uint8_t
use_json){if(!bgp){bgp=bgp_get_default();if(!bgp){if(!use_json)vty_out(vty,"NoBG
Pprocessisconfigured\n");elsevty_out(vty,"{}\n");returnCMD_WARNING;}}/*labeled-u
nicastroutesliveintheunicasttable*/if(safi==SAFI_LABELED_UNICAST)safi=SAFI_UNICA
ST;returnbgp_show_route_in_table(vty,bgp,bgp->rib[afi][safi],ip_str,afi,safi,prd
,prefix_check,pathtype,use_json);}staticintbgp_show_lcommunity(structvty*vty,str
uctbgp*bgp,intargc,structcmd_token**argv,afi_tafi,safi_tsafi,uint8_tuj){structlc
ommunity*lcom;structbuffer*b;inti;char*str;intfirst=0;b=buffer_new(1024);for(i=0
;i<argc;i++){if(first)buffer_putc(b,'');else{if(strmatch(argv[i]->text,"AA:BB:CC
")){first=1;buffer_putstr(b,argv[i]->arg);}}}buffer_putc(b,'\0');str=buffer_gets
tr(b);buffer_free(b);lcom=lcommunity_str2com(str);XFREE(MTYPE_TMP,str);if(!lcom)
{vty_out(vty,"%%Large-communitymalformed\n");returnCMD_WARNING;}returnbgp_show(v
ty,bgp,afi,safi,bgp_show_type_lcommunity,lcom,uj);}staticintbgp_show_lcommunity_
list(structvty*vty,structbgp*bgp,constchar*lcom,afi_tafi,safi_tsafi,uint8_tuj){s
tructcommunity_list*list;list=community_list_lookup(bgp_clist,lcom,LARGE_COMMUNI
TY_LIST_MASTER);if(list==NULL){vty_out(vty,"%%%sisnotavalidlarge-community-listn
ame\n",lcom);returnCMD_WARNING;}returnbgp_show(vty,bgp,afi,safi,bgp_show_type_lc
ommunity_list,list,uj);}DEFUN(show_ip_bgp_large_community_list,show_ip_bgp_large
_community_list_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_S
AFI_WITH_LABEL_CMD_STR"]]large-community-list<(1-500)|WORD>[json]",SHOW_STRIP_ST
RBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP_STRBGP_SAFI_WITH_LABEL_HELP_STR"Displa
yroutesmatchingthelarge-community-list\n""large-community-listnumber\n""large-co
mmunity-listname\n"JSON_STR){char*vrf=NULL;afi_tafi=AFI_IP6;safi_tsafi=SAFI_UNIC
AST;intidx=0;if(argv_find(argv,argc,"ip",&idx))afi=AFI_IP;if(argv_find(argv,argc
,"view",&idx)||argv_find(argv,argc,"vrf",&idx))vrf=argv[++idx]->arg;if(argv_find
(argv,argc,"ipv4",&idx)||argv_find(argv,argc,"ipv6",&idx)){afi=strmatch(argv[idx
]->text,"ipv6")?AFI_IP6:AFI_IP;if(argv_find(argv,argc,"unicast",&idx)||argv_find
(argv,argc,"multicast",&idx))safi=bgp_vty_safi_from_str(argv[idx]->text);}intuj=
use_json(argc,argv);structbgp*bgp=bgp_lookup_by_name(vrf);if(bgp==NULL){vty_out(
vty,"Can'tfindBGPinstance%s\n",vrf);returnCMD_WARNING;}argv_find(argv,argc,"larg
e-community-list",&idx);returnbgp_show_lcommunity_list(vty,bgp,argv[idx+1]->arg,
afi,safi,uj);}DEFUN(show_ip_bgp_large_community,show_ip_bgp_large_community_cmd,
"show[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LABEL_CMD_S
TR"]]large-community[AA:BB:CC][json]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STR
BGP_AFI_HELP_STRBGP_SAFI_WITH_LABEL_HELP_STR"Displayroutesmatchingthelarge-commu
nities\n""Listoflarge-communitynumbers\n"JSON_STR){char*vrf=NULL;afi_tafi=AFI_IP
6;safi_tsafi=SAFI_UNICAST;intidx=0;if(argv_find(argv,argc,"ip",&idx))afi=AFI_IP;
if(argv_find(argv,argc,"view",&idx)||argv_find(argv,argc,"vrf",&idx))vrf=argv[++
idx]->arg;if(argv_find(argv,argc,"ipv4",&idx)||argv_find(argv,argc,"ipv6",&idx))
{afi=strmatch(argv[idx]->text,"ipv6")?AFI_IP6:AFI_IP;if(argv_find(argv,argc,"uni
cast",&idx)||argv_find(argv,argc,"multicast",&idx))safi=bgp_vty_safi_from_str(ar
gv[idx]->text);}intuj=use_json(argc,argv);structbgp*bgp=bgp_lookup_by_name(vrf);
if(bgp==NULL){vty_out(vty,"Can'tfindBGPinstance%s\n",vrf);returnCMD_WARNING;}if(
argv_find(argv,argc,"AA:BB:CC",&idx))returnbgp_show_lcommunity(vty,bgp,argc,argv
,afi,safi,uj);elsereturnbgp_show(vty,bgp,afi,safi,bgp_show_type_lcommunity_all,N
ULL,uj);}staticintbgp_table_stats(structvty*vty,structbgp*bgp,afi_tafi,safi_tsaf
i);/*BGProuteprintoutfunctionwithoutJSON*/DEFUN(show_ip_bgp,show_ip_bgp_cmd,"sho
w[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LABEL_CMD_STR"]
]\<dampening<parameters>\|route-mapWORD\|prefix-listWORD\|filter-listWORD\|stati
stics\|community<AA:NN|local-AS|no-advertise|no-export|graceful-shutdown>[exact-
match]\|community-list<(1-500)|WORD>[exact-match]\|A.B.C.D/Mlonger-prefixes\|X:X
::X:X/Mlonger-prefixes\>",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP
_STRBGP_SAFI_WITH_LABEL_HELP_STR"Displaydetailedinformationaboutdampening\n""Dis
playdetailofconfigureddampeningparameters\n""Displayroutesmatchingtheroute-map\n
""Aroute-maptomatchon\n""Displayroutesconformingtotheprefix-list\n""Prefix-listn
ame\n""Displayroutesconformingtothefilter-list\n""Regularexpressionaccesslistnam
e\n""BGPRIBadvertisementstatistics\n""Displayroutesmatchingthecommunities\n"COMM
UNITY_AANN_STR"DonotsendoutsidelocalAS(well-knowncommunity)\n""Donotadvertisetoa
nypeer(well-knowncommunity)\n""DonotexporttonextAS(well-knowncommunity)\n""Grace
fulshutdown(well-knowncommunity)\n""Exactmatchofthecommunities\n""Displayroutesm
atchingthecommunity-list\n""community-listnumber\n""community-listname\n""Exactm
atchofthecommunities\n""IPv4prefix\n""Displayrouteandmorespecificroutes\n""IPv6p
refix\n""Displayrouteandmorespecificroutes\n"){afi_tafi=AFI_IP6;safi_tsafi=SAFI_
UNICAST;intexact_match=0;structbgp*bgp=NULL;intidx=0;intidx_community_type=0;bgp
_vty_find_and_parse_afi_safi_bgp(vty,argv,argc,&idx,&afi,&safi,&bgp);if(!idx)ret
urnCMD_WARNING;if(argv_find(argv,argc,"dampening",&idx)){if(argv_find(argv,argc,
"parameters",&idx))returnbgp_show_dampening_parameters(vty,afi,safi);}if(argv_fi
nd(argv,argc,"prefix-list",&idx))returnbgp_show_prefix_list(vty,bgp,argv[idx+1]-
>arg,afi,safi,bgp_show_type_prefix_list);if(argv_find(argv,argc,"filter-list",&i
dx))returnbgp_show_filter_list(vty,bgp,argv[idx+1]->arg,afi,safi,bgp_show_type_f
ilter_list);if(argv_find(argv,argc,"statistics",&idx))returnbgp_table_stats(vty,
bgp,afi,safi);if(argv_find(argv,argc,"route-map",&idx))returnbgp_show_route_map(
vty,bgp,argv[idx+1]->arg,afi,safi,bgp_show_type_route_map);if(argv_find(argv,arg
c,"community",&idx)){/*showaspecificcommunity*/if(argv_find(argv,argc,"local-AS"
,&idx_community_type)||argv_find(argv,argc,"no-advertise",&idx_community_type)||
argv_find(argv,argc,"no-export",&idx_community_type)||argv_find(argv,argc,"grace
ful-shutdown",&idx_community_type)||argv_find(argv,argc,"AA:NN",&idx_community_t
ype)){if(argv_find(argv,argc,"exact-match",&idx))exact_match=1;returnbgp_show_co
mmunity(vty,bgp,argv[idx_community_type]->arg,exact_match,afi,safi);}}if(argv_fi
nd(argv,argc,"community-list",&idx)){constchar*clist_number_or_name=argv[++idx]-
>arg;if(++idx<argc&&strmatch(argv[idx]->text,"exact-match"))exact_match=1;return
bgp_show_community_list(vty,bgp,clist_number_or_name,exact_match,afi,safi);}/*pr
efix-longer*/if(argv_find(argv,argc,"A.B.C.D/M",&idx)||argv_find(argv,argc,"X:X:
:X:X/M",&idx))returnbgp_show_prefix_longer(vty,bgp,argv[idx]->arg,afi,safi,bgp_s
how_type_prefix_longer);returnCMD_WARNING;}/*BGProuteprintoutfunctionwithJSON*/D
EFUN(show_ip_bgp_json,show_ip_bgp_json_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["
BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LABEL_CMD_STR"]]\[<\cidr-only\|dampening<flap-st
atistics|dampened-paths>\|community\>][json]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_
HELP_STRBGP_AFI_HELP_STRBGP_SAFI_WITH_LABEL_HELP_STR"Displayonlyrouteswithnon-na
turalnetmasks\n""Displaydetailedinformationaboutdampening\n""Displayflapstatisti
csofroutes\n""Displaypathssuppressedduetodampening\n""Displayroutesmatchingtheco
mmunities\n"JSON_STR){afi_tafi=AFI_IP6;safi_tsafi=SAFI_UNICAST;enumbgp_show_type
sh_type=bgp_show_type_normal;structbgp*bgp=NULL;intidx=0;bgp_vty_find_and_parse_
afi_safi_bgp(vty,argv,argc,&idx,&afi,&safi,&bgp);if(!idx)returnCMD_WARNING;intuj
=use_json(argc,argv);if(uj)argc--;if(argv_find(argv,argc,"cidr-only",&idx))retur
nbgp_show(vty,bgp,afi,safi,bgp_show_type_cidr_only,NULL,uj);if(argv_find(argv,ar
gc,"dampening",&idx)){if(argv_find(argv,argc,"dampened-paths",&idx))returnbgp_sh
ow(vty,bgp,afi,safi,bgp_show_type_dampend_paths,NULL,uj);elseif(argv_find(argv,a
rgc,"flap-statistics",&idx))returnbgp_show(vty,bgp,afi,safi,bgp_show_type_flap_s
tatistics,NULL,uj);}if(argv_find(argv,argc,"community",&idx)){/*showallcommuniti
es*/returnbgp_show(vty,bgp,afi,safi,bgp_show_type_community_all,NULL,uj);}return
bgp_show(vty,bgp,afi,safi,sh_type,NULL,uj);}DEFUN(show_ip_bgp_route,show_ip_bgp_
route_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_L
ABEL_CMD_STR"]]""<A.B.C.D|A.B.C.D/M|X:X::X:X|X:X::X:X/M>[<bestpath|multipath>][j
son]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP_STRBGP_SAFI_WITH_LA
BEL_HELP_STR"NetworkintheBGProutingtabletodisplay\n""IPv4prefix\n""NetworkintheB
GProutingtabletodisplay\n""IPv6prefix\n""Displayonlythebestpath\n""Displayonlymu
ltipaths\n"JSON_STR){intprefix_check=0;afi_tafi=AFI_IP6;safi_tsafi=SAFI_UNICAST;
char*prefix=NULL;structbgp*bgp=NULL;enumbgp_path_typepath_type;uint8_tuj=use_jso
n(argc,argv);intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty,argv,argc,&idx,&af
i,&safi,&bgp);if(!idx)returnCMD_WARNING;if(!bgp){vty_out(vty,"Specified'all'vrf'
sbutthiscommandcurrentlyonlyworksperview/vrf\n");returnCMD_WARNING;}/*<A.B.C.D|A
.B.C.D/M|X:X::X:X|X:X::X:X/M>*/if(argv_find(argv,argc,"A.B.C.D",&idx)||argv_find
(argv,argc,"X:X::X:X",&idx))prefix_check=0;elseif(argv_find(argv,argc,"A.B.C.D/M
",&idx)||argv_find(argv,argc,"X:X::X:X/M",&idx))prefix_check=1;if((argv[idx]->ty
pe==IPV6_TKN||argv[idx]->type==IPV6_PREFIX_TKN)&&afi!=AFI_IP6){vty_out(vty,"%%Ca
nnotspecifyIPv6addressorprefixwithIPv4AFI\n");returnCMD_WARNING;}if((argv[idx]->
type==IPV4_TKN||argv[idx]->type==IPV4_PREFIX_TKN)&&afi!=AFI_IP){vty_out(vty,"%%C
annotspecifyIPv4addressorprefixwithIPv6AFI\n");returnCMD_WARNING;}prefix=argv[id
x]->arg;/*[<bestpath|multipath>]*/if(argv_find(argv,argc,"bestpath",&idx))path_t
ype=BGP_PATH_BESTPATH;elseif(argv_find(argv,argc,"multipath",&idx))path_type=BGP
_PATH_MULTIPATH;elsepath_type=BGP_PATH_ALL;returnbgp_show_route(vty,bgp,prefix,a
fi,safi,NULL,prefix_check,path_type,uj);}DEFUN(show_ip_bgp_regexp,show_ip_bgp_re
gexp_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LA
BEL_CMD_STR"]]regexpREGEX...",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_
HELP_STRBGP_SAFI_WITH_LABEL_HELP_STR"DisplayroutesmatchingtheASpathregularexpres
sion\n""Aregular-expressiontomatchtheBGPASpaths\n"){afi_tafi=AFI_IP6;safi_tsafi=
SAFI_UNICAST;structbgp*bgp=NULL;intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty
,argv,argc,&idx,&afi,&safi,&bgp);if(!idx)returnCMD_WARNING;//getindexofregexargv
_find(argv,argc,"regexp",&idx);idx++;char*regstr=argv_concat(argv,argc,idx);intr
c=bgp_show_regexp(vty,bgp,(constchar*)regstr,afi,safi,bgp_show_type_regexp);XFRE
E(MTYPE_TMP,regstr);returnrc;}DEFUN(show_ip_bgp_instance_all,show_ip_bgp_instanc
e_all_cmd,"show[ip]bgp<view|vrf>all["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LABEL_CMD_S
TR"]][json]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_ALL_HELP_STRBGP_AFI_HELP_STRBGP_S
AFI_WITH_LABEL_HELP_STRJSON_STR){afi_tafi=AFI_IP;safi_tsafi=SAFI_UNICAST;structb
gp*bgp=NULL;intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty,argv,argc,&idx,&afi
,&safi,&bgp);if(!idx)returnCMD_WARNING;intuj=use_json(argc,argv);if(uj)argc--;bg
p_show_all_instances_routes_vty(vty,afi,safi,uj);returnCMD_SUCCESS;}staticintbgp
_show_regexp(structvty*vty,structbgp*bgp,constchar*regstr,afi_tafi,safi_tsafi,en
umbgp_show_typetype){regex_t*regex;intrc;regex=bgp_regcomp(regstr);if(!regex){vt
y_out(vty,"Can'tcompileregexp%s\n",regstr);returnCMD_WARNING;}rc=bgp_show(vty,bg
p,afi,safi,type,regex,0);bgp_regex_free(regex);returnrc;}staticintbgp_show_prefi
x_list(structvty*vty,structbgp*bgp,constchar*prefix_list_str,afi_tafi,safi_tsafi
,enumbgp_show_typetype){structprefix_list*plist;plist=prefix_list_lookup(afi,pre
fix_list_str);if(plist==NULL){vty_out(vty,"%%%sisnotavalidprefix-listname\n",pre
fix_list_str);returnCMD_WARNING;}returnbgp_show(vty,bgp,afi,safi,type,plist,0);}
staticintbgp_show_filter_list(structvty*vty,structbgp*bgp,constchar*filter,afi_t
afi,safi_tsafi,enumbgp_show_typetype){structas_list*as_list;as_list=as_list_look
up(filter);if(as_list==NULL){vty_out(vty,"%%%sisnotavalidAS-pathaccess-listname\
n",filter);returnCMD_WARNING;}returnbgp_show(vty,bgp,afi,safi,type,as_list,0);}s
taticintbgp_show_route_map(structvty*vty,structbgp*bgp,constchar*rmap_str,afi_ta
fi,safi_tsafi,enumbgp_show_typetype){structroute_map*rmap;rmap=route_map_lookup_
by_name(rmap_str);if(!rmap){vty_out(vty,"%%%sisnotavalidroute-mapname\n",rmap_st
r);returnCMD_WARNING;}returnbgp_show(vty,bgp,afi,safi,type,rmap,0);}staticintbgp
_show_community(structvty*vty,structbgp*bgp,constchar*comstr,intexact,afi_tafi,s
afi_tsafi){structcommunity*com;intret=0;com=community_str2com(comstr);if(!com){v
ty_out(vty,"%%Communitymalformed:%s\n",comstr);returnCMD_WARNING;}ret=bgp_show(v
ty,bgp,afi,safi,(exact?bgp_show_type_community_exact:bgp_show_type_community),co
m,0);community_free(com);returnret;}staticintbgp_show_community_list(structvty*v
ty,structbgp*bgp,constchar*com,intexact,afi_tafi,safi_tsafi){structcommunity_lis
t*list;list=community_list_lookup(bgp_clist,com,COMMUNITY_LIST_MASTER);if(list==
NULL){vty_out(vty,"%%%sisnotavalidcommunity-listname\n",com);returnCMD_WARNING;}
returnbgp_show(vty,bgp,afi,safi,(exact?bgp_show_type_community_list_exact:bgp_sh
ow_type_community_list),list,0);}staticintbgp_show_prefix_longer(structvty*vty,s
tructbgp*bgp,constchar*prefix,afi_tafi,safi_tsafi,enumbgp_show_typetype){intret;
structprefix*p;p=prefix_new();ret=str2prefix(prefix,p);if(!ret){vty_out(vty,"%%M
alformedPrefix\n");returnCMD_WARNING;}ret=bgp_show(vty,bgp,afi,safi,type,p,0);pr
efix_free(p);returnret;}staticstructpeer*peer_lookup_in_view(structvty*vty,struc
tbgp*bgp,constchar*ip_str,uint8_tuse_json){intret;structpeer*peer;unionsockunion
su;/*Getpeersockunion.*/ret=str2sockunion(ip_str,&su);if(ret<0){peer=peer_lookup
_by_conf_if(bgp,ip_str);if(!peer){peer=peer_lookup_by_hostname(bgp,ip_str);if(!p
eer){if(use_json){json_object*json_no=NULL;json_no=json_object_new_object();json
_object_string_add(json_no,"malformedAddressOrName",ip_str);vty_out(vty,"%s\n",j
son_object_to_json_string_ext(json_no,JSON_C_TO_STRING_PRETTY));json_object_free
(json_no);}elsevty_out(vty,"%%Malformedaddressorname:%s\n",ip_str);returnNULL;}}
returnpeer;}/*Peerstructurelookup.*/peer=peer_lookup(bgp,&su);if(!peer){if(use_j
son){json_object*json_no=NULL;json_no=json_object_new_object();json_object_strin
g_add(json_no,"warning","Nosuchneighbor");vty_out(vty,"%s\n",json_object_to_json
_string_ext(json_no,JSON_C_TO_STRING_PRETTY));json_object_free(json_no);}elsevty
_out(vty,"Nosuchneighbor\n");returnNULL;}returnpeer;}enumbgp_stats{BGP_STATS_MAX
BITLEN=0,BGP_STATS_RIB,BGP_STATS_PREFIXES,BGP_STATS_TOTPLEN,BGP_STATS_UNAGGREGAT
EABLE,BGP_STATS_MAX_AGGREGATEABLE,BGP_STATS_AGGREGATES,BGP_STATS_SPACE,BGP_STATS
_ASPATH_COUNT,BGP_STATS_ASPATH_MAXHOPS,BGP_STATS_ASPATH_TOTHOPS,BGP_STATS_ASPATH
_MAXSIZE,BGP_STATS_ASPATH_TOTSIZE,BGP_STATS_ASN_HIGHEST,BGP_STATS_MAX,};staticco
nstchar*table_stats_strs[]={[BGP_STATS_PREFIXES]="TotalPrefixes",[BGP_STATS_TOTP
LEN]="Averageprefixlength",[BGP_STATS_RIB]="TotalAdvertisements",[BGP_STATS_UNAG
GREGATEABLE]="Unaggregateableprefixes",[BGP_STATS_MAX_AGGREGATEABLE]="Maximumagg
regateableprefixes",[BGP_STATS_AGGREGATES]="BGPAggregateadvertisements",[BGP_STA
TS_SPACE]="Addressspaceadvertised",[BGP_STATS_ASPATH_COUNT]="Advertisementswithp
aths",[BGP_STATS_ASPATH_MAXHOPS]="LongestAS-Path(hops)",[BGP_STATS_ASPATH_MAXSIZ
E]="LargestAS-Path(bytes)",[BGP_STATS_ASPATH_TOTHOPS]="AverageAS-Pathlength(hops
)",[BGP_STATS_ASPATH_TOTSIZE]="AverageAS-Pathsize(bytes)",[BGP_STATS_ASN_HIGHEST
]="HighestpublicASN",[BGP_STATS_MAX]=NULL,};structbgp_table_stats{structbgp_tabl
e*table;unsignedlonglongcounts[BGP_STATS_MAX];doubletotal_space;};#if0#defineTAL
LY_SIGFIG100000staticunsignedlongravg_tally(unsignedlongcount,unsignedlongoldavg
,unsignedlongnewval){unsignedlongnewtot=(count-1)*oldavg+(newval*TALLY_SIGFIG);u
nsignedlongres=(newtot*TALLY_SIGFIG)/count;unsignedlongret=newtot/count;if((res%
TALLY_SIGFIG)>(TALLY_SIGFIG/2))returnret+1;elsereturnret;}#endifstaticintbgp_tab
le_stats_walker(structthread*t){structbgp_node*rn;structbgp_node*top;structbgp_t
able_stats*ts=THREAD_ARG(t);unsignedintspace=0;if(!(top=bgp_table_top(ts->table)
))return0;switch(top->p.family){caseAF_INET:space=IPV4_MAX_BITLEN;break;caseAF_I
NET6:space=IPV6_MAX_BITLEN;break;}ts->counts[BGP_STATS_MAXBITLEN]=space;for(rn=t
op;rn;rn=bgp_route_next(rn)){structbgp_info*ri;structbgp_node*prn=bgp_node_paren
t_nolock(rn);unsignedintrinum=0;if(rn==top)continue;if(!rn->info)continue;ts->co
unts[BGP_STATS_PREFIXES]++;ts->counts[BGP_STATS_TOTPLEN]+=rn->p.prefixlen;#if0ts
->counts[BGP_STATS_AVGPLEN]=ravg_tally(ts->counts[BGP_STATS_PREFIXES],ts->counts
[BGP_STATS_AVGPLEN],rn->p.prefixlen);#endif/*checkiftheprefixisincludedbyanyothe
rannouncements*/while(prn&&!prn->info)prn=bgp_node_parent_nolock(prn);if(prn==NU
LL||prn==top){ts->counts[BGP_STATS_UNAGGREGATEABLE]++;/*announcedaddressspace*/i
f(space)ts->total_space+=pow(2.0,space-rn->p.prefixlen);}elseif(prn->info)ts->co
unts[BGP_STATS_MAX_AGGREGATEABLE]++;for(ri=rn->info;ri;ri=ri->next){rinum++;ts->
counts[BGP_STATS_RIB]++;if(ri->attr&&(CHECK_FLAG(ri->attr->flag,ATTR_FLAG_BIT(BG
P_ATTR_ATOMIC_AGGREGATE))))ts->counts[BGP_STATS_AGGREGATES]++;/*as-pathstats*/if
(ri->attr&&ri->attr->aspath){unsignedinthops=aspath_count_hops(ri->attr->aspath)
;unsignedintsize=aspath_size(ri->attr->aspath);as_thighest=aspath_highest(ri->at
tr->aspath);ts->counts[BGP_STATS_ASPATH_COUNT]++;if(hops>ts->counts[BGP_STATS_AS
PATH_MAXHOPS])ts->counts[BGP_STATS_ASPATH_MAXHOPS]=hops;if(size>ts->counts[BGP_S
TATS_ASPATH_MAXSIZE])ts->counts[BGP_STATS_ASPATH_MAXSIZE]=size;ts->counts[BGP_ST
ATS_ASPATH_TOTHOPS]+=hops;ts->counts[BGP_STATS_ASPATH_TOTSIZE]+=size;#if0ts->cou
nts[BGP_STATS_ASPATH_AVGHOPS]=ravg_tally(ts->counts[BGP_STATS_ASPATH_COUNT],ts->
counts[BGP_STATS_ASPATH_AVGHOPS],hops);ts->counts[BGP_STATS_ASPATH_AVGSIZE]=ravg
_tally(ts->counts[BGP_STATS_ASPATH_COUNT],ts->counts[BGP_STATS_ASPATH_AVGSIZE],s
ize);#endifif(highest>ts->counts[BGP_STATS_ASN_HIGHEST])ts->counts[BGP_STATS_ASN
_HIGHEST]=highest;}}}return0;}staticintbgp_table_stats(structvty*vty,structbgp*b
gp,afi_tafi,safi_tsafi){structbgp_table_statsts;unsignedinti;if(!bgp->rib[afi][s
afi]){vty_out(vty,"%%NoRIBexist'sfortheAFI(%d)/SAFI(%d)\n",afi,safi);returnCMD_W
ARNING;}vty_out(vty,"BGP%sRIBstatistics\n",afi_safi_print(afi,safi));/*labeled-u
nicastroutesliveintheunicasttable*/if(safi==SAFI_LABELED_UNICAST)safi=SAFI_UNICA
ST;memset(&ts,0,sizeof(ts));ts.table=bgp->rib[afi][safi];thread_execute(bm->mast
er,bgp_table_stats_walker,&ts,0);for(i=0;i<BGP_STATS_MAX;i++){if(!table_stats_st
rs[i])continue;switch(i){#if0caseBGP_STATS_ASPATH_AVGHOPS:caseBGP_STATS_ASPATH_A
VGSIZE:caseBGP_STATS_AVGPLEN:vty_out(vty,"%-30s:",table_stats_strs[i]);vty_out(v
ty,"%12.2f",(float)ts.counts[i]/(float)TALLY_SIGFIG);break;#endifcaseBGP_STATS_A
SPATH_TOTHOPS:caseBGP_STATS_ASPATH_TOTSIZE:vty_out(vty,"%-30s:",table_stats_strs
[i]);vty_out(vty,"%12.2f",ts.counts[i]?(float)ts.counts[i]/(float)ts.counts[BGP_
STATS_ASPATH_COUNT]:0);break;caseBGP_STATS_TOTPLEN:vty_out(vty,"%-30s:",table_st
ats_strs[i]);vty_out(vty,"%12.2f",ts.counts[i]?(float)ts.counts[i]/(float)ts.cou
nts[BGP_STATS_PREFIXES]:0);break;caseBGP_STATS_SPACE:vty_out(vty,"%-30s:",table_
stats_strs[i]);vty_out(vty,"%12g\n",ts.total_space);if(afi==AFI_IP6){vty_out(vty
,"%30s:","/32equivalent");vty_out(vty,"%12g\n",ts.total_space*pow(2.0,-128+32));
vty_out(vty,"%30s:","/48equivalent");vty_out(vty,"%12g\n",ts.total_space*pow(2.0
,-128+48));}else{vty_out(vty,"%30s:","%announced");vty_out(vty,"%12.2f\n",ts.tot
al_space*100.*pow(2.0,-32));vty_out(vty,"%30s:","/8equivalent");vty_out(vty,"%12
.2f\n",ts.total_space*pow(2.0,-32+8));vty_out(vty,"%30s:","/24equivalent");vty_o
ut(vty,"%12.2f\n",ts.total_space*pow(2.0,-32+24));}break;default:vty_out(vty,"%-
30s:",table_stats_strs[i]);vty_out(vty,"%12llu",ts.counts[i]);}vty_out(vty,"\n")
;}returnCMD_SUCCESS;}enumbgp_pcounts{PCOUNT_ADJ_IN=0,PCOUNT_DAMPED,PCOUNT_REMOVE
D,PCOUNT_HISTORY,PCOUNT_STALE,PCOUNT_VALID,PCOUNT_ALL,PCOUNT_COUNTED,PCOUNT_PFCN
T,/*thefigurewedisplaytousers*/PCOUNT_MAX,};staticconstchar*pcount_strs[]={[PCOU
NT_ADJ_IN]="Adj-in",[PCOUNT_DAMPED]="Damped",[PCOUNT_REMOVED]="Removed",[PCOUNT_
HISTORY]="History",[PCOUNT_STALE]="Stale",[PCOUNT_VALID]="Valid",[PCOUNT_ALL]="A
llRIB",[PCOUNT_COUNTED]="PfxCtcounted",[PCOUNT_PFCNT]="Useable",[PCOUNT_MAX]=NUL
L,};structpeer_pcounts{unsignedintcount[PCOUNT_MAX];conststructpeer*peer;constst
ructbgp_table*table;};staticintbgp_peer_count_walker(structthread*t){structbgp_n
ode*rn;structpeer_pcounts*pc=THREAD_ARG(t);conststructpeer*peer=pc->peer;for(rn=
bgp_table_top(pc->table);rn;rn=bgp_route_next(rn)){structbgp_adj_in*ain;structbg
p_info*ri;for(ain=rn->adj_in;ain;ain=ain->next)if(ain->peer==peer)pc->count[PCOU
NT_ADJ_IN]++;for(ri=rn->info;ri;ri=ri->next){charbuf[SU_ADDRSTRLEN];if(ri->peer!
=peer)continue;pc->count[PCOUNT_ALL]++;if(CHECK_FLAG(ri->flags,BGP_INFO_DAMPED))
pc->count[PCOUNT_DAMPED]++;if(CHECK_FLAG(ri->flags,BGP_INFO_HISTORY))pc->count[P
COUNT_HISTORY]++;if(CHECK_FLAG(ri->flags,BGP_INFO_REMOVED))pc->count[PCOUNT_REMO
VED]++;if(CHECK_FLAG(ri->flags,BGP_INFO_STALE))pc->count[PCOUNT_STALE]++;if(CHEC
K_FLAG(ri->flags,BGP_INFO_VALID))pc->count[PCOUNT_VALID]++;if(!CHECK_FLAG(ri->fl
ags,BGP_INFO_UNUSEABLE))pc->count[PCOUNT_PFCNT]++;if(CHECK_FLAG(ri->flags,BGP_IN
FO_COUNTED)){pc->count[PCOUNT_COUNTED]++;if(CHECK_FLAG(ri->flags,BGP_INFO_UNUSEA
BLE))zlog_warn("%s[pcount]%s/%discountedbutflags0x%x",peer->host,inet_ntop(rn->p
.family,&rn->p.u.prefix,buf,SU_ADDRSTRLEN),rn->p.prefixlen,ri->flags);}else{if(!
CHECK_FLAG(ri->flags,BGP_INFO_UNUSEABLE))zlog_warn("%s[pcount]%s/%dnotcountedbut
flags0x%x",peer->host,inet_ntop(rn->p.family,&rn->p.u.prefix,buf,SU_ADDRSTRLEN),
rn->p.prefixlen,ri->flags);}}}return0;}staticintbgp_peer_counts(structvty*vty,st
ructpeer*peer,afi_tafi,safi_tsafi,uint8_tuse_json){structpeer_pcountspcounts={.p
eer=peer};unsignedinti;json_object*json=NULL;json_object*json_loop=NULL;if(use_j
son){json=json_object_new_object();json_loop=json_object_new_object();}if(!peer|
|!peer->bgp||!peer->afc[afi][safi]||!peer->bgp->rib[afi][safi]){if(use_json){jso
n_object_string_add(json,"warning","Nosuchneighbororaddressfamily");vty_out(vty,
"%s\n",json_object_to_json_string(json));json_object_free(json);}elsevty_out(vty
,"%%Nosuchneighbororaddressfamily\n");returnCMD_WARNING;}memset(&pcounts,0,sizeo
f(pcounts));pcounts.peer=peer;pcounts.table=peer->bgp->rib[afi][safi];/*in-place
callviathreadsubsystemsoastorecordexecutiontime*statsforthethread-walk(i.e.ensur
ethiscan'tbeblamedon*onjustvty_read()).*/thread_execute(bm->master,bgp_peer_coun
t_walker,&pcounts,0);if(use_json){json_object_string_add(json,"prefixCountsFor",
peer->host);json_object_string_add(json,"multiProtocol",afi_safi_print(afi,safi)
);json_object_int_add(json,"pfxCounter",peer->pcount[afi][safi]);for(i=0;i<PCOUN
T_MAX;i++)json_object_int_add(json_loop,pcount_strs[i],pcounts.count[i]);json_ob
ject_object_add(json,"ribTableWalkCounters",json_loop);if(pcounts.count[PCOUNT_P
FCNT]!=peer->pcount[afi][safi]){json_object_string_add(json,"pfxctDriftFor",peer
->host);json_object_string_add(json,"recommended","Pleasereportthisbug,withtheab
ovecommandoutput");}vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_
C_TO_STRING_PRETTY));json_object_free(json);}else{if(peer->hostname&&bgp_flag_ch
eck(peer->bgp,BGP_FLAG_SHOW_HOSTNAME)){vty_out(vty,"Prefixcountsfor%s/%s,%s\n",p
eer->hostname,peer->host,afi_safi_print(afi,safi));}else{vty_out(vty,"Prefixcoun
tsfor%s,%s\n",peer->host,afi_safi_print(afi,safi));}vty_out(vty,"PfxCt:%ld\n",pe
er->pcount[afi][safi]);vty_out(vty,"\nCountsfromRIBtablewalk:\n\n");for(i=0;i<PC
OUNT_MAX;i++)vty_out(vty,"%20s:%-10d\n",pcount_strs[i],pcounts.count[i]);if(pcou
nts.count[PCOUNT_PFCNT]!=peer->pcount[afi][safi]){vty_out(vty,"%s[pcount]PfxCtdr
ift!\n",peer->host);vty_out(vty,"Pleasereportthisbug,withtheabovecommandoutput\n
");}}returnCMD_SUCCESS;}DEFUN(show_ip_bgp_instance_neighbor_prefix_counts,show_i
p_bgp_instance_neighbor_prefix_counts_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["B
GP_AFI_CMD_STR"["BGP_SAFI_CMD_STR"]]""neighbors<A.B.C.D|X:X::X:X|WORD>prefix-cou
nts[json]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP_STRBGP_SAFI_HE
LP_STR"DetailedinformationonTCPandBGPneighborconnections\n""Neighbortodisplayinf
ormationabout\n""Neighbortodisplayinformationabout\n""NeighboronBGPconfiguredint
erface\n""Displaydetailedprefixcountinformation\n"JSON_STR){afi_tafi=AFI_IP6;saf
i_tsafi=SAFI_UNICAST;structpeer*peer;intidx=0;structbgp*bgp=NULL;bgp_vty_find_an
d_parse_afi_safi_bgp(vty,argv,argc,&idx,&afi,&safi,&bgp);if(!idx)returnCMD_WARNI
NG;intuj=use_json(argc,argv);if(uj)argc--;argv_find(argv,argc,"neighbors",&idx);
peer=peer_lookup_in_view(vty,bgp,argv[idx+1]->arg,uj);if(!peer)returnCMD_WARNING
;returnbgp_peer_counts(vty,peer,AFI_IP,SAFI_UNICAST,uj);}#ifdefKEEP_OLD_VPN_COMM
ANDSDEFUN(show_ip_bgp_vpn_neighbor_prefix_counts,show_ip_bgp_vpn_neighbor_prefix
_counts_cmd,"show[ip]bgp<vpnv4|vpnv6>allneighbors<A.B.C.D|X:X::X:X|WORD>prefix-c
ounts[json]",SHOW_STRIP_STRBGP_STRBGP_VPNVX_HELP_STR"DisplayinformationaboutallV
PNv4NLRIs\n""DetailedinformationonTCPandBGPneighborconnections\n""Neighbortodisp
layinformationabout\n""Neighbortodisplayinformationabout\n""NeighboronBGPconfigu
redinterface\n""Displaydetailedprefixcountinformation\n"JSON_STR){intidx_peer=6;
structpeer*peer;uint8_tuj=use_json(argc,argv);peer=peer_lookup_in_view(vty,NULL,
argv[idx_peer]->arg,uj);if(!peer)returnCMD_WARNING;returnbgp_peer_counts(vty,pee
r,AFI_IP,SAFI_MPLS_VPN,uj);}DEFUN(show_ip_bgp_vpn_all_route_prefix,show_ip_bgp_v
pn_all_route_prefix_cmd,"show[ip]bgp<vpnv4|vpnv6>all<A.B.C.D|A.B.C.D/M>[json]",S
HOW_STRIP_STRBGP_STRBGP_VPNVX_HELP_STR"DisplayinformationaboutallVPNv4NLRIs\n""N
etworkintheBGProutingtabletodisplay\n""NetworkintheBGProutingtabletodisplay\n"JS
ON_STR){intidx=0;char*network=NULL;structbgp*bgp=bgp_get_default();if(!bgp){vty_
out(vty,"Can'tfinddefaultinstance\n");returnCMD_WARNING;}if(argv_find(argv,argc,
"A.B.C.D",&idx))network=argv[idx]->arg;elseif(argv_find(argv,argc,"A.B.C.D/M",&i
dx))network=argv[idx]->arg;else{vty_out(vty,"UnabletofigureoutNetwork\n");return
CMD_WARNING;}returnbgp_show_route(vty,bgp,network,AFI_IP,SAFI_MPLS_VPN,NULL,0,BG
P_PATH_ALL,use_json(argc,argv));}#endif/*KEEP_OLD_VPN_COMMANDS*/DEFUN(show_ip_bg
p_l2vpn_evpn_all_route_prefix,show_ip_bgp_l2vpn_evpn_all_route_prefix_cmd,"show[
ip]bgpl2vpnevpnall<A.B.C.D|A.B.C.D/M>[json]",SHOW_STRIP_STRBGP_STRL2VPN_HELP_STR
EVPN_HELP_STR"DisplayinformationaboutallEVPNNLRIs\n""NetworkintheBGProutingtable
todisplay\n""NetworkintheBGProutingtabletodisplay\n"JSON_STR){intidx=0;char*netw
ork=NULL;if(argv_find(argv,argc,"A.B.C.D",&idx))network=argv[idx]->arg;elseif(ar
gv_find(argv,argc,"A.B.C.D/M",&idx))network=argv[idx]->arg;else{vty_out(vty,"Una
bletofigureoutNetwork\n");returnCMD_WARNING;}returnbgp_show_route(vty,NULL,netwo
rk,AFI_L2VPN,SAFI_EVPN,NULL,0,BGP_PATH_ALL,use_json(argc,argv));}staticvoidshow_
adj_route(structvty*vty,structpeer*peer,afi_tafi,safi_tsafi,intin,constchar*rmap
_name,uint8_tuse_json,json_object*json){structbgp_table*table;structbgp_adj_in*a
in;structbgp_adj_out*adj;unsignedlongoutput_count;unsignedlongfiltered_count;str
uctbgp_node*rn;intheader1=1;structbgp*bgp;intheader2=1;structattrattr;intret;str
uctupdate_subgroup*subgrp;json_object*json_scode=NULL;json_object*json_ocode=NUL
L;json_object*json_ar=NULL;structpeer_af*paf;if(use_json){json_scode=json_object
_new_object();json_ocode=json_object_new_object();json_ar=json_object_new_object
();json_object_string_add(json_scode,"suppressed","s");json_object_string_add(js
on_scode,"damped","d");json_object_string_add(json_scode,"history","h");json_obj
ect_string_add(json_scode,"valid","*");json_object_string_add(json_scode,"best",
">");json_object_string_add(json_scode,"multipath","=");json_object_string_add(j
son_scode,"internal","i");json_object_string_add(json_scode,"ribFailure","r");js
on_object_string_add(json_scode,"stale","S");json_object_string_add(json_scode,"
removed","R");json_object_string_add(json_ocode,"igp","i");json_object_string_ad
d(json_ocode,"egp","e");json_object_string_add(json_ocode,"incomplete","?");}bgp
=peer->bgp;if(!bgp){if(use_json){json_object_string_add(json,"alert","noBGP");vt
y_out(vty,"%s\n",json_object_to_json_string(json));json_object_free(json);}elsev
ty_out(vty,"%%Nobgp\n");return;}table=bgp->rib[afi][safi];output_count=filtered_
count=0;subgrp=peer_subgroup(peer,afi,safi);if(!in&&subgrp&&CHECK_FLAG(subgrp->s
flags,SUBGRP_STATUS_DEFAULT_ORIGINATE)){if(use_json){json_object_int_add(json,"b
gpTableVersion",table->version);json_object_string_add(json,"bgpLocalRouterId",i
net_ntoa(bgp->router_id));json_object_object_add(json,"bgpStatusCodes",json_scod
e);json_object_object_add(json,"bgpOriginCodes",json_ocode);json_object_string_a
dd(json,"bgpOriginatingDefaultNetwork","0.0.0.0");}else{vty_out(vty,"BGPtablever
sionis%"PRIu64",localrouterIDis%s\n",table->version,inet_ntoa(bgp->router_id));v
ty_out(vty,BGP_SHOW_SCODE_HEADER);vty_out(vty,BGP_SHOW_OCODE_HEADER);vty_out(vty
,"Originatingdefaultnetwork0.0.0.0\n\n");}header1=0;}for(rn=bgp_table_top(table)
;rn;rn=bgp_route_next(rn)){if(in){for(ain=rn->adj_in;ain;ain=ain->next){if(ain->
peer!=peer)continue;if(header1){if(use_json){json_object_int_add(json,"bgpTableV
ersion",0);json_object_string_add(json,"bgpLocalRouterId",inet_ntoa(bgp->router_
id));json_object_object_add(json,"bgpStatusCodes",json_scode);json_object_object
_add(json,"bgpOriginCodes",json_ocode);}else{vty_out(vty,"BGPtableversionis0,loc
alrouterIDis%s\n",inet_ntoa(bgp->router_id));vty_out(vty,BGP_SHOW_SCODE_HEADER);
vty_out(vty,BGP_SHOW_OCODE_HEADER);}header1=0;}if(header2){if(!use_json)vty_out(
vty,BGP_SHOW_HEADER);header2=0;}if(ain->attr){bgp_attr_dup(&attr,ain->attr);if(b
gp_input_modifier(peer,&rn->p,&attr,afi,safi,rmap_name)!=RMAP_DENY){route_vty_ou
t_tmp(vty,&rn->p,&attr,safi,use_json,json_ar);output_count++;}elsefiltered_count
++;}}}else{for(adj=rn->adj_out;adj;adj=adj->next)SUBGRP_FOREACH_PEER(adj->subgro
up,paf){if(paf->peer!=peer)continue;if(header1){if(use_json){json_object_int_add
(json,"bgpTableVersion",table->version);json_object_string_add(json,"bgpLocalRou
terId",inet_ntoa(bgp->router_id));json_object_object_add(json,"bgpStatusCodes",j
son_scode);json_object_object_add(json,"bgpOriginCodes",json_ocode);}else{vty_ou
t(vty,"BGPtableversionis%"PRIu64",localrouterIDis%s\n",table->version,inet_ntoa(
bgp->router_id));vty_out(vty,BGP_SHOW_SCODE_HEADER);vty_out(vty,BGP_SHOW_OCODE_H
EADER);}header1=0;}if(header2){if(!use_json)vty_out(vty,BGP_SHOW_HEADER);header2
=0;}if(adj->attr){bgp_attr_dup(&attr,adj->attr);ret=bgp_output_modifier(peer,&rn
->p,&attr,afi,safi,rmap_name);if(ret!=RMAP_DENY){route_vty_out_tmp(vty,&rn->p,&a
ttr,safi,use_json,json_ar);output_count++;}elsefiltered_count++;bgp_attr_undup(&
attr,adj->attr);}}}}if(use_json)json_object_object_add(json,"advertisedRoutes",j
son_ar);if(output_count!=0){if(use_json)json_object_int_add(json,"totalPrefixCou
nter",output_count);elsevty_out(vty,"\nTotalnumberofprefixes%ld\n",output_count)
;}if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_
STRING_PRETTY));json_object_free(json);}}staticintpeer_adj_routes(structvty*vty,
structpeer*peer,afi_tafi,safi_tsafi,intin,constchar*rmap_name,uint8_tuse_json){j
son_object*json=NULL;if(use_json)json=json_object_new_object();/*labeled-unicast
routesliveintheunicasttable*/if(safi==SAFI_LABELED_UNICAST)safi=SAFI_UNICAST;if(
!peer||!peer->afc[afi][safi]){if(use_json){json_object_string_add(json,"warning"
,"Nosuchneighbororaddressfamily");vty_out(vty,"%s\n",json_object_to_json_string(
json));json_object_free(json);}elsevty_out(vty,"%%Nosuchneighbororaddressfamily\
n");returnCMD_WARNING;}if(in&&!CHECK_FLAG(peer->af_flags[afi][safi],PEER_FLAG_SO
FT_RECONFIG)){if(use_json){json_object_string_add(json,"warning","Inboundsoftrec
onfigurationnotenabled");vty_out(vty,"%s\n",json_object_to_json_string(json));js
on_object_free(json);}elsevty_out(vty,"%%Inboundsoftreconfigurationnotenabled\n"
);returnCMD_WARNING;}show_adj_route(vty,peer,afi,safi,in,rmap_name,use_json,json
);returnCMD_SUCCESS;}DEFUN(show_ip_bgp_instance_neighbor_advertised_route,show_i
p_bgp_instance_neighbor_advertised_route_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]
["BGP_AFI_CMD_STR"["BGP_SAFI_WITH_LABEL_CMD_STR"]]""neighbors<A.B.C.D|X:X::X:X|W
ORD><received-routes|advertised-routes>[route-mapWORD][json]",SHOW_STRIP_STRBGP_
STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP_STRBGP_SAFI_WITH_LABEL_HELP_STR"Detailedinf
ormationonTCPandBGPneighborconnections\n""Neighbortodisplayinformationabout\n""N
eighbortodisplayinformationabout\n""NeighboronBGPconfiguredinterface\n""Displayt
hereceivedroutesfromneighbor\n""DisplaytheroutesadvertisedtoaBGPneighbor\n""Rout
e-maptomodifytheattributes\n""Nameoftheroutemap\n"JSON_STR){afi_tafi=AFI_IP6;saf
i_tsafi=SAFI_UNICAST;char*rmap_name=NULL;char*peerstr=NULL;intrcvd=0;structbgp*b
gp=NULL;structpeer*peer;intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty,argv,ar
gc,&idx,&afi,&safi,&bgp);if(!idx)returnCMD_WARNING;intuj=use_json(argc,argv);if(
uj)argc--;/*neighbors<A.B.C.D|X:X::X:X|WORD>*/argv_find(argv,argc,"neighbors",&i
dx);peerstr=argv[++idx]->arg;peer=peer_lookup_in_view(vty,bgp,peerstr,uj);if(!pe
er)returnCMD_WARNING;if(argv_find(argv,argc,"received-routes",&idx))rcvd=1;if(ar
gv_find(argv,argc,"advertised-routes",&idx))rcvd=0;if(argv_find(argv,argc,"route
-map",&idx))rmap_name=argv[++idx]->arg;returnpeer_adj_routes(vty,peer,afi,safi,r
cvd,rmap_name,uj);}DEFUN(show_ip_bgp_neighbor_received_prefix_filter,show_ip_bgp
_neighbor_received_prefix_filter_cmd,"show[ip]bgp[<ipv4|ipv6>[unicast]]neighbors
<A.B.C.D|X:X::X:X|WORD>receivedprefix-filter[json]",SHOW_STRIP_STRBGP_STR"Addres
sFamily\n""AddressFamily\n""AddressFamilymodifier\n""DetailedinformationonTCPand
BGPneighborconnections\n""Neighbortodisplayinformationabout\n""Neighbortodisplay
informationabout\n""NeighboronBGPconfiguredinterface\n""Displayinformationreceiv
edfromaBGPneighbor\n""Displaytheprefixlistfilter\n"JSON_STR){afi_tafi=AFI_IP6;sa
fi_tsafi=SAFI_UNICAST;char*peerstr=NULL;charname[BUFSIZ];unionsockunionsu;struct
peer*peer;intcount,ret;intidx=0;/*show[ip]bgp*/if(argv_find(argv,argc,"ip",&idx)
)afi=AFI_IP;/*[<ipv4|ipv6>[unicast]]*/if(argv_find(argv,argc,"ipv4",&idx))afi=AF
I_IP;if(argv_find(argv,argc,"ipv6",&idx))afi=AFI_IP6;/*neighbors<A.B.C.D|X:X::X:
X|WORD>*/argv_find(argv,argc,"neighbors",&idx);peerstr=argv[++idx]->arg;uint8_tu
j=use_json(argc,argv);ret=str2sockunion(peerstr,&su);if(ret<0){peer=peer_lookup_
by_conf_if(NULL,peerstr);if(!peer){if(uj)vty_out(vty,"{}\n");elsevty_out(vty,"%%
Malformedaddressorname:%s\n",peerstr);returnCMD_WARNING;}}else{peer=peer_lookup(
NULL,&su);if(!peer){if(uj)vty_out(vty,"{}\n");elsevty_out(vty,"Nopeer\n");return
CMD_WARNING;}}sprintf(name,"%s.%d.%d",peer->host,afi,safi);count=prefix_bgp_show
_prefix_list(NULL,afi,name,uj);if(count){if(!uj)vty_out(vty,"AddressFamily:%s\n"
,afi_safi_print(afi,safi));prefix_bgp_show_prefix_list(vty,afi,name,uj);}else{if
(uj)vty_out(vty,"{}\n");elsevty_out(vty,"Nofunctionaloutput\n");}returnCMD_SUCCE
SS;}staticintbgp_show_neighbor_route(structvty*vty,structpeer*peer,afi_tafi,safi
_tsafi,enumbgp_show_typetype,uint8_tuse_json){/*labeled-unicastroutesliveintheun
icasttable*/if(safi==SAFI_LABELED_UNICAST)safi=SAFI_UNICAST;if(!peer||!peer->afc
[afi][safi]){if(use_json){json_object*json_no=NULL;json_no=json_object_new_objec
t();json_object_string_add(json_no,"warning","Nosuchneighbororaddressfamily");vt
y_out(vty,"%s\n",json_object_to_json_string(json_no));json_object_free(json_no);
}elsevty_out(vty,"%%Nosuchneighbororaddressfamily\n");returnCMD_WARNING;}returnb
gp_show(vty,peer->bgp,afi,safi,type,&peer->su,use_json);}DEFUN(show_ip_bgp_flows
pec_routes_detailed,show_ip_bgp_flowspec_routes_detailed_cmd,"show[ip]bgp[<view|
vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"flowspec]detail[json]",SHOW_STRIP_STRBGP_STRBG
P_INSTANCE_HELP_STRBGP_AFI_HELP_STR"SAFIFlowspec\n""Detailedinformationonflowspe
centries\n"JSON_STR){afi_tafi=AFI_IP;safi_tsafi=SAFI_UNICAST;structbgp*bgp=NULL;
intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty,argv,argc,&idx,&afi,&safi,&bgp)
;if(!idx)returnCMD_WARNING;returnbgp_show(vty,bgp,afi,safi,bgp_show_type_detail,
NULL,use_json(argc,argv));}DEFUN(show_ip_bgp_neighbor_routes,show_ip_bgp_neighbo
r_routes_cmd,"show[ip]bgp[<view|vrf>VIEWVRFNAME]["BGP_AFI_CMD_STR"["BGP_SAFI_WIT
H_LABEL_CMD_STR"]]""neighbors<A.B.C.D|X:X::X:X|WORD><flap-statistics|dampened-ro
utes|routes>[json]",SHOW_STRIP_STRBGP_STRBGP_INSTANCE_HELP_STRBGP_AFI_HELP_STRBG
P_SAFI_WITH_LABEL_HELP_STR"DetailedinformationonTCPandBGPneighborconnections\n""
Neighbortodisplayinformationabout\n""Neighbortodisplayinformationabout\n""Neighb
oronBGPconfiguredinterface\n""Displayflapstatisticsoftherouteslearnedfromneighbo
r\n""Displaythedampenedroutesreceivedfromneighbor\n""Displayrouteslearnedfromnei
ghbor\n"JSON_STR){char*peerstr=NULL;structbgp*bgp=NULL;afi_tafi=AFI_IP6;safi_tsa
fi=SAFI_UNICAST;structpeer*peer;enumbgp_show_typesh_type=bgp_show_type_neighbor;
intidx=0;bgp_vty_find_and_parse_afi_safi_bgp(vty,argv,argc,&idx,&afi,&safi,&bgp)
;if(!idx)returnCMD_WARNING;intuj=use_json(argc,argv);if(uj)argc--;/*neighbors<A.
B.C.D|X:X::X:X|WORD>*/argv_find(argv,argc,"neighbors",&idx);peerstr=argv[++idx]-
>arg;peer=peer_lookup_in_view(vty,bgp,peerstr,uj);if(!peer){vty_out(vty,"Nosuchn
eighbor\n");returnCMD_WARNING;}if(argv_find(argv,argc,"flap-statistics",&idx))sh
_type=bgp_show_type_flap_neighbor;elseif(argv_find(argv,argc,"dampened-routes",&
idx))sh_type=bgp_show_type_damp_neighbor;elseif(argv_find(argv,argc,"routes",&id
x))sh_type=bgp_show_type_neighbor;returnbgp_show_neighbor_route(vty,peer,afi,saf
i,sh_type,uj);}structbgp_table*bgp_distance_table[AFI_MAX][SAFI_MAX];structbgp_d
istance{/*DistancevaluefortheIPsourceprefix.*/uint8_tdistance;/*Nameoftheaccess-
listtobematched.*/char*access_list;};DEFUN(show_bgp_afi_vpn_rd_route,show_bgp_af
i_vpn_rd_route_cmd,"showbgp"BGP_AFI_CMD_STR"vpnrdASN:NN_OR_IP-ADDRESS:NN<A.B.C.D
/M|X:X::X:X/M>[json]",SHOW_STRBGP_STRBGP_AFI_HELP_STR"AddressFamilymodifier\n""D
isplayinformationforaroutedistinguisher\n""RouteDistinguisher\n""NetworkintheBGP
routingtabletodisplay\n""NetworkintheBGProutingtabletodisplay\n"JSON_STR){intret
;structprefix_rdprd;afi_tafi=AFI_MAX;intidx=0;if(!argv_find_and_parse_afi(argv,a
rgc,&idx,&afi)){vty_out(vty,"%%MalformedAddressFamily\n");returnCMD_WARNING;}ret
=str2prefix_rd(argv[5]->arg,&prd);if(!ret){vty_out(vty,"%%MalformedRouteDistingu
isher\n");returnCMD_WARNING;}returnbgp_show_route(vty,NULL,argv[6]->arg,afi,SAFI
_MPLS_VPN,&prd,0,BGP_PATH_ALL,use_json(argc,argv));}staticstructbgp_distance*bgp
_distance_new(void){returnXCALLOC(MTYPE_BGP_DISTANCE,sizeof(structbgp_distance))
;}staticvoidbgp_distance_free(structbgp_distance*bdistance){XFREE(MTYPE_BGP_DIST
ANCE,bdistance);}staticintbgp_distance_set(structvty*vty,constchar*distance_str,
constchar*ip_str,constchar*access_list_str){intret;afi_tafi;safi_tsafi;structpre
fixp;uint8_tdistance;structbgp_node*rn;structbgp_distance*bdistance;afi=bgp_node
_afi(vty);safi=bgp_node_safi(vty);ret=str2prefix(ip_str,&p);if(ret==0){vty_out(v
ty,"Malformedprefix\n");returnCMD_WARNING_CONFIG_FAILED;}distance=atoi(distance_
str);/*GetBGPdistancenode.*/rn=bgp_node_get(bgp_distance_table[afi][safi],(struc
tprefix*)&p);if(rn->info){bdistance=rn->info;bgp_unlock_node(rn);}else{bdistance
=bgp_distance_new();rn->info=bdistance;}/*Setdistancevalue.*/bdistance->distance
=distance;/*Resetaccess-listconfiguration.*/if(bdistance->access_list){XFREE(MTY
PE_AS_LIST,bdistance->access_list);bdistance->access_list=NULL;}if(access_list_s
tr)bdistance->access_list=XSTRDUP(MTYPE_AS_LIST,access_list_str);returnCMD_SUCCE
SS;}staticintbgp_distance_unset(structvty*vty,constchar*distance_str,constchar*i
p_str,constchar*access_list_str){intret;afi_tafi;safi_tsafi;structprefixp;intdis
tance;structbgp_node*rn;structbgp_distance*bdistance;afi=bgp_node_afi(vty);safi=
bgp_node_safi(vty);ret=str2prefix(ip_str,&p);if(ret==0){vty_out(vty,"Malformedpr
efix\n");returnCMD_WARNING_CONFIG_FAILED;}rn=bgp_node_lookup(bgp_distance_table[
afi][safi],(structprefix*)&p);if(!rn){vty_out(vty,"Can'tfindspecifiedprefix\n");
returnCMD_WARNING_CONFIG_FAILED;}bdistance=rn->info;distance=atoi(distance_str);
if(bdistance->distance!=distance){vty_out(vty,"Distancedoesnotmatchconfigured\n"
);returnCMD_WARNING_CONFIG_FAILED;}if(bdistance->access_list)XFREE(MTYPE_AS_LIST
,bdistance->access_list);bgp_distance_free(bdistance);rn->info=NULL;bgp_unlock_n
ode(rn);bgp_unlock_node(rn);returnCMD_SUCCESS;}/*ApplyBGPinformationtodistanceme
thod.*/uint8_tbgp_distance_apply(structprefix*p,structbgp_info*rinfo,afi_tafi,sa
fi_tsafi,structbgp*bgp){structbgp_node*rn;structprefixq;structpeer*peer;structbg
p_distance*bdistance;structaccess_list*alist;structbgp_static*bgp_static;if(!bgp
)return0;peer=rinfo->peer;/*Checksourceaddress.*/sockunion2hostprefix(&peer->su,
&q);rn=bgp_node_match(bgp_distance_table[afi][safi],&q);if(rn){bdistance=rn->inf
o;bgp_unlock_node(rn);if(bdistance->access_list){alist=access_list_lookup(afi,bd
istance->access_list);if(alist&&access_list_apply(alist,p)==FILTER_PERMIT)return
bdistance->distance;}elsereturnbdistance->distance;}/*Backdoorcheck.*/rn=bgp_nod
e_lookup(bgp->route[afi][safi],p);if(rn){bgp_static=rn->info;bgp_unlock_node(rn)
;if(bgp_static->backdoor){if(bgp->distance_local[afi][safi])returnbgp->distance_
local[afi][safi];elsereturnZEBRA_IBGP_DISTANCE_DEFAULT;}}if(peer->sort==BGP_PEER
_EBGP){if(bgp->distance_ebgp[afi][safi])returnbgp->distance_ebgp[afi][safi];retu
rnZEBRA_EBGP_DISTANCE_DEFAULT;}else{if(bgp->distance_ibgp[afi][safi])returnbgp->
distance_ibgp[afi][safi];returnZEBRA_IBGP_DISTANCE_DEFAULT;}}DEFUN(bgp_distance,
bgp_distance_cmd,"distancebgp(1-255)(1-255)(1-255)","Defineanadministrativedista
nce\n""BGPdistance\n""DistanceforroutesexternaltotheAS\n""Distanceforroutesinter
naltotheAS\n""Distanceforlocalroutes\n"){VTY_DECLVAR_CONTEXT(bgp,bgp);intidx_num
ber=2;intidx_number_2=3;intidx_number_3=4;afi_tafi;safi_tsafi;afi=bgp_node_afi(v
ty);safi=bgp_node_safi(vty);bgp->distance_ebgp[afi][safi]=atoi(argv[idx_number]-
>arg);bgp->distance_ibgp[afi][safi]=atoi(argv[idx_number_2]->arg);bgp->distance_
local[afi][safi]=atoi(argv[idx_number_3]->arg);returnCMD_SUCCESS;}DEFUN(no_bgp_d
istance,no_bgp_distance_cmd,"nodistancebgp[(1-255)(1-255)(1-255)]",NO_STR"Define
anadministrativedistance\n""BGPdistance\n""DistanceforroutesexternaltotheAS\n""D
istanceforroutesinternaltotheAS\n""Distanceforlocalroutes\n"){VTY_DECLVAR_CONTEX
T(bgp,bgp);afi_tafi;safi_tsafi;afi=bgp_node_afi(vty);safi=bgp_node_safi(vty);bgp
->distance_ebgp[afi][safi]=0;bgp->distance_ibgp[afi][safi]=0;bgp->distance_local
[afi][safi]=0;returnCMD_SUCCESS;}DEFUN(bgp_distance_source,bgp_distance_source_c
md,"distance(1-255)A.B.C.D/M","Defineanadministrativedistance\n""Administratived
istance\n""IPsourceprefix\n"){intidx_number=1;intidx_ipv4_prefixlen=2;bgp_distan
ce_set(vty,argv[idx_number]->arg,argv[idx_ipv4_prefixlen]->arg,NULL);returnCMD_S
UCCESS;}DEFUN(no_bgp_distance_source,no_bgp_distance_source_cmd,"nodistance(1-25
5)A.B.C.D/M",NO_STR"Defineanadministrativedistance\n""Administrativedistance\n""
IPsourceprefix\n"){intidx_number=2;intidx_ipv4_prefixlen=3;bgp_distance_unset(vt
y,argv[idx_number]->arg,argv[idx_ipv4_prefixlen]->arg,NULL);returnCMD_SUCCESS;}D
EFUN(bgp_distance_source_access_list,bgp_distance_source_access_list_cmd,"distan
ce(1-255)A.B.C.D/MWORD","Defineanadministrativedistance\n""Administrativedistanc
e\n""IPsourceprefix\n""Accesslistname\n"){intidx_number=1;intidx_ipv4_prefixlen=
2;intidx_word=3;bgp_distance_set(vty,argv[idx_number]->arg,argv[idx_ipv4_prefixl
en]->arg,argv[idx_word]->arg);returnCMD_SUCCESS;}DEFUN(no_bgp_distance_source_ac
cess_list,no_bgp_distance_source_access_list_cmd,"nodistance(1-255)A.B.C.D/MWORD
",NO_STR"Defineanadministrativedistance\n""Administrativedistance\n""IPsourcepre
fix\n""Accesslistname\n"){intidx_number=2;intidx_ipv4_prefixlen=3;intidx_word=4;
bgp_distance_unset(vty,argv[idx_number]->arg,argv[idx_ipv4_prefixlen]->arg,argv[
idx_word]->arg);returnCMD_SUCCESS;}DEFUN(ipv6_bgp_distance_source,ipv6_bgp_dista
nce_source_cmd,"distance(1-255)X:X::X:X/M","Defineanadministrativedistance\n""Ad
ministrativedistance\n""IPsourceprefix\n"){bgp_distance_set(vty,argv[1]->arg,arg
v[2]->arg,NULL);returnCMD_SUCCESS;}DEFUN(no_ipv6_bgp_distance_source,no_ipv6_bgp
_distance_source_cmd,"nodistance(1-255)X:X::X:X/M",NO_STR"Defineanadministrative
distance\n""Administrativedistance\n""IPsourceprefix\n"){bgp_distance_unset(vty,
argv[2]->arg,argv[3]->arg,NULL);returnCMD_SUCCESS;}DEFUN(ipv6_bgp_distance_sourc
e_access_list,ipv6_bgp_distance_source_access_list_cmd,"distance(1-255)X:X::X:X/
MWORD","Defineanadministrativedistance\n""Administrativedistance\n""IPsourcepref
ix\n""Accesslistname\n"){bgp_distance_set(vty,argv[1]->arg,argv[2]->arg,argv[3]-
>arg);returnCMD_SUCCESS;}DEFUN(no_ipv6_bgp_distance_source_access_list,no_ipv6_b
gp_distance_source_access_list_cmd,"nodistance(1-255)X:X::X:X/MWORD",NO_STR"Defi
neanadministrativedistance\n""Administrativedistance\n""IPsourceprefix\n""Access
listname\n"){bgp_distance_unset(vty,argv[2]->arg,argv[3]->arg,argv[4]->arg);retu
rnCMD_SUCCESS;}DEFUN(bgp_damp_set,bgp_damp_set_cmd,"bgpdampening[(1-45)[(1-20000
)(1-20000)(1-255)]]","BGPSpecificcommands\n""Enableroute-flapdampening\n""Half-l
ifetimeforthepenalty\n""Valuetostartreusingaroute\n""Valuetostartsuppressingarou
te\n""Maximumdurationtosuppressastableroute\n"){VTY_DECLVAR_CONTEXT(bgp,bgp);int
idx_half_life=2;intidx_reuse=3;intidx_suppress=4;intidx_max_suppress=5;inthalf=D
EFAULT_HALF_LIFE*60;intreuse=DEFAULT_REUSE;intsuppress=DEFAULT_SUPPRESS;intmax=4
*half;if(argc==6){half=atoi(argv[idx_half_life]->arg)*60;reuse=atoi(argv[idx_reu
se]->arg);suppress=atoi(argv[idx_suppress]->arg);max=atoi(argv[idx_max_suppress]
->arg)*60;}elseif(argc==3){half=atoi(argv[idx_half_life]->arg)*60;max=4*half;}if
(suppress<reuse){vty_out(vty,"Suppressvaluecannotbelessthanreusevalue\n");return
0;}returnbgp_damp_enable(bgp,bgp_node_afi(vty),bgp_node_safi(vty),half,reuse,sup
press,max);}DEFUN(bgp_damp_unset,bgp_damp_unset_cmd,"nobgpdampening[(1-45)[(1-20
000)(1-20000)(1-255)]]",NO_STR"BGPSpecificcommands\n""Enableroute-flapdampening\
n""Half-lifetimeforthepenalty\n""Valuetostartreusingaroute\n""Valuetostartsuppre
ssingaroute\n""Maximumdurationtosuppressastableroute\n"){VTY_DECLVAR_CONTEXT(bgp
,bgp);returnbgp_damp_disable(bgp,bgp_node_afi(vty),bgp_node_safi(vty));}/*Displa
yspecifiedrouteofBGPtable.*/staticintbgp_clear_damp_route(structvty*vty,constcha
r*view_name,constchar*ip_str,afi_tafi,safi_tsafi,structprefix_rd*prd,intprefix_c
heck){intret;structprefixmatch;structbgp_node*rn;structbgp_node*rm;structbgp_inf
o*ri;structbgp_info*ri_temp;structbgp*bgp;structbgp_table*table;/*BGPstructurelo
okup.*/if(view_name){bgp=bgp_lookup_by_name(view_name);if(bgp==NULL){vty_out(vty
,"%%Can'tfindBGPinstance%s\n",view_name);returnCMD_WARNING;}}else{bgp=bgp_get_de
fault();if(bgp==NULL){vty_out(vty,"%%NoBGPprocessisconfigured\n");returnCMD_WARN
ING;}}/*CheckIPaddressargument.*/ret=str2prefix(ip_str,&match);if(!ret){vty_out(
vty,"%%addressismalformed\n");returnCMD_WARNING;}match.family=afi2family(afi);if
((safi==SAFI_MPLS_VPN)||(safi==SAFI_ENCAP)||(safi==SAFI_EVPN)){for(rn=bgp_table_
top(bgp->rib[AFI_IP][safi]);rn;rn=bgp_route_next(rn)){if(prd&&memcmp(rn->p.u.val
,prd->val,8)!=0)continue;if((table=rn->info)==NULL)continue;if((rm=bgp_node_matc
h(table,&match))==NULL)continue;if(!prefix_check||rm->p.prefixlen==match.prefixl
en){ri=rm->info;while(ri){if(ri->extra&&ri->extra->damp_info){ri_temp=ri->next;b
gp_damp_info_free(ri->extra->damp_info,1);ri=ri_temp;}elseri=ri->next;}}bgp_unlo
ck_node(rm);}}else{if((rn=bgp_node_match(bgp->rib[afi][safi],&match))!=NULL){if(
!prefix_check||rn->p.prefixlen==match.prefixlen){ri=rn->info;while(ri){if(ri->ex
tra&&ri->extra->damp_info){ri_temp=ri->next;bgp_damp_info_free(ri->extra->damp_i
nfo,1);ri=ri_temp;}elseri=ri->next;}}bgp_unlock_node(rn);}}returnCMD_SUCCESS;}DE
FUN(clear_ip_bgp_dampening,clear_ip_bgp_dampening_cmd,"clearipbgpdampening",CLEA
R_STRIP_STRBGP_STR"Clearrouteflapdampeninginformation\n"){bgp_damp_info_clean();
returnCMD_SUCCESS;}DEFUN(clear_ip_bgp_dampening_prefix,clear_ip_bgp_dampening_pr
efix_cmd,"clearipbgpdampeningA.B.C.D/M",CLEAR_STRIP_STRBGP_STR"Clearrouteflapdam
peninginformation\n""IPv4prefix\n"){intidx_ipv4_prefixlen=4;returnbgp_clear_damp
_route(vty,NULL,argv[idx_ipv4_prefixlen]->arg,AFI_IP,SAFI_UNICAST,NULL,1);}DEFUN
(clear_ip_bgp_dampening_address,clear_ip_bgp_dampening_address_cmd,"clearipbgpda
mpeningA.B.C.D",CLEAR_STRIP_STRBGP_STR"Clearrouteflapdampeninginformation\n""Net
worktocleardampinginformation\n"){intidx_ipv4=4;returnbgp_clear_damp_route(vty,N
ULL,argv[idx_ipv4]->arg,AFI_IP,SAFI_UNICAST,NULL,0);}DEFUN(clear_ip_bgp_dampenin
g_address_mask,clear_ip_bgp_dampening_address_mask_cmd,"clearipbgpdampeningA.B.C
.DA.B.C.D",CLEAR_STRIP_STRBGP_STR"Clearrouteflapdampeninginformation\n""Networkt
ocleardampinginformation\n""Networkmask\n"){intidx_ipv4=4;intidx_ipv4_2=5;intret
;charprefix_str[BUFSIZ];ret=netmask_str2prefix_str(argv[idx_ipv4]->arg,argv[idx_
ipv4_2]->arg,prefix_str);if(!ret){vty_out(vty,"%%Inconsistentaddressandmask\n");
returnCMD_WARNING;}returnbgp_clear_damp_route(vty,NULL,prefix_str,AFI_IP,SAFI_UN
ICAST,NULL,0);}/*alsousedforencapsafi*/staticvoidbgp_config_write_network_vpn(st
ructvty*vty,structbgp*bgp,afi_tafi,safi_tsafi){structbgp_node*prn;structbgp_node
*rn;structbgp_table*table;structprefix*p;structprefix_rd*prd;structbgp_static*bg
p_static;mpls_label_tlabel;charbuf[SU_ADDRSTRLEN];charrdbuf[RD_ADDRSTRLEN];/*Net
workconfiguration.*/for(prn=bgp_table_top(bgp->route[afi][safi]);prn;prn=bgp_rou
te_next(prn)){if((table=prn->info)==NULL)continue;for(rn=bgp_table_top(table);rn
;rn=bgp_route_next(rn)){if((bgp_static=rn->info)==NULL)continue;p=&rn->p;prd=(st
ructprefix_rd*)&prn->p;/*"network"configurationdisplay.*/prefix_rd2str(prd,rdbuf
,sizeof(rdbuf));label=decode_label(&bgp_static->label);vty_out(vty,"network%s/%d
rd%s",inet_ntop(p->family,&p->u.prefix,buf,SU_ADDRSTRLEN),p->prefixlen,rdbuf);if
(safi==SAFI_MPLS_VPN)vty_out(vty,"label%u",label);if(bgp_static->rmap.name)vty_o
ut(vty,"route-map%s",bgp_static->rmap.name);if(bgp_static->backdoor)vty_out(vty,
"backdoor");vty_out(vty,"\n");}}}staticvoidbgp_config_write_network_evpn(structv
ty*vty,structbgp*bgp,afi_tafi,safi_tsafi){structbgp_node*prn;structbgp_node*rn;s
tructbgp_table*table;structprefix*p;structprefix_rd*prd;structbgp_static*bgp_sta
tic;charbuf[PREFIX_STRLEN];charbuf2[SU_ADDRSTRLEN];charrdbuf[RD_ADDRSTRLEN];/*Ne
tworkconfiguration.*/for(prn=bgp_table_top(bgp->route[afi][safi]);prn;prn=bgp_ro
ute_next(prn)){if((table=prn->info)==NULL)continue;for(rn=bgp_table_top(table);r
n;rn=bgp_route_next(rn)){if((bgp_static=rn->info)==NULL)continue;char*macrouter=
NULL;char*esi=NULL;if(bgp_static->router_mac)macrouter=prefix_mac2str(bgp_static
->router_mac,NULL,0);if(bgp_static->eth_s_id)esi=esi2str(bgp_static->eth_s_id);p
=&rn->p;prd=(structprefix_rd*)&prn->p;/*"network"configurationdisplay.*/prefix_r
d2str(prd,rdbuf,sizeof(rdbuf));if(p->u.prefix_evpn.route_type==5){charlocal_buf[
PREFIX_STRLEN];uint8_tfamily=IS_EVPN_PREFIX_IPADDR_V4((structprefix_evpn*)p)?AF_
INET:AF_INET6;inet_ntop(family,&p->u.prefix_evpn.ip.ip.addr,local_buf,PREFIX_STR
LEN);sprintf(buf,"%s/%u",local_buf,p->u.prefix_evpn.ip_prefix_length);}else{pref
ix2str(p,buf,sizeof(buf));}if(bgp_static->gatewayIp.family==AF_INET||bgp_static-
>gatewayIp.family==AF_INET6)inet_ntop(bgp_static->gatewayIp.family,&bgp_static->
gatewayIp.u.prefix,buf2,sizeof(buf2));vty_out(vty,"network%srd%sethtag%ulabel%ue
si%sgwip%sroutermac%s\n",buf,rdbuf,p->u.prefix_evpn.eth_tag,decode_label(&bgp_st
atic->label),esi,buf2,macrouter);if(macrouter)XFREE(MTYPE_TMP,macrouter);if(esi)
XFREE(MTYPE_TMP,esi);}}}/*Configurationofstaticrouteannouncementandaggregateinfo
rmation.*/voidbgp_config_write_network(structvty*vty,structbgp*bgp,afi_tafi,safi
_tsafi){structbgp_node*rn;structprefix*p;structbgp_static*bgp_static;structbgp_a
ggregate*bgp_aggregate;charbuf[SU_ADDRSTRLEN];if((safi==SAFI_MPLS_VPN)||(safi==S
AFI_ENCAP)){bgp_config_write_network_vpn(vty,bgp,afi,safi);return;}if(afi==AFI_L
2VPN&&safi==SAFI_EVPN){bgp_config_write_network_evpn(vty,bgp,afi,safi);return;}/
*Networkconfiguration.*/for(rn=bgp_table_top(bgp->route[afi][safi]);rn;rn=bgp_ro
ute_next(rn)){if((bgp_static=rn->info)==NULL)continue;p=&rn->p;/*"network"config
urationdisplay.*/if(bgp_option_check(BGP_OPT_CONFIG_CISCO)&&afi==AFI_IP){uint32_
tdestination;structin_addrnetmask;destination=ntohl(p->u.prefix4.s_addr);masklen
2ip(p->prefixlen,&netmask);vty_out(vty,"network%s",inet_ntop(p->family,&p->u.pre
fix,buf,SU_ADDRSTRLEN));if((IN_CLASSC(destination)&&p->prefixlen==24)||(IN_CLASS
B(destination)&&p->prefixlen==16)||(IN_CLASSA(destination)&&p->prefixlen==8)||p-
>u.prefix4.s_addr==0){/*Naturalmaskisnotdisplay.*/}elsevty_out(vty,"mask%s",inet
_ntoa(netmask));}else{vty_out(vty,"network%s/%d",inet_ntop(p->family,&p->u.prefi
x,buf,SU_ADDRSTRLEN),p->prefixlen);}if(bgp_static->label_index!=BGP_INVALID_LABE
L_INDEX)vty_out(vty,"label-index%u",bgp_static->label_index);if(bgp_static->rmap
.name)vty_out(vty,"route-map%s",bgp_static->rmap.name);if(bgp_static->backdoor)v
ty_out(vty,"backdoor");vty_out(vty,"\n");}/*Aggregate-addressconfiguration.*/for
(rn=bgp_table_top(bgp->aggregate[afi][safi]);rn;rn=bgp_route_next(rn)){if((bgp_a
ggregate=rn->info)==NULL)continue;p=&rn->p;if(bgp_option_check(BGP_OPT_CONFIG_CI
SCO)&&afi==AFI_IP){structin_addrnetmask;masklen2ip(p->prefixlen,&netmask);vty_ou
t(vty,"aggregate-address%s%s",inet_ntop(p->family,&p->u.prefix,buf,SU_ADDRSTRLEN
),inet_ntoa(netmask));}else{vty_out(vty,"aggregate-address%s/%d",inet_ntop(p->fa
mily,&p->u.prefix,buf,SU_ADDRSTRLEN),p->prefixlen);}if(bgp_aggregate->as_set)vty
_out(vty,"as-set");if(bgp_aggregate->summary_only)vty_out(vty,"summary-only");vt
y_out(vty,"\n");}}voidbgp_config_write_distance(structvty*vty,structbgp*bgp,afi_
tafi,safi_tsafi){structbgp_node*rn;structbgp_distance*bdistance;/*Distanceconfig
uration.*/if(bgp->distance_ebgp[afi][safi]&&bgp->distance_ibgp[afi][safi]&&bgp->
distance_local[afi][safi]&&(bgp->distance_ebgp[afi][safi]!=ZEBRA_EBGP_DISTANCE_D
EFAULT||bgp->distance_ibgp[afi][safi]!=ZEBRA_IBGP_DISTANCE_DEFAULT||bgp->distanc
e_local[afi][safi]!=ZEBRA_IBGP_DISTANCE_DEFAULT)){vty_out(vty,"distancebgp%d%d%d
\n",bgp->distance_ebgp[afi][safi],bgp->distance_ibgp[afi][safi],bgp->distance_lo
cal[afi][safi]);}for(rn=bgp_table_top(bgp_distance_table[afi][safi]);rn;rn=bgp_r
oute_next(rn))if((bdistance=rn->info)!=NULL){charbuf[PREFIX_STRLEN];vty_out(vty,
"distance%d%s%s\n",bdistance->distance,prefix2str(&rn->p,buf,sizeof(buf)),bdista
nce->access_list?bdistance->access_list:"");}}/*Allocateroutingtablestructureand
installcommands.*/voidbgp_route_init(void){afi_tafi;safi_tsafi;/*InitBGPdistance
table.*/FOREACH_AFI_SAFI(afi,safi)bgp_distance_table[afi][safi]=bgp_table_init(a
fi,safi);/*IPv4BGPcommands.*/install_element(BGP_NODE,&bgp_table_map_cmd);instal
l_element(BGP_NODE,&bgp_network_cmd);install_element(BGP_NODE,&no_bgp_table_map_
cmd);install_element(BGP_NODE,&aggregate_address_cmd);install_element(BGP_NODE,&
aggregate_address_mask_cmd);install_element(BGP_NODE,&no_aggregate_address_cmd);
install_element(BGP_NODE,&no_aggregate_address_mask_cmd);/*IPv4unicastconfigurat
ion.*/install_element(BGP_IPV4_NODE,&bgp_table_map_cmd);install_element(BGP_IPV4
_NODE,&bgp_network_cmd);install_element(BGP_IPV4_NODE,&no_bgp_table_map_cmd);ins
tall_element(BGP_IPV4_NODE,&aggregate_address_cmd);install_element(BGP_IPV4_NODE
,&aggregate_address_mask_cmd);install_element(BGP_IPV4_NODE,&no_aggregate_addres
s_cmd);install_element(BGP_IPV4_NODE,&no_aggregate_address_mask_cmd);/*IPv4multi
castconfiguration.*/install_element(BGP_IPV4M_NODE,&bgp_table_map_cmd);install_e
lement(BGP_IPV4M_NODE,&bgp_network_cmd);install_element(BGP_IPV4M_NODE,&no_bgp_t
able_map_cmd);install_element(BGP_IPV4M_NODE,&aggregate_address_cmd);install_ele
ment(BGP_IPV4M_NODE,&aggregate_address_mask_cmd);install_element(BGP_IPV4M_NODE,
&no_aggregate_address_cmd);install_element(BGP_IPV4M_NODE,&no_aggregate_address_
mask_cmd);/*IPv4labeled-unicastconfiguration.*/install_element(VIEW_NODE,&show_i
p_bgp_instance_all_cmd);install_element(VIEW_NODE,&show_ip_bgp_cmd);install_elem
ent(VIEW_NODE,&show_ip_bgp_json_cmd);install_element(VIEW_NODE,&show_ip_bgp_rout
e_cmd);install_element(VIEW_NODE,&show_ip_bgp_regexp_cmd);install_element(VIEW_N
ODE,&show_ip_bgp_instance_neighbor_advertised_route_cmd);install_element(VIEW_NO
DE,&show_ip_bgp_neighbor_routes_cmd);install_element(VIEW_NODE,&show_ip_bgp_neig
hbor_received_prefix_filter_cmd);#ifdefKEEP_OLD_VPN_COMMANDSinstall_element(VIEW
_NODE,&show_ip_bgp_vpn_all_route_prefix_cmd);#endif/*KEEP_OLD_VPN_COMMANDS*/inst
all_element(VIEW_NODE,&show_bgp_afi_vpn_rd_route_cmd);install_element(VIEW_NODE,
&show_ip_bgp_l2vpn_evpn_all_route_prefix_cmd);/*BGPdampeningclearcommands*/insta
ll_element(ENABLE_NODE,&clear_ip_bgp_dampening_cmd);install_element(ENABLE_NODE,
&clear_ip_bgp_dampening_prefix_cmd);install_element(ENABLE_NODE,&clear_ip_bgp_da
mpening_address_cmd);install_element(ENABLE_NODE,&clear_ip_bgp_dampening_address
_mask_cmd);/*prefixcount*/install_element(ENABLE_NODE,&show_ip_bgp_instance_neig
hbor_prefix_counts_cmd);#ifdefKEEP_OLD_VPN_COMMANDSinstall_element(ENABLE_NODE,&
show_ip_bgp_vpn_neighbor_prefix_counts_cmd);#endif/*KEEP_OLD_VPN_COMMANDS*//*New
configIPv6BGPcommands.*/install_element(BGP_IPV6_NODE,&bgp_table_map_cmd);instal
l_element(BGP_IPV6_NODE,&ipv6_bgp_network_cmd);install_element(BGP_IPV6_NODE,&no
_bgp_table_map_cmd);install_element(BGP_IPV6_NODE,&ipv6_aggregate_address_cmd);i
nstall_element(BGP_IPV6_NODE,&no_ipv6_aggregate_address_cmd);install_element(BGP
_IPV6M_NODE,&ipv6_bgp_network_cmd);install_element(BGP_NODE,&bgp_distance_cmd);i
nstall_element(BGP_NODE,&no_bgp_distance_cmd);install_element(BGP_NODE,&bgp_dist
ance_source_cmd);install_element(BGP_NODE,&no_bgp_distance_source_cmd);install_e
lement(BGP_NODE,&bgp_distance_source_access_list_cmd);install_element(BGP_NODE,&
no_bgp_distance_source_access_list_cmd);install_element(BGP_IPV4_NODE,&bgp_dista
nce_cmd);install_element(BGP_IPV4_NODE,&no_bgp_distance_cmd);install_element(BGP
_IPV4_NODE,&bgp_distance_source_cmd);install_element(BGP_IPV4_NODE,&no_bgp_dista
nce_source_cmd);install_element(BGP_IPV4_NODE,&bgp_distance_source_access_list_c
md);install_element(BGP_IPV4_NODE,&no_bgp_distance_source_access_list_cmd);insta
ll_element(BGP_IPV4M_NODE,&bgp_distance_cmd);install_element(BGP_IPV4M_NODE,&no_
bgp_distance_cmd);install_element(BGP_IPV4M_NODE,&bgp_distance_source_cmd);insta
ll_element(BGP_IPV4M_NODE,&no_bgp_distance_source_cmd);install_element(BGP_IPV4M
_NODE,&bgp_distance_source_access_list_cmd);install_element(BGP_IPV4M_NODE,&no_b
gp_distance_source_access_list_cmd);install_element(BGP_IPV6_NODE,&bgp_distance_
cmd);install_element(BGP_IPV6_NODE,&no_bgp_distance_cmd);install_element(BGP_IPV
6_NODE,&ipv6_bgp_distance_source_cmd);install_element(BGP_IPV6_NODE,&no_ipv6_bgp
_distance_source_cmd);install_element(BGP_IPV6_NODE,&ipv6_bgp_distance_source_ac
cess_list_cmd);install_element(BGP_IPV6_NODE,&no_ipv6_bgp_distance_source_access
_list_cmd);install_element(BGP_IPV6M_NODE,&bgp_distance_cmd);install_element(BGP
_IPV6M_NODE,&no_bgp_distance_cmd);install_element(BGP_IPV6M_NODE,&ipv6_bgp_dista
nce_source_cmd);install_element(BGP_IPV6M_NODE,&no_ipv6_bgp_distance_source_cmd)
;install_element(BGP_IPV6M_NODE,&ipv6_bgp_distance_source_access_list_cmd);insta
ll_element(BGP_IPV6M_NODE,&no_ipv6_bgp_distance_source_access_list_cmd);install_
element(BGP_NODE,&bgp_damp_set_cmd);install_element(BGP_NODE,&bgp_damp_unset_cmd
);install_element(BGP_IPV4_NODE,&bgp_damp_set_cmd);install_element(BGP_IPV4_NODE
,&bgp_damp_unset_cmd);/*IPv4MulticastMode*/install_element(BGP_IPV4M_NODE,&bgp_d
amp_set_cmd);install_element(BGP_IPV4M_NODE,&bgp_damp_unset_cmd);/*LargeCommunit
ies*/install_element(VIEW_NODE,&show_ip_bgp_large_community_list_cmd);install_el
ement(VIEW_NODE,&show_ip_bgp_large_community_cmd);/*showbgpipv4flowspecdetailed*
/install_element(VIEW_NODE,&show_ip_bgp_flowspec_routes_detailed_cmd);}voidbgp_r
oute_finish(void){afi_tafi;safi_tsafi;FOREACH_AFI_SAFI(afi,safi){bgp_table_unloc
k(bgp_distance_table[afi][safi]);bgp_distance_table[afi][safi]=NULL;}}