/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
nclude<errno.h>#include"lib/zebra.h"#include"lib/prefix.h"#include"lib/table.h"#
include"lib/vty.h"#include"lib/memory.h"#include"lib/routemap.h"#include"lib/log
.h"#include"lib/linklist.h"#include"lib/command.h"#include"lib/stream.h"#include
"bgpd/bgpd.h"#include"bgpd/bgp_ecommunity.h"#include"bgpd/bgp_attr.h"#include"bg
pd/rfapi/bgp_rfapi_cfg.h"#include"bgpd/rfapi/rfapi.h"#include"bgpd/rfapi/rfapi_b
ackend.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_mplsvpn.h"#include"bgpd/bgp
_aspath.h"#include"bgpd/bgp_advertise.h"#include"bgpd/rfapi/rfapi_import.h"#incl
ude"bgpd/rfapi/rfapi_private.h"#include"bgpd/rfapi/rfapi_monitor.h"#include"bgpd
/rfapi/rfapi_vty.h"#include"bgpd/rfapi/vnc_export_bgp.h"#include"bgpd/rfapi/vnc_
export_bgp_p.h"#include"bgpd/rfapi/vnc_zebra.h"#include"bgpd/rfapi/vnc_import_bg
p.h"#include"bgpd/rfapi/rfapi_rib.h"#include"bgpd/rfapi/rfapi_ap.h"#include"bgpd
/rfapi/vnc_debug.h"/**Per-NVEAdvertisedprefixes**Wemaintainalistofprefixesadvert
isedbyeachNVE.*Therearetwoindices:byprefixandbylifetime.**BY-PREFIXskiplist**key
:ptrtostructprefix(whenstoring,pointtoprefixthat*ispartofrfapi_adb).**value:ptrt
ostructrfapi_adb**BY-LIFETIMEskiplist**key:ptrtostructrfapi_adb*value:ptrtostruc
trfapi_adb**//**Skiplistsortfunctionthatsortsfirstaccordingtolifetime*andthenacc
ordingtoadbpointervalue.Theadbpointer*isusedtospreadoutthesortforadbswiththesame
lifetime*andtherebymaketheskiplistoperationsmoreefficient.*/staticintsl_adb_life
time_cmp(void*adb1,void*adb2){structrfapi_adb*a1=adb1;structrfapi_adb*a2=adb2;if
(a1->lifetime<a2->lifetime)return-1;if(a1->lifetime>a2->lifetime)return1;if(a1<a
2)return-1;if(a1>a2)return1;return0;}voidrfapiApInit(structrfapi_advertised_pref
ixes*ap){ap->ipN_by_prefix=skiplist_new(0,rfapi_rib_key_cmp,NULL);ap->ip0_by_eth
er=skiplist_new(0,rfapi_rib_key_cmp,NULL);ap->by_lifetime=skiplist_new(0,sl_adb_
lifetime_cmp,NULL);}voidrfapiApRelease(structrfapi_advertised_prefixes*ap){struc
trfapi_adb*adb;/*FreeADBsandlifetimeitems*/while(0==skiplist_first(ap->by_lifeti
me,NULL,(void**)&adb)){rfapiAdbFree(adb);skiplist_delete_first(ap->by_lifetime);
}while(0==skiplist_delete_first(ap->ipN_by_prefix));while(0==skiplist_delete_fir
st(ap->ip0_by_ether));/*Freelists*/skiplist_free(ap->ipN_by_prefix);skiplist_fre
e(ap->ip0_by_ether);skiplist_free(ap->by_lifetime);ap->ipN_by_prefix=NULL;ap->ip
0_by_ether=NULL;ap->by_lifetime=NULL;}intrfapiApCount(structrfapi_descriptor*rfd
){if(!rfd->advertised.by_lifetime)return0;returnskiplist_count(rfd->advertised.b
y_lifetime);}intrfapiApCountAll(structbgp*bgp){structrfapi*h;structlistnode*node
;structrfapi_descriptor*rfd;inttotal=0;h=bgp->rfapi;if(h){for(ALL_LIST_ELEMENTS_
RO(&h->descriptors,node,rfd)){total+=rfapiApCount(rfd);}}returntotal;}voidrfapiA
pReadvertiseAll(structbgp*bgp,structrfapi_descriptor*rfd){structrfapi_adb*adb;vo
id*cursor=NULL;intrc;for(rc=skiplist_next(rfd->advertised.by_lifetime,NULL,(void
**)&adb,&cursor);rc==0;rc=skiplist_next(rfd->advertised.by_lifetime,NULL,(void**
)&adb,&cursor)){structprefix_rdprd;uint32_tlocal_pref=rfp_cost_to_localpref(adb-
>cost);prd=rfd->rd;prd.family=AF_UNSPEC;prd.prefixlen=64;/**TBDthisisnotquiterig
ht.Whenpfx_ipis0/32or0/128,*weneedtosubstitutetheVNaddressastheprefix*/add_vnc_r
oute(rfd,bgp,SAFI_MPLS_VPN,&adb->u.s.prefix_ip,&prd,/*RDtouse(0forENCAP)*/&rfd->
vn_addr,/*nexthop*/&local_pref,&adb->lifetime,NULL,NULL,/*structrfapi_un_option*
/NULL,/*structrfapi_vn_option*/rfd->rt_export_list,NULL,/*med*/NULL,ZEBRA_ROUTE_
BGP,BGP_ROUTE_RFP,0);}}voidrfapiApWithdrawAll(structbgp*bgp,structrfapi_descript
or*rfd){structrfapi_adb*adb;void*cursor;intrc;cursor=NULL;for(rc=skiplist_next(r
fd->advertised.by_lifetime,NULL,(void**)&adb,&cursor);rc==0;rc=skiplist_next(rfd
->advertised.by_lifetime,NULL,(void**)&adb,&cursor)){structprefixpfx_vn_buf;stru
ctprefix*pfx_ip;if(!(RFAPI_0_PREFIX(&adb->u.s.prefix_ip)&&RFAPI_HOST_PREFIX(&adb
->u.s.prefix_ip))){pfx_ip=&adb->u.s.prefix_ip;}else{pfx_ip=NULL;/**0/32or0/128=>
macadvertisement*/if(rfapiRaddr2Qprefix(&rfd->vn_addr,&pfx_vn_buf)){/**Bad:itmea
nswecan'tdeletetheroute*/vnc_zlog_debug_verbose("%s:BAD:handlehasbadvn_addr:skip
ping",__func__);continue;}}del_vnc_route(rfd,rfd->peer,bgp,SAFI_MPLS_VPN,pfx_ip?
pfx_ip:&pfx_vn_buf,&adb->u.s.prd,/*RDtouse(0forENCAP)*/ZEBRA_ROUTE_BGP,BGP_ROUTE
_RFP,NULL,0);}}/**returnsnonzeroiftunnelreadvertisementisneeded,0otherwise*/stat
icintrfapiApAdjustLifetimeStats(structrfapi_descriptor*rfd,uint32_t*old_lifetime
,/*setifremoving/replacing*/uint32_t*new_lifetime)/*setifreplacing/adding*/{inta
dvertise=0;intfind_max=0;intfind_min=0;vnc_zlog_debug_verbose("%s:rfd=%p,pOldLif
e=%p,pNewLife=%p",__func__,rfd,old_lifetime,new_lifetime);if(old_lifetime)vnc_zl
og_debug_verbose("%s:OldLife=%d",__func__,*old_lifetime);if(new_lifetime)vnc_zlo
g_debug_verbose("%s:NewLife=%d",__func__,*new_lifetime);if(new_lifetime){/**Addi
ngnewlifetime*/if(old_lifetime){/**replacingexistinglifetime*//*oldandnewaresame
*/if(*old_lifetime==*new_lifetime)return0;if(*old_lifetime==rfd->min_prefix_life
time){find_min=1;}if(*old_lifetime==rfd->max_prefix_lifetime){find_max=1;}/*none
edtosearchifnewvalueisatorequals*min|max*/if(*new_lifetime<=rfd->min_prefix_life
time){rfd->min_prefix_lifetime=*new_lifetime;find_min=0;}if(*new_lifetime>=rfd->
max_prefix_lifetime){rfd->max_prefix_lifetime=*new_lifetime;advertise=1;find_max
=0;}}else{/**Justaddingnewlifetime*/if(*new_lifetime<rfd->min_prefix_lifetime){r
fd->min_prefix_lifetime=*new_lifetime;}if(*new_lifetime>rfd->max_prefix_lifetime
){advertise=1;rfd->max_prefix_lifetime=*new_lifetime;}}}else{/**Deleting*//**See
ifthemaxprefixlifetimeforthisNVEhasdecreased.*Theeasyoptimization:trackmin&max;w
alkthetableonly*iftheyaredifferent.*Thegeneraloptimization:indextheadvertised_pr
efixes*tablebylifetime.**Note:foragivennve_descriptor,onlyoneofthe*advertised_pr
efixes[]tableswillbeused:viz.,the*addressfamilythatmatchestheVNaddress.**/if(rfd
->max_prefix_lifetime==rfd->min_prefix_lifetime){/**Commoncase:alllifetimesareth
esame.Only*thingweneedtodohereischeckifthereare*noexportedroutesleft.Inthatcase,
reinitialize*themaxandminvalues.*/if(!rfapiApCount(rfd)){rfd->max_prefix_lifetim
e=0;rfd->min_prefix_lifetime=UINT32_MAX;}}else{if(old_lifetime){if(*old_lifetime
==rfd->min_prefix_lifetime){find_min=1;}if(*old_lifetime==rfd->max_prefix_lifeti
me){find_max=1;}}}}if(find_min||find_max){uint32_tmin=UINT32_MAX;uint32_tmax=0;s
tructrfapi_adb*adb_min;structrfapi_adb*adb_max;if(!skiplist_first(rfd->advertise
d.by_lifetime,(void**)&adb_min,NULL)&&!skiplist_last(rfd->advertised.by_lifetime
,(void**)&adb_max,NULL)){/**Thisshouldalwayswork*/min=adb_min->lifetime;max=adb_
max->lifetime;}else{void*cursor;structrfapi_rib_keyrk;structrfapi_adb*adb;intrc;
vnc_zlog_debug_verbose("%s:walkingtofindnewmin/max",__func__);cursor=NULL;for(rc
=skiplist_next(rfd->advertised.ipN_by_prefix,(void**)&rk,(void**)&adb,&cursor);!
rc;rc=skiplist_next(rfd->advertised.ipN_by_prefix,(void**)&rk,(void**)&adb,&curs
or)){uint32_tlt=adb->lifetime;if(lt>max)max=lt;if(lt<min)min=lt;}cursor=NULL;for
(rc=skiplist_next(rfd->advertised.ip0_by_ether,(void**)&rk,(void**)&adb,&cursor)
;!rc;rc=skiplist_next(rfd->advertised.ip0_by_ether,(void**)&rk,(void**)&adb,&cur
sor)){uint32_tlt=adb->lifetime;if(lt>max)max=lt;if(lt<min)min=lt;}}/**triggertun
nelrouteupdate*butonlyifwefoundaVPNrouteandithad*alifetimegreaterthan0*/if(max&&
rfd->max_prefix_lifetime!=max)advertise=1;rfd->max_prefix_lifetime=max;rfd->min_
prefix_lifetime=min;}vnc_zlog_debug_verbose("%s:returningadvertise=%d,min=%d,max
=%d",__func__,advertise,rfd->min_prefix_lifetime,rfd->max_prefix_lifetime);retur
n(advertise!=0);}/**ReturnValue**0Noneedtoadvertisetunnelroute*non-0advertisetun
nelroute*/intrfapiApAdd(structbgp*bgp,structrfapi_descriptor*rfd,structprefix*pf
x_ip,structprefix*pfx_eth,structprefix_rd*prd,uint32_tlifetime,uint8_tcost,struc
trfapi_l2address_option*l2o)/*otheroptionsTBD*/{intrc;structrfapi_adb*adb;uint32
_told_lifetime=0;intuse_ip0=0;structrfapi_rib_keyrk;rfapi_rib_key_init(pfx_ip,pr
d,pfx_eth,&rk);if(RFAPI_0_PREFIX(pfx_ip)&&RFAPI_HOST_PREFIX(pfx_ip)){use_ip0=1;a
ssert(pfx_eth);rc=skiplist_search(rfd->advertised.ip0_by_ether,&rk,(void**)&adb)
;}else{/*findprefixinadvertisedprefixeslist*/rc=skiplist_search(rfd->advertised.
ipN_by_prefix,&rk,(void**)&adb);}if(rc){/*Notfound*/adb=XCALLOC(MTYPE_RFAPI_ADB,
sizeof(structrfapi_adb));assert(adb);adb->lifetime=lifetime;adb->u.key=rk;if(use
_ip0){assert(pfx_eth);skiplist_insert(rfd->advertised.ip0_by_ether,&adb->u.key,a
db);}else{skiplist_insert(rfd->advertised.ipN_by_prefix,&adb->u.key,adb);}skipli
st_insert(rfd->advertised.by_lifetime,adb,adb);}else{old_lifetime=adb->lifetime;
if(old_lifetime!=lifetime){assert(!skiplist_delete(rfd->advertised.by_lifetime,a
db,NULL));adb->lifetime=lifetime;assert(!skiplist_insert(rfd->advertised.by_life
time,adb,adb));}}adb->cost=cost;if(l2o)adb->l2o=*l2o;elsememset(&adb->l2o,0,size
of(structrfapi_l2address_option));if(rfapiApAdjustLifetimeStats(rfd,(rc?NULL:&ol
d_lifetime),&lifetime))return1;return0;}/**Afterthisfunctionreturnssuccessfully,
callershouldcall*rfapiAdjustLifetimeStats()andpossiblyrfapiTunnelRouteAnnounce()
*/intrfapiApDelete(structbgp*bgp,structrfapi_descriptor*rfd,structprefix*pfx_ip,
structprefix*pfx_eth,structprefix_rd*prd,int*advertise_tunnel)/*out*/{intrc;stru
ctrfapi_adb*adb;uint32_told_lifetime;intuse_ip0=0;structrfapi_rib_keyrk;if(adver
tise_tunnel)*advertise_tunnel=0;rfapi_rib_key_init(pfx_ip,prd,pfx_eth,&rk);/*fin
dprefixinadvertisedprefixeslist*/if(RFAPI_0_PREFIX(pfx_ip)&&RFAPI_HOST_PREFIX(pf
x_ip)){use_ip0=1;assert(pfx_eth);rc=skiplist_search(rfd->advertised.ip0_by_ether
,&rk,(void**)&adb);}else{/*findprefixinadvertisedprefixeslist*/rc=skiplist_searc
h(rfd->advertised.ipN_by_prefix,&rk,(void**)&adb);}if(rc){returnENOENT;}old_life
time=adb->lifetime;if(use_ip0){rc=skiplist_delete(rfd->advertised.ip0_by_ether,&
rk,NULL);}else{rc=skiplist_delete(rfd->advertised.ipN_by_prefix,&rk,NULL);}asser
t(!rc);rc=skiplist_delete(rfd->advertised.by_lifetime,adb,NULL);assert(!rc);rfap
iAdbFree(adb);if(rfapiApAdjustLifetimeStats(rfd,&old_lifetime,NULL)){if(advertis
e_tunnel)*advertise_tunnel=1;}return0;}