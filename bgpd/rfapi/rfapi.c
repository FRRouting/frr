/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
nclude<errno.h>#include"lib/zebra.h"#include"lib/prefix.h"#include"lib/table.h"#
include"lib/vty.h"#include"lib/memory.h"#include"lib/routemap.h"#include"lib/log
.h"#include"lib/linklist.h"#include"lib/command.h"#include"lib/stream.h"#include
"lib/ringbuf.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_ecommunity.h"#include"bgpd
/bgp_attr.h"#include"bgpd/rfapi/bgp_rfapi_cfg.h"#include"bgpd/rfapi/rfapi.h"#inc
lude"bgpd/rfapi/rfapi_backend.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_mpls
vpn.h"#include"bgpd/bgp_aspath.h"#include"bgpd/bgp_advertise.h"#include"bgpd/bgp
_vnc_types.h"#include"bgpd/bgp_zebra.h"#include"bgpd/rfapi/rfapi_import.h"#inclu
de"bgpd/rfapi/rfapi_private.h"#include"bgpd/rfapi/rfapi_monitor.h"#include"bgpd/
rfapi/rfapi_vty.h"#include"bgpd/rfapi/vnc_export_bgp.h"#include"bgpd/rfapi/vnc_e
xport_bgp_p.h"#include"bgpd/rfapi/vnc_zebra.h"#include"bgpd/rfapi/vnc_import_bgp
.h"#include"bgpd/rfapi/rfapi_rib.h"#include"bgpd/rfapi/rfapi_ap.h"#include"bgpd/
rfapi/rfapi_encap_tlv.h"#include"bgpd/rfapi/vnc_debug.h"#ifdefHAVE_GLIBC_BACKTRA
CE/*forbacktraceandfriends*/#include<execinfo.h>#endif/*HAVE_GLIBC_BACKTRACE*/st
ructethaddrrfapi_ethaddr0={{0}};#defineDEBUG_RFAPI_STR"RFAPIdebugging/testingcom
mand\n"constchar*rfapi_error_str(intcode){switch(code){case0:return"Success";cas
eENXIO:return"BGPorVNCnotconfigured";caseENOENT:return"Nomatch";caseEEXIST:retur
n"Handlealreadyopen";caseENOMSG:return"Incompleteconfiguration";caseEAFNOSUPPORT
:return"Invalidaddressfamily";caseEDEADLK:return"Calledfromwithinacallbackproced
ure";caseEBADF:return"Invalidhandle";caseEINVAL:return"Invalidargument";caseESTA
LE:return"Staledescriptor";default:return"Unknownerror";}}/*--------------------
----------------------*rfapi_get_response_lifetime_default**Returnsthedefaultlif
etimeforaresponse.*rfp_start_valvaluereturnedbyrfp_startor*NULL(=usedefaultinsta
nce)**input:*None**output:**returnvalue:Thebgpinstancedefaultlifetimeforarespons
e.--------------------------------------------*/intrfapi_get_response_lifetime_d
efault(void*rfp_start_val){structbgp*bgp=rfapi_bgp_lookup_by_rfp(rfp_start_val);
if(bgp)returnbgp->rfapi_cfg->default_response_lifetime;returnBGP_VNC_DEFAULT_RES
PONSE_LIFETIME_DEFAULT;}/*------------------------------------------*rfapi_is_vn
c_configured**ReturnsifVNCisconfigured**input:*rfp_start_valvaluereturnedbyrfp_s
tartor*NULL(=usedefaultinstance)**output:**returnvalue:IfVNCisconfiguredforthebg
pdinstance*0Success*ENXIOVNCnotconfigured---------------------------------------
-----*/intrfapi_is_vnc_configured(void*rfp_start_val){structbgp*bgp=rfapi_bgp_lo
okup_by_rfp(rfp_start_val);if(bgp_rfapi_is_vnc_configured(bgp)==0)return0;return
ENXIO;}/*------------------------------------------*rfapi_get_vn_addr**Getthevir
tualnetworkaddressusedbyanNVEbasedonit'sRFD**input:*rfd:rfapidescriptorreturnedb
yrfapi_openorrfapi_create_generic**output:**returnvalue:*vnNVEvirtualnetworkaddr
ess*------------------------------------------*/structrfapi_ip_addr*rfapi_get_vn
_addr(void*rfd){structrfapi_descriptor*rrfd=(structrfapi_descriptor*)rfd;return&
rrfd->vn_addr;}/*------------------------------------------*rfapi_get_un_addr**G
ettheunderlaynetworkaddressusedbyanNVEbasedonit'sRFD**input:*rfd:rfapidescriptor
returnedbyrfapi_openorrfapi_create_generic**output:**returnvalue:*unNVEunderlayn
etworkaddress*------------------------------------------*/structrfapi_ip_addr*rf
api_get_un_addr(void*rfd){structrfapi_descriptor*rrfd=(structrfapi_descriptor*)r
fd;return&rrfd->un_addr;}intrfapi_ip_addr_cmp(structrfapi_ip_addr*a1,structrfapi
_ip_addr*a2){if(a1->addr_family!=a2->addr_family)returna1->addr_family-a2->addr_
family;if(a1->addr_family==AF_INET){returnIPV4_ADDR_CMP(&a1->addr.v4,&a2->addr.v
4);}if(a1->addr_family==AF_INET6){returnIPV6_ADDR_CMP(&a1->addr.v6,&a2->addr.v6)
;}assert(1);/*NOTREACHED*/return1;}staticintrfapi_find_node(structbgp*bgp,struct
rfapi_ip_addr*vn_addr,structrfapi_ip_addr*un_addr,structroute_node**node){struct
rfapi*h;structprefixp;structroute_node*rn;intrc;afi_tafi;if(!bgp){returnENXIO;}h
=bgp->rfapi;if(!h){returnENXIO;}afi=family2afi(un_addr->addr_family);if(!afi){re
turnEAFNOSUPPORT;}if((rc=rfapiRaddr2Qprefix(un_addr,&p)))returnrc;rn=route_node_
lookup(h->un[afi],&p);if(!rn)returnENOENT;route_unlock_node(rn);*node=rn;return0
;}intrfapi_find_rfd(structbgp*bgp,structrfapi_ip_addr*vn_addr,structrfapi_ip_add
r*un_addr,structrfapi_descriptor**rfd){structroute_node*rn;intrc;rc=rfapi_find_n
ode(bgp,vn_addr,un_addr,&rn);if(rc)returnrc;for(*rfd=(structrfapi_descriptor*)(r
n->info);*rfd;*rfd=(*rfd)->next){if(!rfapi_ip_addr_cmp(&(*rfd)->vn_addr,vn_addr)
)break;}if(!*rfd)returnENOENT;return0;}/*---------------------------------------
---*rfapi_find_handle**input:*ununderlaynetworkaddress*vnvirtualnetworkaddress**
output:*pHandlepointertolocationtostorehandle**returnvalue:*0Success*ENOENTnomat
chinghandle*ENXIOBGPorVNCnotconfigured*-----------------------------------------
-*/staticintrfapi_find_handle(structbgp*bgp,structrfapi_ip_addr*vn_addr,structrf
api_ip_addr*un_addr,rfapi_handle*handle){structrfapi_descriptor**rfd;rfd=(struct
rfapi_descriptor**)handle;returnrfapi_find_rfd(bgp,vn_addr,un_addr,rfd);}statici
ntrfapi_find_handle_vty(structvty*vty,structrfapi_ip_addr*vn_addr,structrfapi_ip
_addr*un_addr,rfapi_handle*handle){structbgp*bgp;structrfapi_descriptor**rfd;bgp
=bgp_get_default();/*assume1instancefornow*/rfd=(structrfapi_descriptor**)handle
;returnrfapi_find_rfd(bgp,vn_addr,un_addr,rfd);}staticintis_valid_rfd(structrfap
i_descriptor*rfd){rfapi_handlehh;if(!rfd||rfd->bgp==NULL)return0;if(CHECK_FLAG(r
fd->flags,RFAPI_HD_FLAG_IS_VRF))/*assumeVRF/internalarevalid*/return1;if(rfapi_f
ind_handle(rfd->bgp,&rfd->vn_addr,&rfd->un_addr,&hh))return0;if(rfd!=hh)return0;
return1;}/**checkstatusofdescriptor*/intrfapi_check(void*handle){structrfapi_des
criptor*rfd=(structrfapi_descriptor*)handle;rfapi_handlehh;intrc;if(!rfd||rfd->b
gp==NULL)returnEINVAL;if(CHECK_FLAG(rfd->flags,RFAPI_HD_FLAG_IS_VRF))/*assumeVRF
/internalarevalid*/return0;if((rc=rfapi_find_handle(rfd->bgp,&rfd->vn_addr,&rfd-
>un_addr,&hh)))returnrc;if(rfd!=hh)returnENOENT;if(!rfd->rfg)returnESTALE;return
0;}voiddel_vnc_route(structrfapi_descriptor*rfd,structpeer*peer,/*rfd->peerforRF
Pregs*/structbgp*bgp,safi_tsafi,structprefix*p,structprefix_rd*prd,uint8_ttype,u
int8_tsub_type,structrfapi_nexthop*lnh,intkill){afi_tafi;/*oftheVNaddress*/struc
tbgp_node*bn;structbgp_info*bi;charbuf[PREFIX_STRLEN];charbuf2[RD_ADDRSTRLEN];st
ructprefix_rdprd0;prefix2str(p,buf,sizeof(buf));afi=family2afi(p->family);assert
(afi==AFI_IP||afi==AFI_IP6);if(safi==SAFI_ENCAP){memset(&prd0,0,sizeof(prd0));pr
d0.family=AF_UNSPEC;prd0.prefixlen=64;prd=&prd0;}bn=bgp_afi_node_get(bgp->rib[af
i][safi],afi,safi,p,prd);vnc_zlog_debug_verbose("%s:peer=%p,prefix=%s,prd=%safi=
%d,safi=%dbn=%p,bn->info=%p",__func__,peer,buf,prefix_rd2str(prd,buf2,sizeof(buf
2)),afi,safi,bn,(bn?bn->info:NULL));for(bi=(bn?bn->info:NULL);bi;bi=bi->next){vn
c_zlog_debug_verbose("%s:tryingbi=%p,bi->peer=%p,bi->type=%d,bi->sub_type=%d,bi-
>extra->vnc.export.rfapi_handle=%p,local_pref=%u",__func__,bi,bi->peer,bi->type,
bi->sub_type,(bi->extra?bi->extra->vnc.export.rfapi_handle:NULL),((bi->attr&&CHE
CK_FLAG(bi->attr->flag,ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)))?bi->attr->local_pref
:0));if(bi->peer==peer&&bi->type==type&&bi->sub_type==sub_type&&bi->extra&&bi->e
xtra->vnc.export.rfapi_handle==(void*)rfd){vnc_zlog_debug_verbose("%s:matchedit"
,__func__);break;}}if(lnh){/**lnhsetmeanstoJUSTdeletethelocalnexthopfromthis*rou
te.Leavetherouteitselfinplace.*TBDaddreturncodereportingofsuccess/failure*/if(!b
i||!bi->extra||!bi->extra->vnc.export.local_nexthops){/**nolocalnexthops*/vnc_zl
og_debug_verbose("%s:lnhlistalreadyemptyatprefix%s",__func__,buf);gotodone;}/**l
ookforit*/structlistnode*node;structrfapi_nexthop*pLnh=NULL;for(ALL_LIST_ELEMENT
S_RO(bi->extra->vnc.export.local_nexthops,node,pLnh)){if(prefix_same(&pLnh->addr
,&lnh->addr)){break;}}if(pLnh){listnode_delete(bi->extra->vnc.export.local_nexth
ops,pLnh);/*sillyrabbit,listnode_deletedoesn'tinvoke*list->delondata*/rfapi_next
hop_free(pLnh);}else{vnc_zlog_debug_verbose("%s:desiredlnhnotfound%s",__func__,b
uf);}gotodone;}/**loopbacktoimporttables*DothisbeforeremovingfromBGPRIBbecauserf
apiProcessWithdraw*mightrefertoit*/rfapiProcessWithdraw(peer,rfd,p,prd,NULL,afi,
safi,type,kill);if(bi){charbuf[PREFIX_STRLEN];prefix2str(p,buf,sizeof(buf));vnc_
zlog_debug_verbose("%s:Foundroute(safi=%d)todeleteatprefix%s",__func__,safi,buf)
;if(safi==SAFI_MPLS_VPN){structbgp_node*prn=NULL;structbgp_table*table=NULL;prn=
bgp_node_get(bgp->rib[afi][safi],(structprefix*)prd);if(prn->info){table=(struct
bgp_table*)(prn->info);vnc_import_bgp_del_vnc_host_route_mode_resolve_nve(bgp,pr
d,table,p,bi);}bgp_unlock_node(prn);}/**Deletelocal_nexthopslist*/if(bi->extra&&
bi->extra->vnc.export.local_nexthops){list_delete_and_null(&bi->extra->vnc.expor
t.local_nexthops);}bgp_aggregate_decrement(bgp,p,bi,afi,safi);bgp_info_delete(bn
,bi);bgp_process(bgp,bn,afi,safi);}else{vnc_zlog_debug_verbose("%s:Couldn'tfindr
oute(safi=%d)atprefix%s",__func__,safi,buf);}done:bgp_unlock_node(bn);}structrfa
pi_nexthop*rfapi_nexthop_new(structrfapi_nexthop*copyme){structrfapi_nexthop*new
=XCALLOC(MTYPE_RFAPI_NEXTHOP,sizeof(structrfapi_nexthop));if(copyme)*new=*copyme
;returnnew;}voidrfapi_nexthop_free(void*p){structrfapi_nexthop*goner=p;XFREE(MTY
PE_RFAPI_NEXTHOP,goner);}structrfapi_vn_option*rfapi_vn_options_dup(structrfapi_
vn_option*existing){structrfapi_vn_option*p;structrfapi_vn_option*head=NULL;stru
ctrfapi_vn_option*tail=NULL;for(p=existing;p;p=p->next){structrfapi_vn_option*ne
w;new=XCALLOC(MTYPE_RFAPI_VN_OPTION,sizeof(structrfapi_vn_option));*new=*p;new->
next=NULL;if(tail)(tail)->next=new;tail=new;if(!head){head=new;}}returnhead;}voi
drfapi_un_options_free(structrfapi_un_option*p){structrfapi_un_option*next;while
(p){next=p->next;XFREE(MTYPE_RFAPI_UN_OPTION,p);p=next;}}voidrfapi_vn_options_fr
ee(structrfapi_vn_option*p){structrfapi_vn_option*next;while(p){next=p->next;XFR
EE(MTYPE_RFAPI_VN_OPTION,p);p=next;}}/*Basedonbgp_redistribute_add()*/voidadd_vn
c_route(structrfapi_descriptor*rfd,/*cookie,VPNUNaddr,peer*/structbgp*bgp,intsaf
i,structprefix*p,structprefix_rd*prd,structrfapi_ip_addr*nexthop,uint32_t*local_
pref,uint32_t*lifetime,/*NULL=>dontsendlifetime*/structbgp_tea_options*rfp_optio
ns,structrfapi_un_option*options_un,structrfapi_vn_option*options_vn,structecomm
unity*rt_export_list,/*Copied,notconsumed*/uint32_t*med,/*NULL=>don'tsetmed*/uin
t32_t*label,/*loworder3bytes*/uint8_ttype,uint8_tsub_type,/*RFP,NORMALorREDIST*/
intflags){afi_tafi;/*oftheVNaddress*/structbgp_info*new;structbgp_info*bi;struct
bgp_node*bn;structattrattr={0};structattr*new_attr;uint32_tlabel_val;structbgp_a
ttr_encap_subtlv*encaptlv;charbuf[PREFIX_STRLEN];charbuf2[RD_ADDRSTRLEN];#if0/*u
nused?*/structprefixpfx_buf;#endifstructrfapi_nexthop*lnh=NULL;/*localnexthop*/s
tructrfapi_vn_option*vo;structrfapi_l2address_option*l2o=NULL;structrfapi_ip_add
r*un_addr=&rfd->un_addr;bgp_encap_typesTunnelType=BGP_ENCAP_TYPE_RESERVED;struct
bgp_redist*red;if(safi==SAFI_ENCAP&&!(bgp->rfapi_cfg->flags&BGP_VNC_CONFIG_ADV_U
N_METHOD_ENCAP)){/**Encapmodenotenabled.UNaddresseswillbecommunicated*viaVNCTunn
elsubtlvinstead.*/vnc_zlog_debug_verbose("%s:encapmodenotenabled,notaddingSAFI_E
NCAProute",__func__);return;}#if0/*unused?*/if((safi==SAFI_MPLS_VPN)&&(flags&RFA
PI_AHR_SET_PFX_TO_NEXTHOP)){if(rfapiRaddr2Qprefix(nexthop,&pfx_buf)){vnc_zlog_de
bug_verbose("%s:can'tsetpfxtovnaddr,notaddingSAFI_MPLS_VPNroute",__func__);retur
n;}p=&pfx_buf;}#endiffor(vo=options_vn;vo;vo=vo->next){if(RFAPI_VN_OPTION_TYPE_L
2ADDR==vo->type){l2o=&vo->v.l2addr;if(RFAPI_0_ETHERADDR(&l2o->macaddr))l2o=NULL;
/*notMACresolution*/}if(RFAPI_VN_OPTION_TYPE_LOCAL_NEXTHOP==vo->type){lnh=&vo->v
.local_nexthop;}}if(label)label_val=*label;elselabel_val=MPLS_LABEL_IMPLICIT_NUL
L;prefix_rd2str(prd,buf2,sizeof(buf2));afi=family2afi(p->family);assert(afi==AFI
_IP||afi==AFI_IP6);vnc_zlog_debug_verbose("%s:afi=%s,safi=%s",__func__,afi2str(a
fi),safi2str(safi));/*Makedefaultattribute.Producesalready-internedattr.aspath*/
/*Cripes,thememorymanagementofattributesisbyzantine*/bgp_attr_default_set(&attr,
BGP_ORIGIN_INCOMPLETE);/**Atthispoint:*attr:static*extra:dynamicallyallocated,ow
nedbyattr*aspath:pointstointernedhashfromaspathhashtable*//**Route-specificun_op
tionsgetaddedtotheVPNSAFI*advertisementtunnelencapattribute.(theper-NVE*"default
"un_optionsareputintothe1-per-NVEENCAP*SAFIadvertisement).TheVPNSAFIalsogetsthe*
defaultun_optionsiftherearenoroute-specificoptions.*/if(options_un){structrfapi_
un_option*uo;for(uo=options_un;uo;uo=uo->next){if(RFAPI_UN_OPTION_TYPE_TUNNELTYP
E==uo->type){TunnelType=rfapi_tunneltype_option_to_tlv(bgp,un_addr,&uo->v.tunnel
,&attr,l2o!=NULL);}}}else{/**Addencapattr*ThesearetheNVE-specific"default"un_opt
ionswhichare*putintothe1-per-NVEENCAPadvertisement.*/if(rfd->default_tunneltype_
option.type){TunnelType=rfapi_tunneltype_option_to_tlv(bgp,un_addr,&rfd->default
_tunneltype_option,&attr,l2o!=NULL);}else/*createdefaultforlocaladdse*/if(type==
ZEBRA_ROUTE_BGP&&sub_type==BGP_ROUTE_RFP)TunnelType=rfapi_tunneltype_option_to_t
lv(bgp,un_addr,NULL,&attr,l2o!=NULL);}if(TunnelType==BGP_ENCAP_TYPE_MPLS){if(saf
i==SAFI_ENCAP){/*EncapSAFInotusedwithMPLS*/vnc_zlog_debug_verbose("%s:mplstunnel
type,encapsafiomitted",__func__);aspath_unintern(&attr.aspath);/*Uninternorigina
l.*/return;}}if(local_pref){attr.local_pref=*local_pref;attr.flag|=ATTR_FLAG_BIT
(BGP_ATTR_LOCAL_PREF);}if(med){attr.med=*med;attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_M
ULTI_EXIT_DISC);}/*overridedefaultweightassignedbybgp_attr_default_set()*/attr.w
eight=rfd->peer?rfd->peer->weight[afi][safi]:0;/**NB:ticket81:donotresetattr.asp
athherebecauseitwould*causeiBGPpeerstodroproute*//**SetoriginatorIDforroutesimpo
rtedfromBGPdirectly.*Theseroutescouldbesynthetic,andthereforecould*reusethepeerp
ointersoftheroutestheyarederived*from.SettingtheoriginatorIDto"us"preventsthe*wr
ongoriginatorIDfrombeingsentwhenthisrouteis*sentfromaroutereflector.*/if(type==Z
EBRA_ROUTE_BGP_DIRECT||type==ZEBRA_ROUTE_BGP_DIRECT_EXT){attr.flag|=ATTR_FLAG_BI
T(BGP_ATTR_ORIGINATOR_ID);attr.originator_id=bgp->router_id;}/*Setupvncattribute
(sub-tlvforPrefixLifetime)*/if(lifetime&&*lifetime!=RFAPI_INFINITE_LIFETIME){uin
t32_tlt;encaptlv=XCALLOC(MTYPE_ENCAP_TLV,sizeof(structbgp_attr_encap_subtlv)+4);
assert(encaptlv);encaptlv->type=BGP_VNC_SUBTLV_TYPE_LIFETIME;/*prefixlifetime*/e
ncaptlv->length=4;lt=htonl(*lifetime);memcpy(encaptlv->value,&lt,4);attr.vnc_sub
tlvs=encaptlv;vnc_zlog_debug_verbose("%s:setEncapAttrPrefixLifetimeto%d",__func_
_,*lifetime);}/*addrfpoptionstovncattr*/if(rfp_options){if(flags&RFAPI_AHR_RFPOP
T_IS_VNCTLV){/**thisflagmeanswe'repassingapointertoan*existingencaptlvchainwhich
weshouldcopy.*It'sahacktoavoidaddingyetanotherargument*toadd_vnc_route()*/encapt
lv=encap_tlv_dup((structbgp_attr_encap_subtlv*)rfp_options);if(attr.vnc_subtlvs)
{attr.vnc_subtlvs->next=encaptlv;}else{attr.vnc_subtlvs=encaptlv;}}else{structbg
p_tea_options*hop;/*XXXmaxofonetlvpresentsofarfromabovecode*/structbgp_attr_enca
p_subtlv*tail=attr.vnc_subtlvs;for(hop=rfp_options;hop;hop=hop->next){/**Constru
ctsubtlv*/encaptlv=XCALLOC(MTYPE_ENCAP_TLV,sizeof(structbgp_attr_encap_subtlv)+2
+hop->length);assert(encaptlv);encaptlv->type=BGP_VNC_SUBTLV_TYPE_RFPOPTION;/*RF
Poption*/encaptlv->length=2+hop->length;*((uint8_t*)(encaptlv->value)+0)=hop->ty
pe;*((uint8_t*)(encaptlv->value)+1)=hop->length;memcpy(((uint8_t*)encaptlv->valu
e)+2,hop->value,hop->length);/**addtoendofsubtlvchain*/if(tail){tail->next=encap
tlv;}else{attr.vnc_subtlvs=encaptlv;}tail=encaptlv;}}}/**Atthispoint:*attr:stati
c*extra:dynamicallyallocated,ownedbyattr*vnc_subtlvs:dynamicchain,length1*aspath
:pointstointernedhashfromaspathhashtable*/attr.ecommunity=ecommunity_new();asser
t(attr.ecommunity);if(TunnelType!=BGP_ENCAP_TYPE_MPLS&&TunnelType!=BGP_ENCAP_TYP
E_RESERVED){/**AddBGPEncapsulationExtendedCommunity.Formatdescribedin*section4.5
ofRFC5512.*AlwaysincludewhennotMPLStype,todisambiguatethiscase.*/structecommunit
y_valbeec;memset(&beec,0,sizeof(beec));beec.val[0]=ECOMMUNITY_ENCODE_OPAQUE;beec
.val[1]=ECOMMUNITY_OPAQUE_SUBTYPE_ENCAP;beec.val[6]=((TunnelType)>>8)&0xff;beec.
val[7]=(TunnelType)&0xff;ecommunity_add_val(attr.ecommunity,&beec);}/**Addextend
edcommunityattributestomatchrtexportlist*/if(rt_export_list){attr.ecommunity=eco
mmunity_merge(attr.ecommunity,rt_export_list);}if(attr.ecommunity->size){attr.fl
ag|=ATTR_FLAG_BIT(BGP_ATTR_EXT_COMMUNITIES);}else{ecommunity_free(&attr.ecommuni
ty);attr.ecommunity=NULL;}vnc_zlog_debug_verbose("%s:attr.ecommunity=%p",__func_
_,attr.ecommunity);/**Atthispoint:*attr:static*extra:dynamicallyallocated,ownedb
yattr*vnc_subtlvs:dynamicchain,length1*ecommunity:dynamic2-part*aspath:pointstoi
nternedhashfromaspathhashtable*//*stuffnexthopinattr_extra;whichfielddependsonIP
v4orIPv6*/switch(nexthop->addr_family){caseAF_INET:/**setthisfieldtopreventbgp_r
oute.ccodefromsetting*mp_nexthop_global_intoself*/attr.nexthop.s_addr=nexthop->a
ddr.v4.s_addr;attr.mp_nexthop_global_in=nexthop->addr.v4;attr.mp_nexthop_len=4;b
reak;caseAF_INET6:attr.mp_nexthop_global=nexthop->addr.v6;attr.mp_nexthop_len=16
;break;default:assert(0);}prefix2str(p,buf,sizeof(buf));/**Atthispoint:**attr:st
atic*extra:dynamicallyallocated,ownedbyattr*vnc_subtlvs:dynamicchain,length1*eco
mmunity:dynamic2-part*aspath:pointstointernedhashfromaspathhashtable*/red=bgp_re
dist_lookup(bgp,afi,type,0);if(red&&red->redist_metric_flag){attr.med=red->redis
t_metric;attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC);}bn=bgp_afi_node_get
(bgp->rib[afi][safi],afi,safi,p,prd);/**bgp_attr_interncreatesanewreferencetoaca
ched*attribute,butleavesthefollowingbitsoftrash:*-oldattr*-oldattr->extra(freevi
abgp_attr_extra_free(attr))**Notethatitfreestheoriginalattr->extra->ecommunity*b
utleavesthenewattributepointingtotheORIGINAL*vncoptions(whichthereforeweneedn'tf
reefromthe*staticattr)*/new_attr=bgp_attr_intern(&attr);aspath_unintern(&attr.as
path);/*Uninternoriginal.*//**Atthispoint:**attr:static*extra:dynamicallyallocat
ed,ownedbyattr*vnc_subtlvs:dynamicchain,length1*ecommunity:POINTSTOINTERNEDecom,
THISREFNOTCOUNTED**new_attr:anattrthatispartofthehashtable,distinct*fromattrwhic
hisstatic.*extra:dynamicallyallocated,ownedbynew_attr(inhashtable)*vnc_subtlvs:P
OINTSTOSAMEdynamicchainASattr*ecommunity:POINTSTOinterned/refcounteddynamic2-par
tASattr*aspath:POINTSTOinterned/refcountedhashedblock*/for(bi=bn->info;bi;bi=bi-
>next){/*probablyonlyneedtocheck*bi->extra->vnc.export.rfapi_handle*/if(bi->peer
==rfd->peer&&bi->type==type&&bi->sub_type==sub_type&&bi->extra&&bi->extra->vnc.e
xport.rfapi_handle==(void*)rfd){break;}}if(bi){/**Addingnewlocal_nexthop,whichdo
esnotbyitselfchange*whatisadvertisedviaBGP*/if(lnh){if(!bi->extra->vnc.export.lo
cal_nexthops){/*TBDmakearrangementstofreewhenneeded*/bi->extra->vnc.export.local
_nexthops=list_new();bi->extra->vnc.export.local_nexthops->del=rfapi_nexthop_fre
e;}/**alreadypresent?*/structlistnode*node;structrfapi_nexthop*pLnh=NULL;for(ALL
_LIST_ELEMENTS_RO(bi->extra->vnc.export.local_nexthops,node,pLnh)){if(prefix_sam
e(&pLnh->addr,&lnh->addr)){break;}}/**Notpresent,addnewone*/if(!pLnh){pLnh=rfapi
_nexthop_new(lnh);listnode_add(bi->extra->vnc.export.local_nexthops,pLnh);}}if(a
ttrhash_cmp(bi->attr,new_attr)&&!CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){bgp_att
r_unintern(&new_attr);bgp_unlock_node(bn);vnc_zlog_debug_any("%s:Foundroute(safi
=%d)atprefix%s,nochange",__func__,safi,buf);gotodone;}else{/*Theattributeischang
ed.*/bgp_info_set_flag(bn,bi,BGP_INFO_ATTR_CHANGED);if(safi==SAFI_MPLS_VPN){stru
ctbgp_node*prn=NULL;structbgp_table*table=NULL;prn=bgp_node_get(bgp->rib[afi][sa
fi],(structprefix*)prd);if(prn->info){table=(structbgp_table*)(prn->info);vnc_im
port_bgp_del_vnc_host_route_mode_resolve_nve(bgp,prd,table,p,bi);}bgp_unlock_nod
e(prn);}/*RewriteBGProuteinformation.*/if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)
)bgp_info_restore(bn,bi);elsebgp_aggregate_decrement(bgp,p,bi,afi,safi);bgp_attr
_unintern(&bi->attr);bi->attr=new_attr;bi->uptime=bgp_clock();if(safi==SAFI_MPLS
_VPN){structbgp_node*prn=NULL;structbgp_table*table=NULL;prn=bgp_node_get(bgp->r
ib[afi][safi],(structprefix*)prd);if(prn->info){table=(structbgp_table*)(prn->in
fo);vnc_import_bgp_add_vnc_host_route_mode_resolve_nve(bgp,prd,table,p,bi);}bgp_
unlock_node(prn);}/*Processchange.*/bgp_aggregate_increment(bgp,p,bi,afi,safi);b
gp_process(bgp,bn,afi,safi);bgp_unlock_node(bn);vnc_zlog_debug_any("%s:Foundrout
e(safi=%d)atprefix%s,changedattr",__func__,safi,buf);gotodone;}}new=bgp_info_new
();new->type=type;new->sub_type=sub_type;new->peer=rfd->peer;SET_FLAG(new->flags
,BGP_INFO_VALID);new->attr=new_attr;new->uptime=bgp_clock();/*savebackreftorfapi
handle*/assert(bgp_info_extra_get(new));new->extra->vnc.export.rfapi_handle=(voi
d*)rfd;encode_label(label_val,&new->extra->label[0]);/*debug*/if(VNC_DEBUG(VERBO
SE)){vnc_zlog_debug_verbose("%s:printingBI",__func__);rfapiPrintBi(NULL,new);}bg
p_aggregate_increment(bgp,p,new,afi,safi);bgp_info_add(bn,new);if(safi==SAFI_MPL
S_VPN){structbgp_node*prn=NULL;structbgp_table*table=NULL;prn=bgp_node_get(bgp->
rib[afi][safi],(structprefix*)prd);if(prn->info){table=(structbgp_table*)(prn->i
nfo);vnc_import_bgp_add_vnc_host_route_mode_resolve_nve(bgp,prd,table,p,new);}bg
p_unlock_node(prn);encode_label(label_val,&bn->local_label);}bgp_unlock_node(bn)
;bgp_process(bgp,bn,afi,safi);vnc_zlog_debug_any("%s:Addedroute(safi=%s)atprefix
%s(bn=%p,prd=%s)",__func__,safi2str(safi),buf,bn,buf2);done:/*Loopbacktoimportta
bles*/rfapiProcessUpdate(rfd->peer,rfd,p,prd,new_attr,afi,safi,type,sub_type,&la
bel_val);vnc_zlog_debug_verbose("%s:loopedbackimportroute(safi=%d)",__func__,saf
i);}uint32_trfp_cost_to_localpref(uint8_tcost){return255-cost;}staticvoidrfapiTu
nnelRouteAnnounce(structbgp*bgp,structrfapi_descriptor*rfd,uint32_t*pLifetime){s
tructprefix_rdprd;structprefixpfx_vn;intrc;uint32_tlocal_pref=rfp_cost_to_localp
ref(0);rc=rfapiRaddr2Qprefix(&(rfd->vn_addr),&pfx_vn);assert(!rc);/**Constructro
utedistinguisher=0*/memset(&prd,0,sizeof(prd));prd.family=AF_UNSPEC;prd.prefixle
n=64;add_vnc_route(rfd,/*rfapidescr,forexportlist&backref*/bgp,/*whichbgpinstanc
e*/SAFI_ENCAP,/*whichSAFI*/&pfx_vn,/*prefixtoadvertise*/&prd,/*routedistinguishe
rtouse*/&rfd->un_addr,/*nexthop*/&local_pref,pLifetime,/*maxlifetimeofchildVPNro
utes*/NULL,/*norfpoptionsforENCAPsafi*/NULL,/*rfpunoptions*/NULL,/*rfpvnoptions*
/rfd->rt_export_list,NULL,/*med*/NULL,/*label:default*/ZEBRA_ROUTE_BGP,BGP_ROUTE
_RFP,0);}/**********************************************************************
**RFPprocessingbehaviorconfiguration********************************************
***************************//*------------------------------------------*rfapi_r
fp_set_configuration**Thisisusedtochangerfapi'sprocessingbehaviorbasedon*RFPrequ
irements.**input:*rfp_start_valvaluereturnedbyrfp_start*rfapi_rfp_cfgPointertoco
nfigurationstructure**output:*none**returnvalue:*0Success*ENXIOUnabledtolocateco
nfiguredBGP/VNC--------------------------------------------*/intrfapi_rfp_set_co
nfiguration(void*rfp_start_val,structrfapi_rfp_cfg*new){structrfapi_rfp_cfg*rcfg
;structbgp*bgp;bgp=rfapi_bgp_lookup_by_rfp(rfp_start_val);if(!new||!bgp||!bgp->r
fapi_cfg)returnENXIO;rcfg=&bgp->rfapi_cfg->rfp_cfg;rcfg->download_type=new->down
load_type;rcfg->ftd_advertisement_interval=new->ftd_advertisement_interval;rcfg-
>holddown_factor=new->holddown_factor;if(rcfg->use_updated_response!=new->use_up
dated_response){rcfg->use_updated_response=new->use_updated_response;if(rcfg->us
e_updated_response)rfapiMonitorCallbacksOn(bgp);elserfapiMonitorCallbacksOff(bgp
);}if(rcfg->use_removes!=new->use_removes){rcfg->use_removes=new->use_removes;if
(rcfg->use_removes)rfapiMonitorResponseRemovalOn(bgp);elserfapiMonitorResponseRe
movalOff(bgp);}return0;}/*------------------------------------------*rfapi_rfp_s
et_cb_methods**Changeregisteredcallbackfunctionsforasynchronousnotifications*fro
mRFAPItotheRFPclient.**input:*rfp_start_valvaluereturnedbyrfp_start*methodsPoint
ertostructrfapi_rfp_cb_methodscontaining*pointerstocallbackmethodsasdescribedabo
ve**returnvalue:*0Success*ENXIOBGPorVNCnotconfigured*---------------------------
---------------*/intrfapi_rfp_set_cb_methods(void*rfp_start_val,structrfapi_rfp_
cb_methods*methods){structrfapi*h;structbgp*bgp;bgp=rfapi_bgp_lookup_by_rfp(rfp_
start_val);if(!bgp)returnENXIO;h=bgp->rfapi;if(!h)returnENXIO;h->rfp_methods=*me
thods;return0;}/****************************************************************
********NVESessions*************************************************************
**********//**Callermustsupplyanalready-allocatedrfdwiththe"caller"*fieldsalread
yset(vn_addr,un_addr,callback,cookie)*Theadvertised_prefixes[]arrayelementsshoul
dbeNULLto*havethisfunctionsetthemtonewly-allocatedradixtrees.*/staticintrfapi_op
en_inner(structrfapi_descriptor*rfd,structbgp*bgp,structrfapi*h,structrfapi_nve_
group_cfg*rfg){intret;if(h->flags&RFAPI_INCALLBACK)returnEDEADLK;/**Fillinconfig
uredfields*//**Ifgroup'sRDisspecifiedas"auto",thenfillinbased*onNVE'sVNaddress*/
rfd->rd=rfg->rd;if(rfd->rd.family==AF_UNIX){ret=rfapi_set_autord_from_vn(&rfd->r
d,&rfd->vn_addr);if(ret!=0)returnret;}rfd->rt_export_list=(rfg->rt_export_list)?
ecommunity_dup(rfg->rt_export_list):NULL;rfd->response_lifetime=rfg->response_li
fetime;rfd->rfg=rfg;/**FillinBGPpeerstructure*/rfd->peer=peer_new(bgp);rfd->peer
->status=Established;/*keepbgpcorehappy*/bgp_sync_delete(rfd->peer);/*don'tneedt
hese*//**sincethispeerisnotontheI/Othread,thislockisnotstrictly*necessary,butser
vesasaremindertothosewhomaymeddle...*/pthread_mutex_lock(&rfd->peer->io_mtx);{//
wedon'tneedanyI/Orelatedfacilitiesif(rfd->peer->ibuf)stream_fifo_free(rfd->peer-
>ibuf);if(rfd->peer->obuf)stream_fifo_free(rfd->peer->obuf);if(rfd->peer->ibuf_w
ork)ringbuf_del(rfd->peer->ibuf_work);if(rfd->peer->obuf_work)stream_free(rfd->p
eer->obuf_work);rfd->peer->ibuf=NULL;rfd->peer->obuf=NULL;rfd->peer->obuf_work=N
ULL;rfd->peer->ibuf_work=NULL;}pthread_mutex_unlock(&rfd->peer->io_mtx);{/*basec
odeassumeshavevalidhostpointer*/charbuf[BUFSIZ];buf[0]=0;if(rfd->vn_addr.addr_fa
mily==AF_INET){inet_ntop(AF_INET,&rfd->vn_addr.addr.v4,buf,BUFSIZ);}elseif(rfd->
vn_addr.addr_family==AF_INET6){inet_ntop(AF_INET6,&rfd->vn_addr.addr.v6,buf,BUFS
IZ);}rfd->peer->host=XSTRDUP(MTYPE_BGP_PEER_HOST,buf);}/*MarkpeerasbelongingtoHD
*/SET_FLAG(rfd->peer->flags,PEER_FLAG_IS_RFAPI_HD);/**Setminprefixlifetimetomaxv
aluesoitwillgetset*uponfirstrfapi_register()*/rfd->min_prefix_lifetime=UINT32_MA
X;/**Allocateresponsetablesifneeded*/#defineRFD_RTINIT_AFI(rh,ary,afi)\do{\if(!a
ry[afi]){\ary[afi]=route_table_init();\ary[afi]->info=rh;\}\}while(0)#defineRFD_
RTINIT(rh,ary)\do{\RFD_RTINIT_AFI(rh,ary,AFI_IP);\RFD_RTINIT_AFI(rh,ary,AFI_IP6)
;\RFD_RTINIT_AFI(rh,ary,AFI_L2VPN);\}while(0)RFD_RTINIT(rfd,rfd->rib);RFD_RTINIT
(rfd,rfd->rib_pending);RFD_RTINIT(rfd,rfd->rsp_times);/**LinktoImportTable*/rfd-
>import_table=rfg->rfapi_import_table;rfd->import_table->refcount+=1;rfapiApInit
(&rfd->advertised);/**addthisNVEdescriptortothelistofNVEsintheNVEgroup*/if(!rfg-
>nves){rfg->nves=list_new();}listnode_add(rfg->nves,rfd);vnc_direct_bgp_add_nve(
bgp,rfd);vnc_zebra_add_nve(bgp,rfd);return0;}/*movedfromrfapi_register*/intrfapi
_init_and_open(structbgp*bgp,structrfapi_descriptor*rfd,structrfapi_nve_group_cf
g*rfg){structrfapi*h=bgp->rfapi;charbuf_vn[BUFSIZ];charbuf_un[BUFSIZ];afi_tafi_v
n,afi_un;structprefixpfx_un;structroute_node*rn;rfapi_time(&rfd->open_time);if(r
fg->type==RFAPI_GROUP_CFG_VRF)SET_FLAG(rfd->flags,RFAPI_HD_FLAG_IS_VRF);rfapiRfa
piIpAddr2Str(&rfd->vn_addr,buf_vn,BUFSIZ);rfapiRfapiIpAddr2Str(&rfd->un_addr,buf
_un,BUFSIZ);vnc_zlog_debug_verbose("%s:newRFDwithVN=%sUN=%scookie=%p",__func__,b
uf_vn,buf_un,rfd->cookie);if(rfg->type!=RFAPI_GROUP_CFG_VRF)/*unclearifneededfor
VRF*/{listnode_add(&h->descriptors,rfd);if(h->descriptors.count>h->stat.max_desc
riptors){h->stat.max_descriptors=h->descriptors.count;}/**attachtoUNradixtree*/a
fi_vn=family2afi(rfd->vn_addr.addr_family);afi_un=family2afi(rfd->un_addr.addr_f
amily);assert(afi_vn&&afi_un);assert(!rfapiRaddr2Qprefix(&rfd->un_addr,&pfx_un))
;rn=route_node_get(h->un[afi_un],&pfx_un);assert(rn);rfd->next=rn->info;rn->info
=rfd;rfd->un_node=rn;}returnrfapi_open_inner(rfd,bgp,h,rfg);}structrfapi_vn_opti
on*rfapiVnOptionsDup(structrfapi_vn_option*orig){structrfapi_vn_option*head=NULL
;structrfapi_vn_option*tail=NULL;structrfapi_vn_option*vo=NULL;for(vo=orig;vo;vo
=vo->next){structrfapi_vn_option*new;new=XCALLOC(MTYPE_RFAPI_VN_OPTION,sizeof(st
ructrfapi_vn_option));memcpy(new,vo,sizeof(structrfapi_vn_option));new->next=NUL
L;if(tail){tail->next=new;}else{head=tail=new;}}returnhead;}structrfapi_un_optio
n*rfapiUnOptionsDup(structrfapi_un_option*orig){structrfapi_un_option*head=NULL;
structrfapi_un_option*tail=NULL;structrfapi_un_option*uo=NULL;for(uo=orig;uo;uo=
uo->next){structrfapi_un_option*new;new=XCALLOC(MTYPE_RFAPI_UN_OPTION,sizeof(str
uctrfapi_un_option));memcpy(new,uo,sizeof(structrfapi_un_option));new->next=NULL
;if(tail){tail->next=new;}else{head=tail=new;}}returnhead;}structbgp_tea_options
*rfapiOptionsDup(structbgp_tea_options*orig){structbgp_tea_options*head=NULL;str
uctbgp_tea_options*tail=NULL;structbgp_tea_options*hop=NULL;for(hop=orig;hop;hop
=hop->next){structbgp_tea_options*new;new=XCALLOC(MTYPE_BGP_TEA_OPTIONS,sizeof(s
tructbgp_tea_options));memcpy(new,hop,sizeof(structbgp_tea_options));new->next=N
ULL;if(hop->value){new->value=XCALLOC(MTYPE_BGP_TEA_OPTIONS_VALUE,hop->length);m
emcpy(new->value,hop->value,hop->length);}if(tail){tail->next=new;}else{head=tai
l=new;}}returnhead;}voidrfapiFreeBgpTeaOptionChain(structbgp_tea_options*p){stru
ctbgp_tea_options*next;while(p){next=p->next;if(p->value){XFREE(MTYPE_BGP_TEA_OP
TIONS_VALUE,p->value);p->value=NULL;}XFREE(MTYPE_BGP_TEA_OPTIONS,p);p=next;}}voi
drfapiAdbFree(structrfapi_adb*adb){XFREE(MTYPE_RFAPI_ADB,adb);}staticintrfapi_qu
ery_inner(void*handle,structrfapi_ip_addr*target,structrfapi_l2address_option*l2
o,/*maybeNULL*/structrfapi_next_hop_entry**ppNextHopEntry){afi_tafi;structprefix
p;structprefixp_original;structroute_node*rn;structrfapi_descriptor*rfd=(structr
fapi_descriptor*)handle;structbgp*bgp=rfd->bgp;structrfapi_next_hop_entry*pNHE=N
ULL;structrfapi_ip_addr*self_vn_addr=NULL;inteth_is_0=0;intuse_eth_resolution=0;
structrfapi_next_hop_entry*i_nhe;/*preemptive*/if(!bgp){vnc_zlog_debug_verbose("
%s:NoBGPinstance,returningENXIO",__func__);returnENXIO;}if(!bgp->rfapi){vnc_zlog
_debug_verbose("%s:NoRFAPIinstance,returningENXIO",__func__);returnENXIO;}if(bgp
->rfapi->flags&RFAPI_INCALLBACK){vnc_zlog_debug_verbose("%s:Calledduringcalback,
returningEDEADLK",__func__);returnEDEADLK;}if(!is_valid_rfd(rfd)){vnc_zlog_debug
_verbose("%s:invalidhandle,returningEBADF",__func__);returnEBADF;}rfd->rsp_count
er++;/*dedup:identifythisgeneration*/rfd->rsp_time=rfapi_time(NULL);/*responseco
ntentdedup*/rfd->ftd_last_allowed_time=bgp_clock()-bgp->rfapi_cfg->rfp_cfg.ftd_a
dvertisement_interval;if(l2o){if(!memcmp(l2o->macaddr.octet,rfapi_ethaddr0.octet
,ETH_ALEN)){eth_is_0=1;}/*pert/cPaul/Lou151022*/if(!eth_is_0||l2o->logical_net_i
d){use_eth_resolution=1;}}if(ppNextHopEntry)*ppNextHopEntry=NULL;/**Saveoriginal
targetinprefixform.IncaseofL2-basedqueries,*p_originalwillbemodifiedtoreflectthe
L2target*/assert(!rfapiRaddr2Qprefix(target,&p_original));if(bgp->rfapi_cfg->rfp
_cfg.download_type==RFAPI_RFP_DOWNLOAD_FULL){/*convertqueryto0/0whenfull-tabledo
wnloadisenabled*/memset((char*)&p,0,sizeof(p));p.family=target->addr_family;}els
e{p=p_original;}{charbuf[PREFIX_STRLEN];char*s;prefix2str(&p,buf,sizeof(buf));vn
c_zlog_debug_verbose("%s(rfd=%p,target=%s,ppNextHop=%p)",__func__,rfd,buf,ppNext
HopEntry);s=ecommunity_ecom2str(rfd->import_table->rt_import_list,ECOMMUNITY_FOR
MAT_ROUTE_MAP,0);vnc_zlog_debug_verbose("%srfd->import_table=%p,rfd->import_tabl
e->rt_import_list:%s",__func__,rfd->import_table,s);XFREE(MTYPE_ECOMMUNITY_STR,s
);}afi=family2afi(p.family);assert(afi);if(CHECK_FLAG(bgp->rfapi_cfg->flags,BGP_
VNC_CONFIG_FILTER_SELF_FROM_RSP)){self_vn_addr=&rfd->vn_addr;}if(use_eth_resolut
ion){uint32_tlogical_net_id=l2o->logical_net_id;structecommunity*l2com;/**fixupp
_originaltocontainL2address*/rfapiL2o2Qprefix(l2o,&p_original);l2com=bgp_rfapi_g
et_ecommunity_by_lni_label(bgp,1,logical_net_id,l2o->label);if(l2com){uint8_t*v=
l2com->val;logical_net_id=(v[5]<<16)+(v[6]<<8)+(v[7]);}/**Ethernet/L2-basedlooku
p**AlwaysreturnsITnodecorrespondingtoroute*/if(RFAPI_RFP_DOWNLOAD_FULL==bgp->rfa
pi_cfg->rfp_cfg.download_type){eth_is_0=1;}rn=rfapiMonitorEthAdd(bgp,rfd,(eth_is
_0?&rfapi_ethaddr0:&l2o->macaddr),logical_net_id);if(eth_is_0){structrfapi_ip_pr
efixrprefix;memset(&rprefix,0,sizeof(rprefix));rprefix.prefix.addr_family=target
->addr_family;if(target->addr_family==AF_INET){rprefix.length=32;}else{rprefix.l
ength=128;}pNHE=rfapiEthRouteTable2NextHopList(logical_net_id,&rprefix,rfd->resp
onse_lifetime,self_vn_addr,rfd->rib[afi],&p_original);gotodone;}}else{/**IP-base
dlookup*/rn=rfapiMonitorAdd(bgp,rfd,&p);/**Iftargetaddressis0,thisrequestisspeci
al:meansto*returnALLroutesinthetable**MonitorsforAll-Routesqueriesgetputonaspeci
allist,*notintheVPNtree*/if(RFAPI_0_PREFIX(&p)){vnc_zlog_debug_verbose("%s:0-pre
fix",__func__);/**Generatenexthoplistforcaller*/pNHE=rfapiRouteTable2NextHopList
(rfd->import_table->imported_vpn[afi],rfd->response_lifetime,self_vn_addr,rfd->r
ib[afi],&p_original);gotodone;}if(rn){route_lock_node(rn);/*sowecanunlockbelow*/
}else{/**returnslockednode.Don'tunlockyetbecausethe*unlock*mightfreeitbeforewe'r
edonewithit.This*situation*couldoccurwhenrfapiMonitorGetAttachNode()returns*a*ne
wly-createddefaultnode.*/rn=rfapiMonitorGetAttachNode(rfd,&p);}}assert(rn);if(!r
n->info){route_unlock_node(rn);vnc_zlog_debug_verbose("%s:VPNroutenotfound,retur
ningENOENT",__func__);returnENOENT;}if(VNC_DEBUG(RFAPI_QUERY)){rfapiShowImportTa
ble(NULL,"query",rfd->import_table->imported_vpn[afi],1);}if(use_eth_resolution)
{structrfapi_ip_prefixrprefix;memset(&rprefix,0,sizeof(rprefix));rprefix.prefix.
addr_family=target->addr_family;if(target->addr_family==AF_INET){rprefix.length=
32;}else{rprefix.length=128;}pNHE=rfapiEthRouteNode2NextHopList(rn,&rprefix,rfd-
>response_lifetime,self_vn_addr,rfd->rib[afi],&p_original);}else{/**Generateansw
ertoquery*/pNHE=rfapiRouteNode2NextHopList(rn,rfd->response_lifetime,self_vn_add
r,rfd->rib[afi],&p_original);}route_unlock_node(rn);done:if(ppNextHopEntry){/*on
lycountifcallergetsit*/++bgp->rfapi->response_immediate_count;}if(!pNHE){vnc_zlo
g_debug_verbose("%s:NONHEs,returningENOENT",__func__);returnENOENT;}/**countnext
hopsforstatistics*/for(i_nhe=pNHE;i_nhe;i_nhe=i_nhe->next){++rfd->stat_count_nh_
reachable;}if(ppNextHopEntry){*ppNextHopEntry=pNHE;}else{rfapi_free_next_hop_lis
t(pNHE);}vnc_zlog_debug_verbose("%s:success",__func__);return0;}/**supporton-the
-flyreassignmentofanalready-opennvetoanew*nve-groupintheeventthatitsoriginalnve-
groupis*administrativelydeleted.*/staticintrfapi_open_rfd(structrfapi_descriptor
*rfd,structbgp*bgp){structprefixpfx_vn;structprefixpfx_un;structrfapi_nve_group_
cfg*rfg;structrfapi*h;structrfapi_cfg*hc;intrc;h=bgp->rfapi;if(!h)returnENXIO;hc
=bgp->rfapi_cfg;if(!hc)returnENXIO;rc=rfapiRaddr2Qprefix(&rfd->vn_addr,&pfx_vn);
assert(!rc);rc=rfapiRaddr2Qprefix(&rfd->un_addr,&pfx_un);assert(!rc);/**Findthem
atchingnvegroupconfigblock*/rfg=bgp_rfapi_cfg_match_group(hc,&pfx_vn,&pfx_un);if
(!rfg){returnENOENT;}/**checknvegroupconfigblockforrequiredvalues*/if(!rfg->rt_e
xport_list||!rfg->rfapi_import_table){returnENOMSG;}rc=rfapi_open_inner(rfd,bgp,
h,rfg);if(rc){returnrc;}/**re-advertiseregisteredroutes,thistimeaspartofnewNVE-g
roup*/rfapiApReadvertiseAll(bgp,rfd);/**re-attachcallbackstoimporttable*/if(!(bg
p->rfapi_cfg->flags&BGP_VNC_CONFIG_CALLBACK_DISABLE)){rfapiMonitorAttachImportHd
(rfd);}return0;}/*------------------------------------------*rfapi_open**Thisfun
ctioninitializesaNVErecordandassociatesitwith*thespecifiedVNandunderlaynetworkad
dresses**input:*rfp_start_valvaluereturnedbyrfp_start*vnNVEvirtualnetworkaddress
**unNVEunderlaynetworkaddress**default_optionsDefaultoptionstouseonregistrations
.*Fornowonlytunneltypeissupported.*Maybeoverriddenper-prefixinrfapi_register().*
Callerowns(rfapi_open()doesnotfree)**response_cbPointertonexthoplistupdatecallba
ckfunctionor*NULLwhennocallbacksaredesired.**userdataPassedtosubsequentresponse_
cbinvocations.**output:*response_lifetimeThelengthoftimethatresponsessenttothis*
NVEarevalid.**pHandlepointertolocationtostorerfapihandle.The*handlemustbepassedo
nsubsequentrfapi_calls.***returnvalue:*0Success*EEXISTNVEwiththis{vn,un}alreadyo
pen*ENOENTNomatchingnvegroupconfig*ENOMSGMatchednvegroupconfigwasincomplete*ENXI
OBGPorVNCnotconfigured*EAFNOSUPPORTMatchednvegroupspecifiesauto-assignmentofRD,*
butunderlaynetworkaddressisnotIPv4*EDEADLKCalledfromwithinacallbackprocedure*---
---------------------------------------*/intrfapi_open(void*rfp_start_val,struct
rfapi_ip_addr*vn,structrfapi_ip_addr*un,structrfapi_un_option*default_options,ui
nt32_t*response_lifetime,void*userdata,/*callbackcookie*/rfapi_handle*pHandle){s
tructbgp*bgp;structrfapi*h;structrfapi_descriptor*rfd;structrfapi_cfg*hc;structr
fapi_nve_group_cfg*rfg;structprefixpfx_vn;structprefixpfx_un;intrc;rfapi_handleh
h=NULL;intreusing_provisional=0;{charbuf[2][INET_ADDRSTRLEN];vnc_zlog_debug_verb
ose("%s:VN=%sUN=%s",__func__,rfapiRfapiIpAddr2Str(vn,buf[0],INET_ADDRSTRLEN),rfa
piRfapiIpAddr2Str(un,buf[1],INET_ADDRSTRLEN));}assert(pHandle);*pHandle=NULL;bgp
=rfapi_bgp_lookup_by_rfp(rfp_start_val);if(!bgp)returnENXIO;h=bgp->rfapi;if(!h)r
eturnENXIO;hc=bgp->rfapi_cfg;if(!hc)returnENXIO;if(h->flags&RFAPI_INCALLBACK)ret
urnEDEADLK;rc=rfapiRaddr2Qprefix(vn,&pfx_vn);assert(!rc);rc=rfapiRaddr2Qprefix(u
n,&pfx_un);assert(!rc);/**alreadyhaveadescriptorwithVNandUN?*/if(!rfapi_find_han
dle(bgp,vn,un,&hh)){/**wemighthavesetupahandleforstaticroutesbefore*thisNVEwasop
ened.Inthatcase,reusethehandle*/rfd=hh;if(!CHECK_FLAG(rfd->flags,RFAPI_HD_FLAG_P
ROVISIONAL)){returnEEXIST;}/**reuseprovisionaldescriptor*hhisnotNULL*/reusing_pr
ovisional=1;}/**Findthematchingnvegroupconfigblock*/rfg=bgp_rfapi_cfg_match_grou
p(hc,&pfx_vn,&pfx_un);if(!rfg){++h->stat.count_unknown_nves;{charbuf[2][INET_ADD
RSTRLEN];zlog_notice("%s:nomatchinggroupVN=%sUN=%s",__func__,rfapiRfapiIpAddr2St
r(vn,buf[0],INET_ADDRSTRLEN),rfapiRfapiIpAddr2Str(un,buf[1],INET_ADDRSTRLEN));}r
eturnENOENT;}/**checknvegroupconfigblockforrequiredvalues*/if(!rfg->rt_export_li
st||!rfg->rfapi_import_table){++h->stat.count_unknown_nves;returnENOMSG;}/**Ifgr
oupconfigspecifiesauto-rdassignment,checkthat*VNaddressisIPv4|v6sowedon'tfailinr
fapi_open_inner().*Checkheresowedon'tneedtounwindmemoryallocations,&c.*/if((rfg-
>rd.family==AF_UNIX)&&(vn->addr_family!=AF_INET)&&(vn->addr_family!=AF_INET6)){r
eturnEAFNOSUPPORT;}if(hh){/**reusingprovisionalrfd*/rfd=hh;}else{rfd=XCALLOC(MTY
PE_RFAPI_DESC,sizeof(structrfapi_descriptor));}assert(rfd);rfd->bgp=bgp;if(defau
lt_options){structrfapi_un_option*p;for(p=default_options;p;p=p->next){if((RFAPI
_UN_OPTION_TYPE_PROVISIONAL==p->type)){rfd->flags|=RFAPI_HD_FLAG_PROVISIONAL;}if
((RFAPI_UN_OPTION_TYPE_TUNNELTYPE==p->type)){rfd->default_tunneltype_option=p->v
.tunnel;}}}/**Fillincallerfields*/rfd->vn_addr=*vn;rfd->un_addr=*un;rfd->cookie=
userdata;if(!reusing_provisional){rc=rfapi_init_and_open(bgp,rfd,rfg);/**Thiscan
failonlyiftheVNaddressisIPv6andthegroup*specifiedauto-assignmentofRDs,whichonlyw
orksforv4,*andthecheckaboveshouldcatchit.**Anotherfailurepossibilityisthatwewere
called*duringanrfapicallback.Alsocheckedabove.*/assert(!rc);}if(response_lifetim
e)*response_lifetime=rfd->response_lifetime;*pHandle=rfd;return0;}/**Forusewithd
ebugfunctions*/staticintrfapi_set_response_cb(structrfapi_descriptor*rfd,rfapi_r
esponse_cb_t*response_cb){if(!is_valid_rfd(rfd))returnEBADF;rfd->response_cb=res
ponse_cb;return0;}/**rfapi_close_inner**Doesalmostalltheworkofrfapi_close,except
:*1.preservesthedescriptor(doesn'tfreeit)*2.preservestheprefixquerylist(i.e.,rfd
->monlist)*3.preservestheadvertisedprefixlist(rfd->advertised)*4.preservestherib
andrib_pendingtables**Thepurposeoforganizingitthiswayistosupporton-the-fly*reass
ignmentofanalready-opennvetoanewnve-groupinthe*eventthatitsoriginalnve-groupisad
ministrativelydeleted.*/staticintrfapi_close_inner(structrfapi_descriptor*rfd,st
ructbgp*bgp){intrc;structprefixpfx_vn;structprefix_rdprd;/*currentlyalways0forVN
->UN*/if(!is_valid_rfd(rfd))returnEBADF;rc=rfapiRaddr2Qprefix(&rfd->vn_addr,&pfx
_vn);assert(!rc);/*shouldneverhavebadAFinstoredvnaddress*//**updateexportedroute
storeflectdisappearanceofthisNVEas*nexthop*/vnc_direct_bgp_del_nve(bgp,rfd);vnc_
zebra_del_nve(bgp,rfd);/**unlinkthisHD'smonitorsfromimporttable*/rfapiMonitorDet
achImportHd(rfd);/**UnlinkfromImportTable*NBrfd->import_tablewillbeNULLifwearecl
osingastale*descriptor*/if(rfd->import_table)rfapiImportTableRefDelByIt(bgp,rfd-
>import_table);rfd->import_table=NULL;/**Constructroutedistinguisher*/memset(&pr
d,0,sizeof(prd));prd=rfd->rd;prd.family=AF_UNSPEC;prd.prefixlen=64;/**withdrawtu
nnel*/del_vnc_route(rfd,rfd->peer,bgp,SAFI_ENCAP,&pfx_vn,/*prefixbeingadvertised
*/&prd,/*routedistinguishertouse(0forENCAP)*/ZEBRA_ROUTE_BGP,BGP_ROUTE_RFP,NULL,
0);/*nokill*//**ConstructroutedistinguisherforVPNroutes*/prd=rfd->rd;prd.family=
AF_UNSPEC;prd.prefixlen=64;/**findallVPNroutesassociatedwiththisrfdanddeletethem
,too*/rfapiApWithdrawAll(bgp,rfd);/**removethisnvedescriptorfromthelistofnves*as
sociatedwiththenvegroup*/if(rfd->rfg){listnode_delete(rfd->rfg->nves,rfd);rfd->r
fg=NULL;/*XXXmarkasorphaned/stale*/}if(rfd->rt_export_list)ecommunity_free(&rfd-
>rt_export_list);rfd->rt_export_list=NULL;/**freepeerstructure(possiblydelayedun
tilits*refcountreacheszero)*/if(rfd->peer){vnc_zlog_debug_verbose("%s:callingpee
r_delete(%p),#%d",__func__,rfd->peer,rfd->peer->lock);peer_delete(rfd->peer);}rf
d->peer=NULL;return0;}intrfapi_close(void*handle){structrfapi_descriptor*rfd=(st
ructrfapi_descriptor*)handle;intrc;structroute_node*node;structbgp*bgp;structrfa
pi*h;vnc_zlog_debug_verbose("%s:rfd=%p",__func__,rfd);#ifRFAPI_WHO_IS_CALLING_ME
#ifdefHAVE_GLIBC_BACKTRACE#defineRFAPI_DEBUG_BACKTRACE_NENTRIES5{void*buf[RFAPI_
DEBUG_BACKTRACE_NENTRIES];char**syms;inti;size_tsize;size=backtrace(buf,RFAPI_DE
BUG_BACKTRACE_NENTRIES);syms=backtrace_symbols(buf,size);for(i=0;i<size&&i<RFAPI
_DEBUG_BACKTRACE_NENTRIES;++i){vnc_zlog_debug_verbose("backtrace[%2d]:%s",i,syms
[i]);}free(syms);}#endif#endifbgp=rfd->bgp;if(!bgp)returnENXIO;h=bgp->rfapi;if(!
h)returnENXIO;if(!is_valid_rfd(rfd))returnEBADF;if(h->flags&RFAPI_INCALLBACK){/*
*Queuethesecloserequestsforprocessingaftercallback*isfinished*/if(!CHECK_FLAG(rf
d->flags,RFAPI_HD_FLAG_CLOSING_ADMINISTRATIVELY)){work_queue_add(h->deferred_clo
se_q,handle);vnc_zlog_debug_verbose("%s:addedhandle%ptodeferredclosequeue",__fun
c__,handle);}return0;}if(CHECK_FLAG(rfd->flags,RFAPI_HD_FLAG_CLOSING_ADMINISTRAT
IVELY)){vnc_zlog_debug_verbose("%sadministrativecloserfd=%p",__func__,rfd);if(h&
&h->rfp_methods.close_cb){vnc_zlog_debug_verbose("%scallingclosecallbackrfd=%p",
__func__,rfd);/**callthecallbackfairlyearlysothatitcanstill*lookupun/vn*fromhand
le,etc.**NBRFAPI_INCALLBACKistestedabove,soifwereach*thispoint*wearenotalreadyin
thecontextofacallback.*/h->flags|=RFAPI_INCALLBACK;(*h->rfp_methods.close_cb)(ha
ndle,EIDRM);h->flags&=~RFAPI_INCALLBACK;}}if(rfd->rfg){/**Orphaneddescriptorshav
ealreadydonethispart,sodo*onlyfornon-orphaneddescriptors.*/if((rc=rfapi_close_in
ner(rfd,bgp)))returnrc;}/**RemovedescriptorfromUNindex*(removefromchainatnode)*/
rc=rfapi_find_node(bgp,&rfd->vn_addr,&rfd->un_addr,&node);if(!rc){structrfapi_de
scriptor*hh;if(node->info==rfd){node->info=rfd->next;}else{for(hh=node->info;hh;
hh=hh->next){if(hh->next==rfd){hh->next=rfd->next;break;}}}route_unlock_node(nod
e);}/**removefromdescriptorlist*/listnode_delete(&h->descriptors,rfd);/**Deletem
onitorlistitemsandfreemonitorstructures*/(void)rfapiMonitorDelHd(rfd);/**release
advertisedprefixdata*/rfapiApRelease(&rfd->advertised);/**ReleaseRFPcallbackRIB*
/rfapiRibFree(rfd);/**freedescriptor*/memset(rfd,0,sizeof(structrfapi_descriptor
));XFREE(MTYPE_RFAPI_DESC,rfd);return0;}/**Reopenanvedescriptor.Ifthedescriptor'
sNVE-group*doesnotexist(e.g.,ifithasbeenadministrativelyremoved),*reassignmentto
anewNVE-groupisattempted.**IfNVE-groupreassignmentfails,thedescriptorbecomes"sta
le"*(rfd->rfg==NULLimplies"stale:).TheonlypermissibleAPIoperation*onastaledescri
ptorisrfapi_close().Anyotherrfapi_*APIoperation*onthedescriptorwillreturnESTALE.
**Reopeningadescriptorisapotentiallyexpensiveoperation,because*itinvolveswithdra
winganyroutesadvertisedbytheNVE,withdrawing*theNVE'sroutequeries,andthenre-addin
gthemallafteranew*NVE-groupisassigned.Therearealsopossibleroute-exportaffects*ca
usedbydeletingandthenaddingtheNVE:advertisedprefixes*andnexthoplistsforexportedr
outescanturnover.*/intrfapi_reopen(structrfapi_descriptor*rfd,structbgp*bgp){str
uctrfapi*h;intrc;if((rc=rfapi_close_inner(rfd,bgp))){returnrc;}if((rc=rfapi_open
_rfd(rfd,bgp))){h=bgp->rfapi;assert(!CHECK_FLAG(h->flags,RFAPI_INCALLBACK));if(C
HECK_FLAG(rfd->flags,RFAPI_HD_FLAG_CLOSING_ADMINISTRATIVELY)&&h&&h->rfp_methods.
close_cb){/**NBRFAPI_INCALLBACKistestedabove,soifwereach*thispoint*wearenotalrea
dyinthecontextofacallback.*/h->flags|=RFAPI_INCALLBACK;(*h->rfp_methods.close_cb
)((rfapi_handle)rfd,ESTALE);h->flags&=~RFAPI_INCALLBACK;}returnrc;}return0;}/***
*********************************************************************NVERoutes**
*********************************************************************//**Announc
ereachabilitytothisprefixviatheNVE*/intrfapi_register(void*handle,structrfapi_ip
_prefix*prefix,uint32_tlifetime,/*hostbyteorder*/structrfapi_un_option*options_u
n,structrfapi_vn_option*options_vn,rfapi_register_actionaction){structrfapi_desc
riptor*rfd=(structrfapi_descriptor*)handle;structbgp*bgp;structprefixp;structpre
fix*pfx_ip=NULL;structprefix_rdprd;afi_tafi;structprefixpfx_mac_buf;structprefix
*pfx_mac=NULL;structprefixpfx_vn_buf;constchar*action_str=NULL;uint32_t*label=NU
LL;structrfapi_vn_option*vo;structrfapi_l2address_option*l2o=NULL;structprefix_r
d*prd_override=NULL;switch(action){caseRFAPI_REGISTER_ADD:action_str="add";break
;caseRFAPI_REGISTER_WITHDRAW:action_str="withdraw";break;caseRFAPI_REGISTER_KILL
:action_str="kill";break;default:assert(0);break;}/**InspectVNoptions*/for(vo=op
tions_vn;vo;vo=vo->next){if(RFAPI_VN_OPTION_TYPE_L2ADDR==vo->type){l2o=&vo->v.l2
addr;}if(RFAPI_VN_OPTION_TYPE_INTERNAL_RD==vo->type){prd_override=&vo->v.interna
l_rd;}}/**********************************************************************ad
vertiseprefix*******************************************************************
**//**set<p>basedon<prefix>*/assert(!rfapiRprefix2Qprefix(prefix,&p));afi=family
2afi(prefix->prefix.addr_family);assert(afi);{charbuf[PREFIX_STRLEN];prefix2str(
&p,buf,sizeof(buf));vnc_zlog_debug_verbose("%s(rfd=%p,pfx=%s,lifetime=%d,opts_un
=%p,opts_vn=%p,action=%s)",__func__,rfd,buf,lifetime,options_un,options_vn,actio
n_str);}/**Thesetestscomeaftertheprefixconversionsothatwecan*printtheprefixinade
bugmessagebeforefailing*/bgp=rfd->bgp;if(!bgp){vnc_zlog_debug_verbose("%s:noBGPi
nstance:returningENXIO",__func__);returnENXIO;}if(!bgp->rfapi){vnc_zlog_debug_ve
rbose("%s:noRFAPIinstance:returningENXIO",__func__);returnENXIO;}if(!rfd->rfg){i
f(RFAPI_REGISTER_ADD==action){++bgp->rfapi->stat.count_registrations_failed;}vnc
_zlog_debug_verbose("%s:rfd=%p,noRFGRPinstance:returningESTALE",__func__,rfd);re
turnESTALE;}if(bgp->rfapi->flags&RFAPI_INCALLBACK){if(RFAPI_REGISTER_ADD==action
){++bgp->rfapi->stat.count_registrations_failed;}vnc_zlog_debug_verbose("%s:inca
llback:returningEDEADLK",__func__);returnEDEADLK;}if(!is_valid_rfd(rfd)){if(RFAP
I_REGISTER_ADD==action){++bgp->rfapi->stat.count_registrations_failed;}vnc_zlog_
debug_verbose("%s:invalidhandle:returningEBADF",__func__);returnEBADF;}/**Isther
eaMACaddressinthisregistration?*/if(l2o&&!RFAPI_0_ETHERADDR(&l2o->macaddr)){rfap
iL2o2Qprefix(l2o,&pfx_mac_buf);pfx_mac=&pfx_mac_buf;}/**IsthereanIPprefixinthisr
egistration?*/if(!(RFAPI_0_PREFIX(&p)&&RFAPI_HOST_PREFIX(&p))){pfx_ip=&p;}else{i
f(!pfx_mac){vnc_zlog_debug_verbose("%s:missingmacaddrthatisrequiredforhost0pfx",
__func__);if(RFAPI_REGISTER_ADD==action){++bgp->rfapi->stat.count_registrations_
failed;}returnEINVAL;}if(rfapiRaddr2Qprefix(&rfd->vn_addr,&pfx_vn_buf)){vnc_zlog
_debug_verbose("%s:handlehasbadvn_addr:returningEBADF",__func__);if(RFAPI_REGIST
ER_ADD==action){++bgp->rfapi->stat.count_registrations_failed;}returnEBADF;}}if(
RFAPI_REGISTER_ADD==action){++bgp->rfapi->stat.count_registrations;}/**Figureout
ifthisregistrationismissinganIPaddress**MAC-addrbased:**InRFAPI,weuseprefixesinf
amilyAF_LINKtostore*theMACaddresses.Theseprefixesareusedforthe*listofadvertisedp
refixesandintheRFAPIimport*tables.**InBGPproper,weusetheprefixmatchingtheNVE's*V
Naddresswithahostprefix-length(i.e.,32or128).**/if(l2o&&l2o->logical_net_id&&RFA
PI_0_PREFIX(&p)&&RFAPI_HOST_PREFIX(&p)){rfapiL2o2Qprefix(l2o,&pfx_mac_buf);pfx_m
ac=&pfx_mac_buf;}/**Constructroutedistinguisher*/if(prd_override){prd=*prd_overr
ide;}else{memset(&prd,0,sizeof(prd));if(pfx_mac){prd.family=AF_UNSPEC;prd.prefix
len=64;encode_rd_type(RD_TYPE_VNC_ETH,prd.val);if(l2o->local_nve_id||!(rfd->rfg-
>flags&RFAPI_RFG_L2RD)){/**IfLocalNVEIDisspecifiedinmessage,use*it.*(ifnolocalde
faultconfigured,alsouseit*evenif0)*/prd.val[1]=l2o->local_nve_id;}else{if(rfd->r
fg->l2rd){/**locally-configuredliteralvalue*/prd.val[1]=rfd->rfg->l2rd;}else{/**
0meansauto:vn,whichmeansuseLSB*ofVNaddr*/if(rfd->vn_addr.addr_family==AF_INET){p
rd.val[1]=*(((char*)&rfd->vn_addr.addr.v4.s_addr)+3);}else{prd.val[1]=*(((char*)
&rfd->vn_addr.addr.v6.s6_addr)+15);}}}memcpy(prd.val+2,pfx_mac->u.prefix_eth.oct
et,6);}else{prd=rfd->rd;prd.family=AF_UNSPEC;prd.prefixlen=64;}}if(action==RFAPI
_REGISTER_WITHDRAW||action==RFAPI_REGISTER_KILL){intadv_tunnel=0;/**withdrawprev
iousadvertisement*/del_vnc_route(rfd,rfd->peer,bgp,SAFI_MPLS_VPN,pfx_ip?pfx_ip:&
pfx_vn_buf,/*prefixbeingadvertised*/&prd,/*routedistinguisher(0forENCAP)*/ZEBRA_
ROUTE_BGP,BGP_ROUTE_RFP,NULL,action==RFAPI_REGISTER_KILL);if(0==rfapiApDelete(bg
p,rfd,&p,pfx_mac,&prd,&adv_tunnel)){if(adv_tunnel)rfapiTunnelRouteAnnounce(bgp,r
fd,&rfd->max_prefix_lifetime);}}else{intadv_tunnel=0;uint32_tlocal_pref;structec
ommunity*rtlist=NULL;structecommunity_valecom_value;if(!rfapiApCount(rfd)){/**ma
kesureweadvertisetunnelrouteuponaddingthe*firstVPNroute*/adv_tunnel=1;}if(rfapiA
pAdd(bgp,rfd,&p,pfx_mac,&prd,lifetime,prefix->cost,l2o)){adv_tunnel=1;}vnc_zlog_
debug_verbose("%s:adv_tunnel=%d",__func__,adv_tunnel);if(adv_tunnel){vnc_zlog_de
bug_verbose("%s:announcingtunnelroute",__func__);rfapiTunnelRouteAnnounce(bgp,rf
d,&rfd->max_prefix_lifetime);}vnc_zlog_debug_verbose("%s:callingadd_vnc_route",_
_func__);local_pref=rfp_cost_to_localpref(prefix->cost);if(l2o&&l2o->label)label
=&l2o->label;if(pfx_mac){structecommunity*l2com=NULL;if(label){l2com=bgp_rfapi_g
et_ecommunity_by_lni_label(bgp,1,l2o->logical_net_id,*label);}if(l2com){rtlist=e
community_dup(l2com);}else{/**Ifmacaddressisset,addanRTbasedonthe*registeredLNI*
/memset((char*)&ecom_value,0,sizeof(ecom_value));ecom_value.val[1]=ECOMMUNITY_RO
UTE_TARGET;ecom_value.val[5]=(l2o->logical_net_id>>16)&0xff;ecom_value.val[6]=(l
2o->logical_net_id>>8)&0xff;ecom_value.val[7]=(l2o->logical_net_id>>0)&0xff;rtli
st=ecommunity_new();ecommunity_add_val(rtlist,&ecom_value);}if(l2o->tag_id){as_t
as=bgp->as;uint16_tval=l2o->tag_id;memset((char*)&ecom_value,0,sizeof(ecom_value
));ecom_value.val[1]=ECOMMUNITY_ROUTE_TARGET;if(as>BGP_AS_MAX){ecom_value.val[0]
=ECOMMUNITY_ENCODE_AS4;ecom_value.val[2]=(as>>24)&0xff;ecom_value.val[3]=(as>>16
)&0xff;ecom_value.val[4]=(as>>8)&0xff;ecom_value.val[5]=as&0xff;}else{ecom_value
.val[0]=ECOMMUNITY_ENCODE_AS;ecom_value.val[2]=(as>>8)&0xff;ecom_value.val[3]=as
&0xff;}ecom_value.val[6]=(val>>8)&0xff;ecom_value.val[7]=val&0xff;if(rtlist==NUL
L)rtlist=ecommunity_new();ecommunity_add_val(rtlist,&ecom_value);}}/**advertisep
refixviatunnelendpoint*/add_vnc_route(rfd,/*rfapidescr,forexportlist&backref*/bg
p,/*whichbgpinstance*/SAFI_MPLS_VPN,/*whichSAFI*/(pfx_ip?pfx_ip:&pfx_vn_buf),/*p
refixbeingadvertised*/&prd,/*routedistinguishertouse(0forENCAP)*/&rfd->vn_addr,/
*nexthop*/&local_pref,&lifetime,/*prefixlifetime->TunnelEncapattr*/NULL,options_
un,/*rfapiunoptions*/options_vn,/*rfapivnoptions*/(rtlist?rtlist:rfd->rt_export_
list),NULL,/*med*/label,/*label:default*/ZEBRA_ROUTE_BGP,BGP_ROUTE_RFP,0);if(rtl
ist)ecommunity_free(&rtlist);/*setsrtlist=NULL*/}vnc_zlog_debug_verbose("%s:succ
ess",__func__);return0;}intrfapi_query(void*handle,structrfapi_ip_addr*target,st
ructrfapi_l2address_option*l2o,/*maybeNULL*/structrfapi_next_hop_entry**ppNextHo
pEntry){structrfapi_descriptor*rfd=(structrfapi_descriptor*)handle;structbgp*bgp
=rfd->bgp;intrc;assert(ppNextHopEntry);*ppNextHopEntry=NULL;if(bgp&&bgp->rfapi){
bgp->rfapi->stat.count_queries++;}if(!rfd->rfg){if(bgp&&bgp->rfapi)++bgp->rfapi-
>stat.count_queries_failed;returnESTALE;}if((rc=rfapi_query_inner(handle,target,
l2o,ppNextHopEntry))){if(bgp&&bgp->rfapi)++bgp->rfapi->stat.count_queries_failed
;}returnrc;}intrfapi_query_done(rfapi_handlehandle,structrfapi_ip_addr*target){s
tructprefixp;intrc;structrfapi_descriptor*rfd=(structrfapi_descriptor*)handle;st
ructbgp*bgp=rfd->bgp;if(!rfd->rfg)returnESTALE;assert(target);rc=rfapiRaddr2Qpre
fix(target,&p);assert(!rc);if(!is_valid_rfd(rfd))returnEBADF;/*preemptive*/if(!b
gp||!bgp->rfapi)returnENXIO;if(bgp->rfapi->flags&RFAPI_INCALLBACK)returnEDEADLK;
rfapiMonitorDel(bgp,rfd,&p);return0;}intrfapi_query_done_all(rfapi_handlehandle,
int*count){structrfapi_descriptor*rfd=(structrfapi_descriptor*)handle;structbgp*
bgp=rfd->bgp;;intnum;if(!rfd->rfg)returnESTALE;if(!is_valid_rfd(rfd))returnEBADF
;/*preemptive*/if(!bgp||!bgp->rfapi)returnENXIO;if(bgp->rfapi->flags&RFAPI_INCAL
LBACK)returnEDEADLK;num=rfapiMonitorDelHd(rfd);if(count)*count=num;return0;}void
rfapi_free_next_hop_list(structrfapi_next_hop_entry*list){structrfapi_next_hop_e
ntry*nh;structrfapi_next_hop_entry*next;for(nh=list;nh;nh=next){next=nh->next;rf
api_un_options_free(nh->un_options);nh->un_options=NULL;rfapi_vn_options_free(nh
->vn_options);nh->vn_options=NULL;XFREE(MTYPE_RFAPI_NEXTHOP,nh);}}/**NULLhandle=
>returntotalcountacrossallnves*/uint32_trfapi_monitor_count(void*handle){structb
gp*bgp=bgp_get_default();uint32_tcount;if(handle){structrfapi_descriptor*rfd=(st
ructrfapi_descriptor*)handle;count=rfd->monitor_count;}else{if(!bgp||!bgp->rfapi
)return0;count=bgp->rfapi->monitor_count;}returncount;}/************************
************************************************CLI/CONFIG**********************
*************************************************/DEFUN(debug_rfapi_show_nves,de
bug_rfapi_show_nves_cmd,"debugrfapi-devshownves",DEBUG_STRDEBUG_RFAPI_STRSHOW_ST
R"NVEInformation\n"){rfapiPrintMatchingDescriptors(vty,NULL,NULL);returnCMD_SUCC
ESS;}DEFUN(debug_rfapi_show_nves_vn_un,debug_rfapi_show_nves_vn_un_cmd,"debugrfa
pi-devshownves<vn|un><A.B.C.D|X:X::X:X>",/*prefixalsook*/DEBUG_STRDEBUG_RFAPI_ST
RSHOW_STR"NVEInformation\n""Specifyvirtualnetwork\n""Specifyunderlaynetworkinter
face\n""IPv4address\n""IPv6address\n"){structprefixpfx;if(!str2prefix(argv[5]->a
rg,&pfx)){vty_out(vty,"Malformedaddress\"%s\"\n",argv[5]->arg);returnCMD_WARNING
_CONFIG_FAILED;}if(pfx.family!=AF_INET&&pfx.family!=AF_INET6){vty_out(vty,"Inval
idaddress\"%s\"\n",argv[5]->arg);returnCMD_WARNING_CONFIG_FAILED;}if(argv[4]->ar
g[0]=='u'){rfapiPrintMatchingDescriptors(vty,NULL,&pfx);}else{rfapiPrintMatching
Descriptors(vty,&pfx,NULL);}returnCMD_SUCCESS;}/**Note:thisfunctiondoesnotflushv
tyoutput,soifitiscalled*withastreampointingtoavty,theuserwillhavetotypesomething
*beforethecallbackoutputshowsup*/staticvoidtest_nexthops_callback(//structrfapi_
ip_addr*target,structrfapi_next_hop_entry*next_hops,void*userdata){void*stream=u
serdata;int(*fp)(void*,constchar*,...);structvty*vty;void*out;constchar*vty_newl
ine;if(rfapiStream2Vty(stream,&fp,&vty,&out,&vty_newline)==0)return;fp(out,"Next
hopsCallback,Target=(");//rfapiPrintRfapiIpAddr(stream,target);fp(out,")\n");rfa
piPrintNhl(stream,next_hops);rfapi_free_next_hop_list(next_hops);}DEFUN(debug_rf
api_open,debug_rfapi_open_cmd,"debugrfapi-devopenvn<A.B.C.D|X:X::X:X>un<A.B.C.D|
X:X::X:X>",DEBUG_STRDEBUG_RFAPI_STR"rfapi_open\n""indicatevnaddrfollows\n""virtu
alnetworkinterfaceIPv4address\n""virtualnetworkinterfaceIPv6address\n""indicatex
taddrfollows\n""underlaynetworkinterfaceIPv4address\n""underlaynetworkinterfaceI
Pv6address\n"){structrfapi_ip_addrvn;structrfapi_ip_addrun;uint32_tlifetime;intr
c;rfapi_handlehandle;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[4]->ar
g,&vn)))returnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[6]->arg,&u
n)))returnrc;rc=rfapi_open(rfapi_get_rfp_start_val_by_bgp(bgp_get_default()),&vn
,&un,/*&uo*/NULL,&lifetime,NULL,&handle);vty_out(vty,"rfapi_open:status%d,handle
%p,lifetime%d\n",rc,handle,lifetime);rc=rfapi_set_response_cb(handle,test_nextho
ps_callback);vty_out(vty,"rfapi_set_response_cb:status%d\n",rc);returnCMD_SUCCES
S;}DEFUN(debug_rfapi_close_vn_un,debug_rfapi_close_vn_un_cmd,"debugrfapi-devclos
evn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:X>",DEBUG_STRDEBUG_RFAPI_STR"rfapi_close\
n""indicatevnaddrfollows\n""virtualnetworkinterfaceIPv4address\n""virtualnetwork
interfaceIPv6address\n""indicatextaddrfollows\n""underlaynetworkinterfaceIPv4add
ress\n""underlaynetworkinterfaceIPv6address\n"){structrfapi_ip_addrvn;structrfap
i_ip_addrun;rfapi_handlehandle;intrc;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr
(vty,argv[4]->arg,&vn)))returnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty
,argv[6]->arg,&un)))returnrc;if(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_
out(vty,"can'tlocatehandlematchingvn=%s,un=%s\n",argv[4]->arg,argv[6]->arg);retu
rnCMD_WARNING_CONFIG_FAILED;}rc=rfapi_close(handle);vty_out(vty,"rfapi_close(han
dle=%p):status%d\n",handle,rc);returnCMD_SUCCESS;}DEFUN(debug_rfapi_close_rfd,de
bug_rfapi_close_rfd_cmd,"debugrfapi-devcloserfdHANDLE",DEBUG_STRDEBUG_RFAPI_STR"
rfapi_close\n""indicatehandlefollows\n""rfapihandleinhexadecimal\n"){rfapi_handl
ehandle;intrc;char*endptr=NULL;handle=(rfapi_handle)(uintptr_t)(strtoull(argv[4]
->arg,&endptr,16));if(*endptr!='\0'||(uintptr_t)handle==UINTPTR_MAX){vty_out(vty
,"Invalidvalue:%s\n",argv[4]->arg);returnCMD_WARNING_CONFIG_FAILED;}rc=rfapi_clo
se(handle);vty_out(vty,"rfapi_close(handle=%p):status%d\n",handle,rc);returnCMD_
SUCCESS;}DEFUN(debug_rfapi_register_vn_un,debug_rfapi_register_vn_un_cmd,"debugr
fapi-devregistervn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:X>prefix<A.B.C.D/M|X:X::X:
X/M>lifetimeSECONDS",DEBUG_STRDEBUG_RFAPI_STR"rfapi_register\n""indicatevnaddrfo
llows\n""virtualnetworkIPv4interfaceaddress\n""virtualnetworkIPv6interfaceaddres
s\n""indicateunaddrfollows\n""underlaynetworkIPv4interfaceaddress\n""underlaynet
workIPv6interfaceaddress\n""indicateprefixfollows\n""IPv4prefix\n""IPv6prefix\n"
"indicatelifetimefollows\n""lifetime\n"){structrfapi_ip_addrvn;structrfapi_ip_ad
drun;rfapi_handlehandle;structprefixpfx;uint32_tlifetime;structrfapi_ip_prefixhp
fx;intrc;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[4]->arg,&vn)))retu
rnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[6]->arg,&un)))returnrc
;if(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_out(vty,"can'tlocatehandlema
tchingvn=%s,un=%s\n",argv[4]->arg,argv[6]->arg);returnCMD_WARNING_CONFIG_FAILED;
}/**Getprefixtoadvertise*/if(!str2prefix(argv[8]->arg,&pfx)){vty_out(vty,"Malfor
medprefix\"%s\"\n",argv[8]->arg);returnCMD_WARNING_CONFIG_FAILED;}if(pfx.family!
=AF_INET&&pfx.family!=AF_INET6){vty_out(vty,"Badfamilyforprefix\"%s\"\n",argv[8]
->arg);returnCMD_WARNING_CONFIG_FAILED;}rfapiQprefix2Rprefix(&pfx,&hpfx);if(strm
atch(argv[10]->text,"infinite")){lifetime=RFAPI_INFINITE_LIFETIME;}else{lifetime
=strtoul(argv[10]->arg,NULL,10);}rc=rfapi_register(handle,&hpfx,lifetime,NULL,NU
LL,0);if(rc){vty_out(vty,"rfapi_registerfailedwithrc=%d(%s)\n",rc,strerror(rc));
}returnCMD_SUCCESS;}DEFUN(debug_rfapi_register_vn_un_l2o,debug_rfapi_register_vn
_un_l2o_cmd,"debugrfapi-devregistervn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:X>prefi
x<A.B.C.D/M|X:X::X:X/M>lifetimeSECONDSmacaddrYY:YY:YY:YY:YY:YYlni(0-16777215)",D
EBUG_STRDEBUG_RFAPI_STR"rfapi_register\n""indicatevnaddrfollows\n""virtualnetwor
kIPv4interfaceaddress\n""virtualnetworkIPv6interfaceaddress\n""indicateunaddrfol
lows\n""underlaynetworkIPv4interfaceaddress\n""underlaynetworkIPv6interfaceaddre
ss\n""indicateprefixfollows\n""IPv4prefix\n""IPv6prefix\n""indicatelifetimefollo
ws\n""Secondsoflifetime\n""indicateMACaddressfollows\n""MACaddress\n""indicateln
ifollows\n""lnivaluerange\n"){structrfapi_ip_addrvn;structrfapi_ip_addrun;rfapi_
handlehandle;structprefixpfx;uint32_tlifetime;structrfapi_ip_prefixhpfx;intrc;st
ructrfapi_vn_optionoptary[10];/*XXXmustbebigenough*/structrfapi_vn_option*opt=NU
LL;intopt_next=0;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[4]->arg,&v
n)))returnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[6]->arg,&un)))
returnrc;if(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_out(vty,"can'tlocate
handlematchingvn=%s,un=%s\n",argv[4]->arg,argv[6]->arg);returnCMD_WARNING_CONFIG
_FAILED;}/**Getprefixtoadvertise*/if(!str2prefix(argv[8]->arg,&pfx)){vty_out(vty
,"Malformedprefix\"%s\"\n",argv[8]->arg);returnCMD_WARNING_CONFIG_FAILED;}if(pfx
.family!=AF_INET&&pfx.family!=AF_INET6){vty_out(vty,"Badfamilyforprefix\"%s\"\n"
,argv[8]->arg);returnCMD_WARNING_CONFIG_FAILED;}rfapiQprefix2Rprefix(&pfx,&hpfx)
;if(strmatch(argv[10]->text,"infinite")){lifetime=RFAPI_INFINITE_LIFETIME;}else{
lifetime=strtoul(argv[10]->arg,NULL,10);}/*L2optionparsingSTART*/memset(optary,0
,sizeof(optary));optary[opt_next].v.l2addr.logical_net_id=strtoul(argv[14]->arg,
NULL,10);if((rc=rfapiStr2EthAddr(argv[12]->arg,&optary[opt_next].v.l2addr.macadd
r))){vty_out(vty,"Badmacaddress\"%s\"\n",argv[12]->arg);returnCMD_WARNING_CONFIG
_FAILED;}optary[opt_next].type=RFAPI_VN_OPTION_TYPE_L2ADDR;if(opt_next){optary[o
pt_next-1].next=optary+opt_next;}else{opt=optary;}++opt_next;/*L2optionparsingEN
D*//*TBDfixme*/rc=rfapi_register(handle,&hpfx,lifetime,NULL/*&uo*/,opt,0);if(rc)
{vty_out(vty,"rfapi_registerfailedwithrc=%d(%s)\n",rc,strerror(rc));}returnCMD_S
UCCESS;}DEFUN(debug_rfapi_unregister_vn_un,debug_rfapi_unregister_vn_un_cmd,"deb
ugrfapi-devunregistervn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:X>prefix<A.B.C.D/M|X:
X::X:X/M>",DEBUG_STRDEBUG_RFAPI_STR"rfapi_register\n""indicatevnaddrfollows\n""v
irtualnetworkinterfaceaddress\n""indicatextaddrfollows\n""underlaynetworkinterfa
ceaddress\n""indicateprefixfollows\n""prefix"){structrfapi_ip_addrvn;structrfapi
_ip_addrun;rfapi_handlehandle;structprefixpfx;structrfapi_ip_prefixhpfx;intrc;/*
*GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[4]->arg,&vn)))returnrc;/**Get
UNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[6]->arg,&un)))returnrc;if(rfapi_f
ind_handle_vty(vty,&vn,&un,&handle)){vty_out(vty,"can'tlocatehandlematchingvn=%s
,un=%s\n",argv[4]->arg,argv[6]->arg);returnCMD_WARNING_CONFIG_FAILED;}/**Getpref
ixtoadvertise*/if(!str2prefix(argv[8]->arg,&pfx)){vty_out(vty,"Malformedprefix\"
%s\"\n",argv[8]->arg);returnCMD_WARNING_CONFIG_FAILED;}if(pfx.family!=AF_INET&&p
fx.family!=AF_INET6){vty_out(vty,"Badfamilyforprefix\"%s\"\n",argv[8]->arg);retu
rnCMD_WARNING_CONFIG_FAILED;}rfapiQprefix2Rprefix(&pfx,&hpfx);rfapi_register(han
dle,&hpfx,0,NULL,NULL,1);returnCMD_SUCCESS;}DEFUN(debug_rfapi_query_vn_un,debug_
rfapi_query_vn_un_cmd,"debugrfapi-devqueryvn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:
X>target<A.B.C.D|X:X::X:X>",DEBUG_STRDEBUG_RFAPI_STR"rfapi_query\n""indicatevnad
drfollows\n""virtualnetworkinterfaceIPv4address\n""virtualnetworkinterfaceIPv6ad
dress\n""indicateunaddrfollows\n""IPv4unaddress\n""IPv6unaddress\n""indicatetarg
etfollows\n""targetIPv4address\n""targetIPv6address\n"){structrfapi_ip_addrvn;st
ructrfapi_ip_addrun;structrfapi_ip_addrtarget;rfapi_handlehandle;intrc;structrfa
pi_next_hop_entry*pNextHopEntry;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,
argv[4]->arg,&vn)))returnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv
[6]->arg,&un)))returnrc;/**Gettargetaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv
[8]->arg,&target)))returnrc;if(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_o
ut(vty,"can'tlocatehandlematchingvn=%s,un=%s\n",argv[4]->arg,argv[6]->arg);retur
nCMD_WARNING_CONFIG_FAILED;}/**optionsparameternotused?SettoNULLfornow*/rc=rfapi
_query(handle,&target,NULL,&pNextHopEntry);if(rc){vty_out(vty,"rfapi_queryfailed
withrc=%d(%s)\n",rc,strerror(rc));}else{/**printnexthoplist*/test_nexthops_callb
ack(/*&target,*/pNextHopEntry,vty);/*freesnhlist!*/}returnCMD_SUCCESS;}DEFUN(deb
ug_rfapi_query_vn_un_l2o,debug_rfapi_query_vn_un_l2o_cmd,"debugrfapi-devqueryvn<
A.B.C.D|X:X::X:X>un<A.B.C.D|X:X::X:X>lniLNItargetYY:YY:YY:YY:YY:YY",DEBUG_STRDEB
UG_RFAPI_STR"rfapi_query\n""indicatevnaddrfollows\n""virtualnetworkinterfaceIPv4
address\n""virtualnetworkinterfaceIPv6address\n""indicatextaddrfollows\n""underl
aynetworkinterfaceIPv4address\n""underlaynetworkinterfaceIPv6address\n""logicaln
etworkIDfollows\n""logicalnetworkID\n""indicatetargetMACaddrfollows\n""targetMAC
addr\n"){structrfapi_ip_addrvn;structrfapi_ip_addrun;structrfapi_ip_addrtarget;r
fapi_handlehandle;intrc;structrfapi_next_hop_entry*pNextHopEntry;structrfapi_l2a
ddress_optionl2o_buf;structbgp_tea_optionshopt;uint8_tvalbuf[14];/**GetVNaddr*/i
f((rc=rfapiCliGetRfapiIpAddr(vty,argv[4]->arg,&vn)))returnrc;/**GetUNaddr*/if((r
c=rfapiCliGetRfapiIpAddr(vty,argv[6]->arg,&un)))returnrc;#if0/*thereisnoIPtarget
arghere??????*//**Gettargetaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[2],&targ
et)))returnrc;#elsevty_out(vty,"%%Thiscommandisbroken.\n");returnCMD_WARNING_CON
FIG_FAILED;#endifif(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_out(vty,"can
'tlocatehandlematchingvn=%s,un=%s\n",argv[4]->arg,argv[6]->arg);returnCMD_WARNIN
G_CONFIG_FAILED;}/**SetupL2parameters*/memset(&l2o_buf,0,sizeof(l2o_buf));if(rfa
piStr2EthAddr(argv[10]->arg,&l2o_buf.macaddr)){vty_out(vty,"Badmacaddress\"%s\"\
n",argv[10]->arg);returnCMD_WARNING_CONFIG_FAILED;}l2o_buf.logical_net_id=strtou
l(argv[8]->arg,NULL,10);/*constructoptionchain*/memset(valbuf,0,sizeof(valbuf));
memcpy(valbuf,&l2o_buf.macaddr.octet,ETH_ALEN);valbuf[11]=(l2o_buf.logical_net_i
d>>16)&0xff;valbuf[12]=(l2o_buf.logical_net_id>>8)&0xff;valbuf[13]=l2o_buf.logic
al_net_id&0xff;memset(&hopt,0,sizeof(hopt));hopt.options_count=1;hopt.options_le
ngth=sizeof(valbuf);/*isthisright?*/hopt.type=RFAPI_VN_OPTION_TYPE_L2ADDR;hopt.l
ength=sizeof(valbuf);hopt.value=valbuf;/**optionsparameternotused?SettoNULLforno
w*/rc=rfapi_query(handle,&target,&l2o_buf,&pNextHopEntry);if(rc){vty_out(vty,"rf
api_queryfailedwithrc=%d(%s)\n",rc,strerror(rc));}else{/**printnexthoplist*//*TB
DenhancetoprintL2information*/test_nexthops_callback(/*&target,*/pNextHopEntry,v
ty);/*freesnhlist!*/}returnCMD_SUCCESS;}DEFUN(debug_rfapi_query_done_vn_un,debug
_rfapi_query_vn_un_done_cmd,"debugrfapi-devquerydonevn<A.B.C.D|X:X::X:X>un<A.B.C
.D|X:X::X:X>target<A.B.C.D|X:X::X:X>",DEBUG_STRDEBUG_RFAPI_STR"rfapi_query_done\
n""rfapi_query_done\n""indicatevnaddrfollows\n""virtualnetworkinterfaceIPv4addre
ss\n""virtualnetworkinterfaceIPv6address\n""indicatextaddrfollows\n""underlaynet
workinterfaceIPv4address\n""underlaynetworkinterfaceIPv6address\n""indicatetarge
tfollows\n""TargetIPv4address\n""TargetIPv6address\n"){structrfapi_ip_addrvn;str
uctrfapi_ip_addrun;structrfapi_ip_addrtarget;rfapi_handlehandle;intrc;/**GetVNad
dr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[5]->arg,&vn)))returnrc;/**GetUNaddr*/
if((rc=rfapiCliGetRfapiIpAddr(vty,argv[7]->arg,&un)))returnrc;/**Gettargetaddr*/
if((rc=rfapiCliGetRfapiIpAddr(vty,argv[9]->arg,&target)))returnrc;if(rfapi_find_
handle_vty(vty,&vn,&un,&handle)){vty_out(vty,"can'tlocatehandlematchingvn=%s,un=
%s\n",argv[5]->arg,argv[7]->arg);returnCMD_WARNING_CONFIG_FAILED;}/**optionspara
meternotused?SettoNULLfornow*/rc=rfapi_query_done(handle,&target);vty_out(vty,"r
fapi_query_donereturned%d\n",rc);returnCMD_SUCCESS;}DEFUN(debug_rfapi_show_impor
t,debug_rfapi_show_import_cmd,"debugrfapi-devshowimport",DEBUG_STRDEBUG_RFAPI_ST
RSHOW_STR"import\n"){structbgp*bgp;structrfapi*h;structrfapi_import_table*it;cha
r*s;intfirst_l2=1;/**Showallimporttables*/bgp=bgp_get_default();/*assume1instanc
efornow*/if(!bgp){vty_out(vty,"NoBGPinstance\n");returnCMD_WARNING_CONFIG_FAILED
;}h=bgp->rfapi;if(!h){vty_out(vty,"NoRFAPIinstance\n");returnCMD_WARNING_CONFIG_
FAILED;}/**Iterateoverallimporttables;doafilteredimport*fortheafi/saficombinatio
n*/for(it=h->imports;it;it=it->next){s=ecommunity_ecom2str(it->rt_import_list,EC
OMMUNITY_FORMAT_ROUTE_MAP,0);vty_out(vty,"ImportTable%p,RTs:%s\n",it,s);XFREE(MT
YPE_ECOMMUNITY_STR,s);rfapiShowImportTable(vty,"IPVPN",it->imported_vpn[AFI_IP],
1);rfapiShowImportTable(vty,"IPENCAP",it->imported_encap[AFI_IP],0);rfapiShowImp
ortTable(vty,"IP6VPN",it->imported_vpn[AFI_IP6],1);rfapiShowImportTable(vty,"IP6
ENCAP",it->imported_encap[AFI_IP6],0);}if(h->import_mac){void*cursor=NULL;uint32
_tlni;uintptr_tlni_as_ptr;intrc;charbuf[BUFSIZ];for(rc=skiplist_next(h->import_m
ac,(void**)&lni_as_ptr,(void**)&it,&cursor);!rc;rc=skiplist_next(h->import_mac,(
void**)&lni_as_ptr,(void**)&it,&cursor)){if(it->imported_vpn[AFI_L2VPN]){lni=lni
_as_ptr;if(first_l2){vty_out(vty,"\nLNI-basedEthernetTables:\n");first_l2=0;}snp
rintf(buf,BUFSIZ,"L2VPNLNI=%u",lni);rfapiShowImportTable(vty,buf,it->imported_vp
n[AFI_L2VPN],1);}}}rfapiShowImportTable(vty,"CEIT-IPVPN",h->it_ce->imported_vpn[
AFI_IP],1);returnCMD_SUCCESS;}DEFUN(debug_rfapi_show_import_vn_un,debug_rfapi_sh
ow_import_vn_un_cmd,"debugrfapi-devshowimportvn<A.B.C.D|X:X::X:X>un<A.B.C.D|X:X:
:X:X>",DEBUG_STRDEBUG_RFAPI_STRSHOW_STR"import\n""indicatevnaddrfollows\n""virtu
alnetworkinterfaceIPv4address\n""virtualnetworkinterfaceIPv6address\n""indicatex
taddrfollows\n""underlaynetworkinterfaceIPv4address\n""underlaynetworkinterfaceI
Pv6address\n"){structrfapi_ip_addrvn;structrfapi_ip_addrun;rfapi_handlehandle;in
trc;structrfapi_descriptor*rfd;/**GetVNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,a
rgv[5]->arg,&vn)))returnrc;/**GetUNaddr*/if((rc=rfapiCliGetRfapiIpAddr(vty,argv[
7]->arg,&un)))returnrc;if(rfapi_find_handle_vty(vty,&vn,&un,&handle)){vty_out(vt
y,"can'tlocatehandlematchingvn=%s,un=%s\n",argv[5]->arg,argv[7]->arg);returnCMD_
WARNING_CONFIG_FAILED;}rfd=(structrfapi_descriptor*)handle;rfapiShowImportTable(
vty,"IPVPN",rfd->import_table->imported_vpn[AFI_IP],1);rfapiShowImportTable(vty,
"IPENCAP",rfd->import_table->imported_encap[AFI_IP],0);rfapiShowImportTable(vty,
"IP6VPN",rfd->import_table->imported_vpn[AFI_IP6],1);rfapiShowImportTable(vty,"I
P6ENCAP",rfd->import_table->imported_encap[AFI_IP6],0);returnCMD_SUCCESS;}DEFUN(
debug_rfapi_response_omit_self,debug_rfapi_response_omit_self_cmd,"debugrfapi-de
vresponse-omit-self<on|off>",DEBUG_STRDEBUG_RFAPI_STR"OmitselfinRFPresponses\n""
filteroutselffromresponses\n""leaveselfinresponses\n"){structbgp*bgp=bgp_get_def
ault();if(!bgp){vty_out(vty,"NoBGPprocessisconfigured\n");returnCMD_WARNING_CONF
IG_FAILED;}if(!bgp->rfapi_cfg){vty_out(vty,"VNCnotconfigured\n");returnCMD_WARNI
NG_CONFIG_FAILED;}if(strmatch(argv[3]->text,"on"))SET_FLAG(bgp->rfapi_cfg->flags
,BGP_VNC_CONFIG_FILTER_SELF_FROM_RSP);elseUNSET_FLAG(bgp->rfapi_cfg->flags,BGP_V
NC_CONFIG_FILTER_SELF_FROM_RSP);returnCMD_SUCCESS;}#ifdefRFAPI_DEBUG_SKIPLIST_CL
I#include"lib/skiplist.h"DEFUN(skiplist_test_cli,skiplist_test_cli_cmd,"skiplist
test","skiplistcommand\n""test\n"){skiplist_test(vty);returnCMD_SUCCESS;}DEFUN(s
kiplist_debug_cli,skiplist_debug_cli_cmd,"skiplistdebug","skiplistcommand\n""deb
ug\n"){skiplist_debug(vty,NULL);returnCMD_SUCCESS;}#endif/*RFAPI_DEBUG_SKIPLIST_
CLI*/voidrfapi_init(void){bgp_rfapi_cfg_init();vnc_debug_init();install_element(
ENABLE_NODE,&debug_rfapi_show_import_cmd);install_element(ENABLE_NODE,&debug_rfa
pi_show_import_vn_un_cmd);install_element(ENABLE_NODE,&debug_rfapi_open_cmd);ins
tall_element(ENABLE_NODE,&debug_rfapi_close_vn_un_cmd);install_element(ENABLE_NO
DE,&debug_rfapi_close_rfd_cmd);install_element(ENABLE_NODE,&debug_rfapi_register
_vn_un_cmd);install_element(ENABLE_NODE,&debug_rfapi_unregister_vn_un_cmd);insta
ll_element(ENABLE_NODE,&debug_rfapi_query_vn_un_cmd);install_element(ENABLE_NODE
,&debug_rfapi_query_vn_un_done_cmd);install_element(ENABLE_NODE,&debug_rfapi_que
ry_vn_un_l2o_cmd);install_element(ENABLE_NODE,&debug_rfapi_response_omit_self_cm
d);/*Needthefollowingshowcommandsforgpztestscripts*/install_element(ENABLE_NODE,
&debug_rfapi_show_nves_cmd);install_element(ENABLE_NODE,&debug_rfapi_show_nves_v
n_un_cmd);install_element(ENABLE_NODE,&debug_rfapi_register_vn_un_l2o_cmd);#ifde
fRFAPI_DEBUG_SKIPLIST_CLIinstall_element(ENABLE_NODE,&skiplist_test_cli_cmd);ins
tall_element(ENABLE_NODE,&skiplist_debug_cli_cmd);#endifrfapi_vty_init();}#ifdef
DEBUG_RFAPIstaticvoidrfapi_print_exported(structbgp*bgp){structbgp_node*rdn;stru
ctbgp_node*rn;structbgp_info*bi;if(!bgp)return;for(rdn=bgp_table_top(bgp->rib[AF
I_IP][SAFI_MPLS_VPN]);rdn;rdn=bgp_route_next(rdn)){if(!rdn->info)continue;fprint
f(stderr,"%s:vpnrdn=%p\n",__func__,rdn);for(rn=bgp_table_top(rdn->info);rn;rn=bg
p_route_next(rn)){if(!rn->info)continue;fprintf(stderr,"%s:rn=%p\n",__func__,rn)
;for(bi=rn->info;bi;bi=bi->next){rfapiPrintBi((void*)2,bi);/*2=>stderr*/}}}for(r
dn=bgp_table_top(bgp->rib[AFI_IP][SAFI_ENCAP]);rdn;rdn=bgp_route_next(rdn)){if(!
rdn->info)continue;fprintf(stderr,"%s:encaprdn=%p\n",__func__,rdn);for(rn=bgp_ta
ble_top(rdn->info);rn;rn=bgp_route_next(rn)){if(!rn->info)continue;fprintf(stder
r,"%s:rn=%p\n",__func__,rn);for(bi=rn->info;bi;bi=bi->next){rfapiPrintBi((void*)
2,bi);/*2=>stderr*/}}}}#endif/*defined(DEBUG_RFAPI)*//**Freeallmemorytopreparefo
rcleanexitasseenbyvalgrindmemcheck*/voidrfapi_delete(structbgp*bgp){externvoidrf
p_clear_vnc_nve_all(void);/*can'tfixcorrectlyyet*//**Thisclearsqueriesandregiste
redroutes,andclosesnves*/if(bgp->rfapi)rfp_clear_vnc_nve_all();bgp_rfapi_cfg_des
troy(bgp,bgp->rfapi_cfg);bgp->rfapi_cfg=NULL;bgp_rfapi_destroy(bgp,bgp->rfapi);b
gp->rfapi=NULL;#ifdefDEBUG_RFAPI/**showwhat'sleftintheBGPMPLSVPNRIB*/rfapi_print
_exported(bgp);#endif}intrfapi_set_autord_from_vn(structprefix_rd*rd,structrfapi
_ip_addr*vn){vnc_zlog_debug_verbose("%s:auto-assigningRD",__func__);if(vn->addr_
family!=AF_INET&&vn->addr_family!=AF_INET6){vnc_zlog_debug_verbose("%s:can'tauto
-assignRD,VNaddrfamilyisnotIPv4""|v6",__func__);returnEAFNOSUPPORT;}rd->family=A
F_UNSPEC;rd->prefixlen=64;rd->val[1]=RD_TYPE_IP;if(vn->addr_family==AF_INET){mem
cpy(rd->val+2,&vn->addr.v4.s_addr,4);}else{/*isv6*/memcpy(rd->val+2,&vn->addr.v6
.s6_addr32[3],4);/*loworder4bytes*/}{charbuf[RD_ADDRSTRLEN];vnc_zlog_debug_verbo
se("%s:auto-RDissetto%s",__func__,prefix_rd2str(rd,buf,sizeof(buf)));}return0;}/
*------------------------------------------*rfapi_bgp_lookup_by_rfp**Findbgpinst
ancepointerbasedonvaluereturnedbyrfp_start**input:*rfp_start_valvaluereturnedbyr
fp_startor*NULL(=getdefaultinstance)**output:*none**returnvalue:*bgpbgpinstancep
ointer*NULL=notfound*--------------------------------------------*/structbgp*rfa
pi_bgp_lookup_by_rfp(void*rfp_start_val){structbgp*bgp=NULL;structlistnode*node,
*nnode;if(rfp_start_val==NULL)bgp=bgp_get_default();elsefor(ALL_LIST_ELEMENTS(bm
->bgp,node,nnode,bgp))if(bgp->rfapi!=NULL&&bgp->rfapi->rfp==rfp_start_val)return
bgp;returnbgp;}/*------------------------------------------*rfapi_get_rfp_start_
val_by_bgp**Findbgpinstancepointerbasedonvaluereturnedbyrfp_start**input:*bgpbgp
instancepointer**output:*none**returnvalue:*rfp_start_val*NULL=notfound*--------
------------------------------------*/void*rfapi_get_rfp_start_val_by_bgp(struct
bgp*bgp){if(!bgp||!bgp->rfapi)returnNULL;returnbgp->rfapi->rfp;}/***************
*********************************************************RFPgroupspecificconfigu
ration***********************************************************************/st
aticvoid*rfapi_rfp_get_or_init_group_config_default(structrfapi_cfg*rfc,structvt
y*vty,uint32_tsize){if(rfc->default_rfp_cfg==NULL&&size>0){rfc->default_rfp_cfg=
XCALLOC(MTYPE_RFAPI_RFP_GROUP_CFG,size);vnc_zlog_debug_verbose("%s:allocated,siz
e=%d",__func__,size);}returnrfc->default_rfp_cfg;}staticvoid*rfapi_rfp_get_or_in
it_group_config_nve(structrfapi_cfg*rfc,structvty*vty,uint32_tsize){structrfapi_
nve_group_cfg*rfg=VTY_GET_CONTEXT_SUB(rfapi_nve_group_cfg);/*makesuregroupisstil
linlist*/if(!rfg||!listnode_lookup(rfc->nve_groups_sequential,rfg)){/*Notinlista
nymore*/vty_out(vty,"CurrentNVEgroupnolongerexists\n");returnNULL;}if(rfg->rfp_c
fg==NULL&&size>0){rfg->rfp_cfg=XCALLOC(MTYPE_RFAPI_RFP_GROUP_CFG,size);vnc_zlog_
debug_verbose("%s:allocated,size=%d",__func__,size);}returnrfg->rfp_cfg;}staticv
oid*rfapi_rfp_get_or_init_group_config_l2(structrfapi_cfg*rfc,structvty*vty,uint
32_tsize){structrfapi_l2_group_cfg*rfg=VTY_GET_CONTEXT_SUB(rfapi_l2_group_cfg);/
*makesuregroupisstillinlist*/if(!rfg||!listnode_lookup(rfc->l2_groups,rfg)){/*No
tinlistanymore*/vty_out(vty,"CurrentL2groupnolongerexists\n");returnNULL;}if(rfg
->rfp_cfg==NULL&&size>0){rfg->rfp_cfg=XCALLOC(MTYPE_RFAPI_RFP_GROUP_CFG,size);vn
c_zlog_debug_verbose("%s:allocated,size=%d",__func__,size);}returnrfg->rfp_cfg;}
/*------------------------------------------*rfapi_rfp_init_group_config_ptr_vty
**Thisisusedtoinitorreturnapreviouslyinit'edgroupspecific*configurationpointer.G
roupisidentifiedbyvtycontext.*NOTE:sizeisignoredwhenapreviouslyinit'edvalueisret
urned.*RFAPIfreesrfp_cfg_groupwhengroupisdeletedduringreconfig,*bgprestartorshut
down.**input:*rfp_start_valvaluereturnedbyrfp_start*typegrouptype*vtyquaggavtyco
ntext*sizenumberofbytestoallocation**output:*none**returnvalue:*rfp_cfg_groupNUL
LorPointertoconfigurationstructure--------------------------------------------*/
void*rfapi_rfp_init_group_config_ptr_vty(void*rfp_start_val,rfapi_rfp_cfg_group_
typetype,structvty*vty,uint32_tsize){structbgp*bgp;void*ret=NULL;if(rfp_start_va
l==NULL||vty==NULL)returnNULL;bgp=rfapi_bgp_lookup_by_rfp(rfp_start_val);if(!bgp
||!bgp->rfapi_cfg)returnNULL;switch(type){caseRFAPI_RFP_CFG_GROUP_DEFAULT:ret=rf
api_rfp_get_or_init_group_config_default(bgp->rfapi_cfg,vty,size);break;caseRFAP
I_RFP_CFG_GROUP_NVE:ret=rfapi_rfp_get_or_init_group_config_nve(bgp->rfapi_cfg,vt
y,size);break;caseRFAPI_RFP_CFG_GROUP_L2:ret=rfapi_rfp_get_or_init_group_config_
l2(bgp->rfapi_cfg,vty,size);break;default:zlog_err("%s:Unknowngrouptype=%d",__fu
nc__,type);/*shouldneverhappen*/assert("Unknowntype"==NULL);break;}returnret;}/*
------------------------------------------*rfapi_rfp_get_group_config_ptr_vty**T
hisisusedtogetgroupspecificconfigurationpointer.*Groupisidentifiedbytypeandvtyco
ntext.*RFAPIfreesrfp_cfg_groupwhengroupisdeletedduringreconfig,*bgprestartorshut
down.**input:*rfp_start_valvaluereturnedbyrfp_start*typegrouptype*vtyquaggavtyco
ntext**output:*none**returnvalue:*rfp_cfg_groupPointertoconfigurationstructure--
------------------------------------------*/void*rfapi_rfp_get_group_config_ptr_
vty(void*rfp_start_val,rfapi_rfp_cfg_group_typetype,structvty*vty){returnrfapi_r
fp_init_group_config_ptr_vty(rfp_start_val,type,vty,0);}staticvoid*rfapi_rfp_get
_group_config_name_nve(structrfapi_cfg*rfc,constchar*name,void*criteria,rfp_grou
p_config_search_cb_t*search_cb){structrfapi_nve_group_cfg*rfg;structlistnode*nod
e;for(ALL_LIST_ELEMENTS_RO(rfc->nve_groups_sequential,node,rfg)){if(!strcmp(rfg-
>name,name)&&/*namematch*/(search_cb==NULL||!search_cb(criteria,rfg->rfp_cfg)))r
eturnrfg->rfp_cfg;}returnNULL;}staticvoid*rfapi_rfp_get_group_config_name_l2(str
uctrfapi_cfg*rfc,constchar*name,void*criteria,rfp_group_config_search_cb_t*searc
h_cb){structrfapi_l2_group_cfg*rfg;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(
rfc->l2_groups,node,rfg)){if(!strcmp(rfg->name,name)&&/*namematch*/(search_cb==N
ULL||!search_cb(criteria,rfg->rfp_cfg)))returnrfg->rfp_cfg;}returnNULL;}/*------
------------------------------------*rfapi_rfp_get_group_config_ptr_name**Thisis
usedtogetgroupspecificconfigurationpointer.*Groupisidentifiedbytypeandnamecontex
t.*RFAPIfreesrfp_cfg_groupwhengroupisdeletedduringreconfig,*bgprestartorshutdown
.**input:*rfp_start_valvaluereturnedbyrfp_start*typegrouptype*namegroupname*crit
eriaRFAPIcallerprovidedserachcriteria*search_cboptionalrfp_group_config_search_c
b_t**output:*none**returnvalue:*rfp_cfg_groupPointertoconfigurationstructure----
----------------------------------------*/void*rfapi_rfp_get_group_config_ptr_na
me(void*rfp_start_val,rfapi_rfp_cfg_group_typetype,constchar*name,void*criteria,
rfp_group_config_search_cb_t*search_cb){structbgp*bgp;void*ret=NULL;if(rfp_start
_val==NULL||name==NULL)returnNULL;bgp=rfapi_bgp_lookup_by_rfp(rfp_start_val);if(
!bgp||!bgp->rfapi_cfg)returnNULL;switch(type){caseRFAPI_RFP_CFG_GROUP_DEFAULT:re
t=bgp->rfapi_cfg->default_rfp_cfg;break;caseRFAPI_RFP_CFG_GROUP_NVE:ret=rfapi_rf
p_get_group_config_name_nve(bgp->rfapi_cfg,name,criteria,search_cb);break;caseRF
API_RFP_CFG_GROUP_L2:ret=rfapi_rfp_get_group_config_name_l2(bgp->rfapi_cfg,name,
criteria,search_cb);break;default:zlog_err("%s:Unknowngrouptype=%d",__func__,typ
e);/*shouldneverhappen*/assert("Unknowntype"==NULL);break;}returnret;}/*--------
----------------------------------*rfapi_rfp_get_l2_group_config_ptr_lni**Thisis
usedtogetgroupspecificconfigurationpointer.*Groupisidentifiedbytypeandlogicalnet
workidentifier.*RFAPIfreesrfp_cfg_groupwhengroupisdeletedduringreconfig,*bgprest
artorshutdown.**input:*rfp_start_valvaluereturnedbyrfp_start*typegrouptype*logic
al_net_idgrouplogicalnetworkidentifier*criteriaRFAPIcallerprovidedserachcriteria
*search_cboptionalrfp_group_config_search_cb_t**output:*none**returnvalue:*rfp_c
fg_groupPointertoconfigurationstructure-----------------------------------------
---*/void*rfapi_rfp_get_l2_group_config_ptr_lni(void*rfp_start_val,uint32_tlogic
al_net_id,void*criteria,rfp_group_config_search_cb_t*search_cb){structbgp*bgp;st
ructrfapi_l2_group_cfg*rfg;structlistnode*node;if(rfp_start_val==NULL)returnNULL
;bgp=rfapi_bgp_lookup_by_rfp(rfp_start_val);if(!bgp||!bgp->rfapi_cfg)returnNULL;
for(ALL_LIST_ELEMENTS_RO(bgp->rfapi_cfg->l2_groups,node,rfg)){if(rfg->logical_ne
t_id==logical_net_id&&(search_cb==NULL||!search_cb(criteria,rfg->rfp_cfg))){if(r
fg->rfp_cfg==NULL)vnc_zlog_debug_verbose("%s:returningrfpgroupconfigforlni=0",__
func__);returnrfg->rfp_cfg;}}returnNULL;}