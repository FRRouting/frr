/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
nclude"lib/zebra.h"#include"lib/prefix.h"#include"lib/table.h"#include"lib/memor
y.h"#include"lib/vty.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_route.h"#include"b
gpd/rfapi/vnc_export_table.h"#include"bgpd/rfapi/rfapi_private.h"#include"bgpd/r
fapi/rfapi_import.h"#include"bgpd/rfapi/vnc_debug.h"structroute_node*vnc_etn_get
(structbgp*bgp,vnc_export_type_ttype,structprefix*p){structroute_table*t=NULL;st
ructroute_node*rn=NULL;afi_tafi;if(!bgp||!bgp->rfapi)returnNULL;afi=family2afi(p
->family);assert(afi==AFI_IP||afi==AFI_IP6);switch(type){caseEXPORT_TYPE_BGP:if(
!bgp->rfapi->rt_export_bgp[afi])bgp->rfapi->rt_export_bgp[afi]=route_table_init(
);t=bgp->rfapi->rt_export_bgp[afi];break;caseEXPORT_TYPE_ZEBRA:if(!bgp->rfapi->r
t_export_zebra[afi])bgp->rfapi->rt_export_zebra[afi]=route_table_init();t=bgp->r
fapi->rt_export_zebra[afi];break;}if(t)rn=route_node_get(t,p);returnrn;}structro
ute_node*vnc_etn_lookup(structbgp*bgp,vnc_export_type_ttype,structprefix*p){stru
ctroute_table*t=NULL;structroute_node*rn=NULL;afi_tafi;if(!bgp||!bgp->rfapi)retu
rnNULL;afi=family2afi(p->family);assert(afi==AFI_IP||afi==AFI_IP6);switch(type){
caseEXPORT_TYPE_BGP:if(!bgp->rfapi->rt_export_bgp[afi])bgp->rfapi->rt_export_bgp
[afi]=route_table_init();t=bgp->rfapi->rt_export_bgp[afi];break;caseEXPORT_TYPE_
ZEBRA:if(!bgp->rfapi->rt_export_zebra[afi])bgp->rfapi->rt_export_zebra[afi]=rout
e_table_init();t=bgp->rfapi->rt_export_zebra[afi];break;}if(t)rn=route_node_look
up(t,p);returnrn;}structvnc_export_info*vnc_eti_get(structbgp*bgp,vnc_export_typ
e_tetype,structprefix*p,structpeer*peer,uint8_ttype,uint8_tsubtype){structroute_
node*etn;structvnc_export_info*eti;etn=vnc_etn_get(bgp,etype,p);assert(etn);for(
eti=etn->info;eti;eti=eti->next){if(peer==eti->peer&&type==eti->type&&subtype==e
ti->subtype){break;}}if(eti){route_unlock_node(etn);}else{eti=XCALLOC(MTYPE_RFAP
I_ETI,sizeof(structvnc_export_info));assert(eti);eti->node=etn;eti->peer=peer;pe
er_lock(peer);eti->type=type;eti->subtype=subtype;eti->next=etn->info;etn->info=
eti;}returneti;}voidvnc_eti_delete(structvnc_export_info*goner){structroute_node
*etn;structvnc_export_info*eti;structvnc_export_info*eti_prev=NULL;etn=goner->no
de;for(eti=etn->info;eti;eti_prev=eti,eti=eti->next){if(eti==goner)break;}if(!et
i){vnc_zlog_debug_verbose("%s:COULDN'TFINDETI",__func__);return;}if(eti_prev){et
i_prev->next=goner->next;}else{etn->info=goner->next;}peer_unlock(eti->peer);gon
er->node=NULL;XFREE(MTYPE_RFAPI_ETI,goner);route_unlock_node(etn);}structvnc_exp
ort_info*vnc_eti_checktimer(structbgp*bgp,vnc_export_type_tetype,structprefix*p,
structpeer*peer,uint8_ttype,uint8_tsubtype){structroute_node*etn;structvnc_expor
t_info*eti;etn=vnc_etn_lookup(bgp,etype,p);if(!etn)returnNULL;for(eti=etn->info;
eti;eti=eti->next){if(peer==eti->peer&&type==eti->type&&subtype==eti->subtype){b
reak;}}route_unlock_node(etn);if(eti&&eti->timer)returneti;returnNULL;}