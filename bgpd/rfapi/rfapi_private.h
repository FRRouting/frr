/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*
*InternaldefinitionsforRFAPI.Notforusebyothercode*/#ifndef_QUAGGA_BGP_RFAPI_PRIV
ATE_H#define_QUAGGA_BGP_RFAPI_PRIVATE_H#include"lib/linklist.h"#include"lib/skip
list.h"#include"lib/workqueue.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_route
.h"#include"rfapi.h"/**Listsofrfapi_adb.Eachrfapi_adbisreferencedtwice:**1.eachi
sreferencedinby_lifetime*2.eachisreferencedbyexactlyoneof:ipN_by_prefix,ip0_by_e
ther*/structrfapi_advertised_prefixes{structskiplist*ipN_by_prefix;/*allexcept0/
32,0/128*/structskiplist*ip0_by_ether;/*ipprefix0/32,0/128*/structskiplist*by_li
fetime;/*all*/};structrfapi_descriptor{structroute_node*un_node;/*backreftountab
le*/structrfapi_descriptor*next;/*nextvn_addr*//*suppliedbyclient*/structbgp*bgp
;/*fromrfp_start_val*/structrfapi_ip_addrvn_addr;structrfapi_ip_addrun_addr;rfap
i_response_cb_t*response_cb;/*overrideper-bgpresponse_cb*/void*cookie;/*forcallb
acks*/structrfapi_tunneltype_optiondefault_tunneltype_option;/*suppliedbymatched
configuration*/structprefix_rdrd;structecommunity*rt_export_list;uint32_trespons
e_lifetime;/*listofprefixescurrentlybeingadvertisedbythisnve*/structrfapi_advert
ised_prefixesadvertised;time_topen_time;uint32_tmax_prefix_lifetime;uint32_tmin_
prefix_lifetime;/*referencetothisnve'simporttable*/structrfapi_import_table*impo
rt_table;uint32_tmonitor_count;structroute_table*mon;/*rfapi_monitors*/structski
plist*mon_eth;/*ethernetmonitors*//**ribRIBasseenbyNVE*rib_pendingRIBcontainingn
odeswithupdatedinfochains*rsp_timeslasttimewesentresponsecontainingpfx*/uint32_t
rib_prefix_count;/*pfxeswithroutes*/structroute_table*rib[AFI_MAX];structroute_t
able*rib_pending[AFI_MAX];structwork_queue*updated_responses_queue;structroute_t
able*rsp_times[AFI_MAX];uint32_trsp_counter;/*dedupinitialrsp*/time_trsp_time;/*
dedupinitialrsp*/time_tftd_last_allowed_time;/*FTDfilter*/unsignedintstat_count_
nh_reachable;unsignedintstat_count_nh_removal;/**pointstotheoriginalnvegroupstru
cturethatmatched*whenthisnve_descriptorwascreated.Weusethispointer*inrfapi_close
()tofindthenvegroupstructureand*deleteitsreferencebacktous.**Ifthenvegroupstruct
ureisdeleted(viaconfiguration*change)whilethisnve_descriptorexists,thisrfgpointe
r*willbesettoNULL.*/structrfapi_nve_group_cfg*rfg;/**This~7kBstructureisheretope
rmitmultipleroutesfor*aprefixtobeinjectedtoBGP.Thereareatleasttwo*situationswher
esuchconditionsobtain:**WhenanVNCrouteisexportedtoBGPonbehalfofthesetof*NVEsthat
belongtotheexportNVEgroup,itisreplicated*sothatthereisonerouteperNVE(andtheroute
'snexthop*istheNVE'sVNaddress).**EachoftheseroutesbeinginjectedtoBGPmusthaveadis
tinct*peerpointer(otherwise,iftheyhavethesamepeerpointer,each*routewillbeconside
redanimplicitwaithdrawoftheprevious*routeinjectedfromthatpeer,andthenewroutewill
replace*ratherthanaugmenttheoldone(s)).*/structpeer*peer;uint32_tflags;#defineRF
API_HD_FLAG_CALLBACK_SCHEDULED_AFI_IP0x00000001#defineRFAPI_HD_FLAG_CALLBACK_SCH
EDULED_AFI_IP60x00000002#defineRFAPI_HD_FLAG_CALLBACK_SCHEDULED_AFI_L2VPN0x00000
004#defineRFAPI_HD_FLAG_PROVISIONAL0x00000008#defineRFAPI_HD_FLAG_CLOSING_ADMINI
STRATIVELY0x00000010#defineRFAPI_HD_FLAG_IS_VRF0x00000012};#defineRFAPI_QUEUED_F
LAG(afi)\(((afi)==AFI_IP)\?RFAPI_HD_FLAG_CALLBACK_SCHEDULED_AFI_IP\:(((afi)==AFI
_IP6)\?RFAPI_HD_FLAG_CALLBACK_SCHEDULED_AFI_IP6\:(((afi)==AFI_L2VPN)\?RFAPI_HD_F
LAG_CALLBACK_SCHEDULED_AFI_L2VPN\:(assert(0),0))))structrfapi_global_stats{time_
tlast_reset;unsignedintmax_descriptors;unsignedintcount_unknown_nves;unsignedint
count_queries;unsignedintcount_queries_failed;unsignedintmax_responses;/*semanti
cs?*/unsignedintcount_registrations;unsignedintcount_registrations_failed;unsign
edintcount_updated_response_updates;unsignedintcount_updated_response_deletes;};
/**ThereisoneoftheseperBGPinstance.**Radixtreeisindexedbyunaddress;followchainan
d*checkvnaddresstogetexactmatch.*/structrfapi{structroute_table*un[AFI_MAX];stru
ctrfapi_import_table*imports;/*IPv4,IPv6*/structlistdescriptors;/*debug&resolve-
nveimports*/structrfapi_global_statsstat;/**callbacksintoRFP,setatstartuptime(bg
p_rfapi_new()gets*valuesfromrfp_start())orviarfapi_rfp_set_cb_methods()*(otherwi
seNULL).Notethattheresponse_cbmethodcanalso*beoverriddenper-rfd(currentlyusedonl
yfordebug/testscenarios)*/structrfapi_rfp_cb_methodsrfp_methods;/**Importtablesf
orEthernetoverIPSEC**TheskiplistkeysareLNIs.Valuesarepointers*tostructrfapi_impo
rt_table.*/structskiplist*import_mac;/*L2*//**whenexportingplainroutes("register
ed-nve"mode)to*bgpunicastorzebra,weneedtokeeptrackofinformation*relatedtoexpirin
gtheroutesaccordingtotheVNClifetime*/structroute_table*rt_export_bgp[AFI_MAX];st
ructroute_table*rt_export_zebra[AFI_MAX];/**ForVNC->BGPunicastexportsinCEmode,we
needa*routingtablethatcollectsalloftheVPNroutes*inasingletree.TheVPNribissplitup
according*toRDfirst,sowecan'tusethat.Thisisanimport*tablethatmatchesallRTs.*/str
uctrfapi_import_table*it_ce;/**whenimportingbgp-directroutesinresolve-nvemode,*t
hislistmapsunicastroutenexthopstotheirbgp_infos*intheunicasttable*/structskiplis
t*resolve_nve_nexthop;/**Descriptorsforwhichrfapi_close()wascalledduringacallbac
k.*Theywillbeclosedafterthecallbackfinishes.*/structwork_queue*deferred_close_q;
/**For"showvncresponses"*/uint32_tresponse_immediate_count;uint32_tresponse_upda
ted_count;uint32_tmonitor_count;uint32_trib_prefix_count_total;uint32_trib_prefi
x_count_total_max;uint32_tflags;#defineRFAPI_INCALLBACK0x00000001void*rfp;/*from
rfp_start*/};#defineRFAPI_RIB_PREFIX_COUNT_INCR(rfd,rfapi)\do{\++(rfd)->rib_pref
ix_count;\++(rfapi)->rib_prefix_count_total;\if((rfapi)->rib_prefix_count_total\
>(rfapi)->rib_prefix_count_total_max)\++(rfapi)->rib_prefix_count_total_max;\}wh
ile(0)#defineRFAPI_RIB_PREFIX_COUNT_DECR(rfd,rfapi)\do{\--(rfd)->rib_prefix_coun
t;\--(rfapi)->rib_prefix_count_total;\}while(0)#defineRFAPI_0_PREFIX(prefix)\(((
(prefix)->family==AF_INET)\?(prefix)->u.prefix4.s_addr==0\:(((prefix)->family==A
F_INET6)\?(IN6_IS_ADDR_UNSPECIFIED(&(prefix)->u.prefix6))\:0)))#defineRFAPI_0_ET
HERADDR(ea)\(((ea)->octet[0]|(ea)->octet[1]|(ea)->octet[2]|(ea)->octet[3]\|(ea)-
>octet[4]|(ea)->octet[5])\==0)#defineRFAPI_HOST_PREFIX(prefix)\(((prefix)->famil
y==AF_INET)\?((prefix)->prefixlen==32)\:(((prefix)->family==AF_INET6)\?((prefix)
->prefixlen==128)\:0))externvoidrfapiQprefix2Rprefix(structprefix*qprefix,struct
rfapi_ip_prefix*rprefix);externintrfapi_find_rfd(structbgp*bgp,structrfapi_ip_ad
dr*vn_addr,structrfapi_ip_addr*un_addr,structrfapi_descriptor**rfd);externvoidad
d_vnc_route(structrfapi_descriptor*rfd,/*cookie+UNaddrforVPN*/structbgp*bgp,ints
afi,structprefix*p,structprefix_rd*prd,structrfapi_ip_addr*nexthop,uint32_t*loca
l_pref,/*hostbyteorder*/uint32_t*lifetime,/*hostbyteorder*/structbgp_tea_options
*rfp_options,structrfapi_un_option*options_un,structrfapi_vn_option*options_vn,s
tructecommunity*rt_export_list,uint32_t*med,uint32_t*label,uint8_ttype,uint8_tsu
b_type,intflags);#defineRFAPI_AHR_NO_TUNNEL_SUBTLV0x00000001#defineRFAPI_AHR_RFP
OPT_IS_VNCTLV0x00000002/*hack!*/#if0/*unused?*/#defineRFAPI_AHR_SET_PFX_TO_NEXTH
OP0x00000004#endifexternvoiddel_vnc_route(structrfapi_descriptor*rfd,structpeer*
peer,structbgp*bgp,safi_tsafi,structprefix*p,structprefix_rd*prd,uint8_ttype,uin
t8_tsub_type,structrfapi_nexthop*lnh,intkill);externintrfapiCliGetPrefixAddr(str
uctvty*vty,constchar*str,structprefix*p);externintrfapiGetVncLifetime(structattr
*attr,uint32_t*lifetime);externintrfapiGetTunnelType(structattr*attr,bgp_encap_t
ypes*type);externintrfapiGetVncTunnelUnAddr(structattr*attr,structprefix*p);exte
rnintrfapi_reopen(structrfapi_descriptor*rfd,structbgp*bgp);externvoidvnc_import
_bgp_add_rfp_host_route_mode_resolve_nve(structbgp*bgp,structrfapi_descriptor*rf
d,structprefix*prefix);externvoidvnc_import_bgp_del_rfp_host_route_mode_resolve_
nve(structbgp*bgp,structrfapi_descriptor*rfd,structprefix*prefix);externvoidrfap
iFreeBgpTeaOptionChain(structbgp_tea_options*p);externstructrfapi_vn_option*rfap
iVnOptionsDup(structrfapi_vn_option*orig);externstructrfapi_un_option*rfapiUnOpt
ionsDup(structrfapi_un_option*orig);externstructbgp_tea_options*rfapiOptionsDup(
structbgp_tea_options*orig);externintrfapi_ip_addr_cmp(structrfapi_ip_addr*a1,st
ructrfapi_ip_addr*a2);externuint32_trfp_cost_to_localpref(uint8_tcost);externint
rfapi_set_autord_from_vn(structprefix_rd*rd,structrfapi_ip_addr*vn);externstruct
rfapi_nexthop*rfapi_nexthop_new(structrfapi_nexthop*copyme);externvoidrfapi_next
hop_free(void*goner);externstructrfapi_vn_option*rfapi_vn_options_dup(structrfap
i_vn_option*existing);externvoidrfapi_un_options_free(structrfapi_un_option*gone
r);externvoidrfapi_vn_options_free(structrfapi_vn_option*goner);externvoidvnc_ad
d_vrf_opener(structbgp*bgp,structrfapi_nve_group_cfg*rfg);externvoidclear_vnc_vr
f_closer(structrfapi_nve_group_cfg*rfg);/*--------------------------------------
----*rfapi_extract_l2o**FindLayer2optionsinanoptionchain**input:*pHopoptionchain
**output:*l2olayer2optionsextracted**returnvalue:*0OK*1nooptionsfound*----------
----------------------------------*/externintrfapi_extract_l2o(structbgp_tea_opt
ions*pHop,/*chainofoptions*/structrfapi_l2address_option*l2o);/*returnextractedv
alue*//**compaitibilitytooldquagga_timecall*time_tvalueintermsofstabilisedabsolu
tetime.*replacementforPOSIXtime()*/externtime_trfapi_time(time_t*t);DECLARE_MGRO
UP(RFAPI)DECLARE_MTYPE(RFAPI_CFG)DECLARE_MTYPE(RFAPI_GROUP_CFG)DECLARE_MTYPE(RFA
PI_L2_CFG)DECLARE_MTYPE(RFAPI_RFP_GROUP_CFG)DECLARE_MTYPE(RFAPI)DECLARE_MTYPE(RF
API_DESC)DECLARE_MTYPE(RFAPI_IMPORTTABLE)DECLARE_MTYPE(RFAPI_MONITOR)DECLARE_MTY
PE(RFAPI_MONITOR_ENCAP)DECLARE_MTYPE(RFAPI_NEXTHOP)DECLARE_MTYPE(RFAPI_VN_OPTION
)DECLARE_MTYPE(RFAPI_UN_OPTION)DECLARE_MTYPE(RFAPI_WITHDRAW)DECLARE_MTYPE(RFAPI_
RFG_NAME)DECLARE_MTYPE(RFAPI_ADB)DECLARE_MTYPE(RFAPI_ETI)DECLARE_MTYPE(RFAPI_NVE
_ADDR)DECLARE_MTYPE(RFAPI_PREFIX_BAG)DECLARE_MTYPE(RFAPI_IT_EXTRA)DECLARE_MTYPE(
RFAPI_INFO)DECLARE_MTYPE(RFAPI_ADDR)DECLARE_MTYPE(RFAPI_UPDATED_RESPONSE_QUEUE)D
ECLARE_MTYPE(RFAPI_RECENT_DELETE)DECLARE_MTYPE(RFAPI_L2ADDR_OPT)DECLARE_MTYPE(RF
API_AP)DECLARE_MTYPE(RFAPI_MONITOR_ETH)/**Callermustsupplyanalready-allocatedrfd
withthe"caller"*fieldsalreadyset(vn_addr,un_addr,callback,cookie)*Theadvertised_
prefixes[]arrayelementsshouldbeNULLto*havethisfunctionsetthemtonewly-allocatedra
dixtrees.*/externintrfapi_init_and_open(structbgp*bgp,structrfapi_descriptor*rfd
,structrfapi_nve_group_cfg*rfg);#endif/*_QUAGGA_BGP_RFAPI_PRIVATE_H*/