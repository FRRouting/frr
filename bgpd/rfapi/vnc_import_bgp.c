/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*
*File:vnc_import_bgp.c*Purpose:ImportroutesfromBGPunicastdirectly(notviazebra)*/
#include"lib/zebra.h"#include"lib/prefix.h"#include"lib/table.h"#include"lib/vty
.h"#include"lib/log.h"#include"lib/memory.h"#include"lib/linklist.h"#include"lib
/plist.h"#include"lib/routemap.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_ecommuni
ty.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_mplsvp
n.h"/*forRD_TYPE_IP*/#include"bgpd/rfapi/vnc_export_bgp.h"#include"bgpd/rfapi/bg
p_rfapi_cfg.h"#include"bgpd/rfapi/rfapi.h"#include"bgpd/rfapi/rfapi_import.h"#in
clude"bgpd/rfapi/rfapi_private.h"#include"bgpd/rfapi/rfapi_monitor.h"#include"bg
pd/rfapi/rfapi_vty.h"#include"bgpd/rfapi/vnc_import_bgp.h"#include"bgpd/rfapi/vn
c_import_bgp_p.h"#include"bgpd/rfapi/vnc_debug.h"#defineENABLE_VNC_RHNCK#defineD
EBUG_RHN_LIST0staticstructrfapi_descriptorvncHDBgpDirect;/*dummynvedescriptor*/s
taticstructrfapi_descriptorvncHDResolveNve;/*dummynvedescriptor*//**Forroutesfro
manotherAS:**IfMEDisset,*LOCAL_PREF=255-MIN(255,MED)*else*LOCAL_PREF=default_loc
al_pref**ForroutesfromthesameAS:**LOCAL_PREFunchanged*/uint32_tcalc_local_pref(s
tructattr*attr,structpeer*peer){uint32_tlocal_pref=0;if(!attr){if(peer){returnpe
er->bgp->default_local_pref;}returnbgp_get_default()->default_local_pref;}if(pee
r&&(peer->as!=peer->bgp->as)){if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DI
SC)){if(attr->med>255){local_pref=0;}else{local_pref=255-attr->med;}}else{local_
pref=peer->bgp->default_local_pref;}}else{if(attr->flag&ATTR_FLAG_BIT(BGP_ATTR_L
OCAL_PREF)){local_pref=attr->local_pref;}else{if(peer&&peer->bgp){local_pref=pee
r->bgp->default_local_pref;}}}returnlocal_pref;}staticintis_host_prefix(structpr
efix*p){switch(p->family){caseAF_INET:return(p->prefixlen==32);caseAF_INET6:retu
rn(p->prefixlen==128);}return0;}/***********************************************
*************************RHNlist************************************************
***********************/structprefix_bag{structprefixhpfx;/*ceaddress=unicastnex
thop*/structprefixupfx;/*unicastprefix*/structbgp_info*ubi;/*unicastroute*/};sta
ticconstuint8_tmaskbit[]={0x00,0x80,0xc0,0xe0,0xf0,0xf8,0xfc,0xfe,0xff};intvnc_p
refix_cmp(void*pfx1,void*pfx2){intoffset;intshift;uint8_tmask;structprefix*p1=pf
x1;structprefix*p2=pfx2;if(p1->family<p2->family)return-1;if(p1->family>p2->fami
ly)return1;if(p1->prefixlen<p2->prefixlen)return-1;if(p1->prefixlen>p2->prefixle
n)return1;offset=p1->prefixlen/8;shift=p1->prefixlen%8;if(shift==0&&offset){/*ca
tchalignedcase*/offset--;shift=8;}/*Setbothprefix'sheadpointer.*/constuint8_t*pp
1=(constuint8_t*)&p1->u.prefix;constuint8_t*pp2=(constuint8_t*)&p2->u.prefix;whi
le(offset--){if(*pp1<*pp2)return-1;if(*pp1>*pp2)return1;++pp1;++pp2;}mask=maskbi
t[shift];if((*pp1&mask)<(*pp2&mask))return-1;if((*pp1&mask)>(*pp2&mask))return1;
return0;}staticvoidprefix_bag_free(void*pb){XFREE(MTYPE_RFAPI_PREFIX_BAG,pb);}#i
fDEBUG_RHN_LISTstaticvoidprint_rhn_list(constchar*tag1,constchar*tag2){structbgp
*bgp;structskiplist*sl;structskiplistnode*p;structprefix_bag*pb;intcount=0;bgp=b
gp_get_default();if(!bgp)return;sl=bgp->frapi->resolve_nve_nexthop;if(!sl){vnc_z
log_debug_verbose("%s:%s:RHNListisempty",(tag1?tag1:""),(tag2?tag2:""));return;}
vnc_zlog_debug_verbose("%s:%s:RHNlist:",(tag1?tag1:""),(tag2?tag2:""));/*XXXuses
secretknowledgeofskipliststructure*/for(p=sl->header->forward[0];p;p=p->forward[
0]){charkbuf[PREFIX_STRLEN];charhbuf[PREFIX_STRLEN];charubuf[PREFIX_STRLEN];pb=p
->value;prefix2str(p->key,kbuf,sizeof(kbuf));prefix2str(&pb->hpfx,hbuf,sizeof(hb
uf));prefix2str(&pb->upfx,ubuf,sizeof(ubuf));vnc_zlog_debug_verbose("RHNEntry%d(
q=%p):kpfx=%s,upfx=%s,hpfx=%s,ubi=%p",++count,p,kbuf,ubuf,hbuf,pb->ubi);}}#endif
#ifdefENABLE_VNC_RHNCKstaticvoidvnc_rhnck(char*tag){structbgp*bgp;structskiplist
*sl;structskiplistnode*p;bgp=bgp_get_default();if(!bgp)return;sl=bgp->rfapi->res
olve_nve_nexthop;if(!sl)return;/*XXXusessecretknowledgeofskipliststructure*/for(
p=sl->header->forward[0];p;p=p->forward[0]){structprefix_bag*pb;structprefix*pke
y;afi_tafi;structprefixpfx_orig_nexthop;memset(&pfx_orig_nexthop,0,sizeof(struct
prefix));/*keepvalgrindhappy*/pkey=p->key;pb=p->value;afi=family2afi(pb->upfx.fa
mily);rfapiUnicastNexthop2Prefix(afi,pb->ubi->attr,&pfx_orig_nexthop);/*pb->hpfx
,pb->ubinexthop,pkeyshouldallreflectthesame*pfx*/assert(!vnc_prefix_cmp(&pb->hpf
x,pkey));if(vnc_prefix_cmp(&pb->hpfx,&pfx_orig_nexthop)){charstr_onh[PREFIX_STRL
EN];charstr_nve_pfx[PREFIX_STRLEN];prefix2str(&pfx_orig_nexthop,str_onh,sizeof(s
tr_onh));prefix2str(&pb->hpfx,str_nve_pfx,sizeof(str_nve_pfx));vnc_zlog_debug_ve
rbose("%s:%s:FATAL:resolve_nve_nexthoplistitembinexthop%s!=nvepfx%s",__func__,ta
g,str_onh,str_nve_pfx);assert(0);}}vnc_zlog_debug_verbose("%s:vnc_rhnckOK",tag);
}#defineVNC_RHNCK(n)do{charbuf[BUFSIZ];sprintf(buf,"%s:%s",__func__,#n);vnc_rhnc
k(buf);}while(0)#else#defineVNC_RHNCK(n)#endif/*********************************
***************************************Add/DeleteUnicastRoute*******************
****************************************************//**"AddingaRoute"importproc
ess*//**extractandpackageinformationfromtheBGPunicastroute.*Returncode0meansOK,n
on-0meansdrop.**Ifreturncodeis0,callerMUSTreleaseecom*/staticintprocess_unicast_
route(structbgp*bgp,/*in*/afi_tafi,/*in*/structprefix*prefix,/*in*/structbgp_inf
o*info,/*in*/structecommunity**ecom,/*OUT*/structprefix*unicast_nexthop)/*OUT*/{
structrfapi_cfg*hc=bgp->rfapi_cfg;structpeer*peer=info->peer;structattr*attr=inf
o->attr;structattrhattr;structroute_map*rmap=NULL;structprefixpfx_orig_nexthop;m
emset(&pfx_orig_nexthop,0,sizeof(structprefix));/*keepvalgrindhappy*//**prefixli
stcheck*/if(hc->plist_redist[ZEBRA_ROUTE_BGP_DIRECT][afi]){vnc_zlog_debug_verbos
e("%s:HCprefixlistisset,checking",__func__);if(prefix_list_apply(hc->plist_redis
t[ZEBRA_ROUTE_BGP_DIRECT][afi],prefix)==PREFIX_DENY){vnc_zlog_debug_verbose("%s:
prefixlistreturnsDENY,blockingroute",__func__);return-1;}vnc_zlog_debug_verbose(
"%s:prefixlistreturnsPASS,allowingroute",__func__);}/*applyroutemap,ifany,later*
/rmap=hc->routemap_redist[ZEBRA_ROUTE_BGP_DIRECT];/**Extractoriginalnexthop,whic
hweexpecttobeaNVEconnected*router*Notethatthisisthenexthopbeforeanypossibleappli
cationof*policy*//**Incomingprefixisunicast.Ifv6,itisinmultiprotocolarea,*butifv
4itisinattr->nexthop*/rfapiUnicastNexthop2Prefix(afi,attr,&pfx_orig_nexthop);/**
routemaphandling*Thiscodeisherebecauseitallocatesaninternedattrwhich*mustbefreed
beforewereturn.It'seasiertoputitafter*allofthepossiblereturnsabove.*/memset(&hat
tr,0,sizeof(structattr));bgp_attr_dup(&hattr,attr);/*hattrbecomesaghostattr*/if(
rmap){structbgp_infoinfo;route_map_result_tret;memset(&info,0,sizeof(info));info
.peer=peer;info.attr=&hattr;ret=route_map_apply(rmap,prefix,RMAP_BGP,&info);if(r
et==RMAP_DENYMATCH){bgp_attr_flush(&hattr);vnc_zlog_debug_verbose("%s:routemap\"
%s\"saysDENY,returning",__func__,rmap->name);return-1;}}/**Getthe(possiblyaltere
dbypolicy)unicastnexthop*forlaterlookupintheImportTablebycaller*/rfapiUnicastNex
thop2Prefix(afi,&hattr,unicast_nexthop);if(hattr.ecommunity)*ecom=ecommunity_dup
(hattr.ecommunity);else*ecom=ecommunity_new();/**Donewithhattr,cleanup*/bgp_attr
_flush(&hattr);/**AddECthatcarriesoriginalNHofiBGProute(2bytes=magic*valueindica
tingitcamefromanVNCgateway;default5226,but*mustbeuserconfigurable).Notethatthisi
sthenexthopbefore*anyapplicationofpolicy.*/{structecommunity_valvnc_gateway_magi
c;uint16_tlocaladmin;/*Usingrouteoriginextendedcommunitytype*/memset(&vnc_gatewa
y_magic,0,sizeof(vnc_gateway_magic));vnc_gateway_magic.val[0]=0x01;vnc_gateway_m
agic.val[1]=0x03;/*OnlyworksforIPv4nexthops*/if(prefix->family==AF_INET){memcpy(
vnc_gateway_magic.val+2,&unicast_nexthop->u.prefix4,4);}localadmin=htons(hc->res
olve_nve_roo_local_admin);memcpy(vnc_gateway_magic.val+6,(char*)&localadmin,2);e
community_add_val(*ecom,&vnc_gateway_magic);}return0;}staticvoidvnc_import_bgp_a
dd_route_mode_resolve_nve_one_bi(structbgp*bgp,afi_tafi,structbgp_info*bi,/*VPNb
i*/structprefix_rd*prd,/*RD*/structprefix*prefix,/*unicastrouteprefix*/uint32_t*
local_pref,/*NULL=nolocal_pref*/uint32_t*med,/*NULL=nomed*/structecommunity*ecom
)/*generatedecoms*/{structprefixun;structprefixnexthop;structrfapi_ip_addrnextho
p_h;uint32_tlifetime;uint32_t*plifetime;structbgp_attr_encap_subtlv*encaptlvs;ui
nt32_tlabel=0;structrfapi_un_optionoptary[3];structrfapi_un_option*opt=NULL;intc
ur_opt=0;vnc_zlog_debug_verbose("%s:entry",__func__);if(bi->type!=ZEBRA_ROUTE_BG
P&&bi->type!=ZEBRA_ROUTE_BGP_DIRECT){return;}if(bi->sub_type!=BGP_ROUTE_NORMAL&&
bi->sub_type!=BGP_ROUTE_STATIC&&bi->sub_type!=BGP_ROUTE_RFP){return;}if(CHECK_FL
AG(bi->flags,BGP_INFO_REMOVED))return;vncHDResolveNve.peer=bi->peer;if(!rfapiGet
VncTunnelUnAddr(bi->attr,&un)){if(rfapiQprefix2Raddr(&un,&vncHDResolveNve.un_add
r))return;}else{memset(&vncHDResolveNve.un_addr,0,sizeof(vncHDResolveNve.un_addr
));}/*UsenexthopofVPNrouteasnexthopofconstructedroute*/rfapiNexthop2Prefix(bi->a
ttr,&nexthop);rfapiQprefix2Raddr(&nexthop,&nexthop_h);if(rfapiGetVncLifetime(bi-
>attr,&lifetime)){plifetime=NULL;}else{plifetime=&lifetime;}if(bi->attr){encaptl
vs=bi->attr->vnc_subtlvs;if(bi->attr->encap_tunneltype!=BGP_ENCAP_TYPE_RESERVED&
&bi->attr->encap_tunneltype!=BGP_ENCAP_TYPE_MPLS){if(opt!=NULL)opt->next=&optary
[cur_opt];opt=&optary[cur_opt++];memset(opt,0,sizeof(structrfapi_un_option));opt
->type=RFAPI_UN_OPTION_TYPE_TUNNELTYPE;opt->v.tunnel.type=bi->attr->encap_tunnel
type;/*TBDparsebi->attr->extra->encap_subtlvs*/}}else{encaptlvs=NULL;}structecom
munity*new_ecom=ecommunity_dup(ecom);if(bi->attr&&bi->attr->ecommunity)ecommunit
y_merge(new_ecom,bi->attr->ecommunity);if(bi->extra)label=decode_label(&bi->extr
a->label[0]);add_vnc_route(&vncHDResolveNve,bgp,SAFI_MPLS_VPN,prefix,/*unicastro
uteprefix*/prd,&nexthop_h,/*newnexthop*/local_pref,plifetime,(structbgp_tea_opti
ons*)encaptlvs,/*RFPoptions*/opt,NULL,new_ecom,med,/*NULL=>don'tsetmed*/(label?&
label:NULL),/*NULL=default*/ZEBRA_ROUTE_BGP_DIRECT,BGP_ROUTE_REDISTRIBUTE,RFAPI_
AHR_RFPOPT_IS_VNCTLV);/*flags*/ecommunity_free(&new_ecom);}staticvoidvnc_import_
bgp_add_route_mode_resolve_nve_one_rd(structprefix_rd*prd,/*RD*/structbgp_table*
table_rd,/*per-rdVPNroutetable*/afi_tafi,structbgp*bgp,structprefix*prefix,/*uni
castprefix*/structecommunity*ecom,/*generatedecoms*/uint32_t*local_pref,/*NULL=n
olocal_pref*/uint32_t*med,/*NULL=nomed*/structprefix*ubi_nexthop)/*unicastnextho
p*/{structbgp_node*bn;structbgp_info*bi;if(!table_rd)return;{charstr_nh[PREFIX_S
TRLEN];prefix2str(ubi_nexthop,str_nh,sizeof(str_nh));vnc_zlog_debug_verbose("%s:
ubi_nexthop=%s",__func__,str_nh);}/*exactmatch*/bn=bgp_node_lookup(table_rd,ubi_
nexthop);if(!bn){vnc_zlog_debug_verbose("%s:nomatchinRD'stableforubi_nexthop",__
func__);return;}/*Iterateoverbgp_infoitemsatthisnode*/for(bi=bn->info;bi;bi=bi->
next){vnc_import_bgp_add_route_mode_resolve_nve_one_bi(bgp,afi,bi,/*VPNbi*/prd,p
refix,local_pref,med,ecom);}bgp_unlock_node(bn);}staticvoidvnc_import_bgp_add_ro
ute_mode_resolve_nve(structbgp*bgp,structprefix*prefix,/*unicastprefix*/structbg
p_info*info)/*unicastinfo*/{afi_tafi=family2afi(prefix->family);structrfapi_cfg*
hc=NULL;structprefixpfx_unicast_nexthop={0};/*happyvalgrind*/structecommunity*ec
om=NULL;uint32_tlocal_pref;uint32_t*med=NULL;structprefix_bag*pb;structbgp_node*
bnp;/*prdtablenode*//*debugging*/if(VNC_DEBUG(VERBOSE)){charstr_pfx[PREFIX_STRLE
N];charstr_nh[PREFIX_STRLEN];structprefixnh;prefix2str(prefix,str_pfx,sizeof(str
_pfx));nh.prefixlen=0;rfapiUnicastNexthop2Prefix(afi,info->attr,&nh);if(nh.prefi
xlen){prefix2str(&nh,str_nh,sizeof(str_nh));}else{str_nh[0]='?';str_nh[1]=0;}vnc
_zlog_debug_verbose("%s(bgp=%p,unicastprefix=%s,unicastnh=%s)",__func__,bgp,str_
pfx,str_nh);}if(info->type!=ZEBRA_ROUTE_BGP){vnc_zlog_debug_verbose("%s:unicastt
ype%d=\"%s\"isnot%d=%s,skipping",__func__,info->type,zebra_route_string(info->ty
pe),ZEBRA_ROUTE_BGP,"ZEBRA_ROUTE_BGP");return;}/**Preliminarychecks*/if(!afi){zl
og_err("%s:can'tgetafiofprefix",__func__);return;}if(!(hc=bgp->rfapi_cfg)){vnc_z
log_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__);return;}/*checkvn
credistflagforbgpdirectroutes*/if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BGP_D
IRECT]){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfg->redist[afi=%d][type=ZEBRA_ROU
TE_BGP_DIRECT]is0,skipping",__func__,afi);return;}if(process_unicast_route(bgp,a
fi,prefix,info,&ecom,&pfx_unicast_nexthop)){vnc_zlog_debug_verbose("%s:process_u
nicast_routeerror,skipping",__func__);return;}local_pref=calc_local_pref(info->a
ttr,info->peer);if(info->attr&&(info->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EX
IT_DISC))){med=&info->attr->med;}/**Atthispoint,wehaveallocated:**ecomecommunity
ptr,unionofunicastandROOparts(noNVEpart)**Andwehaveset:**pfx_unicast_nexthopnext
hopofuncastroute*/if(!bgp->rfapi->resolve_nve_nexthop){bgp->rfapi->resolve_nve_n
exthop=skiplist_new(SKIPLIST_FLAG_ALLOW_DUPLICATES,vnc_prefix_cmp,prefix_bag_fre
e);}pb=XCALLOC(MTYPE_RFAPI_PREFIX_BAG,sizeof(structprefix_bag));pb->hpfx=pfx_uni
cast_nexthop;pb->ubi=info;pb->upfx=*prefix;bgp_info_lock(info);/*skiplistreferst
oit*/skiplist_insert(bgp->rfapi->resolve_nve_nexthop,&pb->hpfx,pb);/**Iterateove
rRDsinVPNRIB.ForeachRD,lookupunicastnexthop*(exactmatch,/32).Ifanexactmatchisfou
nd,calladd_vnc_route.*/for(bnp=bgp_table_top(bgp->rib[afi][SAFI_MPLS_VPN]);bnp;b
np=bgp_route_next(bnp)){structbgp_table*table;table=(structbgp_table*)(bnp->info
);if(!table)continue;vnc_import_bgp_add_route_mode_resolve_nve_one_rd((structpre
fix_rd*)&bnp->p,table,afi,bgp,prefix,ecom,&local_pref,med,&pfx_unicast_nexthop);
}if(ecom)ecommunity_free(&ecom);vnc_zlog_debug_verbose("%s:done",__func__);}stat
icvoidvnc_import_bgp_add_route_mode_plain(structbgp*bgp,structprefix*prefix,stru
ctbgp_info*info){afi_tafi=family2afi(prefix->family);structpeer*peer=info->peer;
structattr*attr=info->attr;structattrhattr;structrfapi_cfg*hc=NULL;structattr*ia
ttr=NULL;structrfapi_ip_addrvnaddr;structprefixvn_pfx_space;structprefix*vn_pfx=
NULL;intahr_flags=0;structecommunity*ecom=NULL;structprefix_rdprd;structroute_ma
p*rmap=NULL;uint32_tlocal_pref;uint32_t*med=NULL;{charbuf[PREFIX_STRLEN];prefix2
str(prefix,buf,sizeof(buf));vnc_zlog_debug_verbose("%s(prefix=%s)entry",__func__
,buf);}if(!afi){zlog_err("%s:can'tgetafiofprefix",__func__);return;}if(!(hc=bgp-
>rfapi_cfg)){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__)
;return;}/*checkvncredistflagforbgpdirectroutes*/if(!bgp->rfapi_cfg->redist[afi]
[ZEBRA_ROUTE_BGP_DIRECT]){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfg->redist[afi=
%d][type=ZEBRA_ROUTE_BGP_DIRECT]is0,skipping",__func__,afi);return;}/**mode"plai
n"specificcode*/{vnc_zlog_debug_verbose("%s:NOTusingredistRFG",__func__);/**pref
ixlistcheck*/if(hc->plist_redist[ZEBRA_ROUTE_BGP_DIRECT][afi]){vnc_zlog_debug_ve
rbose("%s:HCprefixlistisset,checking",__func__);if(prefix_list_apply(hc->plist_r
edist[ZEBRA_ROUTE_BGP_DIRECT][afi],prefix)==PREFIX_DENY){vnc_zlog_debug_verbose(
"%s:prefixlistreturnsDENY,blockingroute",__func__);return;}vnc_zlog_debug_verbos
e("%s:prefixlistreturnsPASS,allowingroute",__func__);}/*applyroutemap,ifany,late
r*/rmap=hc->routemap_redist[ZEBRA_ROUTE_BGP_DIRECT];/**Incomingprefixisunicast.I
fv6,itisinmultiprotocol*area,*butifv4itisinattr->nexthop*/rfapiUnicastNexthop2Pr
efix(afi,attr,&vn_pfx_space);vn_pfx=&vn_pfx_space;/*UNaddress*/ahr_flags|=RFAPI_
AHR_NO_TUNNEL_SUBTLV;}if(VNC_DEBUG(IMPORT_BGP_ADD_ROUTE)){charbuf[PREFIX_STRLEN]
;prefix2str(vn_pfx,buf,sizeof(buf));vnc_zlog_debug_any("%svn_pfx=%s",__func__,bu
f);}/**ComputeVNaddress*/if(rfapiQprefix2Raddr(vn_pfx,&vnaddr)){vnc_zlog_debug_v
erbose("%s:redistVNinvalid,skipping",__func__);return;}/**routemaphandling*Thisc
odeisherebecauseitallocatesaninternedattrwhich*mustbefreedbeforewereturn.It'seas
iertoputitafter*allofthepossiblereturnsabove.*/memset(&hattr,0,sizeof(structattr
));bgp_attr_dup(&hattr,attr);/*hattrbecomesaghostattr*/if(rmap){structbgp_infoin
fo;route_map_result_tret;memset(&info,0,sizeof(info));info.peer=peer;info.attr=&
hattr;ret=route_map_apply(rmap,prefix,RMAP_BGP,&info);if(ret==RMAP_DENYMATCH){bg
p_attr_flush(&hattr);vnc_zlog_debug_verbose("%s:routemap\"%s\"saysDENY,returning
",__func__,rmap->name);return;}}iattr=bgp_attr_intern(&hattr);bgp_attr_flush(&ha
ttr);/*Nowiattrisanallocatedinternedattr*//**Mode"plain"specificcode**SetsRDindu
mmyHD*Allocatesecom*/{if(vnaddr.addr_family!=AF_INET){vnc_zlog_debug_verbose("%s
:can'tauto-assignRD,VNAF(%d)isnotIPv4,skipping",__func__,vnaddr.addr_family);if(
iattr){bgp_attr_unintern(&iattr);}return;}memset(&prd,0,sizeof(prd));rfapi_set_a
utord_from_vn(&prd,&vnaddr);if(iattr&&iattr->ecommunity)ecom=ecommunity_dup(iatt
r->ecommunity);}local_pref=calc_local_pref(iattr,peer);if(iattr&&(iattr->flag&AT
TR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC))){med=&iattr->med;}if(VNC_DEBUG(IMPORT_BGP
_ADD_ROUTE)){charbuf[PREFIX_STRLEN];rfapiRfapiIpAddr2Str(&vnaddr,buf,sizeof(buf)
);vnc_zlog_debug_any("%s:settingvnaddrto%s",__func__,buf);}vncHDBgpDirect.peer=p
eer;add_vnc_route(&vncHDBgpDirect,bgp,SAFI_MPLS_VPN,prefix,&prd,&vnaddr,&local_p
ref,&(bgp->rfapi_cfg->redist_lifetime),NULL,/*RFPoptions*/NULL,NULL,ecom,med,/*m
ed*/NULL,/*label:default*/ZEBRA_ROUTE_BGP_DIRECT,BGP_ROUTE_REDISTRIBUTE,ahr_flag
s);vncHDBgpDirect.peer=NULL;if(ecom)ecommunity_free(&ecom);}staticvoidvnc_import
_bgp_add_route_mode_nvegroup(structbgp*bgp,structprefix*prefix,structbgp_info*in
fo,structrfapi_nve_group_cfg*rfg){afi_tafi=family2afi(prefix->family);structpeer
*peer=info->peer;structattr*attr=info->attr;structattrhattr;structrfapi_cfg*hc=N
ULL;structattr*iattr=NULL;structrfapi_ip_addrvnaddr;structprefix*vn_pfx=NULL;int
ahr_flags=0;structecommunity*ecom=NULL;structprefix_rdprd;structroute_map*rmap=N
ULL;uint32_tlocal_pref;{charbuf[PREFIX_STRLEN];prefix2str(prefix,buf,sizeof(buf)
);vnc_zlog_debug_verbose("%s(prefix=%s)entry",__func__,buf);}assert(rfg);if(!afi
){zlog_err("%s:can'tgetafiofprefix",__func__);return;}if(!(hc=bgp->rfapi_cfg)){v
nc_zlog_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__);return;}/*che
ckvncredistflagforbgpdirectroutes*/if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_B
GP_DIRECT]){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfg->redist[afi=%d][type=ZEBRA
_ROUTE_BGP_DIRECT]is0,skipping",__func__,afi);return;}/**RFG-specificcode*/{stru
ctrfapi_ip_prefixpfx_un;vnc_zlog_debug_verbose("%s:usingredistRFG",__func__);/**
RFGprefixlistcheck*/if(rfg->plist_redist[ZEBRA_ROUTE_BGP_DIRECT][afi]){vnc_zlog_
debug_verbose("%s:RFGprefixlistisset,checking",__func__);if(prefix_list_apply(rf
g->plist_redist[ZEBRA_ROUTE_BGP_DIRECT][afi],prefix)==PREFIX_DENY){vnc_zlog_debu
g_verbose("%s:prefixlistreturnsDENY,blockingroute",__func__);return;}vnc_zlog_de
bug_verbose("%s:prefixlistreturnsPASS,allowingroute",__func__);}/*applyroutemap,
ifany,later*/rmap=rfg->routemap_redist[ZEBRA_ROUTE_BGP_DIRECT];/**exportnvegroup
'sVNaddrprefixmustbea/32which*willyieldtheVNaddrtouse*/vn_pfx=&rfg->vn_prefix;/*
*UNAddress*/if(!is_host_prefix(&rfg->un_prefix)){/*NBprefixlen==0meansithasnotbe
enconfigured*/vnc_zlog_debug_verbose("%s:redistRFGUNpfxnothostpfx(plen=%d),skipp
ing",__func__,rfg->un_prefix.prefixlen);return;}rfapiQprefix2Rprefix(&rfg->un_pr
efix,&pfx_un);vncHDBgpDirect.un_addr=pfx_un.prefix;}if(VNC_DEBUG(IMPORT_BGP_ADD_
ROUTE)){charbuf[PREFIX_STRLEN];prefix2str(vn_pfx,buf,sizeof(buf));vnc_zlog_debug
_any("%svn_pfx=%s",__func__,buf);}/**ComputeVNaddress*/if(rfapiQprefix2Raddr(vn_
pfx,&vnaddr)){vnc_zlog_debug_verbose("%s:redistVNinvalid,skipping",__func__);ret
urn;}/**routemaphandling*Thiscodeisherebecauseitallocatesaninternedattrwhich*mus
tbefreedbeforewereturn.It'seasiertoputitafter*allofthepossiblereturnsabove.*/mem
set(&hattr,0,sizeof(structattr));bgp_attr_dup(&hattr,attr);/*hattrbecomesaghosta
ttr*/if(rmap){structbgp_infoinfo;route_map_result_tret;memset(&info,0,sizeof(inf
o));info.peer=peer;info.attr=&hattr;ret=route_map_apply(rmap,prefix,RMAP_BGP,&in
fo);if(ret==RMAP_DENYMATCH){bgp_attr_flush(&hattr);vnc_zlog_debug_verbose("%s:ro
utemap\"%s\"saysDENY,returning",__func__,rmap->name);return;}}iattr=bgp_attr_int
ern(&hattr);bgp_attr_flush(&hattr);/*Nowiattrisanallocatedinternedattr*//**RFG-s
pecificcode**SetsRDindummyHD*Allocatesecom*/{memset(&prd,0,sizeof(prd));prd=rfg-
>rd;prd.family=AF_UNSPEC;prd.prefixlen=64;if(rfg->rd.family==AF_UNIX){rfapi_set_
autord_from_vn(&prd,&vnaddr);}if(rfg->rt_export_list)ecom=ecommunity_dup(bgp->rf
api_cfg->rfg_redist->rt_export_list);elseecom=ecommunity_new();if(iattr&&iattr->
ecommunity)ecom=ecommunity_merge(ecom,iattr->ecommunity);}local_pref=calc_local_
pref(iattr,peer);if(VNC_DEBUG(IMPORT_BGP_ADD_ROUTE)){charbuf[BUFSIZ];buf[0]=0;rf
apiRfapiIpAddr2Str(&vnaddr,buf,BUFSIZ);buf[BUFSIZ-1]=0;vnc_zlog_debug_any("%s:se
ttingvnaddrto%s",__func__,buf);}vncHDBgpDirect.peer=peer;add_vnc_route(&vncHDBgp
Direct,bgp,SAFI_MPLS_VPN,prefix,&prd,&vnaddr,&local_pref,&(bgp->rfapi_cfg->redis
t_lifetime),NULL,/*RFPoptions*/NULL,NULL,ecom,NULL,/*med*/NULL,/*label:default*/
ZEBRA_ROUTE_BGP_DIRECT,BGP_ROUTE_REDISTRIBUTE,ahr_flags);vncHDBgpDirect.peer=NUL
L;if(ecom)ecommunity_free(&ecom);}staticvoidvnc_import_bgp_del_route_mode_plain(
structbgp*bgp,structprefix*prefix,structbgp_info*info){structprefix_rdprd;afi_ta
fi=family2afi(prefix->family);structprefix*vn_pfx=NULL;structrfapi_ip_addrvnaddr
;structprefixvn_pfx_space;assert(afi);/**ComputeVNaddress*/if(info&&info->attr){
rfapiUnicastNexthop2Prefix(afi,info->attr,&vn_pfx_space);}else{vnc_zlog_debug_ve
rbose("%s:noattr,can'tdeleteroute",__func__);return;}vn_pfx=&vn_pfx_space;vnaddr
.addr_family=vn_pfx->family;switch(vn_pfx->family){caseAF_INET:if(vn_pfx->prefix
len!=32){vnc_zlog_debug_verbose("%s:redistVNplen(%d)!=32,skipping",__func__,vn_p
fx->prefixlen);return;}vnaddr.addr.v4=vn_pfx->u.prefix4;break;caseAF_INET6:if(vn
_pfx->prefixlen!=128){vnc_zlog_debug_verbose("%s:redistVNplen(%d)!=128,skipping"
,__func__,vn_pfx->prefixlen);return;}vnaddr.addr.v6=vn_pfx->u.prefix6;break;defa
ult:vnc_zlog_debug_verbose("%s:noredistRFGVNhostpfxconfigured,skipping",__func__
);return;}memset(&prd,0,sizeof(prd));if(rfapi_set_autord_from_vn(&prd,&vnaddr)){
vnc_zlog_debug_verbose("%s:can'tauto-assignRD,skipping",__func__);return;}vncHDB
gpDirect.peer=info->peer;vnc_zlog_debug_verbose("%s:settingpeerto%p",__func__,vn
cHDBgpDirect.peer);del_vnc_route(&vncHDBgpDirect,info->peer,bgp,SAFI_MPLS_VPN,pr
efix,&prd,ZEBRA_ROUTE_BGP_DIRECT,BGP_ROUTE_REDISTRIBUTE,NULL,1);vncHDBgpDirect.p
eer=NULL;}staticvoidvnc_import_bgp_del_route_mode_nvegroup(structbgp*bgp,structp
refix*prefix,structbgp_info*info){structprefix_rdprd;afi_tafi=family2afi(prefix-
>family);structrfapi_nve_group_cfg*rfg=NULL;structprefix*vn_pfx=NULL;structrfapi
_ip_addrvnaddr;assert(afi);rfg=bgp->rfapi_cfg->rfg_redist;assert(rfg);/**Compute
VNaddress*//**exportnvegroup'sVNaddrprefixmustbea/32which*willyieldtheVNaddrtous
e*/vn_pfx=&rfg->vn_prefix;vnaddr.addr_family=vn_pfx->family;switch(vn_pfx->famil
y){caseAF_INET:if(vn_pfx->prefixlen!=32){vnc_zlog_debug_verbose("%s:redistVNplen
(%d)!=32,skipping",__func__,vn_pfx->prefixlen);return;}vnaddr.addr.v4=vn_pfx->u.
prefix4;break;caseAF_INET6:if(vn_pfx->prefixlen!=128){vnc_zlog_debug_verbose("%s
:redistVNplen(%d)!=128,skipping",__func__,vn_pfx->prefixlen);return;}vnaddr.addr
.v6=vn_pfx->u.prefix6;break;default:vnc_zlog_debug_verbose("%s:noredistRFGVNhost
pfxconfigured,skipping",__func__);return;}memset(&prd,0,sizeof(prd));prd=rfg->rd
;prd.family=AF_UNSPEC;prd.prefixlen=64;if(rfg->rd.family==AF_UNIX){/*means"auto"
withVNaddr*/if(rfapi_set_autord_from_vn(&prd,&vnaddr)){vnc_zlog_debug_verbose("%
s:can'tauto-assignRD,skipping",__func__);return;}}vncHDBgpDirect.peer=info->peer
;vnc_zlog_debug_verbose("%s:settingpeerto%p",__func__,vncHDBgpDirect.peer);del_v
nc_route(&vncHDBgpDirect,info->peer,bgp,SAFI_MPLS_VPN,prefix,&prd,ZEBRA_ROUTE_BG
P_DIRECT,BGP_ROUTE_REDISTRIBUTE,NULL,1);vncHDBgpDirect.peer=NULL;}staticvoidvnc_
import_bgp_del_route_mode_resolve_nve_one_bi(structbgp*bgp,afi_tafi,structbgp_in
fo*bi,/*VPNbi*/structprefix_rd*prd,/*RD*/structprefix*prefix)/*unicastrouteprefi
x*/{structprefixun;if(bi->type!=ZEBRA_ROUTE_BGP&&bi->type!=ZEBRA_ROUTE_BGP_DIREC
T){return;}if(bi->sub_type!=BGP_ROUTE_NORMAL&&bi->sub_type!=BGP_ROUTE_STATIC&&bi
->sub_type!=BGP_ROUTE_RFP){return;}if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))ret
urn;vncHDResolveNve.peer=bi->peer;if(!rfapiGetVncTunnelUnAddr(bi->attr,&un)){if(
rfapiQprefix2Raddr(&un,&vncHDResolveNve.un_addr))return;}else{memset(&vncHDResol
veNve.un_addr,0,sizeof(vncHDResolveNve.un_addr));}del_vnc_route(&vncHDResolveNve
,vncHDResolveNve.peer,bgp,SAFI_MPLS_VPN,prefix,/*unicastrouteprefix*/prd,ZEBRA_R
OUTE_BGP_DIRECT,BGP_ROUTE_REDISTRIBUTE,NULL,0);/*flags*/}staticvoidvnc_import_bg
p_del_route_mode_resolve_nve_one_rd(structprefix_rd*prd,structbgp_table*table_rd
,/*per-rdVPNroutetable*/afi_tafi,structbgp*bgp,structprefix*prefix,/*unicastpref
ix*/structprefix*ubi_nexthop)/*unicastbi'snexthop*/{structbgp_node*bn;structbgp_
info*bi;if(!table_rd)return;{charstr_nh[PREFIX_STRLEN];prefix2str(ubi_nexthop,st
r_nh,sizeof(str_nh));vnc_zlog_debug_verbose("%s:ubi_nexthop=%s",__func__,str_nh)
;}/*exactmatch*/bn=bgp_node_lookup(table_rd,ubi_nexthop);if(!bn){vnc_zlog_debug_
verbose("%s:nomatchinRD'stableforubi_nexthop",__func__);return;}/*Iterateoverbgp
_infoitemsatthisnode*/for(bi=bn->info;bi;bi=bi->next){vnc_import_bgp_del_route_m
ode_resolve_nve_one_bi(bgp,afi,bi,/*VPNbi*/prd,/*VPNRD*/prefix);/*unicastroutepr
efix*/}bgp_unlock_node(bn);}staticvoidvnc_import_bgp_del_route_mode_resolve_nve(
structbgp*bgp,afi_tafi,structprefix*prefix,structbgp_info*info){structecommunity
*ecom=NULL;structprefixpfx_unicast_nexthop={0};/*happyvalgrind*///structlistnode
*hnode;//structrfapi_descriptor*rfd;structprefix_bag*pb;void*cursor;structskipli
st*sl=bgp->rfapi->resolve_nve_nexthop;intrc;structbgp_node*bnp;/*prdtablenode*/i
f(!sl){vnc_zlog_debug_verbose("%s:noRHNentries,skipping",__func__);return;}if(in
fo->type!=ZEBRA_ROUTE_BGP){vnc_zlog_debug_verbose("%s:unicasttype%d=\"%s\"isnot%
d=%s,skipping",__func__,info->type,zebra_route_string(info->type),ZEBRA_ROUTE_BG
P,"ZEBRA_ROUTE_BGP");return;}if(process_unicast_route(bgp,afi,prefix,info,&ecom,
&pfx_unicast_nexthop)){vnc_zlog_debug_verbose("%s:process_unicast_routeerror,ski
pping",__func__);return;}rc=skiplist_first_value(sl,&pfx_unicast_nexthop,(void*)
&pb,&cursor);while(!rc){if(pb->ubi==info){skiplist_delete(sl,&pfx_unicast_nextho
p,pb);bgp_info_unlock(info);break;}rc=skiplist_next_value(sl,&pfx_unicast_nextho
p,(void*)&pb,&cursor);}/**IterateoverRDsinVPNRIB.ForeachRD,lookupunicastnexthop*
(exactmatch,/32).Ifanexactmatchisfound,calladd_vnc_route.*/for(bnp=bgp_table_top
(bgp->rib[afi][SAFI_MPLS_VPN]);bnp;bnp=bgp_route_next(bnp)){structbgp_table*tabl
e;table=(structbgp_table*)(bnp->info);if(!table)continue;vnc_import_bgp_del_rout
e_mode_resolve_nve_one_rd((structprefix_rd*)&bnp->p,table,afi,bgp,prefix,&pfx_un
icast_nexthop);/*TBDhowisthisset?*/}if(ecom)ecommunity_free(&ecom);}/***********
*************************************************************Add/DeleteCE->NVEro
utes***********************************************************************//**S
houldbecalledwhanabiisaddedtoVPNRIB.Thisfunction*willcheckifitisahostrouteandret
urnimmediatelyifnot.*/voidvnc_import_bgp_add_vnc_host_route_mode_resolve_nve(str
uctbgp*bgp,structprefix_rd*prd,/*RD*/structbgp_table*table_rd,/*per-rdVPNrouteta
ble*/structprefix*prefix,/*VPNprefix*/structbgp_info*bi)/*newVPNhostroute*/{afi_
tafi=family2afi(prefix->family);structskiplist*sl=NULL;intrc;structprefix_bag*pb
;void*cursor;structrfapi_cfg*hc=NULL;vnc_zlog_debug_verbose("%s:entry",__func__)
;if(afi!=AFI_IP&&afi!=AFI_IP6){vnc_zlog_debug_verbose("%s:badafi%d,skipping",__f
unc__,afi);return;}if(!(hc=bgp->rfapi_cfg)){vnc_zlog_debug_verbose("%s:bgp->rfap
i_cfgisNULL,skipping",__func__);return;}/*checkvncredistflagforbgpdirectroutes*/
if(!hc->redist[afi][ZEBRA_ROUTE_BGP_DIRECT]){vnc_zlog_debug_verbose("%s:bgp->rfa
pi_cfg->redist[afi=%d][type=ZEBRA_ROUTE_BGP_DIRECT]is0,skipping",__func__,afi);r
eturn;}if(hc->redist_mode!=VNC_REDIST_MODE_RESOLVE_NVE){vnc_zlog_debug_verbose("
%s:notinresolve-nvemode,skipping",__func__);return;}if(bgp->rfapi)sl=bgp->rfapi-
>resolve_nve_nexthop;if(!sl){vnc_zlog_debug_verbose("%s:noresolve_nve_nexthopski
plist,skipping",__func__);return;}if(!is_host_prefix(prefix)){vnc_zlog_debug_ver
bose("%s:nothostprefix,skipping",__func__);return;}rc=skiplist_first_value(sl,pr
efix,(void*)&pb,&cursor);while(!rc){structecommunity*ecom;structprefixpfx_unicas
t_nexthop;uint32_t*med=NULL;uint32_tlocal_pref;memset(&pfx_unicast_nexthop,0,siz
eof(structprefix));/*keepvalgrindhappy*/if(VNC_DEBUG(IMPORT_BGP_ADD_ROUTE)){char
hbuf[PREFIX_STRLEN];charubuf[PREFIX_STRLEN];prefix2str(&pb->hpfx,hbuf,sizeof(hbu
f));prefix2str(&pb->upfx,ubuf,sizeof(ubuf));vnc_zlog_debug_any("%s:examiningRHNE
ntry(q=%p):upfx=%s,hpfx=%s,ubi=%p",__func__,cursor,ubuf,hbuf,pb->ubi);}if(proces
s_unicast_route(bgp,afi,&pb->upfx,pb->ubi,&ecom,&pfx_unicast_nexthop)){vnc_zlog_
debug_verbose("%s:process_unicast_routeerror,skipping",__func__);continue;}local
_pref=calc_local_pref(pb->ubi->attr,pb->ubi->peer);if(pb->ubi->attr&&(pb->ubi->a
ttr->flag&ATTR_FLAG_BIT(BGP_ATTR_MULTI_EXIT_DISC))){med=&pb->ubi->attr->med;}/**
Sanitycheck*/if(vnc_prefix_cmp(&pfx_unicast_nexthop,prefix)){charstr_unh[PREFIX_
STRLEN];charstr_nve_pfx[PREFIX_STRLEN];prefix2str(&pfx_unicast_nexthop,str_unh,s
izeof(str_unh));prefix2str(prefix,str_nve_pfx,sizeof(str_nve_pfx));vnc_zlog_debu
g_verbose("%s:FATAL:resolve_nve_nexthoplistitembinexthop%s!=nvepfx%s",__func__,s
tr_unh,str_nve_pfx);assert(0);}vnc_import_bgp_add_route_mode_resolve_nve_one_bi(
bgp,afi,bi,/*VPNbi*/prd,&pb->upfx,/*unicastprefix*/&local_pref,med,ecom);if(ecom
)ecommunity_free(&ecom);#ifDEBUG_RHN_LIST/*debug*/{charpbuf[PREFIX_STRLEN];prefi
x2str(prefix,pbuf,sizeof(pbuf));vnc_zlog_debug_verbose("%s:advancingpastRHNEntry
(q=%p):withprefix%s",__func__,cursor,pbuf);print_rhn_list(__func__,NULL);/*debug
*/}#endifrc=skiplist_next_value(sl,prefix,(void*)&pb,&cursor);}vnc_zlog_debug_ve
rbose("%s:done",__func__);}voidvnc_import_bgp_del_vnc_host_route_mode_resolve_nv
e(structbgp*bgp,structprefix_rd*prd,/*RD*/structbgp_table*table_rd,/*per-rdVPNro
utetable*/structprefix*prefix,/*VPNprefix*/structbgp_info*bi)/*oldVPNhostroute*/
{afi_tafi=family2afi(prefix->family);structskiplist*sl=NULL;structprefix_bag*pb;
void*cursor;structrfapi_cfg*hc=NULL;intrc;{charstr_pfx[PREFIX_STRLEN];prefix2str
(prefix,str_pfx,sizeof(str_pfx));vnc_zlog_debug_verbose("%s(bgp=%p,nveprefix=%s)
",__func__,bgp,str_pfx);}if(afi!=AFI_IP&&afi!=AFI_IP6)return;if(!(hc=bgp->rfapi_
cfg)){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__);return
;}/*checkvncredistflagforbgpdirectroutes*/if(!hc->redist[afi][ZEBRA_ROUTE_BGP_DI
RECT]){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfg->redist[afi=%d][type=ZEBRA_ROUT
E_BGP_DIRECT]is0,skipping",__func__,afi);return;}if(hc->redist_mode!=VNC_REDIST_
MODE_RESOLVE_NVE){vnc_zlog_debug_verbose("%s:notinresolve-nvemode,skipping",__fu
nc__);return;}if(bgp->rfapi)sl=bgp->rfapi->resolve_nve_nexthop;if(!sl){vnc_zlog_
debug_verbose("%s:noRHNentries,skipping",__func__);return;}if(!is_host_prefix(pr
efix)){vnc_zlog_debug_verbose("%s:nothostroute,skip",__func__);return;}/**Findal
lentrieswithkey==CEintheRHNlist*/rc=skiplist_first_value(sl,prefix,(void*)&pb,&c
ursor);while(!rc){structecommunity*ecom;structprefixpfx_unicast_nexthop;memset(&
pfx_unicast_nexthop,0,sizeof(structprefix));/*keepvalgrindhappy*/if(process_unic
ast_route(bgp,afi,&pb->upfx,pb->ubi,&ecom,&pfx_unicast_nexthop)){vnc_zlog_debug_
verbose("%s:process_unicast_routeerror,skipping",__func__);continue;}/**Sanitych
eck*/if(vnc_prefix_cmp(&pfx_unicast_nexthop,prefix)){charstr_unh[PREFIX_STRLEN];
charstr_nve_pfx[PREFIX_STRLEN];prefix2str(&pfx_unicast_nexthop,str_unh,sizeof(st
r_unh));prefix2str(prefix,str_nve_pfx,sizeof(str_nve_pfx));vnc_zlog_debug_verbos
e("%s:FATAL:resolve_nve_nexthoplistitembinexthop%s!=nvepfx%s",__func__,str_unh,s
tr_nve_pfx);assert(0);}vnc_import_bgp_del_route_mode_resolve_nve_one_bi(bgp,afi,
bi,prd,&pb->upfx);if(ecom)ecommunity_free(&ecom);rc=skiplist_next_value(sl,prefi
x,(void*)&pb,&cursor);}}/*******************************************************
*****************ExteriorRoutes*************************************************
**********************/#defineDEBUG_IS_USABLE_INTERIOR1staticintis_usable_interi
or_route(structbgp_info*bi_interior){if(!VALID_INTERIOR_TYPE(bi_interior->type))
{#ifDEBUG_IS_USABLE_INTERIORvnc_zlog_debug_verbose("%s:NO:type%disnotvalidinteri
ortype",__func__,bi_interior->type);#endifreturn0;}if(!CHECK_FLAG(bi_interior->f
lags,BGP_INFO_VALID)){#ifDEBUG_IS_USABLE_INTERIORvnc_zlog_debug_verbose("%s:NO:B
GP_INFO_VALIDnotset",__func__);#endifreturn0;}return1;}/**Thereshouldbeonlyoneof
theseperprefixatatime.*Thisshouldbecalledasaresultofselectionoperation**NBshould
becalledespaciallyforbgpinstancesthatarenamed,*becausetheexteriorrouteswillalway
scomefromoneofthose.*Wefilterhereontheinstancenametomakesurewegetonlythe*rightro
utes.*/staticvoidvnc_import_bgp_exterior_add_route_it(structbgp*bgp,/*exteriorin
stance,wehope*/structprefix*prefix,/*unicastprefix*/structbgp_info*info,/*unicas
tinfo*/structrfapi_import_table*it_only)/*NULL,orlimittothisIT*/{structrfapi*h;s
tructrfapi_cfg*hc;structprefixpfx_orig_nexthop;structrfapi_import_table*it;struc
tbgp*bgp_default=bgp_get_default();afi_tafi=family2afi(prefix->family);if(!bgp_d
efault)return;h=bgp_default->rfapi;hc=bgp_default->rfapi_cfg;vnc_zlog_debug_verb
ose("%s:entrywithit=%p",__func__,it_only);if(!h||!hc){vnc_zlog_debug_verbose("%s
:rfapiorrfapi_cfgnotinstantiated,skipping",__func__);return;}if(!hc->redist_bgp_
exterior_view){vnc_zlog_debug_verbose("%s:exteriorviewnotset,skipping",__func__)
;return;}if(bgp!=hc->redist_bgp_exterior_view){vnc_zlog_debug_verbose("%s:bgp%p!
=hc->redist_bgp_exterior_view%p,skipping",__func__,bgp,hc->redist_bgp_exterior_v
iew);return;}if(!hc->redist[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT]){vnc_zlog_debug_ver
bose("%s:redistofexteriorroutesnotenabled,skipping",__func__);return;}if(!info->
attr){vnc_zlog_debug_verbose("%s:noinfo,skipping",__func__);return;}/**Extractne
xthopfromexteriorroute**Incomingprefixisunicast.Ifv6,itisinmultiprotocolarea,*bu
tifv4itisinattr->nexthop*/rfapiUnicastNexthop2Prefix(afi,info->attr,&pfx_orig_ne
xthop);for(it=h->imports;it;it=it->next){structroute_table*table;structroute_nod
e*rn;structroute_node*par;structbgp_info*bi_interior;inthave_usable_route;vnc_zl
og_debug_verbose("%s:doingit%p",__func__,it);if(it_only&&(it_only!=it)){vnc_zlog
_debug_verbose("%s:doesn'tmatchit_only%p",__func__,it_only);continue;}table=it->
imported_vpn[afi];for(rn=route_node_match(table,&pfx_orig_nexthop),have_usable_r
oute=0;(!have_usable_route)&&rn;){vnc_zlog_debug_verbose("%s:it%ptryingrn%p",__f
unc__,it,rn);for(bi_interior=rn->info;bi_interior;bi_interior=bi_interior->next)
{structprefix_rd*prd;structattrnew_attr;uint32_tlabel=0;if(!is_usable_interior_r
oute(bi_interior))continue;vnc_zlog_debug_verbose("%s:usable:bi_interior%p",__fu
nc__,bi_interior);/**havealegitimateroutetoexterior'snexthop*viaNVE.**Importunic
astroutetotheimporttable*/have_usable_route=1;if(bi_interior->extra){prd=&bi_int
erior->extra->vnc.import.rd;label=decode_label(&bi_interior->extra->label[0]);}e
lseprd=NULL;/*uselocal_preffromunicastroute*/memset(&new_attr,0,sizeof(structatt
r));bgp_attr_dup(&new_attr,bi_interior->attr);if(info->attr->flag&ATTR_FLAG_BIT(
BGP_ATTR_LOCAL_PREF)){new_attr.local_pref=info->attr->local_pref;new_attr.flag|=
ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);}rfapiBgpInfoFilteredImportVPN(it,FIF_ACTION_
UPDATE,bi_interior->peer,NULL,/*rfd*/prefix,NULL,afi,prd,&new_attr,ZEBRA_ROUTE_B
GP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);}if(have_usable_route){/**Makemonit
or**TBDfactorthisoutintoitsownfunction*/structprefix*pfx_mon=prefix_new();if(!RF
API_MONITOR_EXTERIOR(rn)->source){RFAPI_MONITOR_EXTERIOR(rn)->source=skiplist_ne
w(0,NULL,(void(*)(void*))prefix_free);route_lock_node(rn);/*forskiplist*/}route_
lock_node(rn);/*forskiplistentry*/prefix_copy(pfx_mon,prefix);if(!skiplist_inser
t(RFAPI_MONITOR_EXTERIOR(rn)->source,info,pfx_mon)){bgp_info_lock(info);}}par=rn
->parent;if(par)route_lock_node(par);route_unlock_node(rn);rn=par;}if(rn)route_u
nlock_node(rn);if(!have_usable_route){structprefix*pfx_mon=prefix_new();prefix_c
opy(pfx_mon,prefix);if(!skiplist_insert(it->monitor_exterior_orphans,info,pfx_mo
n)){bgp_info_lock(info);}}}}voidvnc_import_bgp_exterior_add_route(structbgp*bgp,
/*exteriorinstance,wehope*/structprefix*prefix,/*unicastprefix*/structbgp_info*i
nfo)/*unicastinfo*/{vnc_import_bgp_exterior_add_route_it(bgp,prefix,info,NULL);}
/**Thereshouldbeonlyoneoftheseperprefixatatime.*Thisshouldprobablybecalledasares
ultofselectionoperation.**NBshouldbecalledespaciallyforbgpinstancesthatarenamed,
*becausetheexteriorrouteswillalwayscomefromoneofthose.*Wefilterhereontheinstance
nametomakesurewegetonlythe*rightroutes.*/voidvnc_import_bgp_exterior_del_route(s
tructbgp*bgp,structprefix*prefix,/*unicastprefix*/structbgp_info*info)/*unicasti
nfo*/{structrfapi*h;structrfapi_cfg*hc;structrfapi_import_table*it;structprefixp
fx_orig_nexthop;afi_tafi=family2afi(prefix->family);structbgp*bgp_default=bgp_ge
t_default();if(!bgp_default)return;memset(&pfx_orig_nexthop,0,sizeof(structprefi
x));/*keepvalgrindhappy*/h=bgp_default->rfapi;hc=bgp_default->rfapi_cfg;if(!h||!
hc){vnc_zlog_debug_verbose("%s:rfapiorrfapi_cfgnotinstantiated,skipping",__func_
_);return;}if(!hc->redist_bgp_exterior_view){vnc_zlog_debug_verbose("%s:exterior
viewnotset,skipping",__func__);return;}if(bgp!=hc->redist_bgp_exterior_view){vnc
_zlog_debug_verbose("%s:bgp%p!=hc->redist_bgp_exterior_view%p,skipping",__func__
,bgp,hc->redist_bgp_exterior_view);return;}if(!hc->redist[afi][ZEBRA_ROUTE_BGP_D
IRECT_EXT]){vnc_zlog_debug_verbose("%s:redistofexteriorroutesnoenabled,skipping"
,__func__);return;}if(!info->attr){vnc_zlog_debug_verbose("%s:noinfo,skipping",_
_func__);return;}/**Extractnexthopfromexteriorroute**Incomingprefixisunicast.Ifv
6,itisinmultiprotocolarea,*butifv4itisinattr->nexthop*/rfapiUnicastNexthop2Prefi
x(afi,info->attr,&pfx_orig_nexthop);for(it=h->imports;it;it=it->next){structrout
e_table*table;structroute_node*rn;structroute_node*par;structbgp_info*bi_interio
r;inthave_usable_route;table=it->imported_vpn[afi];for(rn=route_node_match(table
,&pfx_orig_nexthop),have_usable_route=0;(!have_usable_route)&&rn;){for(bi_interi
or=rn->info;bi_interior;bi_interior=bi_interior->next){structprefix_rd*prd;uint3
2_tlabel=0;if(!is_usable_interior_route(bi_interior))continue;/**havealegitimate
routetoexterior'snexthop*viaNVE.**Importunicastroutetotheimporttable*/have_usabl
e_route=1;if(bi_interior->extra){prd=&bi_interior->extra->vnc.import.rd;label=de
code_label(&bi_interior->extra->label[0]);}elseprd=NULL;rfapiBgpInfoFilteredImpo
rtVPN(it,FIF_ACTION_KILL,bi_interior->peer,NULL,/*rfd*/prefix,NULL,afi,prd,bi_in
terior->attr,ZEBRA_ROUTE_BGP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);/**Delete
monitor**TBDfactorthisoutintoitsownfunction*/{if(RFAPI_MONITOR_EXTERIOR(rn)->sou
rce){if(!skiplist_delete(RFAPI_MONITOR_EXTERIOR(rn)->source,info,NULL)){bgp_info
_unlock(info);route_unlock_node(rn);/*slentry*/}if(skiplist_empty(RFAPI_MONITOR_
EXTERIOR(rn)->source)){skiplist_free(RFAPI_MONITOR_EXTERIOR(rn)->source);RFAPI_M
ONITOR_EXTERIOR(rn)->source=NULL;route_unlock_node(rn);/*skiplistitself*/}}}}par
=rn->parent;if(par)route_lock_node(par);route_unlock_node(rn);rn=par;}if(rn)rout
e_unlock_node(rn);if(!have_usable_route){if(!skiplist_delete(it->monitor_exterio
r_orphans,info,NULL)){bgp_info_unlock(info);}}}}/**Thisfunctionshouldbecalledaft
eranewinteriorVPNroute*hasbeenaddedtoanimport_table.**NBshouldalsobecalledwhenev
eranexistingvpninteriorroute*becomesvalid(e.g.,valid_interior_countisinremented)
*/voidvnc_import_bgp_exterior_add_route_interior(structbgp*bgp,structrfapi_impor
t_table*it,structroute_node*rn_interior,/*VPNITnode*/structbgp_info*bi_interior)
/*VPNITroute*/{afi_tafi=family2afi(rn_interior->p.family);structroute_node*par;s
tructbgp_info*bi_exterior;structprefix*pfx_exterior;/*exteriorpfx*/void*cursor;i
ntrc;structlist*list_adopted;vnc_zlog_debug_verbose("%s:entry",__func__);if(!is_
usable_interior_route(bi_interior)){vnc_zlog_debug_verbose("%s:notusableinterior
route,skipping",__func__);return;}if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BG
P_DIRECT_EXT]){vnc_zlog_debug_verbose("%s:redistofexteriorroutesnoenabled,skippi
ng",__func__);return;}if(it==bgp->rfapi->it_ce){vnc_zlog_debug_verbose("%s:impor
ttableisit_ce,skipping",__func__);return;}/*debugging*/{charstr_pfx[PREFIX_STRLE
N];prefix2str(&rn_interior->p,str_pfx,sizeof(str_pfx));vnc_zlog_debug_verbose("%
s:interiorprefix=%s,bitype=%d",__func__,str_pfx,bi_interior->type);}if(RFAPI_HAS
_MONITOR_EXTERIOR(rn_interior)){intcount=0;/*debugging*/vnc_zlog_debug_verbose("
%s:hasexteriormonitor;extsrc:%p",__func__,RFAPI_MONITOR_EXTERIOR(rn_interior)->s
ource);/**Thereisamonitorherealready.Therefore,wedonotneed*todoanypulldown.Justc
onstructexteriorroutesbased*onthenewinteriorroute.*/cursor=NULL;for(rc=skiplist_
next(RFAPI_MONITOR_EXTERIOR(rn_interior)->source,(void**)&bi_exterior,(void**)&p
fx_exterior,&cursor);!rc;rc=skiplist_next(RFAPI_MONITOR_EXTERIOR(rn_interior)->s
ource,(void**)&bi_exterior,(void**)&pfx_exterior,&cursor)){structprefix_rd*prd;s
tructattrnew_attr;uint32_tlabel=0;++count;/*debugging*/assert(bi_exterior);asser
t(pfx_exterior);if(bi_interior->extra){prd=&bi_interior->extra->vnc.import.rd;la
bel=decode_label(&bi_interior->extra->label[0]);}elseprd=NULL;/*uselocal_preffro
municastroute*/memset(&new_attr,0,sizeof(structattr));bgp_attr_dup(&new_attr,bi_
interior->attr);if(bi_exterior&&(bi_exterior->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_
LOCAL_PREF))){new_attr.local_pref=bi_exterior->attr->local_pref;new_attr.flag|=A
TTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);}rfapiBgpInfoFilteredImportVPN(it,FIF_ACTION_U
PDATE,bi_interior->peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,&new_attr,ZEBRA_RO
UTE_BGP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);}vnc_zlog_debug_verbose("%s:fi
nishedconstructingexteriorsbasedonexistingmonitors",__func__);return;}vnc_zlog_d
ebug_verbose("%s:noexteriormonitor",__func__);/**Nomonitoratthisnode.Isthisthefi
rstvalidinterior*routeatthisnode?*/if(RFAPI_MONITOR_EXTERIOR(rn_interior)->valid
_interior_count>1){vnc_zlog_debug_verbose("%s:newinteriorroutenotfirstvalidone,s
kippingpulldown",__func__);return;}/**Lookupthetreeforpossiblepulldowncandidates
.*Findnearestparentwithanexteriorroutemonitor*/for(par=rn_interior->parent;par;p
ar=par->parent){if(RFAPI_HAS_MONITOR_EXTERIOR(par))break;}if(par){vnc_zlog_debug
_verbose("%s:checkingparent%pforpossiblepulldowns",__func__,par);/*checkmonitors
atparforpossiblepulldown*/cursor=NULL;for(rc=skiplist_next(RFAPI_MONITOR_EXTERIO
R(par)->source,(void**)&bi_exterior,(void**)&pfx_exterior,&cursor);!rc;rc=skipli
st_next(RFAPI_MONITOR_EXTERIOR(par)->source,(void**)&bi_exterior,(void**)&pfx_ex
terior,&cursor)){structprefixpfx_nexthop;memset(&pfx_nexthop,0,sizeof(structpref
ix));/*keepvalgrindhappy*//*checkoriginalnexthopforprefixmatch*/rfapiUnicastNext
hop2Prefix(afi,bi_exterior->attr,&pfx_nexthop);if(prefix_match(&rn_interior->p,&
pfx_nexthop)){structbgp_info*bi;structprefix_rd*prd;structattrnew_attr;uint32_tl
abel=0;/*dopull-down*//**addmonitortolongerprefix*/structprefix*pfx_mon=prefix_n
ew();prefix_copy(pfx_mon,pfx_exterior);if(!RFAPI_MONITOR_EXTERIOR(rn_interior)->
source){RFAPI_MONITOR_EXTERIOR(rn_interior)->source=skiplist_new(0,NULL,(void(*)
(void*))prefix_free);route_lock_node(rn_interior);}skiplist_insert(RFAPI_MONITOR
_EXTERIOR(rn_interior)->source,bi_exterior,pfx_mon);route_lock_node(rn_interior)
;/**Deleteconstructedexteriorroutesbasedon*parentroutes.*/for(bi=par->info;bi;bi
=bi->next){if(bi->extra){prd=&bi->extra->vnc.import.rd;label=decode_label(&bi->e
xtra->label[0]);}elseprd=NULL;rfapiBgpInfoFilteredImportVPN(it,FIF_ACTION_KILL,b
i->peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,bi->attr,ZEBRA_ROUTE_BGP_DIRECT_EX
T,BGP_ROUTE_REDISTRIBUTE,&label);}/**Addconstructedexteriorroutesbasedon*thenewi
nteriorrouteatlongerprefix.*/if(bi_interior->extra){prd=&bi_interior->extra->vnc
.import.rd;label=decode_label(&bi_interior->extra->label[0]);}elseprd=NULL;/*use
local_preffromunicastroute*/memset(&new_attr,0,sizeof(structattr));bgp_attr_dup(
&new_attr,bi_interior->attr);if(bi_exterior&&(bi_exterior->attr->flag&ATTR_FLAG_
BIT(BGP_ATTR_LOCAL_PREF))){new_attr.local_pref=bi_exterior->attr->local_pref;new
_attr.flag|=ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);}rfapiBgpInfoFilteredImportVPN(it
,FIF_ACTION_UPDATE,bi_interior->peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,&new_
attr,ZEBRA_ROUTE_BGP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);}}/**Theonlymonit
orsatrn_interioraretheonesweaddedjust*above,sowecanusethern_interiorlisttoidenti
fywhich*monitorstodeletefromtheparent.*/cursor=NULL;for(rc=skiplist_next(RFAPI_M
ONITOR_EXTERIOR(rn_interior)->source,(void**)&bi_exterior,NULL,&cursor);!rc;rc=s
kiplist_next(RFAPI_MONITOR_EXTERIOR(rn_interior)->source,(void**)&bi_exterior,NU
LL,&cursor)){skiplist_delete(RFAPI_MONITOR_EXTERIOR(par)->source,bi_exterior,NUL
L);route_unlock_node(par);/*slentry*/}if(skiplist_empty(RFAPI_MONITOR_EXTERIOR(p
ar)->source)){skiplist_free(RFAPI_MONITOR_EXTERIOR(par)->source);RFAPI_MONITOR_E
XTERIOR(par)->source=NULL;route_unlock_node(par);/*slitself*/}}vnc_zlog_debug_ve
rbose("%s:checkingorphans",__func__);/**Seeifanyorphanscanbepulleddowntothecurre
ntnode*/cursor=NULL;list_adopted=NULL;for(rc=skiplist_next(it->monitor_exterior_
orphans,(void**)&bi_exterior,(void**)&pfx_exterior,&cursor);!rc;rc=skiplist_next
(it->monitor_exterior_orphans,(void**)&bi_exterior,(void**)&pfx_exterior,&cursor
)){structprefixpfx_nexthop;charbuf[PREFIX_STRLEN];afi_tafi_exterior=family2afi(p
fx_exterior->family);prefix2str(pfx_exterior,buf,sizeof(buf));vnc_zlog_debug_ver
bose("%s:checkingexteriororphanatprefix%s",__func__,buf);if(afi_exterior!=afi){v
nc_zlog_debug_verbose("%s:exteriororphanafi%d!=interiorafi%d,skip",__func__,afi_
exterior,afi);continue;}/*checkoriginalnexthopforprefixmatch*/rfapiUnicastNextho
p2Prefix(afi,bi_exterior->attr,&pfx_nexthop);if(prefix_match(&rn_interior->p,&pf
x_nexthop)){structprefix_rd*prd;structattrnew_attr;uint32_tlabel=0;/*dopull-down
*//**addmonitortolongerprefix*/structprefix*pfx_mon=prefix_new();prefix_copy(pfx
_mon,pfx_exterior);if(!RFAPI_MONITOR_EXTERIOR(rn_interior)->source){RFAPI_MONITO
R_EXTERIOR(rn_interior)->source=skiplist_new(0,NULL,(void(*)(void*))prefix_free)
;route_lock_node(rn_interior);/*sl*/}skiplist_insert(RFAPI_MONITOR_EXTERIOR(rn_i
nterior)->source,bi_exterior,pfx_mon);route_lock_node(rn_interior);/*slentry*/if
(!list_adopted){list_adopted=list_new();}listnode_add(list_adopted,bi_exterior);
/**Addconstructedexteriorroutesbasedonthe*newinteriorrouteatthelongerprefix.*/if
(bi_interior->extra){prd=&bi_interior->extra->vnc.import.rd;label=decode_label(&
bi_interior->extra->label[0]);}elseprd=NULL;/*uselocal_preffromunicastroute*/mem
set(&new_attr,0,sizeof(structattr));bgp_attr_dup(&new_attr,bi_interior->attr);if
(bi_exterior&&(bi_exterior->attr->flag&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF))){new_
attr.local_pref=bi_exterior->attr->local_pref;new_attr.flag|=ATTR_FLAG_BIT(BGP_A
TTR_LOCAL_PREF);}rfapiBgpInfoFilteredImportVPN(it,FIF_ACTION_UPDATE,bi_interior-
>peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,&new_attr,ZEBRA_ROUTE_BGP_DIRECT_EXT
,BGP_ROUTE_REDISTRIBUTE,&label);}}if(list_adopted){structlistnode*node;structrou
te_node*bi_exterior;for(ALL_LIST_ELEMENTS_RO(list_adopted,node,bi_exterior)){ski
plist_delete(it->monitor_exterior_orphans,bi_exterior,NULL);}list_delete_and_nul
l(&list_adopted);}}/**ThisfunctionshouldbecalledafteraninteriorVPNroute*hasbeend
eletedfromanimport_table.*bi_interiormuststillbevalid,butitmustalreadybedetached
*fromitsroutenodeandtheroutenode'svalid_interior_count*mustalreadybedecremented.
**NBshouldalsobecalledwheneveranexistingvpninteriorroute*becomesinvalid(e.g.,val
id_interior_countisdecremented)*/voidvnc_import_bgp_exterior_del_route_interior(
structbgp*bgp,structrfapi_import_table*it,structroute_node*rn_interior,/*VPNITno
de*/structbgp_info*bi_interior)/*VPNITroute*/{afi_tafi=family2afi(rn_interior->p
.family);structroute_node*par;structbgp_info*bi_exterior;structprefix*pfx_exteri
or;/*exteriorpfx*/void*cursor;intrc;if(!VALID_INTERIOR_TYPE(bi_interior->type)){
vnc_zlog_debug_verbose("%s:type%dnotvalidinteriortype,skipping",__func__,bi_inte
rior->type);return;}if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT])
{vnc_zlog_debug_verbose("%s:redistofexteriorroutesnoenabled,skipping",__func__);
return;}if(it==bgp->rfapi->it_ce){vnc_zlog_debug_verbose("%s:itisit_ce,skipping"
,__func__);return;}/*Ifnoexteriorroutesdependonthisprefix,nothingtodo*/if(!RFAPI
_HAS_MONITOR_EXTERIOR(rn_interior)){vnc_zlog_debug_verbose("%s:noexteriormonitor
,skipping",__func__);return;}/*debugging*/{charstr_pfx[PREFIX_STRLEN];prefix2str
(&rn_interior->p,str_pfx,sizeof(str_pfx));vnc_zlog_debug_verbose("%s:interiorpre
fix=%s,bitype=%d",__func__,str_pfx,bi_interior->type);}/**Removeconstructedroute
sbasedonthedeletedinteriorroute*/cursor=NULL;for(rc=skiplist_next(RFAPI_MONITOR_
EXTERIOR(rn_interior)->source,(void**)&bi_exterior,(void**)&pfx_exterior,&cursor
);!rc;rc=skiplist_next(RFAPI_MONITOR_EXTERIOR(rn_interior)->source,(void**)&bi_e
xterior,(void**)&pfx_exterior,&cursor)){structprefix_rd*prd;uint32_tlabel=0;if(b
i_interior->extra){prd=&bi_interior->extra->vnc.import.rd;label=decode_label(&bi
_interior->extra->label[0]);}elseprd=NULL;rfapiBgpInfoFilteredImportVPN(it,FIF_A
CTION_KILL,bi_interior->peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,bi_interior->
attr,ZEBRA_ROUTE_BGP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);}/**Iftherearenor
emainingvalidinteriorroutesatthisprefix,*weneedtolookupthetreeforapossiblenodeto
movemonitorsto*/if(RFAPI_MONITOR_EXTERIOR(rn_interior)->valid_interior_count){vn
c_zlog_debug_verbose("%s:interiorroutesstillpresent,skipping",__func__);return;}
/**Findnearestparentwithatleastonevalidinteriorroute*Ifnoneisfound,parwillendupN
ULL,andwewillmove*themonitorstotheorphanlistforthisimporttable*/for(par=rn_inter
ior->parent;par;par=par->parent){if(RFAPI_MONITOR_EXTERIOR(par)->valid_interior_
count)break;}vnc_zlog_debug_verbose("%s:par=%p,extsrc:%p",__func__,par,RFAPI_MON
ITOR_EXTERIOR(rn_interior)->source);/*moveallmonitors*//**Wewilluseanddeleteever
yelementofthesourceskiplist*/while(!skiplist_first(RFAPI_MONITOR_EXTERIOR(rn_int
erior)->source,(void**)&bi_exterior,(void**)&pfx_exterior)){structprefix*pfx_mon
=prefix_new();prefix_copy(pfx_mon,pfx_exterior);if(par){structbgp_info*bi;/**Add
monitortoparentnode*/if(!RFAPI_MONITOR_EXTERIOR(par)->source){RFAPI_MONITOR_EXTE
RIOR(par)->source=skiplist_new(0,NULL,(void(*)(void*))prefix_free);route_lock_no
de(par);/*sl*/}skiplist_insert(RFAPI_MONITOR_EXTERIOR(par)->source,bi_exterior,p
fx_mon);route_lock_node(par);/*slentry*//*Addconstructedexteriorroutesbasedonpar
ent*/for(bi=par->info;bi;bi=bi->next){structprefix_rd*prd;structattrnew_attr;uin
t32_tlabel=0;if(bi->type==ZEBRA_ROUTE_BGP_DIRECT_EXT)continue;if(bi->extra){prd=
&bi->extra->vnc.import.rd;label=decode_label(&bi->extra->label[0]);}elseprd=NULL
;/*uselocal_preffromunicastroute*/memset(&new_attr,0,sizeof(structattr));bgp_att
r_dup(&new_attr,bi->attr);if(bi_exterior&&(bi_exterior->attr->flag&ATTR_FLAG_BIT
(BGP_ATTR_LOCAL_PREF))){new_attr.local_pref=bi_exterior->attr->local_pref;new_at
tr.flag|=ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF);}rfapiBgpInfoFilteredImportVPN(it,FI
F_ACTION_UPDATE,bi->peer,NULL,/*rfd*/pfx_exterior,NULL,afi,prd,&new_attr,ZEBRA_R
OUTE_BGP_DIRECT_EXT,BGP_ROUTE_REDISTRIBUTE,&label);}}else{/**Nointeriorroutefore
xterior'snexthop.Save*monitor*inorphanlisttoawaitfutureroute.*/skiplist_insert(i
t->monitor_exterior_orphans,bi_exterior,pfx_mon);}skiplist_delete_first(RFAPI_MO
NITOR_EXTERIOR(rn_interior)->source);route_unlock_node(rn_interior);/*slentry*/}
if(skiplist_empty(RFAPI_MONITOR_EXTERIOR(rn_interior)->source)){skiplist_free(RF
API_MONITOR_EXTERIOR(rn_interior)->source);RFAPI_MONITOR_EXTERIOR(rn_interior)->
source=NULL;route_unlock_node(rn_interior);/*slitself*/}}/**********************
**************************************************Genericadd/deleteunicastroutes
***********************************************************************/voidvnc_
import_bgp_add_route(structbgp*bgp,structprefix*prefix,structbgp_info*info){afi_
tafi=family2afi(prefix->family);if(VNC_DEBUG(VERBOSE)){structprefixpfx_nexthop;c
harbuf[PREFIX_STRLEN];charbuf_nh[PREFIX_STRLEN];prefix2str(prefix,buf,sizeof(buf
));rfapiUnicastNexthop2Prefix(afi,info->attr,&pfx_nexthop);prefix2str(&pfx_nexth
op,buf_nh,sizeof(buf_nh));vnc_zlog_debug_verbose("%s:pfx%s,nh%s",__func__,buf,bu
f_nh);}#ifDEBUG_RHN_LISTprint_rhn_list(__func__,"ENTER");#endifVNC_RHNCK(enter);
if(!afi){zlog_err("%s:can'tgetafiofprefix",__func__);return;}if(!bgp->rfapi_cfg)
{vnc_zlog_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__);return;}/*c
heckvncredistflagforbgpdirectroutes*/if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE
_BGP_DIRECT]){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfg->redist[afi=%d][type=%d=
ZEBRA_ROUTE_BGP_DIRECT]is0,skipping",__func__,afi,ZEBRA_ROUTE_BGP_DIRECT);return
;}switch(bgp->rfapi_cfg->redist_mode){caseVNC_REDIST_MODE_PLAIN:vnc_import_bgp_a
dd_route_mode_plain(bgp,prefix,info);break;caseVNC_REDIST_MODE_RFG:if(bgp->rfapi
_cfg->rfg_redist)vnc_import_bgp_add_route_mode_nvegroup(bgp,prefix,info,bgp->rfa
pi_cfg->rfg_redist);elsevnc_zlog_debug_verbose("%s:modeRFGbutnoredistRFG",__func
__);break;caseVNC_REDIST_MODE_RESOLVE_NVE:vnc_import_bgp_add_route_mode_resolve_
nve(bgp,prefix,info);break;}#ifDEBUG_RHN_LISTprint_rhn_list(__func__,"LEAVE");#e
ndifVNC_RHNCK(leave);}/**"WithdrawingaRoute"importprocess*/voidvnc_import_bgp_de
l_route(structbgp*bgp,structprefix*prefix,structbgp_info*info)/*unicastinfo*/{af
i_tafi=family2afi(prefix->family);assert(afi);{structprefixpfx_nexthop;charbuf[P
REFIX_STRLEN];charbuf_nh[PREFIX_STRLEN];prefix2str(prefix,buf,sizeof(buf));rfapi
UnicastNexthop2Prefix(afi,info->attr,&pfx_nexthop);prefix2str(&pfx_nexthop,buf_n
h,sizeof(buf_nh));vnc_zlog_debug_verbose("%s:pfx%s,nh%s",__func__,buf,buf_nh);}#
ifDEBUG_RHN_LISTprint_rhn_list(__func__,"ENTER");#endifVNC_RHNCK(enter);if(!bgp-
>rfapi_cfg){vnc_zlog_debug_verbose("%s:bgp->rfapi_cfgisNULL,skipping",__func__);
return;}/*checkbgpredistflagforvncdirect("vpn")routes*/if(!bgp->rfapi_cfg->redis
t[afi][ZEBRA_ROUTE_BGP_DIRECT]){vnc_zlog_debug_verbose("%s:bgpredistributionofaf
i=%dVNCdirectroutesisoff",__func__,afi);return;}switch(bgp->rfapi_cfg->redist_mo
de){caseVNC_REDIST_MODE_PLAIN:vnc_import_bgp_del_route_mode_plain(bgp,prefix,inf
o);break;caseVNC_REDIST_MODE_RFG:if(bgp->rfapi_cfg->rfg_redist)vnc_import_bgp_de
l_route_mode_nvegroup(bgp,prefix,info);elsevnc_zlog_debug_verbose("%s:modeRFGbut
noredistRFG",__func__);break;caseVNC_REDIST_MODE_RESOLVE_NVE:vnc_import_bgp_del_
route_mode_resolve_nve(bgp,afi,prefix,info);break;}#ifDEBUG_RHN_LISTprint_rhn_li
st(__func__,"LEAVE");#endifVNC_RHNCK(leave);}/**********************************
**************************************Enable/Disable****************************
*******************************************/voidvnc_import_bgp_redist_enable(str
uctbgp*bgp,afi_tafi){/*iterateoverbgpunicastv4andv6routes,call*vnc_import_bgp_ad
d_route*/structbgp_node*rn;vnc_zlog_debug_verbose("%s:entry,afi=%d",__func__,afi
);if(bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BGP_DIRECT]){vnc_zlog_debug_verbose
("%s:alreadyenabledforafi%d,skipping",__func__,afi);return;}bgp->rfapi_cfg->redi
st[afi][ZEBRA_ROUTE_BGP_DIRECT]=1;for(rn=bgp_table_top(bgp->rib[afi][SAFI_UNICAS
T]);rn;rn=bgp_route_next(rn)){structbgp_info*bi;for(bi=rn->info;bi;bi=bi->next){
if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))continue;vnc_import_bgp_add_route(bgp,
&rn->p,bi);}}vnc_zlog_debug_verbose("%s:setredist[afi=%d][type=%d=ZEBRA_ROUTE_BG
P_DIRECT]return",__func__,afi,ZEBRA_ROUTE_BGP_DIRECT);}voidvnc_import_bgp_exteri
or_redist_enable(structbgp*bgp,afi_tafi){structbgp*bgp_exterior;structbgp_node*r
n;bgp_exterior=bgp->rfapi_cfg->redist_bgp_exterior_view;if(bgp->rfapi_cfg->redis
t[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT]){vnc_zlog_debug_verbose("%s:alreadyenabledfor
afi%d,skipping",__func__,afi);return;}bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BG
P_DIRECT_EXT]=1;if(!bgp_exterior){vnc_zlog_debug_verbose("%s:noexteriorviewsetye
t,noroutestoimportyet",__func__);return;}for(rn=bgp_table_top(bgp_exterior->rib[
afi][SAFI_UNICAST]);rn;rn=bgp_route_next(rn)){structbgp_info*bi;for(bi=rn->info;
bi;bi=bi->next){if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))continue;vnc_import_bg
p_exterior_add_route(bgp_exterior,&rn->p,bi);}}vnc_zlog_debug_verbose("%s:setred
ist[afi=%d][type=%d=ZEBRA_ROUTE_BGP_DIRECT]return",__func__,afi,ZEBRA_ROUTE_BGP_
DIRECT);}/**Thisfunctionisforpopulatinganewly-createdImportTable*/voidvnc_import
_bgp_exterior_redist_enable_it(structbgp*bgp,afi_tafi,structrfapi_import_table*i
t_only){structbgp*bgp_exterior;structbgp_node*rn;vnc_zlog_debug_verbose("%s:entr
y",__func__);bgp_exterior=bgp->rfapi_cfg->redist_bgp_exterior_view;if(!bgp->rfap
i_cfg->redist[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT]){vnc_zlog_debug_verbose("%s:noten
abledforafi%d,skipping",__func__,afi);return;}if(!bgp_exterior){vnc_zlog_debug_v
erbose("%s:noexteriorviewsetyet,noroutestoimportyet",__func__);return;}for(rn=bg
p_table_top(bgp_exterior->rib[afi][SAFI_UNICAST]);rn;rn=bgp_route_next(rn)){stru
ctbgp_info*bi;for(bi=rn->info;bi;bi=bi->next){if(CHECK_FLAG(bi->flags,BGP_INFO_R
EMOVED))continue;vnc_import_bgp_exterior_add_route_it(bgp_exterior,&rn->p,bi,it_
only);}}}voidvnc_import_bgp_redist_disable(structbgp*bgp,afi_tafi){/**iterateove
rvpnroutes,findroutesoftypeZEBRA_ROUTE_BGP_DIRECT,*delete(calltimerexpireimmedia
tely)*/structbgp_node*rn1;structbgp_node*rn2;vnc_zlog_debug_verbose("%s:entry",_
_func__);if(!bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BGP_DIRECT]){vnc_zlog_debug
_verbose("%s:alreadydisabledforafi%d,skipping",__func__,afi);return;}/**Two-leve
ltableforSAFI_MPLS_VPN*Becarefulwhenchangingthethingsweiterateover*/for(rn1=bgp_
table_top(bgp->rib[afi][SAFI_MPLS_VPN]);rn1;rn1=bgp_route_next(rn1)){if(rn1->inf
o){for(rn2=bgp_table_top(rn1->info);rn2;rn2=bgp_route_next(rn2)){structbgp_info*
bi;structbgp_info*nextbi;for(bi=rn2->info;bi;bi=nextbi){nextbi=bi->next;if(bi->t
ype==ZEBRA_ROUTE_BGP_DIRECT){structrfapi_descriptor*rfd;vncHDBgpDirect.peer=bi->
peer;rfd=bi->extra->vnc.export.rfapi_handle;vnc_zlog_debug_verbose("%s:deletingb
i=%p,bi->peer=%p,bi->type=%d,bi->sub_type=%d,bi->extra->vnc.export.rfapi_handle=
%p[passingrfd=%p]",__func__,bi,bi->peer,bi->type,bi->sub_type,(bi->extra?bi->ext
ra->vnc.export.rfapi_handle:NULL),rfd);del_vnc_route(rfd,bi->peer,bgp,SAFI_MPLS_
VPN,&rn2->p,(structprefix_rd*)&rn1->p,bi->type,bi->sub_type,NULL,1);/*kill*/vncH
DBgpDirect.peer=NULL;}}}}}/*ClearRHNlist*/if(bgp->rfapi->resolve_nve_nexthop){st
ructprefix_bag*pb;structbgp_info*info;while(!skiplist_first(bgp->rfapi->resolve_
nve_nexthop,NULL,(void*)&pb)){info=pb->ubi;skiplist_delete_first(bgp->rfapi->res
olve_nve_nexthop);bgp_info_unlock(info);}}bgp->rfapi_cfg->redist[afi][ZEBRA_ROUT
E_BGP_DIRECT]=0;vnc_zlog_debug_verbose("%s:return",__func__);}voidvnc_import_bgp
_exterior_redist_disable(structbgp*bgp,afi_tafi){structrfapi_cfg*hc=bgp->rfapi_c
fg;structbgp*bgp_exterior=hc->redist_bgp_exterior_view;vnc_zlog_debug_verbose("%
s:entry",__func__);if(!hc->redist[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT]){vnc_zlog_deb
ug_verbose("%s:alreadydisabledforafi%d,skipping",__func__,afi);return;}if(!bgp_e
xterior){vnc_zlog_debug_verbose("%s:bgpexteriorviewnotdefined,skipping",__func__
);return;}{structbgp_node*rn;for(rn=bgp_table_top(bgp_exterior->rib[afi][SAFI_UN
ICAST]);rn;rn=bgp_route_next(rn)){structbgp_info*bi;for(bi=rn->info;bi;bi=bi->ne
xt){if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))continue;vnc_import_bgp_exterior_d
el_route(bgp_exterior,&rn->p,bi);}}#ifDEBUG_RHN_LISTprint_rhn_list(__func__,NULL
);#endif}bgp->rfapi_cfg->redist[afi][ZEBRA_ROUTE_BGP_DIRECT_EXT]=0;vnc_zlog_debu
g_verbose("%s:return",__func__);}