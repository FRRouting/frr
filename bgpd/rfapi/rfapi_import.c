/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*
*File:rfapi_import.c*Purpose:HandleimportofroutesfromBGPtoRFAPI*/#include<errno.
h>#include"lib/zebra.h"#include"lib/prefix.h"#include"lib/table.h"#include"lib/v
ty.h"#include"lib/memory.h"#include"lib/log.h"#include"lib/skiplist.h"#include"l
ib/thread.h"#include"lib/stream.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_ecommun
ity.h"#include"bgpd/bgp_attr.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_mplsv
pn.h"/*prefix_rd2str()*/#include"bgpd/bgp_vnc_types.h"#include"bgpd/bgp_rd.h"#in
clude"bgpd/rfapi/rfapi.h"#include"bgpd/rfapi/bgp_rfapi_cfg.h"#include"bgpd/rfapi
/rfapi_backend.h"#include"bgpd/rfapi/rfapi_import.h"#include"bgpd/rfapi/rfapi_pr
ivate.h"#include"bgpd/rfapi/rfapi_monitor.h"#include"bgpd/rfapi/rfapi_nve_addr.h
"#include"bgpd/rfapi/rfapi_vty.h"#include"bgpd/rfapi/vnc_export_bgp.h"#include"b
gpd/rfapi/vnc_export_bgp_p.h"#include"bgpd/rfapi/vnc_zebra.h"#include"bgpd/rfapi
/vnc_import_bgp.h"#include"bgpd/rfapi/vnc_import_bgp_p.h"#include"bgpd/rfapi/rfa
pi_rib.h"#include"bgpd/rfapi/rfapi_encap_tlv.h"#include"bgpd/rfapi/vnc_debug.h"#
ifdefHAVE_GLIBC_BACKTRACE/*forbacktraceandfriends*/#include<execinfo.h>#endif/*H
AVE_GLIBC_BACKTRACE*/#undefDEBUG_MONITOR_MOVE_SHORTER#undefDEBUG_RETURNED_NHL#un
defDEBUG_ROUTE_COUNTERS#undefDEBUG_ENCAP_MONITOR#undefDEBUG_L2_EXTRA#undefDEBUG_
IT_NODES#undefDEBUG_BI_SEARCH/**Allocatedforeachwithdrawtimerinstance;freedwhent
hetimer*expiresoriscanceled*/structrfapi_withdraw{structrfapi_import_table*impor
t_table;structroute_node*node;structbgp_info*info;safi_tsafi;/*usedonlyforbulkop
erations*//**Forimporttablenodereferencecountchecking(i.e.,debugging).*Normallyw
henatimerexpires,lockoffsetshouldbe0.However,if*thetimerexpirationfunctioniscall
eddirectly(e.g.,*rfapiExpireVpnNow),thenodecouldbelockedbyapreceding*route_top()
orroute_next()inaloop,soweneedtopassthis*valuein.*/intlockoffset;};/**DEBUGFUNCT
ION*It'sevilandfiendish.It'scompiler-dependent.*?MightneedLDFLAGS-rdynamictoprod
uceallfunctionnames*/voidrfapiDebugBacktrace(void){#ifdefHAVE_GLIBC_BACKTRACE#de
fineRFAPI_DEBUG_BACKTRACE_NENTRIES200void*buf[RFAPI_DEBUG_BACKTRACE_NENTRIES];ch
ar**syms;size_ti;size_tsize;size=backtrace(buf,RFAPI_DEBUG_BACKTRACE_NENTRIES);s
yms=backtrace_symbols(buf,size);for(i=0;i<size&&i<RFAPI_DEBUG_BACKTRACE_NENTRIES
;++i){vnc_zlog_debug_verbose("backtrace[%2zu]:%s",i,syms[i]);}free(syms);#else#e
ndif}/**DEBUGFUNCTION*Countremoteroutesandcomparewithactively-maintainedvalues.*
Abortiftheydisagree.*/voidrfapiCheckRouteCount(){structbgp*bgp=bgp_get_default()
;structrfapi*h;structrfapi_import_table*it;afi_tafi;assert(bgp);h=bgp->rfapi;ass
ert(h);for(it=h->imports;it;it=it->next){for(afi=AFI_IP;afi<AFI_MAX;++afi){struc
troute_table*rt;structroute_node*rn;intholddown_count=0;intlocal_count=0;intimpo
rted_count=0;intremote_count=0;rt=it->imported_vpn[afi];for(rn=route_top(rt);rn;
rn=route_next(rn)){structbgp_info*bi;structbgp_info*next;for(bi=rn->info;bi;bi=n
ext){next=bi->next;if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){++holddown_count;}
else{if(RFAPI_LOCAL_BI(bi)){++local_count;}else{if(RFAPI_DIRECT_IMPORT_BI(bi)){+
+imported_count;}else{++remote_count;}}}}}if(it->holddown_count[afi]!=holddown_c
ount){vnc_zlog_debug_verbose("%s:it->holddown_count%d!=holddown_count%d",__func_
_,it->holddown_count[afi],holddown_count);assert(0);}if(it->remote_count[afi]!=r
emote_count){vnc_zlog_debug_verbose("%s:it->remote_count%d!=remote_count%d",__fu
nc__,it->remote_count[afi],remote_count);assert(0);}if(it->imported_count[afi]!=
imported_count){vnc_zlog_debug_verbose("%s:it->imported_count%d!=imported_count%
d",__func__,it->imported_count[afi],imported_count);assert(0);}}}}#ifDEBUG_ROUTE
_COUNTERS#defineVNC_ITRCCKdo{rfapiCheckRouteCount();}while(0)#else#defineVNC_ITR
CCK#endif/**Validatereferencecountforanodeinanimporttable**Normallylockoffsetis0
fornodesinquiescentstate.However,*route_unlock_nodewilldeletethenodeifitiscalled
when*node->lock==1,andwehavetovalidatetherefcountbefore*thenodeisdeleted.Inthisc
ase,wespecifylockoffset1.*/voidrfapiCheckRefcount(structroute_node*rn,safi_tsafi
,intlockoffset){unsignedintcount_bi=0;unsignedintcount_monitor=0;structbgp_info*
bi;structrfapi_monitor_encap*hme;structrfapi_monitor_vpn*hmv;for(bi=rn->info;bi;
bi=bi->next)++count_bi;if(rn->aggregate){++count_monitor;/*rfapi_it_extra*/switc
h(safi){void*cursor;intrc;caseSAFI_ENCAP:for(hme=RFAPI_MONITOR_ENCAP(rn);hme;hme
=hme->next)++count_monitor;break;caseSAFI_MPLS_VPN:for(hmv=RFAPI_MONITOR_VPN(rn)
;hmv;hmv=hmv->next)++count_monitor;if(RFAPI_MONITOR_EXTERIOR(rn)->source){++coun
t_monitor;/*sl*/cursor=NULL;for(rc=skiplist_next(RFAPI_MONITOR_EXTERIOR(rn)->sou
rce,NULL,NULL,&cursor);!rc;rc=skiplist_next(RFAPI_MONITOR_EXTERIOR(rn)->source,N
ULL,NULL,&cursor)){++count_monitor;/*slentry*/}}break;default:assert(0);}}if(cou
nt_bi+count_monitor+lockoffset!=rn->lock){vnc_zlog_debug_verbose("%s:count_bi=%d
,count_monitor=%d,lockoffset=%d,rn->lock=%d",__func__,count_bi,count_monitor,loc
koffset,rn->lock);assert(0);}}/**Performdeferredrfapi_closeoperationsthatwereque
ued*duringcallbacks.*/staticwq_item_statusrfapi_deferred_close_workfunc(structwo
rk_queue*q,void*data){structrfapi_descriptor*rfd=data;structrfapi*h=q->spec.data
;assert(!(h->flags&RFAPI_INCALLBACK));rfapi_close(rfd);vnc_zlog_debug_verbose("%
s:completeddeferredcloseonhandle%p",__func__,rfd);returnWQ_SUCCESS;}/**Extractla
yer2optionfromEncapTLVSinBGPattrs*/intrfapiGetL2o(structattr*attr,structrfapi_l2
address_option*l2o){if(attr){structbgp_attr_encap_subtlv*pEncap;for(pEncap=attr-
>vnc_subtlvs;pEncap;pEncap=pEncap->next){if(pEncap->type==BGP_VNC_SUBTLV_TYPE_RF
POPTION){if(pEncap->value[0]==RFAPI_VN_OPTION_TYPE_L2ADDR){if(pEncap->value[1]==
14){memcpy(l2o->macaddr.octet,pEncap->value+2,ETH_ALEN);l2o->label=((pEncap->val
ue[10]>>4)&0x0f)+((pEncap->value[9]<<4)&0xff0)+((pEncap->value[8]<<12)&0xff000);
l2o->local_nve_id=pEncap->value[12];l2o->logical_net_id=(pEncap->value[15]&0xff)
+((pEncap->value[14]<<8)&0xff00)+((pEncap->value[13]<<16)&0xff0000);}return0;}}}
}returnENOENT;}/**ExtractthelifetimefromtheTunnelEncapattributeofaroutein*animpo
rttable*/intrfapiGetVncLifetime(structattr*attr,uint32_t*lifetime){structbgp_att
r_encap_subtlv*pEncap;*lifetime=RFAPI_INFINITE_LIFETIME;/*defaulttoinfinite*/if(
attr){for(pEncap=attr->vnc_subtlvs;pEncap;pEncap=pEncap->next){if(pEncap->type==
BGP_VNC_SUBTLV_TYPE_LIFETIME){/*lifetime*/if(pEncap->length==4){memcpy(lifetime,
pEncap->value,4);*lifetime=ntohl(*lifetime);return0;}}}}returnENOENT;}/**Extract
thetunneltypefromtheextendedcommunity*/intrfapiGetTunnelType(structattr*attr,bgp
_encap_types*type){*type=BGP_ENCAP_TYPE_MPLS;/*defaulttoMPLS*/if(attr&&attr->eco
mmunity){structecommunity*ecom=attr->ecommunity;inti;for(i=0;i<(ecom->size*ECOMM
UNITY_SIZE);i+=ECOMMUNITY_SIZE){uint8_t*ep;ep=ecom->val+i;if(ep[0]==ECOMMUNITY_E
NCODE_OPAQUE&&ep[1]==ECOMMUNITY_OPAQUE_SUBTYPE_ENCAP){*type=(ep[6]<<8)+ep[7];ret
urn0;}}}returnENOENT;}/**LookforUNaddressinEncapattribute*/intrfapiGetVncTunnelU
nAddr(structattr*attr,structprefix*p){structbgp_attr_encap_subtlv*pEncap;bgp_enc
ap_typestun_type;rfapiGetTunnelType(attr,&tun_type);if(tun_type==BGP_ENCAP_TYPE_
MPLS){if(!p)return0;/*MPLScarriesUNaddressinnexthop*/rfapiNexthop2Prefix(attr,p)
;if(p->family!=0)return0;returnENOENT;}if(attr){for(pEncap=attr->encap_subtlvs;p
Encap;pEncap=pEncap->next){if(pEncap->type==BGP_ENCAP_SUBTLV_TYPE_REMOTE_ENDPOIN
T){/*unaddr*/switch(pEncap->length){case8:if(p){p->family=AF_INET;p->prefixlen=3
2;memcpy(p->u.val,pEncap->value,4);}return0;case20:if(p){p->family=AF_INET6;p->p
refixlen=128;memcpy(p->u.val,pEncap->value,16);}return0;}}}}returnENOENT;}/**Get
UNaddresswhereveritmightbe*/intrfapiGetUnAddrOfVpnBi(structbgp_info*bi,structpre
fix*p){/*Ifit'sinthisroute'sVNCattribute,we'redone*/if(!rfapiGetVncTunnelUnAddr(
bi->attr,p))return0;/**Otherwise,seeifit'scachedfromacorrespondingENCAPSAFI*adve
rtisement*/if(bi->extra){switch(bi->extra->vnc.import.un_family){caseAF_INET:if(
p){p->family=bi->extra->vnc.import.un_family;p->u.prefix4=bi->extra->vnc.import.
un.addr4;p->prefixlen=32;}return0;caseAF_INET6:if(p){p->family=bi->extra->vnc.im
port.un_family;p->u.prefix6=bi->extra->vnc.import.un.addr6;p->prefixlen=128;}ret
urn0;default:if(p)p->family=0;#ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose("%s:b
i->extra->vnc.import.un_familyis0,noUNaddr",__func__);#endifbreak;}}returnENOENT
;}/**Makeanewbgp_infofromgatheredparameters*/staticstructbgp_info*rfapiBgpInfoCr
eate(structattr*attr,structpeer*peer,void*rfd,structprefix_rd*prd,uint8_ttype,ui
nt8_tsub_type,uint32_t*label){structbgp_info*new;new=bgp_info_new();assert(new);
if(attr){if(!new->attr)new->attr=bgp_attr_intern(attr);}bgp_info_extra_get(new);
if(prd){new->extra->vnc.import.rd=*prd;rfapi_time(&new->extra->vnc.import.create
_time);}if(label)encode_label(*label,&new->extra->label[0]);new->type=type;new->
sub_type=sub_type;new->peer=peer;peer_lock(peer);returnnew;}/**Freesbgp_infoasus
edinimporttables(partsarenot*allocatedexactlythewaytheyareinthemainRIBs)*/static
voidrfapiBgpInfoFree(structbgp_info*goner){if(!goner)return;if(goner->peer){vnc_
zlog_debug_verbose("%s:callingpeer_unlock(%p),#%d",__func__,goner->peer,goner->p
eer->lock);peer_unlock(goner->peer);}if(goner->attr){bgp_attr_unintern(&goner->a
ttr);}if(goner->extra){assert(!goner->extra->damp_info);/*Notusedinimporttbls*/X
FREE(MTYPE_BGP_ROUTE_EXTRA,goner->extra);goner->extra=NULL;}XFREE(MTYPE_BGP_ROUT
E,goner);}structrfapi_import_table*rfapiMacImportTableGetNoAlloc(structbgp*bgp,u
int32_tlni){structrfapi*h;structrfapi_import_table*it=NULL;uintptr_tlni_as_ptr=l
ni;h=bgp->rfapi;if(!h)returnNULL;if(!h->import_mac)returnNULL;if(skiplist_search
(h->import_mac,(void*)lni_as_ptr,(void**)&it))returnNULL;returnit;}structrfapi_i
mport_table*rfapiMacImportTableGet(structbgp*bgp,uint32_tlni){structrfapi*h;stru
ctrfapi_import_table*it=NULL;uintptr_tlni_as_ptr=lni;h=bgp->rfapi;assert(h);if(!
h->import_mac){/*defaultcmpisgoodenoughforLNI*/h->import_mac=skiplist_new(0,NULL
,NULL);}if(skiplist_search(h->import_mac,(void*)lni_as_ptr,(void**)&it)){structe
community*enew;structecommunity_valeval;afi_tafi;it=XCALLOC(MTYPE_RFAPI_IMPORTTA
BLE,sizeof(structrfapi_import_table));/*setRTlistofnewimporttablebasedonLNI*/mem
set((char*)&eval,0,sizeof(eval));eval.val[0]=0;/*VNCL2VPN*/eval.val[1]=2;/*VNCL2
VPN*/eval.val[5]=(lni>>16)&0xff;eval.val[6]=(lni>>8)&0xff;eval.val[7]=(lni>>0)&0
xff;enew=ecommunity_new();ecommunity_add_val(enew,&eval);it->rt_import_list=enew
;for(afi=AFI_IP;afi<AFI_MAX;++afi){it->imported_vpn[afi]=route_table_init();it->
imported_encap[afi]=route_table_init();}it->l2_logical_net_id=lni;skiplist_inser
t(h->import_mac,(void*)lni_as_ptr,it);}assert(it);returnit;}/**ImplementMONITOR_
MOVE_SHORTER(original_node)from*RFAPI-Import-Event-Handling.txt**Returnspointert
othelistofmovedmonitors*/staticstructrfapi_monitor_vpn*rfapiMonitorMoveShorter(s
tructroute_node*original_vpn_node,intlockoffset){structbgp_info*bi;structroute_n
ode*par;structrfapi_monitor_vpn*m;structrfapi_monitor_vpn*mlast;structrfapi_moni
tor_vpn*moved;intmovecount=0;intparent_already_refcounted=0;RFAPI_CHECK_REFCOUNT
(original_vpn_node,SAFI_MPLS_VPN,lockoffset);#ifDEBUG_MONITOR_MOVE_SHORTER{charb
uf[PREFIX_STRLEN];prefix2str(&original_vpn_node->p,buf,sizeof(buf));vnc_zlog_deb
ug_verbose("%s:calledwithnodepfx=%s",__func__,buf);}#endif/**1.Ifthereisatleasto
nebi(eitherregularrouteor*routemarkedaswithdrawn,withapendingtimer)at*original_n
odewithavalidUNaddress,we'redone.Return.*/for(bi=original_vpn_node->info;bi;bi=b
i->next){structprefixpfx;if(!rfapiGetUnAddrOfVpnBi(bi,&pfx)){#ifDEBUG_MONITOR_MO
VE_SHORTERvnc_zlog_debug_verbose("%s:havevalidUNatoriginalnode,nochange",__func_
_);#endifreturnNULL;}}/**2.Travelupthetree(towardless-specificprefixes)from*orig
inal_nodetofindthefirstnodethathasatleast*oneroute(evenifitisonlyawithdrawnroute
)witha*validUNaddress.Callthisnode"NodeP."*/for(par=original_vpn_node->parent;pa
r;par=par->parent){for(bi=par->info;bi;bi=bi->next){structprefixpfx;if(!rfapiGet
UnAddrOfVpnBi(bi,&pfx)){break;}}if(bi)break;}if(par){RFAPI_CHECK_REFCOUNT(par,SA
FI_MPLS_VPN,0);}/**Ifnoless-specificroutes,trytousethe0/0node*/if(!par){/*thisis
n'tnecessarily0/0*/par=route_top(original_vpn_node->table);/**Ifwegotthetopnodeb
utitwasn't0/0,*ignoreit*/if(par&&par->p.prefixlen){route_unlock_node(par);/*mayb
efree*/par=NULL;}if(par){++parent_already_refcounted;}}/**Create0/0nodeifitisn't
there*/if(!par){structprefixpfx_default;memset(&pfx_default,0,sizeof(pfx_default
));pfx_default.family=original_vpn_node->p.family;/*createsdefaultnodeifnoneexis
ts*/par=route_node_get(original_vpn_node->table,&pfx_default);++parent_already_r
efcounted;}/**3.Moveeachofthemonitorsfoundatoriginal_nodetoNodeP.*Theseare"Moved
Monitors."**//**Attachatendsothatthelistpointerwereturnpoints*onlytothemovedrout
es*/for(m=RFAPI_MONITOR_VPN(par),mlast=NULL;m;mlast=m,m=m->next);if(mlast){moved
=mlast->next=RFAPI_MONITOR_VPN(original_vpn_node);}else{moved=RFAPI_MONITOR_VPN_
W_ALLOC(par)=RFAPI_MONITOR_VPN(original_vpn_node);}if(RFAPI_MONITOR_VPN(original
_vpn_node))/*checkagg,sonotallocated*/RFAPI_MONITOR_VPN_W_ALLOC(original_vpn_nod
e)=NULL;/**updatethenodepointersonthemonitors*/for(m=moved;m;m=m->next){++moveco
unt;m->node=par;}RFAPI_CHECK_REFCOUNT(par,SAFI_MPLS_VPN,parent_already_refcounte
d-movecount);while(movecount>parent_already_refcounted){route_lock_node(par);++p
arent_already_refcounted;}while(movecount<parent_already_refcounted){/*unlikely,
butcodedefensively*/route_unlock_node(par);--parent_already_refcounted;}RFAPI_CH
ECK_REFCOUNT(original_vpn_node,SAFI_MPLS_VPN,movecount+lockoffset);while(movecou
nt--){route_unlock_node(original_vpn_node);}#ifDEBUG_MONITOR_MOVE_SHORTER{charbu
f[PREFIX_STRLEN];prefix2str(&par->p,buf,sizeof(buf));vnc_zlog_debug_verbose("%s:
movedtonodepfx=%s",__func__,buf);}#endifreturnmoved;}/**ImplementMONITOR_MOVE_LO
NGER(new_node)from*RFAPI-Import-Event-Handling.txt*/staticvoidrfapiMonitorMoveLo
nger(structroute_node*new_vpn_node){structrfapi_monitor_vpn*monitor;structrfapi_
monitor_vpn*mlast;structbgp_info*bi;structroute_node*par;RFAPI_CHECK_REFCOUNT(ne
w_vpn_node,SAFI_MPLS_VPN,0);/**Makesurewehaveatleastonevalidrouteatthenewnode*/f
or(bi=new_vpn_node->info;bi;bi=bi->next){structprefixpfx;if(!rfapiGetUnAddrOfVpn
Bi(bi,&pfx))break;}if(!bi){vnc_zlog_debug_verbose("%s:novalidroutesatnode%p,sono
tattemptingmoves",__func__,new_vpn_node);return;}/**Findfirstparentnodethathasmo
nitors*/for(par=new_vpn_node->parent;par;par=par->parent){if(RFAPI_MONITOR_VPN(p
ar))break;}if(!par){vnc_zlog_debug_verbose("%s:noparentnodeswithmonitors,done",_
_func__);return;}/**Checkeachofthesemonitorstoseeoftheirlongest-match*isnowtheup
datednode.Moveanysuchmonitorstothemore-*specificupdatednode*/for(mlast=NULL,moni
tor=RFAPI_MONITOR_VPN(par);monitor;){/**Ifnewlongestmatchformonitorprefixisthene
w*route'sprefix,movemonitortonewroute'sprefix*/if(prefix_match(&new_vpn_node->p,
&monitor->p)){/*detach*/if(mlast){mlast->next=monitor->next;}else{RFAPI_MONITOR_
VPN_W_ALLOC(par)=monitor->next;}/*attach*/monitor->next=RFAPI_MONITOR_VPN(new_vp
n_node);RFAPI_MONITOR_VPN_W_ALLOC(new_vpn_node)=monitor;monitor->node=new_vpn_no
de;route_lock_node(new_vpn_node);/*incrrefcount*/monitor=mlast?mlast->next:RFAPI
_MONITOR_VPN(par);RFAPI_CHECK_REFCOUNT(par,SAFI_MPLS_VPN,1);/*decrrefcountafterw
e'redonewithparasthismight*freeit*/route_unlock_node(par);continue;}mlast=monito
r;monitor=monitor->next;}RFAPI_CHECK_REFCOUNT(new_vpn_node,SAFI_MPLS_VPN,0);}sta
ticvoidrfapiBgpInfoChainFree(structbgp_info*bi){structbgp_info*next;while(bi){/*
*Ifthereisatimerwaitingtodeletethisbi,cancel*thetimeranddeleteimmediately*/if(CH
ECK_FLAG(bi->flags,BGP_INFO_REMOVED)&&bi->extra->vnc.import.timer){structthread*
t=(structthread*)bi->extra->vnc.import.timer;structrfapi_withdraw*wcb=t->arg;XFR
EE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);}next=bi->next;bi->next=NULL;rfapi
BgpInfoFree(bi);bi=next;}}staticvoidrfapiImportTableFlush(structrfapi_import_tab
le*it){afi_tafi;/**Freeecommunity*/ecommunity_free(&it->rt_import_list);it->rt_i
mport_list=NULL;for(afi=AFI_IP;afi<AFI_MAX;++afi){structroute_node*rn;for(rn=rou
te_top(it->imported_vpn[afi]);rn;rn=route_next(rn)){/**Eachroute_nodehas:*aggreg
ate:pointstorfapi_it_extrawithmonitor*chain(s)*info:pointstochainofbgp_info*//*f
reebgp_infoanditschildren*/rfapiBgpInfoChainFree(rn->info);rn->info=NULL;rfapiMo
nitorExtraFlush(SAFI_MPLS_VPN,rn);}for(rn=route_top(it->imported_encap[afi]);rn;
rn=route_next(rn)){/*freebgp_infoanditschildren*/rfapiBgpInfoChainFree(rn->info)
;rn->info=NULL;rfapiMonitorExtraFlush(SAFI_ENCAP,rn);}route_table_finish(it->imp
orted_vpn[afi]);route_table_finish(it->imported_encap[afi]);}if(it->monitor_exte
rior_orphans){skiplist_free(it->monitor_exterior_orphans);}}voidrfapiImportTable
RefDelByIt(structbgp*bgp,structrfapi_import_table*it_target){structrfapi*h;struc
trfapi_import_table*it;structrfapi_import_table*prev=NULL;assert(it_target);h=bg
p->rfapi;assert(h);for(it=h->imports;it;prev=it,it=it->next){if(it==it_target)br
eak;}assert(it);assert(it->refcount);it->refcount-=1;if(!it->refcount){if(prev){
prev->next=it->next;}else{h->imports=it->next;}rfapiImportTableFlush(it);XFREE(M
TYPE_RFAPI_IMPORTTABLE,it);}}#ifRFAPI_REQUIRE_ENCAP_BEEC/**LookformagicBGPEncaps
ulationExtendedCommunityvalue*FormatinRFC5512Sect.4.5*/staticintrfapiEcommunitie
sMatchBeec(structecommunity*ecom,bgp_encap_typestype){inti;if(!ecom)return0;for(
i=0;i<(ecom->size*ECOMMUNITY_SIZE);i+=ECOMMUNITY_SIZE){uint8_t*ep;ep=ecom->val+i
;if(ep[0]==ECOMMUNITY_ENCODE_OPAQUE&&ep[1]==ECOMMUNITY_OPAQUE_SUBTYPE_ENCAP&&ep[
6]==((type&&0xff00)>>8)&&ep[7]==(type&0xff)){return1;}}return0;}#endifintrfapiEc
ommunitiesIntersect(structecommunity*e1,structecommunity*e2){inti,j;if(!e1||!e2)
return0;{char*s1,*s2;s1=ecommunity_ecom2str(e1,ECOMMUNITY_FORMAT_DISPLAY,0);s2=e
community_ecom2str(e2,ECOMMUNITY_FORMAT_DISPLAY,0);vnc_zlog_debug_verbose("%s:e1
[%s],e2[%s]",__func__,s1,s2);XFREE(MTYPE_ECOMMUNITY_STR,s1);XFREE(MTYPE_ECOMMUNI
TY_STR,s2);}for(i=0;i<e1->size;++i){for(j=0;j<e2->size;++j){if(!memcmp(e1->val+(
i*ECOMMUNITY_SIZE),e2->val+(j*ECOMMUNITY_SIZE),ECOMMUNITY_SIZE)){return1;}}}retu
rn0;}intrfapiEcommunityGetLNI(structecommunity*ecom,uint32_t*lni){if(ecom){inti;
for(i=0;i<ecom->size;++i){uint8_t*p=ecom->val+(i*ECOMMUNITY_SIZE);if((*(p+0)==0x
00)&&(*(p+1)==0x02)){*lni=(*(p+5)<<16)|(*(p+6)<<8)|(*(p+7));return0;}}}returnENO
ENT;}intrfapiEcommunityGetEthernetTag(structecommunity*ecom,uint16_t*tag_id){str
uctbgp*bgp=bgp_get_default();*tag_id=0;/*defaulttountagged*/if(ecom){inti;for(i=
0;i<ecom->size;++i){as_tas=0;intencode=0;uint8_t*p=ecom->val+(i*ECOMMUNITY_SIZE)
;/*High-orderoctetoftype.*/encode=*p++;if(*p++==ECOMMUNITY_ROUTE_TARGET){if(enco
de==ECOMMUNITY_ENCODE_AS4){p=ptr_get_be32(p,&as);}elseif(encode==ECOMMUNITY_ENCO
DE_AS){as=(*p++<<8);as|=(*p++);p+=2;/*skipnexttwo,tag/vidalwaysinlowestbytes*/}i
f(as==bgp->as){*tag_id=*p++<<8;*tag_id|=(*p++);return0;}}}}returnENOENT;}statici
ntrfapiVpnBiNhEqualsPt(structbgp_info*bi,structrfapi_ip_addr*hpt){uint8_tfamily;
if(!hpt||!bi)return0;family=BGP_MP_NEXTHOP_FAMILY(bi->attr->mp_nexthop_len);if(h
pt->addr_family!=family)return0;switch(family){caseAF_INET:if(bi->attr->mp_nexth
op_global_in.s_addr!=hpt->addr.v4.s_addr)return0;break;caseAF_INET6:if(IPV6_ADDR
_CMP(&bi->attr->mp_nexthop_global,&hpt->addr.v6))return0;break;default:return0;b
reak;}return1;}/**Compare2VPNBIs.ReturntrueiftheyhavethesameVNandUNaddresses*/st
aticintrfapiVpnBiSamePtUn(structbgp_info*bi1,structbgp_info*bi2){structprefixpfx
_un1;structprefixpfx_un2;if(!bi1||!bi2)return0;if(!bi1->attr||!bi2->attr)return0
;/**VNaddresscomparisons*/if(BGP_MP_NEXTHOP_FAMILY(bi1->attr->mp_nexthop_len)!=B
GP_MP_NEXTHOP_FAMILY(bi2->attr->mp_nexthop_len)){return0;}switch(BGP_MP_NEXTHOP_
FAMILY(bi1->attr->mp_nexthop_len)){caseAF_INET:if(bi1->attr->mp_nexthop_global_i
n.s_addr!=bi2->attr->mp_nexthop_global_in.s_addr)return0;break;caseAF_INET6:if(I
PV6_ADDR_CMP(&bi1->attr->mp_nexthop_global,&bi2->attr->mp_nexthop_global))return
0;break;default:return0;break;}/**UNaddresscomparisons*/if(rfapiGetVncTunnelUnAd
dr(bi1->attr,&pfx_un1)){if(bi1->extra){pfx_un1.family=bi1->extra->vnc.import.un_
family;switch(bi1->extra->vnc.import.un_family){caseAF_INET:pfx_un1.u.prefix4=bi
1->extra->vnc.import.un.addr4;break;caseAF_INET6:pfx_un1.u.prefix6=bi1->extra->v
nc.import.un.addr6;break;default:pfx_un1.family=0;break;}}}if(rfapiGetVncTunnelU
nAddr(bi2->attr,&pfx_un2)){if(bi2->extra){pfx_un2.family=bi2->extra->vnc.import.
un_family;switch(bi2->extra->vnc.import.un_family){caseAF_INET:pfx_un2.u.prefix4
=bi2->extra->vnc.import.un.addr4;break;caseAF_INET6:pfx_un2.u.prefix6=bi2->extra
->vnc.import.un.addr6;break;default:pfx_un2.family=0;break;}}}if(!pfx_un1.family
||!pfx_un2.family)return0;if(pfx_un1.family!=pfx_un2.family)return0;switch(pfx_u
n1.family){caseAF_INET:if(!IPV4_ADDR_SAME(&pfx_un1.u.prefix4,&pfx_un2.u.prefix4)
)return0;break;caseAF_INET6:if(!IPV6_ADDR_SAME(&pfx_un1.u.prefix6,&pfx_un2.u.pre
fix6))return0;break;}return1;}uint8_trfapiRfpCost(structattr*attr){if(attr->flag
&ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)){if(attr->local_pref>255){return0;}return255
-attr->local_pref;}return255;}/*------------------------------------------*rfapi
_extract_l2o**FindLayer2optionsinanoptionchain**input:*pHopoptionchain**output:*
l2olayer2optionsextracted**returnvalue:*0OK*1nooptionsfound*--------------------
------------------------*/intrfapi_extract_l2o(structbgp_tea_options*pHop,/*chai
nofoptions*/structrfapi_l2address_option*l2o)/*returnextractedvalue*/{structbgp_
tea_options*p;for(p=pHop;p;p=p->next){if((p->type==RFAPI_VN_OPTION_TYPE_L2ADDR)&
&(p->length>=8)){char*v=p->value;memcpy(&l2o->macaddr,v,6);l2o->label=((v[6]<<12
)&0xff000)+((v[7]<<4)&0xff0)+((v[8]>>4)&0xf);l2o->local_nve_id=(uint8_t)v[10];l2
o->logical_net_id=(v[11]<<16)+(v[12]<<8)+(v[13]<<0);return0;}}return1;}staticstr
uctrfapi_next_hop_entry*rfapiRouteInfo2NextHopEntry(structrfapi_ip_prefix*rprefi
x,structbgp_info*bi,/*routetoencode*/uint32_tlifetime,/*usethisinnhe*/structrout
e_node*rn)/*reqforL2ethaddr*/{structrfapi_next_hop_entry*new;inthave_vnc_tunnel_
un=0;#ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose("%s:entry,bi%p,rn%p",__func__,
bi,rn);#endifnew=XCALLOC(MTYPE_RFAPI_NEXTHOP,sizeof(structrfapi_next_hop_entry))
;assert(new);new->prefix=*rprefix;if(bi->extra&&decode_rd_type(bi->extra->vnc.im
port.rd.val)==RD_TYPE_VNC_ETH){/*ethernet*/structrfapi_vn_option*vo;vo=XCALLOC(M
TYPE_RFAPI_VN_OPTION,sizeof(structrfapi_vn_option));assert(vo);vo->type=RFAPI_VN
_OPTION_TYPE_L2ADDR;memcpy(&vo->v.l2addr.macaddr,&rn->p.u.prefix_eth.octet,ETH_A
LEN);/*onlylow3bytesofthisaresignificant*/if(bi->attr){(void)rfapiEcommunityGetL
NI(bi->attr->ecommunity,&vo->v.l2addr.logical_net_id);(void)rfapiEcommunityGetEt
hernetTag(bi->attr->ecommunity,&vo->v.l2addr.tag_id);}/*local_nve_idcomesfromlow
erbyteofRDtype*/vo->v.l2addr.local_nve_id=bi->extra->vnc.import.rd.val[1];/*labe
lcomesfromMP_REACH_NLRIlabel*/vo->v.l2addr.label=decode_label(&bi->extra->label[
0]);new->vn_options=vo;/**Ifthereisanauxiliaryprefix(i.e.,hostIPaddress),*useita
sthenexthopprefixinsteadofthequeryprefix*/if(bi->extra->vnc.import.aux_prefix.fa
mily){rfapiQprefix2Rprefix(&bi->extra->vnc.import.aux_prefix,&new->prefix);}}if(
bi->attr){bgp_encap_typestun_type;new->prefix.cost=rfapiRfpCost(bi->attr);struct
bgp_attr_encap_subtlv*pEncap;switch(BGP_MP_NEXTHOP_FAMILY(bi->attr->mp_nexthop_l
en)){caseAF_INET:new->vn_address.addr_family=AF_INET;new->vn_address.addr.v4=bi-
>attr->mp_nexthop_global_in;break;caseAF_INET6:new->vn_address.addr_family=AF_IN
ET6;new->vn_address.addr.v6=bi->attr->mp_nexthop_global;break;default:zlog_warn(
"%s:invalidvpnnexthoplength:%d",__func__,bi->attr->mp_nexthop_len);rfapi_free_ne
xt_hop_list(new);returnNULL;}for(pEncap=bi->attr->vnc_subtlvs;pEncap;pEncap=pEnc
ap->next){switch(pEncap->type){caseBGP_VNC_SUBTLV_TYPE_LIFETIME:/*useconfiguredl
ifetime,notattrlifetime*/break;default:zlog_warn("%s:unknownVNCoptiontype%d",__f
unc__,pEncap->type);break;}}rfapiGetTunnelType(bi->attr,&tun_type);if(tun_type==
BGP_ENCAP_TYPE_MPLS){structprefixp;/*MPLScarriesUNaddressinnexthop*/rfapiNexthop
2Prefix(bi->attr,&p);if(p.family!=0){rfapiQprefix2Raddr(&p,&new->un_address);hav
e_vnc_tunnel_un=1;}}for(pEncap=bi->attr->encap_subtlvs;pEncap;pEncap=pEncap->nex
t){switch(pEncap->type){caseBGP_ENCAP_SUBTLV_TYPE_REMOTE_ENDPOINT:/**OverridesEN
CAPUNaddress,ifany*/switch(pEncap->length){case8:new->un_address.addr_family=AF_
INET;memcpy(&new->un_address.addr.v4,pEncap->value,4);have_vnc_tunnel_un=1;break
;case20:new->un_address.addr_family=AF_INET6;memcpy(&new->un_address.addr.v6,pEn
cap->value,16);have_vnc_tunnel_un=1;break;default:zlog_warn("%s:invalidtunnelsub
tlvUNaddrlength(%d)forbi%p",__func__,pEncap->length,bi);}break;default:zlog_warn
("%s:unknownEncapAttributeoptiontype%d",__func__,pEncap->type);break;}}new->un_o
ptions=rfapi_encap_tlv_to_un_option(bi->attr);#ifDEBUG_ENCAP_MONITORvnc_zlog_deb
ug_verbose("%s:line%d:have_vnc_tunnel_un=%d",__func__,__LINE__,have_vnc_tunnel_u
n);#endifif(!have_vnc_tunnel_un&&bi->extra){/**usecachedUNaddressfromENCAProute*
/new->un_address.addr_family=bi->extra->vnc.import.un_family;switch(new->un_addr
ess.addr_family){caseAF_INET:new->un_address.addr.v4=bi->extra->vnc.import.un.ad
dr4;break;caseAF_INET6:new->un_address.addr.v6=bi->extra->vnc.import.un.addr6;br
eak;default:zlog_warn("%s:invalidUNaddrfamily(%d)forbi%p",__func__,new->un_addre
ss.addr_family,bi);rfapi_free_next_hop_list(new);returnNULL;break;}}}new->lifeti
me=lifetime;returnnew;}intrfapiHasNonRemovedRoutes(structroute_node*rn){structbg
p_info*bi;for(bi=rn->info;bi;bi=bi->next){structprefixpfx;if(!CHECK_FLAG(bi->fla
gs,BGP_INFO_REMOVED)&&(bi->extra&&!rfapiGetUnAddrOfVpnBi(bi,&pfx))){return1;}}re
turn0;}#ifDEBUG_IT_NODES/**DEBUGFUNCTION*/voidrfapiDumpNode(structroute_node*rn)
{structbgp_info*bi;vnc_zlog_debug_verbose("%s:rn=%p",__func__,rn);for(bi=rn->inf
o;bi;bi=bi->next){structprefixpfx;intctrc=rfapiGetUnAddrOfVpnBi(bi,&pfx);intnr;i
f(!CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)&&(bi->extra&&!ctrc)){nr=1;}else{nr=0;}
vnc_zlog_debug_verbose("bi=%p,nr=%d,flags=0x%x,extra=%p,ctrc=%d",bi,nr,bi->flags
,bi->extra,ctrc);}}#endifstaticintrfapiNhlAddNodeRoutes(structroute_node*rn,/*in
*/structrfapi_ip_prefix*rprefix,/*in*/uint32_tlifetime,/*in*/intremoved,/*in*/st
ructrfapi_next_hop_entry**head,/*in/out*/structrfapi_next_hop_entry**tail,/*in/o
ut*/structrfapi_ip_addr*exclude_vnaddr,/*omitroutestosameNVE*/structroute_node*r
fd_rib_node,/*preloadthisNVEribnode*/structprefix*pfx_target_original)/*querytar
get*/{structbgp_info*bi;structrfapi_next_hop_entry*new;structprefixpfx_un;struct
skiplist*seen_nexthops;intcount=0;intis_l2=(rn->p.family==AF_ETHERNET);if(rfapiR
ibFTDFilterRecentPrefix((structrfapi_descriptor*)(rfd_rib_node->table->info),rn,
pfx_target_original)){return0;}seen_nexthops=skiplist_new(0,vnc_prefix_cmp,(void
(*)(void*))prefix_free);for(bi=rn->info;bi;bi=bi->next){structprefixpfx_vn;struc
tprefix*newpfx;if(removed&&!CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){#ifDEBUG_RET
URNED_NHLvnc_zlog_debug_verbose("%s:wantholddown,thisroutenotholddown,skip",__fu
nc__);#endifcontinue;}if(!removed&&CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){conti
nue;}if(!bi->extra){continue;}/**CheckforexcludedVNaddress*/if(rfapiVpnBiNhEqual
sPt(bi,exclude_vnaddr))continue;/**CheckforVNaddress(nexthop)copiedalready*/if(i
s_l2){/*L2routes:semanticnexthopinaux_prefix;VNaddr*ain'tit*/pfx_vn=bi->extra->v
nc.import.aux_prefix;}else{rfapiNexthop2Prefix(bi->attr,&pfx_vn);}if(!skiplist_s
earch(seen_nexthops,&pfx_vn,NULL)){#ifDEBUG_RETURNED_NHLcharbuf[PREFIX_STRLEN];p
refix2str(&pfx_vn,buf,sizeof(buf));vnc_zlog_debug_verbose("%s:alreadyputVN/nexth
op%s,skip",__func__,buf);#endifcontinue;}if(rfapiGetUnAddrOfVpnBi(bi,&pfx_un)){#
ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose("%s:failedtogetUNaddressofthisVPNbi"
,__func__);#endifcontinue;}newpfx=prefix_new();*newpfx=pfx_vn;skiplist_insert(se
en_nexthops,newpfx,newpfx);new=rfapiRouteInfo2NextHopEntry(rprefix,bi,lifetime,r
n);if(new){if(rfapiRibPreloadBi(rfd_rib_node,&pfx_vn,&pfx_un,lifetime,bi)){/*dup
licatefilteredbyRIB*/rfapi_free_next_hop_list(new);new=NULL;}}if(new){if(*tail){
(*tail)->next=new;}else{*head=new;}*tail=new;++count;}}skiplist_free(seen_nextho
ps);returncount;}/**Breadth-first**omit_nodeismeantforthesituationwhereweareaddi
ngasubtree*ofaparentofsomeoriginalrequestednode.Theresponsealready*containstheor
iginalrequestednode,andwedon'twanttoduplicate*itsroutesinthelist,soweskipitifthe
rightorleftnode*matches(ofcourse,westilltraveldownitschildsubtrees).*/staticintr
fapiNhlAddSubtree(structroute_node*rn,/*in*/uint32_tlifetime,/*in*/structrfapi_n
ext_hop_entry**head,/*in/out*/structrfapi_next_hop_entry**tail,/*in/out*/structr
oute_node*omit_node,/*in*/structrfapi_ip_addr*exclude_vnaddr,/*omitroutestosameN
VE*/structroute_table*rfd_rib_table,/*preloadhere*/structprefix*pfx_target_origi
nal)/*querytarget*/{structrfapi_ip_prefixrprefix;intrcount=0;/*FIXME:needtofinda
betterwayheretoworkwithoutstickingour*handsinnode->link*/if(rn->l_left&&rn->l_le
ft!=omit_node){if(rn->l_left->info){intcount=0;structroute_node*rib_rn=NULL;rfap
iQprefix2Rprefix(&rn->l_left->p,&rprefix);if(rfd_rib_table){rib_rn=route_node_ge
t(rfd_rib_table,&rn->l_left->p);}count=rfapiNhlAddNodeRoutes(rn->l_left,&rprefix
,lifetime,0,head,tail,exclude_vnaddr,rib_rn,pfx_target_original);if(!count){coun
t=rfapiNhlAddNodeRoutes(rn->l_left,&rprefix,lifetime,1,head,tail,exclude_vnaddr,
rib_rn,pfx_target_original);}rcount+=count;if(rib_rn)route_unlock_node(rib_rn);}
}if(rn->l_right&&rn->l_right!=omit_node){if(rn->l_right->info){intcount=0;struct
route_node*rib_rn=NULL;rfapiQprefix2Rprefix(&rn->l_right->p,&rprefix);if(rfd_rib
_table){rib_rn=route_node_get(rfd_rib_table,&rn->l_right->p);}count=rfapiNhlAddN
odeRoutes(rn->l_right,&rprefix,lifetime,0,head,tail,exclude_vnaddr,rib_rn,pfx_ta
rget_original);if(!count){count=rfapiNhlAddNodeRoutes(rn->l_right,&rprefix,lifet
ime,1,head,tail,exclude_vnaddr,rib_rn,pfx_target_original);}rcount+=count;if(rib
_rn)route_unlock_node(rib_rn);}}if(rn->l_left){rcount+=rfapiNhlAddSubtree(rn->l_
left,lifetime,head,tail,omit_node,exclude_vnaddr,rfd_rib_table,pfx_target_origin
al);}if(rn->l_right){rcount+=rfapiNhlAddSubtree(rn->l_right,lifetime,head,tail,o
mit_node,exclude_vnaddr,rfd_rib_table,pfx_target_original);}returnrcount;}/**Imp
lementationofROUTE_LIST(node)fromRFAPI-Import-Event-Handling.txt**Constructanrfa
pinexthoplistbasedontheroutesattachedto*thespecifiednode.**Ifthereareanyroutesth
atdoNOThaveBGP_INFO_REMOVEDset,*returnthoseonly.IfthereareONLYrouteswithBGP_INFO
_REMOVED,*thenreturnthose,andalsoincludeallthenon-removedroutesfromthe*nextless-
specificnode(i.e.,thisnode'sparent)attheend.*/structrfapi_next_hop_entry*rfapiRo
uteNode2NextHopList(structroute_node*rn,uint32_tlifetime,/*putintonexthopentries
*/structrfapi_ip_addr*exclude_vnaddr,/*omitroutestosameNVE*/structroute_table*rf
d_rib_table,/*preloadhere*/structprefix*pfx_target_original)/*querytarget*/{stru
ctrfapi_ip_prefixrprefix;structrfapi_next_hop_entry*answer=NULL;structrfapi_next
_hop_entry*last=NULL;structroute_node*parent;intcount=0;structroute_node*rib_rn;
#ifDEBUG_RETURNED_NHL{charbuf[PREFIX_STRLEN];prefix2str(&rn->p,buf,sizeof(buf));
vnc_zlog_debug_verbose("%s:calledwithnodepfx=%s",__func__,buf);}rfapiDebugBacktr
ace();#endifrfapiQprefix2Rprefix(&rn->p,&rprefix);rib_rn=rfd_rib_table?route_nod
e_get(rfd_rib_table,&rn->p):NULL;/**Addnon-withdrawnroutesatthisnode*/count=rfap
iNhlAddNodeRoutes(rn,&rprefix,lifetime,0,&answer,&last,exclude_vnaddr,rib_rn,pfx
_target_original);/**Ifthelisthasatleastoneentry,it'sfinished*/if(count){count+=
rfapiNhlAddSubtree(rn,lifetime,&answer,&last,NULL,exclude_vnaddr,rfd_rib_table,p
fx_target_original);vnc_zlog_debug_verbose("%s:%dnexthops,answer=%p",__func__,co
unt,answer);#ifDEBUG_RETURNED_NHLrfapiPrintNhl(NULL,answer);#endifif(rib_rn)rout
e_unlock_node(rib_rn);returnanswer;}/**Addwithdrawnroutesatthisnode*/count=rfapi
NhlAddNodeRoutes(rn,&rprefix,lifetime,1,&answer,&last,exclude_vnaddr,rib_rn,pfx_
target_original);if(rib_rn)route_unlock_node(rib_rn);//rfapiPrintNhl(NULL,answer
);/**walkupthetreeuntilwefindanodewithnon-deleted*routes,thenaddthem*/for(parent
=rn->parent;parent;parent=parent->parent){if(rfapiHasNonRemovedRoutes(parent)){b
reak;}}/**Addnon-withdrawnroutesfromless-specificprefix*/if(parent){rib_rn=rfd_r
ib_table?route_node_get(rfd_rib_table,&parent->p):NULL;rfapiQprefix2Rprefix(&par
ent->p,&rprefix);count+=rfapiNhlAddNodeRoutes(parent,&rprefix,lifetime,0,&answer
,&last,exclude_vnaddr,rib_rn,pfx_target_original);count+=rfapiNhlAddSubtree(pare
nt,lifetime,&answer,&last,rn,exclude_vnaddr,rfd_rib_table,pfx_target_original);i
f(rib_rn)route_unlock_node(rib_rn);}else{/**Thereisnoparentwithnon-removedroutes
.Stillneedto*addsubtreeoforiginalnodeifitcontributedroutestothe*answer.*/if(coun
t)count+=rfapiNhlAddSubtree(rn,lifetime,&answer,&last,rn,exclude_vnaddr,rfd_rib_
table,pfx_target_original);}vnc_zlog_debug_verbose("%s:%dnexthops,answer=%p",__f
unc__,count,answer);#ifDEBUG_RETURNED_NHLrfapiPrintNhl(NULL,answer);#endifreturn
answer;}/**Constructnexthoplistofallroutesintable*/structrfapi_next_hop_entry*rf
apiRouteTable2NextHopList(structroute_table*rt,uint32_tlifetime,/*putintonexthop
entries*/structrfapi_ip_addr*exclude_vnaddr,/*omitroutestosameNVE*/structroute_t
able*rfd_rib_table,/*preloadthisNVEribtable*/structprefix*pfx_target_original)/*
querytarget*/{structroute_node*rn;structrfapi_next_hop_entry*biglist=NULL;struct
rfapi_next_hop_entry*nhl;structrfapi_next_hop_entry*tail=NULL;intcount=0;for(rn=
route_top(rt);rn;rn=route_next(rn)){nhl=rfapiRouteNode2NextHopList(rn,lifetime,e
xclude_vnaddr,rfd_rib_table,pfx_target_original);if(!tail){tail=biglist=nhl;if(t
ail)count=1;}else{tail->next=nhl;}if(tail){while(tail->next){++count;tail=tail->
next;}}}vnc_zlog_debug_verbose("%s:returning%droutes",__func__,count);returnbigl
ist;}structrfapi_next_hop_entry*rfapiEthRouteNode2NextHopList(structroute_node*r
n,structrfapi_ip_prefix*rprefix,uint32_tlifetime,/*putintonexthopentries*/struct
rfapi_ip_addr*exclude_vnaddr,/*omitroutestosameNVE*/structroute_table*rfd_rib_ta
ble,/*preloadNVEribtable*/structprefix*pfx_target_original)/*querytarget*/{intco
unt=0;structrfapi_next_hop_entry*answer=NULL;structrfapi_next_hop_entry*last=NUL
L;structroute_node*rib_rn;rib_rn=rfd_rib_table?route_node_get(rfd_rib_table,&rn-
>p):NULL;count=rfapiNhlAddNodeRoutes(rn,rprefix,lifetime,0,&answer,&last,NULL,ri
b_rn,pfx_target_original);#ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose("%s:node%
p:%dnon-holddownroutes",__func__,rn,count);#endifif(!count){count=rfapiNhlAddNod
eRoutes(rn,rprefix,lifetime,1,&answer,&last,exclude_vnaddr,rib_rn,pfx_target_ori
ginal);vnc_zlog_debug_verbose("%s:node%p:%dholddownroutes",__func__,rn,count);}i
f(rib_rn)route_unlock_node(rib_rn);#ifDEBUG_RETURNED_NHLrfapiPrintNhl(NULL,answe
r);#endifreturnanswer;}/**Constructnexthoplistofallroutesintable*/structrfapi_ne
xt_hop_entry*rfapiEthRouteTable2NextHopList(uint32_tlogical_net_id,structrfapi_i
p_prefix*rprefix,uint32_tlifetime,/*putintonexthopentries*/structrfapi_ip_addr*e
xclude_vnaddr,/*omitroutestosameNVE*/structroute_table*rfd_rib_table,/*preloadNV
Eribnode*/structprefix*pfx_target_original)/*querytarget*/{structrfapi_import_ta
ble*it;structbgp*bgp=bgp_get_default();structroute_table*rt;structroute_node*rn;
structrfapi_next_hop_entry*biglist=NULL;structrfapi_next_hop_entry*nhl;structrfa
pi_next_hop_entry*tail=NULL;intcount=0;it=rfapiMacImportTableGet(bgp,logical_net
_id);rt=it->imported_vpn[AFI_L2VPN];for(rn=route_top(rt);rn;rn=route_next(rn)){n
hl=rfapiEthRouteNode2NextHopList(rn,rprefix,lifetime,exclude_vnaddr,rfd_rib_tabl
e,pfx_target_original);if(!tail){tail=biglist=nhl;if(tail)count=1;}else{tail->ne
xt=nhl;}if(tail){while(tail->next){++count;tail=tail->next;}}}vnc_zlog_debug_ver
bose("%s:returning%droutes",__func__,count);returnbiglist;}/**Insertanewbitothei
mportedroutetablenode,*keepingthelistofBIssortedbestroutefirst*/staticvoidrfapiB
gpInfoAttachSorted(structroute_node*rn,structbgp_info*info_new,afi_tafi,safi_tsa
fi){structbgp*bgp;structbgp_info*prev;structbgp_info*next;charpfx_buf[PREFIX2STR
_BUFFER];bgp=bgp_get_default();/*assume1instancefornow*/if(VNC_DEBUG(IMPORT_BI_A
TTACH)){vnc_zlog_debug_verbose("%s:info_new->peer=%p",__func__,info_new->peer);v
nc_zlog_debug_verbose("%s:info_new->peer->su_remote=%p",__func__,info_new->peer-
>su_remote);}for(prev=NULL,next=rn->info;next;prev=next,next=next->next){if(!bgp
||(!CHECK_FLAG(info_new->flags,BGP_INFO_REMOVED)&&CHECK_FLAG(next->flags,BGP_INF
O_REMOVED))||bgp_info_cmp_compatible(bgp,info_new,next,pfx_buf,afi,safi)==-1){/*
-1if1stisbetter*/break;}}vnc_zlog_debug_verbose("%s:prev=%p,next=%p",__func__,pr
ev,next);if(prev){prev->next=info_new;}else{rn->info=info_new;}info_new->prev=pr
ev;info_new->next=next;if(next)next->prev=info_new;bgp_attr_intern(info_new->att
r);}staticvoidrfapiBgpInfoDetach(structroute_node*rn,structbgp_info*bi){/**Remov
etheroute(doubly-linked)*///bgp_attr_unintern(&bi->attr);if(bi->next)bi->next->p
rev=bi->prev;if(bi->prev)bi->prev->next=bi->next;elsern->info=bi->next;}/**ForL3
-indexedimporttables*/staticintrfapi_bi_peer_rd_cmp(void*b1,void*b2){structbgp_i
nfo*bi1=b1;structbgp_info*bi2=b2;/**Comparepeers*/if(bi1->peer<bi2->peer)return-
1;if(bi1->peer>bi2->peer)return1;/**compareRDs*/returnvnc_prefix_cmp((structpref
ix*)&bi1->extra->vnc.import.rd,(structprefix*)&bi2->extra->vnc.import.rd);}/**Fo
rL2-indexedimporttables*TheBIsinthesetablesshouldALWAYShaveanaux_prefixsetbecaus
e*theyarriveviaIPv4orIPv6advertisements.*/staticintrfapi_bi_peer_rd_aux_cmp(void
*b1,void*b2){structbgp_info*bi1=b1;structbgp_info*bi2=b2;intrc;/**Comparepeers*/
if(bi1->peer<bi2->peer)return-1;if(bi1->peer>bi2->peer)return1;/**compareRDs*/rc
=vnc_prefix_cmp((structprefix*)&bi1->extra->vnc.import.rd,(structprefix*)&bi2->e
xtra->vnc.import.rd);if(rc){returnrc;}/**L2importtablescanhavemultipleentrieswit
hthe*sameMACaddress,sameRD,butdifferentL3addresses.**Usepresenceofaux_prefixwith
AF=ethernetandprefixlen=1*asmagicvaluetosignifyexplicitwildcardingoftheaux_prefi
x.*Thismagicvaluewillnotappearinbonafidebientriesin*theimporttable,butisallowedi
nthe"fake"biusedto*probethetablewhensearching.(Wehavetotestbothb1andb2*becauseth
ereisnoguaranteeoftheorderthetestkeyand*therealkeywillbepassed)*/if((bi1->extra-
>vnc.import.aux_prefix.family==AF_ETHERNET&&(bi1->extra->vnc.import.aux_prefix.p
refixlen==1))||(bi2->extra->vnc.import.aux_prefix.family==AF_ETHERNET&&(bi2->ext
ra->vnc.import.aux_prefix.prefixlen==1))){/**wildcardauxaddressspecified*/return
0;}returnvnc_prefix_cmp(&bi1->extra->vnc.import.aux_prefix,&bi2->extra->vnc.impo
rt.aux_prefix);}/**IndexonRDandPeer*/staticvoidrfapiItBiIndexAdd(structroute_nod
e*rn,/*ImporttableVPNnode*/structbgp_info*bi)/*newBI*/{structskiplist*sl;assert(
rn);assert(bi);assert(bi->extra);{charbuf[RD_ADDRSTRLEN];vnc_zlog_debug_verbose(
"%s:bi%p,peer%p,rd%s",__func__,bi,bi->peer,prefix_rd2str(&bi->extra->vnc.import.
rd,buf,sizeof(buf)));}sl=RFAPI_RDINDEX_W_ALLOC(rn);if(!sl){if(AF_ETHERNET==rn->p
.family){sl=skiplist_new(0,rfapi_bi_peer_rd_aux_cmp,NULL);}else{sl=skiplist_new(
0,rfapi_bi_peer_rd_cmp,NULL);}RFAPI_IT_EXTRA_GET(rn)->u.vpn.idx_rd=sl;route_lock
_node(rn);/*forskiplist*/}assert(!skiplist_insert(sl,(void*)bi,(void*)bi));route
_lock_node(rn);/*forskiplistentry*//*NB:BIsinimporttablesarenotrefcounted*/}stat
icvoidrfapiItBiIndexDump(structroute_node*rn){structskiplist*sl;void*cursor=NULL
;structbgp_info*k;structbgp_info*v;intrc;sl=RFAPI_RDINDEX(rn);if(!sl)return;for(
rc=skiplist_next(sl,(void**)&k,(void**)&v,&cursor);!rc;rc=skiplist_next(sl,(void
**)&k,(void**)&v,&cursor)){charbuf[RD_ADDRSTRLEN];charbuf_aux_pfx[PREFIX_STRLEN]
;prefix_rd2str(&k->extra->vnc.import.rd,buf,sizeof(buf));if(k->extra->vnc.import
.aux_prefix.family){prefix2str(&k->extra->vnc.import.aux_prefix,buf_aux_pfx,size
of(buf_aux_pfx));}elsestrncpy(buf_aux_pfx,"(none)",PREFIX_STRLEN);vnc_zlog_debug
_verbose("bi%p,peer%p,rd%s,aux_prefix%s",k,k->peer,buf,buf_aux_pfx);}}staticstru
ctbgp_info*rfapiItBiIndexSearch(structroute_node*rn,/*ImporttableVPNnode*/struct
prefix_rd*prd,structpeer*peer,structprefix*aux_prefix)/*optionalL3addrforL2ITs*/
{structskiplist*sl;intrc;structbgp_infobi_fake;structbgp_info_extrabi_extra;stru
ctbgp_info*bi_result;sl=RFAPI_RDINDEX(rn);if(!sl)returnNULL;#ifDEBUG_BI_SEARCH{c
harbuf[RD_ADDRSTRLEN];charbuf_aux_pfx[PREFIX_STRLEN];if(aux_prefix){prefix2str(a
ux_prefix,buf_aux_pfx,sizeof(buf_aux_pfx));}elsestrncpy(buf_aux_pfx,"(nil)",size
of(buf_aux_pfx));vnc_zlog_debug_verbose("%swantprd=%s,peer=%p,aux_prefix=%s",__f
unc__,prefix_rd2str(prd,buf,sizeof(buf)),peer,buf_aux_pfx);rfapiItBiIndexDump(rn
);}#endif/*thresholdisaWAG*/if(sl->count<3){#ifDEBUG_BI_SEARCHvnc_zlog_debug_ver
bose("%s:shortlistalgorithm",__func__);#endif/*ifshortlist,linearsearchmightbefa
ster*/for(bi_result=rn->info;bi_result;bi_result=bi_result->next){#ifDEBUG_BI_SE
ARCH{charbuf[RD_ADDRSTRLEN];vnc_zlog_debug_verbose("%s:bihasprd=%s,peer=%p",__fu
nc__,prefix_rd2str(&bi_result->extra->vnc.import.rd,buf,sizeof(buf)),bi_result->
peer);}#endifif(peer==bi_result->peer&&!prefix_cmp((structprefix*)&bi_result->ex
tra->vnc.import.rd,(structprefix*)prd)){#ifDEBUG_BI_SEARCHvnc_zlog_debug_verbose
("%s:peerandRDsame,doingaux_prefixcheck",__func__);#endifif(!aux_prefix||!prefix
_cmp(aux_prefix,&bi_result->extra->vnc.import.aux_prefix)){#ifDEBUG_BI_SEARCHvnc
_zlog_debug_verbose("%s:match",__func__);#endifbreak;}}}returnbi_result;}bi_fake
.peer=peer;bi_fake.extra=&bi_extra;bi_fake.extra->vnc.import.rd=*(structprefix_r
d*)prd;if(aux_prefix){bi_fake.extra->vnc.import.aux_prefix=*aux_prefix;}else{/*w
ildcard*/bi_fake.extra->vnc.import.aux_prefix.family=AF_ETHERNET;bi_fake.extra->
vnc.import.aux_prefix.prefixlen=1;}rc=skiplist_search(sl,(void*)&bi_fake,(void*)
&bi_result);if(rc){#ifDEBUG_BI_SEARCHvnc_zlog_debug_verbose("%s:nomatch",__func_
_);#endifreturnNULL;}#ifDEBUG_BI_SEARCHvnc_zlog_debug_verbose("%s:matchedbi=%p",
__func__,bi_result);#endifreturnbi_result;}staticvoidrfapiItBiIndexDel(structrou
te_node*rn,/*ImporttableVPNnode*/structbgp_info*bi)/*oldBI*/{structskiplist*sl;i
ntrc;{charbuf[RD_ADDRSTRLEN];vnc_zlog_debug_verbose("%s:bi%p,peer%p,rd%s",__func
__,bi,bi->peer,prefix_rd2str(&bi->extra->vnc.import.rd,buf,sizeof(buf)));}sl=RFA
PI_RDINDEX(rn);assert(sl);rc=skiplist_delete(sl,(void*)(bi),(void*)bi);if(rc){rf
apiItBiIndexDump(rn);}assert(!rc);route_unlock_node(rn);/*forskiplistentry*//*NB
:BIsinimporttablesarenotrefcounted*/}/**AddabackreferenceattheENCAPnodetotheVPNr
outethat*referstoit*/staticvoidrfapiMonitorEncapAdd(structrfapi_import_table*imp
ort_table,structprefix*p,/*VNaddress*/structroute_node*vpn_rn,/*VPNnode*/structb
gp_info*vpn_bi)/*VPNbi/route*/{afi_tafi=family2afi(p->family);structroute_node*r
n;structrfapi_monitor_encap*m;assert(afi);rn=route_node_get(import_table->import
ed_encap[afi],p);/*locksrn*/assert(rn);m=XCALLOC(MTYPE_RFAPI_MONITOR_ENCAP,sizeo
f(structrfapi_monitor_encap));assert(m);m->node=vpn_rn;m->bi=vpn_bi;m->rn=rn;/*i
nserttoencapnode'slist*/m->next=RFAPI_MONITOR_ENCAP(rn);if(m->next)m->next->prev
=m;RFAPI_MONITOR_ENCAP_W_ALLOC(rn)=m;/*foreasylookupwhendeletingvpnroute*/vpn_bi
->extra->vnc.import.hme=m;vnc_zlog_debug_verbose("%s:it=%p,vpn_bi=%p,afi=%d,enca
prn=%p,settingvpn_bi->extra->vnc.import.hme=%p",__func__,import_table,vpn_bi,afi
,rn,m);RFAPI_CHECK_REFCOUNT(rn,SAFI_ENCAP,0);bgp_attr_intern(vpn_bi->attr);}stat
icvoidrfapiMonitorEncapDelete(structbgp_info*vpn_bi){/**Removeencapmonitor*/vnc_
zlog_debug_verbose("%s:vpn_bi=%p",__func__,vpn_bi);if(vpn_bi->extra){structrfapi
_monitor_encap*hme=vpn_bi->extra->vnc.import.hme;if(hme){vnc_zlog_debug_verbose(
"%s:hme=%p",__func__,hme);/*Refcountcheckingtakestoolonghere*///RFAPI_CHECK_REFC
OUNT(hme->rn,SAFI_ENCAP,0);if(hme->next)hme->next->prev=hme->prev;if(hme->prev)h
me->prev->next=hme->next;elseRFAPI_MONITOR_ENCAP_W_ALLOC(hme->rn)=hme->next;/*Re
fcountcheckingtakestoolonghere*///RFAPI_CHECK_REFCOUNT(hme->rn,SAFI_ENCAP,1);/*s
eeifthestructrfapi_it_extraisemptyandcanbe*freed*/rfapiMonitorExtraPrune(SAFI_EN
CAP,hme->rn);route_unlock_node(hme->rn);/*decrrefcount*/XFREE(MTYPE_RFAPI_MONITO
R_ENCAP,hme);vpn_bi->extra->vnc.import.hme=NULL;}}}/**quaggalib/thread.hsaysthis
mustreturninteventhough*itdoesn'tdoanythingwiththereturnvalue*/staticintrfapiWit
hdrawTimerVPN(structthread*t){structrfapi_withdraw*wcb=t->arg;structbgp_info*bi=
wcb->info;structbgp*bgp=bgp_get_default();structrfapi_monitor_vpn*moved;afi_tafi
;assert(wcb->node);assert(bi);assert(wcb->import_table);assert(bi->extra);RFAPI_
CHECK_REFCOUNT(wcb->node,SAFI_MPLS_VPN,wcb->lockoffset);{charbuf[BUFSIZ];vnc_zlo
g_debug_verbose("%s:removingbi%patprefix%s/%d",__func__,bi,rfapi_ntop(wcb->node-
>p.family,&wcb->node->p.u.prefix,buf,BUFSIZ),wcb->node->p.prefixlen);}/**Removet
heroute(doubly-linked)*/if(CHECK_FLAG(bi->flags,BGP_INFO_VALID)&&VALID_INTERIOR_
TYPE(bi->type))RFAPI_MONITOR_EXTERIOR(wcb->node)->valid_interior_count--;afi=fam
ily2afi(wcb->node->p.family);wcb->import_table->holddown_count[afi]-=1;/*keepcou
ntconsistent*/rfapiItBiIndexDel(wcb->node,bi);rfapiBgpInfoDetach(wcb->node,bi);/
*withremovedbi*/vnc_import_bgp_exterior_del_route_interior(bgp,wcb->import_table
,wcb->node,bi);/**IfVNCisconfiguredtosendresponseremovemessages,AND*iftheremoved
routehadaUNaddress,doresponseremoval*processing.*/if(!(bgp->rfapi_cfg->flags&BGP
_VNC_CONFIG_RESPONSE_REMOVAL_DISABLE)){inthas_valid_duplicate=0;structbgp_info*b
ii;/**FirstcheckifthereareanyOTHERroutesatthisnode*thathavethesamenexthopandaval
idUNaddress.If*thereare(e.g.,fromotherpeers),thentherouteisn't*reallygone,soskip
sendingaresponseremovalmessage.*/for(bii=wcb->node->info;bii;bii=bii->next){if(r
fapiVpnBiSamePtUn(bi,bii)){has_valid_duplicate=1;break;}}vnc_zlog_debug_verbose(
"%s:has_valid_duplicate=%d",__func__,has_valid_duplicate);if(!has_valid_duplicat
e){rfapiRibPendingDeleteRoute(bgp,wcb->import_table,afi,wcb->node);}}rfapiMonito
rEncapDelete(bi);/**IftherearenoVPNmonitorsatthisVPNNodeA,*wearedone*/if(!RFAPI_
MONITOR_VPN(wcb->node)){vnc_zlog_debug_verbose("%s:noVPNmonitorsatthisnode",__fu
nc__);gotodone;}/**rfapiMonitorMoveShorteronlymovesmonitorsifthereare*noremainin
gvalidroutesatthecurrentnode*/moved=rfapiMonitorMoveShorter(wcb->node,1);if(move
d){rfapiMonitorMovedUp(wcb->import_table,wcb->node,moved->node,moved);}done:/**F
reeVPNbi*/rfapiBgpInfoFree(bi);wcb->info=NULL;/**Ifroutecountatthisnodehasgoneto
0,withdrawexportedprefix*/if(!wcb->node->info){/*seeifthestructrfapi_it_extraise
mptyandcanbefreed*/rfapiMonitorExtraPrune(SAFI_MPLS_VPN,wcb->node);vnc_direct_bg
p_del_prefix(bgp,wcb->import_table,wcb->node);vnc_zebra_del_prefix(bgp,wcb->impo
rt_table,wcb->node);}else{/**nexthopchangeevent*vnc_direct_bgp_add_prefix()willr
ecomputetheVNaddr*ecommunity*/vnc_direct_bgp_add_prefix(bgp,wcb->import_table,wc
b->node);}RFAPI_CHECK_REFCOUNT(wcb->node,SAFI_MPLS_VPN,1+wcb->lockoffset);route_
unlock_node(wcb->node);/*decrrefcount*/XFREE(MTYPE_RFAPI_WITHDRAW,wcb);return0;}
/**Thisworksformultiprotocolextension,butnotforplainol'*unicastIPv4becausethatne
xthopisstoredinattr->nexthop*/voidrfapiNexthop2Prefix(structattr*attr,structpref
ix*p){assert(p);assert(attr);memset(p,0,sizeof(structprefix));switch(p->family=B
GP_MP_NEXTHOP_FAMILY(attr->mp_nexthop_len)){caseAF_INET:p->u.prefix4=attr->mp_ne
xthop_global_in;p->prefixlen=32;break;caseAF_INET6:p->u.prefix6=attr->mp_nexthop
_global;p->prefixlen=128;break;default:vnc_zlog_debug_verbose("%s:Familyisunknow
n=%d",__func__,p->family);}}voidrfapiUnicastNexthop2Prefix(afi_tafi,structattr*a
ttr,structprefix*p){if(afi==AFI_IP){p->family=AF_INET;p->prefixlen=32;p->u.prefi
x4=attr->nexthop;}else{rfapiNexthop2Prefix(attr,p);}}staticintrfapiAttrNexthopAd
drDifferent(structprefix*p1,structprefix*p2){if(!p1||!p2){vnc_zlog_debug_verbose
("%s:p1orp2isNULL",__func__);return1;}/**Areaddressfamiliesthesame?*/if(p1->fami
ly!=p2->family){return1;}switch(p1->family){caseAF_INET:if(IPV4_ADDR_SAME(&p1->u
.prefix4,&p2->u.prefix4))return0;break;caseAF_INET6:if(IPV6_ADDR_SAME(&p1->u.pre
fix6,&p2->u.prefix6))return0;break;default:assert(1);}return1;}staticvoidrfapiCo
pyUnEncap2VPN(structbgp_info*encap_bi,structbgp_info*vpn_bi){if(!encap_bi->attr)
{zlog_warn("%s:noencapbiattr/extra,can'tcopyUNaddress",__func__);return;}if(!vpn
_bi||!vpn_bi->extra){zlog_warn("%s:novpnbiattr/extra,can'tcopyUNaddress",__func_
_);return;}switch(BGP_MP_NEXTHOP_FAMILY(encap_bi->attr->mp_nexthop_len)){caseAF_
INET:/**instrumentationtodebugsegfaultof091127*/vnc_zlog_debug_verbose("%s:vpn_b
i=%p",__func__,vpn_bi);if(vpn_bi){vnc_zlog_debug_verbose("%s:vpn_bi->extra=%p",_
_func__,vpn_bi->extra);}vpn_bi->extra->vnc.import.un_family=AF_INET;vpn_bi->extr
a->vnc.import.un.addr4=encap_bi->attr->mp_nexthop_global_in;break;caseAF_INET6:v
pn_bi->extra->vnc.import.un_family=AF_INET6;vpn_bi->extra->vnc.import.un.addr6=e
ncap_bi->attr->mp_nexthop_global;break;default:zlog_warn("%s:invalidencapnexthop
length:%d",__func__,encap_bi->attr->mp_nexthop_len);vpn_bi->extra->vnc.import.un
_family=0;break;}}/**returns0onsuccess,nonzeroonerror*/staticintrfapiWithdrawEnc
apUpdateCachedUn(structrfapi_import_table*import_table,structbgp_info*encap_bi,s
tructroute_node*vpn_rn,structbgp_info*vpn_bi){if(!encap_bi){/**clearcachedUNaddr
ess*/if(!vpn_bi||!vpn_bi->extra){zlog_warn("%s:missingVPNbi/extra,can'tclearUNad
dr",__func__);return1;}vpn_bi->extra->vnc.import.un_family=0;memset(&vpn_bi->ext
ra->vnc.import.un,0,sizeof(vpn_bi->extra->vnc.import.un));if(CHECK_FLAG(vpn_bi->
flags,BGP_INFO_VALID)){if(rfapiGetVncTunnelUnAddr(vpn_bi->attr,NULL)){UNSET_FLAG
(vpn_bi->flags,BGP_INFO_VALID);if(VALID_INTERIOR_TYPE(vpn_bi->type))RFAPI_MONITO
R_EXTERIOR(vpn_rn)->valid_interior_count--;/*signalinteriorroutewithdrawalto*imp
ort-exterior*/vnc_import_bgp_exterior_del_route_interior(bgp_get_default(),impor
t_table,vpn_rn,vpn_bi);}}}else{if(!vpn_bi){zlog_warn("%s:missingVPNbi,can'tclear
UNaddr",__func__);return1;}rfapiCopyUnEncap2VPN(encap_bi,vpn_bi);if(!CHECK_FLAG(
vpn_bi->flags,BGP_INFO_VALID)){SET_FLAG(vpn_bi->flags,BGP_INFO_VALID);if(VALID_I
NTERIOR_TYPE(vpn_bi->type))RFAPI_MONITOR_EXTERIOR(vpn_rn)->valid_interior_count+
+;/*signalinteriorroutewithdrawaltoimport-exterior*/vnc_import_bgp_exterior_add_
route_interior(bgp_get_default(),import_table,vpn_rn,vpn_bi);}}return0;}staticin
trfapiWithdrawTimerEncap(structthread*t){structrfapi_withdraw*wcb=t->arg;structb
gp_info*bi=wcb->info;intwas_first_route=0;structrfapi_monitor_encap*em;structski
plist*vpn_node_sl=skiplist_new(0,NULL,NULL);assert(wcb->node);assert(bi);assert(
wcb->import_table);RFAPI_CHECK_REFCOUNT(wcb->node,SAFI_ENCAP,0);if(wcb->node->in
fo==bi)was_first_route=1;/**Removetheroute/biandfreeit*/rfapiBgpInfoDetach(wcb->
node,bi);rfapiBgpInfoFree(bi);if(!was_first_route)gotodone;for(em=RFAPI_MONITOR_
ENCAP(wcb->node);em;em=em->next){/**UpdatemonitoringVPNBIswithnewencapinfoatthe*
headoftheencapbichain(whichcouldbeNULLafter*removingtheexpiringbiabove)*/if(rfap
iWithdrawEncapUpdateCachedUn(wcb->import_table,wcb->node->info,em->node,em->bi))
continue;/**BuildalistofuniqueVPNnodesreferencedbythese*monitors.*Useaskiplistfo
rspeed.*/skiplist_insert(vpn_node_sl,em->node,em->node);}/**foreachVPNnoderefere
ncedintheENCAPmonitors:*/structroute_node*rn;while(!skiplist_first(vpn_node_sl,(
void**)&rn,NULL)){if(!wcb->node->info){structrfapi_monitor_vpn*moved;moved=rfapi
MonitorMoveShorter(rn,0);if(moved){//rfapiDoRouteCallback(wcb->import_table,//mo
ved->node,moved);rfapiMonitorMovedUp(wcb->import_table,rn,moved->node,moved);}}e
lse{//rfapiDoRouteCallback(wcb->import_table,rn,NULL);rfapiMonitorItNodeChanged(
wcb->import_table,rn,NULL);}skiplist_delete_first(vpn_node_sl);}done:RFAPI_CHECK
_REFCOUNT(wcb->node,SAFI_ENCAP,1);route_unlock_node(wcb->node);/*decrrefcount*/X
FREE(MTYPE_RFAPI_WITHDRAW,wcb);skiplist_free(vpn_node_sl);return0;}/**Worksforbo
thVPNandENCAProutes;timer_service_funcisdifferent*ineachcase*/staticvoidrfapiBiS
tartWithdrawTimer(structrfapi_import_table*import_table,structroute_node*rn,stru
ctbgp_info*bi,afi_tafi,safi_tsafi,int(*timer_service_func)(structthread*)){uint3
2_tlifetime;structrfapi_withdraw*wcb;ifCHECK_FLAG(bi->flags,BGP_INFO_REMOVED){/*
*Alreadyonthepathtobeingwithdrawn,*shouldalreadyhaveatimersetupto*deleteit.*/vnc
_zlog_debug_verbose("%s:alreadybeingwithdrawn,donothing",__func__);return;}rfapi
GetVncLifetime(bi->attr,&lifetime);vnc_zlog_debug_verbose("%s:VNClifetimeis%u",_
_func__,lifetime);/**withdrawnroutesgettohangaroundforawhile*/SET_FLAG(bi->flags
,BGP_INFO_REMOVED);/*settimertoremovetheroutelater*/lifetime=rfapiGetHolddownFro
mLifetime(lifetime);vnc_zlog_debug_verbose("%s:usingtimeout%u",__func__,lifetime
);/**Stashimport_table,node,andinfoforusebytimer*serviceroutine,whichissupposedt
ofreethewcb.*/wcb=XCALLOC(MTYPE_RFAPI_WITHDRAW,sizeof(structrfapi_withdraw));ass
ert(wcb);wcb->node=rn;wcb->info=bi;wcb->import_table=import_table;bgp_attr_inter
n(bi->attr);if(VNC_DEBUG(VERBOSE)){vnc_zlog_debug_verbose("%s:wcbvalues:node=%p,
info=%p,import_table=%p(bifollows)",__func__,wcb->node,wcb->info,wcb->import_tab
le);rfapiPrintBi(NULL,bi);}assert(bi->extra);if(lifetime>UINT32_MAX/1001){/*sub-
optimalcase,butwillprobablyneverhappen*/bi->extra->vnc.import.timer=NULL;thread_
add_timer(bm->master,timer_service_func,wcb,lifetime,&bi->extra->vnc.import.time
r);}else{staticuint32_tjitter;uint32_tlifetime_msec;/**thegoalhereistospreadoutt
hetimerssotheyare*sortableintheskiplist*/if(++jitter>=1000)jitter=0;lifetime_mse
c=(lifetime*1000)+jitter;bi->extra->vnc.import.timer=NULL;thread_add_timer_msec(
bm->master,timer_service_func,wcb,lifetime_msec,&bi->extra->vnc.import.timer);}/
*re-sortroutelist(BGP_INFO_REMOVEDroutesarelast)*/if(((structbgp_info*)rn->info)
->next){rfapiBgpInfoDetach(rn,bi);rfapiBgpInfoAttachSorted(rn,bi,afi,safi);}}typ
edefvoid(rfapi_bi_filtered_import_f)(structrfapi_import_table*,int,structpeer*,v
oid*,structprefix*,structprefix*,afi_t,structprefix_rd*,structattr*,uint8_t,uint
8_t,uint32_t*);staticvoidrfapiExpireEncapNow(structrfapi_import_table*it,structr
oute_node*rn,structbgp_info*bi){structrfapi_withdraw*wcb;structthreadt;/**preten
dwe'reanexpiringtimer*/wcb=XCALLOC(MTYPE_RFAPI_WITHDRAW,sizeof(structrfapi_withd
raw));wcb->info=bi;wcb->node=rn;wcb->import_table=it;memset(&t,0,sizeof(t));t.ar
g=wcb;rfapiWithdrawTimerEncap(&t);/*freeswcb*/}staticintrfapiGetNexthop(structat
tr*attr,structprefix*prefix){switch(BGP_MP_NEXTHOP_FAMILY(attr->mp_nexthop_len))
{caseAF_INET:prefix->family=AF_INET;prefix->prefixlen=32;prefix->u.prefix4=attr-
>mp_nexthop_global_in;break;caseAF_INET6:prefix->family=AF_INET6;prefix->prefixl
en=128;prefix->u.prefix6=attr->mp_nexthop_global;break;default:vnc_zlog_debug_ve
rbose("%s:unknownattr->mp_nexthop_len%d",__func__,attr->mp_nexthop_len);returnEI
NVAL;}return0;}/**importabgp_infoifitsroutetargetlistintersectswiththe*importtab
le'sroutetargetlist*/staticvoidrfapiBgpInfoFilteredImportEncap(structrfapi_impor
t_table*import_table,intaction,structpeer*peer,void*rfd,/*setforloopedbackroutes
*/structprefix*p,structprefix*aux_prefix,/*Unusedforencaproutes*/afi_tafi,struct
prefix_rd*prd,structattr*attr,/*partofbgp_info*/uint8_ttype,/*partofbgp_info*/ui
nt8_tsub_type,/*partofbgp_info*/uint32_t*label)/*partofbgp_info*/{structroute_ta
ble*rt=NULL;structroute_node*rn;structbgp_info*info_new;structbgp_info*bi;struct
bgp_info*next;charbuf[BUFSIZ];structprefixp_firstbi_old;structprefixp_firstbi_ne
w;intreplacing=0;constchar*action_str=NULL;structprefixun_prefix;structbgp*bgp;b
gp=bgp_get_default();/*assume1instancefornow*/switch(action){caseFIF_ACTION_UPDA
TE:action_str="update";break;caseFIF_ACTION_WITHDRAW:action_str="withdraw";break
;caseFIF_ACTION_KILL:action_str="kill";break;default:assert(0);break;}vnc_zlog_d
ebug_verbose("%s:entry:%s:prefix%s/%d",__func__,action_str,inet_ntop(p->family,&
p->u.prefix,buf,BUFSIZ),p->prefixlen);memset(&p_firstbi_old,0,sizeof(p_firstbi_o
ld));memset(&p_firstbi_new,0,sizeof(p_firstbi_new));if(action==FIF_ACTION_UPDATE
){/**Comparertlists.Ifnointersection,don'timportthisroute*Onawithdraw,peerandRDa
resufficienttodetermineif*weshouldact.*/if(!attr||!attr->ecommunity){vnc_zlog_de
bug_verbose("%s:attr,extra,orecommunitymissing,notimporting",__func__);return;}#
ifRFAPI_REQUIRE_ENCAP_BEECif(!rfapiEcommunitiesMatchBeec(attr->ecommunity)){vnc_
zlog_debug_verbose("%s:it=%p:nomatchforBGPEncapsulationecommunity",__func__,impo
rt_table);return;}#endifif(!rfapiEcommunitiesIntersect(import_table->rt_import_l
ist,attr->ecommunity)){vnc_zlog_debug_verbose("%s:it=%p:noecommunityintersection
",__func__,import_table);return;}/**Updatesmustalsohaveanexthopaddress*/memset(&
un_prefix,0,sizeof(un_prefix));/*keepvalgrindhappy*/if(rfapiGetNexthop(attr,&un_
prefix)){vnc_zlog_debug_verbose("%s:missingnexthopaddress",__func__);return;}}/*
*Figureoutwhichradixtreetheroutewouldgointo*/switch(afi){caseAFI_IP:caseAFI_IP6:
rt=import_table->imported_encap[afi];break;default:zlog_err("%s:badafi%d",__func
__,afi);return;}/**route_node_lookupreturnsanodeonlyifthereisatleast*onerouteatt
ached.*/rn=route_node_lookup(rt,p);#ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose(
"%s:initialencaplookup(it=%p)rn=%p",__func__,import_table,rn);#endifif(rn){RFAPI
_CHECK_REFCOUNT(rn,SAFI_ENCAP,1);route_unlock_node(rn);/*undolockinroute_node_lo
okup*//**capturenexthopoffirstbi*/if(rn->info){rfapiNexthop2Prefix(((structbgp_i
nfo*)(rn->info))->attr,&p_firstbi_old);}for(bi=rn->info;bi;bi=bi->next){/**Doest
hisbgp_inforefertothesameroute*aswearetryingtoadd?*/vnc_zlog_debug_verbose("%s:c
omparingBI%p",__func__,bi);/**CompareRDs**RDofimporttablebiisinbi->extra->vnc.im
port.rd*RDofinfo_origisinprd*/if(!bi->extra){vnc_zlog_debug_verbose("%s:nobi->ex
tra",__func__);continue;}if(prefix_cmp((structprefix*)&bi->extra->vnc.import.rd,
(structprefix*)prd)){vnc_zlog_debug_verbose("%s:prddoesnotmatch",__func__);conti
nue;}/**Comparepeers*/if(bi->peer!=peer){vnc_zlog_debug_verbose("%s:peerdoesnotm
atch",__func__);continue;}vnc_zlog_debug_verbose("%s:foundmatchingbi",__func__);
/*Sameroute.Deletethisbi,replacewithnewone*/if(action==FIF_ACTION_WITHDRAW){vnc_
zlog_debug_verbose("%s:withdrawingatprefix%s/%d",__func__,inet_ntop(rn->p.family
,&rn->p.u.prefix,buf,BUFSIZ),rn->p.prefixlen);rfapiBiStartWithdrawTimer(import_t
able,rn,bi,afi,SAFI_ENCAP,rfapiWithdrawTimerEncap);}else{vnc_zlog_debug_verbose(
"%s:%satprefix%s/%d",__func__,((action==FIF_ACTION_KILL)?"killing":"replacing"),
inet_ntop(rn->p.family,&rn->p.u.prefix,buf,BUFSIZ),rn->p.prefixlen);/**Ifthisrou
teiswaitingtobedeleted*becauseof*apreviouswithdraw,wemustcancelits*timer.*/if(CH
ECK_FLAG(bi->flags,BGP_INFO_REMOVED)&&bi->extra->vnc.import.timer){structthread*
t=(structthread*)bi->extra->vnc.import.timer;structrfapi_withdraw*wcb=t->arg;XFR
EE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);}if(action==FIF_ACTION_UPDATE){rfa
piBgpInfoDetach(rn,bi);rfapiBgpInfoFree(bi);replacing=1;}else{/**Kill:doexportst
uffwhenremoving*bi*/structrfapi_withdraw*wcb;structthreadt;/**pretendwe'reanexpi
ringtimer*/wcb=XCALLOC(MTYPE_RFAPI_WITHDRAW,sizeof(structrfapi_withdraw));wcb->i
nfo=bi;wcb->node=rn;wcb->import_table=import_table;memset(&t,0,sizeof(t));t.arg=
wcb;rfapiWithdrawTimerEncap(&t);/*freeswcb*/}}break;}}if(rn)RFAPI_CHECK_REFCOUNT
(rn,SAFI_ENCAP,replacing?1:0);if(action==FIF_ACTION_WITHDRAW||action==FIF_ACTION
_KILL)return;info_new=rfapiBgpInfoCreate(attr,peer,rfd,prd,type,sub_type,NULL);i
f(rn){if(!replacing)route_lock_node(rn);/*incrrefcountfornewBI*/}else{rn=route_n
ode_get(rt,p);}vnc_zlog_debug_verbose("%s:(afi=%d,rn=%p)insertingatprefix%s/%d",
__func__,afi,rn,inet_ntop(rn->p.family,&rn->p.u.prefix,buf,BUFSIZ),rn->p.prefixl
en);rfapiBgpInfoAttachSorted(rn,info_new,afi,SAFI_ENCAP);/**Deleteholddownroutes
fromsameNVE.Seedetailsin*rfapiBgpInfoFilteredImportVPN()*/for(bi=info_new->next;
bi;bi=next){structprefixpfx_un;intun_match=0;next=bi->next;if(!CHECK_FLAG(bi->fl
ags,BGP_INFO_REMOVED))continue;/**WealreadymatchtheVNaddress(itistheprefix*ofthe
routenode)*/if(!rfapiGetNexthop(bi->attr,&pfx_un)&&prefix_same(&pfx_un,&un_prefi
x)){un_match=1;}if(!un_match)continue;vnc_zlog_debug_verbose("%s:removingholddow
nbimatchingNVEofnewroute",__func__);if(bi->extra->vnc.import.timer){structthread
*t=(structthread*)bi->extra->vnc.import.timer;structrfapi_withdraw*wcb=t->arg;XF
REE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);}rfapiExpireEncapNow(import_table
,rn,bi);}rfapiNexthop2Prefix(((structbgp_info*)(rn->info))->attr,&p_firstbi_new)
;/**IfthenexthopaddressoftheselectedEncaproute(i.e.,*theUNaddress)haschanged,the
nwemustupdatetheVPN*routesthatrefertothisEncaprouteandpossiblyforce*rfapicallbac
ks.*/if(rfapiAttrNexthopAddrDifferent(&p_firstbi_old,&p_firstbi_new)){structrfap
i_monitor_encap*m;structrfapi_monitor_encap*mnext;structroute_node*referenced_vp
n_prefix;/**Optimizedapproach:buildradixtreeontheflyto*holdlistofVPNnodesreferen
cedbytheENCAPmonitors**ThenodesinthistablecorrespondtoprefixesofVPNroutes.*The"i
nfo"pointerofthenodepointstoachainof*structrfapi_monitor_encap,eachofwhichrefers
toa*specificVPNnode.*/structroute_table*referenced_vpn_table;referenced_vpn_tabl
e=route_table_init();assert(referenced_vpn_table);/**iterateoverthesetofmonitors
atthisENCAPnode.*/#ifDEBUG_ENCAP_MONITORvnc_zlog_debug_verbose("%s:examiningmoni
torsatrn=%p",__func__,rn);#endiffor(m=RFAPI_MONITOR_ENCAP(rn);m;m=m->next){/**Fo
reachreferencedbi/route,copytheENCAProute's*nexthoptotheVPNroute'scachedUNaddres
sfield*andset*theaddressfamilyofthecachedUNaddressfield.*/rfapiCopyUnEncap2VPN(i
nfo_new,m->bi);if(!CHECK_FLAG(m->bi->flags,BGP_INFO_VALID)){SET_FLAG(m->bi->flag
s,BGP_INFO_VALID);if(VALID_INTERIOR_TYPE(m->bi->type))RFAPI_MONITOR_EXTERIOR(m->
node)->valid_interior_count++;vnc_import_bgp_exterior_add_route_interior(bgp,imp
ort_table,m->node,m->bi);}/**BuildalistofuniqueVPNnodesreferencedbythese*monitor
s**TherecouldbemorethanoneVPNnodeherewitha*given*prefix.Thosearecurrentlyinanuns
ortedlinear*list*perprefix.*/referenced_vpn_prefix=route_node_get(referenced_vpn
_table,&m->node->p);assert(referenced_vpn_prefix);for(mnext=referenced_vpn_prefi
x->info;mnext;mnext=mnext->next){if(mnext->node==m->node)break;}if(mnext){/**alr
eadyhaveanentryforthisVPNnode*/route_unlock_node(referenced_vpn_prefix);}else{mn
ext=XCALLOC(MTYPE_RFAPI_MONITOR_ENCAP,sizeof(structrfapi_monitor_encap));assert(
mnext);mnext->node=m->node;mnext->next=referenced_vpn_prefix->info;referenced_vp
n_prefix->info=mnext;}}/**foreachVPNnodereferencedintheENCAPmonitors:*/for(refer
enced_vpn_prefix=route_top(referenced_vpn_table);referenced_vpn_prefix;reference
d_vpn_prefix=route_next(referenced_vpn_prefix)){while((m=referenced_vpn_prefix->
info)){structroute_node*n;rfapiMonitorMoveLonger(m->node);for(n=m->node;n;n=n->p
arent){//rfapiDoRouteCallback(import_table,n,//NULL);}rfapiMonitorItNodeChanged(
import_table,m->node,NULL);referenced_vpn_prefix->info=m->next;route_unlock_node
(referenced_vpn_prefix);XFREE(MTYPE_RFAPI_MONITOR_ENCAP,m);}}route_table_finish(
referenced_vpn_table);}RFAPI_CHECK_REFCOUNT(rn,SAFI_ENCAP,0);}staticvoidrfapiExp
ireVpnNow(structrfapi_import_table*it,structroute_node*rn,structbgp_info*bi,intl
ockoffset){structrfapi_withdraw*wcb;structthreadt;/**pretendwe'reanexpiringtimer
*/wcb=XCALLOC(MTYPE_RFAPI_WITHDRAW,sizeof(structrfapi_withdraw));wcb->info=bi;wc
b->node=rn;wcb->import_table=it;wcb->lockoffset=lockoffset;memset(&t,0,sizeof(t)
);t.arg=wcb;rfapiWithdrawTimerVPN(&t);/*freeswcb*/}/**importabgp_infoifitsroutet
argetlistintersectswiththe*importtable'sroutetargetlist*/voidrfapiBgpInfoFiltere
dImportVPN(structrfapi_import_table*import_table,intaction,structpeer*peer,void*
rfd,/*setforloopedbackroutes*/structprefix*p,structprefix*aux_prefix,/*AFI_L2VPN
:optionalIP*/afi_tafi,structprefix_rd*prd,structattr*attr,/*partofbgp_info*/uint
8_ttype,/*partofbgp_info*/uint8_tsub_type,/*partofbgp_info*/uint32_t*label)/*par
tofbgp_info*/{structroute_table*rt=NULL;structroute_node*rn;structroute_node*n;s
tructbgp_info*info_new;structbgp_info*bi;structbgp_info*next;charbuf[BUFSIZ];str
uctprefixvn_prefix;structprefixun_prefix;intun_prefix_valid=0;structroute_node*e
rn;intreplacing=0;intoriginal_had_routes=0;structprefixoriginal_nexthop;constcha
r*action_str=NULL;intis_it_ce=0;structbgp*bgp;bgp=bgp_get_default();/*assume1ins
tancefornow*/switch(action){caseFIF_ACTION_UPDATE:action_str="update";break;case
FIF_ACTION_WITHDRAW:action_str="withdraw";break;caseFIF_ACTION_KILL:action_str="
kill";break;default:assert(0);break;}if(import_table==bgp->rfapi->it_ce)is_it_ce
=1;vnc_zlog_debug_verbose("%s:entry:%s%s:prefix%s/%d:it%p,afi%s",__func__,(is_it
_ce?"CE-IT":""),action_str,rfapi_ntop(p->family,&p->u.prefix,buf,BUFSIZ),p->pref
ixlen,import_table,afi2str(afi));VNC_ITRCCK;/**Comparertlists.Ifnointersection,d
on'timportthisroute*Onawithdraw,peerandRDaresufficienttodetermineif*weshouldact.
*/if(action==FIF_ACTION_UPDATE){if(!attr||!attr->ecommunity){vnc_zlog_debug_verb
ose("%s:attr,extra,orecommunitymissing,notimporting",__func__);return;}if((impor
t_table!=bgp->rfapi->it_ce)&&!rfapiEcommunitiesIntersect(import_table->rt_import
_list,attr->ecommunity)){vnc_zlog_debug_verbose("%s:it=%p:noecommunityintersecti
on",__func__,import_table);return;}memset(&vn_prefix,0,sizeof(vn_prefix));/*keep
valgrindhappy*/if(rfapiGetNexthop(attr,&vn_prefix)){/*missingnexthopaddresswould
beabad,badthing*/vnc_zlog_debug_verbose("%s:missingnexthop",__func__);return;}}/
**Figureoutwhichradixtreetheroutewouldgointo*/switch(afi){caseAFI_IP:caseAFI_IP6
:caseAFI_L2VPN:rt=import_table->imported_vpn[afi];break;default:zlog_err("%s:bad
afi%d",__func__,afi);return;}/*clearit*/memset(&original_nexthop,0,sizeof(origin
al_nexthop));/**route_node_lookupreturnsanodeonlyifthereisatleast*onerouteattach
ed.*/rn=route_node_lookup(rt,p);vnc_zlog_debug_verbose("%s:rn=%p",__func__,rn);i
f(rn){RFAPI_CHECK_REFCOUNT(rn,SAFI_MPLS_VPN,1);route_unlock_node(rn);/*undolocki
nroute_node_lookup*/if(rn->info)original_had_routes=1;if(VNC_DEBUG(VERBOSE)){vnc
_zlog_debug_verbose("%s:showingITnodeonentry",__func__);rfapiShowItNode(NULL,rn)
;/*debug*/}/**Lookforsameroute(willhavesameRDandpeer)*/bi=rfapiItBiIndexSearch(r
n,prd,peer,aux_prefix);if(bi){/**Thiswasanoldtestwhenweiteratedoverthe*BIslinear
ly.Sincewe'renowlookingupwith*RDandpeer,comparingtypesshouldnotbe*needed.Changed
toassertion.**Comparetypes.DoingsopreventsaRFP-originated*routefrommatchinganimp
ortedroute,forexample.*/if(VNC_DEBUG(VERBOSE)&&bi->type!=type)/*shouldbehandledb
yRDs,butwarnfornow*/zlog_warn("%s:typemismatch!(bi=%d,arg=%d)",__func__,bi->type
,type);vnc_zlog_debug_verbose("%s:foundmatchingbi",__func__);/**InthespecialCEta
ble,withdrawalsoccurwithout*holddown*/if(import_table==bgp->rfapi->it_ce){vnc_di
rect_bgp_del_route_ce(bgp,rn,bi);if(action==FIF_ACTION_WITHDRAW)action=FIF_ACTIO
N_KILL;}if(action==FIF_ACTION_WITHDRAW){intwasholddown=CHECK_FLAG(bi->flags,BGP_
INFO_REMOVED);vnc_zlog_debug_verbose("%s:withdrawingatprefix%s/%d%s",__func__,rf
api_ntop(rn->p.family,&rn->p.u.prefix,buf,BUFSIZ),rn->p.prefixlen,(washolddown?"
(alreadybeingwithdrawn)":""));VNC_ITRCCK;if(!washolddown){rfapiBiStartWithdrawTi
mer(import_table,rn,bi,afi,SAFI_MPLS_VPN,rfapiWithdrawTimerVPN);RFAPI_UPDATE_ITA
BLE_COUNT(bi,import_table,afi,-1);import_table->holddown_count[afi]+=1;}VNC_ITRC
CK;}else{vnc_zlog_debug_verbose("%s:%satprefix%s/%d",__func__,((action==FIF_ACTI
ON_KILL)?"killing":"replacing"),rfapi_ntop(rn->p.family,&rn->p.u.prefix,buf,BUFS
IZ),rn->p.prefixlen);/**Ifthisrouteiswaitingtobedeleted*becauseof*apreviouswithd
raw,wemustcancelits*timer.*/if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)&&bi->extra
->vnc.import.timer){structthread*t=(structthread*)bi->extra->vnc.import.timer;st
ructrfapi_withdraw*wcb=t->arg;XFREE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);i
mport_table->holddown_count[afi]-=1;RFAPI_UPDATE_ITABLE_COUNT(bi,import_table,af
i,1);}/**decrementremotecount(ifrouteisremote)*because*wearegoingtoremoveitbelow
*/RFAPI_UPDATE_ITABLE_COUNT(bi,import_table,afi,-1);if(action==FIF_ACTION_UPDATE
){replacing=1;/**makecopyoforiginalnexthopsowe*canseeifitchanged*/rfapiGetNextho
p(bi->attr,&original_nexthop);/**removebiwithoutdoinganyexport*processing*/if(CH
ECK_FLAG(bi->flags,BGP_INFO_VALID)&&VALID_INTERIOR_TYPE(bi->type))RFAPI_MONITOR_
EXTERIOR(rn)->valid_interior_count--;rfapiItBiIndexDel(rn,bi);rfapiBgpInfoDetach
(rn,bi);rfapiMonitorEncapDelete(bi);vnc_import_bgp_exterior_del_route_interior(b
gp,import_table,rn,bi);rfapiBgpInfoFree(bi);}else{/*Kill*//**removebianddoexport
processing*/import_table->holddown_count[afi]+=1;rfapiExpireVpnNow(import_table,
rn,bi,0);}}}}if(rn)RFAPI_CHECK_REFCOUNT(rn,SAFI_MPLS_VPN,replacing?1:0);if(actio
n==FIF_ACTION_WITHDRAW||action==FIF_ACTION_KILL){VNC_ITRCCK;return;}info_new=rfa
piBgpInfoCreate(attr,peer,rfd,prd,type,sub_type,label);/**lookupunaddressinencap
table*/ern=route_node_match(import_table->imported_encap[afi],&vn_prefix);if(ern
){rfapiCopyUnEncap2VPN(ern->info,info_new);route_unlock_node(ern);/*undolockinro
ute_note_match*/}else{charbuf[PREFIX_STRLEN];prefix2str(&vn_prefix,buf,sizeof(bu
f));/*Notabigdeal,justmeansVPNroutegotherefirst*/vnc_zlog_debug_verbose("%s:noen
caprouteforvnaddr%s",__func__,buf);info_new->extra->vnc.import.un_family=0;}if(r
n){if(!replacing)route_lock_node(rn);}else{/**Noneedtoincrementreferencecount,so
only"get"*ifthenodeisnottherealready*/rn=route_node_get(rt,p);}/**Forethernetrou
tes,ifthereisanaccompanyingIPaddress,*saveitinthebi*/if((AFI_L2VPN==afi)&&aux_pr
efix){vnc_zlog_debug_verbose("%s:settingBI'saux_prefix",__func__);info_new->extr
a->vnc.import.aux_prefix=*aux_prefix;}vnc_zlog_debug_verbose("%s:insertingbi%pat
prefix%s/%d#%d",__func__,info_new,rfapi_ntop(rn->p.family,&rn->p.u.prefix,buf,BU
FSIZ),rn->p.prefixlen,rn->lock);rfapiBgpInfoAttachSorted(rn,info_new,afi,SAFI_MP
LS_VPN);rfapiItBiIndexAdd(rn,info_new);if(!rfapiGetUnAddrOfVpnBi(info_new,NULL))
{if(VALID_INTERIOR_TYPE(info_new->type))RFAPI_MONITOR_EXTERIOR(rn)->valid_interi
or_count++;SET_FLAG(info_new->flags,BGP_INFO_VALID);}RFAPI_UPDATE_ITABLE_COUNT(i
nfo_new,import_table,afi,1);vnc_import_bgp_exterior_add_route_interior(bgp,impor
t_table,rn,info_new);if(import_table==bgp->rfapi->it_ce)vnc_direct_bgp_add_route
_ce(bgp,rn,info_new);if(VNC_DEBUG(VERBOSE)){vnc_zlog_debug_verbose("%s:showingIT
node",__func__);rfapiShowItNode(NULL,rn);/*debug*/}rfapiMonitorEncapAdd(import_t
able,&vn_prefix,rn,info_new);if(!rfapiGetUnAddrOfVpnBi(info_new,&un_prefix)){/**
ifwehaveavalidUNaddress(eitherviaEncaproute*orviatunnelattribute),thenweshouldat
tempt*tomoveanymonitorsatless-specificnodestothisnode*/rfapiMonitorMoveLonger(rn
);un_prefix_valid=1;}/**101129Enhancement:ifweaddaroute(implication:itisnot*inho
lddown),deleteallotherroutesfromthisnveatthis*nodethatareinholddown,regardlessof
peer.**Reasonsit'sOKtodothat:**-iftheholddownroutebeingdeletedoriginallycamefrom
BGPVPN,*itisalreadygonefromBGP(implicationofholddown),sothere*won'tbeanyaddedinc
onsistencywiththeBGPRIB.**-onceafreshrouteisaddedataprefix,anyroutesinholddown*a
tthatprefixwillnotshowupinRFPresponses,sodeleting*theholddownrouteswon'taffectth
econtentsofresponses.**-lifetimesaresupposedtobeconsistent,sothereshouldnot*beac
asewherethefreshroutehasashorterlifetimethan*theholddownroute,sowedon'texpectthe
freshrouteto*disappearandcompleteitsholddowntimebeforetheexisting*holddownroutes
timeout.Therefore,wewon'thaveasituation*whereweexpecttheexistingholddownroutesto
behiddenand*thentoreappearsometimelater(asholddownroutes)ina*RFPresponse.**Among
otherthings,thiswouldenableustoskirttheproblem*oflocalholddownroutesthatrefertoN
VEdescriptorsthat*havealreadybeenclosed(ifthesameNVEtriggersasubsequent*rfapi_op
en(),thenewpeerisdifferentanddoesn'tmatchthe*peeroftheholddownroute,sothestaleho
lddownroutestill*hangsarounduntilittimesoutinsteadofjustbeingreplaced*bythefresh
route).*//**Weknowthatthenewbiwillhavebeeninsertedbeforeanyroutes*inholddown,sow
ecanskipanythatcamebeforeit*/for(bi=info_new->next;bi;bi=next){structprefixpfx_v
n;structprefixpfx_un;intun_match=0;intremote_peer_match=0;next=bi->next;/**Mustb
eholddown*/if(!CHECK_FLAG(bi->flags,BGP_INFO_REMOVED))continue;/**MustmatchVNadd
ress(nexthopofVPNroute)*/if(rfapiGetNexthop(bi->attr,&pfx_vn))continue;if(!prefi
x_same(&pfx_vn,&vn_prefix))continue;if(un_prefix_valid&&/*newrouteUNaddr*/!rfapi
GetUnAddrOfVpnBi(bi,&pfx_un)&&/*oldrouteUNaddr*/prefix_same(&pfx_un,&un_prefix))
{/*compare*/un_match=1;}if(!RFAPI_LOCAL_BI(bi)&&!RFAPI_LOCAL_BI(info_new)&&socku
nion_same(&bi->peer->su,&info_new->peer->su)){/*old&newarebothremote,samepeer*/r
emote_peer_match=1;}if(!un_match&!remote_peer_match)continue;vnc_zlog_debug_verb
ose("%s:removingholddownbimatchingNVEofnewroute",__func__);if(bi->extra->vnc.imp
ort.timer){structthread*t=(structthread*)bi->extra->vnc.import.timer;structrfapi
_withdraw*wcb=t->arg;XFREE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);}rfapiExpi
reVpnNow(import_table,rn,bi,0);}if(!original_had_routes){/**Wewentfrom0usablerou
testo1usableroute.Performthe*"AddingaRoute"exportprocess.*/vnc_direct_bgp_add_pr
efix(bgp,import_table,rn);vnc_zebra_add_prefix(bgp,import_table,rn);}else{/**Che
ckfornexthopchangeevent*Note:theprefix_same()testbelowdetectstwosituations:*1.ro
uteisreplaced,newroutehasdifferentnexthop*2.newrouteisadded(original_nexthopis0)
*/structprefixnew_nexthop;rfapiGetNexthop(attr,&new_nexthop);if(!prefix_same(&or
iginal_nexthop,&new_nexthop)){/**nexthopchangeevent*vnc_direct_bgp_add_prefix()w
illrecomputeVNaddr*ecommunity*/vnc_direct_bgp_add_prefix(bgp,import_table,rn);}}
if(!(bgp->rfapi_cfg->flags&BGP_VNC_CONFIG_CALLBACK_DISABLE)){for(n=rn;n;n=n->par
ent){//rfapiDoRouteCallback(import_table,n,NULL);}rfapiMonitorItNodeChanged(impo
rt_table,rn,NULL);}RFAPI_CHECK_REFCOUNT(rn,SAFI_MPLS_VPN,0);VNC_ITRCCK;}staticvo
idrfapiBgpInfoFilteredImportBadSafi(structrfapi_import_table*import_table,intact
ion,structpeer*peer,void*rfd,/*setforloopedbackroutes*/structprefix*p,structpref
ix*aux_prefix,/*AFI_L2VPN:optionalIP*/afi_tafi,structprefix_rd*prd,structattr*at
tr,/*partofbgp_info*/uint8_ttype,/*partofbgp_info*/uint8_tsub_type,/*partofbgp_i
nfo*/uint32_t*label)/*partofbgp_info*/{vnc_zlog_debug_verbose("%s:Error,badsafi"
,__func__);}staticrfapi_bi_filtered_import_f*rfapiBgpInfoFilteredImportFunction(
safi_tsafi){switch(safi){caseSAFI_MPLS_VPN:returnrfapiBgpInfoFilteredImportVPN;c
aseSAFI_ENCAP:returnrfapiBgpInfoFilteredImportEncap;default:/*notexpected*/zlog_
err("%s:badsafi%d",__func__,safi);returnrfapiBgpInfoFilteredImportBadSafi;}}void
rfapiProcessUpdate(structpeer*peer,void*rfd,/*setwhenloopedfromRFP/RFAPI*/struct
prefix*p,structprefix_rd*prd,structattr*attr,afi_tafi,safi_tsafi,uint8_ttype,uin
t8_tsub_type,uint32_t*label){structbgp*bgp;structrfapi*h;structrfapi_import_tabl
e*it;inthas_ip_route=1;uint32_tlni=0;bgp=bgp_get_default();/*assume1instanceforn
ow*/assert(bgp);h=bgp->rfapi;assert(h);/**lookathigh-orderbyteofRD.FFmeansMAC*ad
dressispresent(VNCL2VPN)*/if((safi==SAFI_MPLS_VPN)&&(decode_rd_type(prd->val)==R
D_TYPE_VNC_ETH)){structprefixpfx_mac_buf;structprefixpfx_nexthop_buf;intrc;/**Se
tflagifprefixandnexthoparethesame-don't*addtheroutetonormalIP-basedimporttables*
/if(!rfapiGetNexthop(attr,&pfx_nexthop_buf)){if(!prefix_cmp(&pfx_nexthop_buf,p))
{has_ip_route=0;}}memset(&pfx_mac_buf,0,sizeof(pfx_mac_buf));pfx_mac_buf.family=
AF_ETHERNET;pfx_mac_buf.prefixlen=48;memcpy(&pfx_mac_buf.u.prefix_eth.octet,prd-
>val+2,6);/**FindrtcontainingLNI(LogicalNetworkID),which*_should_alwaysbepresent
whenmacaddressispresent*/rc=rfapiEcommunityGetLNI(attr->ecommunity,&lni);vnc_zlo
g_debug_verbose("%s:rfapiEcommunityGetLNIreturned%d,lni=%d,attr=%p",__func__,rc,
lni,attr);if(!rc){it=rfapiMacImportTableGet(bgp,lni);rfapiBgpInfoFilteredImportV
PN(it,FIF_ACTION_UPDATE,peer,rfd,&pfx_mac_buf,/*prefix*/p,/*auxprefix:IPaddr*/AF
I_L2VPN,prd,attr,type,sub_type,label);}}if(!has_ip_route)return;/**Iterateoveral
limporttables;doafilteredimport*fortheafi/saficombination*/for(it=h->imports;it;
it=it->next){(*rfapiBgpInfoFilteredImportFunction(safi))(it,FIF_ACTION_UPDATE,pe
er,rfd,p,/*prefix*/NULL,afi,prd,attr,type,sub_type,label);}if(safi==SAFI_MPLS_VP
N){vnc_direct_bgp_rh_add_route(bgp,afi,p,peer,attr);rfapiBgpInfoFilteredImportVP
N(bgp->rfapi->it_ce,FIF_ACTION_UPDATE,peer,rfd,p,/*prefix*/NULL,afi,prd,attr,typ
e,sub_type,label);}}voidrfapiProcessWithdraw(structpeer*peer,void*rfd,structpref
ix*p,structprefix_rd*prd,structattr*attr,afi_tafi,safi_tsafi,uint8_ttype,intkill
){structbgp*bgp;structrfapi*h;structrfapi_import_table*it;bgp=bgp_get_default();
/*assume1instancefornow*/assert(bgp);h=bgp->rfapi;assert(h);/**lookathigh-orderb
yteofRD.FFmeansMAC*addressispresent(VNCL2VPN)*/if(h->import_mac!=NULL&&safi==SAF
I_MPLS_VPN&&decode_rd_type(prd->val)==RD_TYPE_VNC_ETH){structprefixpfx_mac_buf;v
oid*cursor=NULL;intrc;memset(&pfx_mac_buf,0,sizeof(pfx_mac_buf));pfx_mac_buf.fam
ily=AF_ETHERNET;pfx_mac_buf.prefixlen=48;memcpy(&pfx_mac_buf.u.prefix_eth,prd->v
al+2,6);/**withdrawdoesnotcontainattrs,sowedon'thave*accesstotheroute'sLNI,which
wouldordinarily*selectthespecificmac-basedimporttable.Instead,*wemustiterateover
allmac-basedtablesandrely*ontheRDtomatch.**Ifthisapproachistooslow,addanindexwhe
re*keyis{RD,peer}andvalueistheimporttable*/for(rc=skiplist_next(h->import_mac,NU
LL,(void**)&it,&cursor);rc==0;rc=skiplist_next(h->import_mac,NULL,(void**)&it,&c
ursor)){#ifDEBUG_L2_EXTRAvnc_zlog_debug_verbose("%s:callingrfapiBgpInfoFilteredI
mportVPN(it=%p,afi=AFI_L2VPN)",__func__,it);#endifrfapiBgpInfoFilteredImportVPN(
it,(kill?FIF_ACTION_KILL:FIF_ACTION_WITHDRAW),peer,rfd,&pfx_mac_buf,/*prefix*/p,
/*aux_prefix:IP*/AFI_L2VPN,prd,attr,type,0,NULL);/*sub_type&labelunusedforwithdr
aw*/}}/**XXXForthecasewherethewithdrawinvolvesanL2*routewithnoIPinformation,were
lyonthelack*ofRT-listintersectiontofilteroutthewithdraw*fromtheIP-basedimporttab
lesbelow*//**Iterateoverallimporttables;doafilteredimport*fortheafi/saficombinat
ion*/for(it=h->imports;it;it=it->next){(*rfapiBgpInfoFilteredImportFunction(safi
))(it,(kill?FIF_ACTION_KILL:FIF_ACTION_WITHDRAW),peer,rfd,p,/*prefix*/NULL,afi,p
rd,attr,type,0,NULL);/*sub_type&labelunusedforwithdraw*/}/*TBDthedeletionshouldh
appenafterthelifetimeexpires*/if(safi==SAFI_MPLS_VPN)vnc_direct_bgp_rh_del_route
(bgp,afi,p,peer);if(safi==SAFI_MPLS_VPN){rfapiBgpInfoFilteredImportVPN(bgp->rfap
i->it_ce,(kill?FIF_ACTION_KILL:FIF_ACTION_WITHDRAW),peer,rfd,p,/*prefix*/NULL,af
i,prd,attr,type,0,NULL);/*sub_type&labelunusedforwithdraw*/}}/**TBDoptimizedwith
drawtimeralgorithmforcaseofmany*routesexpiringatthesametimeduetopeerdrop.*//**1.
VisitallBIsinallENCAPimporttables.**a.Ifabi'speeristhefailedpeer,removethebi.*b.
IftheremovedENCAPbiwasfirstinthelistof*BIsatthisENCAPnode,loopoverallmonitors*at
thisnode:**(1)foreachENCAPmonitor,loopoverallits*VPNnodemonitorsandsettheirRFAPI
_MON_FLAG_NEEDCALLBACK*flags.**2.VisitallBIsinallVPNimporttables.*a.Ifabi'speeri
sthefailedpeer,removethebi.*b.loopoveralltheVPNnodemonitorsandsettheir*RFAPI_MON
_FLAG_NEEDCALLBACKflags*c.IftherearenoBIsleftatthisVPNnode,**//*surprise,thisget
scalledfrompeer_delete(),fromrfapi_close()*/staticvoidrfapiProcessPeerDownRt(str
uctpeer*peer,structrfapi_import_table*import_table,afi_tafi,safi_tsafi){structro
ute_node*rn;structbgp_info*bi;structroute_table*rt;int(*timer_service_func)(stru
ctthread*);assert(afi==AFI_IP||afi==AFI_IP6);VNC_ITRCCK;switch(safi){caseSAFI_MP
LS_VPN:rt=import_table->imported_vpn[afi];timer_service_func=rfapiWithdrawTimerV
PN;break;caseSAFI_ENCAP:rt=import_table->imported_encap[afi];timer_service_func=
rfapiWithdrawTimerEncap;break;default:assert(0);}for(rn=route_top(rt);rn;rn=rout
e_next(rn)){for(bi=rn->info;bi;bi=bi->next){if(bi->peer==peer){if(CHECK_FLAG(bi-
>flags,BGP_INFO_REMOVED)){/*alreadyinholddown,skip*/continue;}if(safi==SAFI_MPLS
_VPN){RFAPI_UPDATE_ITABLE_COUNT(bi,import_table,afi,-1);import_table->holddown_c
ount[afi]+=1;}rfapiBiStartWithdrawTimer(import_table,rn,bi,afi,safi,timer_servic
e_func);}}}VNC_ITRCCK;}/**Thisgetscalledwhenapeerconnectiondrops.Wehavetoremove*
alltheroutesfromthispeer.**Currentapproachiscrude.TBDOptimizebysettingfewertimer
sand*groupingwithdrawnroutessowecangeneratecallbacksmore*efficiently.*/voidrfapi
ProcessPeerDown(structpeer*peer){structbgp*bgp;structrfapi*h;structrfapi_import_
table*it;/**Ifthispeerisa"dummy"peerstructureatachedtoaRFAPI*nve_descriptor,wedo
n'tneedtowalktheimporttables*becausetheroutesarealreadywithdrawnbyrfapi_close()*
/if(CHECK_FLAG(peer->flags,PEER_FLAG_IS_RFAPI_HD))return;/**1.VisitallBIsinallEN
CAPimporttables.*StartwithdrawtimerontheBIsthatmatchpeer.**2.VisitAllBIsinallVPN
importtables.*StartwithdrawtimerontheBIsthatmatchpeer.*/bgp=bgp_get_default();/*
assume1instancefornow*/if(!bgp)return;h=bgp->rfapi;assert(h);for(it=h->imports;i
t;it=it->next){rfapiProcessPeerDownRt(peer,it,AFI_IP,SAFI_ENCAP);rfapiProcessPee
rDownRt(peer,it,AFI_IP6,SAFI_ENCAP);rfapiProcessPeerDownRt(peer,it,AFI_IP,SAFI_M
PLS_VPN);rfapiProcessPeerDownRt(peer,it,AFI_IP6,SAFI_MPLS_VPN);}if(h->it_ce){rfa
piProcessPeerDownRt(peer,h->it_ce,AFI_IP,SAFI_MPLS_VPN);rfapiProcessPeerDownRt(p
eer,h->it_ce,AFI_IP6,SAFI_MPLS_VPN);}}/**ImportanentireRIB(foranafi/safi)toanimp
orttableRIB,*filteredaccordingtotheimporttable'sRTlist**TBD:doesthisfunctionneed
additionstomatchrfapiProcessUpdate()*for,e.g.,L2handling?*/staticvoidrfapiBgpTab
leFilteredImport(structbgp*bgp,structrfapi_import_table*it,afi_tafi,safi_tsafi){
structbgp_node*rn1;structbgp_node*rn2;/*OnlytheseSAFIshave2-levelRIBS*/assert(sa
fi==SAFI_MPLS_VPN||safi==SAFI_ENCAP);/**Nowvisitalltherdnodesandthenodesofallthe
*routetablesattachedtothem,andimporttheroutes*iftheyhavematchingroutetargets*/fo
r(rn1=bgp_table_top(bgp->rib[afi][safi]);rn1;rn1=bgp_route_next(rn1)){if(rn1->in
fo){for(rn2=bgp_table_top(rn1->info);rn2;rn2=bgp_route_next(rn2)){structbgp_info
*bi;for(bi=rn2->info;bi;bi=bi->next){uint32_tlabel=0;if(CHECK_FLAG(bi->flags,BGP
_INFO_REMOVED))continue;if(bi->extra)label=decode_label(&bi->extra->label[0]);(*
rfapiBgpInfoFilteredImportFunction(safi))(it,/*whichimporttable*/FIF_ACTION_UPDA
TE,bi->peer,NULL,&rn2->p,/*prefix*/NULL,afi,(structprefix_rd*)&rn1->p,bi->attr,b
i->type,bi->sub_type,&label);}}}}}/*per-bgp-instancerfapidata*/structrfapi*bgp_r
fapi_new(structbgp*bgp){structrfapi*h;afi_tafi;structrfapi_rfp_cfg*cfg=NULL;stru
ctrfapi_rfp_cb_methods*cbm=NULL;assert(bgp->rfapi_cfg==NULL);h=(structrfapi*)XCA
LLOC(MTYPE_RFAPI,sizeof(structrfapi));for(afi=AFI_IP;afi<AFI_MAX;afi++){h->un[af
i]=route_table_init();}/**initializetheceimporttable*/h->it_ce=XCALLOC(MTYPE_RFA
PI_IMPORTTABLE,sizeof(structrfapi_import_table));h->it_ce->imported_vpn[AFI_IP]=
route_table_init();h->it_ce->imported_vpn[AFI_IP6]=route_table_init();h->it_ce->
imported_encap[AFI_IP]=route_table_init();h->it_ce->imported_encap[AFI_IP6]=rout
e_table_init();rfapiBgpTableFilteredImport(bgp,h->it_ce,AFI_IP,SAFI_MPLS_VPN);rf
apiBgpTableFilteredImport(bgp,h->it_ce,AFI_IP6,SAFI_MPLS_VPN);/**Setupworkqueuef
ordeferredrfapi_closeoperations*/h->deferred_close_q=work_queue_new(bm->master,"
rfapideferredclose");h->deferred_close_q->spec.workfunc=rfapi_deferred_close_wor
kfunc;h->deferred_close_q->spec.data=h;h->rfp=rfp_start(bm->master,&cfg,&cbm);bg
p->rfapi_cfg=bgp_rfapi_cfg_new(cfg);if(cbm!=NULL){h->rfp_methods=*cbm;}returnh;}
voidbgp_rfapi_destroy(structbgp*bgp,structrfapi*h){afi_tafi;if(bgp==NULL||h==NUL
L)return;if(h->resolve_nve_nexthop){skiplist_free(h->resolve_nve_nexthop);h->res
olve_nve_nexthop=NULL;}route_table_finish(h->it_ce->imported_vpn[AFI_IP]);route_
table_finish(h->it_ce->imported_vpn[AFI_IP6]);route_table_finish(h->it_ce->impor
ted_encap[AFI_IP]);route_table_finish(h->it_ce->imported_encap[AFI_IP6]);if(h->i
mport_mac){structrfapi_import_table*it;void*cursor;intrc;for(cursor=NULL,rc=skip
list_next(h->import_mac,NULL,(void**)&it,&cursor);!rc;rc=skiplist_next(h->import
_mac,NULL,(void**)&it,&cursor)){rfapiImportTableFlush(it);XFREE(MTYPE_RFAPI_IMPO
RTTABLE,it);}skiplist_free(h->import_mac);h->import_mac=NULL;}work_queue_free_an
d_null(&h->deferred_close_q);if(h->rfp!=NULL)rfp_stop(h->rfp);for(afi=AFI_IP;afi
<AFI_MAX;afi++){route_table_finish(h->un[afi]);}XFREE(MTYPE_RFAPI_IMPORTTABLE,h-
>it_ce);XFREE(MTYPE_RFAPI,h);}structrfapi_import_table*rfapiImportTableRefAdd(st
ructbgp*bgp,structecommunity*rt_import_list,structrfapi_nve_group_cfg*rfg){struc
trfapi*h;structrfapi_import_table*it;afi_tafi;h=bgp->rfapi;assert(h);for(it=h->i
mports;it;it=it->next){if(ecommunity_cmp(it->rt_import_list,rt_import_list))brea
k;}vnc_zlog_debug_verbose("%s:matchedit=%p",__func__,it);if(!it){it=XCALLOC(MTYP
E_RFAPI_IMPORTTABLE,sizeof(structrfapi_import_table));assert(it);it->next=h->imp
orts;h->imports=it;it->rt_import_list=ecommunity_dup(rt_import_list);it->rfg=rfg
;it->monitor_exterior_orphans=skiplist_new(0,NULL,(void(*)(void*))prefix_free);/
**fillimportroutetablesfromRIBs**Potentialareaforoptimization.Ifthisoccurswhen*t
ablesarelarge(e.g.,theoperatoraddsanvegroup*withanewRTlisttoarunningsystem),itco
uldtake*awhile.**/for(afi=AFI_IP;afi<AFI_MAX;++afi){it->imported_vpn[afi]=route_
table_init();it->imported_encap[afi]=route_table_init();rfapiBgpTableFilteredImp
ort(bgp,it,afi,SAFI_MPLS_VPN);rfapiBgpTableFilteredImport(bgp,it,afi,SAFI_ENCAP)
;vnc_import_bgp_exterior_redist_enable_it(bgp,afi,it);}}it->refcount+=1;returnit
;}/**skiplistelementfreefunction*/staticvoiddelete_rem_pfx_na_free(void*na){uint
32_t*pCounter=((structrfapi_nve_addr*)na)->info;*pCounter+=1;XFREE(MTYPE_RFAPI_N
VE_ADDR,na);}/**CommondeleterforIPandMACimporttables*/staticvoidrfapiDeleteRemot
ePrefixesIt(structbgp*bgp,structrfapi_import_table*it,structprefix*un,structpref
ix*vn,structprefix*p,intdelete_active,intdelete_holddown,uint32_t*pARcount,uint3
2_t*pAHcount,uint32_t*pHRcount,uint32_t*pHHcount,structskiplist*uniq_active_nves
,structskiplist*uniq_holddown_nves){afi_tafi;#ifDEBUG_L2_EXTRA{charbuf_pfx[PREFI
X_STRLEN];if(p){prefix2str(p,buf_pfx,sizeof(buf_pfx));}else{buf_pfx[0]='*';buf_p
fx[1]=0;}vnc_zlog_debug_verbose("%s:entry,p=%s,delete_active=%d,delete_holddown=
%d",__func__,buf_pfx,delete_active,delete_holddown);}#endiffor(afi=AFI_IP;afi<AF
I_MAX;++afi){structroute_table*rt;structroute_node*rn;if(p&&(family2afi(p->famil
y)!=afi)){continue;}rt=it->imported_vpn[afi];if(!rt)continue;vnc_zlog_debug_verb
ose("%s:scanningrtforafi=%d",__func__,afi);for(rn=route_top(rt);rn;rn=route_next
(rn)){structbgp_info*bi;structbgp_info*next;if(VNC_DEBUG(IMPORT_DEL_REMOTE)){cha
rp1line[PREFIX_STRLEN];charp2line[PREFIX_STRLEN];prefix2str(p,p1line,sizeof(p1li
ne));prefix2str(&rn->p,p2line,sizeof(p2line));vnc_zlog_debug_any("%s:want%s,have
%s",__func__,p1line,p2line);}if(p&&prefix_cmp(p,&rn->p))continue;{charbuf_pfx[PR
EFIX_STRLEN];prefix2str(&rn->p,buf_pfx,sizeof(buf_pfx));vnc_zlog_debug_verbose("
%s:rnpfx=%s",__func__,buf_pfx);}/*TBDisthisvalidforafi==AFI_L2VPN?*/RFAPI_CHECK_
REFCOUNT(rn,SAFI_MPLS_VPN,1);for(bi=rn->info;bi;bi=next){next=bi->next;structpre
fixqpt;structprefixqct;intqpt_valid=0;intqct_valid=0;intis_active=0;vnc_zlog_deb
ug_verbose("%s:examiningbi%p",__func__,bi);if(bi->attr){if(!rfapiGetNexthop(bi->
attr,&qpt))qpt_valid=1;}if(vn){if(!qpt_valid||!prefix_match(vn,&qpt)){#ifDEBUG_L
2_EXTRAvnc_zlog_debug_verbose("%s:continueatvn&&!qpt_valid||!prefix_match(vn,&qp
t)",__func__);#endifcontinue;}}if(!rfapiGetUnAddrOfVpnBi(bi,&qct))qct_valid=1;if
(un){if(!qct_valid||!prefix_match(un,&qct)){#ifDEBUG_L2_EXTRAvnc_zlog_debug_verb
ose("%s:continueatun&&!qct_valid||!prefix_match(un,&qct)",__func__);#endifcontin
ue;}}/**Blowbiaway*//**Ifthisrouteiswaitingtobedeleted*becauseof*apreviouswithdr
aw,wemustcancelits*timer.*/if(CHECK_FLAG(bi->flags,BGP_INFO_REMOVED)){if(!delete
_holddown)continue;if(bi->extra->vnc.import.timer){structthread*t=(structthread*
)bi->extra->vnc.import.timer;structrfapi_withdraw*wcb=t->arg;wcb->import_table->
holddown_count[afi]-=1;RFAPI_UPDATE_ITABLE_COUNT(bi,wcb->import_table,afi,1);XFR
EE(MTYPE_RFAPI_WITHDRAW,wcb);thread_cancel(t);}}else{if(!delete_active)continue;
is_active=1;}vnc_zlog_debug_verbose("%s:deletingbi%p(qct_valid=%d,qpt_valid=%d,d
elete_holddown=%d,delete_active=%d)",__func__,bi,qct_valid,qpt_valid,delete_hold
down,delete_active);/**addnvetolist*/if(qct_valid&&qpt_valid){structrfapi_nve_ad
drna;structrfapi_nve_addr*nap;memset(&na,0,sizeof(na));assert(!rfapiQprefix2Radd
r(&qct,&na.un));assert(!rfapiQprefix2Raddr(&qpt,&na.vn));if(skiplist_search((is_
active?uniq_active_nves:uniq_holddown_nves),&na,(void**)&nap)){charline[BUFSIZ];
nap=XCALLOC(MTYPE_RFAPI_NVE_ADDR,sizeof(structrfapi_nve_addr));assert(nap);*nap=
na;nap->info=is_active?pAHcount:pHHcount;skiplist_insert((is_active?uniq_active_
nves:uniq_holddown_nves),nap,nap);rfapiNveAddr2Str(nap,line,BUFSIZ);}}vnc_direct
_bgp_rh_del_route(bgp,afi,&rn->p,bi->peer);RFAPI_UPDATE_ITABLE_COUNT(bi,it,afi,-
1);it->holddown_count[afi]+=1;rfapiExpireVpnNow(it,rn,bi,1);vnc_zlog_debug_verbo
se("%s:incrementingcount(is_active=%d)",__func__,is_active);if(is_active)++*pARc
ount;else++*pHRcount;}}}}/**Forusebythe"clearvncprefixes"command*//*------------
------------------------------*rfapiDeleteRemotePrefixes**UIhelper:Forusebythe"c
learvncprefixes"command**input:*unifset,tunnelmustmatchthisprefix*vnifset,nextho
pprefixmustmatchthisprefix*pifset,prefixmustmatchthisprefix*itifset,onlylookinth
isimporttable**output*pARcountnumberofactiveroutesdeleted*pAHcountnumberofactive
nvesdeleted*pHRcountnumberofholddownroutesdeleted*pHHcountnumberofholddownnvesde
leted**returnvalue:*void--------------------------------------------*/voidrfapiD
eleteRemotePrefixes(structprefix*un,structprefix*vn,structprefix*p,structrfapi_i
mport_table*arg_it,intdelete_active,intdelete_holddown,uint32_t*pARcount,uint32_
t*pAHcount,uint32_t*pHRcount,uint32_t*pHHcount){structbgp*bgp;structrfapi*h;stru
ctrfapi_import_table*it;uint32_tdeleted_holddown_route_count=0;uint32_tdeleted_a
ctive_route_count=0;uint32_tdeleted_holddown_nve_count=0;uint32_tdeleted_active_
nve_count=0;structskiplist*uniq_holddown_nves;structskiplist*uniq_active_nves;VN
C_ITRCCK;bgp=bgp_get_default();/*assume1instancefornow*//*Ifnobgpinstantiatedyet
,novncprefixesexist*/if(!bgp)return;h=bgp->rfapi;assert(h);uniq_holddown_nves=sk
iplist_new(0,rfapi_nve_addr_cmp,delete_rem_pfx_na_free);uniq_active_nves=skiplis
t_new(0,rfapi_nve_addr_cmp,delete_rem_pfx_na_free);/**Iterateoverallimporttables
;doafilteredimport*fortheafi/saficombination*/if(arg_it)it=arg_it;elseit=h->impo
rts;for(;it;){vnc_zlog_debug_verbose("%s:callingrfapiDeleteRemotePrefixesIt()on(
IP)import%p",__func__,it);rfapiDeleteRemotePrefixesIt(bgp,it,un,vn,p,delete_acti
ve,delete_holddown,&deleted_active_route_count,&deleted_active_nve_count,&delete
d_holddown_route_count,&deleted_holddown_nve_count,uniq_active_nves,uniq_holddow
n_nves);if(arg_it)it=NULL;elseit=it->next;}/**NowiterateoverL2importtables*/if(h
->import_mac&&!(p&&(p->family!=AF_ETHERNET))){void*cursor=NULL;intrc;for(cursor=
NULL,rc=skiplist_next(h->import_mac,NULL,(void**)&it,&cursor);!rc;rc=skiplist_ne
xt(h->import_mac,NULL,(void**)&it,&cursor)){vnc_zlog_debug_verbose("%s:callingrf
apiDeleteRemotePrefixesIt()onimport_mac%p",__func__,it);rfapiDeleteRemotePrefixe
sIt(bgp,it,un,vn,p,delete_active,delete_holddown,&deleted_active_route_count,&de
leted_active_nve_count,&deleted_holddown_route_count,&deleted_holddown_nve_count
,uniq_active_nves,uniq_holddown_nves);}}/**ourcustomelementfreeingfunctionabovec
ountsasitdeletes*/skiplist_free(uniq_holddown_nves);skiplist_free(uniq_active_nv
es);if(pARcount)*pARcount=deleted_active_route_count;if(pAHcount)*pAHcount=delet
ed_active_nve_count;if(pHRcount)*pHRcount=deleted_holddown_route_count;if(pHHcou
nt)*pHHcount=deleted_holddown_nve_count;VNC_ITRCCK;}/*--------------------------
----------------*rfapiCountRemoteRoutes**UIhelper:countVRFroutesfromBGPside**inp
ut:**output*pALRcountcountofactivelocalroutes*pARRcountcountofactiveremoteroutes
*pHRcountcountofholddownroutes*pIRcountcountofdirectimportedroutes**returnvalue:
*void--------------------------------------------*/voidrfapiCountAllItRoutes(int
*pALRcount,/*activelocalroutes*/int*pARRcount,/*activeremoteroutes*/int*pHRcount
,/*holddownroutes*/int*pIRcount)/*importedroutes*/{structbgp*bgp;structrfapi*h;s
tructrfapi_import_table*it;afi_tafi;inttotal_active_local=0;inttotal_active_remo
te=0;inttotal_holddown=0;inttotal_imported=0;bgp=bgp_get_default();/*assume1inst
ancefornow*/assert(bgp);h=bgp->rfapi;assert(h);/**Iterateoverallimporttables;doa
filteredimport*fortheafi/saficombination*/for(it=h->imports;it;it=it->next){for(
afi=AFI_IP;afi<AFI_MAX;++afi){total_active_local+=it->local_count[afi];total_act
ive_remote+=it->remote_count[afi];total_holddown+=it->holddown_count[afi];total_
imported+=it->imported_count[afi];}}void*cursor;intrc;if(h->import_mac){for(curs
or=NULL,rc=skiplist_next(h->import_mac,NULL,(void**)&it,&cursor);!rc;rc=skiplist
_next(h->import_mac,NULL,(void**)&it,&cursor)){total_active_local+=it->local_cou
nt[AFI_L2VPN];total_active_remote+=it->remote_count[AFI_L2VPN];total_holddown+=i
t->holddown_count[AFI_L2VPN];total_imported+=it->imported_count[AFI_L2VPN];}}if(
pALRcount){*pALRcount=total_active_local;}if(pARRcount){*pARRcount=total_active_
remote;}if(pHRcount){*pHRcount=total_holddown;}if(pIRcount){*pIRcount=total_impo
rted;}}/*------------------------------------------*rfapiGetHolddownFromLifetime
**calculateholddownvaluebasedonlifetime**input:*lifetimelifetime**returnvalue:*H
olddownvaluebasedonlifetime,holddown_factor,*andRFAPI_LIFETIME_INFINITE_WITHDRAW
_DELAY*--------------------------------------------*//*holddowntimemaxesoutatRFA
PI_LIFETIME_INFINITE_WITHDRAW_DELAY*/uint32_trfapiGetHolddownFromLifetime(uint32
_tlifetime){uint32_tfactor;structbgp*bgp;bgp=bgp_get_default();if(bgp&&bgp->rfap
i_cfg)factor=bgp->rfapi_cfg->rfp_cfg.holddown_factor;elsefactor=RFAPI_RFP_CFG_DE
FAULT_HOLDDOWN_FACTOR;if(factor<100||lifetime<RFAPI_LIFETIME_INFINITE_WITHDRAW_D
ELAY)lifetime=lifetime*factor/100;if(lifetime<RFAPI_LIFETIME_INFINITE_WITHDRAW_D
ELAY)returnlifetime;elsereturnRFAPI_LIFETIME_INFINITE_WITHDRAW_DELAY;}