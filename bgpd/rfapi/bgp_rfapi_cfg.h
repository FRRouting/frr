/***Copyright2009-2016,LabNConsulting,L.L.C.***Thisprogramisfreesoftware;youcanr
edistributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishe
dbytheFreeSoftwareFoundation;eitherversion2*oftheLicense,or(atyouroption)anylate
rversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
fndef_QUAGGA_BGP_RFAPI_CFG_H#define_QUAGGA_BGP_RFAPI_CFG_H#include"lib/table.h"#
include"lib/routemap.h"#ifENABLE_BGP_VNC#include"rfapi.h"structrfapi_l2_group_cf
g{char*name;uint32_tlogical_net_id;structlist*labels;/*listofuint32_t*/structeco
mmunity*rt_import_list;structecommunity*rt_export_list;void*rfp_cfg;/*rfpownedgr
oupconfig*/QOBJ_FIELDS};DECLARE_QOBJ_TYPE(rfapi_l2_group_cfg)typedefenum{RFAPI_G
ROUP_CFG_NVE=1,RFAPI_GROUP_CFG_VRF,RFAPI_GROUP_CFG_L2,RFAPI_GROUP_CFG_MAX}rfapi_
group_cfg_type_t;structrfapi_nve_group_cfg{structroute_node*vn_node;/*backref*/s
tructroute_node*un_node;/*backref*/rfapi_group_cfg_type_ttype;/*NVE|VPN*/char*na
me;/*uniquebytype!*/structprefixvn_prefix;structprefixun_prefix;structprefix_rdr
d;uint8_tl2rd;/*0=VNaddrLSB*/uint32_tresponse_lifetime;uint32_tflags;#defineRFAP
I_RFG_RESPONSE_LIFETIME0x01/*bits*/#defineRFAPI_RFG_L2RD0x02#defineRFAPI_RFG_VPN
_NH_SELF0x04structecommunity*rt_import_list;structecommunity*rt_export_list;stru
ctrfapi_import_table*rfapi_import_table;void*rfp_cfg;/*rfpownedgroupconfig*//**L
istofNVEdescriptorsthatareassignedtothisNVEgroup**Currently(Mar2010)thislistisus
edonlybytheroute*exportcodetogenerateper-NVEnexthopsforeachroute.**Thenvedescrip
torslistedherehavepointersbackto*thisnvegroupconfigstructuretoenablethemtodelete
*theirownlistentrieswhentheyareclosed.Consequently,*ifaninstanceofthisnvegroupco
nfigstructureisdeleted,*wemustfirstsetthenvedescriptorreferencestoittoNULL.*/str
uctlist*nves;/**Routefiltering**Prefixlistsaresegregatedbyafi(partofthebaseplist
code)*Route-mapsarenotsegregated*/char*plist_export_bgp_name[AFI_MAX];structpref
ix_list*plist_export_bgp[AFI_MAX];char*plist_export_zebra_name[AFI_MAX];structpr
efix_list*plist_export_zebra[AFI_MAX];char*plist_redist_name[ZEBRA_ROUTE_MAX][AF
I_MAX];structprefix_list*plist_redist[ZEBRA_ROUTE_MAX][AFI_MAX];char*routemap_ex
port_bgp_name;structroute_map*routemap_export_bgp;char*routemap_export_zebra_nam
e;structroute_map*routemap_export_zebra;char*routemap_redist_name[ZEBRA_ROUTE_MA
X];structroute_map*routemap_redist[ZEBRA_ROUTE_MAX];/*forVRFtypegroups*/uint32_t
label;structrfapi_descriptor*rfd;QOBJ_FIELDS};DECLARE_QOBJ_TYPE(rfapi_nve_group_
cfg)structrfapi_rfg_name{structrfapi_nve_group_cfg*rfg;char*name;};typedefenum{V
NC_REDIST_MODE_PLAIN=0,/*0=default*/VNC_REDIST_MODE_RFG,VNC_REDIST_MODE_RESOLVE_
NVE}vnc_redist_mode_t;structrfapi_cfg{structprefix_rddefault_rd;uint8_tdefault_l
2rd;structecommunity*default_rt_import_list;structecommunity*default_rt_export_l
ist;uint32_tdefault_response_lifetime;#defineBGP_VNC_DEFAULT_RESPONSE_LIFETIME_D
EFAULT3600void*default_rfp_cfg;/*rfpownedgroupconfig*/structlist*l2_groups;/*rfa
pi_l2_group_cfglist*//*threeviewsintothesamecollectionofrfapi_nve_group_cfg*/str
uctlist*nve_groups_sequential;structroute_table*nve_groups_vn[AFI_MAX];structrou
te_table*nve_groups_un[AFI_MAX];/**ForSingleVRFexporttoordinaryroutingprotocols.
Thisis*thenve-groupthattheordinaryprotocolsbelongto.Weuseit*tosettheRDwhensendin
gunicastZebraroutestoVNC*/uint8_tredist[AFI_MAX][ZEBRA_ROUTE_MAX];uint32_tredist
_lifetime;vnc_redist_mode_tredist_mode;/**viewnameofBGPunicastinstancethatholds*
exteriorroutes*/char*redist_bgp_exterior_view_name;structbgp*redist_bgp_exterior
_view;/**nvegroupforredistributionofroutesfromzebratoVNC*(whichisprobablynotusef
ulforproductionnetworks)*/char*rfg_redist_name;structrfapi_nve_group_cfg*rfg_red
ist;/**ListofNVEgroupsonwhosebehalfwewillexportVNC*routestozebra.((NB:it'sactual
lyalistof<struct*rfapi_rfg_name>)*ThislistisusedwhenBGP_VNC_CONFIG_EXPORT_ZEBRA_
MODE_BITSis*BGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_GRP*/structlist*rfg_export_zebra_l;
/**ListofNVEgroupsonwhosebehalfwewillexportVNC*routesdirectlytothebgpunicastRIB.
(NB:it'sactually*alistof<structrfapi_rfg_name>)*ThislistisusedwhenBGP_VNC_CONFIG
_EXPORT_BGP_MODE_BITSis*BGP_VNC_CONFIG_EXPORT_BGP_MODE_GRP*/structlist*rfg_expor
t_direct_bgp_l;/**ExportedRoutefiltering**Prefixlistsaresegregatedbyafi(partofth
ebaseplistcode)*Route-mapsarenotsegregated*/char*plist_export_bgp_name[AFI_MAX];
structprefix_list*plist_export_bgp[AFI_MAX];char*plist_export_zebra_name[AFI_MAX
];structprefix_list*plist_export_zebra[AFI_MAX];char*routemap_export_bgp_name;st
ructroute_map*routemap_export_bgp;char*routemap_export_zebra_name;structroute_ma
p*routemap_export_zebra;/**Redistributedroutefiltering(routesfromother*protocols
intoVNC)*/char*plist_redist_name[ZEBRA_ROUTE_MAX][AFI_MAX];structprefix_list*pli
st_redist[ZEBRA_ROUTE_MAX][AFI_MAX];char*routemap_redist_name[ZEBRA_ROUTE_MAX];s
tructroute_map*routemap_redist[ZEBRA_ROUTE_MAX];/**Forimportingbgpunicastroutest
oVNC,weencodetheCE*(routenexthop)inaRouteOriginextendedcommunity.The*localpart(1
6-bit)isuser-configurable.*/uint16_tresolve_nve_roo_local_admin;#defineBGP_VNC_C
ONFIG_RESOLVE_NVE_ROO_LOCAL_ADMIN_DEFAULT5226uint32_tflags;#defineBGP_VNC_CONFIG
_ADV_UN_METHOD_ENCAP0x00000001#defineBGP_VNC_CONFIG_CALLBACK_DISABLE0x00000002#d
efineBGP_VNC_CONFIG_RESPONSE_REMOVAL_DISABLE0x00000004#defineBGP_VNC_CONFIG_EXPO
RT_BGP_MODE_BITS0x000000f0#defineBGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_BITS0x00000f00
#defineBGP_VNC_CONFIG_EXPORT_BGP_MODE_NONE0x00000000#defineBGP_VNC_CONFIG_EXPORT
_BGP_MODE_GRP0x00000010#defineBGP_VNC_CONFIG_EXPORT_BGP_MODE_RH0x00000020/*regis
terdnve*/#defineBGP_VNC_CONFIG_EXPORT_BGP_MODE_CE0x00000040#defineBGP_VNC_CONFIG
_EXPORT_ZEBRA_MODE_NONE0x00000000#defineBGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_GRP0x00
000100#defineBGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_RH0x00000200#defineBGP_VNC_CONFIG_
FILTER_SELF_FROM_RSP0x00001000#defineBGP_VNC_CONFIG_L2RD0x00002000/*UsenewNVERIB
tofiltercallbackroutes*//*FilterqueryingNVE'sregistrationsfromresponses*//*Defau
lttoupdated-responsesoff*//*Defaulttoremoval-responsesoff*/#defineBGP_VNC_CONFIG
_FLAGS_DEFAULT\(BGP_VNC_CONFIG_FILTER_SELF_FROM_RSP|BGP_VNC_CONFIG_CALLBACK_DISA
BLE\|BGP_VNC_CONFIG_RESPONSE_REMOVAL_DISABLE)structrfapi_rfp_cfgrfp_cfg;/*rfprel
atedconfiguration*/};#defineVNC_EXPORT_ZEBRA_GRP_ENABLED(hc)\(((hc)->flags&BGP_V
NC_CONFIG_EXPORT_ZEBRA_MODE_BITS)\==BGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_GRP)#define
VNC_EXPORT_ZEBRA_RH_ENABLED(hc)\(((hc)->flags&BGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_B
ITS)\==BGP_VNC_CONFIG_EXPORT_ZEBRA_MODE_RH)#defineVNC_EXPORT_BGP_GRP_ENABLED(hc)
\(((hc)->flags&BGP_VNC_CONFIG_EXPORT_BGP_MODE_BITS)\==BGP_VNC_CONFIG_EXPORT_BGP_
MODE_GRP)#defineVNC_EXPORT_BGP_RH_ENABLED(hc)\(((hc)->flags&BGP_VNC_CONFIG_EXPOR
T_BGP_MODE_BITS)\==BGP_VNC_CONFIG_EXPORT_BGP_MODE_RH)#defineVNC_EXPORT_BGP_CE_EN
ABLED(hc)\(((hc)->flags&BGP_VNC_CONFIG_EXPORT_BGP_MODE_BITS)\==BGP_VNC_CONFIG_EX
PORT_BGP_MODE_CE)voidbgp_rfapi_cfg_init(void);structrfapi_cfg*bgp_rfapi_cfg_new(
structrfapi_rfp_cfg*cfg);voidbgp_rfapi_cfg_destroy(structbgp*bgp,structrfapi_cfg
*h);intbgp_rfapi_cfg_write(structvty*vty,structbgp*bgp);externintbgp_rfapi_is_vn
c_configured(structbgp*bgp);externvoidnve_group_to_nve_list(structrfapi_nve_grou
p_cfg*rfg,structlist**nves,uint8_tfamily);/*AF_INET,AF_INET6*/structrfapi_nve_gr
oup_cfg*bgp_rfapi_cfg_match_group(structrfapi_cfg*hc,structprefix*vn,structprefi
x*un);structrfapi_nve_group_cfg*bgp_rfapi_cfg_match_byname(structbgp*bgp,constch
ar*name,rfapi_group_cfg_type_ttype);/*_MAX=any*/externvoidvnc_prefix_list_update
(structbgp*bgp);externvoidvnc_routemap_update(structbgp*bgp,constchar*unused);ex
ternvoidbgp_rfapi_show_summary(structbgp*bgp,structvty*vty);externstructrfapi_cf
g*bgp_rfapi_get_config(structbgp*bgp);externstructrfapi_l2_group_cfg*bgp_rfapi_g
et_group_by_lni_label(structbgp*bgp,uint32_tlogical_net_id,uint32_tlabel);extern
structecommunity*bgp_rfapi_get_ecommunity_by_lni_label(structbgp*bgp,uint32_tis_
import,uint32_tlogical_net_id,uint32_tlabel);/*note,20bitlabel!*/externstructlis
t*bgp_rfapi_get_labellist_by_lni_label(structbgp*bgp,uint32_tlogical_net_id,uint
32_tlabel);/*note,20bitlabel!*/#endif/*ENABLE_BGP_VNC*/#endif/*_QUAGGA_BGP_RFAPI
_CFG_H*/