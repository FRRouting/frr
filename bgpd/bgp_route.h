/*BGProutinginformationbase*Copyright(C)1996,97,98,2000KunihiroIshiguro**Thisfil
eispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*un
derthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;e
itherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopet
hatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHAN
TABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredeta
ils.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogra
m;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fi
fthFloor,Boston,MA02110-1301USA*/#ifndef_QUAGGA_BGP_ROUTE_H#define_QUAGGA_BGP_RO
UTE_H#include"queue.h"#include"nexthop.h"#include"bgp_table.h"structbgp_nexthop_
cache;structbgp_route_evpn;enumbgp_show_type{bgp_show_type_normal,bgp_show_type_
regexp,bgp_show_type_prefix_list,bgp_show_type_filter_list,bgp_show_type_route_m
ap,bgp_show_type_neighbor,bgp_show_type_cidr_only,bgp_show_type_prefix_longer,bg
p_show_type_community_all,bgp_show_type_community,bgp_show_type_community_exact,
bgp_show_type_community_list,bgp_show_type_community_list_exact,bgp_show_type_lc
ommunity_all,bgp_show_type_lcommunity,bgp_show_type_lcommunity_list,bgp_show_typ
e_flap_statistics,bgp_show_type_flap_neighbor,bgp_show_type_dampend_paths,bgp_sh
ow_type_damp_neighbor,bgp_show_type_detail,};#defineBGP_SHOW_SCODE_HEADER\"Statu
scodes:ssuppressed,ddamped,"\"hhistory,*valid,>best,=multipath,\n"\"iinternal,rR
IB-failure,SStale,RRemoved\n"#defineBGP_SHOW_OCODE_HEADER"Origincodes:i-IGP,e-EG
P,?-incomplete\n\n"#defineBGP_SHOW_HEADER"NetworkNextHopMetricLocPrfWeightPath\n
"/*Maximumnumberoflabelswecanprocessorsendwithaprefix.We*reallydoonly1forMPLS(BG
P-LU)butwecando2forEVPN-VxLAN.*/#defineBGP_MAX_LABELS2/*Ancillaryinformationtost
ructbgp_info,*usedforuncommonlyuseddata(aggregation,MPLS,etc.)*andlazilyallocate
dtosavememory.*/structbgp_info_extra{/*Pointertodampeningstructure.*/structbgp_d
amp_info*damp_info;/*Thisrouteissuppressedwithaggregation.*/intsuppress;/*Nextho
preachabilitycheck.*/uint32_tigpmetric;/*MPLSlabel(s)-VNI(s)forEVPN-VxLAN*/mpls_
label_tlabel[BGP_MAX_LABELS];uint32_tnum_labels;#ifENABLE_BGP_VNCunion{struct{vo
id*rfapi_handle;/*export:NVEadvertisingthisroute*/structlist*local_nexthops;/*op
tional,forstaticroutes*/}export;struct{structthread*timer;void*hme;/*encapmonito
r,ifthisisaVPNroute*/structprefix_rdrd;/*import:route'sroute-distinguisher*/uint
8_tun_family;/*familyofcachedunaddress,0ifunset*/union{structin_addraddr4;struct
in6_addraddr6;}un;/*cachedunaddress*/time_tcreate_time;structprefixaux_prefix;/*
AFI_L2VPN:theIPaddr,iffamilyset*/}import;}vnc;#endif/*ForimportedroutesintoaVNI(
orVRF),thispointstotheparent.*/void*parent;/**Sometunnelishparametersfollow.Mayb
econsolidateintoan*internaltunnelstructure?*//**Originalbgpinstanceforimportedro
utes.Neededfor:*1.Findallroutesfromaspecificvrffordeletion*2.vrfcontextoforigina
lnexthop**Storepointertobgpinstanceratherthanbgp->vrf_idbecause*bgp->vrf_idisnot
alwaysvalid(ormaychange?).**SettoNULLifrouteisnotimportedfromanotherbgpinstance.
*/structbgp*bgp_orig;/**Nexthopincontextoforiginalbgpinstance.Needed*forlabelres
olutionofcoremplsroutesexportedtoavrf.*Setnexthop_orig.familyto0ifnotvalid.*/str
uctprefixnexthop_orig;};structbgp_info{/*Forlinkedlist.*/structbgp_info*next;str
uctbgp_info*prev;/*Fornexthoplinkedlist*/LIST_ENTRY(bgp_info)nh_thread;/*Backpoi
ntertotheprefixnode*/structbgp_node*net;/*Backpointertothenexthopstructure*/stru
ctbgp_nexthop_cache*nexthop;/*Peerstructure.*/structpeer*peer;/*Attributestructu
re.*/structattr*attr;/*Extrainformation*/structbgp_info_extra*extra;/*Multipathi
nformation*/structbgp_info_mpath*mpath;/*Uptime.*/time_tuptime;/*referencecount*
/intlock;/*BGPinformationstatus.*/uint16_tflags;#defineBGP_INFO_IGP_CHANGED(1<<0
)#defineBGP_INFO_DAMPED(1<<1)#defineBGP_INFO_HISTORY(1<<2)#defineBGP_INFO_SELECT
ED(1<<3)#defineBGP_INFO_VALID(1<<4)#defineBGP_INFO_ATTR_CHANGED(1<<5)#defineBGP_
INFO_DMED_CHECK(1<<6)#defineBGP_INFO_DMED_SELECTED(1<<7)#defineBGP_INFO_STALE(1<
<8)#defineBGP_INFO_REMOVED(1<<9)#defineBGP_INFO_COUNTED(1<<10)#defineBGP_INFO_MU
LTIPATH(1<<11)#defineBGP_INFO_MULTIPATH_CHG(1<<12)#defineBGP_INFO_RIB_ATTR_CHG(1
<<13)/*BGProutetype.Thiscanbestatic,RIP,OSPF,BGPetc.*/uint8_ttype;/*Whenabovetyp
eisBGP.ThissubtypespecifyBGPsubtypeinformation.*/uint8_tsub_type;#defineBGP_ROUT
E_NORMAL0#defineBGP_ROUTE_STATIC1#defineBGP_ROUTE_AGGREGATE2#defineBGP_ROUTE_RED
ISTRIBUTE3#ifdefENABLE_BGP_VNC#defineBGP_ROUTE_RFP4#endif#defineBGP_ROUTE_IMPORT
ED5/*fromanotherbgpinstance/safi*/unsignedshortinstance;/*Addpathidentifiers*/ui
nt32_taddpath_rx_id;uint32_taddpath_tx_id;};/*StructureusedinBGPpathselection*/s
tructbgp_info_pair{structbgp_info*old;structbgp_info*new;};/*BGPstaticrouteconfi
guration.*/structbgp_static{/*Backdoorconfiguration.*/intbackdoor;/*Labelindexco
nfiguration;appliestoLUprefixes.*/uint32_tlabel_index;#defineBGP_INVALID_LABEL_I
NDEX0xFFFFFFFF/*Importcheckstatus.*/uint8_tvalid;/*IGPmetric.*/uint32_tigpmetric
;/*IGPnexthop.*/structin_addrigpnexthop;/*Atomicsetreferencecount(iecauseofpathl
imit)*/uint32_tatomic;/*BGPredistributeroute-map.*/struct{char*name;structroute_
map*map;}rmap;/*RouteDistinguisher*/structprefix_rdprd;/*MPLSlabel.*/mpls_label_
tlabel;/*EVPN*/structeth_segment_id*eth_s_id;structethaddr*router_mac;uint16_ten
cap_tunneltype;structprefixgatewayIp;};#defineBGP_NEXTHOP_AFI_FROM_NHLEN(nhlen)\
((nhlen)<IPV4_MAX_BYTELEN\?0\:((nhlen)<IPV6_MAX_BYTELEN?AFI_IP:AFI_IP6))#defineB
GP_ATTR_NEXTHOP_AFI_IP6(attr)\(!CHECK_FLAG(attr->flag,ATTR_FLAG_BIT(BGP_ATTR_NEX
T_HOP))\&&((attr)->mp_nexthop_len==16||(attr)->mp_nexthop_len==32))#defineBGP_IN
FO_COUNTABLE(BI)\(!CHECK_FLAG((BI)->flags,BGP_INFO_HISTORY)\&&!CHECK_FLAG((BI)->
flags,BGP_INFO_REMOVED))/*Flagswhichindicatearouteisunuseableinsomeform*/#define
BGP_INFO_UNUSEABLE\(BGP_INFO_HISTORY|BGP_INFO_DAMPED|BGP_INFO_REMOVED)/*Macrotoc
heckBGPinformationisaliveornot.Sadly,*notequivalenttojustcheckingprevious,becaus
eofthe*senseoftheadditionalVALIDflag.*/#defineBGP_INFO_HOLDDOWN(BI)\(!CHECK_FLAG
((BI)->flags,BGP_INFO_VALID)\||CHECK_FLAG((BI)->flags,BGP_INFO_UNUSEABLE))#defin
eDISTRIBUTE_IN_NAME(F)((F)->dlist[FILTER_IN].name)#defineDISTRIBUTE_IN(F)((F)->d
list[FILTER_IN].alist)#defineDISTRIBUTE_OUT_NAME(F)((F)->dlist[FILTER_OUT].name)
#defineDISTRIBUTE_OUT(F)((F)->dlist[FILTER_OUT].alist)#definePREFIX_LIST_IN_NAME
(F)((F)->plist[FILTER_IN].name)#definePREFIX_LIST_IN(F)((F)->plist[FILTER_IN].pl
ist)#definePREFIX_LIST_OUT_NAME(F)((F)->plist[FILTER_OUT].name)#definePREFIX_LIS
T_OUT(F)((F)->plist[FILTER_OUT].plist)#defineFILTER_LIST_IN_NAME(F)((F)->aslist[
FILTER_IN].name)#defineFILTER_LIST_IN(F)((F)->aslist[FILTER_IN].aslist)#defineFI
LTER_LIST_OUT_NAME(F)((F)->aslist[FILTER_OUT].name)#defineFILTER_LIST_OUT(F)((F)
->aslist[FILTER_OUT].aslist)#defineROUTE_MAP_IN_NAME(F)((F)->map[RMAP_IN].name)#
defineROUTE_MAP_IN(F)((F)->map[RMAP_IN].map)#defineROUTE_MAP_OUT_NAME(F)((F)->ma
p[RMAP_OUT].name)#defineROUTE_MAP_OUT(F)((F)->map[RMAP_OUT].map)#defineUNSUPPRES
S_MAP_NAME(F)((F)->usmap.name)#defineUNSUPPRESS_MAP(F)((F)->usmap.map)/*pathPREF
IX(addpathrxidNUMBER)*/#definePATH_ADDPATH_STR_BUFFERPREFIX2STR_BUFFER+32enumbgp
_path_type{BGP_PATH_ALL,BGP_PATH_BESTPATH,BGP_PATH_MULTIPATH};staticinlinevoidbg
p_bump_version(structbgp_node*node){node->version=bgp_table_next_version(bgp_nod
e_table(node));}staticinlineintbgp_fibupd_safi(safi_tsafi){if(safi==SAFI_UNICAST
||safi==SAFI_MULTICAST||safi==SAFI_LABELED_UNICAST)return1;return0;}/*Prototypes
.*/externvoidbgp_rib_remove(structbgp_node*rn,structbgp_info*ri,structpeer*peer,
afi_tafi,safi_tsafi);externvoidbgp_process_queue_init(void);externvoidbgp_route_
init(void);externvoidbgp_route_finish(void);externvoidbgp_cleanup_routes(structb
gp*);externvoidbgp_announce_route(structpeer*,afi_t,safi_t);externvoidbgp_stop_a
nnounce_route_timer(structpeer_af*paf);externvoidbgp_announce_route_all(structpe
er*);externvoidbgp_default_originate(structpeer*,afi_t,safi_t,int);externvoidbgp
_soft_reconfig_in(structpeer*,afi_t,safi_t);externvoidbgp_clear_route(structpeer
*,afi_t,safi_t);externvoidbgp_clear_route_all(structpeer*);externvoidbgp_clear_a
dj_in(structpeer*,afi_t,safi_t);externvoidbgp_clear_stale_route(structpeer*,afi_
t,safi_t);externstructbgp_node*bgp_afi_node_get(structbgp_table*table,afi_tafi,s
afi_tsafi,structprefix*p,structprefix_rd*prd);externstructbgp_info*bgp_info_lock
(structbgp_info*);externstructbgp_info*bgp_info_unlock(structbgp_info*);externvo
idbgp_info_add(structbgp_node*rn,structbgp_info*ri);externvoidbgp_info_reap(stru
ctbgp_node*rn,structbgp_info*ri);externvoidbgp_info_delete(structbgp_node*rn,str
uctbgp_info*ri);externstructbgp_info_extra*bgp_info_extra_get(structbgp_info*);e
xternvoidbgp_info_set_flag(structbgp_node*,structbgp_info*,uint32_t);externvoidb
gp_info_unset_flag(structbgp_node*,structbgp_info*,uint32_t);externvoidbgp_info_
path_with_addpath_rx_str(structbgp_info*ri,char*buf);externintbgp_nlri_parse_ip(
structpeer*,structattr*,structbgp_nlri*);externintbgp_maximum_prefix_overflow(st
ructpeer*,afi_t,safi_t,int);externvoidbgp_redistribute_add(structbgp*bgp,structp
refix*p,constuniong_addr*nexthop,ifindex_tifindex,enumnexthop_types_tnhtype,uint
32_tmetric,uint8_ttype,unsignedshortinstance,route_tag_ttag);externvoidbgp_redis
tribute_delete(structbgp*,structprefix*,uint8_t,unsignedshort);externvoidbgp_red
istribute_withdraw(structbgp*,afi_t,int,unsignedshort);externvoidbgp_static_add(
structbgp*);externvoidbgp_static_delete(structbgp*);externvoidbgp_static_redo_im
port_check(structbgp*);externvoidbgp_purge_static_redist_routes(structbgp*bgp);e
xternvoidbgp_static_update(structbgp*,structprefix*,structbgp_static*,afi_t,safi
_t);externvoidbgp_static_withdraw(structbgp*,structprefix*,afi_t,safi_t);externi
ntbgp_static_set_safi(afi_tafi,safi_tsafi,structvty*vty,constchar*,constchar*,co
nstchar*,constchar*,int,constchar*,constchar*,constchar*,constchar*);externintbg
p_static_unset_safi(afi_tafi,safi_tsafi,structvty*,constchar*,constchar*,constch
ar*,int,constchar*,constchar*,constchar*);/*thisisprimarilyforMPLS-VPN*/externin
tbgp_update(structpeer*,structprefix*,uint32_t,structattr*,afi_t,safi_t,int,int,
structprefix_rd*,mpls_label_t*,uint32_t,int,structbgp_route_evpn*);externintbgp_
withdraw(structpeer*,structprefix*,uint32_t,structattr*,afi_t,safi_t,int,int,str
uctprefix_rd*,mpls_label_t*,uint32_t,structbgp_route_evpn*);/*forbgp_nexthopandb
gp_damp*/externvoidbgp_process(structbgp*,structbgp_node*,afi_t,safi_t);/**Addan
end-of-initial-updatemarkertotheprocessqueue.Thisisjusta*queueelementwithNULLbgp
node.*/externvoidbgp_add_eoiu_mark(structbgp*);externvoidbgp_config_write_table_
map(structvty*,structbgp*,afi_t,safi_t);externvoidbgp_config_write_network(struc
tvty*,structbgp*,afi_t,safi_t);externvoidbgp_config_write_distance(structvty*,st
ructbgp*,afi_t,safi_t);externvoidbgp_aggregate_increment(structbgp*,structprefix
*,structbgp_info*,afi_t,safi_t);externvoidbgp_aggregate_decrement(structbgp*,str
uctprefix*,structbgp_info*,afi_t,safi_t);externuint8_tbgp_distance_apply(structp
refix*,structbgp_info*,afi_t,safi_t,structbgp*);externafi_tbgp_node_afi(structvt
y*);externsafi_tbgp_node_safi(structvty*);externstructbgp_info*info_make(inttype
,intsub_type,unsignedshortinstance,structpeer*peer,structattr*attr,structbgp_nod
e*rn);externvoidroute_vty_out(structvty*,structprefix*,structbgp_info*,int,safi_
t,json_object*);externvoidroute_vty_out_tag(structvty*,structprefix*,structbgp_i
nfo*,int,safi_t,json_object*);externvoidroute_vty_out_tmp(structvty*,structprefi
x*,structattr*,safi_t,uint8_t,json_object*);externvoidroute_vty_out_overlay(stru
ctvty*vty,structprefix*p,structbgp_info*binfo,intdisplay,json_object*json);exter
nintsubgroup_process_announce_selected(structupdate_subgroup*subgrp,structbgp_in
fo*selected,structbgp_node*rn,uint32_taddpath_tx_id);externintsubgroup_announce_
check(structbgp_node*rn,structbgp_info*ri,structupdate_subgroup*subgrp,structpre
fix*p,structattr*attr);externvoidbgp_peer_clear_node_queue_drain_immediate(struc
tpeer*peer);externvoidbgp_process_queues_drain_immediate(void);/*forencap/vpn*/e
xternstructbgp_node*bgp_afi_node_lookup(structbgp_table*table,afi_tafi,safi_tsaf
i,structprefix*p,structprefix_rd*prd);externstructbgp_info*bgp_info_new(void);ex
ternvoidbgp_info_restore(structbgp_node*,structbgp_info*);externintbgp_info_cmp_
compatible(structbgp*,structbgp_info*,structbgp_info*,char*pfx_buf,afi_tafi,safi
_tsafi);externvoidbgp_attr_add_gshut_community(structattr*attr);externvoidbgp_be
st_selection(structbgp*bgp,structbgp_node*rn,structbgp_maxpaths_cfg*mpath_cfg,st
ructbgp_info_pair*result,afi_tafi,safi_tsafi);externvoidbgp_zebra_clear_route_ch
ange_flags(structbgp_node*rn);externintbgp_zebra_has_route_changed(structbgp_nod
e*rn,structbgp_info*selected);externvoidroute_vty_out_detail_header(structvty*vt
y,structbgp*bgp,structbgp_node*rn,structprefix_rd*prd,afi_tafi,safi_tsafi,json_o
bject*json);externvoidroute_vty_out_detail(structvty*vty,structbgp*bgp,structpre
fix*p,structbgp_info*binfo,afi_tafi,safi_tsafi,json_object*json_paths);externint
bgp_show_table_rd(structvty*vty,structbgp*bgp,safi_tsafi,structbgp_table*table,s
tructprefix_rd*prd,enumbgp_show_typetype,void*output_arg,uint8_tuse_json);#endif
/*_QUAGGA_BGP_ROUTE_H*/