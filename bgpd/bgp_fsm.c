/*BGP-4FiniteStateMachine*FromRFC1771[ABorderGatewayProtocol4(BGP-4)]*Copyright(
C)1996,97,98KunihiroIshiguro**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;
youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspu
blishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*latervers
ion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;wi
thouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.Seet
heGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGen
eralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSof
tware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<z
ebra.h>#include"linklist.h"#include"prefix.h"#include"sockunion.h"#include"threa
d.h"#include"log.h"#include"stream.h"#include"ringbuf.h"#include"memory.h"#inclu
de"plist.h"#include"workqueue.h"#include"queue.h"#include"filter.h"#include"comm
and.h"#include"lib/json.h"#include"bgpd/bgpd.h"#include"bgpd/bgp_attr.h"#include
"bgpd/bgp_debug.h"#include"bgpd/bgp_fsm.h"#include"bgpd/bgp_packet.h"#include"bg
pd/bgp_network.h"#include"bgpd/bgp_route.h"#include"bgpd/bgp_dump.h"#include"bgp
d/bgp_open.h"#include"bgpd/bgp_advertise.h"#include"bgpd/bgp_updgrp.h"#include"b
gpd/bgp_nht.h"#include"bgpd/bgp_bfd.h"#include"bgpd/bgp_memory.h"#include"bgpd/b
gp_keepalives.h"#include"bgpd/bgp_io.h"DEFINE_HOOK(peer_backward_transition,(str
uctpeer*peer),(peer))DEFINE_HOOK(peer_established,(structpeer*peer),(peer))/*Def
initionofdisplaystringscorrespondingtoFSMevents.Thisshouldbe*keptconsistentwitht
heeventsdefinedinbgpd.h*/staticconstchar*bgp_event_str[]={NULL,"BGP_Start","BGP_
Stop","TCP_connection_open","TCP_connection_closed","TCP_connection_open_failed"
,"TCP_fatal_error","ConnectRetry_timer_expired","Hold_Timer_expired","KeepAlive_
timer_expired","Receive_OPEN_message","Receive_KEEPALIVE_message","Receive_UPDAT
E_message","Receive_NOTIFICATION_message","Clearing_Completed",};/*BGPFSM(finite
statemachine)hasthreetypesoffunctions.Typeoneisthreadfunctions.Typetwoiseventfun
ctions.TypethreeisFSMfunctions.Timerfunctionsaresetbybgp_timer_setfunction.*//*B
GPeventfunction.*/intbgp_event(structthread*);/*BGPthreadfunctions.*/staticintbg
p_start_timer(structthread*);staticintbgp_connect_timer(structthread*);staticint
bgp_holdtime_timer(structthread*);/*BGPFSMfunctions.*/staticintbgp_start(structp
eer*);staticvoidpeer_xfer_stats(structpeer*peer_dst,structpeer*peer_src){/*Copys
tatsover.Theseareonlythepre-establishedstatestats*/peer_dst->open_in+=peer_src->
open_in;peer_dst->open_out+=peer_src->open_out;peer_dst->keepalive_in+=peer_src-
>keepalive_in;peer_dst->keepalive_out+=peer_src->keepalive_out;peer_dst->notify_
in+=peer_src->notify_in;peer_dst->notify_out+=peer_src->notify_out;peer_dst->dyn
amic_cap_in+=peer_src->dynamic_cap_in;peer_dst->dynamic_cap_out+=peer_src->dynam
ic_cap_out;}staticstructpeer*peer_xfer_conn(structpeer*from_peer){structpeer*pee
r;afi_tafi;safi_tsafi;intfd;intstatus,pstatus;unsignedcharlast_evt,last_maj_evt;
assert(from_peer!=NULL);peer=from_peer->doppelganger;if(!peer||!CHECK_FLAG(peer-
>flags,PEER_FLAG_CONFIG_NODE))returnfrom_peer;if(bgp_debug_neighbor_events(peer)
)zlog_debug("%s:peertransfer%pfd%d->%pfd%d)",from_peer->host,from_peer,from_peer
->fd,peer,peer->fd);bgp_writes_off(peer);bgp_reads_off(peer);bgp_writes_off(from
_peer);bgp_reads_off(from_peer);BGP_TIMER_OFF(peer->t_routeadv);BGP_TIMER_OFF(pe
er->t_connect);BGP_TIMER_OFF(peer->t_connect_check_r);BGP_TIMER_OFF(peer->t_conn
ect_check_w);BGP_TIMER_OFF(from_peer->t_routeadv);BGP_TIMER_OFF(from_peer->t_con
nect);BGP_TIMER_OFF(from_peer->t_connect_check_r);BGP_TIMER_OFF(from_peer->t_con
nect_check_w);BGP_TIMER_OFF(from_peer->t_process_packet);/**Atthispointintime,it
ispossiblethattherearepacketspending*onvariousbuffers.Thoseneedtobetransferredor
dropped,*otherwisewe'llgetspuriousfailuresduringsessionestablishment.*/pthread_m
utex_lock(&peer->io_mtx);pthread_mutex_lock(&from_peer->io_mtx);{fd=peer->fd;pee
r->fd=from_peer->fd;from_peer->fd=fd;stream_fifo_clean(peer->ibuf);stream_fifo_c
lean(peer->obuf);/**thisshouldneverhappen,sincebgp_process_packet()isthe*onlytas
kthatsetsandunsetsthecurrentpacketandit*runsinourpthread.*/if(peer->curr){zlog_e
rr("[%s]Droppingpendingpacketonconnectiontransfer:",peer->host);uint16_ttype=str
eam_getc_from(peer->curr,BGP_MARKER_SIZE+2);bgp_dump_packet(peer,type,peer->curr
);stream_free(peer->curr);peer->curr=NULL;}//copyeachpacketfromoldpeer'soutputqu
euetonewpeerwhile(from_peer->obuf->head)stream_fifo_push(peer->obuf,stream_fifo_
pop(from_peer->obuf));//copyeachpacketfromoldpeer'sinputqueuetonewpeerwhile(from
_peer->ibuf->head)stream_fifo_push(peer->ibuf,stream_fifo_pop(from_peer->ibuf));
ringbuf_wipe(peer->ibuf_work);ringbuf_copy(peer->ibuf_work,from_peer->ibuf_work,
ringbuf_remain(from_peer->ibuf_work));}pthread_mutex_unlock(&from_peer->io_mtx);
pthread_mutex_unlock(&peer->io_mtx);peer->as=from_peer->as;peer->v_holdtime=from
_peer->v_holdtime;peer->v_keepalive=from_peer->v_keepalive;peer->routeadv=from_p
eer->routeadv;peer->v_routeadv=from_peer->v_routeadv;peer->v_gr_restart=from_pee
r->v_gr_restart;peer->cap=from_peer->cap;status=peer->status;pstatus=peer->ostat
us;last_evt=peer->last_event;last_maj_evt=peer->last_major_event;peer->status=fr
om_peer->status;peer->ostatus=from_peer->ostatus;peer->last_event=from_peer->las
t_event;peer->last_major_event=from_peer->last_major_event;from_peer->status=sta
tus;from_peer->ostatus=pstatus;from_peer->last_event=last_evt;from_peer->last_ma
jor_event=last_maj_evt;peer->remote_id=from_peer->remote_id;if(from_peer->hostna
me!=NULL){if(peer->hostname){XFREE(MTYPE_BGP_PEER_HOST,peer->hostname);peer->hos
tname=NULL;}peer->hostname=from_peer->hostname;from_peer->hostname=NULL;}if(from
_peer->domainname!=NULL){if(peer->domainname){XFREE(MTYPE_BGP_PEER_HOST,peer->do
mainname);peer->domainname=NULL;}peer->domainname=from_peer->domainname;from_pee
r->domainname=NULL;}FOREACH_AFI_SAFI(afi,safi){peer->af_flags[afi][safi]=from_pe
er->af_flags[afi][safi];peer->af_sflags[afi][safi]=from_peer->af_sflags[afi][saf
i];peer->af_cap[afi][safi]=from_peer->af_cap[afi][safi];peer->afc_nego[afi][safi
]=from_peer->afc_nego[afi][safi];peer->afc_adv[afi][safi]=from_peer->afc_adv[afi
][safi];peer->afc_recv[afi][safi]=from_peer->afc_recv[afi][safi];peer->orf_plist
[afi][safi]=from_peer->orf_plist[afi][safi];}if(bgp_getsockname(peer)<0){zlog_er
r("%%bgp_getsockname()failedfor%speer%sfd%d(from_peerfd%d)",(CHECK_FLAG(peer->sf
lags,PEER_STATUS_ACCEPT_PEER)?"accept":""),peer->host,peer->fd,from_peer->fd);bg
p_stop(peer);bgp_stop(from_peer);returnNULL;}if(from_peer->status>Active){if(bgp
_getsockname(from_peer)<0){zlog_err("%%bgp_getsockname()failedfor%sfrom_peer%sfd
%d(peerfd%d)",(CHECK_FLAG(from_peer->sflags,PEER_STATUS_ACCEPT_PEER)?"accept":""
),from_peer->host,from_peer->fd,peer->fd);bgp_stop(from_peer);from_peer=NULL;}}/
/Note:peer_xfer_stats()mustbecalledwithI/OturnedOFFif(from_peer)peer_xfer_stats(
peer,from_peer);bgp_reads_on(peer);bgp_writes_on(peer);thread_add_timer_msec(bm-
>master,bgp_process_packet,peer,0,&peer->t_process_packet);return(peer);}/*Hookf
unctioncalledafterbgpeventisoccered.Andvty'sneighborcommandinvokethisfunctionaft
ermakingneighborstructure.*/voidbgp_timer_set(structpeer*peer){switch(peer->stat
us){caseIdle:/*Firstentrypointofpeer'sfinitestatemachine.InIdlestatusstarttimeri
sonunlesspeerisshutdownorpeerisinactive.Allothertimermustbeturnedoff*/if(BGP_PEE
R_START_SUPPRESSED(peer)||!peer_active(peer)||peer->bgp->vrf_id==VRF_UNKNOWN){BG
P_TIMER_OFF(peer->t_start);}else{BGP_TIMER_ON(peer->t_start,bgp_start_timer,peer
->v_start);}BGP_TIMER_OFF(peer->t_connect);BGP_TIMER_OFF(peer->t_holdtime);bgp_k
eepalives_off(peer);BGP_TIMER_OFF(peer->t_routeadv);break;caseConnect:/*Aftersta
rttimerisexpired,thepeermovestoConnectstatus.Makesurestarttimerisoffandconnectti
merison.*/BGP_TIMER_OFF(peer->t_start);BGP_TIMER_ON(peer->t_connect,bgp_connect_
timer,peer->v_connect);BGP_TIMER_OFF(peer->t_holdtime);bgp_keepalives_off(peer);
BGP_TIMER_OFF(peer->t_routeadv);break;caseActive:/*Activeiswaitingconnectionfrom
remotepeer.Andifconnecttimerisexpired,changestatustoConnect.*/BGP_TIMER_OFF(peer
->t_start);/*Ifpeerispassivemode,donotsetconnecttimer.*/if(CHECK_FLAG(peer->flag
s,PEER_FLAG_PASSIVE)||CHECK_FLAG(peer->sflags,PEER_STATUS_NSF_WAIT)){BGP_TIMER_O
FF(peer->t_connect);}else{BGP_TIMER_ON(peer->t_connect,bgp_connect_timer,peer->v
_connect);}BGP_TIMER_OFF(peer->t_holdtime);bgp_keepalives_off(peer);BGP_TIMER_OF
F(peer->t_routeadv);break;caseOpenSent:/*OpenSentstatus.*/BGP_TIMER_OFF(peer->t_
start);BGP_TIMER_OFF(peer->t_connect);if(peer->v_holdtime!=0){BGP_TIMER_ON(peer-
>t_holdtime,bgp_holdtime_timer,peer->v_holdtime);}else{BGP_TIMER_OFF(peer->t_hol
dtime);}bgp_keepalives_off(peer);BGP_TIMER_OFF(peer->t_routeadv);break;caseOpenC
onfirm:/*OpenConfirmstatus.*/BGP_TIMER_OFF(peer->t_start);BGP_TIMER_OFF(peer->t_
connect);/*IfthenegotiatedHoldTimevalueiszero,thentheHoldTimetimerandKeepAliveti
mersarenotstarted.*/if(peer->v_holdtime==0){BGP_TIMER_OFF(peer->t_holdtime);bgp_
keepalives_off(peer);}else{BGP_TIMER_ON(peer->t_holdtime,bgp_holdtime_timer,peer
->v_holdtime);bgp_keepalives_on(peer);}BGP_TIMER_OFF(peer->t_routeadv);break;cas
eEstablished:/*InEstablishedstatusstartandconnecttimeristurnedoff.*/BGP_TIMER_OF
F(peer->t_start);BGP_TIMER_OFF(peer->t_connect);/*SameasOpenConfirm,ifholdtimeis
zerothenbothholdtimeandkeepalivemustbeturnedoff.*/if(peer->v_holdtime==0){BGP_TI
MER_OFF(peer->t_holdtime);bgp_keepalives_off(peer);}else{BGP_TIMER_ON(peer->t_ho
ldtime,bgp_holdtime_timer,peer->v_holdtime);bgp_keepalives_on(peer);}break;caseD
eleted:BGP_TIMER_OFF(peer->t_gr_restart);BGP_TIMER_OFF(peer->t_gr_stale);BGP_TIM
ER_OFF(peer->t_pmax_restart);/*fallthru*/caseClearing:BGP_TIMER_OFF(peer->t_star
t);BGP_TIMER_OFF(peer->t_connect);BGP_TIMER_OFF(peer->t_holdtime);bgp_keepalives
_off(peer);BGP_TIMER_OFF(peer->t_routeadv);break;}}/*BGPstarttimer.Thisfunctions
etBGP_Starteventtothreadvalueandprocessevent.*/staticintbgp_start_timer(structth
read*thread){structpeer*peer;peer=THREAD_ARG(thread);peer->t_start=NULL;if(bgp_d
ebug_neighbor_events(peer))zlog_debug("%s[FSM]Timer(starttimerexpire).",peer->ho
st);THREAD_VAL(thread)=BGP_Start;bgp_event(thread);/*bgp_eventunlockspeer*/retur
n0;}/*BGPconnectretrytimer.*/staticintbgp_connect_timer(structthread*thread){str
uctpeer*peer;intret;peer=THREAD_ARG(thread);assert(!peer->t_write);assert(!peer-
>t_read);peer->t_connect=NULL;if(bgp_debug_neighbor_events(peer))zlog_debug("%s[
FSM]Timer(connecttimerexpire)",peer->host);if(CHECK_FLAG(peer->sflags,PEER_STATU
S_ACCEPT_PEER)){bgp_stop(peer);ret=-1;}else{THREAD_VAL(thread)=ConnectRetry_time
r_expired;bgp_event(thread);/*bgp_eventunlockspeer*/ret=0;}returnret;}/*BGPholdt
imetimer.*/staticintbgp_holdtime_timer(structthread*thread){structpeer*peer;peer
=THREAD_ARG(thread);peer->t_holdtime=NULL;if(bgp_debug_neighbor_events(peer))zlo
g_debug("%s[FSM]Timer(holdtimetimerexpire)",peer->host);THREAD_VAL(thread)=Hold_
Timer_expired;bgp_event(thread);/*bgp_eventunlockspeer*/return0;}intbgp_routeadv
_timer(structthread*thread){structpeer*peer;peer=THREAD_ARG(thread);peer->t_rout
eadv=NULL;if(bgp_debug_neighbor_events(peer))zlog_debug("%s[FSM]Timer(routeadvti
merexpire)",peer->host);peer->synctime=bgp_clock();thread_add_timer_msec(bm->mas
ter,bgp_generate_updgrp_packets,peer,0,&peer->t_generate_updgrp_packets);/*MRAIt
imerwillbestartedagainwhenFIFOisbuilt,noneedto*doithere.*/return0;}/*BGPPeerDown
Cause*/constchar*peer_down_str[]={"","RouterIDchanged","RemoteASchanged","LocalA
Schange","ClusterIDchanged","Confederationidentifierchanged","Confederationpeerc
hanged","RRclientconfigchange","RSclientconfigchange","Updatesourcechange","Addr
essfamilyactivated","Admin.shutdown","Userreset","BGPNotificationreceived","BGPN
otificationsend","Peerclosedthesession","Neighbordeleted","Peer-groupaddmember",
"Peer-groupdeletemember","Capabilitychanged","Passiveconfigchange","Multihopconf
igchange","NSFpeerclosedthesession","Intfpeeringv6onlyconfigchange","BFDdownrece
ived","Interfacedown","Neighboraddresslost"};staticintbgp_graceful_restart_timer
_expire(structthread*thread){structpeer*peer;afi_tafi;safi_tsafi;peer=THREAD_ARG
(thread);peer->t_gr_restart=NULL;/*NSFdeletestaleroute*/for(afi=AFI_IP;afi<AFI_M
AX;afi++)for(safi=SAFI_UNICAST;safi<=SAFI_MPLS_VPN;safi++)if(peer->nsf[afi][safi
])bgp_clear_stale_route(peer,afi,safi);UNSET_FLAG(peer->sflags,PEER_STATUS_NSF_W
AIT);BGP_TIMER_OFF(peer->t_gr_stale);if(bgp_debug_neighbor_events(peer)){zlog_de
bug("%sgracefulrestarttimerexpired",peer->host);zlog_debug("%sgracefulrestartsta
lepathtimerstopped",peer->host);}bgp_timer_set(peer);return0;}staticintbgp_grace
ful_stale_timer_expire(structthread*thread){structpeer*peer;afi_tafi;safi_tsafi;
peer=THREAD_ARG(thread);peer->t_gr_stale=NULL;if(bgp_debug_neighbor_events(peer)
)zlog_debug("%sgracefulrestartstalepathtimerexpired",peer->host);/*NSFdeletestal
eroute*/for(afi=AFI_IP;afi<AFI_MAX;afi++)for(safi=SAFI_UNICAST;safi<=SAFI_MPLS_V
PN;safi++)if(peer->nsf[afi][safi])bgp_clear_stale_route(peer,afi,safi);return0;}
staticintbgp_update_delay_applicable(structbgp*bgp){/*update_delay_overflagshoul
dbereset(setto0)foranynewapplicabilityoftheupdate-delayduringBGPprocesslifetime.
Anditshouldbesetafteranoccurenceoftheupdate-delayisover)*/if(!bgp->update_delay_
over)return1;return0;}intbgp_update_delay_active(structbgp*bgp){if(bgp->t_update
_delay)return1;return0;}intbgp_update_delay_configured(structbgp*bgp){if(bgp->v_
update_delay)return1;return0;}/*Dothepost-processingneededwhenbgpcomesoutofthere
ad-onlymodeonendingtheupdatedelay.*/voidbgp_update_delay_end(structbgp*bgp){THRE
AD_TIMER_OFF(bgp->t_update_delay);THREAD_TIMER_OFF(bgp->t_establish_wait);/*Rese
tupdate-delayrelatedstate*/bgp->update_delay_over=1;bgp->established=0;bgp->rest
arted_peers=0;bgp->implicit_eors=0;bgp->explicit_eors=0;quagga_timestamp(3,bgp->
update_delay_end_time,sizeof(bgp->update_delay_end_time));/**Addanend-of-initial
-updatemarkertothemainprocessqueuesso*that*therouteadvertisementtimerforthepeers
canbestarted.Alsoset*thezebraandpeerupdateholdflags.Theseflagsareusedtoachieve*t
hreestagesintheupdate-delaypostprocessing:*1.Finishbest-pathselectionforallthepr
efixesheldonthe*queues.*(routesinBGPareupdated,andpeerssyncqueuesarepopulated*to
o)*2.Astheeoiumarkisreachedinthebgpprocessroutine,shipall*the*routestozebra.With
thatzebrashouldseeupdatesfromBGP*close*toeachother.*3.Unblockthepeerupdatewrites
.Withthatpeerupdatepacking*with*theprefixesshouldbeatitsmaximum.*/bgp_add_eoiu_m
ark(bgp);bgp->main_zebra_update_hold=1;bgp->main_peers_update_hold=1;/*Resumethe
queueprocessing.Thisshouldtriggertheeventthatwouldtakecareofprocessinganyworktha
twasqueuedduringtheread-onlymode.*/work_queue_unplug(bm->process_main_queue);}/*
**seebgp_fsm.h*/voidbgp_start_routeadv(structbgp*bgp){structlistnode*node,*nnode
;structpeer*peer;zlog_info("bgp_start_routeadv(),updateholdstatus%d",bgp->main_p
eers_update_hold);if(bgp->main_peers_update_hold)return;quagga_timestamp(3,bgp->
update_delay_peers_resume_time,sizeof(bgp->update_delay_peers_resume_time));for(
ALL_LIST_ELEMENTS(bgp->peer,node,nnode,peer)){if(peer->status!=Established)conti
nue;BGP_TIMER_OFF(peer->t_routeadv);BGP_TIMER_ON(peer->t_routeadv,bgp_routeadv_t
imer,0);}}/***seebgp_fsm.h*/voidbgp_adjust_routeadv(structpeer*peer){time_tnowti
me=bgp_clock();doublediff;unsignedlongremain;/*BypasschecksforspecialcaseofMRAIb
eing0*/if(peer->v_routeadv==0){/*Stopexistingtimer,justincaseitisrunningfora*dif
ferent*durationandschedulewritethreadimmediately.*/if(peer->t_routeadv)BGP_TIMER
_OFF(peer->t_routeadv);peer->synctime=bgp_clock();thread_add_timer_msec(bm->mast
er,bgp_generate_updgrp_packets,peer,0,&peer->t_generate_updgrp_packets);return;}
/**CASEI:*IfthelastupdatewaswrittenmorethanMRAIback,expirethetimer*instantlysoth
atwecansendtheupdateoutsooner.**<-------MRAI--------->*|-----------------|------
-----------------|*<-------------m------------>*^^^*|||*||currenttime*|timerstar
t*lastwrite**m>MRAI*/diff=difftime(nowtime,peer->last_update);if(diff>(double)pe
er->v_routeadv){BGP_TIMER_OFF(peer->t_routeadv);BGP_TIMER_ON(peer->t_routeadv,bg
p_routeadv_timer,0);return;}/**CASEII:*-FindwhentoexpiretheMRAItimer.*IfMRAItime
risnotactive,assumewecanstartitnow.**<-------MRAI--------->*|------------|------
-----------------|*<--------m----------><-----r----->*^^^*|||*||currenttime*|tim
erstart*lastwrite**(MRAI-m)<r*/if(peer->t_routeadv)remain=thread_timer_remain_se
cond(peer->t_routeadv);elseremain=peer->v_routeadv;diff=peer->v_routeadv-diff;if
(diff<=(double)remain){BGP_TIMER_OFF(peer->t_routeadv);BGP_TIMER_ON(peer->t_rout
eadv,bgp_routeadv_timer,diff);}}staticintbgp_maxmed_onstartup_applicable(structb
gp*bgp){if(!bgp->maxmed_onstartup_over)return1;return0;}intbgp_maxmed_onstartup_
configured(structbgp*bgp){if(bgp->v_maxmed_onstartup!=BGP_MAXMED_ONSTARTUP_UNCON
FIGURED)return1;return0;}intbgp_maxmed_onstartup_active(structbgp*bgp){if(bgp->t
_maxmed_onstartup)return1;return0;}voidbgp_maxmed_update(structbgp*bgp){uint8_tm
axmed_active;uint32_tmaxmed_value;if(bgp->v_maxmed_admin){maxmed_active=1;maxmed
_value=bgp->maxmed_admin_value;}elseif(bgp->t_maxmed_onstartup){maxmed_active=1;
maxmed_value=bgp->maxmed_onstartup_value;}else{maxmed_active=0;maxmed_value=BGP_
MAXMED_VALUE_DEFAULT;}if(bgp->maxmed_active!=maxmed_active||bgp->maxmed_value!=m
axmed_value){bgp->maxmed_active=maxmed_active;bgp->maxmed_value=maxmed_value;upd
ate_group_announce(bgp);}}/*Themaxmedonstartuptimerexpirycallback.*/staticintbgp
_maxmed_onstartup_timer(structthread*thread){structbgp*bgp;zlog_info("Maxmedonst
artupended-timerexpired.");bgp=THREAD_ARG(thread);THREAD_TIMER_OFF(bgp->t_maxmed
_onstartup);bgp->maxmed_onstartup_over=1;bgp_maxmed_update(bgp);return0;}staticv
oidbgp_maxmed_onstartup_begin(structbgp*bgp){/*Applicableonlyonceintheprocesslif
etimeonthestartup*/if(bgp->maxmed_onstartup_over)return;zlog_info("Beginmaxmedon
startupmode-timer%dseconds",bgp->v_maxmed_onstartup);thread_add_timer(bm->master
,bgp_maxmed_onstartup_timer,bgp,bgp->v_maxmed_onstartup,&bgp->t_maxmed_onstartup
);if(!bgp->v_maxmed_admin){bgp->maxmed_active=1;bgp->maxmed_value=bgp->maxmed_on
startup_value;}/*Routeannouncetoallpeersshouldhappenafterthisin*bgp_establish()*
/}staticvoidbgp_maxmed_onstartup_process_status_change(structpeer*peer){if(peer-
>status==Established&&!peer->bgp->established){bgp_maxmed_onstartup_begin(peer->
bgp);}}/*Theupdatedelaytimerexpirycallback.*/staticintbgp_update_delay_timer(str
uctthread*thread){structbgp*bgp;zlog_info("Updatedelayended-timerexpired.");bgp=
THREAD_ARG(thread);THREAD_TIMER_OFF(bgp->t_update_delay);bgp_update_delay_end(bg
p);return0;}/*Theestablishwaittimerexpirycallback.*/staticintbgp_establish_wait_
timer(structthread*thread){structbgp*bgp;zlog_info("Establishwait-timerexpired."
);bgp=THREAD_ARG(thread);THREAD_TIMER_OFF(bgp->t_establish_wait);bgp_check_updat
e_delay(bgp);return0;}/*Stepstobegintheupdatedelay:-initializequeuesifneeded-sto
pthequeueprocessing-startthetimer*/staticvoidbgp_update_delay_begin(structbgp*bg
p){structlistnode*node,*nnode;structpeer*peer;/*Stoptheprocessingofqueuedwork.En
queueshallcontinue*/work_queue_plug(bm->process_main_queue);for(ALL_LIST_ELEMENT
S(bgp->peer,node,nnode,peer))peer->update_delay_over=0;/*Starttheupdate-delaytim
er*/thread_add_timer(bm->master,bgp_update_delay_timer,bgp,bgp->v_update_delay,&
bgp->t_update_delay);if(bgp->v_establish_wait!=bgp->v_update_delay)thread_add_ti
mer(bm->master,bgp_establish_wait_timer,bgp,bgp->v_establish_wait,&bgp->t_establ
ish_wait);quagga_timestamp(3,bgp->update_delay_begin_time,sizeof(bgp->update_del
ay_begin_time));}staticvoidbgp_update_delay_process_status_change(structpeer*pee
r){if(peer->status==Established){if(!peer->bgp->established++){bgp_update_delay_
begin(peer->bgp);zlog_info("Beginread-onlymode-update-delaytimer%dseconds",peer-
>bgp->v_update_delay);}if(CHECK_FLAG(peer->cap,PEER_CAP_RESTART_BIT_RCV))bgp_upd
ate_restarted_peers(peer);}if(peer->ostatus==Established&&bgp_update_delay_activ
e(peer->bgp)){/*Adjusttheupdate-delaystatetoaccountforthisflap.NOTE:Intentionall
yskippingadjustingimplicit_eorsorexplicit_eorscounters.Extrasanitycheckinbgp_che
ck_update_delay()shouldbeenoughtotakecareofanyadditivediscrepancyinbgpeorcounter
s*/peer->bgp->established--;peer->update_delay_over=0;}}/*Calledaftereventoccure
d,thisfunctionchangestatusandresetread/writeandtimerthread.*/voidbgp_fsm_change_
status(structpeer*peer,intstatus){bgp_dump_state(peer,peer->status,status);/*Tra
nsitionintoClearingorDeletedmust/always/clearallroutes..*(andmustdosobeforeactua
llychangingintoDeleted..*/if(status>=Clearing){bgp_clear_route_all(peer);/*Ifnor
outewasqueuedfortheclear-nodeprocessing,*generatethe*completioneventhere.Thisisn
eededbecauseifthereareno*routes*totriggerthebackgroundclear-nodethread,theeventw
on't*get*generatedandthepeerwouldbestuckinClearing.Notethat*this*eventisforthepe
erandhelpsthepeertransitionoutof*Clearing*state;itshouldnotbegeneratedper(AFI,SA
FI).Theevent*is*directlypostedherewithoutcallingclear_node_complete()as*we*shoul
dn'tdoanextraunlock.Thiseventwillgetprocessed*after*thestatechangethathappensbel
ow,sopeerwillbein*Clearing*(orDeleted).*/if(!work_queue_is_scheduled(peer->clear
_node_queue))BGP_EVENT_ADD(peer,Clearing_Completed);}/*Preserveoldstatusandchang
eintonewstatus.*/peer->ostatus=peer->status;peer->status=status;/*Saveeventthatc
ausedstatuschange.*/peer->last_major_event=peer->cur_event;if(status==Establishe
d)UNSET_FLAG(peer->sflags,PEER_STATUS_ACCEPT_PEER);/*Ifmax-medprocessingisapplic
able,dothenecessary.*/if(status==Established){if(bgp_maxmed_onstartup_configured
(peer->bgp)&&bgp_maxmed_onstartup_applicable(peer->bgp))bgp_maxmed_onstartup_pro
cess_status_change(peer);elsepeer->bgp->maxmed_onstartup_over=1;}/*Ifupdate-dela
yprocessingisapplicable,dothenecessary.*/if(bgp_update_delay_configured(peer->bg
p)&&bgp_update_delay_applicable(peer->bgp))bgp_update_delay_process_status_chang
e(peer);if(bgp_debug_neighbor_events(peer))zlog_debug("%swentfrom%sto%s",peer->h
ost,lookup_msg(bgp_status_msg,peer->ostatus,NULL),lookup_msg(bgp_status_msg,peer
->status,NULL));}/*Flushtheeventqueueandensurethepeerisshutdown*/staticintbgp_cl
earing_completed(structpeer*peer){intrc=bgp_stop(peer);if(rc>=0)BGP_EVENT_FLUSH(
peer);returnrc;}/*AdministrativeBGPpeerstopevent.*//*Maybecalledmultipletimesfor
thesamepeer*/intbgp_stop(structpeer*peer){afi_tafi;safi_tsafi;charorf_name[BUFSI
Z];intret=0;if(peer_dynamic_neighbor(peer)&&!(CHECK_FLAG(peer->flags,PEER_FLAG_D
ELETE))){if(bgp_debug_neighbor_events(peer))zlog_debug("%s(dynamicneighbor)delet
ed",peer->host);peer_delete(peer);return-1;}/*Can'tdothisinClearing;eventsareuse
dforstatetransitions*/if(peer->status!=Clearing){/*Deleteallexistingeventsofthep
eer*/BGP_EVENT_FLUSH(peer);}/*IncrementDroppedcount.*/if(peer->status==Establish
ed){peer->dropped++;/*bgplog-neighbor-changesofneighborDown*/if(bgp_flag_check(p
eer->bgp,BGP_FLAG_LOG_NEIGHBOR_CHANGES)){structvrf*vrf=vrf_lookup_by_id(peer->bg
p->vrf_id);zlog_info("%%ADJCHANGE:neighbor%s(%s)invrf%sDown%s",peer->host,(peer-
>hostname)?peer->hostname:"Unknown",vrf?((vrf->vrf_id!=VRF_DEFAULT)?vrf->name:"D
efault"):"",peer_down_str[(int)peer->last_reset]);}/*gracefulrestart*/if(peer->t
_gr_stale){BGP_TIMER_OFF(peer->t_gr_stale);if(bgp_debug_neighbor_events(peer))zl
og_debug("%sgracefulrestartstalepathtimerstopped",peer->host);}if(CHECK_FLAG(pee
r->sflags,PEER_STATUS_NSF_WAIT)){if(bgp_debug_neighbor_events(peer)){zlog_debug(
"%sgracefulrestarttimerstartedfor%dsec",peer->host,peer->v_gr_restart);zlog_debu
g("%sgracefulrestartstalepathtimerstartedfor%dsec",peer->host,peer->bgp->stalepa
th_time);}BGP_TIMER_ON(peer->t_gr_restart,bgp_graceful_restart_timer_expire,peer
->v_gr_restart);BGP_TIMER_ON(peer->t_gr_stale,bgp_graceful_stale_timer_expire,pe
er->bgp->stalepath_time);}else{UNSET_FLAG(peer->sflags,PEER_STATUS_NSF_MODE);for
(afi=AFI_IP;afi<AFI_MAX;afi++)for(safi=SAFI_UNICAST;safi<=SAFI_MPLS_VPN;safi++)p
eer->nsf[afi][safi]=0;}/*setlastresettime*/peer->resettime=peer->uptime=bgp_cloc
k();if(BGP_DEBUG(update_groups,UPDATE_GROUPS))zlog_debug("%sremovefromallupdateg
roup",peer->host);update_group_remove_peer_afs(peer);hook_call(peer_backward_tra
nsition,peer);/*Resetpeersynctime*/peer->synctime=0;bgp_bfd_deregister_peer(peer
);}/*stopkeepalives*/bgp_keepalives_off(peer);/*Stopreadandwritethreads.*/bgp_wr
ites_off(peer);bgp_reads_off(peer);THREAD_OFF(peer->t_connect_check_r);THREAD_OF
F(peer->t_connect_check_w);/*Stopalltimers.*/BGP_TIMER_OFF(peer->t_start);BGP_TI
MER_OFF(peer->t_connect);BGP_TIMER_OFF(peer->t_holdtime);BGP_TIMER_OFF(peer->t_r
outeadv);/*Clearinputandoutputbuffer.*/pthread_mutex_lock(&peer->io_mtx);{if(pee
r->ibuf)stream_fifo_clean(peer->ibuf);if(peer->obuf)stream_fifo_clean(peer->obuf
);if(peer->ibuf_work)ringbuf_wipe(peer->ibuf_work);if(peer->obuf_work)stream_res
et(peer->obuf_work);if(peer->curr){stream_free(peer->curr);peer->curr=NULL;}}pth
read_mutex_unlock(&peer->io_mtx);/*Closeoffiledescriptor.*/if(peer->fd>=0){close
(peer->fd);peer->fd=-1;}FOREACH_AFI_SAFI(afi,safi){/*Resetallnegotiatedvariables
*/peer->afc_nego[afi][safi]=0;peer->afc_adv[afi][safi]=0;peer->afc_recv[afi][saf
i]=0;/*peeraddressfamilycapabilityflags*/peer->af_cap[afi][safi]=0;/*peeraddress
familystatusflags*/peer->af_sflags[afi][safi]=0;/*ReceivedORFprefix-filter*/peer
->orf_plist[afi][safi]=NULL;if((peer->status==OpenConfirm)||(peer->status==Estab
lished)){/*ORFreceivedprefix-filterpnt*/sprintf(orf_name,"%s.%d.%d",peer->host,a
fi,safi);prefix_bgp_orf_remove_all(afi,orf_name);}}/*Resetkeepaliveandholdtime*/
if(PEER_OR_GROUP_TIMER_SET(peer)){peer->v_keepalive=peer->keepalive;peer->v_hold
time=peer->holdtime;}else{peer->v_keepalive=peer->bgp->default_keepalive;peer->v
_holdtime=peer->bgp->default_holdtime;}peer->update_time=0;/*Untilwearesurethatt
hereisnoproblemaboutprefixcountthisshouldbecommentedout.*/#if0/*Resetprefixcount
*/peer->pcount[AFI_IP][SAFI_UNICAST]=0;peer->pcount[AFI_IP][SAFI_MULTICAST]=0;pe
er->pcount[AFI_IP][SAFI_LABELED_UNICAST]=0;peer->pcount[AFI_IP][SAFI_MPLS_VPN]=0
;peer->pcount[AFI_IP6][SAFI_UNICAST]=0;peer->pcount[AFI_IP6][SAFI_MULTICAST]=0;p
eer->pcount[AFI_IP6][SAFI_LABELED_UNICAST]=0;#endif/*0*/if(!CHECK_FLAG(peer->fla
gs,PEER_FLAG_CONFIG_NODE)&&!(CHECK_FLAG(peer->flags,PEER_FLAG_DELETE))){peer_del
ete(peer);ret=-1;}else{bgp_peer_conf_if_to_su_update(peer);}returnret;}/*BGPpeer
isstopedbytheerror.*/staticintbgp_stop_with_error(structpeer*peer){/*Doublestart
timer.*/peer->v_start*=2;/*Overflowcheck.*/if(peer->v_start>=(60*2))peer->v_star
t=(60*2);if(peer_dynamic_neighbor(peer)){if(bgp_debug_neighbor_events(peer))zlog
_debug("%s(dynamicneighbor)deleted",peer->host);peer_delete(peer);return-1;}retu
rn(bgp_stop(peer));}/*somethingwentwrong,sendnotifyandteardown*/staticintbgp_sto
p_with_notify(structpeer*peer,uint8_tcode,uint8_tsub_code){/*Sendnotifytoremotep
eer*/bgp_notify_send(peer,code,sub_code);if(peer_dynamic_neighbor(peer)){if(bgp_
debug_neighbor_events(peer))zlog_debug("%s(dynamicneighbor)deleted",peer->host);
peer_delete(peer);return-1;}/*Clearstarttimervaluetodefault.*/peer->v_start=BGP_
INIT_START_TIMER;return(bgp_stop(peer));}/***DetermineswhetheraTCPsessionhassucc
essfullyestablishedforapeerand*eventsasappropriate.**Thisfunctioniscalledwhenset
tingupanewsession.Afterconnect()is*calledonthepeer'ssocket(inbgp_start()),thefdi
spassedtopoll()*towaitforconnectionsuccessorfailure.Whenpoll()returns,this*funct
ioniscalledtoevaluatetheresult.**Duetodifferencesinbehaviorofpoll()onLinuxandBSD
-specifically,*thevalueof.reventsinthecaseofaclosedconnection-thisfunctionis*sch
eduledbothforareadandawriteevent.Thewriteeventistriggered*whentheconnectionisest
ablished.Areadeventistriggeredwhenthe*connectionisclosed.Thusweneedtocancelwhich
everonedidnotoccur.*/staticintbgp_connect_check(structthread*thread){intstatus;s
ocklen_tslen;intret;structpeer*peer;peer=THREAD_ARG(thread);assert(!CHECK_FLAG(p
eer->thread_flags,PEER_THREAD_READS_ON));assert(!CHECK_FLAG(peer->thread_flags,P
EER_THREAD_WRITES_ON));assert(!peer->t_read);assert(!peer->t_write);THREAD_OFF(p
eer->t_connect_check_r);THREAD_OFF(peer->t_connect_check_w);/*Checkfiledescripto
r.*/slen=sizeof(status);ret=getsockopt(peer->fd,SOL_SOCKET,SO_ERROR,(void*)&stat
us,&slen);/*Ifgetsockoptisfail,thisisfatalerror.*/if(ret<0){zlog_info("can'tgets
ockoptfornonblockingconnect");BGP_EVENT_ADD(peer,TCP_fatal_error);return-1;}/*Wh
enstatusis0thenTCPconnectionisestablished.*/if(status==0){BGP_EVENT_ADD(peer,TCP
_connection_open);return1;}else{if(bgp_debug_neighbor_events(peer))zlog_debug("%
s[Event]Connectfailed(%s)",peer->host,safe_strerror(errno));BGP_EVENT_ADD(peer,T
CP_connection_open_failed);return0;}}/*TCPconnectionopen.Nextwesendopenmessageto
remotepeer.Andaddreadthreadforreadingopenmessage.*/staticintbgp_connect_success(
structpeer*peer){if(peer->fd<0){zlog_err("bgp_connect_successpeer'sfdisnegativev
alue%d",peer->fd);bgp_stop(peer);return-1;}if(bgp_getsockname(peer)<0){zlog_err(
"%s:bgp_getsockname():failedforpeer%s,fd%d",__FUNCTION__,peer->host,peer->fd);bg
p_notify_send(peer,BGP_NOTIFY_FSM_ERR,0);/*internalerror*/bgp_writes_on(peer);re
turn-1;}bgp_reads_on(peer);if(bgp_debug_neighbor_events(peer)){charbuf1[SU_ADDRS
TRLEN];if(!CHECK_FLAG(peer->sflags,PEER_STATUS_ACCEPT_PEER))zlog_debug("%sopenac
tive,localaddress%s",peer->host,sockunion2str(peer->su_local,buf1,SU_ADDRSTRLEN)
);elsezlog_debug("%spassiveopen",peer->host);}bgp_open_send(peer);return0;}/*TCP
connectfail*/staticintbgp_connect_fail(structpeer*peer){if(peer_dynamic_neighbor
(peer)){if(bgp_debug_neighbor_events(peer))zlog_debug("%s(dynamicneighbor)delete
d",peer->host);peer_delete(peer);return-1;}return(bgp_stop(peer));}/*Thisfunctio
nisthefirststartingpointofallBGPconnection.Ittrytoconnecttoremotepeerwithnon-blo
ckingIO.*/intbgp_start(structpeer*peer){intstatus;intconnected=0;bgp_peer_conf_i
f_to_su_update(peer);if(peer->su.sa.sa_family==AF_UNSPEC){if(bgp_debug_neighbor_
events(peer))zlog_debug("%s[FSM]Unabletogetneighbor'sIPaddress,waiting...",peer-
>host);return-1;}if(BGP_PEER_START_SUPPRESSED(peer)){if(bgp_debug_neighbor_event
s(peer))zlog_err("%s[FSM]Tryingtostartsuppressedpeer""-thisisneversupposedtohapp
en!",peer->host);return-1;}/*Scrubsomeinformationthatmightbeleftoverfromapreviou
s,*session*//*Connectioninformation.*/if(peer->su_local){sockunion_free(peer->su
_local);peer->su_local=NULL;}if(peer->su_remote){sockunion_free(peer->su_remote)
;peer->su_remote=NULL;}/*Clearremoterouter-id.*/peer->remote_id.s_addr=0;/*Clear
peercapabilityflag.*/peer->cap=0;/*Ifthepeerispassivemode,forcetomovetoActivemod
e.*/if(CHECK_FLAG(peer->flags,PEER_FLAG_PASSIVE)){BGP_EVENT_ADD(peer,TCP_connect
ion_open_failed);return0;}if(peer->bgp->vrf_id==VRF_UNKNOWN){if(bgp_debug_neighb
or_events(peer))zlog_err("%s[FSM]InaVRFthatisnotinitialisedyet",peer->host);retu
rn-1;}/*Registertobenotifiedonpeerup*/if(peer->sort==BGP_PEER_EBGP&&peer->ttl==1
&&!CHECK_FLAG(peer->flags,PEER_FLAG_DISABLE_CONNECTED_CHECK)&&!bgp_flag_check(pe
er->bgp,BGP_FLAG_DISABLE_NH_CONNECTED_CHK))connected=1;elseconnected=0;if(!bgp_f
ind_or_add_nexthop(peer->bgp,family2afi(peer->su.sa.sa_family),NULL,peer,connect
ed)){#ifdefined(HAVE_CUMULUS)if(bgp_debug_neighbor_events(peer))zlog_debug("%s[F
SM]WaitingforNHT",peer->host);BGP_EVENT_ADD(peer,TCP_connection_open_failed);ret
urn0;#endif}assert(!peer->t_write);assert(!peer->t_read);assert(!CHECK_FLAG(peer
->thread_flags,PEER_THREAD_WRITES_ON));assert(!CHECK_FLAG(peer->thread_flags,PEE
R_THREAD_READS_ON));status=bgp_connect(peer);switch(status){caseconnect_error:if
(bgp_debug_neighbor_events(peer))zlog_debug("%s[FSM]Connecterror",peer->host);BG
P_EVENT_ADD(peer,TCP_connection_open_failed);break;caseconnect_success:if(bgp_de
bug_neighbor_events(peer))zlog_debug("%s[FSM]Connectimmediatelysuccess,fd%d",pee
r->host,peer->fd);BGP_EVENT_ADD(peer,TCP_connection_open);break;caseconnect_in_p
rogress:/*Tochecknonblockingconnect,wewaituntilsocketisreadableorwritable.*/if(b
gp_debug_neighbor_events(peer))zlog_debug("%s[FSM]Nonblockingconnectwaitingresul
t,fd%d",peer->host,peer->fd);if(peer->fd<0){zlog_err("bgp_startpeer'sfdisnegativ
evalue%d",peer->fd);return-1;}/**-whenthesocketbecomesready,poll()willsignifyPOL
LOUT*-ifitfailstoconnect,poll()willsignifyPOLLHUP*-POLLHUPishandledasa'read'even
tbythread.c**therefore,weschedulebothareadandawriteeventwith*bgp_connect_check()
asthehandlerforeachandcancelthe*unusedeventinthatfunction.*/thread_add_read(bm->
master,bgp_connect_check,peer,peer->fd,&peer->t_connect_check_r);thread_add_writ
e(bm->master,bgp_connect_check,peer,peer->fd,&peer->t_connect_check_w);break;}re
turn0;}/*ConnectretrytimerisexpiredwhenthepeerstatusisConnect.*/staticintbgp_rec
onnect(structpeer*peer){if(bgp_stop(peer)<0)return-1;bgp_start(peer);return0;}st
aticintbgp_fsm_open(structpeer*peer){/*Sendkeepaliveandmakekeepalivetimer*/bgp_k
eepalive_send(peer);/*Resetholdtimervalue.*/BGP_TIMER_OFF(peer->t_holdtime);retu
rn0;}/*FSMerror,unexpectedevent.ThisiserrorofBGPconnection.Socutthepeerandchange
toIdlestatus.*/staticintbgp_fsm_event_error(structpeer*peer){zlog_err("%s[FSM]un
expectedpacketreceivedinstate%s",peer->host,lookup_msg(bgp_status_msg,peer->stat
us,NULL));returnbgp_stop_with_notify(peer,BGP_NOTIFY_FSM_ERR,0);}/*Holdtimerexpi
re.ThisiserrorofBGPconnection.SocutthepeerandchangetoIdlestatus.*/staticintbgp_f
sm_holdtime_expire(structpeer*peer){if(bgp_debug_neighbor_events(peer))zlog_debu
g("%s[FSM]Holdtimerexpire",peer->host);returnbgp_stop_with_notify(peer,BGP_NOTIF
Y_HOLD_ERR,0);}/***TransitiontoEstablishedstate.**Convertpeerfromstubtofullfledg
edpeer,setsometimers,andgenerate*initialupdates.*/staticintbgp_establish(structp
eer*peer){afi_tafi;safi_tsafi;intnsf_af_count=0;intret=0;structpeer*other;other=
peer->doppelganger;peer=peer_xfer_conn(peer);if(!peer){zlog_err("%%Neighborfaile
dinxfer_conn");return-1;}if(other==peer)ret=1;/*bgp_establishspecificcodewhenxfe
r_connhappens.*//*Resetcapabilityopenstatusflag.*/if(!CHECK_FLAG(peer->sflags,PE
ER_STATUS_CAPABILITY_OPEN))SET_FLAG(peer->sflags,PEER_STATUS_CAPABILITY_OPEN);/*
Clearstarttimervaluetodefault.*/peer->v_start=BGP_INIT_START_TIMER;/*Incrementes
tablishedcount.*/peer->established++;bgp_fsm_change_status(peer,Established);/*b
gplog-neighbor-changesofneighborUp*/if(bgp_flag_check(peer->bgp,BGP_FLAG_LOG_NEI
GHBOR_CHANGES)){structvrf*vrf=vrf_lookup_by_id(peer->bgp->vrf_id);zlog_info("%%A
DJCHANGE:neighbor%s(%s)invrf%sUp",peer->host,(peer->hostname)?peer->hostname:"Un
known",vrf?((vrf->vrf_id!=VRF_DEFAULT)?vrf->name:"Default"):"");}/*assignupdate-
group/subgroup*/update_group_adjust_peer_afs(peer);/*gracefulrestart*/UNSET_FLAG
(peer->sflags,PEER_STATUS_NSF_WAIT);for(afi=AFI_IP;afi<AFI_MAX;afi++)for(safi=SA
FI_UNICAST;safi<=SAFI_MPLS_VPN;safi++){if(peer->afc_nego[afi][safi]&&CHECK_FLAG(
peer->cap,PEER_CAP_RESTART_ADV)&&CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_RES
TART_AF_RCV)){if(peer->nsf[afi][safi]&&!CHECK_FLAG(peer->af_cap[afi][safi],PEER_
CAP_RESTART_AF_PRESERVE_RCV))bgp_clear_stale_route(peer,afi,safi);peer->nsf[afi]
[safi]=1;nsf_af_count++;}else{if(peer->nsf[afi][safi])bgp_clear_stale_route(peer
,afi,safi);peer->nsf[afi][safi]=0;}}if(nsf_af_count)SET_FLAG(peer->sflags,PEER_S
TATUS_NSF_MODE);else{UNSET_FLAG(peer->sflags,PEER_STATUS_NSF_MODE);if(peer->t_gr
_stale){BGP_TIMER_OFF(peer->t_gr_stale);if(bgp_debug_neighbor_events(peer))zlog_
debug("%sgracefulrestartstalepathtimerstopped",peer->host);}}if(peer->t_gr_resta
rt){BGP_TIMER_OFF(peer->t_gr_restart);if(bgp_debug_neighbor_events(peer))zlog_de
bug("%sgracefulrestarttimerstopped",peer->host);}hook_call(peer_established,peer
);/*Resetuptime,turnonkeepalives,sendcurrenttable.*/if(!peer->v_holdtime)bgp_kee
palives_on(peer);peer->uptime=bgp_clock();/*Sendroute-refreshwhenORFisenabled*/F
OREACH_AFI_SAFI(afi,safi){if(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PRE
FIX_SM_ADV)){if(CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_RCV))b
gp_route_refresh_send(peer,afi,safi,ORF_TYPE_PREFIX,REFRESH_IMMEDIATE,0);elseif(
CHECK_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_OLD_RCV))bgp_route_ref
resh_send(peer,afi,safi,ORF_TYPE_PREFIX_OLD,REFRESH_IMMEDIATE,0);}}/*Firstupdate
isdeferreduntilORForROUTE-REFRESHisreceived*/FOREACH_AFI_SAFI(afi,safi){if(CHECK
_FLAG(peer->af_cap[afi][safi],PEER_CAP_ORF_PREFIX_RM_ADV))if(CHECK_FLAG(peer->af
_cap[afi][safi],PEER_CAP_ORF_PREFIX_SM_RCV)||CHECK_FLAG(peer->af_cap[afi][safi],
PEER_CAP_ORF_PREFIX_SM_OLD_RCV))SET_FLAG(peer->af_sflags[afi][safi],PEER_STATUS_
ORF_WAIT_REFRESH);}bgp_announce_peer(peer);/*Starttherouteadvertisementtimertose
ndupdatestothepeer-if*BGP*isnotinread-onlymode.Ifitis,thetimerwillbestartedatthe
*end*ofread-onlymode.*/if(!bgp_update_delay_active(peer->bgp)){BGP_TIMER_OFF(pee
r->t_routeadv);BGP_TIMER_ON(peer->t_routeadv,bgp_routeadv_timer,0);}if(peer->dop
pelganger&&(peer->doppelganger->status!=Deleted)){if(bgp_debug_neighbor_events(p
eer))zlog_debug("[Event]Deletingstubconnectionforpeer%s",peer->host);if(peer->do
ppelganger->status>Active)bgp_notify_send(peer->doppelganger,BGP_NOTIFY_CEASE,BG
P_NOTIFY_CEASE_COLLISION_RESOLUTION);elsepeer_delete(peer->doppelganger);}bgp_bf
d_register_peer(peer);returnret;}/*Keepalivepacketisreceived.*/staticintbgp_fsm_
keepalive(structpeer*peer){BGP_TIMER_OFF(peer->t_holdtime);return0;}/*Updatepack
etisreceived.*/staticintbgp_fsm_update(structpeer*peer){BGP_TIMER_OFF(peer->t_ho
ldtime);return0;}/*Thisisemptyevent.*/staticintbgp_ignore(structpeer*peer){zlog_
err("%s[FSM]Ignoringevent%sinstate%s,priorevents%s,%s,fd%d",peer->host,bgp_event
_str[peer->cur_event],lookup_msg(bgp_status_msg,peer->status,NULL),bgp_event_str
[peer->last_event],bgp_event_str[peer->last_major_event],peer->fd);return0;}/*Th
isistohandleunexpectedevents..*/staticintbgp_fsm_exeption(structpeer*peer){zlog_
err("%s[FSM]Unexpectedevent%sinstate%s,priorevents%s,%s,fd%d",peer->host,bgp_eve
nt_str[peer->cur_event],lookup_msg(bgp_status_msg,peer->status,NULL),bgp_event_s
tr[peer->last_event],bgp_event_str[peer->last_major_event],peer->fd);return(bgp_
stop(peer));}voidbgp_fsm_nht_update(structpeer*peer,intvalid){if(!peer)return;sw
itch(peer->status){caseIdle:if(valid)BGP_EVENT_ADD(peer,BGP_Start);break;caseCon
nect:if(!valid){BGP_TIMER_OFF(peer->t_connect);BGP_EVENT_ADD(peer,TCP_fatal_erro
r);}break;caseActive:if(valid){BGP_TIMER_OFF(peer->t_connect);BGP_EVENT_ADD(peer
,ConnectRetry_timer_expired);}break;caseOpenSent:caseOpenConfirm:caseEstablished
:if(!valid&&(peer->gtsm_hops==1))BGP_EVENT_ADD(peer,TCP_fatal_error);caseClearin
g:caseDeleted:default:break;}}/*FiniteStateMachinestructure*/staticconststruct{i
nt(*func)(structpeer*);intnext_state;}FSM[BGP_STATUS_MAX-1][BGP_EVENTS_MAX-1]={{
/*Idlestate:InIdlestate,alleventsotherthanBGP_Startisignored.WithBGP_Startevent,
finitestatemachinecallsbgp_start().*/{bgp_start,Connect},/*BGP_Start*/{bgp_stop,
Idle},/*BGP_Stop*/{bgp_stop,Idle},/*TCP_connection_open*/{bgp_stop,Idle},/*TCP_c
onnection_closed*/{bgp_ignore,Idle},/*TCP_connection_open_failed*/{bgp_stop,Idle
},/*TCP_fatal_error*/{bgp_ignore,Idle},/*ConnectRetry_timer_expired*/{bgp_ignore
,Idle},/*Hold_Timer_expired*/{bgp_ignore,Idle},/*KeepAlive_timer_expired*/{bgp_i
gnore,Idle},/*Receive_OPEN_message*/{bgp_ignore,Idle},/*Receive_KEEPALIVE_messag
e*/{bgp_ignore,Idle},/*Receive_UPDATE_message*/{bgp_ignore,Idle},/*Receive_NOTIF
ICATION_message*/{bgp_ignore,Idle},/*Clearing_Completed*/},{/*Connect*/{bgp_igno
re,Connect},/*BGP_Start*/{bgp_stop,Idle},/*BGP_Stop*/{bgp_connect_success,OpenSe
nt},/*TCP_connection_open*/{bgp_stop,Idle},/*TCP_connection_closed*/{bgp_connect
_fail,Active},/*TCP_connection_open_failed*/{bgp_connect_fail,Idle},/*TCP_fatal_
error*/{bgp_reconnect,Connect},/*ConnectRetry_timer_expired*/{bgp_fsm_exeption,I
dle},/*Hold_Timer_expired*/{bgp_fsm_exeption,Idle},/*KeepAlive_timer_expired*/{b
gp_fsm_exeption,Idle},/*Receive_OPEN_message*/{bgp_fsm_exeption,Idle},/*Receive_
KEEPALIVE_message*/{bgp_fsm_exeption,Idle},/*Receive_UPDATE_message*/{bgp_stop,I
dle},/*Receive_NOTIFICATION_message*/{bgp_fsm_exeption,Idle},/*Clearing_Complete
d*/},{/*Active,*/{bgp_ignore,Active},/*BGP_Start*/{bgp_stop,Idle},/*BGP_Stop*/{b
gp_connect_success,OpenSent},/*TCP_connection_open*/{bgp_stop,Idle},/*TCP_connec
tion_closed*/{bgp_ignore,Active},/*TCP_connection_open_failed*/{bgp_fsm_exeption
,Idle},/*TCP_fatal_error*/{bgp_start,Connect},/*ConnectRetry_timer_expired*/{bgp
_fsm_exeption,Idle},/*Hold_Timer_expired*/{bgp_fsm_exeption,Idle},/*KeepAlive_ti
mer_expired*/{bgp_fsm_exeption,Idle},/*Receive_OPEN_message*/{bgp_fsm_exeption,I
dle},/*Receive_KEEPALIVE_message*/{bgp_fsm_exeption,Idle},/*Receive_UPDATE_messa
ge*/{bgp_fsm_exeption,Idle},/*Receive_NOTIFICATION_message*/{bgp_fsm_exeption,Id
le},/*Clearing_Completed*/},{/*OpenSent,*/{bgp_ignore,OpenSent},/*BGP_Start*/{bg
p_stop,Idle},/*BGP_Stop*/{bgp_stop,Active},/*TCP_connection_open*/{bgp_stop,Acti
ve},/*TCP_connection_closed*/{bgp_stop,Active},/*TCP_connection_open_failed*/{bg
p_stop,Active},/*TCP_fatal_error*/{bgp_fsm_exeption,Idle},/*ConnectRetry_timer_e
xpired*/{bgp_fsm_holdtime_expire,Idle},/*Hold_Timer_expired*/{bgp_fsm_exeption,I
dle},/*KeepAlive_timer_expired*/{bgp_fsm_open,OpenConfirm},/*Receive_OPEN_messag
e*/{bgp_fsm_event_error,Idle},/*Receive_KEEPALIVE_message*/{bgp_fsm_event_error,
Idle},/*Receive_UPDATE_message*/{bgp_stop_with_error,Idle},/*Receive_NOTIFICATIO
N_message*/{bgp_fsm_exeption,Idle},/*Clearing_Completed*/},{/*OpenConfirm,*/{bgp
_ignore,OpenConfirm},/*BGP_Start*/{bgp_stop,Idle},/*BGP_Stop*/{bgp_stop,Idle},/*
TCP_connection_open*/{bgp_stop,Idle},/*TCP_connection_closed*/{bgp_stop,Idle},/*
TCP_connection_open_failed*/{bgp_stop,Idle},/*TCP_fatal_error*/{bgp_fsm_exeption
,Idle},/*ConnectRetry_timer_expired*/{bgp_fsm_holdtime_expire,Idle},/*Hold_Timer
_expired*/{bgp_ignore,OpenConfirm},/*KeepAlive_timer_expired*/{bgp_fsm_exeption,
Idle},/*Receive_OPEN_message*/{bgp_establish,Established},/*Receive_KEEPALIVE_me
ssage*/{bgp_fsm_exeption,Idle},/*Receive_UPDATE_message*/{bgp_stop_with_error,Id
le},/*Receive_NOTIFICATION_message*/{bgp_fsm_exeption,Idle},/*Clearing_Completed
*/},{/*Established,*/{bgp_ignore,Established},/*BGP_Start*/{bgp_stop,Clearing},/
*BGP_Stop*/{bgp_stop,Clearing},/*TCP_connection_open*/{bgp_stop,Clearing},/*TCP_
connection_closed*/{bgp_stop,Clearing},/*TCP_connection_open_failed*/{bgp_stop,C
learing},/*TCP_fatal_error*/{bgp_stop,Clearing},/*ConnectRetry_timer_expired*/{b
gp_fsm_holdtime_expire,Clearing},/*Hold_Timer_expired*/{bgp_ignore,Established},
/*KeepAlive_timer_expired*/{bgp_stop,Clearing},/*Receive_OPEN_message*/{bgp_fsm_
keepalive,Established},/*Receive_KEEPALIVE_message*/{bgp_fsm_update,Established}
,/*Receive_UPDATE_message*/{bgp_stop_with_error,Clearing},/*Receive_NOTIFICATION
_message*/{bgp_fsm_exeption,Idle},/*Clearing_Completed*/},{/*Clearing,*/{bgp_ign
ore,Clearing},/*BGP_Start*/{bgp_stop,Clearing},/*BGP_Stop*/{bgp_stop,Clearing},/
*TCP_connection_open*/{bgp_stop,Clearing},/*TCP_connection_closed*/{bgp_stop,Cle
aring},/*TCP_connection_open_failed*/{bgp_stop,Clearing},/*TCP_fatal_error*/{bgp
_stop,Clearing},/*ConnectRetry_timer_expired*/{bgp_stop,Clearing},/*Hold_Timer_e
xpired*/{bgp_stop,Clearing},/*KeepAlive_timer_expired*/{bgp_stop,Clearing},/*Rec
eive_OPEN_message*/{bgp_stop,Clearing},/*Receive_KEEPALIVE_message*/{bgp_stop,Cl
earing},/*Receive_UPDATE_message*/{bgp_stop,Clearing},/*Receive_NOTIFICATION_mes
sage*/{bgp_clearing_completed,Idle},/*Clearing_Completed*/},{/*Deleted,*/{bgp_ig
nore,Deleted},/*BGP_Start*/{bgp_ignore,Deleted},/*BGP_Stop*/{bgp_ignore,Deleted}
,/*TCP_connection_open*/{bgp_ignore,Deleted},/*TCP_connection_closed*/{bgp_ignor
e,Deleted},/*TCP_connection_open_failed*/{bgp_ignore,Deleted},/*TCP_fatal_error*
/{bgp_ignore,Deleted},/*ConnectRetry_timer_expired*/{bgp_ignore,Deleted},/*Hold_
Timer_expired*/{bgp_ignore,Deleted},/*KeepAlive_timer_expired*/{bgp_ignore,Delet
ed},/*Receive_OPEN_message*/{bgp_ignore,Deleted},/*Receive_KEEPALIVE_message*/{b
gp_ignore,Deleted},/*Receive_UPDATE_message*/{bgp_ignore,Deleted},/*Receive_NOTI
FICATION_message*/{bgp_ignore,Deleted},/*Clearing_Completed*/},};/*Executeeventp
rocess.*/intbgp_event(structthread*thread){intevent;structpeer*peer;intret;peer=
THREAD_ARG(thread);event=THREAD_VAL(thread);ret=bgp_event_update(peer,event);ret
urn(ret);}intbgp_event_update(structpeer*peer,intevent){intnext;intret=0;structp
eer*other;intpassive_conn=0;intdyn_nbr;/*defaultreturncode*/ret=FSM_PEER_NOOP;ot
her=peer->doppelganger;passive_conn=(CHECK_FLAG(peer->sflags,PEER_STATUS_ACCEPT_
PEER))?1:0;dyn_nbr=peer_dynamic_neighbor(peer);/*Loggingthisevent.*/next=FSM[pee
r->status-1][event-1].next_state;if(bgp_debug_neighbor_events(peer)&&peer->statu
s!=next)zlog_debug("%s[FSM]%s(%s->%s),fd%d",peer->host,bgp_event_str[event],look
up_msg(bgp_status_msg,peer->status,NULL),lookup_msg(bgp_status_msg,next,NULL),pe
er->fd);peer->last_event=peer->cur_event;peer->cur_event=event;/*Callfunction.*/
if(FSM[peer->status-1][event-1].func)ret=(*(FSM[peer->status-1][event-1].func))(
peer);if(ret>=0){if(ret==1&&next==Established){/*Thecasewhendoppelgangerswapaccu
rredinbgp_establish.Updatethepeerpointeraccordingly*/ret=FSM_PEER_TRANSFERRED;pe
er=other;}/*Ifstatusischanged.*/if(next!=peer->status){bgp_fsm_change_status(pee
r,next);/**Ifwe'regoingtoESTABLISHEDthenweexecuteda*peertransfer.Inthiscasewecan
eitherreturn*FSM_PEER_TRANSITIONEDorFSM_PEER_TRANSFERRED.*OptingforTRANSFERREDsi
ncetransferimplies*sessionestablishment.*/if(ret!=FSM_PEER_TRANSFERRED)ret=FSM_P
EER_TRANSITIONED;}/*Makesuretimerisset.*/bgp_timer_set(peer);}else{/**Ifwegotare
turnvalueof-1,thatmeanstherewasan*error,restarttheFSM.Sincebgp_stop()wascalledon
the*peer.onlyafewfieldsaresafetoaccesshere.Inanycase*weneedtoindicatethatthepeer
wasstoppedinthereturn*code.*/if(!dyn_nbr&&!passive_conn&&peer->bgp){zlog_err("%s
[FSM]Failurehandlingevent%sinstate%s,""priorevents%s,%s,fd%d",peer->host,bgp_eve
nt_str[peer->cur_event],lookup_msg(bgp_status_msg,peer->status,NULL),bgp_event_s
tr[peer->last_event],bgp_event_str[peer->last_major_event],peer->fd);bgp_stop(pe
er);bgp_fsm_change_status(peer,Idle);bgp_timer_set(peer);}ret=FSM_PEER_STOPPED;}
returnret;}