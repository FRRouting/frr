/**IPMSDPforQuagga*Copyright(C)2016CumulusNetworks,Inc.**Thisprogramisfreesoftwa
re;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicensea
spublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouropti
on)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WIT
HOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPART
ICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceiv
edacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot
,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1
301USA*/#include<zebra.h>#include<lib/hash.h>#include<lib/jhash.h>#include<lib/l
og.h>#include<lib/prefix.h>#include<lib/sockunion.h>#include<lib/stream.h>#inclu
de<lib/thread.h>#include<lib/vty.h>#include<lib/plist.h>#include"pimd.h"#include
"pim_cmd.h"#include"pim_memory.h"#include"pim_iface.h"#include"pim_rp.h"#include
"pim_str.h"#include"pim_time.h"#include"pim_upstream.h"#include"pim_oil.h"#inclu
de"pim_msdp.h"#include"pim_msdp_packet.h"#include"pim_msdp_socket.h"//structpim_
msdppim_msdp,*msdp=&pim_msdp;staticvoidpim_msdp_peer_listen(structpim_msdp_peer*
mp);staticvoidpim_msdp_peer_cr_timer_setup(structpim_msdp_peer*mp,boolstart);sta
ticvoidpim_msdp_peer_ka_timer_setup(structpim_msdp_peer*mp,boolstart);staticvoid
pim_msdp_peer_hold_timer_setup(structpim_msdp_peer*mp,boolstart);staticvoidpim_m
sdp_peer_free(structpim_msdp_peer*mp);staticvoidpim_msdp_enable(structpim_instan
ce*pim);staticvoidpim_msdp_sa_adv_timer_setup(structpim_instance*pim,boolstart);
staticvoidpim_msdp_sa_deref(structpim_msdp_sa*sa,enumpim_msdp_sa_flagsflags);sta
ticintpim_msdp_mg_mbr_comp(constvoid*p1,constvoid*p2);staticvoidpim_msdp_mg_mbr_
free(structpim_msdp_mg_mbr*mbr);staticvoidpim_msdp_mg_mbr_do_del(structpim_msdp_
mg*mg,structpim_msdp_mg_mbr*mbr);/************************SAcachemanagement*****
*************************/staticvoidpim_msdp_sa_timer_expiry_log(structpim_msdp_
sa*sa,constchar*timer_str){zlog_debug("MSDPSA%s%stimerexpired",sa->sg_str,timer_
str);}/*RFC-3618:Sec-5.1-globalactivesourceadvertisementtimer*/staticintpim_msdp
_sa_adv_timer_cb(structthread*t){structpim_instance*pim=THREAD_ARG(t);if(PIM_DEB
UG_MSDP_EVENTS){zlog_debug("MSDPSAadvertismenttimerexpired");}pim_msdp_sa_adv_ti
mer_setup(pim,true/*start*/);pim_msdp_pkt_sa_tx(pim);return0;}staticvoidpim_msdp
_sa_adv_timer_setup(structpim_instance*pim,boolstart){THREAD_OFF(pim->msdp.sa_ad
v_timer);if(start){thread_add_timer(pim->msdp.master,pim_msdp_sa_adv_timer_cb,pi
m,PIM_MSDP_SA_ADVERTISMENT_TIME,&pim->msdp.sa_adv_timer);}}/*RFC-3618:Sec-5.3-SA
cachestatetimer*/staticintpim_msdp_sa_state_timer_cb(structthread*t){structpim_m
sdp_sa*sa;sa=THREAD_ARG(t);if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_sa_timer_expiry_lo
g(sa,"state");}pim_msdp_sa_deref(sa,PIM_MSDP_SAF_PEER);return0;}staticvoidpim_ms
dp_sa_state_timer_setup(structpim_msdp_sa*sa,boolstart){THREAD_OFF(sa->sa_state_
timer);if(start){thread_add_timer(sa->pim->msdp.master,pim_msdp_sa_state_timer_c
b,sa,PIM_MSDP_SA_HOLD_TIME,&sa->sa_state_timer);}}staticvoidpim_msdp_sa_upstream
_del(structpim_msdp_sa*sa){structpim_upstream*up=sa->up;if(!up){return;}sa->up=N
ULL;if(PIM_UPSTREAM_FLAG_TEST_SRC_MSDP(up->flags)){PIM_UPSTREAM_FLAG_UNSET_SRC_M
SDP(up->flags);sa->flags|=PIM_MSDP_SAF_UP_DEL_IN_PROG;pim_upstream_del(sa->pim,u
p,__PRETTY_FUNCTION__);sa->flags&=~PIM_MSDP_SAF_UP_DEL_IN_PROG;}if(PIM_DEBUG_MSD
P_EVENTS){zlog_debug("MSDPSA%sde-referencedSPT",sa->sg_str);}}staticboolpim_msdp
_sa_upstream_add_ok(structpim_msdp_sa*sa,structpim_upstream*xg_up){if(!(sa->flag
s&PIM_MSDP_SAF_PEER)){/*SAshouldhavebeenrxedfromapeer*/returnfalse;}/*checkifwea
reRP*/if(!I_am_RP(sa->pim,sa->sg.grp)){returnfalse;}/*checkifwehavea(*,G)withano
n-emptyimmediateOIL*/if(!xg_up){structprefix_sgsg;memset(&sg,0,sizeof(sg));sg.gr
p=sa->sg.grp;xg_up=pim_upstream_find(sa->pim,&sg);}if(!xg_up||(xg_up->join_state
!=PIM_UPSTREAM_JOINED)){/*joindesiredwillbetrueforsuch(*,G)entriessowewill*justl
ookatjoin_stateandletthePIMstatemachinedothe*restof*themagic*/returnfalse;}retur
ntrue;}/*Upstreamaddevaluationneedstohappeneverytime-*1.Peerreferenceisaddedorre
moved.*2.TheRPforagroupchanges.*3.joinDesiredfortheassociated(*,G)changes*4.asso
ciated(*,G)isremoved-thisseemslikeabitredundant*(considering#4);butjustincaseane
ntrygetsnukedwithout*upstreamstatetransition**/staticvoidpim_msdp_sa_upstream_up
date(structpim_msdp_sa*sa,structpim_upstream*xg_up,constchar*ctx){structpim_upst
ream*up;if(!pim_msdp_sa_upstream_add_ok(sa,xg_up)){pim_msdp_sa_upstream_del(sa);
return;}if(sa->up){/*nothingtodo*/return;}up=pim_upstream_find(sa->pim,&sa->sg);
if(up&&(PIM_UPSTREAM_FLAG_TEST_SRC_MSDP(up->flags))){/*somehowwelosttrackoftheup
streamptr?bestlogit*/sa->up=up;if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%sSPT
referencemissing",sa->sg_str);}return;}/*RFC3618:"RPtriggersa(S,G)joineventtowar
dsthedatasource*asifaJPmessagewasrxedaddressedtotheRPitself."*/up=pim_upstream_a
dd(sa->pim,&sa->sg,NULL/*iif*/,PIM_UPSTREAM_FLAG_MASK_SRC_MSDP,__PRETTY_FUNCTION
__,NULL);sa->up=up;if(up){/*updateinheritedoil*/pim_upstream_inherited_olist(sa-
>pim,up);/*shouldwealsostartthekatinparallel?wewillneedit*whenthe*SAagesout*/if(
PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%sreferencedSPT",sa->sg_str);}}else{if(
PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%sSPTreferencefailed",sa->sg_str);}}}/*
releaseallmemassociatedwithasa*/staticvoidpim_msdp_sa_free(structpim_msdp_sa*sa)
{XFREE(MTYPE_PIM_MSDP_SA,sa);}staticstructpim_msdp_sa*pim_msdp_sa_new(structpim_
instance*pim,structprefix_sg*sg,structin_addrrp){structpim_msdp_sa*sa;sa=XCALLOC
(MTYPE_PIM_MSDP_SA,sizeof(*sa));if(!sa){zlog_err("%s:PIMXCALLOC(%zu)failure",__P
RETTY_FUNCTION__,sizeof(*sa));returnNULL;}sa->pim=pim;sa->sg=*sg;pim_str_sg_set(
sg,sa->sg_str);sa->rp=rp;sa->uptime=pim_time_monotonic_sec();/*insertintomisctab
lesforeasyaccess*/sa=hash_get(pim->msdp.sa_hash,sa,hash_alloc_intern);if(!sa){zl
og_err("%s:PIMhashgetfailure",__PRETTY_FUNCTION__);pim_msdp_sa_free(sa);returnNU
LL;}listnode_add_sort(pim->msdp.sa_list,sa);if(PIM_DEBUG_MSDP_EVENTS){zlog_debug
("MSDPSA%screated",sa->sg_str);}returnsa;}staticstructpim_msdp_sa*pim_msdp_sa_fi
nd(structpim_instance*pim,structprefix_sg*sg){structpim_msdp_salookup;lookup.sg=
*sg;returnhash_lookup(pim->msdp.sa_hash,&lookup);}staticstructpim_msdp_sa*pim_ms
dp_sa_add(structpim_instance*pim,structprefix_sg*sg,structin_addrrp){structpim_m
sdp_sa*sa;sa=pim_msdp_sa_find(pim,sg);if(sa){returnsa;}returnpim_msdp_sa_new(pim
,sg,rp);}staticvoidpim_msdp_sa_del(structpim_msdp_sa*sa){/*thisissomewhatredunda
nt-stillwanttobecarefulnottoleave*staleupstreamreferences*/pim_msdp_sa_upstream_
del(sa);/*stoptimers*/pim_msdp_sa_state_timer_setup(sa,false/*start*/);/*removet
heentryfromvarioustables*/listnode_delete(sa->pim->msdp.sa_list,sa);hash_release
(sa->pim->msdp.sa_hash,sa);if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%sdeleted
",sa->sg_str);}/*freeupanyassociatedmemory*/pim_msdp_sa_free(sa);}staticvoidpim_
msdp_sa_peer_ip_set(structpim_msdp_sa*sa,structpim_msdp_peer*mp,structin_addrrp)
{structpim_msdp_peer*old_mp;/*optimizethe"nochange"caseasitwillhappen*frequently
/periodically*/if(mp&&(sa->peer.s_addr==mp->peer.s_addr)){return;}/*anytimethepe
eripchangesalsoupdatetherpaddress*/if(PIM_INADDR_ISNOT_ANY(sa->peer)){old_mp=pim
_msdp_peer_find(sa->pim,sa->peer);if(old_mp&&old_mp->sa_cnt){--old_mp->sa_cnt;}}
if(mp){++mp->sa_cnt;sa->peer=mp->peer;}else{sa->peer.s_addr=PIM_NET_INADDR_ANY;}
sa->rp=rp;}/*Whenalocalactive-sourceisremovedthereisnowaytowithdrawthe*sourcefro
mpeers.WewillsimplyremoveitfromtheSAcachesoitwill*notbesentinsupsequentSAupdates
.Peerswillconsequentlytimeoutthe*SA.*Similarlya"peer-added"SAisneverexplicitlyde
leted.Itissimply*agedoutovertimeifnotseenintheSAupdatesfromthepeers.*XXX:shouldw
eprovideaknobtodropentrieslearntfromapeerwhenthe*peergoesdown?*/staticvoidpim_ms
dp_sa_deref(structpim_msdp_sa*sa,enumpim_msdp_sa_flagsflags){boolupdate_up=false
;if((sa->flags&PIM_MSDP_SAF_LOCAL)){if(flags&PIM_MSDP_SAF_LOCAL){if(PIM_DEBUG_MS
DP_EVENTS){zlog_debug("MSDPSA%slocalreferenceremoved",sa->sg_str);}if(sa->pim->m
sdp.local_cnt)--sa->pim->msdp.local_cnt;}}if((sa->flags&PIM_MSDP_SAF_PEER)){if(f
lags&PIM_MSDP_SAF_PEER){structin_addrrp;if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MS
DPSA%speerreferenceremoved",sa->sg_str);}pim_msdp_sa_state_timer_setup(sa,false/
*start*/);rp.s_addr=INADDR_ANY;pim_msdp_sa_peer_ip_set(sa,NULL/*mp*/,rp);/*ifpee
rrefwasremovedweneedtoremovethemsdp*referenceonthe*msdpentry*/update_up=true;}}s
a->flags&=~flags;if(update_up){pim_msdp_sa_upstream_update(sa,NULL/*xg_up*/,"sa-
deref");}if(!(sa->flags&PIM_MSDP_SAF_REF)){pim_msdp_sa_del(sa);}}voidpim_msdp_sa
_ref(structpim_instance*pim,structpim_msdp_peer*mp,structprefix_sg*sg,structin_a
ddrrp){structpim_msdp_sa*sa;sa=pim_msdp_sa_add(pim,sg,rp);if(!sa){return;}/*refe
renceit*/if(mp){if(!(sa->flags&PIM_MSDP_SAF_PEER)){sa->flags|=PIM_MSDP_SAF_PEER;
if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%saddedbypeer",sa->sg_str);}}pim_msd
p_sa_peer_ip_set(sa,mp,rp);/*start/re-startthestatetimertopreventcacheexpiry*/pi
m_msdp_sa_state_timer_setup(sa,true/*start*/);/*Were-evaluateSA"SPT-trigger"ever
ytimewehearabtitfrom*a*peer.XXX:Ifthisbecomestoomuchofaperiodicoverheadwe*canmak
eiteventbased*/pim_msdp_sa_upstream_update(sa,NULL/*xg_up*/,"peer-ref");}else{if
(!(sa->flags&PIM_MSDP_SAF_LOCAL)){sa->flags|=PIM_MSDP_SAF_LOCAL;++sa->pim->msdp.
local_cnt;if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPSA%saddedlocally",sa->sg_str
);}/*sendanimmediateSAupdatetopeers*/pim_msdp_pkt_sa_tx_one(sa);}sa->flags&=~PIM
_MSDP_SAF_STALE;}}/*ThefollowingcriteriamustbemettooriginateanSAfromtheMSDP*spea
ker-*1.KATmustberunningi.e.sourceisactive.*2.WemustbeRPforthegroup.*3.Sourcemust
beregistrabletotheRP(thisiswheretheRFCisvague*andespeciallyambiguousinCLOSnetwor
ks;withanycastRPallsources*arepotentiallyregistrabletoallRPsinthedomain).Weassum
e#3is*satisfiedif-*a.WearealsotheFHR-DRforthesource(OR)*b.Werxedapimregister(nul
lordataencapsulated)withinthelast*(3*(1.5*register_suppression_timer))).*/static
boolpim_msdp_sa_local_add_ok(structpim_upstream*up){structpim_instance*pim=up->c
hannel_oil->pim;if(!(pim->msdp.flags&PIM_MSDPF_ENABLE)){returnfalse;}if(!up->t_k
a_timer){/*streamisnotactive*/returnfalse;}if(!I_am_RP(pim,up->sg.grp)){/*wearen
otRPforthegroup*/returnfalse;}/*wearetheFHR-DRforthisstreamorweareRPandhaveseen*
registers*fromaFHRforthissource*/if(PIM_UPSTREAM_FLAG_TEST_FHR(up->flags)||up->t
_msdp_reg_timer){returntrue;}returnfalse;}staticvoidpim_msdp_sa_local_add(struct
pim_instance*pim,structprefix_sg*sg){structin_addrrp;rp.s_addr=0;pim_msdp_sa_ref
(pim,NULL/*mp*/,sg,rp);}voidpim_msdp_sa_local_del(structpim_instance*pim,structp
refix_sg*sg){structpim_msdp_sa*sa;sa=pim_msdp_sa_find(pim,sg);if(sa){pim_msdp_sa
_deref(sa,PIM_MSDP_SAF_LOCAL);}}/*weneedtobeverycautiouswiththisAPIasSAdeltoocan
triggeran*upstreamdelandwewillgetstuckinasimpleloop*/staticvoidpim_msdp_sa_local
_del_on_up_del(structpim_instance*pim,structprefix_sg*sg){structpim_msdp_sa*sa;s
a=pim_msdp_sa_find(pim,sg);if(sa){if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPlo
calsa%sdelonupdel",sa->sg_str);}/*ifthereisnolocalreferenceescape*/if(!(sa->flag
s&PIM_MSDP_SAF_LOCAL)){if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPlocalsa%sdel;
nolocalref",sa->sg_str);}return;}if(sa->flags&PIM_MSDP_SAF_UP_DEL_IN_PROG){/*MSD
Pistheonethattriggeredtheupstreamdel.if*thishappens*wemostcertainlyhaveabuginthe
PIMupstream*statemachine.We*willnothavealocalreferenceunlesstheKATis*running.And
ifthe*KATisrunningthereMUSTbeanadditional*source-streamreferenceto*theflow.Accou
ntingforsuchcasesrequireslotof*changes;perhaps*addressthisinthenextrelease?-XXX*
/zlog_err("MSDPsa%sSPTteardowniscausingthelocalentrytoberemoved",sa->sg_str);ret
urn;}/*wearedroppingthesaonupstreamdelweshouldnothavean*upstreamreference*/if(sa
->up){if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPlocalsa%sdel;upnon-NULL",sa->s
g_str);}sa->up=NULL;}pim_msdp_sa_deref(sa,PIM_MSDP_SAF_LOCAL);}}/*LocalSAqualifi
cationneedstobere-evaluatedwhen-*1.KATisstartedorstopped*2.onRPchanges*3.Wheneve
rFHRstatuschangesfora(S,G)-XXX-currentlythere*isnoclearpathtotransitionanentryou
tof"MASK_FHR"need*todiscussthiswithDonald.Mayresultinsomestrangenessifthe*FHRisa
lsotheRP.*4.Whenmsdp_regtimerisstartedorstopped*/voidpim_msdp_sa_local_update(st
ructpim_upstream*up){structpim_instance*pim=up->channel_oil->pim;if(pim_msdp_sa_
local_add_ok(up)){pim_msdp_sa_local_add(pim,&up->sg);}else{pim_msdp_sa_local_del
(pim,&up->sg);}}staticvoidpim_msdp_sa_local_setup(structpim_instance*pim){struct
pim_upstream*up;structlistnode*up_node;for(ALL_LIST_ELEMENTS_RO(pim->upstream_li
st,up_node,up)){pim_msdp_sa_local_update(up);}}/*whenevertheRPchangesweneedtore-
evaluatethe"local"SA-cache*//*XXX:needstobetested*/voidpim_msdp_i_am_rp_changed(
structpim_instance*pim){structlistnode*sanode;structlistnode*nextnode;structpim_
msdp_sa*sa;if(!(pim->msdp.flags&PIM_MSDPF_ENABLE)){/*ifthefeatureisnotenableddon
othing*/return;}if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPi_am_rpchanged");}/*
markalllocalentriesasstale*/for(ALL_LIST_ELEMENTS_RO(pim->msdp.sa_list,sanode,sa
)){if(sa->flags&PIM_MSDP_SAF_LOCAL){sa->flags|=PIM_MSDP_SAF_STALE;}}/*re-setuplo
calSAentries*/pim_msdp_sa_local_setup(pim);for(ALL_LIST_ELEMENTS(pim->msdp.sa_li
st,sanode,nextnode,sa)){/*purgestaleSAentries*/if(sa->flags&PIM_MSDP_SAF_STALE){
/*clearthestaleflag;theentrymaybekepteven*after*"local-deref"*/sa->flags&=~PIM_M
SDP_SAF_STALE;/*sa_derefcanendupfreeingthesa;sodon'taccess*contentsafter*/pim_ms
dp_sa_deref(sa,PIM_MSDP_SAF_LOCAL);}else{/*ifthesouceisstillactivecheckifwecan*i
nfluenceSPT*/pim_msdp_sa_upstream_update(sa,NULL/*xg_up*/,"rp-change");}}}/*Wetr
ackthejoinstateof(*,G)entries.IfGhassourcesintheSA-cache*weneedtosetuporteardown
SPTwhentheJoinDesiredstatuschangesfor*(*,G)*/voidpim_msdp_up_join_state_changed(
structpim_instance*pim,structpim_upstream*xg_up){structlistnode*sanode;structpim
_msdp_sa*sa;if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPjoinstatechangedfor%s",x
g_up->sg_str);}/*IfthisisnotreallyanXGentryjustmoveon*/if((xg_up->sg.src.s_addr!
=INADDR_ANY)||(xg_up->sg.grp.s_addr==INADDR_ANY)){return;}/*XXX:NeedtomaintainSA
sper-grouptoavoidallthisunnecessary*walking*/for(ALL_LIST_ELEMENTS_RO(pim->msdp.
sa_list,sanode,sa)){if(sa->sg.grp.s_addr!=xg_up->sg.grp.s_addr){continue;}pim_ms
dp_sa_upstream_update(sa,xg_up,"up-jp-change");}}staticvoidpim_msdp_up_xg_del(st
ructpim_instance*pim,structprefix_sg*sg){structlistnode*sanode;structpim_msdp_sa
*sa;if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDP%sdel",pim_str_sg_dump(sg));}/*I
fthisisnotreallyanXGentryjustmoveon*/if((sg->src.s_addr!=INADDR_ANY)||(sg->grp.s
_addr==INADDR_ANY)){return;}/*XXX:NeedtomaintainSAsper-grouptoavoidallthisunnece
ssary*walking*/for(ALL_LIST_ELEMENTS_RO(pim->msdp.sa_list,sanode,sa)){if(sa->sg.
grp.s_addr!=sg->grp.s_addr){continue;}pim_msdp_sa_upstream_update(sa,NULL/*xg*/,
"up-jp-change");}}voidpim_msdp_up_del(structpim_instance*pim,structprefix_sg*sg)
{if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPup%sdel",pim_str_sg_dump(sg));}if(s
g->src.s_addr==INADDR_ANY){pim_msdp_up_xg_del(pim,sg);}else{pim_msdp_sa_local_de
l_on_up_del(pim,sg);}}/*sahashandpeerlisthelpers*/staticunsignedintpim_msdp_sa_h
ash_key_make(void*p){structpim_msdp_sa*sa=p;return(jhash_2words(sa->sg.src.s_add
r,sa->sg.grp.s_addr,0));}staticintpim_msdp_sa_hash_eq(constvoid*p1,constvoid*p2)
{conststructpim_msdp_sa*sa1=p1;conststructpim_msdp_sa*sa2=p2;return((sa1->sg.src
.s_addr==sa2->sg.src.s_addr)&&(sa1->sg.grp.s_addr==sa2->sg.grp.s_addr));}statici
ntpim_msdp_sa_comp(constvoid*p1,constvoid*p2){conststructpim_msdp_sa*sa1=p1;cons
tstructpim_msdp_sa*sa2=p2;if(ntohl(sa1->sg.grp.s_addr)<ntohl(sa2->sg.grp.s_addr)
)return-1;if(ntohl(sa1->sg.grp.s_addr)>ntohl(sa2->sg.grp.s_addr))return1;if(ntoh
l(sa1->sg.src.s_addr)<ntohl(sa2->sg.src.s_addr))return-1;if(ntohl(sa1->sg.src.s_
addr)>ntohl(sa2->sg.src.s_addr))return1;return0;}/*RFC-3618:Sec-10.1.3-Peer-RPFf
orwarding*//*XXX:thiscanuseabitofrefiningandextensions*/boolpim_msdp_peer_rpf_ch
eck(structpim_msdp_peer*mp,structin_addrrp){if(mp->peer.s_addr==rp.s_addr){retur
ntrue;}returnfalse;}/************************Peersessionmanagement**************
************/char*pim_msdp_state_dump(enumpim_msdp_peer_statestate,char*buf,intb
uf_size){switch(state){casePIM_MSDP_DISABLED:snprintf(buf,buf_size,"%s","disable
d");break;casePIM_MSDP_INACTIVE:snprintf(buf,buf_size,"%s","inactive");break;cas
ePIM_MSDP_LISTEN:snprintf(buf,buf_size,"%s","listen");break;casePIM_MSDP_CONNECT
ING:snprintf(buf,buf_size,"%s","connecting");break;casePIM_MSDP_ESTABLISHED:snpr
intf(buf,buf_size,"%s","established");break;default:snprintf(buf,buf_size,"unk-%
d",state);}returnbuf;}char*pim_msdp_peer_key_dump(structpim_msdp_peer*mp,char*bu
f,intbuf_size,boollong_format){charpeer_str[INET_ADDRSTRLEN];charlocal_str[INET_
ADDRSTRLEN];pim_inet4_dump("<peer?>",mp->peer,peer_str,sizeof(peer_str));if(long
_format){pim_inet4_dump("<local?>",mp->local,local_str,sizeof(local_str));snprin
tf(buf,buf_size,"MSDPpeer%slocal%smg%s",peer_str,local_str,mp->mesh_group_name);
}else{snprintf(buf,buf_size,"MSDPpeer%s",peer_str);}returnbuf;}staticvoidpim_msd
p_peer_state_chg_log(structpim_msdp_peer*mp){charstate_str[PIM_MSDP_STATE_STRLEN
];pim_msdp_state_dump(mp->state,state_str,sizeof(state_str));zlog_debug("MSDPpee
r%sstatechgto%s",mp->key_str,state_str);}/*MSDPConnectionStateMachineactions(def
inedinRFC-3618:Sec-11.2)*//*11.2.A2:activepeer-startconnectretrytimer;whenthetim
erfires*atcpconnectionwillbemade*/staticvoidpim_msdp_peer_connect(structpim_msdp
_peer*mp){mp->state=PIM_MSDP_CONNECTING;if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_
state_chg_log(mp);}pim_msdp_peer_cr_timer_setup(mp,true/*start*/);}/*11.2.A3:pas
sivepeer-justlistenforconnections*/staticvoidpim_msdp_peer_listen(structpim_msdp
_peer*mp){mp->state=PIM_MSDP_LISTEN;if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_stat
e_chg_log(mp);}/*thisisinterntionallyasymmetrici.e.wesetuplisten-socketwhen*the*
firstlisteningpeerisconfigured;butdon'tbothertearingitdown*when*allthepeersgodow
n*/pim_msdp_sock_listen(mp->pim);}/*11.2.A4and11.2.A5:transitionactiveorpassivep
eerto*establishedstate*/voidpim_msdp_peer_established(structpim_msdp_peer*mp){if
(mp->state!=PIM_MSDP_ESTABLISHED){++mp->est_flaps;}mp->state=PIM_MSDP_ESTABLISHE
D;mp->uptime=pim_time_monotonic_sec();if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_st
ate_chg_log(mp);}/*stopretrytimeronactivepeers*/pim_msdp_peer_cr_timer_setup(mp,
false/*start*/);/*sendKA;startKAandholdtimers*/pim_msdp_pkt_ka_tx(mp);pim_msdp_p
eer_ka_timer_setup(mp,true/*start*/);pim_msdp_peer_hold_timer_setup(mp,true/*sta
rt*/);pim_msdp_pkt_sa_tx_to_one_peer(mp);PIM_MSDP_PEER_WRITE_ON(mp);PIM_MSDP_PEE
R_READ_ON(mp);}/*11.2.A6,11.2.A7and11.2.A8:shutdownthepeertcpconnection*/voidpim
_msdp_peer_stop_tcp_conn(structpim_msdp_peer*mp,boolchg_state){if(chg_state){if(
mp->state==PIM_MSDP_ESTABLISHED){++mp->est_flaps;}mp->state=PIM_MSDP_INACTIVE;if
(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_state_chg_log(mp);}}if(PIM_DEBUG_MSDP_INTE
RNAL){zlog_debug("MSDPpeer%spim_msdp_peer_stop_tcp_conn",mp->key_str);}/*stoprea
dandwritethreads*/PIM_MSDP_PEER_READ_OFF(mp);PIM_MSDP_PEER_WRITE_OFF(mp);/*reset
buffers*/mp->packet_size=0;if(mp->ibuf)stream_reset(mp->ibuf);if(mp->obuf)stream
_fifo_clean(mp->obuf);/*stopallpeertimers*/pim_msdp_peer_ka_timer_setup(mp,false
/*start*/);pim_msdp_peer_cr_timer_setup(mp,false/*start*/);pim_msdp_peer_hold_ti
mer_setup(mp,false/*start*/);/*closeconnection*/if(mp->fd>=0){close(mp->fd);mp->
fd=-1;}}/*RFC-3618:Sec-5.6-stopthepeertcpconnectionandstartover*/voidpim_msdp_pe
er_reset_tcp_conn(structpim_msdp_peer*mp,constchar*rc_str){if(PIM_DEBUG_EVENTS){
zlog_debug("MSDPpeer%stcpreset%s",mp->key_str,rc_str);snprintf(mp->last_reset,si
zeof(mp->last_reset),"%s",rc_str);}/*closetheconnectionandtransitiontolisteningo
rconnecting*/pim_msdp_peer_stop_tcp_conn(mp,true/*chg_state*/);if(PIM_MSDP_PEER_
IS_LISTENER(mp)){pim_msdp_peer_listen(mp);}else{pim_msdp_peer_connect(mp);}}stat
icvoidpim_msdp_peer_timer_expiry_log(structpim_msdp_peer*mp,constchar*timer_str)
{zlog_debug("MSDPpeer%s%stimerexpired",mp->key_str,timer_str);}/*RFC-3618:Sec-5.
4-peerholdtimer*/staticintpim_msdp_peer_hold_timer_cb(structthread*t){structpim_
msdp_peer*mp;mp=THREAD_ARG(t);if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_timer_expi
ry_log(mp,"hold");}if(mp->state!=PIM_MSDP_ESTABLISHED){return0;}if(PIM_DEBUG_MSD
P_EVENTS){pim_msdp_peer_state_chg_log(mp);}pim_msdp_peer_reset_tcp_conn(mp,"ht-e
xpired");return0;}staticvoidpim_msdp_peer_hold_timer_setup(structpim_msdp_peer*m
p,boolstart){structpim_instance*pim=mp->pim;THREAD_OFF(mp->hold_timer);if(start)
{thread_add_timer(pim->msdp.master,pim_msdp_peer_hold_timer_cb,mp,PIM_MSDP_PEER_
HOLD_TIME,&mp->hold_timer);}}/*RFC-3618:Sec-5.5-peerkeepalivetimer*/staticintpim
_msdp_peer_ka_timer_cb(structthread*t){structpim_msdp_peer*mp;mp=THREAD_ARG(t);i
f(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_timer_expiry_log(mp,"ka");}pim_msdp_pkt_k
a_tx(mp);pim_msdp_peer_ka_timer_setup(mp,true/*start*/);return0;}staticvoidpim_m
sdp_peer_ka_timer_setup(structpim_msdp_peer*mp,boolstart){THREAD_OFF(mp->ka_time
r);if(start){thread_add_timer(mp->pim->msdp.master,pim_msdp_peer_ka_timer_cb,mp,
PIM_MSDP_PEER_KA_TIME,&mp->ka_timer);}}staticvoidpim_msdp_peer_active_connect(st
ructpim_msdp_peer*mp){intrc;++mp->conn_attempts;rc=pim_msdp_sock_connect(mp);if(
PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_msdp_peer_active_connect:%d",
mp->key_str,rc);}switch(rc){caseconnect_error:case-1:/*connectfailedrestarttheco
nnect-retrytimer*/pim_msdp_peer_cr_timer_setup(mp,true/*start*/);break;caseconne
ct_success:/*connectwassucessfulmovetoestablished*/pim_msdp_peer_established(mp)
;break;caseconnect_in_progress:/*forNBcontentweneedtowaittillsockisreadableor*wr
iteable*/PIM_MSDP_PEER_WRITE_ON(mp);PIM_MSDP_PEER_READ_ON(mp);/*alsorestartconne
ct-retrytimertoresetthesocketif*connectis*notsucessful*/pim_msdp_peer_cr_timer_s
etup(mp,true/*start*/);break;}}/*RFC-3618:Sec-5.6-connectionretryonactivepeer*/s
taticintpim_msdp_peer_cr_timer_cb(structthread*t){structpim_msdp_peer*mp;mp=THRE
AD_ARG(t);if(PIM_DEBUG_MSDP_EVENTS){pim_msdp_peer_timer_expiry_log(mp,"connect-r
etry");}if(mp->state!=PIM_MSDP_CONNECTING||PIM_MSDP_PEER_IS_LISTENER(mp)){return
0;}pim_msdp_peer_active_connect(mp);return0;}staticvoidpim_msdp_peer_cr_timer_se
tup(structpim_msdp_peer*mp,boolstart){THREAD_OFF(mp->cr_timer);if(start){thread_
add_timer(mp->pim->msdp.master,pim_msdp_peer_cr_timer_cb,mp,PIM_MSDP_PEER_CONNEC
T_RETRY_TIME,&mp->cr_timer);}}/*ifavalidpacketisrxedfromthepeerwecanrestartholdt
imer*/voidpim_msdp_peer_pkt_rxed(structpim_msdp_peer*mp){if(mp->state==PIM_MSDP_
ESTABLISHED){pim_msdp_peer_hold_timer_setup(mp,true/*start*/);}}/*ifavalidpacket
istxedtothepeerwecanrestartkatimerandavoid*unnecessarykanoiseinthenetwork*/voidp
im_msdp_peer_pkt_txed(structpim_msdp_peer*mp){if(mp->state==PIM_MSDP_ESTABLISHED
){pim_msdp_peer_ka_timer_setup(mp,true/*start*/);if(PIM_DEBUG_MSDP_INTERNAL){zlo
g_debug("MSDPkatimerrestartonpkttxto%s",mp->key_str);}}}staticvoidpim_msdp_addr2
su(unionsockunion*su,structin_addraddr){sockunion_init(su);su->sin.sin_addr=addr
;su->sin.sin_family=AF_INET;#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENsu->sin.sin_len
=sizeof(structsockaddr_in);#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*/}/*11.2.A1:c
reateanewpeerandtransitionstatetolistenorconnecting*/staticenumpim_msdp_errpim_m
sdp_peer_new(structpim_instance*pim,structin_addrpeer_addr,structin_addrlocal_ad
dr,constchar*mesh_group_name,structpim_msdp_peer**mp_p){structpim_msdp_peer*mp;p
im_msdp_enable(pim);mp=XCALLOC(MTYPE_PIM_MSDP_PEER,sizeof(*mp));if(!mp){zlog_err
("%s:PIMXCALLOC(%zu)failure",__PRETTY_FUNCTION__,sizeof(*mp));returnPIM_MSDP_ERR
_OOM;}mp->pim=pim;mp->peer=peer_addr;pim_inet4_dump("<peer?>",mp->peer,mp->key_s
tr,sizeof(mp->key_str));pim_msdp_addr2su(&mp->su_peer,mp->peer);mp->local=local_
addr;/*XXX:originator_idsettingneedstomovetothemeshgroup*/pim->msdp.originator_i
d=local_addr;pim_msdp_addr2su(&mp->su_local,mp->local);mp->mesh_group_name=XSTRD
UP(MTYPE_PIM_MSDP_MG_NAME,mesh_group_name);mp->state=PIM_MSDP_INACTIVE;mp->fd=-1
;strcpy(mp->last_reset,"-");/*higherIPaddressislistener*/if(ntohl(mp->local.s_ad
dr)>ntohl(mp->peer.s_addr)){mp->flags|=PIM_MSDP_PEERF_LISTENER;}/*setuppacketbuf
fers*/mp->ibuf=stream_new(PIM_MSDP_MAX_PACKET_SIZE);mp->obuf=stream_fifo_new();/
*insertintomisctablesforeasyaccess*/mp=hash_get(pim->msdp.peer_hash,mp,hash_allo
c_intern);listnode_add_sort(pim->msdp.peer_list,mp);if(PIM_DEBUG_MSDP_EVENTS){zl
og_debug("MSDPpeer%screated",mp->key_str);pim_msdp_peer_state_chg_log(mp);}/*fir
euptheconnectstatemachine*/if(PIM_MSDP_PEER_IS_LISTENER(mp)){pim_msdp_peer_liste
n(mp);}else{pim_msdp_peer_connect(mp);}if(mp_p){*mp_p=mp;}returnPIM_MSDP_ERR_NON
E;}structpim_msdp_peer*pim_msdp_peer_find(structpim_instance*pim,structin_addrpe
er_addr){structpim_msdp_peerlookup;lookup.peer=peer_addr;returnhash_lookup(pim->
msdp.peer_hash,&lookup);}/*addpeerconfigurationifitdoesn'talreadyexist*/enumpim_
msdp_errpim_msdp_peer_add(structpim_instance*pim,structin_addrpeer_addr,structin
_addrlocal_addr,constchar*mesh_group_name,structpim_msdp_peer**mp_p){structpim_m
sdp_peer*mp;if(mp_p){*mp_p=NULL;}if(peer_addr.s_addr==local_addr.s_addr){/*skips
essionsetupifconfigisinvalid*/if(PIM_DEBUG_MSDP_EVENTS){charpeer_str[INET_ADDRST
RLEN];pim_inet4_dump("<peer?>",peer_addr,peer_str,sizeof(peer_str));zlog_debug("
%saddskippedasDIP=SIP",peer_str);}returnPIM_MSDP_ERR_SIP_EQ_DIP;}mp=pim_msdp_pee
r_find(pim,peer_addr);if(mp){if(mp_p){*mp_p=mp;}returnPIM_MSDP_ERR_PEER_EXISTS;}
returnpim_msdp_peer_new(pim,peer_addr,local_addr,mesh_group_name,mp_p);}/*releas
eallmemassociatedwithapeer*/staticvoidpim_msdp_peer_free(structpim_msdp_peer*mp)
{if(mp->ibuf){stream_free(mp->ibuf);}if(mp->obuf){stream_fifo_free(mp->obuf);}if
(mp->mesh_group_name){XFREE(MTYPE_PIM_MSDP_MG_NAME,mp->mesh_group_name);}XFREE(M
TYPE_PIM_MSDP_PEER,mp);}/*deletethepeerconfig*/staticenumpim_msdp_errpim_msdp_pe
er_do_del(structpim_msdp_peer*mp){/*stopthetcpconnectionandshutdownalltimers*/pi
m_msdp_peer_stop_tcp_conn(mp,true/*chg_state*/);/*removethesessionfromvarioustab
les*/listnode_delete(mp->pim->msdp.peer_list,mp);hash_release(mp->pim->msdp.peer
_hash,mp);if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPpeer%sdeleted",mp->key_str);
}/*freeupanyassociatedmemory*/pim_msdp_peer_free(mp);returnPIM_MSDP_ERR_NONE;}en
umpim_msdp_errpim_msdp_peer_del(structpim_instance*pim,structin_addrpeer_addr){s
tructpim_msdp_peer*mp;mp=pim_msdp_peer_find(pim,peer_addr);if(!mp){returnPIM_MSD
P_ERR_NO_PEER;}returnpim_msdp_peer_do_del(mp);}/*peerhashandpeerlisthelpers*/sta
ticunsignedintpim_msdp_peer_hash_key_make(void*p){structpim_msdp_peer*mp=p;retur
n(jhash_1word(mp->peer.s_addr,0));}staticintpim_msdp_peer_hash_eq(constvoid*p1,c
onstvoid*p2){conststructpim_msdp_peer*mp1=p1;conststructpim_msdp_peer*mp2=p2;ret
urn(mp1->peer.s_addr==mp2->peer.s_addr);}staticintpim_msdp_peer_comp(constvoid*p
1,constvoid*p2){conststructpim_msdp_peer*mp1=p1;conststructpim_msdp_peer*mp2=p2;
if(ntohl(mp1->peer.s_addr)<ntohl(mp2->peer.s_addr))return-1;if(ntohl(mp1->peer.s
_addr)>ntohl(mp2->peer.s_addr))return1;return0;}/**************************Meshg
roupmanagement**************************/staticvoidpim_msdp_mg_free(structpim_in
stance*pim,structpim_msdp_mg*mg){/*Ifthemesh-grouphasvalidmemberorsrc_ipdon'tdel
eteit*/if(!mg||mg->mbr_cnt||(mg->src_ip.s_addr!=INADDR_ANY)){return;}if(PIM_DEBU
G_MSDP_EVENTS){zlog_debug("MSDPmesh-group%sdeleted",mg->mesh_group_name);}if(mg-
>mesh_group_name)XFREE(MTYPE_PIM_MSDP_MG_NAME,mg->mesh_group_name);if(mg->mbr_li
st)list_delete_and_null(&mg->mbr_list);XFREE(MTYPE_PIM_MSDP_MG,mg);pim->msdp.mg=
NULL;}staticstructpim_msdp_mg*pim_msdp_mg_new(constchar*mesh_group_name){structp
im_msdp_mg*mg;mg=XCALLOC(MTYPE_PIM_MSDP_MG,sizeof(*mg));if(!mg){zlog_err("%s:PIM
XCALLOC(%zu)failure",__PRETTY_FUNCTION__,sizeof(*mg));returnNULL;}mg->mesh_group
_name=XSTRDUP(MTYPE_PIM_MSDP_MG_NAME,mesh_group_name);mg->mbr_list=list_new();mg
->mbr_list->del=(void(*)(void*))pim_msdp_mg_mbr_free;mg->mbr_list->cmp=(int(*)(v
oid*,void*))pim_msdp_mg_mbr_comp;if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDPmesh-
group%screated",mg->mesh_group_name);}returnmg;}enumpim_msdp_errpim_msdp_mg_del(
structpim_instance*pim,constchar*mesh_group_name){structpim_msdp_mg*mg=pim->msdp
.mg;structpim_msdp_mg_mbr*mbr;if(!mg||strcmp(mg->mesh_group_name,mesh_group_name
)){returnPIM_MSDP_ERR_NO_MG;}/*deleteallthemesh-groupmembers*/while(!list_isempt
y(mg->mbr_list)){mbr=listnode_head(mg->mbr_list);pim_msdp_mg_mbr_do_del(mg,mbr);
}/*clearsrcip*/mg->src_ip.s_addr=INADDR_ANY;/*freeupthemesh-group*/pim_msdp_mg_f
ree(pim,mg);returnPIM_MSDP_ERR_NONE;}staticenumpim_msdp_errpim_msdp_mg_add(struc
tpim_instance*pim,constchar*mesh_group_name){if(pim->msdp.mg){if(!strcmp(pim->ms
dp.mg->mesh_group_name,mesh_group_name)){returnPIM_MSDP_ERR_NONE;}/*currentlyonl
yonemesh-groupcanexistatatime*/returnPIM_MSDP_ERR_MAX_MESH_GROUPS;}pim->msdp.mg=
pim_msdp_mg_new(mesh_group_name);if(!pim->msdp.mg){returnPIM_MSDP_ERR_OOM;}retur
nPIM_MSDP_ERR_NONE;}staticintpim_msdp_mg_mbr_comp(constvoid*p1,constvoid*p2){con
ststructpim_msdp_mg_mbr*mbr1=p1;conststructpim_msdp_mg_mbr*mbr2=p2;if(ntohl(mbr1
->mbr_ip.s_addr)<ntohl(mbr2->mbr_ip.s_addr))return-1;if(ntohl(mbr1->mbr_ip.s_add
r)>ntohl(mbr2->mbr_ip.s_addr))return1;return0;}staticvoidpim_msdp_mg_mbr_free(st
ructpim_msdp_mg_mbr*mbr){XFREE(MTYPE_PIM_MSDP_MG_MBR,mbr);}staticstructpim_msdp_
mg_mbr*pim_msdp_mg_mbr_find(structpim_instance*pim,structin_addrmbr_ip){structpi
m_msdp_mg_mbr*mbr;structlistnode*mbr_node;if(!pim->msdp.mg){returnNULL;}/*wecanm
ovethistoahashbutconsideringthatnumberofpeersin*amesh-groupthatseemslikebitofano
verkill*/for(ALL_LIST_ELEMENTS_RO(pim->msdp.mg->mbr_list,mbr_node,mbr)){if(mbr->
mbr_ip.s_addr==mbr_ip.s_addr){returnmbr;}}returnmbr;}enumpim_msdp_errpim_msdp_mg
_mbr_add(structpim_instance*pim,constchar*mesh_group_name,structin_addrmbr_ip){i
ntrc;structpim_msdp_mg_mbr*mbr;structpim_msdp_mg*mg;rc=pim_msdp_mg_add(pim,mesh_
group_name);if(rc!=PIM_MSDP_ERR_NONE){returnrc;}mg=pim->msdp.mg;mbr=pim_msdp_mg_
mbr_find(pim,mbr_ip);if(mbr){returnPIM_MSDP_ERR_MG_MBR_EXISTS;}mbr=XCALLOC(MTYPE
_PIM_MSDP_MG_MBR,sizeof(*mbr));if(!mbr){zlog_err("%s:PIMXCALLOC(%zu)failure",__P
RETTY_FUNCTION__,sizeof(*mbr));/*iftherearenoreferencestothemgfreeit*/pim_msdp_m
g_free(pim,mg);returnPIM_MSDP_ERR_OOM;}mbr->mbr_ip=mbr_ip;listnode_add_sort(mg->
mbr_list,mbr);/*ifvalidSIPhasbeenconfiguredaddpeersession*/if(mg->src_ip.s_addr!
=INADDR_ANY){pim_msdp_peer_add(pim,mbr_ip,mg->src_ip,mesh_group_name,&mbr->mp);}
if(PIM_DEBUG_MSDP_EVENTS){charip_str[INET_ADDRSTRLEN];pim_inet4_dump("<mbr?>",mb
r->mbr_ip,ip_str,sizeof(ip_str));zlog_debug("MSDPmesh-group%smbr%screated",mg->m
esh_group_name,ip_str);}++mg->mbr_cnt;returnPIM_MSDP_ERR_NONE;}staticvoidpim_msd
p_mg_mbr_do_del(structpim_msdp_mg*mg,structpim_msdp_mg_mbr*mbr){/*Deleteactivepe
ersessionifany*/if(mbr->mp){pim_msdp_peer_do_del(mbr->mp);}listnode_delete(mg->m
br_list,mbr);if(PIM_DEBUG_MSDP_EVENTS){charip_str[INET_ADDRSTRLEN];pim_inet4_dum
p("<mbr?>",mbr->mbr_ip,ip_str,sizeof(ip_str));zlog_debug("MSDPmesh-group%smbr%sd
eleted",mg->mesh_group_name,ip_str);}pim_msdp_mg_mbr_free(mbr);if(mg->mbr_cnt){-
-mg->mbr_cnt;}}enumpim_msdp_errpim_msdp_mg_mbr_del(structpim_instance*pim,constc
har*mesh_group_name,structin_addrmbr_ip){structpim_msdp_mg_mbr*mbr;structpim_msd
p_mg*mg=pim->msdp.mg;if(!mg||strcmp(mg->mesh_group_name,mesh_group_name)){return
PIM_MSDP_ERR_NO_MG;}mbr=pim_msdp_mg_mbr_find(pim,mbr_ip);if(!mbr){returnPIM_MSDP
_ERR_NO_MG_MBR;}pim_msdp_mg_mbr_do_del(mg,mbr);/*iftherearenoreferencestothemgfr
eeit*/pim_msdp_mg_free(pim,mg);returnPIM_MSDP_ERR_NONE;}staticvoidpim_msdp_mg_sr
c_do_del(structpim_instance*pim){structpim_msdp_mg_mbr*mbr;structlistnode*mbr_no
de;structpim_msdp_mg*mg=pim->msdp.mg;/*SIPisbeingremoved-teardownallactivepeerse
ssions*/for(ALL_LIST_ELEMENTS_RO(mg->mbr_list,mbr_node,mbr)){if(mbr->mp){pim_msd
p_peer_do_del(mbr->mp);mbr->mp=NULL;}}if(PIM_DEBUG_MSDP_EVENTS){zlog_debug("MSDP
mesh-group%ssrccleared",mg->mesh_group_name);}}enumpim_msdp_errpim_msdp_mg_src_d
el(structpim_instance*pim,constchar*mesh_group_name){structpim_msdp_mg*mg=pim->m
sdp.mg;if(!mg||strcmp(mg->mesh_group_name,mesh_group_name)){returnPIM_MSDP_ERR_N
O_MG;}if(mg->src_ip.s_addr!=INADDR_ANY){mg->src_ip.s_addr=INADDR_ANY;pim_msdp_mg
_src_do_del(pim);/*iftherearenoreferencestothemgfreeit*/pim_msdp_mg_free(pim,mg)
;}returnPIM_MSDP_ERR_NONE;}enumpim_msdp_errpim_msdp_mg_src_add(structpim_instanc
e*pim,constchar*mesh_group_name,structin_addrsrc_ip){intrc;structpim_msdp_mg_mbr
*mbr;structlistnode*mbr_node;structpim_msdp_mg*mg;if(src_ip.s_addr==INADDR_ANY){
pim_msdp_mg_src_del(pim,mesh_group_name);returnPIM_MSDP_ERR_NONE;}rc=pim_msdp_mg
_add(pim,mesh_group_name);if(rc!=PIM_MSDP_ERR_NONE){returnrc;}mg=pim->msdp.mg;if
(mg->src_ip.s_addr!=INADDR_ANY){pim_msdp_mg_src_do_del(pim);}mg->src_ip=src_ip;f
or(ALL_LIST_ELEMENTS_RO(mg->mbr_list,mbr_node,mbr)){pim_msdp_peer_add(pim,mbr->m
br_ip,mg->src_ip,mesh_group_name,&mbr->mp);}if(PIM_DEBUG_MSDP_EVENTS){charip_str
[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",mg->src_ip,ip_str,sizeof(ip_str));zlog
_debug("MSDPmesh-group%ssrc%sset",mg->mesh_group_name,ip_str);}returnPIM_MSDP_ER
R_NONE;}/***********************MSDPfeatureAPIs*********************************
/intpim_msdp_config_write_helper(structpim_instance*pim,structvty*vty,constchar*
spaces){structlistnode*mbrnode;structpim_msdp_mg_mbr*mbr;structpim_msdp_mg*mg=pi
m->msdp.mg;charmbr_str[INET_ADDRSTRLEN];charsrc_str[INET_ADDRSTRLEN];intcount=0;
if(!mg){returncount;}if(mg->src_ip.s_addr!=INADDR_ANY){pim_inet4_dump("<src?>",m
g->src_ip,src_str,sizeof(src_str));vty_out(vty,"%sipmsdpmesh-group%ssource%s\n",
spaces,mg->mesh_group_name,src_str);++count;}for(ALL_LIST_ELEMENTS_RO(mg->mbr_li
st,mbrnode,mbr)){pim_inet4_dump("<mbr?>",mbr->mbr_ip,mbr_str,sizeof(mbr_str));vt
y_out(vty,"%sipmsdpmesh-group%smember%s\n",spaces,mg->mesh_group_name,mbr_str);+
+count;}returncount;}intpim_msdp_config_write(structvty*vty){returnpim_msdp_conf
ig_write_helper(pimg,vty,"");}/*Enablefeatureincludingactive/periodictimersetc.o
nthefirstpeer*config.TillthenMSDPshouldjuststayquiet.*/staticvoidpim_msdp_enable
(structpim_instance*pim){if(pim->msdp.flags&PIM_MSDPF_ENABLE){/*featureisalready
enabled*/return;}pim->msdp.flags|=PIM_MSDPF_ENABLE;pim->msdp.work_obuf=stream_ne
w(PIM_MSDP_MAX_PACKET_SIZE);pim_msdp_sa_adv_timer_setup(pim,true/*start*/);/*set
upsacachebasedonlocalsources*/pim_msdp_sa_local_setup(pim);}/*MSDPinit*/voidpim_
msdp_init(structpim_instance*pim,structthread_master*master){pim->msdp.master=ma
ster;charhash_name[64];snprintf(hash_name,64,"PIM%sMSDPPeerHash",pim->vrf->name)
;pim->msdp.peer_hash=hash_create(pim_msdp_peer_hash_key_make,pim_msdp_peer_hash_
eq,hash_name);pim->msdp.peer_list=list_new();pim->msdp.peer_list->del=(void(*)(v
oid*))pim_msdp_peer_free;pim->msdp.peer_list->cmp=(int(*)(void*,void*))pim_msdp_
peer_comp;snprintf(hash_name,64,"PIM%sMSDPSAHash",pim->vrf->name);pim->msdp.sa_h
ash=hash_create(pim_msdp_sa_hash_key_make,pim_msdp_sa_hash_eq,hash_name);pim->ms
dp.sa_list=list_new();pim->msdp.sa_list->del=(void(*)(void*))pim_msdp_sa_free;pi
m->msdp.sa_list->cmp=(int(*)(void*,void*))pim_msdp_sa_comp;}/*counterparttoMSDPi
nit;XXX:unusedcurrently*/voidpim_msdp_exit(structpim_instance*pim){/*XXX:stoplis
teneranddeleteallpeersessions*/if(pim->msdp.peer_hash){hash_free(pim->msdp.peer_
hash);pim->msdp.peer_hash=NULL;}if(pim->msdp.peer_list){list_delete_and_null(&pi
m->msdp.peer_list);}if(pim->msdp.sa_hash){hash_free(pim->msdp.sa_hash);pim->msdp
.sa_hash=NULL;}if(pim->msdp.sa_list){list_delete_and_null(&pim->msdp.sa_list);}}
