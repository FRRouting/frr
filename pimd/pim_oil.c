/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"memory.h"#include"linklist.h"#inc
lude"if.h"#include"hash.h"#include"jhash.h"#include"pimd.h"#include"pim_oil.h"#i
nclude"pim_str.h"#include"pim_iface.h"#include"pim_time.h"//structlist*pim_chann
el_oil_list=NULL;//structhash*pim_channel_oil_hash=NULL;char*pim_channel_oil_dum
p(structchannel_oil*c_oil,char*buf,size_tsize){structprefix_sgsg;inti;memset(buf
,0,size);sg.src=c_oil->oil.mfcc_origin;sg.grp=c_oil->oil.mfcc_mcastgrp;sprintf(b
uf,"%sIIF:%d,OIFS:",pim_str_sg_dump(&sg),c_oil->oil.mfcc_parent);for(i=0;i<MAXVI
FS;i++){if(c_oil->oil.mfcc_ttls[i]!=0){charbuf1[10];sprintf(buf1,"%d",i);strcat(
buf,buf1);}}returnbuf;}staticintpim_channel_oil_compare(structchannel_oil*c1,str
uctchannel_oil*c2){if(ntohl(c1->oil.mfcc_mcastgrp.s_addr)<ntohl(c2->oil.mfcc_mca
stgrp.s_addr))return-1;if(ntohl(c1->oil.mfcc_mcastgrp.s_addr)>ntohl(c2->oil.mfcc
_mcastgrp.s_addr))return1;if(ntohl(c1->oil.mfcc_origin.s_addr)<ntohl(c2->oil.mfc
c_origin.s_addr))return-1;if(ntohl(c1->oil.mfcc_origin.s_addr)>ntohl(c2->oil.mfc
c_origin.s_addr))return1;return0;}staticintpim_oil_equal(constvoid*arg1,constvoi
d*arg2){conststructchannel_oil*c1=(conststructchannel_oil*)arg1;conststructchann
el_oil*c2=(conststructchannel_oil*)arg2;if((c1->oil.mfcc_mcastgrp.s_addr==c2->oi
l.mfcc_mcastgrp.s_addr)&&(c1->oil.mfcc_origin.s_addr==c2->oil.mfcc_origin.s_addr
))return1;return0;}staticunsignedintpim_oil_hash_key(void*arg){structchannel_oil
*oil=(structchannel_oil*)arg;returnjhash_2words(oil->oil.mfcc_mcastgrp.s_addr,oi
l->oil.mfcc_origin.s_addr,0);}voidpim_oil_init(structpim_instance*pim){charhash_
name[64];snprintf(hash_name,64,"PIM%sOilHash",pim->vrf->name);pim->channel_oil_h
ash=hash_create_size(8192,pim_oil_hash_key,pim_oil_equal,hash_name);pim->channel
_oil_list=list_new();if(!pim->channel_oil_list){zlog_err("%s%s:failure:channel_o
il_list=list_new()",__FILE__,__PRETTY_FUNCTION__);return;}pim->channel_oil_list-
>del=(void(*)(void*))pim_channel_oil_free;pim->channel_oil_list->cmp=(int(*)(voi
d*,void*))pim_channel_oil_compare;}voidpim_oil_terminate(structpim_instance*pim)
{if(pim->channel_oil_list)list_delete_and_null(&pim->channel_oil_list);if(pim->c
hannel_oil_hash)hash_free(pim->channel_oil_hash);pim->channel_oil_hash=NULL;}voi
dpim_channel_oil_free(structchannel_oil*c_oil){XFREE(MTYPE_PIM_CHANNEL_OIL,c_oil
);}structchannel_oil*pim_find_channel_oil(structpim_instance*pim,structprefix_sg
*sg){structchannel_oil*c_oil=NULL;structchannel_oillookup;lookup.oil.mfcc_mcastg
rp=sg->grp;lookup.oil.mfcc_origin=sg->src;c_oil=hash_lookup(pim->channel_oil_has
h,&lookup);returnc_oil;}structchannel_oil*pim_channel_oil_add(structpim_instance
*pim,structprefix_sg*sg,intinput_vif_index){structchannel_oil*c_oil;structinterf
ace*ifp;c_oil=pim_find_channel_oil(pim,sg);if(c_oil){if(c_oil->oil.mfcc_parent!=
input_vif_index){c_oil->oil_inherited_rescan=1;if(PIM_DEBUG_MROUTE)zlog_debug("%
s:Existingchanneloil%spointsto%d,modifyingtopointat%d",__PRETTY_FUNCTION__,pim_s
tr_sg_dump(sg),c_oil->oil.mfcc_parent,input_vif_index);}c_oil->oil.mfcc_parent=i
nput_vif_index;++c_oil->oil_ref_count;c_oil->up=pim_upstream_find(pim,sg);//chan
nelmightbepresentpriortoupstreamreturnc_oil;}ifp=pim_if_find_by_vif_index(pim,in
put_vif_index);if(!ifp){/*warningonly*/zlog_warn("%s:(S,G)=%scouldnotfindinputin
terfaceforinput_vif_index=%d",__PRETTY_FUNCTION__,pim_str_sg_dump(sg),input_vif_
index);}c_oil=XCALLOC(MTYPE_PIM_CHANNEL_OIL,sizeof(*c_oil));if(!c_oil){zlog_err(
"PIMXCALLOC(%zu)failure",sizeof(*c_oil));returnNULL;}c_oil->oil.mfcc_mcastgrp=sg
->grp;c_oil->oil.mfcc_origin=sg->src;c_oil=hash_get(pim->channel_oil_hash,c_oil,
hash_alloc_intern);c_oil->oil.mfcc_parent=input_vif_index;c_oil->oil_ref_count=1
;c_oil->installed=0;c_oil->up=pim_upstream_find(pim,sg);c_oil->pim=pim;listnode_
add_sort(pim->channel_oil_list,c_oil);returnc_oil;}voidpim_channel_oil_del(struc
tchannel_oil*c_oil){--c_oil->oil_ref_count;if(c_oil->oil_ref_count<1){/**noticet
hatlistnode_delete()can'tbemoved*intopim_channel_oil_free()becausethelateris*cal
ledbylist_delete_all_node()*/c_oil->up=NULL;listnode_delete(c_oil->pim->channel_
oil_list,c_oil);hash_release(c_oil->pim->channel_oil_hash,c_oil);pim_channel_oil
_free(c_oil);}}intpim_channel_del_oif(structchannel_oil*channel_oil,structinterf
ace*oif,uint32_tproto_mask){structpim_interface*pim_ifp;zassert(channel_oil);zas
sert(oif);pim_ifp=oif->info;/**Don'tdoanythingifwe'vebeenaskedtoremoveasource*th
atisnotactuallyonit.*/if(!(channel_oil->oif_flags[pim_ifp->mroute_vif_index]&pro
to_mask)){if(PIM_DEBUG_MROUTE){chargroup_str[INET_ADDRSTRLEN];charsource_str[INE
T_ADDRSTRLEN];pim_inet4_dump("<group?>",channel_oil->oil.mfcc_mcastgrp,group_str
,sizeof(group_str));pim_inet4_dump("<source?>",channel_oil->oil.mfcc_origin,sour
ce_str,sizeof(source_str));zlog_debug("%s%s:noexistingprotocolmask%u(%u)forreque
stedOIF%s(vif_index=%d,min_ttl=%d)forchannel(S,G)=(%s,%s)",__FILE__,__PRETTY_FUN
CTION__,proto_mask,channel_oil->oif_flags[pim_ifp->mroute_vif_index],oif->name,p
im_ifp->mroute_vif_index,channel_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index],s
ource_str,group_str);}return0;}channel_oil->oif_flags[pim_ifp->mroute_vif_index]
&=~proto_mask;if(channel_oil->oif_flags[pim_ifp->mroute_vif_index]){if(PIM_DEBUG
_MROUTE){chargroup_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet
4_dump("<group?>",channel_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str));pi
m_inet4_dump("<source?>",channel_oil->oil.mfcc_origin,source_str,sizeof(source_s
tr));zlog_debug("%s%s:otherprotocolmasksremainforrequestedOIF%s(vif_index=%d,min
_ttl=%d)forchannel(S,G)=(%s,%s)",__FILE__,__PRETTY_FUNCTION__,oif->name,pim_ifp-
>mroute_vif_index,channel_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index],source_s
tr,group_str);}return0;}channel_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index]=0;
if(pim_mroute_add(channel_oil,__PRETTY_FUNCTION__)){if(PIM_DEBUG_MROUTE){chargro
up_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>
",channel_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_inet4_dump("<s
ource?>",channel_oil->oil.mfcc_origin,source_str,sizeof(source_str));zlog_debug(
"%s%s:couldnotremoveoutputinterface%s(vif_index=%d)forchannel(S,G)=(%s,%s)",__FI
LE__,__PRETTY_FUNCTION__,oif->name,pim_ifp->mroute_vif_index,source_str,group_st
r);}return-1;}--channel_oil->oil_size;if(PIM_DEBUG_MROUTE){chargroup_str[INET_AD
DRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",channel_oil-
>oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_inet4_dump("<source?>",chann
el_oil->oil.mfcc_origin,source_str,sizeof(source_str));zlog_debug("%s%s:(S,G)=(%
s,%s):proto_mask=%uIIF:%dOIF=%svif_index=%d",__FILE__,__PRETTY_FUNCTION__,source
_str,group_str,proto_mask,channel_oil->oil.mfcc_parent,oif->name,pim_ifp->mroute
_vif_index);}return0;}intpim_channel_add_oif(structchannel_oil*channel_oil,struc
tinterface*oif,uint32_tproto_mask){structpim_interface*pim_ifp;intold_ttl;/**Ifw
e'vegottenherewe'vegonebad,butlet's*nottakedownpim*/if(!channel_oil){zlog_warn("
AttempttoAddOIFfornon-existentchanneloil");return-1;}pim_ifp=oif->info;#ifdefPIM
_ENFORCE_LOOPFREE_MFC/*PreventcreatingMFCentrywithOIF=IIF.Thisisaprotectionagain
stimplementationmistakes.PIMprotocolimplicitelyensuresloopfreemulticasttopology.
IGMPmustbeprotectedagainstaddingloopedMFCentriescreatedbybothsourceandreceiverat
tachedtothesameinterface.SeeTODOT22.*/if(pim_ifp->mroute_vif_index==channel_oil-
>oil.mfcc_parent){channel_oil->oil_inherited_rescan=1;if(PIM_DEBUG_MROUTE){charg
roup_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<group
?>",channel_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_inet4_dump("
<source?>",channel_oil->oil.mfcc_origin,source_str,sizeof(source_str));zlog_debu
g("%s%s:refusingprotocolmask%urequestforIIF=OIF=%s(vif_index=%d)forchannel(S,G)=
(%s,%s)",__FILE__,__PRETTY_FUNCTION__,proto_mask,oif->name,pim_ifp->mroute_vif_i
ndex,source_str,group_str);}return-2;}#endif/*Preventsingleprotocolfromsubscribi
ngsameinterfacetochannel(S,G)multipletimes*/if(channel_oil->oif_flags[pim_ifp->m
route_vif_index]&proto_mask){if(PIM_DEBUG_MROUTE){chargroup_str[INET_ADDRSTRLEN]
;charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",channel_oil->oil.mfcc
_mcastgrp,group_str,sizeof(group_str));pim_inet4_dump("<source?>",channel_oil->o
il.mfcc_origin,source_str,sizeof(source_str));zlog_debug("%s%s:existingprotocolm
ask%urequestedOIF%s(vif_index=%d,min_ttl=%d)forchannel(S,G)=(%s,%s)",__FILE__,__
PRETTY_FUNCTION__,proto_mask,oif->name,pim_ifp->mroute_vif_index,channel_oil->oi
l.mfcc_ttls[pim_ifp->mroute_vif_index],source_str,group_str);}return-3;}/*Allowo
therprotocoltorequestsubscriptionofsameinterfaceto*channel(S,G),weneedtonotethis
information*/if(channel_oil->oif_flags[pim_ifp->mroute_vif_index]&PIM_OIF_FLAG_P
ROTO_ANY){channel_oil->oif_creation[pim_ifp->mroute_vif_index]=pim_time_monotoni
c_sec();channel_oil->oif_flags[pim_ifp->mroute_vif_index]|=proto_mask;/*Checkthe
OIFreallyexistsbeforereturning,andonlylogwarningotherwise*/if(channel_oil->oil.m
fcc_ttls[pim_ifp->mroute_vif_index]<1){{chargroup_str[INET_ADDRSTRLEN];charsourc
e_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",channel_oil->oil.mfcc_mcastgrp,
group_str,sizeof(group_str));pim_inet4_dump("<source?>",channel_oil->oil.mfcc_or
igin,source_str,sizeof(source_str));zlog_warn("%s%s:newprotocolmask%urequestedno
nexistentOIF%s(vif_index=%d,min_ttl=%d)forchannel(S,G)=(%s,%s)",__FILE__,__PRETT
Y_FUNCTION__,proto_mask,oif->name,pim_ifp->mroute_vif_index,channel_oil->oil.mfc
c_ttls[pim_ifp->mroute_vif_index],source_str,group_str);}}return0;}old_ttl=chann
el_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index];if(old_ttl>0){if(PIM_DEBUG_MROU
TE){chargroup_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_dum
p("<group?>",channel_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_ine
t4_dump("<source?>",channel_oil->oil.mfcc_origin,source_str,sizeof(source_str));
zlog_debug("%s%s:interface%s(vif_index=%d)isexistingoutputforchannel(S,G)=(%s,%s
)",__FILE__,__PRETTY_FUNCTION__,oif->name,pim_ifp->mroute_vif_index,source_str,g
roup_str);}return-4;}channel_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index]=PIM_M
ROUTE_MIN_TTL;if(pim_mroute_add(channel_oil,__PRETTY_FUNCTION__)){if(PIM_DEBUG_M
ROUTE){chargroup_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_
dump("<group?>",channel_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_
inet4_dump("<source?>",channel_oil->oil.mfcc_origin,source_str,sizeof(source_str
));zlog_debug("%s%s:couldnotaddoutputinterface%s(vif_index=%d)forchannel(S,G)=(%
s,%s)",__FILE__,__PRETTY_FUNCTION__,oif->name,pim_ifp->mroute_vif_index,source_s
tr,group_str);}channel_oil->oil.mfcc_ttls[pim_ifp->mroute_vif_index]=old_ttl;ret
urn-5;}channel_oil->oif_creation[pim_ifp->mroute_vif_index]=pim_time_monotonic_s
ec();++channel_oil->oil_size;channel_oil->oif_flags[pim_ifp->mroute_vif_index]|=
proto_mask;if(PIM_DEBUG_MROUTE){chargroup_str[INET_ADDRSTRLEN];charsource_str[IN
ET_ADDRSTRLEN];pim_inet4_dump("<group?>",channel_oil->oil.mfcc_mcastgrp,group_st
r,sizeof(group_str));pim_inet4_dump("<source?>",channel_oil->oil.mfcc_origin,sou
rce_str,sizeof(source_str));zlog_debug("%s%s:(S,G)=(%s,%s):proto_mask=%uOIF=%svi
f_index=%d:DONE",__FILE__,__PRETTY_FUNCTION__,source_str,group_str,proto_mask,oi
f->name,pim_ifp->mroute_vif_index);}return0;}intpim_channel_oil_empty(structchan
nel_oil*c_oil){staticuint32_tzero[MAXVIFS];staticintinited=0;if(!c_oil)return1;/
**Notsurethatthisisnecessary,butIwouldratherensure*thatthisworks.*/if(!inited){m
emset(&zero,0,sizeof(uint32_t)*MAXVIFS);inited=1;}return!memcmp(c_oil->oif_flags
,zero,MAXVIFS*sizeof(uint32_t));}