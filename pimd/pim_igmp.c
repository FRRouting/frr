/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"memory.h"#include"prefix.h"#include"if.h"#includ
e"hash.h"#include"jhash.h"#include"pimd.h"#include"pim_igmp.h"#include"pim_igmpv
2.h"#include"pim_igmpv3.h"#include"pim_igmp_mtrace.h"#include"pim_iface.h"#inclu
de"pim_sock.h"#include"pim_mroute.h"#include"pim_str.h"#include"pim_util.h"#incl
ude"pim_time.h"#include"pim_zebra.h"staticvoidgroup_timer_off(structigmp_group*g
roup);staticintpim_igmp_general_query(structthread*t);/*ThissocketisusedforTXing
IGMPpacketsonly,IGMPRXhappens*inpim_mroute_msg()*/staticintigmp_sock_open(struct
in_addrifaddr,structinterface*ifp,uint32_tpim_options){intfd;intjoin=0;structin_
addrgroup;fd=pim_socket_mcast(IPPROTO_IGMP,ifaddr,ifp,1);if(fd<0)return-1;if(PIM
_IF_TEST_IGMP_LISTEN_ALLROUTERS(pim_options)){if(inet_aton(PIM_ALL_ROUTERS,&grou
p)){if(!pim_socket_join(fd,group,ifaddr,ifp->ifindex))++join;}else{zlog_warn("%s
%s:IGMPsocketfd=%dinterface%s:couldnotsolve%stogroupaddress:errno=%d:%s",__FILE_
_,__PRETTY_FUNCTION__,fd,inet_ntoa(ifaddr),PIM_ALL_ROUTERS,errno,safe_strerror(e
rrno));}}/*IGMProutersperiodicallysendIGMPgeneralqueriestoAllSystems=224.0.0.1IG
MProutersmustreceivegeneralqueriesforquerierelection.*/if(inet_aton(PIM_ALL_SYST
EMS,&group)){if(!pim_socket_join(fd,group,ifaddr,ifp->ifindex))++join;}else{zlog
_warn("%s%s:IGMPsocketfd=%dinterface%s:couldnotsolve%stogroupaddress:errno=%d:%s
",__FILE__,__PRETTY_FUNCTION__,fd,inet_ntoa(ifaddr),PIM_ALL_SYSTEMS,errno,safe_s
trerror(errno));}if(inet_aton(PIM_ALL_IGMP_ROUTERS,&group)){if(!pim_socket_join(
fd,group,ifaddr,ifp->ifindex)){++join;}}else{zlog_warn("%s%s:IGMPsocketfd=%dinte
rface%s:couldnotsolve%stogroupaddress:errno=%d:%s",__FILE__,__PRETTY_FUNCTION__,
fd,inet_ntoa(ifaddr),PIM_ALL_IGMP_ROUTERS,errno,safe_strerror(errno));}if(!join)
{zlog_err("IGMPsocketfd=%dcouldnotjoinanygrouponinterfaceaddress%s",fd,inet_ntoa
(ifaddr));close(fd);fd=-1;}returnfd;}#undefIGMP_SOCK_DUMP#ifdefIGMP_SOCK_DUMPsta
ticvoidigmp_sock_dump(array_t*igmp_sock_array){intsize=array_size(igmp_sock_arra
y);for(inti=0;i<size;++i){structigmp_sock*igmp=array_get(igmp_sock_array,i);zlog
_debug("%s%s:[%d/%d]igmp_addr=%sfd=%d",__FILE__,__PRETTY_FUNCTION__,i,size,inet_
ntoa(igmp->ifaddr),igmp->fd);}}#endifstructigmp_sock*pim_igmp_sock_lookup_ifaddr
(structlist*igmp_sock_list,structin_addrifaddr){structlistnode*sock_node;structi
gmp_sock*igmp;#ifdefIGMP_SOCK_DUMPigmp_sock_dump(igmp_sock_list);#endiffor(ALL_L
IST_ELEMENTS_RO(igmp_sock_list,sock_node,igmp))if(ifaddr.s_addr==igmp->ifaddr.s_
addr)returnigmp;return0;}structigmp_sock*igmp_sock_lookup_by_fd(structlist*igmp_
sock_list,intfd){structlistnode*sock_node;structigmp_sock*igmp;for(ALL_LIST_ELEM
ENTS_RO(igmp_sock_list,sock_node,igmp))if(fd==igmp->fd)returnigmp;return0;}stati
cintpim_igmp_other_querier_expire(structthread*t){structigmp_sock*igmp;igmp=THRE
AD_ARG(t);zassert(!igmp->t_igmp_query_timer);if(PIM_DEBUG_IGMP_TRACE){charifaddr
_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(
ifaddr_str));zlog_debug("%s:Querier%sresuming",__PRETTY_FUNCTION__,ifaddr_str);}
/*Wearethecurrentquerier,thenre-startsendinggeneralqueries.RFC2236-sec7OtherQuer
ierpresenttimerexpired(SendGeneralQuery,SetGen.Query.timer)*/pim_igmp_general_qu
ery(t);return0;}voidpim_igmp_other_querier_timer_on(structigmp_sock*igmp){longot
her_querier_present_interval_msec;structpim_interface*pim_ifp;zassert(igmp);zass
ert(igmp->interface);zassert(igmp->interface->info);pim_ifp=igmp->interface->inf
o;if(igmp->t_other_querier_timer){/*Thereisotherquerierpresentalready,thenresett
heother-querier-presenttimer.*/if(PIM_DEBUG_IGMP_TRACE){charifaddr_str[INET_ADDR
STRLEN];pim_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));z
log_debug("Querier%sresettingTIMEReventforOther-Querier-Present",ifaddr_str);}TH
READ_OFF(igmp->t_other_querier_timer);}else{/*Wearethecurrentquerier,thenstopsen
dinggeneralqueries:igmp->t_igmp_query_timer=NULL;*/pim_igmp_general_query_off(ig
mp);}/*Sincethissocketisstartingtheother-querier-presenttimer,thereshouldnotbepe
riodicquerytimerforthissocket.*/zassert(!igmp->t_igmp_query_timer);/*RFC3376:8.5
.OtherQuerierPresentIntervalTheOtherQuerierPresentIntervalisthelengthoftimethatm
ustpassbeforeamulticastrouterdecidesthatthereisnolongeranothermulticastrouterwhi
chshouldbethequerier.ThisvalueMUSTbe((theRobustnessVariable)times(theQueryInterv
al))plus(onehalfofoneQueryResponseInterval).other_querier_present_interval_msec=
\igmp->querier_robustness_variable*\1000*igmp->querier_query_interval+\100*(pim_
ifp->query_max_response_time_dsec>>1);*/other_querier_present_interval_msec=PIM_
IGMP_OQPI_MSEC(igmp->querier_robustness_variable,igmp->querier_query_interval,pi
m_ifp->igmp_query_max_response_time_dsec);if(PIM_DEBUG_IGMP_TRACE){charifaddr_st
r[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifa
ddr_str));zlog_debug("Querier%sscheduling%ld.%03ldsecTIMEReventforOther-Querier-
Present",ifaddr_str,other_querier_present_interval_msec/1000,other_querier_prese
nt_interval_msec%1000);}thread_add_timer_msec(master,pim_igmp_other_querier_expi
re,igmp,other_querier_present_interval_msec,&igmp->t_other_querier_timer);}voidp
im_igmp_other_querier_timer_off(structigmp_sock*igmp){zassert(igmp);if(PIM_DEBUG
_IGMP_TRACE){if(igmp->t_other_querier_timer){charifaddr_str[INET_ADDRSTRLEN];pim
_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));zlog_debug("
IGMPquerier%sfd=%dcancellingother-querier-presentTIMEReventon%s",ifaddr_str,igmp
->fd,igmp->interface->name);}}THREAD_OFF(igmp->t_other_querier_timer);}staticint
igmp_recv_query(structigmp_sock*igmp,intquery_version,intmax_resp_code,structin_
addrfrom,constchar*from_str,char*igmp_msg,intigmp_msg_len){structinterface*ifp;s
tructpim_interface*pim_ifp;structin_addrgroup_addr;uint16_trecv_checksum;uint16_
tchecksum;if(igmp->mtrace_only)return0;memcpy(&group_addr,igmp_msg+4,sizeof(stru
ctin_addr));ifp=igmp->interface;pim_ifp=ifp->info;recv_checksum=*(uint16_t*)(igm
p_msg+IGMP_CHECKSUM_OFFSET);/*forcomputingchecksum*/*(uint16_t*)(igmp_msg+IGMP_C
HECKSUM_OFFSET)=0;checksum=in_cksum(igmp_msg,igmp_msg_len);if(checksum!=recv_che
cksum){zlog_warn("RecvIGMPqueryv%dfrom%son%s:checksummismatch:received=%xcompute
d=%x",query_version,from_str,ifp->name,recv_checksum,checksum);return-1;}/**RFC3
376definessomeguidelinesonoperatinginbackwards*compatibilitywitholderversionsofI
GMPbuttherearesomegapsin*thelogic:**-oncewedropfromsayversion3toversion2wewillne
vergoback*toversion3evenifthenodethatTXedanIGMPv2queryupgrades*tov3**-Thenodewit
hthelowestIPisthequeriersowewillonlyknowto*dropfromv3tov2ifthenodethatisthequeri
erisalsotheone*thatisrunningigmpv2.Ifanon-querieronlysupportsigmpv2*wewillhaveno
wayofknowing.**Fornowwewillsimplifythingsandinformtheuserthattheyneedto*configur
eallPIMrouterstousethesameversionofIGMP.*/if(query_version!=pim_ifp->igmp_versio
n){zlog_warn("RecvIGMPqueryv%dfrom%son%sbutweareusingv%d,please""configureallPIM
routersonthissubnettousethesame""IGMPversion",query_version,from_str,ifp->name,p
im_ifp->igmp_version);return0;}if(PIM_DEBUG_IGMP_PACKETS){chargroup_str[INET_ADD
RSTRLEN];pim_inet4_dump("<group?>",group_addr,group_str,sizeof(group_str));zlog_
debug("RecvIGMPqueryv%dfrom%son%sforgroup%s",query_version,from_str,ifp->name,gr
oup_str);}/*RFC3376:6.6.2.QuerierElectionWhenarouterreceivesaquerywithalowerIPad
dress,itsetstheOther-Querier-PresenttimertoOtherQuerierPresentIntervalandceasest
osendqueriesonthenetworkifitwasthepreviouslyelectedquerier.*/if(ntohl(from.s_add
r)<ntohl(igmp->ifaddr.s_addr)){if(PIM_DEBUG_IGMP_TRACE){charifaddr_str[INET_ADDR
STRLEN];pim_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));z
log_debug("%s:localaddress%s(%u)lostquerierelectionto%s(%u)",ifp->name,ifaddr_st
r,ntohl(igmp->ifaddr.s_addr),from_str,ntohl(from.s_addr));}pim_igmp_other_querie
r_timer_on(igmp);}/*IGMPversion3istheonlyonewhereweprocesstheRXedquery*/if(query
_version==3){igmp_v3_recv_query(igmp,from_str,igmp_msg);}return0;}staticvoidon_t
race(constchar*label,structinterface*ifp,structin_addrfrom){if(PIM_DEBUG_IGMP_TR
ACE){charfrom_str[INET_ADDRSTRLEN];pim_inet4_dump("<from?>",from,from_str,sizeof
(from_str));zlog_debug("%s:from%son%s",label,from_str,ifp->name);}}staticintigmp
_v1_recv_report(structigmp_sock*igmp,structin_addrfrom,constchar*from_str,char*i
gmp_msg,intigmp_msg_len){structinterface*ifp=igmp->interface;structigmp_group*gr
oup;structin_addrgroup_addr;on_trace(__PRETTY_FUNCTION__,igmp->interface,from);i
f(igmp->mtrace_only)return0;if(igmp_msg_len!=IGMP_V12_MSG_SIZE){zlog_warn("RecvI
GMPreportv1from%son%s:size=%dotherthancorrect=%d",from_str,ifp->name,igmp_msg_le
n,IGMP_V12_MSG_SIZE);return-1;}if(PIM_DEBUG_IGMP_TRACE){zlog_warn("%s%s:FIXMEWRI
TEME",__FILE__,__PRETTY_FUNCTION__);}memcpy(&group_addr,igmp_msg+4,sizeof(struct
in_addr));if(pim_is_group_filtered(ifp->info,&group_addr))return-1;/*non-existan
tgroupiscreatedasINCLUDE{empty}*/group=igmp_add_group_by_addr(igmp,group_addr);i
f(!group){return-1;}group->last_igmp_v1_report_dsec=pim_time_monotonic_dsec();re
turn0;}intpim_igmp_packet(structigmp_sock*igmp,char*buf,size_tlen){structip*ip_h
dr;size_tip_hlen;/*ipheaderlengthinbytes*/char*igmp_msg;intigmp_msg_len;intmsg_t
ype;charfrom_str[INET_ADDRSTRLEN];charto_str[INET_ADDRSTRLEN];if(len<sizeof(*ip_
hdr)){zlog_warn("IGMPpacketsize=%zushorterthanminimum=%zu",len,sizeof(*ip_hdr));
return-1;}ip_hdr=(structip*)buf;pim_inet4_dump("<src?>",ip_hdr->ip_src,from_str,
sizeof(from_str));pim_inet4_dump("<dst?>",ip_hdr->ip_dst,to_str,sizeof(to_str));
ip_hlen=ip_hdr->ip_hl<<2;/*ip_hlgiveslengthin4-bytewords*/if(PIM_DEBUG_IGMP_PACK
ETS){zlog_debug("RecvIPpacketfrom%sto%son%s:size=%zuip_header_size=%zuip_proto=%
d",from_str,to_str,igmp->interface->name,len,ip_hlen,ip_hdr->ip_p);}igmp_msg=buf
+ip_hlen;msg_type=*igmp_msg;igmp_msg_len=len-ip_hlen;if(PIM_DEBUG_IGMP_PACKETS){
zlog_debug("RecvIGMPpacketfrom%sto%son%s:ttl=%dmsg_type=%dmsg_size=%d",from_str,
to_str,igmp->interface->name,ip_hdr->ip_ttl,msg_type,igmp_msg_len);}if(igmp_msg_
len<PIM_IGMP_MIN_LEN){zlog_warn("IGMPmessagesize=%dshorterthanminimum=%d",igmp_m
sg_len,PIM_IGMP_MIN_LEN);return-1;}switch(msg_type){casePIM_IGMP_MEMBERSHIP_QUER
Y:{intmax_resp_code=igmp_msg[1];intquery_version;/*RFC3376:7.1.QueryVersionDisti
nctionsIGMPv1Query:length=8octetsANDMaxRespCodefieldiszeroIGMPv2Query:length=8oc
tetsANDMaxRespCodefieldisnon-zeroIGMPv3Query:length>=12octets*/if(igmp_msg_len==
8){query_version=max_resp_code?2:1;}elseif(igmp_msg_len>=12){query_version=3;}el
se{zlog_warn("UnknownIGMPqueryversion");return-1;}returnigmp_recv_query(igmp,que
ry_version,max_resp_code,ip_hdr->ip_src,from_str,igmp_msg,igmp_msg_len);}casePIM
_IGMP_V3_MEMBERSHIP_REPORT:returnigmp_v3_recv_report(igmp,ip_hdr->ip_src,from_st
r,igmp_msg,igmp_msg_len);casePIM_IGMP_V2_MEMBERSHIP_REPORT:returnigmp_v2_recv_re
port(igmp,ip_hdr->ip_src,from_str,igmp_msg,igmp_msg_len);casePIM_IGMP_V1_MEMBERS
HIP_REPORT:returnigmp_v1_recv_report(igmp,ip_hdr->ip_src,from_str,igmp_msg,igmp_
msg_len);casePIM_IGMP_V2_LEAVE_GROUP:returnigmp_v2_recv_leave(igmp,ip_hdr->ip_sr
c,from_str,igmp_msg,igmp_msg_len);casePIM_IGMP_MTRACE_RESPONSE:returnigmp_mtrace
_recv_response(igmp,ip_hdr,ip_hdr->ip_src,from_str,igmp_msg,igmp_msg_len);casePI
M_IGMP_MTRACE_QUERY_REQUEST:returnigmp_mtrace_recv_qry_req(igmp,ip_hdr,ip_hdr->i
p_src,from_str,igmp_msg,igmp_msg_len);}zlog_warn("IgnoringunsupportedIGMPmessage
type:%d",msg_type);return-1;}voidpim_igmp_general_query_on(structigmp_sock*igmp)
{structpim_interface*pim_ifp;intstartup_mode;intquery_interval;/*Sincethissocket
isstartingasquerier,thereshouldnotexistatimerforother-querier-present.*/zassert(
!igmp->t_other_querier_timer);pim_ifp=igmp->interface->info;zassert(pim_ifp);/*R
FC3376:8.6.StartupQueryIntervalTheStartupQueryIntervalistheintervalbetweenGenera
lQueriessentbyaQuerieronstartup.Default:1/4theQueryInterval.Thefirstoneshouldbes
entoutimmediatelyinsteadof125/4secondsfromnow.*/startup_mode=igmp->startup_query
_count>0;if(startup_mode){/**Ifthisisthefirsttimewearesendingaqueryona*newlyconf
iguredigmpinterfacesenditoutin1second*justtogivetheentireworldatinybitoftimetose
ttle*elsethequeryintervalis:*query_interval=pim_ifp->igmp_default_query_interval
>>2;*/if(igmp->startup_query_count==igmp->querier_robustness_variable)query_inte
rval=1;elsequery_interval=PIM_IGMP_SQI(pim_ifp->igmp_default_query_interval);--i
gmp->startup_query_count;}else{query_interval=igmp->querier_query_interval;}if(P
IM_DEBUG_IGMP_TRACE){charifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",
igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));zlog_debug("Querier%sscheduling%d-se
cond(%s)TIMEReventforIGMPqueryonfd=%d",ifaddr_str,query_interval,startup_mode?"s
tartup":"non-startup",igmp->fd);}igmp->t_igmp_query_timer=NULL;thread_add_timer(
master,pim_igmp_general_query,igmp,query_interval,&igmp->t_igmp_query_timer);}vo
idpim_igmp_general_query_off(structigmp_sock*igmp){zassert(igmp);if(PIM_DEBUG_IG
MP_TRACE){if(igmp->t_igmp_query_timer){charifaddr_str[INET_ADDRSTRLEN];pim_inet4
_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));zlog_debug("IGMPqu
erier%sfd=%dcancellingqueryTIMEReventon%s",ifaddr_str,igmp->fd,igmp->interface->
name);}}THREAD_OFF(igmp->t_igmp_query_timer);}/*IssueIGMPgeneralquery*/staticint
pim_igmp_general_query(structthread*t){structigmp_sock*igmp;structin_addrdst_add
r;structin_addrgroup_addr;structpim_interface*pim_ifp;intquery_buf_size;igmp=THR
EAD_ARG(t);zassert(igmp->interface);zassert(igmp->interface->info);pim_ifp=igmp-
>interface->info;if(pim_ifp->igmp_version==3){query_buf_size=PIM_IGMP_BUFSIZE_WR
ITE;}else{query_buf_size=IGMP_V12_MSG_SIZE;}charquery_buf[query_buf_size];/*RFC3
376:4.1.12.IPDestinationAddressesforQueriesInIGMPv3,GeneralQueriesaresentwithanI
Pdestinationaddressof224.0.0.1,theall-systemsmulticastaddress.Group-SpecificandG
roup-and-Source-SpecificQueriesaresentwithanIPdestinationaddressequaltothemultic
astaddressofinterest.*/dst_addr.s_addr=htonl(INADDR_ALLHOSTS_GROUP);group_addr.s
_addr=PIM_NET_INADDR_ANY;if(PIM_DEBUG_IGMP_TRACE){charquerier_str[INET_ADDRSTRLE
N];chardst_str[INET_ADDRSTRLEN];pim_inet4_dump("<querier?>",igmp->ifaddr,querier
_str,sizeof(querier_str));pim_inet4_dump("<dst?>",dst_addr,dst_str,sizeof(dst_st
r));zlog_debug("Querier%sissuingIGMPgeneralqueryto%son%s",querier_str,dst_str,ig
mp->interface->name);}igmp_send_query(pim_ifp->igmp_version,0/*igmp_group*/,igmp
->fd,igmp->interface->name,query_buf,sizeof(query_buf),0/*num_sources*/,dst_addr
,group_addr,pim_ifp->igmp_query_max_response_time_dsec,1/*s_flag:alwayssetforgen
eralqueries*/,igmp->querier_robustness_variable,igmp->querier_query_interval);pi
m_igmp_general_query_on(igmp);return0;}staticvoidsock_close(structigmp_sock*igmp
){pim_igmp_other_querier_timer_off(igmp);pim_igmp_general_query_off(igmp);if(PIM
_DEBUG_IGMP_TRACE_DETAIL){if(igmp->t_igmp_read){zlog_debug("CancellingREADevento
nIGMPsocket%sfd=%doninterface%s",inet_ntoa(igmp->ifaddr),igmp->fd,igmp->interfac
e->name);}}THREAD_OFF(igmp->t_igmp_read);if(close(igmp->fd)){zlog_err("Failurecl
osingIGMPsocket%sfd=%doninterface%s:errno=%d:%s",inet_ntoa(igmp->ifaddr),igmp->f
d,igmp->interface->name,errno,safe_strerror(errno));}if(PIM_DEBUG_IGMP_TRACE_DET
AIL){zlog_debug("DeletedIGMPsocket%sfd=%doninterface%s",inet_ntoa(igmp->ifaddr),
igmp->fd,igmp->interface->name);}}voidigmp_startup_mode_on(structigmp_sock*igmp)
{structpim_interface*pim_ifp;pim_ifp=igmp->interface->info;/*RFC3376:8.7.Startup
QueryCountTheStartupQueryCountisthenumberofQueriessentoutonstartup,separatedbyth
eStartupQueryInterval.Default:theRobustnessVariable.*/igmp->startup_query_count=
igmp->querier_robustness_variable;/*Sincewe're(re)starting,resetQQItodefaultQuer
yInterval*/igmp->querier_query_interval=pim_ifp->igmp_default_query_interval;}st
aticvoidigmp_group_free(structigmp_group*group){list_delete_and_null(&group->gro
up_source_list);XFREE(MTYPE_PIM_IGMP_GROUP,group);}staticvoidigmp_group_delete(s
tructigmp_group*group){structlistnode*src_node;structlistnode*src_nextnode;struc
tigmp_source*src;if(PIM_DEBUG_IGMP_TRACE){chargroup_str[INET_ADDRSTRLEN];pim_ine
t4_dump("<group?>",group->group_addr,group_str,sizeof(group_str));zlog_debug("De
letingIGMPgroup%sfromsocket%dinterface%s",group_str,group->group_igmp_sock->fd,g
roup->group_igmp_sock->interface->name);}for(ALL_LIST_ELEMENTS(group->group_sour
ce_list,src_node,src_nextnode,src)){igmp_source_delete(src);}if(group->t_group_q
uery_retransmit_timer){THREAD_OFF(group->t_group_query_retransmit_timer);}group_
timer_off(group);listnode_delete(group->group_igmp_sock->igmp_group_list,group);
hash_release(group->group_igmp_sock->igmp_group_hash,group);igmp_group_free(grou
p);}voidigmp_group_delete_empty_include(structigmp_group*group){zassert(!group->
group_filtermode_isexcl);zassert(!listcount(group->group_source_list));igmp_grou
p_delete(group);}voidigmp_sock_free(structigmp_sock*igmp){zassert(!igmp->t_igmp_
read);zassert(!igmp->t_igmp_query_timer);zassert(!igmp->t_other_querier_timer);z
assert(igmp->igmp_group_list);zassert(!listcount(igmp->igmp_group_list));list_de
lete_and_null(&igmp->igmp_group_list);hash_free(igmp->igmp_group_hash);XFREE(MTY
PE_PIM_IGMP_SOCKET,igmp);}voidigmp_sock_delete(structigmp_sock*igmp){structpim_i
nterface*pim_ifp;structlistnode*grp_node;structlistnode*grp_nextnode;structigmp_
group*grp;for(ALL_LIST_ELEMENTS(igmp->igmp_group_list,grp_node,grp_nextnode,grp)
){igmp_group_delete(grp);}sock_close(igmp);pim_ifp=igmp->interface->info;listnod
e_delete(pim_ifp->igmp_socket_list,igmp);igmp_sock_free(igmp);}voidigmp_sock_del
ete_all(structinterface*ifp){structpim_interface*pim_ifp;structlistnode*igmp_nod
e,*igmp_nextnode;structigmp_sock*igmp;pim_ifp=ifp->info;for(ALL_LIST_ELEMENTS(pi
m_ifp->igmp_socket_list,igmp_node,igmp_nextnode,igmp)){igmp_sock_delete(igmp);}}
staticunsignedintigmp_group_hash_key(void*arg){structigmp_group*group=(structigm
p_group*)arg;returnjhash_1word(group->group_addr.s_addr,0);}staticintigmp_group_
hash_equal(constvoid*arg1,constvoid*arg2){conststructigmp_group*g1=(conststructi
gmp_group*)arg1;conststructigmp_group*g2=(conststructigmp_group*)arg2;if(g1->gro
up_addr.s_addr==g2->group_addr.s_addr)return1;return0;}staticstructigmp_sock*igm
p_sock_new(intfd,structin_addrifaddr,structinterface*ifp,intmtrace_only){structp
im_interface*pim_ifp;structigmp_sock*igmp;charhash_name[64];pim_ifp=ifp->info;if
(PIM_DEBUG_IGMP_TRACE){zlog_debug("CreatingIGMPsocketfd=%dforaddress%soninterfac
e%s",fd,inet_ntoa(ifaddr),ifp->name);}igmp=XCALLOC(MTYPE_PIM_IGMP_SOCKET,sizeof(
*igmp));if(!igmp){zlog_warn("%s%s:XCALLOC()failure",__FILE__,__PRETTY_FUNCTION__
);return0;}igmp->igmp_group_list=list_new();if(!igmp->igmp_group_list){zlog_err(
"%s%s:failure:igmp_group_list=list_new()",__FILE__,__PRETTY_FUNCTION__);return0;
}igmp->igmp_group_list->del=(void(*)(void*))igmp_group_free;snprintf(hash_name,6
4,"IGMP%shash",ifp->name);igmp->igmp_group_hash=hash_create(igmp_group_hash_key,
igmp_group_hash_equal,hash_name);igmp->fd=fd;igmp->interface=ifp;igmp->ifaddr=if
addr;igmp->t_igmp_read=NULL;igmp->t_igmp_query_timer=NULL;igmp->t_other_querier_
timer=NULL;/*nootherquerierpresent*/igmp->querier_robustness_variable=pim_ifp->i
gmp_default_robustness_variable;igmp->sock_creation=pim_time_monotonic_sec();if(
mtrace_only){igmp->mtrace_only=mtrace_only;returnigmp;}igmp->mtrace_only=false;/
*igmp_startup_mode_on()willresetQQI:igmp->querier_query_interval=pim_ifp->igmp_d
efault_query_interval;*/igmp_startup_mode_on(igmp);pim_igmp_general_query_on(igm
p);returnigmp;}staticvoidigmp_read_on(structigmp_sock*igmp);staticintpim_igmp_re
ad(structthread*t){uint8_tbuf[10000];structigmp_sock*igmp=(structigmp_sock*)THRE
AD_ARG(t);structsockaddr_infrom;structsockaddr_into;socklen_tfromlen=sizeof(from
);socklen_ttolen=sizeof(to);ifindex_tifindex=-1;intcont=1;intlen;while(cont){len
=pim_socket_recvfromto(igmp->fd,buf,sizeof(buf),&from,&fromlen,&to,&tolen,&ifind
ex);if(len<0){if(errno==EINTR)continue;if(errno==EWOULDBLOCK||errno==EAGAIN)brea
k;gotodone;}}done:igmp_read_on(igmp);return0;}staticvoidigmp_read_on(structigmp_
sock*igmp){if(PIM_DEBUG_IGMP_TRACE_DETAIL){zlog_debug("SchedulingREADeventonIGMP
socketfd=%d",igmp->fd);}igmp->t_igmp_read=NULL;thread_add_read(master,pim_igmp_r
ead,igmp,igmp->fd,&igmp->t_igmp_read);}structigmp_sock*pim_igmp_sock_add(structl
ist*igmp_sock_list,structin_addrifaddr,structinterface*ifp,boolmtrace_only){stru
ctpim_interface*pim_ifp;structigmp_sock*igmp;intfd;pim_ifp=ifp->info;fd=igmp_soc
k_open(ifaddr,ifp,pim_ifp->options);if(fd<0){zlog_warn("CouldnotopenIGMPsocketfo
r%son%s",inet_ntoa(ifaddr),ifp->name);return0;}igmp=igmp_sock_new(fd,ifaddr,ifp,
mtrace_only);if(!igmp){zlog_err("%s%s:igmp_sock_new()failure",__FILE__,__PRETTY_
FUNCTION__);close(fd);return0;}igmp_read_on(igmp);listnode_add(igmp_sock_list,ig
mp);#ifdefIGMP_SOCK_DUMPigmp_sock_dump(igmp_sock_array);#endifreturnigmp;}/*RFC3
376:6.5.SwitchingRouterFilter-ModesWhenarouter'sfilter-modeforagroupisEXCLUDEand
thegrouptimerexpires,therouterfilter-modeforthegrouptransitionstoINCLUDE.Arouter
usessourcerecordswithrunningsourcetimersasitsstatefortheswitchtoafilter-modeofIN
CLUDE.Ifthereareanysourcerecordswithsourcetimersgreaterthanzero(i.e.,requestedto
beforwarded),arouterswitchestofilter-modeofINCLUDEusingthosesourcerecords.Source
recordswhosetimersarezero(fromthepreviousEXCLUDEmode)aredeleted.*/staticintigmp_
group_timer(structthread*t){structigmp_group*group;group=THREAD_ARG(t);if(PIM_DE
BUG_IGMP_TRACE){chargroup_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",group->
group_addr,group_str,sizeof(group_str));zlog_debug("%s:Timerforgroup%soninterfac
e%s",__PRETTY_FUNCTION__,group_str,group->group_igmp_sock->interface->name);}zas
sert(group->group_filtermode_isexcl);group->group_filtermode_isexcl=0;/*Anysourc
e(*,G)isforwardedonlyifmodeisEXCLUDE{empty}*/igmp_anysource_forward_stop(group);
igmp_source_delete_expired(group->group_source_list);zassert(!group->group_filte
rmode_isexcl);/*RFC3376:6.2.2.DefinitionofGroupTimersIftherearenomoresourcerecor
dsforthegroup,deletegrouprecord.*/if(listcount(group->group_source_list)<1){igmp
_group_delete_empty_include(group);}return0;}staticvoidgroup_timer_off(structigm
p_group*group){if(!group->t_group_timer)return;if(PIM_DEBUG_IGMP_TRACE){chargrou
p_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",group->group_addr,group_str,siz
eof(group_str));zlog_debug("CancellingTIMEReventforgroup%son%s",group_str,group-
>group_igmp_sock->interface->name);}THREAD_OFF(group->t_group_timer);}voidigmp_g
roup_timer_on(structigmp_group*group,longinterval_msec,constchar*ifname){group_t
imer_off(group);if(PIM_DEBUG_IGMP_EVENTS){chargroup_str[INET_ADDRSTRLEN];pim_ine
t4_dump("<group?>",group->group_addr,group_str,sizeof(group_str));zlog_debug("Sc
heduling%ld.%03ldsecTIMEReventforgroup%son%s",interval_msec/1000,interval_msec%1
000,group_str,ifname);}/*RFC3376:6.2.2.DefinitionofGroupTimersThegrouptimerisonl
yusedwhenagroupisinEXCLUDEmodeanditrepresentsthetimeforthe*filter-mode*ofthegrou
ptoexpireandswitchtoINCLUDEmode.*/zassert(group->group_filtermode_isexcl);thread
_add_timer_msec(master,igmp_group_timer,group,interval_msec,&group->t_group_time
r);}structigmp_group*find_group_by_addr(structigmp_sock*igmp,structin_addrgroup_
addr){structigmp_grouplookup;lookup.group_addr.s_addr=group_addr.s_addr;returnha
sh_lookup(igmp->igmp_group_hash,&lookup);}structigmp_group*igmp_add_group_by_add
r(structigmp_sock*igmp,structin_addrgroup_addr){structigmp_group*group;group=fin
d_group_by_addr(igmp,group_addr);if(group){returngroup;}if(!pim_is_group_224_4(g
roup_addr)){zlog_warn("%s:GroupSpecifiedisnotpartof224.0.0.0/4",__PRETTY_FUNCTIO
N__);returnNULL;}if(pim_is_group_224_0_0_0_24(group_addr)){zlog_warn("%s:Groupsp
ecifiedispartof224.0.0.0/24",__PRETTY_FUNCTION__);returnNULL;}/*Non-existantgrou
piscreatedasINCLUDE{empty}:RFC3376-5.1.ActiononChangeofInterfaceStateIfnointerfa
cestateexistedforthatmulticastaddressbeforethechange(i.e.,thechangeconsistedofcr
eatinganewper-interfacerecord),orifnostateexistsafterthechange(i.e.,thechangecon
sistedofdeletingaper-interfacerecord),thenthe"non-existent"stateisconsideredtoha
veafiltermodeofINCLUDEandanemptysourcelist.*/group=XCALLOC(MTYPE_PIM_IGMP_GROUP,
sizeof(*group));if(!group){zlog_warn("%s%s:XCALLOC()failure",__FILE__,__PRETTY_F
UNCTION__);returnNULL;/*error,notfound,couldnotcreate*/}group->group_source_list
=list_new();if(!group->group_source_list){zlog_warn("%s%s:list_new()failure",__F
ILE__,__PRETTY_FUNCTION__);XFREE(MTYPE_PIM_IGMP_GROUP,group);/*discardgroup*/ret
urnNULL;/*error,notfound,couldnotinitialize*/}group->group_source_list->del=(voi
d(*)(void*))igmp_source_free;group->t_group_timer=NULL;group->t_group_query_retr
ansmit_timer=NULL;group->group_specific_query_retransmit_count=0;group->group_ad
dr=group_addr;group->group_igmp_sock=igmp;group->last_igmp_v1_report_dsec=-1;gro
up->last_igmp_v2_report_dsec=-1;group->group_creation=pim_time_monotonic_sec();g
roup->igmp_version=IGMP_DEFAULT_VERSION;/*initializenewgroupasINCLUDE{empty}*/gr
oup->group_filtermode_isexcl=0;/*0=INCLUDE,1=EXCLUDE*/listnode_add(igmp->igmp_gr
oup_list,group);group=hash_get(igmp->igmp_group_hash,group,hash_alloc_intern);if
(PIM_DEBUG_IGMP_TRACE){chargroup_str[INET_ADDRSTRLEN];pim_inet4_dump("<group?>",
group->group_addr,group_str,sizeof(group_str));zlog_debug("CreatingnewIGMPgroup%
sonsocket%dinterface%s",group_str,igmp->fd,igmp->interface->name);}/*RFC3376:6.2
.2.DefinitionofGroupTimersThegrouptimerisonlyusedwhenagroupisinEXCLUDEmodeanditr
epresentsthetimeforthe*filter-mode*ofthegrouptoexpireandswitchtoINCLUDEmode.*/za
ssert(!group->group_filtermode_isexcl);/*INCLUDEmode*/zassert(!group->t_group_ti
mer);/*grouptimer==0*//*Anysource(*,G)isforwardedonlyifmodeisEXCLUDE{empty}*/igm
p_anysource_forward_stop(group);returngroup;}voidigmp_send_query(intigmp_version
,structigmp_group*group,intfd,constchar*ifname,char*query_buf,intquery_buf_size,
intnum_sources,structin_addrdst_addr,structin_addrgroup_addr,intquery_max_respon
se_time_dsec,uint8_ts_flag,uint8_tquerier_robustness_variable,uint16_tquerier_qu
ery_interval){if(igmp_version==3){igmp_v3_send_query(group,fd,ifname,query_buf,q
uery_buf_size,num_sources,dst_addr,group_addr,query_max_response_time_dsec,s_fla
g,querier_robustness_variable,querier_query_interval);}elseif(igmp_version==2){i
gmp_v2_send_query(group,fd,ifname,query_buf,dst_addr,group_addr,query_max_respon
se_time_dsec);}}