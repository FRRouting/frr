/**MulticasttracerouteforFRRouting*Copyright(C)2017MladenSablic**Thisprogramisfr
eesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublic
Licenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(at
youroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful
,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESS
FORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldha
vereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYI
NG;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,M
A02110-1301USA*/#include<zebra.h>#include"pimd.h"#include"pim_util.h"#include"pi
m_sock.h"#include"pim_rp.h"#include"pim_oil.h"#include"pim_ifchannel.h"#include"
pim_macro.h"#include"pim_igmp_mtrace.h"staticstructin_addrmtrace_primary_address
(structinterface*ifp){structconnected*ifc;structlistnode*node;structin_addrany;s
tructpim_interface*pim_ifp;if(ifp->info){pim_ifp=ifp->info;returnpim_ifp->primar
y_address;}any.s_addr=INADDR_ANY;for(ALL_LIST_ELEMENTS_RO(ifp->connected,node,if
c)){structprefix*p=ifc->address;if(p->family!=AF_INET)continue;if(!CHECK_FLAG(if
c->flags,ZEBRA_IFA_SECONDARY))returnp->u.prefix4;/*incasenoprimaryfound,returnas
econdary*/any=p->u.prefix4;}returnany;}staticvoidmtrace_rsp_init(structigmp_mtra
ce_rsp*mtrace_rspp){mtrace_rspp->arrival=0;mtrace_rspp->incoming.s_addr=0;mtrace
_rspp->outgoing.s_addr=0;mtrace_rspp->prev_hop.s_addr=0;mtrace_rspp->in_count=MT
RACE_UNKNOWN_COUNT;mtrace_rspp->out_count=MTRACE_UNKNOWN_COUNT;mtrace_rspp->tota
l=MTRACE_UNKNOWN_COUNT;mtrace_rspp->rtg_proto=0;mtrace_rspp->fwd_ttl=0;mtrace_rs
pp->mbz=0;mtrace_rspp->s=0;mtrace_rspp->src_mask=0;mtrace_rspp->fwd_code=MTRACE_
FWD_CODE_NO_ERROR;}staticvoidmtrace_rsp_debug(uint32_tqry_id,intrsp,structigmp_m
trace_rsp*mrspp){charinc_str[INET_ADDRSTRLEN];charout_str[INET_ADDRSTRLEN];charp
rv_str[INET_ADDRSTRLEN];zlog_debug("Rxmt(%d)qid=%udarr=%xin=%sout=%sprev=%sproto
=%dfwd=%d",rsp,ntohl(qry_id),mrspp->arrival,inet_ntop(AF_INET,&(mrspp->incoming)
,inc_str,sizeof(inc_str)),inet_ntop(AF_INET,&(mrspp->outgoing),out_str,sizeof(ou
t_str)),inet_ntop(AF_INET,&(mrspp->prev_hop),prv_str,sizeof(prv_str)),mrspp->rtg
_proto,mrspp->fwd_code);}staticvoidmtrace_debug(structpim_interface*pim_ifp,stru
ctigmp_mtrace*mtracep,intmtrace_len){charinc_str[INET_ADDRSTRLEN];chargrp_str[IN
ET_ADDRSTRLEN];charsrc_str[INET_ADDRSTRLEN];chardst_str[INET_ADDRSTRLEN];charrsp
_str[INET_ADDRSTRLEN];structin_addrga,sa,da,ra;ga=mtracep->grp_addr;sa=mtracep->
src_addr;da=mtracep->dst_addr;ra=mtracep->rsp_addr;zlog_debug("Rxmtracepacketinc
omingon%s:""hops=%dtype=%dsize=%d,grp=%s,src=%s,""dst=%srsp=%sttl=%dqid=%ud",ine
t_ntop(AF_INET,&(pim_ifp->primary_address),inc_str,sizeof(inc_str)),mtracep->hop
s,mtracep->type,mtrace_len,inet_ntop(AF_INET,&ga,grp_str,sizeof(grp_str)),inet_n
top(AF_INET,&sa,src_str,sizeof(src_str)),inet_ntop(AF_INET,&da,dst_str,sizeof(ds
t_str)),inet_ntop(AF_INET,&ra,rsp_str,sizeof(rsp_str)),mtracep->rsp_ttl,ntohl(mt
racep->qry_id));if(mtrace_len>(int)sizeof(structigmp_mtrace)){inti;intresponses=
mtrace_len-sizeof(structigmp_mtrace);if((responses%sizeof(structigmp_mtrace_rsp)
)!=0)if(PIM_DEBUG_MTRACE)zlog_debug("Mtraceresponseblockofwrong""length");respon
ses=responses/sizeof(structigmp_mtrace_rsp);for(i=0;i<responses;i++)mtrace_rsp_d
ebug(mtracep->qry_id,i,&mtracep->rsp[i]);}}/*5.1QueryArrivalTime*/staticuint32_t
query_arrival_time(void){structtimevaltv;uint32_tqat;charm_qat[]="Queryarrivalti
melookupfailed:errno=%d:%s";if(gettimeofday(&tv,NULL)<0){if(PIM_DEBUG_MTRACE)zlo
g_warn(m_qat,errno,safe_strerror(errno));return0;}/*notsuresecondoffsetcorrect,a
sIgetdifferentvalue*/qat=((tv.tv_sec+32384)<<16)+((tv.tv_usec<<10)/15625);return
qat;}staticintmtrace_send_packet(structinterface*ifp,structigmp_mtrace*mtracep,s
ize_tmtrace_buf_len,structin_addrdst_addr,structin_addrgroup_addr){structsockadd
r_into;socklen_ttolen;ssize_tsent;intret;intfd;charif_str[INET_ADDRSTRLEN];charr
sp_str[INET_ADDRSTRLEN];uint8_tttl;memset(&to,0,sizeof(to));to.sin_family=AF_INE
T;to.sin_addr=dst_addr;tolen=sizeof(to);if(PIM_DEBUG_MTRACE){structin_addrif_add
r;if_addr=mtrace_primary_address(ifp);zlog_debug("Sendingmtracepacketto%son%s",i
net_ntop(AF_INET,&mtracep->rsp_addr,rsp_str,sizeof(rsp_str)),inet_ntop(AF_INET,&
if_addr,if_str,sizeof(if_str)));}fd=pim_socket_raw(IPPROTO_IGMP);if(fd<0)return-
1;ret=pim_socket_bind(fd,ifp);if(ret<0){ret=-1;gotoclose_fd;}if(IPV4_CLASS_DE(nt
ohl(dst_addr.s_addr))){if(IPV4_MC_LINKLOCAL(ntohl(dst_addr.s_addr))){ttl=1;}else
{if(mtracep->type==PIM_IGMP_MTRACE_RESPONSE)ttl=mtracep->rsp_ttl;elsettl=64;}ret
=setsockopt(fd,IPPROTO_IP,IP_MULTICAST_TTL,&ttl,sizeof(ttl));if(ret<0){if(PIM_DE
BUG_MTRACE)zlog_warn("FailedtosetsocketmulticastTTL");ret=-1;gotoclose_fd;}}sent
=sendto(fd,(char*)mtracep,mtrace_buf_len,MSG_DONTWAIT,(structsockaddr*)&to,tolen
);if(sent!=(ssize_t)mtrace_buf_len){chardst_str[INET_ADDRSTRLEN];chargroup_str[I
NET_ADDRSTRLEN];pim_inet4_dump("<dst?>",dst_addr,dst_str,sizeof(dst_str));pim_in
et4_dump("<group?>",group_addr,group_str,sizeof(group_str));if(sent<0){if(PIM_DE
BUG_MTRACE)zlog_warn("Sendmtracerequestfailedfor%son""%s:group=%smsg_size=%zd:er
rno=%d:""%s",dst_str,ifp->name,group_str,mtrace_buf_len,errno,safe_strerror(errn
o));}else{if(PIM_DEBUG_MTRACE)zlog_warn("Sendmtracerequestfailedfor%son""%s:grou
p=%smsg_size=%zd:sent=%zd",dst_str,ifp->name,group_str,mtrace_buf_len,sent);}ret
=-1;gotoclose_fd;}ret=0;close_fd:close(fd);returnret;}staticintmtrace_un_forward
_packet(structpim_instance*pim,structip*ip_hdr,structinterface*interface){struct
pim_nexthopnexthop;structsockaddr_into;structinterface*if_out;socklen_ttolen;int
ret;intfd;intsent;uint16_tchecksum;checksum=ip_hdr->ip_sum;ip_hdr->ip_sum=0;if(c
hecksum!=in_cksum(ip_hdr,ip_hdr->ip_hl*4))return-1;if(ip_hdr->ip_ttl--<=1)return
-1;ip_hdr->ip_sum=in_cksum(ip_hdr,ip_hdr->ip_hl*4);fd=pim_socket_raw(IPPROTO_RAW
);if(fd<0)return-1;pim_socket_ip_hdr(fd);if(interface==NULL){memset(&nexthop,0,s
izeof(nexthop));ret=pim_nexthop_lookup(pim,&nexthop,ip_hdr->ip_dst,0);if(ret!=0)
{close(fd);if(PIM_DEBUG_MTRACE)zlog_warn("Droppingmtracepacket,""noroutetodestin
ation");return-1;}if_out=nexthop.interface;}else{if_out=interface;}ret=pim_socke
t_bind(fd,if_out);if(ret<0){close(fd);return-1;}memset(&to,0,sizeof(to));to.sin_
family=AF_INET;to.sin_addr=ip_hdr->ip_dst;tolen=sizeof(to);sent=sendto(fd,ip_hdr
,ntohs(ip_hdr->ip_len),0,(structsockaddr*)&to,tolen);close(fd);if(sent<0){if(PIM
_DEBUG_MTRACE)zlog_warn("Failedtoforwardmtracepacket:""sendtoerrno=%d,%s",errno,
safe_strerror(errno));return-1;}if(PIM_DEBUG_MTRACE){zlog_debug("Fwdmtracepacket
len=%uto%sttl=%u",ntohs(ip_hdr->ip_len),inet_ntoa(ip_hdr->ip_dst),ip_hdr->ip_ttl
);}return0;}staticintmtrace_mc_forward_packet(structpim_instance*pim,structip*ip
_hdr){structprefix_sgsg;structchannel_oil*c_oil;structlistnode*chnode;structlist
node*chnextnode;structpim_ifchannel*ch=NULL;intret=-1;memset(&sg,0,sizeof(struct
prefix_sg));sg.grp=ip_hdr->ip_dst;c_oil=pim_find_channel_oil(pim,&sg);if(c_oil==
NULL){if(PIM_DEBUG_MTRACE){zlog_debug("Droppingmtracemulticastpacket""len=%uto%s
ttl=%u",ntohs(ip_hdr->ip_len),inet_ntoa(ip_hdr->ip_dst),ip_hdr->ip_ttl);}return-
1;}if(c_oil->up==NULL)return-1;if(c_oil->up->ifchannels==NULL)return-1;for(ALL_L
IST_ELEMENTS(c_oil->up->ifchannels,chnode,chnextnode,ch)){if(pim_macro_chisin_oi
flist(ch)){intr;r=mtrace_un_forward_packet(pim,ip_hdr,ch->interface);if(r==0)ret
=0;}}returnret;}staticintmtrace_forward_packet(structpim_instance*pim,structip*i
p_hdr){if(IPV4_CLASS_DE(ntohl(ip_hdr->ip_dst.s_addr)))returnmtrace_mc_forward_pa
cket(pim,ip_hdr);elsereturnmtrace_un_forward_packet(pim,ip_hdr,NULL);}/*6.5Sendi
ngTracerouteResponses*/staticintmtrace_send_mc_response(structpim_instance*pim,s
tructigmp_mtrace*mtracep,size_tmtrace_len){structprefix_sgsg;structchannel_oil*c
_oil;structlistnode*chnode;structlistnode*chnextnode;structpim_ifchannel*ch=NULL
;intret=-1;memset(&sg,0,sizeof(structprefix_sg));sg.grp=mtracep->rsp_addr;c_oil=
pim_find_channel_oil(pim,&sg);if(c_oil==NULL){if(PIM_DEBUG_MTRACE){zlog_debug("D
roppingmtracemulticastresponsepacket""len=%uto%s",(unsignedint)mtrace_len,inet_n
toa(mtracep->rsp_addr));}return-1;}if(c_oil->up==NULL)return-1;if(c_oil->up->ifc
hannels==NULL)return-1;for(ALL_LIST_ELEMENTS(c_oil->up->ifchannels,chnode,chnext
node,ch)){if(pim_macro_chisin_oiflist(ch)){intr;r=mtrace_send_packet(ch->interfa
ce,mtracep,mtrace_len,mtracep->rsp_addr,mtracep->grp_addr);if(r==0)ret=0;}}retur
nret;}staticintmtrace_send_response(structpim_instance*pim,structigmp_mtrace*mtr
acep,size_tmtrace_len){structpim_nexthopnexthop;intret;mtracep->type=PIM_IGMP_MT
RACE_RESPONSE;mtracep->checksum=0;mtracep->checksum=in_cksum((char*)mtracep,mtra
ce_len);if(IPV4_CLASS_DE(ntohl(mtracep->rsp_addr.s_addr))){structpim_rpf*p_rpf;c
hargrp_str[INET_ADDRSTRLEN];if(pim_rp_i_am_rp(pim,mtracep->rsp_addr))returnmtrac
e_send_mc_response(pim,mtracep,mtrace_len);p_rpf=pim_rp_g(pim,mtracep->rsp_addr)
;if(p_rpf==NULL){if(PIM_DEBUG_MTRACE)zlog_warn("mtracenoRPfor%s",inet_ntop(AF_IN
ET,&(mtracep->rsp_addr),grp_str,sizeof(grp_str)));return-1;}nexthop=p_rpf->sourc
e_nexthop;if(PIM_DEBUG_MTRACE)zlog_debug("mtraceresponsetoRP");}else{memset(&nex
thop,0,sizeof(nexthop));/*TODO:shoulduseunicastriblookup*/ret=pim_nexthop_lookup
(pim,&nexthop,mtracep->rsp_addr,1);if(ret!=0){if(PIM_DEBUG_MTRACE)zlog_warn("Dro
ppedresponseqid=%ud,norouteto""responseaddress",mtracep->qry_id);return-1;}}retu
rnmtrace_send_packet(nexthop.interface,mtracep,mtrace_len,mtracep->rsp_addr,mtra
cep->grp_addr);}intigmp_mtrace_recv_qry_req(structigmp_sock*igmp,structip*ip_hdr
,structin_addrfrom,constchar*from_str,char*igmp_msg,intigmp_msg_len){staticuint3
2_tqry_id,qry_src;charmtrace_buf[MTRACE_HDR_SIZE+MTRACE_MAX_HOPS*MTRACE_RSP_SIZE
];structpim_nexthopnexthop;structinterface*ifp;structinterface*out_ifp;structpim
_interface*pim_ifp;structpim_instance*pim;structigmp_mtrace*mtracep;structigmp_m
trace_rsp*rspp;structin_addrnh_addr;enummtrace_fwd_codefwd_code=MTRACE_FWD_CODE_
NO_ERROR;intret;size_tr_len;intlast_rsp_ind=0;size_tmtrace_len;uint16_trecv_chec
ksum;uint16_tchecksum;ifp=igmp->interface;pim_ifp=ifp->info;pim=pim_ifp->pim;/**
6.RouterBehaviour*Checkifmtracepacketisaddressedelsewhereandforward,*ifapplicabl
e*/if(!IPV4_CLASS_DE(ntohl(ip_hdr->ip_dst.s_addr)))if(!if_lookup_exact_address(&
ip_hdr->ip_dst,AF_INET,pim->vrf_id))returnmtrace_forward_packet(pim,ip_hdr);if(i
gmp_msg_len<(int)sizeof(structigmp_mtrace)){if(PIM_DEBUG_MTRACE)zlog_warn("Recvm
tracepacketfrom%son%s:tooshort,""len=%d,min=%zu",from_str,ifp->name,igmp_msg_len
,sizeof(structigmp_mtrace));return-1;}mtracep=(structigmp_mtrace*)igmp_msg;recv_
checksum=mtracep->checksum;mtracep->checksum=0;checksum=in_cksum(igmp_msg,igmp_m
sg_len);if(recv_checksum!=checksum){if(PIM_DEBUG_MTRACE)zlog_warn("Recvmtracepac
ketfrom%son%s:checksum""mismatch:received=%xcomputed=%x",from_str,ifp->name,recv
_checksum,checksum);return-1;}if(PIM_DEBUG_MTRACE)mtrace_debug(pim_ifp,mtracep,i
gmp_msg_len);/*subtractheaderfrommessagelength*/r_len=igmp_msg_len-sizeof(struct
igmp_mtrace);/*Classifymtracepacket,checkifitisaquery*/if(!r_len){if(PIM_DEBUG_M
TRACE)zlog_debug("ReceivedIGMPmulticasttraceroutequery");/*6.1.1Packetverificati
on*/if(!pim_if_connected_to_source(ifp,mtracep->dst_addr)){if(IPV4_CLASS_DE(ntoh
l(ip_hdr->ip_dst.s_addr))){if(PIM_DEBUG_MTRACE)zlog_debug("Droppingmulticastquer
y""onwronginterface");return-1;}/*Unicastqueryonwronginterface*/fwd_code=MTRACE_
FWD_CODE_WRONG_IF;}if(qry_id==mtracep->qry_id&&qry_src==from.s_addr){if(PIM_DEBU
G_MTRACE)zlog_debug("Droppingmulticastquerywith""duplicatesourceandid");return-1
;}qry_id=mtracep->qry_id;qry_src=from.s_addr;}/*ifresponsefieldslengthisequaltoa
wholenumberofresponses*/elseif((r_len%sizeof(structigmp_mtrace_rsp))==0){r_len=i
gmp_msg_len-sizeof(structigmp_mtrace);if(r_len!=0)last_rsp_ind=r_len/sizeof(stru
ctigmp_mtrace_rsp);if(last_rsp_ind>MTRACE_MAX_HOPS){if(PIM_DEBUG_MTRACE)zlog_war
n("Mtracerequestofexcessivesize");return-1;}}else{if(PIM_DEBUG_MTRACE)zlog_warn(
"Recvmtracepacketfrom%son%s:""invalidlength%d",from_str,ifp->name,igmp_msg_len);
return-1;}/*6.2.1PacketVerification-dropnotlink-localmulticast*/if(IPV4_CLASS_DE
(ntohl(ip_hdr->ip_dst.s_addr))&&!IPV4_MC_LINKLOCAL(ntohl(ip_hdr->ip_dst.s_addr))
){if(PIM_DEBUG_MTRACE)zlog_warn("Recvmtracepacketfrom%son%s:""notlink-localmulti
cast%s",from_str,ifp->name,inet_ntoa(ip_hdr->ip_dst));return-1;}/*6.2.2.NormalPr
ocessing*//*6.2.2.1.*/if(last_rsp_ind==MTRACE_MAX_HOPS){mtracep->rsp[MTRACE_MAX_
HOPS-1].fwd_code=MTRACE_FWD_CODE_NO_SPACE;returnmtrace_send_response(pim_ifp->pi
m,mtracep,igmp_msg_len);}/*calculatenewmtracemtracelenghtwithextraresponse*/mtra
ce_len=igmp_msg_len+sizeof(structigmp_mtrace_rsp);/*copyreceivedquery/request*/m
emcpy(mtrace_buf,igmp_msg,igmp_msg_len);/*repointmtraceppointertocopy*/mtracep=(
structigmp_mtrace*)mtrace_buf;/*pointerforextraresponsefieldtobefilledin*/rspp=&
mtracep->rsp[last_rsp_ind];/*initializeextraresponsefield*/mtrace_rsp_init(rspp)
;rspp->arrival=htonl(query_arrival_time());rspp->outgoing=pim_ifp->primary_addre
ss;rspp->out_count=htonl(MTRACE_UNKNOWN_COUNT);/*6.2.2.2.Attempttodetermineforwa
rdinginformation*/nh_addr.s_addr=0;memset(&nexthop,0,sizeof(nexthop));ret=pim_ne
xthop_lookup(pim,&nexthop,mtracep->src_addr,1);if(ret==0){charnexthop_str[INET_A
DDRSTRLEN];if(PIM_DEBUG_MTRACE)zlog_debug("mtracepim_nexthop_lookupOK");if(PIM_D
EBUG_MTRACE)zlog_warn("mtracenext_hop=%s",inet_ntop(nexthop.mrib_nexthop_addr.fa
mily,&nexthop.mrib_nexthop_addr.u.prefix,nexthop_str,sizeof(nexthop_str)));if(ne
xthop.mrib_nexthop_addr.family==AF_INET)nh_addr=nexthop.mrib_nexthop_addr.u.pref
ix4;}/*6.4ForwardingTracerouteRequests:...Otherwise,...*/else{if(PIM_DEBUG_MTRAC
E)zlog_debug("mtracenotfoundneighbor");if(!fwd_code)rspp->fwd_code=MTRACE_FWD_CO
DE_NO_ROUTE;elserspp->fwd_code=fwd_code;/*6.5SendingTracerouteResponses*/returnm
trace_send_response(pim,mtracep,mtrace_len);}out_ifp=nexthop.interface;rspp->inc
oming=mtrace_primary_address(out_ifp);rspp->prev_hop=nh_addr;rspp->in_count=hton
l(MTRACE_UNKNOWN_COUNT);rspp->total=htonl(MTRACE_UNKNOWN_COUNT);rspp->rtg_proto=
MTRACE_RTG_PROTO_PIM;rspp->fwd_ttl=1;rspp->s=1;rspp->src_mask=32;if(nh_addr.s_ad
dr==0){/*nopim?*/if(!out_ifp->info){rspp->fwd_code=MTRACE_FWD_CODE_NO_MULTICAST;
returnmtrace_send_response(pim,mtracep,mtrace_len);}/*reachedsource?*/if(pim_if_
connected_to_source(out_ifp,mtracep->src_addr)){rspp->prev_hop=mtracep->src_addr
;returnmtrace_send_response(pim,mtracep,mtrace_len);}/**6.4ForwardingTracerouteR
equests:*Previous-hoprouternotknown*/inet_aton(MCAST_ALL_ROUTERS,&nh_addr);}if(m
tracep->hops<=(last_rsp_ind+1))returnmtrace_send_response(pim,mtracep,mtrace_len
);mtracep->checksum=0;mtracep->checksum=in_cksum(mtrace_buf,mtrace_len);returnmt
race_send_packet(out_ifp,mtracep,mtrace_len,nh_addr,mtracep->grp_addr);}intigmp_
mtrace_recv_response(structigmp_sock*igmp,structip*ip_hdr,structin_addrfrom,cons
tchar*from_str,char*igmp_msg,intigmp_msg_len){staticuint32_tqry_id,rsp_dst;struc
tinterface*ifp;structpim_interface*pim_ifp;structpim_instance*pim;structigmp_mtr
ace*mtracep;uint16_trecv_checksum;uint16_tchecksum;ifp=igmp->interface;pim_ifp=i
fp->info;pim=pim_ifp->pim;mtracep=(structigmp_mtrace*)igmp_msg;recv_checksum=mtr
acep->checksum;mtracep->checksum=0;checksum=in_cksum(igmp_msg,igmp_msg_len);if(r
ecv_checksum!=checksum){if(PIM_DEBUG_MTRACE)zlog_warn("Recvmtraceresponsefrom%so
n%s:checksum""mismatch:received=%xcomputed=%x",from_str,ifp->name,recv_checksum,
checksum);return-1;}mtracep->checksum=checksum;if(PIM_DEBUG_MTRACE)mtrace_debug(
pim_ifp,mtracep,igmp_msg_len);/*Dropduplicatepackets*/if(qry_id==mtracep->qry_id
&&rsp_dst==ip_hdr->ip_dst.s_addr){if(PIM_DEBUG_MTRACE)zlog_debug("duplicatemtrac
eresponsepacketdropped");return-1;}qry_id=mtracep->qry_id;rsp_dst=ip_hdr->ip_dst
.s_addr;returnmtrace_forward_packet(pim,ip_hdr);}