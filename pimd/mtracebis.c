/**MulticastTracerouteforFRRouting*Copyright(C)2018MladenSablic**Thisprogramisfr
eesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublic
Licenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(at
youroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful
,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESS
FORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldha
vereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYI
NG;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,M
A02110-1301USA*/#ifdef__linux__#include"pim_igmp_mtrace.h"#include"checksum.h"#i
nclude"mtracebis_routeget.h"#include<sys/select.h>#include<netinet/in.h>#include
<arpa/inet.h>#include<unistd.h>#include<sys/types.h>#include<sys/time.h>#include
<stdio.h>#include<stdlib.h>#include<string.h>#include<time.h>#include<net/if.h>#
include<unistd.h>#include<getopt.h>#include<netdb.h>#defineMTRACEBIS_VERSION"0.1
"#defineMTRACE_TIMEOUT(5)#defineIP_HDR_LEN(sizeof(structip))#defineIP_RA_LEN(4)#
defineMTRACE_BUF_LEN(MTRACE_HDR_SIZE+(MTRACE_MAX_HOPS*MTRACE_RSP_SIZE))#defineIP
_AND_MTRACE_BUF_LEN(IP_HDR_LEN+IP_RA_LEN+MTRACE_BUF_LEN)staticconstchar*progname
;staticvoidusage(void){fprintf(stderr,"Usage:%s<multicastsource>\n",progname);}s
taticvoidversion(void){fprintf(stderr,"%s%s\n",progname,MTRACEBIS_VERSION);}stat
icvoidprint_host(structin_addraddr){structhostent*h;h=gethostbyaddr(&addr,sizeof
(addr),AF_INET);if(h==NULL)printf("?");elseprintf("%s",h->h_name);printf("(%s)",
inet_ntoa(addr));}staticvoidprint_line_no(inti){printf("%3d",-i);}staticconstcha
r*rtg_proto_str(enummtrace_rtg_protoproto){staticcharbuf[80];buf[0]='\0';switch(
proto){caseMTRACE_RTG_PROTO_DVMRP:return"DVMRP";caseMTRACE_RTG_PROTO_MOSPF:retur
n"MOSPF";caseMTRACE_RTG_PROTO_PIM:return"PIM";caseMTRACE_RTG_PROTO_CBT:return"CB
T";caseMTRACE_RTG_PROTO_PIM_SPECIAL:return"PIMspecial";caseMTRACE_RTG_PROTO_PIM_
STATIC:return"PIMstatic";caseMTRACE_RTG_PROTO_DVMRP_STATIC:return"DVMRPstatic";c
aseMTRACE_RTG_PROTO_PIM_MBGP:return"PIMMBGP";caseMTRACE_RTG_PROTO_CBT_SPECIAL:re
turn"CBTspecial";caseMTRACE_RTG_PROTO_CBT_STATIC:return"CBTstatic";caseMTRACE_RT
G_PROTO_PIM_ASSERT:return"PIMassert";default:sprintf(buf,"unknownprotocol(%d)",p
roto);returnbuf;}}staticvoidprint_rtg_proto(uint32_trtg_proto){printf("%s",rtg_p
roto_str(rtg_proto));}staticvoidprint_fwd_ttl(uint32_tfwd_ttl){printf("thresh^%d
",fwd_ttl);}staticconstchar*fwd_code_str(enummtrace_fwd_codecode){staticcharbuf[
80];buf[0]='\0';switch(code){caseMTRACE_FWD_CODE_NO_ERROR:return"noerror";caseMT
RACE_FWD_CODE_WRONG_IF:return"wronginterface";caseMTRACE_FWD_CODE_PRUNE_SENT:ret
urn"prunesent";caseMTRACE_FWD_CODE_PRUNE_RCVD:return"prunereceived";caseMTRACE_F
WD_CODE_SCOPED:return"scoped";caseMTRACE_FWD_CODE_NO_ROUTE:return"noroute";caseM
TRACE_FWD_CODE_WRONG_LAST_HOP:return"wronglasthop";caseMTRACE_FWD_CODE_NOT_FORWA
RDING:return"notforwarding";caseMTRACE_FWD_CODE_REACHED_RP:return"reachedRP";cas
eMTRACE_FWD_CODE_RPF_IF:return"RPFinterface";caseMTRACE_FWD_CODE_NO_MULTICAST:re
turn"nomulticast";caseMTRACE_FWD_CODE_INFO_HIDDEN:return"infohidden";caseMTRACE_
FWD_CODE_NO_SPACE:return"nospace";caseMTRACE_FWD_CODE_OLD_ROUTER:return"oldroute
r";caseMTRACE_FWD_CODE_ADMIN_PROHIB:return"admin.prohib.";default:sprintf(buf,"u
nknownfwd.code(%d)",code);returnbuf;}}staticvoidprint_fwd_code(uint32_tfwd_code)
{printf("%s",fwd_code_str(fwd_code));}staticvoidprint_rsp(structigmp_mtrace_rsp*
rsp){print_host(rsp->outgoing);if(rsp->fwd_code==0){print_rtg_proto(rsp->rtg_pro
to);printf("");print_fwd_ttl(rsp->fwd_ttl);}else{print_fwd_code(rsp->fwd_code);}
printf("\n");}staticvoidprint_dest(structigmp_mtrace*mtrace){print_line_no(0);pr
int_host(mtrace->dst_addr);printf("\n");}staticvoidprint_summary(structigmp_mtra
ce*mtrace,inthops,longmsec){inti;intt=0;for(i=0;i<hops;i++)t+=mtrace->rsp[i].fwd
_ttl;printf("Roundtriptime%ldms;totalttlof%drequired.\n",msec,t);}staticvoidprin
t_responses(structigmp_mtrace*mtrace,inthops,longmsec){inti;print_dest(mtrace);f
or(i=0;i<hops;i++){print_line_no(i+1);print_rsp(&mtrace->rsp[i]);}print_summary(
mtrace,hops,msec);}staticintsend_query(intfd,structin_addrto_addr,structigmp_mtr
ace*mtrace){structsockaddr_into;socklen_ttolen;intsent;memset(&to,0,sizeof(to));
to.sin_family=AF_INET;to.sin_addr=to_addr;tolen=sizeof(to);sent=sendto(fd,(char*
)mtrace,sizeof(*mtrace),MSG_DONTWAIT,(structsockaddr*)&to,tolen);if(sent<1)retur
n-1;return0;}staticvoidprint_query(structigmp_mtrace*mtrace){charsrc_str[INET_AD
DRSTRLEN];chardst_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];printf("*Mtr
acefrom%sto%sviagroup%s\n",inet_ntop(AF_INET,&mtrace->src_addr,src_str,sizeof(sr
c_str)),inet_ntop(AF_INET,&mtrace->dst_addr,dst_str,sizeof(dst_str)),inet_ntop(A
F_INET,&mtrace->grp_addr,grp_str,sizeof(grp_str)));}staticintrecv_response(intfd
,int*hops,structigmp_mtrace*mtracer){intrecvd;charmtrace_buf[IP_AND_MTRACE_BUF_L
EN];structip*ip;structigmp_mtrace*mtrace;intmtrace_len;intresponses;unsignedshor
tsum;recvd=recvfrom(fd,mtrace_buf,IP_AND_MTRACE_BUF_LEN,0,NULL,0);if(recvd<1){fp
rintf(stderr,"recvfromerror:%s\n",strerror(errno));return-1;}if(recvd<(int)sizeo
f(structip)){fprintf(stderr,"noipheader\n");return-1;}ip=(structip*)mtrace_buf;i
f(ip->ip_v!=4){fprintf(stderr,"IPnotversion4\n");return-1;}sum=ip->ip_sum;ip->ip
_sum=0;if(sum!=in_cksum(ip,ip->ip_hl*4))return-1;mtrace=(structigmp_mtrace*)(mtr
ace_buf+(4*ip->ip_hl));mtrace_len=ntohs(ip->ip_len)-ip->ip_hl*4;if(mtrace_len<(i
nt)MTRACE_HDR_SIZE)return-1;sum=mtrace->checksum;mtrace->checksum=0;if(sum!=in_c
ksum(mtrace,mtrace_len)){fprintf(stderr,"mtracechecksumwrong\n");return-1;}if(mt
race->type!=PIM_IGMP_MTRACE_RESPONSE)return-1;responses=mtrace_len-sizeof(struct
igmp_mtrace);responses/=sizeof(structigmp_mtrace_rsp);if(responses>MTRACE_MAX_HO
PS){fprintf(stderr,"mtracetoolarge\n");return-1;}if(hops)*hops=responses;if(mtra
cer)memcpy(mtracer,mtrace,mtrace_len);return0;}staticintwait_for_response(intfd,
int*hops,structigmp_mtrace*mtrace,long*ret_msec){fd_setreadfds;structtimevaltime
out;intret=-1;longmsec,rmsec,tmsec;FD_ZERO(&readfds);FD_SET(fd,&readfds);memset(
&timeout,0,sizeof(timeout));timeout.tv_sec=MTRACE_TIMEOUT;tmsec=timeout.tv_sec*1
000+timeout.tv_usec/1000;do{ret=select(fd+1,&readfds,NULL,NULL,&timeout);if(ret<
=0)returnret;rmsec=timeout.tv_sec*1000+timeout.tv_usec/1000;msec=tmsec-rmsec;}wh
ile(recv_response(fd,hops,mtrace)!=0);if(ret_msec)*ret_msec=msec;returnret;}stat
icboolcheck_end(structigmp_mtrace*mtrace,inthops){returnmtrace->src_addr.s_addr=
=mtrace->rsp[hops-1].prev_hop.s_addr;}intmain(intargc,char*constargv[]){structin
_addrmc_source;structin_addriface_addr;structin_addrgw_addr;structin_addrmtrace_
addr;structigmp_mtracemtrace;structigmp_mtrace*mtracep;inthops=255;intrhops;intm
axhops=255;intperhop=3;intifindex;intunicast=1;intttl=64;intfd=-1;intret=-1;intc
;longmsec;inti,j;charifname[IF_NAMESIZE];charmbuf[MTRACE_BUF_LEN];mtrace_addr.s_
addr=inet_addr("224.0.1.32");uid_tuid=getuid();if(uid!=0){printf("mustrunasroot\
n");exit(EXIT_FAILURE);}if(argc<=0)progname="mtracebis";elseprogname=argv[0];if(
argc!=2){usage();exit(EXIT_FAILURE);}while(1){staticstructoptionlong_options[]={
{"help",no_argument,0,'h'},{"version",no_argument,0,'v'},{0,0,0,0}};intoption_in
dex=0;c=getopt_long(argc,argv,"vh",long_options,&option_index);if(c==-1)break;sw
itch(c){case'h':usage();exit(0);case'v':version();exit(0);default:usage();exit(E
XIT_FAILURE);}}if(inet_pton(AF_INET,argv[1],&mc_source)!=1){usage();fprintf(stde
rr,"%s:%snotavalidIPv4address\n",argv[0],argv[1]);exit(EXIT_FAILURE);}ifindex=ro
uteget(mc_source,&iface_addr,&gw_addr);if(ifindex<0){fprintf(stderr,"%s:failedto
getroutetosource%s\n",argv[0],argv[1]);exit(EXIT_FAILURE);}if(if_indextoname(ifi
ndex,ifname)==NULL){fprintf(stderr,"%s:if_indextonameerror:%s\n",argv[0],strerro
r(errno));exit(EXIT_FAILURE);}/*zeromtracestruct*/memset((char*)&mtrace,0,sizeof
(mtrace));/*setupquery*/mtrace.type=PIM_IGMP_MTRACE_QUERY_REQUEST;mtrace.hops=ho
ps;mtrace.checksum=0;mtrace.grp_addr.s_addr=0;mtrace.src_addr=mc_source;mtrace.d
st_addr=iface_addr;mtrace.rsp_addr=unicast?iface_addr:mtrace_addr;mtrace.rsp_ttl
=ttl;mtrace.qry_id=0xffffff&time(NULL);mtrace.checksum=in_cksum(&mtrace,sizeof(m
trace));fd=socket(AF_INET,SOCK_RAW,IPPROTO_IGMP);if(fd<1){fprintf(stderr,"%s:soc
keterror:%s\n",argv[0],strerror(errno));exit(EXIT_FAILURE);}ret=setsockopt(fd,SO
L_SOCKET,SO_BINDTODEVICE,ifname,strlen(ifname));if(ret<0){fprintf(stderr,"%s:set
sockopterror:%s\n",argv[0],strerror(errno));ret=EXIT_FAILURE;gotoclose_fd;}print
_query(&mtrace);if(send_query(fd,gw_addr,&mtrace)<0){fprintf(stderr,"%s:sendtoer
ror:%s\n",argv[0],strerror(errno));ret=EXIT_FAILURE;gotoclose_fd;}printf("Queryi
ngfullreversepath...\n");mtracep=(structigmp_mtrace*)mbuf;ret=wait_for_response(
fd,&rhops,mtracep,&msec);if(ret>0){print_responses(mtracep,rhops,msec);ret=0;got
oclose_fd;}if(ret<0){fprintf(stderr,"%s:selecterror:%s\n",argv[0],strerror(errno
));ret=EXIT_FAILURE;gotoclose_fd;}printf("*");printf("switchingtohop-by-hop:\n")
;print_dest(&mtrace);for(i=1;i<maxhops;i++){print_line_no(i);mtrace.hops=i;for(j
=0;j<perhop;j++){mtrace.qry_id++;mtrace.checksum=0;mtrace.checksum=in_cksum(&mtr
ace,sizeof(mtrace));if(send_query(fd,gw_addr,&mtrace)<0){fprintf(stderr,"%s:send
toerror:%s\n",argv[0],strerror(errno));ret=EXIT_FAILURE;gotoclose_fd;}ret=wait_f
or_response(fd,&rhops,mtracep,&msec);if(ret>0){if(check_end(mtracep,rhops)){prin
t_rsp(&mtracep->rsp[rhops-1]);print_summary(mtracep,rhops,msec);ret=0;gotoclose_
fd;}if(i>rhops){printf("*...givingup.\n");ret=0;gotoclose_fd;}print_rsp(&mtracep
->rsp[rhops-1]);break;}printf("*");}if(ret<=0)printf("\n");}ret=0;close_fd:close
(fd);exit(ret);}#else/*__linux__*/#include<stdio.h>#include<stdlib.h>intmain(int
argc,char*argv[]){printf("%simplementedonlyforGNU/Linux\n",argv[0]);exit(0);}#en
dif/*__linux__*/