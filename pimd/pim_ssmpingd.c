/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"if.h"#include"log.h"#include"memory.h"#include"s
ockopt.h"#include"vrf.h"#include"pimd.h"#include"pim_ssmpingd.h"#include"pim_tim
e.h"#include"pim_sock.h"staticconstchar*constPIM_SSMPINGD_REPLY_GROUP="232.43.21
1.234";enum{PIM_SSMPINGD_REQUEST='Q',PIM_SSMPINGD_REPLY='A'};staticvoidssmpingd_
read_on(structssmpingd_sock*ss);voidpim_ssmpingd_init(structpim_instance*pim){in
tresult;zassert(!pim->ssmpingd_list);result=inet_pton(AF_INET,PIM_SSMPINGD_REPLY
_GROUP,&pim->ssmpingd_group_addr);zassert(result>0);}voidpim_ssmpingd_destroy(st
ructpim_instance*pim){if(pim->ssmpingd_list)list_delete_and_null(&pim->ssmpingd_
list);}staticstructssmpingd_sock*ssmpingd_find(structpim_instance*pim,structin_a
ddrsource_addr){structlistnode*node;structssmpingd_sock*ss;if(!pim->ssmpingd_lis
t)return0;for(ALL_LIST_ELEMENTS_RO(pim->ssmpingd_list,node,ss))if(source_addr.s_
addr==ss->source_addr.s_addr)returnss;return0;}staticvoidssmpingd_free(structssm
pingd_sock*ss){XFREE(MTYPE_PIM_SSMPINGD,ss);}staticintssmpingd_socket(structin_a
ddraddr,intport,intmttl){structsockaddr_insockaddr;intfd;fd=socket(AF_INET,SOCK_
DGRAM,IPPROTO_UDP);if(fd<0){zlog_err("%s:couldnotcreatesocket:errno=%d:%s",__PRE
TTY_FUNCTION__,errno,safe_strerror(errno));return-1;}sockaddr.sin_family=AF_INET
;sockaddr.sin_addr=addr;sockaddr.sin_port=htons(port);if(bind(fd,(structsockaddr
*)&sockaddr,sizeof(sockaddr))){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ad
dr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s:bind(fd=%d,addr=%s,port=%d,l
en=%zu)failure:errno=%d:%s",__PRETTY_FUNCTION__,fd,addr_str,port,sizeof(sockaddr
),errno,safe_strerror(errno));close(fd);return-1;}/*Neededtoobtaindestinationadd
ressfromrecvmsg()*/{#ifdefined(HAVE_IP_PKTINFO)/*LinuxandSolarisIP_PKTINFO*/into
pt=1;if(setsockopt(fd,IPPROTO_IP,IP_PKTINFO,&opt,sizeof(opt))){zlog_warn("%s:cou
ldnotsetIP_PKTINFOonsocketfd=%d:errno=%d:%s",__PRETTY_FUNCTION__,fd,errno,safe_s
trerror(errno));}#elifdefined(HAVE_IP_RECVDSTADDR)/*BSDIP_RECVDSTADDR*/intopt=1;
if(setsockopt(fd,IPPROTO_IP,IP_RECVDSTADDR,&opt,sizeof(opt))){zlog_warn("%s:coul
dnotsetIP_RECVDSTADDRonsocketfd=%d:errno=%d:%s",__PRETTY_FUNCTION__,fd,errno,saf
e_strerror(errno));}#elsezlog_err("%s%s:missingIP_PKTINFOandIP_RECVDSTADDR:unabl
etogetdstaddrfromrecvmsg()",__FILE__,__PRETTY_FUNCTION__);close(fd);return-1;#en
dif}{intreuse=1;if(setsockopt(fd,SOL_SOCKET,SO_REUSEADDR,(void*)&reuse,sizeof(re
use))){zlog_warn("%s:couldnotsetReuseAddressOptiononsocketfd=%d:errno=%d:%s",__P
RETTY_FUNCTION__,fd,errno,safe_strerror(errno));close(fd);return-1;}}if(setsocko
pt(fd,IPPROTO_IP,IP_MULTICAST_TTL,(void*)&mttl,sizeof(mttl))){zlog_warn("%s:coul
dnotsetmulticastTTL=%donsocketfd=%d:errno=%d:%s",__PRETTY_FUNCTION__,mttl,fd,err
no,safe_strerror(errno));close(fd);return-1;}if(setsockopt_ipv4_multicast_loop(f
d,0)){zlog_warn("%s:couldnotdisableMulticastLoopbackOptiononsocketfd=%d:errno=%d
:%s",__PRETTY_FUNCTION__,fd,errno,safe_strerror(errno));close(fd);returnPIM_SOCK
_ERR_LOOP;}if(setsockopt(fd,IPPROTO_IP,IP_MULTICAST_IF,(void*)&addr,sizeof(addr)
)){zlog_warn("%s:couldnotsetOutgoingInterfaceOptiononsocketfd=%d:errno=%d:%s",__
PRETTY_FUNCTION__,fd,errno,safe_strerror(errno));close(fd);return-1;}{longflags;
flags=fcntl(fd,F_GETFL,0);if(flags<0){zlog_warn("%s:couldnotgetfcntl(F_GETFL,O_N
ONBLOCK)onsocketfd=%d:errno=%d:%s",__PRETTY_FUNCTION__,fd,errno,safe_strerror(er
rno));close(fd);return-1;}if(fcntl(fd,F_SETFL,flags|O_NONBLOCK)){zlog_warn("%s:c
ouldnotsetfcntl(F_SETFL,O_NONBLOCK)onsocketfd=%d:errno=%d:%s",__PRETTY_FUNCTION_
_,fd,errno,safe_strerror(errno));close(fd);return-1;}}returnfd;}staticvoidssmpin
gd_delete(structssmpingd_sock*ss){zassert(ss);THREAD_OFF(ss->t_sock_read);if(clo
se(ss->sock_fd)){charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",ss->sou
rce_addr,source_str,sizeof(source_str));zlog_warn("%s:failureclosingssmpingdsock
_fd=%dforsource%s:errno=%d:%s",__PRETTY_FUNCTION__,ss->sock_fd,source_str,errno,
safe_strerror(errno));/*warningonly*/}listnode_delete(ss->pim->ssmpingd_list,ss)
;ssmpingd_free(ss);}staticvoidssmpingd_sendto(structssmpingd_sock*ss,constuint8_
t*buf,intlen,structsockaddr_into){socklen_ttolen=sizeof(to);intsent;sent=sendto(
ss->sock_fd,buf,len,MSG_DONTWAIT,(structsockaddr*)&to,tolen);if(sent!=len){chart
o_str[INET_ADDRSTRLEN];pim_inet4_dump("<to?>",to.sin_addr,to_str,sizeof(to_str))
;if(sent<0){zlog_warn("%s:sendto()failureto%s,%d:fd=%dlen=%d:errno=%d:%s",__PRET
TY_FUNCTION__,to_str,ntohs(to.sin_port),ss->sock_fd,len,errno,safe_strerror(errn
o));}else{zlog_warn("%s:sendto()partialto%s,%d:fd=%dlen=%d:sent=%d",__PRETTY_FUN
CTION__,to_str,ntohs(to.sin_port),ss->sock_fd,len,sent);}}}staticintssmpingd_rea
d_msg(structssmpingd_sock*ss){structinterface*ifp;structsockaddr_infrom;structso
ckaddr_into;socklen_tfromlen=sizeof(from);socklen_ttolen=sizeof(to);ifindex_tifi
ndex=-1;uint8_tbuf[1000];intlen;++ss->requests;len=pim_socket_recvfromto(ss->soc
k_fd,buf,sizeof(buf),&from,&fromlen,&to,&tolen,&ifindex);if(len<0){charsource_st
r[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",ss->source_addr,source_str,sizeof(sou
rce_str));zlog_warn("%s:failurereceivingssmpingforsource%sonfd=%d:errno=%d:%s",_
_PRETTY_FUNCTION__,source_str,ss->sock_fd,errno,safe_strerror(errno));return-1;}
ifp=if_lookup_by_index(ifindex,ss->pim->vrf_id);if(buf[0]!=PIM_SSMPINGD_REQUEST)
{charsource_str[INET_ADDRSTRLEN];charfrom_str[INET_ADDRSTRLEN];charto_str[INET_A
DDRSTRLEN];pim_inet4_dump("<src?>",ss->source_addr,source_str,sizeof(source_str)
);pim_inet4_dump("<from?>",from.sin_addr,from_str,sizeof(from_str));pim_inet4_du
mp("<to?>",to.sin_addr,to_str,sizeof(to_str));zlog_warn("%s:badssmpingtype=%dfro
m%s,%dto%s,%doninterface%sifindex=%dfd=%dsrc=%s",__PRETTY_FUNCTION__,buf[0],from
_str,ntohs(from.sin_port),to_str,ntohs(to.sin_port),ifp?ifp->name:"<iface?>",ifi
ndex,ss->sock_fd,source_str);return0;}if(PIM_DEBUG_SSMPINGD){charsource_str[INET
_ADDRSTRLEN];charfrom_str[INET_ADDRSTRLEN];charto_str[INET_ADDRSTRLEN];pim_inet4
_dump("<src?>",ss->source_addr,source_str,sizeof(source_str));pim_inet4_dump("<f
rom?>",from.sin_addr,from_str,sizeof(from_str));pim_inet4_dump("<to?>",to.sin_ad
dr,to_str,sizeof(to_str));zlog_debug("%s:recvssmpingfrom%s,%dto%s,%doninterface%
sifindex=%dfd=%dsrc=%s",__PRETTY_FUNCTION__,from_str,ntohs(from.sin_port),to_str
,ntohs(to.sin_port),ifp?ifp->name:"<iface?>",ifindex,ss->sock_fd,source_str);}bu
f[0]=PIM_SSMPINGD_REPLY;/*unicastreply*/ssmpingd_sendto(ss,buf,len,from);/*multi
castreply*/from.sin_addr=ss->pim->ssmpingd_group_addr;ssmpingd_sendto(ss,buf,len
,from);return0;}staticintssmpingd_sock_read(structthread*t){structssmpingd_sock*
ss;intresult;ss=THREAD_ARG(t);result=ssmpingd_read_msg(ss);/*Keepreading*/ssmpin
gd_read_on(ss);returnresult;}staticvoidssmpingd_read_on(structssmpingd_sock*ss){
thread_add_read(master,ssmpingd_sock_read,ss,ss->sock_fd,&ss->t_sock_read);}stat
icstructssmpingd_sock*ssmpingd_new(structpim_instance*pim,structin_addrsource_ad
dr){structssmpingd_sock*ss;intsock_fd;if(!pim->ssmpingd_list){pim->ssmpingd_list
=list_new();if(!pim->ssmpingd_list){zlog_err("%s%s:failure:qpim_ssmpingd_list=li
st_new()",__FILE__,__PRETTY_FUNCTION__);return0;}pim->ssmpingd_list->del=(void(*
)(void*))ssmpingd_free;}sock_fd=ssmpingd_socket(source_addr,/*port:*/4321,/*mTTL
:*/64);if(sock_fd<0){charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",sou
rce_addr,source_str,sizeof(source_str));zlog_warn("%s:ssmpingd_socket()failurefo
rsource%s",__PRETTY_FUNCTION__,source_str);return0;}ss=XCALLOC(MTYPE_PIM_SSMPING
D,sizeof(*ss));if(!ss){charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",s
ource_addr,source_str,sizeof(source_str));zlog_err("%s:XCALLOC(%zu)failureforssm
pingdsource%s",__PRETTY_FUNCTION__,sizeof(*ss),source_str);close(sock_fd);return
0;}ss->pim=pim;ss->sock_fd=sock_fd;ss->t_sock_read=NULL;ss->source_addr=source_a
ddr;ss->creation=pim_time_monotonic_sec();ss->requests=0;listnode_add(pim->ssmpi
ngd_list,ss);ssmpingd_read_on(ss);returnss;}intpim_ssmpingd_start(structpim_inst
ance*pim,structin_addrsource_addr){structssmpingd_sock*ss;ss=ssmpingd_find(pim,s
ource_addr);if(ss){/*silentlyignorerequesttorecreateentry*/return0;}{charsource_
str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",source_addr,source_str,sizeof(sourc
e_str));zlog_info("%s:startingssmpingdforsource%s",__PRETTY_FUNCTION__,source_st
r);}ss=ssmpingd_new(pim,source_addr);if(!ss){charsource_str[INET_ADDRSTRLEN];pim
_inet4_dump("<src?>",source_addr,source_str,sizeof(source_str));zlog_warn("%s:ss
mpingd_new()failureforsource%s",__PRETTY_FUNCTION__,source_str);return-1;}return
0;}intpim_ssmpingd_stop(structpim_instance*pim,structin_addrsource_addr){structs
smpingd_sock*ss;ss=ssmpingd_find(pim,source_addr);if(!ss){charsource_str[INET_AD
DRSTRLEN];pim_inet4_dump("<src?>",source_addr,source_str,sizeof(source_str));zlo
g_warn("%s:couldnotfindssmpingdforsource%s",__PRETTY_FUNCTION__,source_str);retu
rn-1;}{charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",source_addr,sourc
e_str,sizeof(source_str));zlog_info("%s:stoppingssmpingdforsource%s",__PRETTY_FU
NCTION__,source_str);}ssmpingd_delete(ss);return0;}