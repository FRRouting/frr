/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"zebra/rib.h"#include"log.h"#include"zclient.h"#i
nclude"memory.h"#include"thread.h"#include"linklist.h"#include"vty.h"#include"pl
ist.h"#include"hash.h"#include"jhash.h"#include"wheel.h"#include"pimd.h"#include
"pim_pim.h"#include"pim_str.h"#include"pim_time.h"#include"pim_iface.h"#include"
pim_join.h"#include"pim_zlookup.h"#include"pim_upstream.h"#include"pim_ifchannel
.h"#include"pim_neighbor.h"#include"pim_rpf.h"#include"pim_zebra.h"#include"pim_
oil.h"#include"pim_macro.h"#include"pim_rp.h"#include"pim_br.h"#include"pim_regi
ster.h"#include"pim_msdp.h"#include"pim_jp_agg.h"#include"pim_nht.h"#include"pim
_ssm.h"staticvoidjoin_timer_stop(structpim_upstream*up);staticvoidpim_upstream_u
pdate_assert_tracking_desired(structpim_upstream*up);/**A(*,G)ora(*,*)isgoingawa
y*removetheparentpointerfrom*thosepointingatus*/staticvoidpim_upstream_remove_ch
ildren(structpim_instance*pim,structpim_upstream*up){structpim_upstream*child;if
(!up->sources)return;while(!list_isempty(up->sources)){child=listnode_head(up->s
ources);listnode_delete(up->sources,child);if(PIM_UPSTREAM_FLAG_TEST_SRC_LHR(chi
ld->flags)){PIM_UPSTREAM_FLAG_UNSET_SRC_LHR(child->flags);child=pim_upstream_del
(pim,child,__PRETTY_FUNCTION__);}if(child)child->parent=NULL;}list_delete_and_nu
ll(&up->sources);}/**A(*,G)ora(*,*)isbeingcreated*Findthechildrenthatwouldpoint*
atus.*/staticvoidpim_upstream_find_new_children(structpim_instance*pim,structpim
_upstream*up){structpim_upstream*child;structlistnode*ch_node;if((up->sg.src.s_a
ddr!=INADDR_ANY)&&(up->sg.grp.s_addr!=INADDR_ANY))return;if((up->sg.src.s_addr==
INADDR_ANY)&&(up->sg.grp.s_addr==INADDR_ANY))return;for(ALL_LIST_ELEMENTS_RO(pim
->upstream_list,ch_node,child)){if((up->sg.grp.s_addr!=INADDR_ANY)&&(child->sg.g
rp.s_addr==up->sg.grp.s_addr)&&(child!=up)){child->parent=up;listnode_add_sort(u
p->sources,child);}}}/**Ifwehavea(*,*)||(S,*)thereisnoparent*Ifwehavea(S,G),find
the(*,G)*Ifwehavea(*,G),findthe(*,*)*/staticstructpim_upstream*pim_upstream_find
_parent(structpim_instance*pim,structpim_upstream*child){structprefix_sgany=chil
d->sg;structpim_upstream*up=NULL;//(S,G)if((child->sg.src.s_addr!=INADDR_ANY)&&(
child->sg.grp.s_addr!=INADDR_ANY)){any.src.s_addr=INADDR_ANY;up=pim_upstream_fin
d(pim,&any);if(up)listnode_add(up->sources,child);returnup;}returnNULL;}voidpim_
upstream_free(structpim_upstream*up){XFREE(MTYPE_PIM_UPSTREAM,up);up=NULL;}stati
cvoidupstream_channel_oil_detach(structpim_upstream*up){if(up->channel_oil){/*De
tachingfromchannel_oil,channel_oilmayexistpostdel,butupstreamwouldnotkeepreferen
ceofit*/up->channel_oil->up=NULL;pim_channel_oil_del(up->channel_oil);up->channe
l_oil=NULL;}}structpim_upstream*pim_upstream_del(structpim_instance*pim,structpi
m_upstream*up,constchar*name){boolnotify_msdp=false;structprefixnht_p;if(PIM_DEB
UG_TRACE)zlog_debug("%s(%s):Delete%s[%s]refcount:%d,flags:%dc_oilrefcount%d(Pred
ecrement)",__PRETTY_FUNCTION__,name,up->sg_str,pim->vrf->name,up->ref_count,up->
flags,up->channel_oil->oil_ref_count);--up->ref_count;if(up->ref_count>=1)return
up;THREAD_OFF(up->t_ka_timer);THREAD_OFF(up->t_rs_timer);THREAD_OFF(up->t_msdp_r
eg_timer);if(up->join_state==PIM_UPSTREAM_JOINED){pim_jp_agg_single_upstream_sen
d(&up->rpf,up,0);if(up->sg.src.s_addr==INADDR_ANY){/*ifa(*,G)entryinthejoinedsta
teisbeing*deletedwe*needtonotifyMSDP*/notify_msdp=true;}}join_timer_stop(up);pim
_jp_agg_upstream_verification(up,false);up->rpf.source_nexthop.interface=NULL;if
(up->sg.src.s_addr!=INADDR_ANY){wheel_remove_item(pim->upstream_sg_wheel,up);not
ify_msdp=true;}pim_upstream_remove_children(pim,up);if(up->sources)list_delete_a
nd_null(&up->sources);pim_mroute_del(up->channel_oil,__PRETTY_FUNCTION__);upstre
am_channel_oil_detach(up);list_delete_and_null(&up->ifchannels);/*noticethatlist
node_delete()can'tbemovedintopim_upstream_free()becausethelateriscalledbylist_de
lete_all_node()*/if(up->parent&&up->parent->sources)listnode_delete(up->parent->
sources,up);up->parent=NULL;listnode_delete(pim->upstream_list,up);hash_release(
pim->upstream_hash,up);if(notify_msdp){pim_msdp_up_del(pim,&up->sg);}/*Deregiste
raddrwithZebraNHT*/nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.
prefix4=up->upstream_addr;if(PIM_DEBUG_TRACE){charbuf[PREFIX2STR_BUFFER];prefix2
str(&nht_p,buf,sizeof(buf));zlog_debug("%s:Deregisterupstream%saddr%swithZebraNH
T",__PRETTY_FUNCTION__,up->sg_str,buf);}pim_delete_tracked_nexthop(pim,&nht_p,up
,NULL);pim_upstream_free(up);returnNULL;}voidpim_upstream_send_join(structpim_up
stream*up){if(PIM_DEBUG_TRACE){charrpf_str[PREFIX_STRLEN];pim_addr_dump("<rpf?>"
,&up->rpf.rpf_addr,rpf_str,sizeof(rpf_str));zlog_debug("%s:RPF'%s=%s(%s)forInter
face%s",__PRETTY_FUNCTION__,up->sg_str,rpf_str,pim_upstream_state2str(up->join_s
tate),up->rpf.source_nexthop.interface->name);if(pim_rpf_addr_is_inaddr_any(&up-
>rpf)){zlog_debug("%s:can'tsendjoinupstream:RPF'%s=%s",__PRETTY_FUNCTION__,up->s
g_str,rpf_str);/*warningonly*/}}/*sendJoin(S,G)tothecurrentupstreamneighbor*/pim
_jp_agg_single_upstream_send(&up->rpf,up,1/*join*/);}staticinton_join_timer(stru
ctthread*t){structpim_upstream*up;up=THREAD_ARG(t);/**InthecaseofaHFRwewillnotah
veanyonetosendthisto.*/if(PIM_UPSTREAM_FLAG_TEST_FHR(up->flags))return0;/**Don't
sendthejoiniftheoutgoinginterfaceisaloopback*Butsincethismightchangeleavethejoin
timerrunning*/if(up->rpf.source_nexthop.interface&&!if_is_loopback(up->rpf.sourc
e_nexthop.interface))pim_upstream_send_join(up);join_timer_start(up);return0;}st
aticvoidjoin_timer_stop(structpim_upstream*up){structpim_neighbor*nbr;THREAD_OFF
(up->t_join_timer);nbr=pim_neighbor_find(up->rpf.source_nexthop.interface,up->rp
f.rpf_addr.u.prefix4);if(nbr)pim_jp_agg_remove_group(nbr->upstream_jp_agg,up);pi
m_jp_agg_upstream_verification(up,false);}voidjoin_timer_start(structpim_upstrea
m*up){structpim_neighbor*nbr=NULL;if(up->rpf.source_nexthop.interface){nbr=pim_n
eighbor_find(up->rpf.source_nexthop.interface,up->rpf.rpf_addr.u.prefix4);if(PIM
_DEBUG_PIM_EVENTS){zlog_debug("%s:starting%dsectimerforupstream(S,G)=%s",__PRETT
Y_FUNCTION__,qpim_t_periodic,up->sg_str);}}if(nbr)pim_jp_agg_add_group(nbr->upst
ream_jp_agg,up,1);else{THREAD_OFF(up->t_join_timer);thread_add_timer(master,on_j
oin_timer,up,qpim_t_periodic,&up->t_join_timer);}pim_jp_agg_upstream_verificatio
n(up,true);}/**Thisisonlycalledwhenweareswitchingtheupstream*J/Pfromoneneighbort
oanother**Assuchweneedtoremovefromtheoldlistand*addtothenewlist.*/voidpim_upstre
am_join_timer_restart(structpim_upstream*up,structpim_rpf*old){//THREAD_OFF(up->
t_join_timer);join_timer_start(up);}staticvoidpim_upstream_join_timer_restart_ms
ec(structpim_upstream*up,intinterval_msec){if(PIM_DEBUG_PIM_EVENTS){zlog_debug("
%s:restarting%dmsectimerforupstream(S,G)=%s",__PRETTY_FUNCTION__,interval_msec,u
p->sg_str);}THREAD_OFF(up->t_join_timer);thread_add_timer_msec(master,on_join_ti
mer,up,interval_msec,&up->t_join_timer);}voidpim_upstream_join_suppress(structpi
m_upstream*up,structin_addrrpf_addr,intholdtime){longt_joinsuppress_msec;longjoi
n_timer_remain_msec;t_joinsuppress_msec=MIN(pim_if_t_suppressed_msec(up->rpf.sou
rce_nexthop.interface),1000*holdtime);join_timer_remain_msec=pim_time_timer_rema
in_msec(up->t_join_timer);if(PIM_DEBUG_TRACE){charrpf_str[INET_ADDRSTRLEN];pim_i
net4_dump("<rpf?>",rpf_addr,rpf_str,sizeof(rpf_str));zlog_debug("%s%s:detectedJo
in%stoRPF'(S,G)=%s:join_timer=%ldmsect_joinsuppress=%ldmsec",__FILE__,__PRETTY_F
UNCTION__,up->sg_str,rpf_str,join_timer_remain_msec,t_joinsuppress_msec);}if(joi
n_timer_remain_msec<t_joinsuppress_msec){if(PIM_DEBUG_TRACE){zlog_debug("%s%s:su
ppressingJoin(S,G)=%sfor%ldmsec",__FILE__,__PRETTY_FUNCTION__,up->sg_str,t_joins
uppress_msec);}pim_upstream_join_timer_restart_msec(up,t_joinsuppress_msec);}}vo
idpim_upstream_join_timer_decrease_to_t_override(constchar*debug_label,structpim
_upstream*up){longjoin_timer_remain_msec;intt_override_msec;join_timer_remain_ms
ec=pim_time_timer_remain_msec(up->t_join_timer);t_override_msec=pim_if_t_overrid
e_msec(up->rpf.source_nexthop.interface);if(PIM_DEBUG_TRACE){charrpf_str[INET_AD
DRSTRLEN];pim_inet4_dump("<rpf?>",up->rpf.rpf_addr.u.prefix4,rpf_str,sizeof(rpf_
str));zlog_debug("%s:toRPF'%s=%s:join_timer=%ldmsect_override=%dmsec",debug_labe
l,up->sg_str,rpf_str,join_timer_remain_msec,t_override_msec);}if(join_timer_rema
in_msec>t_override_msec){if(PIM_DEBUG_TRACE){zlog_debug("%s:decreasing(S,G)=%sjo
intimertot_override=%dmsec",debug_label,up->sg_str,t_override_msec);}pim_upstrea
m_join_timer_restart_msec(up,t_override_msec);}}staticvoidforward_on(structpim_u
pstream*up){structlistnode*chnode;structlistnode*chnextnode;structpim_ifchannel*
ch=NULL;/*scan(S,G)state*/for(ALL_LIST_ELEMENTS(up->ifchannels,chnode,chnextnode
,ch)){if(pim_macro_chisin_oiflist(ch))pim_forward_start(ch);}/*scanifacechannell
ist*/}staticvoidforward_off(structpim_upstream*up){structlistnode*chnode;structl
istnode*chnextnode;structpim_ifchannel*ch;/*scanper-interface(S,G)state*/for(ALL
_LIST_ELEMENTS(up->ifchannels,chnode,chnextnode,ch)){pim_forward_stop(ch,false);
}/*scanifacechannellist*/}staticintpim_upstream_could_register(structpim_upstrea
m*up){structpim_interface*pim_ifp=NULL;if(up->rpf.source_nexthop.interface)pim_i
fp=up->rpf.source_nexthop.interface->info;else{if(PIM_DEBUG_TRACE)zlog_debug("%s
:up%sRPFisnotpresent",__PRETTY_FUNCTION__,up->sg_str);}if(pim_ifp&&PIM_I_am_DR(p
im_ifp)&&pim_if_connected_to_source(up->rpf.source_nexthop.interface,up->sg.src)
)return1;return0;}/*SourceregistrationissupressedforSSMgroups.WhentheSSMrangecha
nges*were-revaluateregistersetupforexistingupstreamentries*/voidpim_upstream_reg
ister_reevaluate(structpim_instance*pim){structlistnode*upnode;structpim_upstrea
m*up;for(ALL_LIST_ELEMENTS_RO(pim->upstream_list,upnode,up)){/*IfFHRissetCouldRe
gisterisTrue.Alsocheckiftheflow*isactuallyactive;ifitisnotkatsetupwilltrigger*so
urce*registrationwhenevertheflowbecomesactive.*/if(!PIM_UPSTREAM_FLAG_TEST_FHR(u
p->flags)||!up->t_ka_timer)continue;if(pim_is_grp_ssm(pim,up->sg.grp)){/*clearth
eregisterstateforSSMgroups*/if(up->reg_state!=PIM_REG_NOINFO){if(PIM_DEBUG_PIM_E
VENTS)zlog_debug("Clearregisterfor%sasGisnowSSM",up->sg_str);/*removeregifacefro
mtheOILifitisthere*/pim_channel_del_oif(up->channel_oil,pim->regiface,PIM_OIF_FL
AG_PROTO_PIM);up->reg_state=PIM_REG_NOINFO;}}else{/*registerASMsourceswiththeRP*
/if(up->reg_state==PIM_REG_NOINFO){if(PIM_DEBUG_PIM_EVENTS)zlog_debug("Register%
sasGisnowASM",up->sg_str);pim_channel_add_oif(up->channel_oil,pim->regiface,PIM_
OIF_FLAG_PROTO_PIM);up->reg_state=PIM_REG_JOIN;}}}}voidpim_upstream_switch(struc
tpim_instance*pim,structpim_upstream*up,enumpim_upstream_statenew_state){enumpim
_upstream_stateold_state=up->join_state;if(PIM_DEBUG_PIM_EVENTS){zlog_debug("%s:
PIM_UPSTREAM_%s:(S,G)old:%snew:%s",__PRETTY_FUNCTION__,up->sg_str,pim_upstream_s
tate2str(up->join_state),pim_upstream_state2str(new_state));}up->join_state=new_
state;if(old_state!=new_state)up->state_transition=pim_time_monotonic_sec();pim_
upstream_update_assert_tracking_desired(up);if(new_state==PIM_UPSTREAM_JOINED){i
f(old_state!=PIM_UPSTREAM_JOINED){intold_fhr=PIM_UPSTREAM_FLAG_TEST_FHR(up->flag
s);forward_on(up);pim_msdp_up_join_state_changed(pim,up);if(pim_upstream_could_r
egister(up)){PIM_UPSTREAM_FLAG_SET_FHR(up->flags);if(!old_fhr&&PIM_UPSTREAM_FLAG
_TEST_SRC_STREAM(up->flags)){pim_upstream_keep_alive_timer_start(up,pim->keep_al
ive_time);pim_register_join(up);}}else{pim_upstream_send_join(up);join_timer_sta
rt(up);}}else{forward_on(up);}}else{forward_off(up);if(old_state==PIM_UPSTREAM_J
OINED)pim_msdp_up_join_state_changed(pim,up);/*IHR,TriggerSGRpton*,GIIFtopruneS,
GfromRPTtowardsRP.IfIamRPforGthensendS,GprunetoitsIIF.*/if(pim_upstream_is_sg_rp
t(up)&&up->parent&&!I_am_RP(pim,up->sg.grp)){if(PIM_DEBUG_PIM_TRACE_DETAIL)zlog_
debug("%s:*,GIIF%sS,GIIF%s",__PRETTY_FUNCTION__,up->parent->rpf.source_nexthop.i
nterface->name,up->rpf.source_nexthop.interface->name);pim_jp_agg_single_upstrea
m_send(&up->parent->rpf,up->parent,1/*(W,G)Join*/);}elsepim_jp_agg_single_upstre
am_send(&up->rpf,up,0/*prune*/);join_timer_stop(up);}}intpim_upstream_compare(vo
id*arg1,void*arg2){conststructpim_upstream*up1=(conststructpim_upstream*)arg1;co
nststructpim_upstream*up2=(conststructpim_upstream*)arg2;if(ntohl(up1->sg.grp.s_
addr)<ntohl(up2->sg.grp.s_addr))return-1;if(ntohl(up1->sg.grp.s_addr)>ntohl(up2-
>sg.grp.s_addr))return1;if(ntohl(up1->sg.src.s_addr)<ntohl(up2->sg.src.s_addr))r
eturn-1;if(ntohl(up1->sg.src.s_addr)>ntohl(up2->sg.src.s_addr))return1;return0;}
staticstructpim_upstream*pim_upstream_new(structpim_instance*pim,structprefix_sg
*sg,structinterface*incoming,intflags,structpim_ifchannel*ch){enumpim_rpf_result
rpf_result;structpim_interface*pim_ifp;structpim_upstream*up;up=XCALLOC(MTYPE_PI
M_UPSTREAM,sizeof(*up));if(!up){zlog_err("%s:PIMXCALLOC(%zu)failure",__PRETTY_FU
NCTION__,sizeof(*up));returnNULL;}up->sg=*sg;pim_str_sg_set(sg,up->sg_str);if(ch
)ch->upstream=up;up=hash_get(pim->upstream_hash,up,hash_alloc_intern);if(!pim_rp
_set_upstream_addr(pim,&up->upstream_addr,sg->src,sg->grp)){if(PIM_DEBUG_TRACE)z
log_debug("%s:Receiveda(*,G)withnoRPconfigured",__PRETTY_FUNCTION__);hash_releas
e(pim->upstream_hash,up);XFREE(MTYPE_PIM_UPSTREAM,up);returnNULL;}up->parent=pim
_upstream_find_parent(pim,up);if(up->sg.src.s_addr==INADDR_ANY){up->sources=list
_new();up->sources->cmp=pim_upstream_compare;}elseup->sources=NULL;pim_upstream_
find_new_children(pim,up);up->flags=flags;up->ref_count=1;up->t_join_timer=NULL;
up->t_ka_timer=NULL;up->t_rs_timer=NULL;up->t_msdp_reg_timer=NULL;up->join_state
=PIM_UPSTREAM_NOTJOINED;up->reg_state=PIM_REG_NOINFO;up->state_transition=pim_ti
me_monotonic_sec();up->channel_oil=NULL;up->sptbit=PIM_UPSTREAM_SPTBIT_FALSE;up-
>rpf.source_nexthop.interface=NULL;up->rpf.source_nexthop.mrib_nexthop_addr.fami
ly=AF_INET;up->rpf.source_nexthop.mrib_nexthop_addr.u.prefix4.s_addr=PIM_NET_INA
DDR_ANY;up->rpf.source_nexthop.mrib_metric_preference=qpim_infinite_assert_metri
c.metric_preference;up->rpf.source_nexthop.mrib_route_metric=qpim_infinite_asser
t_metric.route_metric;up->rpf.rpf_addr.family=AF_INET;up->rpf.rpf_addr.u.prefix4
.s_addr=PIM_NET_INADDR_ANY;up->ifchannels=list_new();up->ifchannels->cmp=(int(*)
(void*,void*))pim_ifchannel_compare;if(up->sg.src.s_addr!=INADDR_ANY)wheel_add_i
tem(pim->upstream_sg_wheel,up);rpf_result=pim_rpf_update(pim,up,NULL,1);if(rpf_r
esult==PIM_RPF_FAILURE){structprefixnht_p;if(PIM_DEBUG_TRACE)zlog_debug("%s:Atte
mptingtocreateupstream(%s),UnabletoRPFforsource",__PRETTY_FUNCTION__,up->sg_str)
;nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4=up->upstre
am_addr;pim_delete_tracked_nexthop(pim,&nht_p,up,NULL);if(up->parent){listnode_d
elete(up->parent->sources,up);up->parent=NULL;}if(up->sg.src.s_addr!=INADDR_ANY)
wheel_remove_item(pim->upstream_sg_wheel,up);pim_upstream_remove_children(pim,up
);if(up->sources)list_delete_and_null(&up->sources);list_delete_and_null(&up->if
channels);hash_release(pim->upstream_hash,up);XFREE(MTYPE_PIM_UPSTREAM,up);retur
nNULL;}if(up->rpf.source_nexthop.interface){pim_ifp=up->rpf.source_nexthop.inter
face->info;if(pim_ifp)up->channel_oil=pim_channel_oil_add(pim,&up->sg,pim_ifp->m
route_vif_index);}listnode_add_sort(pim->upstream_list,up);if(PIM_DEBUG_TRACE){z
log_debug("%s:CreatedUpstream%supstream_addr%srefcount%dincrement",__PRETTY_FUNC
TION__,up->sg_str,inet_ntoa(up->upstream_addr),up->ref_count);}returnup;}structp
im_upstream*pim_upstream_find(structpim_instance*pim,structprefix_sg*sg){structp
im_upstreamlookup;structpim_upstream*up=NULL;lookup.sg=*sg;up=hash_lookup(pim->u
pstream_hash,&lookup);returnup;}structpim_upstream*pim_upstream_find_or_add(stru
ctprefix_sg*sg,structinterface*incoming,intflags,constchar*name){structpim_upstr
eam*up;structpim_interface*pim_ifp;pim_ifp=incoming->info;up=pim_upstream_find(p
im_ifp->pim,sg);if(up){if(!(up->flags&flags)){up->flags|=flags;up->ref_count++;i
f(PIM_DEBUG_TRACE)zlog_debug("%s(%s):upstream%srefcount%dincrement",__PRETTY_FUN
CTION__,name,up->sg_str,up->ref_count);}}elseup=pim_upstream_add(pim_ifp->pim,sg
,incoming,flags,name,NULL);returnup;}voidpim_upstream_ref(structpim_upstream*up,
intflags,constchar*name){up->flags|=flags;++up->ref_count;if(PIM_DEBUG_TRACE)zlo
g_debug("%s(%s):upstream%srefcount%dincrement",__PRETTY_FUNCTION__,name,up->sg_s
tr,up->ref_count);}structpim_upstream*pim_upstream_add(structpim_instance*pim,st
ructprefix_sg*sg,structinterface*incoming,intflags,constchar*name,structpim_ifch
annel*ch){structpim_upstream*up=NULL;intfound=0;up=pim_upstream_find(pim,sg);if(
up){pim_upstream_ref(up,flags,name);found=1;}else{up=pim_upstream_new(pim,sg,inc
oming,flags,ch);}if(PIM_DEBUG_TRACE){if(up){charbuf[PREFIX2STR_BUFFER];prefix2st
r(&up->rpf.rpf_addr,buf,sizeof(buf));zlog_debug("%s(%s):%s,iif%s(%s)found:%d:ref
_count:%d",__PRETTY_FUNCTION__,name,up->sg_str,buf,up->rpf.source_nexthop.interf
ace?up->rpf.source_nexthop.interface->name:"NIL",found,up->ref_count);}elsezlog_
debug("%s(%s):(%s)failuretocreate",__PRETTY_FUNCTION__,name,pim_str_sg_dump(sg))
;}returnup;}/**Passedinupmustbetheupstreamforch.starchisNULLifno*information*/in
tpim_upstream_evaluate_join_desired_interface(structpim_upstream*up,structpim_if
channel*ch,structpim_ifchannel*starch){if(ch){if(PIM_IF_FLAG_TEST_S_G_RPT(ch->fl
ags))return0;if(!pim_macro_ch_lost_assert(ch)&&pim_macro_chisin_joins_or_include
(ch))return1;}/**joins(*,G)*/if(starch){if(PIM_IF_FLAG_TEST_S_G_RPT(starch->upst
ream->flags))return0;if(!pim_macro_ch_lost_assert(starch)&&pim_macro_chisin_join
s_or_include(starch))return1;}return0;}/*EvaluateJoinDesired(S,G):JoinDesired(S,
G)istrueifthereisadownstream(S,G)interfaceIintheset:inherited_olist(S,G)=joins(S
,G)(+)pim_include(S,G)(-)lost_assert(S,G)JoinDesired(S,G)maybeaffectedbychangesi
nthefollowing:pim_ifp->primary_addresspim_ifp->pim_dr_addrch->ifassert_winner_me
tricch->ifassert_winnerch->local_ifmembershipch->ifjoin_statech->upstream->rpf.s
ource_nexthop.mrib_metric_preferencech->upstream->rpf.source_nexthop.mrib_route_
metricch->upstream->rpf.source_nexthop.interfaceSeealsopim_upstream_update_join_
desired()below.*/intpim_upstream_evaluate_join_desired(structpim_instance*pim,st
ructpim_upstream*up){structinterface*ifp;structpim_ifchannel*ch,*starch;structpi
m_upstream*starup=up->parent;intret=0;FOR_ALL_INTERFACES(pim->vrf,ifp){if(!ifp->
info)continue;ch=pim_ifchannel_find(ifp,&up->sg);if(starup)starch=pim_ifchannel_
find(ifp,&starup->sg);elsestarch=NULL;if(!ch&&!starch)continue;ret+=pim_upstream
_evaluate_join_desired_interface(up,ch,starch);}/*scanifacechannellist*/returnre
t;/*false*/}/*Seealsopim_upstream_evaluate_join_desired()above.*/voidpim_upstrea
m_update_join_desired(structpim_instance*pim,structpim_upstream*up){intwas_join_
desired;/*boolean*/intis_join_desired;/*boolean*/was_join_desired=PIM_UPSTREAM_F
LAG_TEST_DR_JOIN_DESIRED(up->flags);is_join_desired=pim_upstream_evaluate_join_d
esired(pim,up);if(is_join_desired)PIM_UPSTREAM_FLAG_SET_DR_JOIN_DESIRED(up->flag
s);elsePIM_UPSTREAM_FLAG_UNSET_DR_JOIN_DESIRED(up->flags);/*switchedfromfalsetot
rue*/if(is_join_desired&&!was_join_desired){pim_upstream_switch(pim,up,PIM_UPSTR
EAM_JOINED);return;}/*switchedfromtruetofalse*/if(!is_join_desired&&was_join_des
ired){pim_upstream_switch(pim,up,PIM_UPSTREAM_NOTJOINED);return;}}/*RFC46014.5.7
.Sending(S,G)Join/PruneMessagesTransitionsfromJoinedStateRPF'(S,G)GenIDchangesTh
eupstream(S,G)statemachineremainsinJoinedstate.IftheJoinTimerissettoexpireinmore
thant_overrideseconds,resetitsothatitexpiresaftert_overrideseconds.*/voidpim_ups
tream_rpf_genid_changed(structpim_instance*pim,structin_addrneigh_addr){structli
stnode*up_node;structlistnode*up_nextnode;structpim_upstream*up;/**Scanall(S,G)u
pstreamssearchingforRPF'(S,G)=neigh_addr*/for(ALL_LIST_ELEMENTS(pim->upstream_li
st,up_node,up_nextnode,up)){if(PIM_DEBUG_TRACE){charneigh_str[INET_ADDRSTRLEN];c
harrpf_addr_str[PREFIX_STRLEN];pim_inet4_dump("<neigh?>",neigh_addr,neigh_str,si
zeof(neigh_str));pim_addr_dump("<rpf?>",&up->rpf.rpf_addr,rpf_addr_str,sizeof(rp
f_addr_str));zlog_debug("%s:matchingneigh=%sagainstupstream(S,G)=%s[%s]joined=%d
rpf_addr=%s",__PRETTY_FUNCTION__,neigh_str,up->sg_str,pim->vrf->name,up->join_st
ate==PIM_UPSTREAM_JOINED,rpf_addr_str);}/*consideronly(S,G)upstreaminJoinedstate
*/if(up->join_state!=PIM_UPSTREAM_JOINED)continue;/*matchRPF'(S,G)=neigh_addr*/i
f(up->rpf.rpf_addr.u.prefix4.s_addr!=neigh_addr.s_addr)continue;pim_upstream_joi
n_timer_decrease_to_t_override("RPF'(S,G)GenIDchange",up);}}voidpim_upstream_rpf
_interface_changed(structpim_upstream*up,structinterface*old_rpf_ifp){structlist
node*chnode;structlistnode*chnextnode;structpim_ifchannel*ch;/*searchallifchanne
ls*/for(ALL_LIST_ELEMENTS(up->ifchannels,chnode,chnextnode,ch)){if(ch->ifassert_
state==PIM_IFASSERT_I_AM_LOSER){if(/*RPF_interface(S)wasNOTI*/(old_rpf_ifp==ch->
interface)&&/*RPF_interface(S)stoppedbeingI*/(ch->upstream->rpf.source_nexthop.i
nterface!=ch->interface)){assert_action_a5(ch);}}/*PIM_IFASSERT_I_AM_LOSER*/pim_
ifchannel_update_assert_tracking_desired(ch);}}voidpim_upstream_update_could_ass
ert(structpim_upstream*up){structlistnode*chnode;structlistnode*chnextnode;struc
tpim_ifchannel*ch;/*scanper-interface(S,G)state*/for(ALL_LIST_ELEMENTS(up->ifcha
nnels,chnode,chnextnode,ch)){pim_ifchannel_update_could_assert(ch);}/*scanifacec
hannellist*/}voidpim_upstream_update_my_assert_metric(structpim_upstream*up){str
uctlistnode*chnode;structlistnode*chnextnode;structpim_ifchannel*ch;/*scanper-in
terface(S,G)state*/for(ALL_LIST_ELEMENTS(up->ifchannels,chnode,chnextnode,ch)){p
im_ifchannel_update_my_assert_metric(ch);}/*scanifacechannellist*/}staticvoidpim
_upstream_update_assert_tracking_desired(structpim_upstream*up){structlistnode*c
hnode;structlistnode*chnextnode;structpim_interface*pim_ifp;structpim_ifchannel*
ch;/*scanper-interface(S,G)state*/for(ALL_LIST_ELEMENTS(up->ifchannels,chnode,ch
nextnode,ch)){if(!ch->interface)continue;pim_ifp=ch->interface->info;if(!pim_ifp
)continue;pim_ifchannel_update_assert_tracking_desired(ch);}/*scanifacechannelli
st*/}/*WhenkatisstoppedCouldRegistergoestofalsesoweneedto*transitionthe(S,G)onFH
RtoNIstateandremoveregtunnel*fromtheOIL*/staticvoidpim_upstream_fhr_kat_expiry(s
tructpim_instance*pim,structpim_upstream*up){if(!PIM_UPSTREAM_FLAG_TEST_FHR(up->
flags))return;if(PIM_DEBUG_TRACE)zlog_debug("katexpiredon%s;clearfhrregstate",up
->sg_str);/*stopreg-stoptimer*/THREAD_OFF(up->t_rs_timer);/*removeregifacefromth
eOILifitisthere*/pim_channel_del_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_
PROTO_PIM);/*cleartheregisterstate*/up->reg_state=PIM_REG_NOINFO;PIM_UPSTREAM_FL
AG_UNSET_FHR(up->flags);}/*WhenkatisstartedCouldRegistercangototrue.Andifitdoesw
e*needtotransitionthe(S,G)onFHRtoJOINEDstateandaddregtunnel*totheOIL*/staticvoid
pim_upstream_fhr_kat_start(structpim_upstream*up){if(pim_upstream_could_register
(up)){if(PIM_DEBUG_TRACE)zlog_debug("katstartedon%s;setfhrregstatetojoined",up->
sg_str);PIM_UPSTREAM_FLAG_SET_FHR(up->flags);if(up->reg_state==PIM_REG_NOINFO)pi
m_register_join(up);}}/**OnanRP,thePMBRvaluemustbeclearedwhenthe*KeepaliveTimere
xpires*KATexpiryindicatesthatflowisinactive.Iftheflowwascreatedor*maintainedbyac
tivitynowisthetimetoderefit.*/staticintpim_upstream_keep_alive_timer(structthrea
d*t){structpim_upstream*up;structpim_instance*pim;up=THREAD_ARG(t);pim=up->chann
el_oil->pim;if(I_am_RP(pim,up->sg.grp)){pim_br_clear_pmbr(&up->sg);/**Weneedtodo
morehere:)*Butthisisthestart.*/}/*sourceisnolongeractive-pulltheSAfromMSDP'scach
e*/pim_msdp_sa_local_del(pim,&up->sg);/*ifentrywascreatedbecauseofactivityweneed
toderefit*/if(PIM_UPSTREAM_FLAG_TEST_SRC_STREAM(up->flags)){pim_upstream_fhr_kat
_expiry(pim,up);if(PIM_DEBUG_TRACE)zlog_debug("katexpiredon%s[%s];removestreamre
ference",up->sg_str,pim->vrf->name);PIM_UPSTREAM_FLAG_UNSET_SRC_STREAM(up->flags
);pim_upstream_del(pim,up,__PRETTY_FUNCTION__);}elseif(PIM_UPSTREAM_FLAG_TEST_SR
C_LHR(up->flags)){structpim_upstream*parent=up->parent;PIM_UPSTREAM_FLAG_UNSET_S
RC_LHR(up->flags);pim_upstream_del(pim,up,__PRETTY_FUNCTION__);if(parent){pim_jp
_agg_single_upstream_send(&parent->rpf,parent,true);}}return0;}voidpim_upstream_
keep_alive_timer_start(structpim_upstream*up,uint32_ttime){if(!PIM_UPSTREAM_FLAG
_TEST_SRC_STREAM(up->flags)){if(PIM_DEBUG_TRACE)zlog_debug("katstarton%swithnost
reamreference",up->sg_str);}THREAD_OFF(up->t_ka_timer);thread_add_timer(master,p
im_upstream_keep_alive_timer,up,time,&up->t_ka_timer);/*anytimekeepaliveisstarte
dagainstaSGwewillhaveto*re-evaluateouractivesourcedatabase*/pim_msdp_sa_local_up
date(up);}/*MSDPonRPneedstoknowifasourceisregisterabletothisRP*/staticintpim_ups
tream_msdp_reg_timer(structthread*t){structpim_upstream*up=THREAD_ARG(t);structp
im_instance*pim=up->channel_oil->pim;/*sourceisnolongeractive-pulltheSAfromMSDP'
scache*/pim_msdp_sa_local_del(pim,&up->sg);return1;}voidpim_upstream_msdp_reg_ti
mer_start(structpim_upstream*up){THREAD_OFF(up->t_msdp_reg_timer);thread_add_tim
er(master,pim_upstream_msdp_reg_timer,up,PIM_MSDP_REG_RXED_PERIOD,&up->t_msdp_re
g_timer);pim_msdp_sa_local_update(up);}/**4.2.1Last-HopSwitchovertotheSPT**InSpa
rse-ModePIM,last-hoproutersjointhesharedtreetowardsthe*RP.Oncetrafficfromsources
tojoinedgroupsarrivesatalast-hop*router,ithastheoptionofswitchingtoreceivethetra
fficona*shortestpathtree(SPT).**ThedecisionforaroutertoswitchtotheSPTiscontrolle
das*follows:**void*CheckSwitchToSpt(S,G){*if((pim_include(*,G)(-)pim_exclude(S,G
)*(+)pim_include(S,G)!=NULL)*ANDSwitchToSptDesired(S,G)){*#Note:RestartingtheKAT
willresultintheSPTswitch*setKeepaliveTimer(S,G)toKeepalive_Period*}*}**SwitchToS
ptDesired(S,G)isapolicyfunctionthatisimplementation*defined.An"infinitethreshold
"policycanbeimplementedbymaking*SwitchToSptDesired(S,G)returnfalseallthetime.A"s
witchon*firstpacket"policycanbeimplementedbymaking*SwitchToSptDesired(S,G)return
trueonceasinglepackethasbeen*receivedforthesourceandgroup.*/intpim_upstream_swit
ch_to_spt_desired(structpim_instance*pim,structprefix_sg*sg){if(I_am_RP(pim,sg->
grp))return1;return0;}intpim_upstream_is_sg_rpt(structpim_upstream*up){structlis
tnode*chnode;structpim_ifchannel*ch;for(ALL_LIST_ELEMENTS_RO(up->ifchannels,chno
de,ch)){if(PIM_IF_FLAG_TEST_S_G_RPT(ch->flags))return1;}return0;}/**Afterreceivi
ngapacketsetSPTbit:*void*Update_SPTbit(S,G,iif){*if(iif==RPF_interface(S)*ANDJoi
nDesired(S,G)==TRUE*AND(DirectlyConnected(S)==TRUE*ORRPF_interface(S)!=RPF_inter
face(RP(G))*ORinherited_olist(S,G,rpt)==NULL*OR((RPF'(S,G)==RPF'(*,G))AND*(RPF'(
S,G)!=NULL))*OR(I_Am_Assert_Loser(S,G,iif)){*SetSPTbit(S,G)toTRUE*}*}*/voidpim_u
pstream_set_sptbit(structpim_upstream*up,structinterface*incoming){structpim_ups
tream*starup=up->parent;//iif==RPF_interfvace(S)if(up->rpf.source_nexthop.interf
ace!=incoming){if(PIM_DEBUG_TRACE)zlog_debug("%s:IncomingInterface:%sisdifferent
thanRPF_interface(S)%s",__PRETTY_FUNCTION__,incoming->name,up->rpf.source_nextho
p.interface->name);return;}//ANDJoinDesired(S,G)==TRUE//FIXME//DirectlyConnected
(S)==TRUEif(pim_if_connected_to_source(up->rpf.source_nexthop.interface,up->sg.s
rc)){if(PIM_DEBUG_TRACE)zlog_debug("%s:%sisdirectlyconnectedtothesource",__PRETT
Y_FUNCTION__,up->sg_str);up->sptbit=PIM_UPSTREAM_SPTBIT_TRUE;return;}//ORRPF_int
erface(S)!=RPF_interface(RP(G))if(!starup||up->rpf.source_nexthop.interface!=sta
rup->rpf.source_nexthop.interface){if(PIM_DEBUG_TRACE)zlog_debug("%s:%sRPF_inter
face(S)!=RPF_interface(RP(G))",__PRETTY_FUNCTION__,up->sg_str);up->sptbit=PIM_UP
STREAM_SPTBIT_TRUE;return;}//ORinherited_olist(S,G,rpt)==NULLif(pim_upstream_is_
sg_rpt(up)&&pim_upstream_empty_inherited_olist(up)){if(PIM_DEBUG_TRACE)zlog_debu
g("%s:%sORinherited_olist(S,G,rpt)==NULL",__PRETTY_FUNCTION__,up->sg_str);up->sp
tbit=PIM_UPSTREAM_SPTBIT_TRUE;return;}//OR((RPF'(S,G)==RPF'(*,G))AND//(RPF'(S,G)
!=NULL))if(up->parent&&pim_rpf_is_same(&up->rpf,&up->parent->rpf)){if(PIM_DEBUG_
TRACE)zlog_debug("%s:%sRPF'(S,G)isthesameasRPF'(*,G)",__PRETTY_FUNCTION__,up->sg
_str);up->sptbit=PIM_UPSTREAM_SPTBIT_TRUE;return;}return;}constchar*pim_upstream
_state2str(enumpim_upstream_statejoin_state){switch(join_state){casePIM_UPSTREAM
_NOTJOINED:return"NotJoined";break;casePIM_UPSTREAM_JOINED:return"Joined";break;
}return"Unknown";}constchar*pim_reg_state2str(enumpim_reg_statereg_state,char*st
ate_str){switch(reg_state){casePIM_REG_NOINFO:strcpy(state_str,"RegNoInfo");brea
k;casePIM_REG_JOIN:strcpy(state_str,"RegJoined");break;casePIM_REG_JOIN_PENDING:
strcpy(state_str,"RegJoinPend");break;casePIM_REG_PRUNE:strcpy(state_str,"RegPru
ne");break;default:strcpy(state_str,"RegUnknown");}returnstate_str;}staticintpim
_upstream_register_stop_timer(structthread*t){structpim_interface*pim_ifp;struct
pim_instance*pim;structpim_upstream*up;structpim_rpf*rpg;structipip_hdr;up=THREA
D_ARG(t);pim=up->channel_oil->pim;if(PIM_DEBUG_TRACE){charstate_str[PIM_REG_STAT
E_STR_LEN];zlog_debug("%s:(S,G)=%s[%s]upstreamregisterstoptimer%s",__PRETTY_FUNC
TION__,up->sg_str,pim->vrf->name,pim_reg_state2str(up->reg_state,state_str));}sw
itch(up->reg_state){casePIM_REG_JOIN_PENDING:up->reg_state=PIM_REG_JOIN;pim_chan
nel_add_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_PIM);break;casePIM_
REG_JOIN:break;casePIM_REG_PRUNE:pim_ifp=up->rpf.source_nexthop.interface->info;
if(!pim_ifp){if(PIM_DEBUG_TRACE)zlog_debug("%s:Interface:%sisnotconfiguredforpim
",__PRETTY_FUNCTION__,up->rpf.source_nexthop.interface->name);return0;}up->reg_s
tate=PIM_REG_JOIN_PENDING;pim_upstream_start_register_stop_timer(up,1);if(((up->
channel_oil->cc.lastused/100)>pim->keep_alive_time)&&(I_am_RP(pim_ifp->pim,up->s
g.grp))){if(PIM_DEBUG_TRACE)zlog_debug("%s:Stopsendingtheregister,becauseIamtheR
Pandwehaven'tseenapacketinawhile",__PRETTY_FUNCTION__);return0;}rpg=RP(pim_ifp->
pim,up->sg.grp);if(!rpg){if(PIM_DEBUG_TRACE)zlog_debug("%s:Cannotsendregisterfor
%snoRPFtotheRP",__PRETTY_FUNCTION__,up->sg_str);return0;}memset(&ip_hdr,0,sizeof
(structip));ip_hdr.ip_p=PIM_IP_PROTO_PIM;ip_hdr.ip_hl=5;ip_hdr.ip_v=4;ip_hdr.ip_
src=up->sg.src;ip_hdr.ip_dst=up->sg.grp;ip_hdr.ip_len=htons(20);//checksumisbrok
enpim_register_send((uint8_t*)&ip_hdr,sizeof(structip),pim_ifp->primary_address,
rpg,1,up);break;default:break;}return0;}voidpim_upstream_start_register_stop_tim
er(structpim_upstream*up,intnull_register){uint32_ttime;THREAD_TIMER_OFF(up->t_r
s_timer);if(!null_register){uint32_tlower=(0.5*PIM_REGISTER_SUPPRESSION_PERIOD);
uint32_tupper=(1.5*PIM_REGISTER_SUPPRESSION_PERIOD);time=lower+(random()%(upper-
lower+1))-PIM_REGISTER_PROBE_PERIOD;}elsetime=PIM_REGISTER_PROBE_PERIOD;if(PIM_D
EBUG_TRACE){zlog_debug("%s:(S,G)=%sStartingupstreamregisterstoptimer%d",__PRETTY
_FUNCTION__,up->sg_str,time);}thread_add_timer(master,pim_upstream_register_stop
_timer,up,time,&up->t_rs_timer);}intpim_upstream_inherited_olist_decide(structpi
m_instance*pim,structpim_upstream*up){structinterface*ifp;structpim_interface*pi
m_ifp=NULL;structpim_ifchannel*ch,*starch;structpim_upstream*starup=up->parent;i
ntoutput_intf=0;if(up->rpf.source_nexthop.interface)pim_ifp=up->rpf.source_nexth
op.interface->info;else{if(PIM_DEBUG_TRACE)zlog_debug("%s:up%sRPFisnotpresent",_
_PRETTY_FUNCTION__,up->sg_str);}if(pim_ifp&&!up->channel_oil)up->channel_oil=pim
_channel_oil_add(pim,&up->sg,pim_ifp->mroute_vif_index);FOR_ALL_INTERFACES(pim->
vrf,ifp){if(!ifp->info)continue;ch=pim_ifchannel_find(ifp,&up->sg);if(starup)sta
rch=pim_ifchannel_find(ifp,&starup->sg);elsestarch=NULL;if(!ch&&!starch)continue
;if(pim_upstream_evaluate_join_desired_interface(up,ch,starch)){intflag=PIM_OIF_
FLAG_PROTO_PIM;if(!ch)flag=PIM_OIF_FLAG_PROTO_STAR;pim_channel_add_oif(up->chann
el_oil,ifp,flag);output_intf++;}}returnoutput_intf;}/**Foragivenupstream,determi
netheinherited_olist*andapplyit.**inherited_olist(S,G,rpt)=*(joins(*,*,RP(G))(+)
joins(*,G)(-)prunes(S,G,rpt))*(+)(pim_include(*,G)(-)pim_exclude(S,G))*(-)(lost_
assert(*,G)(+)lost_assert(S,G,rpt))**inherited_olist(S,G)=*inherited_olist(S,G,r
pt)(+)*joins(S,G)(+)pim_include(S,G)(-)lost_assert(S,G)**return1ifthereareanyout
putinterfaces*return0iftherearenotanyoutputinterfaces*/intpim_upstream_inherited
_olist(structpim_instance*pim,structpim_upstream*up){intoutput_intf=pim_upstream
_inherited_olist_decide(pim,up);/**Ifwehaveoutput_intfswitchstatetoJoinandworkli
kenormal*Ifwedon'thaveanoutput_intfthatmeansweareprobablya*switchonasticksoturno
nforwardingtojustacceptthe*incomingpacketssowedon'tbothertheotherstuff!*/if(outp
ut_intf)pim_upstream_switch(pim,up,PIM_UPSTREAM_JOINED);elseforward_on(up);retur
noutput_intf;}intpim_upstream_empty_inherited_olist(structpim_upstream*up){retur
npim_channel_oil_empty(up->channel_oil);}/**Whenwehaveanewneighbor,*findupstream
sthatdon'thavetheirrpf_addr*setandseeifthenewneighborallows*thejointobesent*/voi
dpim_upstream_find_new_rpf(structpim_instance*pim){structlistnode*up_node;struct
listnode*up_nextnode;structpim_upstream*up;/**Scanall(S,G)upstreamssearchingforR
PF'(S,G)=neigh_addr*/for(ALL_LIST_ELEMENTS(pim->upstream_list,up_node,up_nextnod
e,up)){if(pim_rpf_addr_is_inaddr_any(&up->rpf)){if(PIM_DEBUG_TRACE)zlog_debug("U
pstream%swithoutapathtosendjoin,checking",up->sg_str);pim_rpf_update(pim,up,NULL
,1);}}}unsignedintpim_upstream_hash_key(void*arg){structpim_upstream*up=(structp
im_upstream*)arg;returnjhash_2words(up->sg.src.s_addr,up->sg.grp.s_addr,0);}void
pim_upstream_terminate(structpim_instance*pim){if(pim->upstream_list)list_delete
_and_null(&pim->upstream_list);if(pim->upstream_hash)hash_free(pim->upstream_has
h);pim->upstream_hash=NULL;}intpim_upstream_equal(constvoid*arg1,constvoid*arg2)
{conststructpim_upstream*up1=(conststructpim_upstream*)arg1;conststructpim_upstr
eam*up2=(conststructpim_upstream*)arg2;if((up1->sg.grp.s_addr==up2->sg.grp.s_add
r)&&(up1->sg.src.s_addr==up2->sg.src.s_addr))return1;return0;}/*rfc4601:section-
4.2:"DataPacketForwardingRules"defines*thecaseswherekathastoberestartedonrxingtr
affic-**if(DirectlyConnected(S)==TRUEANDiif==RPF_interface(S)){*setKeepaliveTime
r(S,G)toKeepalive_Period*#Note:aregisterstatetransitionorUpstreamJPState(S,G)*#t
ransitionmayhappenasaresultofrestarting*#KeepaliveTimer,andmustbedealtwithhere.*
}*if(iif==RPF_interface(S)ANDUpstreamJPState(S,G)==JoinedAND*inherited_olist(S,G
)!=NULL){*setKeepaliveTimer(S,G)toKeepalive_Period*}*/staticboolpim_upstream_kat
_start_ok(structpim_upstream*up){structpim_instance*pim=up->channel_oil->pim;/*"
iif==RPF_interface(S)"checkhastobedonebythekernelorhw*sowewillskipthathere*/if(p
im_if_connected_to_source(up->rpf.source_nexthop.interface,up->sg.src)){returntr
ue;}if((up->join_state==PIM_UPSTREAM_JOINED)&&!pim_upstream_empty_inherited_olis
t(up)){/*XXX:IhaveaddedthisRPcheckjustfor3.2andit'sa*digressionfrom*whatrfc-4601
says.TillnowwewereonlyrunningKATonFHR*andRPand*thereissomeangstaroundmakingthech
angetorunitall*routersthat*maintainthe(S,G)state.ThisistrackedviaCM-13601and*MUS
Tbe*removedtohandlesptturn-aroundscorrectlyina3-tierclos*/if(I_am_RP(pim,up->sg.
grp))returntrue;}returnfalse;}/**Codetocheckandseeifwe'vereceivedpacketsonaS,Gmr
oute*andifsotosettheSPTbitappropriately*/staticvoidpim_upstream_sg_running(void*
arg){structpim_upstream*up=(structpim_upstream*)arg;structpim_instance*pim=up->c
hannel_oil->pim;//Nopacketcanhavearrivedhereifthisisthecaseif(!up->channel_oil->
installed){if(PIM_DEBUG_TRACE)zlog_debug("%s:%s[%s]isnotinstalledinmroute",__PRE
TTY_FUNCTION__,up->sg_str,pim->vrf->name);return;}/**Thisisabitofahack*We'venote
dthatweshouldrescanbut*we'vemissedthewindowfordoingsoin*pim_zebra.cforsomereason
.Iam*onlydoingthisatthispointintime*togetusupandworkingforthemoment*/if(up->chan
nel_oil->oil_inherited_rescan){if(PIM_DEBUG_TRACE)zlog_debug("%s:Handlingunscann
edinherited_olistfor%s[%s]",__PRETTY_FUNCTION__,up->sg_str,pim->vrf->name);pim_u
pstream_inherited_olist_decide(pim,up);up->channel_oil->oil_inherited_rescan=0;}
pim_mroute_update_counters(up->channel_oil);//Haveweseenpackets?if((up->channel_
oil->cc.oldpktcnt>=up->channel_oil->cc.pktcnt)&&(up->channel_oil->cc.lastused/10
0>30)){if(PIM_DEBUG_TRACE){zlog_debug("%s[%s]:%soldpacketcountisequalorlastusedi
sgreaterthan30,(%ld,%ld,%lld)",__PRETTY_FUNCTION__,up->sg_str,pim->vrf->name,up-
>channel_oil->cc.oldpktcnt,up->channel_oil->cc.pktcnt,up->channel_oil->cc.lastus
ed/100);}return;}if(pim_upstream_kat_start_ok(up)){/*Addasourcereferencetothestr
eamif*onedoesn'talreadyexist*/if(!PIM_UPSTREAM_FLAG_TEST_SRC_STREAM(up->flags)){
if(PIM_DEBUG_TRACE)zlog_debug("sourcereferencecreatedonkatrestart%s[%s]",up->sg_
str,pim->vrf->name);pim_upstream_ref(up,PIM_UPSTREAM_FLAG_MASK_SRC_STREAM,__PRET
TY_FUNCTION__);PIM_UPSTREAM_FLAG_SET_SRC_STREAM(up->flags);pim_upstream_fhr_kat_
start(up);}pim_upstream_keep_alive_timer_start(up,pim->keep_alive_time);}elseif(
PIM_UPSTREAM_FLAG_TEST_SRC_LHR(up->flags))pim_upstream_keep_alive_timer_start(up
,pim->keep_alive_time);if(up->sptbit!=PIM_UPSTREAM_SPTBIT_TRUE){pim_upstream_set
_sptbit(up,up->rpf.source_nexthop.interface);}return;}voidpim_upstream_add_lhr_s
tar_pimreg(structpim_instance*pim){structpim_upstream*up;structlistnode*node;for
(ALL_LIST_ELEMENTS_RO(pim->upstream_list,node,up)){if(up->sg.src.s_addr!=INADDR_
ANY)continue;if(!PIM_UPSTREAM_FLAG_TEST_SRC_IGMP(up->flags))continue;pim_channel
_add_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_IGMP);}}voidpim_upstre
am_spt_prefix_list_update(structpim_instance*pim,structprefix_list*pl){constchar
*pname=prefix_list_name(pl);if(pim->spt.plist&&strcmp(pim->spt.plist,pname)==0){
pim_upstream_remove_lhr_star_pimreg(pim,pname);}}/**nlist->Thenewprefixlist**Per
GroupApplicationofpimregtotheOIL*IftheprefixlisttellsusDENYthen*weneedtoSwitchov
ertoSPTimmediate*soaddthepimreg.*IftheprefixlisttellsustoACCEPTthan*weneedtoNeve
rdotheSPTsoremove*theinterface**/voidpim_upstream_remove_lhr_star_pimreg(structp
im_instance*pim,constchar*nlist){structpim_upstream*up;structlistnode*node;struc
tprefix_list*np;structprefixg;enumprefix_list_typeapply_new;np=prefix_list_looku
p(AFI_IP,nlist);g.family=AF_INET;g.prefixlen=IPV4_MAX_PREFIXLEN;for(ALL_LIST_ELE
MENTS_RO(pim->upstream_list,node,up)){if(up->sg.src.s_addr!=INADDR_ANY)continue;
if(!PIM_UPSTREAM_FLAG_TEST_SRC_IGMP(up->flags))continue;if(!nlist){pim_channel_d
el_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_IGMP);continue;}g.u.pref
ix4=up->sg.grp;apply_new=prefix_list_apply(np,&g);if(apply_new==PREFIX_DENY)pim_
channel_add_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_IGMP);elsepim_c
hannel_del_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_IGMP);}}voidpim_
upstream_init(structpim_instance*pim){charhash_name[64];pim->upstream_sg_wheel=w
heel_init(master,31000,100,pim_upstream_hash_key,pim_upstream_sg_running);snprin
tf(hash_name,64,"PIM%sUpstreamHash",pim->vrf->name);pim->upstream_hash=hash_crea
te_size(8192,pim_upstream_hash_key,pim_upstream_equal,hash_name);pim->upstream_l
ist=list_new();pim->upstream_list->del=(void(*)(void*))pim_upstream_free;pim->up
stream_list->cmp=pim_upstream_compare;}