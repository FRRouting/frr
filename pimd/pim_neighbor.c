/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"prefix.h"#include"memory.h"#inclu
de"if.h"#include"vty.h"#include"plist.h"#include"pimd.h"#include"pim_neighbor.h"
#include"pim_time.h"#include"pim_str.h"#include"pim_iface.h"#include"pim_pim.h"#
include"pim_upstream.h"#include"pim_ifchannel.h"#include"pim_rp.h"#include"pim_z
ebra.h"#include"pim_join.h"#include"pim_jp_agg.h"#include"pim_bfd.h"staticvoiddr
_election_by_addr(structinterface*ifp){structpim_interface*pim_ifp;structlistnod
e*node;structpim_neighbor*neigh;pim_ifp=ifp->info;zassert(pim_ifp);pim_ifp->pim_
dr_addr=pim_ifp->primary_address;if(PIM_DEBUG_PIM_TRACE){zlog_debug("%s:oninterf
ace%s",__PRETTY_FUNCTION__,ifp->name);}for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_nei
ghbor_list,node,neigh)){if(ntohl(neigh->source_addr.s_addr)>ntohl(pim_ifp->pim_d
r_addr.s_addr)){pim_ifp->pim_dr_addr=neigh->source_addr;}}}staticvoiddr_election
_by_pri(structinterface*ifp){structpim_interface*pim_ifp;structlistnode*node;str
uctpim_neighbor*neigh;uint32_tdr_pri;pim_ifp=ifp->info;zassert(pim_ifp);pim_ifp-
>pim_dr_addr=pim_ifp->primary_address;dr_pri=pim_ifp->pim_dr_priority;if(PIM_DEB
UG_PIM_TRACE){zlog_debug("%s:drpri%uoninterface%s",__PRETTY_FUNCTION__,dr_pri,if
p->name);}for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,node,neigh)){if(PI
M_DEBUG_PIM_TRACE){zlog_info("%s:neighpri%uaddr%xifdraddr%x",__PRETTY_FUNCTION__
,neigh->dr_priority,ntohl(neigh->source_addr.s_addr),ntohl(pim_ifp->pim_dr_addr.
s_addr));}if((neigh->dr_priority>dr_pri)||((neigh->dr_priority==dr_pri)&&(ntohl(
neigh->source_addr.s_addr)>ntohl(pim_ifp->pim_dr_addr.s_addr)))){pim_ifp->pim_dr
_addr=neigh->source_addr;dr_pri=neigh->dr_priority;}}}/*RFC4601:4.3.2.DRElection
Arouter'sideaofthecurrentDRonaninterfacecanchangewhenaPIMHellomessageisreceived,
whenaneighbortimesout,orwhenarouter'sownDRPrioritychanges.*/intpim_if_dr_electio
n(structinterface*ifp){structpim_interface*pim_ifp=ifp->info;structin_addrold_dr
_addr;++pim_ifp->pim_dr_election_count;old_dr_addr=pim_ifp->pim_dr_addr;if(pim_i
fp->pim_dr_num_nondrpri_neighbors){dr_election_by_addr(ifp);}else{dr_election_by
_pri(ifp);}/*DRchanged?*/if(old_dr_addr.s_addr!=pim_ifp->pim_dr_addr.s_addr){if(
PIM_DEBUG_PIM_EVENTS){chardr_old_str[INET_ADDRSTRLEN];chardr_new_str[INET_ADDRST
RLEN];pim_inet4_dump("<old_dr?>",old_dr_addr,dr_old_str,sizeof(dr_old_str));pim_
inet4_dump("<new_dr?>",pim_ifp->pim_dr_addr,dr_new_str,sizeof(dr_new_str));zlog_
debug("%s:DRwas%snowis%soninterface%s",__PRETTY_FUNCTION__,dr_old_str,dr_new_str
,ifp->name);}pim_ifp->pim_dr_election_last=pim_time_monotonic_sec();/*timestamp*
/++pim_ifp->pim_dr_election_changes;pim_if_update_join_desired(pim_ifp);pim_if_u
pdate_could_assert(ifp);pim_if_update_assert_tracking_desired(ifp);return1;}retu
rn0;}staticvoidupdate_dr_priority(structpim_neighbor*neigh,pim_hello_optionshell
o_options,uint32_tdr_priority){pim_hello_optionswill_set_pri;/*boolean*/pim_hell
o_optionsbit_flip;/*boolean*/pim_hello_optionspri_change;/*boolean*/will_set_pri
=PIM_OPTION_IS_SET(hello_options,PIM_OPTION_MASK_DR_PRIORITY);bit_flip=(will_set
_pri!=PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MASK_DR_PRIORITY));if(bi
t_flip){structpim_interface*pim_ifp=neigh->interface->info;/*updatenum.ofneighbo
rswithoutdr_pri*/if(will_set_pri){--pim_ifp->pim_dr_num_nondrpri_neighbors;}else
{++pim_ifp->pim_dr_num_nondrpri_neighbors;}}pri_change=(bit_flip||(neigh->dr_pri
ority!=dr_priority));if(will_set_pri){neigh->dr_priority=dr_priority;}else{neigh
->dr_priority=0;/*cosmeticunset*/}if(pri_change){/*RFC4601:4.3.2.DRElectionArout
er'sideaofthecurrentDRonaninterfacecanchangewhenaPIMHellomessageisreceived,whena
neighbortimesout,orwhenarouter'sownDRPrioritychanges.*/pim_if_dr_election(neigh-
>interface);//router'sownDRPrioritychanges}}staticinton_neighbor_timer(structthr
ead*t){structpim_neighbor*neigh;structinterface*ifp;charmsg[100];neigh=THREAD_AR
G(t);ifp=neigh->interface;if(PIM_DEBUG_PIM_TRACE){charsrc_str[INET_ADDRSTRLEN];p
im_inet4_dump("<src?>",neigh->source_addr,src_str,sizeof(src_str));zlog_debug("E
xpired%dsecholdtimeforneighbor%soninterface%s",neigh->holdtime,src_str,ifp->name
);}snprintf(msg,sizeof(msg),"%d-secholdtimeexpired",neigh->holdtime);pim_neighbo
r_delete(ifp,neigh,msg);/*RFC4601:4.3.2.DRElectionArouter'sideaofthecurrentDRona
ninterfacecanchangewhenaPIMHellomessageisreceived,whenaneighbortimesout,orwhenar
outer'sownDRPrioritychanges.*/pim_if_dr_election(ifp);//neighbortimesoutreturn0;
}voidpim_neighbor_timer_reset(structpim_neighbor*neigh,uint16_tholdtime){neigh->
holdtime=holdtime;THREAD_OFF(neigh->t_expire_timer);/*0xFFFFisrequestfornoholdti
me*/if(neigh->holdtime==0xFFFF){return;}if(PIM_DEBUG_PIM_TRACE_DETAIL){charsrc_s
tr[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",neigh->source_addr,src_str,sizeof(sr
c_str));zlog_debug("%s:starting%usectimerforneighbor%son%s",__PRETTY_FUNCTION__,
neigh->holdtime,src_str,neigh->interface->name);}thread_add_timer(master,on_neig
hbor_timer,neigh,neigh->holdtime,&neigh->t_expire_timer);}staticinton_neighbor_j
p_timer(structthread*t){structpim_neighbor*neigh=THREAD_ARG(t);structpim_rpfrpf;
if(PIM_DEBUG_PIM_TRACE){charsrc_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",nei
gh->source_addr,src_str,sizeof(src_str));zlog_debug("%s:SendingJPAggto%son%swith
%dgroups",__PRETTY_FUNCTION__,src_str,neigh->interface->name,neigh->upstream_jp_
agg->count);}rpf.source_nexthop.interface=neigh->interface;rpf.rpf_addr.u.prefix
4=neigh->source_addr;pim_joinprune_send(&rpf,neigh->upstream_jp_agg);thread_add_
timer(master,on_neighbor_jp_timer,neigh,qpim_t_periodic,&neigh->jp_timer);return
0;}staticvoidpim_neighbor_start_jp_timer(structpim_neighbor*neigh){THREAD_TIMER_
OFF(neigh->jp_timer);thread_add_timer(master,on_neighbor_jp_timer,neigh,qpim_t_p
eriodic,&neigh->jp_timer);}staticstructpim_neighbor*pim_neighbor_new(structinter
face*ifp,structin_addrsource_addr,pim_hello_optionshello_options,uint16_tholdtim
e,uint16_tpropagation_delay,uint16_toverride_interval,uint32_tdr_priority,uint32
_tgeneration_id,structlist*addr_list){structpim_interface*pim_ifp;structpim_neig
hbor*neigh;charsrc_str[INET_ADDRSTRLEN];zassert(ifp);pim_ifp=ifp->info;zassert(p
im_ifp);neigh=XCALLOC(MTYPE_PIM_NEIGHBOR,sizeof(*neigh));if(!neigh){zlog_err("%s
:PIMXCALLOC(%zu)failure",__PRETTY_FUNCTION__,sizeof(*neigh));return0;}neigh->cre
ation=pim_time_monotonic_sec();neigh->source_addr=source_addr;neigh->hello_optio
ns=hello_options;neigh->propagation_delay_msec=propagation_delay;neigh->override
_interval_msec=override_interval;neigh->dr_priority=dr_priority;neigh->generatio
n_id=generation_id;neigh->prefix_list=addr_list;neigh->t_expire_timer=NULL;neigh
->interface=ifp;neigh->upstream_jp_agg=list_new();neigh->upstream_jp_agg->cmp=pi
m_jp_agg_group_list_cmp;neigh->upstream_jp_agg->del=(void(*)(void*))pim_jp_agg_g
roup_list_free;pim_neighbor_start_jp_timer(neigh);pim_neighbor_timer_reset(neigh
,holdtime);/**Thepim_ifstat_hello_sentvariableisusedtodecideif*weshouldexpeditea
helloouttheinterface.Ifwe*establishanewneighbor,weunfortunatelyneedto*resettheva
luesothatwecanknowtohurryupand*hello*/pim_ifp->pim_ifstat_hello_sent=0;pim_inet4
_dump("<src?>",source_addr,src_str,sizeof(src_str));if(PIM_DEBUG_PIM_EVENTS){zlo
g_debug("%s:creatingPIMneighbor%soninterface%s",__PRETTY_FUNCTION__,src_str,ifp-
>name);}zlog_info("PIMNEIGHBORUP:neighbor%soninterface%s",src_str,ifp->name);if(
neigh->propagation_delay_msec>pim_ifp->pim_neighbors_highest_propagation_delay_m
sec){pim_ifp->pim_neighbors_highest_propagation_delay_msec=neigh->propagation_de
lay_msec;}if(neigh->override_interval_msec>pim_ifp->pim_neighbors_highest_overri
de_interval_msec){pim_ifp->pim_neighbors_highest_override_interval_msec=neigh->o
verride_interval_msec;}if(!PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MAS
K_LAN_PRUNE_DELAY)){/*updatenum.ofneighborswithouthellooptionlan_delay*/++pim_if
p->pim_number_of_nonlandelay_neighbors;}if(!PIM_OPTION_IS_SET(neigh->hello_optio
ns,PIM_OPTION_MASK_DR_PRIORITY)){/*updatenum.ofneighborswithouthellooptiondr_pri
*/++pim_ifp->pim_dr_num_nondrpri_neighbors;}//RegisterPIMNeighborwithBFDpim_bfd_
trigger_event(pim_ifp,neigh,1);returnneigh;}staticvoiddelete_prefix_list(structp
im_neighbor*neigh){if(neigh->prefix_list){#ifdefDUMP_PREFIX_LISTstructlistnode*p
_node;structprefix*p;charaddr_str[10];intlist_size=neigh->prefix_list?(int)listc
ount(neigh->prefix_list):-1;inti=0;for(ALL_LIST_ELEMENTS_RO(neigh->prefix_list,p
_node,p)){pim_inet4_dump("<addr?>",p->u.prefix4,addr_str,sizeof(addr_str));zlog_
debug("%s:DUMP_PREFIX_LISTneigh=%xprefix_list=%xprefix=%xaddr=%s[%d/%d]",__PRETT
Y_FUNCTION__,(unsigned)neigh,(unsigned)neigh->prefix_list,(unsigned)p,addr_str,i
,list_size);++i;}#endiflist_delete_and_null(&neigh->prefix_list);}}voidpim_neigh
bor_free(structpim_neighbor*neigh){zassert(!neigh->t_expire_timer);delete_prefix
_list(neigh);list_delete_and_null(&neigh->upstream_jp_agg);THREAD_OFF(neigh->jp_
timer);XFREE(MTYPE_PIM_NEIGHBOR,neigh);}structpim_neighbor*pim_neighbor_find_by_
secondary(structinterface*ifp,structprefix*src){structpim_interface*pim_ifp;stru
ctlistnode*node,*pnode;structpim_neighbor*neigh;structprefix*p;pim_ifp=ifp->info
;if(!pim_ifp)returnNULL;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,node
,neigh)){for(ALL_LIST_ELEMENTS_RO(neigh->prefix_list,pnode,p)){if(prefix_same(p,
src))returnneigh;}}returnNULL;}structpim_neighbor*pim_neighbor_find(structinterf
ace*ifp,structin_addrsource_addr){structpim_interface*pim_ifp;structlistnode*nod
e;structpim_neighbor*neigh;if(!ifp)returnNULL;pim_ifp=ifp->info;if(!pim_ifp)retu
rnNULL;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,node,neigh)){if(sourc
e_addr.s_addr==neigh->source_addr.s_addr){returnneigh;}}returnNULL;}/**Findthe*o
ne*interfaceout*thisinterface.Ifmorethan*onereturnNULL*/structpim_neighbor*pim_n
eighbor_find_if(structinterface*ifp){structpim_interface*pim_ifp=ifp->info;if(!p
im_ifp||pim_ifp->pim_neighbor_list->count!=1)returnNULL;returnlistnode_head(pim_
ifp->pim_neighbor_list);}structpim_neighbor*pim_neighbor_add(structinterface*ifp
,structin_addrsource_addr,pim_hello_optionshello_options,uint16_tholdtime,uint16
_tpropagation_delay,uint16_toverride_interval,uint32_tdr_priority,uint32_tgenera
tion_id,structlist*addr_list,intsend_hello_now){structpim_interface*pim_ifp;stru
ctpim_neighbor*neigh;neigh=pim_neighbor_new(ifp,source_addr,hello_options,holdti
me,propagation_delay,override_interval,dr_priority,generation_id,addr_list);if(!
neigh){return0;}pim_ifp=ifp->info;zassert(pim_ifp);listnode_add(pim_ifp->pim_nei
ghbor_list,neigh);if(PIM_DEBUG_PIM_TRACE_DETAIL){charstr[INET_ADDRSTRLEN];pim_in
et4_dump("<nht_nbr?>",source_addr,str,sizeof(str));zlog_debug("%s:neighbor%sadde
d",__PRETTY_FUNCTION__,str);}/*RFC4601:4.3.2.DRElectionArouter'sideaofthecurrent
DRonaninterfacecanchangewhenaPIMHellomessageisreceived,whenaneighbortimesout,orw
henarouter'sownDRPrioritychanges.*/pim_if_dr_election(neigh->interface);//newnei
ghbor--shouldnot//triggerdrelection.../*RFC4601:4.3.1.SendingHelloMessagesToallo
wneworrebootingrouterstolearnofPIMneighborsquickly,whenaHellomessageisreceivedfr
omanewneighbor,oraHellomessagewithanewGenIDisreceivedfromanexistingneighbor,anew
Hellomessageshouldbesentonthisinterfaceafterarandomizeddelaybetween0andTriggered
_Hello_Delay.Thisisabitsillytodoitthatway.IfIgetanewgenidweneedtosendthehello*no
w*becausewe'velinedupabunchofjoin/prunemessagestogoouttheinterface.*/if(send_hel
lo_now)pim_hello_restart_now(ifp);elsepim_hello_restart_triggered(neigh->interfa
ce);pim_upstream_find_new_rpf(pim_ifp->pim);/*RNHcansendnexthopupdatepriortoPIMn
eibhorUPinthatcasenexthopcachewouldnotconsiderthisneighborasRPF.UponPIMneighborU
P,iterateallRPsandupdatenexthopcachewiththisneighbor.*/pim_resolve_rp_nh(pim_ifp
->pim);pim_rp_setup(pim_ifp->pim);sched_rpf_cache_refresh(pim_ifp->pim);returnne
igh;}staticuint16_tfind_neighbors_next_highest_propagation_delay_msec(structinte
rface*ifp,structpim_neighbor*highest_neigh){structpim_interface*pim_ifp;structli
stnode*neigh_node;structpim_neighbor*neigh;uint16_tnext_highest_delay_msec;pim_i
fp=ifp->info;zassert(pim_ifp);next_highest_delay_msec=pim_ifp->pim_propagation_d
elay_msec;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,neigh_node,neigh))
{if(neigh==highest_neigh)continue;if(neigh->propagation_delay_msec>next_highest_
delay_msec)next_highest_delay_msec=neigh->propagation_delay_msec;}returnnext_hig
hest_delay_msec;}staticuint16_tfind_neighbors_next_highest_override_interval_mse
c(structinterface*ifp,structpim_neighbor*highest_neigh){structpim_interface*pim_
ifp;structlistnode*neigh_node;structpim_neighbor*neigh;uint16_tnext_highest_inte
rval_msec;pim_ifp=ifp->info;zassert(pim_ifp);next_highest_interval_msec=pim_ifp-
>pim_override_interval_msec;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,
neigh_node,neigh)){if(neigh==highest_neigh)continue;if(neigh->override_interval_
msec>next_highest_interval_msec)next_highest_interval_msec=neigh->override_inter
val_msec;}returnnext_highest_interval_msec;}voidpim_neighbor_delete(structinterf
ace*ifp,structpim_neighbor*neigh,constchar*delete_message){structpim_interface*p
im_ifp;charsrc_str[INET_ADDRSTRLEN];pim_ifp=ifp->info;zassert(pim_ifp);pim_inet4
_dump("<src?>",neigh->source_addr,src_str,sizeof(src_str));zlog_info("PIMNEIGHBO
RDOWN:neighbor%soninterface%s:%s",src_str,ifp->name,delete_message);THREAD_OFF(n
eigh->t_expire_timer);pim_if_assert_on_neighbor_down(ifp,neigh->source_addr);if(
!PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MASK_LAN_PRUNE_DELAY)){/*upda
tenum.ofneighborswithouthellooptionlan_delay*/--pim_ifp->pim_number_of_nonlandel
ay_neighbors;}if(!PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MASK_DR_PRIO
RITY)){/*updatenum.ofneighborswithoutdr_pri*/--pim_ifp->pim_dr_num_nondrpri_neig
hbors;}zassert(neigh->propagation_delay_msec<=pim_ifp->pim_neighbors_highest_pro
pagation_delay_msec);zassert(neigh->override_interval_msec<=pim_ifp->pim_neighbo
rs_highest_override_interval_msec);if(pim_if_lan_delay_enabled(ifp)){/*willdelet
eaneighborwithhighestpropagationdelay?*/if(neigh->propagation_delay_msec==pim_if
p->pim_neighbors_highest_propagation_delay_msec){/*thenfindthenexthighestpropaga
tiondelay*/pim_ifp->pim_neighbors_highest_propagation_delay_msec=find_neighbors_
next_highest_propagation_delay_msec(ifp,neigh);}/*willdeleteaneighborwithhighest
overrideinterval?*/if(neigh->override_interval_msec==pim_ifp->pim_neighbors_high
est_override_interval_msec){/*thenfindthenexthighestpropagationdelay*/pim_ifp->p
im_neighbors_highest_override_interval_msec=find_neighbors_next_highest_override
_interval_msec(ifp,neigh);}}if(PIM_DEBUG_PIM_TRACE){zlog_debug("%s:deletingPIMne
ighbor%soninterface%s",__PRETTY_FUNCTION__,src_str,ifp->name);}//De-RegisterPIMN
eighborwithBFDpim_bfd_trigger_event(pim_ifp,neigh,0);listnode_delete(pim_ifp->pi
m_neighbor_list,neigh);pim_neighbor_free(neigh);sched_rpf_cache_refresh(pim_ifp-
>pim);}voidpim_neighbor_delete_all(structinterface*ifp,constchar*delete_message)
{structpim_interface*pim_ifp;structlistnode*neigh_node;structlistnode*neigh_next
node;structpim_neighbor*neigh;pim_ifp=ifp->info;zassert(pim_ifp);for(ALL_LIST_EL
EMENTS(pim_ifp->pim_neighbor_list,neigh_node,neigh_nextnode,neigh)){pim_neighbor
_delete(ifp,neigh,delete_message);}}structprefix*pim_neighbor_find_secondary(str
uctpim_neighbor*neigh,structprefix*addr){structlistnode*node;structprefix*p;if(!
neigh->prefix_list)return0;for(ALL_LIST_ELEMENTS_RO(neigh->prefix_list,node,p)){
if(prefix_same(p,addr))returnp;}returnNULL;}/*RFC4601:4.3.4.MaintainingSecondary
AddressListsAlltheadvertisedsecondaryaddressesinreceivedHellomessagesmustbecheck
edagainstthosepreviouslyadvertisedbyallotherPIMneighborsonthatinterface.Iftherei
saconflictandthesamesecondaryaddresswaspreviouslyadvertisedbyanotherneighbor,the
nonlythemostrecentlyreceivedmappingMUSTbemaintained,andanerrormessageSHOULDbelog
gedtotheadministratorinarate-limitedmanner.*/staticvoiddelete_from_neigh_addr(st
ructinterface*ifp,structlist*addr_list,structin_addrneigh_addr){structlistnode*a
ddr_node;structprefix*addr;structpim_interface*pim_ifp;pim_ifp=ifp->info;zassert
(pim_ifp);zassert(addr_list);/*Scansecondaryaddresslist*/for(ALL_LIST_ELEMENTS_R
O(addr_list,addr_node,addr)){structlistnode*neigh_node;structpim_neighbor*neigh;
if(addr->family!=AF_INET)continue;/*Scanneighbors*/for(ALL_LIST_ELEMENTS_RO(pim_
ifp->pim_neighbor_list,neigh_node,neigh)){{structprefix*p=pim_neighbor_find_seco
ndary(neigh,addr);if(p){charaddr_str[INET_ADDRSTRLEN];charthis_neigh_str[INET_AD
DRSTRLEN];charother_neigh_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr->u.
prefix4,addr_str,sizeof(addr_str));pim_inet4_dump("<neigh1?>",neigh_addr,this_ne
igh_str,sizeof(this_neigh_str));pim_inet4_dump("<neigh2?>",neigh->source_addr,ot
her_neigh_str,sizeof(other_neigh_str));zlog_info("secondaryaddr%srecvdfromneigh%
sdeletedfromneigh%son%s",addr_str,this_neigh_str,other_neigh_str,ifp->name);list
node_delete(neigh->prefix_list,p);prefix_free(p);}}}/*scanneighbors*/}/*scanaddr
list*/}voidpim_neighbor_update(structpim_neighbor*neigh,pim_hello_optionshello_o
ptions,uint16_tholdtime,uint32_tdr_priority,structlist*addr_list){structpim_inte
rface*pim_ifp=neigh->interface->info;/*Receivedholdtime?*/if(PIM_OPTION_IS_SET(h
ello_options,PIM_OPTION_MASK_HOLDTIME)){pim_neighbor_timer_reset(neigh,holdtime)
;}else{pim_neighbor_timer_reset(neigh,PIM_IF_DEFAULT_HOLDTIME(pim_ifp));}#ifdefD
UMP_PREFIX_LISTzlog_debug("%s:DUMP_PREFIX_LISTold_prefix_list=%xold_size=%dnew_p
refix_list=%xnew_size=%d",__PRETTY_FUNCTION__,(unsigned)neigh->prefix_list,neigh
->prefix_list?(int)listcount(neigh->prefix_list):-1,(unsigned)addr_list,addr_lis
t?(int)listcount(addr_list):-1);#endifif(neigh->prefix_list==addr_list){if(addr_
list){zlog_err("%s:internalerror:tryingtoreplacesameprefixlist=%p",__PRETTY_FUNC
TION__,(void*)addr_list);}}else{/*Deleteexistingsecondaryaddresslist*/delete_pre
fix_list(neigh);}if(addr_list){delete_from_neigh_addr(neigh->interface,addr_list
,neigh->source_addr);}/*Replacesecondaryaddresslist*/neigh->prefix_list=addr_lis
t;update_dr_priority(neigh,hello_options,dr_priority);/*Copyflags*/neigh->hello_
options=hello_options;}