/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"thread.h"#include"memory.h"#inclu
de"if.h"#include"pimd.h"#include"pim_pim.h"#include"pim_time.h"#include"pim_ifac
e.h"#include"pim_sock.h"#include"pim_str.h"#include"pim_util.h"#include"pim_tlv.
h"#include"pim_neighbor.h"#include"pim_hello.h"#include"pim_join.h"#include"pim_
assert.h"#include"pim_msg.h"#include"pim_register.h"staticinton_pim_hello_send(s
tructthread*t);staticintpim_hello_send(structinterface*ifp,uint16_tholdtime);sta
ticconstchar*pim_pim_msgtype2str(enumpim_msg_typetype){switch(type){casePIM_MSG_
TYPE_HELLO:return"HELLO";casePIM_MSG_TYPE_REGISTER:return"REGISTER";casePIM_MSG_
TYPE_REG_STOP:return"REGSTOP";casePIM_MSG_TYPE_JOIN_PRUNE:return"JOINPRUNE";case
PIM_MSG_TYPE_BOOTSTRAP:return"BOOT";casePIM_MSG_TYPE_ASSERT:return"ASSERT";caseP
IM_MSG_TYPE_GRAFT:return"GRAFT";casePIM_MSG_TYPE_GRAFT_ACK:return"GACK";casePIM_
MSG_TYPE_CANDIDATE:return"CANDIDATE";}return"UNKNOWN";}staticvoidsock_close(stru
ctinterface*ifp){structpim_interface*pim_ifp=ifp->info;if(PIM_DEBUG_PIM_TRACE){i
f(pim_ifp->t_pim_sock_read){zlog_debug("CancellingREADeventforPIMsocketfd=%donin
terface%s",pim_ifp->pim_sock_fd,ifp->name);}}THREAD_OFF(pim_ifp->t_pim_sock_read
);if(PIM_DEBUG_PIM_TRACE){if(pim_ifp->t_pim_hello_timer){zlog_debug("CancellingP
IMhellotimerforinterface%s",ifp->name);}}THREAD_OFF(pim_ifp->t_pim_hello_timer);
if(PIM_DEBUG_PIM_TRACE){zlog_debug("DeletingPIMsocketfd=%doninterface%s",pim_ifp
->pim_sock_fd,ifp->name);}/**Ifthefdisalreadydeletednoneedtodoanythinghere*/if(p
im_ifp->pim_sock_fd>0&&close(pim_ifp->pim_sock_fd)){zlog_warn("FailureclosingPIM
socketfd=%doninterface%s:errno=%d:%s",pim_ifp->pim_sock_fd,ifp->name,errno,safe_
strerror(errno));}pim_ifp->pim_sock_fd=-1;pim_ifp->pim_sock_creation=0;}voidpim_
sock_delete(structinterface*ifp,constchar*delete_message){zlog_info("PIMINTERFAC
EDOWN:oninterface%s:%s",ifp->name,delete_message);if(!ifp->info){zlog_err("%s:%s
:butPIMnotenabledoninterface%s(!)",__PRETTY_FUNCTION__,delete_message,ifp->name)
;return;}/*RFC4601:4.3.1.SendingHelloMessagesBeforeaninterfacegoesdownorchangesp
rimaryIPaddress,aHellomessagewithazeroHoldTimeshouldbesentimmediately(withtheold
IPaddressiftheIPaddresschanged).*/pim_hello_send(ifp,0/*zero-secholdtime*/);pim_
neighbor_delete_all(ifp,delete_message);sock_close(ifp);}intpim_pim_packet(struc
tinterface*ifp,uint8_t*buf,size_tlen){structip*ip_hdr;size_tip_hlen;/*ipheaderle
ngthinbytes*/charsrc_str[INET_ADDRSTRLEN];chardst_str[INET_ADDRSTRLEN];uint8_t*p
im_msg;intpim_msg_len;uint16_tpim_checksum;/*receivedchecksum*/uint16_tchecksum;
/*computedchecksum*/structpim_neighbor*neigh;structpim_msg_header*header;if(len<
sizeof(*ip_hdr)){if(PIM_DEBUG_PIM_PACKETS)zlog_debug("PIMpacketsize=%zushorterth
anminimum=%zu",len,sizeof(*ip_hdr));return-1;}ip_hdr=(structip*)buf;ip_hlen=ip_h
dr->ip_hl<<2;/*ip_hlgiveslengthin4-bytewords*/pim_msg=buf+ip_hlen;pim_msg_len=le
n-ip_hlen;header=(structpim_msg_header*)pim_msg;if(pim_msg_len<PIM_PIM_MIN_LEN){
if(PIM_DEBUG_PIM_PACKETS)zlog_debug("PIMmessagesize=%dshorterthanminimum=%d",pim
_msg_len,PIM_PIM_MIN_LEN);return-1;}if(header->ver!=PIM_PROTO_VERSION){if(PIM_DE
BUG_PIM_PACKETS)zlog_debug("IgnoringPIMpktfrom%swithunsupportedversion:%d",ifp->
name,header->ver);return-1;}/*savereceivedchecksum*/pim_checksum=header->checksu
m;/*forcomputingchecksum*/header->checksum=0;if(header->type==PIM_MSG_TYPE_REGIS
TER){/*First8byteheaderchecksum*/checksum=in_cksum(pim_msg,PIM_MSG_REGISTER_LEN)
;if(checksum!=pim_checksum){checksum=in_cksum(pim_msg,pim_msg_len);if(checksum!=
pim_checksum){if(PIM_DEBUG_PIM_PACKETS)zlog_debug("IgnoringPIMpktfrom%swithinval
idchecksum:received=%xcalculated=%x",ifp->name,pim_checksum,checksum);return-1;}
}}else{checksum=in_cksum(pim_msg,pim_msg_len);if(checksum!=pim_checksum){if(PIM_
DEBUG_PIM_PACKETS)zlog_debug("IgnoringPIMpktfrom%swithinvalidchecksum:received=%
xcalculated=%x",ifp->name,pim_checksum,checksum);return-1;}}if(PIM_DEBUG_PIM_PAC
KETS){pim_inet4_dump("<src?>",ip_hdr->ip_src,src_str,sizeof(src_str));pim_inet4_
dump("<dst?>",ip_hdr->ip_dst,dst_str,sizeof(dst_str));zlog_debug("RecvPIM%spacke
tfrom%sto%son%s:ttl=%dpim_version=%dpim_msg_size=%dchecksum=%x",pim_pim_msgtype2
str(header->type),src_str,dst_str,ifp->name,ip_hdr->ip_ttl,header->ver,pim_msg_l
en,checksum);if(PIM_DEBUG_PIM_PACKETDUMP_RECV){pim_pkt_dump(__PRETTY_FUNCTION__,
pim_msg,pim_msg_len);}}switch(header->type){casePIM_MSG_TYPE_HELLO:returnpim_hel
lo_recv(ifp,ip_hdr->ip_src,pim_msg+PIM_MSG_HEADER_LEN,pim_msg_len-PIM_MSG_HEADER
_LEN);break;casePIM_MSG_TYPE_REGISTER:returnpim_register_recv(ifp,ip_hdr->ip_dst
,ip_hdr->ip_src,pim_msg+PIM_MSG_HEADER_LEN,pim_msg_len-PIM_MSG_HEADER_LEN);break
;casePIM_MSG_TYPE_REG_STOP:returnpim_register_stop_recv(ifp,pim_msg+PIM_MSG_HEAD
ER_LEN,pim_msg_len-PIM_MSG_HEADER_LEN);break;casePIM_MSG_TYPE_JOIN_PRUNE:neigh=p
im_neighbor_find(ifp,ip_hdr->ip_src);if(!neigh){if(PIM_DEBUG_PIM_PACKETS)zlog_de
bug("%s%s:non-helloPIMmessagetype=%dfromnon-neighbor%son%s",__FILE__,__PRETTY_FU
NCTION__,header->type,src_str,ifp->name);return-1;}pim_neighbor_timer_reset(neig
h,neigh->holdtime);returnpim_joinprune_recv(ifp,neigh,ip_hdr->ip_src,pim_msg+PIM
_MSG_HEADER_LEN,pim_msg_len-PIM_MSG_HEADER_LEN);break;casePIM_MSG_TYPE_ASSERT:ne
igh=pim_neighbor_find(ifp,ip_hdr->ip_src);if(!neigh){if(PIM_DEBUG_PIM_PACKETS)zl
og_debug("%s%s:non-helloPIMmessagetype=%dfromnon-neighbor%son%s",__FILE__,__PRET
TY_FUNCTION__,header->type,src_str,ifp->name);return-1;}pim_neighbor_timer_reset
(neigh,neigh->holdtime);returnpim_assert_recv(ifp,neigh,ip_hdr->ip_src,pim_msg+P
IM_MSG_HEADER_LEN,pim_msg_len-PIM_MSG_HEADER_LEN);break;default:if(PIM_DEBUG_PIM
_PACKETS){zlog_debug("RecvPIMpackettype%dwhichisnotcurrentlyunderstood",header->
type);}return-1;}return-1;}staticvoidpim_sock_read_on(structinterface*ifp);stati
cintpim_sock_read(structthread*t){structinterface*ifp,*orig_ifp;structpim_interf
ace*pim_ifp;intfd;structsockaddr_infrom;structsockaddr_into;socklen_tfromlen=siz
eof(from);socklen_ttolen=sizeof(to);uint8_tbuf[PIM_PIM_BUFSIZE_READ];intlen;ifin
dex_tifindex=-1;intresult=-1;/*defaultstobad*/staticlonglongcount=0;intcont=1;or
ig_ifp=ifp=THREAD_ARG(t);fd=THREAD_FD(t);pim_ifp=ifp->info;while(cont){len=pim_s
ocket_recvfromto(fd,buf,sizeof(buf),&from,&fromlen,&to,&tolen,&ifindex);if(len<0
){if(errno==EINTR)continue;if(errno==EWOULDBLOCK||errno==EAGAIN)break;if(PIM_DEB
UG_PIM_PACKETS)zlog_debug("Receivederrno:%d%s",errno,safe_strerror(errno));gotod
one;}/**What?Sowithvrf'stheincomingpacketisreceived*onthevrfinterfacebutrecvfrom
toabovereturns*therightifindex,sojustuseit.Weknow*it'stherightinterfacebecausewe
bindtoit*/ifp=if_lookup_by_index(ifindex,pim_ifp->pim->vrf_id);if(!ifp||!ifp->in
fo){if(PIM_DEBUG_PIM_PACKETS)zlog_debug("%s:Receivedincomingpimpacketoninterface
notyetconfiguredforpim",__PRETTY_FUNCTION__);gotodone;}intfail=pim_pim_packet(if
p,buf,len);if(fail){if(PIM_DEBUG_PIM_PACKETS)zlog_debug("%s:pim_pim_packet()retu
rn=%d",__PRETTY_FUNCTION__,fail);gotodone;}count++;if(count%qpim_packet_process=
=0)cont=0;}result=0;/*good*/done:pim_sock_read_on(orig_ifp);if(result){++pim_ifp
->pim_ifstat_hello_recvfail;}returnresult;}staticvoidpim_sock_read_on(structinte
rface*ifp){structpim_interface*pim_ifp;zassert(ifp);zassert(ifp->info);pim_ifp=i
fp->info;if(PIM_DEBUG_PIM_TRACE_DETAIL){zlog_debug("SchedulingREADeventonPIMsock
etfd=%d",pim_ifp->pim_sock_fd);}pim_ifp->t_pim_sock_read=NULL;thread_add_read(ma
ster,pim_sock_read,ifp,pim_ifp->pim_sock_fd,&pim_ifp->t_pim_sock_read);}staticin
tpim_sock_open(structinterface*ifp){intfd;structpim_interface*pim_ifp=ifp->info;
fd=pim_socket_mcast(IPPROTO_PIM,pim_ifp->primary_address,ifp,0/*loop=false*/);if
(fd<0)return-1;if(pim_socket_join(fd,qpim_all_pim_routers_addr,pim_ifp->primary_
address,ifp->ifindex)){close(fd);return-2;}returnfd;}voidpim_ifstat_reset(struct
interface*ifp){structpim_interface*pim_ifp;zassert(ifp);pim_ifp=ifp->info;if(!pi
m_ifp){return;}pim_ifp->pim_ifstat_start=pim_time_monotonic_sec();pim_ifp->pim_i
fstat_hello_sent=0;pim_ifp->pim_ifstat_hello_sendfail=0;pim_ifp->pim_ifstat_hell
o_recv=0;pim_ifp->pim_ifstat_hello_recvfail=0;}voidpim_sock_reset(structinterfac
e*ifp){structpim_interface*pim_ifp;zassert(ifp);zassert(ifp->info);pim_ifp=ifp->
info;pim_ifp->primary_address=pim_find_primary_addr(ifp);pim_ifp->pim_sock_fd=-1
;pim_ifp->pim_sock_creation=0;pim_ifp->t_pim_sock_read=NULL;pim_ifp->t_pim_hello
_timer=NULL;pim_ifp->pim_hello_period=PIM_DEFAULT_HELLO_PERIOD;pim_ifp->pim_defa
ult_holdtime=-1;/*unset:means3.5*pim_hello_period*/pim_ifp->pim_triggered_hello_
delay=PIM_DEFAULT_TRIGGERED_HELLO_DELAY;pim_ifp->pim_dr_priority=PIM_DEFAULT_DR_
PRIORITY;pim_ifp->pim_propagation_delay_msec=PIM_DEFAULT_PROPAGATION_DELAY_MSEC;
pim_ifp->pim_override_interval_msec=PIM_DEFAULT_OVERRIDE_INTERVAL_MSEC;if(PIM_DE
FAULT_CAN_DISABLE_JOIN_SUPPRESSION){PIM_IF_DO_PIM_CAN_DISABLE_JOIN_SUPRESSION(pi
m_ifp->options);}else{PIM_IF_DONT_PIM_CAN_DISABLE_JOIN_SUPRESSION(pim_ifp->optio
ns);}/*neighborswithoutlan_delay*/pim_ifp->pim_number_of_nonlandelay_neighbors=0
;pim_ifp->pim_neighbors_highest_propagation_delay_msec=0;pim_ifp->pim_neighbors_
highest_override_interval_msec=0;/*DRElection*/pim_ifp->pim_dr_election_last=0;/
*timestamp*/pim_ifp->pim_dr_election_count=0;pim_ifp->pim_dr_election_changes=0;
pim_ifp->pim_dr_num_nondrpri_neighbors=0;/*neighborswithoutdr_pri*/pim_ifp->pim_
dr_addr=pim_ifp->primary_address;pim_ifstat_reset(ifp);}staticuint16_tip_id=0;st
aticintpim_msg_send_frame(intfd,char*buf,size_tlen,structsockaddr*dst,size_tsale
n){structip*ip=(structip*)buf;while(sendto(fd,buf,len,MSG_DONTWAIT,dst,salen)<0)
{chardst_str[INET_ADDRSTRLEN];switch(errno){caseEMSGSIZE:{size_thdrsize=sizeof(s
tructip);size_tnewlen1=((len-hdrsize)/2)&0xFFF8;size_tsendlen=newlen1+hdrsize;si
ze_toffset=ntohs(ip->ip_off);ip->ip_len=htons(sendlen);ip->ip_off=htons(offset|I
P_MF);if(pim_msg_send_frame(fd,buf,sendlen,dst,salen)==0){structip*ip2=(structip
*)(buf+newlen1);size_tnewlen2=len-sendlen;sendlen=newlen2+hdrsize;memcpy(ip2,ip,
hdrsize);ip2->ip_len=htons(sendlen);ip2->ip_off=htons(offset+(newlen1>>3));retur
npim_msg_send_frame(fd,(char*)ip2,sendlen,dst,salen);}}return-1;break;default:if
(PIM_DEBUG_PIM_PACKETS){pim_inet4_dump("<dst?>",ip->ip_dst,dst_str,sizeof(dst_st
r));zlog_warn("%s:sendto()failureto%s:fd=%dmsg_size=%zd:errno=%d:%s",__PRETTY_FU
NCTION__,dst_str,fd,len,errno,safe_strerror(errno));}return-1;break;}}return0;}i
ntpim_msg_send(intfd,structin_addrsrc,structin_addrdst,uint8_t*pim_msg,intpim_ms
g_size,constchar*ifname){structsockaddr_into;socklen_ttolen;unsignedcharbuffer[1
0000];unsignedchar*msg_start;uint8_tttl=MAXTTL;structpim_msg_header*header;struc
tip*ip;memset(buffer,0,10000);intsendlen=sizeof(structip)+pim_msg_size;msg_start
=buffer+sizeof(structip);memcpy(msg_start,pim_msg,pim_msg_size);header=(structpi
m_msg_header*)pim_msg;/**Omniosapparentlydoesn'thavea#defineforIPdefault*ttlthat
isthesameasallotherplatforms.*/#ifndefIPDEFTTL#defineIPDEFTTL64#endif/*TTLforpac
ketsdestinetoALL-PIM-ROUTERSis1*/switch(header->type){casePIM_MSG_TYPE_HELLO:cas
ePIM_MSG_TYPE_JOIN_PRUNE:casePIM_MSG_TYPE_BOOTSTRAP:casePIM_MSG_TYPE_ASSERT:ttl=
1;break;casePIM_MSG_TYPE_REGISTER:casePIM_MSG_TYPE_REG_STOP:casePIM_MSG_TYPE_GRA
FT:casePIM_MSG_TYPE_GRAFT_ACK:casePIM_MSG_TYPE_CANDIDATE:ttl=IPDEFTTL;break;defa
ult:ttl=MAXTTL;break;}ip=(structip*)buffer;ip->ip_id=htons(++ip_id);ip->ip_hl=5;
ip->ip_v=4;ip->ip_p=PIM_IP_PROTO_PIM;ip->ip_src=src;ip->ip_dst=dst;ip->ip_ttl=tt
l;ip->ip_len=htons(sendlen);if(PIM_DEBUG_PIM_PACKETS){structpim_msg_header*heade
r=(structpim_msg_header*)pim_msg;chardst_str[INET_ADDRSTRLEN];pim_inet4_dump("<d
st?>",dst,dst_str,sizeof(dst_str));zlog_debug("%s:to%son%s:msg_size=%dchecksum=%
x",__PRETTY_FUNCTION__,dst_str,ifname,pim_msg_size,header->checksum);}memset(&to
,0,sizeof(to));to.sin_family=AF_INET;to.sin_addr=dst;tolen=sizeof(to);if(PIM_DEB
UG_PIM_PACKETDUMP_SEND){pim_pkt_dump(__PRETTY_FUNCTION__,pim_msg,pim_msg_size);}
pim_msg_send_frame(fd,(char*)buffer,sendlen,(structsockaddr*)&to,tolen);return0;
}staticinthello_send(structinterface*ifp,uint16_tholdtime){uint8_tpim_msg[PIM_PI
M_BUFSIZE_WRITE];structpim_interface*pim_ifp;intpim_tlv_size;intpim_msg_size;pim
_ifp=ifp->info;if(PIM_DEBUG_PIM_HELLO){chardst_str[INET_ADDRSTRLEN];pim_inet4_du
mp("<dst?>",qpim_all_pim_routers_addr,dst_str,sizeof(dst_str));zlog_debug("%s:to
%son%s:holdt=%uprop_d=%uoverr_i=%udis_join_supp=%ddr_prio=%ugen_id=%08xaddrs=%d"
,__PRETTY_FUNCTION__,dst_str,ifp->name,holdtime,pim_ifp->pim_propagation_delay_m
sec,pim_ifp->pim_override_interval_msec,PIM_IF_TEST_PIM_CAN_DISABLE_JOIN_SUPRESS
ION(pim_ifp->options),pim_ifp->pim_dr_priority,pim_ifp->pim_generation_id,listco
unt(ifp->connected));}pim_tlv_size=pim_hello_build_tlv(ifp,pim_msg+PIM_PIM_MIN_L
EN,sizeof(pim_msg)-PIM_PIM_MIN_LEN,holdtime,pim_ifp->pim_dr_priority,pim_ifp->pi
m_generation_id,pim_ifp->pim_propagation_delay_msec,pim_ifp->pim_override_interv
al_msec,PIM_IF_TEST_PIM_CAN_DISABLE_JOIN_SUPRESSION(pim_ifp->options));if(pim_tl
v_size<0){return-1;}pim_msg_size=pim_tlv_size+PIM_PIM_MIN_LEN;zassert(pim_msg_si
ze>=PIM_PIM_MIN_LEN);zassert(pim_msg_size<=PIM_PIM_BUFSIZE_WRITE);pim_msg_build_
header(pim_msg,pim_msg_size,PIM_MSG_TYPE_HELLO);if(pim_msg_send(pim_ifp->pim_soc
k_fd,pim_ifp->primary_address,qpim_all_pim_routers_addr,pim_msg,pim_msg_size,ifp
->name)){if(PIM_DEBUG_PIM_HELLO){zlog_debug("%s:couldnotsendPIMmessageoninterfac
e%s",__PRETTY_FUNCTION__,ifp->name);}return-2;}return0;}staticintpim_hello_send(
structinterface*ifp,uint16_tholdtime){structpim_interface*pim_ifp=ifp->info;if(p
im_if_is_loopback(pim_ifp->pim,ifp))return0;if(hello_send(ifp,holdtime)){++pim_i
fp->pim_ifstat_hello_sendfail;if(PIM_DEBUG_PIM_HELLO){zlog_warn("CouldnotsendPIM
hellooninterface%s",ifp->name);}return-1;}++pim_ifp->pim_ifstat_hello_sent;retur
n0;}staticvoidhello_resched(structinterface*ifp){structpim_interface*pim_ifp;pim
_ifp=ifp->info;if(PIM_DEBUG_PIM_HELLO){zlog_debug("Rescheduling%dsechellooninter
face%s",pim_ifp->pim_hello_period,ifp->name);}THREAD_OFF(pim_ifp->t_pim_hello_ti
mer);thread_add_timer(master,on_pim_hello_send,ifp,pim_ifp->pim_hello_period,&pi
m_ifp->t_pim_hello_timer);}/*Periodichellotimer*/staticinton_pim_hello_send(stru
ctthread*t){structpim_interface*pim_ifp;structinterface*ifp;ifp=THREAD_ARG(t);pi
m_ifp=ifp->info;/**Schedulenexthello*/hello_resched(ifp);/**Sendhello*/returnpim
_hello_send(ifp,PIM_IF_DEFAULT_HOLDTIME(pim_ifp));}/*RFC4601:4.3.1.SendingHelloM
essagesThus,ifarouterneedstosendaJoin/PruneorAssertmessageonaninterfaceonwhichit
hasnotyetsentaHellomessagewiththecurrentlyconfiguredIPaddress,thenitMUSTimmediat
elysendtherelevantHellomessagewithoutwaitingfortheHelloTimertoexpire,followedbyt
heJoin/PruneorAssertmessage.*/voidpim_hello_restart_now(structinterface*ifp){str
uctpim_interface*pim_ifp;pim_ifp=ifp->info;/**Resetnexthellotimer*/hello_resched
(ifp);/**Immediatelysendhello*/pim_hello_send(ifp,PIM_IF_DEFAULT_HOLDTIME(pim_if
p));}/*RFC4601:4.3.1.SendingHelloMessagesToallowneworrebootingrouterstolearnofPI
Mneighborsquickly,whenaHellomessageisreceivedfromanewneighbor,oraHellomessagewit
hanewGenIDisreceivedfromanexistingneighbor,anewHellomessageshouldbesentonthisint
erfaceafterarandomizeddelaybetween0andTriggered_Hello_Delay.*/voidpim_hello_rest
art_triggered(structinterface*ifp){structpim_interface*pim_ifp;inttriggered_hell
o_delay_msec;intrandom_msec;pim_ifp=ifp->info;/**Noneedtoeverstartloopbackorvrfd
evicehello's*/if(pim_if_is_loopback(pim_ifp->pim,ifp))return;/**Thereexistssitua
tionswherewehavetheaRPFoutthis*interface,butwehaven'tformedaneighboryet.This*hap
pensespeciallyduringinterfaceflaps.While*wewouldliketohandlethismoregracefullyin
other*partsofthecode.Inordertogetusupandrunning*let'sjustsendthehelloimmediate'i
sh*Thisshouldberevisitedwhenwegetnexthoptracking*inandwhenwehaveabetterhandleons
afely*handlingtherpfinformationforupstreamsthat*wecannotlegallyreachyet.*/trigge
red_hello_delay_msec=1;//triggered_hello_delay_msec=1000*//pim_ifp->pim_triggere
d_hello_delay;if(pim_ifp->t_pim_hello_timer){longremain_msec=pim_time_timer_rema
in_msec(pim_ifp->t_pim_hello_timer);if(remain_msec<=triggered_hello_delay_msec){
/*Reschedulinghellowouldincreasethedelay,thenit'sfastertojustwaitforthescheduled
periodichello.*/return;}THREAD_OFF(pim_ifp->t_pim_hello_timer);}random_msec=trig
gered_hello_delay_msec;//random_msec=random()%(triggered_hello_delay_msec+1);if(
PIM_DEBUG_PIM_HELLO){zlog_debug("Scheduling%dmsectriggeredhellooninterface%s",ra
ndom_msec,ifp->name);}thread_add_timer_msec(master,on_pim_hello_send,ifp,random_
msec,&pim_ifp->t_pim_hello_timer);}intpim_sock_add(structinterface*ifp){structpi
m_interface*pim_ifp;uint32_told_genid;pim_ifp=ifp->info;zassert(pim_ifp);if(pim_
ifp->pim_sock_fd>=0){if(PIM_DEBUG_PIM_PACKETS)zlog_debug("Can'trecreateexistingP
IMsocketfd=%dforinterface%s",pim_ifp->pim_sock_fd,ifp->name);return-1;}pim_ifp->
pim_sock_fd=pim_sock_open(ifp);if(pim_ifp->pim_sock_fd<0){if(PIM_DEBUG_PIM_PACKE
TS)zlog_debug("CouldnotopenPIMsocketoninterface%s",ifp->name);return-2;}pim_sock
et_ip_hdr(pim_ifp->pim_sock_fd);pim_ifp->t_pim_sock_read=NULL;pim_ifp->pim_sock_
creation=pim_time_monotonic_sec();/**Justensurethatthenewgenerationid*actuallych
oosessomethingdifferent.*Actuallyranacrossacasewherethis*happened,pre-switchtora
ndom().*Whilethisisunlikelytohappennow*let'smakesureitdoesn't.*/old_genid=pim_if
p->pim_generation_id;while(old_genid==pim_ifp->pim_generation_id)pim_ifp->pim_ge
neration_id=random();zlog_info("PIMINTERFACEUP:oninterface%sifindex=%d",ifp->nam
e,ifp->ifindex);/**StartreceivingPIMmessages*/pim_sock_read_on(ifp);/**Startsend
ingPIMhello's*/pim_hello_restart_triggered(ifp);return0;}