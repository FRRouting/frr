/**PIMforQuagga*Copyright(C)2015CumulusNetworks,Inc.*DonaldSharp**Thisprogramisf
reesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPubli
cLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(a
tyouroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#include<zebra.h>#include"lib/json.h"#include"log.h"#include"ne
twork.h"#include"if.h"#include"linklist.h"#include"prefix.h"#include"memory.h"#i
nclude"vty.h"#include"vrf.h"#include"plist.h"#include"nexthop.h"#include"table.h
"#include"pimd.h"#include"pim_vty.h"#include"pim_str.h"#include"pim_iface.h"#inc
lude"pim_rp.h"#include"pim_str.h"#include"pim_rpf.h"#include"pim_sock.h"#include
"pim_memory.h"#include"pim_iface.h"#include"pim_msdp.h"#include"pim_nht.h"/*Clea
nuppim->rpf_hasheachnodedata*/voidpim_rp_list_hash_clean(void*data){structpim_ne
xthop_cache*pnc=(structpim_nexthop_cache*)data;list_delete_and_null(&pnc->rp_lis
t);hash_clean(pnc->upstream_hash,NULL);hash_free(pnc->upstream_hash);pnc->upstre
am_hash=NULL;XFREE(MTYPE_PIM_NEXTHOP_CACHE,pnc);}staticvoidpim_rp_info_free(stru
ctrp_info*rp_info){XFREE(MTYPE_PIM_RP,rp_info);}intpim_rp_list_cmp(void*v1,void*
v2){structrp_info*rp1=(structrp_info*)v1;structrp_info*rp2=(structrp_info*)v2;/*
*SortbyRPIPaddress*/if(rp1->rp.rpf_addr.u.prefix4.s_addr<rp2->rp.rpf_addr.u.pref
ix4.s_addr)return-1;if(rp1->rp.rpf_addr.u.prefix4.s_addr>rp2->rp.rpf_addr.u.pref
ix4.s_addr)return1;/**SortbygroupIPaddress*/if(rp1->group.u.prefix4.s_addr<rp2->
group.u.prefix4.s_addr)return-1;if(rp1->group.u.prefix4.s_addr>rp2->group.u.pref
ix4.s_addr)return1;return0;}voidpim_rp_init(structpim_instance*pim){structrp_inf
o*rp_info;structroute_node*rn;pim->rp_list=list_new();if(!pim->rp_list){zlog_err
("Unabletoallocrp_list");return;}pim->rp_list->del=(void(*)(void*))pim_rp_info_f
ree;pim->rp_list->cmp=pim_rp_list_cmp;pim->rp_table=route_table_init();if(!pim->
rp_table){zlog_err("Unabletoallocrp_table");list_delete_and_null(&pim->rp_list);
return;}rp_info=XCALLOC(MTYPE_PIM_RP,sizeof(*rp_info));if(!rp_info){zlog_err("Un
abletoallocrp_info");route_table_finish(pim->rp_table);list_delete_and_null(&pim
->rp_list);return;}if(!str2prefix("224.0.0.0/4",&rp_info->group)){zlog_err("Unab
letoconvert224.0.0.0/4toprefix");list_delete_and_null(&pim->rp_list);route_table
_finish(pim->rp_table);XFREE(MTYPE_PIM_RP,rp_info);return;}rp_info->group.family
=AF_INET;rp_info->rp.rpf_addr.family=AF_INET;rp_info->rp.rpf_addr.prefixlen=IPV4
_MAX_PREFIXLEN;rp_info->rp.rpf_addr.u.prefix4.s_addr=INADDR_NONE;listnode_add(pi
m->rp_list,rp_info);rn=route_node_get(pim->rp_table,&rp_info->group);if(!rn){zlo
g_err("Failuretogetroutenodeforpim->rp_table");list_delete_and_null(&pim->rp_lis
t);route_table_finish(pim->rp_table);XFREE(MTYPE_PIM_RP,rp_info);return;}rn->inf
o=rp_info;if(PIM_DEBUG_TRACE)zlog_debug("Allocated:%pforrp_info:%p(224.0.0.0/4)L
ock:%d",rn,rp_info,rn->lock);}voidpim_rp_free(structpim_instance*pim){if(pim->rp
_list)list_delete_and_null(&pim->rp_list);}/**GivenanRP'sprefix-list,returntheRP
'srp_infoforthatprefix-list*/staticstructrp_info*pim_rp_find_prefix_list(structp
im_instance*pim,structin_addrrp,constchar*plist){structlistnode*node;structrp_in
fo*rp_info;for(ALL_LIST_ELEMENTS_RO(pim->rp_list,node,rp_info)){if(rp.s_addr==rp
_info->rp.rpf_addr.u.prefix4.s_addr&&rp_info->plist&&strcmp(rp_info->plist,plist
)==0){returnrp_info;}}returnNULL;}/**Returntrueifplistisusedbyanyrp_info*/static
intpim_rp_prefix_list_used(structpim_instance*pim,constchar*plist){structlistnod
e*node;structrp_info*rp_info;for(ALL_LIST_ELEMENTS_RO(pim->rp_list,node,rp_info)
){if(rp_info->plist&&strcmp(rp_info->plist,plist)==0){return1;}}return0;}/**Give
nanRP'saddress,returntheRP'srp_infothatisanexactmatchfor*'group'*/staticstructrp
_info*pim_rp_find_exact(structpim_instance*pim,structin_addrrp,structprefix*grou
p){structlistnode*node;structrp_info*rp_info;for(ALL_LIST_ELEMENTS_RO(pim->rp_li
st,node,rp_info)){if(rp.s_addr==rp_info->rp.rpf_addr.u.prefix4.s_addr&&prefix_sa
me(&rp_info->group,group))returnrp_info;}returnNULL;}/**Givenagroup,returntherp_
infoforthatgroup*/staticstructrp_info*pim_rp_find_match_group(structpim_instance
*pim,structprefix*group){structlistnode*node;structrp_info*best=NULL;structrp_in
fo*rp_info;structprefix_list*plist;structprefix*p,*bp;structroute_node*rn;bp=NUL
L;for(ALL_LIST_ELEMENTS_RO(pim->rp_list,node,rp_info)){if(rp_info->plist){plist=
prefix_list_lookup(AFI_IP,rp_info->plist);if(prefix_list_apply_which_prefix(plis
t,&p,group)==PREFIX_DENY)continue;if(!best){best=rp_info;bp=p;continue;}if(bp&&b
p->prefixlen<p->prefixlen){best=rp_info;bp=p;}}}rn=route_node_match(pim->rp_tabl
e,group);if(!rn){zlog_err("%s:BUGWeshouldhavefounddefaultgroupinformation\n",__P
RETTY_FUNCTION__);returnbest;}rp_info=rn->info;if(PIM_DEBUG_TRACE){charbuf[PREFI
X_STRLEN];route_unlock_node(rn);zlog_debug("Lookedup:%pforrp_info:%p(%s)Lock:%d"
,rn,rp_info,prefix2str(&rp_info->group,buf,sizeof(buf)),rn->lock);}if(!best)retu
rnrp_info;if(rp_info->group.prefixlen<best->group.prefixlen)best=rp_info;returnb
est;}/**Whentheusermakes"ippimrp"configurationchangesoriftheychangethe*prefix-li
st(s)usedbythesestatementswemusttickletheupstreamstate*foreachgrouptomakethemre-
lookupwhotheirRPshouldbe.**Thisisaplaceholderfunctionfornow.*/staticvoidpim_rp_r
efresh_group_to_rp_mapping(structpim_instance*pim){pim_msdp_i_am_rp_changed(pim)
;}voidpim_rp_prefix_list_update(structpim_instance*pim,structprefix_list*plist){
structlistnode*node;structrp_info*rp_info;intrefresh_needed=0;for(ALL_LIST_ELEME
NTS_RO(pim->rp_list,node,rp_info)){if(rp_info->plist&&strcmp(rp_info->plist,pref
ix_list_name(plist))==0){refresh_needed=1;break;}}if(refresh_needed)pim_rp_refre
sh_group_to_rp_mapping(pim);}staticintpim_rp_check_interface_addrs(structrp_info
*rp_info,structpim_interface*pim_ifp){structlistnode*node;structpim_secondary_ad
dr*sec_addr;if(pim_ifp->primary_address.s_addr==rp_info->rp.rpf_addr.u.prefix4.s
_addr)return1;if(!pim_ifp->sec_addr_list){return0;}for(ALL_LIST_ELEMENTS_RO(pim_
ifp->sec_addr_list,node,sec_addr)){if(prefix_same(&sec_addr->addr,&rp_info->rp.r
pf_addr)){return1;}}return0;}staticvoidpim_rp_check_interfaces(structpim_instanc
e*pim,structrp_info*rp_info){structinterface*ifp;rp_info->i_am_rp=0;FOR_ALL_INTE
RFACES(pim->vrf,ifp){structpim_interface*pim_ifp=ifp->info;if(!pim_ifp)continue;
if(pim_rp_check_interface_addrs(rp_info,pim_ifp)){rp_info->i_am_rp=1;}}}intpim_r
p_new(structpim_instance*pim,constchar*rp,constchar*group_range,constchar*plist)
{intresult=0;structrp_info*rp_info;structrp_info*rp_all;structprefixgroup_all;st
ructlistnode*node,*nnode;structrp_info*tmp_rp_info;charbuffer[BUFSIZ];structpref
ixnht_p;structpim_nexthop_cachepnc;structroute_node*rn;rp_info=XCALLOC(MTYPE_PIM
_RP,sizeof(*rp_info));if(!rp_info)returnPIM_MALLOC_FAIL;if(group_range==NULL)res
ult=str2prefix("224.0.0.0/4",&rp_info->group);elseresult=str2prefix(group_range,
&rp_info->group);if(!result){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_GROUP_BAD_ADD
RESS;}rp_info->rp.rpf_addr.family=AF_INET;rp_info->rp.rpf_addr.prefixlen=IPV4_MA
X_PREFIXLEN;result=inet_pton(rp_info->rp.rpf_addr.family,rp,&rp_info->rp.rpf_add
r.u.prefix4);if(result<=0){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_RP_BAD_ADDRESS;
}if(plist){/**Returniftheprefix-listisalreadyconfiguredforthisRP*/if(pim_rp_find
_prefix_list(pim,rp_info->rp.rpf_addr.u.prefix4,plist)){XFREE(MTYPE_PIM_RP,rp_in
fo);returnPIM_SUCCESS;}/**Barfiftheprefix-listisalreadyconfiguredforanRP*/if(pim
_rp_prefix_list_used(pim,plist)){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_RP_PFXLIS
T_IN_USE;}/**Freeanyexistingrp_infoentriesforthisRP*/for(ALL_LIST_ELEMENTS(pim->
rp_list,node,nnode,tmp_rp_info)){if(rp_info->rp.rpf_addr.u.prefix4.s_addr==tmp_r
p_info->rp.rpf_addr.u.prefix4.s_addr){if(tmp_rp_info->plist)pim_rp_del(pim,rp,NU
LL,tmp_rp_info->plist);elsepim_rp_del(pim,rp,prefix2str(&tmp_rp_info->group,buff
er,BUFSIZ),NULL);}}rp_info->plist=XSTRDUP(MTYPE_PIM_FILTER_NAME,plist);}else{if(
!str2prefix("224.0.0.0/4",&group_all)){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_GRO
UP_BAD_ADDRESS;}rp_all=pim_rp_find_match_group(pim,&group_all);/**Barfifgroupisa
non-multicastsubnet*/if(!prefix_match(&rp_all->group,&rp_info->group)){XFREE(MTY
PE_PIM_RP,rp_info);returnPIM_GROUP_BAD_ADDRESS;}/**Removeanyprefix-listrp_infoen
triesforthisRP*/for(ALL_LIST_ELEMENTS(pim->rp_list,node,nnode,tmp_rp_info)){if(t
mp_rp_info->plist&&rp_info->rp.rpf_addr.u.prefix4.s_addr==tmp_rp_info->rp.rpf_ad
dr.u.prefix4.s_addr){pim_rp_del(pim,rp,NULL,tmp_rp_info->plist);}}/**Takeoverthe
224.0.0.0/4groupiftherpisINADDR_NONE*/if(prefix_same(&rp_all->group,&rp_info->gr
oup)&&pim_rpf_addr_is_inaddr_none(&rp_all->rp)){rp_all->rp.rpf_addr=rp_info->rp.
rpf_addr;XFREE(MTYPE_PIM_RP,rp_info);/*RegisteraddrwithZebraNHT*/nht_p.family=AF
_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4=rp_all->rp.rpf_addr.u.pref
ix4;//RPaddressif(PIM_DEBUG_PIM_NHT_RP){charbuf[PREFIX2STR_BUFFER];charbuf1[PREF
IX2STR_BUFFER];prefix2str(&nht_p,buf,sizeof(buf));prefix2str(&rp_all->group,buf1
,sizeof(buf1));zlog_debug("%s:NHTRegisterrp_alladdr%sgrp%s",__PRETTY_FUNCTION__,
buf,buf1);}memset(&pnc,0,sizeof(structpim_nexthop_cache));if(pim_find_or_track_n
exthop(pim,&nht_p,NULL,rp_all,&pnc)){if(!pim_ecmp_nexthop_search(pim,&pnc,&rp_al
l->rp.source_nexthop,&nht_p,&rp_all->group,1))returnPIM_RP_NO_PATH;}else{if(pim_
nexthop_lookup(pim,&rp_all->rp.source_nexthop,rp_all->rp.rpf_addr.u.prefix4,1)!=
0)returnPIM_RP_NO_PATH;}pim_rp_check_interfaces(pim,rp_all);pim_rp_refresh_group
_to_rp_mapping(pim);returnPIM_SUCCESS;}/**Returnifthegroupisalreadyconfiguredfor
thisRP*/if(pim_rp_find_exact(pim,rp_info->rp.rpf_addr.u.prefix4,&rp_info->group)
){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_SUCCESS;}/**Barfifthisgroupisalreadycove
redbysomeotherRP*/tmp_rp_info=pim_rp_find_match_group(pim,&rp_info->group);if(tm
p_rp_info){if(tmp_rp_info->plist){XFREE(MTYPE_PIM_RP,rp_info);returnPIM_GROUP_PF
XLIST_OVERLAP;}else{/**IftheonlyRPthatcoversthisgroupisan*RPconfiguredfor*224.0.
0.0/4thatisfine,ignorethatone.*Forallothers*thoughwemustreturnPIM_GROUP_OVERLAP*
/if(prefix_same(&rp_info->group,&tmp_rp_info->group)){XFREE(MTYPE_PIM_RP,rp_info
);returnPIM_GROUP_OVERLAP;}}}}listnode_add_sort(pim->rp_list,rp_info);rn=route_n
ode_get(pim->rp_table,&rp_info->group);if(!rn){charbuf[PREFIX_STRLEN];zlog_err("
Failuretogetroutenodeforpim->rp_table:%s",prefix2str(&rp_info->group,buf,sizeof(
buf)));returnPIM_MALLOC_FAIL;}rn->info=rp_info;if(PIM_DEBUG_TRACE){charbuf[PREFI
X_STRLEN];zlog_debug("Allocated:%pforrp_info:%p(%s)Lock:%d",rn,rp_info,prefix2st
r(&rp_info->group,buf,sizeof(buf)),rn->lock);}/*RegisteraddrwithZebraNHT*/nht_p.
family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4=rp_info->rp.rpf_a
ddr.u.prefix4;if(PIM_DEBUG_PIM_NHT_RP){charbuf[PREFIX2STR_BUFFER];charbuf1[PREFI
X2STR_BUFFER];prefix2str(&nht_p,buf,sizeof(buf));prefix2str(&rp_info->group,buf1
,sizeof(buf1));zlog_debug("%s:NHTRegisterRPaddr%sgrp%swithZebra",__PRETTY_FUNCTI
ON__,buf,buf1);}memset(&pnc,0,sizeof(structpim_nexthop_cache));if(pim_find_or_tr
ack_nexthop(pim,&nht_p,NULL,rp_info,&pnc)){if(!pim_ecmp_nexthop_search(pim,&pnc,
&rp_info->rp.source_nexthop,&nht_p,&rp_info->group,1))returnPIM_RP_NO_PATH;}else
{if(pim_nexthop_lookup(pim,&rp_info->rp.source_nexthop,rp_info->rp.rpf_addr.u.pr
efix4,1)!=0)returnPIM_RP_NO_PATH;}pim_rp_check_interfaces(pim,rp_info);pim_rp_re
fresh_group_to_rp_mapping(pim);returnPIM_SUCCESS;}intpim_rp_del(structpim_instan
ce*pim,constchar*rp,constchar*group_range,constchar*plist){structprefixgroup;str
uctin_addrrp_addr;structprefixg_all;structrp_info*rp_info;structrp_info*rp_all;i
ntresult;structprefixnht_p;structroute_node*rn;boolwas_plist=false;if(group_rang
e==NULL)result=str2prefix("224.0.0.0/4",&group);elseresult=str2prefix(group_rang
e,&group);if(!result)returnPIM_GROUP_BAD_ADDRESS;result=inet_pton(AF_INET,rp,&rp
_addr);if(result<=0)returnPIM_RP_BAD_ADDRESS;if(plist)rp_info=pim_rp_find_prefix
_list(pim,rp_addr,plist);elserp_info=pim_rp_find_exact(pim,rp_addr,&group);if(!r
p_info)returnPIM_RP_NOT_FOUND;if(rp_info->plist){XFREE(MTYPE_PIM_FILTER_NAME,rp_
info->plist);rp_info->plist=NULL;was_plist=true;}/*DeregisteraddrwithZebraNHT*/n
ht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4=rp_info->rp.
rpf_addr.u.prefix4;if(PIM_DEBUG_PIM_NHT_RP){charbuf[PREFIX2STR_BUFFER];prefix2st
r(&nht_p,buf,sizeof(buf));zlog_debug("%s:DeregisterRPaddr%swithZebra",__PRETTY_F
UNCTION__,buf);}pim_delete_tracked_nexthop(pim,&nht_p,NULL,rp_info);if(!str2pref
ix("224.0.0.0/4",&g_all))returnPIM_RP_BAD_ADDRESS;rp_all=pim_rp_find_match_group
(pim,&g_all);if(rp_all==rp_info){rp_all->rp.rpf_addr.family=AF_INET;rp_all->rp.r
pf_addr.u.prefix4.s_addr=INADDR_NONE;rp_all->i_am_rp=0;returnPIM_SUCCESS;}listno
de_delete(pim->rp_list,rp_info);if(!was_plist){rn=route_node_get(pim->rp_table,&
rp_info->group);if(rn){if(rn->info!=rp_info)zlog_err("WTFmatey");if(PIM_DEBUG_TR
ACE){charbuf[PREFIX_STRLEN];zlog_debug("%s:FoundforFreeing:%pforrp_info:%p(%s)Lo
ck:%d",__PRETTY_FUNCTION__,rn,rp_info,prefix2str(&rp_info->group,buf,sizeof(buf)
),rn->lock);}rn->info=NULL;route_unlock_node(rn);route_unlock_node(rn);}}pim_rp_
refresh_group_to_rp_mapping(pim);XFREE(MTYPE_PIM_RP,rp_info);returnPIM_SUCCESS;}
voidpim_rp_setup(structpim_instance*pim){structlistnode*node;structrp_info*rp_in
fo;structprefixnht_p;structpim_nexthop_cachepnc;for(ALL_LIST_ELEMENTS_RO(pim->rp
_list,node,rp_info)){if(rp_info->rp.rpf_addr.u.prefix4.s_addr==INADDR_NONE)conti
nue;nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4=rp_info
->rp.rpf_addr.u.prefix4;memset(&pnc,0,sizeof(structpim_nexthop_cache));if(pim_fi
nd_or_track_nexthop(pim,&nht_p,NULL,rp_info,&pnc))pim_ecmp_nexthop_search(pim,&p
nc,&rp_info->rp.source_nexthop,&nht_p,&rp_info->group,1);else{if(PIM_DEBUG_PIM_N
HT_RP){charbuf[PREFIX2STR_BUFFER];prefix2str(&nht_p,buf,sizeof(buf));zlog_debug(
"%s:NHTLocalNexthopnotfoundforRP%s",__PRETTY_FUNCTION__,buf);}if(!pim_nexthop_lo
okup(pim,&rp_info->rp.source_nexthop,rp_info->rp.rpf_addr.u.prefix4,1))if(PIM_DE
BUG_PIM_NHT_RP)zlog_debug("Unabletolookupnexthopforrpspecified");}}}/**Checkstos
eeifweshouldelectourselftheactualRPwhennewif*addressesareaddedagainstaninterface
.*/voidpim_rp_check_on_if_add(structpim_interface*pim_ifp){structlistnode*node;s
tructrp_info*rp_info;booli_am_rp_changed=false;structpim_instance*pim=pim_ifp->p
im;if(pim->rp_list==NULL)return;for(ALL_LIST_ELEMENTS_RO(pim->rp_list,node,rp_in
fo)){if(pim_rpf_addr_is_inaddr_none(&rp_info->rp))continue;/*ifi_am_rpisalreadys
etnothingtobedone(addingnew*addresses*isnotgoingtomakeadifference).*/if(rp_info-
>i_am_rp){continue;}if(pim_rp_check_interface_addrs(rp_info,pim_ifp)){i_am_rp_ch
anged=true;rp_info->i_am_rp=1;if(PIM_DEBUG_PIM_NHT_RP){charrp[PREFIX_STRLEN];pim
_addr_dump("<rp?>",&rp_info->rp.rpf_addr,rp,sizeof(rp));zlog_debug("%s:%s:iamrp"
,__func__,rp);}}}if(i_am_rp_changed){pim_msdp_i_am_rp_changed(pim);}}/*up-optimi
zedre-evaluationof"i_am_rp".thisisusedwhenifaddresses*areremoved.Removingnumbers
isanuncommoneventinanactivenetwork*soIhavemadenoattempttooptimizeit.*/voidpim_i_
am_rp_re_evaluate(structpim_instance*pim){structlistnode*node;structrp_info*rp_i
nfo;booli_am_rp_changed=false;intold_i_am_rp;if(pim->rp_list==NULL)return;for(AL
L_LIST_ELEMENTS_RO(pim->rp_list,node,rp_info)){if(pim_rpf_addr_is_inaddr_none(&r
p_info->rp))continue;old_i_am_rp=rp_info->i_am_rp;pim_rp_check_interfaces(pim,rp
_info);if(old_i_am_rp!=rp_info->i_am_rp){i_am_rp_changed=true;if(PIM_DEBUG_PIM_N
HT_RP){charrp[PREFIX_STRLEN];pim_addr_dump("<rp?>",&rp_info->rp.rpf_addr,rp,size
of(rp));if(rp_info->i_am_rp){zlog_debug("%s:%s:iamrp",__func__,rp);}else{zlog_de
bug("%s:%s:iamnolongerrp",__func__,rp);}}}}if(i_am_rp_changed){pim_msdp_i_am_rp_
changed(pim);}}/**I_am_RP(G)istrueifthegroup-to-RPmappingindicatesthat*thisroute
ristheRPforthegroup.**SinceweonlyhavestaticRP,allgroupsarepartofthisRP*/intpim_r
p_i_am_rp(structpim_instance*pim,structin_addrgroup){structprefixg;structrp_info
*rp_info;memset(&g,0,sizeof(g));g.family=AF_INET;g.prefixlen=32;g.u.prefix4=grou
p;rp_info=pim_rp_find_match_group(pim,&g);if(rp_info)returnrp_info->i_am_rp;retu
rn0;}/**RP(G)**ReturntheRPthattheGroupbelongstoo.*/structpim_rpf*pim_rp_g(struct
pim_instance*pim,structin_addrgroup){structprefixg;structrp_info*rp_info;memset(
&g,0,sizeof(g));g.family=AF_INET;g.prefixlen=32;g.u.prefix4=group;rp_info=pim_rp
_find_match_group(pim,&g);if(rp_info){structprefixnht_p;structpim_nexthop_cachep
nc;/*RegisteraddrwithZebraNHT*/nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BIT
LEN;nht_p.u.prefix4=rp_info->rp.rpf_addr.u.prefix4;if(PIM_DEBUG_PIM_NHT_RP){char
buf[PREFIX2STR_BUFFER];charbuf1[PREFIX2STR_BUFFER];prefix2str(&nht_p,buf,sizeof(
buf));prefix2str(&rp_info->group,buf1,sizeof(buf1));zlog_debug("%s:NHTRegisterRP
addr%sgrp%swithZebra",__PRETTY_FUNCTION__,buf,buf1);}memset(&pnc,0,sizeof(struct
pim_nexthop_cache));if(pim_find_or_track_nexthop(pim,&nht_p,NULL,rp_info,&pnc))p
im_ecmp_nexthop_search(pim,&pnc,&rp_info->rp.source_nexthop,&nht_p,&rp_info->gro
up,1);else{if(PIM_DEBUG_PIM_NHT_RP){charbuf[PREFIX2STR_BUFFER];charbuf1[PREFIX2S
TR_BUFFER];prefix2str(&nht_p,buf,sizeof(buf));prefix2str(&g,buf1,sizeof(buf1));z
log_debug("%s:NexthopcachenotfoundforRP%sgrp%sregisterwithZebra",__PRETTY_FUNCTI
ON__,buf,buf1);}pim_rpf_set_refresh_time(pim);pim_nexthop_lookup(pim,&rp_info->r
p.source_nexthop,rp_info->rp.rpf_addr.u.prefix4,1);}return(&rp_info->rp);}//Abou
ttoGoDownreturnNULL;}/**SettheupstreamIPaddresswewanttotalktobasedupon*therpconf
iguredandthesourceaddress**Ifwehavedon'thaveaRPconfiguredandthesourceaddressis**
thenreturnfailure.**/intpim_rp_set_upstream_addr(structpim_instance*pim,structin
_addr*up,structin_addrsource,structin_addrgroup){structrp_info*rp_info;structpre
fixg;memset(&g,0,sizeof(g));g.family=AF_INET;g.prefixlen=32;g.u.prefix4=group;rp
_info=pim_rp_find_match_group(pim,&g);if((pim_rpf_addr_is_inaddr_none(&rp_info->
rp))&&(source.s_addr==INADDR_ANY)){if(PIM_DEBUG_PIM_NHT_RP)zlog_debug("%s:Receiv
eda(*,G)withnoRPconfigured",__PRETTY_FUNCTION__);return0;}*up=(source.s_addr==IN
ADDR_ANY)?rp_info->rp.rpf_addr.u.prefix4:source;return1;}intpim_rp_config_write(
structpim_instance*pim,structvty*vty,constchar*spaces){structlistnode*node;struc
trp_info*rp_info;charrp_buffer[32];chargroup_buffer[32];intcount=0;for(ALL_LIST_
ELEMENTS_RO(pim->rp_list,node,rp_info)){if(pim_rpf_addr_is_inaddr_none(&rp_info-
>rp))continue;if(rp_info->plist)vty_out(vty,"%sippimrp%sprefix-list%s\n",spaces,
inet_ntop(AF_INET,&rp_info->rp.rpf_addr.u.prefix4,rp_buffer,32),rp_info->plist);
elsevty_out(vty,"%sippimrp%s%s\n",spaces,inet_ntop(AF_INET,&rp_info->rp.rpf_addr
.u.prefix4,rp_buffer,32),prefix2str(&rp_info->group,group_buffer,32));count++;}r
eturncount;}intpim_rp_check_is_my_ip_address(structpim_instance*pim,structin_add
rgroup,structin_addrdest_addr){structrp_info*rp_info;structprefixg;memset(&g,0,s
izeof(g));g.family=AF_INET;g.prefixlen=32;g.u.prefix4=group;rp_info=pim_rp_find_
match_group(pim,&g);/**Seeifwecanshort-cutsome?*Thismightnotmakesenseifweeverlea
veastaticRP*typeofconfiguration.*Note-Prematureoptimizationmightbiteourpatooeys'
here.*/if(I_am_RP(pim,group)){if(dest_addr.s_addr==rp_info->rp.rpf_addr.u.prefix
4.s_addr)return1;}if(if_lookup_exact_address(&dest_addr,AF_INET,pim->vrf_id))ret
urn1;return0;}voidpim_rp_show_information(structpim_instance*pim,structvty*vty,u
int8_tuj){structrp_info*rp_info;structrp_info*prev_rp_info=NULL;structlistnode*n
ode;json_object*json=NULL;json_object*json_rp_rows=NULL;json_object*json_row=NUL
L;if(uj)json=json_object_new_object();elsevty_out(vty,"RPaddressgroup/prefix-lis
tOIFIamRP\n");for(ALL_LIST_ELEMENTS_RO(pim->rp_list,node,rp_info)){if(!pim_rpf_a
ddr_is_inaddr_none(&rp_info->rp)){charbuf[48];if(uj){/**IfwehavemovedontoanewRPt
henaddthe*entryforthepreviousRP*/if(prev_rp_info&&prev_rp_info->rp.rpf_addr.u.pr
efix4.s_addr!=rp_info->rp.rpf_addr.u.prefix4.s_addr){json_object_object_add(json
,inet_ntoa(prev_rp_info->rp.rpf_addr.u.prefix4),json_rp_rows);json_rp_rows=NULL;
}if(!json_rp_rows)json_rp_rows=json_object_new_array();json_row=json_object_new_
object();if(rp_info->rp.source_nexthop.interface)json_object_string_add(json_row
,"outboundInterface",rp_info->rp.source_nexthop.interface->name);if(rp_info->i_a
m_rp)json_object_boolean_true_add(json_row,"iAmRP");if(rp_info->plist)json_objec
t_string_add(json_row,"prefixList",rp_info->plist);elsejson_object_string_add(js
on_row,"group",prefix2str(&rp_info->group,buf,48));json_object_array_add(json_rp
_rows,json_row);}else{vty_out(vty,"%-15s",inet_ntoa(rp_info->rp.rpf_addr.u.prefi
x4));if(rp_info->plist)vty_out(vty,"%-18s",rp_info->plist);elsevty_out(vty,"%-18
s",prefix2str(&rp_info->group,buf,48));if(rp_info->rp.source_nexthop.interface)v
ty_out(vty,"%-10s",rp_info->rp.source_nexthop.interface->name);elsevty_out(vty,"
%-10s","(Unknown)");if(rp_info->i_am_rp)vty_out(vty,"yes\n");elsevty_out(vty,"no
\n");}prev_rp_info=rp_info;}}if(uj){if(prev_rp_info&&json_rp_rows)json_object_ob
ject_add(json,inet_ntoa(prev_rp_info->rp.rpf_addr.u.prefix4),json_rp_rows);vty_o
ut(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json
_object_free(json);}}voidpim_resolve_rp_nh(structpim_instance*pim){structlistnod
e*node=NULL;structrp_info*rp_info=NULL;structnexthop*nh_node=NULL;structprefixnh
t_p;structpim_nexthop_cachepnc;structpim_neighbor*nbr=NULL;for(ALL_LIST_ELEMENTS
_RO(pim->rp_list,node,rp_info)){if(rp_info->rp.rpf_addr.u.prefix4.s_addr==INADDR
_NONE)continue;nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.pref
ix4=rp_info->rp.rpf_addr.u.prefix4;memset(&pnc,0,sizeof(structpim_nexthop_cache)
);if(!pim_find_or_track_nexthop(pim,&nht_p,NULL,rp_info,&pnc))continue;for(nh_no
de=pnc.nexthop;nh_node;nh_node=nh_node->next){if(nh_node->gate.ipv4.s_addr!=0)co
ntinue;structinterface*ifp1=if_lookup_by_index(nh_node->ifindex,pim->vrf_id);nbr
=pim_neighbor_find_if(ifp1);if(!nbr)continue;nh_node->gate.ipv4=nbr->source_addr
;if(PIM_DEBUG_PIM_NHT_RP){charstr[PREFIX_STRLEN];charstr1[INET_ADDRSTRLEN];pim_i
net4_dump("<nht_nbr?>",nbr->source_addr,str1,sizeof(str1));pim_addr_dump("<nht_a
ddr?>",&nht_p,str,sizeof(str));zlog_debug("%s:addr%snewnexthopaddr%sinterface%s"
,__PRETTY_FUNCTION__,str,str1,ifp1->name);}}}}