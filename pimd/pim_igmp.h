/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#ifndefPIM_IGMP_H#definePIM_IGMP_H#include<netinet/in.h>#include<zebra.h>#
include"vty.h"#include"linklist.h"/*Thefollowingsizesarelikelytosupportanymessag
esentwithinlocalMTU.*/#definePIM_IGMP_BUFSIZE_READ(20000)#definePIM_IGMP_BUFSIZE
_WRITE(20000)#definePIM_IGMP_MEMBERSHIP_QUERY(0x11)#definePIM_IGMP_V1_MEMBERSHIP
_REPORT(0x12)#definePIM_IGMP_V2_MEMBERSHIP_REPORT(0x16)#definePIM_IGMP_V2_LEAVE_
GROUP(0x17)#definePIM_IGMP_MTRACE_RESPONSE(0x1E)#definePIM_IGMP_MTRACE_QUERY_REQ
UEST(0x1F)#definePIM_IGMP_V3_MEMBERSHIP_REPORT(0x22)#defineIGMP_V3_REPORT_HEADER
_SIZE(8)#defineIGMP_V3_GROUP_RECORD_MIN_SIZE(8)#defineIGMP_V3_MSG_MIN_SIZE\(IGMP
_V3_REPORT_HEADER_SIZE+IGMP_V3_GROUP_RECORD_MIN_SIZE)#defineIGMP_V12_MSG_SIZE(8)
#defineIGMP_V3_GROUP_RECORD_TYPE_OFFSET(0)#defineIGMP_V3_GROUP_RECORD_AUXDATALEN
_OFFSET(1)#defineIGMP_V3_GROUP_RECORD_NUMSOURCES_OFFSET(2)#defineIGMP_V3_GROUP_R
ECORD_GROUP_OFFSET(4)#defineIGMP_V3_GROUP_RECORD_SOURCE_OFFSET(8)#defineIGMP_CHE
CKSUM_OFFSET(2)/*RFC3376:8.1.RobustnessVariable-Default:2*/#defineIGMP_DEFAULT_R
OBUSTNESS_VARIABLE(2)/*RFC3376:8.2.QueryInterval-Default:125seconds*/#defineIGMP
_GENERAL_QUERY_INTERVAL(125)/*RFC3376:8.3.QueryResponseInterval-Default:100decis
econds*/#defineIGMP_QUERY_MAX_RESPONSE_TIME_DSEC(100)/*RFC3376:8.8.LastMemberQue
ryInterval-Default:10deciseconds*/#defineIGMP_SPECIFIC_QUERY_MAX_RESPONSE_TIME_D
SEC(10)#defineIGMP_DEFAULT_VERSION(3)structigmp_join{structin_addrgroup_addr;str
uctin_addrsource_addr;intsock_fd;time_tsock_creation;};structigmp_sock{intfd;str
uctinterface*interface;structin_addrifaddr;time_tsock_creation;structthread*t_ig
mp_read;/*read:IGMPsockets*/structthread*t_igmp_query_timer;/*timer:issueIGMPgen
eralqueries*/structthread*t_other_querier_timer;/*timer:otherquerierpresent*/int
querier_query_interval;/*QQI*/intquerier_robustness_variable;/*QRV*/intstartup_q
uery_count;boolmtrace_only;structlist*igmp_group_list;/*listofstructigmp_group*/
structhash*igmp_group_hash;};structigmp_sock*pim_igmp_sock_lookup_ifaddr(structl
ist*igmp_sock_list,structin_addrifaddr);structigmp_sock*igmp_sock_lookup_by_fd(s
tructlist*igmp_sock_list,intfd);structigmp_sock*pim_igmp_sock_add(structlist*igm
p_sock_list,structin_addrifaddr,structinterface*ifp,boolmtrace_only);voidigmp_so
ck_delete(structigmp_sock*igmp);voidigmp_sock_free(structigmp_sock*igmp);voidigm
p_sock_delete_all(structinterface*ifp);intpim_igmp_packet(structigmp_sock*igmp,c
har*buf,size_tlen);voidpim_igmp_general_query_on(structigmp_sock*igmp);voidpim_i
gmp_general_query_off(structigmp_sock*igmp);voidpim_igmp_other_querier_timer_on(
structigmp_sock*igmp);voidpim_igmp_other_querier_timer_off(structigmp_sock*igmp)
;#defineIGMP_SOURCE_MASK_FORWARDING(1<<0)#defineIGMP_SOURCE_MASK_DELETE(1<<1)#de
fineIGMP_SOURCE_MASK_SEND(1<<2)#defineIGMP_SOURCE_TEST_FORWARDING(flags)((flags)
&IGMP_SOURCE_MASK_FORWARDING)#defineIGMP_SOURCE_TEST_DELETE(flags)((flags)&IGMP_
SOURCE_MASK_DELETE)#defineIGMP_SOURCE_TEST_SEND(flags)((flags)&IGMP_SOURCE_MASK_
SEND)#defineIGMP_SOURCE_DO_FORWARDING(flags)((flags)|=IGMP_SOURCE_MASK_FORWARDIN
G)#defineIGMP_SOURCE_DO_DELETE(flags)((flags)|=IGMP_SOURCE_MASK_DELETE)#defineIG
MP_SOURCE_DO_SEND(flags)((flags)|=IGMP_SOURCE_MASK_SEND)#defineIGMP_SOURCE_DONT_
FORWARDING(flags)((flags)&=~IGMP_SOURCE_MASK_FORWARDING)#defineIGMP_SOURCE_DONT_
DELETE(flags)((flags)&=~IGMP_SOURCE_MASK_DELETE)#defineIGMP_SOURCE_DONT_SEND(fla
gs)((flags)&=~IGMP_SOURCE_MASK_SEND)structigmp_source{structin_addrsource_addr;s
tructthread*t_source_timer;structigmp_group*source_group;/*backpointer*/time_tso
urce_creation;uint32_tsource_flags;structchannel_oil*source_channel_oil;/*RFC337
6:6.6.3.2.BuildingandSendingGroupandSourceSpecificQueries*/intsource_query_retra
nsmit_count;};structigmp_group{/*RFC3376:6.2.2.DefinitionofGroupTimersThegroupti
merisonlyusedwhenagroupisinEXCLUDEmodeanditrepresentsthetimeforthe*filter-mode*o
fthegrouptoexpireandswitchtoINCLUDEmode.*/structthread*t_group_timer;/*Sharedbet
weengroup-specificandgroup-and-source-specificretransmissions*/structthread*t_gr
oup_query_retransmit_timer;/*Counterexclusiveforgroup-specificretransmissions(no
tusedbygroup-and-source-specificretransmissions,sincesourceshavetheircounters)*/
intgroup_specific_query_retransmit_count;/*compatibilitymode-igmpv1,v2orv3*/inti
gmp_version;structin_addrgroup_addr;intgroup_filtermode_isexcl;/*0=INCLUDE,1=EXC
LUDE*/structlist*group_source_list;/*listofstructigmp_source*/time_tgroup_creati
on;structigmp_sock*group_igmp_sock;/*backpointer*/int64_tlast_igmp_v1_report_dse
c;int64_tlast_igmp_v2_report_dsec;};structigmp_group*find_group_by_addr(structig
mp_sock*igmp,structin_addrgroup_addr);structigmp_group*igmp_add_group_by_addr(st
ructigmp_sock*igmp,structin_addrgroup_addr);voidigmp_group_delete_empty_include(
structigmp_group*group);voidigmp_startup_mode_on(structigmp_sock*igmp);voidigmp_
group_timer_on(structigmp_group*group,longinterval_msec,constchar*ifname);struct
igmp_source*source_new(structigmp_group*group,structin_addrsrc_addr);voidigmp_se
nd_query(intigmp_version,structigmp_group*group,intfd,constchar*ifname,char*quer
y_buf,intquery_buf_size,intnum_sources,structin_addrdst_addr,structin_addrgroup_
addr,intquery_max_response_time_dsec,uint8_ts_flag,uint8_tquerier_robustness_var
iable,uint16_tquerier_query_interval);#endif/*PIM_IGMP_H*/