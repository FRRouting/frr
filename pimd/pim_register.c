/**PIMforQuagga*Copyright(C)2015CumulusNetworks,Inc.*DonaldSharp**Thisprogramisf
reesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPubli
cLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(a
tyouroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#include<zebra.h>#include"log.h"#include"if.h"#include"thread.h
"#include"prefix.h"#include"vty.h"#include"plist.h"#include"pimd.h"#include"pim_
mroute.h"#include"pim_iface.h"#include"pim_msg.h"#include"pim_pim.h"#include"pim
_str.h"#include"pim_rp.h"#include"pim_register.h"#include"pim_upstream.h"#includ
e"pim_br.h"#include"pim_rpf.h"#include"pim_oil.h"#include"pim_zebra.h"#include"p
im_join.h"#include"pim_util.h"#include"pim_ssm.h"structthread*send_test_packet_t
imer=NULL;voidpim_register_join(structpim_upstream*up){structpim_instance*pim=up
->channel_oil->pim;if(pim_is_grp_ssm(pim,up->sg.grp)){if(PIM_DEBUG_PIM_EVENTS)zl
og_debug("%sregistersetupskippedasgroupisSSM",up->sg_str);return;}pim_channel_ad
d_oif(up->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_PIM);up->reg_state=PIM_RE
G_JOIN;}voidpim_register_stop_send(structinterface*ifp,structprefix_sg*sg,struct
in_addrsrc,structin_addroriginator){structpim_interface*pinfo;unsignedcharbuffer
[10000];unsignedintb1length=0;unsignedintlength;uint8_t*b1;structprefixp;if(PIM_
DEBUG_PIM_REG){zlog_debug("SendingRegisterstopfor%sto%son%s",pim_str_sg_dump(sg)
,inet_ntoa(originator),ifp->name);}memset(buffer,0,10000);b1=(uint8_t*)buffer+PI
M_MSG_REGISTER_STOP_LEN;length=pim_encode_addr_group(b1,AFI_IP,0,0,sg->grp);b1le
ngth+=length;b1+=length;p.family=AF_INET;p.u.prefix4=sg->src;p.prefixlen=32;leng
th=pim_encode_addr_ucast(b1,&p);b1length+=length;pim_msg_build_header(buffer,b1l
ength+PIM_MSG_REGISTER_STOP_LEN,PIM_MSG_TYPE_REG_STOP);pinfo=(structpim_interfac
e*)ifp->info;if(!pinfo){if(PIM_DEBUG_PIM_TRACE)zlog_debug("%s:Nopinfo!\n",__PRET
TY_FUNCTION__);return;}if(pim_msg_send(pinfo->pim_sock_fd,src,originator,buffer,
b1length+PIM_MSG_REGISTER_STOP_LEN,ifp->name)){if(PIM_DEBUG_PIM_TRACE){zlog_debu
g("%s:couldnotsendPIMregisterstopmessageoninterface%s",__PRETTY_FUNCTION__,ifp->
name);}}++pinfo->pim_ifstat_reg_stop_send;}intpim_register_stop_recv(structinter
face*ifp,uint8_t*buf,intbuf_size){structpim_interface*pim_ifp=ifp->info;structpi
m_instance*pim=pim_ifp->pim;structpim_upstream*upstream=NULL;structprefixsource;
structprefix_sgsg;intl;memset(&sg,0,sizeof(structprefix_sg));l=pim_parse_addr_gr
oup(&sg,buf,buf_size);buf+=l;buf_size-=l;pim_parse_addr_ucast(&source,buf,buf_si
ze);sg.src=source.u.prefix4;upstream=pim_upstream_find(pim,&sg);if(!upstream){re
turn0;}if(PIM_DEBUG_PIM_REG)zlog_debug("ReceivedRegisterstopfor%s",upstream->sg_
str);switch(upstream->reg_state){casePIM_REG_NOINFO:casePIM_REG_PRUNE:return0;br
eak;casePIM_REG_JOIN:upstream->reg_state=PIM_REG_PRUNE;pim_channel_del_oif(upstr
eam->channel_oil,pim->regiface,PIM_OIF_FLAG_PROTO_PIM);pim_upstream_start_regist
er_stop_timer(upstream,0);break;casePIM_REG_JOIN_PENDING:upstream->reg_state=PIM
_REG_PRUNE;pim_upstream_start_register_stop_timer(upstream,0);return0;break;}ret
urn0;}voidpim_register_send(constuint8_t*buf,intbuf_size,structin_addrsrc,struct
pim_rpf*rpg,intnull_register,structpim_upstream*up){unsignedcharbuffer[10000];un
signedchar*b1;structpim_interface*pinfo;structinterface*ifp;if(PIM_DEBUG_PIM_REG
){zlog_debug("Sending%s%sRegisterPacketto%s",up->sg_str,null_register?"NULL":"",
inet_ntoa(rpg->rpf_addr.u.prefix4));}ifp=rpg->source_nexthop.interface;if(!ifp){
if(PIM_DEBUG_PIM_REG)zlog_debug("%s:Nointerfacetotransmitregisteron",__PRETTY_FU
NCTION__);return;}pinfo=(structpim_interface*)ifp->info;if(!pinfo){if(PIM_DEBUG_
PIM_REG)zlog_debug("%s:Interface:%snotconfiguredforpimtotrasmiton!\n",__PRETTY_F
UNCTION__,ifp->name);return;}if(PIM_DEBUG_PIM_REG){charrp_str[INET_ADDRSTRLEN];s
trncpy(rp_str,inet_ntoa(rpg->rpf_addr.u.prefix4),INET_ADDRSTRLEN-1);zlog_debug("
%s:Sending%s%sRegisterPacketto%son%s",__PRETTY_FUNCTION__,up->sg_str,null_regist
er?"NULL":"",rp_str,ifp->name);}memset(buffer,0,10000);b1=buffer+PIM_MSG_HEADER_
LEN;*b1|=null_register<<6;b1=buffer+PIM_MSG_REGISTER_LEN;memcpy(b1,(constunsigne
dchar*)buf,buf_size);pim_msg_build_header(buffer,buf_size+PIM_MSG_REGISTER_LEN,P
IM_MSG_TYPE_REGISTER);++pinfo->pim_ifstat_reg_send;if(pim_msg_send(pinfo->pim_so
ck_fd,src,rpg->rpf_addr.u.prefix4,buffer,buf_size+PIM_MSG_REGISTER_LEN,ifp->name
)){if(PIM_DEBUG_PIM_TRACE){zlog_debug("%s:couldnotsendPIMregistermessageoninterf
ace%s",__PRETTY_FUNCTION__,ifp->name);}return;}}/**4.4.2ReceivingRegisterMessage
sattheRP**WhenanRPreceivesaRegistermessage,thecourseofactionis*decidedaccordingt
othefollowingpseudocode:**packet_arrives_on_rp_tunnel(pkt){*if(outer.dstisnotone
ofmyaddresses){*dropthepacketsilently.*#Note:thismaybeaspoofingattempt*}*if(I_am
_RP(G)ANDouter.dst==RP(G)){*sentRegisterStop=FALSE;*if(register.borderbit==TRUE)
{*if(PMBR(S,G)==unknown){*PMBR(S,G)=outer.src*}elseif(outer.src!=PMBR(S,G)){*sen
dRegister-Stop(S,G)toouter.src*dropthepacketsilently.*}*}*if(SPTbit(S,G)OR*(Swit
chToSptDesired(S,G)AND*(inherited_olist(S,G)==NULL))){*sendRegister-Stop(S,G)too
uter.src*sentRegisterStop=TRUE;*}*if(SPTbit(S,G)ORSwitchToSptDesired(S,G)){*if(s
entRegisterStop==TRUE){*setKeepaliveTimer(S,G)toRP_Keepalive_Period;*}else{*setK
eepaliveTimer(S,G)toKeepalive_Period;*}*}*if(!SPTbit(S,G)AND!pkt.NullRegisterBit
){*decapsulateandforwardtheinnerpacketto*inherited_olist(S,G,rpt)#Note(+)*}*}els
e{*sendRegister-Stop(S,G)toouter.src*#Note(*)*}*}*/intpim_register_recv(structin
terface*ifp,structin_addrdest_addr,structin_addrsrc_addr,uint8_t*tlv_buf,inttlv_
buf_size){intsentRegisterStop=0;structip*ip_hdr;structprefix_sgsg;uint32_t*bits;
inti_am_rp=0;structpim_interface*pim_ifp=NULL;pim_ifp=ifp->info;#definePIM_MSG_R
EGISTER_BIT_RESERVED_LEN4ip_hdr=(structip*)(tlv_buf+PIM_MSG_REGISTER_BIT_RESERVE
D_LEN);if(!pim_rp_check_is_my_ip_address(pim_ifp->pim,ip_hdr->ip_dst,dest_addr))
{if(PIM_DEBUG_PIM_REG){chardest[INET_ADDRSTRLEN];pim_inet4_dump("<dst?>",dest_ad
dr,dest,sizeof(dest));zlog_debug("%s:ReceivedRegistermessagefor%sthatIdonotown",
__func__,dest);}return0;}++pim_ifp->pim_ifstat_reg_recv;/**Pleasenotethisisnotdr
awntogetthecorrectbit/datasize**TheentiretyoftheREGISTERpacketlookslikethis:*---
----------------------------------------------------------*|Ver|Type|Reserved|Ch
ecksum|*|-----------------------------------------------------------|*|B|N|Reser
ved2|*|-----------------------------------------------------------|*|Encap|IPHDR
|*|Mcast||*|Packet|--------------------------------------------------|*||McastDa
ta|*|||*...**tlv_bufwhenreceivedfromthecallerpointsattheBbit*Weneedtoknowtheinne
rsourceanddest*/bits=(uint32_t*)tlv_buf;/**tlv_bufpointstothestartofthe|B|N|...R
eserved*Lineabove.Soweneedtoadd4bytestogettothe*startoftheactualEncapsulateddata
.*/memset(&sg,0,sizeof(structprefix_sg));sg.src=ip_hdr->ip_src;sg.grp=ip_hdr->ip
_dst;i_am_rp=I_am_RP(pim_ifp->pim,sg.grp);if(PIM_DEBUG_PIM_REG){charsrc_str[INET
_ADDRSTRLEN];pim_inet4_dump("<src?>",src_addr,src_str,sizeof(src_str));zlog_debu
g("ReceivedRegistermessage(%s)from%son%s,rp:%d",pim_str_sg_dump(&sg),src_str,ifp
->name,i_am_rp);}if(i_am_rp&&(dest_addr.s_addr==((RP(pim_ifp->pim,sg.grp))->rpf_
addr.u.prefix4.s_addr))){sentRegisterStop=0;if(*bits&PIM_REGISTER_BORDER_BIT){st
ructin_addrpimbr=pim_br_get_pmbr(&sg);if(PIM_DEBUG_PIM_PACKETS)zlog_debug("%s:Re
ceivedRegistermessagewithBorderbitset",__func__);if(pimbr.s_addr==pim_br_unknown
.s_addr)pim_br_set_pmbr(&sg,src_addr);elseif(src_addr.s_addr!=pimbr.s_addr){pim_
register_stop_send(ifp,&sg,dest_addr,src_addr);if(PIM_DEBUG_PIM_PACKETS)zlog_deb
ug("%s:Sendingregister-Stopto%sanddroppingmr.packet",__func__,"Sender");/*DropPa
cketSilently*/return0;}}structpim_upstream*upstream=pim_upstream_find(pim_ifp->p
im,&sg);/**Ifwedon'thaveaplacetosendignorethepacket*/if(!upstream){upstream=pim_
upstream_add(pim_ifp->pim,&sg,ifp,PIM_UPSTREAM_FLAG_MASK_SRC_STREAM,__PRETTY_FUN
CTION__,NULL);if(!upstream){zlog_warn("Failuretocreateupstreamstate");return1;}u
pstream->upstream_register=src_addr;}else{/**IftheFHRhassetaveryveryfastregister
timer*thereexistsapossibilitythattheincomingNULL*register*ishappeningbeforeweset
thesptbit.Ifso*Doaquickchecktoupdatethecountersand*thensetthesptbitasappropriate
*/if(upstream->sptbit!=PIM_UPSTREAM_SPTBIT_TRUE){pim_mroute_update_counters(upst
ream->channel_oil);/**Haveweseenpackets?*/if(upstream->channel_oil->cc.oldpktcnt
<upstream->channel_oil->cc.pktcnt)pim_upstream_set_sptbit(upstream,upstream->rpf
.source_nexthop.interface);}}if((upstream->sptbit==PIM_UPSTREAM_SPTBIT_TRUE)||((
SwitchToSptDesired(pim_ifp->pim,&sg))&&pim_upstream_inherited_olist(pim_ifp->pim
,upstream)==0)){//pim_scan_individual_oil(upstream->channel_oil);pim_register_st
op_send(ifp,&sg,dest_addr,src_addr);sentRegisterStop=1;}else{if(PIM_DEBUG_PIM_RE
G)zlog_debug("(%s)sptbit:%d",upstream->sg_str,upstream->sptbit);}if((upstream->s
ptbit==PIM_UPSTREAM_SPTBIT_TRUE)||(SwitchToSptDesired(pim_ifp->pim,&sg))){if(sen
tRegisterStop){pim_upstream_keep_alive_timer_start(upstream,pim_ifp->pim->rp_kee
p_alive_time);}else{pim_upstream_keep_alive_timer_start(upstream,pim_ifp->pim->k
eep_alive_time);}}if(!(upstream->sptbit==PIM_UPSTREAM_SPTBIT_TRUE)&&!(*bits&PIM_
REGISTER_NR_BIT)){//decapsulateandforwardtheinerpacketto//inherited_olist(S,G,rp
t)//Thisistakencareofbythekernelforus}pim_upstream_msdp_reg_timer_start(upstream
);}else{if(PIM_DEBUG_PIM_REG){if(!i_am_rp)zlog_debug("ReceivedRegisterpacketfor%
s,RejectingpacketbecauseIamnottheRPconfiguredforgroup",pim_str_sg_dump(&sg));els
ezlog_debug("ReceivedRegisterpacketfor%s,Rejectingpacketbecausethedstipaddressis
nottheactualRP",pim_str_sg_dump(&sg));}pim_register_stop_send(ifp,&sg,dest_addr,
src_addr);}return0;}