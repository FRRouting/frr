/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"if.h"#include"log.h"#include"prefix.h"#include"m
emory.h"#include"jhash.h"#include"pimd.h"#include"pim_rpf.h"#include"pim_pim.h"#
include"pim_str.h"#include"pim_iface.h"#include"pim_zlookup.h"#include"pim_ifcha
nnel.h"#include"pim_time.h"#include"pim_nht.h"#include"pim_oil.h"staticstructin_
addrpim_rpf_find_rpf_addr(structpim_upstream*up);voidpim_rpf_set_refresh_time(st
ructpim_instance*pim){pim->last_route_change_time=pim_time_monotonic_usec();if(P
IM_DEBUG_TRACE)zlog_debug("%s:vrf(%s)Newlastroutechangetime:%"PRId64,__PRETTY_FU
NCTION__,pim->vrf->name,pim->last_route_change_time);}intpim_nexthop_lookup(stru
ctpim_instance*pim,structpim_nexthop*nexthop,structin_addraddr,intneighbor_neede
d){structpim_zlookup_nexthopnexthop_tab[MULTIPATH_NUM];structpim_neighbor*nbr=NU
LL;intnum_ifindex;structinterface*ifp=NULL;ifindex_tfirst_ifindex=0;intfound=0;i
nti=0;/**Weshouldnotattempttolookupa*255.255.255.255address,since*itwillneverwor
k*/if(addr.s_addr==INADDR_NONE)return-1;if((nexthop->last_lookup.s_addr==addr.s_
addr)&&(nexthop->last_lookup_time>pim->last_route_change_time)){if(PIM_DEBUG_TRA
CE){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(
addr_str));charnexthop_str[PREFIX_STRLEN];pim_addr_dump("<nexthop?>",&nexthop->m
rib_nexthop_addr,nexthop_str,sizeof(nexthop_str));zlog_debug("%s:Usinglastlookup
for%sat%lld,%"PRId64"addr%s",__PRETTY_FUNCTION__,addr_str,nexthop->last_lookup_t
ime,pim->last_route_change_time,nexthop_str);}pim->nexthop_lookups_avoided++;ret
urn0;}else{if(PIM_DEBUG_TRACE){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ad
dr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s:Lookingup:%s,lastlookuptime
:%lld,%"PRId64,__PRETTY_FUNCTION__,addr_str,nexthop->last_lookup_time,pim->last_
route_change_time);}}memset(nexthop_tab,0,sizeof(structpim_zlookup_nexthop)*MULT
IPATH_NUM);num_ifindex=zclient_lookup_nexthop(pim,nexthop_tab,MULTIPATH_NUM,addr
,PIM_NEXTHOP_LOOKUP_MAX);if(num_ifindex<1){charaddr_str[INET_ADDRSTRLEN];pim_ine
t4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s%s:couldnotfindne
xthopifindexforaddress%s",__FILE__,__PRETTY_FUNCTION__,addr_str);return-1;}while
(!found&&(i<num_ifindex)){first_ifindex=nexthop_tab[i].ifindex;ifp=if_lookup_by_
index(first_ifindex,pim->vrf_id);if(!ifp){if(PIM_DEBUG_ZEBRA){charaddr_str[INET_
ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug(
"%s%s:couldnotfindinterfaceforifindex%d(address%s)",__FILE__,__PRETTY_FUNCTION__
,first_ifindex,addr_str);}i++;continue;}if(!ifp->info){if(PIM_DEBUG_ZEBRA){chara
ddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str)
);zlog_debug("%s:multicastnotenabledoninputinterface%s(ifindex=%d,RPFforsource%s
)",__PRETTY_FUNCTION__,ifp->name,first_ifindex,addr_str);}i++;}elseif(neighbor_n
eeded&&!pim_if_connected_to_source(ifp,addr)){nbr=pim_neighbor_find(ifp,nexthop_
tab[i].nexthop_addr.u.prefix4);if(PIM_DEBUG_PIM_TRACE_DETAIL)zlog_debug("ifpname
:%s,pimnbr:%p",ifp->name,nbr);if(!nbr&&!if_is_loopback(ifp))i++;elsefound=1;}els
efound=1;}if(found){if(PIM_DEBUG_ZEBRA){charnexthop_str[PREFIX_STRLEN];charaddr_
str[INET_ADDRSTRLEN];pim_addr_dump("<nexthop?>",&nexthop_tab[i].nexthop_addr,nex
thop_str,sizeof(nexthop_str));pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr
_str));zlog_debug("%s%s:foundnexthop%sforaddress%s:interface%sifindex=%dmetric=%
dpref=%d",__FILE__,__PRETTY_FUNCTION__,nexthop_str,addr_str,ifp->name,first_ifin
dex,nexthop_tab[i].route_metric,nexthop_tab[i].protocol_distance);}/*updatenexto
pdata*/nexthop->interface=ifp;nexthop->mrib_nexthop_addr=nexthop_tab[i].nexthop_
addr;nexthop->mrib_metric_preference=nexthop_tab[i].protocol_distance;nexthop->m
rib_route_metric=nexthop_tab[i].route_metric;nexthop->last_lookup=addr;nexthop->
last_lookup_time=pim_time_monotonic_usec();nexthop->nbr=nbr;return0;}elsereturn-
1;}staticintnexthop_mismatch(conststructpim_nexthop*nh1,conststructpim_nexthop*n
h2){return(nh1->interface!=nh2->interface)||(nh1->mrib_nexthop_addr.u.prefix4.s_
addr!=nh2->mrib_nexthop_addr.u.prefix4.s_addr)||(nh1->mrib_metric_preference!=nh
2->mrib_metric_preference)||(nh1->mrib_route_metric!=nh2->mrib_route_metric);}en
umpim_rpf_resultpim_rpf_update(structpim_instance*pim,structpim_upstream*up,stru
ctpim_rpf*old,uint8_tis_new){structpim_rpf*rpf=&up->rpf;structpim_rpfsaved;struc
tprefixnht_p;structpim_nexthop_cachepnc;structprefixsrc,grp;saved.source_nexthop
=rpf->source_nexthop;saved.rpf_addr=rpf->rpf_addr;if(is_new&&PIM_DEBUG_ZEBRA){ch
arsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<source?>",up->upstream_addr,sourc
e_str,sizeof(source_str));zlog_debug("%s:NHTRegisterupstream%saddr%swithZebra.",
__PRETTY_FUNCTION__,up->sg_str,source_str);}/*RegisteraddrwithZebraNHT*/nht_p.fa
mily=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;nht_p.u.prefix4.s_addr=up->upstream
_addr.s_addr;src.family=AF_INET;src.prefixlen=IPV4_MAX_BITLEN;src.u.prefix4=up->
upstream_addr;//RPorSrcaddressgrp.family=AF_INET;grp.prefixlen=IPV4_MAX_BITLEN;g
rp.u.prefix4=up->sg.grp;memset(&pnc,0,sizeof(structpim_nexthop_cache));if(pim_fi
nd_or_track_nexthop(pim,&nht_p,up,NULL,&pnc)){if(pnc.nexthop_num){if(!pim_ecmp_n
exthop_search(pim,&pnc,&up->rpf.source_nexthop,&src,&grp,!PIM_UPSTREAM_FLAG_TEST
_FHR(up->flags)&&!PIM_UPSTREAM_FLAG_TEST_SRC_IGMP(up->flags)))returnPIM_RPF_FAIL
URE;}}else{if(!pim_ecmp_nexthop_lookup(pim,&rpf->source_nexthop,up->upstream_add
r,&src,&grp,!PIM_UPSTREAM_FLAG_TEST_FHR(up->flags)&&!PIM_UPSTREAM_FLAG_TEST_SRC_
IGMP(up->flags)))returnPIM_RPF_FAILURE;}rpf->rpf_addr.family=AF_INET;rpf->rpf_ad
dr.u.prefix4=pim_rpf_find_rpf_addr(up);if(pim_rpf_addr_is_inaddr_any(rpf)&&PIM_D
EBUG_ZEBRA){/*RPF'(S,G)notfound*/zlog_debug("%s%s:RPF'%snotfound:won'tsendjoinup
stream",__FILE__,__PRETTY_FUNCTION__,up->sg_str);/*warningonly*/}/*detectchangei
npim_nexthop*/if(nexthop_mismatch(&rpf->source_nexthop,&saved.source_nexthop)){i
f(PIM_DEBUG_ZEBRA){charnhaddr_str[PREFIX_STRLEN];pim_addr_dump("<addr?>",&rpf->s
ource_nexthop.mrib_nexthop_addr,nhaddr_str,sizeof(nhaddr_str));zlog_debug("%s%s:
(S,G)=%ssourcenexthopnowis:interface=%saddress=%spref=%dmetric=%d",__FILE__,__PR
ETTY_FUNCTION__,up->sg_str,rpf->source_nexthop.interface?rpf->source_nexthop.int
erface->name:"<ifname?>",nhaddr_str,rpf->source_nexthop.mrib_metric_preference,r
pf->source_nexthop.mrib_route_metric);}pim_upstream_update_join_desired(pim,up);
pim_upstream_update_could_assert(up);pim_upstream_update_my_assert_metric(up);}/
*detectchangeinRPF_interface(S)*/if(saved.source_nexthop.interface!=rpf->source_
nexthop.interface){if(PIM_DEBUG_ZEBRA){zlog_debug("%s%s:(S,G)=%sRPF_interface(S)
changedfrom%sto%s",__FILE__,__PRETTY_FUNCTION__,up->sg_str,saved.source_nexthop.
interface?saved.source_nexthop.interface->name:"<oldif?>",rpf->source_nexthop.in
terface?rpf->source_nexthop.interface->name:"<newif?>");/*warningonly*/}pim_upst
ream_rpf_interface_changed(up,saved.source_nexthop.interface);}/*detectchangeinR
PF'(S,G)*/if(saved.rpf_addr.u.prefix4.s_addr!=rpf->rpf_addr.u.prefix4.s_addr||sa
ved.source_nexthop.interface!=rpf->source_nexthop.interface){/*returnoldrpftocal
ler?*/if(old){old->source_nexthop=saved.source_nexthop;old->rpf_addr=saved.rpf_a
ddr;}returnPIM_RPF_CHANGED;}returnPIM_RPF_OK;}/*RFC4601:4.1.6.StateSummarization
MacrosneighborRPF'(S,G){if(I_Am_Assert_Loser(S,G,RPF_interface(S))){returnAssert
Winner(S,G,RPF_interface(S))}else{returnNBR(RPF_interface(S),MRIB.next_hop(S))}}
RPF'(*,G)andRPF'(S,G)indicatetheneighborfromwhichdatapacketsshouldbecomingandtow
hichjoinsshouldbesentontheRPtreeandSPT,respectively.*/staticstructin_addrpim_rpf
_find_rpf_addr(structpim_upstream*up){structpim_ifchannel*rpf_ch;structpim_neigh
bor*neigh;structin_addrrpf_addr;if(!up->rpf.source_nexthop.interface){zlog_warn(
"%s:missingRPFinterfaceforupstream(S,G)=%s",__PRETTY_FUNCTION__,up->sg_str);rpf_
addr.s_addr=PIM_NET_INADDR_ANY;returnrpf_addr;}rpf_ch=pim_ifchannel_find(up->rpf
.source_nexthop.interface,&up->sg);if(rpf_ch){if(rpf_ch->ifassert_state==PIM_IFA
SSERT_I_AM_LOSER){returnrpf_ch->ifassert_winner;}}/*returnNBR(RPF_interface(S),M
RIB.next_hop(S))*/neigh=pim_if_find_neighbor(up->rpf.source_nexthop.interface,up
->rpf.source_nexthop.mrib_nexthop_addr.u.prefix4);if(neigh)rpf_addr=neigh->sourc
e_addr;elserpf_addr.s_addr=PIM_NET_INADDR_ANY;returnrpf_addr;}intpim_rpf_addr_is
_inaddr_none(structpim_rpf*rpf){switch(rpf->rpf_addr.family){caseAF_INET:returnr
pf->rpf_addr.u.prefix4.s_addr==INADDR_NONE;break;caseAF_INET6:zlog_warn("%s:v6Un
implmeneted",__PRETTY_FUNCTION__);return1;break;default:return0;break;}return0;}
intpim_rpf_addr_is_inaddr_any(structpim_rpf*rpf){switch(rpf->rpf_addr.family){ca
seAF_INET:returnrpf->rpf_addr.u.prefix4.s_addr==INADDR_ANY;break;caseAF_INET6:zl
og_warn("%s:v6Unimplmented",__PRETTY_FUNCTION__);return1;break;default:return0;b
reak;}return0;}intpim_rpf_is_same(structpim_rpf*rpf1,structpim_rpf*rpf2){if(rpf1
->source_nexthop.interface==rpf2->source_nexthop.interface)return1;return0;}unsi
gnedintpim_rpf_hash_key(void*arg){structpim_nexthop_cache*r=(structpim_nexthop_c
ache*)arg;returnjhash_1word(r->rpf.rpf_addr.u.prefix4.s_addr,0);}intpim_rpf_equa
l(constvoid*arg1,constvoid*arg2){conststructpim_nexthop_cache*r1=(conststructpim
_nexthop_cache*)arg1;conststructpim_nexthop_cache*r2=(conststructpim_nexthop_cac
he*)arg2;returnprefix_same(&r1->rpf.rpf_addr,&r2->rpf.rpf_addr);}