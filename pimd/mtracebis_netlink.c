/**libnetlink.cRTnetlinkserviceroutines.**Thisprogramisfreesoftware;youcanredist
ributeitand/or*modifyitunderthetermsoftheGNUGeneralPublicLicense*aspublishedbyth
eFreeSoftwareFoundation;eitherversion*2oftheLicense,or(atyouroption)anylatervers
ion.**Authors:AlexeyKuznetsov,<kuznet@ms2.inr.ac.ru>**/#ifdef__linux__#include<s
tdio.h>#include<stdlib.h>#include<unistd.h>#include<syslog.h>#include<fcntl.h>#i
nclude<net/if_arp.h>#include<sys/socket.h>#include<netinet/in.h>#include<string.
h>#include<errno.h>#include<time.h>#include<sys/uio.h>#include<assert.h>#include
"mtracebis_netlink.h"intrcvbuf=1024*1024;voidrtnl_close(structrtnl_handle*rth){i
f(rth->fd>=0){close(rth->fd);rth->fd=-1;}}intrtnl_open_byproto(structrtnl_handle
*rth,unsignedsubscriptions,intprotocol){socklen_taddr_len;intsndbuf=32768;memset
(rth,0,sizeof(*rth));rth->fd=socket(AF_NETLINK,SOCK_RAW,protocol);if(rth->fd<0){
perror("Cannotopennetlinksocket");return-1;}if(setsockopt(rth->fd,SOL_SOCKET,SO_
SNDBUF,&sndbuf,sizeof(sndbuf))<0){perror("SO_SNDBUF");return-1;}if(setsockopt(rt
h->fd,SOL_SOCKET,SO_RCVBUF,&rcvbuf,sizeof(rcvbuf))<0){perror("SO_RCVBUF");return
-1;}memset(&rth->local,0,sizeof(rth->local));rth->local.nl_family=AF_NETLINK;rth
->local.nl_groups=subscriptions;if(bind(rth->fd,(structsockaddr*)&rth->local,siz
eof(rth->local))<0){perror("Cannotbindnetlinksocket");return-1;}addr_len=sizeof(
rth->local);if(getsockname(rth->fd,(structsockaddr*)&rth->local,&addr_len)<0){pe
rror("Cannotgetsockname");return-1;}if(addr_len!=sizeof(rth->local)){fprintf(std
err,"Wrongaddresslength%d\n",addr_len);return-1;}if(rth->local.nl_family!=AF_NET
LINK){fprintf(stderr,"Wrongaddressfamily%d\n",rth->local.nl_family);return-1;}rt
h->seq=time(NULL);return0;}intrtnl_open(structrtnl_handle*rth,unsignedsubscripti
ons){returnrtnl_open_byproto(rth,subscriptions,NETLINK_ROUTE);}intrtnl_wilddump_
request(structrtnl_handle*rth,intfamily,inttype){struct{structnlmsghdrnlh;struct
rtgenmsgg;}req;memset(&req,0,sizeof(req));req.nlh.nlmsg_len=sizeof(req);req.nlh.
nlmsg_type=type;req.nlh.nlmsg_flags=NLM_F_ROOT|NLM_F_MATCH|NLM_F_REQUEST;req.nlh
.nlmsg_pid=0;req.nlh.nlmsg_seq=rth->dump=++rth->seq;req.g.rtgen_family=family;re
turnsend(rth->fd,(void*)&req,sizeof(req),0);}intrtnl_send(structrtnl_handle*rth,
constchar*buf,intlen){returnsend(rth->fd,buf,len,0);}intrtnl_send_check(structrt
nl_handle*rth,constchar*buf,intlen){structnlmsghdr*h;intstatus;charresp[1024];st
atus=send(rth->fd,buf,len,0);if(status<0)returnstatus;/*Checkforimmediateerrors*
/status=recv(rth->fd,resp,sizeof(resp),MSG_DONTWAIT|MSG_PEEK);if(status<0){if(er
rno==EAGAIN)return0;return-1;}for(h=(structnlmsghdr*)resp;NLMSG_OK(h,(uint32_t)s
tatus);h=NLMSG_NEXT(h,status)){if(h->nlmsg_type==NLMSG_ERROR){structnlmsgerr*err
=(structnlmsgerr*)NLMSG_DATA(h);if(h->nlmsg_len<NLMSG_LENGTH(sizeof(structnlmsge
rr)))fprintf(stderr,"ERRORtruncated\n");elseerrno=-err->error;return-1;}}return0
;}intrtnl_dump_request(structrtnl_handle*rth,inttype,void*req,intlen){structnlms
ghdrnlh;structsockaddr_nlnladdr;structioveciov[2]={{.iov_base=&nlh,.iov_len=size
of(nlh)},{.iov_base=req,.iov_len=len}};structmsghdrmsg={.msg_name=&nladdr,.msg_n
amelen=sizeof(nladdr),.msg_iov=iov,.msg_iovlen=2,};memset(&nladdr,0,sizeof(nladd
r));nladdr.nl_family=AF_NETLINK;nlh.nlmsg_len=NLMSG_LENGTH(len);nlh.nlmsg_type=t
ype;nlh.nlmsg_flags=NLM_F_ROOT|NLM_F_MATCH|NLM_F_REQUEST;nlh.nlmsg_pid=0;nlh.nlm
sg_seq=rth->dump=++rth->seq;returnsendmsg(rth->fd,&msg,0);}intrtnl_dump_filter_l
(structrtnl_handle*rth,conststructrtnl_dump_filter_arg*arg){structsockaddr_nlnla
ddr;structioveciov;structmsghdrmsg={.msg_name=&nladdr,.msg_namelen=sizeof(nladdr
),.msg_iov=&iov,.msg_iovlen=1,};charbuf[16384];iov.iov_base=buf;while(1){intstat
us;conststructrtnl_dump_filter_arg*a;intfound_done=0;intmsglen=0;iov.iov_len=siz
eof(buf);status=recvmsg(rth->fd,&msg,0);if(status<0){if(errno==EINTR||errno==EAG
AIN)continue;fprintf(stderr,"netlinkreceiveerror%s(%d)\n",strerror(errno),errno)
;return-1;}if(status==0){fprintf(stderr,"EOFonnetlink\n");return-1;}for(a=arg;a-
>filter;a++){structnlmsghdr*h=(structnlmsghdr*)buf;msglen=status;while(NLMSG_OK(
h,(uint32_t)msglen)){interr;if(nladdr.nl_pid!=0||h->nlmsg_pid!=rth->local.nl_pid
||h->nlmsg_seq!=rth->dump){if(a->junk){err=a->junk(&nladdr,h,a->arg2);if(err<0)r
eturnerr;}gotoskip_it;}if(h->nlmsg_type==NLMSG_DONE){found_done=1;break;/*proces
snextfilter*/}if(h->nlmsg_type==NLMSG_ERROR){structnlmsgerr*err=(structnlmsgerr*
)NLMSG_DATA(h);if(h->nlmsg_len<NLMSG_LENGTH(sizeof(structnlmsgerr))){fprintf(std
err,"ERRORtruncated\n");}else{errno=-err->error;perror("RTNETLINKanswers");}retu
rn-1;}err=a->filter(&nladdr,h,a->arg1);if(err<0)returnerr;skip_it:h=NLMSG_NEXT(h
,msglen);}}if(found_done)return0;if(msg.msg_flags&MSG_TRUNC){fprintf(stderr,"Mes
sagetruncated\n");continue;}if(msglen){fprintf(stderr,"!!!Remnantofsize%d\n",msg
len);exit(1);}}}intrtnl_dump_filter(structrtnl_handle*rth,rtnl_filter_tfilter,vo
id*arg1,rtnl_filter_tjunk,void*arg2){conststructrtnl_dump_filter_arga[2]={{.filt
er=filter,.arg1=arg1,.junk=junk,.arg2=arg2},{.filter=NULL,.arg1=NULL,.junk=NULL,
.arg2=NULL}};returnrtnl_dump_filter_l(rth,a);}intrtnl_talk(structrtnl_handle*rtn
l,structnlmsghdr*n,pid_tpeer,unsignedgroups,structnlmsghdr*answer,rtnl_filter_tj
unk,void*jarg){intstatus;unsignedseq;structnlmsghdr*h;structsockaddr_nlnladdr;st
ructioveciov={.iov_base=(void*)n,.iov_len=n->nlmsg_len};structmsghdrmsg={.msg_na
me=&nladdr,.msg_namelen=sizeof(nladdr),.msg_iov=&iov,.msg_iovlen=1,};charbuf[163
84];memset(&nladdr,0,sizeof(nladdr));nladdr.nl_family=AF_NETLINK;nladdr.nl_pid=p
eer;nladdr.nl_groups=groups;n->nlmsg_seq=seq=++rtnl->seq;if(answer==NULL)n->nlms
g_flags|=NLM_F_ACK;status=sendmsg(rtnl->fd,&msg,0);if(status<0){perror("Cannotta
lktortnetlink");return-1;}memset(buf,0,sizeof(buf));iov.iov_base=buf;while(1){io
v.iov_len=sizeof(buf);status=recvmsg(rtnl->fd,&msg,0);if(status<0){if(errno==EIN
TR||errno==EAGAIN)continue;fprintf(stderr,"netlinkreceiveerror%s(%d)\n",strerror
(errno),errno);return-1;}if(status==0){fprintf(stderr,"EOFonnetlink\n");return-1
;}if(msg.msg_namelen!=sizeof(nladdr)){fprintf(stderr,"senderaddresslength==%d\n"
,msg.msg_namelen);exit(1);}for(h=(structnlmsghdr*)buf;status>=(int)sizeof(*h);){
interr;intlen=h->nlmsg_len;intl=len-sizeof(*h);if(l<0||len>status){if(msg.msg_fl
ags&MSG_TRUNC){fprintf(stderr,"Truncatedmessage\n");return-1;}fprintf(stderr,"!!
!malformedmessage:len=%d\n",len);exit(1);}if((int)nladdr.nl_pid!=peer||h->nlmsg_
pid!=rtnl->local.nl_pid||h->nlmsg_seq!=seq){if(junk){err=junk(&nladdr,h,jarg);if
(err<0)returnerr;}/*Don'tforgettoskipthatmessage.*/status-=NLMSG_ALIGN(len);h=(s
tructnlmsghdr*)((char*)h+NLMSG_ALIGN(len));continue;}if(h->nlmsg_type==NLMSG_ERR
OR){structnlmsgerr*err=(structnlmsgerr*)NLMSG_DATA(h);if(l<(int)sizeof(structnlm
sgerr)){fprintf(stderr,"ERRORtruncated\n");}else{errno=-err->error;if(errno==0){
if(answer)memcpy(answer,h,h->nlmsg_len);return0;}perror("RTNETLINKanswers");}ret
urn-1;}if(answer){memcpy(answer,h,h->nlmsg_len);return0;}fprintf(stderr,"Unexpec
tedreply!!!\n");status-=NLMSG_ALIGN(len);h=(structnlmsghdr*)((char*)h+NLMSG_ALIG
N(len));}if(msg.msg_flags&MSG_TRUNC){fprintf(stderr,"Messagetruncated\n");contin
ue;}if(status){fprintf(stderr,"!!!Remnantofsize%d\n",status);exit(1);}}}intrtnl_
listen(structrtnl_handle*rtnl,rtnl_filter_thandler,void*jarg){intstatus;structnl
msghdr*h;structsockaddr_nlnladdr;structioveciov;structmsghdrmsg={.msg_name=&nlad
dr,.msg_namelen=sizeof(nladdr),.msg_iov=&iov,.msg_iovlen=1,};charbuf[8192];memse
t(&nladdr,0,sizeof(nladdr));nladdr.nl_family=AF_NETLINK;nladdr.nl_pid=0;nladdr.n
l_groups=0;iov.iov_base=buf;while(1){iov.iov_len=sizeof(buf);status=recvmsg(rtnl
->fd,&msg,0);if(status<0){if(errno==EINTR||errno==EAGAIN)continue;fprintf(stderr
,"netlinkreceiveerror%s(%d)\n",strerror(errno),errno);if(errno==ENOBUFS)continue
;return-1;}if(status==0){fprintf(stderr,"EOFonnetlink\n");return-1;}if(msg.msg_n
amelen!=sizeof(nladdr)){fprintf(stderr,"Senderaddresslength==%d\n",msg.msg_namel
en);exit(1);}for(h=(structnlmsghdr*)buf;status>=(int)sizeof(*h);){interr;intlen=
h->nlmsg_len;intl=len-sizeof(*h);if(l<0||len>status){if(msg.msg_flags&MSG_TRUNC)
{fprintf(stderr,"Truncatedmessage\n");return-1;}fprintf(stderr,"!!!malformedmess
age:len=%d\n",len);exit(1);}err=handler(&nladdr,h,jarg);if(err<0)returnerr;statu
s-=NLMSG_ALIGN(len);h=(structnlmsghdr*)((char*)h+NLMSG_ALIGN(len));}if(msg.msg_f
lags&MSG_TRUNC){fprintf(stderr,"Messagetruncated\n");continue;}if(status){fprint
f(stderr,"!!!Remnantofsize%d\n",status);exit(1);}}}intrtnl_from_file(FILE*rtnl,r
tnl_filter_thandler,void*jarg){intstatus;structsockaddr_nlnladdr;charbuf[8192];s
tructnlmsghdr*h=(void*)buf;memset(&nladdr,0,sizeof(nladdr));nladdr.nl_family=AF_
NETLINK;nladdr.nl_pid=0;nladdr.nl_groups=0;while(1){interr,len;intl;status=fread
(&buf,1,sizeof(*h),rtnl);if(status<0){if(errno==EINTR)continue;perror("rtnl_from
_file:fread");return-1;}if(status==0)return0;len=h->nlmsg_len;l=len-sizeof(*h);i
f(l<0||len>(int)sizeof(buf)){fprintf(stderr,"!!!malformedmessage:len=%d@%lu\n",l
en,ftell(rtnl));return-1;}status=fread(NLMSG_DATA(h),1,NLMSG_ALIGN(l),rtnl);if(s
tatus<0){perror("rtnl_from_file:fread");return-1;}if(status<l){fprintf(stderr,"r
tnl-from_file:truncatedmessage\n");return-1;}err=handler(&nladdr,h,jarg);if(err<
0)returnerr;}}intaddattr32(structnlmsghdr*n,intmaxlen,inttype,__u32data){intlen=
RTA_LENGTH(4);structrtattr*rta;if((int)(NLMSG_ALIGN(n->nlmsg_len)+len)>maxlen){f
printf(stderr,"addattr32:Error!maxallowedbound%dexceeded\n",maxlen);return-1;}rt
a=NLMSG_TAIL(n);rta->rta_type=type;rta->rta_len=len;memcpy(RTA_DATA(rta),&data,4
);n->nlmsg_len=NLMSG_ALIGN(n->nlmsg_len)+len;return0;}intaddattr_l(structnlmsghd
r*n,intmaxlen,inttype,constvoid*data,intalen){intlen=RTA_LENGTH(alen);structrtat
tr*rta;if((int)(NLMSG_ALIGN(n->nlmsg_len)+RTA_ALIGN(len))>maxlen){fprintf(stderr
,"addattr_lERROR:messageexceededboundof%d\n",maxlen);return-1;}rta=NLMSG_TAIL(n)
;rta->rta_type=type;rta->rta_len=len;if(data)memcpy(RTA_DATA(rta),data,alen);els
eassert(alen==0);n->nlmsg_len=NLMSG_ALIGN(n->nlmsg_len)+RTA_ALIGN(len);return0;}
intaddraw_l(structnlmsghdr*n,intmaxlen,constvoid*data,intlen){if((int)(NLMSG_ALI
GN(n->nlmsg_len)+NLMSG_ALIGN(len))>maxlen){fprintf(stderr,"addraw_lERROR:message
exceededboundof%d\n",maxlen);return-1;}memcpy(NLMSG_TAIL(n),data,len);memset((ui
nt8_t*)NLMSG_TAIL(n)+len,0,NLMSG_ALIGN(len)-len);n->nlmsg_len=NLMSG_ALIGN(n->nlm
sg_len)+NLMSG_ALIGN(len);return0;}structrtattr*addattr_nest(structnlmsghdr*n,int
maxlen,inttype){structrtattr*nest=NLMSG_TAIL(n);addattr_l(n,maxlen,type,NULL,0);
returnnest;}intaddattr_nest_end(structnlmsghdr*n,structrtattr*nest){nest->rta_le
n=(uint8_t*)NLMSG_TAIL(n)-(uint8_t*)nest;returnn->nlmsg_len;}structrtattr*addatt
r_nest_compat(structnlmsghdr*n,intmaxlen,inttype,constvoid*data,intlen){structrt
attr*start=NLMSG_TAIL(n);addattr_l(n,maxlen,type,data,len);addattr_nest(n,maxlen
,type);returnstart;}intaddattr_nest_compat_end(structnlmsghdr*n,structrtattr*sta
rt){structrtattr*nest=start+NLMSG_ALIGN(start->rta_len);start->rta_len=(uint8_t*
)NLMSG_TAIL(n)-(uint8_t*)start;addattr_nest_end(n,nest);returnn->nlmsg_len;}intr
ta_addattr32(structrtattr*rta,intmaxlen,inttype,__u32data){intlen=RTA_LENGTH(4);
structrtattr*subrta;if((int)(RTA_ALIGN(rta->rta_len)+len)>maxlen){fprintf(stderr
,"rta_addattr32:Error!maxallowedbound%dexceeded\n",maxlen);return-1;}subrta=(str
uctrtattr*)(((char*)rta)+RTA_ALIGN(rta->rta_len));subrta->rta_type=type;subrta->
rta_len=len;memcpy(RTA_DATA(subrta),&data,4);rta->rta_len=NLMSG_ALIGN(rta->rta_l
en)+len;return0;}intrta_addattr_l(structrtattr*rta,intmaxlen,inttype,constvoid*d
ata,intalen){structrtattr*subrta;intlen=RTA_LENGTH(alen);if((int)(RTA_ALIGN(rta-
>rta_len)+RTA_ALIGN(len))>maxlen){fprintf(stderr,"rta_addattr_l:Error!maxallowed
bound%dexceeded\n",maxlen);return-1;}subrta=(structrtattr*)(((char*)rta)+RTA_ALI
GN(rta->rta_len));subrta->rta_type=type;subrta->rta_len=len;memcpy(RTA_DATA(subr
ta),data,alen);rta->rta_len=NLMSG_ALIGN(rta->rta_len)+RTA_ALIGN(len);return0;}in
tparse_rtattr(structrtattr*tb[],intmax,structrtattr*rta,intlen){memset(tb,0,size
of(structrtattr*)*(max+1));while(RTA_OK(rta,len)){if((rta->rta_type<=max)&&(!tb[
rta->rta_type]))tb[rta->rta_type]=rta;rta=RTA_NEXT(rta,len);}if(len)fprintf(stde
rr,"!!!Deficit%d,rta_len=%d\n",len,rta->rta_len);return0;}intparse_rtattr_byinde
x(structrtattr*tb[],intmax,structrtattr*rta,intlen){inti=0;memset(tb,0,sizeof(st
ructrtattr*)*max);while(RTA_OK(rta,len)){if(rta->rta_type<=max&&i<max)tb[i++]=rt
a;rta=RTA_NEXT(rta,len);}if(len)fprintf(stderr,"!!!Deficit%d,rta_len=%d\n",len,r
ta->rta_len);returni;}int__parse_rtattr_nested_compat(structrtattr*tb[],intmax,s
tructrtattr*rta,intlen){if((int)RTA_PAYLOAD(rta)<len)return-1;if(RTA_PAYLOAD(rta
)>=RTA_ALIGN(len)+sizeof(structrtattr)){rta=(structrtattr*)(uint8_t*)RTA_DATA(rt
a)+RTA_ALIGN(len);returnparse_rtattr_nested(tb,max,rta);}memset(tb,0,sizeof(stru
ctrtattr*)*(max+1));return0;}#endif/*__linux__*/