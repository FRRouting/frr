/**IPMSDPsocketmanagement*Copyright(C)2016CumulusNetworks,Inc.**Thisprogramisfre
esoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicL
icenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(aty
ouroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,
but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSF
ORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhav
ereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYIN
G;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA
02110-1301USA*/#include<zebra.h>#include<lib/log.h>#include<lib/network.h>#inclu
de<lib/sockunion.h>#include<lib/thread.h>#include<lib/vty.h>#include<lib/if.h>#i
nclude<lib/vrf.h>#include"pimd.h"#include"pim_sock.h"#include"pim_msdp.h"#includ
e"pim_msdp_socket.h"/*increasesocketsendbuffersize*/staticvoidpim_msdp_update_so
ck_send_buffer_size(intfd){intsize=PIM_MSDP_SOCKET_SNDBUF_SIZE;intoptval;socklen
_toptlen=sizeof(optval);if(getsockopt(fd,SOL_SOCKET,SO_SNDBUF,&optval,&optlen)<0
){zlog_err("getsockoptofSO_SNDBUFfailed%s\n",safe_strerror(errno));return;}if(op
tval<size){if(setsockopt(fd,SOL_SOCKET,SO_SNDBUF,&size,sizeof(size))<0){zlog_err
("Couldn'tincreasesendbuffer:%s\n",safe_strerror(errno));}}}/*passivepeersocketa
ccept*/staticintpim_msdp_sock_accept(structthread*thread){unionsockunionsu;struc
tpim_instance*pim=THREAD_ARG(thread);intaccept_sock;intmsdp_sock;structpim_msdp_
peer*mp;charbuf[SU_ADDRSTRLEN];sockunion_init(&su);/*re-registeracceptthread*/ac
cept_sock=THREAD_FD(thread);if(accept_sock<0){zlog_err("accept_sockisnegativeval
ue%d",accept_sock);return-1;}pim->msdp.listener.thread=NULL;thread_add_read(mast
er,pim_msdp_sock_accept,pim,accept_sock,&pim->msdp.listener.thread);/*acceptclie
ntconnection.*/msdp_sock=sockunion_accept(accept_sock,&su);if(msdp_sock<0){zlog_
err("pim_msdp_sock_acceptfailed(%s)",safe_strerror(errno));return-1;}/*seeifhave
peerconfigforthis*/mp=pim_msdp_peer_find(pim,su.sin.sin_addr);if(!mp||!PIM_MSDP_
PEER_IS_LISTENER(mp)){++pim->msdp.rejected_accepts;if(PIM_DEBUG_MSDP_EVENTS){zlo
g_err("msdppeerconnectionrefusedfrom%s",sockunion2str(&su,buf,SU_ADDRSTRLEN));}c
lose(msdp_sock);return-1;}if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%sacce
ptsuccess%s",mp->key_str,mp->fd>=0?"(dup)":"");}/*ifwehaveanexistingconnectionwe
needtokillthatone*withthisone*/if(mp->fd>=0){if(PIM_DEBUG_MSDP_EVENTS){zlog_err(
"msdppeernewconnectionfrom%sstopoldconnection",sockunion2str(&su,buf,SU_ADDRSTRL
EN));}pim_msdp_peer_stop_tcp_conn(mp,true/*chg_state*/);}mp->fd=msdp_sock;set_no
nblocking(mp->fd);pim_msdp_update_sock_send_buffer_size(mp->fd);pim_msdp_peer_es
tablished(mp);return0;}/*globallistenerfortheMSDPwellknowTCPport*/intpim_msdp_so
ck_listen(structpim_instance*pim){intsock;intsocklen;structsockaddr_insin;intrc;
structpim_msdp_listener*listener=&pim->msdp.listener;if(pim->msdp.flags&PIM_MSDP
F_LISTENER){/*listeneralreadysetup*/return0;}sock=socket(AF_INET,SOCK_STREAM,0);
if(sock<0){zlog_err("socket:%s",safe_strerror(errno));returnsock;}memset(&sin,0,
sizeof(structsockaddr_in));sin.sin_family=AF_INET;sin.sin_port=htons(PIM_MSDP_TC
P_PORT);socklen=sizeof(structsockaddr_in);#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENs
in.sin_len=socklen;#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*/sockopt_reuseaddr(so
ck);sockopt_reuseport(sock);if(pim->vrf_id!=VRF_DEFAULT){structinterface*ifp=if_
lookup_by_name(pim->vrf->name,pim->vrf_id);if(!ifp){zlog_err("%s:Unabletolookupv
rfinterface:%s",__PRETTY_FUNCTION__,pim->vrf->name);close(sock);return-1;}if(pim
_socket_bind(sock,ifp)){zlog_err("%s:Unabletobindtosocket:%s",__PRETTY_FUNCTION_
_,safe_strerror(errno));close(sock);return-1;}}if(pimd_privs.change(ZPRIVS_RAISE
)){zlog_err("pim_msdp_socket:couldnotraiseprivs,%s",safe_strerror(errno));}/*bin
dtowellknownTCPport*/rc=bind(sock,(structsockaddr*)&sin,socklen);if(pimd_privs.c
hange(ZPRIVS_LOWER)){zlog_err("pim_msdp_socket:couldnotlowerprivs,%s",safe_strer
ror(errno));}if(rc<0){zlog_err("pim_msdp_socketbindtoport%d:%s",ntohs(sin.sin_po
rt),safe_strerror(errno));close(sock);returnrc;}rc=listen(sock,3/*backlog*/);if(
rc<0){zlog_err("pim_msdp_socketlisten:%s",safe_strerror(errno));close(sock);retu
rnrc;}/*addacceptthread*/listener->fd=sock;memcpy(&listener->su,&sin,socklen);li
stener->thread=NULL;thread_add_read(pim->msdp.master,pim_msdp_sock_accept,pim,so
ck,&listener->thread);pim->msdp.flags|=PIM_MSDPF_LISTENER;return0;}/*activepeers
ocketsetup*/intpim_msdp_sock_connect(structpim_msdp_peer*mp){intrc;if(PIM_DEBUG_
MSDP_INTERNAL){zlog_debug("MSDPpeer%sattemptconnect%s",mp->key_str,mp->fd<0?"":"
(dup)");}/*ifwehaveanexistingconnectionweneedtokillthatone*withthisone*/if(mp->f
d>=0){if(PIM_DEBUG_MSDP_EVENTS){zlog_err("msdpduplicateconnectto%snukeoldconnect
ion",mp->key_str);}pim_msdp_peer_stop_tcp_conn(mp,false/*chg_state*/);}/*Makesoc
ketforthepeer.*/mp->fd=sockunion_socket(&mp->su_peer);if(mp->fd<0){zlog_err("pim
_msdp_socketsocketfailure:%s",safe_strerror(errno));return-1;}if(mp->pim->vrf_id
!=VRF_DEFAULT){structinterface*ifp=if_lookup_by_name(mp->pim->vrf->name,mp->pim-
>vrf_id);if(!ifp){zlog_err("%s:Unabletolookupvrfinterface:%s",__PRETTY_FUNCTION_
_,mp->pim->vrf->name);return-1;}if(pim_socket_bind(mp->fd,ifp)){zlog_err("%s:Una
bletobindtosocket:%s",__PRETTY_FUNCTION__,safe_strerror(errno));close(mp->fd);mp
->fd=-1;return-1;}}set_nonblocking(mp->fd);/*Setsocketsendbuffersize*/pim_msdp_u
pdate_sock_send_buffer_size(mp->fd);sockopt_reuseaddr(mp->fd);sockopt_reuseport(
mp->fd);/*sourcebind*/rc=sockunion_bind(mp->fd,&mp->su_local,0,&mp->su_local);if
(rc<0){zlog_err("pim_msdp_socketconnectbindfailure:%s",safe_strerror(errno));clo
se(mp->fd);mp->fd=-1;returnrc;}/*Connecttotheremotemp.*/return(sockunion_connect
(mp->fd,&mp->su_peer,htons(PIM_MSDP_TCP_PORT),0));}