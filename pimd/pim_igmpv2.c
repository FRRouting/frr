/**PIMforQuagga*Copyright(C)2016CumulusNetworks,Inc.*DanielWalton**Thisprogramis
freesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPubl
icLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(
atyouroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeusef
ul,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNE
SSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshould
havereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOP
YING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston
,MA02110-1301USA*/#include"zebra.h"#include"pimd.h"#include"pim_igmp.h"#include"
pim_igmpv2.h"#include"pim_igmpv3.h"#include"pim_str.h"#include"pim_time.h"#inclu
de"pim_util.h"staticvoidon_trace(constchar*label,structinterface*ifp,structin_ad
drfrom){if(PIM_DEBUG_IGMP_TRACE){charfrom_str[INET_ADDRSTRLEN];pim_inet4_dump("<
from?>",from,from_str,sizeof(from_str));zlog_debug("%s:from%son%s",label,from_st
r,ifp->name);}}voidigmp_v2_send_query(structigmp_group*group,intfd,constchar*ifn
ame,char*query_buf,structin_addrdst_addr,structin_addrgroup_addr,intquery_max_re
sponse_time_dsec){ssize_tmsg_size=8;uint8_tmax_resp_code;ssize_tsent;structsocka
ddr_into;socklen_ttolen;uint16_tchecksum;/*max_resp_codemustbenon-zeroelsethiswi
lllooklikeanIGMPv1*query*/max_resp_code=igmp_msg_encode16to8(query_max_response_
time_dsec);zassert(max_resp_code>0);query_buf[0]=PIM_IGMP_MEMBERSHIP_QUERY;query
_buf[1]=max_resp_code;*(uint16_t*)(query_buf+IGMP_CHECKSUM_OFFSET)=0;/*forcomput
ingchecksum*/memcpy(query_buf+4,&group_addr,sizeof(structin_addr));checksum=in_c
ksum(query_buf,msg_size);*(uint16_t*)(query_buf+IGMP_CHECKSUM_OFFSET)=checksum;i
f(PIM_DEBUG_IGMP_PACKETS){chardst_str[INET_ADDRSTRLEN];chargroup_str[INET_ADDRST
RLEN];pim_inet4_dump("<dst?>",dst_addr,dst_str,sizeof(dst_str));pim_inet4_dump("
<group?>",group_addr,group_str,sizeof(group_str));zlog_debug("SendIGMPv2QUERYto%
son%sforgroup%s",dst_str,ifname,group_str);}memset(&to,0,sizeof(to));to.sin_fami
ly=AF_INET;to.sin_addr=dst_addr;tolen=sizeof(to);sent=sendto(fd,query_buf,msg_si
ze,MSG_DONTWAIT,(structsockaddr*)&to,tolen);if(sent!=(ssize_t)msg_size){chardst_
str[INET_ADDRSTRLEN];chargroup_str[INET_ADDRSTRLEN];pim_inet4_dump("<dst?>",dst_
addr,dst_str,sizeof(dst_str));pim_inet4_dump("<group?>",group_addr,group_str,siz
eof(group_str));if(sent<0){zlog_warn("SendIGMPv2QUERYfaileddueto%son%s:group=%sm
sg_size=%zd:errno=%d:%s",dst_str,ifname,group_str,msg_size,errno,safe_strerror(e
rrno));}else{zlog_warn("SendIGMPv2QUERYfaileddueto%son%s:group=%smsg_size=%zd:se
nt=%zd",dst_str,ifname,group_str,msg_size,sent);}return;}}intigmp_v2_recv_report
(structigmp_sock*igmp,structin_addrfrom,constchar*from_str,char*igmp_msg,intigmp
_msg_len){structinterface*ifp=igmp->interface;structin_addrgroup_addr;chargroup_
str[INET_ADDRSTRLEN];on_trace(__PRETTY_FUNCTION__,igmp->interface,from);if(igmp-
>mtrace_only)return0;if(igmp_msg_len!=IGMP_V12_MSG_SIZE){zlog_warn("RecvIGMPv2RE
PORTfrom%son%s:size=%dotherthancorrect=%d",from_str,ifp->name,igmp_msg_len,IGMP_
V12_MSG_SIZE);return-1;}memcpy(&group_addr,igmp_msg+4,sizeof(structin_addr));if(
PIM_DEBUG_IGMP_PACKETS){pim_inet4_dump("<dst?>",group_addr,group_str,sizeof(grou
p_str));zlog_debug("RecvIGMPv2REPORTfrom%son%sfor%s",from_str,ifp->name,group_st
r);}/**RFC3376*7.3.2.InthePresenceofOlderVersionGroupMembers**WhenGroupCompatibi
lityModeisIGMPv2,arouterinternally*translatesthefollowingIGMPv2messagesforthatgr
ouptotheir*IGMPv3equivalents:**IGMPv2MessageIGMPv3Equivalent*-------------------
------------*ReportIS_EX({})*LeaveTO_IN({})*/igmpv3_report_isex(igmp,from,group_
addr,0,NULL,1);return0;}intigmp_v2_recv_leave(structigmp_sock*igmp,structin_addr
from,constchar*from_str,char*igmp_msg,intigmp_msg_len){structinterface*ifp=igmp-
>interface;structin_addrgroup_addr;chargroup_str[INET_ADDRSTRLEN];on_trace(__PRE
TTY_FUNCTION__,igmp->interface,from);if(igmp->mtrace_only)return0;if(igmp_msg_le
n!=IGMP_V12_MSG_SIZE){zlog_warn("RecvIGMPv2LEAVEfrom%son%s:size=%dotherthancorre
ct=%d",from_str,ifp->name,igmp_msg_len,IGMP_V12_MSG_SIZE);return-1;}memcpy(&grou
p_addr,igmp_msg+4,sizeof(structin_addr));if(PIM_DEBUG_IGMP_PACKETS){pim_inet4_du
mp("<dst?>",group_addr,group_str,sizeof(group_str));zlog_debug("RecvIGMPv2LEAVEf
rom%son%sfor%s",from_str,ifp->name,group_str);}/**RFC3376*7.3.2.InthePresenceofO
lderVersionGroupMembers**WhenGroupCompatibilityModeisIGMPv2,arouterinternally*tr
anslatesthefollowingIGMPv2messagesforthatgrouptotheir*IGMPv3equivalents:**IGMPv2
MessageIGMPv3Equivalent*-------------------------------*ReportIS_EX({})*LeaveTO_
IN({})*/igmpv3_report_toin(igmp,from,group_addr,0,NULL);return0;}