/**MulticastTracerouteforFRRouting*Copyright(C)2018MladenSablic**Thisprogramisfr
eesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublic
Licenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(at
youroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful
,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESS
FORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldha
vereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYI
NG;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,M
A02110-1301USA*/#ifdef__linux__#include<asm/types.h>#include<linux/netlink.h>#in
clude<linux/rtnetlink.h>#include<sys/types.h>#include<stdio.h>#include<arpa/inet
.h>#include<string.h>#include"mtracebis_netlink.h"#include"mtracebis_routeget.h"
staticintfind_dst(structnlmsghdr*n,structin_addr*src,structin_addr*gw){structrtm
sg*r=NLMSG_DATA(n);intlen=n->nlmsg_len;structrtattr*tb[RTA_MAX+1];len-=NLMSG_LEN
GTH(sizeof(*r));if(len<0){fprintf(stderr,"BUG:wrongnlmsglen%d\n",len);return-1;}
parse_rtattr(tb,RTA_MAX,RTM_RTA(r),len);if(tb[RTA_PREFSRC])src->s_addr=*(uint32_
t*)RTA_DATA(tb[RTA_PREFSRC]);if(tb[RTA_GATEWAY])gw->s_addr=*(uint32_t*)RTA_DATA(
tb[RTA_GATEWAY]);if(tb[RTA_OIF])return*(int*)RTA_DATA(tb[RTA_OIF]);return0;}intr
outeget(structin_addrdst,structin_addr*src,structin_addr*gw){struct{structnlmsgh
drn;structrtmsgr;charbuf[1024];}req;intret;structrtnl_handlerth={.fd=-1};memset(
&req,0,sizeof(req));req.n.nlmsg_len=NLMSG_LENGTH(sizeof(structrtmsg));req.n.nlms
g_flags=NLM_F_REQUEST;req.n.nlmsg_type=RTM_GETROUTE;req.r.rtm_family=AF_INET;req
.r.rtm_table=0;req.r.rtm_protocol=0;req.r.rtm_scope=0;req.r.rtm_type=0;req.r.rtm
_src_len=0;req.r.rtm_dst_len=0;req.r.rtm_tos=0;addattr_l(&req.n,sizeof(req),RTA_
DST,&dst.s_addr,4);req.r.rtm_dst_len=32;ret=rtnl_open(&rth,0);if(ret<0)returnret
;if(rtnl_talk(&rth,&req.n,0,0,&req.n,NULL,NULL)<0){ret=-1;gotoclose_rth;}ret=fin
d_dst(&req.n,src,gw);close_rth:rtnl_close(&rth);returnret;}#endif/*__linux__*/