/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"prefix.h"#include"if.h"#include"v
ty.h"#include"plist.h"#include"pimd.h"#include"pim_str.h"#include"pim_tlv.h"#inc
lude"pim_msg.h"#include"pim_pim.h"#include"pim_join.h"#include"pim_oil.h"#includ
e"pim_iface.h"#include"pim_hello.h"#include"pim_ifchannel.h"#include"pim_rpf.h"#
include"pim_rp.h"#include"pim_jp_agg.h"#include"pim_util.h"staticvoidon_trace(co
nstchar*label,structinterface*ifp,structin_addrsrc){if(PIM_DEBUG_PIM_TRACE){char
src_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",src,src_str,sizeof(src_str));zl
og_debug("%s:from%son%s",label,src_str,ifp->name);}}staticvoidrecv_join(structin
terface*ifp,structpim_neighbor*neigh,uint16_tholdtime,structin_addrupstream,stru
ctprefix_sg*sg,uint8_tsource_flags){structpim_interface*pim_ifp=NULL;if(PIM_DEBU
G_PIM_TRACE){charup_str[INET_ADDRSTRLEN];charneigh_str[INET_ADDRSTRLEN];pim_inet
4_dump("<upstream?>",upstream,up_str,sizeof(up_str));pim_inet4_dump("<neigh?>",n
eigh->source_addr,neigh_str,sizeof(neigh_str));zlog_warn("%s:join(S,G)=%srpt=%dw
c=%dupstream=%sholdtime=%dfrom%son%s",__PRETTY_FUNCTION__,pim_str_sg_dump(sg),!!
(source_flags&PIM_RPT_BIT_MASK),!!(source_flags&PIM_WILDCARD_BIT_MASK),up_str,ho
ldtime,neigh_str,ifp->name);}pim_ifp=ifp->info;zassert(pim_ifp);++pim_ifp->pim_i
fstat_join_recv;/**IftheRPTandWCaresetit'sa(*,G)*andthesourceistheRP*/if((source
_flags&PIM_RPT_BIT_MASK)&&(source_flags&PIM_WILDCARD_BIT_MASK)){structpim_rpf*rp
=RP(pim_ifp->pim,sg->grp);/**IftheRPsentinthemessageisnot*ourRPforthegroup,dropt
hemessage*/if(sg->src.s_addr!=rp->rpf_addr.u.prefix4.s_addr){charreceived_rp[INE
T_ADDRSTRLEN];charlocal_rp[INET_ADDRSTRLEN];pim_inet4_dump("<received?>",sg->src
,received_rp,sizeof(received_rp));pim_inet4_dump("<local?>",rp->rpf_addr.u.prefi
x4,local_rp,sizeof(local_rp));if(PIM_DEBUG_PIM_TRACE)zlog_warn("%s:SpecifiedRP(%
s)injoinisdifferentthanourconfiguredRP(%s)",__PRETTY_FUNCTION__,received_rp,loca
l_rp);return;}sg->src.s_addr=INADDR_ANY;}/*Restartjoinexpirytimer*/pim_ifchannel
_join_add(ifp,neigh->source_addr,upstream,sg,source_flags,holdtime);}staticvoidr
ecv_prune(structinterface*ifp,structpim_neighbor*neigh,uint16_tholdtime,structin
_addrupstream,structprefix_sg*sg,uint8_tsource_flags){structpim_interface*pim_if
p=NULL;if(PIM_DEBUG_PIM_TRACE){charup_str[INET_ADDRSTRLEN];charneigh_str[INET_AD
DRSTRLEN];pim_inet4_dump("<upstream?>",upstream,up_str,sizeof(up_str));pim_inet4
_dump("<neigh?>",neigh->source_addr,neigh_str,sizeof(neigh_str));zlog_warn("%s:p
rune(S,G)=%srpt=%dwc=%dupstream=%sholdtime=%dfrom%son%s",__PRETTY_FUNCTION__,pim
_str_sg_dump(sg),source_flags&PIM_RPT_BIT_MASK,source_flags&PIM_WILDCARD_BIT_MAS
K,up_str,holdtime,neigh_str,ifp->name);}pim_ifp=ifp->info;zassert(pim_ifp);++pim
_ifp->pim_ifstat_prune_recv;if((source_flags&PIM_RPT_BIT_MASK)&&(source_flags&PI
M_WILDCARD_BIT_MASK)){structpim_rpf*rp=RP(pim_ifp->pim,sg->grp);//IgnoringPrune*
,G'satthemoment.if(sg->src.s_addr!=rp->rpf_addr.u.prefix4.s_addr)return;sg->src.
s_addr=INADDR_ANY;}pim_ifchannel_prune(ifp,upstream,sg,source_flags,holdtime);}i
ntpim_joinprune_recv(structinterface*ifp,structpim_neighbor*neigh,structin_addrs
rc_addr,uint8_t*tlv_buf,inttlv_buf_size){structprefixmsg_upstream_addr;structpim
_interface*pim_ifp;uint8_tmsg_num_groups;uint16_tmsg_holdtime;intaddr_offset;uin
t8_t*buf;uint8_t*pastend;intremain;intgroup;buf=tlv_buf;pastend=tlv_buf+tlv_buf_
size;pim_ifp=ifp->info;/*Parseucastaddr*/addr_offset=pim_parse_addr_ucast(&msg_u
pstream_addr,buf,pastend-buf);if(addr_offset<1){charsrc_str[INET_ADDRSTRLEN];pim
_inet4_dump("<src?>",src_addr,src_str,sizeof(src_str));zlog_warn("%s:pim_parse_a
ddr_ucast()failure:from%son%s",__PRETTY_FUNCTION__,src_str,ifp->name);return-1;}
buf+=addr_offset;/*Checkupstreamaddressfamily*/if(msg_upstream_addr.family!=AF_I
NET){if(PIM_DEBUG_PIM_J_P){charsrc_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",
src_addr,src_str,sizeof(src_str));zlog_warn("%s:ignoringjoin/prunedirectedtounex
pectedaddrfamily=%dfrom%son%s",__PRETTY_FUNCTION__,msg_upstream_addr.family,src_
str,ifp->name);}return-2;}remain=pastend-buf;if(remain<4){charsrc_str[INET_ADDRS
TRLEN];pim_inet4_dump("<src?>",src_addr,src_str,sizeof(src_str));zlog_warn("%s:s
hortjoin/prunemessagebufferforgrouplist:size=%dminimum=%dfrom%son%s",__PRETTY_FU
NCTION__,remain,4,src_str,ifp->name);return-4;}++buf;/*skipreservedbyte*/msg_num
_groups=*(constuint8_t*)buf;++buf;msg_holdtime=ntohs(*(constuint16_t*)buf);++buf
;++buf;if(PIM_DEBUG_PIM_J_P){charsrc_str[INET_ADDRSTRLEN];charupstream_str[INET_
ADDRSTRLEN];pim_inet4_dump("<src?>",src_addr,src_str,sizeof(src_str));pim_inet4_
dump("<addr?>",msg_upstream_addr.u.prefix4,upstream_str,sizeof(upstream_str));zl
og_debug("%s:join/pruneupstream=%sgroups=%dholdtime=%dfrom%son%s",__PRETTY_FUNCT
ION__,upstream_str,msg_num_groups,msg_holdtime,src_str,ifp->name);}/*Scangroups*
/for(group=0;group<msg_num_groups;++group){structprefix_sgsg;uint8_tmsg_source_f
lags;uint16_tmsg_num_joined_sources;uint16_tmsg_num_pruned_sources;intsource;str
uctpim_ifchannel*starg_ch=NULL,*sg_ch=NULL;boolfiltered=false;memset(&sg,0,sizeo
f(structprefix_sg));addr_offset=pim_parse_addr_group(&sg,buf,pastend-buf);if(add
r_offset<1){return-5;}buf+=addr_offset;remain=pastend-buf;if(remain<4){charsrc_s
tr[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",src_addr,src_str,sizeof(src_str));zl
og_warn("%s:shortjoin/prunebufferforsourcelist:size=%dminimum=%dfrom%son%s",__PR
ETTY_FUNCTION__,remain,4,src_str,ifp->name);return-6;}msg_num_joined_sources=nto
hs(*(constuint16_t*)buf);buf+=2;msg_num_pruned_sources=ntohs(*(constuint16_t*)bu
f);buf+=2;if(PIM_DEBUG_PIM_J_P){charsrc_str[INET_ADDRSTRLEN];charupstream_str[IN
ET_ADDRSTRLEN];chargroup_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",src_addr,s
rc_str,sizeof(src_str));pim_inet4_dump("<addr?>",msg_upstream_addr.u.prefix4,ups
tream_str,sizeof(upstream_str));pim_inet4_dump("<grp?>",sg.grp,group_str,sizeof(
group_str));zlog_warn("%s:join/pruneupstream=%sgroup=%s/32join_src=%dprune_src=%
dfrom%son%s",__PRETTY_FUNCTION__,upstream_str,group_str,msg_num_joined_sources,m
sg_num_pruned_sources,src_str,ifp->name);}/*boundarycheck*/filtered=pim_is_group
_filtered(pim_ifp,&sg.grp);/*Scanjoinedsources*/for(source=0;source<msg_num_join
ed_sources;++source){addr_offset=pim_parse_addr_source(&sg,&msg_source_flags,buf
,pastend-buf);if(addr_offset<1){return-7;}buf+=addr_offset;/*ifwearefilteringthi
sgroup,skipthejoin*/if(filtered)continue;recv_join(ifp,neigh,msg_holdtime,msg_up
stream_addr.u.prefix4,&sg,msg_source_flags);if(sg.src.s_addr==INADDR_ANY){starg_
ch=pim_ifchannel_find(ifp,&sg);if(starg_ch)pim_ifchannel_set_star_g_join_state(s
targ_ch,0,1);}}/*Scanprunedsources*/for(source=0;source<msg_num_pruned_sources;+
+source){addr_offset=pim_parse_addr_source(&sg,&msg_source_flags,buf,pastend-buf
);if(addr_offset<1){return-8;}buf+=addr_offset;/*ifwearefilteringthisgroup,skipt
heprune*/if(filtered)continue;recv_prune(ifp,neigh,msg_holdtime,msg_upstream_add
r.u.prefix4,&sg,msg_source_flags);/**SoifwearereceivingaS,G,RPTprune*beforewehav
eanydataforthatS,G*Weneedtoretrievethesg_chafter*weparsetheprune.*/sg_ch=pim_ifc
hannel_find(ifp,&sg);/*ReceivedSG-RPTPrunedeleteoiffromspecificS,G*/if(starg_ch&
&sg_ch&&(msg_source_flags&PIM_RPT_BIT_MASK)&&!(msg_source_flags&PIM_WILDCARD_BIT
_MASK)){structpim_upstream*up=sg_ch->upstream;PIM_IF_FLAG_SET_S_G_RPT(sg_ch->fla
gs);if(up){if(PIM_DEBUG_TRACE)zlog_debug("%s:SGRptflagisset,delinheritoiffromup%
s",__PRETTY_FUNCTION__,up->sg_str);pim_channel_del_oif(up->channel_oil,starg_ch-
>interface,PIM_OIF_FLAG_PROTO_STAR);}}}if(starg_ch&&!filtered)pim_ifchannel_set_
star_g_join_state(starg_ch,1,0);starg_ch=NULL;}/*scangroups*/return0;}/**J/PMess
ageFormat**WhiletheRFCclearlystatesthatthisis32bitswide,it*ischeating.Thesefield
s:*Encoded-Unicastformat(6bytesMIN)*Encoded-Groupformat(8bytesMIN)*Encoded-Sourc
eformat(8bytesMIN)*are*not*32bitswide.**NordoestheRFCexplicitlycalloutthesizefor
:*Reserved(1byte)*NumGroups(1byte)*Holdtime(2bytes)*NumberofJoinedSources(2bytes
)*NumberofPrunedSources(2bytes)**Thisleadstoamissleadingrepresentationfromcasual
*readingandmakingassumptions.Becareful!**0123*01234567890123456789012345678901*+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|PIMVer|Type|Re
served|Checksum|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
-+*|UpstreamNeighborAddress(Encoded-Unicastformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|Reserved|Numgroups|Holdtime|*+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|MulticastGroupAddress1(En
coded-Groupformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+*|NumberofJoinedSources|NumberofPrunedSources|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|JoinedSourceAddress1(Encoded-Sourceformat
)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|.|*|.|*+-+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|JoinedSourceAddr
essn(Encoded-Sourceformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+-+-+-+-+*|PrunedSourceAddress1(Encoded-Sourceformat)|*+-+-+-+-+-+-+-+-+-+-+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|.|*|.|*+-+-+-+-+-+-+-+-+-+-+-+-+-+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|PrunedSourceAddressn(Encoded-Sourceforma
t)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|Multicast
GroupAddressm(Encoded-Groupformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+*|NumberofJoinedSources|NumberofPrunedSources|*+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|JoinedSourceAddress1(Enco
ded-Sourceformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
-+-+*|.|*|.|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|
JoinedSourceAddressn(Encoded-Sourceformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|PrunedSourceAddress1(Encoded-Sourceformat)|*+-+-+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|.|*|.|*+-+-+-+-+-+
-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+*|PrunedSourceAddressn(Enc
oded-Sourceformat)|*+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-+-+*/intpim_joinprune_send(structpim_rpf*rpf,structlist*groups){structpim_jp_a
gg_group*group;structpim_interface*pim_ifp=NULL;structpim_jp_groups*grp=NULL;str
uctpim_jp*msg=NULL;structlistnode*node,*nnode;uint8_tpim_msg[10000];uint8_t*curr
_ptr=pim_msg;boolnew_packet=true;size_tpacket_left=0;size_tpacket_size=0;size_tg
roup_size=0;on_trace(__PRETTY_FUNCTION__,rpf->source_nexthop.interface,rpf->rpf_
addr.u.prefix4);if(rpf->source_nexthop.interface)pim_ifp=rpf->source_nexthop.int
erface->info;else{zlog_warn("%s:RPFinterfaceisnotpresent",__PRETTY_FUNCTION__);r
eturn-1;}if(!pim_ifp){zlog_warn("%s:multicastnotenabledoninterface%s",__PRETTY_F
UNCTION__,rpf->source_nexthop.interface->name);return-1;}if(PIM_INADDR_IS_ANY(rp
f->rpf_addr.u.prefix4)){if(PIM_DEBUG_PIM_J_P){chardst_str[INET_ADDRSTRLEN];pim_i
net4_dump("<dst?>",rpf->rpf_addr.u.prefix4,dst_str,sizeof(dst_str));zlog_debug("
%s:upstream=%sismyselfoninterface%s",__PRETTY_FUNCTION__,dst_str,rpf->source_nex
thop.interface->name);}return0;}/*RFC4601:4.3.1.SendingHelloMessagesThus,ifarout
erneedstosendaJoin/PruneorAssertmessageonaninterfaceonwhichithasnotyetsentaHello
messagewiththecurrentlyconfiguredIPaddress,thenitMUSTimmediatelysendtherelevantH
ellomessagewithoutwaitingfortheHelloTimertoexpire,followedbytheJoin/PruneorAsser
tmessage.*/pim_hello_require(rpf->source_nexthop.interface);for(ALL_LIST_ELEMENT
S(groups,node,nnode,group)){if(new_packet){msg=(structpim_jp*)pim_msg;memset(msg
,0,sizeof(*msg));pim_msg_addr_encode_ipv4_ucast((uint8_t*)&msg->addr,rpf->rpf_ad
dr.u.prefix4);msg->reserved=0;msg->holdtime=htons(PIM_JP_HOLDTIME);new_packet=fa
lse;grp=&msg->groups[0];curr_ptr=(uint8_t*)grp;packet_size=sizeof(structpim_msg_
header);packet_size+=sizeof(structpim_encoded_ipv4_unicast);packet_size+=4;//res
erved(1)+groups(1)+holdtime(2)packet_left=rpf->source_nexthop.interface->mtu-24;
packet_left-=packet_size;}if(PIM_DEBUG_PIM_J_P){chardst_str[INET_ADDRSTRLEN];cha
rgrp_str[INET_ADDRSTRLEN];pim_inet4_dump("<dst?>",rpf->rpf_addr.u.prefix4,dst_st
r,sizeof(dst_str));pim_inet4_dump("<grp?>",group->group,grp_str,sizeof(grp_str))
;zlog_debug("%s:sending(G)=%stoupstream=%soninterface%s",__PRETTY_FUNCTION__,grp
_str,dst_str,rpf->source_nexthop.interface->name);}group_size=pim_msg_get_jp_gro
up_size(group->sources);if(group_size>packet_left){pim_msg_build_header(pim_msg,
packet_size,PIM_MSG_TYPE_JOIN_PRUNE);if(pim_msg_send(pim_ifp->pim_sock_fd,pim_if
p->primary_address,qpim_all_pim_routers_addr,pim_msg,packet_size,rpf->source_nex
thop.interface->name)){zlog_warn("%s:couldnotsendPIMmessageoninterface%s",__PRET
TY_FUNCTION__,rpf->source_nexthop.interface->name);}msg=(structpim_jp*)pim_msg;m
emset(msg,0,sizeof(*msg));pim_msg_addr_encode_ipv4_ucast((uint8_t*)&msg->addr,rp
f->rpf_addr.u.prefix4);msg->reserved=0;msg->holdtime=htons(PIM_JP_HOLDTIME);new_
packet=false;grp=&msg->groups[0];curr_ptr=(uint8_t*)grp;packet_size=sizeof(struc
tpim_msg_header);packet_size+=sizeof(structpim_encoded_ipv4_unicast);packet_size
+=4;//reserved(1)+groups(1)+holdtime(2)packet_left=rpf->source_nexthop.interface
->mtu-24;packet_left-=packet_size;}msg->num_groups++;/*BuildPIMmessage*/curr_ptr
+=group_size;packet_left-=group_size;packet_size+=group_size;pim_msg_build_jp_gr
oups(grp,group,group_size);pim_ifp->pim_ifstat_join_send+=ntohs(grp->joins);pim_
ifp->pim_ifstat_prune_send+=ntohs(grp->prunes);if(PIM_DEBUG_PIM_TRACE)zlog_debug
("%s:interface%snum_joins%unum_prunes%u",__PRETTY_FUNCTION__,rpf->source_nexthop
.interface->name,ntohs(grp->joins),ntohs(grp->prunes));grp=(structpim_jp_groups*
)curr_ptr;if(packet_left<sizeof(structpim_jp_groups)||msg->num_groups==255){pim_
msg_build_header(pim_msg,packet_size,PIM_MSG_TYPE_JOIN_PRUNE);if(pim_msg_send(pi
m_ifp->pim_sock_fd,pim_ifp->primary_address,qpim_all_pim_routers_addr,pim_msg,pa
cket_size,rpf->source_nexthop.interface->name)){zlog_warn("%s:couldnotsendPIMmes
sageoninterface%s",__PRETTY_FUNCTION__,rpf->source_nexthop.interface->name);}new
_packet=true;}}if(!new_packet){//msg->num_groups=htons(msg->num_groups);pim_msg_
build_header(pim_msg,packet_size,PIM_MSG_TYPE_JOIN_PRUNE);if(pim_msg_send(pim_if
p->pim_sock_fd,pim_ifp->primary_address,qpim_all_pim_routers_addr,pim_msg,packet
_size,rpf->source_nexthop.interface->name)){zlog_warn("%s:couldnotsendPIMmessage
oninterface%s",__PRETTY_FUNCTION__,rpf->source_nexthop.interface->name);}}return
0;}