/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include<sys/types.h>#include<sys/socket.h>#include<netin
et/in.h>#include<netinet/igmp.h>#include<arpa/inet.h>#include<unistd.h>#include<
netdb.h>#include<errno.h>#include"log.h"#include"privs.h"#include"if.h"#include"
vrf.h"#include"sockopt.h"#include"pimd.h"#include"pim_mroute.h"#include"pim_sock
.h"#include"pim_str.h"#include"pim_igmp_join.h"/*GLOBALVARS*/intpim_socket_raw(i
ntprotocol){intfd;if(pimd_privs.change(ZPRIVS_RAISE))zlog_err("pim_sockek_raw:co
uldnotraiseprivs,%s",safe_strerror(errno));fd=socket(AF_INET,SOCK_RAW,protocol);
if(pimd_privs.change(ZPRIVS_LOWER))zlog_err("pim_socket_raw:couldnotlowerprivs,%
s",safe_strerror(errno));if(fd<0){zlog_warn("Couldnotcreaterawsocket:errno=%d:%s
",errno,safe_strerror(errno));returnPIM_SOCK_ERR_SOCKET;}returnfd;}voidpim_socke
t_ip_hdr(intfd){constinton=1;if(pimd_privs.change(ZPRIVS_RAISE))zlog_err("%s:cou
ldnotraiseprivs,%s",__PRETTY_FUNCTION__,safe_strerror(errno));if(setsockopt(fd,I
PPROTO_IP,IP_HDRINCL,&on,sizeof(on)))zlog_err("%s:CouldnotturnonIP_HDRINCLoption
:%s",__PRETTY_FUNCTION__,safe_strerror(errno));if(pimd_privs.change(ZPRIVS_LOWER
))zlog_err("%s:couldnotlowerprivs,%s",__PRETTY_FUNCTION__,safe_strerror(errno));
}/**Givenasocketandainterface,*Bindthatsockettothatinterface*/intpim_socket_bind
(intfd,structinterface*ifp){intret=0;#ifdefSO_BINDTODEVICEif(pimd_privs.change(Z
PRIVS_RAISE))zlog_err("%s:couldnotraiseprivs,%s",__PRETTY_FUNCTION__,safe_strerr
or(errno));ret=setsockopt(fd,SOL_SOCKET,SO_BINDTODEVICE,ifp->name,strlen(ifp->na
me));if(pimd_privs.change(ZPRIVS_LOWER))zlog_err("%s:couldnotlowerprivs,%s",__PR
ETTY_FUNCTION__,safe_strerror(errno));#endifreturnret;}intpim_socket_mcast(intpr
otocol,structin_addrifaddr,structinterface*ifp,uint8_tloop){intrcvbuf=1024*1024*
8;#ifdefHAVE_STRUCT_IP_MREQN_IMR_IFINDEXstructip_mreqnmreq;#elsestructip_mreqmre
q;#endifintfd;fd=pim_socket_raw(protocol);if(fd<0){zlog_warn("Couldnotcreatemult
icastsocket:errno=%d:%s",errno,safe_strerror(errno));returnPIM_SOCK_ERR_SOCKET;}
#ifdefSO_BINDTODEVICEif(protocol==IPPROTO_PIM){intret;ret=pim_socket_bind(fd,ifp
);if(ret){close(fd);zlog_warn("Couldnotsetfd:%dforinterface:%stodevice",fd,ifp->
name);returnPIM_SOCK_ERR_BIND;}}#else/*XXX:useIP_PKTINFO/IP_RECVIFtoemulatebehav
iour?Orchangeto*onlyuse1socketforallinterfaces?*/#endif/*Neededtoobtaindestinati
onaddressfromrecvmsg()*/{#ifdefined(HAVE_IP_PKTINFO)/*LinuxandSolarisIP_PKTINFO*
/intopt=1;if(setsockopt(fd,IPPROTO_IP,IP_PKTINFO,&opt,sizeof(opt))){zlog_warn("C
ouldnotsetIP_PKTINFOonsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(errno));}#
elifdefined(HAVE_IP_RECVDSTADDR)/*BSDIP_RECVDSTADDR*/intopt=1;if(setsockopt(fd,I
PPROTO_IP,IP_RECVDSTADDR,&opt,sizeof(opt))){zlog_warn("CouldnotsetIP_RECVDSTADDR
onsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(errno));}#elsezlog_err("%s%s:M
issingIP_PKTINFOandIP_RECVDSTADDR:unabletogetdstaddrfromrecvmsg()",__FILE__,__PR
ETTY_FUNCTION__);close(fd);returnPIM_SOCK_ERR_DSTADDR;#endif}/*Setrouteralert(RF
C2113)forallIGMPmessages(RFC33764.*MessageFormats)*/if(protocol==IPPROTO_IGMP){u
int8_tra[4];ra[0]=148;ra[1]=4;ra[2]=0;ra[3]=0;if(setsockopt(fd,IPPROTO_IP,IP_OPT
IONS,ra,4)){zlog_warn("CouldnotsetRouterAlertOptiononsocketfd=%d:errno=%d:%s",fd
,errno,safe_strerror(errno));close(fd);returnPIM_SOCK_ERR_RA;}}{intreuse=1;if(se
tsockopt(fd,SOL_SOCKET,SO_REUSEADDR,(void*)&reuse,sizeof(reuse))){zlog_warn("Cou
ldnotsetReuseAddressOptiononsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(errn
o));close(fd);returnPIM_SOCK_ERR_REUSE;}}{constintMTTL=1;intttl=MTTL;if(setsocko
pt(fd,IPPROTO_IP,IP_MULTICAST_TTL,(void*)&ttl,sizeof(ttl))){zlog_warn("Couldnots
etmulticastTTL=%donsocketfd=%d:errno=%d:%s",MTTL,fd,errno,safe_strerror(errno));
close(fd);returnPIM_SOCK_ERR_TTL;}}if(setsockopt_ipv4_multicast_loop(fd,loop)){z
log_warn("Couldnot%sMulticastLoopbackOptiononsocketfd=%d:errno=%d:%s",loop?"enab
le":"disable",fd,errno,safe_strerror(errno));close(fd);returnPIM_SOCK_ERR_LOOP;}
memset(&mreq,0,sizeof(mreq));#ifdefHAVE_STRUCT_IP_MREQN_IMR_IFINDEXmreq.imr_ifin
dex=ifp->ifindex;#else/**Iamnotsurewhattodohereyetfor*BSD*///mreq.imr_interface=
ifindex;#endifif(setsockopt(fd,IPPROTO_IP,IP_MULTICAST_IF,(void*)&mreq,sizeof(mr
eq))){zlog_warn("CouldnotsetOutgoingInterfaceOptiononsocketfd=%d:errno=%d:%s",fd
,errno,safe_strerror(errno));close(fd);returnPIM_SOCK_ERR_IFACE;}if(setsockopt(f
d,SOL_SOCKET,SO_RCVBUF,&rcvbuf,sizeof(rcvbuf)))zlog_warn("%s:Failuretosetbuffers
izeto%d",__PRETTY_FUNCTION__,rcvbuf);{longflags;flags=fcntl(fd,F_GETFL,0);if(fla
gs<0){zlog_warn("Couldnotgetfcntl(F_GETFL,O_NONBLOCK)onsocketfd=%d:errno=%d:%s",
fd,errno,safe_strerror(errno));close(fd);returnPIM_SOCK_ERR_NONBLOCK_GETFL;}if(f
cntl(fd,F_SETFL,flags|O_NONBLOCK)){zlog_warn("Couldnotsetfcntl(F_SETFL,O_NONBLOC
K)onsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(errno));close(fd);returnPIM_
SOCK_ERR_NONBLOCK_SETFL;}}returnfd;}intpim_socket_join(intfd,structin_addrgroup,
structin_addrifaddr,ifindex_tifindex){intret;#ifdefHAVE_STRUCT_IP_MREQN_IMR_IFIN
DEXstructip_mreqnopt;#elsestructip_mreqopt;#endifopt.imr_multiaddr=group;#ifdefH
AVE_STRUCT_IP_MREQN_IMR_IFINDEXopt.imr_address=ifaddr;opt.imr_ifindex=ifindex;#e
lseopt.imr_interface=ifaddr;#endifret=setsockopt(fd,IPPROTO_IP,IP_ADD_MEMBERSHIP
,&opt,sizeof(opt));if(ret){chargroup_str[INET_ADDRSTRLEN];charifaddr_str[INET_AD
DRSTRLEN];if(!inet_ntop(AF_INET,&group,group_str,sizeof(group_str)))sprintf(grou
p_str,"<group?>");if(!inet_ntop(AF_INET,&ifaddr,ifaddr_str,sizeof(ifaddr_str)))s
printf(ifaddr_str,"<ifaddr?>");zlog_err("Failuresocketjoiningfd=%dgroup%soninter
faceaddress%s:errno=%d:%s",fd,group_str,ifaddr_str,errno,safe_strerror(errno));r
eturnret;}if(PIM_DEBUG_TRACE){chargroup_str[INET_ADDRSTRLEN];charifaddr_str[INET
_ADDRSTRLEN];if(!inet_ntop(AF_INET,&group,group_str,sizeof(group_str)))sprintf(g
roup_str,"<group?>");if(!inet_ntop(AF_INET,&ifaddr,ifaddr_str,sizeof(ifaddr_str)
))sprintf(ifaddr_str,"<ifaddr?>");zlog_debug("Socketfd=%djoinedgroup%soninterfac
eaddress%s",fd,group_str,ifaddr_str);}returnret;}intpim_socket_join_source(intfd
,ifindex_tifindex,structin_addrgroup_addr,structin_addrsource_addr,constchar*ifn
ame){if(pim_igmp_join_source(fd,ifindex,group_addr,source_addr)){chargroup_str[I
NET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];pim_inet4_dump("<grp?>",group_ad
dr,group_str,sizeof(group_str));pim_inet4_dump("<src?>",source_addr,source_str,s
izeof(source_str));zlog_warn("%s:setsockopt(fd=%d)failureforIGMPgroup%ssource%si
findex%doninterface%s:errno=%d:%s",__PRETTY_FUNCTION__,fd,group_str,source_str,i
findex,ifname,errno,safe_strerror(errno));return-1;}return0;}intpim_socket_recvf
romto(intfd,uint8_t*buf,size_tlen,structsockaddr_in*from,socklen_t*fromlen,struc
tsockaddr_in*to,socklen_t*tolen,ifindex_t*ifindex){structmsghdrmsgh;structcmsghd
r*cmsg;structioveciov;charcbuf[1000];interr;/**IP_PKTINFO/IP_RECVDSTADDRdon'tyie
ldsin_port.*Usegetsockname()togetsin_port.*/if(to){structsockaddr_insi;socklen_t
si_len=sizeof(si);memset(&si,0,sizeof(si));to->sin_family=AF_INET;pim_socket_get
sockname(fd,(structsockaddr*)&si,&si_len);to->sin_port=si.sin_port;to->sin_addr=
si.sin_addr;if(tolen)*tolen=sizeof(si);}memset(&msgh,0,sizeof(structmsghdr));iov
.iov_base=buf;iov.iov_len=len;msgh.msg_control=cbuf;msgh.msg_controllen=sizeof(c
buf);msgh.msg_name=from;msgh.msg_namelen=fromlen?*fromlen:0;msgh.msg_iov=&iov;ms
gh.msg_iovlen=1;msgh.msg_flags=0;err=recvmsg(fd,&msgh,0);if(err<0)returnerr;if(f
romlen)*fromlen=msgh.msg_namelen;for(cmsg=CMSG_FIRSTHDR(&msgh);cmsg!=NULL;cmsg=C
MSG_NXTHDR(&msgh,cmsg)){#ifdefHAVE_IP_PKTINFOif((cmsg->cmsg_level==IPPROTO_IP)&&
(cmsg->cmsg_type==IP_PKTINFO)){structin_pktinfo*i=(structin_pktinfo*)CMSG_DATA(c
msg);if(to)((structsockaddr_in*)to)->sin_addr=i->ipi_addr;if(tolen)*tolen=sizeof
(structsockaddr_in);if(ifindex)*ifindex=i->ipi_ifindex;break;}#endif#ifdefHAVE_I
P_RECVDSTADDRif((cmsg->cmsg_level==IPPROTO_IP)&&(cmsg->cmsg_type==IP_RECVDSTADDR
)){structin_addr*i=(structin_addr*)CMSG_DATA(cmsg);if(to)((structsockaddr_in*)to
)->sin_addr=*i;if(tolen)*tolen=sizeof(structsockaddr_in);break;}#endif#ifdefined
(HAVE_IP_RECVIF)&&defined(CMSG_IFINDEX)if(cmsg->cmsg_type==IP_RECVIF)if(ifindex)
*ifindex=CMSG_IFINDEX(cmsg);#endif}/*for(cmsg)*/returnerr;/*len*/}intpim_socket_
mcastloop_get(intfd){intloop;socklen_tloop_len=sizeof(loop);if(getsockopt(fd,IPP
ROTO_IP,IP_MULTICAST_LOOP,&loop,&loop_len)){inte=errno;zlog_warn("CouldnotgetMul
ticastLoopbackOptiononsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(errno));er
rno=e;returnPIM_SOCK_ERR_LOOP;}returnloop;}intpim_socket_getsockname(intfd,struc
tsockaddr*name,socklen_t*namelen){if(getsockname(fd,name,namelen)){inte=errno;zl
og_warn("CouldnotgetSocketNameforsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror
(errno));errno=e;returnPIM_SOCK_ERR_NAME;}returnPIM_SOCK_ERR_NONE;}