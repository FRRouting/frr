/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"prefix.h"#include"plist.h"#includ
e"pim_util.h"/*RFC3376:4.1.7.QQIC(Querier'sQueryIntervalCode)IfQQIC<128,QQI=QQIC
IfQQIC>=128,QQI=(mant|0x10)<<(exp+3)01234567+-+-+-+-+-+-+-+-+|1|exp|mant|+-+-+-+
-+-+-+-+-+Sinceexp=0..7then(exp+3)=3..10,thenQQIhasoneofthefollowingbitpatterns:
exp=0:QQI=0000.0000.1MMM.M000exp=1:QQI=0000.0001.MMMM.0000...exp=6:QQI=001M.MMM0
.0000.0000exp=7:QQI=01MM.MM00.0000.0000------------------0x40x00x00x0*/uint8_tig
mp_msg_encode16to8(uint16_tvalue){uint8_tcode;if(value<128){code=value;}else{uin
t16_tmask=0x4000;uint8_texp;uint16_tmant;for(exp=7;exp>0;--exp){if(mask&value)br
eak;mask>>=1;}mant=0x000F&(value>>(exp+3));code=((uint8_t)1<<7)|((uint8_t)exp<<4
)|(uint8_t)mant;}returncode;}/*RFC3376:4.1.7.QQIC(Querier'sQueryIntervalCode)IfQ
QIC<128,QQI=QQICIfQQIC>=128,QQI=(mant|0x10)<<(exp+3)01234567+-+-+-+-+-+-+-+-+|1|
exp|mant|+-+-+-+-+-+-+-+-+*/uint16_tigmp_msg_decode8to16(uint8_tcode){uint16_tva
lue;if(code<128){value=code;}else{uint16_tmant=(code&0x0F);uint8_texp=(code&0x70
)>>4;value=(mant|0x10)<<(exp+3);}returnvalue;}voidpim_pkt_dump(constchar*label,c
onstuint8_t*buf,intsize){zlog_debug("%s:pktdumpsize=%d",label,size);zlog_hexdump
(buf,size);}intpim_is_group_224_0_0_0_24(structin_addrgroup_addr){staticintfirst
=1;staticstructprefixgroup_224;structprefixgroup;if(first){if(!str2prefix("224.0
.0.0/24",&group_224))return0;first=0;}group.family=AF_INET;group.u.prefix4=group
_addr;group.prefixlen=IPV4_MAX_PREFIXLEN;returnprefix_match(&group_224,&group);}
intpim_is_group_224_4(structin_addrgroup_addr){staticintfirst=1;staticstructpref
ixgroup_all;structprefixgroup;if(first){if(!str2prefix("224.0.0.0/4",&group_all)
)return0;first=0;}group.family=AF_INET;group.u.prefix4=group_addr;group.prefixle
n=32;returnprefix_match(&group_all,&group);}boolpim_is_group_filtered(structpim_
interface*pim_ifp,structin_addr*grp){structprefixgrp_pfx;structprefix_list*pl;if
(!pim_ifp->boundary_oil_plist)returnfalse;grp_pfx.family=AF_INET;grp_pfx.prefixl
en=32;grp_pfx.u.prefix4=*grp;pl=prefix_list_lookup(AFI_IP,pim_ifp->boundary_oil_
plist);returnpl?prefix_list_apply(pl,&grp_pfx)==PREFIX_DENY:false;}