/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"lib/json.h"#include"command.h"#include"if.h"#inc
lude"prefix.h"#include"zclient.h"#include"plist.h"#include"hash.h"#include"nexth
op.h"#include"vrf.h"#include"ferr.h"#include"pimd.h"#include"pim_mroute.h"#inclu
de"pim_cmd.h"#include"pim_iface.h"#include"pim_vty.h"#include"pim_mroute.h"#incl
ude"pim_str.h"#include"pim_igmp.h"#include"pim_igmpv3.h"#include"pim_sock.h"#inc
lude"pim_time.h"#include"pim_util.h"#include"pim_oil.h"#include"pim_neighbor.h"#
include"pim_pim.h"#include"pim_ifchannel.h"#include"pim_hello.h"#include"pim_msg
.h"#include"pim_upstream.h"#include"pim_rpf.h"#include"pim_macro.h"#include"pim_
ssmpingd.h"#include"pim_zebra.h"#include"pim_static.h"#include"pim_rp.h"#include
"pim_zlookup.h"#include"pim_msdp.h"#include"pim_ssm.h"#include"pim_nht.h"#includ
e"pim_bfd.h"#include"bfd.h"staticstructcmd_nodeinterface_node={INTERFACE_NODE,"%
s(config-if)#",1/*vtysh?yes*/};staticstructcmd_nodedebug_node={DEBUG_NODE,"",1};
staticstructvrf*pim_cmd_lookup_vrf(structvty*vty,structcmd_token*argv[],constint
argc,int*idx){structvrf*vrf;if(argv_find(argv,argc,"NAME",idx))vrf=vrf_lookup_by
_name(argv[*idx]->arg);elsevrf=vrf_lookup_by_id(VRF_DEFAULT);if(!vrf)vty_out(vty
,"SpecifiedVRF:%sdoesnotexist\n",argv[*idx]->arg);returnvrf;}staticvoidpim_if_me
mbership_clear(structinterface*ifp){structpim_interface*pim_ifp;pim_ifp=ifp->inf
o;zassert(pim_ifp);if(PIM_IF_TEST_PIM(pim_ifp->options)&&PIM_IF_TEST_IGMP(pim_if
p->options)){return;}pim_ifchannel_membership_clear(ifp);}/*WhenPIMisdisabledoni
nterface,IGMPv3localmembershipinformationisnotinjectedintoPIMinterfacestate.Thef
unctionpim_if_membership_refresh()fetchesallIGMPv3localmembershipinformationinto
PIM.ItisintentedtobecalledwheneverPIMisenabledontheinterfaceinordertocollectmiss
edlocalmembershipinformation.*/staticvoidpim_if_membership_refresh(structinterfa
ce*ifp){structpim_interface*pim_ifp;structlistnode*sock_node;structigmp_sock*igm
p;pim_ifp=ifp->info;zassert(pim_ifp);if(!PIM_IF_TEST_PIM(pim_ifp->options))retur
n;if(!PIM_IF_TEST_IGMP(pim_ifp->options))return;/*Firstclearoffmembershipfromall
PIM(S,G)entriesontheinterface*/pim_ifchannel_membership_clear(ifp);/*Thenrestore
PIM(S,G)membershipfromallIGMPv3(S,G)entriesontheinterface*//*scanigmpsockets*/fo
r(ALL_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,sock_node,igmp)){structlistnode
*grpnode;structigmp_group*grp;/*scanigmpgroups*/for(ALL_LIST_ELEMENTS_RO(igmp->i
gmp_group_list,grpnode,grp)){structlistnode*srcnode;structigmp_source*src;/*scan
groupsources*/for(ALL_LIST_ELEMENTS_RO(grp->group_source_list,srcnode,src)){if(I
GMP_SOURCE_TEST_FORWARDING(src->source_flags)){structprefix_sgsg;memset(&sg,0,si
zeof(structprefix_sg));sg.src=src->source_addr;sg.grp=grp->group_addr;pim_ifchan
nel_local_membership_add(ifp,&sg);}}/*scangroupsources*/}/*scanigmpgroups*/}/*sc
anigmpsockets*//*FinallydeleteeveryPIM(S,G)entrylackingallstateinfo*/pim_ifchann
el_delete_on_noinfo(ifp);}staticvoidpim_show_assert_helper(structvty*vty,structp
im_interface*pim_ifp,structpim_ifchannel*ch,time_tnow){charch_src_str[INET_ADDRS
TRLEN];charch_grp_str[INET_ADDRSTRLEN];charwinner_str[INET_ADDRSTRLEN];structin_
addrifaddr;charuptime[10];chartimer[10];ifaddr=pim_ifp->primary_address;pim_inet
4_dump("<ch_src?>",ch->sg.src,ch_src_str,sizeof(ch_src_str));pim_inet4_dump("<ch
_grp?>",ch->sg.grp,ch_grp_str,sizeof(ch_grp_str));pim_inet4_dump("<assrt_win?>",
ch->ifassert_winner,winner_str,sizeof(winner_str));pim_time_uptime(uptime,sizeof
(uptime),now-ch->ifassert_creation);pim_time_timer_to_mmss(timer,sizeof(timer),c
h->t_ifassert_timer);vty_out(vty,"%-9s%-15s%-15s%-15s%-6s%-15s%-8s%-5s\n",ch->in
terface->name,inet_ntoa(ifaddr),ch_src_str,ch_grp_str,pim_ifchannel_ifassert_nam
e(ch->ifassert_state),winner_str,uptime,timer);}staticvoidpim_show_assert(struct
pim_instance*pim,structvty*vty){structpim_interface*pim_ifp;structpim_ifchannel*
ch;structinterface*ifp;time_tnow;now=pim_time_monotonic_sec();vty_out(vty,"Inter
faceAddressSourceGroupStateWinnerUptimeTimer\n");FOR_ALL_INTERFACES(pim->vrf,ifp
){pim_ifp=ifp->info;if(!pim_ifp)continue;RB_FOREACH(ch,pim_ifchannel_rb,&pim_ifp
->ifchannel_rb){pim_show_assert_helper(vty,pim_ifp,ch,now);}/*scaninterfacechann
els*/}}staticvoidpim_show_assert_internal_helper(structvty*vty,structpim_interfa
ce*pim_ifp,structpim_ifchannel*ch){charch_src_str[INET_ADDRSTRLEN];charch_grp_st
r[INET_ADDRSTRLEN];structin_addrifaddr;ifaddr=pim_ifp->primary_address;pim_inet4
_dump("<ch_src?>",ch->sg.src,ch_src_str,sizeof(ch_src_str));pim_inet4_dump("<ch_
grp?>",ch->sg.grp,ch_grp_str,sizeof(ch_grp_str));vty_out(vty,"%-9s%-15s%-15s%-15
s%-3s%-3s%-3s%-4s\n",ch->interface->name,inet_ntoa(ifaddr),ch_src_str,ch_grp_str
,PIM_IF_FLAG_TEST_COULD_ASSERT(ch->flags)?"yes":"no",pim_macro_ch_could_assert_e
val(ch)?"yes":"no",PIM_IF_FLAG_TEST_ASSERT_TRACKING_DESIRED(ch->flags)?"yes":"no
",pim_macro_assert_tracking_desired_eval(ch)?"yes":"no");}staticvoidpim_show_ass
ert_internal(structpim_instance*pim,structvty*vty){structpim_interface*pim_ifp;s
tructpim_ifchannel*ch;structinterface*ifp;vty_out(vty,"CA:CouldAssert\n""ECA:Eva
luateCouldAssert\n""ATD:AssertTrackingDesired\n""eATD:EvaluateAssertTrackingDesi
red\n\n");vty_out(vty,"InterfaceAddressSourceGroupCAeCAATDeATD\n");FOR_ALL_INTER
FACES(pim->vrf,ifp){pim_ifp=ifp->info;if(!pim_ifp)continue;RB_FOREACH(ch,pim_ifc
hannel_rb,&pim_ifp->ifchannel_rb){pim_show_assert_internal_helper(vty,pim_ifp,ch
);}/*scaninterfacechannels*/}}staticvoidpim_show_assert_metric_helper(structvty*
vty,structpim_interface*pim_ifp,structpim_ifchannel*ch){charch_src_str[INET_ADDR
STRLEN];charch_grp_str[INET_ADDRSTRLEN];charaddr_str[INET_ADDRSTRLEN];structpim_
assert_metricam;structin_addrifaddr;ifaddr=pim_ifp->primary_address;am=pim_macro
_spt_assert_metric(&ch->upstream->rpf,pim_ifp->primary_address);pim_inet4_dump("
<ch_src?>",ch->sg.src,ch_src_str,sizeof(ch_src_str));pim_inet4_dump("<ch_grp?>",
ch->sg.grp,ch_grp_str,sizeof(ch_grp_str));pim_inet4_dump("<addr?>",am.ip_address
,addr_str,sizeof(addr_str));vty_out(vty,"%-9s%-15s%-15s%-15s%-3s%4u%6u%-15s\n",c
h->interface->name,inet_ntoa(ifaddr),ch_src_str,ch_grp_str,am.rpt_bit_flag?"yes"
:"no",am.metric_preference,am.route_metric,addr_str);}staticvoidpim_show_assert_
metric(structpim_instance*pim,structvty*vty){structpim_interface*pim_ifp;structp
im_ifchannel*ch;structinterface*ifp;vty_out(vty,"InterfaceAddressSourceGroupRPTP
refMetricAddress\n");FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->info;if(!pim_
ifp)continue;RB_FOREACH(ch,pim_ifchannel_rb,&pim_ifp->ifchannel_rb){pim_show_ass
ert_metric_helper(vty,pim_ifp,ch);}/*scaninterfacechannels*/}}staticvoidpim_show
_assert_winner_metric_helper(structvty*vty,structpim_interface*pim_ifp,structpim
_ifchannel*ch){charch_src_str[INET_ADDRSTRLEN];charch_grp_str[INET_ADDRSTRLEN];c
haraddr_str[INET_ADDRSTRLEN];structpim_assert_metric*am;structin_addrifaddr;char
pref_str[5];charmetr_str[7];ifaddr=pim_ifp->primary_address;am=&ch->ifassert_win
ner_metric;pim_inet4_dump("<ch_src?>",ch->sg.src,ch_src_str,sizeof(ch_src_str));
pim_inet4_dump("<ch_grp?>",ch->sg.grp,ch_grp_str,sizeof(ch_grp_str));pim_inet4_d
ump("<addr?>",am->ip_address,addr_str,sizeof(addr_str));if(am->metric_preference
==PIM_ASSERT_METRIC_PREFERENCE_MAX)snprintf(pref_str,sizeof(pref_str),"INFI");el
sesnprintf(pref_str,sizeof(pref_str),"%4u",am->metric_preference);if(am->route_m
etric==PIM_ASSERT_ROUTE_METRIC_MAX)snprintf(metr_str,sizeof(metr_str),"INFI");el
sesnprintf(metr_str,sizeof(metr_str),"%6u",am->route_metric);vty_out(vty,"%-9s%-
15s%-15s%-15s%-3s%-4s%-6s%-15s\n",ch->interface->name,inet_ntoa(ifaddr),ch_src_s
tr,ch_grp_str,am->rpt_bit_flag?"yes":"no",pref_str,metr_str,addr_str);}staticvoi
dpim_show_assert_winner_metric(structpim_instance*pim,structvty*vty){structpim_i
nterface*pim_ifp;structpim_ifchannel*ch;structinterface*ifp;vty_out(vty,"Interfa
ceAddressSourceGroupRPTPrefMetricAddress\n");FOR_ALL_INTERFACES(pim->vrf,ifp){pi
m_ifp=ifp->info;if(!pim_ifp)continue;RB_FOREACH(ch,pim_ifchannel_rb,&pim_ifp->if
channel_rb){pim_show_assert_winner_metric_helper(vty,pim_ifp,ch);}/*scaninterfac
echannels*/}}staticvoidjson_object_pim_ifp_add(structjson_object*json,structinte
rface*ifp){structpim_interface*pim_ifp;pim_ifp=ifp->info;json_object_string_add(
json,"name",ifp->name);json_object_string_add(json,"state",if_is_up(ifp)?"up":"d
own");json_object_string_add(json,"address",inet_ntoa(pim_ifp->primary_address))
;json_object_int_add(json,"index",ifp->ifindex);if(if_is_multicast(ifp))json_obj
ect_boolean_true_add(json,"flagMulticast");if(if_is_broadcast(ifp))json_object_b
oolean_true_add(json,"flagBroadcast");if(ifp->flags&IFF_ALLMULTI)json_object_boo
lean_true_add(json,"flagAllMulticast");if(ifp->flags&IFF_PROMISC)json_object_boo
lean_true_add(json,"flagPromiscuous");if(PIM_IF_IS_DELETED(ifp))json_object_bool
ean_true_add(json,"flagDeleted");if(pim_if_lan_delay_enabled(ifp))json_object_bo
olean_true_add(json,"lanDelayEnabled");}staticvoidpim_show_membership_helper(str
uctvty*vty,structpim_interface*pim_ifp,structpim_ifchannel*ch,structjson_object*
json){charch_src_str[INET_ADDRSTRLEN];charch_grp_str[INET_ADDRSTRLEN];json_objec
t*json_iface=NULL;json_object*json_row=NULL;pim_inet4_dump("<ch_src?>",ch->sg.sr
c,ch_src_str,sizeof(ch_src_str));pim_inet4_dump("<ch_grp?>",ch->sg.grp,ch_grp_st
r,sizeof(ch_grp_str));json_object_object_get_ex(json,ch->interface->name,&json_i
face);if(!json_iface){json_iface=json_object_new_object();json_object_pim_ifp_ad
d(json_iface,ch->interface);json_object_object_add(json,ch->interface->name,json
_iface);}json_row=json_object_new_object();json_object_string_add(json_row,"sour
ce",ch_src_str);json_object_string_add(json_row,"group",ch_grp_str);json_object_
string_add(json_row,"localMembership",ch->local_ifmembership==PIM_IFMEMBERSHIP_N
OINFO?"NOINFO":"INCLUDE");json_object_object_add(json_iface,ch_grp_str,json_row)
;}staticvoidpim_show_membership(structpim_instance*pim,structvty*vty,uint8_tuj){
structpim_interface*pim_ifp;structpim_ifchannel*ch;structinterface*ifp;enumjson_
typetype;json_object*json=NULL;json_object*json_tmp=NULL;json=json_object_new_ob
ject();FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->info;if(!pim_ifp)continue;R
B_FOREACH(ch,pim_ifchannel_rb,&pim_ifp->ifchannel_rb){pim_show_membership_helper
(vty,pim_ifp,ch,json);}/*scaninterfacechannels*/}if(uj){vty_out(vty,"%s\n",json_
object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));}else{vty_out(vty,"Inte
rfaceAddressSourceGroupMembership\n");/**Exampleofthejsondatawearetraversing**{*
"swp3":{*"name":"swp3",*"state":"up",*"address":"10.1.20.1",*"index":5,*"flagMul
ticast":true,*"flagBroadcast":true,*"lanDelayEnabled":true,*"226.10.10.10":{*"so
urce":"*",*"group":"226.10.10.10",*"localMembership":"INCLUDE"*}*}*}*//*foreachi
nterface*/json_object_object_foreach(json,key,val){/*Findallofthekeyswheretheval
isanobject.In*theexample*abovetheonlyoneis226.10.10.10*/json_object_object_forea
ch(val,if_field_key,if_field_val){type=json_object_get_type(if_field_val);if(typ
e==json_type_object){vty_out(vty,"%-9s",key);json_object_object_get_ex(val,"addr
ess",&json_tmp);vty_out(vty,"%-15s",json_object_get_string(json_tmp));json_objec
t_object_get_ex(if_field_val,"source",&json_tmp);vty_out(vty,"%-15s",json_object
_get_string(json_tmp));/*Group*/vty_out(vty,"%-15s",if_field_key);json_object_ob
ject_get_ex(if_field_val,"localMembership",&json_tmp);vty_out(vty,"%-10s\n",json
_object_get_string(json_tmp));}}}}json_object_free(json);}staticvoidpim_print_if
p_flags(structvty*vty,structinterface*ifp,intmloop){vty_out(vty,"Flags\n");vty_o
ut(vty,"-----\n");vty_out(vty,"AllMulticast:%s\n",(ifp->flags&IFF_ALLMULTI)?"yes
":"no");vty_out(vty,"Broadcast:%s\n",if_is_broadcast(ifp)?"yes":"no");vty_out(vt
y,"Deleted:%s\n",PIM_IF_IS_DELETED(ifp)?"yes":"no");vty_out(vty,"InterfaceIndex:
%d\n",ifp->ifindex);vty_out(vty,"Multicast:%s\n",if_is_multicast(ifp)?"yes":"no"
);vty_out(vty,"MulticastLoop:%d\n",mloop);vty_out(vty,"Promiscuous:%s\n",(ifp->f
lags&IFF_PROMISC)?"yes":"no");vty_out(vty,"\n");vty_out(vty,"\n");}staticvoidigm
p_show_interfaces(structpim_instance*pim,structvty*vty,uint8_tuj){structinterfac
e*ifp;time_tnow;json_object*json=NULL;json_object*json_row=NULL;now=pim_time_mon
otonic_sec();if(uj)json=json_object_new_object();elsevty_out(vty,"InterfaceState
AddressVQuerierQueryTimerUptime\n");FOR_ALL_INTERFACES(pim->vrf,ifp){structpim_i
nterface*pim_ifp;structlistnode*sock_node;structigmp_sock*igmp;pim_ifp=ifp->info
;if(!pim_ifp)continue;for(ALL_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,sock_no
de,igmp)){charuptime[10];charquery_hhmmss[10];pim_time_uptime(uptime,sizeof(upti
me),now-igmp->sock_creation);pim_time_timer_to_hhmmss(query_hhmmss,sizeof(query_
hhmmss),igmp->t_igmp_query_timer);if(uj){json_row=json_object_new_object();json_
object_pim_ifp_add(json_row,ifp);json_object_string_add(json_row,"upTime",uptime
);json_object_int_add(json_row,"version",pim_ifp->igmp_version);if(igmp->t_igmp_
query_timer){json_object_boolean_true_add(json_row,"querier");json_object_string
_add(json_row,"queryTimer",query_hhmmss);}json_object_object_add(json,ifp->name,
json_row);if(igmp->mtrace_only){json_object_boolean_true_add(json_row,"mtraceOnl
y");}}else{vty_out(vty,"%-9s%5s%15s%d%7s%11s%8s\n",ifp->name,if_is_up(ifp)?(igmp
->mtrace_only?"mtrc":"up"):"down",inet_ntoa(igmp->ifaddr),pim_ifp->igmp_version,
igmp->t_igmp_query_timer?"local":"other",query_hhmmss,uptime);}}}if(uj){vty_out(
vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_ob
ject_free(json);}}staticvoidigmp_show_interfaces_single(structpim_instance*pim,s
tructvty*vty,constchar*ifname,uint8_tuj){structigmp_sock*igmp;structinterface*if
p;structlistnode*sock_node;structpim_interface*pim_ifp;charuptime[10];charquery_
hhmmss[10];charother_hhmmss[10];intfound_ifname=0;intsqi;intmloop=0;longgmi_msec
;/*GroupMembershipInterval*/longlmqt_msec;longohpi_msec;longoqpi_msec;/*OtherQue
rierPresentInterval*/longqri_msec;time_tnow;json_object*json=NULL;json_object*js
on_row=NULL;if(uj)json=json_object_new_object();now=pim_time_monotonic_sec();FOR
_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->info;if(!pim_ifp)continue;if(strcmp(i
fname,"detail")&&strcmp(ifname,ifp->name))continue;for(ALL_LIST_ELEMENTS_RO(pim_
ifp->igmp_socket_list,sock_node,igmp)){found_ifname=1;pim_time_uptime(uptime,siz
eof(uptime),now-igmp->sock_creation);pim_time_timer_to_hhmmss(query_hhmmss,sizeo
f(query_hhmmss),igmp->t_igmp_query_timer);pim_time_timer_to_hhmmss(other_hhmmss,
sizeof(other_hhmmss),igmp->t_other_querier_timer);gmi_msec=PIM_IGMP_GMI_MSEC(igm
p->querier_robustness_variable,igmp->querier_query_interval,pim_ifp->igmp_query_
max_response_time_dsec);sqi=PIM_IGMP_SQI(pim_ifp->igmp_default_query_interval);o
qpi_msec=PIM_IGMP_OQPI_MSEC(igmp->querier_robustness_variable,igmp->querier_quer
y_interval,pim_ifp->igmp_query_max_response_time_dsec);lmqt_msec=PIM_IGMP_LMQT_M
SEC(pim_ifp->igmp_query_max_response_time_dsec,igmp->querier_robustness_variable
);ohpi_msec=PIM_IGMP_OHPI_DSEC(igmp->querier_robustness_variable,igmp->querier_q
uery_interval,pim_ifp->igmp_query_max_response_time_dsec)*100;qri_msec=pim_ifp->
igmp_query_max_response_time_dsec*100;if(pim_ifp->pim_sock_fd>=0)mloop=pim_socke
t_mcastloop_get(pim_ifp->pim_sock_fd);elsemloop=0;if(uj){json_row=json_object_ne
w_object();json_object_pim_ifp_add(json_row,ifp);json_object_string_add(json_row
,"upTime",uptime);json_object_string_add(json_row,"querier",igmp->t_igmp_query_t
imer?"local":"other");json_object_int_add(json_row,"queryStartCount",igmp->start
up_query_count);json_object_string_add(json_row,"queryQueryTimer",query_hhmmss);
json_object_string_add(json_row,"queryOtherTimer",other_hhmmss);json_object_int_
add(json_row,"version",pim_ifp->igmp_version);json_object_int_add(json_row,"time
rGroupMembershipIntervalMsec",gmi_msec);json_object_int_add(json_row,"timerLastM
emberQueryMsec",lmqt_msec);json_object_int_add(json_row,"timerOlderHostPresentIn
tervalMsec",ohpi_msec);json_object_int_add(json_row,"timerOtherQuerierPresentInt
ervalMsec",oqpi_msec);json_object_int_add(json_row,"timerQueryInterval",igmp->qu
erier_query_interval);json_object_int_add(json_row,"timerQueryResponseIntervalMs
ec",qri_msec);json_object_int_add(json_row,"timerRobustnessVariable",igmp->queri
er_robustness_variable);json_object_int_add(json_row,"timerStartupQueryInterval"
,sqi);json_object_object_add(json,ifp->name,json_row);if(igmp->mtrace_only){json
_object_boolean_true_add(json_row,"mtraceOnly");}}else{vty_out(vty,"Interface:%s
\n",ifp->name);vty_out(vty,"State:%s\n",if_is_up(ifp)?(igmp->mtrace_only?"mtrace
":"up"):"down");vty_out(vty,"Address:%s\n",inet_ntoa(pim_ifp->primary_address));
vty_out(vty,"Uptime:%s\n",uptime);vty_out(vty,"Version:%d\n",pim_ifp->igmp_versi
on);vty_out(vty,"\n");vty_out(vty,"\n");vty_out(vty,"Querier\n");vty_out(vty,"--
-----\n");vty_out(vty,"Querier:%s\n",igmp->t_igmp_query_timer?"local":"other");v
ty_out(vty,"StartCount:%d\n",igmp->startup_query_count);vty_out(vty,"QueryTimer:
%s\n",query_hhmmss);vty_out(vty,"OtherTimer:%s\n",other_hhmmss);vty_out(vty,"\n"
);vty_out(vty,"\n");vty_out(vty,"Timers\n");vty_out(vty,"------\n");vty_out(vty,
"GroupMembershipInterval:%lis\n",gmi_msec/1000);vty_out(vty,"LastMemberQueryTime
:%lis\n",lmqt_msec/1000);vty_out(vty,"OlderHostPresentInterval:%lis\n",ohpi_msec
/1000);vty_out(vty,"OtherQuerierPresentInterval:%lis\n",oqpi_msec/1000);vty_out(
vty,"QueryInterval:%ds\n",igmp->querier_query_interval);vty_out(vty,"QueryRespon
seInterval:%lis\n",qri_msec/1000);vty_out(vty,"RobustnessVariable:%d\n",igmp->qu
erier_robustness_variable);vty_out(vty,"StartupQueryInterval:%ds\n",sqi);vty_out
(vty,"\n");vty_out(vty,"\n");pim_print_ifp_flags(vty,ifp,mloop);}}}if(uj){vty_ou
t(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_
object_free(json);}else{if(!found_ifname)vty_out(vty,"%%Nosuchinterface\n");}}st
aticvoidigmp_show_interface_join(structpim_instance*pim,structvty*vty){structint
erface*ifp;time_tnow;now=pim_time_monotonic_sec();vty_out(vty,"InterfaceAddressS
ourceGroupSocketUptime\n");FOR_ALL_INTERFACES(pim->vrf,ifp){structpim_interface*
pim_ifp;structlistnode*join_node;structigmp_join*ij;structin_addrpri_addr;charpr
i_addr_str[INET_ADDRSTRLEN];pim_ifp=ifp->info;if(!pim_ifp)continue;if(!pim_ifp->
igmp_join_list)continue;pri_addr=pim_find_primary_addr(ifp);pim_inet4_dump("<pri
?>",pri_addr,pri_addr_str,sizeof(pri_addr_str));for(ALL_LIST_ELEMENTS_RO(pim_ifp
->igmp_join_list,join_node,ij)){chargroup_str[INET_ADDRSTRLEN];charsource_str[IN
ET_ADDRSTRLEN];charuptime[10];pim_time_uptime(uptime,sizeof(uptime),now-ij->sock
_creation);pim_inet4_dump("<grp?>",ij->group_addr,group_str,sizeof(group_str));p
im_inet4_dump("<src?>",ij->source_addr,source_str,sizeof(source_str));vty_out(vt
y,"%-9s%-15s%-15s%-15s%6d%8s\n",ifp->name,pri_addr_str,source_str,group_str,ij->
sock_fd,uptime);}/*for(pim_ifp->igmp_join_list)*/}/*for(iflist)*/}staticvoidpim_
show_interfaces_single(structpim_instance*pim,structvty*vty,constchar*ifname,uin
t8_tuj){structin_addrifaddr;structinterface*ifp;structlistnode*neighnode;structl
istnode*upnode;structpim_interface*pim_ifp;structpim_neighbor*neigh;structpim_up
stream*up;time_tnow;chardr_str[INET_ADDRSTRLEN];chardr_uptime[10];charexpire[10]
;chargrp_str[INET_ADDRSTRLEN];charhello_period[10];charhello_timer[10];charneigh
_src_str[INET_ADDRSTRLEN];charsrc_str[INET_ADDRSTRLEN];charstat_uptime[10];charu
ptime[10];intmloop=0;intfound_ifname=0;intprint_header;json_object*json=NULL;jso
n_object*json_row=NULL;json_object*json_pim_neighbor=NULL;json_object*json_pim_n
eighbors=NULL;json_object*json_group=NULL;json_object*json_group_source=NULL;jso
n_object*json_fhr_sources=NULL;structpim_secondary_addr*sec_addr;structlistnode*
sec_node;now=pim_time_monotonic_sec();if(uj)json=json_object_new_object();FOR_AL
L_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->info;if(!pim_ifp)continue;if(strcmp(ifna
me,"detail")&&strcmp(ifname,ifp->name))continue;found_ifname=1;ifaddr=pim_ifp->p
rimary_address;pim_inet4_dump("<dr?>",pim_ifp->pim_dr_addr,dr_str,sizeof(dr_str)
);pim_time_uptime_begin(dr_uptime,sizeof(dr_uptime),now,pim_ifp->pim_dr_election
_last);pim_time_timer_to_hhmmss(hello_timer,sizeof(hello_timer),pim_ifp->t_pim_h
ello_timer);pim_time_mmss(hello_period,sizeof(hello_period),pim_ifp->pim_hello_p
eriod);pim_time_uptime(stat_uptime,sizeof(stat_uptime),now-pim_ifp->pim_ifstat_s
tart);if(pim_ifp->pim_sock_fd>=0)mloop=pim_socket_mcastloop_get(pim_ifp->pim_soc
k_fd);elsemloop=0;if(uj){charpbuf[PREFIX2STR_BUFFER];json_row=json_object_new_ob
ject();json_object_pim_ifp_add(json_row,ifp);if(pim_ifp->update_source.s_addr!=I
NADDR_ANY){json_object_string_add(json_row,"useSource",inet_ntoa(pim_ifp->update
_source));}if(pim_ifp->sec_addr_list){json_object*sec_list=NULL;sec_list=json_ob
ject_new_array();for(ALL_LIST_ELEMENTS_RO(pim_ifp->sec_addr_list,sec_node,sec_ad
dr)){json_object_array_add(sec_list,json_object_new_string(prefix2str(&sec_addr-
>addr,pbuf,sizeof(pbuf))));}json_object_object_add(json_row,"secondaryAddressLis
t",sec_list);}//PIMneighborsif(pim_ifp->pim_neighbor_list->count){json_pim_neigh
bors=json_object_new_object();for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_lis
t,neighnode,neigh)){json_pim_neighbor=json_object_new_object();pim_inet4_dump("<
src?>",neigh->source_addr,neigh_src_str,sizeof(neigh_src_str));pim_time_uptime(u
ptime,sizeof(uptime),now-neigh->creation);pim_time_timer_to_hhmmss(expire,sizeof
(expire),neigh->t_expire_timer);json_object_string_add(json_pim_neighbor,"addres
s",neigh_src_str);json_object_string_add(json_pim_neighbor,"upTime",uptime);json
_object_string_add(json_pim_neighbor,"holdtime",expire);json_object_object_add(j
son_pim_neighbors,neigh_src_str,json_pim_neighbor);}json_object_object_add(json_
row,"neighbors",json_pim_neighbors);}json_object_string_add(json_row,"drAddress"
,dr_str);json_object_int_add(json_row,"drPriority",pim_ifp->pim_dr_priority);jso
n_object_string_add(json_row,"drUptime",dr_uptime);json_object_int_add(json_row,
"drElections",pim_ifp->pim_dr_election_count);json_object_int_add(json_row,"drCh
anges",pim_ifp->pim_dr_election_changes);//FHRfor(ALL_LIST_ELEMENTS_RO(pim->upst
ream_list,upnode,up)){if(ifp!=up->rpf.source_nexthop.interface)continue;if(!(up-
>flags&PIM_UPSTREAM_FLAG_MASK_FHR))continue;if(!json_fhr_sources)json_fhr_source
s=json_object_new_object();pim_inet4_dump("<src?>",up->sg.src,src_str,sizeof(src
_str));pim_inet4_dump("<grp?>",up->sg.grp,grp_str,sizeof(grp_str));pim_time_upti
me(uptime,sizeof(uptime),now-up->state_transition);/**Doesthisgroupliveinjson_fh
r_sources?*Ifnotcreateit.*/json_object_object_get_ex(json_fhr_sources,grp_str,&j
son_group);if(!json_group){json_group=json_object_new_object();json_object_objec
t_add(json_fhr_sources,grp_str,json_group);}json_group_source=json_object_new_ob
ject();json_object_string_add(json_group_source,"source",src_str);json_object_st
ring_add(json_group_source,"group",grp_str);json_object_string_add(json_group_so
urce,"upTime",uptime);json_object_object_add(json_group,src_str,json_group_sourc
e);}if(json_fhr_sources){json_object_object_add(json_row,"firstHopRouter",json_f
hr_sources);}json_object_int_add(json_row,"helloPeriod",pim_ifp->pim_hello_perio
d);json_object_string_add(json_row,"helloTimer",hello_timer);json_object_string_
add(json_row,"helloStatStart",stat_uptime);json_object_int_add(json_row,"helloRe
ceived",pim_ifp->pim_ifstat_hello_recv);json_object_int_add(json_row,"helloRecei
vedFailed",pim_ifp->pim_ifstat_hello_recvfail);json_object_int_add(json_row,"hel
loSend",pim_ifp->pim_ifstat_hello_sent);json_object_int_add(json_row,"hellosendF
ailed",pim_ifp->pim_ifstat_hello_sendfail);json_object_int_add(json_row,"helloGe
nerationId",pim_ifp->pim_generation_id);json_object_int_add(json_row,"flagMultic
astLoop",mloop);json_object_int_add(json_row,"effectivePropagationDelay",pim_if_
effective_propagation_delay_msec(ifp));json_object_int_add(json_row,"effectiveOv
errideInterval",pim_if_effective_override_interval_msec(ifp));json_object_int_ad
d(json_row,"joinPruneOverrideInterval",pim_if_jp_override_interval_msec(ifp));js
on_object_int_add(json_row,"propagationDelay",pim_ifp->pim_propagation_delay_mse
c);json_object_int_add(json_row,"propagationDelayHighest",pim_ifp->pim_neighbors
_highest_propagation_delay_msec);json_object_int_add(json_row,"overrideInterval"
,pim_ifp->pim_override_interval_msec);json_object_int_add(json_row,"overrideInte
rvalHighest",pim_ifp->pim_neighbors_highest_override_interval_msec);json_object_
object_add(json,ifp->name,json_row);}else{vty_out(vty,"Interface:%s\n",ifp->name
);vty_out(vty,"State:%s\n",if_is_up(ifp)?"up":"down");if(pim_ifp->update_source.
s_addr!=INADDR_ANY){vty_out(vty,"UseSource:%s\n",inet_ntoa(pim_ifp->update_sourc
e));}if(pim_ifp->sec_addr_list){charpbuf[PREFIX2STR_BUFFER];vty_out(vty,"Address
:%s(primary)\n",inet_ntoa(ifaddr));for(ALL_LIST_ELEMENTS_RO(pim_ifp->sec_addr_li
st,sec_node,sec_addr)){vty_out(vty,"%s\n",prefix2str(&sec_addr->addr,pbuf,sizeof
(pbuf)));}}else{vty_out(vty,"Address:%s\n",inet_ntoa(ifaddr));}vty_out(vty,"\n")
;//PIMneighborsprint_header=1;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_lis
t,neighnode,neigh)){if(print_header){vty_out(vty,"PIMNeighbors\n");vty_out(vty,"
-------------\n");print_header=0;}pim_inet4_dump("<src?>",neigh->source_addr,nei
gh_src_str,sizeof(neigh_src_str));pim_time_uptime(uptime,sizeof(uptime),now-neig
h->creation);pim_time_timer_to_hhmmss(expire,sizeof(expire),neigh->t_expire_time
r);vty_out(vty,"%-15s:upfor%s,holdtimeexpiresin%s\n",neigh_src_str,uptime,expire
);}if(!print_header){vty_out(vty,"\n");vty_out(vty,"\n");}vty_out(vty,"Designate
dRouter\n");vty_out(vty,"-----------------\n");vty_out(vty,"Address:%s\n",dr_str
);vty_out(vty,"Priority:%d\n",pim_ifp->pim_dr_priority);vty_out(vty,"Uptime:%s\n
",dr_uptime);vty_out(vty,"Elections:%d\n",pim_ifp->pim_dr_election_count);vty_ou
t(vty,"Changes:%d\n",pim_ifp->pim_dr_election_changes);vty_out(vty,"\n");vty_out
(vty,"\n");//FHRprint_header=1;for(ALL_LIST_ELEMENTS_RO(pim->upstream_list,upnod
e,up)){if(strcmp(ifp->name,up->rpf.source_nexthop.interface->name)!=0)continue;i
f(!(up->flags&PIM_UPSTREAM_FLAG_MASK_FHR))continue;if(print_header){vty_out(vty,
"FHR-FirstHopRouter\n");vty_out(vty,"----------------------\n");print_header=0;}
pim_inet4_dump("<src?>",up->sg.src,src_str,sizeof(src_str));pim_inet4_dump("<grp
?>",up->sg.grp,grp_str,sizeof(grp_str));pim_time_uptime(uptime,sizeof(uptime),no
w-up->state_transition);vty_out(vty,"%s:%sisasource,uptimeis%s\n",grp_str,src_st
r,uptime);}if(!print_header){vty_out(vty,"\n");vty_out(vty,"\n");}vty_out(vty,"H
ellos\n");vty_out(vty,"------\n");vty_out(vty,"Period:%d\n",pim_ifp->pim_hello_p
eriod);vty_out(vty,"Timer:%s\n",hello_timer);vty_out(vty,"StatStart:%s\n",stat_u
ptime);vty_out(vty,"Receive:%d\n",pim_ifp->pim_ifstat_hello_recv);vty_out(vty,"R
eceiveFailed:%d\n",pim_ifp->pim_ifstat_hello_recvfail);vty_out(vty,"Send:%d\n",p
im_ifp->pim_ifstat_hello_sent);vty_out(vty,"SendFailed:%d\n",pim_ifp->pim_ifstat
_hello_sendfail);vty_out(vty,"GenerationID:%08x\n",pim_ifp->pim_generation_id);v
ty_out(vty,"\n");vty_out(vty,"\n");pim_print_ifp_flags(vty,ifp,mloop);vty_out(vt
y,"JoinPruneInterval\n");vty_out(vty,"-------------------\n");vty_out(vty,"LANDe
lay:%s\n",pim_if_lan_delay_enabled(ifp)?"yes":"no");vty_out(vty,"EffectivePropag
ationDelay:%dmsec\n",pim_if_effective_propagation_delay_msec(ifp));vty_out(vty,"
EffectiveOverrideInterval:%dmsec\n",pim_if_effective_override_interval_msec(ifp)
);vty_out(vty,"JoinPruneOverrideInterval:%dmsec\n",pim_if_jp_override_interval_m
sec(ifp));vty_out(vty,"\n");vty_out(vty,"\n");vty_out(vty,"LANPruneDelay\n");vty
_out(vty,"---------------\n");vty_out(vty,"PropagationDelay:%dmsec\n",pim_ifp->p
im_propagation_delay_msec);vty_out(vty,"PropagationDelay(Highest):%dmsec\n",pim_
ifp->pim_neighbors_highest_propagation_delay_msec);vty_out(vty,"OverrideInterval
:%dmsec\n",pim_ifp->pim_override_interval_msec);vty_out(vty,"OverrideInterval(Hi
ghest):%dmsec\n",pim_ifp->pim_neighbors_highest_override_interval_msec);vty_out(
vty,"\n");vty_out(vty,"\n");}}if(uj){vty_out(vty,"%s\n",json_object_to_json_stri
ng_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}else{if(!found_ifn
ame)vty_out(vty,"%%Nosuchinterface\n");}}staticvoidpim_show_interfaces(structpim
_instance*pim,structvty*vty,uint8_tuj){structinterface*ifp;structlistnode*upnode
;structpim_interface*pim_ifp;structpim_upstream*up;intfhr=0;intpim_nbrs=0;intpim
_ifchannels=0;json_object*json=NULL;json_object*json_row=NULL;json_object*json_t
mp;json=json_object_new_object();FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->i
nfo;if(!pim_ifp)continue;pim_nbrs=pim_ifp->pim_neighbor_list->count;pim_ifchanne
ls=pim_if_ifchannel_count(pim_ifp);fhr=0;for(ALL_LIST_ELEMENTS_RO(pim->upstream_
list,upnode,up))if(ifp==up->rpf.source_nexthop.interface)if(up->flags&PIM_UPSTRE
AM_FLAG_MASK_FHR)fhr++;json_row=json_object_new_object();json_object_pim_ifp_add
(json_row,ifp);json_object_int_add(json_row,"pimNeighbors",pim_nbrs);json_object
_int_add(json_row,"pimIfChannels",pim_ifchannels);json_object_int_add(json_row,"
firstHopRouterCount",fhr);json_object_string_add(json_row,"pimDesignatedRouter",
inet_ntoa(pim_ifp->pim_dr_addr));if(pim_ifp->pim_dr_addr.s_addr==pim_ifp->primar
y_address.s_addr)json_object_boolean_true_add(json_row,"pimDesignatedRouterLocal
");json_object_object_add(json,ifp->name,json_row);}if(uj){vty_out(vty,"%s\n",js
on_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));}else{vty_out(vty,"I
nterfaceStateAddressPIMNbrsPIMDRFHRIfChannels\n");json_object_object_foreach(jso
n,key,val){vty_out(vty,"%-9s",key);json_object_object_get_ex(val,"state",&json_t
mp);vty_out(vty,"%5s",json_object_get_string(json_tmp));json_object_object_get_e
x(val,"address",&json_tmp);vty_out(vty,"%15s",json_object_get_string(json_tmp));
json_object_object_get_ex(val,"pimNeighbors",&json_tmp);vty_out(vty,"%8d",json_o
bject_get_int(json_tmp));if(json_object_object_get_ex(val,"pimDesignatedRouterLo
cal",&json_tmp)){vty_out(vty,"%15s","local");}else{json_object_object_get_ex(val
,"pimDesignatedRouter",&json_tmp);vty_out(vty,"%15s",json_object_get_string(json
_tmp));}json_object_object_get_ex(val,"firstHopRouter",&json_tmp);vty_out(vty,"%
3d",json_object_get_int(json_tmp));json_object_object_get_ex(val,"pimIfChannels"
,&json_tmp);vty_out(vty,"%9d\n",json_object_get_int(json_tmp));}}json_object_fre
e(json);}staticvoidpim_show_interface_traffic(structpim_instance*pim,structvty*v
ty,uint8_tuj){structinterface*ifp=NULL;structpim_interface*pim_ifp=NULL;json_obj
ect*json=NULL;json_object*json_row=NULL;if(uj)json=json_object_new_object();else
{vty_out(vty,"\n");vty_out(vty,"%-12s%-17s%-17s%-17s%-17s%-17s%-17s\n","Interfac
e","HELLO","JOIN","PRUNE","REGISTER","REGISTER-STOP","ASSERT");vty_out(vty,"%-10
s%-18s%-17s%-17s%-17s%-17s%-17s\n","","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx","R
x/Tx");vty_out(vty,"------------------------------------------------------------
---------------------------------------------------\n");}FOR_ALL_INTERFACES(pim-
>vrf,ifp){pim_ifp=ifp->info;if(!pim_ifp)continue;if(pim_ifp->pim_sock_fd<0)conti
nue;if(uj){json_row=json_object_new_object();json_object_pim_ifp_add(json_row,if
p);json_object_int_add(json_row,"helloRx",pim_ifp->pim_ifstat_hello_recv);json_o
bject_int_add(json_row,"helloTx",pim_ifp->pim_ifstat_hello_sent);json_object_int
_add(json_row,"joinRx",pim_ifp->pim_ifstat_join_recv);json_object_int_add(json_r
ow,"joinTx",pim_ifp->pim_ifstat_join_send);json_object_int_add(json_row,"registe
rRx",pim_ifp->pim_ifstat_reg_recv);json_object_int_add(json_row,"registerTx",pim
_ifp->pim_ifstat_reg_recv);json_object_int_add(json_row,"registerStopRx",pim_ifp
->pim_ifstat_reg_stop_recv);json_object_int_add(json_row,"registerStopTx",pim_if
p->pim_ifstat_reg_stop_send);json_object_int_add(json_row,"assertRx",pim_ifp->pi
m_ifstat_assert_recv);json_object_int_add(json_row,"assertTx",pim_ifp->pim_ifsta
t_assert_send);json_object_object_add(json,ifp->name,json_row);}else{vty_out(vty
,"%-10s%8u/%-8u%7u/%-7u%7u/%-7u%7u/%-7u%7u/%-7u%7u/%-7u\n",ifp->name,pim_ifp->pi
m_ifstat_hello_recv,pim_ifp->pim_ifstat_hello_sent,pim_ifp->pim_ifstat_join_recv
,pim_ifp->pim_ifstat_join_send,pim_ifp->pim_ifstat_prune_recv,pim_ifp->pim_ifsta
t_prune_send,pim_ifp->pim_ifstat_reg_recv,pim_ifp->pim_ifstat_reg_send,pim_ifp->
pim_ifstat_reg_stop_recv,pim_ifp->pim_ifstat_reg_stop_send,pim_ifp->pim_ifstat_a
ssert_recv,pim_ifp->pim_ifstat_assert_send);}}if(uj){vty_out(vty,"%s\n",json_obj
ect_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}s
taticvoidpim_show_interface_traffic_single(structpim_instance*pim,structvty*vty,
constchar*ifname,uint8_tuj){structinterface*ifp=NULL;structpim_interface*pim_ifp
=NULL;json_object*json=NULL;json_object*json_row=NULL;uint8_tfound_ifname=0;if(u
j)json=json_object_new_object();else{vty_out(vty,"\n");vty_out(vty,"%-12s%-17s%-
17s%-17s%-17s%-17s%-17s\n","Interface","HELLO","JOIN","PRUNE","REGISTER","REGIST
ER-STOP","ASSERT");vty_out(vty,"%-10s%-18s%-17s%-17s%-17s%-17s%-17s\n","","Rx/Tx
","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx");vty_out(vty,"------------------------
--------------------------------------------------------------------------------
-------\n");}FOR_ALL_INTERFACES(pim->vrf,ifp){if(strcmp(ifname,ifp->name))contin
ue;pim_ifp=ifp->info;if(!pim_ifp)continue;if(pim_ifp->pim_sock_fd<0)continue;fou
nd_ifname=1;if(uj){json_row=json_object_new_object();json_object_pim_ifp_add(jso
n_row,ifp);json_object_int_add(json_row,"helloRx",pim_ifp->pim_ifstat_hello_recv
);json_object_int_add(json_row,"helloTx",pim_ifp->pim_ifstat_hello_sent);json_ob
ject_int_add(json_row,"joinRx",pim_ifp->pim_ifstat_join_recv);json_object_int_ad
d(json_row,"joinTx",pim_ifp->pim_ifstat_join_send);json_object_int_add(json_row,
"registerRx",pim_ifp->pim_ifstat_reg_recv);json_object_int_add(json_row,"registe
rTx",pim_ifp->pim_ifstat_reg_recv);json_object_int_add(json_row,"registerStopRx"
,pim_ifp->pim_ifstat_reg_stop_recv);json_object_int_add(json_row,"registerStopTx
",pim_ifp->pim_ifstat_reg_stop_send);json_object_int_add(json_row,"assertRx",pim
_ifp->pim_ifstat_assert_recv);json_object_int_add(json_row,"assertTx",pim_ifp->p
im_ifstat_assert_send);json_object_object_add(json,ifp->name,json_row);}else{vty
_out(vty,"%-10s%8u/%-8u%7u/%-7u%7u/%-7u%7u/%-7u%7u/%-7u%7u/%-7u\n",ifp->name,pim
_ifp->pim_ifstat_hello_recv,pim_ifp->pim_ifstat_hello_sent,pim_ifp->pim_ifstat_j
oin_recv,pim_ifp->pim_ifstat_join_send,pim_ifp->pim_ifstat_prune_recv,pim_ifp->p
im_ifstat_prune_send,pim_ifp->pim_ifstat_reg_recv,pim_ifp->pim_ifstat_reg_send,p
im_ifp->pim_ifstat_reg_stop_recv,pim_ifp->pim_ifstat_reg_stop_send,pim_ifp->pim_
ifstat_assert_recv,pim_ifp->pim_ifstat_assert_send);}}if(uj){vty_out(vty,"%s\n",
json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(j
son);}else{if(!found_ifname)vty_out(vty,"%%Nosuchinterface\n");}}staticvoidpim_s
how_join_helper(structvty*vty,structpim_interface*pim_ifp,structpim_ifchannel*ch
,json_object*json,time_tnow,uint8_tuj){charch_src_str[INET_ADDRSTRLEN];charch_gr
p_str[INET_ADDRSTRLEN];json_object*json_iface=NULL;json_object*json_row=NULL;jso
n_object*json_grp=NULL;structin_addrifaddr;charuptime[10];charexpire[10];charpru
ne[10];ifaddr=pim_ifp->primary_address;pim_inet4_dump("<ch_src?>",ch->sg.src,ch_
src_str,sizeof(ch_src_str));pim_inet4_dump("<ch_grp?>",ch->sg.grp,ch_grp_str,siz
eof(ch_grp_str));pim_time_uptime_begin(uptime,sizeof(uptime),now,ch->ifjoin_crea
tion);pim_time_timer_to_mmss(expire,sizeof(expire),ch->t_ifjoin_expiry_timer);pi
m_time_timer_to_mmss(prune,sizeof(prune),ch->t_ifjoin_prune_pending_timer);if(uj
){json_object_object_get_ex(json,ch->interface->name,&json_iface);if(!json_iface
){json_iface=json_object_new_object();json_object_pim_ifp_add(json_iface,ch->int
erface);json_object_object_add(json,ch->interface->name,json_iface);}json_row=js
on_object_new_object();json_object_string_add(json_row,"source",ch_src_str);json
_object_string_add(json_row,"group",ch_grp_str);json_object_string_add(json_row,
"upTime",uptime);json_object_string_add(json_row,"expire",expire);json_object_st
ring_add(json_row,"prune",prune);json_object_string_add(json_row,"channelJoinNam
e",pim_ifchannel_ifjoin_name(ch->ifjoin_state,ch->flags));if(PIM_IF_FLAG_TEST_S_
G_RPT(ch->flags))json_object_int_add(json_row,"SGRpt",1);json_object_object_get_
ex(json_iface,ch_grp_str,&json_grp);if(!json_grp){json_grp=json_object_new_objec
t();json_object_object_add(json_grp,ch_src_str,json_row);json_object_object_add(
json_iface,ch_grp_str,json_grp);}elsejson_object_object_add(json_grp,ch_src_str,
json_row);}else{vty_out(vty,"%-9s%-15s%-15s%-15s%-10s%8s%-6s%5s\n",ch->interface
->name,inet_ntoa(ifaddr),ch_src_str,ch_grp_str,pim_ifchannel_ifjoin_name(ch->ifj
oin_state,ch->flags),uptime,expire,prune);}}staticvoidpim_show_join(structpim_in
stance*pim,structvty*vty,uint8_tuj){structpim_interface*pim_ifp;structpim_ifchan
nel*ch;structinterface*ifp;time_tnow;json_object*json=NULL;now=pim_time_monotoni
c_sec();if(uj)json=json_object_new_object();elsevty_out(vty,"InterfaceAddressSou
rceGroupStateUptimeExpirePrune\n");FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp-
>info;if(!pim_ifp)continue;RB_FOREACH(ch,pim_ifchannel_rb,&pim_ifp->ifchannel_rb
){pim_show_join_helper(vty,pim_ifp,ch,json,now,uj);}/*scaninterfacechannels*/}if
(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRE
TTY));json_object_free(json);}}staticvoidpim_show_neighbors_single(structpim_ins
tance*pim,structvty*vty,constchar*neighbor,uint8_tuj){structlistnode*neighnode;s
tructinterface*ifp;structpim_interface*pim_ifp;structpim_neighbor*neigh;time_tno
w;intfound_neighbor=0;intoption_address_list;intoption_dr_priority;intoption_gen
eration_id;intoption_holdtime;intoption_lan_prune_delay;intoption_t_bit;charupti
me[10];charexpire[10];charneigh_src_str[INET_ADDRSTRLEN];json_object*json=NULL;j
son_object*json_ifp=NULL;json_object*json_row=NULL;now=pim_time_monotonic_sec();
if(uj)json=json_object_new_object();FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp
->info;if(!pim_ifp)continue;if(pim_ifp->pim_sock_fd<0)continue;for(ALL_LIST_ELEM
ENTS_RO(pim_ifp->pim_neighbor_list,neighnode,neigh)){pim_inet4_dump("<src?>",nei
gh->source_addr,neigh_src_str,sizeof(neigh_src_str));/**Theusercanspecifyeithert
heinterfacenameorthe*PIMneighborIP.*Ifthispim_ifpmatchesneitherthenskip.*/if(str
cmp(neighbor,"detail")&&strcmp(neighbor,ifp->name)&&strcmp(neighbor,neigh_src_st
r))continue;found_neighbor=1;pim_time_uptime(uptime,sizeof(uptime),now-neigh->cr
eation);pim_time_timer_to_hhmmss(expire,sizeof(expire),neigh->t_expire_timer);op
tion_address_list=0;option_dr_priority=0;option_generation_id=0;option_holdtime=
0;option_lan_prune_delay=0;option_t_bit=0;if(PIM_OPTION_IS_SET(neigh->hello_opti
ons,PIM_OPTION_MASK_ADDRESS_LIST))option_address_list=1;if(PIM_OPTION_IS_SET(nei
gh->hello_options,PIM_OPTION_MASK_DR_PRIORITY))option_dr_priority=1;if(PIM_OPTIO
N_IS_SET(neigh->hello_options,PIM_OPTION_MASK_GENERATION_ID))option_generation_i
d=1;if(PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MASK_HOLDTIME))option_h
oldtime=1;if(PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTION_MASK_LAN_PRUNE_DE
LAY))option_lan_prune_delay=1;if(PIM_OPTION_IS_SET(neigh->hello_options,PIM_OPTI
ON_MASK_CAN_DISABLE_JOIN_SUPPRESSION))option_t_bit=1;if(uj){/*Doesthisifpliveinj
son?Ifnotcreate*it.*/json_object_object_get_ex(json,ifp->name,&json_ifp);if(!jso
n_ifp){json_ifp=json_object_new_object();json_object_pim_ifp_add(json_ifp,ifp);j
son_object_object_add(json,ifp->name,json_ifp);}json_row=json_object_new_object(
);json_object_string_add(json_row,"interface",ifp->name);json_object_string_add(
json_row,"address",neigh_src_str);json_object_string_add(json_row,"upTime",uptim
e);json_object_string_add(json_row,"holdtime",expire);json_object_int_add(json_r
ow,"drPriority",neigh->dr_priority);json_object_int_add(json_row,"generationId",
neigh->generation_id);if(option_address_list)json_object_boolean_true_add(json_r
ow,"helloOptionAddressList");if(option_dr_priority)json_object_boolean_true_add(
json_row,"helloOptionDrPriority");if(option_generation_id)json_object_boolean_tr
ue_add(json_row,"helloOptionGenerationId");if(option_holdtime)json_object_boolea
n_true_add(json_row,"helloOptionHoldtime");if(option_lan_prune_delay)json_object
_boolean_true_add(json_row,"helloOptionLanPruneDelay");if(option_t_bit)json_obje
ct_boolean_true_add(json_row,"helloOptionTBit");json_object_object_add(json_ifp,
neigh_src_str,json_row);}else{vty_out(vty,"Interface:%s\n",ifp->name);vty_out(vt
y,"Neighbor:%s\n",neigh_src_str);vty_out(vty,"Uptime:%s\n",uptime);vty_out(vty,"
Holdtime:%s\n",expire);vty_out(vty,"DRPriority:%d\n",neigh->dr_priority);vty_out
(vty,"GenerationID:%08x\n",neigh->generation_id);vty_out(vty,"OverrideInterval(m
sec):%d\n",neigh->override_interval_msec);vty_out(vty,"PropagationDelay(msec):%d
\n",neigh->propagation_delay_msec);vty_out(vty,"HelloOption-AddressList:%s\n",op
tion_address_list?"yes":"no");vty_out(vty,"HelloOption-DRPriority:%s\n",option_d
r_priority?"yes":"no");vty_out(vty,"HelloOption-GenerationID:%s\n",option_genera
tion_id?"yes":"no");vty_out(vty,"HelloOption-Holdtime:%s\n",option_holdtime?"yes
":"no");vty_out(vty,"HelloOption-LANPruneDelay:%s\n",option_lan_prune_delay?"yes
":"no");vty_out(vty,"HelloOption-T-bit:%s\n",option_t_bit?"yes":"no");pim_bfd_sh
ow_info(vty,neigh->bfd_info,json_ifp,uj,0);vty_out(vty,"\n");}}}if(uj){vty_out(v
ty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_obj
ect_free(json);}else{{if(!found_neighbor)vty_out(vty,"%%Nosuchinterfaceorneighbo
r\n");}}}staticvoidpim_show_state(structpim_instance*pim,structvty*vty,constchar
*src_or_group,constchar*group,uint8_tuj){structchannel_oil*c_oil;structlistnode*
node;json_object*json=NULL;json_object*json_group=NULL;json_object*json_ifp_in=N
ULL;json_object*json_ifp_out=NULL;json_object*json_source=NULL;time_tnow;intfirs
t_oif;now=pim_time_monotonic_sec();if(uj){json=json_object_new_object();}else{vt
y_out(vty,"Codes:J->PimJoin,I->IGMPReport,S->Source,*->Inheritedfrom(*,G)");vty_
out(vty,"\nInstalledSourceGroupIIFOIL\n");}for(ALL_LIST_ELEMENTS_RO(pim->channel
_oil_list,node,c_oil)){chargrp_str[INET_ADDRSTRLEN];charsrc_str[INET_ADDRSTRLEN]
;charin_ifname[INTERFACE_NAMSIZ+1];charout_ifname[INTERFACE_NAMSIZ+1];intoif_vif
_index;structinterface*ifp_in;first_oif=1;pim_inet4_dump("<group?>",c_oil->oil.m
fcc_mcastgrp,grp_str,sizeof(grp_str));pim_inet4_dump("<source?>",c_oil->oil.mfcc
_origin,src_str,sizeof(src_str));ifp_in=pim_if_find_by_vif_index(pim,c_oil->oil.
mfcc_parent);if(ifp_in)strcpy(in_ifname,ifp_in->name);elsestrcpy(in_ifname,"<iif
?>");if(src_or_group){if(strcmp(src_or_group,src_str)&&strcmp(src_or_group,grp_s
tr))continue;if(group&&strcmp(group,grp_str))continue;}if(uj){/*Findthegroup,cre
ateitifitdoesn'texist*/json_object_object_get_ex(json,grp_str,&json_group);if(!j
son_group){json_group=json_object_new_object();json_object_object_add(json,grp_s
tr,json_group);}/*Findthesourcenestedunderthegroup,createitif*itdoesn'texist*/js
on_object_object_get_ex(json_group,src_str,&json_source);if(!json_source){json_s
ource=json_object_new_object();json_object_object_add(json_group,src_str,json_so
urce);}/*Findtheinboundinterfacenestedunderthesource,*createitifitdoesn'texist*/
json_object_object_get_ex(json_source,in_ifname,&json_ifp_in);if(!json_ifp_in){j
son_ifp_in=json_object_new_object();json_object_object_add(json_source,in_ifname
,json_ifp_in);json_object_int_add(json_source,"Installed",c_oil->installed);json
_object_int_add(json_source,"RefCount",c_oil->oil_ref_count);json_object_int_add
(json_source,"OilListSize",c_oil->oil_size);json_object_int_add(json_source,"Oil
Rescan",c_oil->oil_inherited_rescan);json_object_int_add(json_source,"LastUsed",
c_oil->cc.lastused);json_object_int_add(json_source,"PacketCount",c_oil->cc.pktc
nt);json_object_int_add(json_source,"ByteCount",c_oil->cc.bytecnt);json_object_i
nt_add(json_source,"WrongInterface",c_oil->cc.wrong_if);}}else{vty_out(vty,"%-9d
%-15s%-15s%-7s",c_oil->installed,src_str,grp_str,ifp_in->name);}for(oif_vif_inde
x=0;oif_vif_index<MAXVIFS;++oif_vif_index){structinterface*ifp_out;charoif_uptim
e[10];intttl;ttl=c_oil->oil.mfcc_ttls[oif_vif_index];if(ttl<1)continue;ifp_out=p
im_if_find_by_vif_index(pim,oif_vif_index);pim_time_uptime(oif_uptime,sizeof(oif
_uptime),now-c_oil->oif_creation[oif_vif_index]);if(ifp_out)strcpy(out_ifname,if
p_out->name);elsestrcpy(out_ifname,"<oif?>");if(uj){json_ifp_out=json_object_new
_object();json_object_string_add(json_ifp_out,"source",src_str);json_object_stri
ng_add(json_ifp_out,"group",grp_str);json_object_string_add(json_ifp_out,"inboun
dInterface",in_ifname);json_object_string_add(json_ifp_out,"outboundInterface",o
ut_ifname);json_object_int_add(json_ifp_out,"installed",c_oil->installed);json_o
bject_object_add(json_ifp_in,out_ifname,json_ifp_out);}else{if(first_oif){first_
oif=0;vty_out(vty,"%s(%c%c%c%c)",out_ifname,(c_oil->oif_flags[oif_vif_index]&PIM
_OIF_FLAG_PROTO_IGMP)?'I':'',(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO
_PIM)?'J':'',(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_SOURCE)?'S':'',
(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_STAR)?'*':'');}elsevty_out(v
ty,",%s(%c%c%c%c)",out_ifname,(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROT
O_IGMP)?'I':'',(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_PIM)?'J':'',(
c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_SOURCE)?'S':'',(c_oil->oif_fl
ags[oif_vif_index]&PIM_OIF_FLAG_PROTO_STAR)?'*':'');}}if(!uj)vty_out(vty,"\n");}
if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_P
RETTY));json_object_free(json);}else{vty_out(vty,"\n");}}staticvoidpim_show_neig
hbors(structpim_instance*pim,structvty*vty,uint8_tuj){structlistnode*neighnode;s
tructinterface*ifp;structpim_interface*pim_ifp;structpim_neighbor*neigh;time_tno
w;charuptime[10];charexpire[10];charneigh_src_str[INET_ADDRSTRLEN];json_object*j
son=NULL;json_object*json_ifp_rows=NULL;json_object*json_row=NULL;now=pim_time_m
onotonic_sec();if(uj){json=json_object_new_object();}else{vty_out(vty,"Interface
NeighborUptimeHoldtimeDRPri\n");}FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->i
nfo;if(!pim_ifp)continue;if(pim_ifp->pim_sock_fd<0)continue;if(uj)json_ifp_rows=
json_object_new_object();for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,nei
ghnode,neigh)){pim_inet4_dump("<src?>",neigh->source_addr,neigh_src_str,sizeof(n
eigh_src_str));pim_time_uptime(uptime,sizeof(uptime),now-neigh->creation);pim_ti
me_timer_to_hhmmss(expire,sizeof(expire),neigh->t_expire_timer);if(uj){json_row=
json_object_new_object();json_object_string_add(json_row,"interface",ifp->name);
json_object_string_add(json_row,"neighbor",neigh_src_str);json_object_string_add
(json_row,"upTime",uptime);json_object_string_add(json_row,"holdTime",expire);js
on_object_int_add(json_row,"holdTimeMax",neigh->holdtime);json_object_int_add(js
on_row,"drPriority",neigh->dr_priority);json_object_object_add(json_ifp_rows,nei
gh_src_str,json_row);}else{vty_out(vty,"%-9s%15s%8s%8s%6d\n",ifp->name,neigh_src
_str,uptime,expire,neigh->dr_priority);}}if(uj){json_object_object_add(json,ifp-
>name,json_ifp_rows);json_ifp_rows=NULL;}}if(uj){vty_out(vty,"%s\n",json_object_
to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}stati
cvoidpim_show_neighbors_secondary(structpim_instance*pim,structvty*vty){structin
terface*ifp;vty_out(vty,"InterfaceAddressNeighborSecondary\n");FOR_ALL_INTERFACE
S(pim->vrf,ifp){structpim_interface*pim_ifp;structin_addrifaddr;structlistnode*n
eighnode;structpim_neighbor*neigh;pim_ifp=ifp->info;if(!pim_ifp)continue;if(pim_
ifp->pim_sock_fd<0)continue;ifaddr=pim_ifp->primary_address;for(ALL_LIST_ELEMENT
S_RO(pim_ifp->pim_neighbor_list,neighnode,neigh)){charneigh_src_str[INET_ADDRSTR
LEN];structlistnode*prefix_node;structprefix*p;if(!neigh->prefix_list)continue;p
im_inet4_dump("<src?>",neigh->source_addr,neigh_src_str,sizeof(neigh_src_str));f
or(ALL_LIST_ELEMENTS_RO(neigh->prefix_list,prefix_node,p)){charneigh_sec_str[PRE
FIX2STR_BUFFER];prefix2str(p,neigh_sec_str,sizeof(neigh_sec_str));vty_out(vty,"%
-9s%-15s%-15s%-15s\n",ifp->name,inet_ntoa(ifaddr),neigh_src_str,neigh_sec_str);}
}}}staticvoidjson_object_pim_upstream_add(json_object*json,structpim_upstream*up
){if(up->flags&PIM_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED)json_object_boolean_true_a
dd(json,"drJoinDesired");if(up->flags&PIM_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED_UPD
ATED)json_object_boolean_true_add(json,"drJoinDesiredUpdated");if(up->flags&PIM_
UPSTREAM_FLAG_MASK_FHR)json_object_boolean_true_add(json,"firstHopRouter");if(up
->flags&PIM_UPSTREAM_FLAG_MASK_SRC_IGMP)json_object_boolean_true_add(json,"sourc
eIgmp");if(up->flags&PIM_UPSTREAM_FLAG_MASK_SRC_PIM)json_object_boolean_true_add
(json,"sourcePim");if(up->flags&PIM_UPSTREAM_FLAG_MASK_SRC_STREAM)json_object_bo
olean_true_add(json,"sourceStream");/*XXX:needtoprintthsflagintheplaintextdispla
yaswell*/if(up->flags&PIM_UPSTREAM_FLAG_MASK_SRC_MSDP)json_object_boolean_true_a
dd(json,"sourceMsdp");}staticconstchar*pim_upstream_state2brief_str(enumpim_upst
ream_statejoin_state,char*state_str){switch(join_state){casePIM_UPSTREAM_NOTJOIN
ED:strcpy(state_str,"NotJ");break;casePIM_UPSTREAM_JOINED:strcpy(state_str,"J");
break;default:strcpy(state_str,"Unk");}returnstate_str;}staticconstchar*pim_reg_
state2brief_str(enumpim_reg_statereg_state,char*state_str){switch(reg_state){cas
ePIM_REG_NOINFO:strcpy(state_str,"RegNI");break;casePIM_REG_JOIN:strcpy(state_st
r,"RegJ");break;casePIM_REG_JOIN_PENDING:casePIM_REG_PRUNE:strcpy(state_str,"Reg
P");break;default:strcpy(state_str,"Unk");}returnstate_str;}staticvoidpim_show_u
pstream(structpim_instance*pim,structvty*vty,uint8_tuj){structlistnode*upnode;st
ructpim_upstream*up;time_tnow;json_object*json=NULL;json_object*json_group=NULL;
json_object*json_row=NULL;now=pim_time_monotonic_sec();if(uj)json=json_object_ne
w_object();elsevty_out(vty,"IifSourceGroupStateUptimeJoinTimerRSTimerKATimerRefC
nt\n");for(ALL_LIST_ELEMENTS_RO(pim->upstream_list,upnode,up)){charsrc_str[INET_
ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];charuptime[10];charjoin_timer[10];charr
s_timer[10];charka_timer[10];charmsdp_reg_timer[10];charstate_str[PIM_REG_STATE_
STR_LEN];pim_inet4_dump("<src?>",up->sg.src,src_str,sizeof(src_str));pim_inet4_d
ump("<grp?>",up->sg.grp,grp_str,sizeof(grp_str));pim_time_uptime(uptime,sizeof(u
ptime),now-up->state_transition);pim_time_timer_to_hhmmss(join_timer,sizeof(join
_timer),up->t_join_timer);/**IfwehaveaJ/Ptimerfortheneighbordisplaythat*/if(!up-
>t_join_timer){structpim_neighbor*nbr;nbr=pim_neighbor_find(up->rpf.source_nexth
op.interface,up->rpf.rpf_addr.u.prefix4);if(nbr)pim_time_timer_to_hhmmss(join_ti
mer,sizeof(join_timer),nbr->jp_timer);}pim_time_timer_to_hhmmss(rs_timer,sizeof(
rs_timer),up->t_rs_timer);pim_time_timer_to_hhmmss(ka_timer,sizeof(ka_timer),up-
>t_ka_timer);pim_time_timer_to_hhmmss(msdp_reg_timer,sizeof(msdp_reg_timer),up->
t_msdp_reg_timer);pim_upstream_state2brief_str(up->join_state,state_str);if(up->
reg_state!=PIM_REG_NOINFO){chartmp_str[PIM_REG_STATE_STR_LEN];sprintf(state_str+
strlen(state_str),",%s",pim_reg_state2brief_str(up->reg_state,tmp_str));}if(uj){
json_object_object_get_ex(json,grp_str,&json_group);if(!json_group){json_group=j
son_object_new_object();json_object_object_add(json,grp_str,json_group);}json_ro
w=json_object_new_object();json_object_pim_upstream_add(json_row,up);json_object
_string_add(json_row,"inboundInterface",up->rpf.source_nexthop.interface->name);
/**TheRPFaddressweuseisslightlydifferent*baseduponwhatwearelookingup.*IfwehaveaS
,listthatunless*wearetheFHR,elsewejustput*theRPastherpfAddress*/if(up->flags&PIM
_UPSTREAM_FLAG_MASK_FHR||up->sg.src.s_addr==INADDR_ANY){charrpf[PREFIX_STRLEN];s
tructpim_rpf*rpg;rpg=RP(pim,up->sg.grp);pim_inet4_dump("<rpf?>",rpg->rpf_addr.u.
prefix4,rpf,sizeof(rpf));json_object_string_add(json_row,"rpfAddress",rpf);}else
{json_object_string_add(json_row,"rpfAddress",src_str);}json_object_string_add(j
son_row,"source",src_str);json_object_string_add(json_row,"group",grp_str);json_
object_string_add(json_row,"state",state_str);json_object_string_add(json_row,"j
oinState",pim_upstream_state2str(up->join_state));json_object_string_add(json_ro
w,"regState",pim_reg_state2str(up->reg_state,state_str));json_object_string_add(
json_row,"upTime",uptime);json_object_string_add(json_row,"joinTimer",join_timer
);json_object_string_add(json_row,"resetTimer",rs_timer);json_object_string_add(
json_row,"keepaliveTimer",ka_timer);json_object_string_add(json_row,"msdpRegTime
r",msdp_reg_timer);json_object_int_add(json_row,"refCount",up->ref_count);json_o
bject_int_add(json_row,"sptBit",up->sptbit);json_object_object_add(json_group,sr
c_str,json_row);}else{vty_out(vty,"%-10s%-15s%-15s%-11s%-8s%-9s%-9s%-9s%6d\n",up
->rpf.source_nexthop.interface->name,src_str,grp_str,state_str,uptime,join_timer
,rs_timer,ka_timer,up->ref_count);}}if(uj){vty_out(vty,"%s\n",json_object_to_jso
n_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}staticvoidp
im_show_join_desired_helper(structpim_instance*pim,structvty*vty,structpim_inter
face*pim_ifp,structpim_ifchannel*ch,json_object*json,uint8_tuj){structpim_upstre
am*up=ch->upstream;json_object*json_group=NULL;charsrc_str[INET_ADDRSTRLEN];char
grp_str[INET_ADDRSTRLEN];json_object*json_row=NULL;pim_inet4_dump("<src?>",up->s
g.src,src_str,sizeof(src_str));pim_inet4_dump("<grp?>",up->sg.grp,grp_str,sizeof
(grp_str));if(uj){json_object_object_get_ex(json,grp_str,&json_group);if(!json_g
roup){json_group=json_object_new_object();json_object_object_add(json,grp_str,js
on_group);}json_row=json_object_new_object();json_object_pim_upstream_add(json_r
ow,up);json_object_string_add(json_row,"interface",ch->interface->name);json_obj
ect_string_add(json_row,"source",src_str);json_object_string_add(json_row,"group
",grp_str);if(pim_macro_ch_lost_assert(ch))json_object_boolean_true_add(json_row
,"lostAssert");if(pim_macro_chisin_joins(ch))json_object_boolean_true_add(json_r
ow,"joins");if(pim_macro_chisin_pim_include(ch))json_object_boolean_true_add(jso
n_row,"pimInclude");if(pim_upstream_evaluate_join_desired(pim,up))json_object_bo
olean_true_add(json_row,"evaluateJoinDesired");json_object_object_add(json_group
,src_str,json_row);}else{vty_out(vty,"%-9s%-15s%-15s%-10s%-5s%-10s%-11s%-6s\n",c
h->interface->name,src_str,grp_str,pim_macro_ch_lost_assert(ch)?"yes":"no",pim_m
acro_chisin_joins(ch)?"yes":"no",pim_macro_chisin_pim_include(ch)?"yes":"no",PIM
_UPSTREAM_FLAG_TEST_DR_JOIN_DESIRED(up->flags)?"yes":"no",pim_upstream_evaluate_
join_desired(pim,up)?"yes":"no");}}staticvoidpim_show_join_desired(structpim_ins
tance*pim,structvty*vty,uint8_tuj){structpim_interface*pim_ifp;structpim_ifchann
el*ch;structinterface*ifp;json_object*json=NULL;if(uj)json=json_object_new_objec
t();elsevty_out(vty,"InterfaceSourceGroupLostAssertJoinsPimIncludeJoinDesiredEva
lJD\n");/*scanper-interface(S,G)state*/FOR_ALL_INTERFACES(pim->vrf,ifp){pim_ifp=
ifp->info;if(!pim_ifp)continue;RB_FOREACH(ch,pim_ifchannel_rb,&pim_ifp->ifchanne
l_rb){/*scanallinterfaces*/pim_show_join_desired_helper(pim,vty,pim_ifp,ch,json,
uj);}}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_ST
RING_PRETTY));json_object_free(json);}}staticvoidpim_show_upstream_rpf(structpim
_instance*pim,structvty*vty,uint8_tuj){structlistnode*upnode;structpim_upstream*
up;json_object*json=NULL;json_object*json_group=NULL;json_object*json_row=NULL;i
f(uj)json=json_object_new_object();elsevty_out(vty,"SourceGroupRpfIfaceRibNextHo
pRpfAddress\n");for(ALL_LIST_ELEMENTS_RO(pim->upstream_list,upnode,up)){charsrc_
str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];charrpf_nexthop_str[PREFIX_STR
LEN];charrpf_addr_str[PREFIX_STRLEN];structpim_rpf*rpf;constchar*rpf_ifname;rpf=
&up->rpf;pim_inet4_dump("<src?>",up->sg.src,src_str,sizeof(src_str));pim_inet4_d
ump("<grp?>",up->sg.grp,grp_str,sizeof(grp_str));pim_addr_dump("<nexthop?>",&rpf
->source_nexthop.mrib_nexthop_addr,rpf_nexthop_str,sizeof(rpf_nexthop_str));pim_
addr_dump("<rpf?>",&rpf->rpf_addr,rpf_addr_str,sizeof(rpf_addr_str));rpf_ifname=
rpf->source_nexthop.interface?rpf->source_nexthop.interface->name:"<ifname?>";if
(uj){json_object_object_get_ex(json,grp_str,&json_group);if(!json_group){json_gr
oup=json_object_new_object();json_object_object_add(json,grp_str,json_group);}js
on_row=json_object_new_object();json_object_pim_upstream_add(json_row,up);json_o
bject_string_add(json_row,"source",src_str);json_object_string_add(json_row,"gro
up",grp_str);json_object_string_add(json_row,"rpfInterface",rpf_ifname);json_obj
ect_string_add(json_row,"ribNexthop",rpf_nexthop_str);json_object_string_add(jso
n_row,"rpfAddress",rpf_addr_str);json_object_object_add(json_group,src_str,json_
row);}else{vty_out(vty,"%-15s%-15s%-8s%-15s%-15s\n",src_str,grp_str,rpf_ifname,r
pf_nexthop_str,rpf_addr_str);}}if(uj){vty_out(vty,"%s\n",json_object_to_json_str
ing_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}staticvoidshow_r
pf_refresh_stats(structvty*vty,structpim_instance*pim,time_tnow,json_object*json
){charrefresh_uptime[10];pim_time_uptime_begin(refresh_uptime,sizeof(refresh_upt
ime),now,pim->rpf_cache_refresh_last);if(json){json_object_int_add(json,"rpfCach
eRefreshDelayMsecs",qpim_rpf_cache_refresh_delay_msec);json_object_int_add(json,
"rpfCacheRefreshTimer",pim_time_timer_remain_msec(pim->rpf_cache_refresher));jso
n_object_int_add(json,"rpfCacheRefreshRequests",pim->rpf_cache_refresh_requests)
;json_object_int_add(json,"rpfCacheRefreshEvents",pim->rpf_cache_refresh_events)
;json_object_string_add(json,"rpfCacheRefreshLast",refresh_uptime);json_object_i
nt_add(json,"nexthopLookups",pim->nexthop_lookups);json_object_int_add(json,"nex
thopLookupsAvoided",pim->nexthop_lookups_avoided);}else{vty_out(vty,"RPFCacheRef
reshDelay:%ldmsecs\n""RPFCacheRefreshTimer:%ldmsecs\n""RPFCacheRefreshRequests:%
lld\n""RPFCacheRefreshEvents:%lld\n""RPFCacheRefreshLast:%s\n""NexthopLookups:%l
ld\n""NexthopLookupsAvoided:%lld\n",qpim_rpf_cache_refresh_delay_msec,pim_time_t
imer_remain_msec(pim->rpf_cache_refresher),(longlong)pim->rpf_cache_refresh_requ
ests,(longlong)pim->rpf_cache_refresh_events,refresh_uptime,(longlong)pim->nexth
op_lookups,(longlong)pim->nexthop_lookups_avoided);}}staticvoidshow_scan_oil_sta
ts(structpim_instance*pim,structvty*vty,time_tnow){charuptime_scan_oil[10];charu
ptime_mroute_add[10];charuptime_mroute_del[10];pim_time_uptime_begin(uptime_scan
_oil,sizeof(uptime_scan_oil),now,pim->scan_oil_last);pim_time_uptime_begin(uptim
e_mroute_add,sizeof(uptime_mroute_add),now,pim->mroute_add_last);pim_time_uptime
_begin(uptime_mroute_del,sizeof(uptime_mroute_del),now,pim->mroute_del_last);vty
_out(vty,"ScanOIL-Last:%sEvents:%lld\n""MFCAdd-Last:%sEvents:%lld\n""MFCDel-Last
:%sEvents:%lld\n",uptime_scan_oil,(longlong)pim->scan_oil_events,uptime_mroute_a
dd,(longlong)pim->mroute_add_events,uptime_mroute_del,(longlong)pim->mroute_del_
events);}staticvoidpim_show_rpf(structpim_instance*pim,structvty*vty,uint8_tuj){
structlistnode*up_node;structpim_upstream*up;time_tnow=pim_time_monotonic_sec();
json_object*json=NULL;json_object*json_group=NULL;json_object*json_row=NULL;if(u
j){json=json_object_new_object();show_rpf_refresh_stats(vty,pim,now,json);}else{
show_rpf_refresh_stats(vty,pim,now,json);vty_out(vty,"\n");vty_out(vty,"SourceGr
oupRpfIfaceRpfAddressRibNextHopMetricPref\n");}for(ALL_LIST_ELEMENTS_RO(pim->ups
tream_list,up_node,up)){charsrc_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN
];charrpf_addr_str[PREFIX_STRLEN];charrib_nexthop_str[PREFIX_STRLEN];constchar*r
pf_ifname;structpim_rpf*rpf=&up->rpf;pim_inet4_dump("<src?>",up->sg.src,src_str,
sizeof(src_str));pim_inet4_dump("<grp?>",up->sg.grp,grp_str,sizeof(grp_str));pim
_addr_dump("<rpf?>",&rpf->rpf_addr,rpf_addr_str,sizeof(rpf_addr_str));pim_addr_d
ump("<nexthop?>",&rpf->source_nexthop.mrib_nexthop_addr,rib_nexthop_str,sizeof(r
ib_nexthop_str));rpf_ifname=rpf->source_nexthop.interface?rpf->source_nexthop.in
terface->name:"<ifname?>";if(uj){json_object_object_get_ex(json,grp_str,&json_gr
oup);if(!json_group){json_group=json_object_new_object();json_object_object_add(
json,grp_str,json_group);}json_row=json_object_new_object();json_object_string_a
dd(json_row,"source",src_str);json_object_string_add(json_row,"group",grp_str);j
son_object_string_add(json_row,"rpfInterface",rpf_ifname);json_object_string_add
(json_row,"rpfAddress",rpf_addr_str);json_object_string_add(json_row,"ribNexthop
",rib_nexthop_str);json_object_int_add(json_row,"routeMetric",rpf->source_nextho
p.mrib_route_metric);json_object_int_add(json_row,"routePreference",rpf->source_
nexthop.mrib_metric_preference);json_object_object_add(json_group,src_str,json_r
ow);}else{vty_out(vty,"%-15s%-15s%-8s%-15s%-15s%6d%4d\n",src_str,grp_str,rpf_ifn
ame,rpf_addr_str,rib_nexthop_str,rpf->source_nexthop.mrib_route_metric,rpf->sour
ce_nexthop.mrib_metric_preference);}}if(uj){vty_out(vty,"%s\n",json_object_to_js
on_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}structpnc_
cache_walk_data{structvty*vty;structpim_instance*pim;};staticintpim_print_pnc_ca
che_walkcb(structhash_backet*backet,void*arg){structpim_nexthop_cache*pnc=backet
->data;structpnc_cache_walk_data*cwd=arg;structvty*vty=cwd->vty;structpim_instan
ce*pim=cwd->pim;structnexthop*nh_node=NULL;ifindex_tfirst_ifindex;structinterfac
e*ifp=NULL;if(!pnc)returnCMD_SUCCESS;for(nh_node=pnc->nexthop;nh_node;nh_node=nh
_node->next){first_ifindex=nh_node->ifindex;ifp=if_lookup_by_index(first_ifindex
,pim->vrf_id);vty_out(vty,"%-15s",inet_ntoa(pnc->rpf.rpf_addr.u.prefix4));vty_ou
t(vty,"%-14s",ifp?ifp->name:"NULL");vty_out(vty,"%s",inet_ntoa(nh_node->gate.ipv
4));vty_out(vty,"\n");}returnCMD_SUCCESS;}staticvoidpim_show_nexthop(structpim_i
nstance*pim,structvty*vty){structpnc_cache_walk_datacwd;cwd.vty=vty;cwd.pim=pim;
vty_out(vty,"Numberofregisteredaddresses:%lu\n",pim->rpf_hash->count);vty_out(vt
y,"AddressInterfaceNexthop\n");vty_out(vty,"------------------------------------
-------\n");hash_walk(pim->rpf_hash,pim_print_pnc_cache_walkcb,&cwd);}staticvoid
igmp_show_groups(structpim_instance*pim,structvty*vty,uint8_tuj){structinterface
*ifp;time_tnow;json_object*json=NULL;json_object*json_iface=NULL;json_object*jso
n_row=NULL;now=pim_time_monotonic_sec();if(uj)json=json_object_new_object();else
vty_out(vty,"InterfaceAddressGroupModeTimerSrcsVUptime\n");/*scaninterfaces*/FOR
_ALL_INTERFACES(pim->vrf,ifp){structpim_interface*pim_ifp=ifp->info;structlistno
de*sock_node;structigmp_sock*igmp;if(!pim_ifp)continue;/*scanigmpsockets*/for(AL
L_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,sock_node,igmp)){charifaddr_str[INE
T_ADDRSTRLEN];structlistnode*grpnode;structigmp_group*grp;pim_inet4_dump("<ifadd
r?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));/*scanigmpgroups*/for(ALL_LIST_
ELEMENTS_RO(igmp->igmp_group_list,grpnode,grp)){chargroup_str[INET_ADDRSTRLEN];c
harhhmmss[10];charuptime[10];pim_inet4_dump("<group?>",grp->group_addr,group_str
,sizeof(group_str));pim_time_timer_to_hhmmss(hhmmss,sizeof(hhmmss),grp->t_group_
timer);pim_time_uptime(uptime,sizeof(uptime),now-grp->group_creation);if(uj){jso
n_object_object_get_ex(json,ifp->name,&json_iface);if(!json_iface){json_iface=js
on_object_new_object();json_object_pim_ifp_add(json_iface,ifp);json_object_objec
t_add(json,ifp->name,json_iface);}json_row=json_object_new_object();json_object_
string_add(json_row,"source",ifaddr_str);json_object_string_add(json_row,"group"
,group_str);if(grp->igmp_version==3)json_object_string_add(json_row,"mode",grp->
group_filtermode_isexcl?"EXCLUDE":"INCLUDE");json_object_string_add(json_row,"ti
mer",hhmmss);json_object_int_add(json_row,"sourcesCount",grp->group_source_list?
listcount(grp->group_source_list):0);json_object_int_add(json_row,"version",grp-
>igmp_version);json_object_string_add(json_row,"uptime",uptime);json_object_obje
ct_add(json_iface,group_str,json_row);}else{vty_out(vty,"%-9s%-15s%-15s%4s%8s%4d
%d%8s\n",ifp->name,ifaddr_str,group_str,grp->igmp_version==3?(grp->group_filterm
ode_isexcl?"EXCL":"INCL"):"----",hhmmss,grp->group_source_list?listcount(grp->gr
oup_source_list):0,grp->igmp_version,uptime);}}/*scanigmpgroups*/}/*scanigmpsock
ets*/}/*scaninterfaces*/if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext
(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}staticvoidigmp_show_gro
up_retransmission(structpim_instance*pim,structvty*vty){structinterface*ifp;vty_
out(vty,"InterfaceAddressGroupRetTimerCounterRetSrcs\n");/*scaninterfaces*/FOR_A
LL_INTERFACES(pim->vrf,ifp){structpim_interface*pim_ifp=ifp->info;structlistnode
*sock_node;structigmp_sock*igmp;if(!pim_ifp)continue;/*scanigmpsockets*/for(ALL_
LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,sock_node,igmp)){charifaddr_str[INET_
ADDRSTRLEN];structlistnode*grpnode;structigmp_group*grp;pim_inet4_dump("<ifaddr?
>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));/*scanigmpgroups*/for(ALL_LIST_EL
EMENTS_RO(igmp->igmp_group_list,grpnode,grp)){chargroup_str[INET_ADDRSTRLEN];cha
rgrp_retr_mmss[10];structlistnode*src_node;structigmp_source*src;intgrp_retr_sou
rces=0;pim_inet4_dump("<group?>",grp->group_addr,group_str,sizeof(group_str));pi
m_time_timer_to_mmss(grp_retr_mmss,sizeof(grp_retr_mmss),grp->t_group_query_retr
ansmit_timer);/*countgroupsourceswithretransmissionstate*/for(ALL_LIST_ELEMENTS_
RO(grp->group_source_list,src_node,src)){if(src->source_query_retransmit_count>0
){++grp_retr_sources;}}vty_out(vty,"%-9s%-15s%-15s%-8s%7d%7d\n",ifp->name,ifaddr
_str,group_str,grp_retr_mmss,grp->group_specific_query_retransmit_count,grp_retr
_sources);}/*scanigmpgroups*/}/*scanigmpsockets*/}/*scaninterfaces*/}staticvoidi
gmp_show_sources(structpim_instance*pim,structvty*vty){structinterface*ifp;time_
tnow;now=pim_time_monotonic_sec();vty_out(vty,"InterfaceAddressGroupSourceTimerF
wdUptime\n");/*scaninterfaces*/FOR_ALL_INTERFACES(pim->vrf,ifp){structpim_interf
ace*pim_ifp=ifp->info;structlistnode*sock_node;structigmp_sock*igmp;if(!pim_ifp)
continue;/*scanigmpsockets*/for(ALL_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,s
ock_node,igmp)){charifaddr_str[INET_ADDRSTRLEN];structlistnode*grpnode;structigm
p_group*grp;pim_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str
));/*scanigmpgroups*/for(ALL_LIST_ELEMENTS_RO(igmp->igmp_group_list,grpnode,grp)
){chargroup_str[INET_ADDRSTRLEN];structlistnode*srcnode;structigmp_source*src;pi
m_inet4_dump("<group?>",grp->group_addr,group_str,sizeof(group_str));/*scangroup
sources*/for(ALL_LIST_ELEMENTS_RO(grp->group_source_list,srcnode,src)){charsourc
e_str[INET_ADDRSTRLEN];charmmss[10];charuptime[10];pim_inet4_dump("<source?>",sr
c->source_addr,source_str,sizeof(source_str));pim_time_timer_to_mmss(mmss,sizeof
(mmss),src->t_source_timer);pim_time_uptime(uptime,sizeof(uptime),now-src->sourc
e_creation);vty_out(vty,"%-9s%-15s%-15s%-15s%5s%3s%8s\n",ifp->name,ifaddr_str,gr
oup_str,source_str,mmss,IGMP_SOURCE_TEST_FORWARDING(src->source_flags)?"Y":"N",u
ptime);}/*scangroupsources*/}/*scanigmpgroups*/}/*scanigmpsockets*/}/*scaninterf
aces*/}staticvoidigmp_show_source_retransmission(structpim_instance*pim,structvt
y*vty){structinterface*ifp;vty_out(vty,"InterfaceAddressGroupSourceCounter\n");/
*scaninterfaces*/FOR_ALL_INTERFACES(pim->vrf,ifp){structpim_interface*pim_ifp=if
p->info;structlistnode*sock_node;structigmp_sock*igmp;if(!pim_ifp)continue;/*sca
nigmpsockets*/for(ALL_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_list,sock_node,igmp)
){charifaddr_str[INET_ADDRSTRLEN];structlistnode*grpnode;structigmp_group*grp;pi
m_inet4_dump("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));/*scanigmpg
roups*/for(ALL_LIST_ELEMENTS_RO(igmp->igmp_group_list,grpnode,grp)){chargroup_st
r[INET_ADDRSTRLEN];structlistnode*srcnode;structigmp_source*src;pim_inet4_dump("
<group?>",grp->group_addr,group_str,sizeof(group_str));/*scangroupsources*/for(A
LL_LIST_ELEMENTS_RO(grp->group_source_list,srcnode,src)){charsource_str[INET_ADD
RSTRLEN];pim_inet4_dump("<source?>",src->source_addr,source_str,sizeof(source_st
r));vty_out(vty,"%-9s%-15s%-15s%-15s%7d\n",ifp->name,ifaddr_str,group_str,source
_str,src->source_query_retransmit_count);}/*scangroupsources*/}/*scanigmpgroups*
/}/*scanigmpsockets*/}/*scaninterfaces*/}staticvoidclear_igmp_interfaces(structp
im_instance*pim){structinterface*ifp;FOR_ALL_INTERFACES(pim->vrf,ifp)pim_if_addr
_del_all_igmp(ifp);FOR_ALL_INTERFACES(pim->vrf,ifp)pim_if_addr_add_all(ifp);}sta
ticvoidclear_pim_interfaces(structpim_instance*pim){structinterface*ifp;FOR_ALL_
INTERFACES(pim->vrf,ifp){if(ifp->info){pim_neighbor_delete_all(ifp,"interfacecle
ared");}}}staticvoidclear_interfaces(structpim_instance*pim){clear_igmp_interfac
es(pim);clear_pim_interfaces(pim);}#definePIM_GET_PIM_INTERFACE(pim_ifp,ifp)\pim
_ifp=ifp->info;\if(!pim_ifp){\vty_out(vty,\"%%EnablePIMand/orIGMPonthisinterface
first\n");\returnCMD_WARNING_CONFIG_FAILED;\}DEFUN(clear_ip_interfaces,clear_ip_
interfaces_cmd,"clearipinterfaces[vrfNAME]",CLEAR_STRIP_STR"Resetinterfaces\n"VR
F_CMD_HELP_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if
(!vrf)returnCMD_WARNING;clear_interfaces(vrf->info);returnCMD_SUCCESS;}DEFUN(cle
ar_ip_igmp_interfaces,clear_ip_igmp_interfaces_cmd,"clearipigmp[vrfNAME]interfac
es",CLEAR_STRIP_STRCLEAR_IP_IGMP_STRVRF_CMD_HELP_STR"ResetIGMPinterfaces\n"){int
idx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WAR
NING;clear_igmp_interfaces(vrf->info);returnCMD_SUCCESS;}staticvoidmroute_add_al
l(structpim_instance*pim){structlistnode*node;structchannel_oil*c_oil;for(ALL_LI
ST_ELEMENTS_RO(pim->channel_oil_list,node,c_oil)){if(pim_mroute_add(c_oil,__PRET
TY_FUNCTION__)){/*justlogwarning*/charsource_str[INET_ADDRSTRLEN];chargroup_str[
INET_ADDRSTRLEN];pim_inet4_dump("<source?>",c_oil->oil.mfcc_origin,source_str,si
zeof(source_str));pim_inet4_dump("<group?>",c_oil->oil.mfcc_mcastgrp,group_str,s
izeof(group_str));zlog_warn("%s%s:(S,G)=(%s,%s)failurewritingMFC",__FILE__,__PRE
TTY_FUNCTION__,source_str,group_str);}}}staticvoidmroute_del_all(structpim_insta
nce*pim){structlistnode*node;structchannel_oil*c_oil;for(ALL_LIST_ELEMENTS_RO(pi
m->channel_oil_list,node,c_oil)){if(pim_mroute_del(c_oil,__PRETTY_FUNCTION__)){/
*justlogwarning*/charsource_str[INET_ADDRSTRLEN];chargroup_str[INET_ADDRSTRLEN];
pim_inet4_dump("<source?>",c_oil->oil.mfcc_origin,source_str,sizeof(source_str))
;pim_inet4_dump("<group?>",c_oil->oil.mfcc_mcastgrp,group_str,sizeof(group_str))
;zlog_warn("%s%s:(S,G)=(%s,%s)failureclearingMFC",__FILE__,__PRETTY_FUNCTION__,s
ource_str,group_str);}}}DEFUN(clear_ip_mroute,clear_ip_mroute_cmd,"clearipmroute
[vrfNAME]",CLEAR_STRIP_STR"Resetmulticastroutes\n"VRF_CMD_HELP_STR){intidx=2;str
uctvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;mrou
te_del_all(vrf->info);mroute_add_all(vrf->info);returnCMD_SUCCESS;}DEFUN(clear_i
p_pim_interfaces,clear_ip_pim_interfaces_cmd,"clearippim[vrfNAME]interfaces",CLE
AR_STRIP_STRCLEAR_IP_PIM_STRVRF_CMD_HELP_STR"ResetPIMinterfaces\n"){intidx=2;str
uctvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;clea
r_pim_interfaces(vrf->info);returnCMD_SUCCESS;}DEFUN(clear_ip_pim_interface_traf
fic,clear_ip_pim_interface_traffic_cmd,"clearippim[vrfNAME]interfacetraffic","Re
setfunctions\n""IPinformation\n""PIMclearcommands\n"VRF_CMD_HELP_STR"ResetPIMint
erfaces\n""ResetProtocolPacketcounters\n"){intidx=2;structvrf*vrf=pim_cmd_lookup
_vrf(vty,argv,argc,&idx);structinterface*ifp=NULL;structpim_interface*pim_ifp=NU
LL;if(!vrf)returnCMD_WARNING;FOR_ALL_INTERFACES(vrf,ifp){pim_ifp=ifp->info;if(!p
im_ifp)continue;pim_ifp->pim_ifstat_hello_recv=0;pim_ifp->pim_ifstat_hello_sent=
0;pim_ifp->pim_ifstat_join_recv=0;pim_ifp->pim_ifstat_join_send=0;pim_ifp->pim_i
fstat_prune_recv=0;pim_ifp->pim_ifstat_prune_send=0;pim_ifp->pim_ifstat_reg_recv
=0;pim_ifp->pim_ifstat_reg_send=0;pim_ifp->pim_ifstat_reg_stop_recv=0;pim_ifp->p
im_ifstat_reg_stop_send=0;pim_ifp->pim_ifstat_assert_recv=0;pim_ifp->pim_ifstat_
assert_send=0;}returnCMD_SUCCESS;}DEFUN(clear_ip_pim_oil,clear_ip_pim_oil_cmd,"c
learippim[vrfNAME]oil",CLEAR_STRIP_STRCLEAR_IP_PIM_STRVRF_CMD_HELP_STR"RescanPIM
OIL(outputinterfacelist)\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,
argc,&idx);if(!vrf)returnCMD_WARNING;pim_scan_oil(vrf->info);returnCMD_SUCCESS;}
DEFUN(show_ip_igmp_interface,show_ip_igmp_interface_cmd,"showipigmp[vrfNAME]inte
rface[detail|WORD][json]",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STR"IGMPinterfacein
formation\n""Detailedoutput\n""interfacename\n"JSON_STR){intidx=2;structvrf*vrf=
pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)ret
urnCMD_WARNING;if(argv_find(argv,argc,"detail",&idx)||argv_find(argv,argc,"WORD"
,&idx))igmp_show_interfaces_single(vrf->info,vty,argv[idx]->arg,uj);elseigmp_sho
w_interfaces(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_igmp_interface_v
rf_all,show_ip_igmp_interface_vrf_all_cmd,"showipigmpvrfallinterface[detail|WORD
][json]",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STR"IGMPinterfaceinformation\n""Deta
iledoutput\n""interfacename\n"JSON_STR){intidx=2;uint8_tuj=use_json(argc,argv);s
tructvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf_name_head,
&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",vrf->name
);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);if(argv_find(argv,argc,"det
ail",&idx)||argv_find(argv,argc,"WORD",&idx))igmp_show_interfaces_single(vrf->in
fo,vty,argv[idx]->arg,uj);elseigmp_show_interfaces(vrf->info,vty,uj);}if(uj)vty_
out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(show_ip_igmp_join,show_ip_igmp_join_cmd,
"showipigmp[vrfNAME]join",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STR"IGMPstaticjoini
nformation\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(
!vrf)returnCMD_WARNING;igmp_show_interface_join(vrf->info,vty);returnCMD_SUCCESS
;}DEFUN(show_ip_igmp_join_vrf_all,show_ip_igmp_join_vrf_all_cmd,"showipigmpvrfal
ljoin",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STR"IGMPstaticjoininformation\n"){uint
8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB
_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_
out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);
igmp_show_interface_join(vrf->info,vty);}if(uj)vty_out(vty,"}\n");returnCMD_SUCC
ESS;}DEFUN(show_ip_igmp_groups,show_ip_igmp_groups_cmd,"showipigmp[vrfNAME]group
s[json]",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STRIGMP_GROUP_STRJSON_STR){intidx=2;
structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,arg
v);if(!vrf)returnCMD_WARNING;igmp_show_groups(vrf->info,vty,uj);returnCMD_SUCCES
S;}DEFUN(show_ip_igmp_groups_vrf_all,show_ip_igmp_groups_vrf_all_cmd,"showipigmp
vrfallgroups[json]",SHOW_STRIP_STRIGMP_STRVRF_CMD_HELP_STRIGMP_GROUP_STRJSON_STR
){uint8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"
{");RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,","
);vty_out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->
name);igmp_show_groups(vrf->info,vty,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUC
CESS;}DEFUN(show_ip_igmp_groups_retransmissions,show_ip_igmp_groups_retransmissi
ons_cmd,"showipigmp[vrfNAME]groupsretransmissions",SHOW_STRIP_STRIGMP_STRVRF_CMD
_HELP_STRIGMP_GROUP_STR"IGMPgroupretransmissions\n"){intidx=2;structvrf*vrf=pim_
cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;igmp_show_group_ret
ransmission(vrf->info,vty);returnCMD_SUCCESS;}DEFUN(show_ip_igmp_sources,show_ip
_igmp_sources_cmd,"showipigmp[vrfNAME]sources",SHOW_STRIP_STRIGMP_STRVRF_CMD_HEL
P_STRIGMP_SOURCE_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&i
dx);if(!vrf)returnCMD_WARNING;igmp_show_sources(vrf->info,vty);returnCMD_SUCCESS
;}DEFUN(show_ip_igmp_sources_retransmissions,show_ip_igmp_sources_retransmission
s_cmd,"showipigmp[vrfNAME]sourcesretransmissions",SHOW_STRIP_STRIGMP_STRVRF_CMD_
HELP_STRIGMP_SOURCE_STR"IGMPsourceretransmissions\n"){intidx=2;structvrf*vrf=pim
_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;igmp_show_source_r
etransmission(vrf->info,vty);returnCMD_SUCCESS;}DEFUN(show_ip_pim_assert,show_ip
_pim_assert_cmd,"showippim[vrfNAME]assert",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR
"PIMinterfaceassert\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,
&idx);if(!vrf)returnCMD_WARNING;pim_show_assert(vrf->info,vty);returnCMD_SUCCESS
;}DEFUN(show_ip_pim_assert_internal,show_ip_pim_assert_internal_cmd,"showippim[v
rfNAME]assert-internal",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterfaceintern
alassertstate\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);
if(!vrf)returnCMD_WARNING;pim_show_assert_internal(vrf->info,vty);returnCMD_SUCC
ESS;}DEFUN(show_ip_pim_assert_metric,show_ip_pim_assert_metric_cmd,"showippim[vr
fNAME]assert-metric",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterfaceassertmet
ric\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)re
turnCMD_WARNING;pim_show_assert_metric(vrf->info,vty);returnCMD_SUCCESS;}DEFUN(s
how_ip_pim_assert_winner_metric,show_ip_pim_assert_winner_metric_cmd,"showippim[
vrfNAME]assert-winner-metric",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterface
assertwinnermetric\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&
idx);if(!vrf)returnCMD_WARNING;pim_show_assert_winner_metric(vrf->info,vty);retu
rnCMD_SUCCESS;}DEFUN(show_ip_pim_interface,show_ip_pim_interface_cmd,"showippim[
vrfNAME]interface[detail|WORD][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMi
nterfaceinformation\n""Detailedoutput\n""interfacename\n"JSON_STR){intidx=2;stru
ctvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);i
f(!vrf)returnCMD_WARNING;if(argv_find(argv,argc,"WORD",&idx)||argv_find(argv,arg
c,"detail",&idx))pim_show_interfaces_single(vrf->info,vty,argv[idx]->arg,uj);els
epim_show_interfaces(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim_inte
rface_vrf_all,show_ip_pim_interface_vrf_all_cmd,"showippimvrfallinterface[detail
|WORD][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterfaceinformation\n""D
etailedoutput\n""interfacename\n"JSON_STR){intidx=6;uint8_tuj=use_json(argc,argv
);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf_name_he
ad,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",vrf->n
ame);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);if(argv_find(argv,argc,"
WORD",&idx)||argv_find(argv,argc,"detail",&idx))pim_show_interfaces_single(vrf->
info,vty,argv[idx]->arg,uj);elsepim_show_interfaces(vrf->info,vty,uj);}if(uj)vty
_out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(show_ip_pim_join,show_ip_pim_join_cmd,"
showippim[vrfNAME]join[json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterface
joininformation\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,a
rgc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNING;pim_show_join(
vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim_join_vrf_all,show_ip_pim_
join_vrf_all_cmd,"showippimvrfalljoin[json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_S
TR"PIMinterfacejoininformation\n"JSON_STR){uint8_tuj=use_json(argc,argv);structv
rf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf_name_head,&vrfs_
by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",vrf->name);firs
t=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);pim_show_join(vrf->info,vty,uj);}
if(uj)vty_out(vty,"}\n");returnCMD_WARNING;}DEFUN(show_ip_pim_local_membership,s
how_ip_pim_local_membership_cmd,"showippim[vrfNAME]local-membership[json]",SHOW_
STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterfacelocal-membership\n"JSON_STR){intidx
=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,
argv);if(!vrf)returnCMD_WARNING;pim_show_membership(vrf->info,vty,uj);returnCMD_
SUCCESS;}DEFUN(show_ip_pim_neighbor,show_ip_pim_neighbor_cmd,"showippim[vrfNAME]
neighbor[detail|WORD][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMneighborin
formation\n""Detailedoutput\n""Nameofinterfaceorneighbor\n"JSON_STR){intidx=2;st
ructvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv)
;if(!vrf)returnCMD_WARNING;if(argv_find(argv,argc,"detail",&idx)||argv_find(argv
,argc,"WORD",&idx))pim_show_neighbors_single(vrf->info,vty,argv[idx]->arg,uj);el
sepim_show_neighbors(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim_neig
hbor_vrf_all,show_ip_pim_neighbor_vrf_all_cmd,"showippimvrfallneighbor[detail|WO
RD][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMneighborinformation\n""Detai
ledoutput\n""Nameofinterfaceorneighbor\n"JSON_STR){intidx=2;uint8_tuj=use_json(a
rgc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf
_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":
",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);if(argv_find(arg
v,argc,"detail",&idx)||argv_find(argv,argc,"WORD",&idx))pim_show_neighbors_singl
e(vrf->info,vty,argv[idx]->arg,uj);elsepim_show_neighbors(vrf->info,vty,uj);}if(
uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(show_ip_pim_secondary,show_ip_pim
_secondary_cmd,"showippim[vrfNAME]secondary",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_S
TR"PIMneighboraddresses\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,a
rgc,&idx);if(!vrf)returnCMD_WARNING;pim_show_neighbors_secondary(vrf->info,vty);
returnCMD_SUCCESS;}DEFUN(show_ip_pim_state,show_ip_pim_state_cmd,"showippim[vrfN
AME]state[A.B.C.D[A.B.C.D]][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMstat
einformation\n""UnicastorMulticastaddress\n""Multicastaddress\n"JSON_STR){constc
har*src_or_group=NULL;constchar*group=NULL;intidx=2;structvrf*vrf=pim_cmd_lookup
_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNING
;if(uj)argc--;if(argv_find(argv,argc,"A.B.C.D",&idx)){src_or_group=argv[idx]->ar
g;if(idx+1<argc)group=argv[idx+1]->arg;}pim_show_state(vrf->info,vty,src_or_grou
p,group,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim_state_vrf_all,show_ip_pim_state
_vrf_all_cmd,"showippimvrfallstate[A.B.C.D[A.B.C.D]][json]",SHOW_STRIP_STRPIM_ST
RVRF_CMD_HELP_STR"PIMstateinformation\n""UnicastorMulticastaddress\n""Multicasta
ddress\n"JSON_STR){constchar*src_or_group=NULL;constchar*group=NULL;intidx=2;uin
t8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj){vty_out(vty,"{");
argc--;}if(argv_find(argv,argc,"A.B.C.D",&idx)){src_or_group=argv[idx]->arg;if(i
dx+1<argc)group=argv[idx+1]->arg;}RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if
(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",vrf->name);first=false;}el
sevty_out(vty,"VRF:%s\n",vrf->name);pim_show_state(vrf->info,vty,src_or_group,gr
oup,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(show_ip_pim_upstream,
show_ip_pim_upstream_cmd,"showippim[vrfNAME]upstream[json]",SHOW_STRIP_STRPIM_ST
RVRF_CMD_HELP_STR"PIMupstreaminformation\n"JSON_STR){intidx=2;structvrf*vrf=pim_
cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnC
MD_WARNING;pim_show_upstream(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_
pim_upstream_vrf_all,show_ip_pim_upstream_vrf_all_cmd,"showippimvrfallupstream[j
son]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMupstreaminformation\n"JSON_STR){u
int8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{")
;RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");v
ty_out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->nam
e);pim_show_upstream(vrf->info,vty,uj);}returnCMD_SUCCESS;}DEFUN(show_ip_pim_ups
tream_join_desired,show_ip_pim_upstream_join_desired_cmd,"showippim[vrfNAME]upst
ream-join-desired[json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMupstreamjoin-d
esired\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx)
;uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNING;pim_show_join_desired(v
rf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim_upstream_rpf,show_ip_pim_u
pstream_rpf_cmd,"showippim[vrfNAME]upstream-rpf[json]",SHOW_STRIP_STRPIM_STRVRF_
CMD_HELP_STR"PIMupstreamsourcerpf\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_loo
kup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARN
ING;pim_show_upstream_rpf(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim
_rp,show_ip_pim_rp_cmd,"showippim[vrfNAME]rp-info[json]",SHOW_STRIP_STRPIM_STRVR
F_CMD_HELP_STR"PIMRPinformation\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_looku
p_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNIN
G;pim_rp_show_information(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_pim
_rp_vrf_all,show_ip_pim_rp_vrf_all_cmd,"showippimvrfallrp-info[json]",SHOW_STRIP
_STRPIM_STRVRF_CMD_HELP_STR"PIMRPinformation\n"JSON_STR){uint8_tuj=use_json(argc
,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf_na
me_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",v
rf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);pim_rp_show_informa
tion(vrf->info,vty,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(show_i
p_pim_rpf,show_ip_pim_rpf_cmd,"showippim[vrfNAME]rpf[json]",SHOW_STRIP_STRPIM_ST
RVRF_CMD_HELP_STR"PIMcachedsourcerpfinformation\n"JSON_STR){intidx=2;structvrf*v
rf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)
returnCMD_WARNING;pim_show_rpf(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_i
p_pim_rpf_vrf_all,show_ip_pim_rpf_vrf_all_cmd,"showippimvrfallrpf[json]",SHOW_ST
RIP_STRPIM_STRVRF_CMD_HELP_STR"PIMcachedsourcerpfinformation\n"JSON_STR){uint8_t
uj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FO
REACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out
(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);pim
_show_rpf(vrf->info,vty,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}DEFUN(s
how_ip_pim_nexthop,show_ip_pim_nexthop_cmd,"showippim[vrfNAME]nexthop",SHOW_STRI
P_STRPIM_STRVRF_CMD_HELP_STR"PIMcachednexthoprpfinformation\n"){intidx=2;structv
rf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;pim_show
_nexthop(vrf->info,vty);returnCMD_SUCCESS;}DEFUN(show_ip_pim_nexthop_lookup,show
_ip_pim_nexthop_lookup_cmd,"showippim[vrfNAME]nexthop-lookupA.B.C.DA.B.C.D",SHOW
_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMcachednexthoprpflookup\n""Source/RPaddress\
n""MulticastGroupaddress\n"){structpim_nexthop_cachepnc;structprefixnht_p;intres
ult=0;structin_addrsrc_addr,grp_addr;structin_addrvif_source;constchar*addr_str,
*addr_str1;structprefixgrp;structpim_nexthopnexthop;charnexthop_addr_str[PREFIX_
STRLEN];chargrp_str[PREFIX_STRLEN];intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty
,argv,argc,&idx);if(!vrf)returnCMD_WARNING;argv_find(argv,argc,"A.B.C.D",&idx);a
ddr_str=argv[idx]->arg;result=inet_pton(AF_INET,addr_str,&src_addr);if(result<=0
){vty_out(vty,"Badunicastaddress%s:errno=%d:%s\n",addr_str,errno,safe_strerror(e
rrno));returnCMD_WARNING;}if(pim_is_group_224_4(src_addr)){vty_out(vty,"Invalida
rgument.ExpectedValidSourceAddress.\n");returnCMD_WARNING;}addr_str1=argv[idx+1]
->arg;result=inet_pton(AF_INET,addr_str1,&grp_addr);if(result<=0){vty_out(vty,"B
adunicastaddress%s:errno=%d:%s\n",addr_str,errno,safe_strerror(errno));returnCMD
_WARNING;}if(!pim_is_group_224_4(grp_addr)){vty_out(vty,"Invalidargument.Expecte
dValidMulticastGroupAddress.\n");returnCMD_WARNING;}if(!pim_rp_set_upstream_addr
(vrf->info,&vif_source,src_addr,grp_addr))returnCMD_SUCCESS;memset(&pnc,0,sizeof
(structpim_nexthop_cache));nht_p.family=AF_INET;nht_p.prefixlen=IPV4_MAX_BITLEN;
nht_p.u.prefix4=vif_source;grp.family=AF_INET;grp.prefixlen=IPV4_MAX_BITLEN;grp.
u.prefix4=grp_addr;memset(&nexthop,0,sizeof(nexthop));if(pim_find_or_track_nexth
op(vrf->info,&nht_p,NULL,NULL,&pnc))result=pim_ecmp_nexthop_search(vrf->info,&pn
c,&nexthop,&nht_p,&grp,0);elseresult=pim_ecmp_nexthop_lookup(vrf->info,&nexthop,
vif_source,&nht_p,&grp,0);if(!result){vty_out(vty,"NexthopLookupfailed,nousabler
outesreturned.\n");returnCMD_SUCCESS;}pim_addr_dump("<grp?>",&grp,grp_str,sizeof
(grp_str));pim_addr_dump("<nexthop?>",&nexthop.mrib_nexthop_addr,nexthop_addr_st
r,sizeof(nexthop_addr_str));vty_out(vty,"Group%s---Nexthop%sInterface%s\n",grp_s
tr,nexthop_addr_str,nexthop.interface->name);returnCMD_SUCCESS;}DEFUN(show_ip_pi
m_interface_traffic,show_ip_pim_interface_traffic_cmd,"showippim[vrfNAME]interfa
cetraffic[WORD][json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMinterfaceinforma
tion\n""ProtocolPacketcounters\n""Interfacename\n"JSON_STR){intidx=2;structvrf*v
rf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)
returnCMD_WARNING;if(argv_find(argv,argc,"WORD",&idx))pim_show_interface_traffic
_single(vrf->info,vty,argv[idx]->arg,uj);elsepim_show_interface_traffic(vrf->inf
o,vty,uj);returnCMD_SUCCESS;}staticvoidshow_multicast_interfaces(structpim_insta
nce*pim,structvty*vty){structinterface*ifp;vty_out(vty,"\n");vty_out(vty,"Interf
aceAddressifiVifPktsInPktsOutBytesInBytesOut\n");FOR_ALL_INTERFACES(pim->vrf,ifp
){structpim_interface*pim_ifp;structin_addrifaddr;structsioc_vif_reqvreq;pim_ifp
=ifp->info;if(!pim_ifp)continue;memset(&vreq,0,sizeof(vreq));vreq.vifi=pim_ifp->
mroute_vif_index;if(ioctl(pim->mroute_socket,SIOCGETVIFCNT,&vreq)){zlog_warn("io
ctl(SIOCGETVIFCNT=%lu)failureforinterface%svif_index=%d:errno=%d:%s",(unsignedlo
ng)SIOCGETVIFCNT,ifp->name,pim_ifp->mroute_vif_index,errno,safe_strerror(errno))
;}ifaddr=pim_ifp->primary_address;vty_out(vty,"%-12s%-15s%3d%3d%7lu%7lu%10lu%10l
u\n",ifp->name,inet_ntoa(ifaddr),ifp->ifindex,pim_ifp->mroute_vif_index,(unsigne
dlong)vreq.icount,(unsignedlong)vreq.ocount,(unsignedlong)vreq.ibytes,(unsignedl
ong)vreq.obytes);}}staticvoidpim_cmd_show_ip_multicast_helper(structpim_instance
*pim,structvty*vty){structvrf*vrf=pim->vrf;time_tnow=pim_time_monotonic_sec();ch
aruptime[10];pim=vrf->info;vty_out(vty,"Mroutesocketdescriptor:");vty_out(vty,"%
d(%s)\n",pim->mroute_socket,vrf->name);pim_time_uptime(uptime,sizeof(uptime),now
-pim->mroute_socket_creation);vty_out(vty,"Mroutesocketuptime:%s\n",uptime);vty_
out(vty,"\n");pim_zebra_zclient_update(vty);pim_zlookup_show_ip_multicast(vty);v
ty_out(vty,"\n");vty_out(vty,"MaximumhighestVifIndex:%d\n",PIM_MAX_USABLE_VIFS);
vty_out(vty,"\n");vty_out(vty,"UpstreamJoinTimer:%dsecs\n",qpim_t_periodic);vty_
out(vty,"Join/PruneHoldtime:%dsecs\n",PIM_JP_HOLDTIME);vty_out(vty,"PIMECMP:%s\n
",qpim_ecmp_enable?"Enable":"Disable");vty_out(vty,"PIMECMPRebalance:%s\n",qpim_
ecmp_rebalance_enable?"Enable":"Disable");vty_out(vty,"\n");show_rpf_refresh_sta
ts(vty,pim,now,NULL);vty_out(vty,"\n");show_scan_oil_stats(pim,vty,now);show_mul
ticast_interfaces(pim,vty);}DEFUN(show_ip_multicast,show_ip_multicast_cmd,"showi
pmulticast[vrfNAME]",SHOW_STRIP_STRVRF_CMD_HELP_STR"Multicastglobalinformation\n
"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnC
MD_WARNING;pim_cmd_show_ip_multicast_helper(vrf->info,vty);returnCMD_SUCCESS;}DE
FUN(show_ip_multicast_vrf_all,show_ip_multicast_vrf_all_cmd,"showipmulticastvrfa
ll",SHOW_STRIP_STRVRF_CMD_HELP_STR"Multicastglobalinformation\n"){uint8_tuj=use_
json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_FOREACH(v
rf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\
"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);pim_cmd_sh
ow_ip_multicast_helper(vrf->info,vty);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCES
S;}staticvoidshow_mroute(structpim_instance*pim,structvty*vty,boolfill,uint8_tuj
){structlistnode*node;structchannel_oil*c_oil;structstatic_route*s_route;time_tn
ow;json_object*json=NULL;json_object*json_group=NULL;json_object*json_source=NUL
L;json_object*json_oil=NULL;json_object*json_ifp_out=NULL;intfound_oif=0;intfirs
t=1;chargrp_str[INET_ADDRSTRLEN];charsrc_str[INET_ADDRSTRLEN];charin_ifname[INTE
RFACE_NAMSIZ+1];charout_ifname[INTERFACE_NAMSIZ+1];intoif_vif_index;structinterf
ace*ifp_in;charproto[100];if(uj){json=json_object_new_object();}else{vty_out(vty
,"SourceGroupProtoInputOutputTTLUptime\n");}now=pim_time_monotonic_sec();/*print
listofPIMandIGMProutes*/for(ALL_LIST_ELEMENTS_RO(pim->channel_oil_list,node,c_oi
l)){found_oif=0;first=1;if(!c_oil->installed&&!uj)continue;pim_inet4_dump("<grou
p?>",c_oil->oil.mfcc_mcastgrp,grp_str,sizeof(grp_str));pim_inet4_dump("<source?>
",c_oil->oil.mfcc_origin,src_str,sizeof(src_str));ifp_in=pim_if_find_by_vif_inde
x(pim,c_oil->oil.mfcc_parent);if(ifp_in)strcpy(in_ifname,ifp_in->name);elsestrcp
y(in_ifname,"<iif?>");if(uj){/*Findthegroup,createitifitdoesn'texist*/json_objec
t_object_get_ex(json,grp_str,&json_group);if(!json_group){json_group=json_object
_new_object();json_object_object_add(json,grp_str,json_group);}/*Findthesourcene
stedunderthegroup,createitif*itdoesn'texist*/json_object_object_get_ex(json_grou
p,src_str,&json_source);if(!json_source){json_source=json_object_new_object();js
on_object_object_add(json_group,src_str,json_source);}/*Findtheinboundinterfacen
estedunderthesource,*createitifitdoesn'texist*/json_object_int_add(json_source,"
installed",c_oil->installed);json_object_int_add(json_source,"refCount",c_oil->o
il_ref_count);json_object_int_add(json_source,"oilSize",c_oil->oil_size);json_ob
ject_int_add(json_source,"OilInheritedRescan",c_oil->oil_inherited_rescan);json_
object_string_add(json_source,"iif",in_ifname);json_oil=NULL;}for(oif_vif_index=
0;oif_vif_index<MAXVIFS;++oif_vif_index){structinterface*ifp_out;charoif_uptime[
10];intttl;ttl=c_oil->oil.mfcc_ttls[oif_vif_index];if(ttl<1)continue;ifp_out=pim
_if_find_by_vif_index(pim,oif_vif_index);pim_time_uptime(oif_uptime,sizeof(oif_u
ptime),now-c_oil->oif_creation[oif_vif_index]);found_oif=1;if(ifp_out)strcpy(out
_ifname,ifp_out->name);elsestrcpy(out_ifname,"<oif?>");if(uj){json_ifp_out=json_
object_new_object();json_object_string_add(json_ifp_out,"source",src_str);json_o
bject_string_add(json_ifp_out,"group",grp_str);if(c_oil->oif_flags[oif_vif_index
]&PIM_OIF_FLAG_PROTO_PIM)json_object_boolean_true_add(json_ifp_out,"protocolPim"
);if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_IGMP)json_object_boolean
_true_add(json_ifp_out,"protocolIgmp");if(c_oil->oif_flags[oif_vif_index]&PIM_OI
F_FLAG_PROTO_SOURCE)json_object_boolean_true_add(json_ifp_out,"protocolSource");
if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_STAR)json_object_boolean_t
rue_add(json_ifp_out,"protocolInherited");json_object_string_add(json_ifp_out,"i
nboundInterface",in_ifname);json_object_int_add(json_ifp_out,"iVifI",c_oil->oil.
mfcc_parent);json_object_string_add(json_ifp_out,"outboundInterface",out_ifname)
;json_object_int_add(json_ifp_out,"oVifI",oif_vif_index);json_object_int_add(jso
n_ifp_out,"ttl",ttl);json_object_string_add(json_ifp_out,"upTime",oif_uptime);if
(!json_oil){json_oil=json_object_new_object();json_object_object_add(json_source
,"oil",json_oil);}json_object_object_add(json_oil,out_ifname,json_ifp_out);}else
{if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_PIM){strcpy(proto,"PIM");
}if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_IGMP){strcpy(proto,"IGMP"
);}if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_SOURCE){strcpy(proto,"S
RC");}if(c_oil->oif_flags[oif_vif_index]&PIM_OIF_FLAG_PROTO_STAR){strcpy(proto,"
STAR");}vty_out(vty,"%-15s%-15s%-6s%-10s%-10s%-3d%8s\n",src_str,grp_str,proto,in
_ifname,out_ifname,ttl,oif_uptime);if(first){src_str[0]='\0';grp_str[0]='\0';in_
ifname[0]='\0';first=0;}}}if(!uj&&!found_oif){vty_out(vty,"%-15s%-15s%-6s%-10s%-
10s%-3d%8s\n",src_str,grp_str,"none",in_ifname,"none",0,"--:--:--");}}/*Printlis
tofstaticroutes*/for(ALL_LIST_ELEMENTS_RO(pim->static_routes,node,s_route)){firs
t=1;if(!s_route->c_oil.installed)continue;pim_inet4_dump("<group?>",s_route->gro
up,grp_str,sizeof(grp_str));pim_inet4_dump("<source?>",s_route->source,src_str,s
izeof(src_str));ifp_in=pim_if_find_by_vif_index(pim,s_route->iif);found_oif=0;if
(ifp_in)strcpy(in_ifname,ifp_in->name);elsestrcpy(in_ifname,"<iif?>");if(uj){/*F
indthegroup,createitifitdoesn'texist*/json_object_object_get_ex(json,grp_str,&js
on_group);if(!json_group){json_group=json_object_new_object();json_object_object
_add(json,grp_str,json_group);}/*Findthesourcenestedunderthegroup,createitif*itd
oesn'texist*/json_object_object_get_ex(json_group,src_str,&json_source);if(!json
_source){json_source=json_object_new_object();json_object_object_add(json_group,
src_str,json_source);}json_object_string_add(json_source,"iif",in_ifname);json_o
il=NULL;}else{strcpy(proto,"STATIC");}for(oif_vif_index=0;oif_vif_index<MAXVIFS;
++oif_vif_index){structinterface*ifp_out;charoif_uptime[10];intttl;ttl=s_route->
oif_ttls[oif_vif_index];if(ttl<1)continue;ifp_out=pim_if_find_by_vif_index(pim,o
if_vif_index);pim_time_uptime(oif_uptime,sizeof(oif_uptime),now-s_route->c_oil.o
if_creation[oif_vif_index]);found_oif=1;if(ifp_out)strcpy(out_ifname,ifp_out->na
me);elsestrcpy(out_ifname,"<oif?>");if(uj){json_ifp_out=json_object_new_object()
;json_object_string_add(json_ifp_out,"source",src_str);json_object_string_add(js
on_ifp_out,"group",grp_str);json_object_boolean_true_add(json_ifp_out,"protocolS
tatic");json_object_string_add(json_ifp_out,"inboundInterface",in_ifname);json_o
bject_int_add(json_ifp_out,"iVifI",s_route->c_oil.oil.mfcc_parent);json_object_s
tring_add(json_ifp_out,"outboundInterface",out_ifname);json_object_int_add(json_
ifp_out,"oVifI",oif_vif_index);json_object_int_add(json_ifp_out,"ttl",ttl);json_
object_string_add(json_ifp_out,"upTime",oif_uptime);if(!json_oil){json_oil=json_
object_new_object();json_object_object_add(json_source,"oil",json_oil);}json_obj
ect_object_add(json_oil,out_ifname,json_ifp_out);}else{vty_out(vty,"%-15s%-15s%-
6s%-10s%-10s%-3d%8s%s\n",src_str,grp_str,proto,in_ifname,out_ifname,ttl,oif_upti
me,pim->vrf->name);if(first&&!fill){src_str[0]='\0';grp_str[0]='\0';in_ifname[0]
='\0';first=0;}}}if(!uj&&!found_oif){vty_out(vty,"%-15s%-15s%-6s%-10s%-10s%-3d%8
s%s\n",src_str,grp_str,proto,in_ifname,"none",0,"--:--:--",pim->vrf->name);}}if(
uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRET
TY));json_object_free(json);}}DEFUN(show_ip_mroute,show_ip_mroute_cmd,"showipmro
ute[vrfNAME][fill][json]",SHOW_STRIP_STRMROUTE_STRVRF_CMD_HELP_STR"FillinAssumed
data\n"JSON_STR){uint8_tuj=use_json(argc,argv);boolfill=false;intidx=2;structvrf
*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;if(argv_fi
nd(argv,argc,"fill",&idx))fill=true;show_mroute(vrf->info,vty,fill,uj);returnCMD
_SUCCESS;}DEFUN(show_ip_mroute_vrf_all,show_ip_mroute_vrf_all_cmd,"showipmroutev
rfall[fill][json]",SHOW_STRIP_STRMROUTE_STRVRF_CMD_HELP_STR"FillinAssumeddata\n"
JSON_STR){uint8_tuj=use_json(argc,argv);intidx=4;structvrf*vrf;boolfirst=true;bo
olfill=false;if(argv_find(argv,argc,"fill",&idx))fill=true;if(uj)vty_out(vty,"{"
);RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");
vty_out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->na
me);show_mroute(vrf->info,vty,fill,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCE
SS;}staticvoidshow_mroute_count(structpim_instance*pim,structvty*vty){structlist
node*node;structchannel_oil*c_oil;structstatic_route*s_route;vty_out(vty,"\n");v
ty_out(vty,"SourceGroupLastUsedPacketsBytesWrongIf\n");/*PrintPIMandIGMProutecou
nts*/for(ALL_LIST_ELEMENTS_RO(pim->channel_oil_list,node,c_oil)){chargroup_str[I
NET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];if(!c_oil->installed)continue;pi
m_mroute_update_counters(c_oil);pim_inet4_dump("<group?>",c_oil->oil.mfcc_mcastg
rp,group_str,sizeof(group_str));pim_inet4_dump("<source?>",c_oil->oil.mfcc_origi
n,source_str,sizeof(source_str));vty_out(vty,"%-15s%-15s%-8llu%-7ld%-10ld%-7ld\n
",source_str,group_str,c_oil->cc.lastused/100,c_oil->cc.pktcnt,c_oil->cc.bytecnt
,c_oil->cc.wrong_if);}for(ALL_LIST_ELEMENTS_RO(pim->static_routes,node,s_route))
{chargroup_str[INET_ADDRSTRLEN];charsource_str[INET_ADDRSTRLEN];if(!s_route->c_o
il.installed)continue;pim_mroute_update_counters(&s_route->c_oil);pim_inet4_dump
("<group?>",s_route->c_oil.oil.mfcc_mcastgrp,group_str,sizeof(group_str));pim_in
et4_dump("<source?>",s_route->c_oil.oil.mfcc_origin,source_str,sizeof(source_str
));vty_out(vty,"%-15s%-15s%-8llu%-7ld%-10ld%-7ld\n",source_str,group_str,s_route
->c_oil.cc.lastused,s_route->c_oil.cc.pktcnt,s_route->c_oil.cc.bytecnt,s_route->
c_oil.cc.wrong_if);}}DEFUN(show_ip_mroute_count,show_ip_mroute_count_cmd,"showip
mroute[vrfNAME]count",SHOW_STRIP_STRMROUTE_STRVRF_CMD_HELP_STR"Routeandpacketcou
ntdata\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf
)returnCMD_WARNING;show_mroute_count(vrf->info,vty);returnCMD_SUCCESS;}DEFUN(sho
w_ip_mroute_count_vrf_all,show_ip_mroute_count_vrf_all_cmd,"showipmroutevrfallco
unt",SHOW_STRIP_STRMROUTE_STRVRF_CMD_HELP_STR"Routeandpacketcountdata\n"){uint8_
tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB_F
OREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_ou
t(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);sh
ow_mroute_count(vrf->info,vty);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}DEFU
N(show_ip_rib,show_ip_rib_cmd,"showiprib[vrfNAME]A.B.C.D",SHOW_STRIP_STRRIB_STRV
RF_CMD_HELP_STR"Unicastaddress\n"){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty
,argv,argc,&idx);structin_addraddr;constchar*addr_str;structpim_nexthopnexthop;c
harnexthop_addr_str[PREFIX_STRLEN];intresult;if(!vrf)returnCMD_WARNING;memset(&n
exthop,0,sizeof(nexthop));argv_find(argv,argc,"A.B.C.D",&idx);addr_str=argv[idx]
->arg;result=inet_pton(AF_INET,addr_str,&addr);if(result<=0){vty_out(vty,"Baduni
castaddress%s:errno=%d:%s\n",addr_str,errno,safe_strerror(errno));returnCMD_WARN
ING;}if(pim_nexthop_lookup(vrf->info,&nexthop,addr,0)){vty_out(vty,"Failurequery
ingRIBnexthopforunicastaddress%s\n",addr_str);returnCMD_WARNING;}vty_out(vty,"Ad
dressNextHopInterfaceMetricPreference\n");pim_addr_dump("<nexthop?>",&nexthop.mr
ib_nexthop_addr,nexthop_addr_str,sizeof(nexthop_addr_str));vty_out(vty,"%-15s%-1
5s%-9s%6d%10d\n",addr_str,nexthop_addr_str,nexthop.interface?nexthop.interface->
name:"<ifname?>",nexthop.mrib_route_metric,nexthop.mrib_metric_preference);retur
nCMD_SUCCESS;}staticvoidshow_ssmpingd(structpim_instance*pim,structvty*vty){stru
ctlistnode*node;structssmpingd_sock*ss;time_tnow;vty_out(vty,"SourceSocketAddres
sPortUptimeRequests\n");if(!pim->ssmpingd_list)return;now=pim_time_monotonic_sec
();for(ALL_LIST_ELEMENTS_RO(pim->ssmpingd_list,node,ss)){charsource_str[INET_ADD
RSTRLEN];charss_uptime[10];structsockaddr_inbind_addr;socklen_tlen=sizeof(bind_a
ddr);charbind_addr_str[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",ss->source_addr,
source_str,sizeof(source_str));if(pim_socket_getsockname(ss->sock_fd,(structsock
addr*)&bind_addr,&len)){vty_out(vty,"%%Failurereadingsocketnameforssmpingdsource
%sonfd=%d\n",source_str,ss->sock_fd);}pim_inet4_dump("<addr?>",bind_addr.sin_add
r,bind_addr_str,sizeof(bind_addr_str));pim_time_uptime(ss_uptime,sizeof(ss_uptim
e),now-ss->creation);vty_out(vty,"%-15s%6d%-15s%5d%8s%8lld\n",source_str,ss->soc
k_fd,bind_addr_str,ntohs(bind_addr.sin_port),ss_uptime,(longlong)ss->requests);}
}DEFUN(show_ip_ssmpingd,show_ip_ssmpingd_cmd,"showipssmpingd[vrfNAME]",SHOW_STRI
P_STRSHOW_SSMPINGD_STRVRF_CMD_HELP_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vr
f(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;show_ssmpingd(vrf->info,vty);ret
urnCMD_SUCCESS;}staticintpim_rp_cmd_worker(structpim_instance*pim,structvty*vty,
constchar*rp,constchar*group,constchar*plist){intresult;result=pim_rp_new(pim,rp
,group,plist);if(result==PIM_MALLOC_FAIL){vty_out(vty,"%%Outofmemory\n");returnC
MD_WARNING_CONFIG_FAILED;}if(result==PIM_GROUP_BAD_ADDRESS){vty_out(vty,"%%Badgr
oupaddressspecified:%s\n",group);returnCMD_WARNING_CONFIG_FAILED;}if(result==PIM
_RP_BAD_ADDRESS){vty_out(vty,"%%BadRPaddressspecified:%s\n",rp);returnCMD_WARNIN
G_CONFIG_FAILED;}if(result==PIM_RP_NO_PATH){vty_out(vty,"%%NoPathtoRPaddressspec
ified:%s\n",rp);returnCMD_WARNING;}if(result==PIM_GROUP_OVERLAP){vty_out(vty,"%%
Grouprangespecifiedcannotexactmatchanother\n");returnCMD_WARNING_CONFIG_FAILED;}
if(result==PIM_GROUP_PFXLIST_OVERLAP){vty_out(vty,"%%Thisgroupisalreadycoveredby
aRPprefix-list\n");returnCMD_WARNING_CONFIG_FAILED;}if(result==PIM_RP_PFXLIST_IN
_USE){vty_out(vty,"%%Thesameprefix-listcannotbeappliedtomultipleRPs\n");returnCM
D_WARNING_CONFIG_FAILED;}returnCMD_SUCCESS;}staticintpim_cmd_spt_switchover(stru
ctpim_instance*pim,enumpim_spt_switchoverspt,constchar*plist){pim->spt.switchove
r=spt;switch(pim->spt.switchover){casePIM_SPT_IMMEDIATE:if(pim->spt.plist)XFREE(
MTYPE_PIM_SPT_PLIST_NAME,pim->spt.plist);pim_upstream_add_lhr_star_pimreg(pim);b
reak;casePIM_SPT_INFINITY:pim_upstream_remove_lhr_star_pimreg(pim,plist);if(pim-
>spt.plist)XFREE(MTYPE_PIM_SPT_PLIST_NAME,pim->spt.plist);if(plist)pim->spt.plis
t=XSTRDUP(MTYPE_PIM_SPT_PLIST_NAME,plist);break;}returnCMD_SUCCESS;}DEFUN(ip_pim
_spt_switchover_infinity,ip_pim_spt_switchover_infinity_cmd,"ippimspt-switchover
infinity-and-beyond",IP_STRPIM_STR"SPT-Switchover\n""NeverswitchtoSPTTree\n"){PI
M_DECLVAR_CONTEXT(vrf,pim);returnpim_cmd_spt_switchover(pim,PIM_SPT_INFINITY,NUL
L);}DEFUN(ip_pim_spt_switchover_infinity_plist,ip_pim_spt_switchover_infinity_pl
ist_cmd,"ippimspt-switchoverinfinity-and-beyondprefix-listWORD",IP_STRPIM_STR"SP
T-Switchover\n""NeverswitchtoSPTTree\n""Prefix-Listtocontrolwhichgroupstoswitch\
n""Prefix-Listname\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnpim_cmd_spt_switchover
(pim,PIM_SPT_INFINITY,argv[5]->arg);}DEFUN(no_ip_pim_spt_switchover_infinity,no_
ip_pim_spt_switchover_infinity_cmd,"noippimspt-switchoverinfinity-and-beyond",NO
_STRIP_STRPIM_STR"SPT_Switchover\n""NeverswitchtoSPTTree\n"){PIM_DECLVAR_CONTEXT
(vrf,pim);returnpim_cmd_spt_switchover(pim,PIM_SPT_IMMEDIATE,NULL);}DEFUN(no_ip_
pim_spt_switchover_infinity_plist,no_ip_pim_spt_switchover_infinity_plist_cmd,"n
oippimspt-switchoverinfinity-and-beyondprefix-listWORD",NO_STRIP_STRPIM_STR"SPT_
Switchover\n""NeverswitchtoSPTTree\n""Prefix-Listtocontrolwhichgroupstoswitch\n"
"Prefix-Listname\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnpim_cmd_spt_switchover(p
im,PIM_SPT_IMMEDIATE,NULL);}DEFUN(ip_pim_joinprune_time,ip_pim_joinprune_time_cm
d,"ippimjoin-prune-interval(60-600)",IP_STR"pimmulticastrouting\n""JoinPruneSend
Interval\n""Seconds\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_t_periodic=atoi(argv[3
]->arg);returnCMD_SUCCESS;}DEFUN(no_ip_pim_joinprune_time,no_ip_pim_joinprune_ti
me_cmd,"noippimjoin-prune-interval(60-600)",NO_STRIP_STR"pimmulticastrouting\n""
JoinPruneSendInterval\n""Seconds\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_t_periodi
c=PIM_DEFAULT_T_PERIODIC;returnCMD_SUCCESS;}DEFUN(ip_pim_register_suppress,ip_pi
m_register_suppress_cmd,"ippimregister-suppress-time(5-60000)",IP_STR"pimmultica
strouting\n""RegisterSuppressTimer\n""Seconds\n"){PIM_DECLVAR_CONTEXT(vrf,pim);q
pim_register_suppress_time=atoi(argv[3]->arg);returnCMD_SUCCESS;}DEFUN(no_ip_pim
_register_suppress,no_ip_pim_register_suppress_cmd,"noippimregister-suppress-tim
e(5-60000)",NO_STRIP_STR"pimmulticastrouting\n""RegisterSuppressTimer\n""Seconds
\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_register_suppress_time=PIM_REGISTER_SUPPR
ESSION_TIME_DEFAULT;returnCMD_SUCCESS;}DEFUN(ip_pim_rp_keep_alive,ip_pim_rp_keep
_alive_cmd,"ippimrpkeep-alive-timer(31-60000)",IP_STR"pimmulticastrouting\n""Ren
devousPoint\n""KeepaliveTimer\n""Seconds\n"){PIM_DECLVAR_CONTEXT(vrf,pim);pim->r
p_keep_alive_time=atoi(argv[4]->arg);returnCMD_SUCCESS;}DEFUN(no_ip_pim_rp_keep_
alive,no_ip_pim_rp_keep_alive_cmd,"noippimrpkeep-alive-timer(31-60000)",NO_STRIP
_STR"pimmulticastrouting\n""RendevousPoint\n""KeepaliveTimer\n""Seconds\n"){PIM_
DECLVAR_CONTEXT(vrf,pim);pim->rp_keep_alive_time=PIM_KEEPALIVE_PERIOD;returnCMD_
SUCCESS;}DEFUN(ip_pim_keep_alive,ip_pim_keep_alive_cmd,"ippimkeep-alive-timer(31
-60000)",IP_STR"pimmulticastrouting\n""KeepaliveTimer\n""Seconds\n"){PIM_DECLVAR
_CONTEXT(vrf,pim);pim->keep_alive_time=atoi(argv[3]->arg);returnCMD_SUCCESS;}DEF
UN(no_ip_pim_keep_alive,no_ip_pim_keep_alive_cmd,"noippimkeep-alive-timer(31-600
00)",NO_STRIP_STR"pimmulticastrouting\n""KeepaliveTimer\n""Seconds\n"){PIM_DECLV
AR_CONTEXT(vrf,pim);pim->keep_alive_time=PIM_KEEPALIVE_PERIOD;returnCMD_SUCCESS;
}DEFUN(ip_pim_packets,ip_pim_packets_cmd,"ippimpackets(1-100)",IP_STR"pimmultica
strouting\n""packetstoprocessatonetimeperfd\n""Numberofpackets\n"){PIM_DECLVAR_C
ONTEXT(vrf,pim);qpim_packet_process=atoi(argv[3]->arg);returnCMD_SUCCESS;}DEFUN(
no_ip_pim_packets,no_ip_pim_packets_cmd,"noippimpackets(1-100)",NO_STRIP_STR"pim
multicastrouting\n""packetstoprocessatonetimeperfd\n""Numberofpackets\n"){PIM_DE
CLVAR_CONTEXT(vrf,pim);qpim_packet_process=PIM_DEFAULT_PACKET_PROCESS;returnCMD_
SUCCESS;}DEFUN(ip_pim_v6_secondary,ip_pim_v6_secondary_cmd,"ippimsend-v6-seconda
ry",IP_STR"pimmulticastrouting\n""Sendv6secondaryaddresses\n"){PIM_DECLVAR_CONTE
XT(vrf,pim);pim->send_v6_secondary=1;returnCMD_SUCCESS;}DEFUN(no_ip_pim_v6_secon
dary,no_ip_pim_v6_secondary_cmd,"noippimsend-v6-secondary",NO_STRIP_STR"pimmulti
castrouting\n""Sendv6secondaryaddresses\n"){PIM_DECLVAR_CONTEXT(vrf,pim);pim->se
nd_v6_secondary=0;returnCMD_SUCCESS;}DEFUN(ip_pim_rp,ip_pim_rp_cmd,"ippimrpA.B.C
.D[A.B.C.D/M]",IP_STR"pimmulticastrouting\n""RendevousPoint\n""ipaddressofRP\n""
GroupAddressrangetocover\n"){PIM_DECLVAR_CONTEXT(vrf,pim);intidx_ipv4=3;if(argc=
=(idx_ipv4+1))returnpim_rp_cmd_worker(pim,vty,argv[idx_ipv4]->arg,NULL,NULL);els
ereturnpim_rp_cmd_worker(pim,vty,argv[idx_ipv4]->arg,argv[idx_ipv4+1]->arg,NULL)
;}DEFUN(ip_pim_rp_prefix_list,ip_pim_rp_prefix_list_cmd,"ippimrpA.B.C.Dprefix-li
stWORD",IP_STR"pimmulticastrouting\n""RendevousPoint\n""ipaddressofRP\n""grouppr
efix-listfilter\n""Nameofaprefix-list\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnpim
_rp_cmd_worker(pim,vty,argv[3]->arg,NULL,argv[5]->arg);}staticintpim_no_rp_cmd_w
orker(structpim_instance*pim,structvty*vty,constchar*rp,constchar*group,constcha
r*plist){intresult=pim_rp_del(pim,rp,group,plist);if(result==PIM_GROUP_BAD_ADDRE
SS){vty_out(vty,"%%Badgroupaddressspecified:%s\n",group);returnCMD_WARNING_CONFI
G_FAILED;}if(result==PIM_RP_BAD_ADDRESS){vty_out(vty,"%%BadRPaddressspecified:%s
\n",rp);returnCMD_WARNING_CONFIG_FAILED;}if(result==PIM_RP_NOT_FOUND){vty_out(vt
y,"%%UnabletofindspecifiedRP\n");returnCMD_WARNING_CONFIG_FAILED;}returnCMD_SUCC
ESS;}DEFUN(no_ip_pim_rp,no_ip_pim_rp_cmd,"noippimrpA.B.C.D[A.B.C.D/M]",NO_STRIP_
STR"pimmulticastrouting\n""RendevousPoint\n""ipaddressofRP\n""GroupAddressranget
ocover\n"){PIM_DECLVAR_CONTEXT(vrf,pim);intidx_ipv4=4,idx_group=0;if(argv_find(a
rgv,argc,"A.B.C.D/M",&idx_group))returnpim_no_rp_cmd_worker(pim,vty,argv[idx_ipv
4]->arg,argv[idx_group]->arg,NULL);elsereturnpim_no_rp_cmd_worker(pim,vty,argv[i
dx_ipv4]->arg,NULL,NULL);}DEFUN(no_ip_pim_rp_prefix_list,no_ip_pim_rp_prefix_lis
t_cmd,"noippimrpA.B.C.Dprefix-listWORD",NO_STRIP_STR"pimmulticastrouting\n""Rend
evousPoint\n""ipaddressofRP\n""groupprefix-listfilter\n""Nameofaprefix-list\n"){
PIM_DECLVAR_CONTEXT(vrf,pim);returnpim_no_rp_cmd_worker(pim,vty,argv[4]->arg,NUL
L,argv[6]->arg);}staticintpim_ssm_cmd_worker(structpim_instance*pim,structvty*vt
y,constchar*plist){intresult=pim_ssm_range_set(pim,pim->vrf_id,plist);if(result=
=PIM_SSM_ERR_NONE)returnCMD_SUCCESS;switch(result){casePIM_SSM_ERR_NO_VRF:vty_ou
t(vty,"%%VRFdoesn'texist\n");break;casePIM_SSM_ERR_DUP:vty_out(vty,"%%duplicatec
onfig\n");break;default:vty_out(vty,"%%ssmrangeconfigfailed\n");}returnCMD_WARNI
NG_CONFIG_FAILED;}DEFUN(ip_pim_ssm_prefix_list,ip_pim_ssm_prefix_list_cmd,"ippim
ssmprefix-listWORD",IP_STR"pimmulticastrouting\n""SourceSpecificMulticast\n""gro
uprangeprefix-listfilter\n""Nameofaprefix-list\n"){PIM_DECLVAR_CONTEXT(vrf,pim);
returnpim_ssm_cmd_worker(pim,vty,argv[4]->arg);}DEFUN(no_ip_pim_ssm_prefix_list,
no_ip_pim_ssm_prefix_list_cmd,"noippimssmprefix-list",NO_STRIP_STR"pimmulticastr
outing\n""SourceSpecificMulticast\n""grouprangeprefix-listfilter\n"){PIM_DECLVAR
_CONTEXT(vrf,pim);returnpim_ssm_cmd_worker(pim,vty,NULL);}DEFUN(no_ip_pim_ssm_pr
efix_list_name,no_ip_pim_ssm_prefix_list_name_cmd,"noippimssmprefix-listWORD",NO
_STRIP_STR"pimmulticastrouting\n""SourceSpecificMulticast\n""grouprangeprefix-li
stfilter\n""Nameofaprefix-list\n"){PIM_DECLVAR_CONTEXT(vrf,pim);structpim_ssm*ss
m=pim->ssm_info;if(ssm->plist_name&&!strcmp(ssm->plist_name,argv[5]->arg))return
pim_ssm_cmd_worker(pim,vty,NULL);vty_out(vty,"%%pimssmprefix-list%sdoesn'texist\
n",argv[5]->arg);returnCMD_WARNING_CONFIG_FAILED;}staticvoidip_pim_ssm_show_grou
p_range(structpim_instance*pim,structvty*vty,uint8_tuj){structpim_ssm*ssm=pim->s
sm_info;constchar*range_str=ssm->plist_name?ssm->plist_name:PIM_SSM_STANDARD_RAN
GE;if(uj){json_object*json;json=json_object_new_object();json_object_string_add(
json,"ssmGroups",range_str);vty_out(vty,"%s\n",json_object_to_json_string_ext(js
on,JSON_C_TO_STRING_PRETTY));json_object_free(json);}elsevty_out(vty,"SSMgroupra
nge:%s\n",range_str);}DEFUN(show_ip_pim_ssm_range,show_ip_pim_ssm_range_cmd,"sho
wippim[vrfNAME]group-type[json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"PIMgroupt
ype\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);ui
nt8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNING;ip_pim_ssm_show_group_rang
e(vrf->info,vty,uj);returnCMD_SUCCESS;}staticvoidip_pim_ssm_show_group_type(stru
ctpim_instance*pim,structvty*vty,uint8_tuj,constchar*group){structin_addrgroup_a
ddr;constchar*type_str;intresult;result=inet_pton(AF_INET,group,&group_addr);if(
result<=0)type_str="invalid";else{if(pim_is_group_224_4(group_addr))type_str=pim
_is_grp_ssm(pim,group_addr)?"SSM":"ASM";elsetype_str="not-multicast";}if(uj){jso
n_object*json;json=json_object_new_object();json_object_string_add(json,"groupTy
pe",type_str);vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_S
TRING_PRETTY));json_object_free(json);}elsevty_out(vty,"Grouptype:%s\n",type_str
);}DEFUN(show_ip_pim_group_type,show_ip_pim_group_type_cmd,"showippim[vrfNAME]gr
oup-typeA.B.C.D[json]",SHOW_STRIP_STRPIM_STRVRF_CMD_HELP_STR"multicastgrouptype\
n""groupaddress\n"JSON_STR){intidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,a
rgc,&idx);uint8_tuj=use_json(argc,argv);if(!vrf)returnCMD_WARNING;argv_find(argv
,argc,"A.B.C.D",&idx);ip_pim_ssm_show_group_type(vrf->info,vty,uj,argv[idx]->arg
);returnCMD_SUCCESS;}DEFUN_HIDDEN(ip_multicast_routing,ip_multicast_routing_cmd,
"ipmulticast-routing",IP_STR"EnableIPmulticastforwarding\n"){returnCMD_SUCCESS;}
DEFUN_HIDDEN(no_ip_multicast_routing,no_ip_multicast_routing_cmd,"noipmulticast-
routing",NO_STRIP_STR"EnableIPmulticastforwarding\n"){vty_out(vty,"CommandisDisa
bledandwillberemovedinafutureversion\n");returnCMD_SUCCESS;}DEFUN(ip_ssmpingd,ip
_ssmpingd_cmd,"ipssmpingd[A.B.C.D]",IP_STRCONF_SSMPINGD_STR"Sourceaddress\n"){PI
M_DECLVAR_CONTEXT(vrf,pim);intidx_ipv4=2;intresult;structin_addrsource_addr;cons
tchar*source_str=(argc==3)?argv[idx_ipv4]->arg:"0.0.0.0";result=inet_pton(AF_INE
T,source_str,&source_addr);if(result<=0){vty_out(vty,"%%Badsourceaddress%s:errno
=%d:%s\n",source_str,errno,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED
;}result=pim_ssmpingd_start(pim,source_addr);if(result){vty_out(vty,"%%Failurest
artingssmpingdforsource%s:%d\n",source_str,result);returnCMD_WARNING_CONFIG_FAIL
ED;}returnCMD_SUCCESS;}DEFUN(no_ip_ssmpingd,no_ip_ssmpingd_cmd,"noipssmpingd[A.B
.C.D]",NO_STRIP_STRCONF_SSMPINGD_STR"Sourceaddress\n"){PIM_DECLVAR_CONTEXT(vrf,p
im);intidx_ipv4=3;intresult;structin_addrsource_addr;constchar*source_str=(argc=
=4)?argv[idx_ipv4]->arg:"0.0.0.0";result=inet_pton(AF_INET,source_str,&source_ad
dr);if(result<=0){vty_out(vty,"%%Badsourceaddress%s:errno=%d:%s\n",source_str,er
rno,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}result=pim_ssmpingd_s
top(pim,source_addr);if(result){vty_out(vty,"%%Failurestoppingssmpingdforsource%
s:%d\n",source_str,result);returnCMD_WARNING_CONFIG_FAILED;}returnCMD_SUCCESS;}D
EFUN(ip_pim_ecmp,ip_pim_ecmp_cmd,"ippimecmp",IP_STR"pimmulticastrouting\n""Enabl
ePIMECMP\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_ecmp_enable=1;returnCMD_SUCCESS;}
DEFUN(no_ip_pim_ecmp,no_ip_pim_ecmp_cmd,"noippimecmp",NO_STRIP_STR"pimmulticastr
outing\n""DisablePIMECMP\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_ecmp_enable=0;ret
urnCMD_SUCCESS;}DEFUN(ip_pim_ecmp_rebalance,ip_pim_ecmp_rebalance_cmd,"ippimecmp
rebalance",IP_STR"pimmulticastrouting\n""EnablePIMECMP\n""EnablePIMECMPRebalance
\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_ecmp_enable=1;qpim_ecmp_rebalance_enable=
1;returnCMD_SUCCESS;}DEFUN(no_ip_pim_ecmp_rebalance,no_ip_pim_ecmp_rebalance_cmd
,"noippimecmprebalance",NO_STRIP_STR"pimmulticastrouting\n""DisablePIMECMP\n""Di
sablePIMECMPRebalance\n"){PIM_DECLVAR_CONTEXT(vrf,pim);qpim_ecmp_rebalance_enabl
e=0;returnCMD_SUCCESS;}staticintpim_cmd_igmp_start(structvty*vty,structinterface
*ifp){structpim_interface*pim_ifp;uint8_tneed_startup=0;pim_ifp=ifp->info;if(!pi
m_ifp){pim_ifp=pim_if_new(ifp,1/*igmp=true*/,0/*pim=false*/);if(!pim_ifp){vty_ou
t(vty,"CouldnotenableIGMPoninterface%s\n",ifp->name);returnCMD_WARNING_CONFIG_FA
ILED;}need_startup=1;}else{if(!PIM_IF_TEST_IGMP(pim_ifp->options)){PIM_IF_DO_IGM
P(pim_ifp->options);need_startup=1;}}/*'ipigmp'executedmultipletimes,withneed_st
artupavoidmultipleifaddallandmembershiprefresh*/if(need_startup){pim_if_addr_add
_all(ifp);pim_if_membership_refresh(ifp);}returnCMD_SUCCESS;}DEFUN(interface_ip_
igmp,interface_ip_igmp_cmd,"ipigmp",IP_STRIFACE_IGMP_STR){VTY_DECLVAR_CONTEXT(in
terface,ifp);returnpim_cmd_igmp_start(vty,ifp);}DEFUN(interface_no_ip_igmp,inter
face_no_ip_igmp_cmd,"noipigmp",NO_STRIP_STRIFACE_IGMP_STR){VTY_DECLVAR_CONTEXT(i
nterface,ifp);structpim_interface*pim_ifp=ifp->info;if(!pim_ifp)returnCMD_SUCCES
S;PIM_IF_DONT_IGMP(pim_ifp->options);pim_if_membership_clear(ifp);pim_if_addr_de
l_all_igmp(ifp);if(!PIM_IF_TEST_PIM(pim_ifp->options)){pim_if_delete(ifp);}retur
nCMD_SUCCESS;}DEFUN(interface_ip_igmp_join,interface_ip_igmp_join_cmd,"ipigmpjoi
nA.B.C.DA.B.C.D",IP_STRIFACE_IGMP_STR"IGMPjoinmulticastgroup\n""Multicastgroupad
dress\n""Sourceaddress\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=3;inti
dx_ipv4_2=4;constchar*group_str;constchar*source_str;structin_addrgroup_addr;str
uctin_addrsource_addr;intresult;/*Groupaddress*/group_str=argv[idx_ipv4]->arg;re
sult=inet_pton(AF_INET,group_str,&group_addr);if(result<=0){vty_out(vty,"Badgrou
paddress%s:errno=%d:%s\n",group_str,errno,safe_strerror(errno));returnCMD_WARNIN
G_CONFIG_FAILED;}/*Sourceaddress*/source_str=argv[idx_ipv4_2]->arg;result=inet_p
ton(AF_INET,source_str,&source_addr);if(result<=0){vty_out(vty,"Badsourceaddress
%s:errno=%d:%s\n",source_str,errno,safe_strerror(errno));returnCMD_WARNING_CONFI
G_FAILED;}CMD_FERR_RETURN(pim_if_igmp_join_add(ifp,group_addr,source_addr),"Fail
urejoiningIGMPgroup:$ERR");returnCMD_SUCCESS;}DEFUN(interface_no_ip_igmp_join,in
terface_no_ip_igmp_join_cmd,"noipigmpjoinA.B.C.DA.B.C.D",NO_STRIP_STRIFACE_IGMP_
STR"IGMPjoinmulticastgroup\n""Multicastgroupaddress\n""Sourceaddress\n"){VTY_DEC
LVAR_CONTEXT(interface,ifp);intidx_ipv4=4;intidx_ipv4_2=5;constchar*group_str;co
nstchar*source_str;structin_addrgroup_addr;structin_addrsource_addr;intresult;/*
Groupaddress*/group_str=argv[idx_ipv4]->arg;result=inet_pton(AF_INET,group_str,&
group_addr);if(result<=0){vty_out(vty,"Badgroupaddress%s:errno=%d:%s\n",group_st
r,errno,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}/*Sourceaddress*/
source_str=argv[idx_ipv4_2]->arg;result=inet_pton(AF_INET,source_str,&source_add
r);if(result<=0){vty_out(vty,"Badsourceaddress%s:errno=%d:%s\n",source_str,errno
,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}result=pim_if_igmp_join_
del(ifp,group_addr,source_addr);if(result){vty_out(vty,"%%FailureleavingIGMPgrou
p%ssource%soninterface%s:%d\n",group_str,source_str,ifp->name,result);returnCMD_
WARNING_CONFIG_FAILED;}returnCMD_SUCCESS;}/*CLIreconfigurationaffectstheinterfac
elevel(structpim_interface).Thisfunctionpropagatesthereconfigurationtoeveryactiv
esocketforthatinterface.*/staticvoidigmp_sock_query_interval_reconfig(structigmp
_sock*igmp){structinterface*ifp;structpim_interface*pim_ifp;zassert(igmp);/*othe
rquerierpresent?*/if(igmp->t_other_querier_timer)return;/*thisisthequerier*/zass
ert(igmp->interface);zassert(igmp->interface->info);ifp=igmp->interface;pim_ifp=
ifp->info;if(PIM_DEBUG_IGMP_TRACE){charifaddr_str[INET_ADDRSTRLEN];pim_inet4_dum
p("<ifaddr?>",igmp->ifaddr,ifaddr_str,sizeof(ifaddr_str));zlog_debug("%s:Querier
%son%sreconfigquery_interval=%d",__PRETTY_FUNCTION__,ifaddr_str,ifp->name,pim_if
p->igmp_default_query_interval);}/*igmp_startup_mode_on()willresetQQI:igmp->quer
ier_query_interval=pim_ifp->igmp_default_query_interval;*/igmp_startup_mode_on(i
gmp);}staticvoidigmp_sock_query_reschedule(structigmp_sock*igmp){if(igmp->t_igmp
_query_timer){/*otherquerierpresent*/zassert(igmp->t_igmp_query_timer);zassert(!
igmp->t_other_querier_timer);pim_igmp_general_query_off(igmp);pim_igmp_general_q
uery_on(igmp);zassert(igmp->t_igmp_query_timer);zassert(!igmp->t_other_querier_t
imer);}else{/*thisisthequerier*/zassert(!igmp->t_igmp_query_timer);zassert(igmp-
>t_other_querier_timer);pim_igmp_other_querier_timer_off(igmp);pim_igmp_other_qu
erier_timer_on(igmp);zassert(!igmp->t_igmp_query_timer);zassert(igmp->t_other_qu
erier_timer);}}staticvoidchange_query_interval(structpim_interface*pim_ifp,intqu
ery_interval){structlistnode*sock_node;structigmp_sock*igmp;pim_ifp->igmp_defaul
t_query_interval=query_interval;for(ALL_LIST_ELEMENTS_RO(pim_ifp->igmp_socket_li
st,sock_node,igmp)){igmp_sock_query_interval_reconfig(igmp);igmp_sock_query_resc
hedule(igmp);}}staticvoidchange_query_max_response_time(structpim_interface*pim_
ifp,intquery_max_response_time_dsec){structlistnode*sock_node;structigmp_sock*ig
mp;pim_ifp->igmp_query_max_response_time_dsec=query_max_response_time_dsec;/*Bel
owwemodifysocket/group/sourcetimersinordertoquicklyreflectthechange.Otherwise,th
osetimerswouldeventuallycatchup.*//*scanallsockets*/for(ALL_LIST_ELEMENTS_RO(pim
_ifp->igmp_socket_list,sock_node,igmp)){structlistnode*grp_node;structigmp_group
*grp;/*reschedulesocketgeneralquery*/igmp_sock_query_reschedule(igmp);/*scansock
etgroups*/for(ALL_LIST_ELEMENTS_RO(igmp->igmp_group_list,grp_node,grp)){structli
stnode*src_node;structigmp_source*src;/*resetgrouptimersforgroupsinEXCLUDEmode*/
if(grp->group_filtermode_isexcl){igmp_group_reset_gmi(grp);}/*scangroupsources*/
for(ALL_LIST_ELEMENTS_RO(grp->group_source_list,src_node,src)){/*resetsourcetime
rsforsourceswithrunning*timers*/if(src->t_source_timer){igmp_source_reset_gmi(ig
mp,grp,src);}}}}}#defineIGMP_QUERY_INTERVAL_MIN(1)#defineIGMP_QUERY_INTERVAL_MAX
(1800)DEFUN(interface_ip_igmp_query_interval,interface_ip_igmp_query_interval_cm
d,"ipigmpquery-interval(1-1800)",IP_STRIFACE_IGMP_STRIFACE_IGMP_QUERY_INTERVAL_S
TR"Queryintervalinseconds\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structpim_inter
face*pim_ifp=ifp->info;intquery_interval;intquery_interval_dsec;intret;if(!pim_i
fp){ret=pim_cmd_igmp_start(vty,ifp);if(ret!=CMD_SUCCESS)returnret;pim_ifp=ifp->i
nfo;}query_interval=atoi(argv[3]->arg);query_interval_dsec=10*query_interval;/*I
tseemswedon'tneedtocheckboundssincecommand.cdoesitalready,butweverifythemanywayf
orextrasafety.*/if(query_interval<IGMP_QUERY_INTERVAL_MIN){vty_out(vty,"Generalq
ueryinterval%dlowerthanminimum%d\n",query_interval,IGMP_QUERY_INTERVAL_MIN);retu
rnCMD_WARNING_CONFIG_FAILED;}if(query_interval>IGMP_QUERY_INTERVAL_MAX){vty_out(
vty,"Generalqueryinterval%dhigherthanmaximum%d\n",query_interval,IGMP_QUERY_INTE
RVAL_MAX);returnCMD_WARNING_CONFIG_FAILED;}if(query_interval_dsec<=pim_ifp->igmp
_query_max_response_time_dsec){vty_out(vty,"Can'tsetgeneralqueryinterval%ddsec<=
querymaxresponsetime%ddsec.\n",query_interval_dsec,pim_ifp->igmp_query_max_respo
nse_time_dsec);returnCMD_WARNING_CONFIG_FAILED;}change_query_interval(pim_ifp,qu
ery_interval);returnCMD_SUCCESS;}DEFUN(interface_no_ip_igmp_query_interval,inter
face_no_ip_igmp_query_interval_cmd,"noipigmpquery-interval",NO_STRIP_STRIFACE_IG
MP_STRIFACE_IGMP_QUERY_INTERVAL_STR){VTY_DECLVAR_CONTEXT(interface,ifp);structpi
m_interface*pim_ifp=ifp->info;intdefault_query_interval_dsec;if(!pim_ifp)returnC
MD_SUCCESS;default_query_interval_dsec=IGMP_GENERAL_QUERY_INTERVAL*10;if(default
_query_interval_dsec<=pim_ifp->igmp_query_max_response_time_dsec){vty_out(vty,"C
an'tsetdefaultgeneralqueryinterval%ddsec<=querymaxresponsetime%ddsec.\n",default
_query_interval_dsec,pim_ifp->igmp_query_max_response_time_dsec);returnCMD_WARNI
NG_CONFIG_FAILED;}change_query_interval(pim_ifp,IGMP_GENERAL_QUERY_INTERVAL);ret
urnCMD_SUCCESS;}DEFUN(interface_ip_igmp_version,interface_ip_igmp_version_cmd,"i
pigmpversion(2-3)",IP_STRIFACE_IGMP_STR"IGMPversion\n""IGMPversionnumber\n"){VTY
_DECLVAR_CONTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;intigmp_ve
rsion,old_version=0;intret;if(!pim_ifp){ret=pim_cmd_igmp_start(vty,ifp);if(ret!=
CMD_SUCCESS)returnret;pim_ifp=ifp->info;}igmp_version=atoi(argv[3]->arg);old_ver
sion=pim_ifp->igmp_version;pim_ifp->igmp_version=igmp_version;//CheckifIGMPisEna
bledotherwise,enableoninterfaceif(!PIM_IF_TEST_IGMP(pim_ifp->options)){PIM_IF_DO
_IGMP(pim_ifp->options);pim_if_addr_add_all(ifp);pim_if_membership_refresh(ifp);
old_version=igmp_version;//avoidrefreshingmembershipagain.}/*Currentandnewversio
nisdifferentrefreshexistingmembership.Goingfrom3->2or2->3.*/if(old_version!=igmp
_version)pim_if_membership_refresh(ifp);returnCMD_SUCCESS;}DEFUN(interface_no_ip
_igmp_version,interface_no_ip_igmp_version_cmd,"noipigmpversion(2-3)",NO_STRIP_S
TRIFACE_IGMP_STR"IGMPversion\n""IGMPversionnumber\n"){VTY_DECLVAR_CONTEXT(interf
ace,ifp);structpim_interface*pim_ifp=ifp->info;if(!pim_ifp)returnCMD_SUCCESS;pim
_ifp->igmp_version=IGMP_DEFAULT_VERSION;returnCMD_SUCCESS;}#defineIGMP_QUERY_MAX
_RESPONSE_TIME_MIN_DSEC(10)#defineIGMP_QUERY_MAX_RESPONSE_TIME_MAX_DSEC(250)DEFU
N(interface_ip_igmp_query_max_response_time,interface_ip_igmp_query_max_response
_time_cmd,"ipigmpquery-max-response-time(10-250)",IP_STRIFACE_IGMP_STRIFACE_IGMP
_QUERY_MAX_RESPONSE_TIME_STR"Queryresponsevalueindeci-seconds\n"){VTY_DECLVAR_CO
NTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;intquery_max_response
_time;intret;if(!pim_ifp){ret=pim_cmd_igmp_start(vty,ifp);if(ret!=CMD_SUCCESS)re
turnret;pim_ifp=ifp->info;}query_max_response_time=atoi(argv[3]->arg);if(query_m
ax_response_time>=pim_ifp->igmp_default_query_interval*10){vty_out(vty,"Can'tset
querymaxresponsetime%dsec>=generalqueryinterval%dsec\n",query_max_response_time,
pim_ifp->igmp_default_query_interval);returnCMD_WARNING_CONFIG_FAILED;}change_qu
ery_max_response_time(pim_ifp,query_max_response_time);returnCMD_SUCCESS;}DEFUN(
interface_no_ip_igmp_query_max_response_time,interface_no_ip_igmp_query_max_resp
onse_time_cmd,"noipigmpquery-max-response-time(10-250)",NO_STRIP_STRIFACE_IGMP_S
TRIFACE_IGMP_QUERY_MAX_RESPONSE_TIME_STR"Timeforresponseindeci-seconds\n"){VTY_D
ECLVAR_CONTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;if(!pim_ifp)
returnCMD_SUCCESS;change_query_max_response_time(pim_ifp,IGMP_QUERY_MAX_RESPONSE
_TIME_DSEC);returnCMD_SUCCESS;}#defineIGMP_QUERY_MAX_RESPONSE_TIME_MIN_DSEC(10)#
defineIGMP_QUERY_MAX_RESPONSE_TIME_MAX_DSEC(250)DEFUN_HIDDEN(interface_ip_igmp_q
uery_max_response_time_dsec,interface_ip_igmp_query_max_response_time_dsec_cmd,"
ipigmpquery-max-response-time-dsec(10-250)",IP_STRIFACE_IGMP_STRIFACE_IGMP_QUERY
_MAX_RESPONSE_TIME_DSEC_STR"Queryresponsevalueindeciseconds\n"){VTY_DECLVAR_CONT
EXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;intquery_max_response_t
ime_dsec;intdefault_query_interval_dsec;intret;if(!pim_ifp){ret=pim_cmd_igmp_sta
rt(vty,ifp);if(ret!=CMD_SUCCESS)returnret;pim_ifp=ifp->info;}query_max_response_
time_dsec=atoi(argv[4]->arg);default_query_interval_dsec=10*pim_ifp->igmp_defaul
t_query_interval;if(query_max_response_time_dsec>=default_query_interval_dsec){v
ty_out(vty,"Can'tsetquerymaxresponsetime%ddsec>=generalqueryinterval%ddsec\n",qu
ery_max_response_time_dsec,default_query_interval_dsec);returnCMD_WARNING_CONFIG
_FAILED;}change_query_max_response_time(pim_ifp,query_max_response_time_dsec);re
turnCMD_SUCCESS;}DEFUN_HIDDEN(interface_no_ip_igmp_query_max_response_time_dsec,
interface_no_ip_igmp_query_max_response_time_dsec_cmd,"noipigmpquery-max-respons
e-time-dsec",NO_STRIP_STRIFACE_IGMP_STRIFACE_IGMP_QUERY_MAX_RESPONSE_TIME_DSEC_S
TR){VTY_DECLVAR_CONTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;if(
!pim_ifp)returnCMD_SUCCESS;change_query_max_response_time(pim_ifp,IGMP_QUERY_MAX
_RESPONSE_TIME_DSEC);returnCMD_SUCCESS;}DEFUN(interface_ip_pim_drprio,interface_
ip_pim_drprio_cmd,"ippimdrpriority(1-4294967295)",IP_STRPIM_STR"SettheDesignated
RouterElectionPriority\n""ValueofthenewDRPriority\n"){VTY_DECLVAR_CONTEXT(interf
ace,ifp);intidx_number=3;structpim_interface*pim_ifp=ifp->info;uint32_told_dr_pr
io;if(!pim_ifp){vty_out(vty,"PleaseenablePIMoninterface,first\n");returnCMD_WARN
ING_CONFIG_FAILED;}old_dr_prio=pim_ifp->pim_dr_priority;pim_ifp->pim_dr_priority
=strtol(argv[idx_number]->arg,NULL,10);if(old_dr_prio!=pim_ifp->pim_dr_priority)
{if(pim_if_dr_election(ifp))pim_hello_restart_now(ifp);}returnCMD_SUCCESS;}DEFUN
(interface_no_ip_pim_drprio,interface_no_ip_pim_drprio_cmd,"noippimdrpriority[(1
-4294967295)]",NO_STRIP_STRPIM_STR"ReverttheDesignatedRouterPrioritytodefault\n"
"OldValueofthePriority\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structpim_interfac
e*pim_ifp=ifp->info;if(!pim_ifp){vty_out(vty,"Pimnotenabledonthisinterface\n");r
eturnCMD_WARNING_CONFIG_FAILED;}if(pim_ifp->pim_dr_priority!=PIM_DEFAULT_DR_PRIO
RITY){pim_ifp->pim_dr_priority=PIM_DEFAULT_DR_PRIORITY;if(pim_if_dr_election(ifp
))pim_hello_restart_now(ifp);}returnCMD_SUCCESS;}staticintpim_cmd_interface_add(
structinterface*ifp){structpim_interface*pim_ifp=ifp->info;if(!pim_ifp){pim_ifp=
pim_if_new(ifp,0/*igmp=false*/,1/*pim=true*/);if(!pim_ifp){return0;}}else{PIM_IF
_DO_PIM(pim_ifp->options);}pim_if_addr_add_all(ifp);pim_if_membership_refresh(if
p);return1;}DEFUN_HIDDEN(interface_ip_pim_ssm,interface_ip_pim_ssm_cmd,"ippimssm
",IP_STRPIM_STRIFACE_PIM_STR){VTY_DECLVAR_CONTEXT(interface,ifp);if(!pim_cmd_int
erface_add(ifp)){vty_out(vty,"CouldnotenablePIMSMoninterface\n");returnCMD_WARNI
NG_CONFIG_FAILED;}vty_out(vty,"WARN:EnabledPIMSMoninterface;configurePIMSSM""ran
geifneeded\n");returnCMD_SUCCESS;}DEFUN(interface_ip_pim_sm,interface_ip_pim_sm_
cmd,"ippimsm",IP_STRPIM_STRIFACE_PIM_SM_STR){structpim_interface*pim_ifp;VTY_DEC
LVAR_CONTEXT(interface,ifp);if(!pim_cmd_interface_add(ifp)){vty_out(vty,"Couldno
tenablePIMSMoninterface\n");returnCMD_WARNING_CONFIG_FAILED;}pim_ifp=ifp->info;p
im_if_create_pimreg(pim_ifp->pim);returnCMD_SUCCESS;}staticintpim_cmd_interface_
delete(structinterface*ifp){structpim_interface*pim_ifp=ifp->info;if(!pim_ifp)re
turn1;PIM_IF_DONT_PIM(pim_ifp->options);pim_if_membership_clear(ifp);/*pim_sock_
delete()removesallneighborsfrompim_ifp->pim_neighbor_list.*/pim_sock_delete(ifp,
"pimunconfiguredoninterface");if(!PIM_IF_TEST_IGMP(pim_ifp->options)){pim_if_add
r_del_all(ifp);pim_if_delete(ifp);}return1;}DEFUN_HIDDEN(interface_no_ip_pim_ssm
,interface_no_ip_pim_ssm_cmd,"noippimssm",NO_STRIP_STRPIM_STRIFACE_PIM_STR){VTY_
DECLVAR_CONTEXT(interface,ifp);if(!pim_cmd_interface_delete(ifp)){vty_out(vty,"U
nabletodeleteinterfaceinformation\n");returnCMD_WARNING_CONFIG_FAILED;}returnCMD
_SUCCESS;}DEFUN(interface_no_ip_pim_sm,interface_no_ip_pim_sm_cmd,"noippimsm",NO
_STRIP_STRPIM_STRIFACE_PIM_SM_STR){VTY_DECLVAR_CONTEXT(interface,ifp);if(!pim_cm
d_interface_delete(ifp)){vty_out(vty,"Unabletodeleteinterfaceinformation\n");ret
urnCMD_WARNING_CONFIG_FAILED;}returnCMD_SUCCESS;}/*boundaries*/DEFUN(interface_i
p_pim_boundary_oil,interface_ip_pim_boundary_oil_cmd,"ipmulticastboundaryoilWORD
",IP_STR"Genericmulticastconfigurationoptions\n""Definemulticastboundary\n""Filt
erOILbygroupusingprefixlist\n""PrefixlisttofilterOILwith\n"){VTY_DECLVAR_CONTEXT
(interface,iif);structpim_interface*pim_ifp;intidx=0;argv_find(argv,argc,"WORD",
&idx);PIM_GET_PIM_INTERFACE(pim_ifp,iif);if(pim_ifp->boundary_oil_plist)XFREE(MT
YPE_PIM_INTERFACE,pim_ifp->boundary_oil_plist);pim_ifp->boundary_oil_plist=XSTRD
UP(MTYPE_PIM_INTERFACE,argv[idx]->arg);/*InterfacewillbeprunedfromOILonnextJoin*
/returnCMD_SUCCESS;}DEFUN(interface_no_ip_pim_boundary_oil,interface_no_ip_pim_b
oundary_oil_cmd,"noipmulticastboundaryoil[WORD]",NO_STRIP_STR"Genericmulticastco
nfigurationoptions\n""Definemulticastboundary\n""FilterOILbygroupusingprefixlist
\n""PrefixlisttofilterOILwith\n"){VTY_DECLVAR_CONTEXT(interface,iif);structpim_i
nterface*pim_ifp;intidx=0;argv_find(argv,argc,"WORD",&idx);PIM_GET_PIM_INTERFACE
(pim_ifp,iif);if(pim_ifp->boundary_oil_plist)XFREE(MTYPE_PIM_INTERFACE,pim_ifp->
boundary_oil_plist);returnCMD_SUCCESS;}DEFUN(interface_ip_mroute,interface_ip_mr
oute_cmd,"ipmrouteINTERFACEA.B.C.D",IP_STR"Addmulticastroute\n""Outgoinginterfac
ename\n""Groupaddress\n"){VTY_DECLVAR_CONTEXT(interface,iif);structpim_interface
*pim_ifp;structpim_instance*pim;intidx_interface=2;intidx_ipv4=3;structinterface
*oif;constchar*oifname;constchar*grp_str;structin_addrgrp_addr;structin_addrsrc_
addr;intresult;PIM_GET_PIM_INTERFACE(pim_ifp,iif);pim=pim_ifp->pim;oifname=argv[
idx_interface]->arg;oif=if_lookup_by_name(oifname,pim->vrf_id);if(!oif){vty_out(
vty,"Nosuchinterfacename%s\n",oifname);returnCMD_WARNING;}grp_str=argv[idx_ipv4]
->arg;result=inet_pton(AF_INET,grp_str,&grp_addr);if(result<=0){vty_out(vty,"Bad
groupaddress%s:errno=%d:%s\n",grp_str,errno,safe_strerror(errno));returnCMD_WARN
ING;}src_addr.s_addr=INADDR_ANY;if(pim_static_add(pim,iif,oif,grp_addr,src_addr)
){vty_out(vty,"Failedtoaddroute\n");returnCMD_WARNING;}returnCMD_SUCCESS;}DEFUN(
interface_ip_mroute_source,interface_ip_mroute_source_cmd,"ipmrouteINTERFACEA.B.
C.DA.B.C.D",IP_STR"Addmulticastroute\n""Outgoinginterfacename\n""Groupaddress\n"
"Sourceaddress\n"){VTY_DECLVAR_CONTEXT(interface,iif);structpim_interface*pim_if
p;structpim_instance*pim;intidx_interface=2;intidx_ipv4=3;intidx_ipv4_2=4;struct
interface*oif;constchar*oifname;constchar*grp_str;structin_addrgrp_addr;constcha
r*src_str;structin_addrsrc_addr;intresult;PIM_GET_PIM_INTERFACE(pim_ifp,iif);pim
=pim_ifp->pim;oifname=argv[idx_interface]->arg;oif=if_lookup_by_name(oifname,pim
->vrf_id);if(!oif){vty_out(vty,"Nosuchinterfacename%s\n",oifname);returnCMD_WARN
ING;}grp_str=argv[idx_ipv4]->arg;result=inet_pton(AF_INET,grp_str,&grp_addr);if(
result<=0){vty_out(vty,"Badgroupaddress%s:errno=%d:%s\n",grp_str,errno,safe_stre
rror(errno));returnCMD_WARNING;}src_str=argv[idx_ipv4_2]->arg;result=inet_pton(A
F_INET,src_str,&src_addr);if(result<=0){vty_out(vty,"Badsourceaddress%s:errno=%d
:%s\n",src_str,errno,safe_strerror(errno));returnCMD_WARNING;}if(pim_static_add(
pim,iif,oif,grp_addr,src_addr)){vty_out(vty,"Failedtoaddroute\n");returnCMD_WARN
ING;}returnCMD_SUCCESS;}DEFUN(interface_no_ip_mroute,interface_no_ip_mroute_cmd,
"noipmrouteINTERFACEA.B.C.D",NO_STRIP_STR"Addmulticastroute\n""Outgoinginterface
name\n""GroupAddress\n"){VTY_DECLVAR_CONTEXT(interface,iif);structpim_interface*
pim_ifp;structpim_instance*pim;intidx_interface=3;intidx_ipv4=4;structinterface*
oif;constchar*oifname;constchar*grp_str;structin_addrgrp_addr;structin_addrsrc_a
ddr;intresult;PIM_GET_PIM_INTERFACE(pim_ifp,iif);pim=pim_ifp->pim;oifname=argv[i
dx_interface]->arg;oif=if_lookup_by_name(oifname,pim->vrf_id);if(!oif){vty_out(v
ty,"Nosuchinterfacename%s\n",oifname);returnCMD_WARNING;}grp_str=argv[idx_ipv4]-
>arg;result=inet_pton(AF_INET,grp_str,&grp_addr);if(result<=0){vty_out(vty,"Badg
roupaddress%s:errno=%d:%s\n",grp_str,errno,safe_strerror(errno));returnCMD_WARNI
NG;}src_addr.s_addr=INADDR_ANY;if(pim_static_del(pim,iif,oif,grp_addr,src_addr))
{vty_out(vty,"Failedtoremoveroute\n");returnCMD_WARNING;}returnCMD_SUCCESS;}DEFU
N(interface_no_ip_mroute_source,interface_no_ip_mroute_source_cmd,"noipmrouteINT
ERFACEA.B.C.DA.B.C.D",NO_STRIP_STR"Addmulticastroute\n""Outgoinginterfacename\n"
"GroupAddress\n""SourceAddress\n"){VTY_DECLVAR_CONTEXT(interface,iif);structpim_
interface*pim_ifp;structpim_instance*pim;intidx_interface=3;intidx_ipv4=4;intidx
_ipv4_2=5;structinterface*oif;constchar*oifname;constchar*grp_str;structin_addrg
rp_addr;constchar*src_str;structin_addrsrc_addr;intresult;PIM_GET_PIM_INTERFACE(
pim_ifp,iif);pim=pim_ifp->pim;oifname=argv[idx_interface]->arg;oif=if_lookup_by_
name(oifname,pim->vrf_id);if(!oif){vty_out(vty,"Nosuchinterfacename%s\n",oifname
);returnCMD_WARNING;}grp_str=argv[idx_ipv4]->arg;result=inet_pton(AF_INET,grp_st
r,&grp_addr);if(result<=0){vty_out(vty,"Badgroupaddress%s:errno=%d:%s\n",grp_str
,errno,safe_strerror(errno));returnCMD_WARNING;}src_str=argv[idx_ipv4_2]->arg;re
sult=inet_pton(AF_INET,src_str,&src_addr);if(result<=0){vty_out(vty,"Badsourcead
dress%s:errno=%d:%s\n",src_str,errno,safe_strerror(errno));returnCMD_WARNING;}if
(pim_static_del(pim,iif,oif,grp_addr,src_addr)){vty_out(vty,"Failedtoremoveroute
\n");returnCMD_WARNING;}returnCMD_SUCCESS;}DEFUN(interface_ip_pim_hello,interfac
e_ip_pim_hello_cmd,"ippimhello(1-180)[(1-180)]",IP_STRPIM_STRIFACE_PIM_HELLO_STR
IFACE_PIM_HELLO_TIME_STRIFACE_PIM_HELLO_HOLD_STR){VTY_DECLVAR_CONTEXT(interface,
ifp);intidx_time=3;intidx_hold=4;structpim_interface*pim_ifp=ifp->info;if(!pim_i
fp){if(!pim_cmd_interface_add(ifp)){vty_out(vty,"CouldnotenablePIMSMoninterface\
n");returnCMD_WARNING_CONFIG_FAILED;}}pim_ifp=ifp->info;pim_ifp->pim_hello_perio
d=strtol(argv[idx_time]->arg,NULL,10);if(argc==idx_hold+1)pim_ifp->pim_default_h
oldtime=strtol(argv[idx_hold]->arg,NULL,10);returnCMD_SUCCESS;}DEFUN(interface_n
o_ip_pim_hello,interface_no_ip_pim_hello_cmd,"noippimhello[(1-180)(1-180)]",NO_S
TRIP_STRPIM_STRIFACE_PIM_HELLO_STRIFACE_PIM_HELLO_TIME_STRIFACE_PIM_HELLO_HOLD_S
TR){VTY_DECLVAR_CONTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;if(
!pim_ifp){vty_out(vty,"Pimnotenabledonthisinterface\n");returnCMD_WARNING_CONFIG
_FAILED;}pim_ifp->pim_hello_period=PIM_DEFAULT_HELLO_PERIOD;pim_ifp->pim_default
_holdtime=-1;returnCMD_SUCCESS;}DEFUN(debug_igmp,debug_igmp_cmd,"debugigmp",DEBU
G_STRDEBUG_IGMP_STR){PIM_DO_DEBUG_IGMP_EVENTS;PIM_DO_DEBUG_IGMP_PACKETS;PIM_DO_D
EBUG_IGMP_TRACE;returnCMD_SUCCESS;}DEFUN(no_debug_igmp,no_debug_igmp_cmd,"nodebu
gigmp",NO_STRDEBUG_STRDEBUG_IGMP_STR){PIM_DONT_DEBUG_IGMP_EVENTS;PIM_DONT_DEBUG_
IGMP_PACKETS;PIM_DONT_DEBUG_IGMP_TRACE;returnCMD_SUCCESS;}DEFUN(debug_igmp_event
s,debug_igmp_events_cmd,"debugigmpevents",DEBUG_STRDEBUG_IGMP_STRDEBUG_IGMP_EVEN
TS_STR){PIM_DO_DEBUG_IGMP_EVENTS;returnCMD_SUCCESS;}DEFUN(no_debug_igmp_events,n
o_debug_igmp_events_cmd,"nodebugigmpevents",NO_STRDEBUG_STRDEBUG_IGMP_STRDEBUG_I
GMP_EVENTS_STR){PIM_DONT_DEBUG_IGMP_EVENTS;returnCMD_SUCCESS;}DEFUN(debug_igmp_p
ackets,debug_igmp_packets_cmd,"debugigmppackets",DEBUG_STRDEBUG_IGMP_STRDEBUG_IG
MP_PACKETS_STR){PIM_DO_DEBUG_IGMP_PACKETS;returnCMD_SUCCESS;}DEFUN(no_debug_igmp
_packets,no_debug_igmp_packets_cmd,"nodebugigmppackets",NO_STRDEBUG_STRDEBUG_IGM
P_STRDEBUG_IGMP_PACKETS_STR){PIM_DONT_DEBUG_IGMP_PACKETS;returnCMD_SUCCESS;}DEFU
N(debug_igmp_trace,debug_igmp_trace_cmd,"debugigmptrace",DEBUG_STRDEBUG_IGMP_STR
DEBUG_IGMP_TRACE_STR){PIM_DO_DEBUG_IGMP_TRACE;returnCMD_SUCCESS;}DEFUN(no_debug_
igmp_trace,no_debug_igmp_trace_cmd,"nodebugigmptrace",NO_STRDEBUG_STRDEBUG_IGMP_
STRDEBUG_IGMP_TRACE_STR){PIM_DONT_DEBUG_IGMP_TRACE;returnCMD_SUCCESS;}DEFUN(debu
g_mroute,debug_mroute_cmd,"debugmroute",DEBUG_STRDEBUG_MROUTE_STR){PIM_DO_DEBUG_
MROUTE;returnCMD_SUCCESS;}DEFUN(debug_mroute_detail,debug_mroute_detail_cmd,"deb
ugmroutedetail",DEBUG_STRDEBUG_MROUTE_STR"detailed\n"){PIM_DO_DEBUG_MROUTE_DETAI
L;returnCMD_SUCCESS;}DEFUN(no_debug_mroute,no_debug_mroute_cmd,"nodebugmroute",N
O_STRDEBUG_STRDEBUG_MROUTE_STR){PIM_DONT_DEBUG_MROUTE;returnCMD_SUCCESS;}DEFUN(n
o_debug_mroute_detail,no_debug_mroute_detail_cmd,"nodebugmroutedetail",NO_STRDEB
UG_STRDEBUG_MROUTE_STR"detailed\n"){PIM_DONT_DEBUG_MROUTE_DETAIL;returnCMD_SUCCE
SS;}DEFUN(debug_static,debug_static_cmd,"debugstatic",DEBUG_STRDEBUG_STATIC_STR)
{PIM_DO_DEBUG_STATIC;returnCMD_SUCCESS;}DEFUN(no_debug_static,no_debug_static_cm
d,"nodebugstatic",NO_STRDEBUG_STRDEBUG_STATIC_STR){PIM_DONT_DEBUG_STATIC;returnC
MD_SUCCESS;}DEFUN(debug_pim,debug_pim_cmd,"debugpim",DEBUG_STRDEBUG_PIM_STR){PIM
_DO_DEBUG_PIM_EVENTS;PIM_DO_DEBUG_PIM_PACKETS;PIM_DO_DEBUG_PIM_TRACE;PIM_DO_DEBU
G_MSDP_EVENTS;PIM_DO_DEBUG_MSDP_PACKETS;returnCMD_SUCCESS;}DEFUN(no_debug_pim,no
_debug_pim_cmd,"nodebugpim",NO_STRDEBUG_STRDEBUG_PIM_STR){PIM_DONT_DEBUG_PIM_EVE
NTS;PIM_DONT_DEBUG_PIM_PACKETS;PIM_DONT_DEBUG_PIM_TRACE;PIM_DONT_DEBUG_MSDP_EVEN
TS;PIM_DONT_DEBUG_MSDP_PACKETS;PIM_DONT_DEBUG_PIM_PACKETDUMP_SEND;PIM_DONT_DEBUG
_PIM_PACKETDUMP_RECV;returnCMD_SUCCESS;}DEFUN(debug_pim_nht,debug_pim_nht_cmd,"d
ebugpimnht",DEBUG_STRDEBUG_PIM_STR"NexthopTracking\n"){PIM_DO_DEBUG_PIM_NHT;retu
rnCMD_SUCCESS;}DEFUN(no_debug_pim_nht,no_debug_pim_nht_cmd,"nodebugpimnht",NO_ST
RDEBUG_STRDEBUG_PIM_STR"NexthopTracking\n"){PIM_DONT_DEBUG_PIM_NHT;returnCMD_SUC
CESS;}DEFUN(debug_pim_nht_rp,debug_pim_nht_rp_cmd,"debugpimnhtrp",DEBUG_STRDEBUG
_PIM_STR"NexthopTracking\n""RPNexthopTracking\n"){PIM_DO_DEBUG_PIM_NHT_RP;return
CMD_SUCCESS;}DEFUN(no_debug_pim_nht_rp,no_debug_pim_nht_rp_cmd,"nodebugpimnhtrp"
,NO_STRDEBUG_STRDEBUG_PIM_STR"NexthopTracking\n""RPNexthopTracking\n"){PIM_DONT_
DEBUG_PIM_NHT_RP;returnCMD_SUCCESS;}DEFUN(debug_pim_events,debug_pim_events_cmd,
"debugpimevents",DEBUG_STRDEBUG_PIM_STRDEBUG_PIM_EVENTS_STR){PIM_DO_DEBUG_PIM_EV
ENTS;returnCMD_SUCCESS;}DEFUN(no_debug_pim_events,no_debug_pim_events_cmd,"nodeb
ugpimevents",NO_STRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_EVENTS_STR){PIM_DONT_DEBUG_PI
M_EVENTS;returnCMD_SUCCESS;}DEFUN(debug_pim_packets,debug_pim_packets_cmd,"debug
pimpackets[<hello|joins|register>]",DEBUG_STRDEBUG_PIM_STRDEBUG_PIM_PACKETS_STRD
EBUG_PIM_HELLO_PACKETS_STRDEBUG_PIM_J_P_PACKETS_STRDEBUG_PIM_PIM_REG_PACKETS_STR
){intidx=0;if(argv_find(argv,argc,"hello",&idx)){PIM_DO_DEBUG_PIM_HELLO;vty_out(
vty,"PIMHellodebuggingison\n");}elseif(argv_find(argv,argc,"joins",&idx)){PIM_DO
_DEBUG_PIM_J_P;vty_out(vty,"PIMJoin/Prunedebuggingison\n");}elseif(argv_find(arg
v,argc,"register",&idx)){PIM_DO_DEBUG_PIM_REG;vty_out(vty,"PIMRegisterdebuggingi
son\n");}else{PIM_DO_DEBUG_PIM_PACKETS;vty_out(vty,"PIMPacketdebuggingison\n");}
returnCMD_SUCCESS;}DEFUN(no_debug_pim_packets,no_debug_pim_packets_cmd,"nodebugp
impackets[<hello|joins|register>]",NO_STRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_PACKETS
_STRDEBUG_PIM_HELLO_PACKETS_STRDEBUG_PIM_J_P_PACKETS_STRDEBUG_PIM_PIM_REG_PACKET
S_STR){intidx=0;if(argv_find(argv,argc,"hello",&idx)){PIM_DONT_DEBUG_PIM_HELLO;v
ty_out(vty,"PIMHellodebuggingisoff\n");}elseif(argv_find(argv,argc,"joins",&idx)
){PIM_DONT_DEBUG_PIM_J_P;vty_out(vty,"PIMJoin/Prunedebuggingisoff\n");}elseif(ar
gv_find(argv,argc,"register",&idx)){PIM_DONT_DEBUG_PIM_REG;vty_out(vty,"PIMRegis
terdebuggingisoff\n");}elsePIM_DONT_DEBUG_PIM_PACKETS;returnCMD_SUCCESS;}DEFUN(d
ebug_pim_packetdump_send,debug_pim_packetdump_send_cmd,"debugpimpacket-dumpsend"
,DEBUG_STRDEBUG_PIM_STRDEBUG_PIM_PACKETDUMP_STRDEBUG_PIM_PACKETDUMP_SEND_STR){PI
M_DO_DEBUG_PIM_PACKETDUMP_SEND;returnCMD_SUCCESS;}DEFUN(no_debug_pim_packetdump_
send,no_debug_pim_packetdump_send_cmd,"nodebugpimpacket-dumpsend",NO_STRDEBUG_ST
RDEBUG_PIM_STRDEBUG_PIM_PACKETDUMP_STRDEBUG_PIM_PACKETDUMP_SEND_STR){PIM_DONT_DE
BUG_PIM_PACKETDUMP_SEND;returnCMD_SUCCESS;}DEFUN(debug_pim_packetdump_recv,debug
_pim_packetdump_recv_cmd,"debugpimpacket-dumpreceive",DEBUG_STRDEBUG_PIM_STRDEBU
G_PIM_PACKETDUMP_STRDEBUG_PIM_PACKETDUMP_RECV_STR){PIM_DO_DEBUG_PIM_PACKETDUMP_R
ECV;returnCMD_SUCCESS;}DEFUN(no_debug_pim_packetdump_recv,no_debug_pim_packetdum
p_recv_cmd,"nodebugpimpacket-dumpreceive",NO_STRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_
PACKETDUMP_STRDEBUG_PIM_PACKETDUMP_RECV_STR){PIM_DONT_DEBUG_PIM_PACKETDUMP_RECV;
returnCMD_SUCCESS;}DEFUN(debug_pim_trace,debug_pim_trace_cmd,"debugpimtrace",DEB
UG_STRDEBUG_PIM_STRDEBUG_PIM_TRACE_STR){PIM_DO_DEBUG_PIM_TRACE;returnCMD_SUCCESS
;}DEFUN(debug_pim_trace_detail,debug_pim_trace_detail_cmd,"debugpimtracedetail",
DEBUG_STRDEBUG_PIM_STRDEBUG_PIM_TRACE_STR"DetailedInformation\n"){PIM_DO_DEBUG_P
IM_TRACE_DETAIL;returnCMD_SUCCESS;}DEFUN(no_debug_pim_trace,no_debug_pim_trace_c
md,"nodebugpimtrace",NO_STRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_TRACE_STR){PIM_DONT_D
EBUG_PIM_TRACE;returnCMD_SUCCESS;}DEFUN(no_debug_pim_trace_detail,no_debug_pim_t
race_detail_cmd,"nodebugpimtracedetail",NO_STRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_TR
ACE_STR"DetailedInformation\n"){PIM_DONT_DEBUG_PIM_TRACE_DETAIL;returnCMD_SUCCES
S;}DEFUN(debug_ssmpingd,debug_ssmpingd_cmd,"debugssmpingd",DEBUG_STRDEBUG_SSMPIN
GD_STR){PIM_DO_DEBUG_SSMPINGD;returnCMD_SUCCESS;}DEFUN(no_debug_ssmpingd,no_debu
g_ssmpingd_cmd,"nodebugssmpingd",NO_STRDEBUG_STRDEBUG_SSMPINGD_STR){PIM_DONT_DEB
UG_SSMPINGD;returnCMD_SUCCESS;}DEFUN(debug_pim_zebra,debug_pim_zebra_cmd,"debugp
imzebra",DEBUG_STRDEBUG_PIM_STRDEBUG_PIM_ZEBRA_STR){PIM_DO_DEBUG_ZEBRA;returnCMD
_SUCCESS;}DEFUN(no_debug_pim_zebra,no_debug_pim_zebra_cmd,"nodebugpimzebra",NO_S
TRDEBUG_STRDEBUG_PIM_STRDEBUG_PIM_ZEBRA_STR){PIM_DONT_DEBUG_ZEBRA;returnCMD_SUCC
ESS;}DEFUN(debug_msdp,debug_msdp_cmd,"debugmsdp",DEBUG_STRDEBUG_MSDP_STR){PIM_DO
_DEBUG_MSDP_EVENTS;PIM_DO_DEBUG_MSDP_PACKETS;returnCMD_SUCCESS;}DEFUN(no_debug_m
sdp,no_debug_msdp_cmd,"nodebugmsdp",NO_STRDEBUG_STRDEBUG_MSDP_STR){PIM_DONT_DEBU
G_MSDP_EVENTS;PIM_DONT_DEBUG_MSDP_PACKETS;returnCMD_SUCCESS;}ALIAS(no_debug_msdp
,undebug_msdp_cmd,"undebugmsdp",UNDEBUG_STRDEBUG_MSDP_STR)DEFUN(debug_msdp_event
s,debug_msdp_events_cmd,"debugmsdpevents",DEBUG_STRDEBUG_MSDP_STRDEBUG_MSDP_EVEN
TS_STR){PIM_DO_DEBUG_MSDP_EVENTS;returnCMD_SUCCESS;}DEFUN(no_debug_msdp_events,n
o_debug_msdp_events_cmd,"nodebugmsdpevents",NO_STRDEBUG_STRDEBUG_MSDP_STRDEBUG_M
SDP_EVENTS_STR){PIM_DONT_DEBUG_MSDP_EVENTS;returnCMD_SUCCESS;}ALIAS(no_debug_msd
p_events,undebug_msdp_events_cmd,"undebugmsdpevents",UNDEBUG_STRDEBUG_MSDP_STRDE
BUG_MSDP_EVENTS_STR)DEFUN(debug_msdp_packets,debug_msdp_packets_cmd,"debugmsdppa
ckets",DEBUG_STRDEBUG_MSDP_STRDEBUG_MSDP_PACKETS_STR){PIM_DO_DEBUG_MSDP_PACKETS;
returnCMD_SUCCESS;}DEFUN(no_debug_msdp_packets,no_debug_msdp_packets_cmd,"nodebu
gmsdppackets",NO_STRDEBUG_STRDEBUG_MSDP_STRDEBUG_MSDP_PACKETS_STR){PIM_DONT_DEBU
G_MSDP_PACKETS;returnCMD_SUCCESS;}ALIAS(no_debug_msdp_packets,undebug_msdp_packe
ts_cmd,"undebugmsdppackets",UNDEBUG_STRDEBUG_MSDP_STRDEBUG_MSDP_PACKETS_STR)DEFU
N(debug_mtrace,debug_mtrace_cmd,"debugmtrace",DEBUG_STRDEBUG_MTRACE_STR){PIM_DO_
DEBUG_MTRACE;returnCMD_SUCCESS;}DEFUN(no_debug_mtrace,no_debug_mtrace_cmd,"nodeb
ugmtrace",NO_STRDEBUG_STRDEBUG_MTRACE_STR){PIM_DONT_DEBUG_MTRACE;returnCMD_SUCCE
SS;}DEFUN_NOSH(show_debugging_pim,show_debugging_pim_cmd,"showdebugging[pim]",SH
OW_STRDEBUG_STRPIM_STR){vty_out(vty,"PIMdebuggingstatus\n");pim_debug_config_wri
te(vty);returnCMD_SUCCESS;}staticintinterface_pim_use_src_cmd_worker(structvty*v
ty,constchar*source){intresult;structin_addrsource_addr;intret=CMD_SUCCESS;VTY_D
ECLVAR_CONTEXT(interface,ifp);result=inet_pton(AF_INET,source,&source_addr);if(r
esult<=0){vty_out(vty,"%%Badsourceaddress%s:errno=%d:%s\n",source,errno,safe_str
error(errno));returnCMD_WARNING_CONFIG_FAILED;}result=pim_update_source_set(ifp,
source_addr);switch(result){casePIM_SUCCESS:break;casePIM_IFACE_NOT_FOUND:ret=CM
D_WARNING_CONFIG_FAILED;vty_out(vty,"Pimnotenabledonthisinterface\n");break;case
PIM_UPDATE_SOURCE_DUP:ret=CMD_WARNING;vty_out(vty,"%%Sourcealreadysetto%s\n",sou
rce);break;default:ret=CMD_WARNING_CONFIG_FAILED;vty_out(vty,"%%Sourcesetfailed\
n");}returnret;}DEFUN(interface_pim_use_source,interface_pim_use_source_cmd,"ipp
imuse-sourceA.B.C.D",IP_STR"pimmulticastrouting\n""ConfigureprimaryIPaddress\n""
sourceipaddress\n"){returninterface_pim_use_src_cmd_worker(vty,argv[3]->arg);}DE
FUN(interface_no_pim_use_source,interface_no_pim_use_source_cmd,"noippimuse-sour
ce[A.B.C.D]",NO_STRIP_STR"pimmulticastrouting\n""DeletesourceIPaddress\n""source
ipaddress\n"){returninterface_pim_use_src_cmd_worker(vty,"0.0.0.0");}DEFUN(ip_pi
m_bfd,ip_pim_bfd_cmd,"ippimbfd",IP_STRPIM_STR"EnablesBFDsupport\n"){VTY_DECLVAR_
CONTEXT(interface,ifp);structpim_interface*pim_ifp=ifp->info;structbfd_info*bfd_
info=NULL;if(!pim_ifp){if(!pim_cmd_interface_add(ifp)){vty_out(vty,"Couldnotenab
lePIMSMoninterface\n");returnCMD_WARNING;}}pim_ifp=ifp->info;bfd_info=pim_ifp->b
fd_info;if(!bfd_info||!CHECK_FLAG(bfd_info->flags,BFD_FLAG_PARAM_CFG))pim_bfd_if
_param_set(ifp,BFD_DEF_MIN_RX,BFD_DEF_MIN_TX,BFD_DEF_DETECT_MULT,1);returnCMD_SU
CCESS;}DEFUN(no_ip_pim_bfd,no_ip_pim_bfd_cmd,"noippimbfd",NO_STRIP_STRPIM_STR"Di
sablesBFDsupport\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structpim_interface*pim_
ifp=ifp->info;if(!pim_ifp){vty_out(vty,"Pimnotenabledonthisinterface\n");returnC
MD_WARNING;}if(pim_ifp->bfd_info){pim_bfd_reg_dereg_all_nbr(ifp,ZEBRA_BFD_DEST_D
EREGISTER);bfd_info_free(&(pim_ifp->bfd_info));}returnCMD_SUCCESS;}DEFUN(ip_pim_
bfd_param,ip_pim_bfd_param_cmd,"ippimbfd(2-255)(50-60000)(50-60000)",IP_STRPIM_S
TR"EnablesBFDsupport\n""DetectMultiplier\n""Requiredminreceiveinterval\n""Desire
dmintransmitinterval\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_number=3;inti
dx_number_2=4;intidx_number_3=5;uint32_trx_val;uint32_ttx_val;uint8_tdm_val;intr
et;structpim_interface*pim_ifp=ifp->info;if(!pim_ifp){if(!pim_cmd_interface_add(
ifp)){vty_out(vty,"CouldnotenablePIMSMoninterface\n");returnCMD_WARNING;}}if((re
t=bfd_validate_param(vty,argv[idx_number]->arg,argv[idx_number_2]->arg,argv[idx_
number_3]->arg,&dm_val,&rx_val,&tx_val))!=CMD_SUCCESS)returnret;pim_bfd_if_param
_set(ifp,rx_val,tx_val,dm_val,0);returnCMD_SUCCESS;}ALIAS(no_ip_pim_bfd,no_ip_pi
m_bfd_param_cmd,"noippimbfd(2-255)(50-60000)(50-60000)",NO_STRIP_STRPIM_STR"Enab
lesBFDsupport\n""DetectMultiplier\n""Requiredminreceiveinterval\n""Desiredmintra
nsmitinterval\n")staticintip_msdp_peer_cmd_worker(structpim_instance*pim,structv
ty*vty,constchar*peer,constchar*local){enumpim_msdp_errresult;structin_addrpeer_
addr;structin_addrlocal_addr;intret=CMD_SUCCESS;result=inet_pton(AF_INET,peer,&p
eer_addr);if(result<=0){vty_out(vty,"%%Badpeeraddress%s:errno=%d:%s\n",peer,errn
o,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}result=inet_pton(AF_INE
T,local,&local_addr);if(result<=0){vty_out(vty,"%%Badsourceaddress%s:errno=%d:%s
\n",local,errno,safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}result=pi
m_msdp_peer_add(pim,peer_addr,local_addr,"default",NULL/*mp_p*/);switch(result){
casePIM_MSDP_ERR_NONE:break;casePIM_MSDP_ERR_OOM:ret=CMD_WARNING_CONFIG_FAILED;v
ty_out(vty,"%%Outofmemory\n");break;casePIM_MSDP_ERR_PEER_EXISTS:ret=CMD_WARNING
;vty_out(vty,"%%Peerexists\n");break;casePIM_MSDP_ERR_MAX_MESH_GROUPS:ret=CMD_WA
RNING_CONFIG_FAILED;vty_out(vty,"%%Onlyonemesh-groupallowedcurrently\n");break;d
efault:ret=CMD_WARNING_CONFIG_FAILED;vty_out(vty,"%%peeraddfailed\n");}returnret
;}DEFUN_HIDDEN(ip_msdp_peer,ip_msdp_peer_cmd,"ipmsdppeerA.B.C.DsourceA.B.C.D",IP
_STRCFG_MSDP_STR"ConfigureMSDPpeer\n""peeripaddress\n""SourceaddressforTCPconnec
tion\n""localipaddress\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnip_msdp_peer_cmd_w
orker(pim,vty,argv[3]->arg,argv[5]->arg);}staticintip_no_msdp_peer_cmd_worker(st
ructpim_instance*pim,structvty*vty,constchar*peer){enumpim_msdp_errresult;struct
in_addrpeer_addr;result=inet_pton(AF_INET,peer,&peer_addr);if(result<=0){vty_out
(vty,"%%Badpeeraddress%s:errno=%d:%s\n",peer,errno,safe_strerror(errno));returnC
MD_WARNING_CONFIG_FAILED;}result=pim_msdp_peer_del(pim,peer_addr);switch(result)
{casePIM_MSDP_ERR_NONE:break;casePIM_MSDP_ERR_NO_PEER:vty_out(vty,"%%Peerdoesnot
exist\n");break;default:vty_out(vty,"%%peerdelfailed\n");}returnresult?CMD_WARNI
NG_CONFIG_FAILED:CMD_SUCCESS;}DEFUN_HIDDEN(no_ip_msdp_peer,no_ip_msdp_peer_cmd,"
noipmsdppeerA.B.C.D",NO_STRIP_STRCFG_MSDP_STR"DeleteMSDPpeer\n""peeripaddress\n"
){PIM_DECLVAR_CONTEXT(vrf,pim);returnip_no_msdp_peer_cmd_worker(pim,vty,argv[4]-
>arg);}staticintip_msdp_mesh_group_member_cmd_worker(structpim_instance*pim,stru
ctvty*vty,constchar*mg,constchar*mbr){enumpim_msdp_errresult;structin_addrmbr_ip
;intret=CMD_SUCCESS;result=inet_pton(AF_INET,mbr,&mbr_ip);if(result<=0){vty_out(
vty,"%%Badmemberaddress%s:errno=%d:%s\n",mbr,errno,safe_strerror(errno));returnC
MD_WARNING_CONFIG_FAILED;}result=pim_msdp_mg_mbr_add(pim,mg,mbr_ip);switch(resul
t){casePIM_MSDP_ERR_NONE:break;casePIM_MSDP_ERR_OOM:ret=CMD_WARNING_CONFIG_FAILE
D;vty_out(vty,"%%Outofmemory\n");break;casePIM_MSDP_ERR_MG_MBR_EXISTS:ret=CMD_WA
RNING;vty_out(vty,"%%mesh-groupmemberexists\n");break;casePIM_MSDP_ERR_MAX_MESH_
GROUPS:ret=CMD_WARNING_CONFIG_FAILED;vty_out(vty,"%%Onlyonemesh-groupallowedcurr
ently\n");break;default:ret=CMD_WARNING_CONFIG_FAILED;vty_out(vty,"%%memberaddfa
iled\n");}returnret;}DEFUN(ip_msdp_mesh_group_member,ip_msdp_mesh_group_member_c
md,"ipmsdpmesh-groupWORDmemberA.B.C.D",IP_STRCFG_MSDP_STR"ConfigureMSDPmesh-grou
p\n""meshgroupname\n""meshgroupmember\n""peeripaddress\n"){PIM_DECLVAR_CONTEXT(v
rf,pim);returnip_msdp_mesh_group_member_cmd_worker(pim,vty,argv[3]->arg,argv[5]-
>arg);}staticintip_no_msdp_mesh_group_member_cmd_worker(structpim_instance*pim,s
tructvty*vty,constchar*mg,constchar*mbr){enumpim_msdp_errresult;structin_addrmbr
_ip;result=inet_pton(AF_INET,mbr,&mbr_ip);if(result<=0){vty_out(vty,"%%Badmember
address%s:errno=%d:%s\n",mbr,errno,safe_strerror(errno));returnCMD_WARNING_CONFI
G_FAILED;}result=pim_msdp_mg_mbr_del(pim,mg,mbr_ip);switch(result){casePIM_MSDP_
ERR_NONE:break;casePIM_MSDP_ERR_NO_MG:vty_out(vty,"%%mesh-groupdoesnotexist\n");
break;casePIM_MSDP_ERR_NO_MG_MBR:vty_out(vty,"%%mesh-groupmemberdoesnotexist\n")
;break;default:vty_out(vty,"%%mesh-groupmemberdelfailed\n");}returnresult?CMD_WA
RNING_CONFIG_FAILED:CMD_SUCCESS;}DEFUN(no_ip_msdp_mesh_group_member,no_ip_msdp_m
esh_group_member_cmd,"noipmsdpmesh-groupWORDmemberA.B.C.D",NO_STRIP_STRCFG_MSDP_
STR"DeleteMSDPmesh-groupmember\n""meshgroupname\n""meshgroupmember\n""peeripaddr
ess\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnip_no_msdp_mesh_group_member_cmd_work
er(pim,vty,argv[4]->arg,argv[6]->arg);}staticintip_msdp_mesh_group_source_cmd_wo
rker(structpim_instance*pim,structvty*vty,constchar*mg,constchar*src){enumpim_ms
dp_errresult;structin_addrsrc_ip;result=inet_pton(AF_INET,src,&src_ip);if(result
<=0){vty_out(vty,"%%Badsourceaddress%s:errno=%d:%s\n",src,errno,safe_strerror(er
rno));returnCMD_WARNING_CONFIG_FAILED;}result=pim_msdp_mg_src_add(pim,mg,src_ip)
;switch(result){casePIM_MSDP_ERR_NONE:break;casePIM_MSDP_ERR_OOM:vty_out(vty,"%%
Outofmemory\n");break;casePIM_MSDP_ERR_MAX_MESH_GROUPS:vty_out(vty,"%%Onlyonemes
h-groupallowedcurrently\n");break;default:vty_out(vty,"%%sourceaddfailed\n");}re
turnresult?CMD_WARNING_CONFIG_FAILED:CMD_SUCCESS;}DEFUN(ip_msdp_mesh_group_sourc
e,ip_msdp_mesh_group_source_cmd,"ipmsdpmesh-groupWORDsourceA.B.C.D",IP_STRCFG_MS
DP_STR"ConfigureMSDPmesh-group\n""meshgroupname\n""meshgrouplocaladdress\n""sour
ceipaddressfortheTCPconnection\n"){PIM_DECLVAR_CONTEXT(vrf,pim);returnip_msdp_me
sh_group_source_cmd_worker(pim,vty,argv[3]->arg,argv[5]->arg);}staticintip_no_ms
dp_mesh_group_source_cmd_worker(structpim_instance*pim,structvty*vty,constchar*m
g){enumpim_msdp_errresult;result=pim_msdp_mg_src_del(pim,mg);switch(result){case
PIM_MSDP_ERR_NONE:break;casePIM_MSDP_ERR_NO_MG:vty_out(vty,"%%mesh-groupdoesnote
xist\n");break;default:vty_out(vty,"%%mesh-groupsourcedelfailed\n");}returnresul
t?CMD_WARNING_CONFIG_FAILED:CMD_SUCCESS;}staticintip_no_msdp_mesh_group_cmd_work
er(structpim_instance*pim,structvty*vty,constchar*mg){enumpim_msdp_errresult;res
ult=pim_msdp_mg_del(pim,mg);switch(result){casePIM_MSDP_ERR_NONE:break;casePIM_M
SDP_ERR_NO_MG:vty_out(vty,"%%mesh-groupdoesnotexist\n");break;default:vty_out(vt
y,"%%mesh-groupsourcedelfailed\n");}returnresult?CMD_WARNING_CONFIG_FAILED:CMD_S
UCCESS;}DEFUN(no_ip_msdp_mesh_group_source,no_ip_msdp_mesh_group_source_cmd,"noi
pmsdpmesh-groupWORDsource[A.B.C.D]",NO_STRIP_STRCFG_MSDP_STR"DeleteMSDPmesh-grou
psource\n""meshgroupname\n""meshgroupsource\n""meshgrouplocaladdress\n"){PIM_DEC
LVAR_CONTEXT(vrf,pim);if(argc==7)returnip_no_msdp_mesh_group_cmd_worker(pim,vty,
argv[6]->arg);elsereturnip_no_msdp_mesh_group_source_cmd_worker(pim,vty,argv[4]-
>arg);}staticvoidprint_empty_json_obj(structvty*vty){json_object*json;json=json_
object_new_object();vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_
C_TO_STRING_PRETTY));json_object_free(json);}staticvoidip_msdp_show_mesh_group(s
tructpim_instance*pim,structvty*vty,uint8_tuj){structlistnode*mbrnode;structpim_
msdp_mg_mbr*mbr;structpim_msdp_mg*mg=pim->msdp.mg;charmbr_str[INET_ADDRSTRLEN];c
harsrc_str[INET_ADDRSTRLEN];charstate_str[PIM_MSDP_STATE_STRLEN];enumpim_msdp_pe
er_statestate;json_object*json=NULL;json_object*json_mg_row=NULL;json_object*jso
n_members=NULL;json_object*json_row=NULL;if(!mg){if(uj)print_empty_json_obj(vty)
;return;}pim_inet4_dump("<source?>",mg->src_ip,src_str,sizeof(src_str));if(uj){j
son=json_object_new_object();/*currentlythereisonlyonemeshgroupbutweshouldstill*
make*itadictwithmg-nameaskey*/json_mg_row=json_object_new_object();json_object_s
tring_add(json_mg_row,"name",mg->mesh_group_name);json_object_string_add(json_mg
_row,"source",src_str);}else{vty_out(vty,"Meshgroup:%s\n",mg->mesh_group_name);v
ty_out(vty,"Source:%s\n",src_str);vty_out(vty,"MemberState\n");}for(ALL_LIST_ELE
MENTS_RO(mg->mbr_list,mbrnode,mbr)){pim_inet4_dump("<mbr?>",mbr->mbr_ip,mbr_str,
sizeof(mbr_str));if(mbr->mp){state=mbr->mp->state;}else{state=PIM_MSDP_DISABLED;
}pim_msdp_state_dump(state,state_str,sizeof(state_str));if(uj){json_row=json_obj
ect_new_object();json_object_string_add(json_row,"member",mbr_str);json_object_s
tring_add(json_row,"state",state_str);if(!json_members){json_members=json_object
_new_object();json_object_object_add(json_mg_row,"members",json_members);}json_o
bject_object_add(json_members,mbr_str,json_row);}else{vty_out(vty,"%-15s%11s\n",
mbr_str,state_str);}}if(uj){json_object_object_add(json,mg->mesh_group_name,json
_mg_row);vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING
_PRETTY));json_object_free(json);}}DEFUN(show_ip_msdp_mesh_group,show_ip_msdp_me
sh_group_cmd,"showipmsdp[vrfNAME]mesh-group[json]",SHOW_STRIP_STRMSDP_STRVRF_CMD
_HELP_STR"MSDPmesh-groupinformation\n"JSON_STR){uint8_tuj=use_json(argc,argv);in
tidx=2;structvrf*vrf=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WA
RNING;ip_msdp_show_mesh_group(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip
_msdp_mesh_group_vrf_all,show_ip_msdp_mesh_group_vrf_all_cmd,"showipmsdpvrfallme
sh-group[json]",SHOW_STRIP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPmesh-groupinformation
\n"JSON_STR){uint8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vt
y_out(vty,"{");RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_
out(vty,",");vty_out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:
%s\n",vrf->name);ip_msdp_show_mesh_group(vrf->info,vty,uj);}if(uj)vty_out(vty,"}
\n");returnCMD_SUCCESS;}staticvoidip_msdp_show_peers(structpim_instance*pim,stru
ctvty*vty,uint8_tuj){structlistnode*mpnode;structpim_msdp_peer*mp;charpeer_str[I
NET_ADDRSTRLEN];charlocal_str[INET_ADDRSTRLEN];charstate_str[PIM_MSDP_STATE_STRL
EN];chartimebuf[PIM_MSDP_UPTIME_STRLEN];int64_tnow;json_object*json=NULL;json_ob
ject*json_row=NULL;if(uj){json=json_object_new_object();}else{vty_out(vty,"PeerL
ocalStateUptimeSaCnt\n");}for(ALL_LIST_ELEMENTS_RO(pim->msdp.peer_list,mpnode,mp
)){if(mp->state==PIM_MSDP_ESTABLISHED){now=pim_time_monotonic_sec();pim_time_upt
ime(timebuf,sizeof(timebuf),now-mp->uptime);}else{strcpy(timebuf,"-");}pim_inet4
_dump("<peer?>",mp->peer,peer_str,sizeof(peer_str));pim_inet4_dump("<local?>",mp
->local,local_str,sizeof(local_str));pim_msdp_state_dump(mp->state,state_str,siz
eof(state_str));if(uj){json_row=json_object_new_object();json_object_string_add(
json_row,"peer",peer_str);json_object_string_add(json_row,"local",local_str);jso
n_object_string_add(json_row,"state",state_str);json_object_string_add(json_row,
"upTime",timebuf);json_object_int_add(json_row,"saCount",mp->sa_cnt);json_object
_object_add(json,peer_str,json_row);}else{vty_out(vty,"%-15s%15s%11s%8s%6d\n",pe
er_str,local_str,state_str,timebuf,mp->sa_cnt);}}if(uj){vty_out(vty,"%s\n",json_
object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);
}}staticvoidip_msdp_show_peers_detail(structpim_instance*pim,structvty*vty,const
char*peer,uint8_tuj){structlistnode*mpnode;structpim_msdp_peer*mp;charpeer_str[I
NET_ADDRSTRLEN];charlocal_str[INET_ADDRSTRLEN];charstate_str[PIM_MSDP_STATE_STRL
EN];chartimebuf[PIM_MSDP_UPTIME_STRLEN];charkatimer[PIM_MSDP_TIMER_STRLEN];charc
rtimer[PIM_MSDP_TIMER_STRLEN];charholdtimer[PIM_MSDP_TIMER_STRLEN];int64_tnow;js
on_object*json=NULL;json_object*json_row=NULL;if(uj){json=json_object_new_object
();}for(ALL_LIST_ELEMENTS_RO(pim->msdp.peer_list,mpnode,mp)){pim_inet4_dump("<pe
er?>",mp->peer,peer_str,sizeof(peer_str));if(strcmp(peer,"detail")&&strcmp(peer,
peer_str))continue;if(mp->state==PIM_MSDP_ESTABLISHED){now=pim_time_monotonic_se
c();pim_time_uptime(timebuf,sizeof(timebuf),now-mp->uptime);}else{strcpy(timebuf
,"-");}pim_inet4_dump("<local?>",mp->local,local_str,sizeof(local_str));pim_msdp
_state_dump(mp->state,state_str,sizeof(state_str));pim_time_timer_to_hhmmss(kati
mer,sizeof(katimer),mp->ka_timer);pim_time_timer_to_hhmmss(crtimer,sizeof(crtime
r),mp->cr_timer);pim_time_timer_to_hhmmss(holdtimer,sizeof(holdtimer),mp->hold_t
imer);if(uj){json_row=json_object_new_object();json_object_string_add(json_row,"
peer",peer_str);json_object_string_add(json_row,"local",local_str);json_object_s
tring_add(json_row,"meshGroupName",mp->mesh_group_name);json_object_string_add(j
son_row,"state",state_str);json_object_string_add(json_row,"upTime",timebuf);jso
n_object_string_add(json_row,"keepAliveTimer",katimer);json_object_string_add(js
on_row,"connRetryTimer",crtimer);json_object_string_add(json_row,"holdTimer",hol
dtimer);json_object_string_add(json_row,"lastReset",mp->last_reset);json_object_
int_add(json_row,"connAttempts",mp->conn_attempts);json_object_int_add(json_row,
"establishedChanges",mp->est_flaps);json_object_int_add(json_row,"saCount",mp->s
a_cnt);json_object_int_add(json_row,"kaSent",mp->ka_tx_cnt);json_object_int_add(
json_row,"kaRcvd",mp->ka_rx_cnt);json_object_int_add(json_row,"saSent",mp->sa_tx
_cnt);json_object_int_add(json_row,"saRcvd",mp->sa_rx_cnt);json_object_object_ad
d(json,peer_str,json_row);}else{vty_out(vty,"Peer:%s\n",peer_str);vty_out(vty,"L
ocal:%s\n",local_str);vty_out(vty,"MeshGroup:%s\n",mp->mesh_group_name);vty_out(
vty,"State:%s\n",state_str);vty_out(vty,"Uptime:%s\n",timebuf);vty_out(vty,"Keep
aliveTimer:%s\n",katimer);vty_out(vty,"ConnRetryTimer:%s\n",crtimer);vty_out(vty
,"HoldTimer:%s\n",holdtimer);vty_out(vty,"LastReset:%s\n",mp->last_reset);vty_ou
t(vty,"ConnAttempts:%d\n",mp->conn_attempts);vty_out(vty,"EstablishedChanges:%d\
n",mp->est_flaps);vty_out(vty,"SACount:%d\n",mp->sa_cnt);vty_out(vty,"Statistics
:\n");vty_out(vty,"SentRcvd\n");vty_out(vty,"Keepalives:%10d%10d\n",mp->ka_tx_cn
t,mp->ka_rx_cnt);vty_out(vty,"SAs:%10d%10d\n",mp->sa_tx_cnt,mp->sa_rx_cnt);vty_o
ut(vty,"\n");}}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSO
N_C_TO_STRING_PRETTY));json_object_free(json);}}DEFUN(show_ip_msdp_peer_detail,s
how_ip_msdp_peer_detail_cmd,"showipmsdp[vrfNAME]peer[detail|A.B.C.D][json]",SHOW
_STRIP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPpeerinformation\n""Detailedoutput\n""peer
ipaddress\n"JSON_STR){uint8_tuj=use_json(argc,argv);intidx=2;structvrf*vrf=pim_c
md_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;char*arg=NULL;if(arg
v_find(argv,argc,"detail",&idx))arg=argv[idx]->text;elseif(argv_find(argv,argc,"
A.B.C.D",&idx))arg=argv[idx]->arg;if(arg)ip_msdp_show_peers_detail(vrf->info,vty
,argv[idx]->arg,uj);elseip_msdp_show_peers(vrf->info,vty,uj);returnCMD_SUCCESS;}
DEFUN(show_ip_msdp_peer_detail_vrf_all,show_ip_msdp_peer_detail_vrf_all_cmd,"sho
wipmsdpvrfallpeer[detail|A.B.C.D][json]",SHOW_STRIP_STRMSDP_STRVRF_CMD_HELP_STR"
MSDPpeerinformation\n""Detailedoutput\n""peeripaddress\n"JSON_STR){intidx=2;uint
8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_out(vty,"{");RB
_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_
out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);
if(argv_find(argv,argc,"detail",&idx)||argv_find(argv,argc,"A.B.C.D",&idx))ip_ms
dp_show_peers_detail(vrf->info,vty,argv[idx]->arg,uj);elseip_msdp_show_peers(vrf
->info,vty,uj);}if(uj)vty_out(vty,"}\n");returnCMD_SUCCESS;}staticvoidip_msdp_sh
ow_sa(structpim_instance*pim,structvty*vty,uint8_tuj){structlistnode*sanode;stru
ctpim_msdp_sa*sa;charsrc_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];charr
p_str[INET_ADDRSTRLEN];chartimebuf[PIM_MSDP_UPTIME_STRLEN];charspt_str[8];charlo
cal_str[8];int64_tnow;json_object*json=NULL;json_object*json_group=NULL;json_obj
ect*json_row=NULL;if(uj){json=json_object_new_object();}else{vty_out(vty,"Source
GroupRPLocalSPTUptime\n");}for(ALL_LIST_ELEMENTS_RO(pim->msdp.sa_list,sanode,sa)
){now=pim_time_monotonic_sec();pim_time_uptime(timebuf,sizeof(timebuf),now-sa->u
ptime);pim_inet4_dump("<src?>",sa->sg.src,src_str,sizeof(src_str));pim_inet4_dum
p("<grp?>",sa->sg.grp,grp_str,sizeof(grp_str));if(sa->flags&PIM_MSDP_SAF_PEER){p
im_inet4_dump("<rp?>",sa->rp,rp_str,sizeof(rp_str));if(sa->up){strcpy(spt_str,"y
es");}else{strcpy(spt_str,"no");}}else{strcpy(rp_str,"-");strcpy(spt_str,"-");}i
f(sa->flags&PIM_MSDP_SAF_LOCAL){strcpy(local_str,"yes");}else{strcpy(local_str,"
no");}if(uj){json_object_object_get_ex(json,grp_str,&json_group);if(!json_group)
{json_group=json_object_new_object();json_object_object_add(json,grp_str,json_gr
oup);}json_row=json_object_new_object();json_object_string_add(json_row,"source"
,src_str);json_object_string_add(json_row,"group",grp_str);json_object_string_ad
d(json_row,"rp",rp_str);json_object_string_add(json_row,"local",local_str);json_
object_string_add(json_row,"sptSetup",spt_str);json_object_string_add(json_row,"
upTime",timebuf);json_object_object_add(json_group,src_str,json_row);}else{vty_o
ut(vty,"%-15s%15s%15s%5c%3c%8s\n",src_str,grp_str,rp_str,local_str[0],spt_str[0]
,timebuf);}}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C
_TO_STRING_PRETTY));json_object_free(json);}}staticvoidip_msdp_show_sa_entry_det
ail(structpim_msdp_sa*sa,constchar*src_str,constchar*grp_str,structvty*vty,uint8
_tuj,json_object*json){charrp_str[INET_ADDRSTRLEN];charpeer_str[INET_ADDRSTRLEN]
;chartimebuf[PIM_MSDP_UPTIME_STRLEN];charspt_str[8];charlocal_str[8];charstateti
mer[PIM_MSDP_TIMER_STRLEN];int64_tnow;json_object*json_group=NULL;json_object*js
on_row=NULL;now=pim_time_monotonic_sec();pim_time_uptime(timebuf,sizeof(timebuf)
,now-sa->uptime);if(sa->flags&PIM_MSDP_SAF_PEER){pim_inet4_dump("<rp?>",sa->rp,r
p_str,sizeof(rp_str));pim_inet4_dump("<peer?>",sa->peer,peer_str,sizeof(peer_str
));if(sa->up){strcpy(spt_str,"yes");}else{strcpy(spt_str,"no");}}else{strcpy(rp_
str,"-");strcpy(peer_str,"-");strcpy(spt_str,"-");}if(sa->flags&PIM_MSDP_SAF_LOC
AL){strcpy(local_str,"yes");}else{strcpy(local_str,"no");}pim_time_timer_to_hhmm
ss(statetimer,sizeof(statetimer),sa->sa_state_timer);if(uj){json_object_object_g
et_ex(json,grp_str,&json_group);if(!json_group){json_group=json_object_new_objec
t();json_object_object_add(json,grp_str,json_group);}json_row=json_object_new_ob
ject();json_object_string_add(json_row,"source",src_str);json_object_string_add(
json_row,"group",grp_str);json_object_string_add(json_row,"rp",rp_str);json_obje
ct_string_add(json_row,"local",local_str);json_object_string_add(json_row,"sptSe
tup",spt_str);json_object_string_add(json_row,"upTime",timebuf);json_object_stri
ng_add(json_row,"stateTimer",statetimer);json_object_object_add(json_group,src_s
tr,json_row);}else{vty_out(vty,"SA:%s\n",sa->sg_str);vty_out(vty,"RP:%s\n",rp_st
r);vty_out(vty,"Peer:%s\n",peer_str);vty_out(vty,"Local:%s\n",local_str);vty_out
(vty,"SPTSetup:%s\n",spt_str);vty_out(vty,"Uptime:%s\n",timebuf);vty_out(vty,"St
ateTimer:%s\n",statetimer);vty_out(vty,"\n");}}staticvoidip_msdp_show_sa_detail(
structpim_instance*pim,structvty*vty,uint8_tuj){structlistnode*sanode;structpim_
msdp_sa*sa;charsrc_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];json_object
*json=NULL;if(uj){json=json_object_new_object();}for(ALL_LIST_ELEMENTS_RO(pim->m
sdp.sa_list,sanode,sa)){pim_inet4_dump("<src?>",sa->sg.src,src_str,sizeof(src_st
r));pim_inet4_dump("<grp?>",sa->sg.grp,grp_str,sizeof(grp_str));ip_msdp_show_sa_
entry_detail(sa,src_str,grp_str,vty,uj,json);}if(uj){vty_out(vty,"%s\n",json_obj
ect_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}D
EFUN(show_ip_msdp_sa_detail,show_ip_msdp_sa_detail_cmd,"showipmsdp[vrfNAME]sadet
ail[json]",SHOW_STRIP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPactive-sourceinformation\n
""Detailedoutput\n"JSON_STR){uint8_tuj=use_json(argc,argv);intidx=2;structvrf*vr
f=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;ip_msdp_show_
sa_detail(vrf->info,vty,uj);returnCMD_SUCCESS;}DEFUN(show_ip_msdp_sa_detail_vrf_
all,show_ip_msdp_sa_detail_vrf_all_cmd,"showipmsdpvrfallsadetail[json]",SHOW_STR
IP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPactive-sourceinformation\n""Detailedoutput\n"
JSON_STR){uint8_tuj=use_json(argc,argv);structvrf*vrf;boolfirst=true;if(uj)vty_o
ut(vty,"{");RB_FOREACH(vrf,vrf_name_head,&vrfs_by_name){if(uj){if(!first)vty_out
(vty,",");vty_out(vty,"\"%s\":",vrf->name);first=false;}elsevty_out(vty,"VRF:%s\
n",vrf->name);ip_msdp_show_sa_detail(vrf->info,vty,uj);}if(uj)vty_out(vty,"}\n")
;returnCMD_SUCCESS;}staticvoidip_msdp_show_sa_addr(structpim_instance*pim,struct
vty*vty,constchar*addr,uint8_tuj){structlistnode*sanode;structpim_msdp_sa*sa;cha
rsrc_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN];json_object*json=NULL;if(
uj){json=json_object_new_object();}for(ALL_LIST_ELEMENTS_RO(pim->msdp.sa_list,sa
node,sa)){pim_inet4_dump("<src?>",sa->sg.src,src_str,sizeof(src_str));pim_inet4_
dump("<grp?>",sa->sg.grp,grp_str,sizeof(grp_str));if(!strcmp(addr,src_str)||!str
cmp(addr,grp_str)){ip_msdp_show_sa_entry_detail(sa,src_str,grp_str,vty,uj,json);
}}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING
_PRETTY));json_object_free(json);}}staticvoidip_msdp_show_sa_sg(structpim_instan
ce*pim,structvty*vty,constchar*src,constchar*grp,uint8_tuj){structlistnode*sanod
e;structpim_msdp_sa*sa;charsrc_str[INET_ADDRSTRLEN];chargrp_str[INET_ADDRSTRLEN]
;json_object*json=NULL;if(uj){json=json_object_new_object();}for(ALL_LIST_ELEMEN
TS_RO(pim->msdp.sa_list,sanode,sa)){pim_inet4_dump("<src?>",sa->sg.src,src_str,s
izeof(src_str));pim_inet4_dump("<grp?>",sa->sg.grp,grp_str,sizeof(grp_str));if(!
strcmp(src,src_str)&&!strcmp(grp,grp_str)){ip_msdp_show_sa_entry_detail(sa,src_s
tr,grp_str,vty,uj,json);}}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_e
xt(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}}DEFUN(show_ip_msdp_sa
_sg,show_ip_msdp_sa_sg_cmd,"showipmsdp[vrfNAME]sa[A.B.C.D[A.B.C.D]][json]",SHOW_
STRIP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPactive-sourceinformation\n""sourceorgroupi
p\n""groupip\n"JSON_STR){uint8_tuj=use_json(argc,argv);structvrf*vrf;intidx=2;vr
f=pim_cmd_lookup_vrf(vty,argv,argc,&idx);if(!vrf)returnCMD_WARNING;char*src_ip=a
rgv_find(argv,argc,"A.B.C.D",&idx)?argv[idx++]->arg:NULL;char*grp_ip=idx<argc&&a
rgv_find(argv,argc,"A.B.C.D",&idx)?argv[idx]->arg:NULL;if(src_ip&&grp_ip)ip_msdp
_show_sa_sg(vrf->info,vty,src_ip,grp_ip,uj);elseif(src_ip)ip_msdp_show_sa_addr(v
rf->info,vty,src_ip,uj);elseip_msdp_show_sa(vrf->info,vty,uj);returnCMD_SUCCESS;
}DEFUN(show_ip_msdp_sa_sg_vrf_all,show_ip_msdp_sa_sg_vrf_all_cmd,"showipmsdpvrfa
llsa[A.B.C.D[A.B.C.D]][json]",SHOW_STRIP_STRMSDP_STRVRF_CMD_HELP_STR"MSDPactive-
sourceinformation\n""sourceorgroupip\n""groupip\n"JSON_STR){uint8_tuj=use_json(a
rgc,argv);structvrf*vrf;boolfirst=true;intidx=2;char*src_ip=argv_find(argv,argc,
"A.B.C.D",&idx)?argv[idx++]->arg:NULL;char*grp_ip=idx<argc&&argv_find(argv,argc,
"A.B.C.D",&idx)?argv[idx]->arg:NULL;if(uj)vty_out(vty,"{");RB_FOREACH(vrf,vrf_na
me_head,&vrfs_by_name){if(uj){if(!first)vty_out(vty,",");vty_out(vty,"\"%s\":",v
rf->name);first=false;}elsevty_out(vty,"VRF:%s\n",vrf->name);if(src_ip&&grp_ip)i
p_msdp_show_sa_sg(vrf->info,vty,src_ip,grp_ip,uj);elseif(src_ip)ip_msdp_show_sa_
addr(vrf->info,vty,src_ip,uj);elseip_msdp_show_sa(vrf->info,vty,uj);}if(uj)vty_o
ut(vty,"}\n");returnCMD_SUCCESS;}voidpim_cmd_init(void){install_node(&interface_
node,pim_interface_config_write);/*INTERFACE_NODE*/if_cmd_init();install_node(&d
ebug_node,pim_debug_config_write);install_element(CONFIG_NODE,&ip_multicast_rout
ing_cmd);install_element(CONFIG_NODE,&no_ip_multicast_routing_cmd);install_eleme
nt(CONFIG_NODE,&ip_pim_rp_cmd);install_element(VRF_NODE,&ip_pim_rp_cmd);install_
element(CONFIG_NODE,&no_ip_pim_rp_cmd);install_element(VRF_NODE,&no_ip_pim_rp_cm
d);install_element(CONFIG_NODE,&ip_pim_rp_prefix_list_cmd);install_element(VRF_N
ODE,&ip_pim_rp_prefix_list_cmd);install_element(CONFIG_NODE,&no_ip_pim_rp_prefix
_list_cmd);install_element(VRF_NODE,&no_ip_pim_rp_prefix_list_cmd);install_eleme
nt(CONFIG_NODE,&no_ip_pim_ssm_prefix_list_cmd);install_element(VRF_NODE,&no_ip_p
im_ssm_prefix_list_cmd);install_element(CONFIG_NODE,&no_ip_pim_ssm_prefix_list_n
ame_cmd);install_element(VRF_NODE,&no_ip_pim_ssm_prefix_list_name_cmd);install_e
lement(CONFIG_NODE,&ip_pim_ssm_prefix_list_cmd);install_element(VRF_NODE,&ip_pim
_ssm_prefix_list_cmd);install_element(CONFIG_NODE,&ip_pim_register_suppress_cmd)
;install_element(VRF_NODE,&ip_pim_register_suppress_cmd);install_element(CONFIG_
NODE,&no_ip_pim_register_suppress_cmd);install_element(VRF_NODE,&no_ip_pim_regis
ter_suppress_cmd);install_element(CONFIG_NODE,&ip_pim_spt_switchover_infinity_cm
d);install_element(VRF_NODE,&ip_pim_spt_switchover_infinity_cmd);install_element
(CONFIG_NODE,&ip_pim_spt_switchover_infinity_plist_cmd);install_element(VRF_NODE
,&ip_pim_spt_switchover_infinity_plist_cmd);install_element(CONFIG_NODE,&no_ip_p
im_spt_switchover_infinity_cmd);install_element(VRF_NODE,&no_ip_pim_spt_switchov
er_infinity_cmd);install_element(CONFIG_NODE,&no_ip_pim_spt_switchover_infinity_
plist_cmd);install_element(VRF_NODE,&no_ip_pim_spt_switchover_infinity_plist_cmd
);install_element(CONFIG_NODE,&ip_pim_joinprune_time_cmd);install_element(VRF_NO
DE,&ip_pim_joinprune_time_cmd);install_element(CONFIG_NODE,&no_ip_pim_joinprune_
time_cmd);install_element(VRF_NODE,&no_ip_pim_joinprune_time_cmd);install_elemen
t(CONFIG_NODE,&ip_pim_keep_alive_cmd);install_element(VRF_NODE,&ip_pim_keep_aliv
e_cmd);install_element(CONFIG_NODE,&ip_pim_rp_keep_alive_cmd);install_element(VR
F_NODE,&ip_pim_rp_keep_alive_cmd);install_element(CONFIG_NODE,&no_ip_pim_keep_al
ive_cmd);install_element(VRF_NODE,&no_ip_pim_keep_alive_cmd);install_element(CON
FIG_NODE,&no_ip_pim_rp_keep_alive_cmd);install_element(VRF_NODE,&no_ip_pim_rp_ke
ep_alive_cmd);install_element(CONFIG_NODE,&ip_pim_packets_cmd);install_element(V
RF_NODE,&ip_pim_packets_cmd);install_element(CONFIG_NODE,&no_ip_pim_packets_cmd)
;install_element(VRF_NODE,&no_ip_pim_packets_cmd);install_element(CONFIG_NODE,&i
p_pim_v6_secondary_cmd);install_element(VRF_NODE,&ip_pim_v6_secondary_cmd);insta
ll_element(CONFIG_NODE,&no_ip_pim_v6_secondary_cmd);install_element(VRF_NODE,&no
_ip_pim_v6_secondary_cmd);install_element(CONFIG_NODE,&ip_ssmpingd_cmd);install_
element(VRF_NODE,&ip_ssmpingd_cmd);install_element(CONFIG_NODE,&no_ip_ssmpingd_c
md);install_element(VRF_NODE,&no_ip_ssmpingd_cmd);install_element(CONFIG_NODE,&i
p_msdp_peer_cmd);install_element(VRF_NODE,&ip_msdp_peer_cmd);install_element(CON
FIG_NODE,&no_ip_msdp_peer_cmd);install_element(VRF_NODE,&no_ip_msdp_peer_cmd);in
stall_element(CONFIG_NODE,&ip_pim_ecmp_cmd);install_element(VRF_NODE,&ip_pim_ecm
p_cmd);install_element(CONFIG_NODE,&no_ip_pim_ecmp_cmd);install_element(VRF_NODE
,&no_ip_pim_ecmp_cmd);install_element(CONFIG_NODE,&ip_pim_ecmp_rebalance_cmd);in
stall_element(VRF_NODE,&ip_pim_ecmp_rebalance_cmd);install_element(CONFIG_NODE,&
no_ip_pim_ecmp_rebalance_cmd);install_element(VRF_NODE,&no_ip_pim_ecmp_rebalance
_cmd);install_element(INTERFACE_NODE,&interface_ip_igmp_cmd);install_element(INT
ERFACE_NODE,&interface_no_ip_igmp_cmd);install_element(INTERFACE_NODE,&interface
_ip_igmp_join_cmd);install_element(INTERFACE_NODE,&interface_no_ip_igmp_join_cmd
);install_element(INTERFACE_NODE,&interface_ip_igmp_version_cmd);install_element
(INTERFACE_NODE,&interface_no_ip_igmp_version_cmd);install_element(INTERFACE_NOD
E,&interface_ip_igmp_query_interval_cmd);install_element(INTERFACE_NODE,&interfa
ce_no_ip_igmp_query_interval_cmd);install_element(INTERFACE_NODE,&interface_ip_i
gmp_query_max_response_time_cmd);install_element(INTERFACE_NODE,&interface_no_ip
_igmp_query_max_response_time_cmd);install_element(INTERFACE_NODE,&interface_ip_
igmp_query_max_response_time_dsec_cmd);install_element(INTERFACE_NODE,&interface
_no_ip_igmp_query_max_response_time_dsec_cmd);install_element(INTERFACE_NODE,&in
terface_ip_pim_ssm_cmd);install_element(INTERFACE_NODE,&interface_no_ip_pim_ssm_
cmd);install_element(INTERFACE_NODE,&interface_ip_pim_sm_cmd);install_element(IN
TERFACE_NODE,&interface_no_ip_pim_sm_cmd);install_element(INTERFACE_NODE,&interf
ace_ip_pim_drprio_cmd);install_element(INTERFACE_NODE,&interface_no_ip_pim_drpri
o_cmd);install_element(INTERFACE_NODE,&interface_ip_pim_hello_cmd);install_eleme
nt(INTERFACE_NODE,&interface_no_ip_pim_hello_cmd);install_element(INTERFACE_NODE
,&interface_ip_pim_boundary_oil_cmd);install_element(INTERFACE_NODE,&interface_n
o_ip_pim_boundary_oil_cmd);//StaticmroutesNEBinstall_element(INTERFACE_NODE,&int
erface_ip_mroute_cmd);install_element(INTERFACE_NODE,&interface_ip_mroute_source
_cmd);install_element(INTERFACE_NODE,&interface_no_ip_mroute_cmd);install_elemen
t(INTERFACE_NODE,&interface_no_ip_mroute_source_cmd);install_element(VIEW_NODE,&
show_ip_igmp_interface_cmd);install_element(VIEW_NODE,&show_ip_igmp_interface_vr
f_all_cmd);install_element(VIEW_NODE,&show_ip_igmp_join_cmd);install_element(VIE
W_NODE,&show_ip_igmp_join_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_igmp_g
roups_cmd);install_element(VIEW_NODE,&show_ip_igmp_groups_vrf_all_cmd);install_e
lement(VIEW_NODE,&show_ip_igmp_groups_retransmissions_cmd);install_element(VIEW_
NODE,&show_ip_igmp_sources_cmd);install_element(VIEW_NODE,&show_ip_igmp_sources_
retransmissions_cmd);install_element(VIEW_NODE,&show_ip_pim_assert_cmd);install_
element(VIEW_NODE,&show_ip_pim_assert_internal_cmd);install_element(VIEW_NODE,&s
how_ip_pim_assert_metric_cmd);install_element(VIEW_NODE,&show_ip_pim_assert_winn
er_metric_cmd);install_element(VIEW_NODE,&show_ip_pim_interface_traffic_cmd);ins
tall_element(VIEW_NODE,&show_ip_pim_interface_cmd);install_element(VIEW_NODE,&sh
ow_ip_pim_interface_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_pim_join_cmd
);install_element(VIEW_NODE,&show_ip_pim_join_vrf_all_cmd);install_element(VIEW_
NODE,&show_ip_pim_local_membership_cmd);install_element(VIEW_NODE,&show_ip_pim_n
eighbor_cmd);install_element(VIEW_NODE,&show_ip_pim_neighbor_vrf_all_cmd);instal
l_element(VIEW_NODE,&show_ip_pim_rpf_cmd);install_element(VIEW_NODE,&show_ip_pim
_rpf_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_pim_secondary_cmd);install_
element(VIEW_NODE,&show_ip_pim_state_cmd);install_element(VIEW_NODE,&show_ip_pim
_state_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_pim_upstream_cmd);install
_element(VIEW_NODE,&show_ip_pim_upstream_vrf_all_cmd);install_element(VIEW_NODE,
&show_ip_pim_upstream_join_desired_cmd);install_element(VIEW_NODE,&show_ip_pim_u
pstream_rpf_cmd);install_element(VIEW_NODE,&show_ip_pim_rp_cmd);install_element(
VIEW_NODE,&show_ip_pim_rp_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_multic
ast_cmd);install_element(VIEW_NODE,&show_ip_multicast_vrf_all_cmd);install_eleme
nt(VIEW_NODE,&show_ip_mroute_cmd);install_element(VIEW_NODE,&show_ip_mroute_vrf_
all_cmd);install_element(VIEW_NODE,&show_ip_mroute_count_cmd);install_element(VI
EW_NODE,&show_ip_mroute_count_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_ri
b_cmd);install_element(VIEW_NODE,&show_ip_ssmpingd_cmd);install_element(VIEW_NOD
E,&show_debugging_pim_cmd);install_element(VIEW_NODE,&show_ip_pim_nexthop_cmd);i
nstall_element(VIEW_NODE,&show_ip_pim_nexthop_lookup_cmd);install_element(ENABLE
_NODE,&clear_ip_interfaces_cmd);install_element(ENABLE_NODE,&clear_ip_igmp_inter
faces_cmd);install_element(ENABLE_NODE,&clear_ip_mroute_cmd);install_element(ENA
BLE_NODE,&clear_ip_pim_interfaces_cmd);install_element(ENABLE_NODE,&clear_ip_pim
_interface_traffic_cmd);install_element(ENABLE_NODE,&clear_ip_pim_oil_cmd);insta
ll_element(ENABLE_NODE,&debug_igmp_cmd);install_element(ENABLE_NODE,&no_debug_ig
mp_cmd);install_element(ENABLE_NODE,&debug_igmp_events_cmd);install_element(ENAB
LE_NODE,&no_debug_igmp_events_cmd);install_element(ENABLE_NODE,&debug_igmp_packe
ts_cmd);install_element(ENABLE_NODE,&no_debug_igmp_packets_cmd);install_element(
ENABLE_NODE,&debug_igmp_trace_cmd);install_element(ENABLE_NODE,&no_debug_igmp_tr
ace_cmd);install_element(ENABLE_NODE,&debug_mroute_cmd);install_element(ENABLE_N
ODE,&debug_mroute_detail_cmd);install_element(ENABLE_NODE,&no_debug_mroute_cmd);
install_element(ENABLE_NODE,&no_debug_mroute_detail_cmd);install_element(ENABLE_
NODE,&debug_static_cmd);install_element(ENABLE_NODE,&no_debug_static_cmd);instal
l_element(ENABLE_NODE,&debug_pim_cmd);install_element(ENABLE_NODE,&no_debug_pim_
cmd);install_element(ENABLE_NODE,&debug_pim_nht_cmd);install_element(ENABLE_NODE
,&no_debug_pim_nht_cmd);install_element(ENABLE_NODE,&debug_pim_nht_rp_cmd);insta
ll_element(ENABLE_NODE,&no_debug_pim_nht_rp_cmd);install_element(ENABLE_NODE,&de
bug_pim_events_cmd);install_element(ENABLE_NODE,&no_debug_pim_events_cmd);instal
l_element(ENABLE_NODE,&debug_pim_packets_cmd);install_element(ENABLE_NODE,&no_de
bug_pim_packets_cmd);install_element(ENABLE_NODE,&debug_pim_packetdump_send_cmd)
;install_element(ENABLE_NODE,&no_debug_pim_packetdump_send_cmd);install_element(
ENABLE_NODE,&debug_pim_packetdump_recv_cmd);install_element(ENABLE_NODE,&no_debu
g_pim_packetdump_recv_cmd);install_element(ENABLE_NODE,&debug_pim_trace_cmd);ins
tall_element(ENABLE_NODE,&no_debug_pim_trace_cmd);install_element(ENABLE_NODE,&d
ebug_pim_trace_detail_cmd);install_element(ENABLE_NODE,&no_debug_pim_trace_detai
l_cmd);install_element(ENABLE_NODE,&debug_ssmpingd_cmd);install_element(ENABLE_N
ODE,&no_debug_ssmpingd_cmd);install_element(ENABLE_NODE,&debug_pim_zebra_cmd);in
stall_element(ENABLE_NODE,&no_debug_pim_zebra_cmd);install_element(ENABLE_NODE,&
debug_msdp_cmd);install_element(ENABLE_NODE,&no_debug_msdp_cmd);install_element(
ENABLE_NODE,&undebug_msdp_cmd);install_element(ENABLE_NODE,&debug_msdp_events_cm
d);install_element(ENABLE_NODE,&no_debug_msdp_events_cmd);install_element(ENABLE
_NODE,&undebug_msdp_events_cmd);install_element(ENABLE_NODE,&debug_msdp_packets_
cmd);install_element(ENABLE_NODE,&no_debug_msdp_packets_cmd);install_element(ENA
BLE_NODE,&undebug_msdp_packets_cmd);install_element(ENABLE_NODE,&debug_mtrace_cm
d);install_element(ENABLE_NODE,&no_debug_mtrace_cmd);install_element(CONFIG_NODE
,&debug_igmp_cmd);install_element(CONFIG_NODE,&no_debug_igmp_cmd);install_elemen
t(CONFIG_NODE,&debug_igmp_events_cmd);install_element(CONFIG_NODE,&no_debug_igmp
_events_cmd);install_element(CONFIG_NODE,&debug_igmp_packets_cmd);install_elemen
t(CONFIG_NODE,&no_debug_igmp_packets_cmd);install_element(CONFIG_NODE,&debug_igm
p_trace_cmd);install_element(CONFIG_NODE,&no_debug_igmp_trace_cmd);install_eleme
nt(CONFIG_NODE,&debug_mroute_cmd);install_element(CONFIG_NODE,&debug_mroute_deta
il_cmd);install_element(CONFIG_NODE,&no_debug_mroute_cmd);install_element(CONFIG
_NODE,&no_debug_mroute_detail_cmd);install_element(CONFIG_NODE,&debug_static_cmd
);install_element(CONFIG_NODE,&no_debug_static_cmd);install_element(CONFIG_NODE,
&debug_pim_cmd);install_element(CONFIG_NODE,&no_debug_pim_cmd);install_element(C
ONFIG_NODE,&debug_pim_nht_cmd);install_element(CONFIG_NODE,&no_debug_pim_nht_cmd
);install_element(CONFIG_NODE,&debug_pim_nht_rp_cmd);install_element(CONFIG_NODE
,&no_debug_pim_nht_rp_cmd);install_element(CONFIG_NODE,&debug_pim_events_cmd);in
stall_element(CONFIG_NODE,&no_debug_pim_events_cmd);install_element(CONFIG_NODE,
&debug_pim_packets_cmd);install_element(CONFIG_NODE,&no_debug_pim_packets_cmd);i
nstall_element(CONFIG_NODE,&debug_pim_trace_cmd);install_element(CONFIG_NODE,&no
_debug_pim_trace_cmd);install_element(CONFIG_NODE,&debug_pim_trace_detail_cmd);i
nstall_element(CONFIG_NODE,&no_debug_pim_trace_detail_cmd);install_element(CONFI
G_NODE,&debug_ssmpingd_cmd);install_element(CONFIG_NODE,&no_debug_ssmpingd_cmd);
install_element(CONFIG_NODE,&debug_pim_zebra_cmd);install_element(CONFIG_NODE,&n
o_debug_pim_zebra_cmd);install_element(CONFIG_NODE,&debug_msdp_cmd);install_elem
ent(CONFIG_NODE,&no_debug_msdp_cmd);install_element(CONFIG_NODE,&undebug_msdp_cm
d);install_element(CONFIG_NODE,&debug_msdp_events_cmd);install_element(CONFIG_NO
DE,&no_debug_msdp_events_cmd);install_element(CONFIG_NODE,&undebug_msdp_events_c
md);install_element(CONFIG_NODE,&debug_msdp_packets_cmd);install_element(CONFIG_
NODE,&no_debug_msdp_packets_cmd);install_element(CONFIG_NODE,&undebug_msdp_packe
ts_cmd);install_element(CONFIG_NODE,&debug_mtrace_cmd);install_element(CONFIG_NO
DE,&no_debug_mtrace_cmd);install_element(CONFIG_NODE,&ip_msdp_mesh_group_member_
cmd);install_element(VRF_NODE,&ip_msdp_mesh_group_member_cmd);install_element(CO
NFIG_NODE,&no_ip_msdp_mesh_group_member_cmd);install_element(VRF_NODE,&no_ip_msd
p_mesh_group_member_cmd);install_element(CONFIG_NODE,&ip_msdp_mesh_group_source_
cmd);install_element(VRF_NODE,&ip_msdp_mesh_group_source_cmd);install_element(CO
NFIG_NODE,&no_ip_msdp_mesh_group_source_cmd);install_element(VRF_NODE,&no_ip_msd
p_mesh_group_source_cmd);install_element(VIEW_NODE,&show_ip_msdp_peer_detail_cmd
);install_element(VIEW_NODE,&show_ip_msdp_peer_detail_vrf_all_cmd);install_eleme
nt(VIEW_NODE,&show_ip_msdp_sa_detail_cmd);install_element(VIEW_NODE,&show_ip_msd
p_sa_detail_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_msdp_sa_sg_cmd);inst
all_element(VIEW_NODE,&show_ip_msdp_sa_sg_vrf_all_cmd);install_element(VIEW_NODE
,&show_ip_msdp_mesh_group_cmd);install_element(VIEW_NODE,&show_ip_msdp_mesh_grou
p_vrf_all_cmd);install_element(VIEW_NODE,&show_ip_pim_ssm_range_cmd);install_ele
ment(VIEW_NODE,&show_ip_pim_group_type_cmd);install_element(INTERFACE_NODE,&inte
rface_pim_use_source_cmd);install_element(INTERFACE_NODE,&interface_no_pim_use_s
ource_cmd);/*InstallBFDcommand*/install_element(INTERFACE_NODE,&ip_pim_bfd_cmd);
install_element(INTERFACE_NODE,&ip_pim_bfd_param_cmd);install_element(INTERFACE_
NODE,&no_ip_pim_bfd_cmd);install_element(INTERFACE_NODE,&no_ip_pim_bfd_param_cmd
);}