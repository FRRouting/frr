/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"memory.h"#include"if.h"#include"p
refix.h"#include"vty.h"#include"plist.h"#include"hash.h"#include"jhash.h"#includ
e"vrf.h"#include"pimd.h"#include"pim_cmd.h"#include"pim_str.h"#include"pim_oil.h
"#include"pim_pim.h"#include"pim_ssmpingd.h"#include"pim_static.h"#include"pim_r
p.h"#include"pim_ssm.h"#include"pim_zlookup.h"#include"pim_zebra.h"constchar*con
stPIM_ALL_SYSTEMS=MCAST_ALL_SYSTEMS;constchar*constPIM_ALL_ROUTERS=MCAST_ALL_ROU
TERS;constchar*constPIM_ALL_PIM_ROUTERS=MCAST_ALL_PIM_ROUTERS;constchar*constPIM
_ALL_IGMP_ROUTERS=MCAST_ALL_IGMP_ROUTERS;structthread_master*master=NULL;uint32_
tqpim_debugs=0;intqpim_t_periodic=PIM_DEFAULT_T_PERIODIC;/*PeriodbetweenJoin/Pru
neMessages*/structpim_assert_metricqpim_infinite_assert_metric;longqpim_rpf_cach
e_refresh_delay_msec=50;intqpim_packet_process=PIM_DEFAULT_PACKET_PROCESS;uint8_
tqpim_ecmp_enable=0;uint8_tqpim_ecmp_rebalance_enable=0;structpim_instance*pimg=
NULL;int32_tqpim_register_suppress_time=PIM_REGISTER_SUPPRESSION_TIME_DEFAULT;in
t32_tqpim_register_probe_time=PIM_REGISTER_PROBE_TIME_DEFAULT;voidpim_prefix_lis
t_update(structprefix_list*plist){structpim_instance*pim;structvrf*vrf;RB_FOREAC
H(vrf,vrf_name_head,&vrfs_by_name){pim=vrf->info;if(!pim)continue;pim_rp_prefix_
list_update(pim,plist);pim_ssm_prefix_list_update(pim,plist);pim_upstream_spt_pr
efix_list_update(pim,plist);}}staticvoidpim_free(){pim_route_map_terminate();zcl
ient_lookup_free();zprivs_terminate(&pimd_privs);}voidpim_init(){if(!inet_aton(P
IM_ALL_PIM_ROUTERS,&qpim_all_pim_routers_addr)){zlog_err("%s%s:couldnotsolve%sto
groupaddress:errno=%d:%s",__FILE__,__PRETTY_FUNCTION__,PIM_ALL_PIM_ROUTERS,errno
,safe_strerror(errno));zassert(0);return;}/*RFC4601:4.6.3.AssertMetricsassert_me
tricinfinite_assert_metric(){return{1,infinity,infinity,0}}*/qpim_infinite_asser
t_metric.rpt_bit_flag=1;qpim_infinite_assert_metric.metric_preference=PIM_ASSERT
_METRIC_PREFERENCE_MAX;qpim_infinite_assert_metric.route_metric=PIM_ASSERT_ROUTE
_METRIC_MAX;qpim_infinite_assert_metric.ip_address.s_addr=INADDR_ANY;pim_cmd_ini
t();}voidpim_terminate(){structzclient*zclient;pim_free();/*reverseprefix_list_i
nit*/prefix_list_add_hook(NULL);prefix_list_delete_hook(NULL);prefix_list_reset(
);pim_vrf_terminate();zclient=pim_zebra_zclient_get();if(zclient){zclient_stop(z
client);zclient_free(zclient);}frr_fini();}