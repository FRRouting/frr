/**IPMSDPpackethelper*Copyright(C)2016CumulusNetworks,Inc.**Thisprogramisfreesof
tware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicen
seaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouro
ption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*
WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAP
ARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaverec
eivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;if
not,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA0211
0-1301USA*/#include<zebra.h>#include<lib/log.h>#include<lib/network.h>#include<l
ib/stream.h>#include<lib/thread.h>#include<lib/vty.h>#include"pimd.h"#include"pi
m_str.h"#include"pim_msdp.h"#include"pim_msdp_packet.h"#include"pim_msdp_socket.
h"staticchar*pim_msdp_pkt_type_dump(enumpim_msdp_tlvtype,char*buf,intbuf_size){s
witch(type){casePIM_MSDP_V4_SOURCE_ACTIVE:snprintf(buf,buf_size,"%s","SA");break
;casePIM_MSDP_V4_SOURCE_ACTIVE_REQUEST:snprintf(buf,buf_size,"%s","SA_REQ");brea
k;casePIM_MSDP_V4_SOURCE_ACTIVE_RESPONSE:snprintf(buf,buf_size,"%s","SA_RESP");b
reak;casePIM_MSDP_KEEPALIVE:snprintf(buf,buf_size,"%s","KA");break;casePIM_MSDP_
RESERVED:snprintf(buf,buf_size,"%s","RSVD");break;casePIM_MSDP_TRACEROUTE_PROGRE
SS:snprintf(buf,buf_size,"%s","TRACE_PROG");break;casePIM_MSDP_TRACEROUTE_REPLY:
snprintf(buf,buf_size,"%s","TRACE_REPLY");break;default:snprintf(buf,buf_size,"U
NK-%d",type);}returnbuf;}staticvoidpim_msdp_pkt_sa_dump_one(structstream*s){stru
ctprefix_sgsg;/*justthrowawaythethreereservedbytes*/stream_get3(s);/*throwawayth
eprefixlengthalso*/stream_getc(s);memset(&sg,0,sizeof(structprefix_sg));sg.grp.s
_addr=stream_get_ipv4(s);sg.src.s_addr=stream_get_ipv4(s);zlog_debug("sg%s",pim_
str_sg_dump(&sg));}staticvoidpim_msdp_pkt_sa_dump(structstream*s){intentry_cnt;i
nti;structin_addrrp;/*LastRPaddressassociatedwiththisSA*/entry_cnt=stream_getc(s
);rp.s_addr=stream_get_ipv4(s);if(PIM_DEBUG_MSDP_PACKETS){charrp_str[INET_ADDRST
RLEN];pim_inet4_dump("<rp?>",rp,rp_str,sizeof(rp_str));zlog_debug("entry_cnt%drp
%s",entry_cnt,rp_str);}/*dumpSAs*/for(i=0;i<entry_cnt;++i){pim_msdp_pkt_sa_dump_
one(s);}}staticvoidpim_msdp_pkt_dump(structpim_msdp_peer*mp,inttype,intlen,boolr
x,structstream*s){chartype_str[PIM_MSDP_PKT_TYPE_STRLEN];pim_msdp_pkt_type_dump(
type,type_str,sizeof(type_str));zlog_debug("MSDPpeer%spkt%stype%slen%d",mp->key_
str,rx?"rx":"tx",type_str,len);if(!s){return;}switch(type){casePIM_MSDP_V4_SOURC
E_ACTIVE:pim_msdp_pkt_sa_dump(s);break;default:;}}/*Checkfiledescriptorwhetherco
nnectisestablished.*/staticvoidpim_msdp_connect_check(structpim_msdp_peer*mp){in
tstatus;socklen_tslen;intret;if(mp->state!=PIM_MSDP_CONNECTING){/*ifwearehereitm
eanswearenotinaconnectingor*establishedstate*fornowtreatthisasafatalerror*/pim_m
sdp_peer_reset_tcp_conn(mp,"invalid-state");return;}PIM_MSDP_PEER_READ_OFF(mp);P
IM_MSDP_PEER_WRITE_OFF(mp);/*Checkfiledescriptor.*/slen=sizeof(status);ret=getso
ckopt(mp->fd,SOL_SOCKET,SO_ERROR,(void*)&status,&slen);/*Ifgetsockoptisfail,this
isfatalerror.*/if(ret<0){zlog_err("can'tgetsockoptfornonblockingconnect");pim_ms
dp_peer_reset_tcp_conn(mp,"connect-failed");return;}/*Whenstatusis0thenTCPconnec
tionisestablished.*/if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_connec
t_check%s",mp->key_str,status?"fail":"success");}if(status==0){pim_msdp_peer_est
ablished(mp);}else{pim_msdp_peer_reset_tcp_conn(mp,"connect-failed");}}staticvoi
dpim_msdp_pkt_delete(structpim_msdp_peer*mp){stream_free(stream_fifo_pop(mp->obu
f));}staticvoidpim_msdp_pkt_add(structpim_msdp_peer*mp,structstream*s){stream_fi
fo_push(mp->obuf,s);}staticvoidpim_msdp_write_proceed_actions(structpim_msdp_pee
r*mp){if(stream_fifo_head(mp->obuf)){PIM_MSDP_PEER_WRITE_ON(mp);}}intpim_msdp_wr
ite(structthread*thread){structpim_msdp_peer*mp;structstream*s;intnum;enumpim_ms
dp_tlvtype;intlen;intwork_cnt=0;intwork_max_cnt=100;mp=THREAD_ARG(thread);mp->t_
write=NULL;if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_msdp_write",mp-
>key_str);}if(mp->fd<0){return-1;}/*checkifTCPconnectionisestablished*/if(mp->st
ate!=PIM_MSDP_ESTABLISHED){pim_msdp_connect_check(mp);return0;}s=stream_fifo_hea
d(mp->obuf);if(!s){pim_msdp_write_proceed_actions(mp);return0;}sockopt_cork(mp->
fd,1);/*NonblockingwriteuntilTCPoutputbufferisfull*/do{intwritenum;/*Numberofbyt
estobesent*/writenum=stream_get_endp(s)-stream_get_getp(s);/*Callwrite()systemca
ll*/num=write(mp->fd,stream_pnt(s),writenum);if(num<0){/*writefailedeitherretryn
eededorerror*/if(ERRNO_IO_RETRY(errno)){if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("
MSDPpeer%spim_msdp_writeioretry",mp->key_str);}break;}pim_msdp_peer_reset_tcp_co
nn(mp,"pkt-tx-failed");return0;}if(num!=writenum){/*Partialwrite*/stream_forward
_getp(s,num);if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_msdp_partial_
write",mp->key_str);}break;}/*Retrievemsdppackettype.*/stream_set_getp(s,0);type
=stream_getc(s);len=stream_getw(s);switch(type){casePIM_MSDP_KEEPALIVE:mp->ka_tx
_cnt++;break;casePIM_MSDP_V4_SOURCE_ACTIVE:mp->sa_tx_cnt++;break;default:;}if(PI
M_DEBUG_MSDP_PACKETS){pim_msdp_pkt_dump(mp,type,len,false/*rx*/,s);}/*packetsent
deleteit.*/pim_msdp_pkt_delete(mp);++work_cnt;/*mayneedtopauseifwehavedonetoomuc
hworkinthis*loop*/if(work_cnt>=work_max_cnt){break;}}while((s=stream_fifo_head(m
p->obuf))!=NULL);pim_msdp_write_proceed_actions(mp);sockopt_cork(mp->fd,0);if(PI
M_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_msdp_writewrote%dpackets",mp->k
ey_str,work_cnt);}return0;}staticvoidpim_msdp_pkt_send(structpim_msdp_peer*mp,st
ructstream*s){/*Addpackettotheendoflist.*/pim_msdp_pkt_add(mp,s);PIM_MSDP_PEER_W
RITE_ON(mp);}voidpim_msdp_pkt_ka_tx(structpim_msdp_peer*mp){structstream*s;if(mp
->state!=PIM_MSDP_ESTABLISHED){/*don'ttxanythingunlessasessionisestablished*/ret
urn;}s=stream_new(PIM_MSDP_KA_TLV_MAX_SIZE);stream_putc(s,PIM_MSDP_KEEPALIVE);st
ream_putw(s,PIM_MSDP_KA_TLV_MAX_SIZE);pim_msdp_pkt_send(mp,s);}staticvoidpim_msd
p_pkt_sa_push_to_one_peer(structpim_instance*pim,structpim_msdp_peer*mp){structs
tream*s;if(mp->state!=PIM_MSDP_ESTABLISHED){/*don'ttxanythingunlessasessionisest
ablished*/return;}s=stream_dup(pim->msdp.work_obuf);if(s){pim_msdp_pkt_send(mp,s
);mp->flags|=PIM_MSDP_PEERF_SA_JUST_SENT;}}/*pushthestreamintotheobuffifoofallth
epeers*/staticvoidpim_msdp_pkt_sa_push(structpim_instance*pim,structpim_msdp_pee
r*mp){structlistnode*mpnode;if(mp){pim_msdp_pkt_sa_push_to_one_peer(pim,mp);}els
e{for(ALL_LIST_ELEMENTS_RO(pim->msdp.peer_list,mpnode,mp)){if(PIM_DEBUG_MSDP_INT
ERNAL){zlog_debug("MSDPpeer%spim_msdp_pkt_sa_push",mp->key_str);}pim_msdp_pkt_sa
_push_to_one_peer(pim,mp);}}}staticintpim_msdp_pkt_sa_fill_hdr(structpim_instanc
e*pim,intlocal_cnt){intcurr_tlv_ecnt;stream_reset(pim->msdp.work_obuf);curr_tlv_
ecnt=local_cnt>PIM_MSDP_SA_MAX_ENTRY_CNT?PIM_MSDP_SA_MAX_ENTRY_CNT:local_cnt;loc
al_cnt-=curr_tlv_ecnt;stream_putc(pim->msdp.work_obuf,PIM_MSDP_V4_SOURCE_ACTIVE)
;stream_putw(pim->msdp.work_obuf,PIM_MSDP_SA_ENTRY_CNT2SIZE(curr_tlv_ecnt));stre
am_putc(pim->msdp.work_obuf,curr_tlv_ecnt);stream_put_ipv4(pim->msdp.work_obuf,p
im->msdp.originator_id.s_addr);returnlocal_cnt;}staticvoidpim_msdp_pkt_sa_fill_o
ne(structpim_msdp_sa*sa){stream_put3(sa->pim->msdp.work_obuf,0/*reserved*/);stre
am_putc(sa->pim->msdp.work_obuf,32/*sprefixlen*/);stream_put_ipv4(sa->pim->msdp.
work_obuf,sa->sg.grp.s_addr);stream_put_ipv4(sa->pim->msdp.work_obuf,sa->sg.src.
s_addr);}staticvoidpim_msdp_pkt_sa_gen(structpim_instance*pim,structpim_msdp_pee
r*mp){structlistnode*sanode;structpim_msdp_sa*sa;intsa_count;intlocal_cnt=pim->m
sdp.local_cnt;sa_count=0;if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("sagen%d",local_
cnt);}local_cnt=pim_msdp_pkt_sa_fill_hdr(pim,local_cnt);for(ALL_LIST_ELEMENTS_RO
(pim->msdp.sa_list,sanode,sa)){if(!(sa->flags&PIM_MSDP_SAF_LOCAL)){/*currentimpl
ementationofMSDPisforanycasti.e.*fullmesh.so*nore-forwardingofSAsthatwelearntfro
mother*peers*/continue;}/*addsaintoscratchpad*/pim_msdp_pkt_sa_fill_one(sa);++sa
_count;if(sa_count>=PIM_MSDP_SA_MAX_ENTRY_CNT){pim_msdp_pkt_sa_push(pim,mp);/*re
setheaders*/sa_count=0;if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("sagenforremainder
%d",local_cnt);}local_cnt=pim_msdp_pkt_sa_fill_hdr(pim,local_cnt);}}if(sa_count)
{pim_msdp_pkt_sa_push(pim,mp);}return;}staticvoidpim_msdp_pkt_sa_tx_done(structp
im_instance*pim){structlistnode*mpnode;structpim_msdp_peer*mp;/*ifSAweresenttoth
epeerswerestartkatimerandavoid*unnecessarykanoise*/for(ALL_LIST_ELEMENTS_RO(pim-
>msdp.peer_list,mpnode,mp)){if(mp->flags&PIM_MSDP_PEERF_SA_JUST_SENT){mp->flags&
=~PIM_MSDP_PEERF_SA_JUST_SENT;pim_msdp_peer_pkt_txed(mp);}}}voidpim_msdp_pkt_sa_
tx(structpim_instance*pim){pim_msdp_pkt_sa_gen(pim,NULL/*mp*/);pim_msdp_pkt_sa_t
x_done(pim);}voidpim_msdp_pkt_sa_tx_one(structpim_msdp_sa*sa){pim_msdp_pkt_sa_fi
ll_hdr(sa->pim,1/*cnt*/);pim_msdp_pkt_sa_fill_one(sa);pim_msdp_pkt_sa_push(sa->p
im,NULL);pim_msdp_pkt_sa_tx_done(sa->pim);}/*whenaconnectionisfirstestablishedwe
pushallSAsimmediately*/voidpim_msdp_pkt_sa_tx_to_one_peer(structpim_msdp_peer*mp
){pim_msdp_pkt_sa_gen(mp->pim,mp);pim_msdp_pkt_sa_tx_done(mp->pim);}staticvoidpi
m_msdp_pkt_rxed_with_fatal_error(structpim_msdp_peer*mp){pim_msdp_peer_reset_tcp
_conn(mp,"invalid-pkt-rx");}staticvoidpim_msdp_pkt_ka_rx(structpim_msdp_peer*mp,
intlen){mp->ka_rx_cnt++;if(len!=PIM_MSDP_KA_TLV_MAX_SIZE){pim_msdp_pkt_rxed_with
_fatal_error(mp);return;}pim_msdp_peer_pkt_rxed(mp);}staticvoidpim_msdp_pkt_sa_r
x_one(structpim_msdp_peer*mp,structin_addrrp){intprefix_len;structprefix_sgsg;/*
justthrowawaythethreereservedbytes*/stream_get3(mp->ibuf);prefix_len=stream_getc
(mp->ibuf);memset(&sg,0,sizeof(structprefix_sg));sg.grp.s_addr=stream_get_ipv4(m
p->ibuf);sg.src.s_addr=stream_get_ipv4(mp->ibuf);if(prefix_len!=32){/*ignoreSAup
dateiftheprefixlengthisnot32*/zlog_err("rxedsaupdatewithinvalidprefixlength%d",p
refix_len);return;}if(PIM_DEBUG_MSDP_PACKETS){zlog_debug("sg%s",pim_str_sg_dump(
&sg));}pim_msdp_sa_ref(mp->pim,mp,&sg,rp);}staticvoidpim_msdp_pkt_sa_rx(structpi
m_msdp_peer*mp,intlen){intentry_cnt;inti;structin_addrrp;/*LastRPaddressassociat
edwiththisSA*/mp->sa_rx_cnt++;if(len<PIM_MSDP_SA_TLV_MIN_SIZE){pim_msdp_pkt_rxed
_with_fatal_error(mp);return;}entry_cnt=stream_getc(mp->ibuf);/*somevendorsinclu
detheactualmulticastdatainthetlv(atthe*end).*wewillignoresuchdata.inthefuturewem
ayconsiderpushingit*down*theRPT*/if(len<PIM_MSDP_SA_ENTRY_CNT2SIZE(entry_cnt)){p
im_msdp_pkt_rxed_with_fatal_error(mp);return;}rp.s_addr=stream_get_ipv4(mp->ibuf
);if(PIM_DEBUG_MSDP_PACKETS){charrp_str[INET_ADDRSTRLEN];pim_inet4_dump("<rp?>",
rp,rp_str,sizeof(rp_str));zlog_debug("entry_cnt%drp%s",entry_cnt,rp_str);}if(!pi
m_msdp_peer_rpf_check(mp,rp)){/*ifpeer-RPFcheckfailsdon'tprocessthepacketanyfurt
her*/if(PIM_DEBUG_MSDP_PACKETS){zlog_debug("peerRPFcheckfailed");}return;}pim_ms
dp_peer_pkt_rxed(mp);/*updateSAcache*/for(i=0;i<entry_cnt;++i){pim_msdp_pkt_sa_r
x_one(mp,rp);}}staticvoidpim_msdp_pkt_rx(structpim_msdp_peer*mp){enumpim_msdp_tl
vtype;intlen;/*re-readtypeandlen*/type=stream_getc_from(mp->ibuf,0);len=stream_g
etw_from(mp->ibuf,1);if(len<PIM_MSDP_HEADER_SIZE){pim_msdp_pkt_rxed_with_fatal_e
rror(mp);return;}if(len>PIM_MSDP_SA_TLV_MAX_SIZE){/*iftlvsizeifgreaterthanmaxjus
tignorethetlv*/return;}if(PIM_DEBUG_MSDP_PACKETS){pim_msdp_pkt_dump(mp,type,len,
true/*rx*/,NULL/*s*/);}switch(type){casePIM_MSDP_KEEPALIVE:pim_msdp_pkt_ka_rx(mp
,len);break;casePIM_MSDP_V4_SOURCE_ACTIVE:mp->sa_rx_cnt++;pim_msdp_pkt_sa_rx(mp,
len);break;default:mp->unk_rx_cnt++;}}/*pimmsdpreadutilityfunction.*/staticintpi
m_msdp_read_packet(structpim_msdp_peer*mp){intnbytes;intreadsize;intold_endp;int
new_endp;old_endp=stream_get_endp(mp->ibuf);readsize=mp->packet_size-old_endp;if
(!readsize){return0;}/*Readpacketfromfd*/nbytes=stream_read_try(mp->ibuf,mp->fd,
readsize);new_endp=stream_get_endp(mp->ibuf);if(nbytes<0){if(PIM_DEBUG_MSDP_INTE
RNAL){zlog_debug("MSDPpeer%sreadfailed%d",mp->key_str,nbytes);}if(nbytes==-2){if
(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%spim_msdp_readioretryold_end:%dne
w_end:%d",mp->key_str,old_endp,new_endp);}/*transienterrorretry*/return-1;}pim_m
sdp_pkt_rxed_with_fatal_error(mp);return-1;}if(!nbytes){if(PIM_DEBUG_MSDP_INTERN
AL){zlog_debug("MSDPpeer%sreadfailed%d",mp->key_str,nbytes);}pim_msdp_peer_reset
_tcp_conn(mp,"peer-down");return-1;}/*Wereadpartialpacket.*/if(stream_get_endp(m
p->ibuf)!=mp->packet_size){if(PIM_DEBUG_MSDP_INTERNAL){zlog_debug("MSDPpeer%srea
dpartiallen%dold_endp%dnew_endp%d",mp->key_str,mp->packet_size,old_endp,new_endp
);}return-1;}return0;}intpim_msdp_read(structthread*thread){structpim_msdp_peer*
mp;intrc;uint32_tlen;mp=THREAD_ARG(thread);mp->t_read=NULL;if(PIM_DEBUG_MSDP_INT
ERNAL){zlog_debug("MSDPpeer%spim_msdp_read",mp->key_str);}if(mp->fd<0){return-1;
}/*checkifTCPconnectionisestablished*/if(mp->state!=PIM_MSDP_ESTABLISHED){pim_ms
dp_connect_check(mp);return0;}PIM_MSDP_PEER_READ_ON(mp);if(!mp->packet_size){mp-
>packet_size=PIM_MSDP_HEADER_SIZE;}if(stream_get_endp(mp->ibuf)<PIM_MSDP_HEADER_
SIZE){/*startbyreadingtheTLVheader*/rc=pim_msdp_read_packet(mp);if(rc<0){gotopim
_msdp_read_end;}/*FindTLVtypeandlen*/stream_getc(mp->ibuf);len=stream_getw(mp->i
buf);if(len<PIM_MSDP_HEADER_SIZE){pim_msdp_pkt_rxed_with_fatal_error(mp);gotopim
_msdp_read_end;}/*readcompleteTLV*/mp->packet_size=len;}rc=pim_msdp_read_packet(
mp);if(rc<0){gotopim_msdp_read_end;}pim_msdp_pkt_rx(mp);/*resetinputbuffersandge
treadyforthenextpacket*/mp->packet_size=0;stream_reset(mp->ibuf);pim_msdp_read_e
nd:return0;}