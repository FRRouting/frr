/**PIMforQuagga:addtheabilitytoconfiguremulticaststaticroutes*Copyright(C)2014Na
thanBahr,ATCorp**Thisprogramisfreesoftware;youcanredistributeitand/ormodify*itun
derthetermsoftheGNUGeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation;e
itherversion2oftheLicense,or*(atyouroption)anylaterversion.**Thisprogramisdistri
butedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwar
rantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLic
enseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong
*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,
51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"vty.h"
#include"if.h"#include"log.h"#include"memory.h"#include"linklist.h"#include"pimd
.h"#include"pim_oil.h"#include"pim_static.h"#include"pim_time.h"#include"pim_str
.h"#include"pim_iface.h"voidpim_static_route_free(structstatic_route*s_route){XF
REE(MTYPE_PIM_STATIC_ROUTE,s_route);}staticstructstatic_route*static_route_alloc
(){structstatic_route*s_route;s_route=XCALLOC(MTYPE_PIM_STATIC_ROUTE,sizeof(*s_r
oute));if(!s_route){zlog_err("PIMXCALLOC(%zu)failure",sizeof(*s_route));return0;
}returns_route;}staticstructstatic_route*static_route_new(unsignedintiif,unsigne
dintoif,structin_addrgroup,structin_addrsource){structstatic_route*s_route;s_rou
te=static_route_alloc();if(!s_route){return0;}s_route->group=group;s_route->sour
ce=source;s_route->iif=iif;s_route->oif_ttls[oif]=1;s_route->c_oil.oil_ref_count
=1;s_route->c_oil.oil.mfcc_origin=source;s_route->c_oil.oil.mfcc_mcastgrp=group;
s_route->c_oil.oil.mfcc_parent=iif;s_route->c_oil.oil.mfcc_ttls[oif]=1;s_route->
c_oil.oif_creation[oif]=pim_time_monotonic_sec();returns_route;}intpim_static_ad
d(structpim_instance*pim,structinterface*iif,structinterface*oif,structin_addrgr
oup,structin_addrsource){structlistnode*node=NULL;structstatic_route*s_route=NUL
L;structstatic_route*original_s_route=NULL;structpim_interface*pim_iif=iif?iif->
info:NULL;structpim_interface*pim_oif=oif?oif->info:NULL;ifindex_tiif_index=pim_
iif?pim_iif->mroute_vif_index:0;ifindex_toif_index=pim_oif?pim_oif->mroute_vif_i
ndex:0;if(!iif_index||!oif_index){zlog_warn("%s%s:Unabletoaddstaticroute:Invalid
interfaceindex(iif=%d,oif=%d)",__FILE__,__PRETTY_FUNCTION__,iif_index,oif_index)
;return-2;}#ifdefPIM_ENFORCE_LOOPFREE_MFCif(iif_index==oif_index){/*loopedMFCent
ry*/zlog_warn("%s%s:Unabletoaddstaticroute:LoopedMFCentry(iif=%d,oif=%d)",__FILE
__,__PRETTY_FUNCTION__,iif_index,oif_index);return-4;}#endifif(iif->vrf_id!=oif-
>vrf_id){return-3;}for(ALL_LIST_ELEMENTS_RO(pim->static_routes,node,s_route)){if
(s_route->group.s_addr==group.s_addr&&s_route->source.s_addr==source.s_addr){if(
s_route->iif==iif_index&&s_route->oif_ttls[oif_index]){chargifaddr_str[INET_ADDR
STRLEN];charsifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",group,gifadd
r_str,sizeof(gifaddr_str));pim_inet4_dump("<ifaddr?>",source,sifaddr_str,sizeof(
sifaddr_str));zlog_warn("%s%s:Unabletoaddstaticroute:Routealreadyexists(iif=%d,o
if=%d,group=%s,source=%s)",__FILE__,__PRETTY_FUNCTION__,iif_index,oif_index,gifa
ddr_str,sifaddr_str);return-3;}/*Ok,fromhereonoutwewillbemakingchangestothe*s_ro
utestructure,butif*forsomereasonwefailtocommitthesechangesto*thekernel,wewanttob
eable*restorethestateofthelist.Socopythenodedata*andifneedbe,wecancopy*backifitf
ails.*/original_s_route=static_route_alloc();if(!original_s_route){return-5;}mem
cpy(original_s_route,s_route,sizeof(structstatic_route));/*Routeexistsandhasthes
ameinputinterface,but*addinganewoutputinterface*/if(s_route->iif==iif_index){s_r
oute->oif_ttls[oif_index]=1;s_route->c_oil.oil.mfcc_ttls[oif_index]=1;s_route->c
_oil.oif_creation[oif_index]=pim_time_monotonic_sec();++s_route->c_oil.oil_ref_c
ount;}else{/*inputinterfacechanged*/s_route->iif=iif_index;s_route->c_oil.oil.mf
cc_parent=iif_index;#ifdefPIM_ENFORCE_LOOPFREE_MFC/*checktomakesurethenewinputwa
snotan*oldoutput*/if(s_route->oif_ttls[iif_index]){s_route->oif_ttls[iif_index]=
0;s_route->c_oil.oif_creation[iif_index]=0;s_route->c_oil.oil.mfcc_ttls[iif_inde
x]=0;--s_route->c_oil.oil_ref_count;}#endif/*nowaddthenewoutput,ifitisnew*/if(!s
_route->oif_ttls[oif_index]){s_route->oif_ttls[oif_index]=1;s_route->c_oil.oif_c
reation[oif_index]=pim_time_monotonic_sec();s_route->c_oil.oil.mfcc_ttls[oif_ind
ex]=1;++s_route->c_oil.oil_ref_count;}}break;}}/*Ifnodeisnullthenwereachedtheend
ofthelistwithoutfindinga*match*/if(!node){s_route=static_route_new(iif_index,oif
_index,group,source);listnode_add(pim->static_routes,s_route);}s_route->c_oil.pi
m=pim;if(pim_mroute_add(&s_route->c_oil,__PRETTY_FUNCTION__)){chargifaddr_str[IN
ET_ADDRSTRLEN];charsifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",group
,gifaddr_str,sizeof(gifaddr_str));pim_inet4_dump("<ifaddr?>",source,sifaddr_str,
sizeof(sifaddr_str));zlog_warn("%s%s:Unabletoaddstaticroute(iif=%d,oif=%d,group=
%s,source=%s)",__FILE__,__PRETTY_FUNCTION__,iif_index,oif_index,gifaddr_str,sifa
ddr_str);/*Needtoputs_routebacktothewayitwas*/if(original_s_route){memcpy(s_rout
e,original_s_route,sizeof(structstatic_route));}else{/*weneverstoredoffacopy,soi
tmusthavebeena*freshnewroute*/listnode_delete(pim->static_routes,s_route);pim_st
atic_route_free(s_route);}if(original_s_route){pim_static_route_free(original_s_
route);}return-1;}/*Makesurewefreethememoryfortheroutecopyifused*/if(original_s_
route){pim_static_route_free(original_s_route);}if(PIM_DEBUG_STATIC){chargifaddr
_str[INET_ADDRSTRLEN];charsifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>
",group,gifaddr_str,sizeof(gifaddr_str));pim_inet4_dump("<ifaddr?>",source,sifad
dr_str,sizeof(sifaddr_str));zlog_debug("%s:Staticrouteadded(iif=%d,oif=%d,group=
%s,source=%s)",__PRETTY_FUNCTION__,iif_index,oif_index,gifaddr_str,sifaddr_str);
}return0;}intpim_static_del(structpim_instance*pim,structinterface*iif,structint
erface*oif,structin_addrgroup,structin_addrsource){structlistnode*node=NULL;stru
ctlistnode*nextnode=NULL;structstatic_route*s_route=NULL;structpim_interface*pim
_iif=iif?iif->info:0;structpim_interface*pim_oif=oif?oif->info:0;ifindex_tiif_in
dex=pim_iif?pim_iif->mroute_vif_index:0;ifindex_toif_index=pim_oif?pim_oif->mrou
te_vif_index:0;if(!iif_index||!oif_index){zlog_warn("%s%s:Unabletoremovestaticro
ute:Invalidinterfaceindex(iif=%d,oif=%d)",__FILE__,__PRETTY_FUNCTION__,iif_index
,oif_index);return-2;}for(ALL_LIST_ELEMENTS(pim->static_routes,node,nextnode,s_r
oute)){if(s_route->iif==iif_index&&s_route->group.s_addr==group.s_addr&&s_route-
>source.s_addr==source.s_addr&&s_route->oif_ttls[oif_index]){s_route->oif_ttls[o
if_index]=0;s_route->c_oil.oil.mfcc_ttls[oif_index]=0;--s_route->c_oil.oil_ref_c
ount;/*Iftherearenomoreoutputsthendeletethewhole*route,otherwisesettheroutewitht
henewoutputs*/if(s_route->c_oil.oil_ref_count<=0?pim_mroute_del(&s_route->c_oil,
__PRETTY_FUNCTION__):pim_mroute_add(&s_route->c_oil,__PRETTY_FUNCTION__)){chargi
faddr_str[INET_ADDRSTRLEN];charsifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifa
ddr?>",group,gifaddr_str,sizeof(gifaddr_str));pim_inet4_dump("<ifaddr?>",source,
sifaddr_str,sizeof(sifaddr_str));zlog_warn("%s%s:Unabletoremovestaticroute(iif=%
d,oif=%d,group=%s,source=%s)",__FILE__,__PRETTY_FUNCTION__,iif_index,oif_index,g
ifaddr_str,sifaddr_str);s_route->oif_ttls[oif_index]=1;s_route->c_oil.oil.mfcc_t
tls[oif_index]=1;++s_route->c_oil.oil_ref_count;return-1;}s_route->c_oil.oif_cre
ation[oif_index]=0;if(s_route->c_oil.oil_ref_count<=0){listnode_delete(pim->stat
ic_routes,s_route);pim_static_route_free(s_route);}if(PIM_DEBUG_STATIC){chargifa
ddr_str[INET_ADDRSTRLEN];charsifaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifadd
r?>",group,gifaddr_str,sizeof(gifaddr_str));pim_inet4_dump("<ifaddr?>",source,si
faddr_str,sizeof(sifaddr_str));zlog_debug("%s:Staticrouteremoved(iif=%d,oif=%d,g
roup=%s,source=%s)",__PRETTY_FUNCTION__,iif_index,oif_index,gifaddr_str,sifaddr_
str);}break;}}if(!node){chargifaddr_str[INET_ADDRSTRLEN];charsifaddr_str[INET_AD
DRSTRLEN];pim_inet4_dump("<ifaddr?>",group,gifaddr_str,sizeof(gifaddr_str));pim_
inet4_dump("<ifaddr?>",source,sifaddr_str,sizeof(sifaddr_str));zlog_warn("%s%s:U
nabletoremovestaticroute:Routedoesnotexist(iif=%d,oif=%d,group=%s,source=%s)",__
FILE__,__PRETTY_FUNCTION__,iif_index,oif_index,gifaddr_str,sifaddr_str);return-3
;}return0;}intpim_static_write_mroute(structpim_instance*pim,structvty*vty,struc
tinterface*ifp){structpim_interface*pim_ifp=ifp->info;structlistnode*node;struct
static_route*sroute;intcount=0;charsbuf[INET_ADDRSTRLEN];chargbuf[INET_ADDRSTRLE
N];if(!pim_ifp)return0;for(ALL_LIST_ELEMENTS_RO(pim->static_routes,node,sroute))
{pim_inet4_dump("<ifaddr?>",sroute->group,gbuf,sizeof(gbuf));pim_inet4_dump("<if
addr?>",sroute->source,sbuf,sizeof(sbuf));if(sroute->iif==pim_ifp->mroute_vif_in
dex){inti;for(i=0;i<MAXVIFS;i++)if(sroute->oif_ttls[i]){structinterface*oifp=pim
_if_find_by_vif_index(pim,i);if(sroute->source.s_addr==0)vty_out(vty,"ipmroute%s
%s\n",oifp->name,gbuf);elsevty_out(vty,"ipmroute%s%s%s\n",oifp->name,gbuf,sbuf);
count++;}}}returncount;}