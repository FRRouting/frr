/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"log.h"#include"privs.h"#include"if.h"#include"pr
efix.h"#include"vty.h"#include"plist.h"#include"sockopt.h"#include"pimd.h"#inclu
de"pim_rpf.h"#include"pim_mroute.h"#include"pim_oil.h"#include"pim_str.h"#includ
e"pim_time.h"#include"pim_iface.h"#include"pim_macro.h"#include"pim_rp.h"#includ
e"pim_oil.h"#include"pim_register.h"#include"pim_ifchannel.h"#include"pim_zlooku
p.h"#include"pim_ssm.h"#include"pim_sock.h"staticvoidmroute_read_on(structpim_in
stance*pim);staticintpim_mroute_set(structpim_instance*pim,intenable){interr;int
opt;socklen_topt_len=sizeof(opt);longflags;/**WeneedtocreatetheVRFtableforthepim
mroute_socket*/if(pim->vrf_id!=VRF_DEFAULT){if(pimd_privs.change(ZPRIVS_RAISE))z
log_err("pim_mroute_socket_enable:couldnotraiseprivs,%s",safe_strerror(errno));o
pt=pim->vrf->data.l.table_id;err=setsockopt(pim->mroute_socket,IPPROTO_IP,MRT_TA
BLE,&opt,opt_len);if(err){zlog_warn("%s%s:failure:setsockopt(fd=%d,IPPROTO_IP,MR
T_TABLE=%d):errno=%d:%s",__FILE__,__PRETTY_FUNCTION__,pim->mroute_socket,opt,err
no,safe_strerror(errno));return-1;}if(pimd_privs.change(ZPRIVS_LOWER))zlog_err("
pim_mroute_socket_enable:couldnotlowerprivs,%s",safe_strerror(errno));}opt=enabl
e?MRT_INIT:MRT_DONE;err=setsockopt(pim->mroute_socket,IPPROTO_IP,opt,&opt,opt_le
n);if(err){zlog_warn("%s%s:failure:setsockopt(fd=%d,IPPROTO_IP,%s=%d):errno=%d:%
s",__FILE__,__PRETTY_FUNCTION__,pim->mroute_socket,enable?"MRT_INIT":"MRT_DONE",
opt,errno,safe_strerror(errno));return-1;}#ifdefined(HAVE_IP_PKTINFO)if(enable){
/*LinuxandSolarisIP_PKTINFO*/opt=1;if(setsockopt(pim->mroute_socket,IPPROTO_IP,I
P_PKTINFO,&opt,sizeof(opt))){zlog_warn("CouldnotsetIP_PKTINFOonsocketfd=%d:errno
=%d:%s",pim->mroute_socket,errno,safe_strerror(errno));}}#endifsetsockopt_so_rec
vbuf(pim->mroute_socket,1024*1024*8);flags=fcntl(pim->mroute_socket,F_GETFL,0);i
f(flags<0){zlog_warn("Couldnotgetflagsonsocketfd:%d%d%s",pim->mroute_socket,errn
o,safe_strerror(errno));close(pim->mroute_socket);return-1;}if(fcntl(pim->mroute
_socket,F_SETFL,flags|O_NONBLOCK)){zlog_warn("CouldnotsetO_NONBLOCKonsocketfd:%d
%d%s",pim->mroute_socket,errno,safe_strerror(errno));close(pim->mroute_socket);r
eturn-1;}if(enable){#ifdefinedlinuxintupcalls=IGMPMSG_WRVIFWHOLE;opt=MRT_PIM;err
=setsockopt(pim->mroute_socket,IPPROTO_IP,opt,&upcalls,sizeof(upcalls));if(err){
zlog_warn("FailuretoregisterforVIFWHOLEandWRONGVIFupcalls%d%s",errno,safe_strerr
or(errno));return-1;}#elsezlog_warn("PIM-SMwillnotworkproperlyonthisplatform,unt
iltheabilitytoreceivetheWRVIFWHOLEupcall");#endif}return0;}staticconstchar*igmpm
sgtype2str[IGMPMSG_WRVIFWHOLE+1]={"<unknown_upcall?>","NOCACHE","WRONGVIF","WHOL
EPKT","WRVIFWHOLE"};staticintpim_mroute_msg_nocache(intfd,structinterface*ifp,co
nststructigmpmsg*msg){structpim_interface*pim_ifp=ifp->info;structpim_upstream*u
p;structpim_rpf*rpg;structprefix_sgsg;rpg=RP(pim_ifp->pim,msg->im_dst);/**Ifthei
ncominginterfaceisunknownOR*theInterfacetypeisSSMwedon'tneedto*doanythinghere*/i
f((pim_rpf_addr_is_inaddr_none(rpg))||(!pim_ifp)||(!(PIM_I_am_DR(pim_ifp)))){if(
PIM_DEBUG_MROUTE_DETAIL)zlog_debug("%s:Interfaceisnotconfiguredcorrectlytohandle
incomingpacket:Couldbe!DR,!pim_ifp,!SM,!RP",__PRETTY_FUNCTION__);return0;}/**Ifw
e'vereceivedamulticastpacketthatisn'tconnectedto*us*/if(!pim_if_connected_to_sou
rce(ifp,msg->im_src)){if(PIM_DEBUG_MROUTE_DETAIL)zlog_debug("%s:Receivedincoming
packetthatdoesn'toriginateonourseg",__PRETTY_FUNCTION__);return0;}memset(&sg,0,s
izeof(structprefix_sg));sg.src=msg->im_src;sg.grp=msg->im_dst;up=pim_upstream_fi
nd_or_add(&sg,ifp,PIM_UPSTREAM_FLAG_MASK_FHR,__PRETTY_FUNCTION__);if(!up){if(PIM
_DEBUG_MROUTE){zlog_debug("%s:Failuretoaddupstreaminformationfor%s",__PRETTY_FUN
CTION__,pim_str_sg_dump(&sg));}return0;}/**Imovedthisdebugtillaftertheactualaddb
ecause*Iwanttotakeadvantageoftheup->sg_strbeingfilledin.*/if(PIM_DEBUG_MROUTE){z
log_debug("%s:AddingaRoute%sforWHOLEPKTconsumption",__PRETTY_FUNCTION__,up->sg_s
tr);}PIM_UPSTREAM_FLAG_SET_SRC_STREAM(up->flags);pim_upstream_keep_alive_timer_s
tart(up,pim_ifp->pim->keep_alive_time);up->channel_oil->cc.pktcnt++;PIM_UPSTREAM
_FLAG_SET_FHR(up->flags);//resolvemfcc_parentpriortomroute_addinchannel_add_oifi
f(up->channel_oil->oil.mfcc_parent>=MAXVIFS){intvif_index=0;vif_index=pim_if_fin
d_vifindex_by_ifindex(pim_ifp->pim,up->rpf.source_nexthop.interface->ifindex);up
->channel_oil->oil.mfcc_parent=vif_index;}pim_register_join(up);return0;}statici
ntpim_mroute_msg_wholepkt(intfd,structinterface*ifp,constchar*buf){structpim_int
erface*pim_ifp;structprefix_sgsg;structpim_rpf*rpg;conststructip*ip_hdr;structpi
m_upstream*up;pim_ifp=ifp->info;ip_hdr=(conststructip*)buf;memset(&sg,0,sizeof(s
tructprefix_sg));sg.src=ip_hdr->ip_src;sg.grp=ip_hdr->ip_dst;up=pim_upstream_fin
d(pim_ifp->pim,&sg);if(!up){structprefix_sgstar=sg;star.src.s_addr=INADDR_ANY;up
=pim_upstream_find(pim_ifp->pim,&star);if(up&&PIM_UPSTREAM_FLAG_TEST_SRC_IGMP(up
->flags)){up=pim_upstream_add(pim_ifp->pim,&sg,ifp,PIM_UPSTREAM_FLAG_MASK_SRC_LH
R,__PRETTY_FUNCTION__,NULL);if(!up){if(PIM_DEBUG_MROUTE)zlog_debug("%s:Unabletoc
reateupstreaminformationfor%s",__PRETTY_FUNCTION__,pim_str_sg_dump(&sg));return0
;}pim_upstream_keep_alive_timer_start(up,pim_ifp->pim->keep_alive_time);pim_upst
ream_inherited_olist(pim_ifp->pim,up);pim_upstream_switch(pim_ifp->pim,up,PIM_UP
STREAM_JOINED);if(PIM_DEBUG_MROUTE)zlog_debug("%s:Creating%supstreamonLHR",__PRE
TTY_FUNCTION__,up->sg_str);return0;}if(PIM_DEBUG_MROUTE_DETAIL){zlog_debug("%s:U
nabletofindupstreamchannelWHOLEPKT%s",__PRETTY_FUNCTION__,pim_str_sg_dump(&sg));
}return0;}pim_ifp=up->rpf.source_nexthop.interface->info;rpg=RP(pim_ifp->pim,sg.
grp);if((pim_rpf_addr_is_inaddr_none(rpg))||(!pim_ifp)||(!(PIM_I_am_DR(pim_ifp))
)){if(PIM_DEBUG_MROUTE){zlog_debug("%s:FailedChecksendpacket",__PRETTY_FUNCTION_
_);}return0;}/**Ifwe'vereceivedaregistersuppress*/if(!up->t_rs_timer){if(pim_is_
grp_ssm(pim_ifp->pim,sg.grp)){if(PIM_DEBUG_PIM_REG)zlog_debug("%sregisterforward
skippedasgroupisSSM",pim_str_sg_dump(&sg));return0;}pim_register_send((uint8_t*)
buf+sizeof(structip),ntohs(ip_hdr->ip_len)-sizeof(structip),pim_ifp->primary_add
ress,rpg,0,up);}return0;}staticintpim_mroute_msg_wrongvif(intfd,structinterface*
ifp,conststructigmpmsg*msg){structpim_ifchannel*ch;structpim_interface*pim_ifp;s
tructprefix_sgsg;memset(&sg,0,sizeof(structprefix_sg));sg.src=msg->im_src;sg.grp
=msg->im_dst;/*SendAssert(S,G)oniifasresponsetoWRONGVIFkernelupcall.RFC46014.8.2
.PIM-SSM-OnlyRoutersiifistheincominginterfaceofthepacket.if(iifisininherited_oli
st(S,G)){sendAssert(S,G)oniif}*/if(!ifp){if(PIM_DEBUG_MROUTE)zlog_debug("%s:WRON
GVIF(S,G)=%scouldnotfindinputinterfaceforinput_vif_index=%d",__PRETTY_FUNCTION__
,pim_str_sg_dump(&sg),msg->im_vif);return-1;}pim_ifp=ifp->info;if(!pim_ifp){if(P
IM_DEBUG_MROUTE)zlog_debug("%s:WRONGVIF(S,G)=%smulticastnotenabledoninterface%s"
,__PRETTY_FUNCTION__,pim_str_sg_dump(&sg),ifp->name);return-2;}ch=pim_ifchannel_
find(ifp,&sg);if(!ch){structprefix_sgstar_g=sg;if(PIM_DEBUG_MROUTE)zlog_debug("%
s:WRONGVIF(S,G)=%scouldnotfindchanneloninterface%s",__PRETTY_FUNCTION__,pim_str_
sg_dump(&sg),ifp->name);star_g.src.s_addr=INADDR_ANY;ch=pim_ifchannel_find(ifp,&
star_g);if(!ch){if(PIM_DEBUG_MROUTE)zlog_debug("%s:WRONGVIF(*,G)=%scouldnotfindc
hanneloninterface%s",__PRETTY_FUNCTION__,pim_str_sg_dump(&star_g),ifp->name);ret
urn-3;}}/*RFC4601:4.6.1.(S,G)AssertMessageStateMachineTransitionsfromNoInfoState
An(S,G)datapacketarrivesoninterfaceI,ANDCouldAssert(S,G,I)==TRUEAn(S,G)datapacke
tarrivedonandownstreaminterfacethatisinour(S,G)outgoinginterfacelist.Weoptimisti
callyassumethatwewillbetheassertwinnerforthis(S,G),andsowetransitiontothe"IamAss
ertWinner"stateandperformActionsA1(below),whichwillinitiatetheassertnegotiationf
or(S,G).*/if(ch->ifassert_state!=PIM_IFASSERT_NOINFO){if(PIM_DEBUG_MROUTE){zlog_
debug("%s:WRONGVIF(S,G)=%schannelisnotonAssertNoInfostateforinterface%s",__PRETT
Y_FUNCTION__,ch->sg_str,ifp->name);}return-4;}if(!PIM_IF_FLAG_TEST_COULD_ASSERT(
ch->flags)){if(PIM_DEBUG_MROUTE){zlog_debug("%s:WRONGVIF(S,G)=%sinterface%sisnot
downstreamforchannel",__PRETTY_FUNCTION__,ch->sg_str,ifp->name);}return-5;}if(as
sert_action_a1(ch)){if(PIM_DEBUG_MROUTE){zlog_debug("%s:WRONGVIF(S,G)=%sassert_a
ction_a1failureoninterface%s",__PRETTY_FUNCTION__,ch->sg_str,ifp->name);}return-
6;}return0;}staticintpim_mroute_msg_wrvifwhole(intfd,structinterface*ifp,constch
ar*buf){conststructip*ip_hdr=(conststructip*)buf;structpim_interface*pim_ifp;str
uctpim_ifchannel*ch;structpim_upstream*up;structprefix_sgstar_g;structprefix_sgs
g;structchannel_oil*oil;pim_ifp=ifp->info;memset(&sg,0,sizeof(structprefix_sg));
sg.src=ip_hdr->ip_src;sg.grp=ip_hdr->ip_dst;ch=pim_ifchannel_find(ifp,&sg);if(ch
){if(PIM_DEBUG_MROUTE)zlog_debug("WRVIFWHOLE(S,G)=%sfoundifchanneloninterface%s"
,ch->sg_str,ifp->name);return-1;}star_g=sg;star_g.src.s_addr=INADDR_ANY;#if0ch=p
im_ifchannel_find(ifp,&star_g);if(ch){if(PIM_DEBUG_MROUTE)zlog_debug("WRVIFWHOLE
(*,G)=%sfoundifchanneloninterface%s",pim_str_sg_dump(&star_g),ifp->name);return-
1;}#endifup=pim_upstream_find(pim_ifp->pim,&sg);if(up){structpim_upstream*parent
;structpim_nexthopsource;structpim_rpf*rpf=RP(pim_ifp->pim,sg.grp);if(!rpf||!rpf
->source_nexthop.interface)return0;/**IfwehavereceivedaWRVIFWHOLEandareatthis*po
int,wecouldbereceivingthepacketonthe*,G*tree,let'scheckandifsowecansafelydrop*it
.*/parent=pim_upstream_find(pim_ifp->pim,&star_g);if(parent&&parent->rpf.source_
nexthop.interface==ifp)return0;pim_ifp=rpf->source_nexthop.interface->info;memse
t(&source,0,sizeof(source));/**Ifwearethefhrthatmeanswearegettingacallbackduring
*thepimregperiod,soIbelievewecanignorethispacket*/if(!PIM_UPSTREAM_FLAG_TEST_FHR
(up->flags)){//Noifchannel,butupstreamweareattheRP.if(pim_nexthop_lookup(pim_ifp
->pim,&source,up->upstream_register,0)==0){pim_register_stop_send(source.interfa
ce,&sg,pim_ifp->primary_address,up->upstream_register);up->sptbit=PIM_UPSTREAM_S
PTBIT_TRUE;}if(!up->channel_oil)up->channel_oil=pim_channel_oil_add(pim_ifp->pim
,&sg,pim_ifp->mroute_vif_index);pim_upstream_inherited_olist(pim_ifp->pim,up);if
(!up->channel_oil->installed)pim_mroute_add(up->channel_oil,__PRETTY_FUNCTION__)
;}else{if(I_am_RP(pim_ifp->pim,up->sg.grp)){if(pim_nexthop_lookup(pim_ifp->pim,&
source,up->upstream_register,0)==0)pim_register_stop_send(source.interface,&sg,p
im_ifp->primary_address,up->upstream_register);up->sptbit=PIM_UPSTREAM_SPTBIT_TR
UE;}pim_upstream_keep_alive_timer_start(up,pim_ifp->pim->keep_alive_time);pim_up
stream_inherited_olist(pim_ifp->pim,up);pim_mroute_msg_wholepkt(fd,ifp,buf);}ret
urn0;}pim_ifp=ifp->info;oil=pim_channel_oil_add(pim_ifp->pim,&sg,pim_ifp->mroute
_vif_index);if(!oil->installed)pim_mroute_add(oil,__PRETTY_FUNCTION__);if(pim_if
_connected_to_source(ifp,sg.src)){up=pim_upstream_add(pim_ifp->pim,&sg,ifp,PIM_U
PSTREAM_FLAG_MASK_FHR,__PRETTY_FUNCTION__,NULL);if(!up){if(PIM_DEBUG_MROUTE)zlog
_debug("%s:WRONGVIF%sunabletocreateupstreamoninterface",pim_str_sg_dump(&sg),ifp
->name);return-2;}PIM_UPSTREAM_FLAG_SET_SRC_STREAM(up->flags);pim_upstream_keep_
alive_timer_start(up,pim_ifp->pim->keep_alive_time);up->channel_oil=oil;up->chan
nel_oil->cc.pktcnt++;pim_register_join(up);pim_upstream_inherited_olist(pim_ifp-
>pim,up);//SendthepackettotheRPpim_mroute_msg_wholepkt(fd,ifp,buf);}return0;}sta
ticintpim_mroute_msg(structpim_instance*pim,constchar*buf,intbuf_size,ifindex_ti
findex){structinterface*ifp;structpim_interface*pim_ifp;conststructip*ip_hdr;con
ststructigmpmsg*msg;charip_src_str[INET_ADDRSTRLEN]="";charip_dst_str[INET_ADDRS
TRLEN]="";charsrc_str[INET_ADDRSTRLEN]="<src?>";chargrp_str[INET_ADDRSTRLEN]="<g
rp?>";structin_addrifaddr;structigmp_sock*igmp;ip_hdr=(conststructip*)buf;if(ip_
hdr->ip_p==IPPROTO_IGMP){/*WehavetheIPpacketbutwedonotknowwhichinterfacethis*pac
ketwas*receivedon.Findtheinterfacethatisonthesamesubnetas*thesource*oftheIPpacke
t.*/ifp=if_lookup_by_index(ifindex,pim->vrf_id);if(!ifp||!ifp->info)return0;pim_
ifp=ifp->info;ifaddr=pim_find_primary_addr(ifp);igmp=pim_igmp_sock_lookup_ifaddr
(pim_ifp->igmp_socket_list,ifaddr);if(PIM_DEBUG_MROUTE){pim_inet4_dump("<src?>",
ip_hdr->ip_src,ip_src_str,sizeof(ip_src_str));pim_inet4_dump("<dst?>",ip_hdr->ip
_dst,ip_dst_str,sizeof(ip_dst_str));zlog_warn("%s(%s):igmpkernelupcallon%s(%p)fo
r%s->%s",__PRETTY_FUNCTION__,pim->vrf->name,ifp->name,igmp,ip_src_str,ip_dst_str
);}if(igmp)pim_igmp_packet(igmp,(char*)buf,buf_size);}elseif(ip_hdr->ip_p){if(PI
M_DEBUG_MROUTE_DETAIL){pim_inet4_dump("<src?>",ip_hdr->ip_src,src_str,sizeof(src
_str));pim_inet4_dump("<grp?>",ip_hdr->ip_dst,grp_str,sizeof(grp_str));zlog_debu
g("%s:nokernelupcallproto=%dsrc:%sdst:%smsg_size=%d",__PRETTY_FUNCTION__,ip_hdr-
>ip_p,src_str,grp_str,buf_size);}}else{msg=(conststructigmpmsg*)buf;ifp=pim_if_f
ind_by_vif_index(pim,msg->im_vif);if(!ifp)return0;if(PIM_DEBUG_MROUTE){pim_inet4
_dump("<src?>",msg->im_src,src_str,sizeof(src_str));pim_inet4_dump("<grp?>",msg-
>im_dst,grp_str,sizeof(grp_str));zlog_warn("%s:pimkernelupcall%stype=%dip_p=%dfr
omfd=%dfor(S,G)=(%s,%s)on%svifi=%dsize=%d",__PRETTY_FUNCTION__,igmpmsgtype2str[m
sg->im_msgtype],msg->im_msgtype,ip_hdr->ip_p,pim->mroute_socket,src_str,grp_str,
ifp->name,msg->im_vif,buf_size);}switch(msg->im_msgtype){caseIGMPMSG_WRONGVIF:re
turnpim_mroute_msg_wrongvif(pim->mroute_socket,ifp,msg);break;caseIGMPMSG_NOCACH
E:returnpim_mroute_msg_nocache(pim->mroute_socket,ifp,msg);break;caseIGMPMSG_WHO
LEPKT:returnpim_mroute_msg_wholepkt(pim->mroute_socket,ifp,(constchar*)msg);brea
k;caseIGMPMSG_WRVIFWHOLE:returnpim_mroute_msg_wrvifwhole(pim->mroute_socket,ifp,
(constchar*)msg);break;default:break;}}return0;}staticintmroute_read(structthrea
d*t){structpim_instance*pim;staticlonglongcount;charbuf[10000];intresult=0;intco
nt=1;intrd;ifindex_tifindex;pim=THREAD_ARG(t);while(cont){rd=pim_socket_recvfrom
to(pim->mroute_socket,(uint8_t*)buf,sizeof(buf),NULL,NULL,NULL,NULL,&ifindex);if
(rd<=0){if(errno==EINTR)continue;if(errno==EWOULDBLOCK||errno==EAGAIN)break;if(P
IM_DEBUG_MROUTE)zlog_warn("%s:failurereadingrd=%d:fd=%d:errno=%d:%s",__PRETTY_FU
NCTION__,rd,pim->mroute_socket,errno,safe_strerror(errno));gotodone;}result=pim_
mroute_msg(pim,buf,rd,ifindex);count++;if(count%qpim_packet_process==0)cont=0;}/
*Keepreading*/done:mroute_read_on(pim);returnresult;}staticvoidmroute_read_on(st
ructpim_instance*pim){thread_add_read(master,mroute_read,pim,pim->mroute_socket,
&pim->thread);}staticvoidmroute_read_off(structpim_instance*pim){THREAD_OFF(pim-
>thread);}intpim_mroute_socket_enable(structpim_instance*pim){intfd;if(pimd_priv
s.change(ZPRIVS_RAISE))zlog_err("pim_mroute_socket_enable:couldnotraiseprivs,%s"
,safe_strerror(errno));fd=socket(AF_INET,SOCK_RAW,IPPROTO_IGMP);if(fd<0){zlog_wa
rn("Couldnotcreatemroutesocket:errno=%d:%s",errno,safe_strerror(errno));return-2
;}#ifdefSO_BINDTODEVICEif(pim->vrf->vrf_id!=VRF_DEFAULT&&setsockopt(fd,SOL_SOCKE
T,SO_BINDTODEVICE,pim->vrf->name,strlen(pim->vrf->name))){zlog_warn("Couldnotset
sockoptSO_BINDTODEVICE:%s",safe_strerror(errno));close(fd);return-3;}#endifif(pi
md_privs.change(ZPRIVS_LOWER))zlog_err("pim_mroute_socket_enable:couldnotlowerpr
ivs,%s",safe_strerror(errno));pim->mroute_socket=fd;if(pim_mroute_set(pim,1)){zl
og_warn("Couldnotenablemrouteonsocketfd=%d:errno=%d:%s",fd,errno,safe_strerror(e
rrno));close(fd);pim->mroute_socket=-1;return-3;}pim->mroute_socket_creation=pim
_time_monotonic_sec();mroute_read_on(pim);return0;}intpim_mroute_socket_disable(
structpim_instance*pim){if(pim_mroute_set(pim,0)){zlog_warn("Couldnotdisablemrou
teonsocketfd=%d:errno=%d:%s",pim->mroute_socket,errno,safe_strerror(errno));retu
rn-2;}if(close(pim->mroute_socket)){zlog_warn("Failureclosingmroutesocket:fd=%de
rrno=%d:%s",pim->mroute_socket,errno,safe_strerror(errno));return-3;}mroute_read
_off(pim);pim->mroute_socket=-1;return0;}/*Foreachnetworkinterface(e.g.,physical
oravirtualtunnel)thatwouldbeusedformulticastforwarding,acorrespondingmulticastin
terfacemustbeaddedtothekernel.*/intpim_mroute_add_vif(structinterface*ifp,struct
in_addrifaddr,unsignedcharflags){structpim_interface*pim_ifp=ifp->info;structvif
ctlvc;interr;if(PIM_DEBUG_MROUTE)zlog_debug("%s:AddVif%d(%s[%s])",__PRETTY_FUNCT
ION__,pim_ifp->mroute_vif_index,ifp->name,pim_ifp->pim->vrf->name);memset(&vc,0,
sizeof(vc));vc.vifc_vifi=pim_ifp->mroute_vif_index;#ifdefVIFF_USE_IFINDEXvc.vifc
_lcl_ifindex=ifp->ifindex;#elseif(ifaddr.s_addr==INADDR_ANY){zlog_warn("%s:unnum
beredinterfacesarenotsupportedonthisplatform",__PRETTY_FUNCTION__);return-1;}mem
cpy(&vc.vifc_lcl_addr,&ifaddr,sizeof(vc.vifc_lcl_addr));#endifvc.vifc_flags=flag
s;vc.vifc_threshold=PIM_MROUTE_MIN_TTL;vc.vifc_rate_limit=0;#ifdefPIM_DVMRP_TUNN
ELif(vc.vifc_flags&VIFF_TUNNEL){memcpy(&vc.vifc_rmt_addr,&vif_remote_addr,sizeof
(vc.vifc_rmt_addr));}#endiferr=setsockopt(pim_ifp->pim->mroute_socket,IPPROTO_IP
,MRT_ADD_VIF,(void*)&vc,sizeof(vc));if(err){charifaddr_str[INET_ADDRSTRLEN];pim_
inet4_dump("<ifaddr?>",ifaddr,ifaddr_str,sizeof(ifaddr_str));zlog_warn("%s:failu
re:setsockopt(fd=%d,IPPROTO_IP,MRT_ADD_VIF,vif_index=%d,ifaddr=%s,flag=%d):errno
=%d:%s",__PRETTY_FUNCTION__,pim_ifp->pim->mroute_socket,ifp->ifindex,ifaddr_str,
flags,errno,safe_strerror(errno));return-2;}return0;}intpim_mroute_del_vif(struc
tinterface*ifp){structpim_interface*pim_ifp=ifp->info;structvifctlvc;interr;if(P
IM_DEBUG_MROUTE)zlog_debug("%s:DelVif%d(%s[%s])",__PRETTY_FUNCTION__,pim_ifp->mr
oute_vif_index,ifp->name,pim_ifp->pim->vrf->name);memset(&vc,0,sizeof(vc));vc.vi
fc_vifi=pim_ifp->mroute_vif_index;err=setsockopt(pim_ifp->pim->mroute_socket,IPP
ROTO_IP,MRT_DEL_VIF,(void*)&vc,sizeof(vc));if(err){zlog_warn("%s%s:failure:setso
ckopt(fd=%d,IPPROTO_IP,MRT_DEL_VIF,vif_index=%d):errno=%d:%s",__FILE__,__PRETTY_
FUNCTION__,pim_ifp->pim->mroute_socket,pim_ifp->mroute_vif_index,errno,safe_stre
rror(errno));return-2;}return0;}intpim_mroute_add(structchannel_oil*c_oil,constc
har*name){structpim_instance*pim=c_oil->pim;interr;intorig=0;intorig_iif_vif=0;p
im->mroute_add_last=pim_time_monotonic_sec();++pim->mroute_add_events;/*Donotins
tallrouteifincominginterfaceisundefined.*/if(c_oil->oil.mfcc_parent>=MAXVIFS){if
(PIM_DEBUG_MROUTE){charbuf[1000];zlog_debug("%s(%s)%sAttemptingtoaddvifithatisin
validtomroutetable",__PRETTY_FUNCTION__,name,pim_channel_oil_dump(c_oil,buf,size
of(buf)));}return-2;}/*Thelinuxkernel*expects*theincoming*viftobepartoftheoutgoi
nglist*inthecaseofa(*,G).*/if(c_oil->oil.mfcc_origin.s_addr==INADDR_ANY){orig=c_
oil->oil.mfcc_ttls[c_oil->oil.mfcc_parent];c_oil->oil.mfcc_ttls[c_oil->oil.mfcc_
parent]=1;}/**IfwehaveanunresolvedcacheentryfortheS,G*itisownedbythepimregforthe
incomingIIF*SosetpimregastheIIFtemporarilytocause*thepacketstobeforwarded.Thense
tit*tothecorrectIIFafterwords.*/if(!c_oil->installed&&c_oil->oil.mfcc_origin.s_a
ddr!=INADDR_ANY&&c_oil->oil.mfcc_parent!=0){orig_iif_vif=c_oil->oil.mfcc_parent;
c_oil->oil.mfcc_parent=0;}err=setsockopt(pim->mroute_socket,IPPROTO_IP,MRT_ADD_M
FC,&c_oil->oil,sizeof(c_oil->oil));if(!err&&!c_oil->installed&&c_oil->oil.mfcc_o
rigin.s_addr!=INADDR_ANY&&orig_iif_vif!=0){c_oil->oil.mfcc_parent=orig_iif_vif;e
rr=setsockopt(pim->mroute_socket,IPPROTO_IP,MRT_ADD_MFC,&c_oil->oil,sizeof(c_oil
->oil));}if(c_oil->oil.mfcc_origin.s_addr==INADDR_ANY)c_oil->oil.mfcc_ttls[c_oil
->oil.mfcc_parent]=orig;if(err){zlog_warn("%s%s:failure:setsockopt(fd=%d,IPPROTO
_IP,MRT_ADD_MFC):errno=%d:%s",__FILE__,__PRETTY_FUNCTION__,pim->mroute_socket,er
rno,safe_strerror(errno));return-2;}if(PIM_DEBUG_MROUTE){charbuf[1000];zlog_debu
g("%s(%s),vrf%sAddedRoute:%s",__PRETTY_FUNCTION__,name,pim->vrf->name,pim_channe
l_oil_dump(c_oil,buf,sizeof(buf)));}c_oil->installed=1;return0;}intpim_mroute_de
l(structchannel_oil*c_oil,constchar*name){structpim_instance*pim=c_oil->pim;inte
rr;pim->mroute_del_last=pim_time_monotonic_sec();++pim->mroute_del_events;if(!c_
oil->installed){if(PIM_DEBUG_MROUTE){charbuf[1000];zlog_debug("%s%s:vifi%dforrou
teis%snotinstalled,donotneedtosenddelreq.",__FILE__,__PRETTY_FUNCTION__,c_oil->o
il.mfcc_parent,pim_channel_oil_dump(c_oil,buf,sizeof(buf)));}return-2;}err=setso
ckopt(pim->mroute_socket,IPPROTO_IP,MRT_DEL_MFC,&c_oil->oil,sizeof(c_oil->oil));
if(err){if(PIM_DEBUG_MROUTE)zlog_warn("%s%s:failure:setsockopt(fd=%d,IPPROTO_IP,
MRT_DEL_MFC):errno=%d:%s",__FILE__,__PRETTY_FUNCTION__,pim->mroute_socket,errno,
safe_strerror(errno));return-2;}if(PIM_DEBUG_MROUTE){charbuf[1000];zlog_debug("%
s(%s),vrf%sDeletedRoute:%s",__PRETTY_FUNCTION__,name,pim->vrf->name,pim_channel_
oil_dump(c_oil,buf,sizeof(buf)));}//Resetkernelinstalledflagc_oil->installed=0;r
eturn0;}voidpim_mroute_update_counters(structchannel_oil*c_oil){structpim_instan
ce*pim=c_oil->pim;structsioc_sg_reqsgreq;c_oil->cc.oldpktcnt=c_oil->cc.pktcnt;c_
oil->cc.oldbytecnt=c_oil->cc.bytecnt;c_oil->cc.oldwrong_if=c_oil->cc.wrong_if;if
(!c_oil->installed){c_oil->cc.lastused=100*pim->keep_alive_time;if(PIM_DEBUG_MRO
UTE){structprefix_sgsg;sg.src=c_oil->oil.mfcc_origin;sg.grp=c_oil->oil.mfcc_mcas
tgrp;if(PIM_DEBUG_MROUTE)zlog_debug("Channel(%s)isnotinstallednoneedtocollectdat
afromkernel",pim_str_sg_dump(&sg));}return;}memset(&sgreq,0,sizeof(sgreq));sgreq
.src=c_oil->oil.mfcc_origin;sgreq.grp=c_oil->oil.mfcc_mcastgrp;pim_zlookup_sg_st
atistics(c_oil);if(ioctl(pim->mroute_socket,SIOCGETSGCNT,&sgreq)){if(PIM_DEBUG_M
ROUTE){structprefix_sgsg;sg.src=c_oil->oil.mfcc_origin;sg.grp=c_oil->oil.mfcc_mc
astgrp;zlog_warn("ioctl(SIOCGETSGCNT=%lu)failurefor(S,G)=(%s):errno=%d:%s",(unsi
gnedlong)SIOCGETSGCNT,pim_str_sg_dump(&sg),errno,safe_strerror(errno));}return;}
c_oil->cc.pktcnt=sgreq.pktcnt;c_oil->cc.bytecnt=sgreq.bytecnt;c_oil->cc.wrong_if
=sgreq.wrong_if;return;}