/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include<stdlib.h>#include<stdio.h>#include<errno.h>#incl
ude<string.h>#include<unistd.h>#include<sys/types.h>#include<sys/socket.h>#inclu
de<net/if.h>#include<arpa/inet.h>#include"if.h"#include"pim_igmp_join.h"constcha
r*prog_name=0;staticintiface_solve_index(constchar*ifname){structif_nameindex*in
i;ifindex_tifindex=-1;inti;if(!ifname)return-1;ini=if_nameindex();if(!ini){inter
r=errno;fprintf(stderr,"%s:interface=%s:failuresolvingindex:errno=%d:%s\n",prog_
name,ifname,err,strerror(err));errno=err;return-1;}for(i=0;ini[i].if_index;++i){
#if0fprintf(stderr,"%s:interface=%smatchingagainstlocalifname=%sifindex=%d\n",pr
og_name,ifname,ini[i].if_name,ini[i].if_index);#endifif(!strcmp(ini[i].if_name,i
fname)){ifindex=ini[i].if_index;break;}}if_freenameindex(ini);returnifindex;}int
main(intargc,constchar*argv[]){structin_addrgroup_addr;structin_addrsource_addr;
constchar*ifname;constchar*group;constchar*source;ifindex_tifindex;intresult;int
fd;prog_name=argv[0];fd=socket(AF_INET,SOCK_DGRAM,IPPROTO_UDP);if(fd<0){fprintf(
stderr,"%s:couldnotcreatesocket:socket():errno=%d:%s\n",prog_name,errno,strerror
(errno));exit(1);}if(argc!=4){fprintf(stderr,"usage:%sinterfacegroupsource\n""ex
ample:%seth0232.1.1.11.1.1.1\n",prog_name,prog_name);exit(1);}ifname=argv[1];gro
up=argv[2];source=argv[3];ifindex=iface_solve_index(ifname);if(ifindex<0){fprint
f(stderr,"%s:couldnotfindinterface:%s\n",prog_name,ifname);exit(1);}result=inet_
pton(AF_INET,group,&group_addr);if(result<=0){fprintf(stderr,"%s:badgroupaddress
:%s\n",prog_name,group);exit(1);}result=inet_pton(AF_INET,source,&source_addr);i
f(result<=0){fprintf(stderr,"%s:badsourceaddress:%s\n",prog_name,source);exit(1)
;}result=pim_igmp_join_source(fd,ifindex,group_addr,source_addr);if(result){fpri
ntf(stderr,"%s:setsockopt(fd=%d)failureforIGMPgroup%ssource%sifindex%doninterfac
e%s:errno=%d:%s\n",prog_name,fd,group,source,ifindex,ifname,errno,strerror(errno
));exit(1);}printf("%s:joinedchannel(S,G)=(%s,%s)oninterface%s\n",prog_name,sour
ce,group,ifname);printf("%s:waiting...\n",prog_name);if(getchar()==EOF)fprintf(s
tderr,"getcharfailure\n");close(fd);printf("%s:leftchannel(S,G)=(%s,%s)oninterfa
ce%s\n",prog_name,source,group,ifname);exit(0);}