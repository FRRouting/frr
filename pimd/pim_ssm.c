/**IPSSMrangesforFRR*Copyright(C)2017CumulusNetworks,Inc.**Thisprogramisfreesoft
ware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicens
easpublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyourop
tion)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*W
ITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPA
RTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaverece
ivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifn
ot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110
-1301USA*/#include<zebra.h>#include<lib/linklist.h>#include<lib/prefix.h>#includ
e<lib/vty.h>#include<lib/vrf.h>#include<lib/plist.h>#include"pimd.h"#include"pim
_ssm.h"#include"pim_zebra.h"staticvoidpim_ssm_range_reevaluate(structpim_instanc
e*pim){/*1.Setupregisterstatefor(S,G)entriesifGhaschangedfromSSM*to*ASM.*2.check
existing(*,G)IGMPregistrationstoseeiftheyare*stillASM.iftheyarenowSSMdeletethem.
*3.AllowchannelsetupforIGMP(*,G)membersifGisnowASM*4.Icouldteardownall(*,G),(S,G
,rpt)states.Butthatisan*unnecessarysladgehammerandmaynotbeparticularlyusefulasit
is*likelytheSPTswitchoverhasalreadyhappenedforflowsalongsuch*RPTs.*AsfortheRPTst
atesitseemsthatthebestthingtodoisletthem*age*outgracefully.AslongastheFHRandLHRd
otherightthingRPTs*will*disappearintimeforSSMgroups.*/pim_upstream_register_reev
aluate(pim);igmp_source_forward_reevaluate_all(pim);}voidpim_ssm_prefix_list_upd
ate(structpim_instance*pim,structprefix_list*plist){structpim_ssm*ssm=pim->ssm_i
nfo;if(!ssm->plist_name||strcmp(ssm->plist_name,prefix_list_name(plist))){/*noto
urs*/return;}pim_ssm_range_reevaluate(pim);}staticintpim_is_grp_standard_ssm(str
uctprefix*group){staticintfirst=1;staticstructprefixgroup_ssm;if(first){if(!str2
prefix(PIM_SSM_STANDARD_RANGE,&group_ssm))zlog_err("%s:FailuretoReadGroupAddress
:%s",__PRETTY_FUNCTION__,PIM_SSM_STANDARD_RANGE);first=0;}returnprefix_match(&gr
oup_ssm,group);}intpim_is_grp_ssm(structpim_instance*pim,structin_addrgroup_addr
){structpim_ssm*ssm;structprefixgroup;structprefix_list*plist;memset(&group,0,si
zeof(group));group.family=AF_INET;group.u.prefix4=group_addr;group.prefixlen=32;
ssm=pim->ssm_info;if(!ssm->plist_name){returnpim_is_grp_standard_ssm(&group);}pl
ist=prefix_list_lookup(AFI_IP,ssm->plist_name);if(!plist)return0;return(prefix_l
ist_apply(plist,&group)==PREFIX_PERMIT);}intpim_ssm_range_set(structpim_instance
*pim,vrf_id_tvrf_id,constchar*plist_name){structpim_ssm*ssm;intchange=0;if(vrf_i
d!=pim->vrf_id)returnPIM_SSM_ERR_NO_VRF;ssm=pim->ssm_info;if(plist_name){if(ssm-
>plist_name){if(!strcmp(ssm->plist_name,plist_name))returnPIM_SSM_ERR_DUP;XFREE(
MTYPE_PIM_FILTER_NAME,ssm->plist_name);}ssm->plist_name=XSTRDUP(MTYPE_PIM_FILTER
_NAME,plist_name);change=1;}else{if(ssm->plist_name){change=1;XFREE(MTYPE_PIM_FI
LTER_NAME,ssm->plist_name);}}if(change)pim_ssm_range_reevaluate(pim);returnPIM_S
SM_ERR_NONE;}void*pim_ssm_init(void){structpim_ssm*ssm;ssm=XCALLOC(MTYPE_PIM_SSM
_INFO,sizeof(*ssm));returnssm;}voidpim_ssm_terminate(structpim_ssm*ssm){if(ssm&&
ssm->plist_name)XFREE(MTYPE_PIM_FILTER_NAME,ssm->plist_name);}