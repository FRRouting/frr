/**PIMforFRR-J/PAggregation*Copyright(C)2017CumulusNetworks,Inc.*DonaldSharp**Th
isprogramisfreesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNU
GeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheL
icense,or*(atyouroption)anylaterversion.**Thisprogramisdistributedinthehopethati
twillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABI
LITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.
**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;se
ethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthF
loor,Boston,MA02110-1301USA*/#include<zebra.h>#include"linklist.h"#include"log.h
"#include"vrf.h"#include"if.h"#include"pimd.h"#include"pim_msg.h"#include"pim_jp
_agg.h"#include"pim_join.h"#include"pim_iface.h"voidpim_jp_agg_group_list_free(s
tructpim_jp_agg_group*jag){list_delete_and_null(&jag->sources);XFREE(MTYPE_PIM_J
P_AGG_GROUP,jag);}staticvoidpim_jp_agg_src_free(structpim_jp_sources*js){structp
im_upstream*up=js->up;/**Whenwearebeingcalledhere,weknow*thattheneighborisgoinga
waystart*thenormalj/ptimersothatitcan*pickthisshitbackupwhenthe*nbrcomesbackaliv
e*/if(up)join_timer_start(js->up);XFREE(MTYPE_PIM_JP_AGG_SOURCE,js);}intpim_jp_a
gg_group_list_cmp(void*arg1,void*arg2){conststructpim_jp_agg_group*jag1=(constst
ructpim_jp_agg_group*)arg1;conststructpim_jp_agg_group*jag2=(conststructpim_jp_a
gg_group*)arg2;if(jag1->group.s_addr<jag2->group.s_addr)return-1;if(jag1->group.
s_addr>jag2->group.s_addr)return1;return0;}staticintpim_jp_agg_src_cmp(void*arg1
,void*arg2){conststructpim_jp_sources*js1=(conststructpim_jp_sources*)arg1;const
structpim_jp_sources*js2=(conststructpim_jp_sources*)arg2;if(js1->is_join&&!js2-
>is_join)return-1;if(!js1->is_join&&js2->is_join)return1;if((uint32_t)js1->up->s
g.src.s_addr<(uint32_t)js2->up->sg.src.s_addr)return-1;if((uint32_t)js1->up->sg.
src.s_addr>(uint32_t)js2->up->sg.src.s_addr)return1;return0;}/**Thisfunctionisus
edbyscan_oiltoclear*thecreatedjp_agg_groupcreatedwhen*figuringoutwheretosendprun
es*andjoins.*/voidpim_jp_agg_clear_group(structlist*group){structlistnode*gnode,
*gnnode;structlistnode*snode,*snnode;structpim_jp_agg_group*jag;structpim_jp_sou
rces*js;for(ALL_LIST_ELEMENTS(group,gnode,gnnode,jag)){for(ALL_LIST_ELEMENTS(jag
->sources,snode,snnode,js)){listnode_delete(jag->sources,js);js->up=NULL;XFREE(M
TYPE_PIM_JP_AGG_SOURCE,js);}list_delete_and_null(&jag->sources);listnode_delete(
group,jag);XFREE(MTYPE_PIM_JP_AGG_GROUP,jag);}}staticstructpim_iface_upstream_sw
itch*pim_jp_agg_get_interface_upstream_switch_list(structpim_rpf*rpf){structpim_
interface*pim_ifp=rpf->source_nexthop.interface->info;structpim_iface_upstream_s
witch*pius;structlistnode*node,*nnode;/*Oldinterfaceispimdisabled*/if(!pim_ifp)r
eturnNULL;for(ALL_LIST_ELEMENTS(pim_ifp->upstream_switch_list,node,nnode,pius)){
if(pius->address.s_addr==rpf->rpf_addr.u.prefix4.s_addr)break;}if(!pius){pius=XC
ALLOC(MTYPE_PIM_JP_AGG_GROUP,sizeof(structpim_iface_upstream_switch));pius->addr
ess.s_addr=rpf->rpf_addr.u.prefix4.s_addr;pius->us=list_new();listnode_add_sort(
pim_ifp->upstream_switch_list,pius);}returnpius;}voidpim_jp_agg_remove_group(str
uctlist*group,structpim_upstream*up){structlistnode*node,*nnode;structpim_jp_agg
_group*jag=NULL;structpim_jp_sources*js=NULL;for(ALL_LIST_ELEMENTS(group,node,nn
ode,jag)){if(jag->group.s_addr==up->sg.grp.s_addr)break;}if(!jag)return;for(ALL_
LIST_ELEMENTS(jag->sources,node,nnode,js)){if(js->up==up)break;}if(js){js->up=NU
LL;listnode_delete(jag->sources,js);XFREE(MTYPE_PIM_JP_AGG_SOURCE,js);}if(jag->s
ources->count==0){list_delete_and_null(&jag->sources);listnode_delete(group,jag)
;XFREE(MTYPE_PIM_JP_AGG_GROUP,jag);}}intpim_jp_agg_is_in_list(structlist*group,s
tructpim_upstream*up){structlistnode*node,*nnode;structpim_jp_agg_group*jag=NULL
;structpim_jp_sources*js=NULL;for(ALL_LIST_ELEMENTS(group,node,nnode,jag)){if(ja
g->group.s_addr==up->sg.grp.s_addr)break;}if(!jag)return0;for(ALL_LIST_ELEMENTS(
jag->sources,node,nnode,js)){if(js->up==up)return1;}return0;}//#definePIM_JP_AGG
_DEBUG1/**Forthegivenupstream,checkalltheneighbor*jp_agglistsandensurethatitisno
t*inanotherlist***IF*ignoreistruewecanskip*up->rpf.source_nexthop.interfaceparti
cularinterfaceforchecking**Thisisadebuggingfunction,Probably*canbesafelycompiled
outinreal*builds*/voidpim_jp_agg_upstream_verification(structpim_upstream*up,boo
lignore){#ifdefPIM_JP_AGG_DEBUGstructinterface*ifp;structpim_interface*pim_ifp=u
p->rpf.source_nexthop.interface->info;structpim_instance*pim=pim_ifp->pim;FOR_AL
L_INTERFACES(pim->vrf,ifp){pim_ifp=ifp->info;structlistnode*nnode;if(ignore&&ifp
==up->rpf.source_nexthop.interface)continue;if(pim_ifp){structpim_neighbor*neigh
;for(ALL_LIST_ELEMENTS_RO(pim_ifp->pim_neighbor_list,nnode,neigh)){assert(!pim_j
p_agg_is_in_list(neigh->upstream_jp_agg,up));}}}#elsereturn;#endif}voidpim_jp_ag
g_add_group(structlist*group,structpim_upstream*up,boolis_join){structlistnode*n
ode,*nnode;structpim_jp_agg_group*jag=NULL;structpim_jp_sources*js=NULL;for(ALL_
LIST_ELEMENTS(group,node,nnode,jag)){if(jag->group.s_addr==up->sg.grp.s_addr)bre
ak;}if(!jag){jag=XCALLOC(MTYPE_PIM_JP_AGG_GROUP,sizeof(structpim_jp_agg_group));
jag->group.s_addr=up->sg.grp.s_addr;jag->sources=list_new();jag->sources->cmp=pi
m_jp_agg_src_cmp;jag->sources->del=(void(*)(void*))pim_jp_agg_src_free;listnode_
add_sort(group,jag);}for(ALL_LIST_ELEMENTS(jag->sources,node,nnode,js)){if(js->u
p==up)break;}if(!js){js=XCALLOC(MTYPE_PIM_JP_AGG_SOURCE,sizeof(structpim_jp_sour
ces));js->up=up;js->is_join=is_join;listnode_add_sort(jag->sources,js);}else{if(
js->is_join!=is_join){listnode_delete(jag->sources,js);js->is_join=is_join;listn
ode_add_sort(jag->sources,js);}}}voidpim_jp_agg_switch_interface(structpim_rpf*o
rpf,structpim_rpf*nrpf,structpim_upstream*up){structpim_iface_upstream_switch*op
ius;structpim_iface_upstream_switch*npius;opius=pim_jp_agg_get_interface_upstrea
m_switch_list(orpf);npius=pim_jp_agg_get_interface_upstream_switch_list(nrpf);/*
*RFC4601:4.5.7.Sending(S,G)Join/PruneMessages**TransitionsfromJoinedState**RPF'(
S,G)changesnotduetoanAssert**Theupstream(S,G)statemachineremainsinJoined*state.S
endJoin(S,G)tothenewupstreamneighbor,whichis*thenewvalueofRPF'(S,G).SendPrune(S,
G)totheold*upstreamneighbor,whichistheoldvalueofRPF'(S,G).Set*theJoinTimer(JT)to
expireaftert_periodicseconds.*//*sendPrune(S,G)totheoldupstreamneighbor*/if(opiu
s)pim_jp_agg_add_group(opius->us,up,false);/*sendJoin(S,G)tothecurrentupstreamne
ighbor*/pim_jp_agg_add_group(npius->us,up,true);}voidpim_jp_agg_single_upstream_
send(structpim_rpf*rpf,structpim_upstream*up,boolis_join){staticstructlist*group
s=NULL;staticstructpim_jp_agg_groupjag;staticstructpim_jp_sourcesjs;staticboolfi
rst=true;/*skipJPupstreammessagesifsourceisdirectlyconnected*/if(!up||!rpf->sour
ce_nexthop.interface||pim_if_connected_to_source(rpf->source_nexthop.interface,u
p->sg.src))return;if(first){groups=list_new();jag.sources=list_new();listnode_ad
d(groups,&jag);listnode_add(jag.sources,&js);first=false;}jag.group.s_addr=up->s
g.grp.s_addr;js.up=up;js.is_join=is_join;pim_joinprune_send(rpf,groups);}