/**PIMforQuagga*Copyright(C)2017CumulusNetworks,Inc.*ChiragShah**Thisprogramisfr
eesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublic
Licenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(at
youroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful
,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESS
FORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldha
vereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYI
NG;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,M
A02110-1301USA*/#include<zebra.h>#include"network.h"#include"zclient.h"#include"
stream.h"#include"nexthop.h"#include"if.h"#include"hash.h"#include"jhash.h"#incl
ude"pimd.h"#include"pimd/pim_nht.h"#include"log.h"#include"pim_time.h"#include"p
im_oil.h"#include"pim_ifchannel.h"#include"pim_mroute.h"#include"pim_zebra.h"#in
clude"pim_upstream.h"#include"pim_join.h"#include"pim_jp_agg.h"#include"pim_zebr
a.h"#include"pim_zlookup.h"/***pim_sendmsg_zebra_rnh--Formatandsendanexthopregis
ter/Unregister*commandtoZebra.*/voidpim_sendmsg_zebra_rnh(structpim_instance*pim
,structzclient*zclient,structpim_nexthop_cache*pnc,intcommand){structprefix*p;in
tret;p=&(pnc->rpf.rpf_addr);ret=zclient_send_rnh(zclient,command,p,false,pim->vr
f_id);if(ret<0)zlog_warn("sendmsg_nexthop:zclient_send_message()failed");if(PIM_
DEBUG_PIM_NHT){charbuf[PREFIX2STR_BUFFER];prefix2str(p,buf,sizeof(buf));zlog_deb
ug("%s:NHT%sregisteredaddr%s(%s)withZebraret:%d",__PRETTY_FUNCTION__,(command==Z
EBRA_NEXTHOP_REGISTER)?"":"de",buf,pim->vrf->name,ret);}return;}structpim_nextho
p_cache*pim_nexthop_cache_find(structpim_instance*pim,structpim_rpf*rpf){structp
im_nexthop_cache*pnc=NULL;structpim_nexthop_cachelookup;lookup.rpf.rpf_addr.fami
ly=rpf->rpf_addr.family;lookup.rpf.rpf_addr.prefixlen=rpf->rpf_addr.prefixlen;lo
okup.rpf.rpf_addr.u.prefix4.s_addr=rpf->rpf_addr.u.prefix4.s_addr;pnc=hash_looku
p(pim->rpf_hash,&lookup);returnpnc;}staticstructpim_nexthop_cache*pim_nexthop_ca
che_add(structpim_instance*pim,structpim_rpf*rpf_addr){structpim_nexthop_cache*p
nc;charhash_name[64];charbuf1[64];pnc=XCALLOC(MTYPE_PIM_NEXTHOP_CACHE,sizeof(str
uctpim_nexthop_cache));if(!pnc){zlog_err("%s:NHTPIMXCALLOCfailure",__PRETTY_FUNC
TION__);returnNULL;}pnc->rpf.rpf_addr.family=rpf_addr->rpf_addr.family;pnc->rpf.
rpf_addr.prefixlen=rpf_addr->rpf_addr.prefixlen;pnc->rpf.rpf_addr.u.prefix4.s_ad
dr=rpf_addr->rpf_addr.u.prefix4.s_addr;pnc=hash_get(pim->rpf_hash,pnc,hash_alloc
_intern);pnc->rp_list=list_new();pnc->rp_list->cmp=pim_rp_list_cmp;snprintf(hash
_name,64,"PNC%s(%s)UpstreamHash",prefix2str(&pnc->rpf.rpf_addr,buf1,64),pim->vrf
->name);pnc->upstream_hash=hash_create_size(8192,pim_upstream_hash_key,pim_upstr
eam_equal,hash_name);returnpnc;}/**pim_find_or_track_nexthop**ThisAPIisusedtoReg
isteranaddresswithZebra**1->Success*0->Failure*/intpim_find_or_track_nexthop(str
uctpim_instance*pim,structprefix*addr,structpim_upstream*up,structrp_info*rp,str
uctpim_nexthop_cache*out_pnc){structpim_nexthop_cache*pnc=NULL;structpim_rpfrpf;
structlistnode*ch_node=NULL;structzclient*zclient=NULL;zclient=pim_zebra_zclient
_get();memset(&rpf,0,sizeof(structpim_rpf));rpf.rpf_addr.family=addr->family;rpf
.rpf_addr.prefixlen=addr->prefixlen;rpf.rpf_addr.u.prefix4=addr->u.prefix4;pnc=p
im_nexthop_cache_find(pim,&rpf);if(!pnc){pnc=pim_nexthop_cache_add(pim,&rpf);if(
!pnc){charrpf_str[PREFIX_STRLEN];pim_addr_dump("<nht-pnc?>",addr,rpf_str,sizeof(
rpf_str));zlog_warn("%s:pncnodeallocationfailed.addr%s",__PRETTY_FUNCTION__,rpf_
str);return0;}pim_sendmsg_zebra_rnh(pim,zclient,pnc,ZEBRA_NEXTHOP_REGISTER);if(P
IM_DEBUG_PIM_NHT){charbuf[PREFIX2STR_BUFFER];prefix2str(addr,buf,sizeof(buf));zl
og_debug("%s:NHTcacheandzebranotificationaddedfor%s(%s)",__PRETTY_FUNCTION__,buf
,pim->vrf->name);}}if(rp!=NULL){ch_node=listnode_lookup(pnc->rp_list,rp);if(ch_n
ode==NULL)listnode_add_sort(pnc->rp_list,rp);}if(up!=NULL)hash_get(pnc->upstream
_hash,up,hash_alloc_intern);if(pnc&&CHECK_FLAG(pnc->flags,PIM_NEXTHOP_VALID)){me
mcpy(out_pnc,pnc,sizeof(structpim_nexthop_cache));return1;}return0;}voidpim_dele
te_tracked_nexthop(structpim_instance*pim,structprefix*addr,structpim_upstream*u
p,structrp_info*rp){structpim_nexthop_cache*pnc=NULL;structpim_nexthop_cachelook
up;structzclient*zclient=NULL;zclient=pim_zebra_zclient_get();/*RemovefromRPFhas
hifitisthelastentry*/lookup.rpf.rpf_addr=*addr;pnc=hash_lookup(pim->rpf_hash,&lo
okup);if(pnc){if(rp)listnode_delete(pnc->rp_list,rp);if(up)hash_release(pnc->ups
tream_hash,up);if(PIM_DEBUG_PIM_NHT){charbuf[PREFIX_STRLEN];prefix2str(addr,buf,
sizeofbuf);zlog_debug("%s:NHT%s(%s)rp_listcount:%dupstreamcount:%ld",__PRETTY_FU
NCTION__,buf,pim->vrf->name,pnc->rp_list->count,pnc->upstream_hash->count);}if(p
nc->rp_list->count==0&&pnc->upstream_hash->count==0){pim_sendmsg_zebra_rnh(pim,z
client,pnc,ZEBRA_NEXTHOP_UNREGISTER);list_delete_and_null(&pnc->rp_list);hash_fr
ee(pnc->upstream_hash);hash_release(pim->rpf_hash,pnc);if(pnc->nexthop)nexthops_
free(pnc->nexthop);XFREE(MTYPE_PIM_NEXTHOP_CACHE,pnc);}}}/*UpdateRPnexthopinfoba
sedonNexthopupdatereceivedfromZebra.*/staticvoidpim_update_rp_nh(structpim_insta
nce*pim,structpim_nexthop_cache*pnc){structlistnode*node=NULL;structrp_info*rp_i
nfo=NULL;/*TraverseRPlistandupdateeachRPNexthopinfo*/for(ALL_LIST_ELEMENTS_RO(pn
c->rp_list,node,rp_info)){if(rp_info->rp.rpf_addr.u.prefix4.s_addr==INADDR_NONE)
continue;//ComputePIMRPFusingcachednexthoppim_ecmp_nexthop_search(pim,pnc,&rp_in
fo->rp.source_nexthop,&rp_info->rp.rpf_addr,&rp_info->group,1);}}/*ThisAPIisused
totraversenexthopcacheofRPFaddrofupstreamentrywhoseIPv4nexthopaddressisinunresol
vedstateandduetoeventlikepimneighborUPeventifitcanberesolved.*/voidpim_resolve_u
pstream_nh(structpim_instance*pim,structprefix*nht_p){structnexthop*nh_node=NULL
;structpim_nexthop_cachepnc;structpim_neighbor*nbr=NULL;memset(&pnc,0,sizeof(str
uctpim_nexthop_cache));if(!pim_find_or_track_nexthop(pim,nht_p,NULL,NULL,&pnc))r
eturn;for(nh_node=pnc.nexthop;nh_node;nh_node=nh_node->next){if(nh_node->gate.ip
v4.s_addr!=0)continue;structinterface*ifp1=if_lookup_by_index(nh_node->ifindex,p
im->vrf_id);nbr=pim_neighbor_find_if(ifp1);if(!nbr)continue;nh_node->gate.ipv4=n
br->source_addr;if(PIM_DEBUG_PIM_NHT){charstr[PREFIX_STRLEN];charstr1[INET_ADDRS
TRLEN];pim_inet4_dump("<nht_nbr?>",nbr->source_addr,str1,sizeof(str1));pim_addr_
dump("<nht_addr?>",nht_p,str,sizeof(str));zlog_debug("%s:addr%snewnexthopaddr%si
nterface%s",__PRETTY_FUNCTION__,str,str1,ifp1->name);}}}/*UpdateUpstreamnexthopi
nfobasedonNexthopupdatereceivedfromZebra.*/staticintpim_update_upstream_nh_helpe
r(structhash_backet*backet,void*arg){structpim_instance*pim=(structpim_instance*
)arg;structpim_upstream*up=(structpim_upstream*)backet->data;intvif_index=0;enum
pim_rpf_resultrpf_result;structpim_rpfold;old.source_nexthop.interface=up->rpf.s
ource_nexthop.interface;rpf_result=pim_rpf_update(pim,up,&old,0);if(rpf_result==
PIM_RPF_FAILURE){pim_mroute_del(up->channel_oil,__PRETTY_FUNCTION__);returnHASHW
ALK_CONTINUE;}/*updatekernelmulticastforwardingcache(MFC)*/if(up->channel_oil){i
findex_tifindex=up->rpf.source_nexthop.interface->ifindex;vif_index=pim_if_find_
vifindex_by_ifindex(pim,ifindex);/*PassCurrentselectedNHvifindextomroutedownload
*/if(vif_index)pim_scan_individual_oil(up->channel_oil,vif_index);else{if(PIM_DE
BUG_PIM_NHT)zlog_debug("%s:NHTupstream%schannel_oilIIF%svif_indexisnotvalid",__P
RETTY_FUNCTION__,up->sg_str,up->rpf.source_nexthop.interface->name);}}if(rpf_res
ult==PIM_RPF_CHANGED){structpim_neighbor*nbr;nbr=pim_neighbor_find(old.source_ne
xthop.interface,old.rpf_addr.u.prefix4);if(nbr)pim_jp_agg_remove_group(nbr->upst
ream_jp_agg,up);/**Wehavedetectedacasewherewemightneedtorescan*theinheritedo_lis
tsodoit.*/if(up->channel_oil&&up->channel_oil->oil_inherited_rescan){pim_upstrea
m_inherited_olist_decide(pim,up);up->channel_oil->oil_inherited_rescan=0;}if(up-
>join_state==PIM_UPSTREAM_JOINED){/**Ifwecomeuprealfastwecanbehere*wherethemrout
ehasnotbeeninstalled*soinstallit.*/if(up->channel_oil&&!up->channel_oil->install
ed)pim_mroute_add(up->channel_oil,__PRETTY_FUNCTION__);/**RFC4601:4.5.7.Sending(
S,G)Join/PruneMessages**TransitionsfromJoinedState**RPF'(S,G)changesnotduetoanAs
sert**Theupstream(S,G)statemachineremainsinJoined*state.SendJoin(S,G)tothenewups
tream*neighbor,whichisthenewvalueofRPF'(S,G).*SendPrune(S,G)totheoldupstreamneig
hbor,which*istheoldvalueofRPF'(S,G).SettheJoin*Timer(JT)toexpireaftert_periodics
econds.*/pim_jp_agg_switch_interface(&old,&up->rpf,up);pim_upstream_join_timer_r
estart(up,&old);}/*up->join_state==PIM_UPSTREAM_JOINED*//**FIXMEcanjoin_desireda
ctuallybechangedby*pim_rpf_update()returningPIM_RPF_CHANGED?*/pim_upstream_updat
e_join_desired(pim,up);}/*PIM_RPF_CHANGED*/if(PIM_DEBUG_PIM_NHT){zlog_debug("%s:
NHTupstream%s(%s)oldifp%snewifp%s",__PRETTY_FUNCTION__,up->sg_str,pim->vrf->name
,old.source_nexthop.interface->name,up->rpf.source_nexthop.interface->name);}ret
urnHASHWALK_CONTINUE;}staticintpim_update_upstream_nh(structpim_instance*pim,str
uctpim_nexthop_cache*pnc){structlistnode*node;structinterface*ifp;hash_walk(pnc-
>upstream_hash,pim_update_upstream_nh_helper,pim);FOR_ALL_INTERFACES(pim->vrf,if
p)if(ifp->info){structpim_interface*pim_ifp=ifp->info;structpim_iface_upstream_s
witch*us;for(ALL_LIST_ELEMENTS_RO(pim_ifp->upstream_switch_list,node,us)){struct
pim_rpfrpf;rpf.source_nexthop.interface=ifp;rpf.rpf_addr.u.prefix4=us->address;p
im_joinprune_send(&rpf,us->us);pim_jp_agg_clear_group(us->us);}}return0;}uint32_
tpim_compute_ecmp_hash(structprefix*src,structprefix*grp){uint32_thash_val;uint3
2_ts=0,g=0;if((!src))return0;switch(src->family){caseAF_INET:{s=src->u.prefix4.s
_addr;s=s==0?1:s;if(grp)g=grp->u.prefix4.s_addr;}break;default:break;}hash_val=j
hash_2words(g,s,101);returnhash_val;}intpim_ecmp_nexthop_search(structpim_instan
ce*pim,structpim_nexthop_cache*pnc,structpim_nexthop*nexthop,structprefix*src,st
ructprefix*grp,intneighbor_needed){structpim_neighbor*nbr=NULL;structnexthop*nh_
node=NULL;ifindex_tfirst_ifindex;structinterface*ifp=NULL;uint32_thash_val=0,mod
_val=0;uint8_tnh_iter=0,found=0;if(!pnc||!pnc->nexthop_num||!nexthop)return0;//C
urrentNexthopisVALID,checktostayonthecurrentpath.if(nexthop->interface&&nexthop-
>interface->info&&nexthop->mrib_nexthop_addr.u.prefix4.s_addr!=PIM_NET_INADDR_AN
Y){/*Userconfiguredknobtoexplicitlyswitchtonewpathisdisabledorcurrentpathmetrici
slessthannexthopupdate.*/if(qpim_ecmp_rebalance_enable==0){uint8_tcurr_route_val
id=0;//Checkifcurrentnexthopispresentinnewupdated//Nexthoplist.//Ifthecurrentnex
thopisnotvalid,candidateto//choosenewNexthop.for(nh_node=pnc->nexthop;nh_node;nh
_node=nh_node->next){curr_route_valid=(nexthop->interface->ifindex==nh_node->ifi
ndex);if(curr_route_valid)break;}if(curr_route_valid&&!pim_if_connected_to_sourc
e(nexthop->interface,src->u.prefix4)){nbr=pim_neighbor_find(nexthop->interface,n
exthop->mrib_nexthop_addr.u.prefix4);if(!nbr&&!if_is_loopback(nexthop->interface
)){if(PIM_DEBUG_PIM_NHT)zlog_debug("%s:currentnexthopdoesnothavenbr",__PRETTY_FU
NCTION__);}else{if(PIM_DEBUG_PIM_NHT){charsrc_str[INET_ADDRSTRLEN];pim_inet4_dum
p("<addr?>",src->u.prefix4,src_str,sizeof(src_str));chargrp_str[INET_ADDRSTRLEN]
;pim_inet4_dump("<addr?>",grp->u.prefix4,grp_str,sizeof(grp_str));zlog_debug("%s
:(%s,%s)(%s)currentnexthop%sisvalid,skippingnewpathselection",__PRETTY_FUNCTION_
_,src_str,grp_str,pim->vrf->name,nexthop->interface->name);}return1;}}}}if(qpim_
ecmp_enable){//PIMECMPflagisenablethenchooseECMPpath.hash_val=pim_compute_ecmp_h
ash(src,grp);mod_val=hash_val%pnc->nexthop_num;}for(nh_node=pnc->nexthop;nh_node
&&(found==0);nh_node=nh_node->next){first_ifindex=nh_node->ifindex;ifp=if_lookup
_by_index(first_ifindex,pim->vrf_id);if(!ifp){if(PIM_DEBUG_PIM_NHT){charaddr_str
[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",src->u.prefix4,addr_str,sizeof(addr_s
tr));zlog_debug("%s%s:couldnotfindinterfaceforifindex%d(address%s(%s))",__FILE__
,__PRETTY_FUNCTION__,first_ifindex,addr_str,pim->vrf->name);}if(nh_iter==mod_val
)mod_val++;//Selectnexthpathnh_iter++;continue;}if(!ifp->info){if(PIM_DEBUG_PIM_
NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",src->u.prefix4,addr_
str,sizeof(addr_str));zlog_debug("%s:multicastnotenabledoninputinterface%s(%s)(i
findex=%d,RPFforsource%s)",__PRETTY_FUNCTION__,ifp->name,pim->vrf->name,first_if
index,addr_str);}if(nh_iter==mod_val)mod_val++;//Selectnexthpathnh_iter++;contin
ue;}if(neighbor_needed&&!pim_if_connected_to_source(ifp,src->u.prefix4)){nbr=pim
_neighbor_find(ifp,nh_node->gate.ipv4);if(!nbr&&!if_is_loopback(ifp)){if(PIM_DEB
UG_PIM_NHT)zlog_debug("%s:pimnbrnotfoundoninputinterface%s(%s)",__PRETTY_FUNCTIO
N__,ifp->name,pim->vrf->name);if(nh_iter==mod_val)mod_val++;//Selectnexthpathnh_
iter++;continue;}}if(nh_iter==mod_val){nexthop->interface=ifp;nexthop->mrib_next
hop_addr.family=AF_INET;nexthop->mrib_nexthop_addr.prefixlen=IPV4_MAX_BITLEN;nex
thop->mrib_nexthop_addr.u.prefix4=nh_node->gate.ipv4;nexthop->mrib_metric_prefer
ence=pnc->distance;nexthop->mrib_route_metric=pnc->metric;nexthop->last_lookup=s
rc->u.prefix4;nexthop->last_lookup_time=pim_time_monotonic_usec();nexthop->nbr=n
br;found=1;if(PIM_DEBUG_PIM_NHT){charbuf[INET_ADDRSTRLEN];charbuf2[INET_ADDRSTRL
EN];charbuf3[INET_ADDRSTRLEN];pim_inet4_dump("<src?>",src->u.prefix4,buf2,sizeof
(buf2));pim_inet4_dump("<grp?>",grp->u.prefix4,buf3,sizeof(buf3));pim_inet4_dump
("<rpf?>",nexthop->mrib_nexthop_addr.u.prefix4,buf,sizeof(buf));zlog_debug("%s:(
%s,%s)(%s)selectednhopinterface%saddr%smod_val%uiter%decmp%d",__PRETTY_FUNCTION_
_,buf2,buf3,pim->vrf->name,ifp->name,buf,mod_val,nh_iter,qpim_ecmp_enable);}}nh_
iter++;}if(found)return1;elsereturn0;}/*ThisAPIisusedtoparseRegisteredaddressnex
thopupdatecomingfromZebra*/intpim_parse_nexthop_update(intcommand,structzclient*
zclient,zebra_size_tlength,vrf_id_tvrf_id){structnexthop*nexthop;structnexthop*n
hlist_head=NULL;structnexthop*nhlist_tail=NULL;inti;structpim_rpfrpf;structpim_n
exthop_cache*pnc=NULL;structpim_neighbor*nbr=NULL;structinterface*ifp=NULL;struc
tinterface*ifp1=NULL;structvrf*vrf=vrf_lookup_by_id(vrf_id);structpim_instance*p
im;structzapi_routenhr;if(!vrf)return0;pim=vrf->info;if(!zapi_nexthop_update_dec
ode(zclient->ibuf,&nhr)){if(PIM_DEBUG_PIM_NHT)zlog_debug("%s:Decodeofnexthopupda
tefromzebrafailed",__PRETTY_FUNCTION__);return0;}if(command==ZEBRA_NEXTHOP_UPDAT
E){prefix_copy(&rpf.rpf_addr,&nhr.prefix);pnc=pim_nexthop_cache_find(pim,&rpf);i
f(!pnc){if(PIM_DEBUG_PIM_NHT){charbuf[PREFIX2STR_BUFFER];prefix2str(&rpf.rpf_add
r,buf,sizeof(buf));zlog_debug("%s:SkippingNHTupdate,addr%sisnotinlocalcachedDB."
,__PRETTY_FUNCTION__,buf);}return0;}}else{/**WedonotcurrentlyhandleZEBRA_IMPORT_
CHECK_UPDATE*/return0;}pnc->last_update=pim_time_monotonic_usec();if(nhr.nexthop
_num){pnc->nexthop_num=0;//Onlyincrementforpimenabledrpf.for(i=0;i<nhr.nexthop_n
um;i++){nexthop=nexthop_from_zapi_nexthop(&nhr.nexthops[i]);switch(nexthop->type
){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IFINDEX:caseNEXTHOP_TYPE_IPV4_IFINDEX:c
aseNEXTHOP_TYPE_IPV6:caseNEXTHOP_TYPE_BLACKHOLE:break;caseNEXTHOP_TYPE_IPV6_IFIN
DEX:ifp1=if_lookup_by_index(nexthop->ifindex,pim->vrf_id);nbr=pim_neighbor_find_
if(ifp1);/*OverwritewithNbraddressasNHaddr*/if(nbr)nexthop->gate.ipv4=nbr->sourc
e_addr;else{//Marknexthopaddressto0untilPIM//Nbrisresolved.nexthop->gate.ipv4.s_
addr=PIM_NET_INADDR_ANY;}break;}ifp=if_lookup_by_index(nexthop->ifindex,pim->vrf
_id);if(!ifp){if(PIM_DEBUG_PIM_NHT){charbuf[NEXTHOP_STRLEN];zlog_debug("%s:could
notfindinterfaceforifindex%d(%s)(addr%s)",__PRETTY_FUNCTION__,nexthop->ifindex,p
im->vrf->name,nexthop2str(nexthop,buf,sizeof(buf)));}nexthop_free(nexthop);conti
nue;}if(PIM_DEBUG_PIM_NHT){charp_str[PREFIX2STR_BUFFER];prefix2str(&nhr.prefix,p
_str,sizeof(p_str));zlog_debug("%s:NHTaddr%s(%s)%d-nhopvia%s(%s)type%ddistance:%
umetric:%u",__PRETTY_FUNCTION__,p_str,pim->vrf->name,i+1,inet_ntoa(nexthop->gate
.ipv4),ifp->name,nexthop->type,nhr.distance,nhr.metric);}if(!ifp->info){if(PIM_D
EBUG_PIM_NHT){charbuf[NEXTHOP_STRLEN];zlog_debug("%s:multicastnotenabledoninputi
nterface%s(%s)(ifindex=%d,addr%s)",__PRETTY_FUNCTION__,ifp->name,pim->vrf->name,
nexthop->ifindex,nexthop2str(nexthop,buf,sizeof(buf)));}nexthop_free(nexthop);co
ntinue;}if(nhlist_tail){nhlist_tail->next=nexthop;nhlist_tail=nexthop;}else{nhli
st_tail=nexthop;nhlist_head=nexthop;}//OnlykeeptrackofnexthopswhicharePIMenabled
.pnc->nexthop_num++;}/*Resetexistingpnc->nexthopbeforeassigningnewlist*/nexthops
_free(pnc->nexthop);pnc->nexthop=nhlist_head;if(pnc->nexthop_num){pnc->flags|=PI
M_NEXTHOP_VALID;pnc->distance=nhr.distance;pnc->metric=nhr.metric;}}else{pnc->fl
ags&=~PIM_NEXTHOP_VALID;pnc->nexthop_num=nhr.nexthop_num;nexthops_free(pnc->next
hop);pnc->nexthop=NULL;}if(PIM_DEBUG_PIM_NHT){charbuf[PREFIX2STR_BUFFER];prefix2
str(&nhr.prefix,buf,sizeof(buf));zlog_debug("%s:NHTUpdatefor%s(%s)num_nh%dnum_pi
m_nh%dvrf:%uup%ldrp%d",__PRETTY_FUNCTION__,buf,pim->vrf->name,nhr.nexthop_num,pn
c->nexthop_num,vrf_id,pnc->upstream_hash->count,listcount(pnc->rp_list));}pim_rp
f_set_refresh_time(pim);if(listcount(pnc->rp_list))pim_update_rp_nh(pim,pnc);if(
pnc->upstream_hash->count)pim_update_upstream_nh(pim,pnc);return0;}intpim_ecmp_n
exthop_lookup(structpim_instance*pim,structpim_nexthop*nexthop,structin_addraddr
,structprefix*src,structprefix*grp,intneighbor_needed){structpim_zlookup_nexthop
nexthop_tab[MULTIPATH_NUM];structpim_neighbor*nbr=NULL;intnum_ifindex;structinte
rface*ifp;intfirst_ifindex;intfound=0;uint8_ti=0;uint32_thash_val=0,mod_val=0;if
(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,
addr_str,sizeof(addr_str));zlog_debug("%s:Lookingup:%s(%s),lastlookuptime:%lld",
__PRETTY_FUNCTION__,addr_str,pim->vrf->name,nexthop->last_lookup_time);}memset(n
exthop_tab,0,sizeof(structpim_zlookup_nexthop)*MULTIPATH_NUM);num_ifindex=zclien
t_lookup_nexthop(pim,nexthop_tab,MULTIPATH_NUM,addr,PIM_NEXTHOP_LOOKUP_MAX);if(n
um_ifindex<1){if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump
("<addr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s:couldnotfindnexthopifin
dexforaddress%s(%s)",__PRETTY_FUNCTION__,addr_str,pim->vrf->name);}return0;}//If
PIMECMPenablethenchooseECMPpath.if(qpim_ecmp_enable){hash_val=pim_compute_ecmp_h
ash(src,grp);mod_val=hash_val%num_ifindex;if(PIM_DEBUG_PIM_NHT_DETAIL)zlog_debug
("%s:hash_val%umod_val%u",__PRETTY_FUNCTION__,hash_val,mod_val);}while(!found&&(
i<num_ifindex)){first_ifindex=nexthop_tab[i].ifindex;ifp=if_lookup_by_index(firs
t_ifindex,pim->vrf_id);if(!ifp){if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRL
EN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s%s:co
uldnotfindinterfaceforifindex%d(address%s(%s))",__FILE__,__PRETTY_FUNCTION__,fir
st_ifindex,addr_str,pim->vrf->name);}if(i==mod_val)mod_val++;i++;continue;}if(!i
fp->info){if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<a
ddr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s:multicastnotenabledoninput
interface%s(%s)(ifindex=%d,RPFforsource%s)",__PRETTY_FUNCTION__,ifp->name,pim->v
rf->name,first_ifindex,addr_str);}if(i==mod_val)mod_val++;i++;continue;}if(neigh
bor_needed&&!pim_if_connected_to_source(ifp,addr)){nbr=pim_neighbor_find(ifp,nex
thop_tab[i].nexthop_addr.u.prefix4);if(PIM_DEBUG_PIM_NHT_DETAIL)zlog_debug("ifpn
ame:%s(%s),pimnbr:%p",ifp->name,pim->vrf->name,nbr);if(!nbr&&!if_is_loopback(ifp
)){if(i==mod_val)mod_val++;i++;if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLE
N];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s:NBRno
tfoundoninputinterface%s(%s)(RPFforsource%s)",__PRETTY_FUNCTION__,ifp->name,pim-
>vrf->name,addr_str);}continue;}}if(i==mod_val){if(PIM_DEBUG_PIM_NHT){charnextho
p_str[PREFIX_STRLEN];charaddr_str[INET_ADDRSTRLEN];pim_addr_dump("<nexthop?>",&n
exthop_tab[i].nexthop_addr,nexthop_str,sizeof(nexthop_str));pim_inet4_dump("<add
r?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s:foundnhop%sforaddr%sinterfac
e%s(%s)metric%ddist%d",__PRETTY_FUNCTION__,nexthop_str,addr_str,ifp->name,pim->v
rf->name,nexthop_tab[i].route_metric,nexthop_tab[i].protocol_distance);}/*update
nextopdata*/nexthop->interface=ifp;nexthop->mrib_nexthop_addr=nexthop_tab[i].nex
thop_addr;nexthop->mrib_metric_preference=nexthop_tab[i].protocol_distance;nexth
op->mrib_route_metric=nexthop_tab[i].route_metric;nexthop->last_lookup=addr;next
hop->last_lookup_time=pim_time_monotonic_usec();nexthop->nbr=nbr;found=1;}i++;}i
f(found)return1;elsereturn0;}intpim_ecmp_fib_lookup_if_vif_index(structpim_insta
nce*pim,structin_addraddr,structprefix*src,structprefix*grp){structpim_zlookup_n
exthopnexthop_tab[MULTIPATH_NUM];intnum_ifindex;intvif_index;ifindex_tfirst_ifin
dex;uint32_thash_val=0,mod_val=0;memset(nexthop_tab,0,sizeof(structpim_zlookup_n
exthop)*MULTIPATH_NUM);num_ifindex=zclient_lookup_nexthop(pim,nexthop_tab,MULTIP
ATH_NUM,addr,PIM_NEXTHOP_LOOKUP_MAX);if(num_ifindex<1){if(PIM_DEBUG_PIM_NHT){cha
raddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_st
r));zlog_debug("%s:couldnotfindnexthopifindexforaddress%s(%s)",__PRETTY_FUNCTION
__,addr_str,pim->vrf->name);}return-1;}//IfPIMECMPenablethenchooseECMPpath.if(qp
im_ecmp_enable){hash_val=pim_compute_ecmp_hash(src,grp);mod_val=hash_val%num_ifi
ndex;if(PIM_DEBUG_PIM_NHT_DETAIL)zlog_debug("%s:hash_val%umod_val%u",__PRETTY_FU
NCTION__,hash_val,mod_val);}first_ifindex=nexthop_tab[mod_val].ifindex;if(PIM_DE
BUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<ifaddr?>",addr,addr_
str,sizeof(addr_str));zlog_debug("%s:foundnexthopifindex=%d(interface%s(%s))fora
ddress%s",__PRETTY_FUNCTION__,first_ifindex,ifindex2ifname(first_ifindex,pim->vr
f_id),pim->vrf->name,addr_str);}vif_index=pim_if_find_vifindex_by_ifindex(pim,fi
rst_ifindex);if(vif_index<0){if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN]
;pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s:lowvif_
index=%d(%s)<1nexthopforaddress%s",__PRETTY_FUNCTION__,vif_index,pim->vrf->name,
addr_str);}return-2;}returnvif_index;}