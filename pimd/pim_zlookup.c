/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"zebra/rib.h"#include"log.h"#include"prefix.h"#in
clude"zclient.h"#include"stream.h"#include"network.h"#include"thread.h"#include"
prefix.h"#include"vty.h"#include"pimd.h"#include"pim_iface.h"#include"pim_pim.h"
#include"pim_str.h"#include"pim_oil.h"#include"pim_zlookup.h"staticstructzclient
*zlookup=NULL;staticvoidzclient_lookup_sched(structzclient*zlookup,intdelay);/*C
onnecttozebrafornexthoplookup.*/staticintzclient_lookup_connect(structthread*t){
structzclient*zlookup;zlookup=THREAD_ARG(t);if(zlookup->sock>=0){return0;}if(zcl
ient_socket_connect(zlookup)<0){++zlookup->fail;zlog_warn("%s:failureconnectingz
clientsocket:failures=%d",__PRETTY_FUNCTION__,zlookup->fail);}else{zlookup->fail
=0;/*resetcounteronconnection*/}if(zlookup->sock<0){/*Sincelastconnectfailed,ret
rywithin10secs*/zclient_lookup_sched(zlookup,10);return-1;}return0;}/*Scheduleco
nnectionwithdelay.*/staticvoidzclient_lookup_sched(structzclient*zlookup,intdela
y){thread_add_timer(master,zclient_lookup_connect,zlookup,delay,&zlookup->t_conn
ect);zlog_notice("%s:zclientlookupconnectionscheduledfor%dseconds",__PRETTY_FUNC
TION__,delay);}/*Scheduleconnectionfornow.*/staticvoidzclient_lookup_sched_now(s
tructzclient*zlookup){thread_add_event(master,zclient_lookup_connect,zlookup,0,&
zlookup->t_connect);zlog_notice("%s:zclientlookupimmediateconnectionscheduled",_
_PRETTY_FUNCTION__);}/*Schedulereconnection,ifneeded.*/staticvoidzclient_lookup_
reconnect(structzclient*zlookup){if(zlookup->t_connect){return;}zclient_lookup_s
ched_now(zlookup);}staticvoidzclient_lookup_failed(structzclient*zlookup){if(zlo
okup->sock>=0){if(close(zlookup->sock)){zlog_warn("%s:closingfd=%d:errno=%d%s",_
_func__,zlookup->sock,errno,safe_strerror(errno));}zlookup->sock=-1;}zclient_loo
kup_reconnect(zlookup);}voidzclient_lookup_free(void){zclient_stop(zlookup);zcli
ent_free(zlookup);zlookup=NULL;}voidzclient_lookup_new(void){zlookup=zclient_new
_notify(master,&zclient_options_default);if(!zlookup){zlog_err("%s:zclient_new()
failure",__PRETTY_FUNCTION__);return;}zlookup->sock=-1;zlookup->t_connect=NULL;z
lookup->privs=&pimd_privs;zclient_lookup_sched_now(zlookup);zlog_notice("%s:zcli
entlookupsocketinitialized",__PRETTY_FUNCTION__);}staticintzclient_read_nexthop(
structpim_instance*pim,structzclient*zlookup,structpim_zlookup_nexthopnexthop_ta
b[],constinttab_size,structin_addraddr){intnum_ifindex=0;structstream*s;uint16_t
length;uint8_tmarker;uint8_tversion;vrf_id_tvrf_id;uint16_tcommand=0;structin_ad
drraddr;uint8_tdistance;uint32_tmetric;intnexthop_num;inti,err;if(PIM_DEBUG_PIM_
NHT_DETAIL){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str
,sizeof(addr_str));zlog_debug("%s:addr=%s(%s)",__PRETTY_FUNCTION__,addr_str,pim-
>vrf->name);}s=zlookup->ibuf;while(command!=ZEBRA_IPV4_NEXTHOP_LOOKUP_MRIB){stre
am_reset(s);err=zclient_read_header(s,zlookup->sock,&length,&marker,&version,&vr
f_id,&command);if(err<0){zlog_err("%s:zclient_read_header()failed",__PRETTY_FUNC
TION__);zclient_lookup_failed(zlookup);return-1;}}raddr.s_addr=stream_get_ipv4(s
);if(raddr.s_addr!=addr.s_addr){charaddr_str[INET_ADDRSTRLEN];charraddr_str[INET
_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));pim_inet4_
dump("<raddr?>",raddr,raddr_str,sizeof(raddr_str));zlog_warn("%s:addressmismatch
:addr=%s(%s)raddr=%s",__PRETTY_FUNCTION__,addr_str,pim->vrf->name,raddr_str);/*w
arningonly*/}distance=stream_getc(s);metric=stream_getl(s);nexthop_num=stream_ge
tc(s);if(nexthop_num<1){if(PIM_DEBUG_PIM_NHT_DETAIL)zlog_debug("%s:socket%dbadne
xthop_num=%d",__func__,zlookup->sock,nexthop_num);return-6;}for(i=0;i<nexthop_nu
m;++i){enumnexthop_types_tnexthop_type;structpim_neighbor*nbr;structprefixp;next
hop_type=stream_getc(s);if(num_ifindex>=tab_size){charaddr_str[INET_ADDRSTRLEN];
pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s:foundtoom
anynexthopifindexes(%d>%d)foraddress%s(%s)",__PRETTY_FUNCTION__,(num_ifindex+1),
tab_size,addr_str,pim->vrf->name);returnnum_ifindex;}switch(nexthop_type){caseNE
XTHOP_TYPE_IFINDEX:caseNEXTHOP_TYPE_IPV4_IFINDEX:caseNEXTHOP_TYPE_IPV4:nexthop_t
ab[num_ifindex].nexthop_addr.family=AF_INET;if(nexthop_type==NEXTHOP_TYPE_IPV4_I
FINDEX||nexthop_type==NEXTHOP_TYPE_IPV4){nexthop_tab[num_ifindex].nexthop_addr.u
.prefix4.s_addr=stream_get_ipv4(s);}else{nexthop_tab[num_ifindex].nexthop_addr.u
.prefix4.s_addr=PIM_NET_INADDR_ANY;}nexthop_tab[num_ifindex].ifindex=stream_getl
(s);nexthop_tab[num_ifindex].protocol_distance=distance;nexthop_tab[num_ifindex]
.route_metric=metric;++num_ifindex;break;caseNEXTHOP_TYPE_IPV6_IFINDEX:nexthop_t
ab[num_ifindex].nexthop_addr.family=AF_INET6;stream_get(&nexthop_tab[num_ifindex
].nexthop_addr.u.prefix6,s,sizeof(structin6_addr));nexthop_tab[num_ifindex].ifin
dex=stream_getl(s);p.family=AF_INET6;p.prefixlen=IPV6_MAX_PREFIXLEN;memcpy(&p.u.
prefix6,&nexthop_tab[num_ifindex].nexthop_addr.u.prefix6,sizeof(structin6_addr))
;/**Ifwearesendingv6secondaryassumewereceivev6*secondary*/if(pim->send_v6_second
ary)nbr=pim_neighbor_find_by_secondary(if_lookup_by_index(nexthop_tab[num_ifinde
x].ifindex,vrf_id),&p);elsenbr=pim_neighbor_find_if(if_lookup_by_index(nexthop_t
ab[num_ifindex].ifindex,vrf_id));if(nbr){nexthop_tab[num_ifindex].nexthop_addr.f
amily=AF_INET;nexthop_tab[num_ifindex].nexthop_addr.u.prefix4=nbr->source_addr;}
++num_ifindex;break;default:/*donothing*/{charaddr_str[INET_ADDRSTRLEN];pim_inet
4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s:foundnon-ifindexn
exthoptype=%dforaddress%s(%s)",__PRETTY_FUNCTION__,nexthop_type,addr_str,pim->vr
f->name);}break;}}returnnum_ifindex;}staticintzclient_lookup_nexthop_once(struct
pim_instance*pim,structpim_zlookup_nexthopnexthop_tab[],constinttab_size,structi
n_addraddr){structstream*s;intret;if(PIM_DEBUG_PIM_NHT_DETAIL){charaddr_str[INET
_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug
("%s:addr=%s(%s)",__PRETTY_FUNCTION__,addr_str,pim->vrf->name);}/*Checksocket.*/
if(zlookup->sock<0){zlog_err("%s:zclientlookupsocketisnotconnected",__PRETTY_FUN
CTION__);zclient_lookup_failed(zlookup);return-1;}if(pim->vrf->vrf_id==VRF_UNKNO
WN){zlog_err("%s:VRF:%sdoesnotfullyexistyet,delayinglookup",__PRETTY_FUNCTION__,
pim->vrf->name);return-1;}s=zlookup->obuf;stream_reset(s);zclient_create_header(
s,ZEBRA_IPV4_NEXTHOP_LOOKUP_MRIB,pim->vrf_id);stream_put_in_addr(s,&addr);stream
_putw_at(s,0,stream_get_endp(s));ret=writen(zlookup->sock,s->data,stream_get_end
p(s));if(ret<0){zlog_err("%s:writen()failure:%dwritingtozclientlookupsocket",__P
RETTY_FUNCTION__,errno);zclient_lookup_failed(zlookup);return-2;}if(ret==0){zlog
_err("%s:connectionclosedonzclientlookupsocket",__PRETTY_FUNCTION__);zclient_loo
kup_failed(zlookup);return-3;}returnzclient_read_nexthop(pim,zlookup,nexthop_tab
,tab_size,addr);}intzclient_lookup_nexthop(structpim_instance*pim,structpim_zloo
kup_nexthopnexthop_tab[],constinttab_size,structin_addraddr,intmax_lookup){intlo
okup;uint32_troute_metric=0xFFFFFFFF;uint8_tprotocol_distance=0xFF;pim->nexthop_
lookups++;for(lookup=0;lookup<max_lookup;++lookup){intnum_ifindex;intfirst_ifind
ex;structprefixnexthop_addr;num_ifindex=zclient_lookup_nexthop_once(pim,nexthop_
tab,tab_size,addr);if(num_ifindex<1){if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADD
RSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_debug("%s
:lookup=%d/%d:couldnotfindnexthopifindexforaddress%s(%s)",__PRETTY_FUNCTION__,lo
okup,max_lookup,addr_str,pim->vrf->name);}return-1;}if(lookup<1){/*thisisthenon-
recursivelookup-saveoriginal*metric/distance*/route_metric=nexthop_tab[0].route_
metric;protocol_distance=nexthop_tab[0].protocol_distance;}/**FIXME:Non-recursiv
enexthopensuredonlyforfirstifindex.*However,recursiveroutelookupshouldreallybefi
xedin*zebradaemon.*SeealsoTODOT24.**SoZebraforNEXTHOP_TYPE_IPV4returnstheifindex
nowsince*itwasbeingstored.ThisDoesn'tsolveallcasesof*recursivelookupbutforthemos
tcommontypesitdoes.*/first_ifindex=nexthop_tab[0].ifindex;nexthop_addr=nexthop_t
ab[0].nexthop_addr;if(first_ifindex>0){/*found:firstifindexisnon-recursivenextho
p*/if(lookup>0){/*Reportnon-recursivesuccessafterfirst*lookup*/if(PIM_DEBUG_PIM_
NHT){charaddr_str[INET_ADDRSTRLEN];pim_inet4_dump("<addr?>",addr,addr_str,sizeof
(addr_str));zlog_debug("%s:lookup=%d/%d:foundnon-recursiveifindex=%dforaddress%s
(%s)dist=%dmet=%d",__PRETTY_FUNCTION__,lookup,max_lookup,first_ifindex,addr_str,
pim->vrf->name,nexthop_tab[0].protocol_distance,nexthop_tab[0].route_metric);}/*
uselastaddressasnexthopaddress*/nexthop_tab[0].nexthop_addr.u.prefix4=addr;/*rep
ortoriginalroutemetric/distance*/nexthop_tab[0].route_metric=route_metric;nextho
p_tab[0].protocol_distance=protocol_distance;}returnnum_ifindex;}if(PIM_DEBUG_PI
M_NHT){charaddr_str[INET_ADDRSTRLEN];charnexthop_str[PREFIX_STRLEN];pim_inet4_du
mp("<addr?>",addr,addr_str,sizeof(addr_str));pim_addr_dump("<nexthop?>",&nexthop
_addr,nexthop_str,sizeof(nexthop_str));zlog_debug("%s:lookup=%d/%d:zebrareturned
recursivenexthop%sforaddress%s(%s)dist=%dmet=%d",__PRETTY_FUNCTION__,lookup,max_
lookup,nexthop_str,addr_str,pim->vrf->name,nexthop_tab[0].protocol_distance,next
hop_tab[0].route_metric);}addr=nexthop_addr.u.prefix4;/*usenexthopaddrforrecursi
velookup*/}/*for(max_lookup)*/if(PIM_DEBUG_PIM_NHT){charaddr_str[INET_ADDRSTRLEN
];pim_inet4_dump("<addr?>",addr,addr_str,sizeof(addr_str));zlog_warn("%s:lookup=
%d/%d:failuresearchingrecursivenexthopifindexforaddress%s(%s)",__PRETTY_FUNCTION
__,lookup,max_lookup,addr_str,pim->vrf->name);}return-2;}voidpim_zlookup_show_ip
_multicast(structvty*vty){vty_out(vty,"Zclientlookupsocket:");if(zlookup){vty_ou
t(vty,"%dfailures=%d\n",zlookup->sock,zlookup->fail);}else{vty_out(vty,"<nullzcl
ient>\n");}}intpim_zlookup_sg_statistics(structchannel_oil*c_oil){structstream*s
=zlookup->obuf;uint16_tcommand=0;unsignedlonglonglastused;structprefix_sgsg;intc
ount=0;intret;structinterface*ifp=pim_if_find_by_vif_index(c_oil->pim,c_oil->oil
.mfcc_parent);if(PIM_DEBUG_ZEBRA){structprefix_sgmore;more.src=c_oil->oil.mfcc_o
rigin;more.grp=c_oil->oil.mfcc_mcastgrp;zlog_debug("SendingRequestforNewChannelO
ilInformation(%s)VIIF%d(%s)",pim_str_sg_dump(&more),c_oil->oil.mfcc_parent,c_oil
->pim->vrf->name);}if(!ifp)return-1;stream_reset(s);zclient_create_header(s,ZEBR
A_IPMR_ROUTE_STATS,c_oil->pim->vrf_id);stream_put_in_addr(s,&c_oil->oil.mfcc_ori
gin);stream_put_in_addr(s,&c_oil->oil.mfcc_mcastgrp);stream_putl(s,ifp->ifindex)
;stream_putw_at(s,0,stream_get_endp(s));count=stream_get_endp(s);ret=writen(zloo
kup->sock,s->data,count);if(ret<=0){zlog_err("%s:writen()failure:%dwritingtozcli
entlookupsocket",__PRETTY_FUNCTION__,errno);return-1;}s=zlookup->ibuf;while(comm
and!=ZEBRA_IPMR_ROUTE_STATS){interr;uint16_tlength=0;vrf_id_tvrf_id;uint8_tmarke
r;uint8_tversion;stream_reset(s);err=zclient_read_header(s,zlookup->sock,&length
,&marker,&version,&vrf_id,&command);if(err<0){zlog_err("%s:zclient_read_header()
failed",__PRETTY_FUNCTION__);zclient_lookup_failed(zlookup);return-1;}}sg.src.s_
addr=stream_get_ipv4(s);sg.grp.s_addr=stream_get_ipv4(s);if(sg.src.s_addr!=c_oil
->oil.mfcc_origin.s_addr||sg.grp.s_addr!=c_oil->oil.mfcc_mcastgrp.s_addr){if(PIM
_DEBUG_ZEBRA){structprefix_sgmore;more.src=c_oil->oil.mfcc_origin;more.grp=c_oil
->oil.mfcc_mcastgrp;zlog_err("%s:Receivedwrong%s(%s)informationrequested",__PRET
TY_FUNCTION__,pim_str_sg_dump(&more),c_oil->pim->vrf->name);}zclient_lookup_fail
ed(zlookup);return-3;}stream_get(&lastused,s,sizeof(lastused));stream_getl(s);c_
oil->cc.lastused=lastused;return0;}