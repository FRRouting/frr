/**PIMforQuagga*Copyright(C)2008EvertondaSilvaMarques**Thisprogramisfreesoftware
;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPublicLicenseasp
ublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense,or*(atyouroption
)anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#ifndefPIM_UPSTREAM_H#definePIM_UPSTREAM_H#include<zebra.h>#include<prefix
.h>#include"plist.h"#include<pimd/pim_rpf.h>#include"pim_str.h"#include"pim_ifch
annel.h"#definePIM_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED(1<<0)#definePIM_UPSTREAM_F
LAG_MASK_DR_JOIN_DESIRED_UPDATED(1<<1)#definePIM_UPSTREAM_FLAG_MASK_FHR(1<<2)#de
finePIM_UPSTREAM_FLAG_MASK_SRC_IGMP(1<<3)#definePIM_UPSTREAM_FLAG_MASK_SRC_PIM(1
<<4)#definePIM_UPSTREAM_FLAG_MASK_SRC_STREAM(1<<5)#definePIM_UPSTREAM_FLAG_MASK_
SRC_MSDP(1<<6)#definePIM_UPSTREAM_FLAG_MASK_SEND_SG_RPT_PRUNE(1<<7)#definePIM_UP
STREAM_FLAG_MASK_SRC_LHR(1<<8)#definePIM_UPSTREAM_FLAG_ALL0xFFFFFFFF#definePIM_U
PSTREAM_FLAG_TEST_DR_JOIN_DESIRED(flags)((flags)&PIM_UPSTREAM_FLAG_MASK_DR_JOIN_
DESIRED)#definePIM_UPSTREAM_FLAG_TEST_DR_JOIN_DESIRED_UPDATED(flags)((flags)&PIM
_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED_UPDATED)#definePIM_UPSTREAM_FLAG_TEST_FHR(fl
ags)((flags)&PIM_UPSTREAM_FLAG_MASK_FHR)#definePIM_UPSTREAM_FLAG_TEST_SRC_IGMP(f
lags)((flags)&PIM_UPSTREAM_FLAG_MASK_SRC_IGMP)#definePIM_UPSTREAM_FLAG_TEST_SRC_
PIM(flags)((flags)&PIM_UPSTREAM_FLAG_MASK_SRC_PIM)#definePIM_UPSTREAM_FLAG_TEST_
SRC_STREAM(flags)((flags)&PIM_UPSTREAM_FLAG_MASK_SRC_STREAM)#definePIM_UPSTREAM_
FLAG_TEST_SRC_MSDP(flags)((flags)&PIM_UPSTREAM_FLAG_MASK_SRC_MSDP)#definePIM_UPS
TREAM_FLAG_TEST_SEND_SG_RPT_PRUNE(flags)((flags)&PIM_UPSTREAM_FLAG_MASK_SEND_SG_
RPT_PRUNE)#definePIM_UPSTREAM_FLAG_TEST_SRC_LHR(flags)((flags)&PIM_UPSTREAM_FLAG
_MASK_SRC_LHR)#definePIM_UPSTREAM_FLAG_SET_DR_JOIN_DESIRED(flags)((flags)|=PIM_U
PSTREAM_FLAG_MASK_DR_JOIN_DESIRED)#definePIM_UPSTREAM_FLAG_SET_DR_JOIN_DESIRED_U
PDATED(flags)((flags)|=PIM_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED_UPDATED)#definePIM
_UPSTREAM_FLAG_SET_FHR(flags)((flags)|=PIM_UPSTREAM_FLAG_MASK_FHR)#definePIM_UPS
TREAM_FLAG_SET_SRC_IGMP(flags)((flags)|=PIM_UPSTREAM_FLAG_MASK_SRC_IGMP)#defineP
IM_UPSTREAM_FLAG_SET_SRC_PIM(flags)((flags)|=PIM_UPSTREAM_FLAG_MASK_SRC_PIM)#def
inePIM_UPSTREAM_FLAG_SET_SRC_STREAM(flags)((flags)|=PIM_UPSTREAM_FLAG_MASK_SRC_S
TREAM)#definePIM_UPSTREAM_FLAG_SET_SRC_MSDP(flags)((flags)|=PIM_UPSTREAM_FLAG_MA
SK_SRC_MSDP)#definePIM_UPSTREAM_FLAG_SET_SEND_SG_RPT_PRUNE(flags)((flags)|=PIM_U
PSTREAM_FLAG_MASK_SEND_SG_RPT_PRUNE)#definePIM_UPSTREAM_FLAG_SET_SRC_LHR(flags)(
(flags)|=PIM_UPSTREAM_FLAG_MASK_SRC_LHR)#definePIM_UPSTREAM_FLAG_UNSET_DR_JOIN_D
ESIRED(flags)((flags)&=~PIM_UPSTREAM_FLAG_MASK_DR_JOIN_DESIRED)#definePIM_UPSTRE
AM_FLAG_UNSET_DR_JOIN_DESIRED_UPDATED(flags)((flags)&=~PIM_UPSTREAM_FLAG_MASK_DR
_JOIN_DESIRED_UPDATED)#definePIM_UPSTREAM_FLAG_UNSET_FHR(flags)((flags)&=~PIM_UP
STREAM_FLAG_MASK_FHR)#definePIM_UPSTREAM_FLAG_UNSET_SRC_IGMP(flags)((flags)&=~PI
M_UPSTREAM_FLAG_MASK_SRC_IGMP)#definePIM_UPSTREAM_FLAG_UNSET_SRC_PIM(flags)((fla
gs)&=~PIM_UPSTREAM_FLAG_MASK_SRC_PIM)#definePIM_UPSTREAM_FLAG_UNSET_SRC_STREAM(f
lags)((flags)&=~PIM_UPSTREAM_FLAG_MASK_SRC_STREAM)#definePIM_UPSTREAM_FLAG_UNSET
_SRC_MSDP(flags)((flags)&=~PIM_UPSTREAM_FLAG_MASK_SRC_MSDP)#definePIM_UPSTREAM_F
LAG_UNSET_SEND_SG_RPT_PRUNE(flags)((flags)&=~PIM_UPSTREAM_FLAG_MASK_SEND_SG_RPT_
PRUNE)#definePIM_UPSTREAM_FLAG_UNSET_SRC_LHR(flags)((flags)&=~PIM_UPSTREAM_FLAG_
MASK_SRC_LHR)enumpim_upstream_state{PIM_UPSTREAM_NOTJOINED,PIM_UPSTREAM_JOINED,}
;enumpim_reg_state{PIM_REG_NOINFO,PIM_REG_JOIN,PIM_REG_JOIN_PENDING,PIM_REG_PRUN
E,};enumpim_upstream_sptbit{PIM_UPSTREAM_SPTBIT_FALSE,PIM_UPSTREAM_SPTBIT_TRUE};
/*Upstream(S,G)channelinJoinedstate(S,G)inthe"NotJoined"stateisnotrepresentedSee
RFC4601:4.5.7.Sending(S,G)Join/PruneMessage*/structpim_upstream{structpim_upstre
am*parent;structin_addrupstream_addr;/*Whowearetalkingto*/structin_addrupstream_
register;/*Whowereceivedaregisterfrom*/structprefix_sgsg;/*(S,G)groupkey*/charsg
_str[PIM_SG_LEN];uint32_tflags;structchannel_oil*channel_oil;structlist*sources;
structlist*ifchannels;enumpim_upstream_statejoin_state;enumpim_reg_statereg_stat
e;enumpim_upstream_sptbitsptbit;intref_count;structpim_rpfrpf;structthread*t_joi
n_timer;/**RST(S,G)*/structthread*t_rs_timer;#definePIM_REGISTER_SUPPRESSION_PER
IOD(60)#definePIM_REGISTER_PROBE_PERIOD(5)/**KAT(S,G)*/structthread*t_ka_timer;#
definePIM_KEEPALIVE_PERIOD(210)#definePIM_RP_KEEPALIVE_PERIOD(3*qpim_register_su
ppress_time+qpim_register_probe_time)/*ontheRPwerestartatimertoindicateifregiste
rsarebeingrxed*for*SG.ThisisneededbyMSDPtodetermineitslocalSAcache*/structthread
*t_msdp_reg_timer;#definePIM_MSDP_REG_RXED_PERIOD(3*(1.5*qpim_register_suppress_
time))int64_tstate_transition;/*Recordcurrentstateuptime*/};voidpim_upstream_fre
e(structpim_upstream*up);structpim_upstream*pim_upstream_find(structpim_instance
*pim,structprefix_sg*sg);structpim_upstream*pim_upstream_find_or_add(structprefi
x_sg*sg,structinterface*ifp,intflags,constchar*name);structpim_upstream*pim_upst
ream_add(structpim_instance*pim,structprefix_sg*sg,structinterface*ifp,intflags,
constchar*name,structpim_ifchannel*ch);voidpim_upstream_ref(structpim_upstream*u
p,intflags,constchar*name);structpim_upstream*pim_upstream_del(structpim_instanc
e*pim,structpim_upstream*up,constchar*name);intpim_upstream_evaluate_join_desire
d(structpim_instance*pim,structpim_upstream*up);intpim_upstream_evaluate_join_de
sired_interface(structpim_upstream*up,structpim_ifchannel*ch,structpim_ifchannel
*starch);voidpim_upstream_update_join_desired(structpim_instance*pim,structpim_u
pstream*up);voidpim_upstream_join_suppress(structpim_upstream*up,structin_addrrp
f_addr,intholdtime);voidpim_upstream_join_timer_decrease_to_t_override(constchar
*debug_label,structpim_upstream*up);voidpim_upstream_join_timer_restart(structpi
m_upstream*up,structpim_rpf*old);voidpim_upstream_rpf_genid_changed(structpim_in
stance*pim,structin_addrneigh_addr);voidpim_upstream_rpf_interface_changed(struc
tpim_upstream*up,structinterface*old_rpf_ifp);voidpim_upstream_update_could_asse
rt(structpim_upstream*up);voidpim_upstream_update_my_assert_metric(structpim_ups
tream*up);voidpim_upstream_keep_alive_timer_start(structpim_upstream*up,uint32_t
time);intpim_upstream_switch_to_spt_desired(structpim_instance*pim,structprefix_
sg*sg);#defineSwitchToSptDesired(pim,sg)pim_upstream_switch_to_spt_desired(pim,s
g)intpim_upstream_is_sg_rpt(structpim_upstream*up);voidpim_upstream_set_sptbit(s
tructpim_upstream*up,structinterface*incoming);voidpim_upstream_start_register_s
top_timer(structpim_upstream*up,intnull_register);voidpim_upstream_send_join(str
uctpim_upstream*up);voidpim_upstream_switch(structpim_instance*pim,structpim_ups
tream*up,enumpim_upstream_statenew_state);constchar*pim_upstream_state2str(enump
im_upstream_statejoin_state);#definePIM_REG_STATE_STR_LEN12constchar*pim_reg_sta
te2str(enumpim_reg_statestate,char*state_str);intpim_upstream_inherited_olist_de
cide(structpim_instance*pim,structpim_upstream*up);intpim_upstream_inherited_oli
st(structpim_instance*pim,structpim_upstream*up);intpim_upstream_empty_inherited
_olist(structpim_upstream*up);voidpim_upstream_find_new_rpf(structpim_instance*p
im);voidpim_upstream_msdp_reg_timer_start(structpim_upstream*up);voidpim_upstrea
m_init(structpim_instance*pim);voidpim_upstream_terminate(structpim_instance*pim
);voidjoin_timer_start(structpim_upstream*up);intpim_upstream_compare(void*arg1,
void*arg2);voidpim_upstream_register_reevaluate(structpim_instance*pim);voidpim_
upstream_add_lhr_star_pimreg(structpim_instance*pim);voidpim_upstream_remove_lhr
_star_pimreg(structpim_instance*pim,constchar*nlist);voidpim_upstream_spt_prefix
_list_update(structpim_instance*pim,structprefix_list*pl);unsignedintpim_upstrea
m_hash_key(void*arg);intpim_upstream_equal(constvoid*arg1,constvoid*arg2);#endif
/*PIM_UPSTREAM_H*/