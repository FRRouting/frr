/*Agenericnexthopstructure*Copyright(C)2013CumulusNetworks,Inc.**Thisfileisparto
fQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodifyit*underthetermso
ftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion
2,or(atyouroption)any*laterversion.**Quaggaisdistributedinthehopethatitwillbeuse
ful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITN
ESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshoul
dhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCO
PYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bosto
n,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"table.h"#include"
memory.h"#include"command.h"#include"if.h"#include"log.h"#include"sockunion.h"#i
nclude"linklist.h"#include"thread.h"#include"prefix.h"#include"nexthop.h"#includ
e"mpls.h"DEFINE_MTYPE_STATIC(LIB,NEXTHOP,"Nexthop")DEFINE_MTYPE_STATIC(LIB,NH_LA
BEL,"Nexthoplabel")/*checkifnexthopsaresame,non-recursive*/intnexthop_same_no_re
curse(conststructnexthop*next1,conststructnexthop*next2){if(next1->type!=next2->
type)return0;switch(next1->type){caseNEXTHOP_TYPE_IPV4:caseNEXTHOP_TYPE_IPV4_IFI
NDEX:if(!IPV4_ADDR_SAME(&next1->gate.ipv4,&next2->gate.ipv4))return0;if(next1->i
findex&&(next1->ifindex!=next2->ifindex))return0;break;caseNEXTHOP_TYPE_IFINDEX:
if(next1->ifindex!=next2->ifindex)return0;break;caseNEXTHOP_TYPE_IPV6:if(!IPV6_A
DDR_SAME(&next1->gate.ipv6,&next2->gate.ipv6))return0;break;caseNEXTHOP_TYPE_IPV
6_IFINDEX:if(!IPV6_ADDR_SAME(&next1->gate.ipv6,&next2->gate.ipv6))return0;if(nex
t1->ifindex!=next2->ifindex)return0;break;default:/*donothing*/break;}return1;}i
ntnexthop_same_firsthop(structnexthop*next1,structnexthop*next2){inttype1=NEXTHO
P_FIRSTHOPTYPE(next1->type);inttype2=NEXTHOP_FIRSTHOPTYPE(next2->type);if(type1!
=type2)return0;switch(type1){caseNEXTHOP_TYPE_IPV4_IFINDEX:if(!IPV4_ADDR_SAME(&n
ext1->gate.ipv4,&next2->gate.ipv4))return0;if(next1->ifindex!=next2->ifindex)ret
urn0;break;caseNEXTHOP_TYPE_IFINDEX:if(next1->ifindex!=next2->ifindex)return0;br
eak;caseNEXTHOP_TYPE_IPV6_IFINDEX:if(!IPV6_ADDR_SAME(&next1->gate.ipv6,&next2->g
ate.ipv6))return0;if(next1->ifindex!=next2->ifindex)return0;break;default:/*dono
thing*/break;}return1;}/**nexthop_type_to_str*/constchar*nexthop_type_to_str(enu
mnexthop_types_tnh_type){staticconstchar*desc[]={"none","Directlyconnected","IPv
4nexthop","IPv4nexthopwithifindex","IPv6nexthop","IPv6nexthopwithifindex","Null0
nexthop",};returndesc[nh_type];}/**Checkifthelabelsmatchforthe2nexthopsspecified
.*/intnexthop_labels_match(structnexthop*nh1,structnexthop*nh2){structmpls_label
_stack*nhl1,*nhl2;nhl1=nh1->nh_label;nhl2=nh2->nh_label;if(!nhl1||!nhl2)return0;
if(nhl1->num_labels!=nhl2->num_labels)return0;if(memcmp(nhl1->label,nhl2->label,
nhl1->num_labels))return0;return1;}structnexthop*nexthop_new(void){returnXCALLOC
(MTYPE_NEXTHOP,sizeof(structnexthop));}/*Freenexthop.*/voidnexthop_free(structne
xthop*nexthop){nexthop_del_labels(nexthop);if(nexthop->resolved)nexthops_free(ne
xthop->resolved);XFREE(MTYPE_NEXTHOP,nexthop);}/*Freesalistofnexthops*/voidnexth
ops_free(structnexthop*nexthop){structnexthop*nh,*next;for(nh=nexthop;nh;nh=next
){next=nh->next;nexthop_free(nh);}}boolnexthop_same(conststructnexthop*nh1,const
structnexthop*nh2){if(nh1&&!nh2)returnfalse;if(!nh1&&nh2)returnfalse;if(nh1==nh2
)returntrue;if(nh1->vrf_id!=nh2->vrf_id)returnfalse;if(nh1->type!=nh2->type)retu
rnfalse;switch(nh1->type){caseNEXTHOP_TYPE_IFINDEX:if(nh1->ifindex!=nh2->ifindex
)returnfalse;break;caseNEXTHOP_TYPE_IPV4:if(nh1->gate.ipv4.s_addr!=nh2->gate.ipv
4.s_addr)returnfalse;break;caseNEXTHOP_TYPE_IPV4_IFINDEX:if(nh1->gate.ipv4.s_add
r!=nh2->gate.ipv4.s_addr)returnfalse;if(nh1->ifindex!=nh2->ifindex)returnfalse;b
reak;caseNEXTHOP_TYPE_IPV6:if(memcmp(&nh1->gate.ipv6,&nh2->gate.ipv6,16))returnf
alse;break;caseNEXTHOP_TYPE_IPV6_IFINDEX:if(memcmp(&nh1->gate.ipv6,&nh2->gate.ip
v6,16))returnfalse;if(nh1->ifindex!=nh2->ifindex)returnfalse;break;caseNEXTHOP_T
YPE_BLACKHOLE:if(nh1->bh_type!=nh2->bh_type)returnfalse;break;}returntrue;}/*Upd
atenexthopwithlabelinformation.*/voidnexthop_add_labels(structnexthop*nexthop,en
umlsp_types_ttype,uint8_tnum_labels,mpls_label_t*label){structmpls_label_stack*n
h_label;inti;nexthop->nh_label_type=type;nh_label=XCALLOC(MTYPE_NH_LABEL,sizeof(
structmpls_label_stack)+num_labels*sizeof(mpls_label_t));nh_label->num_labels=nu
m_labels;for(i=0;i<num_labels;i++)nh_label->label[i]=*(label+i);nexthop->nh_labe
l=nh_label;}/*Freelabelinformationofnexthop,ifpresent.*/voidnexthop_del_labels(s
tructnexthop*nexthop){if(nexthop->nh_label){XFREE(MTYPE_NH_LABEL,nexthop->nh_lab
el);nexthop->nh_label_type=ZEBRA_LSP_NONE;}}constchar*nexthop2str(structnexthop*
nexthop,char*str,intsize){switch(nexthop->type){caseNEXTHOP_TYPE_IFINDEX:snprint
f(str,size,"if%u",nexthop->ifindex);break;caseNEXTHOP_TYPE_IPV4:snprintf(str,siz
e,"%s",inet_ntoa(nexthop->gate.ipv4));break;caseNEXTHOP_TYPE_IPV4_IFINDEX:snprin
tf(str,size,"%sif%u",inet_ntoa(nexthop->gate.ipv4),nexthop->ifindex);break;caseN
EXTHOP_TYPE_IPV6:snprintf(str,size,"%s",inet6_ntoa(nexthop->gate.ipv6));break;ca
seNEXTHOP_TYPE_IPV6_IFINDEX:snprintf(str,size,"%sif%u",inet6_ntoa(nexthop->gate.
ipv6),nexthop->ifindex);break;caseNEXTHOP_TYPE_BLACKHOLE:snprintf(str,size,"blac
khole");break;default:snprintf(str,size,"unknown");break;}returnstr;}/**Iteratio
nstepforALL_NEXTHOPSmacro:*Thisisthetrickypart.Checkif`nexthop'has*NEXTHOP_FLAG_
RECURSIVEset.Ifyes,thisimpliesthat`nexthop'has*atleastonenexthopattachedto`nexth
op->resolved',whichwillbe*thenextone.**IfNEXTHOP_FLAG_RECURSIVEisnotset,`nexthop
'willprogressinits*currentchain.Incaseitscurrentchainendisreached,itwillmove*upw
ardsintherecursionlevelsandprogressthere.Wheneverastep*forwardinachainisdone,rec
ursionwillbecheckedagain.*Inanustshell,it'sequivalenttoapre-traversalorderassumi
ngthat*leftbranchis'resolved'andrightbranchis'next':*https://en.wikipedia.org/wi
ki/Tree_traversal#/media/File:Sorted_binary_tree_preorder.svg*/structnexthop*nex
thop_next(structnexthop*nexthop){if(CHECK_FLAG(nexthop->flags,NEXTHOP_FLAG_RECUR
SIVE))returnnexthop->resolved;if(nexthop->next)returnnexthop->next;for(structnex
thop*par=nexthop->rparent;par;par=par->rparent)if(par->next)returnpar->next;retu
rnNULL;}unsignedintnexthop_level(structnexthop*nexthop){unsignedintrv=0;for(stru
ctnexthop*par=nexthop->rparent;par;par=par->rparent)rv++;returnrv;}