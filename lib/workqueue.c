/**QuaggaWorkQueueSupport.**Copyright(C)2005SunMicrosystems,Inc.**Thisfileispart
ofGNUZebra.**Quaggaisfreesoftware;youcanredistributeitand/ormodifyit*undertheter
msoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eithervers
ion2,or(atyouroption)any*laterversion.**Quaggaisdistributedinthehopethatitwillbe
useful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorF
ITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yoush
ouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefil
eCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bo
ston,MA02110-1301USA*/#include<zebra.h>#include"thread.h"#include"memory.h"#incl
ude"workqueue.h"#include"linklist.h"#include"command.h"#include"log.h"DEFINE_MTY
PE(LIB,WORK_QUEUE,"Workqueue")DEFINE_MTYPE_STATIC(LIB,WORK_QUEUE_ITEM,"Workqueue
item")DEFINE_MTYPE_STATIC(LIB,WORK_QUEUE_NAME,"Workqueuenamestring")/*masterlist
ofwork_queues*/staticstructlist_work_queues;/*pointerprimarilytoavoidanotherwise
harmlesswarningon*ALL_LIST_ELEMENTS_RO*/staticstructlist*work_queues=&_work_queu
es;#defineWORK_QUEUE_MIN_GRANULARITY1staticstructwork_queue_item*work_queue_item
_new(structwork_queue*wq){structwork_queue_item*item;assert(wq);item=XCALLOC(MTY
PE_WORK_QUEUE_ITEM,sizeof(structwork_queue_item));returnitem;}staticvoidwork_que
ue_item_free(structwork_queue_item*item){XFREE(MTYPE_WORK_QUEUE_ITEM,item);retur
n;}staticvoidwork_queue_item_remove(structwork_queue*wq,structwork_queue_item*it
em){assert(item&&item->data);/*callprivatedatadeletioncallbackifneeded*/if(wq->s
pec.del_item_data)wq->spec.del_item_data(wq,item->data);work_queue_item_dequeue(
wq,item);work_queue_item_free(item);return;}/*createnewworkqueue*/structwork_que
ue*work_queue_new(structthread_master*m,constchar*queue_name){structwork_queue*n
ew;new=XCALLOC(MTYPE_WORK_QUEUE,sizeof(structwork_queue));if(new==NULL)returnnew
;new->name=XSTRDUP(MTYPE_WORK_QUEUE_NAME,queue_name);new->master=m;SET_FLAG(new-
>flags,WQ_UNPLUGGED);STAILQ_INIT(&new->items);listnode_add(work_queues,new);new-
>cycles.granularity=WORK_QUEUE_MIN_GRANULARITY;/*Defaultvalues,canbeoverridenbyc
aller*/new->spec.hold=WORK_QUEUE_DEFAULT_HOLD;new->spec.yield=THREAD_YIELD_TIME_
SLOT;returnnew;}voidwork_queue_free_original(structwork_queue*wq){if(wq->thread!
=NULL)thread_cancel(wq->thread);while(!work_queue_empty(wq)){structwork_queue_it
em*item=work_queue_last_item(wq);work_queue_item_remove(wq,item);}listnode_delet
e(work_queues,wq);XFREE(MTYPE_WORK_QUEUE_NAME,wq->name);XFREE(MTYPE_WORK_QUEUE,w
q);return;}voidwork_queue_free_and_null(structwork_queue**wq){work_queue_free_or
iginal(*wq);*wq=NULL;}boolwork_queue_is_scheduled(structwork_queue*wq){return(wq
->thread!=NULL);}staticintwork_queue_schedule(structwork_queue*wq,unsignedintdel
ay){/*ifappropriate,scheduleworkqueuethread*/if(CHECK_FLAG(wq->flags,WQ_UNPLUGGE
D)&&(wq->thread==NULL)&&!work_queue_empty(wq)){wq->thread=NULL;thread_add_timer_
msec(wq->master,work_queue_run,wq,delay,&wq->thread);/*setthreadyieldtime,ifneed
ed*/if(wq->thread&&wq->spec.yield!=THREAD_YIELD_TIME_SLOT)thread_set_yield_time(
wq->thread,wq->spec.yield);return1;}elsereturn0;}voidwork_queue_add(structwork_q
ueue*wq,void*data){structwork_queue_item*item;assert(wq);if(!(item=work_queue_it
em_new(wq))){zlog_err("%s:unabletogetnewqueueitem",__func__);return;}item->data=
data;work_queue_item_enqueue(wq,item);work_queue_schedule(wq,wq->spec.hold);retu
rn;}staticvoidwork_queue_item_requeue(structwork_queue*wq,structwork_queue_item*
item){work_queue_item_dequeue(wq,item);/*attachtoendoflist*/work_queue_item_enqu
eue(wq,item);}DEFUN(show_work_queues,show_work_queues_cmd,"showwork-queues",SHOW
_STR"WorkQueueinformation\n"){structlistnode*node;structwork_queue*wq;vty_out(vt
y,"%c%8s%5s%8s%8s%21s\n",'',"List","(ms)","Q.Runs","Yields","CycleCounts");vty_o
ut(vty,"%c%8s%5s%8s%8s%7s%6s%8s%6s%s\n",'P',"Items","Hold","Total","Total","Best
","Gran.","Total","Avg.","Name");for(ALL_LIST_ELEMENTS_RO(work_queues,node,wq)){
vty_out(vty,"%c%8d%5d%8ld%8ld%7d%6d%8ld%6u%s\n",(CHECK_FLAG(wq->flags,WQ_UNPLUGG
ED)?'':'P'),work_queue_item_count(wq),wq->spec.hold,wq->runs,wq->yields,wq->cycl
es.best,wq->cycles.granularity,wq->cycles.total,(wq->runs)?(unsignedint)(wq->cyc
les.total/wq->runs):0,wq->name);}returnCMD_SUCCESS;}voidworkqueue_cmd_init(void)
{install_element(VIEW_NODE,&show_work_queues_cmd);}/*'plug'aqueue:Stopitfrombein
gscheduled,*ie:preventthequeuefromdraining.*/voidwork_queue_plug(structwork_queu
e*wq){if(wq->thread)thread_cancel(wq->thread);wq->thread=NULL;UNSET_FLAG(wq->fla
gs,WQ_UNPLUGGED);}/*unplugqueue,scheduleitagain,ifappropriate*Ie:Allowthequeueto
bedrainedagain*/voidwork_queue_unplug(structwork_queue*wq){SET_FLAG(wq->flags,WQ
_UNPLUGGED);/*ifthreadisntalreadywaiting,addone*/work_queue_schedule(wq,wq->spec
.hold);}/*timerthreadtoprocessaworkqueue*willrescheduleitselfifrequired,*otherwi
sework_queue_item_add*/intwork_queue_run(structthread*thread){structwork_queue*w
q;structwork_queue_item*item,*titem;wq_item_statusret;unsignedintcycles=0;charyi
elded=0;wq=THREAD_ARG(thread);wq->thread=NULL;assert(wq);/*calculatecyclegranula
rity:*listiteration==1run*listnodeprocessing==1cycle*granularity==#cyclesbetween
checkswhetherweshouldyield.**granularityshouldbe>0,andcanincreaseslowlyaftereach
runto*providesomehysteris,butnotpastcycles.bestor2*cycles.**Best:startslow,canon
lyincrease**Granularity:startsatWORK_QUEUE_MIN_GRANULARITY,canbedecreased*ifweru
ntoendoftimeslot,canincreaseotherwise*byasmallfactor.**Wecouldusejusttheaveragea
ndsavesomework,howeverwewantto*be*abletoadjustquicklytoCPUpressure.Averagewontsh
iftmuchif*daemonhasbeenrunningalongtime.*/if(wq->cycles.granularity==0)wq->cycle
s.granularity=WORK_QUEUE_MIN_GRANULARITY;STAILQ_FOREACH_SAFE(item,&wq->items,wq,
titem){assert(item&&item->data);/*dontrunitemswhicharepasttheirallowedretries*/i
f(item->ran>wq->spec.max_retries){/*runerrorhandler,ifany*/if(wq->spec.errorfunc
)wq->spec.errorfunc(wq,item->data);work_queue_item_remove(wq,item);continue;}/*r
unandtakecareofitemsthatwanttoberetried*immediately*/do{ret=wq->spec.workfunc(wq
,item->data);item->ran++;}while((ret==WQ_RETRY_NOW)&&(item->ran<wq->spec.max_ret
ries));switch(ret){caseWQ_QUEUE_BLOCKED:{/*decrementitem->ranagain,causethisisn'
tanitem*specificerror,andfallthroughtoWQ_RETRY_LATER*/item->ran--;}caseWQ_RETRY_
LATER:{gotostats;}caseWQ_REQUEUE:{item->ran--;work_queue_item_requeue(wq,item);/
*Ifasinglenodeisbeingusedwithameta-queue*(e.g.,zebra),*updatethenextnodeaswedon'
twanttoexitthe*threadand*rescheduleitaftereverynode.Bydefinition,*WQ_REQUEUEis*m
eanttocontinuetheprocessing;theyieldlogic*willkickin*toterminatethethreadwhentim
ehasexceeded.*/if(titem==NULL)titem=item;break;}caseWQ_RETRY_NOW:/*aRETRY_NOWtha
tgetsherehasexceededmax_tries,sameas*ERROR*/caseWQ_ERROR:{if(wq->spec.errorfunc)
wq->spec.errorfunc(wq,item);}/*fallthru*/caseWQ_SUCCESS:default:{work_queue_item
_remove(wq,item);break;}}/*completedcycle*/cycles++;/*testifweshouldyield*/if(!(
cycles%wq->cycles.granularity)&&thread_should_yield(thread)){yielded=1;gotostats
;}}stats:#defineWQ_HYSTERESIS_FACTOR4/*weyielded,checkwhethergranularityshouldbe
reduced*/if(yielded&&(cycles<wq->cycles.granularity)){wq->cycles.granularity=((c
ycles>0)?cycles:WORK_QUEUE_MIN_GRANULARITY);}/*otherwise,shouldgranularityincrea
se?*/elseif(cycles>=(wq->cycles.granularity)){if(cycles>wq->cycles.best)wq->cycl
es.best=cycles;/*alongwithyieldedcheck,provideshysteresisforgranularity*/if(cycl
es>(wq->cycles.granularity*WQ_HYSTERESIS_FACTOR*WQ_HYSTERESIS_FACTOR))wq->cycles
.granularity*=WQ_HYSTERESIS_FACTOR;/*quickramp-up*/elseif(cycles>(wq->cycles.gra
nularity*WQ_HYSTERESIS_FACTOR))wq->cycles.granularity+=WQ_HYSTERESIS_FACTOR;}#un
defWQ_HYSTERIS_FACTORwq->runs++;wq->cycles.total+=cycles;if(yielded)wq->yields++
;#if0printf("%s:cycles%d,new:best%d,worst%d\n",__func__,cycles,wq->cycles.best,w
q->cycles.granularity);#endif/*Isthequeuedoneyet?Ifitis,callthecompletioncallbac
k.*/if(!work_queue_empty(wq))work_queue_schedule(wq,0);elseif(wq->spec.completio
n_func)wq->spec.completion_func(wq);return0;}