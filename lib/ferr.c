/**Copyright(c)2015-16DavidLamparter,forNetDEF,Inc.**Permissiontouse,copy,modify
,anddistributethissoftwareforany*purposewithorwithoutfeeisherebygranted,provided
thattheabove*copyrightnoticeandthispermissionnoticeappearinallcopies.**THESOFTWA
REISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINC
LUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBE
LIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEV
ERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOR
OTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFT
WARE.*/#include<stdlib.h>#include<stdarg.h>#include<string.h>#include<pthread.h>
#include<signal.h>#include"ferr.h"#include"vty.h"#include"jhash.h"#include"memor
y.h"DEFINE_MTYPE_STATIC(LIB,ERRINFO,"errorinformation")staticpthread_key_terrkey
;staticvoidferr_free(void*arg){XFREE(MTYPE_ERRINFO,arg);}staticvoiderr_key_init(
void)__attribute__((_CONSTRUCTOR(500)));staticvoiderr_key_init(void){pthread_key
_create(&errkey,ferr_free);}staticvoiderr_key_fini(void)__attribute__((_DESTRUCT
OR(500)));staticvoiderr_key_fini(void){pthread_key_delete(errkey);}conststructfe
rr*ferr_get_last(ferr_rerrval){structferr*last_error=pthread_getspecific(errkey)
;if(!last_error||last_error->kind==0)returnNULL;returnlast_error;}ferr_rferr_cle
ar(void){structferr*last_error=pthread_getspecific(errkey);if(last_error)last_er
ror->kind=0;returnferr_ok();}staticferr_rferr_set_va(constchar*file,intline,cons
tchar*func,enumferr_kindkind,constchar*pathname,interrno_val,constchar*text,va_l
istva){structferr*error=pthread_getspecific(errkey);if(!error){error=XCALLOC(MTY
PE_ERRINFO,sizeof(*error));if(!error){/*we'rescrewed*/zlog_err("outofmemorywhile
allocatingerrorinfo");raise(SIGSEGV);abort();/*raise()canreturn,butraise(SIGSEGV
)shallnot*/}pthread_setspecific(errkey,error);}error->file=file;error->line=line
;error->func=func;error->kind=kind;error->unique_id=jhash(text,strlen(text),jhas
h(file,strlen(file),0xd4ed0298));error->errno_val=errno_val;if(pathname)snprintf
(error->pathname,sizeof(error->pathname),"%s",pathname);elseerror->pathname[0]='
\0';vsnprintf(error->message,sizeof(error->message),text,va);return-1;}ferr_rfer
r_set_internal(constchar*file,intline,constchar*func,enumferr_kindkind,constchar
*text,...){ferr_rrv;va_listva;va_start(va,text);rv=ferr_set_va(file,line,func,ki
nd,NULL,0,text,va);va_end(va);returnrv;}ferr_rferr_set_internal_ext(constchar*fi
le,intline,constchar*func,enumferr_kindkind,constchar*pathname,interrno_val,cons
tchar*text,...){ferr_rrv;va_listva;va_start(va,text);rv=ferr_set_va(file,line,fu
nc,kind,pathname,errno_val,text,va);va_end(va);returnrv;}#defineREPLACE"$ERR"voi
dvty_print_error(structvty*vty,ferr_rerr,constchar*msg,...){chartmpmsg[512],*rep
lacepos;conststructferr*last_error=ferr_get_last(err);va_listva;va_start(va,msg)
;vsnprintf(tmpmsg,sizeof(tmpmsg),msg,va);va_end(va);replacepos=strstr(tmpmsg,REP
LACE);if(!replacepos)vty_out(vty,"%s\n",tmpmsg);else{replacepos[0]='\0';replacep
os+=sizeof(REPLACE)-1;vty_out(vty,"%s%s%s\n",tmpmsg,last_error?last_error->messa
ge:"(noerror?)",replacepos);}}