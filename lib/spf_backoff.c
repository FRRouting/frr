/**ThisisanimplementationoftheIETFSPFdelayalgorithm*asexplainedindraft-ietf-rtgw
g-backoff-algo-04**Created:25-01-2017byS.Litkowski**Copyright(C)2017OrangeLabsht
tp://www.orange.com/*Copyright(C)2017byChristianFranke,OpenSourceRouting/NetDEFI
nc.**ThisfileispartofFreeRangeRouting(FRR)**FRRisfreesoftware;youcanredistribute
itand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeS
oftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**FRRisdistrib
utedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarr
antyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLice
nseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*
withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,5
1FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"spf_bac
koff.h"#include"command.h"#include"memory.h"#include"thread.h"#include"vty.h"DEF
INE_MTYPE_STATIC(LIB,SPF_BACKOFF,"SPFbackoff")DEFINE_MTYPE_STATIC(LIB,SPF_BACKOF
F_NAME,"SPFbackoffname")staticbooldebug_spf_backoff=false;#definebackoff_debug(.
..)\do{\if(debug_spf_backoff)\zlog_debug(__VA_ARGS__);\}while(0)enumspf_backoff_
state{SPF_BACKOFF_QUIET,SPF_BACKOFF_SHORT_WAIT,SPF_BACKOFF_LONG_WAIT};structspf_
backoff{structthread_master*m;/*Timersasperdraft*/longinit_delay;longshort_delay
;longlong_delay;longholddown;longtimetolearn;/*Statemachine*/enumspf_backoff_sta
testate;structthread*t_holddown;structthread*t_timetolearn;/*Fordebugging*/char*
name;structtimevalfirst_event_time;structtimevallast_event_time;};staticconstcha
r*spf_backoff_state2str(enumspf_backoff_statestate){switch(state){caseSPF_BACKOF
F_QUIET:return"QUIET";caseSPF_BACKOFF_SHORT_WAIT:return"SHORT_WAIT";caseSPF_BACK
OFF_LONG_WAIT:return"LONG_WAIT";}return"???";}structspf_backoff*spf_backoff_new(
structthread_master*m,constchar*name,longinit_delay,longshort_delay,longlong_del
ay,longholddown,longtimetolearn){structspf_backoff*rv;rv=XCALLOC(MTYPE_SPF_BACKO
FF,sizeof(*rv));rv->m=m;rv->init_delay=init_delay;rv->short_delay=short_delay;rv
->long_delay=long_delay;rv->holddown=holddown;rv->timetolearn=timetolearn;rv->st
ate=SPF_BACKOFF_QUIET;rv->name=XSTRDUP(MTYPE_SPF_BACKOFF_NAME,name);returnrv;}vo
idspf_backoff_free(structspf_backoff*backoff){if(!backoff)return;THREAD_TIMER_OF
F(backoff->t_holddown);THREAD_TIMER_OFF(backoff->t_timetolearn);XFREE(MTYPE_SPF_
BACKOFF_NAME,backoff->name);XFREE(MTYPE_SPF_BACKOFF,backoff);}staticintspf_backo
ff_timetolearn_elapsed(structthread*thread){structspf_backoff*backoff=THREAD_ARG
(thread);backoff->t_timetolearn=NULL;backoff->state=SPF_BACKOFF_LONG_WAIT;backof
f_debug("SPFBack-off(%s)TIMETOLEARNelapsed,movetostate%s",backoff->name,spf_back
off_state2str(backoff->state));return0;}staticintspf_backoff_holddown_elapsed(st
ructthread*thread){structspf_backoff*backoff=THREAD_ARG(thread);backoff->t_holdd
own=NULL;THREAD_TIMER_OFF(backoff->t_timetolearn);timerclear(&backoff->first_eve
nt_time);backoff->state=SPF_BACKOFF_QUIET;backoff_debug("SPFBack-off(%s)HOLDDOWN
elapsed,movetostate%s",backoff->name,spf_backoff_state2str(backoff->state));retu
rn0;}longspf_backoff_schedule(structspf_backoff*backoff){longrv;structtimevalnow
;gettimeofday(&now,NULL);backoff_debug("SPFBack-off(%s)schedulecalledinstate%s",
backoff->name,spf_backoff_state2str(backoff->state));backoff->last_event_time=no
w;switch(backoff->state){caseSPF_BACKOFF_QUIET:backoff->state=SPF_BACKOFF_SHORT_
WAIT;thread_add_timer_msec(backoff->m,spf_backoff_timetolearn_elapsed,backoff,ba
ckoff->timetolearn,&backoff->t_timetolearn);thread_add_timer_msec(backoff->m,spf
_backoff_holddown_elapsed,backoff,backoff->holddown,&backoff->t_holddown);backof
f->first_event_time=now;rv=backoff->init_delay;break;caseSPF_BACKOFF_SHORT_WAIT:
caseSPF_BACKOFF_LONG_WAIT:THREAD_TIMER_OFF(backoff->t_holddown);thread_add_timer
_msec(backoff->m,spf_backoff_holddown_elapsed,backoff,backoff->holddown,&backoff
->t_holddown);if(backoff->state==SPF_BACKOFF_SHORT_WAIT)rv=backoff->short_delay;
elserv=backoff->long_delay;break;default:zlog_warn("SPFBack-off(%s)inunknownstat
e",backoff->name);rv=backoff->init_delay;}backoff_debug("SPFBack-off(%s)changeds
tateto%sandreturned%lddelay",backoff->name,spf_backoff_state2str(backoff->state)
,rv);returnrv;}staticconstchar*timeval_format(structtimeval*tv){structtmtm_store
;structtm*tm;staticchartimebuf[256];if(!tv->tv_sec&&!tv->tv_usec)return"(never)"
;tm=localtime_r(&tv->tv_sec,&tm_store);if(!tm||strftime(timebuf,sizeof(timebuf),
"%Z%a%Y-%m-%d%H:%M:%S",tm)==0){return"???";}size_toffset=strlen(timebuf);snprint
f(timebuf+offset,sizeof(timebuf)-offset,".%ld",(longint)tv->tv_usec);returntimeb
uf;}voidspf_backoff_show(structspf_backoff*backoff,structvty*vty,constchar*prefi
x){vty_out(vty,"%sCurrentstate:%s\n",prefix,spf_backoff_state2str(backoff->state
));vty_out(vty,"%sInittimer:%ldmsec\n",prefix,backoff->init_delay);vty_out(vty,"
%sShorttimer:%ldmsec\n",prefix,backoff->short_delay);vty_out(vty,"%sLongtimer:%l
dmsec\n",prefix,backoff->long_delay);vty_out(vty,"%sHolddowntimer:%ldmsec\n",pre
fix,backoff->holddown);if(backoff->t_holddown){structtimevalremain=thread_timer_
remain(backoff->t_holddown);vty_out(vty,"%sStillrunsfor%lldmsec\n",prefix,(longl
ong)remain.tv_sec*1000+remain.tv_usec/1000);}else{vty_out(vty,"%sInactive\n",pre
fix);}vty_out(vty,"%sTimeToLearntimer:%ldmsec\n",prefix,backoff->timetolearn);if
(backoff->t_timetolearn){structtimevalremain=thread_timer_remain(backoff->t_time
tolearn);vty_out(vty,"%sStillrunsfor%lldmsec\n",prefix,(longlong)remain.tv_sec*1
000+remain.tv_usec/1000);}else{vty_out(vty,"%sInactive\n",prefix);}vty_out(vty,"
%sFirstevent:%s\n",prefix,timeval_format(&backoff->first_event_time));vty_out(vt
y,"%sLastevent:%s\n",prefix,timeval_format(&backoff->last_event_time));}DEFUN(sp
f_backoff_debug,spf_backoff_debug_cmd,"debugspf-delay-ietf",DEBUG_STR"SPFBack-of
fDebugging\n"){debug_spf_backoff=true;returnCMD_SUCCESS;}DEFUN(no_spf_backoff_de
bug,no_spf_backoff_debug_cmd,"nodebugspf-delay-ietf",NO_STRDEBUG_STR"SPFBack-off
Debugging\n"){debug_spf_backoff=false;returnCMD_SUCCESS;}intspf_backoff_write_co
nfig(structvty*vty){intwritten=0;if(debug_spf_backoff){vty_out(vty,"debugspf-del
ay-ietf\n");written++;}returnwritten;}voidspf_backoff_cmd_init(void){install_ele
ment(ENABLE_NODE,&spf_backoff_debug_cmd);install_element(CONFIG_NODE,&spf_backof
f_debug_cmd);install_element(ENABLE_NODE,&no_spf_backoff_debug_cmd);install_elem
ent(CONFIG_NODE,&no_spf_backoff_debug_cmd);}longspf_backoff_init_delay(structspf
_backoff*backoff){returnbackoff->init_delay;}longspf_backoff_short_delay(structs
pf_backoff*backoff){returnbackoff->short_delay;}longspf_backoff_long_delay(struc
tspf_backoff*backoff){returnbackoff->long_delay;}longspf_backoff_holddown(struct
spf_backoff*backoff){returnbackoff->holddown;}longspf_backoff_timetolearn(struct
spf_backoff*backoff){returnbackoff->timetolearn;}