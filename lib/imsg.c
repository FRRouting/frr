/*$OpenBSD$*//**Copyright(c)2003,2004HenningBrauer<henning@openbsd.org>**Permiss
iontouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishe
rebygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearina
llcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREG
ARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOE
VENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESO
RANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFC
ONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORP
ERFORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"queue.h"#include"imsg.h"int
imsg_fd_overhead=0;intimsg_get_fd(structimsgbuf*);#ifndef__OpenBSD__/**Theorigin
alcodecallsgetdtablecount()whichisOpenBSDspecific.Use*available_fds()fromOpenSMT
PDinstead.*/staticintavailable_fds(unsignedintn){unsignedinti;intret,fds[256];if
(n>(sizeof(fds)/sizeof(fds[0])))return(1);ret=0;for(i=0;i<n;i++){fds[i]=-1;if((f
ds[i]=socket(AF_INET,SOCK_DGRAM,0))<0){if(errno==EAFNOSUPPORT||errno==EPROTONOSU
PPORT)fds[i]=socket(AF_INET6,SOCK_DGRAM,0);if(fds[i]<0){ret=1;break;}}}for(i=0;i
<n&&fds[i]>=0;i++)close(fds[i]);return(ret);}#endifvoidimsg_init(structimsgbuf*i
buf,intfd){msgbuf_init(&ibuf->w);memset(&ibuf->r,0,sizeof(ibuf->r));ibuf->fd=fd;
ibuf->w.fd=fd;ibuf->pid=getpid();TAILQ_INIT(&ibuf->fds);}ssize_timsg_read(struct
imsgbuf*ibuf){structmsghdrmsg;structcmsghdr*cmsg;union{structcmsghdrhdr;charbuf[
CMSG_SPACE(sizeof(int)*1)];}cmsgbuf;structioveciov;ssize_tn=-1;intfd;structimsg_
fd*ifd;memset(&msg,0,sizeof(msg));memset(&cmsgbuf,0,sizeof(cmsgbuf));iov.iov_bas
e=ibuf->r.buf+ibuf->r.wpos;iov.iov_len=sizeof(ibuf->r.buf)-ibuf->r.wpos;msg.msg_
iov=&iov;msg.msg_iovlen=1;msg.msg_control=&cmsgbuf.buf;msg.msg_controllen=sizeof
(cmsgbuf.buf);if((ifd=calloc(1,sizeof(structimsg_fd)))==NULL)return(-1);again:#i
fdef__OpenBSD__if(getdtablecount()+imsg_fd_overhead+(int)((CMSG_SPACE(sizeof(int
))-CMSG_SPACE(0))/sizeof(int))>=getdtablesize()){#elseif(available_fds(imsg_fd_o
verhead+(CMSG_SPACE(sizeof(int))-CMSG_SPACE(0))/sizeof(int))){#endiferrno=EAGAIN
;free(ifd);return(-1);}if((n=recvmsg(ibuf->fd,&msg,0))==-1){if(errno==EINTR)goto
again;gotofail;}ibuf->r.wpos+=n;for(cmsg=CMSG_FIRSTHDR(&msg);cmsg!=NULL;cmsg=CMS
G_NXTHDR(&msg,cmsg)){if(cmsg->cmsg_level==SOL_SOCKET&&cmsg->cmsg_type==SCM_RIGHT
S){inti;intj;/**Weonlyacceptonefiledescriptor.DuetoC*paddingrules,ourcontrolbuff
ermightcontain*morethanonefd,andwemustclosethem.*/j=((char*)cmsg+cmsg->cmsg_len-
(char*)CMSG_DATA(cmsg))/sizeof(int);for(i=0;i<j;i++){fd=((int*)CMSG_DATA(cmsg))[
i];if(ifd!=NULL){ifd->fd=fd;TAILQ_INSERT_TAIL(&ibuf->fds,ifd,entry);ifd=NULL;}el
seclose(fd);}}/*wedonothandleotherctldatalevel*/}fail:free(ifd);return(n);}ssize
_timsg_get(structimsgbuf*ibuf,structimsg*imsg){size_tav,left,datalen;av=ibuf->r.
wpos;if(IMSG_HEADER_SIZE>av)return(0);memcpy(&imsg->hdr,ibuf->r.buf,sizeof(imsg-
>hdr));if(imsg->hdr.len<IMSG_HEADER_SIZE||imsg->hdr.len>MAX_IMSGSIZE){errno=ERAN
GE;return(-1);}if(imsg->hdr.len>av)return(0);datalen=imsg->hdr.len-IMSG_HEADER_S
IZE;ibuf->r.rptr=ibuf->r.buf+IMSG_HEADER_SIZE;if(datalen==0)imsg->data=NULL;else
if((imsg->data=malloc(datalen))==NULL)return(-1);if(imsg->hdr.flags&IMSGF_HASFD)
imsg->fd=imsg_get_fd(ibuf);elseimsg->fd=-1;if(imsg->data)memcpy(imsg->data,ibuf-
>r.rptr,datalen);if(imsg->hdr.len<av){left=av-imsg->hdr.len;memmove(&ibuf->r.buf
,ibuf->r.buf+imsg->hdr.len,left);ibuf->r.wpos=left;}elseibuf->r.wpos=0;return(da
talen+IMSG_HEADER_SIZE);}intimsg_compose(structimsgbuf*ibuf,uint32_ttype,uint32_
tpeerid,pid_tpid,intfd,constvoid*data,uint16_tdatalen){structibuf*wbuf;if((wbuf=
imsg_create(ibuf,type,peerid,pid,datalen))==NULL)return(-1);if(imsg_add(wbuf,dat
a,datalen)==-1)return(-1);wbuf->fd=fd;imsg_close(ibuf,wbuf);return(1);}intimsg_c
omposev(structimsgbuf*ibuf,uint32_ttype,uint32_tpeerid,pid_tpid,intfd,conststruc
tiovec*iov,intiovcnt){structibuf*wbuf;inti,datalen=0;for(i=0;i<iovcnt;i++)datale
n+=iov[i].iov_len;if((wbuf=imsg_create(ibuf,type,peerid,pid,datalen))==NULL)retu
rn(-1);for(i=0;i<iovcnt;i++)if(imsg_add(wbuf,iov[i].iov_base,iov[i].iov_len)==-1
)return(-1);wbuf->fd=fd;imsg_close(ibuf,wbuf);return(1);}/*ARGSUSED*/structibuf*
imsg_create(structimsgbuf*ibuf,uint32_ttype,uint32_tpeerid,pid_tpid,uint16_tdata
len){structibuf*wbuf;structimsg_hdrhdr;datalen+=IMSG_HEADER_SIZE;if(datalen>MAX_
IMSGSIZE){errno=ERANGE;return(NULL);}hdr.type=type;hdr.flags=0;hdr.peerid=peerid
;if((hdr.pid=pid)==0)hdr.pid=ibuf->pid;if((wbuf=ibuf_dynamic(datalen,MAX_IMSGSIZ
E))==NULL){return(NULL);}if(imsg_add(wbuf,&hdr,sizeof(hdr))==-1)return(NULL);ret
urn(wbuf);}intimsg_add(structibuf*msg,constvoid*data,uint16_tdatalen){if(datalen
)if(ibuf_add(msg,data,datalen)==-1){ibuf_free(msg);return(-1);}return(datalen);}
voidimsg_close(structimsgbuf*ibuf,structibuf*msg){structimsg_hdr*hdr;hdr=(struct
imsg_hdr*)msg->buf;hdr->flags&=~IMSGF_HASFD;if(msg->fd!=-1)hdr->flags|=IMSGF_HAS
FD;hdr->len=(uint16_t)msg->wpos;ibuf_close(&ibuf->w,msg);}voidimsg_free(structim
sg*imsg){free(imsg->data);}intimsg_get_fd(structimsgbuf*ibuf){intfd;structimsg_f
d*ifd;if((ifd=TAILQ_FIRST(&ibuf->fds))==NULL)return(-1);fd=ifd->fd;TAILQ_REMOVE(
&ibuf->fds,ifd,entry);free(ifd);return(fd);}intimsg_flush(structimsgbuf*ibuf){wh
ile(ibuf->w.queued)if(msgbuf_write(&ibuf->w)<=0)return(-1);return(0);}voidimsg_c
lear(structimsgbuf*ibuf){intfd;msgbuf_clear(&ibuf->w);while((fd=imsg_get_fd(ibuf
))!=-1)close(fd);}