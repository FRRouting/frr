/**CLIgraphhandling**--*Copyright(C)2016CumulusNetworks,Inc.*Copyright(C)1997,98
,99KunihiroIshiguro*Copyright(C)2013byOpenSourceRouting.*Copyright(C)2013byInter
netSystemsConsortium,Inc.("ISC")**Thisprogramisfreesoftware;youcanredistributeit
and/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*Sof
twareFoundation;eitherversion2oftheLicense,or(atyouroption)*anylaterversion.**Th
isprogramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;without
eventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNU
GeneralPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralP
ublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware
*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.
h>#include"command_graph.h"DEFINE_MTYPE_STATIC(LIB,CMD_TOKENS,"CommandTokens")DE
FINE_MTYPE_STATIC(LIB,CMD_DESC,"CommandTokenText")DEFINE_MTYPE_STATIC(LIB,CMD_TE
XT,"CommandTokenHelp")DEFINE_MTYPE(LIB,CMD_ARG,"CommandArgument")DEFINE_MTYPE_ST
ATIC(LIB,CMD_VAR,"CommandArgumentName")structcmd_token*cmd_token_new(enumcmd_tok
en_typetype,uint8_tattr,constchar*text,constchar*desc){structcmd_token*token=XCA
LLOC(MTYPE_CMD_TOKENS,sizeof(structcmd_token));token->type=type;token->attr=attr
;token->text=text?XSTRDUP(MTYPE_CMD_TEXT,text):NULL;token->desc=desc?XSTRDUP(MTY
PE_CMD_DESC,desc):NULL;token->refcnt=1;token->arg=NULL;token->allowrepeat=false;
token->varname=NULL;returntoken;}voidcmd_token_del(structcmd_token*token){if(!to
ken)return;XFREE(MTYPE_CMD_TEXT,token->text);XFREE(MTYPE_CMD_DESC,token->desc);X
FREE(MTYPE_CMD_ARG,token->arg);XFREE(MTYPE_CMD_VAR,token->varname);XFREE(MTYPE_C
MD_TOKENS,token);}structcmd_token*cmd_token_dup(structcmd_token*token){structcmd
_token*copy=cmd_token_new(token->type,token->attr,NULL,NULL);copy->max=token->ma
x;copy->min=token->min;copy->text=token->text?XSTRDUP(MTYPE_CMD_TEXT,token->text
):NULL;copy->desc=token->desc?XSTRDUP(MTYPE_CMD_DESC,token->desc):NULL;copy->arg
=token->arg?XSTRDUP(MTYPE_CMD_ARG,token->arg):NULL;copy->varname=token->varname?
XSTRDUP(MTYPE_CMD_VAR,token->varname):NULL;returncopy;}voidcmd_token_varname_set
(structcmd_token*token,constchar*varname){XFREE(MTYPE_CMD_VAR,token->varname);if
(!varname){token->varname=NULL;return;}size_tlen=strlen(varname),i;token->varnam
e=XMALLOC(MTYPE_CMD_VAR,len+1);for(i=0;i<len;i++)switch(varname[i]){case'-':case
'+':case'*':case':':token->varname[i]='_';break;default:token->varname[i]=tolowe
r((int)varname[i]);}token->varname[len]='\0';}staticboolcmd_nodes_link(structgra
ph_node*from,structgraph_node*to){for(size_ti=0;i<vector_active(from->to);i++)if
(vector_slot(from->to,i)==to)returntrue;returnfalse;}staticboolcmd_nodes_equal(s
tructgraph_node*ga,structgraph_node*gb);/*returnsasinglenodetobeexcludedas"next"
fromiteration*-forJOIN_TKN,nevercontinuebacktotheFORK_TKN*-inallothercases,don't
trythenodeitself(incaseof"...")*/staticinlinestructgraph_node*cmd_loopstop(struc
tgraph_node*gn){structcmd_token*tok=gn->data;if(tok->type==JOIN_TKN)returntok->f
orkjoin;elsereturngn;}staticboolcmd_subgraph_equal(structgraph_node*ga,structgra
ph_node*gb,structgraph_node*a_join){size_ti,j;structgraph_node*a_fork,*b_fork;a_
fork=cmd_loopstop(ga);b_fork=cmd_loopstop(gb);if(vector_active(ga->to)!=vector_a
ctive(gb->to))returnfalse;for(i=0;i<vector_active(ga->to);i++){structgraph_node*
cga=vector_slot(ga->to,i);for(j=0;j<vector_active(gb->to);j++){structgraph_node*
cgb=vector_slot(gb->to,i);if(cga==a_fork&&cgb!=b_fork)continue;if(cga==a_fork&&c
gb==b_fork)break;if(cmd_nodes_equal(cga,cgb)){if(cga==a_join)break;if(cmd_subgra
ph_equal(cga,cgb,a_join))break;}}if(j==vector_active(gb->to))returnfalse;}return
true;}/*deepcompare--forFORK_TKN,theentiresubgraphiscompared.*thisiswhat'sneeded
sincewe'renotcurrentlytryingtopartially*mergesubgraphs*/staticboolcmd_nodes_equa
l(structgraph_node*ga,structgraph_node*gb){structcmd_token*a=ga->data,*b=gb->dat
a;if(a->type!=b->type||a->allowrepeat!=b->allowrepeat)returnfalse;if(a->type<SPE
CIAL_TKN&&strcmp(a->text,b->text))returnfalse;/*onea...,theothernot.*/if(cmd_nod
es_link(ga,ga)!=cmd_nodes_link(gb,gb))returnfalse;if(!a->varname!=!b->varname)re
turnfalse;if(a->varname&&strcmp(a->varname,b->varname))returnfalse;switch(a->typ
e){caseRANGE_TKN:returna->min==b->min&&a->max==b->max;caseFORK_TKN:/*oneiskeywor
ds,theotherjustoptionorselector...*/if(cmd_nodes_link(a->forkjoin,ga)!=cmd_nodes
_link(b->forkjoin,gb))returnfalse;if(cmd_nodes_link(ga,a->forkjoin)!=cmd_nodes_l
ink(gb,b->forkjoin))returnfalse;returncmd_subgraph_equal(ga,gb,a->forkjoin);defa
ult:returntrue;}}staticvoidcmd_fork_bump_attr(structgraph_node*gn,structgraph_no
de*join,uint8_tattr){size_ti;structcmd_token*tok=gn->data;structgraph_node*stop=
cmd_loopstop(gn);tok->attr=attr;for(i=0;i<vector_active(gn->to);i++){structgraph
_node*next=vector_slot(gn->to,i);if(next==stop||next==join)continue;cmd_fork_bum
p_attr(next,join,attr);}}/*moveanentiresubtreefromthetemporarygraphresultingfrom
*parse()intothepermanentgraphforthecommandnode.**thistouchesratherdeeplyintotheg
raphcodeunfortunately.*/staticvoidcmd_reparent_tree(structgraph*fromgraph,struct
graph*tograph,structgraph_node*node){structgraph_node*stop=cmd_loopstop(node);si
ze_ti;for(i=0;i<vector_active(fromgraph->nodes);i++)if(vector_slot(fromgraph->no
des,i)==node){/*agressiveiterationpunchingthroughsubgraphs-may*hitsome*nodestwic
e.reparentonlyiffoundonoldgraph*/vector_unset(fromgraph->nodes,i);vector_set(tog
raph->nodes,node);break;}for(i=0;i<vector_active(node->to);i++){structgraph_node
*next=vector_slot(node->to,i);if(next!=stop)cmd_reparent_tree(fromgraph,tograph,
next);}}staticvoidcmd_free_recur(structgraph*graph,structgraph_node*node,structg
raph_node*stop){structgraph_node*next,*nstop;for(size_ti=vector_active(node->to)
;i;i--){next=vector_slot(node->to,i-1);if(next==stop)continue;nstop=cmd_loopstop
(next);if(nstop!=next)cmd_free_recur(graph,next,nstop);cmd_free_recur(graph,nsto
p,stop);}graph_delete_node(graph,node);}staticvoidcmd_free_node(structgraph*grap
h,structgraph_node*node){structcmd_token*tok=node->data;if(tok->type==JOIN_TKN)c
md_free_recur(graph,tok->forkjoin,node);graph_delete_node(graph,node);}/*recursi
vegraphmerge.callwith*old~=new*(whichholdstrueforold==START_TKN,new==START_TKN)*
/staticvoidcmd_merge_nodes(structgraph*oldgraph,structgraph*newgraph,structgraph
_node*old,structgraph_node*new,intdirection){structcmd_token*tok;structgraph_nod
e*old_skip,*new_skip;old_skip=cmd_loopstop(old);new_skip=cmd_loopstop(new);asser
t(direction==1||direction==-1);tok=old->data;tok->refcnt+=direction;size_tj,i;fo
r(j=0;j<vector_active(new->to);j++){structgraph_node*cnew=vector_slot(new->to,j)
;if(cnew==new_skip)continue;for(i=0;i<vector_active(old->to);i++){structgraph_no
de*cold=vector_slot(old->to,i);if(cold==old_skip)continue;if(cmd_nodes_equal(col
d,cnew)){structcmd_token*told=cold->data,*tnew=cnew->data;if(told->type==END_TKN
){if(direction<0){graph_delete_node(oldgraph,vector_slot(cold->to,0));graph_dele
te_node(oldgraph,cold);}else/*forceno-matchhandlingto*installEND_TKN*/i=vector_a
ctive(old->to);break;}/*theentireforkcomparedasequal,we*continueafterit.*/if(tol
d->type==FORK_TKN){if(tnew->attr<told->attr&&direction>0)cmd_fork_bump_attr(cold
,told->forkjoin,tnew->attr);/*XXX:noreversebumponuninstall*/told=(cold=told->for
kjoin)->data;tnew=(cnew=tnew->forkjoin)->data;}if(tnew->attr<told->attr)told->at
tr=tnew->attr;cmd_merge_nodes(oldgraph,newgraph,cold,cnew,direction);break;}}/*n
othingfound=>addnewtoold*/if(i==vector_active(old->to)&&direction>0){graph_remov
e_edge(new,cnew);cmd_reparent_tree(newgraph,oldgraph,cnew);graph_add_edge(old,cn
ew);}}if(!tok->refcnt)cmd_free_node(oldgraph,old);}voidcmd_graph_merge(structgra
ph*old,structgraph*new,intdirection){assert(vector_active(old->nodes)>=1);assert
(vector_active(new->nodes)>=1);cmd_merge_nodes(old,new,vector_slot(old->nodes,0)
,vector_slot(new->nodes,0),direction);}staticvoidcmd_node_names(structgraph_node
*gn,structgraph_node*join,constchar*prevname){size_ti;structcmd_token*tok=gn->da
ta,*jointok;structgraph_node*stop=cmd_loopstop(gn);switch(tok->type){caseWORD_TK
N:prevname=tok->text;break;caseVARIABLE_TKN:if(!tok->varname&&strcmp(tok->text,"
WORD")&&strcmp(tok->text,"NAME"))cmd_token_varname_set(tok,tok->text);/*fallthro
ugh*/caseRANGE_TKN:caseIPV4_TKN:caseIPV4_PREFIX_TKN:caseIPV6_TKN:caseIPV6_PREFIX
_TKN:caseMAC_TKN:caseMAC_PREFIX_TKN:if(!tok->varname&&prevname)cmd_token_varname
_set(tok,prevname);prevname=NULL;break;caseSTART_TKN:caseJOIN_TKN:/*"<foo|bar>WO
RD"->wordisnot"bar"or"foo"*/prevname=NULL;break;caseFORK_TKN:/*apply"<A.B.C.D|X:
X::X:X>$name"*/jointok=tok->forkjoin->data;if(!jointok->varname)break;for(i=0;i<
vector_active(tok->forkjoin->from);i++){structgraph_node*tail=vector_slot(tok->f
orkjoin->from,i);structcmd_token*tailtok=tail->data;if(tail==gn||tailtok->varnam
e)continue;cmd_token_varname_set(tailtok,jointok->varname);}break;caseEND_TKN:re
turn;}for(i=0;i<vector_active(gn->to);i++){structgraph_node*next=vector_slot(gn-
>to,i);if(next==stop||next==join)continue;cmd_node_names(next,join,prevname);}if
(tok->type==FORK_TKN&&tok->forkjoin!=join)cmd_node_names(tok->forkjoin,join,NULL
);}voidcmd_graph_names(structgraph*graph){structgraph_node*start;assert(vector_a
ctive(graph->nodes)>=1);start=vector_slot(graph->nodes,0);/*applyvarnameoninitia
l"[no]"*/do{if(vector_active(start->to)!=1)break;structgraph_node*first=vector_s
lot(start->to,0);structcmd_token*tok=first->data;/*lookingforanoptionwith2choice
s,nothingor"no"*/if(tok->type!=FORK_TKN||vector_active(first->to)!=2)break;struc
tgraph_node*next0=vector_slot(first->to,0);structgraph_node*next1=vector_slot(fi
rst->to,1);/*oneneedstobeempty*/if(next0!=tok->forkjoin&&next1!=tok->forkjoin)br
eak;structcmd_token*tok0=next0->data;structcmd_token*tok1=next1->data;/*theother
oneneedstobe"no"(onlyonewillmatchhere)*/if((tok0->type==WORD_TKN&&!strcmp(tok0->
text,"no")))cmd_token_varname_set(tok0,"no");if((tok1->type==WORD_TKN&&!strcmp(t
ok1->text,"no")))cmd_token_varname_set(tok1,"no");}while(0);cmd_node_names(start
,NULL,NULL);}