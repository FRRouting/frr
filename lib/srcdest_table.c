/**SRC-DESTRoutingTable**Copyright(C)2017byDavidLamparter&ChristianFranke,*OpenS
ourceRouting/NetDEFInc.**ThisfileispartofFreeRangeRouting(FRR)**FRRisfreesoftwar
e;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseas
publishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterve
rsion.**FRRisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;witho
uteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheG
NU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGenera
lPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftwa
re*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebr
a.h>#include"srcdest_table.h"#include"memory.h"#include"prefix.h"#include"table.
h"DEFINE_MTYPE_STATIC(LIB,ROUTE_SRC_NODE,"Routesourcenode")/*-----functionstoman
agernodes_with_srcdesttable-----*/structsrcdest_rnode{/*mustbefirstinstructurefo
rcastingto/fromroute_node*/ROUTE_NODE_FIELDS;structroute_table*src_table;};stati
cstructsrcdest_rnode*srcdest_rnode_from_rnode(structroute_node*rn){assert(rnode_
is_dstnode(rn));return(structsrcdest_rnode*)rn;}staticstructroute_node*srcdest_r
node_to_rnode(structsrcdest_rnode*srn){return(structroute_node*)srn;}staticstruc
troute_node*srcdest_rnode_create(route_table_delegate_t*delegate,structroute_tab
le*table){structsrcdest_rnode*srn;srn=XCALLOC(MTYPE_ROUTE_NODE,sizeof(structsrcd
est_rnode));returnsrcdest_rnode_to_rnode(srn);}staticvoidsrcdest_rnode_destroy(r
oute_table_delegate_t*delegate,structroute_table*table,structroute_node*rn){stru
ctsrcdest_rnode*srn=srcdest_rnode_from_rnode(rn);structroute_table*src_table;/*C
learroutenode'ssrc_tableherealready,otherwisethe*deletionofthelastnodeinthesrc_t
ablewilltrigger*anothercalltoroute_table_finishforthesrc_table.**(Comparewithsrc
dest_srcnode_destroy)*/src_table=srn->src_table;srn->src_table=NULL;route_table_
finish(src_table);XFREE(MTYPE_ROUTE_NODE,rn);}route_table_delegate_t_srcdest_dst
node_delegate={.create_node=srcdest_rnode_create,.destroy_node=srcdest_rnode_des
troy};/*-----functionstomanagernodes_in_srcdesttable-----*//*nodecreation/deleti
onforsrcdestsourceprefixnodes.*theroute_nodeisn'tactuallydifferentfromthenormalr
oute_node,*butthecleanupisspecialtofreethetable(andpossiblythe*destinationprefix
'sroute_node)*/staticstructroute_node*srcdest_srcnode_create(route_table_delegat
e_t*delegate,structroute_table*table){returnXCALLOC(MTYPE_ROUTE_SRC_NODE,sizeof(
structroute_node));}staticvoidsrcdest_srcnode_destroy(route_table_delegate_t*del
egate,structroute_table*table,structroute_node*rn){structsrcdest_rnode*srn;XFREE
(MTYPE_ROUTE_SRC_NODE,rn);srn=table->info;if(srn->src_table&&route_table_count(s
rn->src_table)==0){/*deletingtheroute_tablefrominsidedestroy_nodeisONLY*permitte
dIFtable->countis0!seelib/table.c*route_node_delete()*fordetails*/route_table_fi
nish(srn->src_table);srn->src_table=NULL;/*droptherefwe'reholdinginsrcdest_node_
get().there*mightbe*non-srcdestroutes,sotheroute_nodemaystillexist.*hence,it's*i
mportanttoclearsrc_tableabove.*/route_unlock_node(srcdest_rnode_to_rnode(srn));}
}route_table_delegate_t_srcdest_srcnode_delegate={.create_node=srcdest_srcnode_c
reate,.destroy_node=srcdest_srcnode_destroy};/*NB:readcommentsincodeforrefcounti
ngbeforeusing!*/staticstructroute_node*srcdest_srcnode_get(structroute_node*rn,s
tructprefix_ipv6*src_p){structsrcdest_rnode*srn;if(!src_p||src_p->prefixlen==0)r
eturnrn;srn=srcdest_rnode_from_rnode(rn);if(!srn->src_table){/*thiswon'tusesrcde
st_rnode,we'realreadyonthesource*here*/srn->src_table=route_table_init_with_dele
gate(&_srcdest_srcnode_delegate);srn->src_table->info=srn;/*thereisnoroute_unloc
k_nodeontheoriginalrnhere.*Thereferenceiskeptforthesrc_table.*/}else{/*onlykeep1
referenceforthesrc_table,makesthe*refcounting*moresimilartothenon-srcdestcase.Ei
therwayafter*returnfrom*function,theonlyreferenceheldistheoneonthereturn*value.*
*Wecansafelydropourreferenceherebecausesrc_tableis*holding*anotherreference,soth
iswon'tfreern*/route_unlock_node(rn);}returnroute_node_get(srn->src_table,(struc
tprefix*)src_p);}staticstructroute_node*srcdest_srcnode_lookup(structroute_node*
rn,structprefix_ipv6*src_p){structsrcdest_rnode*srn;if(!rn||!src_p||src_p->prefi
xlen==0)returnrn;/*Wegotthisrnfromalookup,soitsrefcntwasincremented.Aswe*won't*r
eturnreturnrnfromanypointbeyondhere,weshoulddecrementits*refcnt.*/route_unlock_n
ode(rn);srn=srcdest_rnode_from_rnode(rn);if(!srn->src_table)returnNULL;returnrou
te_node_lookup(srn->src_table,(structprefix*)src_p);}/*-----exportedfunctions---
--*/structroute_table*srcdest_table_init(void){returnroute_table_init_with_deleg
ate(&_srcdest_dstnode_delegate);}structroute_node*srcdest_route_next(structroute
_node*rn){structroute_node*next,*parent;/*Foranonsrc-destnode,justreturnroute_ne
xt*/if(!(rnode_is_dstnode(rn)||rnode_is_srcnode(rn)))returnroute_next(rn);if(rno
de_is_dstnode(rn)){/*Thismeanstheroute_nodeispartofthetophierarchy*andreferstoad
estinationprefix.*/structsrcdest_rnode*srn=srcdest_rnode_from_rnode(rn);if(srn->
src_table)next=route_top(srn->src_table);elsenext=NULL;if(next){/*Thereisasource
prefix.Returnthenodeforit*/route_unlock_node(rn);returnnext;}else{/*Thereisnosou
rceprefix,justcontinueasusual*/returnroute_next(rn);}}/*Thisparthandlesthecaseof
iteratingsourcenodes.*/parent=route_lock_node(rn->table->info);next=route_next(r
n);if(next){/*Thereisanothersourcenode,continueinthesourcetable*/route_unlock_no
de(parent);returnnext;}else{/*Thesourcetableiscomplete,continueintheparenttable*
/returnroute_next(parent);}}structroute_node*srcdest_rnode_get(structroute_table
*table,unionprefixptrdst_pu,structprefix_ipv6*src_p){structprefix_ipv6*dst_p=dst
_pu.p6;structroute_node*rn;rn=route_node_get(table,(structprefix*)dst_p);returns
rcdest_srcnode_get(rn,src_p);}structroute_node*srcdest_rnode_lookup(structroute_
table*table,unionprefixptrdst_pu,structprefix_ipv6*src_p){structprefix_ipv6*dst_
p=dst_pu.p6;structroute_node*rn;structroute_node*srn;rn=route_node_lookup_maynul
l(table,(structprefix*)dst_p);srn=srcdest_srcnode_lookup(rn,src_p);if(rn!=NULL&&
rn==srn&&!rn->info){/*Matchthebehaviorofroute_node_lookupanddon'treturnan*emptyr
oute-nodeforadest-route*/route_unlock_node(rn);returnNULL;}returnsrn;}voidsrcdes
t_rnode_prefixes(structroute_node*rn,structprefix**p,structprefix**src_p){if(rno
de_is_srcnode(rn)){structroute_node*dst_rn=rn->table->info;if(p)*p=&dst_rn->p;if
(src_p)*src_p=&rn->p;}else{if(p)*p=&rn->p;if(src_p)*src_p=NULL;}}constchar*srcde
st_rnode2str(structroute_node*rn,char*str,intsize){structprefix*dst_p,*src_p;cha
rdst_buf[PREFIX_STRLEN],src_buf[PREFIX_STRLEN];srcdest_rnode_prefixes(rn,&dst_p,
&src_p);snprintf(str,size,"%s%s%s",prefix2str(dst_p,dst_buf,sizeof(dst_buf)),(sr
c_p&&src_p->prefixlen)?"from":"",(src_p&&src_p->prefixlen)?prefix2str(src_p,src_
buf,sizeof(src_buf)):"");returnstr;}