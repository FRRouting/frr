/*Prefixlistfunctions.*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebr
a.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itunderthetermsofthe
GNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;eitherversion2,or
(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"command.h"#include"
memory.h"#include"plist.h"#include"sockunion.h"#include"buffer.h"#include"log.h"
#include"routemap.h"#include"lib/json.h"#include"libfrr.h"#include"plist_int.h"D
EFINE_MTYPE_STATIC(LIB,PREFIX_LIST,"PrefixList")DEFINE_MTYPE_STATIC(LIB,MPREFIX_
LIST_STR,"PrefixListStr")DEFINE_MTYPE_STATIC(LIB,PREFIX_LIST_ENTRY,"PrefixListEn
try")DEFINE_MTYPE_STATIC(LIB,PREFIX_LIST_TRIE,"PrefixListTrieTable")/*notcurrent
lychangeable,codeassumesbytesfurtherdown*/#definePLC_BITS8#definePLC_LEN(1<<PLC_
BITS)#definePLC_MAXLEVELV42/*/24forIPv4*/#definePLC_MAXLEVELV64/*/48forIPv6*/#de
finePLC_MAXLEVEL4/*max(v4,v6)*/structpltrie_entry{union{structpltrie_table*next_
table;structprefix_list_entry*final_chain;};structprefix_list_entry*up_chain;};s
tructpltrie_table{structpltrie_entryentries[PLC_LEN];};/*Listofstructprefix_list
.*/structprefix_list_list{structprefix_list*head;structprefix_list*tail;};/*Mast
erstructureofprefix_list.*/structprefix_master{/*Listofprefix_listwhichnameisnum
ber.*/structprefix_list_listnum;/*Listofprefix_listwhichnameisstring.*/structpre
fix_list_liststr;/*Whethersequentialnumberisused.*/intseqnum;/*Thelatestupdate.*
/structprefix_list*recent;/*Hookfunctionwhichisexecutedwhennewprefix_listisadded
.*/void(*add_hook)(structprefix_list*);/*Hookfunctionwhichisexecutedwhenprefix_l
istisdeleted.*/void(*delete_hook)(structprefix_list*);/*numberofbytesthathaveatr
ielevel*/size_ttrie_depth;};/*StaticstructureofIPv4prefix_list'smaster.*/statics
tructprefix_masterprefix_master_ipv4={{NULL,NULL},{NULL,NULL},1,NULL,NULL,NULL,P
LC_MAXLEVELV4,};/*StaticstructureofIPv6prefix-list'smaster.*/staticstructprefix_
masterprefix_master_ipv6={{NULL,NULL},{NULL,NULL},1,NULL,NULL,NULL,PLC_MAXLEVELV
6,};/*StaticstructureofBGPORFprefix_list'smaster.*/staticstructprefix_masterpref
ix_master_orf_v4={{NULL,NULL},{NULL,NULL},1,NULL,NULL,NULL,PLC_MAXLEVELV4,};/*St
aticstructureofBGPORFprefix_list'smaster.*/staticstructprefix_masterprefix_maste
r_orf_v6={{NULL,NULL},{NULL,NULL},1,NULL,NULL,NULL,PLC_MAXLEVELV6,};staticstruct
prefix_master*prefix_master_get(afi_tafi,intorf){if(afi==AFI_IP)returnorf?&prefi
x_master_orf_v4:&prefix_master_ipv4;if(afi==AFI_IP6)returnorf?&prefix_master_orf
_v6:&prefix_master_ipv6;returnNULL;}constchar*prefix_list_name(structprefix_list
*plist){returnplist->name;}afi_tprefix_list_afi(structprefix_list*plist){if(plis
t->master==&prefix_master_ipv4||plist->master==&prefix_master_orf_v4)returnAFI_I
P;returnAFI_IP6;}/*Lookupprefix_listfromlistofprefix_listbyname.*/staticstructpr
efix_list*prefix_list_lookup_do(afi_tafi,intorf,constchar*name){structprefix_lis
t*plist;structprefix_master*master;if(name==NULL)returnNULL;master=prefix_master
_get(afi,orf);if(master==NULL)returnNULL;for(plist=master->num.head;plist;plist=
plist->next)if(strcmp(plist->name,name)==0)returnplist;for(plist=master->str.hea
d;plist;plist=plist->next)if(strcmp(plist->name,name)==0)returnplist;returnNULL;
}structprefix_list*prefix_list_lookup(afi_tafi,constchar*name){returnprefix_list
_lookup_do(afi,0,name);}structprefix_list*prefix_bgp_orf_lookup(afi_tafi,constch
ar*name){returnprefix_list_lookup_do(afi,1,name);}staticstructprefix_list*prefix
_list_new(void){structprefix_list*new;new=XCALLOC(MTYPE_PREFIX_LIST,sizeof(struc
tprefix_list));returnnew;}staticvoidprefix_list_free(structprefix_list*plist){XF
REE(MTYPE_PREFIX_LIST,plist);}staticstructprefix_list_entry*prefix_list_entry_ne
w(void){structprefix_list_entry*new;new=XCALLOC(MTYPE_PREFIX_LIST_ENTRY,sizeof(s
tructprefix_list_entry));returnnew;}staticvoidprefix_list_entry_free(structprefi
x_list_entry*pentry){XFREE(MTYPE_PREFIX_LIST_ENTRY,pentry);}/*Insertnewprefixlis
ttolistofprefix_list.Eachprefix_listissortedbythename.*/staticstructprefix_list*
prefix_list_insert(afi_tafi,intorf,constchar*name){unsignedinti;longnumber;struc
tprefix_list*plist;structprefix_list*point;structprefix_list_list*list;structpre
fix_master*master;master=prefix_master_get(afi,orf);if(master==NULL)returnNULL;/
*Allocatenewprefix_listandcopygivenname.*/plist=prefix_list_new();plist->name=XS
TRDUP(MTYPE_MPREFIX_LIST_STR,name);plist->master=master;plist->trie=XCALLOC(MTYP
E_PREFIX_LIST_TRIE,sizeof(structpltrie_table));/*Ifnameismadebyalldigitcharacter
.Wetreatitasnumber.*/for(number=0,i=0;i<strlen(name);i++){if(isdigit((int)name[i
]))number=(number*10)+(name[i]-'0');elsebreak;}/*Incaseofnameisalldigitcharacter
*/if(i==strlen(name)){plist->type=PREFIX_TYPE_NUMBER;/*Setprefix_listtonumberlis
t.*/list=&master->num;for(point=list->head;point;point=point->next)if(atol(point
->name)>=number)break;}else{plist->type=PREFIX_TYPE_STRING;/*Setprefix_listtostr
inglist.*/list=&master->str;/*Setpointtoinsertionpoint.*/for(point=list->head;po
int;point=point->next)if(strcmp(point->name,name)>=0)break;}/*Incaseofthisisthef
irstelementofmaster.*/if(list->head==NULL){list->head=list->tail=plist;returnpli
st;}/*Incaseofinsertionismadeatthetailofaccess_list.*/if(point==NULL){plist->pre
v=list->tail;list->tail->next=plist;list->tail=plist;returnplist;}/*Incaseofinse
rtionismadeattheheadofaccess_list.*/if(point==list->head){plist->next=list->head
;list->head->prev=plist;list->head=plist;returnplist;}/*Insertionismadeatmiddleo
ftheaccess_list.*/plist->next=point;plist->prev=point->prev;if(point->prev)point
->prev->next=plist;point->prev=plist;returnplist;}staticstructprefix_list*prefix
_list_get(afi_tafi,intorf,constchar*name){structprefix_list*plist;plist=prefix_l
ist_lookup_do(afi,orf,name);if(plist==NULL)plist=prefix_list_insert(afi,orf,name
);returnplist;}staticvoidprefix_list_trie_del(structprefix_list*plist,structpref
ix_list_entry*pentry);/*Deleteprefix-listfromprefix_list_masterandfreeit.*/stati
cvoidprefix_list_delete(structprefix_list*plist){structprefix_list_list*list;str
uctprefix_master*master;structprefix_list_entry*pentry;structprefix_list_entry*n
ext;/*Ifprefix-listcontainprefix_list_entryfreeallofit.*/for(pentry=plist->head;
pentry;pentry=next){next=pentry->next;prefix_list_trie_del(plist,pentry);prefix_
list_entry_free(pentry);plist->count--;}master=plist->master;if(plist->type==PRE
FIX_TYPE_NUMBER)list=&master->num;elselist=&master->str;if(plist->next)plist->ne
xt->prev=plist->prev;elselist->tail=plist->prev;if(plist->prev)plist->prev->next
=plist->next;elselist->head=plist->next;if(plist->desc)XFREE(MTYPE_TMP,plist->de
sc);/*Makesuremaster'srecentchangedprefix-listinformationiscleared.*/master->rec
ent=NULL;route_map_notify_dependencies(plist->name,RMAP_EVENT_PLIST_DELETED);if(
master->delete_hook)(*master->delete_hook)(plist);if(plist->name)XFREE(MTYPE_MPR
EFIX_LIST_STR,plist->name);XFREE(MTYPE_PREFIX_LIST_TRIE,plist->trie);prefix_list
_free(plist);}staticstructprefix_list_entry*prefix_list_entry_make(structprefix*
prefix,enumprefix_list_typetype,intseq,intle,intge,intany){structprefix_list_ent
ry*pentry;pentry=prefix_list_entry_new();if(any)pentry->any=1;prefix_copy(&pentr
y->prefix,prefix);pentry->type=type;pentry->seq=seq;pentry->le=le;pentry->ge=ge;
returnpentry;}/*Addhookfunction.*/voidprefix_list_add_hook(void(*func)(structpre
fix_list*plist)){prefix_master_ipv4.add_hook=func;prefix_master_ipv6.add_hook=fu
nc;}/*Deletehookfunction.*/voidprefix_list_delete_hook(void(*func)(structprefix_
list*plist)){prefix_master_ipv4.delete_hook=func;prefix_master_ipv6.delete_hook=
func;}/*Calculatenewsequentialnumber.*/staticintprefix_new_seq_get(structprefix_
list*plist){intmaxseq;intnewseq;structprefix_list_entry*pentry;maxseq=newseq=0;f
or(pentry=plist->head;pentry;pentry=pentry->next){if(maxseq<pentry->seq)maxseq=p
entry->seq;}newseq=((maxseq/5)*5)+5;returnnewseq;}/*Returnprefixlistentrywhichha
ssameseqnumber.*/staticstructprefix_list_entry*prefix_seq_check(structprefix_lis
t*plist,intseq){structprefix_list_entry*pentry;for(pentry=plist->head;pentry;pen
try=pentry->next)if(pentry->seq==seq)returnpentry;returnNULL;}staticstructprefix
_list_entry*prefix_list_entry_lookup(structprefix_list*plist,structprefix*prefix
,enumprefix_list_typetype,intseq,intle,intge){structprefix_list_entry*pentry;for
(pentry=plist->head;pentry;pentry=pentry->next)if(prefix_same(&pentry->prefix,pr
efix)&&pentry->type==type){if(seq>=0&&pentry->seq!=seq)continue;if(pentry->le!=l
e)continue;if(pentry->ge!=ge)continue;returnpentry;}returnNULL;}staticvoidtrie_w
alk_affected(size_tvalidbits,structpltrie_table*table,uint8_tbyte,structprefix_l
ist_entry*object,void(*fn)(structprefix_list_entry*object,structprefix_list_entr
y**updptr)){uint8_tmask;uint16_tbwalk;if(validbits>PLC_BITS){fn(object,&table->e
ntries[byte].final_chain);return;}mask=(1<<(8-validbits))-1;for(bwalk=byte&~mask
;bwalk<=byte+mask;bwalk++){fn(object,&table->entries[bwalk].up_chain);}}staticvo
idtrie_uninstall_fn(structprefix_list_entry*object,structprefix_list_entry**updp
tr){for(;*updptr;updptr=&(*updptr)->next_best)if(*updptr==object){*updptr=object
->next_best;break;}}staticinttrie_table_empty(structpltrie_table*table){size_ti;
for(i=0;i<PLC_LEN;i++)if(table->entries[i].next_table||table->entries[i].up_chai
n)return0;return1;}staticvoidprefix_list_trie_del(structprefix_list*plist,struct
prefix_list_entry*pentry){size_tdepth,maxdepth=plist->master->trie_depth;uint8_t
*bytes=&pentry->prefix.u.prefix;size_tvalidbits=pentry->prefix.prefixlen;structp
ltrie_table*table,**tables[PLC_MAXLEVEL];table=plist->trie;for(depth=0;validbits
>PLC_BITS&&depth<maxdepth-1;depth++){uint8_tbyte=bytes[depth];assert(table->entr
ies[byte].next_table);tables[depth+1]=&table->entries[byte].next_table;table=tab
le->entries[byte].next_table;validbits-=PLC_BITS;}trie_walk_affected(validbits,t
able,bytes[depth],pentry,trie_uninstall_fn);for(;depth>0;depth--)if(trie_table_e
mpty(*tables[depth])){XFREE(MTYPE_PREFIX_LIST_TRIE,*tables[depth]);*tables[depth
]=NULL;}}staticvoidprefix_list_entry_delete(structprefix_list*plist,structprefix
_list_entry*pentry,intupdate_list){if(plist==NULL||pentry==NULL)return;prefix_li
st_trie_del(plist,pentry);if(pentry->prev)pentry->prev->next=pentry->next;elsepl
ist->head=pentry->next;if(pentry->next)pentry->next->prev=pentry->prev;elseplist
->tail=pentry->prev;prefix_list_entry_free(pentry);plist->count--;if(update_list
){route_map_notify_dependencies(plist->name,RMAP_EVENT_PLIST_DELETED);if(plist->
master->delete_hook)(*plist->master->delete_hook)(plist);if(plist->head==NULL&&p
list->tail==NULL&&plist->desc==NULL)prefix_list_delete(plist);elseplist->master-
>recent=plist;}}staticvoidtrie_install_fn(structprefix_list_entry*object,structp
refix_list_entry**updptr){while(*updptr){if(*updptr==object)return;if((*updptr)-
>prefix.prefixlen<object->prefix.prefixlen)break;if((*updptr)->prefix.prefixlen=
=object->prefix.prefixlen&&(*updptr)->seq>object->seq)break;updptr=&(*updptr)->n
ext_best;}if(!object->next_best)object->next_best=*updptr;elseassert(object->nex
t_best==*updptr||!*updptr);*updptr=object;}staticvoidprefix_list_trie_add(struct
prefix_list*plist,structprefix_list_entry*pentry){size_tdepth=plist->master->tri
e_depth;uint8_t*bytes=&pentry->prefix.u.prefix;size_tvalidbits=pentry->prefix.pr
efixlen;structpltrie_table*table;table=plist->trie;while(validbits>PLC_BITS&&dep
th>1){if(!table->entries[*bytes].next_table)table->entries[*bytes].next_table=XC
ALLOC(MTYPE_PREFIX_LIST_TRIE,sizeof(structpltrie_table));table=table->entries[*b
ytes].next_table;bytes++;depth--;validbits-=PLC_BITS;}trie_walk_affected(validbi
ts,table,*bytes,pentry,trie_install_fn);}staticvoidprefix_list_entry_add(structp
refix_list*plist,structprefix_list_entry*pentry){structprefix_list_entry*replace
;structprefix_list_entry*point;/*Automaticasignmentofseqno.*/if(pentry->seq==-1)
pentry->seq=prefix_new_seq_get(plist);if(plist->tail&&pentry->seq>plist->tail->s
eq)point=NULL;else{/*Isthereanysameseqprefixlistentry?*/replace=prefix_seq_check
(plist,pentry->seq);if(replace)prefix_list_entry_delete(plist,replace,0);/*Check
insertpoint.*/for(point=plist->head;point;point=point->next)if(point->seq>=pentr
y->seq)break;}/*Incaseofthisisthefirstelementofthelist.*/pentry->next=point;if(p
oint){if(point->prev)point->prev->next=pentry;elseplist->head=pentry;pentry->pre
v=point->prev;point->prev=pentry;}else{if(plist->tail)plist->tail->next=pentry;e
lseplist->head=pentry;pentry->prev=plist->tail;plist->tail=pentry;}prefix_list_t
rie_add(plist,pentry);/*Incrementcount.*/plist->count++;/*Runhookfunction.*/if(p
list->master->add_hook)(*plist->master->add_hook)(plist);route_map_notify_depend
encies(plist->name,RMAP_EVENT_PLIST_ADDED);plist->master->recent=plist;}/*Return
stringofprefix_list_type.*/staticconstchar*prefix_list_type_str(structprefix_lis
t_entry*pentry){switch(pentry->type){casePREFIX_PERMIT:return"permit";casePREFIX
_DENY:return"deny";default:return"";}}staticintprefix_list_entry_match(structpre
fix_list_entry*pentry,structprefix*p){intret;if(pentry->prefix.family!=p->family
)return0;ret=prefix_match(&pentry->prefix,p);if(!ret)return0;/*Incaseoflenorgeis
specified,exactmatchisperformed.*/if(!pentry->le&&!pentry->ge){if(pentry->prefix
.prefixlen!=p->prefixlen)return0;}else{if(pentry->le)if(p->prefixlen>pentry->le)
return0;if(pentry->ge)if(p->prefixlen<pentry->ge)return0;}return1;}enumprefix_li
st_typeprefix_list_apply_which_prefix(structprefix_list*plist,structprefix**whic
h,void*object){structprefix_list_entry*pentry,*pbest=NULL;structprefix*p=(struct
prefix*)object;uint8_t*byte=&p->u.prefix;size_tdepth;size_tvalidbits=p->prefixle
n;structpltrie_table*table;if(plist==NULL){if(which)*which=NULL;returnPREFIX_DEN
Y;}if(plist->count==0){if(which)*which=NULL;returnPREFIX_PERMIT;}depth=plist->ma
ster->trie_depth;table=plist->trie;while(1){for(pentry=table->entries[*byte].up_
chain;pentry;pentry=pentry->next_best){if(pbest&&pbest->seq<pentry->seq)continue
;if(prefix_list_entry_match(pentry,p))pbest=pentry;}if(validbits<=PLC_BITS)break
;validbits-=PLC_BITS;if(--depth){if(!table->entries[*byte].next_table)break;tabl
e=table->entries[*byte].next_table;byte++;continue;}for(pentry=table->entries[*b
yte].final_chain;pentry;pentry=pentry->next_best){if(pbest&&pbest->seq<pentry->s
eq)continue;if(prefix_list_entry_match(pentry,p))pbest=pentry;}break;}if(which){
if(pbest)*which=&pbest->prefix;else*which=NULL;}if(pbest==NULL)returnPREFIX_DENY
;returnpbest->type;}staticvoid__attribute__((unused))prefix_list_print(structpre
fix_list*plist){structprefix_list_entry*pentry;if(plist==NULL)return;printf("ipp
refix-list%s:%dentries\n",plist->name,plist->count);for(pentry=plist->head;pentr
y;pentry=pentry->next){if(pentry->any)printf("any%s\n",prefix_list_type_str(pent
ry));else{structprefix*p;charbuf[BUFSIZ];p=&pentry->prefix;printf("seq%u%s%s/%d"
,pentry->seq,prefix_list_type_str(pentry),inet_ntop(p->family,&p->u.prefix,buf,B
UFSIZ),p->prefixlen);if(pentry->ge)printf("ge%d",pentry->ge);if(pentry->le)print
f("le%d",pentry->le);printf("\n");}}}/*Retrun1whenplistalreadyincludepentrypolic
y.*/staticstructprefix_list_entry*prefix_entry_dup_check(structprefix_list*plist
,structprefix_list_entry*new){size_tdepth,maxdepth=plist->master->trie_depth;uin
t8_tbyte,*bytes=&new->prefix.u.prefix;size_tvalidbits=new->prefix.prefixlen;stru
ctpltrie_table*table;structprefix_list_entry*pentry;intseq=0;if(new->seq==-1)seq
=prefix_new_seq_get(plist);elseseq=new->seq;table=plist->trie;for(depth=0;validb
its>PLC_BITS&&depth<maxdepth-1;depth++){byte=bytes[depth];if(!table->entries[byt
e].next_table)returnNULL;table=table->entries[byte].next_table;validbits-=PLC_BI
TS;}byte=bytes[depth];if(validbits>PLC_BITS)pentry=table->entries[byte].final_ch
ain;elsepentry=table->entries[byte].up_chain;for(;pentry;pentry=pentry->next_bes
t){if(prefix_same(&pentry->prefix,&new->prefix)&&pentry->type==new->type&&pentry
->le==new->le&&pentry->ge==new->ge&&pentry->seq!=seq)returnpentry;}returnNULL;}s
taticintvty_invalid_prefix_range(structvty*vty,constchar*prefix){vty_out(vty,"%%
Invalidprefixrangefor%s,makesure:len<ge-value<=le-value\n",prefix);returnCMD_WAR
NING_CONFIG_FAILED;}staticintvty_prefix_list_install(structvty*vty,afi_tafi,cons
tchar*name,constchar*seq,constchar*typestr,constchar*prefix,constchar*ge,constch
ar*le){intret;enumprefix_list_typetype;structprefix_list*plist;structprefix_list
_entry*pentry;structprefix_list_entry*dup;structprefixp,p_tmp;intany=0;intseqnum
=-1;intlenum=0;intgenum=0;/*Sequentialnumber.*/if(seq)seqnum=atoi(seq);/*geandle
number*/if(ge)genum=atoi(ge);if(le)lenum=atoi(le);/*Checkfiltertype.*/if(strncmp
("permit",typestr,1)==0)type=PREFIX_PERMIT;elseif(strncmp("deny",typestr,1)==0)t
ype=PREFIX_DENY;else{vty_out(vty,"%%prefixtypemustbepermitordeny\n");returnCMD_W
ARNING_CONFIG_FAILED;}/*"any"isspecialtokenformatchinganyIPv4addresses.*/switch(
afi){caseAFI_IP:if(strncmp("any",prefix,strlen(prefix))==0){ret=str2prefix_ipv4(
"0.0.0.0/0",(structprefix_ipv4*)&p);genum=0;lenum=IPV4_MAX_BITLEN;any=1;}elseret
=str2prefix_ipv4(prefix,(structprefix_ipv4*)&p);if(ret<=0){vty_out(vty,"%%Malfor
medIPv4prefix\n");returnCMD_WARNING_CONFIG_FAILED;}/*makeacopytoverifyprefixmatc
hesmasklength*/prefix_copy(&p_tmp,&p);apply_mask_ipv4((structprefix_ipv4*)&p_tmp
);break;caseAFI_IP6:if(strncmp("any",prefix,strlen(prefix))==0){ret=str2prefix_i
pv6("::/0",(structprefix_ipv6*)&p);genum=0;lenum=IPV6_MAX_BITLEN;any=1;}elseret=
str2prefix_ipv6(prefix,(structprefix_ipv6*)&p);if(ret<=0){vty_out(vty,"%%Malform
edIPv6prefix\n");returnCMD_WARNING_CONFIG_FAILED;}/*makeacopytoverifyprefixmatch
esmasklength*/prefix_copy(&p_tmp,&p);apply_mask_ipv6((structprefix_ipv6*)&p_tmp)
;break;caseAFI_L2VPN:default:vty_out(vty,"%%UnrecognizedAFI(%d)\n",afi);returnCM
D_WARNING_CONFIG_FAILED;break;}/*Ifprefixhasbitsnotunderthemask,adjustittofit*/i
f(!prefix_same(&p_tmp,&p)){charbuf[PREFIX2STR_BUFFER];charbuf_tmp[PREFIX2STR_BUF
FER];prefix2str(&p,buf,sizeof(buf));prefix2str(&p_tmp,buf_tmp,sizeof(buf_tmp));z
log_warn("Prefix-list%sprefixchangedfrom%sto%stomatchlength",name,buf,buf_tmp);p
=p_tmp;}/*geandlecheck.*/if(genum&&(genum<=p.prefixlen))returnvty_invalid_prefix
_range(vty,prefix);if(lenum&&(lenum<p.prefixlen))returnvty_invalid_prefix_range(
vty,prefix);if(lenum&&(genum>lenum))returnvty_invalid_prefix_range(vty,prefix);i
f(genum&&(lenum==(afi==AFI_IP?32:128)))lenum=0;/*Getprefix_listwithname.*/plist=
prefix_list_get(afi,0,name);/*Makeprefixentry.*/pentry=prefix_list_entry_make(&p
,type,seqnum,lenum,genum,any);/*Checksamepolicy.*/dup=prefix_entry_dup_check(pli
st,pentry);if(dup){prefix_list_entry_free(pentry);returnCMD_SUCCESS;}/*Installne
wfiltertotheaccess_list.*/prefix_list_entry_add(plist,pentry);returnCMD_SUCCESS;
}staticintvty_prefix_list_uninstall(structvty*vty,afi_tafi,constchar*name,constc
har*seq,constchar*typestr,constchar*prefix,constchar*ge,constchar*le){intret;enu
mprefix_list_typetype;structprefix_list*plist;structprefix_list_entry*pentry;str
uctprefixp;intseqnum=-1;intlenum=0;intgenum=0;/*Checkprefixlistname.*/plist=pref
ix_list_lookup(afi,name);if(!plist){vty_out(vty,"%%Can'tfindspecifiedprefix-list
\n");returnCMD_WARNING_CONFIG_FAILED;}/*Onlyprefix-listnamespecified,deletetheen
tireprefix-list.*/if(seq==NULL&&typestr==NULL&&prefix==NULL&&ge==NULL&&le==NULL)
{prefix_list_delete(plist);returnCMD_SUCCESS;}/*Wemusthave,ataminimum,boththetyp
eandprefixhere*/if((typestr==NULL)||(prefix==NULL)){vty_out(vty,"%%Bothprefixand
typerequired\n");returnCMD_WARNING_CONFIG_FAILED;}/*Checksequencenumber.*/if(seq
)seqnum=atoi(seq);/*geandlenumber*/if(ge)genum=atoi(ge);if(le)lenum=atoi(le);/*C
heckoffiltertype.*/if(strncmp("permit",typestr,1)==0)type=PREFIX_PERMIT;elseif(s
trncmp("deny",typestr,1)==0)type=PREFIX_DENY;else{vty_out(vty,"%%prefixtypemustb
epermitordeny\n");returnCMD_WARNING_CONFIG_FAILED;}/*"any"isspecialtokenformatch
inganyIPv4addresses.*/if(afi==AFI_IP){if(strncmp("any",prefix,strlen(prefix))==0
){ret=str2prefix_ipv4("0.0.0.0/0",(structprefix_ipv4*)&p);genum=0;lenum=IPV4_MAX
_BITLEN;}elseret=str2prefix_ipv4(prefix,(structprefix_ipv4*)&p);if(ret<=0){vty_o
ut(vty,"%%MalformedIPv4prefix\n");returnCMD_WARNING_CONFIG_FAILED;}}elseif(afi==
AFI_IP6){if(strncmp("any",prefix,strlen(prefix))==0){ret=str2prefix_ipv6("::/0",
(structprefix_ipv6*)&p);genum=0;lenum=IPV6_MAX_BITLEN;}elseret=str2prefix_ipv6(p
refix,(structprefix_ipv6*)&p);if(ret<=0){vty_out(vty,"%%MalformedIPv6prefix\n");
returnCMD_WARNING_CONFIG_FAILED;}}/*Lookupprefixentry.*/pentry=prefix_list_entry
_lookup(plist,&p,type,seqnum,lenum,genum);if(pentry==NULL){vty_out(vty,"%%Can'tf
indspecifiedprefix-list\n");returnCMD_WARNING_CONFIG_FAILED;}/*Installnewfiltert
otheaccess_list.*/prefix_list_entry_delete(plist,pentry,1);returnCMD_SUCCESS;}st
aticintvty_prefix_list_desc_unset(structvty*vty,afi_tafi,constchar*name){structp
refix_list*plist;plist=prefix_list_lookup(afi,name);if(!plist){vty_out(vty,"%%Ca
n'tfindspecifiedprefix-list\n");returnCMD_WARNING_CONFIG_FAILED;}if(plist->desc)
{XFREE(MTYPE_TMP,plist->desc);plist->desc=NULL;}if(plist->head==NULL&&plist->tai
l==NULL&&plist->desc==NULL)prefix_list_delete(plist);returnCMD_SUCCESS;}enumdisp
lay_type{normal_display,summary_display,detail_display,sequential_display,longer
_display,first_match_display};staticvoidvty_show_prefix_entry(structvty*vty,afi_
tafi,structprefix_list*plist,structprefix_master*master,enumdisplay_typedtype,in
tseqnum){structprefix_list_entry*pentry;/*Printthenameoftheprotocol*/vty_out(vty
,"%s:",frr_protoname);if(dtype==normal_display){vty_out(vty,"ip%sprefix-list%s:%
dentries\n",afi==AFI_IP?"":"v6",plist->name,plist->count);if(plist->desc)vty_out
(vty,"Description:%s\n",plist->desc);}elseif(dtype==summary_display||dtype==deta
il_display){vty_out(vty,"ip%sprefix-list%s:\n",afi==AFI_IP?"":"v6",plist->name);
if(plist->desc)vty_out(vty,"Description:%s\n",plist->desc);vty_out(vty,"count:%d
,rangeentries:%d,sequences:%u-%u\n",plist->count,plist->rangecount,plist->head?p
list->head->seq:0,plist->tail?plist->tail->seq:0);}if(dtype!=summary_display){fo
r(pentry=plist->head;pentry;pentry=pentry->next){if(dtype==sequential_display&&p
entry->seq!=seqnum)continue;vty_out(vty,"");if(master->seqnum)vty_out(vty,"seq%u
",pentry->seq);vty_out(vty,"%s",prefix_list_type_str(pentry));if(pentry->any)vty
_out(vty,"any");else{structprefix*p=&pentry->prefix;charbuf[BUFSIZ];vty_out(vty,
"%s/%d",inet_ntop(p->family,&p->u.prefix,buf,BUFSIZ),p->prefixlen);if(pentry->ge
)vty_out(vty,"ge%d",pentry->ge);if(pentry->le)vty_out(vty,"le%d",pentry->le);}if
(dtype==detail_display||dtype==sequential_display)vty_out(vty,"(hitcount:%ld,ref
count:%ld)",pentry->hitcnt,pentry->refcnt);vty_out(vty,"\n");}}}staticintvty_sho
w_prefix_list(structvty*vty,afi_tafi,constchar*name,constchar*seq,enumdisplay_ty
pedtype){structprefix_list*plist;structprefix_master*master;intseqnum=0;master=p
refix_master_get(afi,0);if(master==NULL)returnCMD_WARNING;if(seq)seqnum=atoi(seq
);if(name){plist=prefix_list_lookup(afi,name);if(!plist){vty_out(vty,"%%Can'tfin
dspecifiedprefix-list\n");returnCMD_WARNING;}vty_show_prefix_entry(vty,afi,plist
,master,dtype,seqnum);}else{if(dtype==detail_display||dtype==summary_display){if
(master->recent)vty_out(vty,"Prefix-listwiththelastdeletion/insertion:%s\n",mast
er->recent->name);}for(plist=master->num.head;plist;plist=plist->next)vty_show_p
refix_entry(vty,afi,plist,master,dtype,seqnum);for(plist=master->str.head;plist;
plist=plist->next)vty_show_prefix_entry(vty,afi,plist,master,dtype,seqnum);}retu
rnCMD_SUCCESS;}staticintvty_show_prefix_list_prefix(structvty*vty,afi_tafi,const
char*name,constchar*prefix,enumdisplay_typetype){structprefix_list*plist;structp
refix_list_entry*pentry;structprefixp;intret;intmatch;plist=prefix_list_lookup(a
fi,name);if(!plist){vty_out(vty,"%%Can'tfindspecifiedprefix-list\n");returnCMD_W
ARNING;}ret=str2prefix(prefix,&p);if(ret<=0){vty_out(vty,"%%prefixismalformed\n"
);returnCMD_WARNING;}for(pentry=plist->head;pentry;pentry=pentry->next){match=0;
if(type==normal_display||type==first_match_display)if(prefix_same(&p,&pentry->pr
efix))match=1;if(type==longer_display){if((p.family==pentry->prefix.family)&&(pr
efix_match(&p,&pentry->prefix)))match=1;}if(match){vty_out(vty,"seq%u%s",pentry-
>seq,prefix_list_type_str(pentry));if(pentry->any)vty_out(vty,"any");else{struct
prefix*p=&pentry->prefix;charbuf[BUFSIZ];vty_out(vty,"%s/%d",inet_ntop(p->family
,&p->u.prefix,buf,BUFSIZ),p->prefixlen);if(pentry->ge)vty_out(vty,"ge%d",pentry-
>ge);if(pentry->le)vty_out(vty,"le%d",pentry->le);}if(type==normal_display||type
==first_match_display)vty_out(vty,"(hitcount:%ld,refcount:%ld)",pentry->hitcnt,p
entry->refcnt);vty_out(vty,"\n");if(type==first_match_display)returnCMD_SUCCESS;
}}returnCMD_SUCCESS;}staticintvty_clear_prefix_list(structvty*vty,afi_tafi,const
char*name,constchar*prefix){structprefix_master*master;structprefix_list*plist;s
tructprefix_list_entry*pentry;intret;structprefixp;master=prefix_master_get(afi,
0);if(master==NULL)returnCMD_WARNING;if(name==NULL&&prefix==NULL){for(plist=mast
er->num.head;plist;plist=plist->next)for(pentry=plist->head;pentry;pentry=pentry
->next)pentry->hitcnt=0;for(plist=master->str.head;plist;plist=plist->next)for(p
entry=plist->head;pentry;pentry=pentry->next)pentry->hitcnt=0;}else{plist=prefix
_list_lookup(afi,name);if(!plist){vty_out(vty,"%%Can'tfindspecifiedprefix-list\n
");returnCMD_WARNING;}if(prefix){ret=str2prefix(prefix,&p);if(ret<=0){vty_out(vt
y,"%%prefixismalformed\n");returnCMD_WARNING;}}for(pentry=plist->head;pentry;pen
try=pentry->next){if(prefix){if(pentry->prefix.family==p.family&&prefix_match(&p
entry->prefix,&p))pentry->hitcnt=0;}elsepentry->hitcnt=0;}}returnCMD_SUCCESS;}#i
fndefVTYSH_EXTRACT_PL#include"lib/plist_clippy.c"#endifDEFPY(ip_prefix_list,ip_p
refix_list_cmd,"ipprefix-listWORD[seq(1-4294967295)]<deny|permit>$action<any$des
t|A.B.C.D/M$dest[{ge(0-32)|le(0-32)}]>",IP_STRPREFIX_LIST_STR"Nameofaprefixlist\
n""sequencenumberofanentry\n""Sequencenumber\n""Specifypacketstoreject\n""Specif
ypacketstoforward\n""Anyprefixmatch.Sameas\"0.0.0.0/0le32\"\n""IPprefix<network>
/<length>,e.g.,35.0.0.0/8\n""Minimumprefixlengthtobematched\n""Minimumprefixleng
th\n""Maximumprefixlengthtobematched\n""Maximumprefixlength\n"){returnvty_prefix
_list_install(vty,AFI_IP,prefix_list,seq_str,action,dest,ge_str,le_str);}DEFPY(n
o_ip_prefix_list,no_ip_prefix_list_cmd,"noipprefix-listWORD[seq(1-4294967295)]<d
eny|permit>$action<any$dest|A.B.C.D/M$dest[{ge(0-32)|le(0-32)}]>",NO_STRIP_STRPR
EFIX_LIST_STR"Nameofaprefixlist\n""sequencenumberofanentry\n""Sequencenumber\n""
Specifypacketstoreject\n""Specifypacketstoforward\n""Anyprefixmatch.Sameas\"0.0.
0.0/0le32\"\n""IPprefix<network>/<length>,e.g.,35.0.0.0/8\n""Minimumprefixlength
tobematched\n""Minimumprefixlength\n""Maximumprefixlengthtobematched\n""Maximump
refixlength\n"){returnvty_prefix_list_uninstall(vty,AFI_IP,prefix_list,seq_str,a
ction,dest,ge_str,le_str);}DEFPY(no_ip_prefix_list_all,no_ip_prefix_list_all_cmd
,"noipprefix-listWORD",NO_STRIP_STRPREFIX_LIST_STR"Nameofaprefixlist\n"){returnv
ty_prefix_list_uninstall(vty,AFI_IP,prefix_list,NULL,NULL,NULL,NULL,NULL);}DEFPY
(ip_prefix_list_sequence_number,ip_prefix_list_sequence_number_cmd,"[no]ipprefix
-listsequence-number",NO_STRIP_STRPREFIX_LIST_STR"Include/excludesequencenumbers
inNVGEN\n"){prefix_master_ipv4.seqnum=no?0:1;returnCMD_SUCCESS;}DEFUN(ip_prefix_
list_description,ip_prefix_list_description_cmd,"ipprefix-listWORDdescriptionLIN
E...",IP_STRPREFIX_LIST_STR"Nameofaprefixlist\n""Prefix-listspecificdescription\
n""Upto80charactersdescribingthisprefix-list\n"){intidx_word=2;intidx_line=4;str
uctprefix_list*plist;plist=prefix_list_get(AFI_IP,0,argv[idx_word]->arg);if(plis
t->desc){XFREE(MTYPE_TMP,plist->desc);plist->desc=NULL;}plist->desc=argv_concat(
argv,argc,idx_line);returnCMD_SUCCESS;}DEFUN(no_ip_prefix_list_description,no_ip
_prefix_list_description_cmd,"noipprefix-listWORDdescription",NO_STRIP_STRPREFIX
_LIST_STR"Nameofaprefixlist\n""Prefix-listspecificdescription\n"){intidx_word=3;
returnvty_prefix_list_desc_unset(vty,AFI_IP,argv[idx_word]->arg);}/*ALIAS_FIXME*
/DEFUN(no_ip_prefix_list_description_comment,no_ip_prefix_list_description_comme
nt_cmd,"noipprefix-listWORDdescriptionLINE...",NO_STRIP_STRPREFIX_LIST_STR"Nameo
faprefixlist\n""Prefix-listspecificdescription\n""Upto80charactersdescribingthis
prefix-list\n"){returnno_ip_prefix_list_description(self,vty,argc,argv);}DEFPY(s
how_ip_prefix_list,show_ip_prefix_list_cmd,"showipprefix-list[WORD[seq$dseq(1-42
94967295)$arg]]",SHOW_STRIP_STRPREFIX_LIST_STR"Nameofaprefixlist\n""sequencenumb
erofanentry\n""Sequencenumber\n"){enumdisplay_typedtype=normal_display;if(dseq)d
type=sequential_display;returnvty_show_prefix_list(vty,AFI_IP,prefix_list,arg_st
r,dtype);}DEFPY(show_ip_prefix_list_prefix,show_ip_prefix_list_prefix_cmd,"showi
pprefix-listWORDA.B.C.D/M$prefix[longer$dl|first-match$dfm]",SHOW_STRIP_STRPREFI
X_LIST_STR"Nameofaprefixlist\n""IPprefix<network>/<length>,e.g.,35.0.0.0/8\n""Lo
okuplongerprefix\n""Firstmatchedprefix\n"){enumdisplay_typedtype=normal_display;
if(dl)dtype=longer_display;elseif(dfm)dtype=first_match_display;returnvty_show_p
refix_list_prefix(vty,AFI_IP,prefix_list,prefix_str,dtype);}DEFPY(show_ip_prefix
_list_summary,show_ip_prefix_list_summary_cmd,"showipprefix-listsummary[WORD$pre
fix_list]",SHOW_STRIP_STRPREFIX_LIST_STR"Summaryofprefixlists\n""Nameofaprefixli
st\n"){returnvty_show_prefix_list(vty,AFI_IP,prefix_list,NULL,summary_display);}
DEFPY(show_ip_prefix_list_detail,show_ip_prefix_list_detail_cmd,"showipprefix-li
stdetail[WORD$prefix_list]",SHOW_STRIP_STRPREFIX_LIST_STR"Detailofprefixlists\n"
"Nameofaprefixlist\n"){returnvty_show_prefix_list(vty,AFI_IP,prefix_list,NULL,de
tail_display);}DEFPY(clear_ip_prefix_list,clear_ip_prefix_list_cmd,"clearipprefi
x-list[WORD[A.B.C.D/M$prefix]]",CLEAR_STRIP_STRPREFIX_LIST_STR"Nameofaprefixlist
\n""IPprefix<network>/<length>,e.g.,35.0.0.0/8\n"){returnvty_clear_prefix_list(v
ty,AFI_IP,prefix_list,prefix_str);}DEFPY(ipv6_prefix_list,ipv6_prefix_list_cmd,"
ipv6prefix-listWORD[seq(1-4294967295)]<deny|permit>$action<any$dest|X:X::X:X/M$d
est[{ge(0-128)|le(0-128)}]>",IPV6_STRPREFIX_LIST_STR"Nameofaprefixlist\n""sequen
cenumberofanentry\n""Sequencenumber\n""Specifypacketstoreject\n""Specifypacketst
oforward\n""Anyprefixmatch.Sameas\"::0/0le128\"\n""IPv6prefix<network>/<length>,
e.g.,3ffe::/16\n""Maximumprefixlengthtobematched\n""Maximumprefixlength\n""Minim
umprefixlengthtobematched\n""Minimumprefixlength\n"){returnvty_prefix_list_insta
ll(vty,AFI_IP6,prefix_list,seq_str,action,dest,ge_str,le_str);}DEFPY(no_ipv6_pre
fix_list,no_ipv6_prefix_list_cmd,"noipv6prefix-listWORD[seq(1-4294967295)]<deny|
permit>$action<any$dest|X:X::X:X/M$dest[{ge(0-128)|le(0-128)}]>",NO_STRIPV6_STRP
REFIX_LIST_STR"Nameofaprefixlist\n""sequencenumberofanentry\n""Sequencenumber\n"
"Specifypacketstoreject\n""Specifypacketstoforward\n""Anyprefixmatch.Sameas\"::0
/0le128\"\n""IPv6prefix<network>/<length>,e.g.,3ffe::/16\n""Maximumprefixlengtht
obematched\n""Maximumprefixlength\n""Minimumprefixlengthtobematched\n""Minimumpr
efixlength\n"){returnvty_prefix_list_uninstall(vty,AFI_IP6,prefix_list,seq_str,a
ction,dest,ge_str,le_str);}DEFPY(no_ipv6_prefix_list_all,no_ipv6_prefix_list_all
_cmd,"noipv6prefix-listWORD",NO_STRIPV6_STRPREFIX_LIST_STR"Nameofaprefixlist\n")
{returnvty_prefix_list_uninstall(vty,AFI_IP6,prefix_list,NULL,NULL,NULL,NULL,NUL
L);}DEFPY(ipv6_prefix_list_sequence_number,ipv6_prefix_list_sequence_number_cmd,
"[no]ipv6prefix-listsequence-number",NO_STRIPV6_STRPREFIX_LIST_STR"Include/exclu
desequencenumbersinNVGEN\n"){prefix_master_ipv6.seqnum=no?0:1;returnCMD_SUCCESS;
}DEFUN(ipv6_prefix_list_description,ipv6_prefix_list_description_cmd,"ipv6prefix
-listWORDdescriptionLINE...",IPV6_STRPREFIX_LIST_STR"Nameofaprefixlist\n""Prefix
-listspecificdescription\n""Upto80charactersdescribingthisprefix-list\n"){intidx
_word=2;intiddx_line=4;structprefix_list*plist;plist=prefix_list_get(AFI_IP6,0,a
rgv[idx_word]->arg);if(plist->desc){XFREE(MTYPE_TMP,plist->desc);plist->desc=NUL
L;}plist->desc=argv_concat(argv,argc,iddx_line);returnCMD_SUCCESS;}DEFUN(no_ipv6
_prefix_list_description,no_ipv6_prefix_list_description_cmd,"noipv6prefix-listW
ORDdescription",NO_STRIPV6_STRPREFIX_LIST_STR"Nameofaprefixlist\n""Prefix-listsp
ecificdescription\n"){intidx_word=3;returnvty_prefix_list_desc_unset(vty,AFI_IP6
,argv[idx_word]->arg);}/*ALIAS_FIXME*/DEFUN(no_ipv6_prefix_list_description_comm
ent,no_ipv6_prefix_list_description_comment_cmd,"noipv6prefix-listWORDdescriptio
nLINE...",NO_STRIPV6_STRPREFIX_LIST_STR"Nameofaprefixlist\n""Prefix-listspecific
description\n""Upto80charactersdescribingthisprefix-list\n"){returnno_ipv6_prefi
x_list_description(self,vty,argc,argv);}DEFPY(show_ipv6_prefix_list,show_ipv6_pr
efix_list_cmd,"showipv6prefix-list[WORD[seq$dseq(1-4294967295)$arg]]",SHOW_STRIP
V6_STRPREFIX_LIST_STR"Nameofaprefixlist\n""sequencenumberofanentry\n""Sequencenu
mber\n"){enumdisplay_typedtype=normal_display;if(dseq)dtype=sequential_display;r
eturnvty_show_prefix_list(vty,AFI_IP6,prefix_list,arg_str,dtype);}DEFPY(show_ipv
6_prefix_list_prefix,show_ipv6_prefix_list_prefix_cmd,"showipv6prefix-listWORDX:
X::X:X/M$prefix[longer$dl|first-match$dfm]",SHOW_STRIPV6_STRPREFIX_LIST_STR"Name
ofaprefixlist\n""IPv6prefix<network>/<length>,e.g.,3ffe::/16\n""Lookuplongerpref
ix\n""Firstmatchedprefix\n"){enumdisplay_typedtype=normal_display;if(dl)dtype=lo
nger_display;elseif(dfm)dtype=first_match_display;returnvty_show_prefix_list_pre
fix(vty,AFI_IP6,prefix_list,prefix_str,dtype);}DEFPY(show_ipv6_prefix_list_summa
ry,show_ipv6_prefix_list_summary_cmd,"showipv6prefix-listsummary[WORD$prefix-lis
t]",SHOW_STRIPV6_STRPREFIX_LIST_STR"Summaryofprefixlists\n""Nameofaprefixlist\n"
){returnvty_show_prefix_list(vty,AFI_IP6,prefix_list,NULL,summary_display);}DEFP
Y(show_ipv6_prefix_list_detail,show_ipv6_prefix_list_detail_cmd,"showipv6prefix-
listdetail[WORD$prefix-list]",SHOW_STRIPV6_STRPREFIX_LIST_STR"Detailofprefixlist
s\n""Nameofaprefixlist\n"){returnvty_show_prefix_list(vty,AFI_IP6,prefix_list,NU
LL,detail_display);}DEFPY(clear_ipv6_prefix_list,clear_ipv6_prefix_list_cmd,"cle
aripv6prefix-list[WORD[X:X::X:X/M$prefix]]",CLEAR_STRIPV6_STRPREFIX_LIST_STR"Nam
eofaprefixlist\n""IPv6prefix<network>/<length>,e.g.,3ffe::/16\n"){returnvty_clea
r_prefix_list(vty,AFI_IP6,prefix_list,prefix_str);}/*Configurationwritefunction.
*/staticintconfig_write_prefix_afi(afi_tafi,structvty*vty){structprefix_list*pli
st;structprefix_list_entry*pentry;structprefix_master*master;intwrite=0;master=p
refix_master_get(afi,0);if(master==NULL)return0;if(!master->seqnum){vty_out(vty,
"noip%sprefix-listsequence-number\n",afi==AFI_IP?"":"v6");vty_out(vty,"!\n");}fo
r(plist=master->num.head;plist;plist=plist->next){if(plist->desc){vty_out(vty,"i
p%sprefix-list%sdescription%s\n",afi==AFI_IP?"":"v6",plist->name,plist->desc);wr
ite++;}for(pentry=plist->head;pentry;pentry=pentry->next){vty_out(vty,"ip%sprefi
x-list%s",afi==AFI_IP?"":"v6",plist->name);if(master->seqnum)vty_out(vty,"seq%u"
,pentry->seq);vty_out(vty,"%s",prefix_list_type_str(pentry));if(pentry->any)vty_
out(vty,"any");else{structprefix*p=&pentry->prefix;charbuf[BUFSIZ];vty_out(vty,"
%s/%d",inet_ntop(p->family,&p->u.prefix,buf,BUFSIZ),p->prefixlen);if(pentry->ge)
vty_out(vty,"ge%d",pentry->ge);if(pentry->le)vty_out(vty,"le%d",pentry->le);}vty
_out(vty,"\n");write++;}/*vty_out(vty,"!\n");*/}for(plist=master->str.head;plist
;plist=plist->next){if(plist->desc){vty_out(vty,"ip%sprefix-list%sdescription%s\
n",afi==AFI_IP?"":"v6",plist->name,plist->desc);write++;}for(pentry=plist->head;
pentry;pentry=pentry->next){vty_out(vty,"ip%sprefix-list%s",afi==AFI_IP?"":"v6",
plist->name);if(master->seqnum)vty_out(vty,"seq%u",pentry->seq);vty_out(vty,"%s"
,prefix_list_type_str(pentry));if(pentry->any)vty_out(vty,"any");else{structpref
ix*p=&pentry->prefix;charbuf[BUFSIZ];vty_out(vty,"%s/%d",inet_ntop(p->family,&p-
>u.prefix,buf,BUFSIZ),p->prefixlen);if(pentry->ge)vty_out(vty,"ge%d",pentry->ge)
;if(pentry->le)vty_out(vty,"le%d",pentry->le);}vty_out(vty,"\n");write++;}}retur
nwrite;}structstream*prefix_bgp_orf_entry(structstream*s,structprefix_list*plist
,uint8_tinit_flag,uint8_tpermit_flag,uint8_tdeny_flag){structprefix_list_entry*p
entry;if(!plist)returns;for(pentry=plist->head;pentry;pentry=pentry->next){uint8
_tflag=init_flag;structprefix*p=&pentry->prefix;flag|=(pentry->type==PREFIX_PERM
IT?permit_flag:deny_flag);stream_putc(s,flag);stream_putl(s,(uint32_t)pentry->se
q);stream_putc(s,(uint8_t)pentry->ge);stream_putc(s,(uint8_t)pentry->le);stream_
put_prefix(s,p);}returns;}intprefix_bgp_orf_set(char*name,afi_tafi,structorf_pre
fix*orfp,intpermit,intset){structprefix_list*plist;structprefix_list_entry*pentr
y;/*geandlevaluecheck*/if(orfp->ge&&orfp->ge<=orfp->p.prefixlen)returnCMD_WARNIN
G_CONFIG_FAILED;if(orfp->le&&orfp->le<=orfp->p.prefixlen)returnCMD_WARNING_CONFI
G_FAILED;if(orfp->le&&orfp->ge>orfp->le)returnCMD_WARNING_CONFIG_FAILED;if(orfp-
>ge&&orfp->le==(afi==AFI_IP?32:128))orfp->le=0;plist=prefix_list_get(afi,1,name)
;if(!plist)returnCMD_WARNING_CONFIG_FAILED;if(set){pentry=prefix_list_entry_make
(&orfp->p,(permit?PREFIX_PERMIT:PREFIX_DENY),orfp->seq,orfp->le,orfp->ge,0);if(p
refix_entry_dup_check(plist,pentry)){prefix_list_entry_free(pentry);returnCMD_WA
RNING_CONFIG_FAILED;}prefix_list_entry_add(plist,pentry);}else{pentry=prefix_lis
t_entry_lookup(plist,&orfp->p,(permit?PREFIX_PERMIT:PREFIX_DENY),orfp->seq,orfp-
>le,orfp->ge);if(!pentry)returnCMD_WARNING_CONFIG_FAILED;prefix_list_entry_delet
e(plist,pentry,1);}returnCMD_SUCCESS;}voidprefix_bgp_orf_remove_all(afi_tafi,cha
r*name){structprefix_list*plist;plist=prefix_bgp_orf_lookup(afi,name);if(plist)p
refix_list_delete(plist);}/*returnprefixcount*/intprefix_bgp_show_prefix_list(st
ructvty*vty,afi_tafi,char*name,uint8_tuse_json){structprefix_list*plist;structpr
efix_list_entry*pentry;json_object*json=NULL;json_object*json_prefix=NULL;json_o
bject*json_list=NULL;plist=prefix_bgp_orf_lookup(afi,name);if(!plist)return0;if(
!vty)returnplist->count;if(use_json){json=json_object_new_object();json_prefix=j
son_object_new_object();json_list=json_object_new_object();json_object_int_add(j
son_prefix,"prefixListCounter",plist->count);json_object_string_add(json_prefix,
"prefixListName",plist->name);for(pentry=plist->head;pentry;pentry=pentry->next)
{structprefix*p=&pentry->prefix;charbuf_a[BUFSIZ];charbuf_b[BUFSIZ];sprintf(buf_
a,"%s/%d",inet_ntop(p->family,&p->u.prefix,buf_b,BUFSIZ),p->prefixlen);json_obje
ct_int_add(json_list,"seq",pentry->seq);json_object_string_add(json_list,"seqPre
fixListType",prefix_list_type_str(pentry));if(pentry->ge)json_object_int_add(jso
n_list,"ge",pentry->ge);if(pentry->le)json_object_int_add(json_list,"le",pentry-
>le);json_object_object_add(json_prefix,buf_a,json_list);}if(afi==AFI_IP)json_ob
ject_object_add(json,"ipPrefixList",json_prefix);elsejson_object_object_add(json
,"ipv6PrefixList",json_prefix);vty_out(vty,"%s\n",json_object_to_json_string_ext
(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}else{vty_out(vty,"ip%spr
efix-list%s:%dentries\n",afi==AFI_IP?"":"v6",plist->name,plist->count);for(pentr
y=plist->head;pentry;pentry=pentry->next){structprefix*p=&pentry->prefix;charbuf
[BUFSIZ];vty_out(vty,"seq%u%s%s/%d",pentry->seq,prefix_list_type_str(pentry),ine
t_ntop(p->family,&p->u.prefix,buf,BUFSIZ),p->prefixlen);if(pentry->ge)vty_out(vt
y,"ge%d",pentry->ge);if(pentry->le)vty_out(vty,"le%d",pentry->le);vty_out(vty,"\
n");}}returnplist->count;}staticvoidprefix_list_reset_afi(afi_tafi,intorf){struc
tprefix_list*plist;structprefix_list*next;structprefix_master*master;master=pref
ix_master_get(afi,orf);if(master==NULL)return;for(plist=master->num.head;plist;p
list=next){next=plist->next;prefix_list_delete(plist);}for(plist=master->str.hea
d;plist;plist=next){next=plist->next;prefix_list_delete(plist);}assert(master->n
um.head==NULL);assert(master->num.tail==NULL);assert(master->str.head==NULL);ass
ert(master->str.tail==NULL);master->seqnum=1;master->recent=NULL;}/*Prefix-listn
ode.*/staticstructcmd_nodeprefix_node={PREFIX_NODE,"",/*Prefixlisthasnointerface
.*/1};staticintconfig_write_prefix_ipv4(structvty*vty){returnconfig_write_prefix
_afi(AFI_IP,vty);}staticvoidplist_autocomplete_afi(afi_tafi,vectorcomps,structcm
d_token*token){structprefix_list*plist;structprefix_master*master;master=prefix_
master_get(afi,0);if(master==NULL)return;for(plist=master->str.head;plist;plist=
plist->next)vector_set(comps,XSTRDUP(MTYPE_COMPLETION,plist->name));for(plist=ma
ster->num.head;plist;plist=plist->next)vector_set(comps,XSTRDUP(MTYPE_COMPLETION
,plist->name));}staticvoidplist_autocomplete(vectorcomps,structcmd_token*token){
plist_autocomplete_afi(AFI_IP,comps,token);plist_autocomplete_afi(AFI_IP6,comps,
token);}staticconststructcmd_variable_handlerplist_var_handlers[]={{/*"prefix-li
stWORD"*/.varname="prefix_list",.completions=plist_autocomplete},{.completions=N
ULL}};staticvoidprefix_list_init_ipv4(void){install_node(&prefix_node,config_wri
te_prefix_ipv4);install_element(CONFIG_NODE,&ip_prefix_list_cmd);install_element
(CONFIG_NODE,&no_ip_prefix_list_cmd);install_element(CONFIG_NODE,&no_ip_prefix_l
ist_all_cmd);install_element(CONFIG_NODE,&ip_prefix_list_description_cmd);instal
l_element(CONFIG_NODE,&no_ip_prefix_list_description_cmd);install_element(CONFIG
_NODE,&no_ip_prefix_list_description_comment_cmd);install_element(CONFIG_NODE,&i
p_prefix_list_sequence_number_cmd);install_element(VIEW_NODE,&show_ip_prefix_lis
t_cmd);install_element(VIEW_NODE,&show_ip_prefix_list_prefix_cmd);install_elemen
t(VIEW_NODE,&show_ip_prefix_list_summary_cmd);install_element(VIEW_NODE,&show_ip
_prefix_list_detail_cmd);install_element(ENABLE_NODE,&clear_ip_prefix_list_cmd);
}/*Prefix-listnode.*/staticstructcmd_nodeprefix_ipv6_node={PREFIX_IPV6_NODE,"",/
*Prefixlisthasnointerface.*/1};staticintconfig_write_prefix_ipv6(structvty*vty){
returnconfig_write_prefix_afi(AFI_IP6,vty);}staticvoidprefix_list_init_ipv6(void
){install_node(&prefix_ipv6_node,config_write_prefix_ipv6);install_element(CONFI
G_NODE,&ipv6_prefix_list_cmd);install_element(CONFIG_NODE,&no_ipv6_prefix_list_c
md);install_element(CONFIG_NODE,&no_ipv6_prefix_list_all_cmd);install_element(CO
NFIG_NODE,&ipv6_prefix_list_description_cmd);install_element(CONFIG_NODE,&no_ipv
6_prefix_list_description_cmd);install_element(CONFIG_NODE,&no_ipv6_prefix_list_
description_comment_cmd);install_element(CONFIG_NODE,&ipv6_prefix_list_sequence_
number_cmd);install_element(VIEW_NODE,&show_ipv6_prefix_list_cmd);install_elemen
t(VIEW_NODE,&show_ipv6_prefix_list_prefix_cmd);install_element(VIEW_NODE,&show_i
pv6_prefix_list_summary_cmd);install_element(VIEW_NODE,&show_ipv6_prefix_list_de
tail_cmd);install_element(ENABLE_NODE,&clear_ipv6_prefix_list_cmd);}voidprefix_l
ist_init(){cmd_variable_handler_register(plist_var_handlers);prefix_list_init_ip
v4();prefix_list_init_ipv6();}voidprefix_list_reset(){prefix_list_reset_afi(AFI_
IP,0);prefix_list_reset_afi(AFI_IP6,0);prefix_list_reset_afi(AFI_IP,1);prefix_li
st_reset_afi(AFI_IP6,1);}