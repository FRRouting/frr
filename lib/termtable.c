/**ASCIItablegenerator.*Copyright(C)2017CumulusNetworks*QuentinYoung**Thisprogra
misfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralP
ublicLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,o
r(atyouroption)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeu
seful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FI
TNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Yousho
uldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefile
COPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bos
ton,MA02110-1301USA*/#include<zebra.h>#include<stdio.h>#include"memory.h"#includ
e"termtable.h"DEFINE_MTYPE_STATIC(LIB,TTABLE,"ASCIItable")/*clang-formatoff*/str
uctttable_stylettable_styles[]={{//defaultascii.corner='+',.rownums_on=false,.in
dent=1,.border={.top='-',.bottom='-',.left='|',.right='|',.top_on=true,.bottom_o
n=true,.left_on=true,.right_on=true,},.cell={.lpad=1,.rpad=1,.align=LEFT,.border
={.bottom='-',.bottom_on=true,.top='-',.top_on=false,.right='|',.right_on=true,.
left='|',.left_on=false,},},},{//blank,suitableforplaintextalignment.corner='',.
rownums_on=false,.indent=1,.border={.top='',.bottom='',.left='',.right='',.top_o
n=false,.bottom_on=false,.left_on=false,.right_on=false,},.cell={.lpad=0,.rpad=3
,.align=LEFT,.border={.bottom='',.bottom_on=false,.top='',.top_on=false,.right='
',.right_on=false,.left='',.left_on=false,},}}};/*clang-formaton*/voidttable_del
(structttable*tt){for(inti=tt->nrows-1;i>=0;i--)ttable_del_row(tt,i);XFREE(MTYPE
_TTABLE,tt->table);XFREE(MTYPE_TTABLE,tt);}structttable*ttable_new(structttable_
style*style){structttable*tt;tt=XCALLOC(MTYPE_TTABLE,sizeof(structttable));tt->s
tyle=*style;tt->nrows=0;tt->ncols=0;tt->size=0;tt->table=NULL;returntt;}/***Inse
rtsorappendsanewrowatthespecifiedindex.**Iftheindexis-1,therowisaddedtotheendoft
hetable.Otherwisethe*indexmustbeavalidindexintott->table.**Ifthetablealreadyhasa
tleastonerow(andthereforeadeterminate*numberofcolumns),aformatstringspecifyingan
umberofcolumnsnotequal*tott->ncolswillresultinano-opandareturnvalueofNULL.**@par
amtttabletoinsertinto*@paramiinsertionindex;insertedrowwillbe(i+1)'throw*@paramf
ormatprintfformatstringasinttable_[add|insert]_row()*@paramappre-initializedvari
adiclistofargumentsforformatstring**@returnpointertothefirstcellofallocatedrow*/
staticstructttable_cell*ttable_insert_row_va(structttable*tt,inti,constchar*form
at,va_listap){assert(i>=-1&&i<tt->nrows);char*res,*orig,*section;structttable_ce
ll*row;intcol=0;intncols=0;/*counthowmanycolumnswehave*/for(inti=0;format[i];i++
)ncols+=!!(format[i]=='|');ncols++;if(tt->ncols==0)tt->ncols=ncols;elseif(ncols!
=tt->ncols)returnNULL;/*reallocatechunkifnecessary*/while(tt->size<(tt->nrows+1)
*sizeof(structttable_cell*)){tt->size=MAX(2*tt->size,2*sizeof(structttable_cell*
));tt->table=XREALLOC(MTYPE_TTABLE,tt->table,tt->size);}/*CALLOCablockofcells*/r
ow=XCALLOC(MTYPE_TTABLE,tt->ncols*sizeof(structttable_cell));res=NULL;vasprintf(
&res,format,ap);orig=res;while(res){section=strsep(&res,"|");row[col].text=XSTRD
UP(MTYPE_TTABLE,section);row[col].style=tt->style.cell;col++;}free(orig);/*inser
trow*/if(i==-1||i==tt->nrows)tt->table[tt->nrows]=row;else{memmove(&tt->table[i+
1],&tt->table[i],(tt->nrows-i)*sizeof(structttable_cell*));tt->table[i]=row;}tt-
>nrows++;returnrow;}structttable_cell*ttable_insert_row(structttable*tt,unsigned
inti,constchar*format,...){structttable_cell*ret;va_listap;va_start(ap,format);r
et=ttable_insert_row_va(tt,i,format,ap);va_end(ap);returnret;}structttable_cell*
ttable_add_row(structttable*tt,constchar*format,...){structttable_cell*ret;va_li
stap;va_start(ap,format);ret=ttable_insert_row_va(tt,-1,format,ap);va_end(ap);re
turnret;}voidttable_del_row(structttable*tt,unsignedinti){assert((int)i<tt->nrow
s);for(intj=0;j<tt->ncols;j++)XFREE(MTYPE_TTABLE,tt->table[i][j].text);XFREE(MTY
PE_TTABLE,tt->table[i]);memmove(&tt->table[i],&tt->table[i+1],(tt->nrows-i-1)*si
zeof(structttable_cell*));tt->nrows--;if(tt->nrows==0)tt->ncols=0;}voidttable_al
ign(structttable*tt,unsignedintrow,unsignedintcol,unsignedintnrow,unsignedintnco
l,enumttable_alignalign){assert((int)row<tt->nrows);assert((int)col<tt->ncols);a
ssert((int)row+(int)nrow<=tt->nrows);assert((int)col+(int)ncol<=tt->ncols);for(u
nsignedinti=row;i<row+nrow;i++)for(unsignedintj=col;j<col+ncol;j++)tt->table[i][
j].style.align=align;}staticvoidttable_cell_pad(structttable_cell*cell,enumttabl
e_alignalign,shortpad){if(align==LEFT)cell->style.lpad=pad;elsecell->style.rpad=
pad;}voidttable_pad(structttable*tt,unsignedintrow,unsignedintcol,unsignedintnro
w,unsignedintncol,enumttable_alignalign,shortpad){assert((int)row<tt->nrows);ass
ert((int)col<tt->ncols);assert((int)row+(int)nrow<=tt->nrows);assert((int)col+(i
nt)ncol<=tt->ncols);for(unsignedinti=row;i<row+nrow;i++)for(unsignedintj=col;j<c
ol+ncol;j++)ttable_cell_pad(&tt->table[i][j],align,pad);}voidttable_restyle(stru
ctttable*tt){for(inti=0;i<tt->nrows;i++)for(intj=0;j<tt->ncols;j++)tt->table[i][
j].style=tt->style.cell;}voidttable_colseps(structttable*tt,unsignedintcol,enumt
table_alignalign,boolon,charsep){for(inti=0;i<tt->nrows;i++){if(align==RIGHT){tt
->table[i][col].style.border.right_on=on;tt->table[i][col].style.border.right=se
p;}else{tt->table[i][col].style.border.left_on=on;tt->table[i][col].style.border
.left=sep;}}}voidttable_rowseps(structttable*tt,unsignedintrow,enumttable_aligna
lign,boolon,charsep){for(inti=0;i<tt->ncols;i++){if(align==TOP){tt->table[row][i
].style.border.top_on=on;tt->table[row][i].style.border.top=sep;}else{tt->table[
row][i].style.border.bottom_on=on;tt->table[row][i].style.border.bottom=sep;}}}c
har*ttable_dump(structttable*tt,constchar*newline){/*clang-formatoff*/char*buf;/
/printbuffersize_tpos;//positioninbuffersize_tnl_len;//strlen(newline)intcw[tt->
ncols];//calculatedcolumnwidthsintnlines;//totalnumberofnewlines/tablelinessize_
twidth;//lengthofoneline,withnewlineintabspad;//calculatedwhitespaceforsprintfch
ar*left;//leftpartoflinesize_tlsize;//sizeofabovechar*right;//rightpartoflinesiz
e_trsize;//sizeofabovestructttable_cell*cell,*row;//iterationpointers/*clang-for
maton*/nl_len=strlen(newline);/*calculatewidthofeachcolumn*/memset(cw,0x00,sizeo
f(int)*tt->ncols);for(intj=0;j<tt->ncols;j++)for(inti=0,cellw=0;i<tt->nrows;i++)
{cell=&tt->table[i][j];cellw=0;cellw+=(int)strlen(cell->text);cellw+=cell->style
.lpad;cellw+=cell->style.rpad;if(j!=0)cellw+=cell->style.border.left_on?1:0;if(j
!=tt->ncols-1)cellw+=cell->style.border.right_on?1:0;cw[j]=MAX(cw[j],cellw);}/*c
alculateoveralllinewidth,includingnewline*/width=0;width+=tt->style.indent;width
+=tt->style.border.left_on?1:0;width+=tt->style.border.right_on?1:0;width+=strle
n(newline);for(inti=0;i<tt->ncols;i++)width+=cw[i];/*calculatenumberoflinesentot
al*/nlines=tt->nrows;nlines+=tt->style.border.top_on?1:0;nlines+=1;//tt->style.b
order.bottom_on?1:1;makeslifeeasierfor(inti=0;i<tt->nrows;i++){/*ifleftmostcellh
astop/bottomborder,wholerowdoes*/nlines+=tt->table[i][0].style.border.top_on?1:0
;nlines+=tt->table[i][0].style.border.bottom_on?1:0;}/*initializeleft&right*/lsi
ze=tt->style.indent+(tt->style.border.left_on?1:0);left=XCALLOC(MTYPE_TTABLE,lsi
ze);rsize=nl_len+(tt->style.border.right_on?1:0);right=XCALLOC(MTYPE_TTABLE,rsiz
e);memset(left,'',lsize);if(tt->style.border.left_on)left[lsize-1]=tt->style.bor
der.left;if(tt->style.border.right_on){right[0]=tt->style.border.right;memcpy(&r
ight[1],newline,nl_len);}elsememcpy(&right[0],newline,nl_len);/*allocateprintbuf
fer*/buf=XCALLOC(MTYPE_TMP,width*(nlines+1)+1);pos=0;if(tt->style.border.top_on)
{memcpy(&buf[pos],left,lsize);pos+=lsize;for(size_ti=0;i<width-lsize-rsize;i++)b
uf[pos++]=tt->style.border.top;memcpy(&buf[pos],right,rsize);pos+=rsize;}for(int
i=0;i<tt->nrows;i++){row=tt->table[i];/*iftopborderandnotfirstrow,printtoprowbor
der*/if(row[0].style.border.top_on&&i!=0){memcpy(&buf[pos],left,lsize);pos+=lsiz
e;for(size_ti=0;i<width-lsize-rsize;i++)buf[pos++]=row[0].style.border.top;pos-=
width-lsize-rsize;for(intk=0;k<tt->ncols;k++){if(k!=0&&row[k].style.border.left_
on)buf[pos]=tt->style.corner;pos+=cw[k];if(row[k].style.border.right_on&&k!=tt->
ncols-1)buf[pos-1]=tt->style.corner;}memcpy(&buf[pos],right,rsize);pos+=rsize;}m
emcpy(&buf[pos],left,lsize);pos+=lsize;for(intj=0;j<tt->ncols;j++){/*ifleftborde
r&&notfirstcolprintleftborder*/if(row[j].style.border.left_on&&j!=0)buf[pos++]=r
ow[j].style.border.left;/*printleftpadding*/for(inti=0;i<row[j].style.lpad;i++)b
uf[pos++]='';/*calculatepaddingforsprintf*/abspad=cw[j];abspad-=row[j].style.rpa
d;abspad-=row[j].style.lpad;if(j!=0)abspad-=row[j].style.border.left_on?1:0;if(j
!=tt->ncols-1)abspad-=row[j].style.border.right_on?1:0;/*printtext*/constchar*fm
t;if(row[j].style.align==LEFT)fmt="%-*s";elsefmt="%*s";pos+=sprintf(&buf[pos],fm
t,abspad,row[j].text);/*printrightpadding*/for(inti=0;i<row[j].style.rpad;i++)bu
f[pos++]='';/*ifrightborder&&notlastcolprintrightborder*/if(row[j].style.border.
right_on&&j!=tt->ncols-1)buf[pos++]=row[j].style.border.right;}memcpy(&buf[pos],
right,rsize);pos+=rsize;/*ifbottomborderandnotlastrow,printbottomborder*/if(row[
0].style.border.bottom_on&&i!=tt->nrows-1){memcpy(&buf[pos],left,lsize);pos+=lsi
ze;for(size_ti=0;i<width-lsize-rsize;i++)buf[pos++]=row[0].style.border.bottom;p
os-=width-lsize-rsize;for(intk=0;k<tt->ncols;k++){if(k!=0&&row[k].style.border.l
eft_on)buf[pos]=tt->style.corner;pos+=cw[k];if(row[k].style.border.right_on&&k!=
tt->ncols-1)buf[pos-1]=tt->style.corner;}memcpy(&buf[pos],right,rsize);pos+=rsiz
e;}assert(!buf[pos]);/*pos==&offirst\0inbuf*/}if(tt->style.border.bottom_on){mem
cpy(&buf[pos],left,lsize);pos+=lsize;for(size_ti=0;i<width-lsize-rsize;i++)buf[p
os++]=tt->style.border.bottom;memcpy(&buf[pos],right,rsize);pos+=rsize;}buf[pos]
='\0';XFREE(MTYPE_TTABLE,left);XFREE(MTYPE_TTABLE,right);returnbuf;}