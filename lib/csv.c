/*CSV*Copyright(C)2013CumulusNetworks,Inc.**ThisfileispartofQuagga.**Quaggaisfre
esoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicL
icenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any
*laterversion.**Quaggaisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
nclude<stdio.h>#include<stdlib.h>#include<string.h>#include<stdarg.h>#include<as
sert.h>#include<sys/queue.h>#include<fcntl.h>#include<unistd.h>#include"csv.h"#d
efineDEBUG_E1#defineDEBUG_V1#definelog_error(fmt,...)\do{\if(DEBUG_E)\fprintf(st
derr,"%s:%d:%s():"fmt,__FILE__,\__LINE__,__func__,##__VA_ARGS__);\}while(0)#defi
nelog_verbose(fmt,...)\do{\if(DEBUG_V)\fprintf(stderr,"%s:%d:%s():"fmt,__FILE__,
\__LINE__,__func__,__VA_ARGS__);\}while(0)struct_csv_field_t_{TAILQ_ENTRY(_csv_f
ield_t_)next_field;char*field;intfield_len;};struct_csv_record_t_{TAILQ_HEAD(,_c
sv_field_t_)fields;TAILQ_ENTRY(_csv_record_t_)next_record;char*record;intrec_len
;};struct_csv_t_{TAILQ_HEAD(,_csv_record_t_)records;char*buf;intbuflen;intcsv_le
n;intpointer;intnum_recs;};intcsvlen(csv_t*csv){return(csv->csv_len);}csv_t*csv_
init(csv_t*csv,char*buf,intbuflen){if(csv==NULL){csv=malloc(sizeof(csv_t));if(cs
v==NULL){log_error("CSVMallocfailed\n");return(NULL);}}memset(csv,0,sizeof(csv_t
));csv->buf=buf;csv->buflen=buflen;TAILQ_INIT(&(csv->records));return(csv);}void
csv_clean(csv_t*csv){csv_record_t*rec;csv_record_t*rec_n;rec=TAILQ_FIRST(&(csv->
records));while(rec!=NULL){rec_n=TAILQ_NEXT(rec,next_record);csv_remove_record(c
sv,rec);rec=rec_n;}}voidcsv_free(csv_t*csv){if(csv!=NULL){free(csv);}}staticvoid
csv_init_record(csv_record_t*record){TAILQ_INIT(&(record->fields));record->rec_l
en=0;}csv_record_t*csv_record_iter(csv_t*csv){return(TAILQ_FIRST(&(csv->records)
));}csv_record_t*csv_record_iter_next(csv_record_t*rec){if(!rec)returnNULL;retur
n(TAILQ_NEXT(rec,next_record));}char*csv_field_iter(csv_record_t*rec,csv_field_t
**fld){if(!rec)returnNULL;*fld=TAILQ_FIRST(&(rec->fields));return((*fld)->field)
;}char*csv_field_iter_next(csv_field_t**fld){*fld=TAILQ_NEXT(*fld,next_field);if
((*fld)==NULL){return(NULL);}return((*fld)->field);}intcsv_field_len(csv_field_t
*fld){if(fld){returnfld->field_len;}return0;}staticvoidcsv_decode_record(csv_rec
ord_t*rec){char*curr=rec->record;char*field;csv_field_t*fld;field=strpbrk(curr,"
,");while(field!=NULL){fld=malloc(sizeof(csv_field_t));if(fld){TAILQ_INSERT_TAIL
(&(rec->fields),fld,next_field);fld->field=curr;fld->field_len=field-curr;}curr=
field+1;field=strpbrk(curr,",");}field=strstr(curr,"\n");if(!field)return;fld=ma
lloc(sizeof(csv_field_t));if(fld){fld->field=curr;fld->field_len=field-curr;TAIL
Q_INSERT_TAIL(&(rec->fields),fld,next_field);}}staticcsv_field_t*csv_add_field_t
o_record(csv_t*csv,csv_record_t*rec,char*col){csv_field_t*fld;char*str=rec->reco
rd;intrlen=rec->rec_len;intblen=csv->buflen;fld=malloc(sizeof(csv_field_t));if(!
fld){log_error("fieldmallocfailed\n");/*morecleanupneeded*/return(NULL);}TAILQ_I
NSERT_TAIL(&(rec->fields),fld,next_field);fld->field=str+rlen;fld->field_len=snp
rintf((str+rlen),(blen-rlen),"%s",col);rlen+=fld->field_len;rec->rec_len=rlen;re
turnfld;}csv_record_t*csv_encode(csv_t*csv,intcount,...){inttempc;va_listlist;ch
ar*buf=csv->buf;intlen=csv->buflen;intpointer=csv->pointer;char*str=NULL;char*co
l;csv_record_t*rec;csv_field_t*fld;if(buf){str=buf+pointer;}else{/*allocatesuffi
cientbuffer*/str=(char*)malloc(csv->buflen);if(!str){log_error("fieldstrmallocfa
iled\n");return(NULL);}}va_start(list,count);rec=malloc(sizeof(csv_record_t));if
(!rec){log_error("recordmallocfailed\n");if(!buf)free(str);va_end(list);return(N
ULL);}csv_init_record(rec);rec->record=str;TAILQ_INSERT_TAIL(&(csv->records),rec
,next_record);csv->num_recs++;/***Iteratethroughthefieldspassedasavariablelistan
daddthem*/for(tempc=0;tempc<count;tempc++){col=va_arg(list,char*);fld=csv_add_fi
eld_to_record(csv,rec,col);if(!fld){log_error("fldmallocfailed\n");csv_remove_re
cord(csv,rec);va_end(list);return(NULL);}if(tempc<(count-1)){rec->rec_len+=snpri
ntf((str+rec->rec_len),(len-rec->rec_len),",");}}rec->rec_len+=snprintf((str+rec
->rec_len),(len-rec->rec_len),"\n");va_end(list);csv->csv_len+=rec->rec_len;csv-
>pointer+=rec->rec_len;return(rec);}intcsv_num_records(csv_t*csv){if(csv){return
csv->num_recs;}return0;}csv_record_t*csv_encode_record(csv_t*csv,csv_record_t*re
c,intcount,...){inttempc;va_listlist;char*str;char*col;csv_field_t*fld=NULL;inti
;va_start(list,count);str=csv_field_iter(rec,&fld);if(!fld){va_end(list);returnN
ULL;}for(tempc=0;tempc<count;tempc++){col=va_arg(list,char*);for(i=0;i<fld->fiel
d_len;i++){str[i]=col[i];}str=csv_field_iter_next(&fld);}va_end(list);return(rec
);}csv_record_t*csv_append_record(csv_t*csv,csv_record_t*rec,intcount,...){intte
mpc;va_listlist;intlen=csv->buflen,tlen;char*str;csv_field_t*fld;char*col;if(csv
->buf){/*notonlyworkswithdiscretebufs*/returnNULL;}if(!rec){/*createanewrec*/rec
=calloc(1,sizeof(csv_record_t));if(!rec){log_error("recordmallocfailed\n");retur
nNULL;}csv_init_record(rec);rec->record=calloc(1,csv->buflen);if(!rec->record){l
og_error("fieldstrmallocfailed\n");free(rec);returnNULL;}csv_insert_record(csv,r
ec);}str=rec->record;va_start(list,count);if(rec->rec_len&&(str[rec->rec_len-1]=
='\n'))str[rec->rec_len-1]=',';/***Iteratethroughthefieldspassedasavariablelista
ndaddthem*/tlen=rec->rec_len;for(tempc=0;tempc<count;tempc++){col=va_arg(list,ch
ar*);fld=csv_add_field_to_record(csv,rec,col);if(!fld){log_error("fldmallocfaile
d\n");break;}if(tempc<(count-1)){rec->rec_len+=snprintf((str+rec->rec_len),(len-
rec->rec_len),",");}}rec->rec_len+=snprintf((str+rec->rec_len),(len-rec->rec_len
),"\n");va_end(list);csv->csv_len+=(rec->rec_len-tlen);csv->pointer+=(rec->rec_l
en-tlen);return(rec);}intcsv_serialize(csv_t*csv,char*msgbuf,intmsglen){csv_reco
rd_t*rec;intoffset=0;if(!csv||!msgbuf)return-1;rec=csv_record_iter(csv);while(re
c!=NULL){if((offset+rec->rec_len)>=msglen)return-1;offset+=sprintf(&msgbuf[offse
t],"%s",rec->record);rec=csv_record_iter_next(rec);}return0;}voidcsv_clone_recor
d(csv_t*csv,csv_record_t*in_rec,csv_record_t**out_rec){char*curr;csv_record_t*re
c;/*firstcheckifrecbelongstothiscsv*/if(!csv_is_record_valid(csv,in_rec)){log_er
ror("recnotinthiscsv\n");return;}/*onlyworkswithcsvwithdiscretebufs*/if(csv->buf
){log_error("un-supportedforthiscsvtype-singlebufdetected\n");return;}/*createan
ewrec*/rec=calloc(1,sizeof(csv_record_t));if(!rec){log_error("recordmallocfailed
\n");return;}csv_init_record(rec);curr=calloc(1,csv->buflen);if(!curr){log_error
("fieldstrmallocfailed\n");free(rec);return;}rec->record=curr;rec->rec_len=in_re
c->rec_len;strcpy(rec->record,in_rec->record);/*decoderecordintofields*/csv_deco
de_record(rec);*out_rec=rec;}voidcsv_remove_record(csv_t*csv,csv_record_t*rec){c
sv_field_t*fld=NULL,*p_fld;/*firstcheckifrecbelongstothiscsv*/if(!csv_is_record_
valid(csv,rec)){log_error("recnotinthiscsv\n");return;}/*removefields*/csv_field
_iter(rec,&fld);while(fld){p_fld=fld;csv_field_iter_next(&fld);TAILQ_REMOVE(&(re
c->fields),p_fld,next_field);free(p_fld);}TAILQ_REMOVE(&(csv->records),rec,next_
record);csv->num_recs--;csv->csv_len-=rec->rec_len;csv->pointer-=rec->rec_len;if
(!csv->buf)free(rec->record);free(rec);}voidcsv_insert_record(csv_t*csv,csv_reco
rd_t*rec){/*firstcheckifrecalreadyincsv*/if(csv_is_record_valid(csv,rec)){log_er
ror("recalreadyinthiscsv\n");return;}/*wecanonlyinsertrecordsifnobufwassuppliedd
uringcsvinit*/if(csv->buf){log_error("un-supportedforthiscsvtype-singlebufdetect
ed\n");return;}/*dowegobeyondthemaxbufsetforthiscsv?*/if((csv->csv_len+rec->rec_
len)>csv->buflen){log_error("cannotinsert-exceededbufsize\n");return;}TAILQ_INSE
RT_TAIL(&(csv->records),rec,next_record);csv->num_recs++;csv->csv_len+=rec->rec_
len;csv->pointer+=rec->rec_len;}csv_record_t*csv_concat_record(csv_t*csv,csv_rec
ord_t*rec1,csv_record_t*rec2){char*curr;char*ret;csv_record_t*rec;/*firstcheckif
rec1andrec2belongtothiscsv*/if(!csv_is_record_valid(csv,rec1)||!csv_is_record_va
lid(csv,rec2)){log_error("rec1and/orrec2invalid\n");return(NULL);}/*wecanonlycon
catrecordsifnobufwassuppliedduringcsvinit*/if(csv->buf){log_error("un-supportedf
orthiscsvtype-singlebufdetected\n");return(NULL);}/*createanewrec*/rec=calloc(1,
sizeof(csv_record_t));if(!rec){log_error("recordmallocfailed\n");return(NULL);}c
sv_init_record(rec);curr=(char*)calloc(1,csv->buflen);if(!curr){log_error("field
strmallocfailed\n");gotoout_rec;}rec->record=curr;/*concattherecordstring*/ret=s
trstr(rec1->record,"\n");if(!ret){log_error("rec1strnotproperlyformatted\n");got
oout_curr;}snprintf(curr,(int)(ret-rec1->record+1),"%s",rec1->record);strcat(cur
r,",");ret=strstr(rec2->record,"\n");if(!ret){log_error("rec2strnotproperlyforma
tted\n");gotoout_curr;}snprintf((curr+strlen(curr)),(int)(ret-rec2->record+1),"%
s",rec2->record);strcat(curr,"\n");rec->rec_len=strlen(curr);/*paranoia*/assert(
csv->buflen>(csv->csv_len-rec1->rec_len-rec2->rec_len+rec->rec_len));/*decoderec
ordintofields*/csv_decode_record(rec);/*nowremoverec1andrec2andinsertrecintothis
csv*/csv_remove_record(csv,rec1);csv_remove_record(csv,rec2);csv_insert_record(c
sv,rec);returnrec;out_curr:free(curr);out_rec:free(rec);returnNULL;}voidcsv_deco
de(csv_t*csv,char*inbuf){char*buf;char*pos;csv_record_t*rec;buf=(inbuf)?inbuf:cs
v->buf;pos=strpbrk(buf,"\n");while(pos!=NULL){rec=calloc(1,sizeof(csv_record_t))
;if(!rec)return;csv_init_record(rec);TAILQ_INSERT_TAIL(&(csv->records),rec,next_
record);csv->num_recs++;if(csv->buf)rec->record=buf;else{rec->record=calloc(1,cs
v->buflen);if(!rec->record){log_error("fieldstrmallocfailed\n");return;}strncpy(
rec->record,buf,pos-buf+1);}rec->rec_len=pos-buf+1;/*decoderecordintofields*/csv
_decode_record(rec);buf=pos+1;pos=strpbrk(buf,"\n");}}intcsv_is_record_valid(csv
_t*csv,csv_record_t*in_rec){csv_record_t*rec;intvalid=0;rec=csv_record_iter(csv)
;while(rec){if(rec==in_rec){valid=1;break;}rec=csv_record_iter_next(rec);}return
valid;}voidcsv_dump(csv_t*csv){csv_record_t*rec;csv_field_t*fld;char*str;rec=csv
_record_iter(csv);while(rec!=NULL){str=csv_field_iter(rec,&fld);while(str!=NULL)
{fprintf(stderr,"%s\n",str);str=csv_field_iter_next(&fld);}rec=csv_record_iter_n
ext(rec);}}#ifdefTEST_CSVstaticintget_memory_usage(pid_tpid){intfd,data,stack;ch
arbuf[4096],status_child[BUFSIZ];char*vm;sprintf(status_child,"/proc/%d/status",
pid);if((fd=open(status_child,O_RDONLY))<0)return-1;read(fd,buf,4095);buf[4095]=
'\0';close(fd);data=stack=0;vm=strstr(buf,"VmData:");if(vm){sscanf(vm,"%*s%d",&d
ata);}vm=strstr(buf,"VmStk:");if(vm){sscanf(vm,"%*s%d",&stack);}returndata+stack
;}intmain(){charbuf[10000];csv_tcsv;inti;csv_record_t*rec;charhdr1[32],hdr2[32];
log_verbose("Mem:%d\n",get_memory_usage(getpid()));csv_init(&csv,buf,256);sprint
f(hdr1,"%4u",0);sprintf(hdr2,"%4u",1);log_verbose("(%zu/%zu/%d/%d)\n",strlen(hdr
1),strlen(hdr2),atoi(hdr1),atoi(hdr2));rec=csv_encode(&csv,2,hdr1,hdr2);csv_enco
de(&csv,4,"name","age","sex","hei");csv_encode(&csv,3,NULL,"0",NULL);csv_encode(
&csv,2,"p","35");for(i=0;i<50;i++){csv_encode(&csv,2,"p","10");}csv_encode(&csv,
2,"pdfadfadfadsadsaddfdfdsfdsd","35444554545454545");log_verbose("%s\n",buf);spr
intf(hdr1,"%4u",csv.csv_len);sprintf(hdr2,"%4u",1);log_verbose("(%zu/%zu/%d/%d)\
n",strlen(hdr1),strlen(hdr2),atoi(hdr1),atoi(hdr2));rec=csv_encode_record(&csv,r
ec,2,hdr1,hdr2);log_verbose("(%d/%d)\n%s\n",rec->rec_len,csv.csv_len,buf);log_ve
rbose("Mem:%d\n",get_memory_usage(getpid()));csv_clean(&csv);log_verbose("Mem:%d
\n",get_memory_usage(getpid()));csv_init(&csv,buf,256);csv_decode(&csv,NULL);log
_verbose("%s","AFTERDECODE\n");csv_dump(&csv);csv_clean(&csv);log_verbose("Mem:%
d\n",get_memory_usage(getpid()));}#endif