/*SNMPsupport*Copyright(C)2012VincentBernat<bernat@luffy.cx>**ThisfileispartofGN
UZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheterms
oftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversio
n2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbe
useful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorF
ITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yoush
ouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefil
eCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bo
ston,MA02110-1301USA*/#include<zebra.h>#ifdefSNMP_AGENTX#include<net-snmp/net-sn
mp-config.h>#include<net-snmp/net-snmp-includes.h>#include<net-snmp/agent/net-sn
mp-agent-includes.h>#include<net-snmp/agent/snmp_vars.h>#include"command.h"#incl
ude"smux.h"#include"memory.h"#include"linklist.h"#include"version.h"staticintage
ntx_enabled=0;staticstructthread_master*agentx_tm;staticstructthread*timeout_thr
=NULL;staticstructlist*events=NULL;staticvoidagentx_events_update(void);staticin
tagentx_timeout(structthread*t){timeout_thr=NULL;snmp_timeout();run_alarms();net
snmp_check_outstanding_agent_requests();agentx_events_update();return0;}staticin
tagentx_read(structthread*t){fd_setfds;structlistnode*ln=THREAD_ARG(t);list_dele
te_node(events,ln);FD_ZERO(&fds);FD_SET(THREAD_FD(t),&fds);snmp_read(&fds);netsn
mp_check_outstanding_agent_requests();agentx_events_update();return0;}staticvoid
agentx_events_update(void){intmaxfd=0;intblock=1;structtimevaltimeout={.tv_sec=0
,.tv_usec=0};fd_setfds;structlistnode*ln;structthread*thr;intfd,thr_fd;THREAD_OF
F(timeout_thr);FD_ZERO(&fds);snmp_select_info(&maxfd,&fds,&timeout,&block);if(!b
lock){timeout_thr=NULL;thread_add_timer_tv(agentx_tm,agentx_timeout,NULL,&timeou
t,&timeout_thr);}ln=listhead(events);thr=ln?listgetdata(ln):NULL;thr_fd=thr?THRE
AD_FD(thr):-1;/*"two-pointer"/two-listsimultaneousiteration*ln/thr/thr_fdpointto
thenextexistingeventlistenertohitwhile*fdcountstocatchup*/for(fd=0;fd<maxfd;fd++
){/*caughtup*/if(thr_fd==fd){structlistnode*nextln=listnextnode(ln);if(!FD_ISSET
(fd,&fds)){thread_cancel(thr);list_delete_node(events,ln);}ln=nextln;thr=ln?list
getdata(ln):NULL;thr_fd=thr?THREAD_FD(thr):-1;}/*needlistener,buthaven'thitonewh
ereitwouldbe*/elseif(FD_ISSET(fd,&fds)){structlistnode*newln;thr=NULL;thread_add
_read(agentx_tm,agentx_read,NULL,fd,&thr);newln=listnode_add_before(events,ln,th
r);thr->arg=newln;}}/*leftovereventlistenersatthispointhavefd>maxfd,deletethem*/
while(ln){structlistnode*nextln=listnextnode(ln);thread_cancel(listgetdata(ln));
list_delete_node(events,ln);ln=nextln;}}/*AgentXnode.*/staticstructcmd_nodeagent
x_node={SMUX_NODE,"",/*AgentXhasnointerface.*/1};/*LoggingNetSNMPmessages*/stati
cintagentx_log_callback(intmajor,intminor,void*serverarg,void*clientarg){structs
nmp_log_message*slm=(structsnmp_log_message*)serverarg;char*msg=XSTRDUP(MTYPE_TM
P,slm->msg);if(msg)msg[strlen(msg)-1]='\0';switch(slm->priority){caseLOG_EMERG:z
log_err("snmp[emerg]:%s",msg?msg:slm->msg);break;caseLOG_ALERT:zlog_err("snmp[al
ert]:%s",msg?msg:slm->msg);break;caseLOG_CRIT:zlog_err("snmp[crit]:%s",msg?msg:s
lm->msg);break;caseLOG_ERR:zlog_err("snmp[err]:%s",msg?msg:slm->msg);break;caseL
OG_WARNING:zlog_warn("snmp[warning]:%s",msg?msg:slm->msg);break;caseLOG_NOTICE:z
log_notice("snmp[notice]:%s",msg?msg:slm->msg);break;caseLOG_INFO:zlog_info("snm
p[info]:%s",msg?msg:slm->msg);break;caseLOG_DEBUG:zlog_debug("snmp[debug]:%s",ms
g?msg:slm->msg);break;}XFREE(MTYPE_TMP,msg);returnSNMP_ERR_NOERROR;}staticintcon
fig_write_agentx(structvty*vty){if(agentx_enabled)vty_out(vty,"agentx\n");return
1;}DEFUN(agentx_enable,agentx_enable_cmd,"agentx","SNMPAgentXprotocolsettings\n"
){if(!agentx_enabled){init_snmp(FRR_SMUX_NAME);events=list_new();agentx_events_u
pdate();agentx_enabled=1;returnCMD_SUCCESS;}vty_out(vty,"SNMPAgentXalreadyenable
d\n");returnCMD_SUCCESS;}DEFUN(no_agentx,no_agentx_cmd,"noagentx",NO_STR"SNMPAge
ntXprotocolsettings\n"){if(!agentx_enabled)returnCMD_SUCCESS;vty_out(vty,"SNMPAg
entXsupportcannotbedisabledonceenabled\n");returnCMD_WARNING_CONFIG_FAILED;}void
smux_init(structthread_master*tm){agentx_tm=tm;netsnmp_enable_subagent();snmp_di
sable_log();snmp_enable_calllog();snmp_register_callback(SNMP_CALLBACK_LIBRARY,S
NMP_CALLBACK_LOGGING,agentx_log_callback,NULL);init_agent(FRR_SMUX_NAME);install
_node(&agentx_node,config_write_agentx);install_element(CONFIG_NODE,&agentx_enab
le_cmd);install_element(CONFIG_NODE,&no_agentx_cmd);}voidsmux_register_mib(const
char*descr,structvariable*var,size_twidth,intnum,oidname[],size_tnamelen){regist
er_mib(descr,var,width,num,name,namelen);}intsmux_trap(structvariable*vp,size_tv
p_len,constoid*ename,size_tenamelen,constoid*name,size_tnamelen,constoid*iname,s
ize_tinamelen,conststructtrap_object*trapobj,size_ttrapobjlen,uint8_tsptrap){oid
objid_snmptrap[]={1,3,6,1,6,3,1,1,4,1,0};size_tobjid_snmptrap_len=sizeofobjid_sn
mptrap/sizeof(oid);oidnotification_oid[MAX_OID_LEN];size_tnotification_oid_len;u
nsignedinti;netsnmp_variable_list*notification_vars=NULL;if(!agentx_enabled)retu
rn0;/*snmpTrapOID*/oid_copy(notification_oid,ename,enamelen);notification_oid[en
amelen]=sptrap;notification_oid_len=enamelen+1;snmp_varlist_add_variable(&notifi
cation_vars,objid_snmptrap,objid_snmptrap_len,ASN_OBJECT_ID,(uint8_t*)notificati
on_oid,notification_oid_len*sizeof(oid));/*Providedbindings*/for(i=0;i<trapobjle
n;i++){unsignedintj;oidoid[MAX_OID_LEN];size_toid_len,onamelen;uint8_t*val;size_
tval_len;WriteMethod*wm=NULL;structvariablecvp;/*MakeOID.*/if(trapobj[i].namelen
>0){/*Columnarobject*/onamelen=trapobj[i].namelen;oid_copy(oid,name,namelen);oid
_copy(oid+namelen,trapobj[i].name,onamelen);oid_copy(oid+namelen+onamelen,iname,
inamelen);oid_len=namelen+onamelen+inamelen;}else{/*Scalarobject*/onamelen=trapo
bj[i].namelen*(-1);oid_copy(oid,name,namelen);oid_copy(oid+namelen,trapobj[i].na
me,onamelen);oid[onamelen+namelen]=0;oid_len=namelen+onamelen+1;}/*Locatetheappr
opriatefunctionandtypeintheMIBregistry.*/for(j=0;j<vp_len;j++){if(oid_compare(tr
apobj[i].name,onamelen,vp[j].name,vp[j].namelen)!=0)continue;/*Wefoundtheappropr
iatevariableintheMIB*registry.*/oid_copy(cvp.name,name,namelen);oid_copy(cvp.nam
e+namelen,vp[j].name,vp[j].namelen);cvp.namelen=namelen+vp[j].namelen;cvp.type=v
p[j].type;cvp.magic=vp[j].magic;cvp.acl=vp[j].acl;cvp.findVar=vp[j].findVar;/*Gr
abtheresult.*/val=cvp.findVar(&cvp,oid,&oid_len,1,&val_len,&wm);if(!val)break;sn
mp_varlist_add_variable(&notification_vars,oid,oid_len,vp[j].type,val,val_len);b
reak;}}send_v2trap(notification_vars);snmp_free_varbind(notification_vars);agent
x_events_update();return1;}#endif/*SNMP_AGENTX*/