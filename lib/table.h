/**RoutingTable*Copyright(C)1998KunihiroIshiguro**ThisfileispartofGNUZebra.**GNU
Zebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGene
ralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyour
option)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*W
ITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPA
RTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhaverece
ivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifn
ot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110
-1301USA*/#ifndef_ZEBRA_TABLE_H#define_ZEBRA_TABLE_H#include"memory.h"#include"h
ash.h"DECLARE_MTYPE(ROUTE_TABLE)DECLARE_MTYPE(ROUTE_NODE)/**Forwarddeclarations.
*/structroute_node;structroute_table;/**route_table_delegate_t**Functionvectorth
atcanbeusedbyaclienttocustomizethe*behaviorofoneormoreroutetables.*/typedefstruc
troute_table_delegate_t_route_table_delegate_t;typedefstructroute_node*(*route_t
able_create_node_func_t)(route_table_delegate_t*,structroute_table*);typedefvoid
(*route_table_destroy_node_func_t)(route_table_delegate_t*,structroute_table*,st
ructroute_node*);structroute_table_delegate_t_{route_table_create_node_func_tcre
ate_node;route_table_destroy_node_func_tdestroy_node;};/*Routingtabletopstructur
e.*/structroute_table{structroute_node*top;structhash*hash;/**Delegatethatperfor
mscertainfunctionsforthistable.*/route_table_delegate_t*delegate;void(*cleanup)(
structroute_table*,structroute_node*);unsignedlongcount;/**Userdata.*/void*info;
};/**node->linkisreallyinternaltothetablecodeandshouldnotbe*accessedbyoutsidecod
e.Wedon'thaveanywriters(yay),thoughsome*readersarelefttobefixed.**rationale:wene
edtoaddahashtableinparallel,tospeedup*exact-matchlookups.**samereallyappliesforn
ode->parent,thoughthat'slessofanissue.*table->linkshouldbe-andis-NEVERwrittenbyo
utsidecode*/#ifdefFRR_COMPILING_TABLE_C#definetable_rdonly(x)x#definetable_inter
nal(x)x#else#definetable_rdonly(x)constx#definetable_internal(x)\constx__attribu
te__(\(deprecated("thisshouldonlybeaccessedbylib/table.c")))/*table_internalisfo
rnode->linkandnode->lock,oncewehavedone*somethingaboutremainingaccesses*/#endif/
*so...theproblemwiththisisthat"const"doesn'tmean"readonly".*Itinfactmayallowthec
ompilertooptimizebasedontheassumption*thatthevaluedoesn'tchange.Hence,sincetheon
lypurposeofthis*istoaidindevelopment,don'tputthe"const"inreleasebuilds.**(Ihaven
'tseenthisactuallybreak,butGCCandLLVMaregettingever*moreaggressiveinoptimizing..
.)*/#ifndefDEV_BUILD#undeftable_rdonly#definetable_rdonly(x)x#endif/**Macrothatd
efinesallfieldsinaroutenode.*/#defineROUTE_NODE_FIELDS\/*Actualprefixofthisradix
.*/\structprefixp;\\/*Treelink.*/\structroute_table*table_rdonly(table);\structr
oute_node*table_rdonly(parent);\structroute_node*table_rdonly(link[2]);\\/*Locko
fthisradix*/\unsignedinttable_rdonly(lock);\\/*Eachnodeofroute.*/\void*info;\\/*
Aggregation.*/\void*aggregate;/*Eachroutingentry.*/structroute_node{ROUTE_NODE_F
IELDS#definel_leftlink[0]#definel_rightlink[1]};typedefstructroute_table_iter_t_
route_table_iter_t;typedefenum{RT_ITER_STATE_INIT,RT_ITER_STATE_ITERATING,RT_ITE
R_STATE_PAUSED,RT_ITER_STATE_DONE}route_table_iter_state_t;/**route_table_iter_t
**Structurethatholdsstateforiteratingoveraroutetable.*/structroute_table_iter_t_
{route_table_iter_state_tstate;/**Routingtablethatweareiteratingover.Thecallermu
stensure*thatthattableoutlivestheiterator.*/structroute_table*table;/**Thenodeth
attheiteratoriscurrentlyon.*/structroute_node*current;/**Thelastprefixthattheite
ratorprocessedbeforeitwaspaused.*/structprefixpause_prefix;};/*Prototypes.*/exte
rnstructroute_table*route_table_init(void);externstructroute_table*route_table_i
nit_with_delegate(route_table_delegate_t*);externroute_table_delegate_t*route_ta
ble_get_default_delegate(void);externvoidroute_table_finish(structroute_table*);
externstructroute_node*route_top(structroute_table*);externstructroute_node*rout
e_next(structroute_node*);externstructroute_node*route_next_until(structroute_no
de*,conststructroute_node*);externstructroute_node*route_node_get(structroute_ta
ble*const,unionprefixconstptr);externstructroute_node*route_node_lookup(conststr
uctroute_table*,unionprefixconstptr);externstructroute_node*route_node_lookup_ma
ynull(conststructroute_table*,unionprefixconstptr);externstructroute_node*route_
node_match(conststructroute_table*,unionprefixconstptr);externstructroute_node*r
oute_node_match_ipv4(conststructroute_table*,conststructin_addr*);externstructro
ute_node*route_node_match_ipv6(conststructroute_table*,conststructin6_addr*);ext
ernunsignedlongroute_table_count(conststructroute_table*);externstructroute_node
*route_node_create(route_table_delegate_t*,structroute_table*);externvoidroute_n
ode_delete(structroute_node*);externvoidroute_node_destroy(route_table_delegate_
t*,structroute_table*,structroute_node*);externstructroute_node*route_table_get_
next(conststructroute_table*table,unionprefixconstptrpu);externintroute_table_pr
efix_iter_cmp(conststructprefix*p1,conststructprefix*p2);/**Iteratorfunctions.*/
externvoidroute_table_iter_init(route_table_iter_t*iter,structroute_table*table)
;externvoidroute_table_iter_pause(route_table_iter_t*iter);externvoidroute_table
_iter_cleanup(route_table_iter_t*iter);/**Inlinefunctions.*//*Locknode.*/statici
nlinestructroute_node*route_lock_node(structroute_node*node){(*(unsigned*)&node-
>lock)++;returnnode;}/*Unlocknode.*/staticinlinevoidroute_unlock_node(structrout
e_node*node){assert(node->lock>0);(*(unsigned*)&node->lock)--;if(node->lock==0)r
oute_node_delete(node);}/**route_table_iter_next**Getthenextnodeinthetree.*/stat
icinlinestructroute_node*route_table_iter_next(route_table_iter_t*iter){structro
ute_node*node;switch(iter->state){caseRT_ITER_STATE_INIT:/**We'rejuststartingthe
iteration.*/node=route_top(iter->table);break;caseRT_ITER_STATE_ITERATING:node=r
oute_next(iter->current);break;caseRT_ITER_STATE_PAUSED:/**Startwiththenodefollo
wingpause_prefix.*/node=route_table_get_next(iter->table,&iter->pause_prefix);br
eak;caseRT_ITER_STATE_DONE:returnNULL;default:assert(0);}iter->current=node;if(n
ode)iter->state=RT_ITER_STATE_ITERATING;elseiter->state=RT_ITER_STATE_DONE;retur
nnode;}/**route_table_iter_is_done**ReturnsTRUEiftheiterationiscomplete.*/static
inlineintroute_table_iter_is_done(route_table_iter_t*iter){returniter->state==RT
_ITER_STATE_DONE;}/**route_table_iter_started**ReturnsTRUEifthisiteratorhasstart
editeratingoverthetree.*/staticinlineintroute_table_iter_started(route_table_ite
r_t*iter){returniter->state!=RT_ITER_STATE_INIT;}#endif/*_ZEBRA_TABLE_H*/