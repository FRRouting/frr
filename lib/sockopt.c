/*setsockoptfunctions*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebra
.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheG
NUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(
atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful
,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESS
FORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldha
vereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYI
NG;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,M
A02110-1301USA*/#include<zebra.h>#ifdefSUNOS_5#include<ifaddrs.h>#endif#include"
log.h"#include"sockopt.h"#include"sockunion.h"voidsetsockopt_so_recvbuf(intsock,
intsize){intorig_req=size;while(setsockopt(sock,SOL_SOCKET,SO_RCVBUF,&size,sizeo
f(size))==-1)size/=2;if(size!=orig_req)zlog_warn("%s:fd%d:SO_RCVBUFsetto%d(reque
sted%d)",__func__,sock,size,orig_req);}voidsetsockopt_so_sendbuf(constintsock,in
tsize){intorig_req=size;while(setsockopt(sock,SOL_SOCKET,SO_SNDBUF,&size,sizeof(
size))==-1)size/=2;if(size!=orig_req)zlog_warn("%s:fd%d:SO_SNDBUFsetto%d(request
ed%d)",__func__,sock,size,orig_req);}intgetsockopt_so_sendbuf(constintsock){uint
32_toptval;socklen_toptlen=sizeof(optval);intret=getsockopt(sock,SOL_SOCKET,SO_S
NDBUF,(char*)&optval,&optlen);if(ret<0){zlog_err("fd%d:can'tgetsockoptSO_SNDBUF:
%d(%s)",sock,errno,safe_strerror(errno));returnret;}returnoptval;}staticvoid*get
sockopt_cmsg_data(structmsghdr*msgh,intlevel,inttype){structcmsghdr*cmsg;void*pt
r=NULL;for(cmsg=ZCMSG_FIRSTHDR(msgh);cmsg!=NULL;cmsg=CMSG_NXTHDR(msgh,cmsg))if(c
msg->cmsg_level==level&&cmsg->cmsg_type)return(ptr=CMSG_DATA(cmsg));returnNULL;}
/*SetIPv6packetinfotothesocket.*/intsetsockopt_ipv6_pktinfo(intsock,intval){intr
et;#ifdefIPV6_RECVPKTINFO/*2292bis-01*/ret=setsockopt(sock,IPPROTO_IPV6,IPV6_REC
VPKTINFO,&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsockoptIPV6_RECVPKTINFO:%
s",safe_strerror(errno));#else/*RFC2292*/ret=setsockopt(sock,IPPROTO_IPV6,IPV6_P
KTINFO,&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsockoptIPV6_PKTINFO:%s",saf
e_strerror(errno));#endif/*INIA_IPV6*/returnret;}/*Setmulticasthopsvaltothesocke
t.*/intsetsockopt_ipv6_checksum(intsock,intval){intret;#ifdefGNU_LINUXret=setsoc
kopt(sock,IPPROTO_RAW,IPV6_CHECKSUM,&val,sizeof(val));#elseret=setsockopt(sock,I
PPROTO_IPV6,IPV6_CHECKSUM,&val,sizeof(val));#endif/*GNU_LINUX*/if(ret<0)zlog_war
n("can'tsetsockoptIPV6_CHECKSUM");returnret;}/*Setmulticasthopsvaltothesocket.*/
intsetsockopt_ipv6_multicast_hops(intsock,intval){intret;ret=setsockopt(sock,IPP
ROTO_IPV6,IPV6_MULTICAST_HOPS,&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsock
optIPV6_MULTICAST_HOPS");returnret;}/*Setmulticasthopsvaltothesocket.*/intsetsoc
kopt_ipv6_unicast_hops(intsock,intval){intret;ret=setsockopt(sock,IPPROTO_IPV6,I
PV6_UNICAST_HOPS,&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsockoptIPV6_UNICA
ST_HOPS");returnret;}intsetsockopt_ipv6_hoplimit(intsock,intval){intret;#ifdefIP
V6_RECVHOPLIMIT/*2292bis-01*/ret=setsockopt(sock,IPPROTO_IPV6,IPV6_RECVHOPLIMIT,
&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsockoptIPV6_RECVHOPLIMIT");#else/*
RFC2292*/ret=setsockopt(sock,IPPROTO_IPV6,IPV6_HOPLIMIT,&val,sizeof(val));if(ret
<0)zlog_warn("can'tsetsockoptIPV6_HOPLIMIT");#endifreturnret;}/*Setmulticastloop
zerotothesocket.*/intsetsockopt_ipv6_multicast_loop(intsock,intval){intret;ret=s
etsockopt(sock,IPPROTO_IPV6,IPV6_MULTICAST_LOOP,&val,sizeof(val));if(ret<0)zlog_
warn("can'tsetsockoptIPV6_MULTICAST_LOOP");returnret;}staticintgetsockopt_ipv6_i
findex(structmsghdr*msgh){structin6_pktinfo*pktinfo;pktinfo=getsockopt_cmsg_data
(msgh,IPPROTO_IPV6,IPV6_PKTINFO);returnpktinfo->ipi6_ifindex;}intsetsockopt_ipv6
_tclass(intsock,inttclass){intret=0;#ifdefIPV6_TCLASS/*RFC3542*/ret=setsockopt(s
ock,IPPROTO_IPV6,IPV6_TCLASS,&tclass,sizeof(tclass));if(ret<0)zlog_warn("Can'tse
tIPV6_TCLASSoptionforfd%dto%#x:%s",sock,tclass,safe_strerror(errno));#endifretur
nret;}/**ProcessmulticastsocketoptionsforIPv4inanOS-dependentmanner.*Supportedop
tionsareIP_{ADD,DROP}_MEMBERSHIP.**Manyoperatingsystemshavealimitonthenumberofgr
oupsthat*canbejoinedpersocket(whereeachgroupandlocaladdress*counts).ThisimpactsO
SPF,whichjoinsgroupsoneachinterface*usingasinglesocket.Thelimitistypically20,der
ivedfromthe*originalBSDmulticastimplementation.Somesystemshave*mechanismsforincr
easingthislimit.**Inmany4.4BSD-derivedsystems,multicastgroupoperationsarenot*all
owedoninterfacesthatarenotUP.Thus,apreviousattemptto*leavethegroupmayhavefailed,
leavingitstilljoined,andwe*drop/joinquietlytorecover.Thismaynotbenecessary,butai
msto*defendagainstunknownbehaviorinthatwewillstillreturnanerror*ifthesecondjoinf
ails.Itisnotclearhowothersystems*(e.g.Linux,Solaris)behavewhenleavinggroupsondow
ninterfaces,*butthisbehaviorshouldnotbeharmfuliftheybehavethesameway,*allowleave
s,orimplicitlyleaveallgroupsjoinedtodowninterfaces.*/intsetsockopt_ipv4_multicas
t(intsock,intoptname,structin_addrif_addr,unsignedintmcast_addr,ifindex_tifindex
){#ifdefHAVE_RFC3678structgroup_reqgr;structsockaddr_in*si;intret;memset(&gr,0,s
izeof(gr));si=(structsockaddr_in*)&gr.gr_group;gr.gr_interface=ifindex;si->sin_f
amily=AF_INET;#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENsi->sin_len=sizeof(structsock
addr_in);#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*/si->sin_addr.s_addr=mcast_addr
;ret=setsockopt(sock,IPPROTO_IP,(optname==IP_ADD_MEMBERSHIP)?MCAST_JOIN_GROUP:MC
AST_LEAVE_GROUP,(void*)&gr,sizeof(gr));if((ret<0)&&(optname==IP_ADD_MEMBERSHIP)&
&(errno==EADDRINUSE)){setsockopt(sock,IPPROTO_IP,MCAST_LEAVE_GROUP,(void*)&gr,si
zeof(gr));ret=setsockopt(sock,IPPROTO_IP,MCAST_JOIN_GROUP,(void*)&gr,sizeof(gr))
;}returnret;#elifdefined(HAVE_STRUCT_IP_MREQN_IMR_IFINDEX)&&!defined(__FreeBSD__
)structip_mreqnmreqn;intret;assert(optname==IP_ADD_MEMBERSHIP||optname==IP_DROP_
MEMBERSHIP);memset(&mreqn,0,sizeof(mreqn));mreqn.imr_multiaddr.s_addr=mcast_addr
;mreqn.imr_ifindex=ifindex;ret=setsockopt(sock,IPPROTO_IP,optname,(void*)&mreqn,
sizeof(mreqn));if((ret<0)&&(optname==IP_ADD_MEMBERSHIP)&&(errno==EADDRINUSE)){/*
seeabove:handlepossibleproblemwheninterfacecomesback*up*/charbuf[1][INET_ADDRSTR
LEN];zlog_info("setsockopt_ipv4_multicastattemptingtodropand""re-add(fd%d,mcast%
s,ifindex%u)",sock,inet_ntop(AF_INET,&mreqn.imr_multiaddr,buf[0],sizeof(buf[0]))
,ifindex);setsockopt(sock,IPPROTO_IP,IP_DROP_MEMBERSHIP,(void*)&mreqn,sizeof(mre
qn));ret=setsockopt(sock,IPPROTO_IP,IP_ADD_MEMBERSHIP,(void*)&mreqn,sizeof(mreqn
));}returnret;/*ExampledefinesforanotherOS,boilerplateoffothercodeinthisfunction
,ANDhandleoptnameasperothersectionsforconsistency!!*//*#elifdefined(BOGON_NIX)&&
EXAMPLE_VERSION_CODE>-100000*//*AddyourfavouriteOShere!*/#elifdefined(HAVE_BSD_S
TRUCT_IP_MREQ_HACK)/*#ifOS_TYPE*//*standardBSDAPI*/structip_mreqmreq;intret;asse
rt(optname==IP_ADD_MEMBERSHIP||optname==IP_DROP_MEMBERSHIP);memset(&mreq,0,sizeo
f(mreq));mreq.imr_multiaddr.s_addr=mcast_addr;#if!defined__OpenBSD__mreq.imr_int
erface.s_addr=htonl(ifindex);#elsemreq.imr_interface.s_addr=if_addr.s_addr;#endi
fret=setsockopt(sock,IPPROTO_IP,optname,(void*)&mreq,sizeof(mreq));if((ret<0)&&(
optname==IP_ADD_MEMBERSHIP)&&(errno==EADDRINUSE)){/*seeabove:handlepossibleprobl
emwheninterfacecomesback*up*/charbuf[1][INET_ADDRSTRLEN];zlog_info("setsockopt_i
pv4_multicastattemptingtodropand""re-add(fd%d,mcast%s,ifindex%u)",sock,inet_ntop
(AF_INET,&mreq.imr_multiaddr,buf[0],sizeof(buf[0])),ifindex);setsockopt(sock,IPP
ROTO_IP,IP_DROP_MEMBERSHIP,(void*)&mreq,sizeof(mreq));ret=setsockopt(sock,IPPROT
O_IP,IP_ADD_MEMBERSHIP,(void*)&mreq,sizeof(mreq));}returnret;#else#error"Unsuppo
rtedmulticastAPI"#endif/*#ifOS_TYPE*/}/**SetIP_MULTICAST_IFsocketoptioninanOS-de
pendentmanner.*/intsetsockopt_ipv4_multicast_if(intsock,structin_addrif_addr,ifi
ndex_tifindex){#ifdefHAVE_STRUCT_IP_MREQN_IMR_IFINDEXstructip_mreqnmreqn;memset(
&mreqn,0,sizeof(mreqn));mreqn.imr_ifindex=ifindex;returnsetsockopt(sock,IPPROTO_
IP,IP_MULTICAST_IF,(void*)&mreqn,sizeof(mreqn));/*ExampledefinesforanotherOS,boi
lerplateoffothercodeinthisfunction*//*#elifdefined(BOGON_NIX)&&EXAMPLE_VERSION_C
ODE>-100000*//*AddyourfavouriteOShere!*/#elifdefined(HAVE_BSD_STRUCT_IP_MREQ_HAC
K)structin_addrm;#if!defined__OpenBSD__m.s_addr=htonl(ifindex);#elsem.s_addr=if_
addr.s_addr;#endifreturnsetsockopt(sock,IPPROTO_IP,IP_MULTICAST_IF,(void*)&m,siz
eof(m));#elifdefined(SUNOS_5)charifname[IF_NAMESIZE];structifaddrs*ifa,*ifap;str
uctin_addrifaddr;if(if_indextoname(ifindex,ifname)==NULL)return-1;if(getifaddrs(
&ifa)!=0)return-1;for(ifap=ifa;ifap!=NULL;ifap=ifap->ifa_next){structsockaddr_in
*sa;if(strcmp(ifap->ifa_name,ifname)!=0)continue;if(ifap->ifa_addr->sa_family!=A
F_INET)continue;sa=(structsockaddr_in*)ifap->ifa_addr;memcpy(&ifaddr,&sa->sin_ad
dr,sizeof(ifaddr));break;}freeifaddrs(ifa);if(!ifap)/*ThismeanswedidnotfindanIP*
/return-1;returnsetsockopt(sock,IPPROTO_IP,IP_MULTICAST_IF,(void*)&ifaddr,sizeof
(ifaddr));#else#error"UnsupportedmulticastAPI"#endif}intsetsockopt_ipv4_multicas
t_loop(intsock,uint8_tval){intret;ret=setsockopt(sock,IPPROTO_IP,IP_MULTICAST_LO
OP,(void*)&val,sizeof(val));if(ret<0)zlog_warn("can'tsetsockoptIP_MULTICAST_LOOP
");returnret;}staticintsetsockopt_ipv4_ifindex(intsock,ifindex_tval){intret;#ifd
efined(IP_PKTINFO)if((ret=setsockopt(sock,IPPROTO_IP,IP_PKTINFO,&val,sizeof(val)
))<0)zlog_warn("Can'tsetIP_PKTINFOoptionforfd%dto%d:%s",sock,val,safe_strerror(e
rrno));#elifdefined(IP_RECVIF)if((ret=setsockopt(sock,IPPROTO_IP,IP_RECVIF,&val,
sizeof(val)))<0)zlog_warn("Can'tsetIP_RECVIFoptionforfd%dto%d:%s",sock,val,safe_
strerror(errno));#else#warning"NeitherIP_PKTINFOnorIP_RECVIFisavailable."#warnin
g"Willnotbeabletoreceivelinkinfo."#warning"Thingsmightbeseriouslybroken.."/*XXXD
oesthiseverhappen?Shouldtherebeazlog_warnmessagehere?*/ret=-1;#endifreturnret;}i
ntsetsockopt_ipv4_tos(intsock,inttos){intret;ret=setsockopt(sock,IPPROTO_IP,IP_T
OS,&tos,sizeof(tos));if(ret<0)zlog_warn("Can'tsetIP_TOSoptionforfd%dto%#x:%s",so
ck,tos,safe_strerror(errno));returnret;}intsetsockopt_ifindex(intaf,intsock,ifin
dex_tval){intret=-1;switch(af){caseAF_INET:ret=setsockopt_ipv4_ifindex(sock,val)
;break;caseAF_INET6:ret=setsockopt_ipv6_pktinfo(sock,val);break;default:zlog_war
n("setsockopt_ifindex:unknownaddressfamily%d",af);}returnret;}/**Requires:msghis
notNULLandpointstoavalidstructmsghdr,which*mayormaynothavecontroldataabouttheinc
ominginterface.**Returnstheinterfaceindex(smallinteger>=1)ifitcanbe*determined,o
relse0.*/staticifindex_tgetsockopt_ipv4_ifindex(structmsghdr*msgh){/*XXX:initial
izetozero?(Alwaysoverwritten,sojustcosmetic.)*/ifindex_tifindex=-1;#ifdefined(IP
_PKTINFO)/*Linuxpktinfobasedifindexretrieval*/structin_pktinfo*pktinfo;pktinfo=(
structin_pktinfo*)getsockopt_cmsg_data(msgh,IPPROTO_IP,IP_PKTINFO);/*XXXCanpktin
fobeNULL?Cleanuppost0.98.*/ifindex=pktinfo->ipi_ifindex;#elifdefined(IP_RECVIF)/
*retrievalbasedonIP_RECVIF*/#ifndefSUNOS_5/*BSDsystemsuseasockaddr_dlasthecontro
lmessagepayload.*/structsockaddr_dl*sdl;#else/*SUNOS_5usesanintegerwiththeindex.
*/ifindex_t*ifindex_p;#endif/*SUNOS_5*/#ifndefSUNOS_5/*BSD*/sdl=(structsockaddr_
dl*)getsockopt_cmsg_data(msgh,IPPROTO_IP,IP_RECVIF);if(sdl!=NULL)ifindex=sdl->sd
l_index;elseifindex=0;#else/**Solaris.OnSolaris8,IP_RECVIFisdefined,butthecallto
*enableitfailswitherrno=99,andthestructmsghdrhas*controllen0.*/ifindex_p=(uint_t
*)getsockopt_cmsg_data(msgh,IPPROTO_IP,IP_RECVIF);if(ifindex_p!=NULL)ifindex=*if
index_p;elseifindex=0;#endif/*SUNOS_5*/#else/**NeitherIP_PKTINFOnorIP_RECVIFdefi
ned-warnatcompiletime.*XXXDecideifthisisacoreservice,orifdaemonshavetocope.*Sinc
eSolaris8andOpenBSDseemnottoprovideit,itseemsthat*daemonshavetocope.*/#warning"g
etsockopt_ipv4_ifindex:NeitherIP_PKTINFOnorIP_RECVIFdefined."#warning"Somedaemon
smayfailtooperatecorrectly!"ifindex=0;#endif/*IP_PKTINFO*/returnifindex;}/*retur
nifindex,0ifnonefound*/ifindex_tgetsockopt_ifindex(intaf,structmsghdr*msgh){swit
ch(af){caseAF_INET:return(getsockopt_ipv4_ifindex(msgh));break;caseAF_INET6:retu
rn(getsockopt_ipv6_ifindex(msgh));break;default:zlog_warn("getsockopt_ifindex:un
knownaddressfamily%d",af);return0;}}/*swabiphbetweenordersystemusesforIP_HDRINCL
andhostorder*/voidsockopt_iphdrincl_swab_htosys(structip*iph){/*BSDandderivedtak
eiphinnetworkorder,exceptfor*ip_lenandip_off*/#ifndefHAVE_IP_HDRINCL_BSD_ORDERip
h->ip_len=htons(iph->ip_len);iph->ip_off=htons(iph->ip_off);#endif/*HAVE_IP_HDRI
NCL_BSD_ORDER*/iph->ip_id=htons(iph->ip_id);}voidsockopt_iphdrincl_swab_systoh(s
tructip*iph){#ifndefHAVE_IP_HDRINCL_BSD_ORDERiph->ip_len=ntohs(iph->ip_len);iph-
>ip_off=ntohs(iph->ip_off);#endif/*HAVE_IP_HDRINCL_BSD_ORDER*/iph->ip_id=ntohs(i
ph->ip_id);}intsockopt_tcp_rtt(intsock){#ifdefTCP_INFOstructtcp_infoti;socklen_t
len=sizeof(ti);if(getsockopt(sock,IPPROTO_TCP,TCP_INFO,&ti,&len)!=0)return0;retu
rnti.tcpi_rtt/1000;#elsereturn0;#endif}intsockopt_tcp_signature(intsock,unionsoc
kunion*su,constchar*password){#ifdefined(HAVE_TCP_MD5_LINUX24)&&defined(GNU_LINU
X)/*SupportfortheoldLinux2.4TCP-MD5patch,takenfromHassoTepper's*versionoftheQuag
gapatch(basedonworkbyRickPayne,andBruce*Simpson)*/#defineTCP_MD5_AUTH13#defineTC
P_MD5_AUTH_ADD1#defineTCP_MD5_AUTH_DEL2structtcp_rfc2385_cmd{uint8_tcommand;/*Co
mmand-Add/Delete*/uint32_taddress;/*IPV4addressassociated*/uint8_tkeylen;/*MD5Ke
ylen(doNOTassume0terminatedascii)*/void*key;/*MD5Key*/}cmd;structin_addr*addr=&s
u->sin.sin_addr;cmd.command=(password!=NULL?TCP_MD5_AUTH_ADD:TCP_MD5_AUTH_DEL);c
md.address=addr->s_addr;cmd.keylen=(password!=NULL?strlen(password):0);cmd.key=p
assword;returnsetsockopt(sock,IPPROTO_TCP,TCP_MD5_AUTH,&cmd,sizeofcmd);#elifHAVE
_DECL_TCP_MD5SIGintret;#ifndefGNU_LINUX/**XXXNeedtodoPF_KEYoperationheretoadd/re
moveanSAentry,*andadd/removeanSPentryforthispeer'spacketflowsalso.*/intmd5sig=pa
ssword&&*password?1:0;#elseintkeylen=password?strlen(password):0;structtcp_md5si
gmd5sig;unionsockunion*su2,*susock;/*Figureoutwhetherthesocketandthesockunionare
thesamefamily..*addingAF_INETtoAF_INET6needstobev4mapped,you'dthink..*/if(!(suso
ck=sockunion_getsockname(sock)))return-1;if(susock->sa.sa_family==su->sa.sa_fami
ly)su2=su;else{/*oops..*/su2=susock;if(su2->sa.sa_family==AF_INET){sockunion_fre
e(susock);return0;}/*Ifthisdoesnotwork,thenallusersofthissockoptwill*needto*diff
erentiatebetweenIPv4andIPv6,andkeepseperate*socketsfor*each.**Sadly,itdoesn'tsee
mtoworkatpresent.It'sunknown*whether*thisisabugornot.*/if(su2->sa.sa_family==AF_
INET6&&su->sa.sa_family==AF_INET){su2->sin6.sin6_family=AF_INET6;/*V4Maptheaddre
ss*/memset(&su2->sin6.sin6_addr,0,sizeof(structin6_addr));su2->sin6.sin6_addr.s6
_addr32[2]=htonl(0xffff);memcpy(&su2->sin6.sin6_addr.s6_addr32[3],&su->sin.sin_a
ddr,4);}}memset(&md5sig,0,sizeof(md5sig));memcpy(&md5sig.tcpm_addr,su2,sizeof(*s
u2));md5sig.tcpm_keylen=keylen;if(keylen)memcpy(md5sig.tcpm_key,password,keylen)
;sockunion_free(susock);#endif/*GNU_LINUX*/if((ret=setsockopt(sock,IPPROTO_TCP,T
CP_MD5SIG,&md5sig,sizeofmd5sig))<0){/*ENOENTisharmless.Itisreturnedwhenweclearap
asswordforwhichonewasnotpreviouslyset.*/if(ENOENT==errno)ret=0;elsezlog_err("soc
kopt_tcp_signature:setsockopt(%d):%s",sock,safe_strerror(errno));}returnret;#els
e/*HAVE_TCP_MD5SIG*/return-2;#endif/*!HAVE_TCP_MD5SIG*/}