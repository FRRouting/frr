/**Processidoutput.*Copyright(C)1998,1999KunihiroIshiguro**ThisfileispartofGNUZe
bra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoft
heGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,
or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuse
ful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITN
ESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshoul
dhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCO
PYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bosto
n,MA02110-1301USA*/#include<zebra.h>#include<fcntl.h>#include<log.h>#include"ver
sion.h"#include"network.h"#definePIDFILE_MASK0644pid_tpid_output(constchar*path)
{inttmp;intfd;pid_tpid;charbuf[16];structflocklock;mode_toldumask;pid=getpid();o
ldumask=umask(0777&~PIDFILE_MASK);fd=open(path,O_RDWR|O_CREAT,PIDFILE_MASK);if(f
d<0){zlog_err("Can'tcreatepidlockfile%s(%s),exiting",path,safe_strerror(errno));
umask(oldumask);exit(1);}else{size_tpidsize;umask(oldumask);memset(&lock,0,sizeo
f(lock));set_cloexec(fd);lock.l_type=F_WRLCK;lock.l_whence=SEEK_SET;if(fcntl(fd,
F_SETLK,&lock)<0){zlog_err("Couldnotlockpid_file%s(%s),exiting",path,safe_strerr
or(errno));exit(1);}sprintf(buf,"%d\n",(int)pid);pidsize=strlen(buf);if((tmp=wri
te(fd,buf,pidsize))!=(int)pidsize)zlog_err("Couldnotwritepid%dtopid_file%s,rcwas
%d:%s",(int)pid,path,tmp,safe_strerror(errno));elseif(ftruncate(fd,pidsize)<0)zl
og_err("Couldnottruncatepid_file%sto%ubytes:%s",path,(unsignedint)pidsize,safe_s
trerror(errno));}returnpid;}