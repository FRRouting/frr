/**NSfunctions.*Copyright(C)20146WINDS.A.**ThisfileispartofGNUZebra.**GNUZebrais
freesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGeneralPubl
icLicenseaspublished*bytheFreeSoftwareFoundation;eitherversion2,or(atyour*option
)anylaterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTA
NYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULA
RPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedaco
pyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writ
etotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301US
A*/#include<zebra.h>#ifdefHAVE_NETNS#undef_GNU_SOURCE#define_GNU_SOURCE#include<
sched.h>#endif/*forbasename*/#include<libgen.h>#include"if.h"#include"ns.h"#incl
ude"log.h"#include"memory.h"#include"command.h"#include"vty.h"#include"vrf.h"DEF
INE_MTYPE_STATIC(LIB,NS,"NetNSContext")DEFINE_MTYPE_STATIC(LIB,NS_NAME,"NetNSNam
e")/*defaultNSIDvalueusedwhenVRFbackendisnotNETNS*/#defineNS_DEFAULT_INTERNAL0st
aticinlineintns_compare(conststructns*ns,conststructns*ns2);staticstructns*ns_lo
okup_name_internal(constchar*name);RB_GENERATE(ns_head,ns,entry,ns_compare)struc
tns_headns_tree=RB_INITIALIZER(&ns_tree);staticstructns*default_ns;staticintns_c
urrent_ns_fd;staticintns_default_ns_fd;staticintns_debug;#ifndefCLONE_NEWNET#def
ineCLONE_NEWNET0x40000000/*Newnetworknamespace(lo,device,namessockets,etc)*/#end
if#ifndefHAVE_SETNSstaticinlineintsetns(intfd,intnstype){#ifdef__NR_setnsreturns
yscall(__NR_setns,fd,nstype);#elseerrno=EINVAL;return-1;#endif}#endif/*!HAVE_SET
NS*/#ifdefHAVE_NETNSstaticinthave_netns_enabled=-1;#endif/*HAVE_NETNS*//*default
NSIDvalueusedwhenVRFbackendisnotNETNS*/#defineNS_DEFAULT_INTERNAL0staticinthave_
netns(void){#ifdefHAVE_NETNSif(have_netns_enabled<0){intfd=open(NS_DEFAULT_NAME,
O_RDONLY);if(fd<0)have_netns_enabled=0;else{have_netns_enabled=1;close(fd);}}ret
urnhave_netns_enabled;#elsereturn0;#endif}/*HoldingNShooks*/structns_master{int(
*ns_new_hook)(structns*ns);int(*ns_delete_hook)(structns*ns);int(*ns_enable_hook
)(structns*ns);int(*ns_disable_hook)(structns*ns);}ns_master={0,};staticintns_is
_enabled(structns*ns);staticinlineintns_compare(conststructns*a,conststructns*b)
{return(a->ns_id-b->ns_id);}/*LookupaNSbyidentifier.*/staticstructns*ns_lookup_i
nternal(ns_id_tns_id){structnsns;ns.ns_id=ns_id;returnRB_FIND(ns_head,&ns_tree,&
ns);}/*LookupaNSbyname*/staticstructns*ns_lookup_name_internal(constchar*name){s
tructns*ns=NULL;RB_FOREACH(ns,ns_head,&ns_tree){if(ns->name!=NULL){if(strcmp(nam
e,ns->name)==0)returnns;}}returnNULL;}staticstructns*ns_get_created_internal(str
uctns*ns,char*name,ns_id_tns_id){intcreated=0;/**Initializeinterfaces.*/if(!ns&&
!name&&ns_id!=NS_UNKNOWN)ns=ns_lookup_internal(ns_id);if(!ns&&name)ns=ns_lookup_
name_internal(name);if(!ns){ns=XCALLOC(MTYPE_NS,sizeof(structns));ns->ns_id=ns_i
d;if(name)ns->name=XSTRDUP(MTYPE_NS_NAME,name);ns->fd=-1;RB_INSERT(ns_head,&ns_t
ree,ns);created=1;}if(ns_id!=ns->ns_id){RB_REMOVE(ns_head,&ns_tree,ns);ns->ns_id
=ns_id;RB_INSERT(ns_head,&ns_tree,ns);}if(!created)returnns;if(ns_debug){if(ns->
ns_id!=NS_UNKNOWN)zlog_info("NS%uiscreated.",ns->ns_id);elsezlog_info("NS%siscre
ated.",ns->name);}if(ns_master.ns_new_hook)(*ns_master.ns_new_hook)(ns);returnns
;}/**EnableaNS-thatis,lettheNSbereadytouse.*TheNS_ENABLE_HOOKcallbackwillbecalle
dtoinform*thattheycanallocateresourcesinthisNS.**RETURN:1-enabledsuccessfully;ot
herwise,0.*/staticintns_enable_internal(structns*ns,void(*func)(ns_id_t,void*)){
if(!ns_is_enabled(ns)){if(have_netns()){ns->fd=open(ns->name,O_RDONLY);}else{ns-
>fd=-2;/*Rememberns_enable_hookhasbeencalled*/errno=-ENOTSUP;}if(!ns_is_enabled(
ns)){zlog_err("CannotenableNS%u:%s!",ns->ns_id,safe_strerror(errno));return0;}/*
NondefaultNS.leave*/if(ns->ns_id==NS_UNKNOWN){zlog_err("CannotenableNS%s%u:Inval
idNSID",ns->name,ns->ns_id);return0;}if(func)func(ns->ns_id,(void*)ns->vrf_ctxt)
;if(ns_debug){if(have_netns())zlog_info("NS%uisassociatedwithNETNS%s.",ns->ns_id
,ns->name);zlog_info("NS%uisenabled.",ns->ns_id);}/*zebrafirstreceivesNSenableev
ent,*thenVRFenableevent*/if(ns_master.ns_enable_hook)(*ns_master.ns_enable_hook)
(ns);}return1;}/**CheckwhethertheNSisenabled-thatis,whethertheNS*isreadytoalloca
teresources.Currentlythere'sonlyone*typeofresource:socket.*/staticintns_is_enabl
ed(structns*ns){if(have_netns())returnns&&ns->fd>=0;elsereturnns&&ns->fd==-2&&ns
->ns_id==NS_DEFAULT;}/**DisableaNS-thatis,lettheNSbeunusable.*TheNS_DELETE_HOOKc
allbackwillbecalledtoinform*thattheymustreleasetheresourcesintheNS.*/staticvoidn
s_disable_internal(structns*ns){if(ns_is_enabled(ns)){if(ns_debug)zlog_info("NS%
uistobedisabled.",ns->ns_id);if(ns_master.ns_disable_hook)(*ns_master.ns_disable
_hook)(ns);if(have_netns())close(ns->fd);ns->fd=-1;}}structns*ns_get_created(str
uctns*ns,char*name,ns_id_tns_id){returnns_get_created_internal(ns,name,ns_id);}i
ntns_have_netns(void){returnhave_netns();}/*DeleteaNS.Thisiscalledinns_terminate
().*/voidns_delete(structns*ns){if(ns_debug)zlog_info("NS%uistobedeleted.",ns->n
s_id);ns_disable(ns);if(ns_master.ns_delete_hook)(*ns_master.ns_delete_hook)(ns)
;/**I'mnotentirelysureifthevrf->iflist*needstobemovedintohereornot.*///if_termin
ate(&ns->iflist);RB_REMOVE(ns_head,&ns_tree,ns);if(ns->name)XFREE(MTYPE_NS_NAME,
ns->name);XFREE(MTYPE_NS,ns);}/*LookupthedatapointerofthespecifiedVRF.*/void*ns_
info_lookup(ns_id_tns_id){structns*ns=ns_lookup_internal(ns_id);returnns?ns->inf
o:NULL;}/*LookupaNSbyname*/structns*ns_lookup_name(constchar*name){returnns_look
up_name_internal(name);}intns_enable(structns*ns,void(*func)(ns_id_t,void*)){ret
urnns_enable_internal(ns,func);}voidns_disable(structns*ns){returnns_disable_int
ernal(ns);}structns*ns_lookup(ns_id_tns_id){returnns_lookup_internal(ns_id);}voi
dns_walk_func(int(*func)(structns*)){structns*ns=NULL;RB_FOREACH(ns,ns_head,&ns_
tree)func(ns);}constchar*ns_get_name(structns*ns){if(!ns)returnNULL;returnns->na
me;}/*AddaNShook.Pleaseaddhooksbeforecallingns_init().*/voidns_add_hook(inttype,
int(*func)(structns*)){switch(type){caseNS_NEW_HOOK:ns_master.ns_new_hook=func;b
reak;caseNS_DELETE_HOOK:ns_master.ns_delete_hook=func;break;caseNS_ENABLE_HOOK:n
s_master.ns_enable_hook=func;break;caseNS_DISABLE_HOOK:ns_master.ns_disable_hook
=func;break;default:break;}}/**NSrealizationwithNETNS*/char*ns_netns_pathname(st
ructvty*vty,constchar*name){staticcharpathname[PATH_MAX];char*result;char*check_
base;if(name[0]=='/')/*absolutepathname*/result=realpath(name,pathname);else{/*r
elevantpathname*/chartmp_name[PATH_MAX];snprintf(tmp_name,PATH_MAX,"%s/%s",NS_RU
N_DIR,name);result=realpath(tmp_name,pathname);}if(!result){if(vty)vty_out(vty,"
Invalidpathname:%s\n",safe_strerror(errno));elsezlog_warn("Invalidpathname:%s",s
afe_strerror(errno));returnNULL;}check_base=basename(pathname);if(check_base!=NU
LL&&strlen(check_base)+1>NS_NAMSIZ){if(vty)vty_out(vty,"NSname(%s)invalid:toolon
g(>%d)\n",check_base,NS_NAMSIZ-1);elsezlog_warn("NSname(%s)invalid:toolong(>%d)"
,check_base,NS_NAMSIZ-1);returnNULL;}returnpathname;}voidns_init(void){staticint
ns_initialised;ns_debug=0;/*silentlyreturnasinitialisationdone*/if(ns_initialise
d==1)return;errno=0;#ifdefHAVE_NETNSif(have_netns_enabled<0)ns_default_ns_fd=ope
n(NS_DEFAULT_NAME,O_RDONLY);else{ns_default_ns_fd=-1;default_ns=NULL;}#elsens_de
fault_ns_fd=-1;default_ns=NULL;#endif/*HAVE_NETNS*/if(ns_default_ns_fd==-1)zlog_
err("NSinitialisationfailure(%s)",safe_strerror(errno));ns_current_ns_fd=-1;ns_i
nitialised=1;}/*InitializeNSmodule.*/voidns_init_management(ns_id_tdefault_ns_id
){intfd;ns_init();default_ns=ns_get_created_internal(NULL,NULL,default_ns_id);if
(!default_ns){zlog_err("%s:failedtocreatethedefaultNS!",__func__);exit(1);}if(ha
ve_netns()){fd=open(NS_DEFAULT_NAME,O_RDONLY);default_ns->fd=fd;}/*Setthedefault
NSname.*/default_ns->name=XSTRDUP(MTYPE_NS_NAME,NS_DEFAULT_NAME);if(ns_debug)zlo
g_info("%s:defaultNSIDis%u",__func__,default_ns->ns_id);/*EnablethedefaultNS.*/i
f(!ns_enable(default_ns,NULL)){zlog_err("%s:failedtoenablethedefaultNS!",__func_
_);exit(1);}}/*TerminateNSmodule.*/voidns_terminate(void){structns*ns;while(!RB_
EMPTY(ns_head,&ns_tree)){ns=RB_ROOT(ns_head,&ns_tree);ns_delete(ns);}}intns_swit
ch_to_netns(constchar*name){intret;intfd;if(name==NULL)return-1;if(ns_default_ns
_fd==-1)return-1;fd=open(name,O_RDONLY);if(fd==-1){errno=EINVAL;return-1;}ret=se
tns(fd,CLONE_NEWNET);ns_current_ns_fd=fd;close(fd);returnret;}/*returns1ifswitch
()wasnotcalledbefore*returnstatusofsetns()otherwise*/intns_switchback_to_initial
(void){if(ns_current_ns_fd!=-1&&ns_default_ns_fd!=-1){intret;ret=setns(ns_defaul
t_ns_fd,CLONE_NEWNET);ns_current_ns_fd=-1;returnret;}/*silentlyignoreifsetns()is
notcalled*/return1;}/*CreateasocketfortheNS.*/intns_socket(intdomain,inttype,int
protocol,ns_id_tns_id){structns*ns=ns_lookup(ns_id);intret;if(!ns||!ns_is_enable
d(ns)){errno=EINVAL;return-1;}if(have_netns()){ret=(ns_id!=NS_DEFAULT)?setns(ns-
>fd,CLONE_NEWNET):0;if(ret>=0){ret=socket(domain,type,protocol);if(ns_id!=NS_DEF
AULT){setns(ns_lookup(NS_DEFAULT)->fd,CLONE_NEWNET);ns_current_ns_fd=ns_id;}}}el
seret=socket(domain,type,protocol);returnret;}ns_id_tns_get_default_id(void){if(
default_ns)returndefault_ns->ns_id;returnNS_DEFAULT_INTERNAL;}