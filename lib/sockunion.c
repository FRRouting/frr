/*Socketunionrelatedfunction.*Copyright(c)1997,98KunihiroIshiguro**Thisfileispar
tofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthe
termsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherv
ersion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitw
illbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILI
TYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**
YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seet
hefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFlo
or,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"vty.h"#in
clude"sockunion.h"#include"memory.h"#include"log.h"#include"jhash.h"DEFINE_MTYPE
_STATIC(LIB,SOCKUNION,"Socketunion")constchar*inet_sutop(constunionsockunion*su,
char*str){switch(su->sa.sa_family){caseAF_INET:inet_ntop(AF_INET,&su->sin.sin_ad
dr,str,INET_ADDRSTRLEN);break;caseAF_INET6:inet_ntop(AF_INET6,&su->sin6.sin6_add
r,str,INET6_ADDRSTRLEN);break;}returnstr;}intstr2sockunion(constchar*str,unionso
ckunion*su){intret;memset(su,0,sizeof(unionsockunion));ret=inet_pton(AF_INET,str
,&su->sin.sin_addr);if(ret>0)/*ValidIPv4addressformat.*/{su->sin.sin_family=AF_I
NET;#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENsu->sin.sin_len=sizeof(structsockaddr_i
n);#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*/return0;}ret=inet_pton(AF_INET6,str,
&su->sin6.sin6_addr);if(ret>0)/*ValidIPv6addressformat.*/{su->sin6.sin6_family=A
F_INET6;#ifdefSIN6_LENsu->sin6.sin6_len=sizeof(structsockaddr_in6);#endif/*SIN6_
LEN*/return0;}return-1;}constchar*sockunion2str(constunionsockunion*su,char*buf,
size_tlen){switch(sockunion_family(su)){caseAF_UNSPEC:snprintf(buf,len,"(unspec)
");returnbuf;caseAF_INET:returninet_ntop(AF_INET,&su->sin.sin_addr,buf,len);case
AF_INET6:returninet_ntop(AF_INET6,&su->sin6.sin6_addr,buf,len);}snprintf(buf,len
,"(af%d)",sockunion_family(su));returnbuf;}unionsockunion*sockunion_str2su(const
char*str){unionsockunion*su=XCALLOC(MTYPE_SOCKUNION,sizeof(unionsockunion));if(!
str2sockunion(str,su))returnsu;XFREE(MTYPE_SOCKUNION,su);returnNULL;}/*ConvertIP
v4compatibleIPv6addresstoIPv4address.*/staticvoidsockunion_normalise_mapped(unio
nsockunion*su){structsockaddr_insin;if(su->sa.sa_family==AF_INET6&&IN6_IS_ADDR_V
4MAPPED(&su->sin6.sin6_addr)){memset(&sin,0,sizeof(structsockaddr_in));sin.sin_f
amily=AF_INET;sin.sin_port=su->sin6.sin6_port;memcpy(&sin.sin_addr,((char*)&su->
sin6.sin6_addr)+12,4);memcpy(su,&sin,sizeof(structsockaddr_in));}}/*returnsockun
ionstructure:thisfunctionshouldberevised.*/staticconstchar*sockunion_log(constun
ionsockunion*su,char*buf,size_tlen){switch(su->sa.sa_family){caseAF_INET:returni
net_ntop(AF_INET,&su->sin.sin_addr,buf,len);caseAF_INET6:returninet_ntop(AF_INET
6,&(su->sin6.sin6_addr),buf,len);break;default:snprintf(buf,len,"af_unknown%d",s
u->sa.sa_family);returnbuf;}}/*Returnsocketofsockunion.*/intsockunion_socket(con
stunionsockunion*su){intsock;sock=socket(su->sa.sa_family,SOCK_STREAM,0);if(sock
<0){charbuf[SU_ADDRSTRLEN];zlog_warn("Can'tmakesocketfor%s:%s",sockunion_log(su,
buf,SU_ADDRSTRLEN),safe_strerror(errno));return-1;}returnsock;}/*Returnacceptedn
ewsocketfiledescriptor.*/intsockunion_accept(intsock,unionsockunion*su){socklen_
tlen;intclient_sock;len=sizeof(unionsockunion);client_sock=accept(sock,(structso
ckaddr*)su,&len);sockunion_normalise_mapped(su);returnclient_sock;}/*Returnsizeo
funionsockunion.*/staticintsockunion_sizeof(constunionsockunion*su){intret;ret=0
;switch(su->sa.sa_family){caseAF_INET:ret=sizeof(structsockaddr_in);break;caseAF
_INET6:ret=sizeof(structsockaddr_in6);break;}returnret;}/*Performsanon-blockingc
onnect().*/enumconnect_resultsockunion_connect(intfd,constunionsockunion*peersu,
unsignedshortport,ifindex_tifindex){intret;unionsockunionsu;memcpy(&su,peersu,si
zeof(unionsockunion));switch(su.sa.sa_family){caseAF_INET:su.sin.sin_port=port;b
reak;caseAF_INET6:su.sin6.sin6_port=port;#ifdefKAMEif(IN6_IS_ADDR_LINKLOCAL(&su.
sin6.sin6_addr)&&ifindex){su.sin6.sin6_scope_id=ifindex;SET_IN6_LINKLOCAL_IFINDE
X(su.sin6.sin6_addr,ifindex);}#endif/*KAME*/break;}/*Callconnectfunction.*/ret=c
onnect(fd,(structsockaddr*)&su,sockunion_sizeof(&su));/*Immediatesuccess*/if(ret
==0)returnconnect_success;/*Ifconnectisinprogressthenreturn1elseit'srealerror.*/
if(ret<0){if(errno!=EINPROGRESS){charstr[SU_ADDRSTRLEN];zlog_info("can'tconnectt
o%sfd%d:%s",sockunion_log(&su,str,sizeofstr),fd,safe_strerror(errno));returnconn
ect_error;}}returnconnect_in_progress;}/*Makesocketfromsockunionunion.*/intsocku
nion_stream_socket(unionsockunion*su){intsock;if(su->sa.sa_family==0)su->sa.sa_f
amily=AF_INET_UNION;sock=socket(su->sa.sa_family,SOCK_STREAM,0);if(sock<0)zlog_w
arn("can'tmakesocketsockunion_stream_socket");returnsock;}/*Bindsockettospecifie
daddress.*/intsockunion_bind(intsock,unionsockunion*su,unsignedshortport,unionso
ckunion*su_addr){intsize=0;intret;if(su->sa.sa_family==AF_INET){size=sizeof(stru
ctsockaddr_in);su->sin.sin_port=htons(port);#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LE
Nsu->sin.sin_len=size;#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*/if(su_addr==NULL)
sockunion2ip(su)=htonl(INADDR_ANY);}elseif(su->sa.sa_family==AF_INET6){size=size
of(structsockaddr_in6);su->sin6.sin6_port=htons(port);#ifdefSIN6_LENsu->sin6.sin
6_len=size;#endif/*SIN6_LEN*/if(su_addr==NULL){#ifdefLINUX_IPV6memset(&su->sin6.
sin6_addr,0,sizeof(structin6_addr));#elsesu->sin6.sin6_addr=in6addr_any;#endif/*
LINUX_IPV6*/}}ret=bind(sock,(structsockaddr*)su,size);if(ret<0){charbuf[SU_ADDRS
TRLEN];zlog_warn("can'tbindsocketfor%s:%s",sockunion_log(su,buf,SU_ADDRSTRLEN),s
afe_strerror(errno));}returnret;}intsockopt_reuseaddr(intsock){intret;inton=1;re
t=setsockopt(sock,SOL_SOCKET,SO_REUSEADDR,(void*)&on,sizeof(on));if(ret<0){zlog_
warn("can'tsetsockoptSO_REUSEADDRtosocket%d",sock);return-1;}return0;}#ifdefSO_R
EUSEPORTintsockopt_reuseport(intsock){intret;inton=1;ret=setsockopt(sock,SOL_SOC
KET,SO_REUSEPORT,(void*)&on,sizeof(on));if(ret<0){zlog_warn("can'tsetsockoptSO_R
EUSEPORTtosocket%d",sock);return-1;}return0;}#elseintsockopt_reuseport(intsock){
return0;}#endif/*0*/intsockopt_ttl(intfamily,intsock,intttl){intret;#ifdefIP_TTL
if(family==AF_INET){ret=setsockopt(sock,IPPROTO_IP,IP_TTL,(void*)&ttl,sizeof(int
));if(ret<0){zlog_warn("can'tsetsockoptIP_TTL%dtosocket%d",ttl,sock);return-1;}r
eturn0;}#endif/*IP_TTL*/if(family==AF_INET6){ret=setsockopt(sock,IPPROTO_IPV6,IP
V6_UNICAST_HOPS,(void*)&ttl,sizeof(int));if(ret<0){zlog_warn("can'tsetsockoptIPV
6_UNICAST_HOPS%dtosocket%d",ttl,sock);return-1;}return0;}return0;}/**Thisfunctio
ncalledsetsockopt(..,TCP_CORK,...)*Whichonlinuxisano-opsinceitisenabledby*defaul
tandonBSDitusesTCP_NOPUSHtodo*thesamething(whichitwasnotconfiguredto*use).Thiscl
eanupoftheapioccuredon8/1/17*Iimagineifaftermorethan1yearofno-one*complaining,an
damajorupgradereleasewe*candeprecateandremovethisfunctioncall*/intsockopt_cork(i
ntsock,intonoff){return0;}intsockopt_mark_default(intsock,intmark,structzebra_pr
ivs_t*cap){#ifdefSO_MARKintret;if(cap->change(ZPRIVS_RAISE))zlog_err("routing_so
cket:Can'traiseprivileges");ret=setsockopt(sock,SOL_SOCKET,SO_MARK,&mark,sizeof(
mark));if(cap->change(ZPRIVS_LOWER))zlog_err("routing_socket:Can'tlowerprivilege
s");returnret;#elsereturn0;#endif}intsockopt_minttl(intfamily,intsock,intminttl)
{#ifdefIP_MINTTLif(family==AF_INET){intret=setsockopt(sock,IPPROTO_IP,IP_MINTTL,
&minttl,sizeof(minttl));if(ret<0)zlog_warn("can'tsetsockoptIP_MINTTLto%donsocket
%d:%s",minttl,sock,safe_strerror(errno));returnret;}#endif/*IP_MINTTL*/#ifdefIPV
6_MINHOPCOUNTif(family==AF_INET6){intret=setsockopt(sock,IPPROTO_IPV6,IPV6_MINHO
PCOUNT,&minttl,sizeof(minttl));if(ret<0)zlog_warn("can'tsetsockoptIPV6_MINHOPCOU
NTto%donsocket%d:%s",minttl,sock,safe_strerror(errno));returnret;}#endiferrno=EO
PNOTSUPP;return-1;}intsockopt_v6only(intfamily,intsock){intret,on=1;#ifdefIPV6_V
6ONLYif(family==AF_INET6){ret=setsockopt(sock,IPPROTO_IPV6,IPV6_V6ONLY,(void*)&o
n,sizeof(int));if(ret<0){zlog_warn("can'tsetsockoptIPV6_V6ONLY""tosocket%d",sock
);return-1;}return0;}#endif/*IPV6_V6ONLY*/return0;}/*Ifsamefamilyandsameprefixre
turn1.*/intsockunion_same(constunionsockunion*su1,constunionsockunion*su2){intre
t=0;if(su1->sa.sa_family!=su2->sa.sa_family)return0;switch(su1->sa.sa_family){ca
seAF_INET:ret=memcmp(&su1->sin.sin_addr,&su2->sin.sin_addr,sizeof(structin_addr)
);break;caseAF_INET6:ret=memcmp(&su1->sin6.sin6_addr,&su2->sin6.sin6_addr,sizeof
(structin6_addr));if((ret==0)&&IN6_IS_ADDR_LINKLOCAL(&su1->sin6.sin6_addr)){/*co
mpareinterfaceindices*/if(su1->sin6.sin6_scope_id&&su2->sin6.sin6_scope_id)ret=(
su1->sin6.sin6_scope_id==su2->sin6.sin6_scope_id)?0:1;}break;}if(ret==0)return1;
elsereturn0;}unsignedintsockunion_hash(constunionsockunion*su){switch(sockunion_
family(su)){caseAF_INET:returnjhash_1word(su->sin.sin_addr.s_addr,0);caseAF_INET
6:returnjhash2(su->sin6.sin6_addr.s6_addr32,ZEBRA_NUM_OF(su->sin6.sin6_addr.s6_a
ddr32),0);}return0;}size_tfamily2addrsize(intfamily){switch(family){caseAF_INET:
returnsizeof(structin_addr);caseAF_INET6:returnsizeof(structin6_addr);}return0;}
size_tsockunion_get_addrlen(constunionsockunion*su){returnfamily2addrsize(sockun
ion_family(su));}constuint8_t*sockunion_get_addr(constunionsockunion*su){switch(
sockunion_family(su)){caseAF_INET:return(constuint8_t*)&su->sin.sin_addr.s_addr;
caseAF_INET6:return(constuint8_t*)&su->sin6.sin6_addr;}returnNULL;}voidsockunion
_set(unionsockunion*su,intfamily,constuint8_t*addr,size_tbytes){if(family2addrsi
ze(family)!=bytes)return;sockunion_family(su)=family;switch(family){caseAF_INET:
memcpy(&su->sin.sin_addr.s_addr,addr,bytes);break;caseAF_INET6:memcpy(&su->sin6.
sin6_addr,addr,bytes);break;}}/*AfterTCPconnectionisestablished.Getlocaladdressa
ndport.*/unionsockunion*sockunion_getsockname(intfd){intret;socklen_tlen;union{s
tructsockaddrsa;structsockaddr_insin;structsockaddr_in6sin6;chartmp_buffer[128];
}name;unionsockunion*su;memset(&name,0,sizeofname);len=sizeofname;ret=getsocknam
e(fd,(structsockaddr*)&name,&len);if(ret<0){zlog_warn("Can'tgetlocaladdressandpo
rtbygetsockname:%s",safe_strerror(errno));returnNULL;}if(name.sa.sa_family==AF_I
NET){su=XCALLOC(MTYPE_SOCKUNION,sizeof(unionsockunion));memcpy(su,&name,sizeof(s
tructsockaddr_in));returnsu;}if(name.sa.sa_family==AF_INET6){su=XCALLOC(MTYPE_SO
CKUNION,sizeof(unionsockunion));memcpy(su,&name,sizeof(structsockaddr_in6));sock
union_normalise_mapped(su);returnsu;}returnNULL;}/*AfterTCPconnectionisestablish
ed.Getremoteaddressandport.*/unionsockunion*sockunion_getpeername(intfd){intret;
socklen_tlen;union{structsockaddrsa;structsockaddr_insin;structsockaddr_in6sin6;
chartmp_buffer[128];}name;unionsockunion*su;memset(&name,0,sizeofname);len=sizeo
fname;ret=getpeername(fd,(structsockaddr*)&name,&len);if(ret<0){zlog_warn("Can't
getremoteaddressandport:%s",safe_strerror(errno));returnNULL;}if(name.sa.sa_fami
ly==AF_INET){su=XCALLOC(MTYPE_SOCKUNION,sizeof(unionsockunion));memcpy(su,&name,
sizeof(structsockaddr_in));returnsu;}if(name.sa.sa_family==AF_INET6){su=XCALLOC(
MTYPE_SOCKUNION,sizeof(unionsockunion));memcpy(su,&name,sizeof(structsockaddr_in
6));sockunion_normalise_mapped(su);returnsu;}returnNULL;}/*Printsockunionstructu
re*/staticvoid__attribute__((unused))sockunion_print(constunionsockunion*su){if(
su==NULL)return;switch(su->sa.sa_family){caseAF_INET:printf("%s\n",inet_ntoa(su-
>sin.sin_addr));break;caseAF_INET6:{charbuf[SU_ADDRSTRLEN];printf("%s\n",inet_nt
op(AF_INET6,&(su->sin6.sin6_addr),buf,sizeof(buf)));}break;#ifdefAF_LINKcaseAF_L
INK:{structsockaddr_dl*sdl;sdl=(structsockaddr_dl*)&(su->sa);printf("link#%d\n",
sdl->sdl_index);}break;#endif/*AF_LINK*/default:printf("af_unknown%d\n",su->sa.s
a_family);break;}}staticintin6addr_cmp(conststructin6_addr*addr1,conststructin6_
addr*addr2){unsignedinti;constuint8_t*p1,*p2;p1=(constuint8_t*)addr1;p2=(constui
nt8_t*)addr2;for(i=0;i<sizeof(structin6_addr);i++){if(p1[i]>p2[i])return1;elseif
(p1[i]<p2[i])return-1;}return0;}intsockunion_cmp(constunionsockunion*su1,constun
ionsockunion*su2){if(su1->sa.sa_family>su2->sa.sa_family)return1;if(su1->sa.sa_f
amily<su2->sa.sa_family)return-1;if(su1->sa.sa_family==AF_INET){if(ntohl(sockuni
on2ip(su1))==ntohl(sockunion2ip(su2)))return0;if(ntohl(sockunion2ip(su1))>ntohl(
sockunion2ip(su2)))return1;elsereturn-1;}if(su1->sa.sa_family==AF_INET6)returnin
6addr_cmp(&su1->sin6.sin6_addr,&su2->sin6.sin6_addr);return0;}/*Duplicatesockuni
on.*/unionsockunion*sockunion_dup(constunionsockunion*su){unionsockunion*dup=XCA
LLOC(MTYPE_SOCKUNION,sizeof(unionsockunion));memcpy(dup,su,sizeof(unionsockunion
));returndup;}voidsockunion_free(unionsockunion*su){XFREE(MTYPE_SOCKUNION,su);}v
oidsockunion_init(unionsockunion*su){memset(su,0,sizeof(unionsockunion));}