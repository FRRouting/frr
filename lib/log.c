/**Loggingofzebra*Copyright(C)1997,1998,1999KunihiroIshiguro**ThisfileispartofGN
UZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheterms
oftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversio
n2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbe
useful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorF
ITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yoush
ouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefil
eCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bo
ston,MA02110-1301USA*/#defineFRR_DEFINE_DESC_TABLE#include<zebra.h>#include"zcli
ent.h"#include"log.h"#include"log_int.h"#include"memory.h"#include"command.h"#if
ndefSUNOS_5#include<sys/un.h>#endif/*forprintstackonsolaris*/#ifdefHAVE_UCONTEXT
_H#include<ucontext.h>#endifDEFINE_MTYPE_STATIC(LIB,ZLOG,"Logging")staticintlogf
ile_fd=-1;/*Usedinsignalhandler.*/structzlog*zlog_default=NULL;boolzlog_startup_
stderr=true;/*lockprotectingzlog_defaultformt-safezlog*/pthread_mutex_tloglock=P
THREAD_MUTEX_INITIALIZER;constchar*zlog_priority[]={"emergencies","alerts","crit
ical","errors","warnings","notifications","informational","debugging",NULL,};/**
write_wrapper**glibchasdeclaredthatthereturnvaluefromwrite*must*notbe*ignored.*g
ccsee'sthisproblemandissuesawarningfortheline.**Whyisthisabigdealyousay?Becauseb
othofthemareright*andifyouhave-Werrorenabledthenallcallstowrite*generateabuilder
rorandthebuildstops.**clanghashelpfullyallowedthisconstruct:*(void)write(...)*to
tellthecompileryeahIknowithasareturnvalue*Idon'tcareaboutitatthistime.*gccdoesn'
thavethisability.**Thiscodewaswrittensuchthatitdidn'tcareaboutthe*returnvaluefro
mwrite.AtthistimedoIwant*togothroughandfixandtestthiscodeforcorrectness.*Sojustw
rapperthebadbehaviorandmoveon.*/staticvoidwrite_wrapper(intfd,constvoid*buf,size
_tcount){if(write(fd,buf,count)<=0)return;return;}/***Looksupamessageinamessagel
istbykey.**Ifthemessageisnotfound,returnstheprovidederrormessage.**Terminateswhe
nithitsastructmessagethat'sallzeros.**@parammzthemessagelist*@paramkzthemessagek
ey*@paramnfthemessagetoreturnifnotfound*@returnthemessage*/constchar*lookup_msg(
conststructmessage*mz,intkz,constchar*nf){staticstructmessagent={0};constchar*rz
=nf?nf:"(nomessagefound)";conststructmessage*pnt;for(pnt=mz;memcmp(pnt,&nt,sizeo
f(structmessage));pnt++)if(pnt->key==kz){rz=pnt->str?pnt->str:rz;break;}returnrz
;}/*Fortimestringformat.*/size_tquagga_timestamp(inttimestamp_precision,char*buf
,size_tbuflen){staticstruct{time_tlast;size_tlen;charbuf[28];}cache;structtimeva
lclock;gettimeofday(&clock,NULL);/*first,weupdatethecacheifthetimehaschanged*/if
(cache.last!=clock.tv_sec){structtm*tm;cache.last=clock.tv_sec;tm=localtime(&cac
he.last);cache.len=strftime(cache.buf,sizeof(cache.buf),"%Y/%m/%d%H:%M:%S",tm);}
/*note:it'snotworthcachingthesubsecondpart,becausechancesarethatback-to-backcall
sarenotsufficientlyclosetogetherfortheclocknottohavetickedforward*/if(buflen>cac
he.len){memcpy(buf,cache.buf,cache.len);if((timestamp_precision>0)&&(buflen>cach
e.len+1+timestamp_precision)){/*shouldweworryaboutlocaleissues?*/staticconstintd
ivisor[]={0,100000,10000,1000,100,10,1};intprec;char*p=buf+cache.len+1+(prec=tim
estamp_precision);*p--='\0';while(prec>6)/*thisisunlikelytohappen,butprotectanyw
ay*/{*p--='0';prec--;}clock.tv_usec/=divisor[prec];do{*p--='0'+(clock.tv_usec%10
);clock.tv_usec/=10;}while(--prec>0);*p='.';returncache.len+1+timestamp_precisio
n;}buf[cache.len]='\0';returncache.len;}if(buflen>0)buf[0]='\0';return0;}/*Utili
tyroutineforcurrenttimeprinting.*/staticvoidtime_print(FILE*fp,structtimestamp_c
ontrol*ctl){if(!ctl->already_rendered){ctl->len=quagga_timestamp(ctl->precision,
ctl->buf,sizeof(ctl->buf));ctl->already_rendered=1;}fprintf(fp,"%s",ctl->buf);}s
taticvoidvzlog_file(structzlog*zl,structtimestamp_control*tsctl,constchar*proto_
str,intrecord_priority,intpriority,FILE*fp,constchar*format,va_listargs){va_list
ac;time_print(fp,tsctl);if(record_priority)fprintf(fp,"%s:",zlog_priority[priori
ty]);fprintf(fp,"%s",proto_str);va_copy(ac,args);vfprintf(fp,format,ac);va_end(a
c);fprintf(fp,"\n");fflush(fp);}/*va_listversionofzlog.*/voidvzlog(intpriority,c
onstchar*format,va_listargs){pthread_mutex_lock(&loglock);charproto_str[32];into
riginal_errno=errno;structtimestamp_controltsctl;tsctl.already_rendered=0;struct
zlog*zl=zlog_default;/*Whenzlog_defaultisalsoNULL,usestderrforlogging.*/if(zl==N
ULL){tsctl.precision=0;time_print(stderr,&tsctl);fprintf(stderr,"%s:","unknown")
;vfprintf(stderr,format,args);fprintf(stderr,"\n");fflush(stderr);/*Inthiscasewe
returnathere.*/errno=original_errno;pthread_mutex_unlock(&loglock);return;}tsctl
.precision=zl->timestamp_precision;/*Syslogoutput*/if(priority<=zl->maxlvl[ZLOG_
DEST_SYSLOG]){va_listac;va_copy(ac,args);vsyslog(priority|zlog_default->facility
,format,ac);va_end(ac);}if(zl->instance)sprintf(proto_str,"%s[%d]:",zl->protonam
e,zl->instance);elsesprintf(proto_str,"%s:",zl->protoname);/*Fileoutput.*/if((pr
iority<=zl->maxlvl[ZLOG_DEST_FILE])&&zl->fp)vzlog_file(zl,&tsctl,proto_str,zl->r
ecord_priority,priority,zl->fp,format,args);/*fixed-configloggingtostderrwhilewe
'restatingup&haven't*daemonized/reachedmainloopyet**notethe"else"onstdoutoutput-
-wedon'twanttoprintthesame*messagetobothstderrandstdout.*/if(zlog_startup_stderr
&&priority<=LOG_WARNING)vzlog_file(zl,&tsctl,proto_str,1,priority,stderr,format,
args);elseif(priority<=zl->maxlvl[ZLOG_DEST_STDOUT])vzlog_file(zl,&tsctl,proto_s
tr,zl->record_priority,priority,stdout,format,args);/*Terminalmonitor.*/if(prior
ity<=zl->maxlvl[ZLOG_DEST_MONITOR])vty_log((zl->record_priority?zlog_priority[pr
iority]:NULL),proto_str,format,&tsctl,args);errno=original_errno;pthread_mutex_u
nlock(&loglock);}intvzlog_test(intpriority){pthread_mutex_lock(&loglock);intret=
0;structzlog*zl=zlog_default;/*Whenzlog_defaultisalsoNULL,usestderrforlogging.*/
if(zl==NULL)ret=1;/*Syslogoutput*/elseif(priority<=zl->maxlvl[ZLOG_DEST_SYSLOG])
ret=1;/*Fileoutput.*/elseif((priority<=zl->maxlvl[ZLOG_DEST_FILE])&&zl->fp)ret=1
;/*stdoutoutput.*/elseif(priority<=zl->maxlvl[ZLOG_DEST_STDOUT])ret=1;/*Terminal
monitor.*/elseif(priority<=zl->maxlvl[ZLOG_DEST_MONITOR])ret=1;pthread_mutex_unl
ock(&loglock);returnret;}staticchar*str_append(char*dst,intlen,constchar*src){wh
ile((len-->0)&&*src)*dst++=*src++;returndst;}staticchar*num_append(char*s,intlen
,unsignedlongx){charbuf[30];char*t;if(!x)returnstr_append(s,len,"0");*(t=&buf[si
zeof(buf)-1])='\0';while(x&&(t>buf)){*--t='0'+(x%10);x/=10;}returnstr_append(s,l
en,t);}#ifdefined(SA_SIGINFO)||defined(HAVE_STACK_TRACE)staticchar*hex_append(ch
ar*s,intlen,unsignedlongx){charbuf[30];char*t;if(!x)returnstr_append(s,len,"0");
*(t=&buf[sizeof(buf)-1])='\0';while(x&&(t>buf)){unsignedintcc=(x%16);*--t=((cc<1
0)?('0'+cc):('a'+cc-10));x/=16;}returnstr_append(s,len,t);}#endif/*Needstobeenha
ncedtosupportSolaris.*/staticintsyslog_connect(void){#ifdefSUNOS_5return-1;#else
intfd;char*s;structsockaddr_unaddr;if((fd=socket(AF_UNIX,SOCK_DGRAM,0))<0)return
-1;addr.sun_family=AF_UNIX;#ifdef_PATH_LOG#defineSYSLOG_SOCKET_PATH_PATH_LOG#els
e#defineSYSLOG_SOCKET_PATH"/dev/log"#endifs=str_append(addr.sun_path,sizeof(addr
.sun_path),SYSLOG_SOCKET_PATH);#undefSYSLOG_SOCKET_PATH*s='\0';if(connect(fd,(st
ructsockaddr*)&addr,sizeof(addr))<0){close(fd);return-1;}returnfd;#endif}staticv
oidsyslog_sigsafe(intpriority,constchar*msg,size_tmsglen){staticintsyslog_fd=-1;
charbuf[sizeof("<1234567890>ripngd[1234567890]:")+msglen+50];char*s;if((syslog_f
d<0)&&((syslog_fd=syslog_connect())<0))return;#defineLOCs,buf+sizeof(buf)-ss=buf
;s=str_append(LOC,"<");s=num_append(LOC,priority);s=str_append(LOC,">");/*forget
aboutthetimestamp,toodifficultinasignalhandler*/s=str_append(LOC,zlog_default->i
dent);if(zlog_default->syslog_options&LOG_PID){s=str_append(LOC,"[");s=num_appen
d(LOC,getpid());s=str_append(LOC,"]");}s=str_append(LOC,":");s=str_append(LOC,ms
g);write_wrapper(syslog_fd,buf,s-buf);#undefLOC}staticintopen_crashlog(void){#de
fineCRASHLOG_PREFIX"/var/tmp/quagga."#defineCRASHLOG_SUFFIX"crashlog"if(zlog_def
ault&&zlog_default->ident){/*Avoidstrlensinceitisnotasync-signal-safe.*/constcha
r*p;size_tilen;for(p=zlog_default->ident,ilen=0;*p;p++)ilen++;{charbuf[sizeof(CR
ASHLOG_PREFIX)+ilen+sizeof(CRASHLOG_SUFFIX)+3];char*s=buf;#defineLOCs,buf+sizeof
(buf)-ss=str_append(LOC,CRASHLOG_PREFIX);s=str_append(LOC,zlog_default->ident);s
=str_append(LOC,".");s=str_append(LOC,CRASHLOG_SUFFIX);#undefLOC*s='\0';returnop
en(buf,O_WRONLY|O_CREAT|O_EXCL,LOGFILE_MASK);}}returnopen(CRASHLOG_PREFIXCRASHLO
G_SUFFIX,O_WRONLY|O_CREAT|O_EXCL,LOGFILE_MASK);#undefCRASHLOG_SUFFIX#undefCRASHL
OG_PREFIX}/*Note:thegoalhereistouseonlyasync-signal-safefunctions.*/voidzlog_sig
nal(intsigno,constchar*action#ifdefSA_SIGINFO,siginfo_t*siginfo,void*program_cou
nter#endif){time_tnow;charbuf[sizeof("DEFAULT:ReceivedsignalSatT(si_addr0xP,PC0x
P);aborting...")+100];char*s=buf;char*msgstart=buf;#defineLOCs,buf+sizeof(buf)-s
time(&now);if(zlog_default){s=str_append(LOC,zlog_default->protoname);*s++=':';*
s++='';msgstart=s;}s=str_append(LOC,"Receivedsignal");s=num_append(LOC,signo);s=
str_append(LOC,"at");s=num_append(LOC,now);#ifdefSA_SIGINFOs=str_append(LOC,"(si
_addr0x");s=hex_append(LOC,(unsignedlong)(siginfo->si_addr));if(program_counter)
{s=str_append(LOC,",PC0x");s=hex_append(LOC,(unsignedlong)program_counter);}s=st
r_append(LOC,");");#else/*SA_SIGINFO*/s=str_append(LOC,";");#endif/*SA_SIGINFO*/
s=str_append(LOC,action);if(s<buf+sizeof(buf))*s++='\n';/*N.B.implicitpriorityis
mostsevere*/#definePRILOG_CRIT#defineDUMP(FD)write_wrapper(FD,buf,s-buf);/*Ifnof
ileloggingconfigured,trytowritetofallbacklogfile.*/if((logfile_fd>=0)||((logfile
_fd=open_crashlog())>=0))DUMP(logfile_fd)if(!zlog_default)DUMP(STDERR_FILENO)els
e{if(PRI<=zlog_default->maxlvl[ZLOG_DEST_STDOUT])DUMP(STDOUT_FILENO)/*Removetrai
ling'\n'formonitorandsyslog*/*--s='\0';if(PRI<=zlog_default->maxlvl[ZLOG_DEST_MO
NITOR])vty_log_fixed(buf,s-buf);if(PRI<=zlog_default->maxlvl[ZLOG_DEST_SYSLOG])s
yslog_sigsafe(PRI|zlog_default->facility,msgstart,s-msgstart);}#undefDUMPzlog_ba
cktrace_sigsafe(PRI,#ifdefSA_SIGINFOprogram_counter#elseNULL#endif);s=buf;struct
thread*tc;tc=pthread_getspecific(thread_current);if(!tc)s=str_append(LOC,"nothre
adinformationavailable\n");else{s=str_append(LOC,"inthread");s=str_append(LOC,tc
->funcname);s=str_append(LOC,"scheduledfrom");s=str_append(LOC,tc->schedfrom);s=
str_append(LOC,":");s=num_append(LOC,tc->schedfrom_line);s=str_append(LOC,"\n");
}#defineDUMP(FD)write_wrapper(FD,buf,s-buf);/*Ifnofileloggingconfigured,trytowri
tetofallbacklogfile.*/if(logfile_fd>=0)DUMP(logfile_fd)if(!zlog_default)DUMP(STD
ERR_FILENO)else{if(PRI<=zlog_default->maxlvl[ZLOG_DEST_STDOUT])DUMP(STDOUT_FILEN
O)/*Removetrailing'\n'formonitorandsyslog*/*--s='\0';if(PRI<=zlog_default->maxlv
l[ZLOG_DEST_MONITOR])vty_log_fixed(buf,s-buf);if(PRI<=zlog_default->maxlvl[ZLOG_
DEST_SYSLOG])syslog_sigsafe(PRI|zlog_default->facility,msgstart,s-msgstart);}#un
defDUMP#undefPRI#undefLOC}/*Logabacktraceusingonlyasync-signal-safefunctions.Nee
dstobeenhancedtosupportsysloglogging.*/voidzlog_backtrace_sigsafe(intpriority,vo
id*program_counter){#ifdefHAVE_STACK_TRACEstaticconstcharpclabel[]="Programcount
er:";void*array[64];intsize;charbuf[100];char*s,**bt=NULL;#defineLOCs,buf+sizeof
(buf)-s#ifdefHAVE_GLIBC_BACKTRACEsize=backtrace(array,array_size(array));if(size
<=0||(size_t)size>array_size(array))return;#defineDUMP(FD)\{\if(program_counter)
{\write_wrapper(FD,pclabel,sizeof(pclabel)-1);\backtrace_symbols_fd(&program_cou
nter,1,FD);\}\write_wrapper(FD,buf,s-buf);\backtrace_symbols_fd(array,size,FD);\
}#elifdefined(HAVE_PRINTSTACK)#defineDUMP(FD)\{\if(program_counter)\write_wrappe
r((FD),pclabel,sizeof(pclabel)-1);\write_wrapper((FD),buf,s-buf);\printstack((FD
));\}#endif/*HAVE_GLIBC_BACKTRACE,HAVE_PRINTSTACK*/s=buf;s=str_append(LOC,"Backt
racefor");s=num_append(LOC,size);s=str_append(LOC,"stackframes:\n");if((logfile_
fd>=0)||((logfile_fd=open_crashlog())>=0))DUMP(logfile_fd)if(!zlog_default)DUMP(
STDERR_FILENO)else{if(priority<=zlog_default->maxlvl[ZLOG_DEST_STDOUT])DUMP(STDO
UT_FILENO)/*Removetrailing'\n'formonitorandsyslog*/*--s='\0';if(priority<=zlog_d
efault->maxlvl[ZLOG_DEST_MONITOR])vty_log_fixed(buf,s-buf);if(priority<=zlog_def
ault->maxlvl[ZLOG_DEST_SYSLOG])syslog_sigsafe(priority|zlog_default->facility,bu
f,s-buf);{inti;#ifdefHAVE_GLIBC_BACKTRACEbt=backtrace_symbols(array,size);#endif
/*Justprintthefunctionaddresses.*/for(i=0;i<size;i++){s=buf;if(bt)s=str_append(L
OC,bt[i]);else{s=str_append(LOC,"[bt");s=num_append(LOC,i);s=str_append(LOC,"]0x
");s=hex_append(LOC,(unsignedlong)(array[i]));}*s='\0';if(priority<=zlog_default
->maxlvl[ZLOG_DEST_MONITOR])vty_log_fixed(buf,s-buf);if(priority<=zlog_default->
maxlvl[ZLOG_DEST_SYSLOG])syslog_sigsafe(priority|zlog_default->facility,buf,s-bu
f);}if(bt)free(bt);}}#undefDUMP#undefLOC#endif/*HAVE_STRACK_TRACE*/}voidzlog_bac
ktrace(intpriority){#ifndefHAVE_GLIBC_BACKTRACEzlog(priority,"Nobacktraceavailab
leonthisplatform.");#elsevoid*array[20];intsize,i;char**strings;size=backtrace(a
rray,array_size(array));if(size<=0||(size_t)size>array_size(array)){zlog_err("Ca
nnotgetbacktrace,returnedinvalid#offrames%d""(validrangeisbetween1and%lu)",size,
(unsignedlong)(array_size(array)));return;}zlog(priority,"Backtracefor%dstackfra
mes:",size);if(!(strings=backtrace_symbols(array,size))){zlog_err("Cannotgetback
tracesymbols(outofmemory?)");for(i=0;i<size;i++)zlog(priority,"[bt%d]%p",i,array
[i]);}else{for(i=0;i<size;i++)zlog(priority,"[bt%d]%s",i,strings[i]);free(string
s);}#endif/*HAVE_GLIBC_BACKTRACE*/}voidzlog(intpriority,constchar*format,...){va
_listargs;va_start(args,format);vzlog(priority,format,args);va_end(args);}#defin
eZLOG_FUNC(FUNCNAME,PRIORITY)\voidFUNCNAME(constchar*format,...)\{\va_listargs;\
va_start(args,format);\vzlog(PRIORITY,format,args);\va_end(args);\}ZLOG_FUNC(zlo
g_err,LOG_ERR)ZLOG_FUNC(zlog_warn,LOG_WARNING)ZLOG_FUNC(zlog_info,LOG_INFO)ZLOG_
FUNC(zlog_notice,LOG_NOTICE)ZLOG_FUNC(zlog_debug,LOG_DEBUG)#undefZLOG_FUNCvoidzl
og_thread_info(intlog_level){structthread*tc;tc=pthread_getspecific(thread_curre
nt);if(tc)zlog(log_level,"Currentthreadfunction%s,scheduledfrom""file%s,line%u",
tc->funcname,tc->schedfrom,tc->schedfrom_line);elsezlog(log_level,"Currentthread
notknown/applicable");}void_zlog_assert_failed(constchar*assertion,constchar*fil
e,unsignedintline,constchar*function){/*Forcefallbackfilelogging?*/if(zlog_defau
lt&&!zlog_default->fp&&((logfile_fd=open_crashlog())>=0)&&((zlog_default->fp=fdo
pen(logfile_fd,"w"))!=NULL))zlog_default->maxlvl[ZLOG_DEST_FILE]=LOG_ERR;zlog(LO
G_CRIT,"Assertion`%s'failedinfile%s,line%u,function%s",assertion,file,line,(func
tion?function:"?"));zlog_backtrace(LOG_CRIT);zlog_thread_info(LOG_CRIT);log_mems
tats(stderr,"log");abort();}voidmemory_oom(size_tsize,constchar*name){zlog_err("
outofmemory:failedtoallocate%zubytesfor%s""object",size,name);zlog_backtrace(LOG
_ERR);abort();}/*Openlogstream*/voidopenzlog(constchar*progname,constchar*proton
ame,unsignedshortinstance,intsyslog_flags,intsyslog_facility){structzlog*zl;unsi
gnedinti;zl=XCALLOC(MTYPE_ZLOG,sizeof(structzlog));zl->ident=progname;zl->proton
ame=protoname;zl->instance=instance;zl->facility=syslog_facility;zl->syslog_opti
ons=syslog_flags;/*Setdefaultlogginglevels.*/for(i=0;i<array_size(zl->maxlvl);i+
+)zl->maxlvl[i]=ZLOG_DISABLED;zl->maxlvl[ZLOG_DEST_MONITOR]=LOG_DEBUG;zl->defaul
t_lvl=LOG_DEBUG;openlog(progname,syslog_flags,zl->facility);pthread_mutex_lock(&
loglock);zlog_default=zl;pthread_mutex_unlock(&loglock);#ifdefHAVE_GLIBC_BACKTRA
CE/*workaroundbacktrace()usinglazilyresolveddynamicallylinked*symbols,whichwillo
therwisecausefunnybreakageintheSEGV*handler.*(particularly,thedynamiclinkercanca
llmalloc(),whichuseslocks*inprogramslinkedwith-pthread,thuscandeadlock.)*/void*b
t[4];backtrace(bt,array_size(bt));free(backtrace_symbols(bt,0));backtrace_symbol
s_fd(bt,0,0);#endif}voidclosezlog(void){pthread_mutex_lock(&loglock);structzlog*
zl=zlog_default;closelog();if(zl->fp!=NULL)fclose(zl->fp);if(zl->filename!=NULL)
XFREE(MTYPE_ZLOG,zl->filename);XFREE(MTYPE_ZLOG,zl);zlog_default=NULL;pthread_mu
tex_unlock(&loglock);}/*Calledfromcommand.c.*/voidzlog_set_level(zlog_dest_tdest
,intlog_level){pthread_mutex_lock(&loglock);zlog_default->maxlvl[dest]=log_level
;pthread_mutex_unlock(&loglock);}intzlog_set_file(constchar*filename,intlog_leve
l){structzlog*zl;FILE*fp;mode_toldumask;intret=1;/*Thereisopendfile.*/zlog_reset
_file();/*Openfile.*/oldumask=umask(0777&~LOGFILE_MASK);fp=fopen(filename,"a");u
mask(oldumask);if(fp==NULL){ret=0;}else{pthread_mutex_lock(&loglock);zl=zlog_def
ault;/*Setflags.*/zl->filename=XSTRDUP(MTYPE_ZLOG,filename);zl->maxlvl[ZLOG_DEST
_FILE]=log_level;zl->fp=fp;logfile_fd=fileno(fp);pthread_mutex_unlock(&loglock);
}returnret;}/*Resetopendfile.*/intzlog_reset_file(void){pthread_mutex_lock(&logl
ock);structzlog*zl=zlog_default;if(zl->fp)fclose(zl->fp);zl->fp=NULL;logfile_fd=
-1;zl->maxlvl[ZLOG_DEST_FILE]=ZLOG_DISABLED;if(zl->filename)XFREE(MTYPE_ZLOG,zl-
>filename);zl->filename=NULL;pthread_mutex_unlock(&loglock);return1;}/*Reopenlog
file.*/intzlog_rotate(void){pthread_mutex_lock(&loglock);structzlog*zl=zlog_defa
ult;intlevel;intret=1;if(zl->fp)fclose(zl->fp);zl->fp=NULL;logfile_fd=-1;level=z
l->maxlvl[ZLOG_DEST_FILE];zl->maxlvl[ZLOG_DEST_FILE]=ZLOG_DISABLED;if(zl->filena
me){mode_toldumask;intsave_errno;oldumask=umask(0777&~LOGFILE_MASK);zl->fp=fopen
(zl->filename,"a");save_errno=errno;umask(oldumask);if(zl->fp==NULL){zlog_err("L
ogrotatefailed:cannotopenfile%sforappend:%s",zl->filename,safe_strerror(save_err
no));ret=-1;}else{logfile_fd=fileno(zl->fp);zl->maxlvl[ZLOG_DEST_FILE]=level;}}p
thread_mutex_unlock(&loglock);returnret;}/*Wrapperaroundstrerrortohandlecasewher
eitreturnsNULL.*/constchar*safe_strerror(interrnum){constchar*s=strerror(errnum)
;return(s!=NULL)?s:"Unknownerror";}#defineDESC_ENTRY(T)[(T)]={(T),(#T),'\0'}stat
icconststructzebra_desc_tablecommand_types[]={DESC_ENTRY(ZEBRA_INTERFACE_ADD),DE
SC_ENTRY(ZEBRA_INTERFACE_DELETE),DESC_ENTRY(ZEBRA_INTERFACE_ADDRESS_ADD),DESC_EN
TRY(ZEBRA_INTERFACE_ADDRESS_DELETE),DESC_ENTRY(ZEBRA_INTERFACE_UP),DESC_ENTRY(ZE
BRA_INTERFACE_DOWN),DESC_ENTRY(ZEBRA_INTERFACE_SET_MASTER),DESC_ENTRY(ZEBRA_ROUT
E_ADD),DESC_ENTRY(ZEBRA_ROUTE_DELETE),DESC_ENTRY(ZEBRA_ROUTE_NOTIFY_OWNER),DESC_
ENTRY(ZEBRA_IPV4_ROUTE_ADD),DESC_ENTRY(ZEBRA_IPV4_ROUTE_DELETE),DESC_ENTRY(ZEBRA
_IPV6_ROUTE_ADD),DESC_ENTRY(ZEBRA_IPV6_ROUTE_DELETE),DESC_ENTRY(ZEBRA_REDISTRIBU
TE_ADD),DESC_ENTRY(ZEBRA_REDISTRIBUTE_DELETE),DESC_ENTRY(ZEBRA_REDISTRIBUTE_DEFA
ULT_ADD),DESC_ENTRY(ZEBRA_REDISTRIBUTE_DEFAULT_DELETE),DESC_ENTRY(ZEBRA_ROUTER_I
D_ADD),DESC_ENTRY(ZEBRA_ROUTER_ID_DELETE),DESC_ENTRY(ZEBRA_ROUTER_ID_UPDATE),DES
C_ENTRY(ZEBRA_HELLO),DESC_ENTRY(ZEBRA_NEXTHOP_REGISTER),DESC_ENTRY(ZEBRA_NEXTHOP
_UNREGISTER),DESC_ENTRY(ZEBRA_NEXTHOP_UPDATE),DESC_ENTRY(ZEBRA_INTERFACE_NBR_ADD
RESS_ADD),DESC_ENTRY(ZEBRA_INTERFACE_NBR_ADDRESS_DELETE),DESC_ENTRY(ZEBRA_INTERF
ACE_BFD_DEST_UPDATE),DESC_ENTRY(ZEBRA_IMPORT_ROUTE_REGISTER),DESC_ENTRY(ZEBRA_IM
PORT_ROUTE_UNREGISTER),DESC_ENTRY(ZEBRA_IMPORT_CHECK_UPDATE),DESC_ENTRY(ZEBRA_IP
V4_ROUTE_IPV6_NEXTHOP_ADD),DESC_ENTRY(ZEBRA_BFD_DEST_REGISTER),DESC_ENTRY(ZEBRA_
BFD_DEST_DEREGISTER),DESC_ENTRY(ZEBRA_BFD_DEST_UPDATE),DESC_ENTRY(ZEBRA_BFD_DEST
_REPLAY),DESC_ENTRY(ZEBRA_REDISTRIBUTE_ROUTE_ADD),DESC_ENTRY(ZEBRA_REDISTRIBUTE_
ROUTE_DEL),DESC_ENTRY(ZEBRA_VRF_UNREGISTER),DESC_ENTRY(ZEBRA_VRF_ADD),DESC_ENTRY
(ZEBRA_VRF_DELETE),DESC_ENTRY(ZEBRA_VRF_LABEL),DESC_ENTRY(ZEBRA_INTERFACE_VRF_UP
DATE),DESC_ENTRY(ZEBRA_BFD_CLIENT_REGISTER),DESC_ENTRY(ZEBRA_INTERFACE_ENABLE_RA
DV),DESC_ENTRY(ZEBRA_INTERFACE_DISABLE_RADV),DESC_ENTRY(ZEBRA_IPV4_NEXTHOP_LOOKU
P_MRIB),DESC_ENTRY(ZEBRA_INTERFACE_LINK_PARAMS),DESC_ENTRY(ZEBRA_MPLS_LABELS_ADD
),DESC_ENTRY(ZEBRA_MPLS_LABELS_DELETE),DESC_ENTRY(ZEBRA_IPMR_ROUTE_STATS),DESC_E
NTRY(ZEBRA_LABEL_MANAGER_CONNECT),DESC_ENTRY(ZEBRA_GET_LABEL_CHUNK),DESC_ENTRY(Z
EBRA_RELEASE_LABEL_CHUNK),DESC_ENTRY(ZEBRA_ADVERTISE_ALL_VNI),DESC_ENTRY(ZEBRA_A
DVERTISE_DEFAULT_GW),DESC_ENTRY(ZEBRA_ADVERTISE_SUBNET),DESC_ENTRY(ZEBRA_VNI_ADD
),DESC_ENTRY(ZEBRA_VNI_DEL),DESC_ENTRY(ZEBRA_L3VNI_ADD),DESC_ENTRY(ZEBRA_L3VNI_D
EL),DESC_ENTRY(ZEBRA_REMOTE_VTEP_ADD),DESC_ENTRY(ZEBRA_REMOTE_VTEP_DEL),DESC_ENT
RY(ZEBRA_MACIP_ADD),DESC_ENTRY(ZEBRA_MACIP_DEL),DESC_ENTRY(ZEBRA_IP_PREFIX_ROUTE
_ADD),DESC_ENTRY(ZEBRA_IP_PREFIX_ROUTE_DEL),DESC_ENTRY(ZEBRA_REMOTE_MACIP_ADD),D
ESC_ENTRY(ZEBRA_REMOTE_MACIP_DEL),DESC_ENTRY(ZEBRA_PW_ADD),DESC_ENTRY(ZEBRA_PW_D
ELETE),DESC_ENTRY(ZEBRA_PW_SET),DESC_ENTRY(ZEBRA_PW_UNSET),DESC_ENTRY(ZEBRA_PW_S
TATUS_UPDATE),DESC_ENTRY(ZEBRA_RULE_ADD),DESC_ENTRY(ZEBRA_RULE_DELETE),DESC_ENTR
Y(ZEBRA_RULE_NOTIFY_OWNER),DESC_ENTRY(ZEBRA_TABLE_MANAGER_CONNECT),DESC_ENTRY(ZE
BRA_GET_TABLE_CHUNK),DESC_ENTRY(ZEBRA_RELEASE_TABLE_CHUNK),};#undefDESC_ENTRYsta
ticconststructzebra_desc_tableunknown={0,"unknown",'?'};staticconststructzebra_d
esc_table*zroute_lookup(unsignedintzroute){unsignedinti;if(zroute>=array_size(ro
ute_types)){zlog_err("unknownzebraroutetype:%u",zroute);return&unknown;}if(zrout
e==route_types[zroute].type)return&route_types[zroute];for(i=0;i<array_size(rout
e_types);i++){if(zroute==route_types[i].type){zlog_warn("internalerror:routetype
tableoutoforder""whilesearchingfor%u,pleasenotifydevelopers",zroute);return&rout
e_types[i];}}zlog_err("internalerror:cannotfindroutetype%uintable!",zroute);retu
rn&unknown;}constchar*zebra_route_string(unsignedintzroute){returnzroute_lookup(
zroute)->string;}charzebra_route_char(unsignedintzroute){returnzroute_lookup(zro
ute)->chr;}constchar*zserv_command_string(unsignedintcommand){if(command>=array_
size(command_types)){zlog_err("unknownzservcommandtype:%u",command);returnunknow
n.string;}returncommand_types[command].string;}intproto_name2num(constchar*s){un
signedi;for(i=0;i<array_size(route_types);++i)if(strcasecmp(s,route_types[i].str
ing)==0)returnroute_types[i].type;return-1;}intproto_redistnum(intafi,constchar*
s){if(!s)return-1;if(afi==AFI_IP){if(strmatch(s,"kernel"))returnZEBRA_ROUTE_KERN
EL;elseif(strmatch(s,"connected"))returnZEBRA_ROUTE_CONNECT;elseif(strmatch(s,"s
tatic"))returnZEBRA_ROUTE_STATIC;elseif(strmatch(s,"rip"))returnZEBRA_ROUTE_RIP;
elseif(strmatch(s,"eigrp"))returnZEBRA_ROUTE_EIGRP;elseif(strmatch(s,"ospf"))ret
urnZEBRA_ROUTE_OSPF;elseif(strmatch(s,"isis"))returnZEBRA_ROUTE_ISIS;elseif(strm
atch(s,"bgp"))returnZEBRA_ROUTE_BGP;elseif(strmatch(s,"table"))returnZEBRA_ROUTE
_TABLE;elseif(strmatch(s,"vnc"))returnZEBRA_ROUTE_VNC;elseif(strmatch(s,"vnc-dir
ect"))returnZEBRA_ROUTE_VNC_DIRECT;elseif(strmatch(s,"nhrp"))returnZEBRA_ROUTE_N
HRP;elseif(strmatch(s,"babel"))returnZEBRA_ROUTE_BABEL;elseif(strmatch(s,"sharp"
))returnZEBRA_ROUTE_SHARP;}if(afi==AFI_IP6){if(strmatch(s,"kernel"))returnZEBRA_
ROUTE_KERNEL;elseif(strmatch(s,"connected"))returnZEBRA_ROUTE_CONNECT;elseif(str
match(s,"static"))returnZEBRA_ROUTE_STATIC;elseif(strmatch(s,"ripng"))returnZEBR
A_ROUTE_RIPNG;elseif(strmatch(s,"ospf6"))returnZEBRA_ROUTE_OSPF6;elseif(strmatch
(s,"isis"))returnZEBRA_ROUTE_ISIS;elseif(strmatch(s,"bgp"))returnZEBRA_ROUTE_BGP
;elseif(strmatch(s,"table"))returnZEBRA_ROUTE_TABLE;elseif(strmatch(s,"vnc"))ret
urnZEBRA_ROUTE_VNC;elseif(strmatch(s,"vnc-direct"))returnZEBRA_ROUTE_VNC_DIRECT;
elseif(strmatch(s,"nhrp"))returnZEBRA_ROUTE_NHRP;elseif(strmatch(s,"babel"))retu
rnZEBRA_ROUTE_BABEL;elseif(strmatch(s,"sharp"))returnZEBRA_ROUTE_SHARP;}return-1
;}voidzlog_hexdump(constvoid*mem,unsignedintlen){unsignedlongi=0;unsignedintj=0;
unsignedintcolumns=8;/**19bytesfor0xADDRESS:*24bytesfordata;2charsplusaspaceperd
atabyte*1byteforspace*8bytesforASCIIrepresentation*1byteforanewline*============
=========*53bytesper8bytesofdata*1bytefornullterm*/size_tbs=((len/8)+1)*53+1;cha
rbuf[bs];char*s=buf;memset(buf,0,sizeof(buf));for(i=0;i<len+((len%columns)?(colu
mns-len%columns):0);i++){/*printoffset*/if(i%columns==0)s+=snprintf(s,bs-(s-buf)
,"0x%016lx:",(unsignedlong)mem+i);/*printhexdata*/if(i<len)s+=snprintf(s,bs-(s-b
uf),"%02x",0xFF&((constchar*)mem)[i]);/*endofblock,justaligningforASCIIdump*/els
es+=snprintf(s,bs-(s-buf),"");/*printASCIIdump*/if(i%columns==(columns-1)){for(j
=i-(columns-1);j<=i;j++){/*endofblocknotreallyprinting*/if(j>=len)s+=snprintf(s,
bs-(s-buf),"");elseif(isprint((int)((constchar*)mem)[j]))s+=snprintf(s,bs-(s-buf
),"%c",0xFF&((constchar*)mem)[j]);else/*otherchar*/s+=snprintf(s,bs-(s-buf),".")
;}s+=snprintf(s,bs-(s-buf),"\n");}}zlog_debug("\n%s",buf);}constchar*zlog_saniti
ze(char*buf,size_tbufsz,constvoid*in,size_tinlen){constchar*inbuf=in;char*pos=bu
f,*end=buf+bufsz;constchar*iend=inbuf+inlen;memset(buf,0,bufsz);for(;inbuf<iend;
inbuf++){/*don'twritepartialescapesequence*/if(end-pos<5)break;if(*inbuf=='\n')s
nprintf(pos,end-pos,"\\n");elseif(*inbuf=='\r')snprintf(pos,end-pos,"\\r");elsei
f(*inbuf=='\t')snprintf(pos,end-pos,"\\t");elseif(*inbuf<''||*inbuf=='"'||*inbuf
>=127)snprintf(pos,end-pos,"\\x%02hhx",*inbuf);else*pos=*inbuf;pos+=strlen(pos);
}returnbuf;}