/*Distributelistfunctions*Copyright(C)1998,1999KunihiroIshiguro**Thisfileisparto
fGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itunderthete
rmsoftheGNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;eitherver
sion2,or(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopethatitwil
lbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITY
orFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yo
ushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethe
fileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor
,Boston,MA02110-1301USA*/#include<zebra.h>#include"hash.h"#include"if.h"#include
"filter.h"#include"command.h"#include"distribute.h"#include"memory.h"DEFINE_MTYP
E_STATIC(LIB,DISTRIBUTE,"Distributelist")DEFINE_MTYPE_STATIC(LIB,DISTRIBUTE_IFNA
ME,"Dist-listifname")DEFINE_MTYPE_STATIC(LIB,DISTRIBUTE_NAME,"Dist-listname")/*H
ashofdistributelist.*/structhash*disthash;/*Hookfunctions.*/void(*distribute_add
_hook)(structdistribute*);void(*distribute_delete_hook)(structdistribute*);stati
cstructdistribute*distribute_new(void){returnXCALLOC(MTYPE_DISTRIBUTE,sizeof(str
uctdistribute));}/*Freedistributeobject.*/staticvoiddistribute_free(structdistri
bute*dist){inti=0;if(dist->ifname)XFREE(MTYPE_DISTRIBUTE_IFNAME,dist->ifname);fo
r(i=0;i<DISTRIBUTE_MAX;i++)if(dist->list[i])XFREE(MTYPE_DISTRIBUTE_NAME,dist->li
st[i]);for(i=0;i<DISTRIBUTE_MAX;i++)if(dist->prefix[i])XFREE(MTYPE_DISTRIBUTE_NA
ME,dist->prefix[i]);XFREE(MTYPE_DISTRIBUTE,dist);}staticvoiddistribute_free_if_e
mpty(structdistribute*dist){inti;for(i=0;i<DISTRIBUTE_MAX;i++)if(dist->list[i]!=
NULL||dist->prefix[i]!=NULL)return;hash_release(disthash,dist);distribute_free(d
ist);}/*Lookupinterface'sdistributelist.*/structdistribute*distribute_lookup(con
stchar*ifname){structdistributekey;structdistribute*dist;/*temporaryreference*/k
ey.ifname=(ifname)?XSTRDUP(MTYPE_DISTRIBUTE_IFNAME,ifname):NULL;dist=hash_lookup
(disthash,&key);if(key.ifname)XFREE(MTYPE_DISTRIBUTE_IFNAME,key.ifname);returndi
st;}voiddistribute_list_add_hook(void(*func)(structdistribute*)){distribute_add_
hook=func;}voiddistribute_list_delete_hook(void(*func)(structdistribute*)){distr
ibute_delete_hook=func;}staticvoid*distribute_hash_alloc(structdistribute*arg){s
tructdistribute*dist;dist=distribute_new();if(arg->ifname)dist->ifname=XSTRDUP(M
TYPE_DISTRIBUTE_IFNAME,arg->ifname);elsedist->ifname=NULL;returndist;}/*Makenewd
istributelistandpushintohash.*/staticstructdistribute*distribute_get(constchar*i
fname){structdistributekey;structdistribute*ret;/*temporaryreference*/key.ifname
=(ifname)?XSTRDUP(MTYPE_DISTRIBUTE_IFNAME,ifname):NULL;ret=hash_get(disthash,&ke
y,(void*(*)(void*))distribute_hash_alloc);if(key.ifname)XFREE(MTYPE_DISTRIBUTE_I
FNAME,key.ifname);returnret;}staticunsignedintdistribute_hash_make(void*arg){con
ststructdistribute*dist=arg;returndist->ifname?string_hash_make(dist->ifname):0;
}/*Iftwodistribute-listhavesamevaluethenreturn1elsereturn0.Thisfunctionisusedbyh
ashpackage.*/staticintdistribute_cmp(conststructdistribute*dist1,conststructdist
ribute*dist2){if(dist1->ifname&&dist2->ifname)if(strcmp(dist1->ifname,dist2->ifn
ame)==0)return1;if(!dist1->ifname&&!dist2->ifname)return1;return0;}/*Setaccess-l
istnametothedistributelist.*/staticvoiddistribute_list_set(constchar*ifname,enum
distribute_typetype,constchar*alist_name){structdistribute*dist;dist=distribute_
get(ifname);if(dist->list[type])XFREE(MTYPE_DISTRIBUTE_NAME,dist->list[type]);di
st->list[type]=XSTRDUP(MTYPE_DISTRIBUTE_NAME,alist_name);/*Applythisdistribute-l
isttotheinterface.*/(*distribute_add_hook)(dist);}/*Unsetdistribute-list.Ifmatch
eddistribute-listexistthenreturn1.*/staticintdistribute_list_unset(constchar*ifn
ame,enumdistribute_typetype,constchar*alist_name){structdistribute*dist;dist=dis
tribute_lookup(ifname);if(!dist)return0;if(!dist->list[type])return0;if(strcmp(d
ist->list[type],alist_name)!=0)return0;XFREE(MTYPE_DISTRIBUTE_NAME,dist->list[ty
pe]);dist->list[type]=NULL;/*Applythisdistribute-listtotheinterface.*/(*distribu
te_delete_hook)(dist);/*IfalldistareNULL,thenfreedistributelist.*/distribute_fre
e_if_empty(dist);return1;}/*Setaccess-listnametothedistributelist.*/staticvoiddi
stribute_list_prefix_set(constchar*ifname,enumdistribute_typetype,constchar*plis
t_name){structdistribute*dist;dist=distribute_get(ifname);if(dist->prefix[type])
XFREE(MTYPE_DISTRIBUTE_NAME,dist->prefix[type]);dist->prefix[type]=XSTRDUP(MTYPE
_DISTRIBUTE_NAME,plist_name);/*Applythisdistribute-listtotheinterface.*/(*distri
bute_add_hook)(dist);}/*Unsetdistribute-list.Ifmatcheddistribute-listexistthenre
turn1.*/staticintdistribute_list_prefix_unset(constchar*ifname,enumdistribute_ty
petype,constchar*plist_name){structdistribute*dist;dist=distribute_lookup(ifname
);if(!dist)return0;if(!dist->prefix[type])return0;if(strcmp(dist->prefix[type],p
list_name)!=0)return0;XFREE(MTYPE_DISTRIBUTE_NAME,dist->prefix[type]);dist->pref
ix[type]=NULL;/*Applythisdistribute-listtotheinterface.*/(*distribute_delete_hoo
k)(dist);/*IfalldistareNULL,thenfreedistributelist.*/distribute_free_if_empty(di
st);return1;}DEFUN(distribute_list,distribute_list_cmd,"distribute-list[prefix]W
ORD<in|out>[WORD]","Filternetworksinroutingupdates\n""Specifyaprefix\n""Access-l
istname\n""Filterincomingroutingupdates\n""Filteroutgoingroutingupdates\n""Inter
facename\n"){intprefix=(argv[1]->type==WORD_TKN)?1:0;/*Checkofdistributelisttype
.*/enumdistribute_typetype=argv[2+prefix]->arg[0]=='i'?DISTRIBUTE_V4_IN:DISTRIBU
TE_V4_OUT;/*Setappropriatefunctioncall*/void(*distfn)(constchar*,enumdistribute_
type,constchar*)=prefix?&distribute_list_prefix_set:&distribute_list_set;/*ifint
erfaceispresent,getname*/constchar*ifname=NULL;if(argv[argc-1]->type==VARIABLE_T
KN)ifname=argv[argc-1]->arg;/*Getinterfacenamecorrespondingdistributelist.*/dist
fn(ifname,type,argv[1+prefix]->arg);returnCMD_SUCCESS;}DEFUN(ipv6_distribute_lis
t,ipv6_distribute_list_cmd,"ipv6distribute-list[prefix]WORD<in|out>[WORD]","IPv6
\n""Filternetworksinroutingupdates\n""Specifyaprefix\n""Access-listname\n""Filte
rincomingroutingupdates\n""Filteroutgoingroutingupdates\n""Interfacename\n"){int
prefix=(argv[2]->type==WORD_TKN)?1:0;/*Checkofdistributelisttype.*/enumdistribut
e_typetype=argv[3+prefix]->arg[0]=='i'?DISTRIBUTE_V6_IN:DISTRIBUTE_V6_OUT;/*Seta
ppropriatefunctioncall*/void(*distfn)(constchar*,enumdistribute_type,constchar*)
=prefix?&distribute_list_prefix_set:&distribute_list_set;/*ifinterfaceispresent,
getname*/constchar*ifname=NULL;if(argv[argc-1]->type==VARIABLE_TKN)ifname=argv[a
rgc-1]->arg;/*Getinterfacenamecorrespondingdistributelist.*/distfn(ifname,type,a
rgv[1+prefix]->arg);returnCMD_SUCCESS;}DEFUN(no_distribute_list,no_distribute_li
st_cmd,"no[ipv6]distribute-list[prefix]WORD<in|out>[WORD]",NO_STR"IPv6\n""Filter
networksinroutingupdates\n""Specifyaprefix\n""Access-listname\n""Filterincomingr
outingupdates\n""Filteroutgoingroutingupdates\n""Interfacename\n"){intipv6=strma
tch(argv[1]->text,"ipv6");intprefix=(argv[2+ipv6]->type==WORD_TKN)?1:0;intidx_al
name=2+ipv6+prefix;intidx_disttype=idx_alname+1;/*Checkofdistributelisttype.*/en
umdistribute_typedistin=(ipv6)?DISTRIBUTE_V6_IN:DISTRIBUTE_V4_IN;enumdistribute_
typedistout=(ipv6)?DISTRIBUTE_V6_OUT:DISTRIBUTE_V4_OUT;enumdistribute_typetype=a
rgv[idx_disttype]->arg[0]=='i'?distin:distout;/*Setappropriatefunctioncall*/int(
*distfn)(constchar*,enumdistribute_type,constchar*)=prefix?&distribute_list_pref
ix_unset:&distribute_list_unset;/*ifinterfaceispresent,getname*/constchar*ifname
=NULL;if(argv[argc-1]->type==VARIABLE_TKN)ifname=argv[argc-1]->arg;/*Getinterfac
enamecorrespondingdistributelist.*/intret=distfn(ifname,type,argv[2+prefix]->arg
);if(!ret){vty_out(vty,"distributelistdoesn'texist\n");returnCMD_WARNING_CONFIG_
FAILED;}returnCMD_SUCCESS;}staticintdistribute_print(structvty*vty,char*tab[],in
tis_prefix,enumdistribute_typetype,inthas_print){if(tab[type]){vty_out(vty,"%s%s
%s",has_print?",":"",is_prefix?"(prefix-list)":"",tab[type]);return1;}returnhas_
print;}intconfig_show_distribute(structvty*vty){unsignedinti;inthas_print=0;stru
cthash_backet*mp;structdistribute*dist;/*Outputfilterconfiguration.*/dist=distri
bute_lookup(NULL);vty_out(vty,"Outgoingupdatefilterlistforallinterfaceis");has_p
rint=0;if(dist){has_print=distribute_print(vty,dist->list,0,DISTRIBUTE_V4_OUT,ha
s_print);has_print=distribute_print(vty,dist->prefix,1,DISTRIBUTE_V4_OUT,has_pri
nt);has_print=distribute_print(vty,dist->list,0,DISTRIBUTE_V6_OUT,has_print);has
_print=distribute_print(vty,dist->prefix,1,DISTRIBUTE_V6_OUT,has_print);}if(has_
print)vty_out(vty,"\n");elsevty_out(vty,"notset\n");for(i=0;i<disthash->size;i++
)for(mp=disthash->index[i];mp;mp=mp->next){dist=mp->data;if(dist->ifname){vty_ou
t(vty,"%sfilteredby",dist->ifname);has_print=0;has_print=distribute_print(vty,di
st->list,0,DISTRIBUTE_V4_OUT,has_print);has_print=distribute_print(vty,dist->pre
fix,1,DISTRIBUTE_V4_OUT,has_print);has_print=distribute_print(vty,dist->list,0,D
ISTRIBUTE_V6_OUT,has_print);has_print=distribute_print(vty,dist->prefix,1,DISTRI
BUTE_V6_OUT,has_print);if(has_print)vty_out(vty,"\n");elsevty_out(vty,"nothing\n
");}}/*Inputfilterconfiguration.*/dist=distribute_lookup(NULL);vty_out(vty,"Inco
mingupdatefilterlistforallinterfaceis");has_print=0;if(dist){has_print=distribut
e_print(vty,dist->list,0,DISTRIBUTE_V4_IN,has_print);has_print=distribute_print(
vty,dist->prefix,1,DISTRIBUTE_V4_IN,has_print);has_print=distribute_print(vty,di
st->list,0,DISTRIBUTE_V6_IN,has_print);has_print=distribute_print(vty,dist->pref
ix,1,DISTRIBUTE_V6_IN,has_print);}if(has_print)vty_out(vty,"\n");elsevty_out(vty
,"notset\n");for(i=0;i<disthash->size;i++)for(mp=disthash->index[i];mp;mp=mp->ne
xt){dist=mp->data;if(dist->ifname){vty_out(vty,"%sfilteredby",dist->ifname);has_
print=0;has_print=distribute_print(vty,dist->list,0,DISTRIBUTE_V4_IN,has_print);
has_print=distribute_print(vty,dist->prefix,1,DISTRIBUTE_V4_IN,has_print);has_pr
int=distribute_print(vty,dist->list,0,DISTRIBUTE_V6_IN,has_print);has_print=dist
ribute_print(vty,dist->prefix,1,DISTRIBUTE_V6_IN,has_print);if(has_print)vty_out
(vty,"\n");elsevty_out(vty,"nothing\n");}}return0;}/*Configurationwritefunction.
*/intconfig_write_distribute(structvty*vty){unsignedinti;intj;intoutput,v6;struc
thash_backet*mp;intwrite=0;for(i=0;i<disthash->size;i++)for(mp=disthash->index[i
];mp;mp=mp->next){structdistribute*dist;dist=mp->data;for(j=0;j<DISTRIBUTE_MAX;j
++)if(dist->list[j]){output=j==DISTRIBUTE_V4_OUT||j==DISTRIBUTE_V6_OUT;v6=j==DIS
TRIBUTE_V6_IN||j==DISTRIBUTE_V6_OUT;vty_out(vty,"%sdistribute-list%s%s%s\n",v6?"
ipv6":"",dist->list[j],output?"out":"in",dist->ifname?dist->ifname:"");write++;}
for(j=0;j<DISTRIBUTE_MAX;j++)if(dist->prefix[j]){output=j==DISTRIBUTE_V4_OUT||j=
=DISTRIBUTE_V6_OUT;v6=j==DISTRIBUTE_V6_IN||j==DISTRIBUTE_V6_OUT;vty_out(vty,"%sd
istribute-listprefix%s%s%s\n",v6?"ipv6":"",dist->prefix[j],output?"out":"in",dis
t->ifname?dist->ifname:"");write++;}}returnwrite;}/*Clearalldistributelist.*/voi
ddistribute_list_reset(){hash_clean(disthash,(void(*)(void*))distribute_free);}/
*Initializedistributelistrelatedhash.*/voiddistribute_list_init(intnode){disthas
h=hash_create(distribute_hash_make,(int(*)(constvoid*,constvoid*))distribute_cmp
,NULL);/*vtyshcommand-extractiondoesn'tgrokinstall_element(node,)*/if(node==RIP_
NODE){install_element(RIP_NODE,&distribute_list_cmd);install_element(RIP_NODE,&n
o_distribute_list_cmd);}elseif(node==RIPNG_NODE){install_element(RIPNG_NODE,&dis
tribute_list_cmd);install_element(RIPNG_NODE,&no_distribute_list_cmd);}/*install
v6*/if(node==RIPNG_NODE){install_element(RIPNG_NODE,&ipv6_distribute_list_cmd);}
/*TODO:installv4syntaxcommandforv6onlyprotocols.*//*if(node==RIPNG_NODE){*instal
l_element(node,&ipv6_as_v4_distribute_list_all_cmd);*install_element(node,&no_ip
v6_as_v4_distribute_list_all_cmd);*install_element(node,&ipv6_as_v4_distribute_l
ist_cmd);*install_element(node,&no_ipv6_as_v4_distribute_list_cmd);*install_elem
ent(node,&ipv6_as_v4_distribute_list_prefix_all_cmd);*install_element(node,&no_i
pv6_as_v4_distribute_list_prefix_all_cmd);*install_element(node,&ipv6_as_v4_dist
ribute_list_prefix_cmd);*install_element(node,&no_ipv6_as_v4_distribute_list_pre
fix_cmd);}*/}