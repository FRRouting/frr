/**InputmatchingroutinesforCLIbackend.**--*Copyright(C)2016CumulusNetworks,Inc.*
*ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormod
ifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoun
dation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedin
thehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof
*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicensefor
moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withth
isprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Frank
linSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"command_match
.h"#include"memory.h"DEFINE_MTYPE_STATIC(LIB,CMD_MATCHSTACK,"CommandMatchStack")
#ifdefTRACE_MATCHER#defineTM1#else#defineTM0#endif#definetrace_matcher(...)\do{\
if(TM)\fprintf(stderr,__VA_ARGS__);\}while(0);/*matcherhelperprototypes*/statici
ntadd_nexthops(structlist*,structgraph_node*,structgraph_node**,size_t);staticen
ummatcher_rvcommand_match_r(structgraph_node*,vector,unsignedint,structgraph_nod
e**,structlist**);staticintscore_precedence(enumcmd_token_type);staticenummatch_
typemin_match_level(enumcmd_token_type);staticvoiddel_arglist(structlist*);stati
cstructcmd_token*disambiguate_tokens(structcmd_token*,structcmd_token*,char*);st
aticstructlist*disambiguate(structlist*,structlist*,vector,unsignedint);intcompa
re_completions(constvoid*,constvoid*);/*tokenmatcherprototypes*/staticenummatch_
typematch_token(structcmd_token*,char*);staticenummatch_typematch_ipv4(constchar
*);staticenummatch_typematch_ipv4_prefix(constchar*);staticenummatch_typematch_i
pv6_prefix(constchar*,bool);staticenummatch_typematch_range(structcmd_token*,con
stchar*);staticenummatch_typematch_word(structcmd_token*,constchar*);staticenumm
atch_typematch_variable(structcmd_token*,constchar*);staticenummatch_typematch_m
ac(constchar*,bool);enummatcher_rvcommand_match(structgraph*cmdgraph,vectorvline
,structlist**argv,conststructcmd_element**el){structgraph_node*stack[CMD_ARGC_MA
X];enummatcher_rvstatus;*argv=NULL;//prependadummytokentomatchthatpeskystartnode
vectorvvline=vector_init(vline->alloced+1);vector_set_index(vvline,0,(void*)XSTR
DUP(MTYPE_TMP,"dummy"));memcpy(vvline->index+1,vline->index,sizeof(void*)*vline-
>alloced);vvline->active=vline->active+1;structgraph_node*start=vector_slot(cmdg
raph->nodes,0);status=command_match_r(start,vvline,0,stack,argv);if(status==MATC
HER_OK){//successfulmatchstructlistnode*head=listhead(*argv);structlistnode*tail
=listtail(*argv);//deletedummystartnodecmd_token_del((structcmd_token*)head->dat
a);list_delete_node(*argv,head);//getcmd_elementoutoflisttail*el=listgetdata(tai
l);list_delete_node(*argv,tail);//nowargvisanorderedlistofcmd_tokenmatchingtheus
er//input,witheachcmd_token->argholdingthecorresponding//inputassert(*el);}elsei
f(*argv){del_arglist(*argv);*argv=NULL;}if(!*el){trace_matcher("Nomatch\n");}els
e{trace_matcher("Matchedcommand\n->string%s\n->desc%s\n",(*el)->string,(*el)->do
c);}//freetheleadertokenwealloc'dXFREE(MTYPE_TMP,vector_slot(vvline,0));//freeve
ctorvector_free(vvline);returnstatus;}/***BuildsanargumentlistgivenaDFAandamatch
inginputline.**Firstthefunctiondeterminesifthenodeitispassedmatchesthefirst*toke
nofinput.Ifitdoesnot,itreturnsNULL(MATCHER_NO_MATCH).Ifit*doesmatch,thenitsavest
heinputtokenastheheadofanargumentlist.**Thenextstepistoseeifthereisfurtherinputi
ntheinputline.If*thereisnot,thecurrentnode'schildrenaresearchedtoseeifanyofthem*
areleaves(typeEND_TKN).Ifthisisthecase,thenthebottomofthe*recursionstackhasbeenr
eached,theleafispushedontotheargumentlist,*thecurrentnodeispushed,andtheresultin
gargumentlistis*returned(MATCHER_OK).Ifitisnotthecase,NULLisreturned,indicating*
thatthereisnomatchfortheinputalongthispath(MATCHER_INCOMPLETE).**Ifthereisfurthe
rinput,thenthefunctionrecursesoneachofthecurrent*node'schildren,passingthemthein
putlineminusthetokenthatwasjust*matched.Foreachchild,thereturnvalueoftherecursiv
ecallis*inspected.Ifitisnull,thenthereisnomatchfortheinputalongthe*subgraphheade
dbythatchild.Ifitisnotnull,thenthereisatleastone*inputmatchinthatsubgraph(moreon
thisinamoment).**Ifarecursivecallonachildreturnsanon-nullvalue,thenithasmatched*
theinputgivenitonthesubgraphthatstartswiththatchild.However,due*totheflexibility
ofthegrammar,itissometimesthecasethattwoormore*childgraphsmatchthesameinput(twoo
rmoreoftherecursivecallshave*non-NULLreturnvalues).Thisisnotavalidstate,sinceonl
yonetrue*matchispossible.Inordertoresolvethisconflict,thefunctionkeepsa*referenc
etothechildnodethatmostspecificallymatchestheinput.This*isdonebyassigningeachnod
etypeaprecedence.Ifachildisfoundto*matchtheremaininginput,thentheprecedencevalue
softhecurrent*best-matchingchildandthisnewmatcharecompared.Thenodewithhigher*pre
cedenceiskept,andtheothermatchisdiscarded.Duetotherecursive*natureofthisfunction
,itisonlynecessarytocomparetheprecedenceof*immediatechildren,sinceallsubsequentc
hildrenwillalreadyhavebeen*disambiguatedinthisway.**Intheeventthattwochildrenare
foundtomatchwiththesameprecedence,*thentheinputisambiguousforthepassedcmd_elemen
tandNULLisreturned.**@param[in]startthestartnode.*@param[in]vlinethevectorizedin
putline.*@param[in]ntheindexofthefirstinputtoken.*@returnAlinkedlistofnelements.
Thefirstn-1elementsarepointersto*structcmd_tokenandrepresentthesequenceoftokensm
atchedbytheinput.*The->argfieldofeachtokenpointstoacopyoftheinputmatchedonit.*Th
efinalnthelementisapointertostructcmd_element,whichisthe*commandthatwasmatched.*
*Ifnomatchwasfound,thereturnvalueisNULL.*/staticenummatcher_rvcommand_match_r(st
ructgraph_node*start,vectorvline,unsignedintn,structgraph_node**stack,structlist
**currbest){assert(n<vector_active(vline));enummatcher_rvstatus=MATCHER_NO_MATCH
;//gettheminimummatchlevelthatcancountasafullmatchstructcmd_token*token=start->d
ata;enummatch_typeminmatch=min_match_level(token->type);/*checkhistory/stackofto
kens*thisdisallowsmatchingthesameonemorethanonceifthereisa*circleinthegraph(used
forkeywordarguments)*/if(n==CMD_ARGC_MAX)returnMATCHER_NO_MATCH;if(!token->allow
repeat)for(size_ts=0;s<n;s++)if(stack[s]==start)returnMATCHER_NO_MATCH;//getthec
urrentoperatinginputtokenchar*input_token=vector_slot(vline,n);#ifdefTRACE_MATCH
ERfprintf(stdout,"\"%-20s\"matches\"%-30s\"?",input_token,token->text);enummatch
_typemt=match_token(token,input_token);fprintf(stdout,"type:%d",token->type);fpr
intf(stdout,"min:%d-",minmatch);switch(mt){casetrivial_match:fprintf(stdout,"tri
vial_match");break;caseno_match:fprintf(stdout,"no_match");break;casepartly_matc
h:fprintf(stdout,"partly_match");break;caseexact_match:fprintf(stdout,"exact_mat
ch");break;}if(mt>=minmatch)fprintf(stdout,"MATCH");fprintf(stdout,"\n");#endif/
/ifwedon'tmatchthisnode,dieif(match_token(token,input_token)<minmatch)returnMATC
HER_NO_MATCH;stack[n]=start;//pointersforiteratinglinkliststructlistnode*ln;stru
ctgraph_node*gn;//getallpossiblenexthopsstructlist*next=list_new();add_nexthops(
next,start,NULL,0);//determinethebestmatchfor(ALL_LIST_ELEMENTS_RO(next,ln,gn)){
//ifwe'vematchedallinputwe'relookingforEND_TKNif(n+1==vector_active(vline)){stru
ctcmd_token*tok=gn->data;if(tok->type==END_TKN){//ifmorethanoneEND_TKNinthefollo
wsetif(*currbest){status=MATCHER_AMBIGUOUS;break;}else{status=MATCHER_OK;}*currb
est=list_new();//nodeshouldhaveonechildnodewiththe//elementstructgraph_node*leaf
=vector_slot(gn->to,0);//lastnodeinthelistwillholdthe//cmd_element;thisisimporta
ntbecause//list_delete()expectsthatallnodeshave//thesamedatatype,sowhendeletingt
his//listthelastnodemustbemanuallydeletedstructcmd_element*el=leaf->data;listnod
e_add(*currbest,el);(*currbest)->del=(void(*)(void*))&cmd_token_del;//donotbreak
immediately;continuewalking//throughthefollowsettoensurethatthere//isexactlyoneE
ND_TKN}continue;}//elserecurseoncandidatechildnodestructlist*result=NULL;enummat
cher_rvrstat=command_match_r(gn,vline,n+1,stack,&result);//savethebestmatchif(re
sult&&*currbest){//pickthebestoftwomatchesstructlist*newbest=disambiguate(*currb
est,result,vline,n+1);//currentbestandresultareambiguousif(!newbest)status=MATCH
ER_AMBIGUOUS;//currentbestisstillthebest,butambiguouselseif(newbest==*currbest&&
status==MATCHER_AMBIGUOUS)status=MATCHER_AMBIGUOUS;//resultisbetter,butalsoambig
uouselseif(newbest==result&&rstat==MATCHER_AMBIGUOUS)status=MATCHER_AMBIGUOUS;//
oneortheotherissuperiorandnotambiguouselsestatus=MATCHER_OK;//deletetheunnecessa
ryresultstructlist*todelete=((newbest&&newbest==result)?*currbest:result);del_ar
glist(todelete);*currbest=newbest?newbest:*currbest;}elseif(result){status=rstat
;*currbest=result;}elseif(!*currbest){status=MAX(rstat,status);}}if(*currbest){/
/copytoken,setargandprependtocurrbeststructcmd_token*token=start->data;structcmd
_token*copy=cmd_token_dup(token);copy->arg=XSTRDUP(MTYPE_CMD_ARG,input_token);li
stnode_add_before(*currbest,(*currbest)->head,copy);}elseif(n+1==vector_active(v
line)&&status==MATCHER_NO_MATCH)status=MATCHER_INCOMPLETE;//cleanuplist_delete_a
nd_null(&next);returnstatus;}staticvoidstack_del(void*val){XFREE(MTYPE_CMD_MATCH
STACK,val);}enummatcher_rvcommand_complete(structgraph*graph,vectorvline,structl
ist**completions){//pointertonextinputtokentomatchchar*input_token;structlist*cu
rrent=list_new(),//currentnodestomatchinputtokenagainst*next=list_new();//possib
lenexthopsaftercurrentinput//tokencurrent->del=next->del=stack_del;//pointersuse
dforiteratinglistsstructgraph_node**gstack,**newstack;structlistnode*node;//adda
llchildrenofstartnodetoliststructgraph_node*start=vector_slot(graph->nodes,0);ad
d_nexthops(next,start,&start,0);unsignedintidx;for(idx=0;idx<vector_active(vline
)&&next->count>0;idx++){list_delete_and_null(&current);current=next;next=list_ne
w();next->del=stack_del;input_token=vector_slot(vline,idx);intexact_match_exists
=0;for(ALL_LIST_ELEMENTS_RO(current,node,gstack))if(!exact_match_exists)exact_ma
tch_exists=(match_token(gstack[0]->data,input_token)==exact_match);elsebreak;for
(ALL_LIST_ELEMENTS_RO(current,node,gstack)){structcmd_token*token=gstack[0]->dat
a;if(token->attr==CMD_ATTR_HIDDEN||token->attr==CMD_ATTR_DEPRECATED)continue;enu
mmatch_typeminmatch=min_match_level(token->type);trace_matcher("\"%s\"matches\"%
s\"(%d)?",input_token,token->text,token->type);unsignedintlast_token=(vector_act
ive(vline)-1==idx);enummatch_typematchtype=match_token(token,input_token);switch
(matchtype){//occurswhenlasttokeniswhitespacecasetrivial_match:trace_matcher("tr
ivial_match\n");assert(last_token);newstack=XMALLOC(MTYPE_CMD_MATCHSTACK,sizeof(
structgraph_node*));/*we'renotrecursinghere,justthefirst*elementisOK*/newstack[0
]=gstack[0];listnode_add(next,newstack);break;casepartly_match:trace_matcher("tr
ivial_match\n");if(exact_match_exists&&!last_token)break;/*fallthru*/caseexact_m
atch:trace_matcher("exact_match\n");if(last_token){newstack=XMALLOC(MTYPE_CMD_MA
TCHSTACK,sizeof(structgraph_node*));/*sameasabove,notrecursingonthis*/newstack[0
]=gstack[0];listnode_add(next,newstack);}elseif(matchtype>=minmatch)add_nexthops
(next,gstack[0],gstack,idx+1);break;default:trace_matcher("no_match\n");break;}}
}/*Variablesummary*-------------------------------------------------------------
----*token=lastinputtokenprocessed*idx=indexin`command`oflasttokenprocessed*curr
ent=setofalltransitionsfromthepreviousinputtoken*next=setofallnodesreachablefrom
allnodesin`matched`*/enummatcher_rvmrv=idx==vector_active(vline)&&next->count?MA
TCHER_OK:MATCHER_NO_MATCH;*completions=NULL;if(!MATCHER_ERROR(mrv)){//extractcmd
_tokenintolist*completions=list_new();for(ALL_LIST_ELEMENTS_RO(next,node,gstack)
){listnode_add(*completions,gstack[0]->data);}}list_delete_and_null(&current);li
st_delete_and_null(&next);returnmrv;}/***Addsallchildrenthatarereachablebyonepar
serhoptothegivenlist.*specialtokensexceptEND_TKNaretreatedastransparent.**@param
[in]listtoaddthenexthopsto*@param[in]nodetostartcalculatingnexthopsfrom*@param[i
n]stacklistingpreviouslyvisitednodes,ifnon-NULL.*@param[in]stackposhowmanyvalide
ntriesareinstack*@returnthenumberofchildrenaddedtothelist**NB:non-null"stack"mea
nsthatnewstackswillbeaddedto"list"as*output,insteadofdirectnodepointers!*/static
intadd_nexthops(structlist*list,structgraph_node*node,structgraph_node**stack,si
ze_tstackpos){intadded=0;structgraph_node*child;structgraph_node**nextstack;for(
unsignedinti=0;i<vector_active(node->to);i++){child=vector_slot(node->to,i);size
_tj;structcmd_token*token=child->data;if(!token->allowrepeat&&stack){for(j=0;j<s
tackpos;j++)if(child==stack[j])break;if(j!=stackpos)continue;}if(token->type>=SP
ECIAL_TKN&&token->type!=END_TKN){added+=add_nexthops(list,child,stack,stackpos);
}else{if(stack){nextstack=XMALLOC(MTYPE_CMD_MATCHSTACK,(stackpos+1)*sizeof(struc
tgraph_node*));nextstack[0]=child;memcpy(nextstack+1,stack,stackpos*sizeof(struc
tgraph_node*));listnode_add(list,nextstack);}elselistnode_add(list,child);added+
+;}}returnadded;}/***Determinesthenodetypesforwhichapartialmatchmaycountasafull*
match.Enablescommandabbrevations.**@param[in]typenodetype*@returnminimummatchlev
elneededtoforatokentofullymatch*/staticenummatch_typemin_match_level(enumcmd_tok
en_typetype){switch(type){//anythingmatchesastartnode,forthesakeofrecursioncaseS
TART_TKN:returnno_match;//allowingwordstopartlymatchenablescommandabbreviationca
seWORD_TKN:returnpartly_match;default:returnexact_match;}}/***Assignsprecedences
corestonodetypes.**@param[in]typenodetypetoscore*@returnprecedencescore*/statici
ntscore_precedence(enumcmd_token_typetype){switch(type){//someofthesearemutually
exclusive,sotheyshare//thesameprecedencevaluecaseIPV4_TKN:caseIPV4_PREFIX_TKN:ca
seIPV6_TKN:caseIPV6_PREFIX_TKN:caseMAC_TKN:caseMAC_PREFIX_TKN:caseRANGE_TKN:retu
rn2;caseWORD_TKN:return3;caseVARIABLE_TKN:return4;default:return10;}}/***Picksth
ebetteroftwopossiblematchesforatoken.**@param[in]firstcandidatenodematchingtoken
*@param[in]secondcandidatenodematchingtoken*@param[in]tokenthetokenbeingmatched*
@returnthebest-matchingnode,orNULLifthetwoareentirelyambiguous*/staticstructcmd_
token*disambiguate_tokens(structcmd_token*first,structcmd_token*second,char*inpu
t_token){//ifthetypesaredifferent,simplygooffoftypeprecedenceif(first->type!=sec
ond->type){intfirstprec=score_precedence(first->type);intsecndprec=score_precede
nce(second->type);if(firstprec!=secndprec)returnfirstprec<secndprec?first:second
;elsereturnNULL;}//ifthey'rethesame,returnthemoreexactmatchenummatch_typefmtype=
match_token(first,input_token);enummatch_typesmtype=match_token(second,input_tok
en);if(fmtype!=smtype)returnfmtype>smtype?first:second;returnNULL;}/***Pickstheb
etteroftwopossiblematchesforaninputline.**@param[in]firstcandidatelistofcmd_toke
nmatchingvline*@param[in]secondcandidatelistofcmd_tokenmatchingvline*@param[in]v
linetheinputlinebeingmatched*@param[in]nindexintovlinetostartcomparingat*@return
thebest-matchinglist,orNULLifthetwoareentirelyambiguous*/staticstructlist*disamb
iguate(structlist*first,structlist*second,vectorvline,unsignedintn){//doesn'tmak
esenseforthesetobeinequallengthassert(first->count==second->count);assert(first-
>count==vector_active(vline)-n+1);structlistnode*fnode=listhead(first),*snode=li
sthead(second);structcmd_token*ftok=listgetdata(fnode),*stok=listgetdata(snode),
*best=NULL;//compareeachtoken,ifonematchesbetterusethatonefor(unsignedinti=n;i<v
ector_active(vline);i++){char*token=vector_slot(vline,i);if((best=disambiguate_t
okens(ftok,stok,token)))returnbest==ftok?first:second;fnode=listnextnode(fnode);
snode=listnextnode(snode);ftok=listgetdata(fnode);stok=listgetdata(snode);}retur
nNULL;}/**Deletionfunctionforarglist.**Sincelist->delforarglistsexpectsalllistno
de->datatoholdcmd_token,*butarglistshavecmd_elementasthedataforthetail,thisfunct
ion*manuallydeletesthetailbeforedeletingtherestofthelistasusual.**Thecmd_element
attheendis*not*acopy.Itistheoneandonly.**@paramlistthearglisttodelete*/staticvoi
ddel_arglist(structlist*list){//manuallydeletelastnodestructlistnode*tail=listta
il(list);tail->data=NULL;list_delete_node(list,tail);//deletetherestofthelistasu
suallist_delete_and_null(&list);}/*----------tokenlevelmatchingfunctions--------
--*/staticenummatch_typematch_token(structcmd_token*token,char*input_token){//no
thingtriviallymatcheseverythingif(!input_token)returntrivial_match;switch(token-
>type){caseWORD_TKN:returnmatch_word(token,input_token);caseIPV4_TKN:returnmatch
_ipv4(input_token);caseIPV4_PREFIX_TKN:returnmatch_ipv4_prefix(input_token);case
IPV6_TKN:returnmatch_ipv6_prefix(input_token,false);caseIPV6_PREFIX_TKN:returnma
tch_ipv6_prefix(input_token,true);caseRANGE_TKN:returnmatch_range(token,input_to
ken);caseVARIABLE_TKN:returnmatch_variable(token,input_token);caseMAC_TKN:return
match_mac(input_token,false);caseMAC_PREFIX_TKN:returnmatch_mac(input_token,true
);caseEND_TKN:default:returnno_match;}}#defineIPV4_ADDR_STR"0123456789."#defineI
PV4_PREFIX_STR"0123456789./"staticenummatch_typematch_ipv4(constchar*str){constc
har*sp;intdots=0,nums=0;charbuf[4];for(;;){memset(buf,0,sizeof(buf));sp=str;whil
e(*str!='\0'){if(*str=='.'){if(dots>=3)returnno_match;if(*(str+1)=='.')returnno_
match;if(*(str+1)=='\0')returnpartly_match;dots++;break;}if(!isdigit((int)*str))
returnno_match;str++;}if(str-sp>3)returnno_match;strncpy(buf,sp,str-sp);if(atoi(
buf)>255)returnno_match;nums++;if(*str=='\0')break;str++;}if(nums<4)returnpartly
_match;returnexact_match;}staticenummatch_typematch_ipv4_prefix(constchar*str){c
onstchar*sp;intdots=0;charbuf[4];for(;;){memset(buf,0,sizeof(buf));sp=str;while(
*str!='\0'&&*str!='/'){if(*str=='.'){if(dots==3)returnno_match;if(*(str+1)=='.'|
|*(str+1)=='/')returnno_match;if(*(str+1)=='\0')returnpartly_match;dots++;break;
}if(!isdigit((int)*str))returnno_match;str++;}if(str-sp>3)returnno_match;strncpy
(buf,sp,str-sp);if(atoi(buf)>255)returnno_match;if(dots==3){if(*str=='/'){if(*(s
tr+1)=='\0')returnpartly_match;str++;break;}elseif(*str=='\0')returnpartly_match
;}if(*str=='\0')returnpartly_match;str++;}sp=str;while(*str!='\0'){if(!isdigit((
int)*str))returnno_match;str++;}if(atoi(sp)>32)returnno_match;returnexact_match;
}#defineIPV6_ADDR_STR"0123456789abcdefABCDEF:."#defineIPV6_PREFIX_STR"0123456789
abcdefABCDEF:./"#defineSTATE_START1#defineSTATE_COLON2#defineSTATE_DOUBLE3#defin
eSTATE_ADDR4#defineSTATE_DOT5#defineSTATE_SLASH6#defineSTATE_MASK7staticenummatc
h_typematch_ipv6_prefix(constchar*str,boolprefix){intstate=STATE_START;intcolons
=0,nums=0,double_colon=0;intmask;constchar*sp=NULL,*start=str;char*endptr=NULL;i
f(str==NULL)returnpartly_match;if(strspn(str,prefix?IPV6_PREFIX_STR:IPV6_ADDR_ST
R)!=strlen(str))returnno_match;while(*str!='\0'&&state!=STATE_MASK){switch(state
){caseSTATE_START:if(*str==':'){if(*(str+1)!=':'&&*(str+1)!='\0')returnno_match;
colons--;state=STATE_COLON;}else{sp=str;state=STATE_ADDR;}continue;caseSTATE_COL
ON:colons++;if(*(str+1)=='/')returnno_match;elseif(*(str+1)==':')state=STATE_DOU
BLE;else{sp=str+1;state=STATE_ADDR;}break;caseSTATE_DOUBLE:if(double_colon)retur
nno_match;if(*(str+1)==':')returnno_match;else{if(*(str+1)!='\0'&&*(str+1)!='/')
colons++;sp=str+1;if(*(str+1)=='/')state=STATE_SLASH;elsestate=STATE_ADDR;}doubl
e_colon++;nums+=1;break;caseSTATE_ADDR:if(*(str+1)==':'||*(str+1)=='.'||*(str+1)
=='\0'||*(str+1)=='/'){if(str-sp>3)returnno_match;for(;sp<=str;sp++)if(*sp=='/')
returnno_match;nums++;if(*(str+1)==':')state=STATE_COLON;elseif(*(str+1)=='.'){i
f(colons||double_colon)state=STATE_DOT;elsereturnno_match;}elseif(*(str+1)=='/')
state=STATE_SLASH;}break;caseSTATE_DOT:state=STATE_ADDR;break;caseSTATE_SLASH:if
(*(str+1)=='\0')returnpartly_match;state=STATE_MASK;break;default:break;}if(nums
>11)returnno_match;if(colons>7)returnno_match;str++;}if(!prefix){structsockaddr_
in6sin6_dummy;intret=inet_pton(AF_INET6,start,&sin6_dummy.sin6_addr);returnret==
1?exact_match:partly_match;}if(state<STATE_MASK)returnpartly_match;mask=strtol(s
tr,&endptr,10);if(*endptr!='\0')returnno_match;if(mask<0||mask>128)returnno_matc
h;returnexact_match;}staticenummatch_typematch_range(structcmd_token*token,const
char*str){assert(token->type==RANGE_TKN);char*endptr=NULL;longlongval;val=strtol
l(str,&endptr,10);if(*endptr!='\0')returnno_match;if(val<token->min||val>token->
max)returnno_match;elsereturnexact_match;}staticenummatch_typematch_word(structc
md_token*token,constchar*word){assert(token->type==WORD_TKN);//ifthepassedtokeni
s0length,partlymatchif(!strlen(word))returnpartly_match;//ifthepassedtokenisstri
ctlyaprefixofthefullword,partly//matchif(strlen(word)<strlen(token->text))return
!strncmp(token->text,word,strlen(word))?partly_match:no_match;//iftheyarethesame
lengthandexactlyequal,exactmatchelseif(strlen(word)==strlen(token->text))return!
strncmp(token->text,word,strlen(word))?exact_match:no_match;returnno_match;}stat
icenummatch_typematch_variable(structcmd_token*token,constchar*word){assert(toke
n->type==VARIABLE_TKN);returnexact_match;}#defineMAC_CHARS"ABCDEFabcdef012345678
9:"staticenummatch_typematch_mac(constchar*word,boolprefix){/*62-digithexnumbers
separatedby5colons*/size_tmac_explen=6*2+5;/*'/'+2-digitinteger*/size_tmask_len=
1+2;unsignedinti;char*eptr;unsignedintmaskval;/*lengthcheck*/if(strlen(word)>mac
_explen+(prefix?mask_len:0))returnno_match;/*addresscheck*/for(i=0;i<mac_explen;
i++){if(word[i]=='\0'||!strchr(MAC_CHARS,word[i]))break;if(((i+1)%3==0)!=(word[i
]==':'))returnno_match;}/*incompleteaddress*/if(i<mac_explen&&word[i]=='\0')retu
rnpartly_match;elseif(i<mac_explen)returnno_match;/*maskcheck*/if(prefix&&word[i
]=='/'){if(word[++i]=='\0')returnpartly_match;maskval=strtoul(&word[i],&eptr,10)
;if(*eptr!='\0'||maskval>48)returnno_match;}elseif(prefix&&word[i]=='\0'){return
partly_match;}elseif(prefix){returnno_match;}returnexact_match;}