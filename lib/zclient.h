/*Zebra'sclientheader.*Copyright(C)1999KunihiroIshiguro**ThisfileispartofGNUZebr
a.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofthe
GNUGeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2,or
(atyouroption)*anylaterversion.**GNUZebraisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#ifndef_ZEBRA_ZCLIENT_H#define_ZEBRA_ZCLIENT_H/*Forstructzapi_r
oute.*/#include"prefix.h"/*Forstructinterfaceandstructconnected.*/#include"if.h"
/*Forvrf_bitmap_t.*/#include"vrf.h"/*Foruniong_addr*/#include"nexthop.h"/*Foruni
onpw_protocol_fields*/#include"pw.h"/*Forinput/outputbuffertozebra.*/#defineZEBR
A_MAX_PACKET_SIZ16384/*Zebraheadersize.*/#defineZEBRA_HEADER_SIZE10/*specialsock
etpathnametouseTCP*@isusedasfirstcharacterbecausethat'sabstractsocketnamesonLinu
x*/#defineZAPI_TCP_PATHNAME"@tcp"externstructsockaddr_storagezclient_addr;extern
socklen_tzclient_addr_len;/*Zebramessagetypes.*/typedefenum{ZEBRA_INTERFACE_ADD,
ZEBRA_INTERFACE_DELETE,ZEBRA_INTERFACE_ADDRESS_ADD,ZEBRA_INTERFACE_ADDRESS_DELET
E,ZEBRA_INTERFACE_UP,ZEBRA_INTERFACE_DOWN,ZEBRA_INTERFACE_SET_MASTER,ZEBRA_ROUTE
_ADD,ZEBRA_ROUTE_DELETE,ZEBRA_ROUTE_NOTIFY_OWNER,ZEBRA_IPV4_ROUTE_ADD,ZEBRA_IPV4
_ROUTE_DELETE,ZEBRA_IPV6_ROUTE_ADD,ZEBRA_IPV6_ROUTE_DELETE,ZEBRA_REDISTRIBUTE_AD
D,ZEBRA_REDISTRIBUTE_DELETE,ZEBRA_REDISTRIBUTE_DEFAULT_ADD,ZEBRA_REDISTRIBUTE_DE
FAULT_DELETE,ZEBRA_ROUTER_ID_ADD,ZEBRA_ROUTER_ID_DELETE,ZEBRA_ROUTER_ID_UPDATE,Z
EBRA_HELLO,ZEBRA_NEXTHOP_REGISTER,ZEBRA_NEXTHOP_UNREGISTER,ZEBRA_NEXTHOP_UPDATE,
ZEBRA_INTERFACE_NBR_ADDRESS_ADD,ZEBRA_INTERFACE_NBR_ADDRESS_DELETE,ZEBRA_INTERFA
CE_BFD_DEST_UPDATE,ZEBRA_IMPORT_ROUTE_REGISTER,ZEBRA_IMPORT_ROUTE_UNREGISTER,ZEB
RA_IMPORT_CHECK_UPDATE,ZEBRA_IPV4_ROUTE_IPV6_NEXTHOP_ADD,ZEBRA_BFD_DEST_REGISTER
,ZEBRA_BFD_DEST_DEREGISTER,ZEBRA_BFD_DEST_UPDATE,ZEBRA_BFD_DEST_REPLAY,ZEBRA_RED
ISTRIBUTE_ROUTE_ADD,ZEBRA_REDISTRIBUTE_ROUTE_DEL,ZEBRA_VRF_UNREGISTER,ZEBRA_VRF_
ADD,ZEBRA_VRF_DELETE,ZEBRA_VRF_LABEL,ZEBRA_INTERFACE_VRF_UPDATE,ZEBRA_BFD_CLIENT
_REGISTER,ZEBRA_INTERFACE_ENABLE_RADV,ZEBRA_INTERFACE_DISABLE_RADV,ZEBRA_IPV4_NE
XTHOP_LOOKUP_MRIB,ZEBRA_INTERFACE_LINK_PARAMS,ZEBRA_MPLS_LABELS_ADD,ZEBRA_MPLS_L
ABELS_DELETE,ZEBRA_IPMR_ROUTE_STATS,ZEBRA_LABEL_MANAGER_CONNECT,ZEBRA_GET_LABEL_
CHUNK,ZEBRA_RELEASE_LABEL_CHUNK,ZEBRA_FEC_REGISTER,ZEBRA_FEC_UNREGISTER,ZEBRA_FE
C_UPDATE,ZEBRA_ADVERTISE_DEFAULT_GW,ZEBRA_ADVERTISE_SUBNET,ZEBRA_ADVERTISE_ALL_V
NI,ZEBRA_VNI_ADD,ZEBRA_VNI_DEL,ZEBRA_L3VNI_ADD,ZEBRA_L3VNI_DEL,ZEBRA_REMOTE_VTEP
_ADD,ZEBRA_REMOTE_VTEP_DEL,ZEBRA_MACIP_ADD,ZEBRA_MACIP_DEL,ZEBRA_IP_PREFIX_ROUTE
_ADD,ZEBRA_IP_PREFIX_ROUTE_DEL,ZEBRA_REMOTE_MACIP_ADD,ZEBRA_REMOTE_MACIP_DEL,ZEB
RA_PW_ADD,ZEBRA_PW_DELETE,ZEBRA_PW_SET,ZEBRA_PW_UNSET,ZEBRA_PW_STATUS_UPDATE,ZEB
RA_RULE_ADD,ZEBRA_RULE_DELETE,ZEBRA_RULE_NOTIFY_OWNER,ZEBRA_TABLE_MANAGER_CONNEC
T,ZEBRA_GET_TABLE_CHUNK,ZEBRA_RELEASE_TABLE_CHUNK,}zebra_message_types_t;structr
edist_proto{uint8_tenabled;structlist*instances;};/*Structureforthezebraclient.*
/structzclient{/*Thethreadmasterwescheduleourselveson*/structthread_master*maste
r;/*Priviledgestochangesocketvalues*/structzebra_privs_t*privs;/*Dowecareaboutfa
ilureeventsforrouteinstall?*/boolreceive_notify;/*Sockettozebradaemon.*/intsock;
/*Connectionfailurecount.*/intfail;/*Inputbufferforzebramessage.*/structstream*i
buf;/*Outputbufferforzebramessage.*/structstream*obuf;/*Bufferofdatawaitingtobew
rittentozebra.*/structbuffer*wb;/*Readandconnectthread.*/structthread*t_read;str
uctthread*t_connect;/*Threadtowritebuffereddatatozebra.*/structthread*t_write;/*
Redistributeinformation.*/uint8_tredist_default;/*clientsprotocol*/unsignedshort
instance;structredist_protomi_redist[AFI_MAX][ZEBRA_ROUTE_MAX];vrf_bitmap_tredis
t[AFI_MAX][ZEBRA_ROUTE_MAX];/*Redistributedefauilt.*/vrf_bitmap_tdefault_informa
tion;/*Pointertothecallbackfunctions.*/void(*zebra_connected)(structzclient*);in
t(*router_id_update)(int,structzclient*,uint16_t,vrf_id_t);int(*interface_add)(i
nt,structzclient*,uint16_t,vrf_id_t);int(*interface_delete)(int,structzclient*,u
int16_t,vrf_id_t);int(*interface_up)(int,structzclient*,uint16_t,vrf_id_t);int(*
interface_down)(int,structzclient*,uint16_t,vrf_id_t);int(*interface_address_add
)(int,structzclient*,uint16_t,vrf_id_t);int(*interface_address_delete)(int,struc
tzclient*,uint16_t,vrf_id_t);int(*interface_link_params)(int,structzclient*,uint
16_t);int(*interface_bfd_dest_update)(int,structzclient*,uint16_t,vrf_id_t);int(
*interface_nbr_address_add)(int,structzclient*,uint16_t,vrf_id_t);int(*interface
_nbr_address_delete)(int,structzclient*,uint16_t,vrf_id_t);int(*interface_vrf_up
date)(int,structzclient*,uint16_t,vrf_id_t);int(*nexthop_update)(int,structzclie
nt*,uint16_t,vrf_id_t);int(*import_check_update)(int,structzclient*,uint16_t,vrf
_id_t);int(*bfd_dest_replay)(int,structzclient*,uint16_t,vrf_id_t);int(*redistri
bute_route_add)(int,structzclient*,uint16_t,vrf_id_t);int(*redistribute_route_de
l)(int,structzclient*,uint16_t,vrf_id_t);int(*fec_update)(int,structzclient*,uin
t16_t);int(*local_vni_add)(int,structzclient*,uint16_t,vrf_id_t);int(*local_vni_
del)(int,structzclient*,uint16_t,vrf_id_t);int(*local_l3vni_add)(int,structzclie
nt*,uint16_t,vrf_id_t);int(*local_l3vni_del)(int,structzclient*,uint16_t,vrf_id_
t);void(*local_ip_prefix_add)(int,structzclient*,uint16_t,vrf_id_t);void(*local_
ip_prefix_del)(int,structzclient*,uint16_t,vrf_id_t);int(*local_macip_add)(int,s
tructzclient*,uint16_t,vrf_id_t);int(*local_macip_del)(int,structzclient*,uint16
_t,vrf_id_t);int(*pw_status_update)(int,structzclient*,uint16_t,vrf_id_t);int(*r
oute_notify_owner)(intcommand,structzclient*zclient,uint16_tlength,vrf_id_tvrf_i
d);int(*rule_notify_owner)(intcommand,structzclient*zclient,uint16_tlength,vrf_i
d_tvrf_id);};/*ZebraAPImessageflag.*/#defineZAPI_MESSAGE_NEXTHOP0x01#defineZAPI_
MESSAGE_DISTANCE0x02#defineZAPI_MESSAGE_METRIC0x04#defineZAPI_MESSAGE_TAG0x08#de
fineZAPI_MESSAGE_MTU0x10#defineZAPI_MESSAGE_SRCPFX0x20#defineZAPI_MESSAGE_LABEL0
x40/**ThisshouldonlybeusedbyaDAEMONthatneedstocommunicate*thetablebeingusedisnot
intheVRF.Youmustpassthe*defaultvrf,elsethiswillbeignored.*/#defineZAPI_MESSAGE_T
ABLEID0x80#defineZSERV_VERSION5/*Zservprotocolmessageheader*/structzmsghdr{uint1
6_tlength;/*Alwayssetto255innewzserv*/uint8_tmarker;uint8_tversion;vrf_id_tvrf_i
d;uint16_tcommand;};structzapi_nexthop{enumnexthop_types_ttype;vrf_id_tvrf_id;if
index_tifindex;union{uniong_addrgate;enumblackhole_typebh_type;};/*MPLSlabelsfor
BGP-LUorSegmentRouting*/uint8_tlabel_num;mpls_label_tlabels[MPLS_MAX_LABELS];};/
**Someofthesedatastructuresdonotmapeasilyto*aactualdatastructuresizegivingdiffer
entcompilers*andsystems.Forthosedatastructuresweneed*tousethesmallestavailablest
ream_getX/putXfunctions*toencode/decode.*/structzapi_route{uint8_ttype;unsigneds
hortinstance;uint32_tflags;uint8_tmessage;/**Thisisanenumbutwearegoingtotreatita
sauint8_t*forpurposeofencoding/decoding*/safi_tsafi;structprefixprefix;structpre
fix_ipv6src_prefix;uint16_tnexthop_num;structzapi_nexthopnexthops[MULTIPATH_NUM]
;uint8_tdistance;uint32_tmetric;route_tag_ttag;uint32_tmtu;vrf_id_tvrf_id;uint32
_ttableid;structethaddrrmac;};/*ZebraIPv4routemessageAPI.*/structzapi_ipv4{uint8
_ttype;unsignedshortinstance;uint32_tflags;uint8_tmessage;safi_tsafi;uint8_tnext
hop_num;structin_addr**nexthop;uint8_tifindex_num;ifindex_t*ifindex;uint8_tlabel
_num;unsignedint*label;uint8_tdistance;uint32_tmetric;route_tag_ttag;uint32_tmtu
;vrf_id_tvrf_id;};structzapi_pw{charifname[IF_NAMESIZE];ifindex_tifindex;inttype
;intaf;uniong_addrnexthop;uint32_tlocal_label;uint32_tremote_label;uint8_tflags;
unionpw_protocol_fieldsdata;uint8_tprotocol;};structzapi_pw_status{charifname[IF
_NAMESIZE];ifindex_tifindex;uint32_tstatus;};enumzapi_route_notify_owner{ZAPI_RO
UTE_FAIL_INSTALL,ZAPI_ROUTE_BETTER_ADMIN_WON,ZAPI_ROUTE_INSTALLED,ZAPI_ROUTE_REM
OVED,ZAPI_ROUTE_REMOVE_FAIL,};enumzapi_rule_notify_owner{ZAPI_RULE_FAIL_INSTALL,
ZAPI_RULE_INSTALLED,ZAPI_RULE_REMOVED,};/*ZebraMACtypes*/#defineZEBRA_MACIP_TYPE
_STICKY0x01/*StickyMAC*/#defineZEBRA_MACIP_TYPE_GW0x02/*gateway(SVI)mac*/structz
client_options{boolreceive_notify;};/*Prototypesofzebraclientservicefunctions.*/
externstructzclient*zclient_new(structthread_master*);/*clang-formatoff*/#ifCONF
DATE>20181101CPP_NOTICE("zclient_new_notifycantakeoverorzclient_newnow");#endif/
*clang-formaton*/externstructzclient_optionszclient_options_default;externstruct
zclient*zclient_new_notify(structthread_master*m,structzclient_options*opt);#def
inezclient_new(A)\zclient_new_notify((A),&zclient_options_default);\CPP_WARN("Pl
easetransitiontousingzclient_new_notify");externvoidzclient_init(structzclient*,
int,unsignedshort,structzebra_privs_t*privs);externintzclient_start(structzclien
t*);externvoidzclient_stop(structzclient*);externvoidzclient_reset(structzclient
*);externvoidzclient_free(structzclient*);externintzclient_socket_connect(struct
zclient*);externunsignedshort*redist_check_instance(structredist_proto*,unsigned
short);externvoidredist_add_instance(structredist_proto*,unsignedshort);externvo
idredist_del_instance(structredist_proto*,unsignedshort);/**Sendtozebrathatthesp
ecifiedvrfisusinglabeltoresolve*itselfforL3VPN's.Repeatedcallsofthisfunctionwith
*differentlabelswillcauseaneffectiveupdateofthe*labelforlookup.IfyoupassinMPLS_L
ABEL_NONE*wewillcauseadeleteactionandremovethislabelpop*operation.**Theunderlyin
gAF_MPLSdoesn'tcareaboutafi's*butwecanmakethezebra_vrfkeeptrackofwhat*wehaveinst
alledandplaysomespecialgames*togetthembothinstalled.*/externvoidzclient_send_vrf
_label(structzclient*zclient,vrf_id_tvrf_id,afi_tafi,mpls_label_tlabel,enumlsp_t
ypes_tltype);externvoidzclient_send_reg_requests(structzclient*,vrf_id_t);extern
voidzclient_send_dereg_requests(structzclient*,vrf_id_t);externvoidzclient_send_
interface_radv_req(structzclient*zclient,vrf_id_tvrf_id,structinterface*ifp,inte
nable,intra_interval);/*Sendredistributecommandtozebradaemon.Donotupdatezclients
tate.*/externintzebra_redistribute_send(intcommand,structzclient*,afi_t,inttype,
unsignedshortinstance,vrf_id_tvrf_id);/*Ifstatehaschanged,updatestateandcallzebr
a_redistribute_send.*/externvoidzclient_redistribute(intcommand,structzclient*,a
fi_t,inttype,unsignedshortinstance,vrf_id_tvrf_id);/*Ifstatehaschanged,updatesta
teandsendthecommandtozebra.*/externvoidzclient_redistribute_default(intcommand,s
tructzclient*,vrf_id_tvrf_id);/*Sendthemessageinzclient->obuftothezebradaemon(or
enqueueit).Returns0forsuccessor-1onanI/Oerror.*/externintzclient_send_message(st
ructzclient*);/*createheaderforcommand,lengthtobefilledinbyuserlater*/externvoid
zclient_create_header(structstream*,uint16_t,vrf_id_t);/**Readsizeof(structzmsgh
dr)bytesfromtheprovidedsocketandparsethe*receiveddataintothespecifiedfields.Ifth
isissuccessful,readthe*restofthepacketintotheprovidedstream.**s*Thestreamtoreadi
nto**sock*Thesockettoreadfrom**size*Parsedmessagesizewillbeplacedinthepointed-at
integer**marker*Parsedmarkerwillbeplacedinthepointed-atbyte**version*Parsedversi
onwillbeplacedinthepointed-atbyte**vrf_id*ParsedVRFIDwillbeplacedinthepointed-at
vrf_id_t**cmd*Parsedcommandnumberwillbeplacedinthepointed-atinteger**Returns:*-1
if:*-insufficientdataforheaderwasread*-aversionmismatchwasdetected*-amarkermisma
tchwasdetected*-headersizefieldspecifiedmoredatathancouldberead*/externintzclien
t_read_header(structstream*s,intsock,uint16_t*size,uint8_t*marker,uint8_t*versio
n,vrf_id_t*vrf_id,uint16_t*cmd);/**ParseheaderfromZAPImessagestreamintostructzms
ghdr.*Thisfunctionassumesthestreamgetppointsatthefirstbyteoftheheader.*Ifthefunc
tionissuccessfulthenthestreamgetpwillpointtothebyte*immediatelyafterthelastbyteo
ftheheader.**zmsg*Thestreamcontainingtheheader**hdr*Theheaderstructtoparseinto.*
*Returns:*trueifparsingsucceeded,falseotherwise*/externboolzapi_parse_header(str
uctstream*zmsg,structzmsghdr*hdr);externvoidzclient_interface_set_master(structz
client*client,structinterface*master,structinterface*slave);externstructinterfac
e*zebra_interface_add_read(structstream*,vrf_id_t);externstructinterface*zebra_i
nterface_state_read(structstream*s,vrf_id_t);externstructconnected*zebra_interfa
ce_address_read(int,structstream*,vrf_id_t);externstructnbr_connected*zebra_inte
rface_nbr_address_read(int,structstream*,vrf_id_t);externstructinterface*zebra_i
nterface_vrf_update_read(structstream*s,vrf_id_tvrf_id,vrf_id_t*new_vrf_id);exte
rnvoidzebra_interface_if_set_value(structstream*,structinterface*);externvoidzeb
ra_router_id_update_read(structstream*s,structprefix*rid);/*clang-formatoff*/#if
CONFDATE>20180823CPP_NOTICE("zapi_ipv4_route,zapi_ipv6_route,zapi_ipv4_route_ipv
6_nexthopaswellasthezapi_ipv4andzapi_ipv6datastructuresshouldberemovednow");#end
if/*clang-formaton*/externintzapi_ipv4_route(uint8_t,structzclient*,structprefix
_ipv4*,structzapi_ipv4*)__attribute__((deprecated));externstructinterface*zebra_
interface_link_params_read(structstream*);externsize_tzebra_interface_link_param
s_write(structstream*,structinterface*);externintlm_label_manager_connect(struct
zclient*zclient);externintlm_get_label_chunk(structzclient*zclient,uint8_tkeep,u
int32_tchunk_size,uint32_t*start,uint32_t*end);externintlm_release_label_chunk(s
tructzclient*zclient,uint32_tstart,uint32_tend);externinttm_table_manager_connec
t(structzclient*zclient);externinttm_get_table_chunk(structzclient*zclient,uint3
2_tchunk_size,uint32_t*start,uint32_t*end);externinttm_release_table_chunk(struc
tzclient*zclient,uint32_tstart,uint32_tend);externintzebra_send_pw(structzclient
*zclient,intcommand,structzapi_pw*pw);externvoidzebra_read_pw_status_update(intc
ommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id,structzapi_pw_sta
tus*pw);/*IPv6prefixaddanddeletefunctionprototype.*/structzapi_ipv6{uint8_ttype;
unsignedshortinstance;uint32_tflags;uint8_tmessage;safi_tsafi;uint8_tnexthop_num
;structin6_addr**nexthop;uint8_tifindex_num;ifindex_t*ifindex;uint8_tlabel_num;u
nsignedint*label;uint8_tdistance;uint32_tmetric;route_tag_ttag;uint32_tmtu;vrf_i
d_tvrf_id;};externintzapi_ipv6_route(uint8_tcmd,structzclient*zclient,structpref
ix_ipv6*p,structprefix_ipv6*src_p,structzapi_ipv6*api)__attribute__((deprecated)
);externintzapi_ipv4_route_ipv6_nexthop(uint8_t,structzclient*,structprefix_ipv4
*,structzapi_ipv6*)__attribute__((deprecated));externintzclient_route_send(uint8
_t,structzclient*,structzapi_route*);externintzclient_send_rnh(structzclient*zcl
ient,intcommand,structprefix*p,boolexact_match,vrf_id_tvrf_id);externintzapi_rou
te_encode(uint8_t,structstream*,structzapi_route*);externintzapi_route_decode(st
ructstream*,structzapi_route*);boolzapi_route_notify_decode(structstream*s,struc
tprefix*p,uint32_t*tableid,enumzapi_route_notify_owner*note);boolzapi_rule_notif
y_decode(structstream*s,uint32_t*seqno,uint32_t*priority,uint32_t*unique,ifindex
_t*ifindex,enumzapi_rule_notify_owner*note);externstructnexthop*nexthop_from_zap
i_nexthop(structzapi_nexthop*znh);externboolzapi_nexthop_update_decode(structstr
eam*s,structzapi_route*nhr);staticinlinevoidzapi_route_set_blackhole(structzapi_
route*api,enumblackhole_typebh_type){api->nexthop_num=1;api->nexthops[0].type=NE
XTHOP_TYPE_BLACKHOLE;api->nexthops[0].vrf_id=VRF_DEFAULT;api->nexthops[0].bh_typ
e=bh_type;SET_FLAG(api->message,ZAPI_MESSAGE_NEXTHOP);};#endif/*_ZEBRA_ZCLIENT_H
*/