/*Virtualterminal[akaTeletYpe]interfaceroutine*Copyright(C)1997KunihiroIshiguro*
*ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormod
ifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoun
dation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedin
thehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof
*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicensefor
moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withth
isprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Frank
linSt,FifthFloor,Boston,MA02110-1301USA*/#ifndef_ZEBRA_VTY_H#define_ZEBRA_VTY_H#
include"thread.h"#include"log.h"#include"sockunion.h"#include"qobj.h"#include"co
mpiler.h"#defineVTY_BUFSIZ4096#defineVTY_MAXHIST20/*VTYstruct.*/structvty{/*File
descripterofthisvty.*/intfd;/*outputFD,tosupportstdin/stdoutcombination*/intwfd;
/*Isthisvtyconnecttofileornot*/enum{VTY_TERM,VTY_FILE,VTY_SHELL,VTY_SHELL_SERV}t
ype;/*Nodestatusofthisvty*/intnode;/*Failurecount*/intfail;/*Outputbuffer.*/stru
ctbuffer*obuf;/*Commandinputbuffer*/char*buf;/*Commandinputerrorbuffer*/char*err
or_buf;/*Commandcursorpoint*/intcp;/*Commandlength*/intlength;/*Commandmaxlength
.*/intmax;/*Histryofcommand*/char*hist[VTY_MAXHIST];/*Historylookupcurrentpoint*
/inthp;/*Historyinsertendpoint*/inthindex;/*qobjobjectID(replacementfor"index")*
/uint64_tqobj_index;/*qobjsecond-levelobjectID(replacementfor"index_sub")*/uint6
4_tqobj_index_sub;/*Forescapecharacter.*/unsignedcharescape;/*Currentvtystatus.*
/enum{VTY_NORMAL,VTY_CLOSE,VTY_MORE,VTY_MORELINE}status;/*IAChandling:wasthelast
characterreceivedtheIAC(interpret-as-command)escapecharacter(andthereforethenext
characterwillbethecommandcode)?RefertoTelnetRFC854.*/unsignedchariac;/*IACSB(opt
ionsubnegotiation)handling*/unsignedchariac_sb_in_progress;/*Atthemoment,wecareo
nlyabouttheNAWS(windowsize)negotiation,andthatrequiresjusta5-characterbuffer(RFC
1073):<NAWSchar><16-bitwidth><16-bitheight>*/#defineTELNET_NAWS_SB_LEN5unsignedc
harsb_buf[TELNET_NAWS_SB_LEN];/*Howmanysubnegotiationcharactershavewereceived?We
justdropthosethatdonotfitinthebuffer.*/size_tsb_len;/*Windowwidth/height.*/intwi
dth;intheight;/*Configurelines.*/intlines;/*Terminalmonitor.*/intmonitor;/*Incon
figuremode.*/intconfig;/*Readandwritethread.*/structthread*t_read;structthread*t
_write;/*Timeoutsecondsandthread.*/unsignedlongv_timeout;structthread*t_timeout;
/*Whataddressisthisvtycommingfrom.*/charaddress[SU_ADDRSTRLEN];/*"frame"output.T
hisisbufferedandwillbeprintedifsome*actualoutputfollows,orwillbediscardedifthefr
ameends*withoutanyoutput.*/size_tframe_pos;charframe[1024];};staticinlinevoidvty
_push_context(structvty*vty,intnode,uint64_tid){vty->node=node;vty->qobj_index=i
d;}/*note:VTY_PUSH_CONTEXT(...,NULL)doesn'twork,sinceitwilltryto*dereference"NUL
L->qobj_node.nid"*/#defineVTY_PUSH_CONTEXT(nodeval,ptr)\vty_push_context(vty,nod
eval,QOBJ_ID_0SAFE(ptr))#defineVTY_PUSH_CONTEXT_NULL(nodeval)vty_push_context(vt
y,nodeval,0ULL)#defineVTY_PUSH_CONTEXT_SUB(nodeval,ptr)\do{\vty->node=nodeval;\/
*qobj_indexstaysuntouched*/\vty->qobj_index_sub=QOBJ_ID_0SAFE(ptr);\}while(0)/*c
anreturnNULLifcontextisinvalid!*/#defineVTY_GET_CONTEXT(structname)\QOBJ_GET_TYP
ESAFE(vty->qobj_index,structname)#defineVTY_GET_CONTEXT_SUB(structname)\QOBJ_GET
_TYPESAFE(vty->qobj_index_sub,structname)/*willreturnifptrisNULL.*/#defineVTY_CH
ECK_CONTEXT(ptr)\if(!ptr){\vty_out(vty,\"Currentconfigurationobjectwasdeleted"\"
byanotherprocess.\n");\returnCMD_WARNING;\}/*structstructname*ptr=<context>;ptrw
illneverbeNULL.*/#defineVTY_DECLVAR_CONTEXT(structname,ptr)\structstructname*ptr
=VTY_GET_CONTEXT(structname);\VTY_CHECK_CONTEXT(ptr);#defineVTY_DECLVAR_CONTEXT_
SUB(structname,ptr)\structstructname*ptr=VTY_GET_CONTEXT_SUB(structname);\VTY_CH
ECK_CONTEXT(ptr);#defineVTY_DECLVAR_INSTANCE_CONTEXT(structname,ptr)\if(vty->qob
j_index==0)\returnCMD_NOT_MY_INSTANCE;\structstructname*ptr=VTY_GET_CONTEXT(stru
ctname);\VTY_CHECK_CONTEXT(ptr);structvty_arg{constchar*name;constchar*value;con
stchar**argv;intargc;};/*Integratedconfigurationfile.*/#defineINTEGRATE_DEFAULT_
CONFIG"frr.conf"/*Defaulttimeoutvalue*/#defineVTY_TIMEOUT_DEFAULT600/*Vtyreadbuf
fersize.*/#defineVTY_READ_BUFSIZ512/*Directoryseparator.*/#ifndefDIRECTORY_SEP#d
efineDIRECTORY_SEP'/'#endif/*DIRECTORY_SEP*/#ifndefIS_DIRECTORY_SEP#defineIS_DIR
ECTORY_SEP(c)((c)==DIRECTORY_SEP)#endif/*Exportedvariables*/externcharintegrate_
default[];/*Prototypes.*/externvoidvty_init(structthread_master*);externvoidvty_
init_vtysh(void);externvoidvty_terminate(void);externvoidvty_reset(void);externs
tructvty*vty_new(void);externstructvty*vty_stdio(void(*atclose)(intisexit));/*-v
ty_frame()outputgoestoabuffer(forcontext-beginmarkers)*-vty_out()willfirstprintt
hisbuffer,andclearit*-vty_endframe()clearsthebufferwithoutprintingit,andprintsan
*extrastringifthebufferwasemptybefore(forcontext-endmarkers)*/externintvty_out(s
tructvty*,constchar*,...)PRINTF_ATTRIBUTE(2,3);externvoidvty_frame(structvty*,co
nstchar*,...)PRINTF_ATTRIBUTE(2,3);externvoidvty_endframe(structvty*,constchar*)
;externvoidvty_read_config(constchar*,char*);externvoidvty_time_print(structvty*
,int);externvoidvty_serv_sock(constchar*,unsignedshort,constchar*);externvoidvty
_close(structvty*);externchar*vty_get_cwd(void);externvoidvty_log(constchar*leve
l,constchar*proto,constchar*fmt,structtimestamp_control*,va_list);externintvty_c
onfig_lock(structvty*);externintvty_config_unlock(structvty*);externvoidvty_conf
ig_lockless(void);externintvty_shell(structvty*);externintvty_shell_serv(structv
ty*);externvoidvty_hello(structvty*);/*^Z/SIGTSTPhandling*/externvoidvty_stdio_s
uspend(void);externvoidvty_stdio_resume(void);externvoidvty_stdio_close(void);/*
Sendafixed-sizemessagetoallvtyterminalmonitors;thisshouldbeanasync-signal-safefu
nction.*/externvoidvty_log_fixed(char*buf,size_tlen);#endif/*_ZEBRA_VTY_H*/