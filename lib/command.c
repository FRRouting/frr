/**CLIbackendinterface.**--*Copyright(C)2016CumulusNetworks,Inc.*Copyright(C)199
7,98,99KunihiroIshiguro*Copyright(C)2013byOpenSourceRouting.*Copyright(C)2013byI
nternetSystemsConsortium,Inc.("ISC")**ThisfileispartofGNUZebra.**GNUZebraisfrees
oftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLic
enseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*l
aterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWAR
RANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURP
OSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceivedacopyoft
heGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetoth
eFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#i
nclude<zebra.h>#include"memory.h"#include"log.h"#include"log_int.h"#include<lib/
version.h>#include"thread.h"#include"vector.h"#include"linklist.h"#include"vty.h
"#include"command.h"#include"workqueue.h"#include"vrf.h"#include"command_match.h
"#include"command_graph.h"#include"qobj.h"#include"defaults.h"#include"libfrr.h"
#include"jhash.h"DEFINE_MTYPE(LIB,HOST,"Hostconfig")DEFINE_MTYPE(LIB,STRVEC,"Str
ingvector")DEFINE_MTYPE(LIB,COMPLETION,"Completionitem")constchar*node_names[]={
"auth",//AUTH_NODE,"view",//VIEW_NODE,"authenable",//AUTH_ENABLE_NODE,"enable",/
/ENABLE_NODE,"config",//CONFIG_NODE,"service",//SERVICE_NODE,"debug",//DEBUG_NOD
E,"vrfdebug",//VRF_DEBUG_NODE,"vncdebug",//DEBUG_VNC_NODE,"aaa",//AAA_NODE,"keyc
hain",//KEYCHAIN_NODE,"keychainkey",//KEYCHAIN_KEY_NODE,"logical-router",//LOGIC
ALROUTER_NODE,"vrf",//VRF_NODE,"interface",//INTERFACE_NODE,"nexthop-group",//NH
_GROUP_NODE,"zebra",//ZEBRA_NODE,"table",//TABLE_NODE,"rip",//RIP_NODE,"ripng",/
/RIPNG_NODE,"babel",//BABEL_NODE,"eigrp",//EIGRP_NODE,"bgp",//BGP_NODE,"bgpvpnv4
",//BGP_VPNV4_NODE,"bgpvpnv6",//BGP_VPNV6_NODE,"bgpipv4unicast",//BGP_IPV4_NODE,
"bgpipv4multicast",//BGP_IPV4M_NODE,"bgpipv4labeledunicast",//BGP_IPV4L_NODE,"bg
pipv6",//BGP_IPV6_NODE,"bgpipv6multicast",//BGP_IPV6M_NODE,"bgpipv6labeledunicas
t",//BGP_IPV6L_NODE,"bgpvrfpolicy",//BGP_VRF_POLICY_NODE,"bgpvncdefaults",//BGP_
VNC_DEFAULTS_NODE,"bgpvncnve",//BGP_VNC_NVE_GROUP_NODE,"bgpvncl2",//BGP_VNC_L2_G
ROUP_NODE,"rfpdefaults",//RFP_DEFAULTS_NODE,"bgpevpn",//BGP_EVPN_NODE,"ospf",//O
SPF_NODE,"ospf6",//OSPF6_NODE,"ldp",//LDP_NODE,"ldpipv4",//LDP_IPV4_NODE,"ldpipv
6",//LDP_IPV6_NODE,"ldpipv4interface",//LDP_IPV4_IFACE_NODE,"ldpipv6interface",/
/LDP_IPV6_IFACE_NODE,"ldpl2vpn",//LDP_L2VPN_NODE,"ldp",//LDP_PSEUDOWIRE_NODE,"is
is",//ISIS_NODE,"masc",//MASC_NODE,"irdp",//IRDP_NODE,"staticip",//IP_NODE,"ipv4
accesslist",//ACCESS_NODE,"ipv4prefixlist",//PREFIX_NODE,"ipv6accesslist",//ACCE
SS_IPV6_NODE,"MACaccesslist",//ACCESS_MAC_NODE,"ipv6prefixlist",//PREFIX_IPV6_NO
DE,"aslist",//AS_LIST_NODE,"communitylist",//COMMUNITY_LIST_NODE,"routemap",//RM
AP_NODE,"smux",//SMUX_NODE,"dump",//DUMP_NODE,"forwarding",//FORWARDING_NODE,"pr
otocol",//PROTOCOL_NODE,"mpls",//MPLS_NODE,"pw",//PW_NODE,"vty",//VTY_NODE,"link
-params",//LINK_PARAMS_NODE,"bgpevpnvni",//BGP_EVPN_VNI_NODE,"rpki",//RPKI_NODE"
bgpipv4flowspec",/*BGP_FLOWSPECV4_NODE*/"bgpipv6flowspec",/*BGP_FLOWSPECV6_NODE*
/};/*Commandvectorwhichincludessomelevelofcommandlists.Normallyeachdaemonmaintai
nseachowncmdvec.*/vectorcmdvec=NULL;/*Hostinformationstructure.*/structhosthost;
/**Returnshost.nameifany,otherwise*itreturnsthesystemhostname.*/constchar*cmd_ho
stname_get(void){returnhost.name;}/**Returnsunixdomainname*/constchar*cmd_domain
name_get(void){returnhost.domainname;}/*Standardcommandnodestructures.*/staticst
ructcmd_nodeauth_node={AUTH_NODE,"Password:",};staticstructcmd_nodeview_node={VI
EW_NODE,"%s>",};staticstructcmd_nodeauth_enable_node={AUTH_ENABLE_NODE,"Password
:",};staticstructcmd_nodeenable_node={ENABLE_NODE,"%s#",};staticstructcmd_nodeco
nfig_node={CONFIG_NODE,"%s(config)#",1};/*Defaultmotdstring.*/staticconstchar*de
fault_motd=FRR_DEFAULT_MOTD;staticconststructfacility_map{intfacility;constchar*
name;size_tmatch;}syslog_facilities[]={{LOG_KERN,"kern",1},{LOG_USER,"user",2},{
LOG_MAIL,"mail",1},{LOG_DAEMON,"daemon",1},{LOG_AUTH,"auth",1},{LOG_SYSLOG,"sysl
og",1},{LOG_LPR,"lpr",2},{LOG_NEWS,"news",1},{LOG_UUCP,"uucp",2},{LOG_CRON,"cron
",1},#ifdefLOG_FTP{LOG_FTP,"ftp",1},#endif{LOG_LOCAL0,"local0",6},{LOG_LOCAL1,"l
ocal1",6},{LOG_LOCAL2,"local2",6},{LOG_LOCAL3,"local3",6},{LOG_LOCAL4,"local4",6
},{LOG_LOCAL5,"local5",6},{LOG_LOCAL6,"local6",6},{LOG_LOCAL7,"local7",6},{0,NUL
L,0},};staticconstchar*facility_name(intfacility){conststructfacility_map*fm;for
(fm=syslog_facilities;fm->name;fm++)if(fm->facility==facility)returnfm->name;ret
urn"";}staticintfacility_match(constchar*str){conststructfacility_map*fm;for(fm=
syslog_facilities;fm->name;fm++)if(!strncmp(str,fm->name,fm->match))returnfm->fa
cility;return-1;}staticintlevel_match(constchar*s){intlevel;for(level=0;zlog_pri
ority[level]!=NULL;level++)if(!strncmp(s,zlog_priority[level],2))returnlevel;ret
urnZLOG_DISABLED;}/*Thisiscalledfrommainwhenadaemonisinvokedwith-vor--version.*/
voidprint_version(constchar*progname){printf("%sversion%s\n",progname,FRR_VERSIO
N);printf("%s\n",FRR_COPYRIGHT);printf("configuredwith:\n\t%s\n",FRR_CONFIG_ARGS
);}/*Utilityfunctiontoconcatenateargvargumentintoasinglestringwithinserting''cha
racterbetweeneachargument.*/char*argv_concat(structcmd_token**argv,intargc,intsh
ift){inti;size_tlen;char*str;char*p;len=0;for(i=shift;i<argc;i++)len+=strlen(arg
v[i]->arg)+1;if(!len)returnNULL;p=str=XMALLOC(MTYPE_TMP,len);for(i=shift;i<argc;
i++){size_targlen;memcpy(p,argv[i]->arg,(arglen=strlen(argv[i]->arg)));p+=arglen
;*p++='';}*(p-1)='\0';returnstr;}/***Conveniencefunctionforaccessingargvdata.**@
paramargc*@paramargv*@paramtextdefinitionsnippetofthedesiredtoken*@paramindexthe
startingindex,andwheretostorethe*indexofthefoundtokenifitexists*@return1iffound,
0otherwise*/intargv_find(structcmd_token**argv,intargc,constchar*text,int*index)
{intfound=0;for(inti=*index;i<argc&&found==0;i++)if((found=strmatch(text,argv[i]
->text)))*index=i;returnfound;}staticunsignedintcmd_hash_key(void*p){intsize=siz
eof(p);returnjhash(p,size,0);}staticintcmd_hash_cmp(constvoid*a,constvoid*b){ret
urna==b;}/*Installtopnodeofcommandvector.*/voidinstall_node(structcmd_node*node,
int(*func)(structvty*)){vector_set_index(cmdvec,node->node,node);node->func=func
;node->cmdgraph=graph_new();node->cmd_vector=vector_init(VECTOR_MIN_SIZE);//adds
tartnodestructcmd_token*token=cmd_token_new(START_TKN,CMD_ATTR_NORMAL,NULL,NULL)
;graph_new_node(node->cmdgraph,token,(void(*)(void*))&cmd_token_del);node->cmd_h
ash=hash_create_size(16,cmd_hash_key,cmd_hash_cmp,"CommandHash");}/***Tokenizesa
string,storingtokensinavector.*Whitespaceisignored.**Delimiterstring="\n\r\t".**
@paramstringtotokenize*@returntokenizedstring*/vectorcmd_make_strvec(constchar*s
tring){if(!string)returnNULL;char*copy,*copystart;copystart=copy=XSTRDUP(MTYPE_T
MP,string);//skipleadingwhitespacewhile(isspace((int)*copy)&&*copy!='\0')copy++;
//iftheentirestringwaswhitespaceoracomment,returnif(*copy=='\0'||*copy=='!'||*co
py=='#'){XFREE(MTYPE_TMP,copystart);returnNULL;}vectorstrvec=vector_init(VECTOR_
MIN_SIZE);constchar*delim="\n\r\t",*tok=NULL;while(copy){tok=strsep(&copy,delim)
;if(*tok!='\0')vector_set(strvec,XSTRDUP(MTYPE_STRVEC,tok));}XFREE(MTYPE_TMP,cop
ystart);returnstrvec;}/*Freeallocatedstringvector.*/voidcmd_free_strvec(vectorv)
{unsignedinti;char*cp;if(!v)return;for(i=0;i<vector_active(v);i++)if((cp=vector_
slot(v,i))!=NULL)XFREE(MTYPE_STRVEC,cp);vector_free(v);}/*Returnpromptcharactero
fspecifiednode.*/constchar*cmd_prompt(enumnode_typenode){structcmd_node*cnode;cn
ode=vector_slot(cmdvec,node);returncnode->prompt;}/*Installacommandintoanode.*/v
oidinstall_element(enumnode_typentype,structcmd_element*cmd){structcmd_node*cnod
e;/*cmd_inithasn'tbeencalled*/if(!cmdvec){fprintf(stderr,"%scalledbeforecmd_init
,breakagelikely\n",__func__);return;}cnode=vector_lookup(cmdvec,ntype);if(cnode=
=NULL){fprintf(stderr,"%s[%s]:\n""\tnode%d(%s)doesnotexist.\n""\tpleasecallinsta
ll_node()beforeinstall_element()\n",cmd->name,cmd->string,ntype,node_names[ntype
]);exit(EXIT_FAILURE);}if(hash_lookup(cnode->cmd_hash,cmd)!=NULL){fprintf(stderr
,"%s[%s]:\n""\tnode%d(%s)alreadyhasthiscommandinstalled.\n""\tduplicateinstall_e
lementcall?\n",cmd->name,cmd->string,ntype,node_names[ntype]);return;}assert(has
h_get(cnode->cmd_hash,cmd,hash_alloc_intern));structgraph*graph=graph_new();stru
ctcmd_token*token=cmd_token_new(START_TKN,CMD_ATTR_NORMAL,NULL,NULL);graph_new_n
ode(graph,token,(void(*)(void*))&cmd_token_del);cmd_graph_parse(graph,cmd);cmd_g
raph_names(graph);cmd_graph_merge(cnode->cmdgraph,graph,+1);graph_delete_graph(g
raph);vector_set(cnode->cmd_vector,cmd);if(ntype==VIEW_NODE)install_element(ENAB
LE_NODE,cmd);}voiduninstall_element(enumnode_typentype,structcmd_element*cmd){st
ructcmd_node*cnode;/*cmd_inithasn'tbeencalled*/if(!cmdvec){fprintf(stderr,"%scal
ledbeforecmd_init,breakagelikely\n",__func__);return;}cnode=vector_lookup(cmdvec
,ntype);if(cnode==NULL){fprintf(stderr,"%s[%s]:\n""\tnode%d(%s)doesnotexist.\n""
\tpleasecallinstall_node()beforeuninstall_element()\n",cmd->name,cmd->string,nty
pe,node_names[ntype]);exit(EXIT_FAILURE);}if(hash_release(cnode->cmd_hash,cmd)==
NULL){fprintf(stderr,"%s[%s]:\n""\tnode%d(%s)doesnothavethiscommandinstalled.\n"
"\tduplicateuninstall_elementcall?\n",cmd->name,cmd->string,ntype,node_names[nty
pe]);return;}vector_unset_value(cnode->cmd_vector,cmd);structgraph*graph=graph_n
ew();structcmd_token*token=cmd_token_new(START_TKN,CMD_ATTR_NORMAL,NULL,NULL);gr
aph_new_node(graph,token,(void(*)(void*))&cmd_token_del);cmd_graph_parse(graph,c
md);cmd_graph_names(graph);cmd_graph_merge(cnode->cmdgraph,graph,-1);graph_delet
e_graph(graph);if(ntype==VIEW_NODE)uninstall_element(ENABLE_NODE,cmd);}staticcon
stunsignedcharitoa64[]="./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqr
stuvwxyz";staticvoidto64(char*s,longv,intn){while(--n>=0){*s++=itoa64[v&0x3f];v>
>=6;}}staticchar*zencrypt(constchar*passwd){charsalt[6];structtimevaltv;char*cry
pt(constchar*,constchar*);gettimeofday(&tv,0);to64(&salt[0],random(),3);to64(&sa
lt[3],tv.tv_usec,3);salt[5]='\0';returncrypt(passwd,salt);}/*Thisfunctionwriteco
nfigurationofthishost.*/staticintconfig_write_host(structvty*vty){if(cmd_hostnam
e_get())vty_out(vty,"hostname%s\n",cmd_hostname_get());if(cmd_domainname_get())v
ty_out(vty,"domainname%s\n",cmd_domainname_get());if(host.encrypt){if(host.passw
ord_encrypt)vty_out(vty,"password8%s\n",host.password_encrypt);if(host.enable_en
crypt)vty_out(vty,"enablepassword8%s\n",host.enable_encrypt);}else{if(host.passw
ord)vty_out(vty,"password%s\n",host.password);if(host.enable)vty_out(vty,"enable
password%s\n",host.enable);}if(zlog_default->default_lvl!=LOG_DEBUG){vty_out(vty
,"!N.B.The'logtrap'commandisdeprecated.\n");vty_out(vty,"logtrap%s\n",zlog_prior
ity[zlog_default->default_lvl]);}if(host.logfile&&(zlog_default->maxlvl[ZLOG_DES
T_FILE]!=ZLOG_DISABLED)){vty_out(vty,"logfile%s",host.logfile);if(zlog_default->
maxlvl[ZLOG_DEST_FILE]!=zlog_default->default_lvl)vty_out(vty,"%s",zlog_priority
[zlog_default->maxlvl[ZLOG_DEST_FILE]]);vty_out(vty,"\n");}if(zlog_default->maxl
vl[ZLOG_DEST_STDOUT]!=ZLOG_DISABLED){vty_out(vty,"logstdout");if(zlog_default->m
axlvl[ZLOG_DEST_STDOUT]!=zlog_default->default_lvl)vty_out(vty,"%s",zlog_priorit
y[zlog_default->maxlvl[ZLOG_DEST_STDOUT]]);vty_out(vty,"\n");}if(zlog_default->m
axlvl[ZLOG_DEST_MONITOR]==ZLOG_DISABLED)vty_out(vty,"nologmonitor\n");elseif(zlo
g_default->maxlvl[ZLOG_DEST_MONITOR]!=zlog_default->default_lvl)vty_out(vty,"log
monitor%s\n",zlog_priority[zlog_default->maxlvl[ZLOG_DEST_MONITOR]]);if(zlog_def
ault->maxlvl[ZLOG_DEST_SYSLOG]!=ZLOG_DISABLED){vty_out(vty,"logsyslog");if(zlog_
default->maxlvl[ZLOG_DEST_SYSLOG]!=zlog_default->default_lvl)vty_out(vty,"%s",zl
og_priority[zlog_default->maxlvl[ZLOG_DEST_SYSLOG]]);vty_out(vty,"\n");}if(zlog_
default->facility!=LOG_DAEMON)vty_out(vty,"logfacility%s\n",facility_name(zlog_d
efault->facility));if(zlog_default->record_priority==1)vty_out(vty,"logrecord-pr
iority\n");if(zlog_default->timestamp_precision>0)vty_out(vty,"logtimestamppreci
sion%d\n",zlog_default->timestamp_precision);if(host.advanced)vty_out(vty,"servi
ceadvanced-vty\n");if(host.encrypt)vty_out(vty,"servicepassword-encryption\n");i
f(host.lines>=0)vty_out(vty,"serviceterminal-length%d\n",host.lines);if(host.mot
dfile)vty_out(vty,"bannermotdfile%s\n",host.motdfile);elseif(!host.motd)vty_out(
vty,"nobannermotd\n");if(debug_memstats_at_exit)vty_out(vty,"!\ndebugmemstats-at
-exit\n");return1;}/*Utilityfunctionforgettingcommandgraph.*/staticstructgraph*c
md_node_graph(vectorv,enumnode_typentype){structcmd_node*cnode=vector_slot(v,nty
pe);returncnode->cmdgraph;}staticintcmd_try_do_shortcut(enumnode_typenode,char*f
irst_word){if(first_word!=NULL&&node!=AUTH_NODE&&node!=VIEW_NODE&&node!=AUTH_ENA
BLE_NODE&&0==strcmp("do",first_word))return1;return0;}/***Comparefunctionforcmd_
token.*Usedwithqsorttosortcommandcompletions.*/staticintcompare_completions(cons
tvoid*fst,constvoid*snd){structcmd_token*first=*(structcmd_token**)fst,*secnd=*(
structcmd_token**)snd;returnstrcmp(first->text,secnd->text);}/***Takesalistofcom
pletionsreturnedbycommand_complete,*dedeuplicatesthembasedonbothtextanddescripti
on,*sortsthem,andreturnsthemasavector.**@paramcompletionslinkedlistofcmd_token*@
returndeduplicatedandsortedvectorwith*/vectorcompletions_to_vec(structlist*compl
etions){vectorcomps=vector_init(VECTOR_MIN_SIZE);structlistnode*ln;structcmd_tok
en*token,*cr=NULL;unsignedinti,exists;for(ALL_LIST_ELEMENTS_RO(completions,ln,to
ken)){if(token->type==END_TKN&&(cr=token))continue;//linearsearchfortokenincompl
etionsvectorexists=0;for(i=0;i<vector_active(comps)&&!exists;i++){structcmd_toke
n*curr=vector_slot(comps,i);#ifdefVTYSH_DEBUGexists=!strcmp(curr->text,token->te
xt)&&!strcmp(curr->desc,token->desc);#elseexists=!strcmp(curr->text,token->text)
;#endif/*VTYSH_DEBUG*/}if(!exists)vector_set(comps,token);}//sortcompletionsqsor
t(comps->index,vector_active(comps),sizeof(void*),&compare_completions);//make<c
r>thefirstelement,ifitispresentif(cr){vector_set_index(comps,vector_active(comps
),NULL);memmove(comps->index+1,comps->index,(comps->alloced-1)*sizeof(void*));ve
ctor_set_index(comps,0,cr);}returncomps;}/***Generatesavectorofcmd_tokenrepresen
tingpossiblecompletions*onthecurrentinput.**@paramvlinethevectorizedinputline*@p
aramvtythevtywiththenodetomatchon*@paramstatuspointertomatcherstatuscode*@return
vectorofstructcmd_token*withpossiblecompletions*/staticvectorcmd_complete_comman
d_real(vectorvline,structvty*vty,int*status){structlist*completions;structgraph*
cmdgraph=cmd_node_graph(cmdvec,vty->node);enummatcher_rvrv=command_complete(cmdg
raph,vline,&completions);if(MATCHER_ERROR(rv)){*status=CMD_ERR_NO_MATCH;returnNU
LL;}vectorcomps=completions_to_vec(completions);list_delete_and_null(&completion
s);//setstatuscodeappropriatelyswitch(vector_active(comps)){case0:*status=CMD_ER
R_NO_MATCH;break;case1:*status=CMD_COMPLETE_FULL_MATCH;break;default:*status=CMD
_COMPLETE_LIST_MATCH;}returncomps;}vectorcmd_describe_command(vectorvline,struct
vty*vty,int*status){vectorret;if(cmd_try_do_shortcut(vty->node,vector_slot(vline
,0))){enumnode_typeonode;vectorshifted_vline;unsignedintindex;onode=vty->node;vt
y->node=ENABLE_NODE;/*Wecantryitonenablenode,cos'thevtyisauthenticated*/shifted_
vline=vector_init(vector_count(vline));/*usememcpy?*/for(index=1;index<vector_ac
tive(vline);index++){vector_set_index(shifted_vline,index-1,vector_lookup(vline,
index));}ret=cmd_complete_command_real(shifted_vline,vty,status);vector_free(shi
fted_vline);vty->node=onode;returnret;}returncmd_complete_command_real(vline,vty
,status);}staticstructlist*varhandlers=NULL;voidcmd_variable_complete(structcmd_
token*token,constchar*arg,vectorcomps){structlistnode*ln;conststructcmd_variable
_handler*cvh;size_ti,argsz;vectortmpcomps;tmpcomps=arg?vector_init(VECTOR_MIN_SI
ZE):comps;for(ALL_LIST_ELEMENTS_RO(varhandlers,ln,cvh)){if(cvh->tokenname&&strcm
p(cvh->tokenname,token->text))continue;if(cvh->varname&&(!token->varname||strcmp
(cvh->varname,token->varname)))continue;cvh->completions(tmpcomps,token);break;}
if(!arg)return;argsz=strlen(arg);for(i=vector_active(tmpcomps);i;i--){char*item=
vector_slot(tmpcomps,i-1);if(strlen(item)>=argsz&&!strncmp(item,arg,argsz))vecto
r_set(comps,item);elseXFREE(MTYPE_COMPLETION,item);}vector_free(tmpcomps);}#defi
neAUTOCOMP_INDENT5char*cmd_variable_comp2str(vectorcomps,unsignedshortcols){size
_tbsz=16;char*buf=XCALLOC(MTYPE_TMP,bsz);intlc=AUTOCOMP_INDENT;size_tcs=AUTOCOMP
_INDENT;size_titemlen;snprintf(buf,bsz,"%*s",AUTOCOMP_INDENT,"");for(size_tj=0;j
<vector_active(comps);j++){char*item=vector_slot(comps,j);itemlen=strlen(item);i
f(cs+itemlen+AUTOCOMP_INDENT+3>=bsz)buf=XREALLOC(MTYPE_TMP,buf,(bsz*=2));if(lc+i
temlen+1>=cols){cs+=snprintf(&buf[cs],bsz-cs,"\n%*s",AUTOCOMP_INDENT,"");lc=AUTO
COMP_INDENT;}size_twritten=snprintf(&buf[cs],bsz-cs,"%s",item);lc+=written;cs+=w
ritten;XFREE(MTYPE_COMPLETION,item);vector_set_index(comps,j,NULL);}returnbuf;}v
oidcmd_variable_handler_register(conststructcmd_variable_handler*cvh){if(!varhan
dlers)return;for(;cvh->completions;cvh++)listnode_add(varhandlers,(void*)cvh);}D
EFUN_HIDDEN(autocomplete,autocomplete_cmd,"autocompleteTYPETEXTVARNAME","Autocom
pletionhandler(internal,forvtysh)\n""cmd_token->type\n""cmd_token->text\n""cmd_t
oken->varname\n"){structcmd_tokentok;vectorcomps=vector_init(32);size_ti;memset(
&tok,0,sizeof(tok));tok.type=atoi(argv[1]->arg);tok.text=argv[2]->arg;tok.varnam
e=argv[3]->arg;if(!strcmp(tok.varname,"-"))tok.varname=NULL;cmd_variable_complet
e(&tok,NULL,comps);for(i=0;i<vector_active(comps);i++){char*text=vector_slot(com
ps,i);vty_out(vty,"%s\n",text);XFREE(MTYPE_COMPLETION,text);}vector_free(comps);
returnCMD_SUCCESS;}/***Generatepossibletab-completionsforthegiveninput.Thisfunct
iononly*returnsresultsthatwouldresultinavalidcommandifusedasReadline*completions
(asisthecaseinvtysh).Forinstance,ifthepassedvlineends*with'4.3.2',thestrings'A.B
.C.D'and'A.B.C.D/M'will_not_bereturned.**@paramvlinevectorizedinputline*@paramvt
ythevty*@paramstatuslocationtostorematcherstatuscodein*@returnsetofvalidstringsf
orusewithReadlineastab-completions.*/char**cmd_complete_command(vectorvline,stru
ctvty*vty,int*status){char**ret=NULL;intoriginal_node=vty->node;vectorinput_line
=vector_init(vector_count(vline));//ifthefirsttokenis'do'we'llwanttoexecutetheco
mmandinthe//enablenodeintdo_shortcut=cmd_try_do_shortcut(vty->node,vector_slot(v
line,0));vty->node=do_shortcut?ENABLE_NODE:original_node;//constructtheinputline
we'llbematchingonunsignedintoffset=(do_shortcut)?1:0;for(unsignedindex=0;index+o
ffset<vector_active(vline);index++)vector_set_index(input_line,index,vector_look
up(vline,index+offset));//gettokencompletions--thisisacopyingoperationvectorcomp
s=NULL,initial_comps;initial_comps=cmd_complete_command_real(input_line,vty,stat
us);if(!MATCHER_ERROR(*status)){assert(initial_comps);//filterouteverythingthati
snotsuitablefora//tab-completioncomps=vector_init(VECTOR_MIN_SIZE);for(unsignedi
nti=0;i<vector_active(initial_comps);i++){structcmd_token*token=vector_slot(init
ial_comps,i);if(token->type==WORD_TKN)vector_set(comps,XSTRDUP(MTYPE_COMPLETION,
token->text));elseif(IS_VARYING_TOKEN(token->type)){constchar*ref=vector_lookup(
vline,vector_active(vline)-1);cmd_variable_complete(token,ref,comps);}}vector_fr
ee(initial_comps);//sincewefilteredresults,weneedtore-setstatuscodeswitch(vector
_active(comps)){case0:*status=CMD_ERR_NO_MATCH;break;case1:*status=CMD_COMPLETE_
FULL_MATCH;break;default:*status=CMD_COMPLETE_LIST_MATCH;}//copycompletionstexti
ntoanarrayofchar*ret=XMALLOC(MTYPE_TMP,(vector_active(comps)+1)*sizeof(char*));u
nsignedinti;for(i=0;i<vector_active(comps);i++){ret[i]=vector_slot(comps,i);}//s
etthelastelementtoNULL,becausethisarrayisusedin//aReadlinecompletion_generatorfu
nctionwhichexpectsNULL//asasentinelvalueret[i]=NULL;vector_free(comps);comps=NUL
L;}elseif(initial_comps)vector_free(initial_comps);//compsshouldalwaysbenullhere
assert(!comps);//freetheadjustedinputlinevector_free(input_line);//resetvty->nod
etoitsoriginalvaluevty->node=original_node;returnret;}/*returnparentnode*//*MUST
eventuallyconvergeonCONFIG_NODE*/enumnode_typenode_parent(enumnode_typenode){enu
mnode_typeret;assert(node>CONFIG_NODE);switch(node){caseBGP_VPNV4_NODE:caseBGP_V
PNV6_NODE:caseBGP_FLOWSPECV4_NODE:caseBGP_FLOWSPECV6_NODE:caseBGP_VRF_POLICY_NOD
E:caseBGP_VNC_DEFAULTS_NODE:caseBGP_VNC_NVE_GROUP_NODE:caseBGP_VNC_L2_GROUP_NODE
:caseBGP_IPV4_NODE:caseBGP_IPV4M_NODE:caseBGP_IPV4L_NODE:caseBGP_IPV6_NODE:caseB
GP_IPV6M_NODE:caseBGP_EVPN_NODE:caseBGP_IPV6L_NODE:ret=BGP_NODE;break;caseBGP_EV
PN_VNI_NODE:ret=BGP_EVPN_NODE;break;caseKEYCHAIN_KEY_NODE:ret=KEYCHAIN_NODE;brea
k;caseLINK_PARAMS_NODE:ret=INTERFACE_NODE;break;caseLDP_IPV4_NODE:caseLDP_IPV6_N
ODE:ret=LDP_NODE;break;caseLDP_IPV4_IFACE_NODE:ret=LDP_IPV4_NODE;break;caseLDP_I
PV6_IFACE_NODE:ret=LDP_IPV6_NODE;break;caseLDP_PSEUDOWIRE_NODE:ret=LDP_L2VPN_NOD
E;break;default:ret=CONFIG_NODE;break;}returnret;}/*Executecommandbyargumentvlin
evector.*/staticintcmd_execute_command_real(vectorvline,enumfilter_typefilter,st
ructvty*vty,conststructcmd_element**cmd){structlist*argv_list;enummatcher_rvstat
us;conststructcmd_element*matched_element=NULL;structgraph*cmdgraph=cmd_node_gra
ph(cmdvec,vty->node);status=command_match(cmdgraph,vline,&argv_list,&matched_ele
ment);if(cmd)*cmd=matched_element;//ifmatchererror,returncorrespondingCMD_ERRif(
MATCHER_ERROR(status)){if(argv_list)list_delete_and_null(&argv_list);switch(stat
us){caseMATCHER_INCOMPLETE:returnCMD_ERR_INCOMPLETE;caseMATCHER_AMBIGUOUS:return
CMD_ERR_AMBIGUOUS;default:returnCMD_ERR_NO_MATCH;}}//buildargvarrayfromargvlists
tructcmd_token**argv=XMALLOC(MTYPE_TMP,argv_list->count*sizeof(structcmd_token*)
);structlistnode*ln;structcmd_token*token;unsignedinti=0;for(ALL_LIST_ELEMENTS_R
O(argv_list,ln,token))argv[i++]=token;intargc=argv_list->count;intret;if(matched
_element->daemon)ret=CMD_SUCCESS_DAEMON;elseret=matched_element->func(matched_el
ement,vty,argc,argv);//deletelistandcmd_token'sinitlist_delete_and_null(&argv_li
st);XFREE(MTYPE_TMP,argv);returnret;}/***Executeagivencommand,handlingthingslike
"do..."andchecking*whetherthegivencommandmightapplyataparentnodeifdoesn't*applyf
orthecurrentnode.**@paramvlineCommandlineinput,vectorofchar*whereeachelementis*o
neinputtoken.*@paramvtyThevtycontextinwhichthecommandshouldbeexecuted.*@paramcmd
Pointerwherethestructcmd_elementofthematchedcommand*willbestored,ifany.Maybesett
oNULLifthisinfois*notneeded.*@paramvtyshIfset!=0,don'tlookupthecommandatparentno
des.*@returnThestatusofthecommandthathasbeenexecutedoranerrorcode*astowhynocomma
ndcouldbeexecuted.*/intcmd_execute_command(vectorvline,structvty*vty,conststruct
cmd_element**cmd,intvtysh){intret,saved_ret=0;enumnode_typeonode,try_node;onode=
try_node=vty->node;if(cmd_try_do_shortcut(vty->node,vector_slot(vline,0))){vecto
rshifted_vline;unsignedintindex;vty->node=ENABLE_NODE;/*Wecantryitonenablenode,c
os'thevtyisauthenticated*/shifted_vline=vector_init(vector_count(vline));/*useme
mcpy?*/for(index=1;index<vector_active(vline);index++)vector_set_index(shifted_v
line,index-1,vector_lookup(vline,index));ret=cmd_execute_command_real(shifted_vl
ine,FILTER_RELAXED,vty,cmd);vector_free(shifted_vline);vty->node=onode;returnret
;}saved_ret=ret=cmd_execute_command_real(vline,FILTER_RELAXED,vty,cmd);if(vtysh)
returnsaved_ret;if(ret!=CMD_SUCCESS&&ret!=CMD_WARNING&&ret!=CMD_NOT_MY_INSTANCE&
&ret!=CMD_WARNING_CONFIG_FAILED){/*ThisassumesallnodesaboveCONFIG_NODEarechildso
f*CONFIG_NODE*/while(vty->node>CONFIG_NODE){try_node=node_parent(try_node);vty->
node=try_node;ret=cmd_execute_command_real(vline,FILTER_RELAXED,vty,cmd);if(ret=
=CMD_SUCCESS||ret==CMD_WARNING||ret==CMD_NOT_MY_INSTANCE||ret==CMD_WARNING_CONFI
G_FAILED)returnret;}/*nocommandsucceeded,resetthevtytotheoriginalnode*/vty->node
=onode;}/*returncommandstatusfororiginalnode*/returnsaved_ret;}/***Executeagiven
command,matchingitstrictlyagainstthecurrentnode.*Thismodeisusedwhenreadingconfig
files.**@paramvlineCommandlineinput,vectorofchar*whereeachelementis*oneinputtoke
n.*@paramvtyThevtycontextinwhichthecommandshouldbeexecuted.*@paramcmdPointerwher
ethestructcmd_element*ofthematchedcommand*willbestored,ifany.MaybesettoNULLifthi
sinfois*notneeded.*@returnThestatusofthecommandthathasbeenexecutedoranerrorcode*
astowhynocommandcouldbeexecuted.*/intcmd_execute_command_strict(vectorvline,stru
ctvty*vty,conststructcmd_element**cmd){returncmd_execute_command_real(vline,FILT
ER_STRICT,vty,cmd);}/***Parseonelineofconfig,walkinguptheparsetreeattemptingtofi
nda*match**@paramvtyThevtycontextinwhichthecommandshouldbeexecuted.*@paramcmdPoi
nterwherethestructcmd_element*ofthematchcommand*willbestored,ifany.MaybesettoNUL
Lifthisinfois*notneeded.*@paramuse_daemonBooleantocontrolwhetherornotwematchon*C
MD_SUCCESS_DAEMON*ornot.*@returnThestatusofthecommandthathasbeenexecutedoranerro
rcode*astowhynocommandcouldbeexecuted.*/intcommand_config_read_one_line(structvt
y*vty,conststructcmd_element**cmd,intuse_daemon){vectorvline;intsaved_node;intre
t;vline=cmd_make_strvec(vty->buf);/*Incaseofcommentline*/if(vline==NULL)returnCM
D_SUCCESS;/*Executeconfigurationcommand:thisisstrictmatch*/ret=cmd_execute_comma
nd_strict(vline,vty,cmd);//Climbthetreeandtrythecommandagainateachnodeif(!(use_d
aemon&&ret==CMD_SUCCESS_DAEMON)&&!(!use_daemon&&ret==CMD_ERR_NOTHING_TODO)&&ret!
=CMD_SUCCESS&&ret!=CMD_WARNING&&ret!=CMD_NOT_MY_INSTANCE&&ret!=CMD_WARNING_CONFI
G_FAILED&&vty->node!=CONFIG_NODE){saved_node=vty->node;while(!(use_daemon&&ret==
CMD_SUCCESS_DAEMON)&&!(!use_daemon&&ret==CMD_ERR_NOTHING_TODO)&&ret!=CMD_SUCCESS
&&ret!=CMD_WARNING&&vty->node>CONFIG_NODE){vty->node=node_parent(vty->node);ret=
cmd_execute_command_strict(vline,vty,cmd);}//Ifclimbingthetreedidnotworkthenigno
rethecommandand//stayatthesamenodeif(!(use_daemon&&ret==CMD_SUCCESS_DAEMON)&&!(!
use_daemon&&ret==CMD_ERR_NOTHING_TODO)&&ret!=CMD_SUCCESS&&ret!=CMD_WARNING){vty-
>node=saved_node;}}if(ret!=CMD_SUCCESS&&ret!=CMD_WARNING)memcpy(vty->error_buf,v
ty->buf,VTY_BUFSIZ);cmd_free_strvec(vline);returnret;}/*Configurationmakefromfil
e.*/intconfig_from_file(structvty*vty,FILE*fp,unsignedint*line_num){intret,error
_ret=0;*line_num=0;while(fgets(vty->buf,VTY_BUFSIZ,fp)){if(!error_ret)++(*line_n
um);ret=command_config_read_one_line(vty,NULL,0);if(ret!=CMD_SUCCESS&&ret!=CMD_W
ARNING&&ret!=CMD_ERR_NOTHING_TODO)error_ret=ret;}if(error_ret){returnerror_ret;}
returnCMD_SUCCESS;}/*Configurationfromterminal*/DEFUN(config_terminal,config_ter
minal_cmd,"configureterminal","Configurationfromvtyinterface\n""Configurationter
minal\n"){if(vty_config_lock(vty))vty->node=CONFIG_NODE;else{vty_out(vty,"VTYcon
figurationislockedbyotherVTY\n");returnCMD_WARNING_CONFIG_FAILED;}returnCMD_SUCC
ESS;}/*Enablecommand*/DEFUN(enable,config_enable_cmd,"enable","Turnonprivilegedm
odecommand\n"){/*IfenablepasswordisNULL,changetoENABLE_NODE*/if((host.enable==NU
LL&&host.enable_encrypt==NULL)||vty->type==VTY_SHELL_SERV)vty->node=ENABLE_NODE;
elsevty->node=AUTH_ENABLE_NODE;returnCMD_SUCCESS;}/*Disablecommand*/DEFUN(disabl
e,config_disable_cmd,"disable","Turnoffprivilegedmodecommand\n"){if(vty->node==E
NABLE_NODE)vty->node=VIEW_NODE;returnCMD_SUCCESS;}/*Downvtynodelevel.*/DEFUN(con
fig_exit,config_exit_cmd,"exit","Exitcurrentmodeanddowntopreviousmode\n"){cmd_ex
it(vty);returnCMD_SUCCESS;}voidcmd_exit(structvty*vty){switch(vty->node){caseVIE
W_NODE:caseENABLE_NODE:if(vty_shell(vty))exit(0);elsevty->status=VTY_CLOSE;break
;caseCONFIG_NODE:vty->node=ENABLE_NODE;vty_config_unlock(vty);break;caseINTERFAC
E_NODE:casePW_NODE:caseLOGICALROUTER_NODE:caseVRF_NODE:caseNH_GROUP_NODE:caseZEB
RA_NODE:caseBGP_NODE:caseRIP_NODE:caseEIGRP_NODE:caseBABEL_NODE:caseRIPNG_NODE:c
aseOSPF_NODE:caseOSPF6_NODE:caseLDP_NODE:caseLDP_L2VPN_NODE:caseISIS_NODE:caseKE
YCHAIN_NODE:caseMASC_NODE:caseRMAP_NODE:caseVTY_NODE:vty->node=CONFIG_NODE;break
;caseBGP_IPV4_NODE:caseBGP_IPV4M_NODE:caseBGP_IPV4L_NODE:caseBGP_VPNV4_NODE:case
BGP_VPNV6_NODE:caseBGP_FLOWSPECV4_NODE:caseBGP_FLOWSPECV6_NODE:caseBGP_VRF_POLIC
Y_NODE:caseBGP_VNC_DEFAULTS_NODE:caseBGP_VNC_NVE_GROUP_NODE:caseBGP_VNC_L2_GROUP
_NODE:caseBGP_IPV6_NODE:caseBGP_IPV6M_NODE:caseBGP_EVPN_NODE:caseBGP_IPV6L_NODE:
vty->node=BGP_NODE;break;caseBGP_EVPN_VNI_NODE:vty->node=BGP_EVPN_NODE;break;cas
eLDP_IPV4_NODE:caseLDP_IPV6_NODE:vty->node=LDP_NODE;break;caseLDP_IPV4_IFACE_NOD
E:vty->node=LDP_IPV4_NODE;break;caseLDP_IPV6_IFACE_NODE:vty->node=LDP_IPV6_NODE;
break;caseLDP_PSEUDOWIRE_NODE:vty->node=LDP_L2VPN_NODE;break;caseKEYCHAIN_KEY_NO
DE:vty->node=KEYCHAIN_NODE;break;caseLINK_PARAMS_NODE:vty->node=INTERFACE_NODE;b
reak;default:break;}}/*ALIAS_FIXME*/DEFUN(config_quit,config_quit_cmd,"quit","Ex
itcurrentmodeanddowntopreviousmode\n"){returnconfig_exit(self,vty,argc,argv);}/*
Endofconfiguration.*/DEFUN(config_end,config_end_cmd,"end","Endcurrentmodeandcha
ngetoenablemode.\n"){switch(vty->node){caseVIEW_NODE:caseENABLE_NODE:/*Nothingto
do.*/break;caseCONFIG_NODE:caseINTERFACE_NODE:casePW_NODE:caseLOGICALROUTER_NODE
:caseVRF_NODE:caseNH_GROUP_NODE:caseZEBRA_NODE:caseRIP_NODE:caseRIPNG_NODE:caseE
IGRP_NODE:caseBABEL_NODE:caseBGP_NODE:caseBGP_VRF_POLICY_NODE:caseBGP_VNC_DEFAUL
TS_NODE:caseBGP_VNC_NVE_GROUP_NODE:caseBGP_VNC_L2_GROUP_NODE:caseBGP_VPNV4_NODE:
caseBGP_VPNV6_NODE:caseBGP_FLOWSPECV4_NODE:caseBGP_FLOWSPECV6_NODE:caseBGP_IPV4_
NODE:caseBGP_IPV4M_NODE:caseBGP_IPV4L_NODE:caseBGP_IPV6_NODE:caseBGP_IPV6M_NODE:
caseBGP_EVPN_NODE:caseBGP_EVPN_VNI_NODE:caseBGP_IPV6L_NODE:caseRMAP_NODE:caseOSP
F_NODE:caseOSPF6_NODE:caseLDP_NODE:caseLDP_IPV4_NODE:caseLDP_IPV6_NODE:caseLDP_I
PV4_IFACE_NODE:caseLDP_IPV6_IFACE_NODE:caseLDP_L2VPN_NODE:caseLDP_PSEUDOWIRE_NOD
E:caseISIS_NODE:caseKEYCHAIN_NODE:caseKEYCHAIN_KEY_NODE:caseMASC_NODE:caseVTY_NO
DE:caseLINK_PARAMS_NODE:vty_config_unlock(vty);vty->node=ENABLE_NODE;break;defau
lt:break;}returnCMD_SUCCESS;}/*Showversion.*/DEFUN(show_version,show_version_cmd
,"showversion",SHOW_STR"Displayszebraversion\n"){vty_out(vty,"%s%s(%s).\n",FRR_F
ULL_NAME,FRR_VERSION,cmd_hostname_get()?cmd_hostname_get():"");vty_out(vty,"%s%s
\n",FRR_COPYRIGHT,GIT_INFO);vty_out(vty,"configuredwith:\n%s\n",FRR_CONFIG_ARGS)
;returnCMD_SUCCESS;}/*"Set"version...ignoreversiontags*/DEFUN(frr_version_defaul
ts,frr_version_defaults_cmd,"frr<version|defaults>LINE...","FRRoutingglobalparam
eters\n""versionconfigurationwaswrittenby\n""setofconfigurationdefaultsused\n""v
ersionstring\n"){returnCMD_SUCCESS;}/*Helpdisplayfunctionforallnode.*/DEFUN(conf
ig_help,config_help_cmd,"help","Descriptionoftheinteractivehelpsystem\n"){vty_ou
t(vty,"QuaggaVTYprovidesadvancedhelpfeature.Whenyouneedhelp,\n\anytimeatthecomma
ndlinepleasepress'?'.\n\\n\Ifnothingmatches,thehelplistwillbeemptyandyoumustback
up\n\untilenteringa'?'showstheavailableoptions.\n\Twostylesofhelpareprovided:\n\
1.Fullhelpisavailablewhenyouarereadytoentera\n\commandargument(e.g.'show?')andde
scribeseachpossible\n\argument.\n\2.Partialhelpisprovidedwhenanabbreviatedargume
ntisentered\n\andyouwanttoknowwhatargumentsmatchtheinput\n\(e.g.'showme?'.)\n\n"
);returnCMD_SUCCESS;}staticvoidpermute(structgraph_node*start,structvty*vty){sta
ticstructlist*position=NULL;if(!position)position=list_new();structcmd_token*sto
k=start->data;structgraph_node*gnn;structlistnode*ln;//recursivedfslistnode_add(
position,start);for(unsignedinti=0;i<vector_active(start->to);i++){structgraph_n
ode*gn=vector_slot(start->to,i);structcmd_token*tok=gn->data;if(tok->attr==CMD_A
TTR_HIDDEN||tok->attr==CMD_ATTR_DEPRECATED)continue;elseif(tok->type==END_TKN||g
n==start){vty_out(vty,"");for(ALL_LIST_ELEMENTS_RO(position,ln,gnn)){structcmd_t
oken*tt=gnn->data;if(tt->type<SPECIAL_TKN)vty_out(vty,"%s",tt->text);}if(gn==sta
rt)vty_out(vty,"...");vty_out(vty,"\n");}else{boolskip=false;if(stok->type==FORK
_TKN&&tok->type!=FORK_TKN)for(ALL_LIST_ELEMENTS_RO(position,ln,gnn))if(gnn==gn){
skip=true;break;}if(!skip)permute(gn,vty);}}list_delete_node(position,listtail(p
osition));}intcmd_list_cmds(structvty*vty,intdo_permute){structcmd_node*node=vec
tor_slot(cmdvec,vty->node);if(do_permute)permute(vector_slot(node->cmdgraph->nod
es,0),vty);else{/*loopoverallcommandsatthisnode*/structcmd_element*element=NULL;
for(unsignedinti=0;i<vector_active(node->cmd_vector);i++)if((element=vector_slot
(node->cmd_vector,i))&&element->attr!=CMD_ATTR_DEPRECATED&&element->attr!=CMD_AT
TR_HIDDEN)vty_out(vty,"%s\n",element->string);}returnCMD_SUCCESS;}/*Helpdisplayf
unctionforallnode.*/DEFUN(config_list,config_list_cmd,"list[permutations]","Prin
tcommandlist\n""Printallpossiblecommandpermutations\n"){returncmd_list_cmds(vty,
argc==2);}DEFUN(show_commandtree,show_commandtree_cmd,"showcommandtree[permutati
ons]",SHOW_STR"Showcommandtree\n""Permutationsthatweareinterestedin\n"){returncm
d_list_cmds(vty,argc==3);}staticintvty_write_config(structvty*vty){size_ti;struc
tcmd_node*node;if(host.noconfig)returnCMD_SUCCESS;if(vty->type==VTY_TERM){vty_ou
t(vty,"\nCurrentconfiguration:\n");vty_out(vty,"!\n");}vty_out(vty,"frrversion%s
\n",FRR_VER_SHORT);vty_out(vty,"frrdefaults%s\n",DFLT_NAME);vty_out(vty,"!\n");f
or(i=0;i<vector_active(cmdvec);i++)if((node=vector_slot(cmdvec,i))&&node->func&&
(node->vtysh||vty->type!=VTY_SHELL)){if((*node->func)(vty))vty_out(vty,"!\n");}i
f(vty->type==VTY_TERM){vty_out(vty,"end\n");}returnCMD_SUCCESS;}staticintfile_wr
ite_config(structvty*vty){intfd,dirfd;char*config_file,*slash;char*config_file_t
mp=NULL;char*config_file_sav=NULL;intret=CMD_WARNING;structvty*file_vty;structst
atconf_stat;if(host.noconfig)returnCMD_SUCCESS;/*Checkandseeifweareoperatingunde
rvtyshconfiguration*/if(host.config==NULL){vty_out(vty,"Can'tsavetoconfiguration
file,usingvtysh.\n");returnCMD_WARNING;}/*Getfilename.*/config_file=host.config;
#ifndefO_DIRECTORY#defineO_DIRECTORY0#endifslash=strrchr(config_file,'/');if(sla
sh){char*config_dir=XSTRDUP(MTYPE_TMP,config_file);config_dir[slash-config_file]
='\0';dirfd=open(config_dir,O_DIRECTORY|O_RDONLY);XFREE(MTYPE_TMP,config_dir);}e
lsedirfd=open(".",O_DIRECTORY|O_RDONLY);/*ifdirfdisinvalid,directorysyncfails,bu
twe'restillOK*/config_file_sav=XMALLOC(MTYPE_TMP,strlen(config_file)+strlen(CONF
_BACKUP_EXT)+1);strcpy(config_file_sav,config_file);strcat(config_file_sav,CONF_
BACKUP_EXT);config_file_tmp=XMALLOC(MTYPE_TMP,strlen(config_file)+8);sprintf(con
fig_file_tmp,"%s.XXXXXX",config_file);/*Openfiletoconfigurationwrite.*/fd=mkstem
p(config_file_tmp);if(fd<0){vty_out(vty,"Can'topenconfigurationfile%s.\n",config
_file_tmp);gotofinished;}if(fchmod(fd,CONFIGFILE_MASK)!=0){vty_out(vty,"Can'tchm
odconfigurationfile%s:%s(%d).\n",config_file_tmp,safe_strerror(errno),errno);got
ofinished;}/*Makevtyforconfigurationfile.*/file_vty=vty_new();file_vty->wfd=fd;f
ile_vty->type=VTY_FILE;/*Configfileheaderprint.*/vty_out(file_vty,"!\n!Zebraconf
igurationsavedfromvty\n!");vty_time_print(file_vty,1);vty_out(file_vty,"!\n");vt
y_write_config(file_vty);vty_close(file_vty);if(stat(config_file,&conf_stat)>=0)
{if(unlink(config_file_sav)!=0)if(errno!=ENOENT){vty_out(vty,"Can'tunlinkbackupc
onfigurationfile%s.\n",config_file_sav);gotofinished;}if(link(config_file,config
_file_sav)!=0){vty_out(vty,"Can'tbackupoldconfigurationfile%s.\n",config_file_sa
v);gotofinished;}if(dirfd>=0)fsync(dirfd);}if(rename(config_file_tmp,config_file
)!=0){vty_out(vty,"Can'tsaveconfigurationfile%s.\n",config_file);gotofinished;}i
f(dirfd>=0)fsync(dirfd);vty_out(vty,"Configurationsavedto%s\n",config_file);ret=
CMD_SUCCESS;finished:if(ret!=CMD_SUCCESS)unlink(config_file_tmp);if(dirfd>=0)clo
se(dirfd);XFREE(MTYPE_TMP,config_file_tmp);XFREE(MTYPE_TMP,config_file_sav);retu
rnret;}/*Writecurrentconfigurationintofile.*/DEFUN(config_write,config_write_cmd
,"write[<file|memory|terminal>]","Writerunningconfigurationtomemory,network,orte
rminal\n""Writetoconfigurationfile\n""Writeconfigurationcurrentlyinmemory\n""Wri
teconfigurationtoterminal\n"){constintidx_type=1;//ifcommandwas'writeterminal'or
'writememory'if(argc==2&&(!strcmp(argv[idx_type]->text,"terminal"))){returnvty_w
rite_config(vty);}returnfile_write_config(vty);}/*ALIAS_FIXMEfor'write<terminal|
memory>'*/DEFUN(show_running_config,show_running_config_cmd,"showrunning-config"
,SHOW_STR"runningconfiguration(sameaswriteterminal)\n"){returnvty_write_config(v
ty);}/*ALIAS_FIXMEfor'writefile'*/DEFUN(copy_runningconf_startupconf,copy_runnin
gconf_startupconf_cmd,"copyrunning-configstartup-config","Copyconfiguration\n""C
opyrunningconfigto...\n""Copyrunningconfigtostartupconfig(sameaswritefile/memory
)\n"){returnfile_write_config(vty);}/**--**//*Writestartupconfigurationintothete
rminal.*/DEFUN(show_startup_config,show_startup_config_cmd,"showstartup-config",
SHOW_STR"Contentsofstartupconfiguration\n"){charbuf[BUFSIZ];FILE*confp;if(host.n
oconfig)returnCMD_SUCCESS;if(host.config==NULL)returnCMD_WARNING;confp=fopen(hos
t.config,"r");if(confp==NULL){vty_out(vty,"Can'topenconfigurationfile[%s]dueto'%
s'\n",host.config,safe_strerror(errno));returnCMD_WARNING;}while(fgets(buf,BUFSI
Z,confp)){char*cp=buf;while(*cp!='\r'&&*cp!='\n'&&*cp!='\0')cp++;*cp='\0';vty_ou
t(vty,"%s\n",buf);}fclose(confp);returnCMD_SUCCESS;}intcmd_domainname_set(constc
har*domainname){XFREE(MTYPE_HOST,host.domainname);host.domainname=domainname?XST
RDUP(MTYPE_HOST,domainname):NULL;returnCMD_SUCCESS;}/*Hostnameconfiguration*/DEF
UN(config_domainname,domainname_cmd,"domainnameWORD","Setsystem'sdomainname\n""T
hissystem'sdomainname\n"){structcmd_token*word=argv[1];if(!isalpha((int)word->ar
g[0])){vty_out(vty,"Pleasespecifystringstartingwithalphabet\n");returnCMD_WARNIN
G_CONFIG_FAILED;}returncmd_domainname_set(word->arg);}DEFUN(config_no_domainname
,no_domainname_cmd,"nodomainname[DOMAINNAME]",NO_STR"Resetsystem'sdomainname\n""
domainnameofthisrouter\n"){returncmd_domainname_set(NULL);}intcmd_hostname_set(c
onstchar*hostname){XFREE(MTYPE_HOST,host.name);host.name=hostname?XSTRDUP(MTYPE_
HOST,hostname):NULL;returnCMD_SUCCESS;}/*Hostnameconfiguration*/DEFUN(config_hos
tname,hostname_cmd,"hostnameWORD","Setsystem'snetworkname\n""Thissystem'snetwork
name\n"){structcmd_token*word=argv[1];if(!isalpha((int)word->arg[0])){vty_out(vt
y,"Pleasespecifystringstartingwithalphabet\n");returnCMD_WARNING_CONFIG_FAILED;}
returncmd_hostname_set(word->arg);}DEFUN(config_no_hostname,no_hostname_cmd,"noh
ostname[HOSTNAME]",NO_STR"Resetsystem'snetworkname\n""Hostnameofthisrouter\n"){r
eturncmd_hostname_set(NULL);}/*VTYinterfacepasswordset.*/DEFUN(config_password,p
assword_cmd,"password[(8-8)]WORD","Assigntheterminalconnectionpassword\n""Specif
iesaHIDDENpasswordwillfollow\n""Thepasswordstring\n"){intidx_8=1;intidx_word=2;i
f(argc==3)//'8'wasspecified{if(host.password)XFREE(MTYPE_HOST,host.password);hos
t.password=NULL;if(host.password_encrypt)XFREE(MTYPE_HOST,host.password_encrypt)
;host.password_encrypt=XSTRDUP(MTYPE_HOST,argv[idx_word]->arg);returnCMD_SUCCESS
;}if(!isalnum((int)argv[idx_8]->arg[0])){vty_out(vty,"Pleasespecifystringstartin
gwithalphanumeric\n");returnCMD_WARNING_CONFIG_FAILED;}if(host.password)XFREE(MT
YPE_HOST,host.password);host.password=NULL;if(host.encrypt){if(host.password_enc
rypt)XFREE(MTYPE_HOST,host.password_encrypt);host.password_encrypt=XSTRDUP(MTYPE
_HOST,zencrypt(argv[idx_8]->arg));}elsehost.password=XSTRDUP(MTYPE_HOST,argv[idx
_8]->arg);returnCMD_SUCCESS;}/*VTYenablepasswordset.*/DEFUN(config_enable_passwo
rd,enable_password_cmd,"enablepassword[(8-8)]WORD","Modifyenablepasswordparamete
rs\n""Assigntheprivilegedlevelpassword\n""SpecifiesaHIDDENpasswordwillfollow\n""
TheHIDDEN'enable'passwordstring\n"){intidx_8=2;intidx_word=3;/*Crypttypeisspecif
ied.*/if(argc==4){if(argv[idx_8]->arg[0]=='8'){if(host.enable)XFREE(MTYPE_HOST,h
ost.enable);host.enable=NULL;if(host.enable_encrypt)XFREE(MTYPE_HOST,host.enable
_encrypt);host.enable_encrypt=XSTRDUP(MTYPE_HOST,argv[idx_word]->arg);returnCMD_
SUCCESS;}else{vty_out(vty,"Unknownencryptiontype.\n");returnCMD_WARNING_CONFIG_F
AILED;}}if(!isalnum((int)argv[idx_8]->arg[0])){vty_out(vty,"Pleasespecifystrings
tartingwithalphanumeric\n");returnCMD_WARNING_CONFIG_FAILED;}if(host.enable)XFRE
E(MTYPE_HOST,host.enable);host.enable=NULL;/*Plainpasswordinput.*/if(host.encryp
t){if(host.enable_encrypt)XFREE(MTYPE_HOST,host.enable_encrypt);host.enable_encr
ypt=XSTRDUP(MTYPE_HOST,zencrypt(argv[idx_8]->arg));}elsehost.enable=XSTRDUP(MTYP
E_HOST,argv[idx_8]->arg);returnCMD_SUCCESS;}/*VTYenablepassworddelete.*/DEFUN(no
_config_enable_password,no_enable_password_cmd,"noenablepassword",NO_STR"Modifye
nablepasswordparameters\n""Assigntheprivilegedlevelpassword\n"){if(host.enable)X
FREE(MTYPE_HOST,host.enable);host.enable=NULL;if(host.enable_encrypt)XFREE(MTYPE
_HOST,host.enable_encrypt);host.enable_encrypt=NULL;returnCMD_SUCCESS;}DEFUN(ser
vice_password_encrypt,service_password_encrypt_cmd,"servicepassword-encryption",
"Setupmiscellaneousservice\n""Enableencryptedpasswords\n"){if(host.encrypt)retur
nCMD_SUCCESS;host.encrypt=1;if(host.password){if(host.password_encrypt)XFREE(MTY
PE_HOST,host.password_encrypt);host.password_encrypt=XSTRDUP(MTYPE_HOST,zencrypt
(host.password));}if(host.enable){if(host.enable_encrypt)XFREE(MTYPE_HOST,host.e
nable_encrypt);host.enable_encrypt=XSTRDUP(MTYPE_HOST,zencrypt(host.enable));}re
turnCMD_SUCCESS;}DEFUN(no_service_password_encrypt,no_service_password_encrypt_c
md,"noservicepassword-encryption",NO_STR"Setupmiscellaneousservice\n""Enableencr
yptedpasswords\n"){if(!host.encrypt)returnCMD_SUCCESS;host.encrypt=0;if(host.pas
sword_encrypt)XFREE(MTYPE_HOST,host.password_encrypt);host.password_encrypt=NULL
;if(host.enable_encrypt)XFREE(MTYPE_HOST,host.enable_encrypt);host.enable_encryp
t=NULL;returnCMD_SUCCESS;}DEFUN(config_terminal_length,config_terminal_length_cm
d,"terminallength(0-512)","Setterminallineparameters\n""Setnumberoflinesonascree
n\n""Numberoflinesonscreen(0fornopausing)\n"){intidx_number=2;vty->lines=atoi(ar
gv[idx_number]->arg);returnCMD_SUCCESS;}DEFUN(config_terminal_no_length,config_t
erminal_no_length_cmd,"terminalnolength","Setterminallineparameters\n"NO_STR"Set
numberoflinesonascreen\n"){vty->lines=-1;returnCMD_SUCCESS;}DEFUN(service_termin
al_length,service_terminal_length_cmd,"serviceterminal-length(0-512)","Setupmisc
ellaneousservice\n""Systemwideterminallengthconfiguration\n""NumberoflinesofVTY(
0meansnolinecontrol)\n"){intidx_number=2;host.lines=atoi(argv[idx_number]->arg);
returnCMD_SUCCESS;}DEFUN(no_service_terminal_length,no_service_terminal_length_c
md,"noserviceterminal-length[(0-512)]",NO_STR"Setupmiscellaneousservice\n""Syste
mwideterminallengthconfiguration\n""NumberoflinesofVTY(0meansnolinecontrol)\n"){
host.lines=-1;returnCMD_SUCCESS;}DEFUN_HIDDEN(do_echo,echo_cmd,"echoMESSAGE...",
"Echoamessagebacktothevty\n""Themessagetoecho\n"){char*message;vty_out(vty,"%s\n
",((message=argv_concat(argv,argc,1))?message:""));if(message)XFREE(MTYPE_TMP,me
ssage);returnCMD_SUCCESS;}DEFUN(config_logmsg,config_logmsg_cmd,"logmsg<emergenc
ies|alerts|critical|errors|warnings|notifications|informational|debugging>MESSAG
E...","Sendamessagetoenabledloggingdestinations\n"LOG_LEVEL_DESC"Themessagetosen
d\n"){intidx_log_level=1;intidx_message=2;intlevel;char*message;if((level=level_
match(argv[idx_log_level]->arg))==ZLOG_DISABLED)returnCMD_ERR_NO_MATCH;zlog(leve
l,"%s",((message=argv_concat(argv,argc,idx_message))?message:""));if(message)XFR
EE(MTYPE_TMP,message);returnCMD_SUCCESS;}DEFUN(show_logging,show_logging_cmd,"sh
owlogging",SHOW_STR"Showcurrentloggingconfiguration\n"){structzlog*zl=zlog_defau
lt;vty_out(vty,"Sysloglogging:");if(zl->maxlvl[ZLOG_DEST_SYSLOG]==ZLOG_DISABLED)
vty_out(vty,"disabled");elsevty_out(vty,"level%s,facility%s,ident%s",zlog_priori
ty[zl->maxlvl[ZLOG_DEST_SYSLOG]],facility_name(zl->facility),zl->ident);vty_out(
vty,"\n");vty_out(vty,"Stdoutlogging:");if(zl->maxlvl[ZLOG_DEST_STDOUT]==ZLOG_DI
SABLED)vty_out(vty,"disabled");elsevty_out(vty,"level%s",zlog_priority[zl->maxlv
l[ZLOG_DEST_STDOUT]]);vty_out(vty,"\n");vty_out(vty,"Monitorlogging:");if(zl->ma
xlvl[ZLOG_DEST_MONITOR]==ZLOG_DISABLED)vty_out(vty,"disabled");elsevty_out(vty,"
level%s",zlog_priority[zl->maxlvl[ZLOG_DEST_MONITOR]]);vty_out(vty,"\n");vty_out
(vty,"Filelogging:");if((zl->maxlvl[ZLOG_DEST_FILE]==ZLOG_DISABLED)||!zl->fp)vty
_out(vty,"disabled");elsevty_out(vty,"level%s,filename%s",zlog_priority[zl->maxl
vl[ZLOG_DEST_FILE]],zl->filename);vty_out(vty,"\n");vty_out(vty,"Protocolname:%s
\n",zl->protoname);vty_out(vty,"Recordpriority:%s\n",(zl->record_priority?"enabl
ed":"disabled"));vty_out(vty,"Timestampprecision:%d\n",zl->timestamp_precision);
returnCMD_SUCCESS;}DEFUN(config_log_stdout,config_log_stdout_cmd,"logstdout[<eme
rgencies|alerts|critical|errors|warnings|notifications|informational|debugging>]
","Loggingcontrol\n""Setstdoutlogginglevel\n"LOG_LEVEL_DESC){intidx_log_level=2;
if(argc==idx_log_level){zlog_set_level(ZLOG_DEST_STDOUT,zlog_default->default_lv
l);returnCMD_SUCCESS;}intlevel;if((level=level_match(argv[idx_log_level]->arg))=
=ZLOG_DISABLED)returnCMD_ERR_NO_MATCH;zlog_set_level(ZLOG_DEST_STDOUT,level);ret
urnCMD_SUCCESS;}DEFUN(no_config_log_stdout,no_config_log_stdout_cmd,"nologstdout
[<emergencies|alerts|critical|errors|warnings|notifications|informational|debugg
ing>]",NO_STR"Loggingcontrol\n""Cancelloggingtostdout\n"LOG_LEVEL_DESC){zlog_set
_level(ZLOG_DEST_STDOUT,ZLOG_DISABLED);returnCMD_SUCCESS;}DEFUN(config_log_monit
or,config_log_monitor_cmd,"logmonitor[<emergencies|alerts|critical|errors|warnin
gs|notifications|informational|debugging>]","Loggingcontrol\n""Setterminalline(m
onitor)logginglevel\n"LOG_LEVEL_DESC){intidx_log_level=2;if(argc==idx_log_level)
{zlog_set_level(ZLOG_DEST_MONITOR,zlog_default->default_lvl);returnCMD_SUCCESS;}
intlevel;if((level=level_match(argv[idx_log_level]->arg))==ZLOG_DISABLED)returnC
MD_ERR_NO_MATCH;zlog_set_level(ZLOG_DEST_MONITOR,level);returnCMD_SUCCESS;}DEFUN
(no_config_log_monitor,no_config_log_monitor_cmd,"nologmonitor[<emergencies|aler
ts|critical|errors|warnings|notifications|informational|debugging>]",NO_STR"Logg
ingcontrol\n""Disableterminalline(monitor)logging\n"LOG_LEVEL_DESC){zlog_set_lev
el(ZLOG_DEST_MONITOR,ZLOG_DISABLED);returnCMD_SUCCESS;}staticintset_log_file(str
uctvty*vty,constchar*fname,intloglevel){intret;char*p=NULL;constchar*fullpath;/*
Pathdetection.*/if(!IS_DIRECTORY_SEP(*fname)){charcwd[MAXPATHLEN+1];cwd[MAXPATHL
EN]='\0';if(getcwd(cwd,MAXPATHLEN)==NULL){zlog_err("config_log_file:Unabletoallo
cmem!");returnCMD_WARNING_CONFIG_FAILED;}if((p=XMALLOC(MTYPE_TMP,strlen(cwd)+str
len(fname)+2))==NULL){zlog_err("config_log_file:Unabletoallocmem!");returnCMD_WA
RNING_CONFIG_FAILED;}sprintf(p,"%s/%s",cwd,fname);fullpath=p;}elsefullpath=fname
;ret=zlog_set_file(fullpath,loglevel);if(p)XFREE(MTYPE_TMP,p);if(!ret){vty_out(v
ty,"can'topenlogfile%s\n",fname);returnCMD_WARNING_CONFIG_FAILED;}if(host.logfil
e)XFREE(MTYPE_HOST,host.logfile);host.logfile=XSTRDUP(MTYPE_HOST,fname);#ifdefin
ed(HAVE_CUMULUS)if(zlog_default->maxlvl[ZLOG_DEST_SYSLOG]!=ZLOG_DISABLED)zlog_de
fault->maxlvl[ZLOG_DEST_SYSLOG]=ZLOG_DISABLED;#endifreturnCMD_SUCCESS;}DEFUN(con
fig_log_file,config_log_file_cmd,"logfileFILENAME[<emergencies|alerts|critical|e
rrors|warnings|notifications|informational|debugging>]","Loggingcontrol\n""Loggi
ngtofile\n""Loggingfilename\n"LOG_LEVEL_DESC){intidx_filename=2;intidx_log_level
s=3;if(argc==4){intlevel;if((level=level_match(argv[idx_log_levels]->arg))==ZLOG
_DISABLED)returnCMD_ERR_NO_MATCH;returnset_log_file(vty,argv[idx_filename]->arg,
level);}elsereturnset_log_file(vty,argv[idx_filename]->arg,zlog_default->default
_lvl);}DEFUN(no_config_log_file,no_config_log_file_cmd,"nologfile[FILENAME[LEVEL
]]",NO_STR"Loggingcontrol\n""Cancelloggingtofile\n""Loggingfilename\n""Loggingle
vel\n"){zlog_reset_file();if(host.logfile)XFREE(MTYPE_HOST,host.logfile);host.lo
gfile=NULL;returnCMD_SUCCESS;}DEFUN(config_log_syslog,config_log_syslog_cmd,"log
syslog[<emergencies|alerts|critical|errors|warnings|notifications|informational|
debugging>]","Loggingcontrol\n""Setsysloglogginglevel\n"LOG_LEVEL_DESC){intidx_l
og_levels=2;if(argc==3){intlevel;if((level=level_match(argv[idx_log_levels]->arg
))==ZLOG_DISABLED)returnCMD_ERR_NO_MATCH;zlog_set_level(ZLOG_DEST_SYSLOG,level);
returnCMD_SUCCESS;}else{zlog_set_level(ZLOG_DEST_SYSLOG,zlog_default->default_lv
l);returnCMD_SUCCESS;}}DEFUN(no_config_log_syslog,no_config_log_syslog_cmd,"nolo
gsyslog[<kern|user|mail|daemon|auth|syslog|lpr|news|uucp|cron|local0|local1|loca
l2|local3|local4|local5|local6|local7>][<emergencies|alerts|critical|errors|warn
ings|notifications|informational|debugging>]",NO_STR"Loggingcontrol\n""Cancellog
gingtosyslog\n"LOG_FACILITY_DESCLOG_LEVEL_DESC){zlog_set_level(ZLOG_DEST_SYSLOG,
ZLOG_DISABLED);returnCMD_SUCCESS;}DEFUN(config_log_facility,config_log_facility_
cmd,"logfacility<kern|user|mail|daemon|auth|syslog|lpr|news|uucp|cron|local0|loc
al1|local2|local3|local4|local5|local6|local7>","Loggingcontrol\n""Facilityparam
eterforsyslogmessages\n"LOG_FACILITY_DESC){intidx_target=2;intfacility=facility_
match(argv[idx_target]->arg);zlog_default->facility=facility;returnCMD_SUCCESS;}
DEFUN(no_config_log_facility,no_config_log_facility_cmd,"nologfacility[<kern|use
r|mail|daemon|auth|syslog|lpr|news|uucp|cron|local0|local1|local2|local3|local4|
local5|local6|local7>]",NO_STR"Loggingcontrol\n""Resetsyslogfacilitytodefault(da
emon)\n"LOG_FACILITY_DESC){zlog_default->facility=LOG_DAEMON;returnCMD_SUCCESS;}
DEFUN_DEPRECATED(config_log_trap,config_log_trap_cmd,"logtrap<emergencies|alerts
|critical|errors|warnings|notifications|informational|debugging>","Loggingcontro
l\n""(Deprecated)Setlogginglevelanddefaultforalldestinations\n"LOG_LEVEL_DESC){i
ntnew_level;inti;if((new_level=level_match(argv[2]->arg))==ZLOG_DISABLED)returnC
MD_ERR_NO_MATCH;zlog_default->default_lvl=new_level;for(i=0;i<ZLOG_NUM_DESTS;i++
)if(zlog_default->maxlvl[i]!=ZLOG_DISABLED)zlog_default->maxlvl[i]=new_level;ret
urnCMD_SUCCESS;}DEFUN_DEPRECATED(no_config_log_trap,no_config_log_trap_cmd,"nolo
gtrap[emergencies|alerts|critical|errors|warnings|notifications|informational|de
bugging]",NO_STR"Loggingcontrol\n""Permitalllogginginformation\n"LOG_LEVEL_DESC)
{zlog_default->default_lvl=LOG_DEBUG;returnCMD_SUCCESS;}DEFUN(config_log_record_
priority,config_log_record_priority_cmd,"logrecord-priority","Loggingcontrol\n""
Logthepriorityofthemessagewithinthemessage\n"){zlog_default->record_priority=1;r
eturnCMD_SUCCESS;}DEFUN(no_config_log_record_priority,no_config_log_record_prior
ity_cmd,"nologrecord-priority",NO_STR"Loggingcontrol\n""Donotlogthepriorityofthe
messagewithinthemessage\n"){zlog_default->record_priority=0;returnCMD_SUCCESS;}D
EFUN(config_log_timestamp_precision,config_log_timestamp_precision_cmd,"logtimes
tampprecision(0-6)","Loggingcontrol\n""Timestampconfiguration\n""Setthetimestamp
precision\n""Numberofsubseconddigits\n"){intidx_number=3;zlog_default->timestamp
_precision=strtoul(argv[idx_number]->arg,NULL,10);returnCMD_SUCCESS;}DEFUN(no_co
nfig_log_timestamp_precision,no_config_log_timestamp_precision_cmd,"nologtimesta
mpprecision",NO_STR"Loggingcontrol\n""Timestampconfiguration\n""Resetthetimestam
pprecisiontothedefaultvalueof0\n"){zlog_default->timestamp_precision=0;returnCMD
_SUCCESS;}DEFUN(debug_memstats,debug_memstats_cmd,"[no]debugmemstats-at-exit",NO
_STRDEBUG_STR"Printmemorytypestatisticsatexit\n"){debug_memstats_at_exit=!!strcm
p(argv[0]->text,"no");returnCMD_SUCCESS;}intcmd_banner_motd_file(constchar*file)
{intsuccess=CMD_SUCCESS;charp[PATH_MAX];char*rpath;char*in;rpath=realpath(file,p
);if(!rpath)returnCMD_ERR_NO_FILE;in=strstr(rpath,SYSCONFDIR);if(in==rpath){if(h
ost.motdfile)XFREE(MTYPE_HOST,host.motdfile);host.motdfile=XSTRDUP(MTYPE_HOST,fi
le);}elsesuccess=CMD_WARNING_CONFIG_FAILED;returnsuccess;}DEFUN(banner_motd_file
,banner_motd_file_cmd,"bannermotdfileFILE","Setbanner\n""Bannerformotd\n""Banner
fromafile\n""Filename\n"){intidx_file=3;constchar*filename=argv[idx_file]->arg;i
ntcmd=cmd_banner_motd_file(filename);if(cmd==CMD_ERR_NO_FILE)vty_out(vty,"%sdoes
notexist",filename);elseif(cmd==CMD_WARNING_CONFIG_FAILED)vty_out(vty,"%smustbei
n%s",filename,SYSCONFDIR);returncmd;}DEFUN(banner_motd_default,banner_motd_defau
lt_cmd,"bannermotddefault","Setbannerstring\n""Stringsformotd\n""Defaultstring\n
"){host.motd=default_motd;returnCMD_SUCCESS;}DEFUN(no_banner_motd,no_banner_motd
_cmd,"nobannermotd",NO_STR"Setbannerstring\n""Stringsformotd\n"){host.motd=NULL;
if(host.motdfile)XFREE(MTYPE_HOST,host.motdfile);host.motdfile=NULL;returnCMD_SU
CCESS;}DEFUN(find,find_cmd,"findCOMMAND...","FindCLIcommandcontainingtext\n""Tex
ttosearchfor\n"){char*text=argv_concat(argv,argc,1);conststructcmd_node*node;con
ststructcmd_element*cli;vectorclis;for(unsignedinti=0;i<vector_active(cmdvec);i+
+){node=vector_slot(cmdvec,i);if(!node)continue;clis=node->cmd_vector;for(unsign
edintj=0;j<vector_active(clis);j++){cli=vector_slot(clis,j);if(strcasestr(cli->s
tring,text))vty_out(vty,"(%s)%s\n",node_names[node->node],cli->string);}}XFREE(M
TYPE_TMP,text);returnCMD_SUCCESS;}/*Setconfigfilename.Calledfromvty.c*/voidhost_
config_set(constchar*filename){if(host.config)XFREE(MTYPE_HOST,host.config);host
.config=XSTRDUP(MTYPE_HOST,filename);}constchar*host_config_get(void){returnhost
.config;}voidinstall_default(enumnode_typenode){install_element(node,&config_exi
t_cmd);install_element(node,&config_quit_cmd);install_element(node,&config_end_c
md);install_element(node,&config_help_cmd);install_element(node,&config_list_cmd
);install_element(node,&find_cmd);install_element(node,&config_write_cmd);instal
l_element(node,&show_running_config_cmd);install_element(node,&autocomplete_cmd)
;}/*Initializecommandinterface.Installbasicnodesandcommands.**terminal=0--vtysh/
nologging,noconfigcontrol*terminal=1--normaldaemon*terminal=-1--watchfrr/nologgi
ng,butminimalconfigcontrol*/voidcmd_init(intterminal){structutsnamenames;if(arra
y_size(node_names)!=NODE_TYPE_MAX)assert(!"UpdatetheCLInodedescriptionarray!");u
name(&names);qobj_init();varhandlers=list_new();/*Allocateinitialtopvectorofcomm
ands.*/cmdvec=vector_init(VECTOR_MIN_SIZE);/*Defaulthostvaluesettings.*/host.nam
e=XSTRDUP(MTYPE_HOST,names.nodename);#ifdefHAVE_STRUCT_UTSNAME_DOMAINNAMEif((str
cmp(names.domainname,"(none)")==0))host.domainname=NULL;elsehost.domainname=XSTR
DUP(MTYPE_HOST,names.domainname);#elsehost.domainname=NULL;#endifhost.password=N
ULL;host.enable=NULL;host.logfile=NULL;host.config=NULL;host.noconfig=(terminal<
0);host.lines=-1;host.motd=default_motd;host.motdfile=NULL;/*Installtopnodes.*/i
nstall_node(&view_node,NULL);install_node(&enable_node,NULL);install_node(&auth_
node,NULL);install_node(&auth_enable_node,NULL);install_node(&config_node,config
_write_host);/*Eachnode'sbasiccommands.*/install_element(VIEW_NODE,&show_version
_cmd);install_element(ENABLE_NODE,&show_startup_config_cmd);install_element(ENAB
LE_NODE,&debug_memstats_cmd);if(terminal){install_element(VIEW_NODE,&config_list
_cmd);install_element(VIEW_NODE,&config_exit_cmd);install_element(VIEW_NODE,&con
fig_quit_cmd);install_element(VIEW_NODE,&config_help_cmd);install_element(VIEW_N
ODE,&config_enable_cmd);install_element(VIEW_NODE,&config_terminal_length_cmd);i
nstall_element(VIEW_NODE,&config_terminal_no_length_cmd);install_element(VIEW_NO
DE,&show_logging_cmd);install_element(VIEW_NODE,&show_commandtree_cmd);install_e
lement(VIEW_NODE,&echo_cmd);install_element(VIEW_NODE,&autocomplete_cmd);install
_element(VIEW_NODE,&find_cmd);install_element(ENABLE_NODE,&config_end_cmd);insta
ll_element(ENABLE_NODE,&config_disable_cmd);install_element(ENABLE_NODE,&config_
terminal_cmd);install_element(ENABLE_NODE,&copy_runningconf_startupconf_cmd);ins
tall_element(ENABLE_NODE,&config_write_cmd);install_element(ENABLE_NODE,&show_ru
nning_config_cmd);install_element(ENABLE_NODE,&config_logmsg_cmd);install_defaul
t(CONFIG_NODE);thread_cmd_init();workqueue_cmd_init();hash_cmd_init();}install_e
lement(CONFIG_NODE,&hostname_cmd);install_element(CONFIG_NODE,&no_hostname_cmd);
install_element(CONFIG_NODE,&domainname_cmd);install_element(CONFIG_NODE,&no_dom
ainname_cmd);install_element(CONFIG_NODE,&frr_version_defaults_cmd);install_elem
ent(CONFIG_NODE,&debug_memstats_cmd);if(terminal>0){install_element(CONFIG_NODE,
&password_cmd);install_element(CONFIG_NODE,&enable_password_cmd);install_element
(CONFIG_NODE,&no_enable_password_cmd);install_element(CONFIG_NODE,&config_log_st
dout_cmd);install_element(CONFIG_NODE,&no_config_log_stdout_cmd);install_element
(CONFIG_NODE,&config_log_monitor_cmd);install_element(CONFIG_NODE,&no_config_log
_monitor_cmd);install_element(CONFIG_NODE,&config_log_file_cmd);install_element(
CONFIG_NODE,&no_config_log_file_cmd);install_element(CONFIG_NODE,&config_log_sys
log_cmd);install_element(CONFIG_NODE,&no_config_log_syslog_cmd);install_element(
CONFIG_NODE,&config_log_facility_cmd);install_element(CONFIG_NODE,&no_config_log
_facility_cmd);install_element(CONFIG_NODE,&config_log_trap_cmd);install_element
(CONFIG_NODE,&no_config_log_trap_cmd);install_element(CONFIG_NODE,&config_log_re
cord_priority_cmd);install_element(CONFIG_NODE,&no_config_log_record_priority_cm
d);install_element(CONFIG_NODE,&config_log_timestamp_precision_cmd);install_elem
ent(CONFIG_NODE,&no_config_log_timestamp_precision_cmd);install_element(CONFIG_N
ODE,&service_password_encrypt_cmd);install_element(CONFIG_NODE,&no_service_passw
ord_encrypt_cmd);install_element(CONFIG_NODE,&banner_motd_default_cmd);install_e
lement(CONFIG_NODE,&banner_motd_file_cmd);install_element(CONFIG_NODE,&no_banner
_motd_cmd);install_element(CONFIG_NODE,&service_terminal_length_cmd);install_ele
ment(CONFIG_NODE,&no_service_terminal_length_cmd);vrf_install_commands();}#ifdef
DEV_BUILDgrammar_sandbox_init();#endif}voidcmd_terminate(){structcmd_node*cmd_no
de;if(cmdvec){for(unsignedinti=0;i<vector_active(cmdvec);i++)if((cmd_node=vector
_slot(cmdvec,i))!=NULL){//deletingthegraphdeletsthecmd_elementas//wellgraph_dele
te_graph(cmd_node->cmdgraph);vector_free(cmd_node->cmd_vector);hash_clean(cmd_no
de->cmd_hash,NULL);hash_free(cmd_node->cmd_hash);cmd_node->cmd_hash=NULL;}vector
_free(cmdvec);cmdvec=NULL;}if(host.name)XFREE(MTYPE_HOST,host.name);if(host.doma
inname)XFREE(MTYPE_HOST,host.domainname);if(host.password)XFREE(MTYPE_HOST,host.
password);if(host.password_encrypt)XFREE(MTYPE_HOST,host.password_encrypt);if(ho
st.enable)XFREE(MTYPE_HOST,host.enable);if(host.enable_encrypt)XFREE(MTYPE_HOST,
host.enable_encrypt);if(host.logfile)XFREE(MTYPE_HOST,host.logfile);if(host.motd
file)XFREE(MTYPE_HOST,host.motdfile);if(host.config)XFREE(MTYPE_HOST,host.config
);list_delete_and_null(&varhandlers);qobj_finish();}