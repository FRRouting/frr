/**libzebraZeroMQbindings*Copyright(C)2015DavidLamparter**Thisprogramisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(atyouropti
on)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,butWIT
HOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPAR
TICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshouldhaverecei
vedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifno
t,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-
1301USA*/#ifndef_FRRZMQ_H#define_FRRZMQ_H#include"thread.h"#include<zmq.h>/*link
ing/packagingnote:thisisaseparatelibrarythatneedstobe*linkedintoanydaemon/librar
y/modulethatwishestouseits*functionality.Thepurposeofthisistoencapsulatethelibzm
q*dependencyandnotmakelibfrr/FRRitselfdependonlibzmq.**libfrrzmqshouldbeputinLDF
LAGS/LIBADD*before*eitherlibfrror*libzmq,andbothoftheseshouldalwaysbelisted,e.g.
*foo_LDFLAGS=libfrrzmq.lalibfrr.la$(ZEROMQ_LIBS)*//*callbackintegration*/structc
b_core{structthread*thread;void*arg;boolcancelled;void(*cb_msg)(void*arg,void*zm
qsock);void(*cb_part)(void*arg,void*zmqsock,zmq_msg_t*msg,unsignedpartnum);void(
*cb_error)(void*arg,void*zmqsock);};structfrrzmq_cb{void*zmqsock;intfd;structcb_
coreread;structcb_corewrite;};/*libzmq'scontext**thisismostlyhereasaconvenience,
ithasIPv6enabledbutnothing*elseistiedtoit;youcanuseaseparatecontextwithoutproble
ms*/externvoid*frrzmq_context;externvoidfrrzmq_init(void);externvoidfrrzmq_finis
h(void);#definedebugargdefconstchar*funcname,constchar*schedfrom,intfromln/*core
eventregistration,oneofthese2macrosshouldbeused*/#definefrrzmq_thread_add_read_m
sg(m,f,e,a,z,d)\funcname_frrzmq_thread_add_read(m,f,NULL,e,a,z,d,#f,__FILE__,\__
LINE__)#definefrrzmq_thread_add_read_part(m,f,e,a,z,d)\funcname_frrzmq_thread_ad
d_read(m,NULL,f,e,a,z,d,#f,__FILE__,\__LINE__)#definefrrzmq_thread_add_write_msg
(m,f,e,a,z,d)\funcname_frrzmq_thread_add_write(m,f,e,a,z,d,#f,__FILE__,\__LINE__
)structcb_core;structfrrzmq_cb;/*SetupaPOLLINorPOLLOUTnotificationtobecalledfrom
thelibfrrmain*loop.Thishasthefollowingproperties:**-sinceZeroMQworkswithedgetrig
gerednotifications,itwillloopand*dispatchasmanyeventsasZeroMQhaspendingatthetime
libfrrcalls*intothiscode*-duetothislooping(whichmeansitnon-single-issue),thecall
backis*alsopersistent.Do_NOT_re-registertheeventinsideofyour*callbackfunction.*-
eithermsgfuncorpartfuncwillbecalled(onlyonecanbespecified)*-msgfunciscalledoncef
oreachincomingmessage*-ifpartfuncisspecified,themessageisreadandpartfunciscalled
*foreachZeroMQmulti-partsubpart.Notethatyoucan'tsendreplies*beforeallpartshavebe
enreadbecausethatviolatestheZeroMQFSM.*-writeversiondoesn'tallowforpartialcallba
ck,youmusthandlethe*wholemessage(allparts)inmsgfunccallback*-youcansafelycancelt
hecallbackfromwithinitself*-installingacallbackwillcheckforpendingevents(ZMQ_EVE
NTS)and*mayscheduletheeventtorunassoonaslibfrrisbackinitsmain*loop.*/externintfu
ncname_frrzmq_thread_add_read(structthread_master*master,void(*msgfunc)(void*arg
,void*zmqsock),void(*partfunc)(void*arg,void*zmqsock,zmq_msg_t*msg,unsignedpartn
um),void(*errfunc)(void*arg,void*zmqsock),void*arg,void*zmqsock,structfrrzmq_cb*
*cb,debugargdef);externintfuncname_frrzmq_thread_add_write(structthread_master*m
aster,void(*msgfunc)(void*arg,void*zmqsock),void(*errfunc)(void*arg,void*zmqsock
),void*arg,void*zmqsock,structfrrzmq_cb**cb,debugargdef);externvoidfrrzmq_thread
_cancel(structfrrzmq_cb**cb,structcb_core*core);/**http://api.zeromq.org/4-2:zmq
-getsockopt#toc10**Asthedescriptorisedgetriggered,applicationsmustupdatethestate
of*ZMQ_EVENTSaftereachinvocationofzmq_sendorzmq_recv.Tobemoreexplicit:*aftercall
ingzmq_sendthesocketmaybecomereadable(andviceversa)*withouttriggeringareadevento
nthefiledescriptor.*/externvoidfrrzmq_check_events(structfrrzmq_cb**cbp,structcb
_core*core,intevent);#endif/*_FRRZMQ_H*/