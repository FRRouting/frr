/**clippy(CLIpreparatorinpython)wrapperforFRRcommand_graph*Copyright(C)2016-2017
DavidLamparterforNetDEF,Inc.**Thisprogramisfreesoftware;youcanredistributeitand/
ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*Softwar
eFoundation;eitherversion2oftheLicense,or(atyouroption)*anylaterversion.**Thispr
ogramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteven
theimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGene
ralPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPubli
cLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Fou
ndation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*note:thiswrapperi
sintendedtobeusedasbuild-timehelper.while*itshouldbegenerallycorrectandproper,th
eremaybetheoccasional*memoryleakorSEGVforthingsthathaven'tbeenwell-tested.*/#inc
lude<Python.h>#include"structmember.h"#include<string.h>#include<stdlib.h>#inclu
de"command_graph.h"#include"clippy.h"structwrap_graph;staticPyObject*graph_to_py
obj(structwrap_graph*graph,structgraph_node*gn);/**nodesarewrappedasfollows:*-in
stancescanonlybeacquiredfromagraph*-thesamenodewillreturnthesamewrapperobject(th
ey'rebuffered*through"idx")*-areferenceisheldontothegraph*-fieldsarecopiedforeas
yaccesswithPyMemberDef*/structwrap_graph_node{PyObject_HEADboolallowrepeat;const
char*type;booldeprecated;boolhidden;constchar*text;constchar*desc;constchar*varn
ame;longlongmin,max;structgraph_node*node;structwrap_graph*wgraph;size_tidx;};/*
*graphsarewrappedasfollows:*-theycanonlybecreatedbyparsingadefinitionstring*-the
re'satablehereforthewrappednodes(nodewrappers),indexed*by"idx"(correspondstonode
'spositioningraph'stableofnodes)*-graphsdoNOTholdreferencestonodes(wouldbecircul
ar)*/structwrap_graph{PyObject_HEADchar*definition;structgraph*graph;structwrap_
graph_node**nodewrappers;};staticPyObject*refuse_new(PyTypeObject*type,PyObject*
args,PyObject*kwds){PyErr_SetString(PyExc_ValueError,"cannotcreateinstancesofthi
stype");returnNULL;}#definemember(name,type)\{\(char*)#name,type,offsetof(struct
wrap_graph_node,name),\READONLY,(char*)#name"("#type")"\}staticPyMemberDefmember
s_graph_node[]={member(allowrepeat,T_BOOL),member(type,T_STRING),member(deprecat
ed,T_BOOL),member(hidden,T_BOOL),member(text,T_STRING),member(desc,T_STRING),mem
ber(min,T_LONGLONG),member(max,T_LONGLONG),member(varname,T_STRING),{},};#undefm
ember/**node.next()--returnslistofall"next"nodes.*thiswillincludecirclesifthegra
phhasthem.*/staticPyObject*graph_node_next(PyObject*self,PyObject*args){structwr
ap_graph_node*wrap=(structwrap_graph_node*)self;PyObject*pylist;if(wrap->node->d
ata&&((structcmd_token*)wrap->node->data)->type==END_TKN)returnPyList_New(0);pyl
ist=PyList_New(vector_active(wrap->node->to));for(size_ti=0;i<vector_active(wrap
->node->to);i++){structgraph_node*gn=vector_slot(wrap->node->to,i);PyList_SetIte
m(pylist,i,graph_to_pyobj(wrap->wgraph,gn));}returnpylist;};/**node.join()--retu
rnFORK'sJOINnodeorNone*/staticPyObject*graph_node_join(PyObject*self,PyObject*ar
gs){structwrap_graph_node*wrap=(structwrap_graph_node*)self;if(!wrap->node->data
||((structcmd_token*)wrap->node->data)->type==END_TKN)Py_RETURN_NONE;structcmd_t
oken*tok=wrap->node->data;if(tok->type!=FORK_TKN)Py_RETURN_NONE;returngraph_to_p
yobj(wrap->wgraph,tok->forkjoin);};staticPyMethodDefmethods_graph_node[]={{"next
",graph_node_next,METH_NOARGS,"outboundgraphedgelist"},{"join",graph_node_join,M
ETH_NOARGS,"outboundjoinnode"},{}};staticvoidgraph_node_wrap_free(void*arg){stru
ctwrap_graph_node*wrap=arg;wrap->wgraph->nodewrappers[wrap->idx]=NULL;Py_DECREF(
wrap->wgraph);}staticPyTypeObjecttypeobj_graph_node={PyVarObject_HEAD_INIT(NULL,
0).tp_name="_clippy.GraphNode",.tp_basicsize=sizeof(structwrap_graph_node),.tp_f
lags=Py_TPFLAGS_DEFAULT,.tp_doc="structgraph_node*",.tp_new=refuse_new,.tp_free=
graph_node_wrap_free,.tp_members=members_graph_node,.tp_methods=methods_graph_no
de,};staticPyObject*graph_to_pyobj(structwrap_graph*wgraph,structgraph_node*gn){
structwrap_graph_node*wrap;size_ti;for(i=0;i<vector_active(wgraph->graph->nodes)
;i++)if(vector_slot(wgraph->graph->nodes,i)==gn)break;if(i==vector_active(wgraph
->graph->nodes)){PyErr_SetString(PyExc_ValueError,"cannotfindnodeingraph");retur
nNULL;}if(wgraph->nodewrappers[i]){PyObject*obj=(PyObject*)wgraph->nodewrappers[
i];Py_INCREF(obj);returnobj;}wrap=(structwrap_graph_node*)typeobj_graph_node.tp_
alloc(&typeobj_graph_node,0);if(!wrap)returnNULL;wgraph->nodewrappers[i]=wrap;Py
_INCREF(wgraph);wrap->idx=i;wrap->wgraph=wgraph;wrap->node=gn;wrap->type="NULL";
wrap->allowrepeat=false;if(gn->data){structcmd_token*tok=gn->data;switch(tok->ty
pe){#defineitem(x)casex:wrap->type=#x;break;item(WORD_TKN)//wordsitem(VARIABLE_T
KN)//almostanythingitem(RANGE_TKN)//integerrangeitem(IPV4_TKN)//IPV4addressesite
m(IPV4_PREFIX_TKN)//IPV4networkprefixesitem(IPV6_TKN)//IPV6prefixesitem(IPV6_PRE
FIX_TKN)//IPV6networkprefixesitem(MAC_TKN)//MACaddressitem(MAC_PREFIX_TKN)//MACa
ddresswithmask/*plumbingtypes*/item(FORK_TKN)item(JOIN_TKN)item(START_TKN)item(E
ND_TKN)default:wrap->type="???";}wrap->deprecated=(tok->attr==CMD_ATTR_DEPRECATE
D);wrap->hidden=(tok->attr==CMD_ATTR_HIDDEN);wrap->text=tok->text;wrap->desc=tok
->desc;wrap->varname=tok->varname;wrap->min=tok->min;wrap->max=tok->max;wrap->al
lowrepeat=tok->allowrepeat;}return(PyObject*)wrap;}#definemember(name,type)\{\(c
har*)#name,type,offsetof(structwrap_graph,name),\READONLY,(char*)#name"("#type")
"\}staticPyMemberDefmembers_graph[]={member(definition,T_STRING),{},};#undefmemb
er/*graph.first()-rootnode*/staticPyObject*graph_first(PyObject*self,PyObject*ar
gs){structwrap_graph*gwrap=(structwrap_graph*)self;structgraph_node*gn=vector_sl
ot(gwrap->graph->nodes,0);returngraph_to_pyobj(gwrap,gn);};staticPyMethodDefmeth
ods_graph[]={{"first",graph_first,METH_NOARGS,"firstgraphnode"},{}};staticPyObje
ct*graph_parse(PyTypeObject*type,PyObject*args,PyObject*kwds);staticvoidgraph_wr
ap_free(void*arg){structwrap_graph*wgraph=arg;graph_delete_graph(wgraph->graph);
free(wgraph->nodewrappers);free(wgraph->definition);}staticPyTypeObjecttypeobj_g
raph={PyVarObject_HEAD_INIT(NULL,0).tp_name="_clippy.Graph",.tp_basicsize=sizeof
(structwrap_graph),.tp_flags=Py_TPFLAGS_DEFAULT,.tp_doc="structgraph*",.tp_new=g
raph_parse,.tp_free=graph_wrap_free,.tp_members=members_graph,.tp_methods=method
s_graph,};/*topcall/entrypointforpythoncode*/staticPyObject*graph_parse(PyTypeOb
ject*type,PyObject*args,PyObject*kwds){constchar*def,*doc=NULL;structwrap_graph*
gwrap;staticconstchar*kwnames[]={"cmddef","doc",NULL};gwrap=(structwrap_graph*)t
ypeobj_graph.tp_alloc(&typeobj_graph,0);if(!gwrap)returnNULL;if(!PyArg_ParseTupl
eAndKeywords(args,kwds,"s|s",(char**)kwnames,&def,&doc))returnNULL;structgraph*g
raph=graph_new();structcmd_token*token=cmd_token_new(START_TKN,0,NULL,NULL);grap
h_new_node(graph,token,(void(*)(void*))&cmd_token_del);structcmd_elementcmd={.st
ring=def,.doc=doc};cmd_graph_parse(graph,&cmd);cmd_graph_names(graph);gwrap->gra
ph=graph;gwrap->definition=strdup(def);gwrap->nodewrappers=calloc(vector_active(
graph->nodes),sizeof(gwrap->nodewrappers[0]));return(PyObject*)gwrap;}staticPyMe
thodDefclippy_methods[]={{"parse",clippy_parse,METH_VARARGS,"ParseaCfile"},{NULL
,NULL,0,NULL}};#ifPY_MAJOR_VERSION>=3staticstructPyModuleDefpymoddef_clippy={PyM
oduleDef_HEAD_INIT,"_clippy",NULL,/*docstring*/-1,clippy_methods,};#definemodcre
ate()PyModule_Create(&pymoddef_clippy)#defineinitret(val)returnval;#else#definem
odcreate()Py_InitModule("_clippy",clippy_methods)#defineinitret(val)\do{\if(!val
)\Py_FatalError("initializationfailure");\return;\}while(0)#endifPyMODINIT_FUNCc
ommand_py_init(void){PyObject*pymod;if(PyType_Ready(&typeobj_graph_node)<0)initr
et(NULL);if(PyType_Ready(&typeobj_graph)<0)initret(NULL);pymod=modcreate();if(!p
ymod)initret(NULL);Py_INCREF(&typeobj_graph_node);PyModule_AddObject(pymod,"Grap
hNode",(PyObject*)&typeobj_graph_node);Py_INCREF(&typeobj_graph);PyModule_AddObj
ect(pymod,"Graph",(PyObject*)&typeobj_graph);initret(pymod);}