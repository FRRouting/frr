/**libfrroverallmanagementfunctions**Copyright(C)2016DavidLamparterforNetDEF,Inc
.**Thisprogramisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoft
heGNUGeneralPublicLicenseaspublishedbytheFree*SoftwareFoundation;eitherversion2o
ftheLicense,or(atyouroption)*anylaterversion.**Thisprogramisdistributedinthehope
thatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHAN
TABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredet
ails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogr
am;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,F
ifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<sys/un.h>#include<sy
s/types.h>#include<sys/wait.h>#include"libfrr.h"#include"getopt.h"#include"privs
.h"#include"vty.h"#include"command.h"#include"version.h"#include"memory_vty.h"#i
nclude"zclient.h"#include"log_int.h"#include"module.h"#include"network.h"DEFINE_
HOOK(frr_late_init,(structthread_master*tm),(tm))DEFINE_KOOH(frr_early_fini,(),(
))DEFINE_KOOH(frr_fini,(),())constcharfrr_sysconfdir[]=SYSCONFDIR;constcharfrr_v
tydir[]=DAEMON_VTY_DIR;constcharfrr_moduledir[]=MODULE_PATH;charfrr_protoname[25
6]="NONE";charfrr_protonameinst[256]="NONE";charconfig_default[256];charfrr_zcli
entpath[256];staticcharpidfile_default[256];staticcharvtypath_default[256];boold
ebug_memstats_at_exit=0;staticcharcomb_optstr[256];staticstructoptioncomb_lo[64]
;staticstructoption*comb_next_lo=&comb_lo[0];staticcharcomb_helpstr[4096];struct
optspec{constchar*optstr;constchar*helpstr;conststructoption*longopts;};staticvo
idopt_extend(conststructoptspec*os){conststructoption*lo;strcat(comb_optstr,os->
optstr);strcat(comb_helpstr,os->helpstr);for(lo=os->longopts;lo->name;lo++)memcp
y(comb_next_lo++,lo,sizeof(*lo));}#defineOPTION_VTYSOCK1000#defineOPTION_MODULED
IR1002staticconststructoptionlo_always[]={{"help",no_argument,NULL,'h'},{"versio
n",no_argument,NULL,'v'},{"daemon",no_argument,NULL,'d'},{"module",no_argument,N
ULL,'M'},{"vty_socket",required_argument,NULL,OPTION_VTYSOCK},{"moduledir",requi
red_argument,NULL,OPTION_MODULEDIR},{NULL}};staticconststructoptspecos_always={"
hvdM:","-h,--helpDisplaythishelpandexit\n""-v,--versionPrintprogramversion\n""-d
,--daemonRunsindaemonmode\n""-M,--moduleLoadspecifiedmodule\n""--vty_socketOverr
idevtysocketpath\n""--moduledirOverridemodulesdirectory\n",lo_always};staticcons
tstructoptionlo_cfg_pid_dry[]={{"pid_file",required_argument,NULL,'i'},{"config_
file",required_argument,NULL,'f'},{"pathspace",required_argument,NULL,'N'},{"dry
run",no_argument,NULL,'C'},{"terminal",no_argument,NULL,'t'},{NULL}};staticconst
structoptspecos_cfg_pid_dry={"f:i:CtN:","-f,--config_fileSetconfigurationfilenam
e\n""-i,--pid_fileSetprocessidentifierfilename\n""-N,--pathspaceInsertprefixinto
config&socketpaths\n""-C,--dryrunCheckconfigurationforvalidityandexit\n""-t,--te
rminalOpenterminalsessiononstdio\n""-d-tDaemonizeafterterminalsessionends\n",lo_
cfg_pid_dry};staticconststructoptionlo_zclient[]={{"socket",required_argument,NU
LL,'z'},{NULL}};staticconststructoptspecos_zclient={"z:","-z,--socketSetpathofze
brasocket\n",lo_zclient};staticconststructoptionlo_vty[]={{"vty_addr",required_a
rgument,NULL,'A'},{"vty_port",required_argument,NULL,'P'},{NULL}};staticconststr
uctoptspecos_vty={"A:P:","-A,--vty_addrSetvty'sbindaddress\n""-P,--vty_portSetvt
y'sportnumber\n",lo_vty};staticconststructoptionlo_user[]={{"user",required_argu
ment,NULL,'u'},{"group",required_argument,NULL,'g'},{NULL}};staticconststructopt
specos_user={"u:g:","-u,--userUsertorunas\n""-g,--groupGrouptorunas\n",lo_user};
boolfrr_zclient_addr(structsockaddr_storage*sa,socklen_t*sa_len,constchar*path){
memset(sa,0,sizeof(*sa));if(!path)path=ZEBRA_SERV_PATH;if(!strncmp(path,ZAPI_TCP
_PATHNAME,strlen(ZAPI_TCP_PATHNAME))){/*note:thisfunctionalityisdisabledatbottom
*/intaf;intport=ZEBRA_PORT;char*err=NULL;structsockaddr_in*sin=NULL;structsockad
dr_in6*sin6=NULL;path+=strlen(ZAPI_TCP_PATHNAME);switch(path[0]){case'4':path++;
af=AF_INET;break;case'6':path++;/*fallthrough*/default:af=AF_INET6;break;}switch
(path[0]){case'\0':break;case':':path++;port=strtoul(path,&err,10);if(*err||!*pa
th)returnfalse;break;default:returnfalse;}sa->ss_family=af;switch(af){caseAF_INE
T:sin=(structsockaddr_in*)sa;sin->sin_port=htons(port);sin->sin_addr.s_addr=hton
l(INADDR_LOOPBACK);*sa_len=sizeof(structsockaddr_in);#ifdefHAVE_STRUCT_SOCKADDR_
IN_SIN_LENsin->sin_len=*sa_len;#endifbreak;caseAF_INET6:sin6=(structsockaddr_in6
*)sa;sin6->sin6_port=htons(port);inet_pton(AF_INET6,"::1",&sin6->sin6_addr);*sa_
len=sizeof(structsockaddr_in6);#ifdefSIN6_LENsin6->sin6_len=*sa_len;#endifbreak;
}#if1/*force-disablethispath,becausetcp-zebraisa*SECURITYISSUE.therearenochecksa
tallagainst*untrustedusersonthelocalsystemconnectingonTCP*andinjectingbogusrouti
ngdataintotheentirerouting*domain.**Thefunctionalityisonlyleftherebecauseitmaybe
*usefulduringdevelopment,inordertobeabletoget*tcpdumporwiresharkwatchingZAPIasTC
P.Ifyouwant*todothat,flipthe#if1aboveto#if0.*/memset(sa,0,sizeof(*sa));returnfal
se;#endif}else{/*"sun"isa#defineonsolaris*/structsockaddr_un*suna=(structsockadd
r_un*)sa;suna->sun_family=AF_UNIX;strlcpy(suna->sun_path,path,sizeof(suna->sun_p
ath));#ifdefHAVE_STRUCT_SOCKADDR_UN_SUN_LEN*sa_len=suna->sun_len=SUN_LEN(suna);#
else*sa_len=sizeof(suna->sun_family)+strlen(suna->sun_path);#endif/*HAVE_STRUCT_
SOCKADDR_UN_SUN_LEN*/#if0/*thisislefthereforfuturereference;Linuxabstract*socket
namespacesupportcanbeenabledbyreplacing*above#if0with#ifdefGNU_LINUX.**THISISASE
CURITYISSUE,theabstractsocketnamespace*doesnothaveuser/grouppermissioncontrolons
ockets.*we'dneedtoimplementSCM_CREDENTIALSsupportfirstto*checkthatonlyproperuser
scanconnecttoabstract*sockets.(sameproblemastcp-zebra,exceptthereisa*fixwithSCM_
CREDENTIALS.tcp-zebrahasnosuchfix.)*/if(suna->sun_path[0]=='@')suna->sun_path[0]
='\0';#endif}returntrue;}staticstructfrr_daemon_info*di=NULL;voidfrr_preinit(str
uctfrr_daemon_info*daemon,intargc,char**argv){di=daemon;/*basename(),opencoded.*
/char*p=strrchr(argv[0],'/');di->progname=p?p+1:argv[0];umask(0027);opt_extend(&
os_always);if(!(di->flags&FRR_NO_CFG_PID_DRY))opt_extend(&os_cfg_pid_dry);if(!(d
i->flags&FRR_NO_PRIVSEP))opt_extend(&os_user);if(!(di->flags&FRR_NO_ZCLIENT))opt
_extend(&os_zclient);if(!(di->flags&FRR_NO_TCPVTY))opt_extend(&os_vty);snprintf(
config_default,sizeof(config_default),"%s/%s.conf",frr_sysconfdir,di->name);snpr
intf(pidfile_default,sizeof(pidfile_default),"%s/%s.pid",frr_vtydir,di->name);st
rlcpy(frr_protoname,di->logname,sizeof(frr_protoname));strlcpy(frr_protonameinst
,di->logname,sizeof(frr_protonameinst));strlcpy(frr_zclientpath,ZEBRA_SERV_PATH,
sizeof(frr_zclientpath));}voidfrr_opt_add(constchar*optstr,conststructoption*lon
gopts,constchar*helpstr){conststructoptspecmain_opts={optstr,helpstr,longopts};o
pt_extend(&main_opts);}voidfrr_help_exit(intstatus){FILE*target=status?stderr:st
dout;if(status!=0)fprintf(stderr,"Invalidoptions.\n\n");if(di->printhelp)di->pri
nthelp(target);elsefprintf(target,"Usage:%s[OPTION...]\n\n%s%s%s\n\n%s",di->prog
name,di->proghelp,di->copyright?"\n\n":"",di->copyright?di->copyright:"",comb_he
lpstr);fprintf(target,"\nReportbugsto%s\n",FRR_BUG_ADDRESS);exit(status);}struct
option_chain{structoption_chain*next;constchar*arg;};staticstructoption_chain*mo
dules=NULL,**modnext=&modules;staticinterrors=0;staticintfrr_opt(intopt){statici
ntvty_port_set=0;staticintvty_addr_set=0;structoption_chain*oc;char*err;switch(o
pt){case'h':frr_help_exit(0);break;case'v':print_version(di->progname);exit(0);b
reak;case'd':di->daemon_mode=1;break;case'M':oc=XMALLOC(MTYPE_TMP,sizeof(*oc));o
c->arg=optarg;oc->next=NULL;*modnext=oc;modnext=&oc->next;break;case'i':if(di->f
lags&FRR_NO_CFG_PID_DRY)return1;di->pid_file=optarg;break;case'f':if(di->flags&F
RR_NO_CFG_PID_DRY)return1;di->config_file=optarg;break;case'N':if(di->flags&FRR_
NO_CFG_PID_DRY)return1;if(di->pathspace){fprintf(stderr,"-N/--pathspaceoptionspe
cifiedmorethanonce!\n");errors++;break;}if(strchr(optarg,'/')||strchr(optarg,'.'
)){fprintf(stderr,"slashesordotsarenotpermittedinthe--pathspaceoption.\n");error
s++;break;}di->pathspace=optarg;break;case'C':if(di->flags&FRR_NO_CFG_PID_DRY)re
turn1;di->dryrun=1;break;case't':if(di->flags&FRR_NO_CFG_PID_DRY)return1;di->ter
minal=1;break;case'z':if(di->flags&FRR_NO_ZCLIENT)return1;strlcpy(frr_zclientpat
h,optarg,sizeof(frr_zclientpath));break;case'A':if(di->flags&FRR_NO_TCPVTY)retur
n1;if(vty_addr_set){fprintf(stderr,"-Aoptionspecifiedmorethanonce!\n");errors++;
break;}vty_addr_set=1;di->vty_addr=optarg;break;case'P':if(di->flags&FRR_NO_TCPV
TY)return1;if(vty_port_set){fprintf(stderr,"-Poptionspecifiedmorethanonce!\n");e
rrors++;break;}vty_port_set=1;di->vty_port=strtoul(optarg,&err,0);if(*err||!*opt
arg){fprintf(stderr,"invalidportnumber\"%s\"for-Poption\n",optarg);errors++;brea
k;}break;caseOPTION_VTYSOCK:if(di->vty_sock_path){fprintf(stderr,"--vty_socketop
tionspecifiedmorethanonce!\n");errors++;break;}di->vty_sock_path=optarg;break;ca
seOPTION_MODULEDIR:if(di->module_path){fprintf(stderr,"----modulediroptionspecif
iedmorethanonce!\n");errors++;break;}di->module_path=optarg;break;case'u':if(di-
>flags&FRR_NO_PRIVSEP)return1;di->privs->user=optarg;break;case'g':if(di->flags&
FRR_NO_PRIVSEP)return1;di->privs->group=optarg;break;default:return1;}return0;}i
ntfrr_getopt(intargc,char*constargv[],int*longindex){intopt;intlidx;comb_next_lo
->name=NULL;do{opt=getopt_long(argc,argv,comb_optstr,comb_lo,&lidx);if(frr_opt(o
pt))break;}while(opt!=-1);if(opt==-1&&errors)frr_help_exit(1);if(longindex)*long
index=lidx;returnopt;}staticvoidfrr_mkdir(constchar*path,boolstrip){charbuf[256]
;mode_tprev;intret;structzprivs_ids_tids;if(strip){char*slash=strrchr(path,'/');
size_tplen;if(!slash)return;plen=slash-path;if(plen>sizeof(buf)-1)return;memcpy(
buf,path,plen);buf[plen]='\0';path=buf;}/*o+rx(..5)isneededforthefrrvtygrouptowo
rkproperly;*withoutit,usersinthefrrvtygroupcan'taccessthevtysockets.*/prev=umask
(0022);ret=mkdir(path,0755);umask(prev);if(ret!=0){/*ifEEXIST,returnwithouttouch
ingthepermissions,*souser-setcustompermissionsareleftinplace*/if(errno==EEXIST)r
eturn;zlog_warn("failedtomkdir\"%s\":%s",path,strerror(errno));return;}zprivs_ge
t_ids(&ids);if(chown(path,ids.uid_normal,ids.gid_normal))zlog_warn("failedtochow
n\"%s\":%s",path,strerror(errno));}staticstructthread_master*master;structthread
_master*frr_init(void){structoption_chain*oc;structfrrmod_runtime*module;charmod
err[256];charp_instance[16]="",p_pathspace[256]="";constchar*dir;dir=di->module_
path?di->module_path:frr_moduledir;srandom(time(NULL));if(di->instance){snprintf
(frr_protonameinst,sizeof(frr_protonameinst),"%s[%u]",di->logname,di->instance);
snprintf(p_instance,sizeof(p_instance),"-%d",di->instance);}if(di->pathspace)snp
rintf(p_pathspace,sizeof(p_pathspace),"/%s",di->pathspace);snprintf(config_defau
lt,sizeof(config_default),"%s%s%s%s.conf",frr_sysconfdir,p_pathspace,di->name,p_
instance);snprintf(pidfile_default,sizeof(pidfile_default),"%s%s/%s%s.pid",frr_v
tydir,p_pathspace,di->name,p_instance);zprivs_preinit(di->privs);openzlog(di->pr
ogname,di->logname,di->instance,LOG_CONS|LOG_NDELAY|LOG_PID,LOG_DAEMON);#ifdefin
ed(HAVE_CUMULUS)zlog_set_level(ZLOG_DEST_SYSLOG,zlog_default->default_lvl);#endi
fif(!frr_zclient_addr(&zclient_addr,&zclient_addr_len,frr_zclientpath)){fprintf(
stderr,"Invalidzservsocketpath:%s\n",frr_zclientpath);exit(1);}/*don'tmkdirthese
asroot...*/if(!(di->flags&FRR_NO_PRIVSEP)){if(!di->pid_file||!di->vty_path)frr_m
kdir(frr_vtydir,false);if(di->pid_file)frr_mkdir(di->pid_file,true);if(di->vty_p
ath)frr_mkdir(di->vty_path,true);}frrmod_init(di->module);while(modules){modules
=(oc=modules)->next;module=frrmod_load(oc->arg,dir,moderr,sizeof(moderr));if(!mo
dule){fprintf(stderr,"%s\n",moderr);exit(1);}XFREE(MTYPE_TMP,oc);}zprivs_init(di
->privs);master=thread_master_create(NULL);signal_init(master,di->n_signals,di->
signals);if(di->flags&FRR_LIMITED_CLI)cmd_init(-1);elsecmd_init(1);vty_init(mast
er);memory_init();returnmaster;}staticintrcvd_signal=0;staticvoidrcv_signal(ints
ignum){rcvd_signal=signum;/*poll()isinterruptedbythesignal;handledbelow*/}static
voidfrr_daemon_wait(intfd){structpollfdpfd[1];intret;pid_texitpid;intexitstat;si
gset_tsigs,prevsigs;sigemptyset(&sigs);sigaddset(&sigs,SIGTSTP);sigaddset(&sigs,
SIGQUIT);sigaddset(&sigs,SIGINT);sigprocmask(SIG_BLOCK,&sigs,&prevsigs);structsi
gactionsa={.sa_handler=rcv_signal,.sa_flags=SA_RESETHAND,};sigemptyset(&sa.sa_ma
sk);sigaction(SIGTSTP,&sa,NULL);sigaction(SIGQUIT,&sa,NULL);sigaction(SIGINT,&sa
,NULL);do{charbuf[1];ssize_tnrecv;pfd[0].fd=fd;pfd[0].events=POLLIN;rcvd_signal=
0;#ifdefined(HAVE_PPOLL)ret=ppoll(pfd,1,NULL,&prevsigs);#elifdefined(HAVE_POLLTS
)ret=pollts(pfd,1,NULL,&prevsigs);#else/*racy--onlyusedonFreeBSD9*/sigset_ttmpsi
gs;sigprocmask(SIG_SETMASK,&prevsigs,&tmpsigs);ret=poll(pfd,1,-1);sigprocmask(SI
G_SETMASK,&tmpsigs,NULL);#endifif(ret<0&&errno!=EINTR&&errno!=EAGAIN){perror("po
ll()");exit(1);}switch(rcvd_signal){caseSIGTSTP:send(fd,"S",1,0);do{nrecv=recv(f
d,buf,sizeof(buf),0);}while(nrecv==-1&&(errno==EINTR||errno==EAGAIN));raise(SIGT
STP);sigaction(SIGTSTP,&sa,NULL);send(fd,"R",1,0);break;caseSIGINT:send(fd,"I",1
,0);break;caseSIGQUIT:send(fd,"Q",1,0);break;}}while(ret<=0);exitpid=waitpid(-1,
&exitstat,WNOHANG);if(exitpid==0)/*childsuccessfullywenttomainloop&closedsocket*
/exit(0);/*childfailedonewayoranother...*/if(WIFEXITED(exitstat)&&WEXITSTATUS(ex
itstat)==0)/*canhappenin--terminalcaseifexitisfastenough*/(void)0;elseif(WIFEXIT
ED(exitstat))fprintf(stderr,"%sfailedtostart,exited%d\n",di->name,WEXITSTATUS(ex
itstat));elseif(WIFSIGNALED(exitstat))fprintf(stderr,"%scrashedinstartup,signal%
d\n",di->name,WTERMSIG(exitstat));elsefprintf(stderr,"%sfailedtostart,unknownpro
blem\n",di->name);exit(1);}staticintdaemon_ctl_sock=-1;staticvoidfrr_daemonize(v
oid){intfds[2];pid_tpid;if(socketpair(AF_UNIX,SOCK_STREAM,0,fds)){perror("socket
pair()fordaemoncontrol");exit(1);}set_cloexec(fds[0]);set_cloexec(fds[1]);pid=fo
rk();if(pid<0){perror("fork()");exit(1);}if(pid==0){/*child*/close(fds[0]);if(se
tsid()<0){perror("setsid()");exit(1);}daemon_ctl_sock=fds[1];return;}close(fds[1
]);frr_daemon_wait(fds[0]);}voidfrr_config_fork(void){hook_call(frr_late_init,ma
ster);vty_read_config(di->config_file,config_default);/*Don'tstartexecutionifwea
reindry-runmode*/if(di->dryrun)exit(0);if(di->daemon_mode||di->terminal)frr_daem
onize();if(!di->pid_file)di->pid_file=pidfile_default;pid_output(di->pid_file);}
voidfrr_vty_serv(void){/*allowexplicitoverrideofvty_pathinthefuture*(notcurrentl
ysetanywhere)*/if(!di->vty_path){constchar*dir;chardefvtydir[256];snprintf(defvt
ydir,sizeof(defvtydir),"%s%s%s",frr_vtydir,di->pathspace?"/":"",di->pathspace?di
->pathspace:"");dir=di->vty_sock_path?di->vty_sock_path:defvtydir;if(di->instanc
e)snprintf(vtypath_default,sizeof(vtypath_default),"%s/%s-%d.vty",dir,di->name,d
i->instance);elsesnprintf(vtypath_default,sizeof(vtypath_default),"%s/%s.vty",di
r,di->name);di->vty_path=vtypath_default;}vty_serv_sock(di->vty_addr,di->vty_por
t,di->vty_path);}staticvoidfrr_terminal_close(intisexit){intnullfd;if(daemon_ctl
_sock!=-1){close(daemon_ctl_sock);daemon_ctl_sock=-1;}if(!di->daemon_mode||isexi
t){printf("\n%sexiting\n",di->name);if(!isexit)raise(SIGINT);return;}else{printf
("\n%sdaemonizing\n",di->name);fflush(stdout);}nullfd=open("/dev/null",O_RDONLY|
O_NOCTTY);if(nullfd==-1){zlog_err("%s:failedtoopen/dev/null:%s",__func__,safe_st
rerror(errno));}else{dup2(nullfd,0);dup2(nullfd,1);dup2(nullfd,2);close(nullfd);
}}staticstructthread*daemon_ctl_thread=NULL;staticintfrr_daemon_ctl(structthread
*t){charbuf[1];ssize_tnr;nr=recv(daemon_ctl_sock,buf,sizeof(buf),0);if(nr<0&&(er
rno==EINTR||errno==EAGAIN))gotoout;if(nr<=0)return0;switch(buf[0]){case'S':/*SIG
TSTP*/vty_stdio_suspend();send(daemon_ctl_sock,"s",1,0);break;case'R':/*SIGTCNT[
implicit]*/vty_stdio_resume();break;case'I':/*SIGINT*/di->daemon_mode=false;rais
e(SIGINT);break;case'Q':/*SIGQUIT*/di->daemon_mode=true;vty_stdio_close();break;
}out:thread_add_read(master,frr_daemon_ctl,NULL,daemon_ctl_sock,&daemon_ctl_thre
ad);return0;}voidfrr_run(structthread_master*master){charinstanceinfo[64]="";frr
_vty_serv();if(di->instance)snprintf(instanceinfo,sizeof(instanceinfo),"instance
%u",di->instance);zlog_notice("%s%sstarting:%svty@%d%s",di->name,FRR_VERSION,ins
tanceinfo,di->vty_port,di->startinfo);if(di->terminal){vty_stdio(frr_terminal_cl
ose);if(daemon_ctl_sock!=-1){set_nonblocking(daemon_ctl_sock);thread_add_read(ma
ster,frr_daemon_ctl,NULL,daemon_ctl_sock,&daemon_ctl_thread);}}elseif(di->daemon
_mode){intnullfd=open("/dev/null",O_RDONLY|O_NOCTTY);if(nullfd==-1){zlog_err("%s
:failedtoopen/dev/null:%s",__func__,safe_strerror(errno));}else{dup2(nullfd,0);d
up2(nullfd,1);dup2(nullfd,2);close(nullfd);}if(daemon_ctl_sock!=-1)close(daemon_
ctl_sock);daemon_ctl_sock=-1;}/*endfixedstderrstartuplogging*/zlog_startup_stder
r=false;structthreadthread;while(thread_fetch(master,&thread))thread_call(&threa
d);}voidfrr_early_fini(void){hook_call(frr_early_fini);}voidfrr_fini(void){FILE*
fp;charfilename[128];inthave_leftovers;hook_call(frr_fini);/*memory_init->nothin
gneeded*/vty_terminate();cmd_terminate();zprivs_terminate(di->privs);/*signal_in
it->nothingneeded*/thread_master_free(master);master=NULL;closezlog();/*frrmod_i
nit->nothingneeded/hooks*/if(!debug_memstats_at_exit)return;have_leftovers=log_m
emstats(stderr,di->name);/*incasewedecideatruntimethatwewantexit-memstatsfor*ada
emon,butithasnostderrbecauseit'sdaemonized*(onlydothisifweactuallyhavesomethingt
oprintthough)*/if(!have_leftovers)return;snprintf(filename,sizeof(filename),"/tm
p/frr-memstats-%s-%llu-%llu",di->name,(unsignedlonglong)getpid(),(unsignedlonglo
ng)time(NULL));fp=fopen(filename,"w");if(fp){log_memstats(fp,di->name);fclose(fp
);}}