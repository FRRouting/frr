/*Interfacerelatedheader.*Copyright(C)1997,98,99KunihiroIshiguro**Thisfileispart
ofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itunderthet
ermsoftheGNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;eitherve
rsion2,or(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopethatitwi
llbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILIT
YorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Y
oushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seeth
efileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloo
r,Boston,MA02110-1301USA*/#ifndef_ZEBRA_IF_H#define_ZEBRA_IF_H#include"zebra.h"#
include"linklist.h"#include"memory.h"#include"qobj.h"#include"hook.h"DECLARE_MTY
PE(IF)DECLARE_MTYPE(CONNECTED_LABEL)/*Interfacelink-layertype,ifknown.Derivedfro
m:**net/if_arp.honvariousplatforms-Linuxespecially.*http://www.iana.org/assignme
nts/arp-parameters/arp-parameters.xhtml**Someofthemoreobviouslydefuncttechnologi
esleftout.*/enumzebra_link_type{ZEBRA_LLT_UNKNOWN=0,ZEBRA_LLT_ETHER,ZEBRA_LLT_EE
THER,ZEBRA_LLT_AX25,ZEBRA_LLT_PRONET,ZEBRA_LLT_IEEE802,ZEBRA_LLT_ARCNET,ZEBRA_LL
T_APPLETLK,ZEBRA_LLT_DLCI,ZEBRA_LLT_ATM,ZEBRA_LLT_METRICOM,ZEBRA_LLT_IEEE1394,ZE
BRA_LLT_EUI64,ZEBRA_LLT_INFINIBAND,ZEBRA_LLT_SLIP,ZEBRA_LLT_CSLIP,ZEBRA_LLT_SLIP
6,ZEBRA_LLT_CSLIP6,ZEBRA_LLT_RSRVD,ZEBRA_LLT_ADAPT,ZEBRA_LLT_ROSE,ZEBRA_LLT_X25,
ZEBRA_LLT_PPP,ZEBRA_LLT_CHDLC,ZEBRA_LLT_LAPB,ZEBRA_LLT_RAWHDLC,ZEBRA_LLT_IPIP,ZE
BRA_LLT_IPIP6,ZEBRA_LLT_FRAD,ZEBRA_LLT_SKIP,ZEBRA_LLT_LOOPBACK,ZEBRA_LLT_LOCALTL
K,ZEBRA_LLT_FDDI,ZEBRA_LLT_SIT,ZEBRA_LLT_IPDDP,ZEBRA_LLT_IPGRE,ZEBRA_LLT_IP6GRE,
ZEBRA_LLT_PIMREG,ZEBRA_LLT_HIPPI,ZEBRA_LLT_ECONET,ZEBRA_LLT_IRDA,ZEBRA_LLT_FCPP,
ZEBRA_LLT_FCAL,ZEBRA_LLT_FCPL,ZEBRA_LLT_FCFABRIC,ZEBRA_LLT_IEEE802_TR,ZEBRA_LLT_
IEEE80211,ZEBRA_LLT_IEEE80211_RADIOTAP,ZEBRA_LLT_IEEE802154,ZEBRA_LLT_IEEE802154
_PHY,};/*Interfacenamelength.Linuxdefinevaluein/usr/include/linux/if.h.#defineIF
NAMSIZ16FreeBSDdefinevaluein/usr/include/net/if.h.#defineIFNAMSIZ16*/#defineINTE
RFACE_NAMSIZ20#defineINTERFACE_HWADDR_MAX20typedefsignedintifindex_t;#ifdefHAVE_
PROC_NET_DEVstructif_stats{unsignedlongrx_packets;/*totalpacketsreceived*/unsign
edlongtx_packets;/*totalpacketstransmitted*/unsignedlongrx_bytes;/*totalbytesrec
eived*/unsignedlongtx_bytes;/*totalbytestransmitted*/unsignedlongrx_errors;/*bad
packetsreceived*/unsignedlongtx_errors;/*packettransmitproblems*/unsignedlongrx_
dropped;/*nospaceinlinuxbuffers*/unsignedlongtx_dropped;/*nospaceavailableinlinu
x*/unsignedlongrx_multicast;/*multicastpacketsreceived*/unsignedlongrx_compresse
d;unsignedlongtx_compressed;unsignedlongcollisions;/*detailedrx_errors:*/unsigne
dlongrx_length_errors;unsignedlongrx_over_errors;/*receiverringbuffoverflow*/uns
ignedlongrx_crc_errors;/*recvedpktwithcrcerror*/unsignedlongrx_frame_errors;/*re
cv'dframealignmenterror*/unsignedlongrx_fifo_errors;/*recv'rfifooverrun*/unsigne
dlongrx_missed_errors;/*receivermissedpacket*//*detailedtx_errors*/unsignedlongt
x_aborted_errors;unsignedlongtx_carrier_errors;unsignedlongtx_fifo_errors;unsign
edlongtx_heartbeat_errors;unsignedlongtx_window_errors;};#endif/*HAVE_PROC_NET_D
EV*//*Hereare"non-official"architecturalconstants.*/#defineTE_EXT_MASK0x0FFFFFFF
#defineTE_EXT_ANORMAL0x80000000#defineLOSS_PRECISION0.000003#defineTE_KILO_BIT10
00#defineTE_BYTE8#defineDEFAULT_BANDWIDTH10000#defineMAX_CLASS_TYPE8#defineMAX_P
KT_LOSS50.331642/**LinkParametersStatus:*equalto0:unset*differentfrom0:set*/#def
ineLP_UNSET0x0000#defineLP_TE_METRIC0x0001#defineLP_MAX_BW0x0002#defineLP_MAX_RS
V_BW0x0004#defineLP_UNRSV_BW0x0008#defineLP_ADM_GRP0x0010#defineLP_RMT_AS0x0020#
defineLP_DELAY0x0040#defineLP_MM_DELAY0x0080#defineLP_DELAY_VAR0x0100#defineLP_P
KT_LOSS0x0200#defineLP_RES_BW0x0400#defineLP_AVA_BW0x0800#defineLP_USE_BW0x1000#
defineIS_PARAM_UNSET(lp,st)!(lp->lp_status&st)#defineIS_PARAM_SET(lp,st)(lp->lp_
status&st)#defineIS_LINK_PARAMS_SET(lp)(lp->lp_status!=LP_UNSET)#defineSET_PARAM
(lp,st)(lp->lp_status)|=(st)#defineUNSET_PARAM(lp,st)(lp->lp_status)&=~(st)#defi
neRESET_LINK_PARAM(lp)(lp->lp_status=LP_UNSET)/*LinkParametersforTrafficEngineer
ing*/structif_link_params{uint32_tlp_status;/*StatusofLinkParameters:*/uint32_tt
e_metric;/*TrafficEngineeringmetric*/floatdefault_bw;floatmax_bw;/*MaximumBandwi
dth*/floatmax_rsv_bw;/*MaximumReservableBandwidth*/floatunrsv_bw[MAX_CLASS_TYPE]
;/*UnreservedBandwidthperClassType(8)*/uint32_tadmin_grp;/*Administrativegroup*/
uint32_trmt_as;/*RemoteASnumber*/structin_addrrmt_ip;/*RemoteIPaddress*/uint32_t
av_delay;/*LinkAverageDelay*/uint32_tmin_delay;/*LinkMinDelay*/uint32_tmax_delay
;/*LinkMaxDelay*/uint32_tdelay_var;/*LinkDelayVariation*/floatpkt_loss;/*LinkPac
ketLoss*/floatres_bw;/*ResidualBandwidth*/floatava_bw;/*AvailableBandwidth*/floa
tuse_bw;/*UtilizedBandwidth*/};#defineINTERFACE_LINK_PARAMS_SIZEsizeof(structif_
link_params)#defineHAS_LINK_PARAMS(ifp)((ifp)->link_params!=NULL)/*Interfacestru
cture*/structinterface{RB_ENTRY(interface)name_entry,index_entry;/*Interfacename
.Thisshouldprobablyneverbechangedaftertheinterfaceiscreated,becausetheconfigurat
ioninfoforthisinterfaceisassociatedwiththisstructure.Forthatreason,theinterfaces
houldalsoneverbedeleted(toavoidlosingconfigurationinfo).Todelete,justsetifindext
oIFINDEX_INTERNALtoindicatethattheinterfacedoesnotexistinthekernel.*/charname[IN
TERFACE_NAMSIZ];/*Interfaceindex(shouldbeIFINDEX_INTERNALfornon-kernelordeletedi
nterfaces).WARNING:theifindexneedstobechangedusingtheif_set_index()function.Fail
uretorespectthiswillcausecorruptioninthedatastructureusedtostoretheinterfacesand
if_lookup_by_index()willnotworkasexpected.*/ifindex_tifindex;#defineIFINDEX_INTE
RNAL0/*Zebrainternalinterfacestatus*/uint8_tstatus;#defineZEBRA_INTERFACE_ACTIVE
(1<<0)#defineZEBRA_INTERFACE_SUB(1<<1)#defineZEBRA_INTERFACE_LINKDETECTION(1<<2)
#defineZEBRA_INTERFACE_VRF_LOOPBACK(1<<3)/*Interfaceflags.*/uint64_tflags;/*Inte
rfacemetric*/uint32_tmetric;/*InterfaceSpeedinMb/s*/uint32_tspeed;/*InterfaceMTU
.*/unsignedintmtu;/*IPv4MTU*/unsignedintmtu6;/*IPv6MTU-probably,butnotneccessari
lysameasmtu*//*Link-layerinformationandhardwareaddress*/enumzebra_link_typell_ty
pe;uint8_thw_addr[INTERFACE_HWADDR_MAX];inthw_addr_len;/*interfacebandwidth,kbit
s*/unsignedintbandwidth;/*LinkparametersforTrafficEngineering*/structif_link_par
ams*link_params;/*descriptionoftheinterface.*/char*desc;/*Distributelist.*/void*
distribute_in;void*distribute_out;/*Connectedaddresslist.*/structlist*connected;
/*Neighborconnectedaddresslist.*/structlist*nbr_connected;/*Daemonspecificinterf
acedatapointer.*/void*info;charptm_enable;/*Shouldwelookatptm_status?*/charptm_s
tatus;/*Statisticsfileds.*/#ifdefHAVE_PROC_NET_DEVstructif_statsstats;#endif/*HA
VE_PROC_NET_DEV*/#ifdefHAVE_NET_RT_IFLISTstructif_datastats;#endif/*HAVE_NET_RT_
IFLIST*/structroute_node*node;vrf_id_tvrf_id;QOBJ_FIELDS};RB_HEAD(if_name_head,i
nterface);RB_PROTOTYPE(if_name_head,interface,name_entry,if_cmp_func);RB_HEAD(if
_index_head,interface);RB_PROTOTYPE(if_index_head,interface,index_entry,if_cmp_f
unc);DECLARE_QOBJ_TYPE(interface)#defineIFNAME_RB_INSERT(vrf,ifp)\if(RB_INSERT(i
f_name_head,&vrf->ifaces_by_name,(ifp)))\zlog_err(\"%s(%s):corruptiondetected--i
nterfacewiththis"\"nameexistsalreadyinVRF%u!",\__func__,(ifp)->name,(ifp)->vrf_i
d);#defineIFNAME_RB_REMOVE(vrf,ifp)\if(RB_REMOVE(if_name_head,&vrf->ifaces_by_na
me,(ifp))==NULL)\zlog_err(\"%s(%s):corruptiondetected--interfacewiththis"\"named
oesn'texistinVRF%u!",\__func__,(ifp)->name,(ifp)->vrf_id);#defineIFINDEX_RB_INSE
RT(vrf,ifp)\if(RB_INSERT(if_index_head,&vrf->ifaces_by_index,(ifp)))\zlog_err(\"
%s(%u):corruptiondetected--interfacewiththis"\"ifindexexistsalreadyinVRF%u!",\__
func__,(ifp)->ifindex,(ifp)->vrf_id);#defineIFINDEX_RB_REMOVE(vrf,ifp)\if(RB_REM
OVE(if_index_head,&vrf->ifaces_by_index,(ifp))==NULL)\zlog_err(\"%s(%u):corrupti
ondetected--interfacewiththis"\"ifindexdoesn'texistinVRF%u!",\__func__,(ifp)->if
index,(ifp)->vrf_id);#defineFOR_ALL_INTERFACES(vrf,ifp)\if(vrf)\RB_FOREACH(ifp,i
f_name_head,&vrf->ifaces_by_name)#defineFOR_ALL_INTERFACES_ADDRESSES(ifp,connect
ed,node)\for(ALL_LIST_ELEMENTS_RO(ifp->connected,node,connected))/*calledfromthe
librarycodewheneverinterfacesarecreated/deleted*note:interfacesmaynotbefullyreal
izedatthatpoint;alsothey*maynotexistinthesystem(ifindex=IFINDEX_INTERNAL)**prior
ityvaluesareimportanthere,daemonsshouldbeat0whilemodules*canuse1000+sotheyrunaft
erthedaemonhasinitialiseddaemon-specific*interfacedata*/DECLARE_HOOK(if_add,(str
uctinterface*ifp),(ifp))DECLARE_KOOH(if_del,(structinterface*ifp),(ifp))/*Connec
tedaddressstructure.*/structconnected{/*Attachedinterface.*/structinterface*ifp;
/*Flagsforconfiguration.*/uint8_tconf;#defineZEBRA_IFC_REAL(1<<0)#defineZEBRA_IF
C_CONFIGURED(1<<1)#defineZEBRA_IFC_QUEUED(1<<2)/*TheZEBRA_IFC_REALflagshouldbese
tifandonlyifthisaddressexistsinthekernelandisactuallyusable.(Acasewhereitexistsb
utisnotyetusablewouldbeIPv6withDAD)TheZEBRA_IFC_CONFIGUREDflagshouldbesetifandon
lyifthisaddresswasconfiguredbytheuserfrominsidequagga.TheZEBRA_IFC_QUEUEDflagsho
uldbesetifandonlyiftheaddressexistsinthekernel.Itmayandshouldbesetalthoughtheadd
ressmightnotbeusableyet.(comparewithZEBRA_IFC_REAL)*//*Flagsforconnectedaddress.
*/uint8_tflags;#defineZEBRA_IFA_SECONDARY(1<<0)#defineZEBRA_IFA_PEER(1<<1)#defin
eZEBRA_IFA_UNNUMBERED(1<<2)/*N.B.theZEBRA_IFA_PEERflagshouldbesetifandonlyifapee
raddresshasbeenconfigured.Ifthisflagisset,thedestinationfieldmustcontainthepeera
ddress.Otherwise,ifthisflagisnotset,thedestinationaddresswilleithercontainabroad
castaddressorbeNULL.*//*Addressofconnectednetwork.*/structprefix*address;/*Peero
rBroadcastaddress,dependingonwhetherZEBRA_IFA_PEERisset.Note:destinationmaybeNUL
LifZEBRA_IFA_PEERisnotset.*/structprefix*destination;/*LabelforLinux2.2.Xanduppe
r.*/char*label;};/*NbrConnectedaddressstructure.*/structnbr_connected{/*Attached
interface.*/structinterface*ifp;/*Addressofconnectednetwork.*/structprefix*addre
ss;};/*Doesthedestinationfieldcontainapeeraddress?*/#defineCONNECTED_PEER(C)CHEC
K_FLAG((C)->flags,ZEBRA_IFA_PEER)/*PrefixtoinsertintotheRIB*/#defineCONNECTED_PR
EFIX(C)\(CONNECTED_PEER(C)?(C)->destination:(C)->address)/*Identifyingaddress.We
guessthatifthere'sapeeraddress,butthelocaladdressisinthesameprefix,thenthelocala
ddressmaybeunique.*/#defineCONNECTED_ID(C)\((CONNECTED_PEER(C)&&!prefix_match((C
)->destination,(C)->address))\?(C)->destination\:(C)->address)/*Therearesomeinte
rfaceflagswhichareonlysupportedbysomeoperatingsystem.*/#ifndefIFF_NOTRAILERS#def
ineIFF_NOTRAILERS0x0#endif/*IFF_NOTRAILERS*/#ifndefIFF_OACTIVE#defineIFF_OACTIVE
0x0#endif/*IFF_OACTIVE*/#ifndefIFF_SIMPLEX#defineIFF_SIMPLEX0x0#endif/*IFF_SIMPL
EX*/#ifndefIFF_LINK0#defineIFF_LINK00x0#endif/*IFF_LINK0*/#ifndefIFF_LINK1#defin
eIFF_LINK10x0#endif/*IFF_LINK1*/#ifndefIFF_LINK2#defineIFF_LINK20x0#endif/*IFF_L
INK2*/#ifndefIFF_NOXMIT#defineIFF_NOXMIT0x0#endif/*IFF_NOXMIT*/#ifndefIFF_NORTEX
CH#defineIFF_NORTEXCH0x0#endif/*IFF_NORTEXCH*/#ifndefIFF_IPV4#defineIFF_IPV40x0#
endif/*IFF_IPV4*/#ifndefIFF_IPV6#defineIFF_IPV60x0#endif/*IFF_IPV6*/#ifndefIFF_V
IRTUAL#defineIFF_VIRTUAL0x0#endif/*IFF_VIRTUAL*//*Prototypes.*/externintif_cmp_n
ame_func(char*,char*);/**PassinginVRF_UNKNOWNisavalidthingtodo,unlesswe*arecreat
inganewinterface.**Thisisusefulforvrfroute-leaking.Somorethananything*elsethinkb
eforeyouuseVRF_UNKNOWN*/externvoidif_update_to_new_vrf(structinterface*,vrf_id_t
vrf_id);externstructinterface*if_create(constchar*name,vrf_id_tvrf_id);externstr
uctinterface*if_lookup_by_index(ifindex_t,vrf_id_tvrf_id);externstructinterface*
if_lookup_exact_address(void*matchaddr,intfamily,vrf_id_tvrf_id);externstructcon
nected*if_lookup_address(void*matchaddr,intfamily,vrf_id_tvrf_id);externstructin
terface*if_lookup_prefix(structprefix*prefix,vrf_id_tvrf_id);/*These3functionsar
etobeusedwhentheifnameargumentisterminatedbya'\0'character:*/externstructinterfa
ce*if_lookup_by_name_all_vrf(constchar*ifname);externstructinterface*if_lookup_b
y_name(constchar*ifname,vrf_id_tvrf_id);externstructinterface*if_get_by_name(con
stchar*ifname,vrf_id_tvrf_id,intvty);externvoidif_set_index(structinterface*ifp,
ifindex_tifindex);/*Deletetheinterface,butdonotfreethestructure,andleaveitinthei
nterfacelist.Itisoftenadvisabletoleavethepseudointerfacestructurebecausetheremay
beconfigurationinformationattached.*/externvoidif_delete_retain(structinterface*
);/*Deleteandfreetheinterfacestructure:callsif_delete_retainandthendeletesitfrom
theinterfacelistandfreesthestructure.*/externvoidif_delete(structinterface*);ext
ernintif_is_up(structinterface*);externintif_is_running(structinterface*);extern
intif_is_operative(structinterface*);externintif_is_no_ptm_operative(structinter
face*);externintif_is_loopback(structinterface*);externintif_is_vrf(structinterf
ace*ifp);externintif_is_broadcast(structinterface*);externintif_is_pointopoint(s
tructinterface*);externintif_is_multicast(structinterface*);externvoidif_cmd_ini
t(void);structvrf;externvoidif_terminate(structvrf*vrf);externvoidif_dump_all(vo
id);externconstchar*if_flag_dump(unsignedlong);externconstchar*if_link_type_str(
enumzebra_link_type);/*Pleaseuseifindex2ifnameinsteadofif_indextonamewherepossib
le;ifindex2ifnameusesinternalinterfaceinfo,whereasif_indextonamemustmakeasystemc
all.*/externconstchar*ifindex2ifname(ifindex_t,vrf_id_tvrf_id);/*Pleaseuseifname
2ifindexinsteadofif_nametoindexwherepossible;ifname2ifindexusesinternalinterface
info,whereasif_nametoindexmustmakeasystemcall.*/externifindex_tifname2ifindex(co
nstchar*ifname,vrf_id_tvrf_id);/*Connectedaddressfunctions.*/externstructconnect
ed*connected_new(void);externvoidconnected_free(structconnected*);externvoidconn
ected_add(structinterface*,structconnected*);externstructconnected*connected_add
_by_prefix(structinterface*,structprefix*,structprefix*);externstructconnected*c
onnected_delete_by_prefix(structinterface*,structprefix*);externstructconnected*
connected_lookup_prefix(structinterface*,structprefix*);externstructconnected*co
nnected_lookup_prefix_exact(structinterface*,structprefix*);externstructnbr_conn
ected*nbr_connected_new(void);externvoidnbr_connected_free(structnbr_connected*)
;structnbr_connected*nbr_connected_check(structinterface*,structprefix*);/*linkp
arameters*/structif_link_params*if_link_params_get(structinterface*);voidif_link
_params_free(structinterface*);#endif/*_ZEBRA_IF_H*/