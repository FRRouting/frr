/**TestingshimandAPIexamplesforthenewCLIbackend.**Thisunitdefinesanumberofcomman
dsintheoldenginethatcan*beusedtotestandinteractwiththenewengine.*--*Copyright(C)
2016CumulusNetworks,Inc.**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youc
anredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublis
hedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.
**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withou
teventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGN
U*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneral
PublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftwar
e*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include"comma
nd.h"#include"memory_vty.h"#include"graph.h"#include"linklist.h"#include"command
_match.h"#defineGRAMMAR_STR"CLIgrammarsandbox\n"DEFINE_MTYPE_STATIC(LIB,CMD_TOKE
NS,"Commanddesc")/**headers**/voidgrammar_sandbox_init(void);voidpretty_print_gr
aph(structvty*vty,structgraph_node*,int,int,structgraph_node**,size_t);staticvoi
dpretty_print_dot(FILE*ofd,unsignedopts,structgraph_node*start,structgraph_node*
*stack,size_tstackpos,structgraph_node**visited,size_t*visitpos);voidinit_cmdgra
ph(structvty*,structgraph**);/**shiminterfacecommands**/structgraph*nodegraph=NU
LL,*nodegraph_free=NULL;#definecheck_nodegraph()\do{\if(!nodegraph){\vty_out(vty
,"nodegraphnotinitialized\n");\returnCMD_WARNING;\}\}while(0)DEFUN(grammar_test,
grammar_test_cmd,"grammarparseLINE...",GRAMMAR_STR"parseacommand\n""commandtopas
stonewparser\n"){check_nodegraph();intidx_command=2;//makeastringfromtokenizedco
mmandlinechar*command=argv_concat(argv,argc,idx_command);//createcmd_elementforp
arserstructcmd_element*cmd=XCALLOC(MTYPE_CMD_TOKENS,sizeof(structcmd_element));c
md->string=command;cmd->doc="0\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n1
5\n16\n17\n18\n19\n";cmd->func=NULL;//parsethecommandandinstallitintothecommandg
raphstructgraph*graph=graph_new();structcmd_token*token=cmd_token_new(START_TKN,
CMD_ATTR_NORMAL,NULL,NULL);graph_new_node(graph,token,(void(*)(void*))&cmd_token
_del);cmd_graph_parse(graph,cmd);cmd_graph_merge(nodegraph,graph,+1);returnCMD_S
UCCESS;}DEFUN(grammar_test_complete,grammar_test_complete_cmd,"grammarcompleteCO
MMAND...",GRAMMAR_STR"attempttocompleteinputonDFA\n""commandtocomplete\n"){check
_nodegraph();intidx_command=2;char*cmdstr=argv_concat(argv,argc,idx_command);if(
!cmdstr)returnCMD_SUCCESS;vectorcommand=cmd_make_strvec(cmdstr);if(!command){XFR
EE(MTYPE_TMP,cmdstr);returnCMD_SUCCESS;}//generatecompletionsofuserinputstructli
st*completions;enummatcher_rvresult=command_complete(nodegraph,command,&completi
ons);//printcompletionsorrelevanterrormessageif(!MATCHER_ERROR(result)){vectorco
mps=completions_to_vec(completions);structcmd_token*tkn;//calculatelengthoflonge
sttkn->textincompletionsunsignedintwidth=0,i=0;for(i=0;i<vector_active(comps);i+
+){tkn=vector_slot(comps,i);unsignedintlen=strlen(tkn->text);width=len>width?len
:width;}//printcompletionsfor(i=0;i<vector_active(comps);i++){tkn=vector_slot(co
mps,i);vty_out(vty,"%-*s%s\n",width,tkn->text,tkn->desc);}for(i=0;i<vector_activ
e(comps);i++)cmd_token_del((structcmd_token*)vector_slot(comps,i));vector_free(c
omps);}elsevty_out(vty,"%%Nomatch\n");//freeresourceslist_delete_and_null(&compl
etions);cmd_free_strvec(command);XFREE(MTYPE_TMP,cmdstr);returnCMD_SUCCESS;}DEFU
N(grammar_test_match,grammar_test_match_cmd,"grammarmatchCOMMAND...",GRAMMAR_STR
"attempttomatchinputonDFA\n""commandtomatch\n"){check_nodegraph();intidx_command
=2;if(argv[2]->arg[0]=='#')returnCMD_SUCCESS;char*cmdstr=argv_concat(argv,argc,i
dx_command);if(!cmdstr)returnCMD_SUCCESS;vectorcommand=cmd_make_strvec(cmdstr);i
f(!command){XFREE(MTYPE_TMP,cmdstr);returnCMD_SUCCESS;}structlist*argvv=NULL;con
ststructcmd_element*element=NULL;enummatcher_rvresult=command_match(nodegraph,co
mmand,&argvv,&element);//printcompletionsorrelevanterrormessageif(element){vty_o
ut(vty,"Matched:%s\n",element->string);structlistnode*ln;structcmd_token*token;f
or(ALL_LIST_ELEMENTS_RO(argvv,ln,token))vty_out(vty,"%s--%s\n",token->text,token
->arg);vty_out(vty,"func:%p\n",element->func);list_delete_and_null(&argvv);}else
{assert(MATCHER_ERROR(result));switch(result){caseMATCHER_NO_MATCH:vty_out(vty,"
%%Unknowncommand\n");break;caseMATCHER_INCOMPLETE:vty_out(vty,"%%Incompletecomma
nd\n");break;caseMATCHER_AMBIGUOUS:vty_out(vty,"%%Ambiguouscommand\n");break;def
ault:vty_out(vty,"%%Unknownerror\n");break;}}//freeresourcescmd_free_strvec(comm
and);XFREE(MTYPE_TMP,cmdstr);returnCMD_SUCCESS;}/***Testingshimtotestdocstrings*
/DEFUN(grammar_test_doc,grammar_test_doc_cmd,"grammartestdocstring",GRAMMAR_STR"
Testfunctionfordocstring\n""Commandend\n"){check_nodegraph();//createcmd_element
withdocstringstructcmd_element*cmd=XCALLOC(MTYPE_CMD_TOKENS,sizeof(structcmd_ele
ment));cmd->string=XSTRDUP(MTYPE_CMD_TOKENS,"testdocstring<example|selectorfollo
w>(1-255)endVARIABLE[OPTION|setlol].VARARG");cmd->doc=XSTRDUP(MTYPE_CMD_TOKENS,"
Teststuff\n""docstringthing\n""firstexample\n""secondexample\n""follow\n""random
range\n""endthingy\n""variable\n""optionalvariable\n""optionalset\n""optionallol
\n""vararg!\n");cmd->func=NULL;//parseelementcmd_graph_parse(nodegraph,cmd);retu
rnCMD_SUCCESS;}/***Debuggingcommandtoprintcommandgraph*/DEFUN(grammar_test_show,
grammar_test_show_cmd,"grammarshow[doc]",GRAMMAR_STR"printcurrentaccumulatedDFA\
n""includedocstrings\n"){check_nodegraph();structgraph_node*stack[CMD_ARGC_MAX];
pretty_print_graph(vty,vector_slot(nodegraph->nodes,0),0,argc>=3,stack,0);return
CMD_SUCCESS;}DEFUN(grammar_test_dot,grammar_test_dot_cmd,"grammardotfileOUTNAME"
,GRAMMAR_STR"printcurrentgraphfordot\n"".dotfilename\n"){check_nodegraph();struc
tgraph_node*stack[CMD_ARGC_MAX];structgraph_node*visited[CMD_ARGC_MAX*CMD_ARGC_M
AX];size_tvpos=0;FILE*ofd=fopen(argv[2]->arg,"w");if(!ofd){vty_out(vty,"%s:%s\r\
n",argv[2]->arg,strerror(errno));returnCMD_SUCCESS;}fprintf(ofd,"digraph{\ngraph
[rankdir=LR];\nnode[fontname=\"FiraMono\",fontsize=9];\n\n");pretty_print_dot(of
d,0,vector_slot(nodegraph->nodes,0),stack,0,visited,&vpos);fprintf(ofd,"}\n");fc
lose(ofd);returnCMD_SUCCESS;}structcmd_permute_item{char*cmd;structcmd_element*e
l;};staticvoidcmd_permute_free(void*arg){structcmd_permute_item*i=arg;XFREE(MTYP
E_TMP,i->cmd);XFREE(MTYPE_TMP,i);}staticintcmd_permute_cmp(void*a,void*b){struct
cmd_permute_item*aa=a,*bb=b;returnstrcmp(aa->cmd,bb->cmd);}staticvoidcmd_graph_p
ermute(structlist*out,structgraph_node**stack,size_tstackpos,char*cmd){structgra
ph_node*gn=stack[stackpos];structcmd_token*tok=gn->data;char*appendp=cmd+strlen(
cmd);size_ti,j;if(tok->type<SPECIAL_TKN){sprintf(appendp,"%s",tok->text);appendp
+=strlen(appendp);}elseif(tok->type==END_TKN){structcmd_permute_item*i=XMALLOC(M
TYPE_TMP,sizeof(*i));i->el=((structgraph_node*)vector_slot(gn->to,0))->data;i->c
md=XSTRDUP(MTYPE_TMP,cmd);i->cmd[strlen(cmd)-1]='\0';listnode_add_sort(out,i);re
turn;}if(++stackpos==CMD_ARGC_MAX)return;for(i=0;i<vector_active(gn->to);i++){st
ructgraph_node*gnext=vector_slot(gn->to,i);for(j=0;j<stackpos;j++)if(stack[j]==g
next)break;if(j!=stackpos)continue;stack[stackpos]=gnext;*appendp='\0';cmd_graph
_permute(out,stack,stackpos,cmd);}}staticstructlist*cmd_graph_permutations(struc
tgraph*graph){characcumulate[2048]="";structgraph_node*stack[CMD_ARGC_MAX];struc
tlist*rv=list_new();rv->cmp=cmd_permute_cmp;rv->del=cmd_permute_free;stack[0]=ve
ctor_slot(graph->nodes,0);cmd_graph_permute(rv,stack,0,accumulate);returnrv;}ext
ernvectorcmdvec;DEFUN(grammar_findambig,grammar_findambig_cmd,"grammarfind-ambig
uous[{printall|nodescan}]",GRAMMAR_STR"Findambiguouscommands\n""Printallpermutat
ions\n""Scanallnodes\n"){structlist*commands;structcmd_permute_item*prev=NULL,*c
ur=NULL;structlistnode*ln;inti,printall,scan,scannode=0;intambig=0;i=0;printall=
argv_find(argv,argc,"printall",&i);i=0;scan=argv_find(argv,argc,"nodescan",&i);i
f(scan&&nodegraph_free){graph_delete_graph(nodegraph_free);nodegraph_free=NULL;}
if(!scan&&!nodegraph){vty_out(vty,"nodegraphuninitialized\r\n");returnCMD_WARNIN
G_CONFIG_FAILED;}do{if(scan){structcmd_node*cnode=vector_slot(cmdvec,scannode++)
;if(!cnode)continue;nodegraph=cnode->cmdgraph;if(!nodegraph)continue;vty_out(vty
,"scanningnode%d(%s)\n",scannode-1,node_names[scannode-1]);}commands=cmd_graph_p
ermutations(nodegraph);prev=NULL;for(ALL_LIST_ELEMENTS_RO(commands,ln,cur)){ints
ame=prev&&!strcmp(prev->cmd,cur->cmd);if(printall&&!same)vty_out(vty,"'%s'[%x]\n
",cur->cmd,cur->el->daemon);if(same){vty_out(vty,"'%s'AMBIGUOUS:\n",cur->cmd);vt
y_out(vty,"%s\n'%s'\n",prev->el->name,prev->el->string);vty_out(vty,"%s\n'%s'\n"
,cur->el->name,cur->el->string);vty_out(vty,"\n");ambig++;}prev=cur;}list_delete
_and_null(&commands);vty_out(vty,"\n");}while(scan&&scannode<LINK_PARAMS_NODE);v
ty_out(vty,"%dambiguouscommandsfound.\n",ambig);if(scan)nodegraph=NULL;returnamb
ig==0?CMD_SUCCESS:CMD_WARNING_CONFIG_FAILED;}DEFUN(grammar_init_graph,grammar_in
it_graph_cmd,"grammarinit",GRAMMAR_STR"(re)initializegraph\n"){if(nodegraph_free
)graph_delete_graph(nodegraph_free);nodegraph_free=NULL;init_cmdgraph(vty,&nodeg
raph);returnCMD_SUCCESS;}DEFUN(grammar_access,grammar_access_cmd,"grammaraccess(
0-65535)",GRAMMAR_STR"accessnodegraph\n""nodenumber\n"){if(nodegraph_free)graph_
delete_graph(nodegraph_free);nodegraph_free=NULL;structcmd_node*cnode;cnode=vect
or_slot(cmdvec,atoi(argv[2]->arg));if(!cnode){vty_out(vty,"%%nosuchnode\n");retu
rnCMD_WARNING_CONFIG_FAILED;}vty_out(vty,"node%d\n",(int)cnode->node);nodegraph=
cnode->cmdgraph;returnCMD_SUCCESS;}/*thisiscalledinvtysh.ctosetupthetestingshim*
/voidgrammar_sandbox_init(void){//installallenableelementsinstall_element(ENABLE
_NODE,&grammar_test_cmd);install_element(ENABLE_NODE,&grammar_test_show_cmd);ins
tall_element(ENABLE_NODE,&grammar_test_dot_cmd);install_element(ENABLE_NODE,&gra
mmar_test_match_cmd);install_element(ENABLE_NODE,&grammar_test_complete_cmd);ins
tall_element(ENABLE_NODE,&grammar_test_doc_cmd);install_element(ENABLE_NODE,&gra
mmar_findambig_cmd);install_element(ENABLE_NODE,&grammar_init_graph_cmd);install
_element(ENABLE_NODE,&grammar_access_cmd);}#defineitem(x){x,#x}structmessagetoke
nnames[]={item(WORD_TKN),//wordsitem(VARIABLE_TKN),//almostanythingitem(RANGE_TK
N),//integerrangeitem(IPV4_TKN),//IPV4addressesitem(IPV4_PREFIX_TKN),//IPV4netwo
rkprefixesitem(IPV6_TKN),//IPV6prefixesitem(IPV6_PREFIX_TKN),//IPV6networkprefix
esitem(MAC_TKN),//MACaddressitem(MAC_PREFIX_TKN),//MACaddressw/mask/*plumbingtyp
es*/item(FORK_TKN),item(JOIN_TKN),item(START_TKN),//firsttokeninlineitem(END_TKN
),//lasttokeninline{0}};/***Pretty-printsagraph,assumingitisatree.**@paramstartt
henodetotakeastheroot*@paramlevelindentlevelforrecursivecalls,alwayspass0*/voidp
retty_print_graph(structvty*vty,structgraph_node*start,intlevel,intdesc,structgr
aph_node**stack,size_tstackpos){//printthisnodechartokennum[32];structcmd_token*
tok=start->data;snprintf(tokennum,sizeof(tokennum),"%d?",tok->type);vty_out(vty,
"%s",lookup_msg(tokennames,tok->type,NULL));if(tok->text)vty_out(vty,":\"%s\"",t
ok->text);if(tok->varname)vty_out(vty,"=>%s",tok->varname);if(desc)vty_out(vty,"
?'%s'",tok->desc);vty_out(vty,"");if(stackpos==CMD_ARGC_MAX){vty_out(vty,"-abort
ing!(depthlimit)\n");return;}stack[stackpos++]=start;intnumto=desc?2:vector_acti
ve(start->to);if(numto){if(numto>1)vty_out(vty,"\n");for(unsignedinti=0;i<vector
_active(start->to);i++){structgraph_node*adj=vector_slot(start->to,i);//ifwe'rel
istingmultiplechildren,indent!if(numto>1)for(intj=0;j<level+1;j++)vty_out(vty,""
);//ifthisnodeisavararg,justprint*if(adj==start)vty_out(vty,"*");elseif(((struct
cmd_token*)adj->data)->type==END_TKN)vty_out(vty,"--END\n");else{size_tk;for(k=0
;k<stackpos;k++)if(stack[k]==adj){vty_out(vty,"<<loop@%zu\n",k);break;}if(k==sta
ckpos)pretty_print_graph(vty,adj,numto>1?level+1:level,desc,stack,stackpos);}}}e
lsevty_out(vty,"\n");}staticvoidpretty_print_dot(FILE*ofd,unsignedopts,structgra
ph_node*start,structgraph_node**stack,size_tstackpos,structgraph_node**visited,s
ize_t*visitpos){//printthisnodechartokennum[32];structcmd_token*tok=start->data;
constchar*color;for(size_ti=0;i<(*visitpos);i++)if(visited[i]==start)return;visi
ted[(*visitpos)++]=start;if((*visitpos)==CMD_ARGC_MAX*CMD_ARGC_MAX)return;snprin
tf(tokennum,sizeof(tokennum),"%d?",tok->type);fprintf(ofd,"n%p[shape=box,label=<
",start);fprintf(ofd,"<b>%s</b>",lookup_msg(tokennames,tok->type,NULL));if(tok->
attr==CMD_ATTR_DEPRECATED)fprintf(ofd,"(d)");elseif(tok->attr==CMD_ATTR_HIDDEN)f
printf(ofd,"(h)");if(tok->text){if(tok->type==WORD_TKN)fprintf(ofd,"<br/>\"<font
color=\"#0055ff\"point-size=\"11\"><b>%s</b></font>\"",tok->text);elsefprintf(of
d,"<br/>%s",tok->text);}/*if(desc)fprintf(ofd,"?'%s'",tok->desc);*/switch(tok->t
ype){caseSTART_TKN:color="#ccffcc";break;caseFORK_TKN:color="#aaddff";break;case
JOIN_TKN:color="#ddaaff";break;caseWORD_TKN:color="#ffffff";break;default:color=
"#ffffff";break;}fprintf(ofd,">,style=filled,fillcolor=\"%s\"];\n",color);if(sta
ckpos==CMD_ARGC_MAX)return;stack[stackpos++]=start;for(unsignedinti=0;i<vector_a
ctive(start->to);i++){structgraph_node*adj=vector_slot(start->to,i);//ifthisnode
isavararg,justprint*if(adj==start){fprintf(ofd,"n%p->n%p;\n",start,start);}elsei
f(((structcmd_token*)adj->data)->type==END_TKN){//structcmd_token*et=adj->data;f
printf(ofd,"n%p->end%p;\n",start,adj);fprintf(ofd,"end%p[shape=box,label=<end>,s
tyle=filled,fillcolor=\"#ffddaa\"];\n",adj);}else{fprintf(ofd,"n%p->n%p;\n",star
t,adj);size_tk;for(k=0;k<stackpos;k++)if(stack[k]==adj)break;if(k==stackpos){pre
tty_print_dot(ofd,opts,adj,stack,stackpos,visited,visitpos);}}}}/**stuffthatshou
ldgoincommand.c+command.h*/voidinit_cmdgraph(structvty*vty,structgraph**graph){/
/initializegraph,addstartnoe*graph=graph_new();nodegraph_free=*graph;structcmd_t
oken*token=cmd_token_new(START_TKN,0,NULL,NULL);graph_new_node(*graph,token,(voi
d(*)(void*))&cmd_token_del);if(vty)vty_out(vty,"initializedgraph\n");}