/**Copyright(c)2015-16DavidLamparter,forNetDEF,Inc.**Permissiontouse,copy,modify
,anddistributethissoftwareforany*purposewithorwithoutfeeisherebygranted,provided
thattheabove*copyrightnoticeandthispermissionnoticeappearinallcopies.**THESOFTWA
REISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINC
LUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBE
LIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEV
ERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOR
OTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFT
WARE.*/#ifndef_QOBJ_H#define_QOBJ_H#include<stdint.h>#include<stdlib.h>#include<
stddef.h>/*reserveaspecificamountofbytesforastruct,whichcangrowupto*thatsize(orb
edummy'doutifnotneeded)**notethepadding'sarraysizewillbeanerrorifitgetsnegativeo
rzero;*thisisintentionaltopreventthestructfromgrowingbeyondtheallocated*space.*/
#defineRESERVED_SPACE_STRUCT(name,fieldname,size)\struct{\structnamefieldname;\c
harpadding##fieldname[size-sizeof(structname)];\};/*don'tneedstructdefinitionsfo
rthesehere.codeactuallyusing*theseneedstodefinethestruct*before*includingthishea
der.*HAVE_QOBJ_xxxshouldbedefinedto+1inthatcase,likethis:**#ifdefined(HAVE_QOBJ_
NODETYPE_CLI)&&HAVE_QOBJ_NODETYPE_CLI<0*#errorincludefilesareinwrongorder*#else*
#defineHAVE_QOBJ_NODETYPE_CLI1*structqobj_nodetype_cli{...}*#endif*/#ifndefHAVE_
QOBJ_NODETYPE_CLI#defineHAVE_QOBJ_NODETYPE_CLI-1structqobj_nodetype_cli{intdummy
;};#endif#ifndefHAVE_QOBJ_NODETYPE_CAPNP#defineHAVE_QOBJ_NODETYPE_CAPNP-1structq
obj_nodetype_capnp{intdummy;};#endif/*eachdifferentkindofobjectwillhaveaglobalva
riableofthistype,*whichcanbeusedbyvariousotherpiecestostoretype-relatedbits.*typ
eequalitycanbetestedaspointerequality.(cf.QOBJ_GET_TYPESAFE)*/structqobj_nodetyp
e{ptrdiff_tnode_member_offset;RESERVED_SPACE_STRUCT(qobj_nodetype_cli,cli,256)RE
SERVED_SPACE_STRUCT(qobj_nodetype_capnp,capnp,256)};/*anchortobeembeddedsomewher
eintheobject'sstruct*/structqobj_node{uint64_tnid;structqobj_nodetype*type;};#de
fineQOBJ_FIELDSstructqobj_nodeqobj_node;/*calltheseattheendofany_createfunction(
QOBJ_REG)*andbeginningofany_destroyfunction(QOBJ_UNREG)*/#defineQOBJ_REG(n,struc
tname)qobj_reg(&n->qobj_node,&qobj_t_##structname)#defineQOBJ_UNREG(n)qobj_unreg
(&n->qobj_node)/*internals-shouldnotbedirectlyusedwithoutagoodreason**note:qobj_
getisessentiallyneversafetouseinMTcontextbecause*theobjectcouldbedeletedbyanothe
rthread--andworse,itcouldbe*ofthe"wrong"typeanddeleted.**withqobj_get_typed,thet
ypecheckisdoneunderlock,whichmeansthat*itcanbeusedaslongasanotherlockpreventsthe
deletionofobjects*oftheexpectedtype.**inthelongthismayneedanothertouch,e.g.built
-inper-objectlocking.*/voidqobj_reg(structqobj_node*node,structqobj_nodetype*typ
e);voidqobj_unreg(structqobj_node*node);structqobj_node*qobj_get(uint64_tid);voi
d*qobj_get_typed(uint64_tid,structqobj_nodetype*type);/*typedeclarations*/#defin
eDECLARE_QOBJ_TYPE(structname)\externstructqobj_nodetypeqobj_t_##structname;#def
ineDEFINE_QOBJ_TYPE(structname)\structqobj_nodetypeqobj_t_##structname={\.node_m
ember_offset=\(ptrdiff_t)offsetof(structstructname,qobj_node)};#defineDEFINE_QOB
J_TYPE_INIT(structname,...)\structqobj_nodetypeqobj_t_##structname={\.node_membe
r_offset=\(ptrdiff_t)offsetof(structstructname,qobj_node),\__VA_ARGS__};/*IDdere
ferencewithtypecheck.*willreturnNULLifidnotfoundorwrongtype.*/#defineQOBJ_GET_TY
PESAFE(id,structname)\((structstructname*)qobj_get_typed((id),&qobj_t_##structna
me))#defineQOBJ_ID(ptr)((ptr)->qobj_node.nid)#defineQOBJ_ID_0SAFE(ptr)\({\typeof
(ptr)_ptr=(ptr);\_ptr?_ptr->qobj_node.nid:0ULL;\})voidqobj_init(void);voidqobj_f
inish(void);#endif/*_QOBJ_H*/