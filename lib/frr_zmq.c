/**libzebraZeroMQbindings*Copyright(C)2015DavidLamparter**Thisprogramisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(atyouropti
on)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,butWIT
HOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPAR
TICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshouldhaverecei
vedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifno
t,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-
1301USA*/#include<zebra.h>#include<zmq.h>#include"thread.h"#include"memory.h"#in
clude"frr_zmq.h"#include"log.h"DEFINE_MTYPE_STATIC(LIB,ZEROMQ_CB,"ZeroMQcallback
")/*libzmq'scontext*/void*frrzmq_context=NULL;staticunsignedfrrzmq_initcount=0;v
oidfrrzmq_init(void){if(frrzmq_initcount++==0){frrzmq_context=zmq_ctx_new();zmq_
ctx_set(frrzmq_context,ZMQ_IPV6,1);}}voidfrrzmq_finish(void){if(--frrzmq_initcou
nt==0){zmq_ctx_term(frrzmq_context);frrzmq_context=NULL;}}staticintfrrzmq_read_m
sg(structthread*t){structfrrzmq_cb**cbp=THREAD_ARG(t);structfrrzmq_cb*cb;zmq_msg
_tmsg;unsignedpartno;unsignedcharread=0;intret,more;size_tmoresz;if(!cbp)return1
;cb=(*cbp);if(!cb||!cb->zmqsock)return1;while(1){zmq_pollitem_tpolli={.socket=cb
->zmqsock,.events=ZMQ_POLLIN};ret=zmq_poll(&polli,1,0);if(ret<0)gotoout_err;if(!
(polli.revents&ZMQ_POLLIN))break;if(cb->read.cb_msg){cb->read.cb_msg(cb->read.ar
g,cb->zmqsock);read=1;if(cb->read.cancelled){frrzmq_check_events(cbp,&cb->write,
ZMQ_POLLOUT);cb->read.thread=NULL;if(cb->write.cancelled&&!cb->write.thread)XFRE
E(MTYPE_ZEROMQ_CB,cb);return0;}continue;}partno=0;if(zmq_msg_init(&msg))gotoout_
err;do{ret=zmq_msg_recv(&msg,cb->zmqsock,ZMQ_NOBLOCK);if(ret<0){if(errno==EAGAIN
)break;zmq_msg_close(&msg);gotoout_err;}read=1;cb->read.cb_part(cb->read.arg,cb-
>zmqsock,&msg,partno);if(cb->read.cancelled){zmq_msg_close(&msg);frrzmq_check_ev
ents(cbp,&cb->write,ZMQ_POLLOUT);cb->read.thread=NULL;if(cb->write.cancelled&&!c
b->write.thread)XFREE(MTYPE_ZEROMQ_CB,cb);return0;}/*cb_partmayhavereadadditiona
lpartsofthe*message;don'tusezmq_msg_morehere*/moresz=sizeof(more);more=0;ret=zmq
_getsockopt(cb->zmqsock,ZMQ_RCVMORE,&more,&moresz);if(ret<0){zmq_msg_close(&msg)
;gotoout_err;}partno++;}while(more);zmq_msg_close(&msg);}if(read)frrzmq_check_ev
ents(cbp,&cb->write,ZMQ_POLLOUT);funcname_thread_add_read_write(THREAD_READ,t->m
aster,frrzmq_read_msg,cbp,cb->fd,&cb->read.thread,t->funcname,t->schedfrom,t->sc
hedfrom_line);return0;out_err:zlog_err("ZeroMQreaderror:%s(%d)",strerror(errno),
errno);if(cb->read.cb_error)cb->read.cb_error(cb->read.arg,cb->zmqsock);return1;
}intfuncname_frrzmq_thread_add_read(structthread_master*master,void(*msgfunc)(vo
id*arg,void*zmqsock),void(*partfunc)(void*arg,void*zmqsock,zmq_msg_t*msg,unsigne
dpartnum),void(*errfunc)(void*arg,void*zmqsock),void*arg,void*zmqsock,structfrrz
mq_cb**cbp,debugargdef){intfd,events;size_tlen;structfrrzmq_cb*cb;if(!cbp)return
-1;if(!(msgfunc||partfunc)||(msgfunc&&partfunc))return-1;len=sizeof(fd);if(zmq_g
etsockopt(zmqsock,ZMQ_FD,&fd,&len))return-1;len=sizeof(events);if(zmq_getsockopt
(zmqsock,ZMQ_EVENTS,&events,&len))return-1;if(*cbp)cb=*cbp;else{cb=XCALLOC(MTYPE
_ZEROMQ_CB,sizeof(structfrrzmq_cb));cb->write.cancelled=1;if(!cb)return-1;*cbp=c
b;}cb->zmqsock=zmqsock;cb->fd=fd;cb->read.arg=arg;cb->read.cb_msg=msgfunc;cb->re
ad.cb_part=partfunc;cb->read.cb_error=errfunc;cb->read.cancelled=0;if(events&ZMQ
_POLLIN){if(cb->read.thread){thread_cancel(cb->read.thread);cb->read.thread=NULL
;}funcname_thread_add_event(master,frrzmq_read_msg,cbp,fd,&cb->read.thread,funcn
ame,schedfrom,fromln);}elsefuncname_thread_add_read_write(THREAD_READ,master,frr
zmq_read_msg,cbp,fd,&cb->read.thread,funcname,schedfrom,fromln);return0;}statici
ntfrrzmq_write_msg(structthread*t){structfrrzmq_cb**cbp=THREAD_ARG(t);structfrrz
mq_cb*cb;unsignedcharwritten=0;intret;if(!cbp)return1;cb=(*cbp);if(!cb||!cb->zmq
sock)return1;while(1){zmq_pollitem_tpolli={.socket=cb->zmqsock,.events=ZMQ_POLLO
UT};ret=zmq_poll(&polli,1,0);if(ret<0)gotoout_err;if(!(polli.revents&ZMQ_POLLOUT
))break;if(cb->write.cb_msg){cb->write.cb_msg(cb->write.arg,cb->zmqsock);written
=1;if(cb->write.cancelled){frrzmq_check_events(cbp,&cb->read,ZMQ_POLLIN);cb->wri
te.thread=NULL;if(cb->read.cancelled&&!cb->read.thread)XFREE(MTYPE_ZEROMQ_CB,cb)
;return0;}continue;}}if(written)frrzmq_check_events(cbp,&cb->read,ZMQ_POLLIN);fu
ncname_thread_add_read_write(THREAD_WRITE,t->master,frrzmq_write_msg,cbp,cb->fd,
&cb->write.thread,t->funcname,t->schedfrom,t->schedfrom_line);return0;out_err:zl
og_err("ZeroMQwriteerror:%s(%d)",strerror(errno),errno);if(cb->write.cb_error)cb
->write.cb_error(cb->write.arg,cb->zmqsock);return1;}intfuncname_frrzmq_thread_a
dd_write(structthread_master*master,void(*msgfunc)(void*arg,void*zmqsock),void(*
errfunc)(void*arg,void*zmqsock),void*arg,void*zmqsock,structfrrzmq_cb**cbp,debug
argdef){intfd,events;size_tlen;structfrrzmq_cb*cb;if(!cbp)return-1;if(!msgfunc)r
eturn-1;len=sizeof(fd);if(zmq_getsockopt(zmqsock,ZMQ_FD,&fd,&len))return-1;len=s
izeof(events);if(zmq_getsockopt(zmqsock,ZMQ_EVENTS,&events,&len))return-1;if(*cb
p)cb=*cbp;else{cb=XCALLOC(MTYPE_ZEROMQ_CB,sizeof(structfrrzmq_cb));cb->read.canc
elled=1;if(!cb)return-1;*cbp=cb;}cb->zmqsock=zmqsock;cb->fd=fd;cb->write.arg=arg
;cb->write.cb_msg=msgfunc;cb->write.cb_part=NULL;cb->write.cb_error=errfunc;cb->
write.cancelled=0;if(events&ZMQ_POLLOUT){if(cb->write.thread){thread_cancel(cb->
write.thread);cb->write.thread=NULL;}funcname_thread_add_event(master,frrzmq_wri
te_msg,cbp,fd,&cb->write.thread,funcname,schedfrom,fromln);}elsefuncname_thread_
add_read_write(THREAD_WRITE,master,frrzmq_write_msg,cbp,fd,&cb->write.thread,fun
cname,schedfrom,fromln);return0;}voidfrrzmq_thread_cancel(structfrrzmq_cb**cb,st
ructcb_core*core){if(!cb||!*cb)return;core->cancelled=1;if(core->thread){thread_
cancel(core->thread);core->thread=NULL;}if((*cb)->read.cancelled&&!(*cb)->read.t
hread&&(*cb)->write.cancelled&&(*cb)->write.thread)XFREE(MTYPE_ZEROMQ_CB,*cb);}v
oidfrrzmq_check_events(structfrrzmq_cb**cbp,structcb_core*core,intevent){structf
rrzmq_cb*cb;intevents;size_tlen;if(!cbp)return;cb=(*cbp);if(!cb||!cb->zmqsock)re
turn;if(zmq_getsockopt(cb->zmqsock,ZMQ_EVENTS,&events,&len))return;if(events&eve
nt&&core->thread&&!core->cancelled){structthread_master*tm=core->thread->master;
thread_cancel(core->thread);core->thread=NULL;thread_add_event(tm,(event==ZMQ_PO
LLIN?frrzmq_read_msg:frrzmq_write_msg),cbp,cb->fd,&core->thread);}}