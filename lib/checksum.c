/**ChecksumroutineforInternetProtocolfamilyheaders(CVersion).**Referto"Computing
theInternetChecksum"byR.Braden,D.Bormanand*C.Partridge,ComputerCommunicationRevi
ew,Vol.19,No.2,April1989,*pp.86-101,foradditionaldetailsoncomputingthischecksum.
*/#include<zebra.h>#include"checksum.h"int/*returnchecksuminlow-order16bits*/in_
cksum(void*parg,intnbytes){unsignedshort*ptr=parg;registerlongsum;/*assumeslong=
=32bits*/unsignedshortoddbyte;registerunsignedshortanswer;/*assumesunsignedshort
==16bits*//**Ouralgorithmissimple,usinga32-bitaccumulator(sum),*weaddsequential1
6-bitwordstoit,andattheend,foldback*allthecarrybitsfromthetop16bitsintothelower1
6bits.*/sum=0;while(nbytes>1){sum+=*ptr++;nbytes-=2;}/*mopupanoddbyte,ifnecessar
y*/if(nbytes==1){oddbyte=0;/*makesuretophalfiszero*/*((uint8_t*)&oddbyte)=*(uint
8_t*)ptr;/*onebyteonly*/sum+=oddbyte;}/**Addbackcarryoutsfromtop16bitstolow16bit
s.*/sum=(sum>>16)+(sum&0xffff);/*addhigh-16tolow-16*/sum+=(sum>>16);/*addcarry*/
answer=~sum;/*ones-complement,thentruncateto16bits*/return(answer);}/*FletcherCh
ecksum--RefertoRFC1008.*/#defineMODX4102U/*5802shouldbefine*//*Tobeconsistent,of
fsetis0-basedindex,ratherthanthe1-basedindexrequiredinthespecificationISO8473,An
nexC.1*//*callingwithoffset==FLETCHER_CHECKSUM_VALIDATEwillvalidatethechecksumwi
thoutmodifyingthebuffer;avalidchecksumreturns0*/uint16_tfletcher_checksum(uint8_
t*buffer,constsize_tlen,constuint16_toffset){uint8_t*p;intx,y,c0,c1;uint16_tchec
ksum=0;uint16_t*csum;size_tpartial_len,i,left=len;if(offset!=FLETCHER_CHECKSUM_V
ALIDATE)/*Zerothecsuminthepacket.*/{assert(offset<(len-1));/*accountfortwobyteso
fchecksum*/csum=(uint16_t*)(buffer+offset);*(csum)=0;}p=buffer;c0=0;c1=0;while(l
eft!=0){partial_len=MIN(left,MODX);for(i=0;i<partial_len;i++){c0=c0+*(p++);c1+=c
0;}c0=c0%255;c1=c1%255;left-=partial_len;}/*Thecastisimportant,toensurethemodist
akenasasignedvalue.*/x=(int)((len-offset-1)*c0-c1)%255;if(x<=0)x+=255;y=510-c0-x
;if(y>255)y-=255;if(offset==FLETCHER_CHECKSUM_VALIDATE){checksum=(c1<<8)+c0;}els
e{/**Nowwewritethistothepacket.*Wecouldskipthissteptoo,sincethechecksumreturned*
would*bestoredintothechecksumfieldbythecaller.*/buffer[offset]=x;buffer[offset+1
]=y;/*Takecareoftheendianissue*/checksum=htons((x<<8)|(y&0xFF));}returnchecksum;
}