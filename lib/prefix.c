/**Prefixrelatedfunctions.*Copyright(C)1997,98,99KunihiroIshiguro**Thisfileispar
tofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthe
termsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherv
ersion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitw
illbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILI
TYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**
YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seet
hefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFlo
or,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"vty.h"#in
clude"sockunion.h"#include"memory.h"#include"log.h"#include"jhash.h"DEFINE_MTYPE
_STATIC(LIB,PREFIX,"Prefix")/*Maskbit.*/staticconstuint8_tmaskbit[]={0x00,0x80,0
xc0,0xe0,0xf0,0xf8,0xfc,0xfe,0xff};staticconststructin6_addrmaskbytes6[]={/*/0*/
{{{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x
00}}},/*/1*/{{{0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00}}},/*/2*/{{{0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00,0x00,0x00,0x00,0x00}}},/*/3*/{{{0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/4*/{{{0xf0,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/5*/{{{0xf8,0x00,0x00,0x
00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/6*/{{{0xfc,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*
/7*/{{{0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00}}},/*/8*/{{{0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00}}},/*/9*/{{{0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/10*/{{{0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/11*/{{{0xff,0xe0,0x00,0x00,0x0
0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/12*/{{{0xff,0xf0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/13*/
{{{0xff,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x
00}}},/*/14*/{{{0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00}}},/*/15*/{{{0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00,0x00,0x00}}},/*/16*/{{{0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/17*/{{{0xff,0xff,0x80,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/18*/{{{0xff,0xff,0x
c0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/19*/{{
{0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
}}},/*/20*/{{{0xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00}}},/*/21*/{{{0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00,0x00,0x00,0x00,0x00}}},/*/22*/{{{0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/23*/{{{0xff,0xff,0xfe,0x00,0x00,0x
00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/24*/{{{0xff,0xff,0xff
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/25*/{{{0
xff,0xff,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}
},/*/26*/{{{0xff,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00,0x00}}},/*/27*/{{{0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00}}},/*/28*/{{{0xff,0xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x
00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/29*/{{{0xff,0xff,0xff,0xf8,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/30*/{{{0xff,0xff,0xff,0
xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/31*/{{{0xf
f,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},
/*/32*/{{{0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00}}},/*/33*/{{{0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x
00,0x00,0x00,0x00,0x00}}},/*/34*/{{{0xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/35*/{{{0xff,0xff,0xff,0xff,0xe0,0x00,0
x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/36*/{{{0xff,0xff,0xff,0xf
f,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/37*/{{{0xff,
0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*
/38*/{{{0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x
00,0x00}}},/*/39*/{{{0xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00}}},/*/40*/{{{0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/41*/{{{0xff,0xff,0xff,0xff,0xff,0x80,0x0
0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/42*/{{{0xff,0xff,0xff,0xff,
0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/43*/{{{0xff,0x
ff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/4
4*/{{{0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00}}},/*/45*/{{{0xff,0xff,0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0
x00,0x00,0x00,0x00}}},/*/46*/{{{0xff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x00,0x0
0,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/47*/{{{0xff,0xff,0xff,0xff,0xff,0xfe,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/48*/{{{0xff,0xff,0xff,0xff,0x
ff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/49*/{{{0xff,0xff
,0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/50*
/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0
x00}}},/*/51*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x0
0,0x00,0x00,0x00}}},/*/52*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00}}},/*/53*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x
00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/54*/{{{0xff,0xff,0xff,0xff,0xff
,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/55*/{{{0xff,0xff,0
xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/56*/{
{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0
0}}},/*/57*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00}}},/*/58*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x
00,0x00,0x00,0x00,0x00,0x00}}},/*/59*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/60*/{{{0xff,0xff,0xff,0xff,0xff,0
xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/61*/{{{0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/62*/{{{
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
}},/*/63*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x
00,0x00,0x00}}},/*/64*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00}}},/*/65*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0
x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/66*/{{{0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/67*/{{{0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/68*/{{{0x
ff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}}
,/*/69*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00
,0x00,0x00}}},/*/70*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0
x00,0x00,0x00,0x00,0x00}}},/*/71*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
e,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/72*/{{{0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/73*/{{{0xff,0xff,0xff,0x
ff,0xff,0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/74*/{{{0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x00,0x00,0x00,0x00}}},/
*/75*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00,0
x00,0x00}}},/*/76*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x0
0,0x00,0x00,0x00,0x00}}},/*/77*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xf8,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/78*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/79*/{{{0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/80*/{{{0xff,0
xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00}}},/*/
81*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00,0x0
0,0x00}}},/*/82*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00,
0x00,0x00,0x00,0x00}}},/*/83*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xe0,0x00,0x00,0x00,0x00,0x00}}},/*/84*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xf0,0x00,0x00,0x00,0x00,0x00}}},/*/85*/{{{0xff,0xff,0xff,0xff,0
xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x00,0x00}}},/*/86*/{{{0xff,0xf
f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x00,0x00,0x00}}},/*/87
*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00,0x00,
0x00}}},/*/88*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x
00,0x00,0x00,0x00}}},/*/89*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0x80,0x00,0x00,0x00,0x00}}},/*/90*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0
xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x00,0x00}}},/*/91*/{{{0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00,0x00}}},/*/92*/{{{0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x00,0x00,0x00}}},/*/93*/
{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x00,0x00,0x00,0x
00}}},/*/94*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x00
,0x00,0x00,0x00}}},/*/95*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0
xff,0xfe,0x00,0x00,0x00,0x00}}},/*/96*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00}}},/*/97*/{{{0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x00,0x00,0x00}}},/*/98*/{{{0xff,0xff,0x
ff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00,0x00,0x00}}},/*/99*/{{
{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00,0x00,0x00
}}},/*/100*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
0x00,0x00,0x00}}},/*/101*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0
xff,0xff,0xf8,0x00,0x00,0x00}}},/*/102*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00,0x00}}},/*/103*/{{{0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0x00,0x00,0x00}}},/*/104*/{{{0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00}}},/*/105
*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x00,
0x00}}},/*/106*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0
xff,0xc0,0x00,0x00}}},/*/107*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xff,0xff,0xff,0xe0,0x00,0x00}}},/*/108*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00,0x00}}},/*/109*/{{{0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf8,0x00,0x00}}},/*/110*/{{{0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0x00,0x00}}},/*
/111*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0
x00,0x00}}},/*/112*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xff,0xff,0x00,0x00}}},/*/113*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xff,0xff,0x80,0x00}}},/*/114*/{{{0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,0x00}}},/*/115*/{{{0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,0x00}}},/*/116*/{{{0
xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,0x00}}
},/*/117*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
ff,0xf8,0x00}}},/*/118*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xff,0xfc,0x00}}},/*/119*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0x00}}},/*/120*/{{{0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00}}},/*/121*/{{{0xff,0xff,0
xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80}}},/*/122*/
{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x
c0}}},/*/123*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff,0xff,0xe0}}},/*/124*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xf0}}},/*/125*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf8}}},/*/126*/{{{0xff,0xff,0xff,0xff,0
xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc}}},/*/127*/{{{0xff,0x
ff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe}}},/*/1
28*/{{{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf
f,0xff}}}};/*Numberofbitsinprefixtype.*/#ifndefPNBBY#definePNBBY8#endif/*PNBBY*/
#defineMASKBIT(offset)((0xff<<(PNBBY-(offset)))&0xff)intis_zero_mac(structethadd
r*mac){inti=0;for(i=0;i<ETH_ALEN;i++){if(mac->octet[i])return0;}return1;}unsigne
dintprefix_bit(constuint8_t*prefix,constuint8_tprefixlen){unsignedintoffset=pref
ixlen/8;unsignedintshift=7-(prefixlen%8);return(prefix[offset]>>shift)&1;}unsign
edintprefix6_bit(conststructin6_addr*prefix,constuint8_tprefixlen){returnprefix_
bit((constuint8_t*)&prefix->s6_addr,prefixlen);}intstr2family(constchar*string){
if(!strcmp("ipv4",string))returnAF_INET;elseif(!strcmp("ipv6",string))returnAF_I
NET6;elseif(!strcmp("ethernet",string))returnAF_ETHERNET;elseif(!strcmp("evpn",s
tring))returnAF_EVPN;return-1;}/*AddressFamiyIdentifiertoAddressFamilyconverter.
*/intafi2family(afi_tafi){if(afi==AFI_IP)returnAF_INET;elseif(afi==AFI_IP6)retur
nAF_INET6;elseif(afi==AFI_L2VPN)returnAF_ETHERNET;/*NOTE:EVPNcodeshouldNOTusethi
sinterface.*/return0;}afi_tfamily2afi(intfamily){if(family==AF_INET)returnAFI_IP
;elseif(family==AF_INET6)returnAFI_IP6;elseif(family==AF_ETHERNET||family==AF_EV
PN)returnAFI_L2VPN;return0;}constchar*afi2str(afi_tafi){switch(afi){caseAFI_IP:r
eturn"IPv4";caseAFI_IP6:return"IPv6";caseAFI_L2VPN:return"l2vpn";caseAFI_MAX:ret
urn"bad-value";default:break;}returnNULL;}constchar*safi2str(safi_tsafi){switch(
safi){caseSAFI_UNICAST:return"unicast";caseSAFI_MULTICAST:return"multicast";case
SAFI_MPLS_VPN:return"vpn";caseSAFI_ENCAP:return"encap";caseSAFI_EVPN:return"evpn
";caseSAFI_LABELED_UNICAST:return"labeled-unicast";caseSAFI_FLOWSPEC:return"flow
spec";default:return"unknown";}}/*Ifnincludespprefixthenreturn1elsereturn0.*/int
prefix_match(conststructprefix*n,conststructprefix*p){intoffset;intshift;constui
nt8_t*np,*pp;/*Ifn'sprefixislongerthanp'sonereturn0.*/if(n->prefixlen>p->prefixl
en)return0;if(n->family==AF_FLOWSPEC){/*prefixlenisunused.lookatfsprefixlen*/if(
n->u.prefix_flowspec.prefixlen>p->u.prefix_flowspec.prefixlen)return0;/*Setbothp
refix'sheadpointer.*/np=(constuint8_t*)&n->u.prefix_flowspec.ptr;pp=(constuint8_
t*)&p->u.prefix_flowspec.ptr;offset=n->u.prefix_flowspec.prefixlen;while(offset-
-)if(np[offset]!=pp[offset])return0;return1;}/*Setbothprefix'sheadpointer.*/np=(
constuint8_t*)&n->u.prefix;pp=(constuint8_t*)&p->u.prefix;offset=n->prefixlen/PN
BBY;shift=n->prefixlen%PNBBY;if(shift)if(maskbit[shift]&(np[offset]^pp[offset]))
return0;while(offset--)if(np[offset]!=pp[offset])return0;return1;}/*Ifnincludesp
thenreturn1elsereturn0.Prefixmaskisnotconsidered*/intprefix_match_network_statem
ent(conststructprefix*n,conststructprefix*p){intoffset;intshift;constuint8_t*np,
*pp;/*Setbothprefix'sheadpointer.*/np=(constuint8_t*)&n->u.prefix;pp=(constuint8
_t*)&p->u.prefix;offset=n->prefixlen/PNBBY;shift=n->prefixlen%PNBBY;if(shift)if(
maskbit[shift]&(np[offset]^pp[offset]))return0;while(offset--)if(np[offset]!=pp[
offset])return0;return1;}voidprefix_copy(structprefix*dest,conststructprefix*src
){dest->family=src->family;dest->prefixlen=src->prefixlen;if(src->family==AF_INE
T)dest->u.prefix4=src->u.prefix4;elseif(src->family==AF_INET6)dest->u.prefix6=sr
c->u.prefix6;elseif(src->family==AF_ETHERNET){memcpy(&dest->u.prefix_eth,&src->u
.prefix_eth,sizeof(structethaddr));}elseif(src->family==AF_EVPN){memcpy(&dest->u
.prefix_evpn,&src->u.prefix_evpn,sizeof(structevpn_addr));}elseif(src->family==A
F_UNSPEC){dest->u.lp.id=src->u.lp.id;dest->u.lp.adv_router=src->u.lp.adv_router;
}elseif(src->family==AF_FLOWSPEC){void*temp;intlen;len=src->u.prefix_flowspec.pr
efixlen;dest->u.prefix_flowspec.prefixlen=src->u.prefix_flowspec.prefixlen;dest-
>family=src->family;temp=XCALLOC(MTYPE_PREFIX_FLOWSPEC,len);dest->u.prefix_flows
pec.ptr=(uintptr_t)temp;memcpy((void*)dest->u.prefix_flowspec.ptr,(void*)src->u.
prefix_flowspec.ptr,len);}else{zlog_err("prefix_copy():Unknownaddressfamily%d",s
rc->family);assert(0);}}/**Return1iftheaddress/netmaskcontainedintheprefixstruct
ure*isthesame,andelsereturn0.Forthisroutine,'same'requires*thatnotonlytheprefixl
engthandthenetworkpartbethesame,*butalsothehostpart.Thus,10.0.0.1/8and10.0.0.2/8
arenot*thesame.Notethatthisroutinehasthesamereturnvaluesense*as'=='(whichisdiffe
rentfromprefix_cmp).*/intprefix_same(conststructprefix*p1,conststructprefix*p2){
if((p1&&!p2)||(!p1&&p2))return0;if(!p1&&!p2)return1;if(p1->family==p2->family&&p
1->prefixlen==p2->prefixlen){if(p1->family==AF_INET)if(IPV4_ADDR_SAME(&p1->u.pre
fix4,&p2->u.prefix4))return1;if(p1->family==AF_INET6)if(IPV6_ADDR_SAME(&p1->u.pr
efix6.s6_addr,&p2->u.prefix6.s6_addr))return1;if(p1->family==AF_ETHERNET)if(!mem
cmp(&p1->u.prefix_eth,&p2->u.prefix_eth,sizeof(structethaddr)))return1;if(p1->fa
mily==AF_EVPN)if(!memcmp(&p1->u.prefix_evpn,&p2->u.prefix_evpn,sizeof(structevpn
_addr)))return1;if(p1->family==AF_FLOWSPEC){if(p1->u.prefix_flowspec.prefixlen!=
p2->u.prefix_flowspec.prefixlen)return0;if(!memcmp(&p1->u.prefix_flowspec.ptr,&p
2->u.prefix_flowspec.ptr,p2->u.prefix_flowspec.prefixlen))return1;}}return0;}/**
Return0ifthenetworkprefixesrepresentedbythestructprefix*argumentsarethesameprefi
x,and1otherwise.Networkprefixes*areconsideredthesameiftheprefixlengthsareequalan
dthe*networkpartsarethesame.Hostbits(whichareconsideredmasked*bytheprefixlength)
arenotsignificant.Thus,10.0.0.1/8and*10.0.0.2/8areconsideredequivalentbythisrout
ine.Notethat*thisroutinehasthesamereturnsenseasstrcmp(whichisdifferent*fromprefi
x_same).*/intprefix_cmp(conststructprefix*p1,conststructprefix*p2){intoffset;int
shift;/*Setbothprefix'sheadpointer.*/constuint8_t*pp1;constuint8_t*pp2;if(p1->fa
mily!=p2->family)return1;if(p1->family==AF_FLOWSPEC){pp1=(constuint8_t*)p1->u.pr
efix_flowspec.ptr;pp2=(constuint8_t*)p2->u.prefix_flowspec.ptr;if(p1->u.prefix_f
lowspec.prefixlen!=p2->u.prefix_flowspec.prefixlen)return1;offset=p1->u.prefix_f
lowspec.prefixlen;while(offset--)if(pp1[offset]!=pp2[offset])return1;return0;}pp
1=(constuint8_t*)&p1->u.prefix;pp2=(constuint8_t*)&p2->u.prefix;if(p1->prefixlen
!=p2->prefixlen)return1;offset=p1->prefixlen/PNBBY;shift=p1->prefixlen%PNBBY;if(
shift)if(maskbit[shift]&(pp1[offset]^pp2[offset]))return1;while(offset--)if(pp1[
offset]!=pp2[offset])return1;return0;}/**Countthenumberofcommonbitsin2prefixes.T
heprefixlengthis*ignoredforthisfunction;thewholeprefixiscompared.Iftheprefix*add
ressfamiliesdon'tmatch,return-1;otherwisethereturnvalueis*inrange0...maximumpref
ixlengthfortheaddressfamily.*/intprefix_common_bits(conststructprefix*p1,constst
ructprefix*p2){intpos,bit;intlength=0;uint8_txor;/*Setbothprefix'sheadpointer.*/
constuint8_t*pp1=(constuint8_t*)&p1->u.prefix;constuint8_t*pp2=(constuint8_t*)&p
2->u.prefix;if(p1->family==AF_INET)length=IPV4_MAX_BYTELEN;if(p1->family==AF_INE
T6)length=IPV6_MAX_BYTELEN;if(p1->family==AF_ETHERNET)length=ETH_ALEN;if(p1->fam
ily==AF_EVPN)length=8*sizeof(structevpn_addr);if(p1->family!=p2->family||!length
)return-1;for(pos=0;pos<length;pos++)if(pp1[pos]!=pp2[pos])break;if(pos==length)
returnpos*8;xor=pp1[pos]^pp2[pos];for(bit=0;bit<8;bit++)if(xor&(1<<(7-bit)))brea
k;returnpos*8+bit;}/*Returnprefixfamilytypestring.*/constchar*prefix_family_str(
conststructprefix*p){if(p->family==AF_INET)return"inet";if(p->family==AF_INET6)r
eturn"inet6";if(p->family==AF_ETHERNET)return"ether";if(p->family==AF_EVPN)retur
n"evpn";return"unspec";}/*Allocatenewprefix_ipv4structure.*/structprefix_ipv4*pr
efix_ipv4_new(){structprefix_ipv4*p;/*Callprefix_newtoallocateafull-sizestructpr
efixtoavoidproblemswherethestructprefix_ipv4iscasttostructprefixandunallocatedby
teswerebeingreferenced(e.g.instructureassignments).*/p=(structprefix_ipv4*)prefi
x_new();p->family=AF_INET;returnp;}/*Freeprefix_ipv4structure.*/voidprefix_ipv4_
free(structprefix_ipv4*p){prefix_free((structprefix*)p);}/*Whenstringformatisinv
alidreturn0.*/intstr2prefix_ipv4(constchar*str,structprefix_ipv4*p){intret;intpl
en;char*pnt;char*cp;/*Findslashinsidestring.*/pnt=strchr(str,'/');/*Stringdoesn'
tcontailslash.*/if(pnt==NULL){/*Convertstringtoprefix.*/ret=inet_aton(str,&p->pr
efix);if(ret==0)return0;/*Ifaddressdoesn'tcontainslashweassumeithostaddress.*/p-
>family=AF_INET;p->prefixlen=IPV4_MAX_BITLEN;returnret;}else{cp=XMALLOC(MTYPE_TM
P,(pnt-str)+1);strncpy(cp,str,pnt-str);*(cp+(pnt-str))='\0';ret=inet_aton(cp,&p-
>prefix);XFREE(MTYPE_TMP,cp);/*Getprefixlength.*/plen=(uint8_t)atoi(++pnt);if(pl
en>IPV4_MAX_PREFIXLEN)return0;p->family=AF_INET;p->prefixlen=plen;}returnret;}/*
Whenstringformatisinvalidreturn0.*/intstr2prefix_eth(constchar*str,structprefix_
eth*p){intret=0;intplen=48;char*pnt;char*cp=NULL;constchar*str_addr=str;unsigned
inta[6];inti;boolslash=false;if(!strcmp(str,"any")){memset(p,0,sizeof(*p));p->fa
mily=AF_ETHERNET;return1;}/*Findslashinsidestring.*/pnt=strchr(str,'/');if(pnt){
/*Getprefixlength.*/plen=(uint8_t)atoi(++pnt);if(plen>48){ret=0;gotodone;}cp=XMA
LLOC(MTYPE_TMP,(pnt-str)+1);strncpy(cp,str,pnt-str);*(cp+(pnt-str))='\0';str_add
r=cp;slash=true;}/*Convertstringtoprefix.*/if(sscanf(str_addr,"%2x:%2x:%2x:%2x:%
2x:%2x",a+0,a+1,a+2,a+3,a+4,a+5)!=6){ret=0;gotodone;}for(i=0;i<6;++i){p->eth_add
r.octet[i]=a[i]&0xff;}p->prefixlen=plen;p->family=AF_ETHERNET;/**specialcasetoal
lowoldconfigurationstowork*Sinceallzero'sisimplicitlymeanttoallow*acomparisontoz
ero,let'sassume*/if(!slash&&is_zero_mac(&(p->eth_addr)))p->prefixlen=0;ret=1;don
e:if(cp)XFREE(MTYPE_TMP,cp);returnret;}/*ConvertmasklenintoIPaddress'snetmask(ne
tworkbyteorder).*/voidmasklen2ip(constintmasklen,structin_addr*netmask){assert(m
asklen>=0&&masklen<=IPV4_MAX_BITLEN);/*leftshiftisonlydefinedforlessthanthesizeo
fthetype.*weunconditionallyuselonglongincasethetargetplatform*hasdefinedbehaviou
rfor<<32(orhasa64-bitleftshift)*/if(sizeof(unsignedlonglong)>4)netmask->s_addr=h
tonl(0xffffffffULL<<(32-masklen));elsenetmask->s_addr=htonl(masklen?0xffffffffU<
<(32-masklen):0);}/*ConvertIPaddress'snetmaskintointeger.Weassumenetmaskissequen
tialone.Argumentnetmaskshouldbenetworkbyteorder.*/uint8_tip_masklen(structin_add
rnetmask){uint32_ttmp=~ntohl(netmask.s_addr);if(tmp)/*clz:countleadingzeroes.sad
ly,thebehaviourofthis*builtin*isundefinedfora0argument,eventhoughmostCPUsgive32*
/return__builtin_clz(tmp);elsereturn32;}/*ApplymasktoIPv4prefix(networkbyteorder
).*/voidapply_mask_ipv4(structprefix_ipv4*p){structin_addrmask;masklen2ip(p->pre
fixlen,&mask);p->prefix.s_addr&=mask.s_addr;}/*Ifprefixis0.0.0.0/0thenreturn1els
ereturn0.*/intprefix_ipv4_any(conststructprefix_ipv4*p){return(p->prefix.s_addr=
=0&&p->prefixlen==0);}/*Allocateanewipversion6route*/structprefix_ipv6*prefix_ip
v6_new(void){structprefix_ipv6*p;/*Allocateafull-sizestructprefixtoavoidproblems
withstructuresizemismatches.*/p=(structprefix_ipv6*)prefix_new();p->family=AF_IN
ET6;returnp;}/*FreeprefixforIPv6.*/voidprefix_ipv6_free(structprefix_ipv6*p){pre
fix_free((structprefix*)p);}/*Ifgivenstringisvalidreturnpin6elsereturnNULL*/ints
tr2prefix_ipv6(constchar*str,structprefix_ipv6*p){char*pnt;char*cp;intret;pnt=st
rchr(str,'/');/*Ifstringdoesn'tcontain`/'treatitashostroute.*/if(pnt==NULL){ret=
inet_pton(AF_INET6,str,&p->prefix);if(ret==0)return0;p->prefixlen=IPV6_MAX_BITLE
N;}else{intplen;cp=XMALLOC(MTYPE_TMP,(pnt-str)+1);strncpy(cp,str,pnt-str);*(cp+(
pnt-str))='\0';ret=inet_pton(AF_INET6,cp,&p->prefix);XFREE(MTYPE_TMP,cp);if(ret=
=0)return0;plen=(uint8_t)atoi(++pnt);if(plen>IPV6_MAX_BITLEN)return0;p->prefixle
n=plen;}p->family=AF_INET6;returnret;}/*Convertstructin6_addrnetmaskintointeger.
*FIXMEreturnuint8_tasip_maskleni()does.*/intip6_masklen(structin6_addrnetmask){i
ntlen=0;unsignedcharval;unsignedchar*pnt;pnt=(unsignedchar*)&netmask;while((*pnt
==0xff)&&len<IPV6_MAX_BITLEN){len+=8;pnt++;}if(len<IPV6_MAX_BITLEN){val=*pnt;whi
le(val){len++;val<<=1;}}returnlen;}voidmasklen2ip6(constintmasklen,structin6_add
r*netmask){assert(masklen>=0&&masklen<=IPV6_MAX_BITLEN);memcpy(netmask,maskbytes
6+masklen,sizeof(structin6_addr));}voidapply_mask_ipv6(structprefix_ipv6*p){uint
8_t*pnt;intindex;intoffset;index=p->prefixlen/8;if(index<16){pnt=(uint8_t*)&p->p
refix;offset=p->prefixlen%8;pnt[index]&=maskbit[offset];index++;while(index<16)p
nt[index++]=0;}}voidapply_mask(structprefix*p){switch(p->family){caseAF_INET:app
ly_mask_ipv4((structprefix_ipv4*)p);break;caseAF_INET6:apply_mask_ipv6((structpr
efix_ipv6*)p);break;default:break;}return;}/*Utilityfunctionofconvertbetweenstru
ctprefix<=>unionsockunion.*FIXMEThisfunctionisn'tusedanywhere.*/structprefix*soc
kunion2prefix(constunionsockunion*dest,constunionsockunion*mask){if(dest->sa.sa_
family==AF_INET){structprefix_ipv4*p;p=prefix_ipv4_new();p->family=AF_INET;p->pr
efix=dest->sin.sin_addr;p->prefixlen=ip_masklen(mask->sin.sin_addr);return(struc
tprefix*)p;}if(dest->sa.sa_family==AF_INET6){structprefix_ipv6*p;p=prefix_ipv6_n
ew();p->family=AF_INET6;p->prefixlen=ip6_masklen(mask->sin6.sin6_addr);memcpy(&p
->prefix,&dest->sin6.sin6_addr,sizeof(structin6_addr));return(structprefix*)p;}r
eturnNULL;}/*Utilityfunctionofconvertbetweenstructprefix<=>unionsockunion.*/stru
ctprefix*sockunion2hostprefix(constunionsockunion*su,structprefix*prefix){if(su-
>sa.sa_family==AF_INET){structprefix_ipv4*p;p=prefix?(structprefix_ipv4*)prefix:
prefix_ipv4_new();p->family=AF_INET;p->prefix=su->sin.sin_addr;p->prefixlen=IPV4
_MAX_BITLEN;return(structprefix*)p;}if(su->sa.sa_family==AF_INET6){structprefix_
ipv6*p;p=prefix?(structprefix_ipv6*)prefix:prefix_ipv6_new();p->family=AF_INET6;
p->prefixlen=IPV6_MAX_BITLEN;memcpy(&p->prefix,&su->sin6.sin6_addr,sizeof(struct
in6_addr));return(structprefix*)p;}returnNULL;}voidprefix2sockunion(conststructp
refix*p,unionsockunion*su){memset(su,0,sizeof(*su));su->sa.sa_family=p->family;i
f(p->family==AF_INET)su->sin.sin_addr=p->u.prefix4;if(p->family==AF_INET6)memcpy
(&su->sin6.sin6_addr,&p->u.prefix6,sizeof(structin6_addr));}intprefix_blen(const
structprefix*p){switch(p->family){caseAF_INET:returnIPV4_MAX_BYTELEN;break;caseA
F_INET6:returnIPV6_MAX_BYTELEN;break;caseAF_ETHERNET:returnETH_ALEN;break;}retur
n0;}/*Genericfunctionforconversionstringtostructprefix.*/intstr2prefix(constchar
*str,structprefix*p){intret;/*Firstwetrytoconvertstringtostructprefix_ipv4.*/ret
=str2prefix_ipv4(str,(structprefix_ipv4*)p);if(ret)returnret;/*Nextwetrytoconver
tstringtostructprefix_ipv6.*/ret=str2prefix_ipv6(str,(structprefix_ipv6*)p);if(r
et)returnret;/*Nextwetrytoconvertstringtostructprefix_eth.*/ret=str2prefix_eth(s
tr,(structprefix_eth*)p);if(ret)returnret;return0;}staticconstchar*prefixevpn2st
r(conststructprefix*p,char*str,intsize){uint8_tfamily;charbuf[PREFIX2STR_BUFFER]
;charbuf2[ETHER_ADDR_STRLEN];if(p->u.prefix_evpn.route_type==2){if(IS_EVPN_PREFI
X_IPADDR_NONE((structprefix_evpn*)p))snprintf(str,size,"[%d]:[%s]/%d",p->u.prefi
x_evpn.route_type,prefix_mac2str(&p->u.prefix_evpn.mac,buf2,sizeof(buf2)),p->pre
fixlen);else{family=IS_EVPN_PREFIX_IPADDR_V4((structprefix_evpn*)p)?AF_INET:AF_I
NET6;snprintf(str,size,"[%d]:[%s]:[%s]/%d",p->u.prefix_evpn.route_type,prefix_ma
c2str(&p->u.prefix_evpn.mac,buf2,sizeof(buf2)),inet_ntop(family,&p->u.prefix_evp
n.ip.ip.addr,buf,PREFIX2STR_BUFFER),p->prefixlen);}}elseif(p->u.prefix_evpn.rout
e_type==3){family=IS_EVPN_PREFIX_IPADDR_V4((structprefix_evpn*)p)?AF_INET:AF_INE
T6;snprintf(str,size,"[%d]:[%s]/%d",p->u.prefix_evpn.route_type,inet_ntop(family
,&p->u.prefix_evpn.ip.ip.addr,buf,PREFIX2STR_BUFFER),p->prefixlen);}elseif(p->u.
prefix_evpn.route_type==5){family=IS_EVPN_PREFIX_IPADDR_V4((structprefix_evpn*)p
)?AF_INET:AF_INET6;snprintf(str,size,"[%d]:[%u][%s/%d]/%d",p->u.prefix_evpn.rout
e_type,p->u.prefix_evpn.eth_tag,inet_ntop(family,&p->u.prefix_evpn.ip.ip.addr,bu
f,PREFIX2STR_BUFFER),p->u.prefix_evpn.ip_prefix_length,p->prefixlen);}else{sprin
tf(str,"UnsupportedEVPNroutetype%d",p->u.prefix_evpn.route_type);}returnstr;}con
stchar*prefix2str(unionprefixconstptrpu,char*str,intsize){conststructprefix*p=pu
.p;charbuf[PREFIX2STR_BUFFER];switch(p->family){caseAF_INET:caseAF_INET6:snprint
f(str,size,"%s/%d",inet_ntop(p->family,&p->u.prefix,buf,PREFIX2STR_BUFFER),p->pr
efixlen);break;caseAF_ETHERNET:snprintf(str,size,"%s/%d",prefix_mac2str(&p->u.pr
efix_eth,buf,sizeof(buf)),p->prefixlen);break;caseAF_EVPN:prefixevpn2str(p,str,s
ize);break;caseAF_FLOWSPEC:sprintf(str,"FSprefix");break;default:sprintf(str,"UN
Kprefix");break;}returnstr;}structprefix*prefix_new(){structprefix*p;p=XCALLOC(M
TYPE_PREFIX,sizeof*p);returnp;}/*Freeprefixstructure.*/voidprefix_free(structpre
fix*p){XFREE(MTYPE_PREFIX,p);}/*Utilityfunction.Checkthestringonlycontainsdigit*
character.*FIXMEstr.[c|h]wouldbebetterplaceforthisfunction.*/intall_digit(constc
har*str){for(;*str!='\0';str++)if(!isdigit((int)*str))return0;return1;}/*Utility
functiontoconvertipv4prefixestoClassfulprefixes*/voidapply_classful_mask_ipv4(st
ructprefix_ipv4*p){uint32_tdestination;destination=ntohl(p->prefix.s_addr);if(p-
>prefixlen==IPV4_MAX_PREFIXLEN);/*donothingforhostroutes*/elseif(IN_CLASSC(desti
nation)){p->prefixlen=24;apply_mask_ipv4(p);}elseif(IN_CLASSB(destination)){p->p
refixlen=16;apply_mask_ipv4(p);}else{p->prefixlen=8;apply_mask_ipv4(p);}}in_addr
_tipv4_network_addr(in_addr_thostaddr,intmasklen){structin_addrmask;masklen2ip(m
asklen,&mask);returnhostaddr&mask.s_addr;}in_addr_tipv4_broadcast_addr(in_addr_t
hostaddr,intmasklen){structin_addrmask;masklen2ip(masklen,&mask);return(masklen!
=IPV4_MAX_PREFIXLEN-1)?/*normalcase*/(hostaddr|~mask.s_addr):/*specialcasefor/31
*/(hostaddr^~mask.s_addr);}/*Utilityfunctiontoconvertipv4netmasktoprefixesex.)"1
.1.0.0""255.255.0.0"=>"1.1.0.0/16"ex.)"1.0.0.0"NULL=>"1.0.0.0/8"*/intnetmask_str
2prefix_str(constchar*net_str,constchar*mask_str,char*prefix_str){structin_addrn
etwork;structin_addrmask;uint8_tprefixlen;uint32_tdestination;intret;ret=inet_at
on(net_str,&network);if(!ret)return0;if(mask_str){ret=inet_aton(mask_str,&mask);
if(!ret)return0;prefixlen=ip_masklen(mask);}else{destination=ntohl(network.s_add
r);if(network.s_addr==0)prefixlen=0;elseif(IN_CLASSC(destination))prefixlen=24;e
lseif(IN_CLASSB(destination))prefixlen=16;elseif(IN_CLASSA(destination))prefixle
n=8;elsereturn0;}sprintf(prefix_str,"%s/%d",net_str,prefixlen);return1;}/*Utilit
yfunctionformakingIPv6addressstring.*/constchar*inet6_ntoa(structin6_addraddr){s
taticcharbuf[INET6_ADDRSTRLEN];inet_ntop(AF_INET6,&addr,buf,INET6_ADDRSTRLEN);re
turnbuf;}/*convertstointernalrepresentationofmacaddress*returns1onsuccess,0other
wise*formataccepted:AA:BB:CC:DD:EE:FF*ifmacparameterisnull,thencheckonly*/intpre
fix_str2mac(constchar*str,structethaddr*mac){unsignedinta[6];inti;if(!str)return
0;if(sscanf(str,"%2x:%2x:%2x:%2x:%2x:%2x",a+0,a+1,a+2,a+3,a+4,a+5)!=6){/*errorin
incomingstrlength*/return0;}/*validmacaddress*/if(!mac)return1;for(i=0;i<6;++i)m
ac->octet[i]=a[i]&0xff;return1;}char*prefix_mac2str(conststructethaddr*mac,char*
buf,intsize){char*ptr;if(!mac)returnNULL;if(!buf)ptr=(char*)XMALLOC(MTYPE_TMP,ET
HER_ADDR_STRLEN*sizeof(char));else{assert(size>=ETHER_ADDR_STRLEN);ptr=buf;}snpr
intf(ptr,(ETHER_ADDR_STRLEN),"%02x:%02x:%02x:%02x:%02x:%02x",(uint8_t)mac->octet
[0],(uint8_t)mac->octet[1],(uint8_t)mac->octet[2],(uint8_t)mac->octet[3],(uint8_
t)mac->octet[4],(uint8_t)mac->octet[5]);returnptr;}unsignedprefix_hash_key(void*
pp){structprefixcopy;if(((structprefix*)pp)->family==AF_FLOWSPEC){uint32_tlen;vo
id*temp;/*makesure*all*unusedbitsarezero,*particularlyincludingalignment/*paddin
gandunusedprefixbytes.*/memset(&copy,0,sizeof(copy));prefix_copy(&copy,(structpr
efix*)pp);len=jhash((void*)copy.u.prefix_flowspec.ptr,copy.u.prefix_flowspec.pre
fixlen,0x55aa5a5a);temp=(void*)copy.u.prefix_flowspec.ptr;XFREE(MTYPE_PREFIX_FLO
WSPEC,temp);copy.u.prefix_flowspec.ptr=(uintptr_t)NULL;returnlen;}/*makesure*all
*unusedbitsarezero,particularlyincluding*alignment/*paddingandunusedprefixbytes.
*/memset(&copy,0,sizeof(copy));prefix_copy(&copy,(structprefix*)pp);returnjhash(
&copy,offsetof(structprefix,u.prefix)+PSIZE(copy.prefixlen),0x55aa5a5a);}