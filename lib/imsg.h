/*$OpenBSD$*//**Copyright(c)2006,2007Pierre-YvesRitschard<pyr@openbsd.org>*Copyr
ight(c)2006,2007,2008ReykFloeter<reyk@openbsd.org>*Copyright(c)2003,2004HenningB
rauer<henning@openbsd.org>**Permissiontouse,copy,modify,anddistributethissoftwar
eforany*purposewithorwithoutfeeisherebygranted,providedthattheabove*copyrightnot
iceandthispermissionnoticeappearinallcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEA
UTHORDISCLAIMSALLWARRANTIES*WITHREGARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIE
SOF*MERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRE
CT,INDIRECT,ORCONSEQUENTIALDAMAGESORANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,
DATAORPROFITS,WHETHERINAN*ACTIONOFCONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISI
NGOUTOF*ORINCONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFTWARE.*/#ifndef_IMSG_H_#de
fine_IMSG_H_#defineIBUF_READ_SIZE65535#defineIMSG_HEADER_SIZEsizeof(structimsg_h
dr)#defineMAX_IMSGSIZE16384structibuf{TAILQ_ENTRY(ibuf)entry;uint8_t*buf;size_ts
ize;size_tmax;size_twpos;size_trpos;intfd;};structmsgbuf{TAILQ_HEAD(,ibuf)bufs;u
int32_tqueued;intfd;};structibuf_read{uint8_tbuf[IBUF_READ_SIZE];uint8_t*rptr;si
ze_twpos;};structimsg_fd{TAILQ_ENTRY(imsg_fd)entry;intfd;};structimsgbuf{TAILQ_H
EAD(,imsg_fd)fds;structibuf_readr;structmsgbufw;intfd;pid_tpid;};#defineIMSGF_HA
SFD1structimsg_hdr{uint32_ttype;uint16_tlen;uint16_tflags;uint32_tpeerid;uint32_
tpid;};structimsg{structimsg_hdrhdr;intfd;void*data;};/*buffer.c*/structibuf*ibu
f_open(size_t);structibuf*ibuf_dynamic(size_t,size_t);intibuf_add(structibuf*,co
nstvoid*,size_t);void*ibuf_reserve(structibuf*,size_t);void*ibuf_seek(structibuf
*,size_t,size_t);size_tibuf_size(structibuf*);size_tibuf_left(structibuf*);voidi
buf_close(structmsgbuf*,structibuf*);intibuf_write(structmsgbuf*);voidibuf_free(
structibuf*);voidmsgbuf_init(structmsgbuf*);voidmsgbuf_clear(structmsgbuf*);intm
sgbuf_write(structmsgbuf*);voidmsgbuf_drain(structmsgbuf*,size_t);/*imsg.c*/void
imsg_init(structimsgbuf*,int);ssize_timsg_read(structimsgbuf*);ssize_timsg_get(s
tructimsgbuf*,structimsg*);intimsg_compose(structimsgbuf*,uint32_t,uint32_t,pid_
t,int,constvoid*,uint16_t);intimsg_composev(structimsgbuf*,uint32_t,uint32_t,pid
_t,int,conststructiovec*,int);structibuf*imsg_create(structimsgbuf*,uint32_t,uin
t32_t,pid_t,uint16_t);intimsg_add(structibuf*,constvoid*,uint16_t);voidimsg_clos
e(structimsgbuf*,structibuf*);voidimsg_free(structimsg*);intimsg_flush(structims
gbuf*);voidimsg_clear(structimsgbuf*);#endif