/*$OpenBSD$*//**Copyright(c)2003,2004HenningBrauer<henning@openbsd.org>**Permiss
iontouse,copy,modify,anddistributethissoftwareforany*purposewithorwithoutfeeishe
rebygranted,providedthattheabove*copyrightnoticeandthispermissionnoticeappearina
llcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEAUTHORDISCLAIMSALLWARRANTIES*WITHREG
ARDTOTHISSOFTWAREINCLUDINGALLIMPLIEDWARRANTIESOF*MERCHANTABILITYANDFITNESS.INNOE
VENTSHALLTHEAUTHORBELIABLEFOR*ANYSPECIAL,DIRECT,INDIRECT,ORCONSEQUENTIALDAMAGESO
RANYDAMAGES*WHATSOEVERRESULTINGFROMLOSSOFUSE,DATAORPROFITS,WHETHERINAN*ACTIONOFC
ONTRACT,NEGLIGENCEOROTHERTORTIOUSACTION,ARISINGOUTOF*ORINCONNECTIONWITHTHEUSEORP
ERFORMANCEOFTHISSOFTWARE.*/#include<zebra.h>#include"queue.h"#include"imsg.h"int
ibuf_realloc(structibuf*,size_t);voidibuf_enqueue(structmsgbuf*,structibuf*);voi
dibuf_dequeue(structmsgbuf*,structibuf*);structibuf*ibuf_open(size_tlen){structi
buf*buf;if((buf=calloc(1,sizeof(structibuf)))==NULL)return(NULL);if((buf->buf=ma
lloc(len))==NULL){free(buf);return(NULL);}buf->size=buf->max=len;buf->fd=-1;retu
rn(buf);}structibuf*ibuf_dynamic(size_tlen,size_tmax){structibuf*buf;if(max<len)
return(NULL);if((buf=ibuf_open(len))==NULL)return(NULL);if(max>0)buf->max=max;re
turn(buf);}intibuf_realloc(structibuf*buf,size_tlen){uint8_t*b;/*onstaticbuffers
maxiseqsizeandsothefollowingfails*/if(buf->wpos+len>buf->max){errno=ERANGE;retur
n(-1);}b=realloc(buf->buf,buf->wpos+len);if(b==NULL)return(-1);buf->buf=b;buf->s
ize=buf->wpos+len;return(0);}intibuf_add(structibuf*buf,constvoid*data,size_tlen
){if(buf->wpos+len>buf->size)if(ibuf_realloc(buf,len)==-1)return(-1);memcpy(buf-
>buf+buf->wpos,data,len);buf->wpos+=len;return(0);}void*ibuf_reserve(structibuf*
buf,size_tlen){void*b;if(buf->wpos+len>buf->size)if(ibuf_realloc(buf,len)==-1)re
turn(NULL);b=buf->buf+buf->wpos;buf->wpos+=len;return(b);}void*ibuf_seek(structi
buf*buf,size_tpos,size_tlen){/*onlyallowedtoseekinalreadywrittenparts*/if(pos+le
n>buf->wpos)return(NULL);return(buf->buf+pos);}size_tibuf_size(structibuf*buf){r
eturn(buf->wpos);}size_tibuf_left(structibuf*buf){return(buf->max-buf->wpos);}vo
idibuf_close(structmsgbuf*msgbuf,structibuf*buf){ibuf_enqueue(msgbuf,buf);}intib
uf_write(structmsgbuf*msgbuf){structioveciov[IOV_MAX];structibuf*buf;unsignedint
i=0;ssize_tn;memset(&iov,0,sizeof(iov));TAILQ_FOREACH(buf,&msgbuf->bufs,entry){i
f(i>=IOV_MAX)break;iov[i].iov_base=buf->buf+buf->rpos;iov[i].iov_len=buf->wpos-b
uf->rpos;i++;}again:if((n=writev(msgbuf->fd,iov,i))==-1){if(errno==EINTR)gotoaga
in;if(errno==ENOBUFS)errno=EAGAIN;return(-1);}if(n==0){/*connectionclosed*/errno
=0;return(0);}msgbuf_drain(msgbuf,n);return(1);}voidibuf_free(structibuf*buf){if
(buf==NULL)return;free(buf->buf);free(buf);}voidmsgbuf_init(structmsgbuf*msgbuf)
{msgbuf->queued=0;msgbuf->fd=-1;TAILQ_INIT(&msgbuf->bufs);}voidmsgbuf_drain(stru
ctmsgbuf*msgbuf,size_tn){structibuf*buf,*next;for(buf=TAILQ_FIRST(&msgbuf->bufs)
;buf!=NULL&&n>0;buf=next){next=TAILQ_NEXT(buf,entry);if(buf->rpos+n>=buf->wpos){
n-=buf->wpos-buf->rpos;ibuf_dequeue(msgbuf,buf);}else{buf->rpos+=n;n=0;}}}voidms
gbuf_clear(structmsgbuf*msgbuf){structibuf*buf;while((buf=TAILQ_FIRST(&msgbuf->b
ufs))!=NULL)ibuf_dequeue(msgbuf,buf);}intmsgbuf_write(structmsgbuf*msgbuf){struc
tioveciov[IOV_MAX];structibuf*buf;unsignedinti=0;ssize_tn;structmsghdrmsg;struct
cmsghdr*cmsg;union{structcmsghdrhdr;charbuf[CMSG_SPACE(sizeof(int))];}cmsgbuf;me
mset(&iov,0,sizeof(iov));memset(&msg,0,sizeof(msg));memset(&cmsgbuf,0,sizeof(cms
gbuf));TAILQ_FOREACH(buf,&msgbuf->bufs,entry){if(i>=IOV_MAX)break;iov[i].iov_bas
e=buf->buf+buf->rpos;iov[i].iov_len=buf->wpos-buf->rpos;i++;if(buf->fd!=-1)break
;}msg.msg_iov=iov;msg.msg_iovlen=i;if(buf!=NULL&&buf->fd!=-1){msg.msg_control=(c
addr_t)&cmsgbuf.buf;msg.msg_controllen=sizeof(cmsgbuf.buf);cmsg=CMSG_FIRSTHDR(&m
sg);cmsg->cmsg_len=CMSG_LEN(sizeof(int));cmsg->cmsg_level=SOL_SOCKET;cmsg->cmsg_
type=SCM_RIGHTS;memcpy(CMSG_DATA(cmsg),&buf->fd,sizeof(int));}again:if((n=sendms
g(msgbuf->fd,&msg,0))==-1){if(errno==EINTR)gotoagain;if(errno==ENOBUFS)errno=EAG
AIN;return(-1);}if(n==0){/*connectionclosed*/errno=0;return(0);}/**assumption:fd
gotsentifsendmsgsentanything*thisworksbecausefdsarepassedoneatatime*/if(buf!=NUL
L&&buf->fd!=-1){close(buf->fd);buf->fd=-1;}msgbuf_drain(msgbuf,n);return(1);}voi
dibuf_enqueue(structmsgbuf*msgbuf,structibuf*buf){TAILQ_INSERT_TAIL(&msgbuf->buf
s,buf,entry);msgbuf->queued++;}voidibuf_dequeue(structmsgbuf*msgbuf,structibuf*b
uf){TAILQ_REMOVE(&msgbuf->bufs,buf,entry);if(buf->fd!=-1)close(buf->fd);msgbuf->
queued--;ibuf_free(buf);}