/*SNMPsupport*Copyright(C)1999KunihiroIshiguro<kunihiro@zebra.org>**Thisfileispa
rtofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underth
etermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;either
version2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatit
willbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABIL
ITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.*
*YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;see
thefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFl
oor,Boston,MA02110-1301USA*/#include<zebra.h>#ifdefSNMP_SMUX#include<net-snmp/ne
t-snmp-config.h>#include<net-snmp/net-snmp-includes.h>#include"log.h"#include"th
read.h"#include"linklist.h"#include"command.h"#include<lib/version.h>#include"me
mory.h"#include"sockunion.h"#include"smux.h"#defineSMUX_PORT_DEFAULT199#defineSM
UXMAXPKTSIZE1500#defineSMUXMAXSTRLEN256#defineSMUX_OPEN(ASN_APPLICATION|ASN_CONS
TRUCTOR|0)#defineSMUX_CLOSE(ASN_APPLICATION|ASN_PRIMITIVE|1)#defineSMUX_RREQ(ASN
_APPLICATION|ASN_CONSTRUCTOR|2)#defineSMUX_RRSP(ASN_APPLICATION|ASN_PRIMITIVE|3)
#defineSMUX_SOUT(ASN_APPLICATION|ASN_PRIMITIVE|4)#defineSMUX_GET(ASN_CONTEXT|ASN
_CONSTRUCTOR|0)#defineSMUX_GETNEXT(ASN_CONTEXT|ASN_CONSTRUCTOR|1)#defineSMUX_GET
RSP(ASN_CONTEXT|ASN_CONSTRUCTOR|2)#defineSMUX_SET(ASN_CONTEXT|ASN_CONSTRUCTOR|3)
#defineSMUX_TRAP(ASN_CONTEXT|ASN_CONSTRUCTOR|4)#defineSMUX_MAX_FAILURE3/*SNMPtre
e.*/structsubtree{/*Tree'soid.*/oidname[MAX_OID_LEN];uint8_tname_len;/*Listofthe
variables.*/structvariable*variables;/*Lengthofthevariableslist.*/intvariables_n
um;/*Widthofthevariableslist.*/intvariables_width;/*Registeredflag.*/intregister
ed;};#definemin(A,B)((A)<(B)?(A):(B))enumsmux_event{SMUX_SCHEDULE,SMUX_CONNECT,S
MUX_READ};voidsmux_event(enumsmux_event,int);/*SMUXsocket.*/intsmux_sock=-1;/*SM
UXsubtreelist.*/structlist*treelist;/*SMUXoid.*/oid*smux_oid=NULL;size_tsmux_oid
_len;/*SMUXpassword.*/char*smux_passwd=NULL;/*SMUXreadthreads.*/structthread*smu
x_read_thread;/*SMUXconnectthrads.*/structthread*smux_connect_thread;/*SMUXdebug
flag.*/intdebug_smux=0;/*SMUXfailurecount.*/intfail=0;/*SMUXnode.*/staticstructc
md_nodesmux_node={SMUX_NODE,""/*SMUXhasnointerface.*/};/*threadmaster*/staticstr
uctthread_master*smux_master;staticintoid_compare_part(oid*o1,into1_len,oid*o2,i
nto2_len){inti;for(i=0;i<min(o1_len,o2_len);i++){if(o1[i]<o2[i])return-1;elseif(
o1[i]>o2[i])return1;}if(o1_len<o2_len)return-1;return0;}staticvoidsmux_oid_dump(
constchar*prefix,constoid*oid,size_toid_len){unsignedinti;intfirst=1;charbuf[MAX
_OID_LEN*3];buf[0]='\0';for(i=0;i<oid_len;i++){sprintf(buf+strlen(buf),"%s%d",fi
rst?"":".",(int)oid[i]);first=0;}zlog_debug("%s:%s",prefix,buf);}staticintsmux_s
ocket(void){intret;structaddrinfohints,*res0,*res;intgai;intsock=0;memset(&hints
,0,sizeof(hints));hints.ai_family=PF_UNSPEC;hints.ai_socktype=SOCK_STREAM;gai=ge
taddrinfo(NULL,"smux",&hints,&res0);if(gai==EAI_SERVICE){charservbuf[NI_MAXSERV]
;sprintf(servbuf,"%d",SMUX_PORT_DEFAULT);servbuf[sizeof(servbuf)-1]='\0';gai=get
addrinfo(NULL,servbuf,&hints,&res0);}if(gai){zlog_warn("Cannotlocateloopbackserv
icesmux");return-1;}for(res=res0;res;res=res->ai_next){if(res->ai_family!=AF_INE
T&&res->ai_family!=AF_INET6)continue;sock=socket(res->ai_family,res->ai_socktype
,res->ai_protocol);if(sock<0)continue;sockopt_reuseaddr(sock);sockopt_reuseport(
sock);ret=connect(sock,res->ai_addr,res->ai_addrlen);if(ret<0){close(sock);sock=
-1;continue;}break;}freeaddrinfo(res0);if(sock<0)zlog_warn("Can'tconnecttoSNMPag
entwithSMUX");returnsock;}staticvoidsmux_getresp_send(oidobjid[],size_tobjid_len
,longreqid,longerrstat,longerrindex,uint8_tval_type,void*arg,size_targ_len){uint
8_tbuf[BUFSIZ];uint8_t*ptr,*h1,*h1e,*h2,*h2e;size_tlen,length;ptr=buf;len=BUFSIZ
;length=len;if(debug_smux){zlog_debug("SMUXGETRSPsend");zlog_debug("SMUXGETRSPre
qid:%ld",reqid);}h1=ptr;/*Placeholderh1forcompletesequence*/ptr=asn_build_sequen
ce(ptr,&len,(uint8_t)SMUX_GETRSP,0);h1e=ptr;ptr=asn_build_int(ptr,&len,(uint8_t)
(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),&reqid,sizeof(reqid));if(debug_smux)zl
og_debug("SMUXGETRSPerrstat:%ld",errstat);ptr=asn_build_int(ptr,&len,(uint8_t)(A
SN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),&errstat,sizeof(errstat));if(debug_smux)
zlog_debug("SMUXGETRSPerrindex:%ld",errindex);ptr=asn_build_int(ptr,&len,(uint8_
t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),&errindex,sizeof(errindex));h2=ptr;/
*Placeholderh2foronevariable*/ptr=asn_build_sequence(ptr,&len,(uint8_t)(ASN_SEQU
ENCE|ASN_CONSTRUCTOR),0);h2e=ptr;ptr=snmp_build_var_op(ptr,objid,&objid_len,val_
type,arg_len,arg,&len);/*Nowvariablesizeisknown,fillinsize*/asn_build_sequence(h
2,&length,(uint8_t)(ASN_SEQUENCE|ASN_CONSTRUCTOR),ptr-h2e);/*Fillinsizeofwholese
quence*/asn_build_sequence(h1,&length,(uint8_t)SMUX_GETRSP,ptr-h1e);if(debug_smu
x)zlog_debug("SMUXgetrespsend:%td",(ptr-buf));send(smux_sock,buf,(ptr-buf),0);}s
taticuint8_t*smux_var(uint8_t*ptr,size_tlen,oidobjid[],size_t*objid_len,size_t*v
ar_val_len,uint8_t*var_val_type,void**var_value){uint8_ttype;uint8_tval_type;siz
e_tval_len;uint8_t*val;if(debug_smux)zlog_debug("SMUXvarparse:len%zd",len);/*Par
seheader.*/ptr=asn_parse_header(ptr,&len,&type);if(debug_smux){zlog_debug("SMUXv
arparse:type%dlen%zd",type,len);zlog_debug("SMUXvarparse:typemustbe%d",(ASN_SEQU
ENCE|ASN_CONSTRUCTOR));}/*Parsevaroption.*/*objid_len=MAX_OID_LEN;ptr=snmp_parse
_var_op(ptr,objid,objid_len,&val_type,&val_len,&val,&len);if(var_val_len)*var_va
l_len=val_len;if(var_value)*var_value=(void*)val;if(var_val_type)*var_val_type=v
al_type;/*Requestedobjectidlengthisobjid_len.*/if(debug_smux)smux_oid_dump("Requ
estOID",objid,*objid_len);if(debug_smux)zlog_debug("SMUXval_type:%d",val_type);/
*Checkrequestvaluetype.*/if(debug_smux)switch(val_type){caseASN_NULL:/*IncaseofS
MUX_GETorSMUX_GET_NEXTval_typeissettoASN_NULL.*/zlog_debug("ASN_NULL");break;cas
eASN_INTEGER:zlog_debug("ASN_INTEGER");break;caseASN_COUNTER:caseASN_GAUGE:caseA
SN_TIMETICKS:caseASN_UINTEGER:zlog_debug("ASN_COUNTER");break;caseASN_COUNTER64:
zlog_debug("ASN_COUNTER64");break;caseASN_IPADDRESS:zlog_debug("ASN_IPADDRESS");
break;caseASN_OCTET_STR:zlog_debug("ASN_OCTET_STR");break;caseASN_OPAQUE:caseASN
_NSAP:caseASN_OBJECT_ID:zlog_debug("ASN_OPAQUE");break;caseSNMP_NOSUCHOBJECT:zlo
g_debug("SNMP_NOSUCHOBJECT");break;caseSNMP_NOSUCHINSTANCE:zlog_debug("SNMP_NOSU
CHINSTANCE");break;caseSNMP_ENDOFMIBVIEW:zlog_debug("SNMP_ENDOFMIBVIEW");break;c
aseASN_BIT_STR:zlog_debug("ASN_BIT_STR");break;default:zlog_debug("Unknowntype")
;break;}returnptr;}/*NOTE:all3functions(smux_set,smux_get&smux_getnext)arebasedo
nucd-snmpsmuxandassuchsuppose,thatthepeerreceivesinthemessageonlyonevariable.For
tunately,IBMseemstodothesameinAIX.*/staticintsmux_set(oid*reqid,size_t*reqid_len
,uint8_tval_type,void*val,size_tval_len,intaction){intj;structsubtree*subtree;st
ructvariable*v;intsubresult;oid*suffix;size_tsuffix_len;intresult;uint8_t*statP=
NULL;WriteMethod*write_method=NULL;structlistnode*node,*nnode;/*Check*/for(ALL_L
IST_ELEMENTS(treelist,node,nnode,subtree)){subresult=oid_compare_part(reqid,*req
id_len,subtree->name,subtree->name_len);/*Subtreematched.*/if(subresult==0){/*Pr
eparesuffix.*/suffix=reqid+subtree->name_len;suffix_len=*reqid_len-subtree->name
_len;result=subresult;/*Checkvariables.*/for(j=0;j<subtree->variables_num;j++){v
=&subtree->variables[j];/*Alwayschecksuffix*/result=oid_compare_part(suffix,suff
ix_len,v->name,v->namelen);/*Thisisexactmatchsoresultmustbezero.*/if(result==0){
if(debug_smux)zlog_debug("SMUXfunctioncallindexis%d",v->magic);statP=(*v->findVa
r)(v,suffix,&suffix_len,1,&val_len,&write_method);if(write_method){return(*write
_method)(action,val,val_type,val_len,statP,suffix,suffix_len);}else{returnSNMP_E
RR_READONLY;}}/*Ifaboveexecutionisfailedoroidissmall(sothereisnofurthermatch).*/
if(result<0)returnSNMP_ERR_NOSUCHNAME;}}}returnSNMP_ERR_NOSUCHNAME;}staticintsmu
x_get(oid*reqid,size_t*reqid_len,intexact,uint8_t*val_type,void**val,size_t*val_
len){intj;structsubtree*subtree;structvariable*v;intsubresult;oid*suffix;size_ts
uffix_len;intresult;WriteMethod*write_method=NULL;structlistnode*node,*nnode;/*C
heck*/for(ALL_LIST_ELEMENTS(treelist,node,nnode,subtree)){subresult=oid_compare_
part(reqid,*reqid_len,subtree->name,subtree->name_len);/*Subtreematched.*/if(sub
result==0){/*Preparesuffix.*/suffix=reqid+subtree->name_len;suffix_len=*reqid_le
n-subtree->name_len;result=subresult;/*Checkvariables.*/for(j=0;j<subtree->varia
bles_num;j++){v=&subtree->variables[j];/*Alwayschecksuffix*/result=oid_compare_p
art(suffix,suffix_len,v->name,v->namelen);/*Thisisexactmatchsoresultmustbezero.*
/if(result==0){if(debug_smux)zlog_debug("SMUXfunctioncallindexis%d",v->magic);*v
al=(*v->findVar)(v,suffix,&suffix_len,exact,val_len,&write_method);/*Thereisnoin
stance.*/if(*val==NULL)returnSNMP_NOSUCHINSTANCE;/*Callissuceed.*/*val_type=v->t
ype;return0;}/*Ifaboveexecutionisfailedoroidissmall(sothereisnofurthermatch).*/i
f(result<0)returnSNMP_ERR_NOSUCHNAME;}}}returnSNMP_ERR_NOSUCHNAME;}staticintsmux
_getnext(oid*reqid,size_t*reqid_len,intexact,uint8_t*val_type,void**val,size_t*v
al_len){intj;oidsave[MAX_OID_LEN];intsavelen=0;structsubtree*subtree;structvaria
ble*v;intsubresult;oid*suffix;size_tsuffix_len;intresult;WriteMethod*write_metho
d=NULL;structlistnode*node,*nnode;/*Saveincomingrequest.*/oid_copy(save,reqid,*r
eqid_len);savelen=*reqid_len;/*Check*/for(ALL_LIST_ELEMENTS(treelist,node,nnode,
subtree)){subresult=oid_compare_part(reqid,*reqid_len,subtree->name,subtree->nam
e_len);/*Ifrequestisinthetree.Theagenthastomakesureweonlyreceiverequestswehavere
gisteredfor.*//*Unfortunately,that'snottrue.Infact,aSMUXsubagenthastobehaveasifi
tmanagesthewholeSNMPMIBtreeitself.It'sthedutyofthemasteragenttocollectthebestans
werandreturnittothemanager.SeeRFC1227chapter3.1.6fortheglorydetails:-).ucd-snmpr
eallybehavesbadhereasitactuallymightaskmultipletimesforthesameGETNEXTrequestasit
throwsawaytheanswerwhenitexpectsitinadifferentsubtreeandmightcomebacklaterwithth
everysamerequest.--jochen*/if(subresult<=0){/*Preparesuffix.*/suffix=reqid+subtr
ee->name_len;suffix_len=*reqid_len-subtree->name_len;if(subresult<0){oid_copy(re
qid,subtree->name,subtree->name_len);*reqid_len=subtree->name_len;}for(j=0;j<sub
tree->variables_num;j++){result=subresult;v=&subtree->variables[j];/*Nextthenche
ckresult>=0.*/if(result==0)result=oid_compare_part(suffix,suffix_len,v->name,v->
namelen);if(result<=0){if(debug_smux)zlog_debug("SMUXfunctioncallindexis%d",v->m
agic);if(result<0){oid_copy(suffix,v->name,v->namelen);suffix_len=v->namelen;}*v
al=(*v->findVar)(v,suffix,&suffix_len,exact,val_len,&write_method);*reqid_len=su
ffix_len+subtree->name_len;if(*val){*val_type=v->type;return0;}}}}}memcpy(reqid,
save,savelen*sizeof(oid));*reqid_len=savelen;returnSNMP_ERR_NOSUCHNAME;}/*GETmes
sageheader.*/staticuint8_t*smux_parse_get_header(uint8_t*ptr,size_t*len,long*req
id){uint8_ttype;longerrstat;longerrindex;/*RequestID.*/ptr=asn_parse_int(ptr,len
,&type,reqid,sizeof(*reqid));if(debug_smux)zlog_debug("SMUXGETreqid:%dlen:%d",(i
nt)*reqid,(int)*len);/*Errorstatus.*/ptr=asn_parse_int(ptr,len,&type,&errstat,si
zeof(errstat));if(debug_smux)zlog_debug("SMUXGETerrstat%ldlen:%zd",errstat,*len)
;/*Errorindex.*/ptr=asn_parse_int(ptr,len,&type,&errindex,sizeof(errindex));if(d
ebug_smux)zlog_debug("SMUXGETerrindex%ldlen:%zd",errindex,*len);returnptr;}stati
cvoidsmux_parse_set(uint8_t*ptr,size_tlen,intaction){longreqid;oidoid[MAX_OID_LE
N];size_toid_len;uint8_tval_type;void*val;size_tval_len;intret;if(debug_smux)zlo
g_debug("SMUXSET(%s)messageparse:len%zd",(RESERVE1==action)?"RESERVE1":((FREE==a
ction)?"FREE":"COMMIT"),len);/*ParseSETmessageheader.*/ptr=smux_parse_get_header
(ptr,&len,&reqid);/*ParseSETmessageobjectID.*/ptr=smux_var(ptr,len,oid,&oid_len,
&val_len,&val_type,&val);ret=smux_set(oid,&oid_len,val_type,val,val_len,action);
if(debug_smux)zlog_debug("SMUXSETret%d",ret);/*Returnresult.*/if(RESERVE1==actio
n)smux_getresp_send(oid,oid_len,reqid,ret,3,ASN_NULL,NULL,0);}staticvoidsmux_par
se_get(uint8_t*ptr,size_tlen,intexact){longreqid;oidoid[MAX_OID_LEN];size_toid_l
en;uint8_tval_type;void*val;size_tval_len;intret;if(debug_smux)zlog_debug("SMUXG
ETmessageparse:len%zd",len);/*ParseGETmessageheader.*/ptr=smux_parse_get_header(
ptr,&len,&reqid);/*ParseGETmessageobjectID.Weneedn'tthevaluecome*/ptr=smux_var(p
tr,len,oid,&oid_len,NULL,NULL,NULL);/*Traditionalgetstatptr.*/if(exact)ret=smux_
get(oid,&oid_len,exact,&val_type,&val,&val_len);elseret=smux_getnext(oid,&oid_le
n,exact,&val_type,&val,&val_len);/*Returnresult.*/if(ret==0)smux_getresp_send(oi
d,oid_len,reqid,0,0,val_type,val,val_len);elsesmux_getresp_send(oid,oid_len,reqi
d,ret,3,ASN_NULL,NULL,0);}/*ParseSMUX_CLOSEmessage.*/staticvoidsmux_parse_close(
uint8_t*ptr,intlen){longreason=0;while(len--){reason=(reason<<8)|(long)*ptr;ptr+
+;}zlog_info("SMUX_CLOSEwithreason:%ld",reason);}/*SMUX_RRSPmessage.*/staticvoid
smux_parse_rrsp(uint8_t*ptr,size_tlen){uint8_tval;longerrstat;ptr=asn_parse_int(
ptr,&len,&val,&errstat,sizeof(errstat));if(debug_smux)zlog_debug("SMUX_RRSPvalue
:%derrstat:%ld",val,errstat);}/*ParseSMUXmessage.*/staticintsmux_parse(uint8_t*p
tr,size_tlen){/*Thisbufferwe'lluseforSOUTmessage.Wecouldallocateitwithmallocands
aveonlystaticpointer/lenght,butIMHOstaticbufferisafastersolusion.*/staticuint8_t
sout_save_buff[SMUXMAXPKTSIZE];staticintsout_save_len=0;intlen_income=len;/*seen
otebelow:YYY*/uint8_ttype;uint8_trollback;rollback=ptr[2];/*importantonlyforSMUX
_SOUT*/process_rest:/*seenotebelow:YYY*//*ParseSMUXmessagetypeandsubsequentlengt
h.*/ptr=asn_parse_header(ptr,&len,&type);if(debug_smux)zlog_debug("SMUXmessagere
ceivedtype:%drestlen:%zd",type,len);switch(type){caseSMUX_OPEN:/*Openmustbenotse
ndfromSNMPagent.*/zlog_warn("SMUX_OPENreceived:resettingconnection.");return-1;b
reak;caseSMUX_RREQ:/*SMUX_RREQmessageisinvalidforus.*/zlog_warn("SMUX_RREQreceiv
ed:resettingconnection.");return-1;break;caseSMUX_SOUT:/*SMUX_SOUTmessageisnowva
liedforus.*/if(debug_smux)zlog_debug("SMUX_SOUT(%s)",rollback?"rollback":"commit
");if(sout_save_len>0){smux_parse_set(sout_save_buff,sout_save_len,rollback?FREE
:COMMIT);sout_save_len=0;}elsezlog_warn("SMUX_SOUTsout_save_len=%d-invalid",(int
)sout_save_len);if(len_income>3){/*YYY:thisstrangecodehastosolvethe"slowpeer"pro
blem:WhenagentsendsSMUX_SOUTmessageitdoesn'twaitanyresponceandmaysendsomenextmes
sagetosubagent.Thenthepeerin'smux_read()'willrecievefromsocketthe'concatenated'b
uffer,contaningbothSMUX_SOUTmessageandthenextone(SMUX_GET/SMUX_GETNEXT/SMUX_GET)
.Soweshouldcheck:ifthebufferislongerthan3(lengthofSMUX_SOUT),wemustprocesstheres
tofit.Thiseffectmaybeobservedif'debug_smux'issetto'1'*/ptr++;len=len_income-3;go
toprocess_rest;}break;caseSMUX_GETRSP:/*SMUX_GETRSPmessageisinvalidforus.*/zlog_
warn("SMUX_GETRSPreceived:resettingconnection.");return-1;break;caseSMUX_CLOSE:/
*CloseSMUXconnection.*/if(debug_smux)zlog_debug("SMUX_CLOSE");smux_parse_close(p
tr,len);return-1;break;caseSMUX_RRSP:/*Thisisresponseforregistermessage.*/if(deb
ug_smux)zlog_debug("SMUX_RRSP");smux_parse_rrsp(ptr,len);break;caseSMUX_GET:/*Ex
actrequestforobjectid.*/if(debug_smux)zlog_debug("SMUX_GET");smux_parse_get(ptr,
len,1);break;caseSMUX_GETNEXT:/*Nextrequestforobjectid.*/if(debug_smux)zlog_debu
g("SMUX_GETNEXT");smux_parse_get(ptr,len,0);break;caseSMUX_SET:/*SMUX_SETissuppo
rtedwithsomelimitations.*/if(debug_smux)zlog_debug("SMUX_SET");/*savethedataforf
utureSMUX_SOUT*/memcpy(sout_save_buff,ptr,len);sout_save_len=len;smux_parse_set(
ptr,len,RESERVE1);break;default:zlog_info("Unknowntype:%d",type);break;}return0;
}/*SMUXmessagereadfunction.*/staticintsmux_read(structthread*t){intsock;intlen;u
int8_tbuf[SMUXMAXPKTSIZE];intret;/*Clearthread.*/sock=THREAD_FD(t);smux_read_thr
ead=NULL;if(debug_smux)zlog_debug("SMUXreadstart");/*ReadmessagefromSMUXsocket.*
/len=recv(sock,buf,SMUXMAXPKTSIZE,0);if(len<0){zlog_warn("Can'treadallSMUXpacket
:%s",safe_strerror(errno));close(sock);smux_sock=-1;smux_event(SMUX_CONNECT,0);r
eturn-1;}if(len==0){zlog_warn("SMUXconnectionclosed:%d",sock);close(sock);smux_s
ock=-1;smux_event(SMUX_CONNECT,0);return-1;}if(debug_smux)zlog_debug("SMUXreadle
n:%d",len);/*Parsethemessage.*/ret=smux_parse(buf,len);if(ret<0){close(sock);smu
x_sock=-1;smux_event(SMUX_CONNECT,0);return-1;}/*Regiserreadthread.*/smux_event(
SMUX_READ,sock);return0;}staticintsmux_open(intsock){uint8_tbuf[BUFSIZ];uint8_t*
ptr;size_tlen;longversion;constcharprogname[]=FRR_SMUX_NAME"-"FRR_VERSION;if(deb
ug_smux){smux_oid_dump("SMUXopenoid",smux_oid,smux_oid_len);zlog_debug("SMUXopen
progname:%s",progname);zlog_debug("SMUXopenpassword:%s",smux_passwd);}ptr=buf;le
n=BUFSIZ;/*SMUXHeader.Asplaceholder.*/ptr=asn_build_header(ptr,&len,(uint8_t)SMU
X_OPEN,0);/*SMUXOpen.*/version=0;ptr=asn_build_int(ptr,&len,(uint8_t)(ASN_UNIVER
SAL|ASN_PRIMITIVE|ASN_INTEGER),&version,sizeof(version));/*SMUXconnectionoid.*/p
tr=asn_build_objid(ptr,&len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_OBJECT_ID)
,smux_oid,smux_oid_len);/*SMUXconnectiondescription.*/ptr=asn_build_string(ptr,&
len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_OCTET_STR),(constuint8_t*)progname
,strlen(progname));/*SMUXconnectionpassword.*/ptr=asn_build_string(ptr,&len,(uin
t8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_OCTET_STR),(uint8_t*)smux_passwd,strlen(sm
ux_passwd));/*FillinrealSMUXheader.WeexcludeASNheadersize(2).*/len=BUFSIZ;asn_bu
ild_header(buf,&len,(uint8_t)SMUX_OPEN,(ptr-buf)-2);returnsend(sock,buf,(ptr-buf
),0);}/*`ename`isignored.InsteadofusingtheprovidedenterpriseOID,theSMUXpeerisuse
d.ThiskeepcompatibilitywiththepreviousversionsofQuagga.Allotherfieldsareusedasth
eyareintended.*/intsmux_trap(structvariable*vp,size_tvp_len,constoid*ename,size_
tenamelen,constoid*name,size_tnamelen,constoid*iname,size_tinamelen,conststructt
rap_object*trapobj,size_ttrapobjlen,uint8_tsptrap){unsignedinti;uint8_tbuf[BUFSI
Z];uint8_t*ptr;size_tlen,length;structin_addraddr;unsignedlongval;uint8_t*h1,*h1
e;ptr=buf;len=BUFSIZ;length=len;/*WhenSMUXconnectionisnotestablished.*/if(smux_s
ock<0)return0;/*SMUXheader.*/ptr=asn_build_header(ptr,&len,(uint8_t)SMUX_TRAP,0)
;/*Subagententerpriseoid.*/ptr=asn_build_objid(ptr,&len,(uint8_t)(ASN_UNIVERSAL|
ASN_PRIMITIVE|ASN_OBJECT_ID),smux_oid,smux_oid_len);/*IPaddress.*/addr.s_addr=0;
ptr=asn_build_string(ptr,&len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_IPADDRES
S),(uint8_t*)&addr,sizeof(addr));/*Generictrapinteger.*/val=SNMP_TRAP_ENTERPRISE
SPECIFIC;ptr=asn_build_int(ptr,&len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_IN
TEGER),(long*)&val,sizeof(val));/*Specifictrapinteger.*/val=sptrap;ptr=asn_build
_int(ptr,&len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),(long*)&val,siz
eof(val));/*Timetickstimestamp.*/val=0;ptr=asn_build_unsigned_int(ptr,&len,(uint
8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_TIMETICKS),&val,sizeof(val));/*Variables.*/
h1=ptr;ptr=asn_build_sequence(ptr,&len,(uint8_t)(ASN_SEQUENCE|ASN_CONSTRUCTOR),0
);/*Iterationforeachobjects.*/h1e=ptr;for(i=0;i<trapobjlen;i++){intret;oidoid[MA
X_OID_LEN];size_toid_len;void*val;size_tval_len;uint8_tval_type;/*MakeOID.*/if(t
rapobj[i].namelen>0){oid_copy(oid,name,namelen);oid_copy(oid+namelen,trapobj[i].
name,trapobj[i].namelen);oid_copy(oid+namelen+trapobj[i].namelen,iname,inamelen)
;oid_len=namelen+trapobj[i].namelen+inamelen;}else{oid_copy(oid,name,namelen);oi
d_copy(oid+namelen,trapobj[i].name,trapobj[i].namelen*(-1));oid_len=namelen+trap
obj[i].namelen*(-1);}if(debug_smux){smux_oid_dump("Trap",name,namelen);if(trapob
j[i].namelen<0)smux_oid_dump("Trap",trapobj[i].name,(-1)*(trapobj[i].namelen));e
lse{smux_oid_dump("Trap",trapobj[i].name,(trapobj[i].namelen));smux_oid_dump("Tr
ap",iname,inamelen);}smux_oid_dump("Trap",oid,oid_len);zlog_info("BUFSIZ:%d//oid
_len:%lu",BUFSIZ,(unsignedlong)oid_len);}ret=smux_get(oid,&oid_len,1,&val_type,&
val,&val_len);if(debug_smux)zlog_debug("smux_getresult%d",ret);if(ret==0)ptr=snm
p_build_var_op(ptr,oid,&oid_len,val_type,val_len,val,&len);}/*Nowvariablesizeisk
nown,fillinsize*/asn_build_sequence(h1,&length,(uint8_t)(ASN_SEQUENCE|ASN_CONSTR
UCTOR),ptr-h1e);/*Fillinsizeofwholesequence*/len=BUFSIZ;asn_build_header(buf,&le
n,(uint8_t)SMUX_TRAP,(ptr-buf)-2);returnsend(smux_sock,buf,(ptr-buf),0);}statici
ntsmux_register(intsock){uint8_tbuf[BUFSIZ];uint8_t*ptr;intret;size_tlen;longpri
ority;longoperation;structsubtree*subtree;structlistnode*node,*nnode;ret=0;for(A
LL_LIST_ELEMENTS(treelist,node,nnode,subtree)){ptr=buf;len=BUFSIZ;/*SMUXRReqHead
er.*/ptr=asn_build_header(ptr,&len,(uint8_t)SMUX_RREQ,0);/*RegisterMIBtree.*/ptr
=asn_build_objid(ptr,&len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_OBJECT_ID),s
ubtree->name,subtree->name_len);/*Priority.*/priority=-1;ptr=asn_build_int(ptr,&
len,(uint8_t)(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),&priority,sizeof(priority
));/*Operation.*/operation=2;/*RegisterR/W*/ptr=asn_build_int(ptr,&len,(uint8_t)
(ASN_UNIVERSAL|ASN_PRIMITIVE|ASN_INTEGER),&operation,sizeof(operation));if(debug
_smux){smux_oid_dump("SMUXregisteroid",subtree->name,subtree->name_len);zlog_deb
ug("SMUXregisterpriority:%ld",priority);zlog_debug("SMUXregisteroperation:%ld",o
peration);}len=BUFSIZ;asn_build_header(buf,&len,(uint8_t)SMUX_RREQ,(ptr-buf)-2);
ret=send(sock,buf,(ptr-buf),0);if(ret<0)returnret;}returnret;}/*TrytoconnecttoSN
MPagent.*/staticintsmux_connect(structthread*t){intret;if(debug_smux)zlog_debug(
"SMUXconnecttry%d",fail+1);/*Clearthreadponerofmyself.*/smux_connect_thread=NULL
;/*Makesocket.Trytoconnect.*/smux_sock=smux_socket();if(smux_sock<0){if(++fail<S
MUX_MAX_FAILURE)smux_event(SMUX_CONNECT,0);return0;}/*SendOPENPDU.*/ret=smux_ope
n(smux_sock);if(ret<0){zlog_warn("SMUXopenmessagesendfailed:%s",safe_strerror(er
rno));close(smux_sock);smux_sock=-1;if(++fail<SMUX_MAX_FAILURE)smux_event(SMUX_C
ONNECT,0);return-1;}/*SendanyoutstandingregisterPDUs.*/ret=smux_register(smux_so
ck);if(ret<0){zlog_warn("SMUXregistermessagesendfailed:%s",safe_strerror(errno))
;close(smux_sock);smux_sock=-1;if(++fail<SMUX_MAX_FAILURE)smux_event(SMUX_CONNEC
T,0);return-1;}/*Everythinggoesfine.*/smux_event(SMUX_READ,smux_sock);return0;}/
*ClearallSMUXrelatedresources.*/staticvoidsmux_stop(void){if(smux_read_thread){t
hread_cancel(smux_read_thread);smux_read_thread=NULL;}if(smux_connect_thread){th
read_cancel(smux_connect_thread);smux_connect_thread=NULL;}if(smux_sock>=0){clos
e(smux_sock);smux_sock=-1;}}voidsmux_event(enumsmux_eventevent,intsock){switch(e
vent){caseSMUX_SCHEDULE:smux_connect_thread=NULL;thread_add_event(smux_master,sm
ux_connect,NULL,0,&smux_connect_thread);break;caseSMUX_CONNECT:smux_connect_thre
ad=NULL;thread_add_timer(smux_master,smux_connect,NULL,10,&smux_connect_thread);
break;caseSMUX_READ:smux_read_thread=NULL;thread_add_read(smux_master,smux_read,
NULL,sock,&smux_read_thread);break;default:break;}}staticintsmux_str2oid(constch
ar*str,oid*oid,size_t*oid_len){intlen;intval;len=0;val=0;*oid_len=0;if(*str=='.'
)str++;if(*str=='\0')return0;while(1){if(!isdigit(*str))return-1;while(isdigit(*
str)){val*=10;val+=(*str-'0');str++;}if(*str=='\0')break;if(*str!='.')return-1;o
id[len++]=val;val=0;str++;}oid[len++]=val;*oid_len=len;return0;}staticoid*smux_o
id_dup(oid*objid,size_tobjid_len){oid*new;new=XMALLOC(MTYPE_TMP,sizeof(oid)*obji
d_len);oid_copy(new,objid,objid_len);returnnew;}staticintsmux_peer_oid(structvty
*vty,constchar*oid_str,constchar*passwd_str){intret;oidoid[MAX_OID_LEN];size_toi
d_len;ret=smux_str2oid(oid_str,oid,&oid_len);if(ret!=0){vty_out(vty,"objectIDmal
formed\n");returnCMD_WARNING_CONFIG_FAILED;}if(smux_oid){free(smux_oid);smux_oid
=NULL;}/*careful,smux_passwdmightpointtostringconstant*/if(smux_passwd){free(smu
x_passwd);smux_passwd=NULL;}smux_oid=smux_oid_dup(oid,oid_len);smux_oid_len=oid_
len;if(passwd_str)smux_passwd=strdup(passwd_str);elsesmux_passwd=strdup("");retu
rn0;}staticintsmux_peer_default(void){if(smux_oid){free(smux_oid);smux_oid=NULL;
}/*careful,smux_passwdmightbepointingatstringconstant*/if(smux_passwd){free(smux
_passwd);smux_passwd=NULL;}returnCMD_SUCCESS;}DEFUN(smux_peer,smux_peer_cmd,"smu
xpeerOID","SNMPMUXprotocolsettings\n""SNMPMUXpeersettings\n""ObjectIDusedinSMUXp
eering\n"){intidx_oid=2;if(smux_peer_oid(vty,argv[idx_oid]->arg,NULL)==0){smux_s
tart();returnCMD_SUCCESS;}elsereturnCMD_WARNING_CONFIG_FAILED;}DEFUN(smux_peer_p
assword,smux_peer_password_cmd,"smuxpeerOIDPASSWORD","SNMPMUXprotocolsettings\n"
"SNMPMUXpeersettings\n""SMUXpeeringobjectID\n""SMUXpeeringpassword\n"){intidx_oi
d=2;if(smux_peer_oid(vty,argv[idx_oid]->arg,argv[3]->rg)==0){smux_start();return
CMD_SUCCESS;}elsereturnCMD_WARNING_CONFIG_FAILED;}DEFUN(no_smux_peer,no_smux_pee
r_cmd,"nosmuxpeer[OID[PASSWORD]]",NO_STR"SNMPMUXprotocolsettings\n""SNMPMUXpeers
ettings\n""SMUXpeeringobjectID\n""SMUXpeeringpassword\n"){smux_stop();returnsmux
_peer_default();}staticintconfig_write_smux(structvty*vty){intfirst=1;unsignedin
ti;if(smux_oid){vty_out(vty,"smuxpeer");for(i=0;i<smux_oid_len;i++){vty_out(vty,
"%s%d",first?"":".",(int)smux_oid[i]);first=0;}vty_out(vty,"%s\n",smux_passwd);}
return0;}/*Registersubtreetosmuxmastertree.*/voidsmux_register_mib(constchar*des
cr,structvariable*var,size_twidth,intnum,oidname[],size_tnamelen){structsubtree*
tree;tree=(structsubtree*)malloc(sizeof(structsubtree));oid_copy(tree->name,name
,namelen);tree->name_len=namelen;tree->variables=var;tree->variables_num=num;tre
e->variables_width=width;tree->registered=0;listnode_add_sort(treelist,tree);}/*
Comparefunctiontokeeptreelistsorted*/staticintsmux_tree_cmp(structsubtree*tree1,
structsubtree*tree2){returnoid_compare(tree1->name,tree1->name_len,tree2->name,t
ree2->name_len);}/*InitializesomevaluesthenschedulefirstSMUXconnection.*/voidsmu
x_init(structthread_master*tm){assert(tm);/*copycallersthreadmaster*/smux_master
=tm;/*MakeMIBtree.*/treelist=list_new();treelist->cmp=(int(*)(void*,void*))smux_
tree_cmp;/*Installcommands.*/install_node(&smux_node,config_write_smux);install_
element(CONFIG_NODE,&smux_peer_cmd);install_element(CONFIG_NODE,&smux_peer_passw
ord_cmd);install_element(CONFIG_NODE,&no_smux_peer_cmd);install_element(CONFIG_N
ODE,&no_smux_peer_oid_cmd);install_element(CONFIG_NODE,&no_smux_peer_oid_passwor
d_cmd);}voidsmux_start(void){/*Closeanyexistingconnections.*/smux_stop();/*Sched
ulefirstconnection.*/smux_event(SMUX_SCHEDULE,0);}#endif/*SNMP_SMUX*/