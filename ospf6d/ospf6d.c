/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"thread.h"#include"linklist.h"#include"vty.h"#include"command
.h"#include"plist.h"#include"ospf6_proto.h"#include"ospf6_network.h"#include"osp
f6_lsa.h"#include"ospf6_lsdb.h"#include"ospf6_message.h"#include"ospf6_route.h"#
include"ospf6_zebra.h"#include"ospf6_spf.h"#include"ospf6_top.h"#include"ospf6_a
rea.h"#include"ospf6_interface.h"#include"ospf6_neighbor.h"#include"ospf6_intra.
h"#include"ospf6_asbr.h"#include"ospf6_abr.h"#include"ospf6_flood.h"#include"osp
f6d.h"#include"ospf6_bfd.h"structroute_node*route_prev(structroute_node*node){st
ructroute_node*end;structroute_node*prev=NULL;end=node;node=node->parent;if(node
)route_lock_node(node);while(node){prev=node;node=route_next(node);if(node==end)
{route_unlock_node(node);node=NULL;}}route_unlock_node(end);if(prev)route_lock_n
ode(prev);returnprev;}staticstructcmd_nodedebug_node={DEBUG_NODE,"",1/*VTYSH*/};
staticintconfig_write_ospf6_debug(structvty*vty){config_write_ospf6_debug_messag
e(vty);config_write_ospf6_debug_lsa(vty);config_write_ospf6_debug_zebra(vty);con
fig_write_ospf6_debug_interface(vty);config_write_ospf6_debug_neighbor(vty);conf
ig_write_ospf6_debug_spf(vty);config_write_ospf6_debug_route(vty);config_write_o
spf6_debug_brouter(vty);config_write_ospf6_debug_asbr(vty);config_write_ospf6_de
bug_abr(vty);config_write_ospf6_debug_flood(vty);return0;}DEFUN_NOSH(show_debugg
ing_ospf6,show_debugging_ospf6_cmd,"showdebugging[ospf6]",SHOW_STRDEBUG_STROSPF6
_STR){vty_out(vty,"OSPF6debuggingstatus:");config_write_ospf6_debug(vty);returnC
MD_SUCCESS;}#defineAREA_LSDB_TITLE_FORMAT\"\nAreaScopedLinkStateDatabase(Area%s)
\n\n"#defineIF_LSDB_TITLE_FORMAT\"\nI/FScopedLinkStateDatabase(I/F%sinArea%s)\n\
n"#defineAS_LSDB_TITLE_FORMAT"\nASScopedLinkStateDatabase\n\n"staticintparse_sho
w_level(intidx_level,intargc,structcmd_token**argv){intlevel=OSPF6_LSDB_SHOW_LEV
EL_NORMAL;if(argc>idx_level){if(strmatch(argv[idx_level]->text,"detail"))level=O
SPF6_LSDB_SHOW_LEVEL_DETAIL;elseif(strmatch(argv[idx_level]->text,"dump"))level=
OSPF6_LSDB_SHOW_LEVEL_DUMP;elseif(strmatch(argv[idx_level]->text,"internal"))lev
el=OSPF6_LSDB_SHOW_LEVEL_INTERNAL;}returnlevel;}staticuint16_tparse_type_spec(in
tidx_lsa,intargc,structcmd_token**argv){uint16_ttype=0;if(argc>idx_lsa){if(strma
tch(argv[idx_lsa]->text,"router"))type=htons(OSPF6_LSTYPE_ROUTER);elseif(strmatc
h(argv[idx_lsa]->text,"network"))type=htons(OSPF6_LSTYPE_NETWORK);elseif(strmatc
h(argv[idx_lsa]->text,"as-external"))type=htons(OSPF6_LSTYPE_AS_EXTERNAL);elseif
(strmatch(argv[idx_lsa]->text,"intra-prefix"))type=htons(OSPF6_LSTYPE_INTRA_PREF
IX);elseif(strmatch(argv[idx_lsa]->text,"inter-router"))type=htons(OSPF6_LSTYPE_
INTER_ROUTER);elseif(strmatch(argv[idx_lsa]->text,"inter-prefix"))type=htons(OSP
F6_LSTYPE_INTER_PREFIX);elseif(strmatch(argv[idx_lsa]->text,"link"))type=htons(O
SPF6_LSTYPE_LINK);}returntype;}DEFUN(show_ipv6_ospf6_database,show_ipv6_ospf6_da
tabase_cmd,"showipv6ospf6database[<detail|dump|internal>]",SHOW_STRIPV6_STROSPF6
_STR"DisplayLinkstatedatabase\n""DisplaydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'
sinternalinformation\n"){intidx_level=4;intlevel;structlistnode*i,*j;structospf6
*o=ospf6;structospf6_area*oa;structospf6_interface*oi;OSPF6_CMD_CHECK_RUNNING();
level=parse_show_level(idx_level,argc,argv);for(ALL_LIST_ELEMENTS_RO(o->area_lis
t,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,
NULL,NULL,NULL,oa->lsdb);}for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_L
IST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interfac
e->name,oa->name);ospf6_lsdb_show(vty,level,NULL,NULL,NULL,oi->lsdb);}}vty_out(v
ty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,level,NULL,NULL,NULL,o->lsdb);vty_o
ut(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database_type,show_ipv6_os
pf6_database_type_cmd,"showipv6ospf6database<router|network|inter-prefix|inter-r
outer|as-external|group-membership|type-7|link|intra-prefix>[<detail|dump|intern
al>]",SHOW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n"
"DisplayNetworkLSAs\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterL
SAs\n""DisplayAs-ExternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSA
s\n""DisplayLinkLSAs\n""DisplayIntra-Area-PrefixLSAs\n""DisplaydetailsofLSAs\n""
DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_lsa=4;intidx_level=5;intl
evel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_int
erface*oi;uint16_ttype=0;OSPF6_CMD_CHECK_RUNNING();type=parse_type_spec(idx_lsa,
argc,argv);level=parse_show_level(idx_level,argc,argv);switch(OSPF6_LSA_SCOPE(ty
pe)){caseOSPF6_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(v
ty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,&type,NULL,NULL,oa
->lsdb);}break;caseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o->area_list,i
,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORM
AT,oi->interface->name,oa->name);ospf6_lsdb_show(vty,level,&type,NULL,NULL,oi->l
sdb);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_sho
w(vty,level,&type,NULL,NULL,o->lsdb);break;default:assert(0);break;}vty_out(vty,
"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database_id,show_ipv6_ospf6_datab
ase_id_cmd,"showipv6ospf6database<*|linkstate-id>A.B.C.D[<detail|dump|internal>]
",SHOW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""AnyLinkstateType\n""Sear
chbyLinkstateID\n""SpecifyLinkstateIDasIPv4addressnotation\n""DisplaydetailsofLS
As\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_ipv4=5;intidx_level
=6;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;structos
pf6_interface*oi;uint32_tid=0;OSPF6_CMD_CHECK_RUNNING();if(argv[idx_ipv4]->type=
=IPV4_TKN)inet_pton(AF_INET,argv[idx_ipv4]->arg,&id);level=parse_show_level(idx_
level,argc,argv);for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_L
SDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,NULL,&id,NULL,oa->lsdb);}fo
r(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,
j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb
_show(vty,level,NULL,&id,NULL,oi->lsdb);}}vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf
6_lsdb_show(vty,level,NULL,&id,NULL,o->lsdb);vty_out(vty,"\n");returnCMD_SUCCESS
;}DEFUN(show_ipv6_ospf6_database_router,show_ipv6_ospf6_database_router_cmd,"sho
wipv6ospf6database<*|adv-router>*A.B.C.D<detail|dump|internal>",SHOW_STRIPV6_STR
OSPF6_STR"DisplayLinkstatedatabase\n""AnyLinkstateType\n""SearchbyAdvertisingRou
ter\n""AnyLinkstateID\n""SpecifyAdvertisingRouterasIPv4addressnotation\n""Displa
ydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_ipv4=6;
intidx_level=7;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area
*oa;structospf6_interface*oi;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNING();inet
_pton(AF_INET,argv[idx_ipv4]->arg,&adv_router);level=parse_show_level(idx_level,
argc,argv);for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_TI
TLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,NULL,NULL,&adv_router,oa->lsdb);}
for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_lis
t,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_ls
db_show(vty,level,NULL,NULL,&adv_router,oi->lsdb);}}vty_out(vty,AS_LSDB_TITLE_FO
RMAT);ospf6_lsdb_show(vty,level,NULL,NULL,&adv_router,o->lsdb);vty_out(vty,"\n")
;returnCMD_SUCCESS;}DEFUN_HIDDEN(show_ipv6_ospf6_database_aggr_router,show_ipv6_
ospf6_database_aggr_router_cmd,"showipv6ospf6databaseaggradv-routerA.B.C.D",SHOW
_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""AggregatedRouterLSA\n""Searchb
yAdvertisingRouter\n""SpecifyAdvertisingRouterasIPv4addressnotation\n"){intlevel
=OSPF6_LSDB_SHOW_LEVEL_DETAIL;uint16_ttype=htons(OSPF6_LSTYPE_ROUTER);intidx_ipv
4=6;structlistnode*i;structospf6*o=ospf6;structospf6_area*oa;structospf6_lsdb*ls
db;uint32_tadv_router=0;inet_pton(AF_INET,argv[idx_ipv4]->arg,&adv_router);for(A
LL_LIST_ELEMENTS_RO(o->area_list,i,oa)){if(adv_router==o->router_id)lsdb=oa->lsd
b_self;elselsdb=oa->lsdb;if(ospf6_create_single_router_lsa(oa,lsdb,adv_router)==
NULL){vty_out(vty,"AdvrouterisnotfoundinLSDB.");returnCMD_SUCCESS;}ospf6_lsdb_sh
ow(vty,level,&type,NULL,NULL,oa->temp_router_lsa_lsdb);/*Removethetempcache*/osp
f6_remove_temp_router_lsa(oa);}vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_i
pv6_ospf6_database_type_id,show_ipv6_ospf6_database_type_id_cmd,"showipv6ospf6da
tabase<router|network|inter-prefix|inter-router|as-external|group-membership|typ
e-7|link|intra-prefix>linkstate-idA.B.C.D[<detail|dump|internal>]",SHOW_STRIPV6_
STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""DisplayNetworkLSAs
\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""DisplayAs-Ex
ternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""DisplayLinkLSA
s\n""DisplayIntra-Area-PrefixLSAs\n""SearchbyLinkstateID\n""SpecifyLinkstateIDas
IPv4addressnotation\n""DisplaydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'sinternali
nformation\n"){intidx_lsa=4;intidx_ipv4=6;intidx_level=7;intlevel;structlistnode
*i,*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_interface*oi;uint16_tt
ype=0;uint32_tid=0;OSPF6_CMD_CHECK_RUNNING();type=parse_type_spec(idx_lsa,argc,a
rgv);inet_pton(AF_INET,argv[idx_ipv4]->arg,&id);level=parse_show_level(idx_level
,argc,argv);switch(OSPF6_LSA_SCOPE(type)){caseOSPF6_SCOPE_AREA:for(ALL_LIST_ELEM
ENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_l
sdb_show(vty,level,&type,&id,NULL,oa->lsdb);}break;caseOSPF6_SCOPE_LINKLOCAL:for
(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j
,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb_
show(vty,level,&type,&id,NULL,oi->lsdb);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,A
S_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,level,&type,&id,NULL,o->lsdb);break;def
ault:assert(0);break;}vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6
_database_type_router,show_ipv6_ospf6_database_type_router_cmd,"showipv6ospf6dat
abase<router|network|inter-prefix|inter-router|as-external|group-membership|type
-7|link|intra-prefix><*|adv-router>A.B.C.D[<detail|dump|internal>]",SHOW_STRIPV6
_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""DisplayNetworkLSA
s\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""DisplayAs-E
xternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""DisplayLinkLS
As\n""DisplayIntra-Area-PrefixLSAs\n""AnyLinkstateID\n""SearchbyAdvertisingRoute
r\n""SpecifyAdvertisingRouterasIPv4addressnotation\n""DisplaydetailsofLSAs\n""Du
mpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_lsa=4;intidx_ipv4=6;intidx_
level=7;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;str
uctospf6_interface*oi;uint16_ttype=0;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNIN
G();type=parse_type_spec(idx_lsa,argc,argv);inet_pton(AF_INET,argv[idx_ipv4]->ar
g,&adv_router);level=parse_show_level(idx_level,argc,argv);switch(OSPF6_LSA_SCOP
E(type)){caseOSPF6_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_o
ut(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,&type,NULL,&ad
v_router,oa->lsdb);}break;caseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o->
area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB
_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb_show(vty,level,&type,NULL
,&adv_router,oi->lsdb);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FORM
AT);ospf6_lsdb_show(vty,level,&type,NULL,&adv_router,o->lsdb);break;default:asse
rt(0);break;}vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database
_id_router,show_ipv6_ospf6_database_id_router_cmd,"showipv6ospf6database*A.B.C.D
A.B.C.D[<detail|dump|internal>]",SHOW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatab
ase\n""AnyLinkstateType\n""SpecifyLinkstateIDasIPv4addressnotation\n""SpecifyAdv
ertisingRouterasIPv4addressnotation\n""DisplaydetailsofLSAs\n""DumpLSAs\n""Displ
ayLSA'sinternalinformation\n"){intidx_ls_id=5;intidx_adv_rtr=6;intidx_level=7;in
tlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_i
nterface*oi;uint32_tid=0;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNING();inet_pto
n(AF_INET,argv[idx_ls_id]->arg,&id);inet_pton(AF_INET,argv[idx_adv_rtr]->arg,&ad
v_router);level=parse_show_level(idx_level,argc,argv);for(ALL_LIST_ELEMENTS_RO(o
->area_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(
vty,level,NULL,&id,&adv_router,oa->lsdb);}for(ALL_LIST_ELEMENTS_RO(o->area_list,
i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FOR
MAT,oi->interface->name,oa->name);ospf6_lsdb_show(vty,level,NULL,&id,&adv_router
,oi->lsdb);}}vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,level,NULL,&i
d,&adv_router,o->lsdb);vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf
6_database_adv_router_linkstate_id,show_ipv6_ospf6_database_adv_router_linkstate
_id_cmd,"showipv6ospf6databaseadv-routerA.B.C.Dlinkstate-idA.B.C.D[<detail|dump|
internal>]",SHOW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""SearchbyAdvert
isingRouter\n""SpecifyAdvertisingRouterasIPv4addressnotation\n""SearchbyLinkstat
eID\n""SpecifyLinkstateIDasIPv4addressnotation\n""DisplaydetailsofLSAs\n""DumpLS
As\n""DisplayLSA'sinternalinformation\n"){intidx_adv_rtr=5;intidx_ls_id=7;intidx
_level=8;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;st
ructospf6_interface*oi;uint32_tid=0;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNING
();inet_pton(AF_INET,argv[idx_adv_rtr]->arg,&adv_router);inet_pton(AF_INET,argv[
idx_ls_id]->arg,&id);level=parse_show_level(idx_level,argc,argv);for(ALL_LIST_EL
EMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6
_lsdb_show(vty,level,NULL,&id,&adv_router,oa->lsdb);}for(ALL_LIST_ELEMENTS_RO(o-
>area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSD
B_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb_show(vty,level,NULL,&id,
&adv_router,oi->lsdb);}}vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,le
vel,NULL,&id,&adv_router,o->lsdb);vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(sho
w_ipv6_ospf6_database_type_id_router,show_ipv6_ospf6_database_type_id_router_cmd
,"showipv6ospf6database<router|network|inter-prefix|inter-router|as-external|gro
up-membership|type-7|link|intra-prefix>A.B.C.DA.B.C.D[<dump|internal>]",SHOW_STR
IPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""DisplayNetwor
kLSAs\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""Display
As-ExternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""DisplayLi
nkLSAs\n""DisplayIntra-Area-PrefixLSAs\n""SpecifyLinkstateIDasIPv4addressnotatio
n\n""SpecifyAdvertisingRouterasIPv4addressnotation\n""DumpLSAs\n""DisplayLSA'sin
ternalinformation\n"){intidx_lsa=4;intidx_ls_id=5;intidx_adv_rtr=6;intidx_level=
7;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;structosp
f6_interface*oi;uint16_ttype=0;uint32_tid=0;uint32_tadv_router=0;OSPF6_CMD_CHECK
_RUNNING();type=parse_type_spec(idx_lsa,argc,argv);inet_pton(AF_INET,argv[idx_ls
_id]->arg,&id);inet_pton(AF_INET,argv[idx_adv_rtr]->arg,&adv_router);level=parse
_show_level(idx_level,argc,argv);switch(OSPF6_LSA_SCOPE(type)){caseOSPF6_SCOPE_A
REA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FOR
MAT,oa->name);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,oa->lsdb);}break;c
aseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_LI
ST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interface
->name,oa->name);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,oi->lsdb);}}bre
ak;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,leve
l,&type,&id,&adv_router,o->lsdb);break;default:assert(0);break;}vty_out(vty,"\n"
);returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database_type_adv_router_linkstate_id
,show_ipv6_ospf6_database_type_adv_router_linkstate_id_cmd,"showipv6ospf6databas
e<router|network|inter-prefix|inter-router|as-external|group-membership|type-7|l
ink|intra-prefix>adv-routerA.B.C.Dlinkstate-idA.B.C.D[<dump|internal>]",SHOW_STR
IPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""DisplayNetwor
kLSAs\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""Display
As-ExternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""DisplayLi
nkLSAs\n""DisplayIntra-Area-PrefixLSAs\n""SearchbyAdvertisingRouter\n""SpecifyAd
vertisingRouterasIPv4addressnotation\n""SearchbyLinkstateID\n""SpecifyLinkstateI
DasIPv4addressnotation\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx
_lsa=4;intidx_adv_rtr=6;intidx_ls_id=8;intidx_level=9;intlevel;structlistnode*i,
*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_interface*oi;uint16_ttype
=0;uint32_tid=0;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNING();type=parse_type_s
pec(idx_lsa,argc,argv);inet_pton(AF_INET,argv[idx_adv_rtr]->arg,&adv_router);ine
t_pton(AF_INET,argv[idx_ls_id]->arg,&id);level=parse_show_level(idx_level,argc,a
rgv);switch(OSPF6_LSA_SCOPE(type)){caseOSPF6_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO
(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_sho
w(vty,level,&type,&id,&adv_router,oa->lsdb);}break;caseOSPF6_SCOPE_LINKLOCAL:for
(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j
,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb_
show(vty,level,&type,&id,&adv_router,oi->lsdb);}}break;caseOSPF6_SCOPE_AS:vty_ou
t(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,o->l
sdb);break;default:assert(0);break;}vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(s
how_ipv6_ospf6_database_self_originated,show_ipv6_ospf6_database_self_originated
_cmd,"showipv6ospf6databaseself-originated[<detail|dump|internal>]",SHOW_STRIPV6
_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplaySelf-originatedLSAs\n""Displayd
etailsofLSAs\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_level=5;i
ntlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_
interface*oi;uint32_tadv_router=0;OSPF6_CMD_CHECK_RUNNING();level=parse_show_lev
el(idx_level,argc,argv);adv_router=o->router_id;for(ALL_LIST_ELEMENTS_RO(o->area
_list,i,oa)){vty_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,le
vel,NULL,NULL,&adv_router,oa->lsdb);}for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)
){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,o
i->interface->name,oa->name);ospf6_lsdb_show(vty,level,NULL,NULL,&adv_router,oi-
>lsdb);}}vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(vty,level,NULL,NULL,&
adv_router,o->lsdb);vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_d
atabase_type_self_originated,show_ipv6_ospf6_database_type_self_originated_cmd,"
showipv6ospf6database<router|network|inter-prefix|inter-router|as-external|group
-membership|type-7|link|intra-prefix>self-originated[<detail|dump|internal>]",SH
OW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""Display
NetworkLSAs\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""D
isplayAs-ExternalLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""Dis
playLinkLSAs\n""DisplayIntra-Area-PrefixLSAs\n""DisplaySelf-originatedLSAs\n""Di
splaydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){intidx_lsa
=4;intidx_level=6;intlevel;structlistnode*i,*j;structospf6*o=ospf6;structospf6_a
rea*oa;structospf6_interface*oi;uint16_ttype=0;uint32_tadv_router=0;OSPF6_CMD_CH
ECK_RUNNING();type=parse_type_spec(idx_lsa,argc,argv);level=parse_show_level(idx
_level,argc,argv);adv_router=o->router_id;switch(OSPF6_LSA_SCOPE(type)){caseOSPF
6_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_
TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,&type,NULL,&adv_router,oa->lsdb
);}break;caseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){
for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi-
>interface->name,oa->name);ospf6_lsdb_show(vty,level,&type,NULL,&adv_router,oi->
lsdb);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_sh
ow(vty,level,&type,NULL,&adv_router,o->lsdb);break;default:assert(0);break;}vty_
out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database_type_self_origin
ated_linkstate_id,show_ipv6_ospf6_database_type_self_originated_linkstate_id_cmd
,"showipv6ospf6database<router|network|inter-prefix|inter-router|as-external|gro
up-membership|type-7|link|intra-prefix>self-originatedlinkstate-idA.B.C.D[<detai
l|dump|internal>]",SHOW_STRIPV6_STROSPF6_STR"DisplayLinkstatedatabase\n""Display
RouterLSAs\n""DisplayNetworkLSAs\n""DisplayInter-Area-PrefixLSAs\n""DisplayInter
-Area-RouterLSAs\n""DisplayAs-ExternalLSAs\n""DisplayGroup-MembershipLSAs\n""Dis
playType-7LSAs\n""DisplayLinkLSAs\n""DisplayIntra-Area-PrefixLSAs\n""DisplaySelf
-originatedLSAs\n""SearchbyLinkstateID\n""SpecifyLinkstateIDasIPv4addressnotatio
n\n""DisplaydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'sinternalinformation\n"){int
idx_lsa=4;intidx_ls_id=7;intidx_level=8;intlevel;structlistnode*i,*j;structospf6
*o=ospf6;structospf6_area*oa;structospf6_interface*oi;uint16_ttype=0;uint32_tadv
_router=0;uint32_tid=0;OSPF6_CMD_CHECK_RUNNING();type=parse_type_spec(idx_lsa,ar
gc,argv);inet_pton(AF_INET,argv[idx_ls_id]->arg,&id);level=parse_show_level(idx_
level,argc,argv);adv_router=o->router_id;switch(OSPF6_LSA_SCOPE(type)){caseOSPF6
_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vty_out(vty,AREA_LSDB_T
ITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,oa->lsdb);
}break;caseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){fo
r(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LSDB_TITLE_FORMAT,oi->i
nterface->name,oa->name);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,oi->lsd
b);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FORMAT);ospf6_lsdb_show(
vty,level,&type,&id,&adv_router,o->lsdb);break;default:assert(0);break;}vty_out(
vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_database_type_id_self_origina
ted,show_ipv6_ospf6_database_type_id_self_originated_cmd,"showipv6ospf6database<
router|network|inter-prefix|inter-router|as-external|group-membership|type-7|lin
k|intra-prefix>A.B.C.Dself-originated[<detail|dump|internal>]",SHOW_STRIPV6_STRO
SPF6_STR"DisplayLinkstatedatabase\n""DisplayRouterLSAs\n""DisplayNetworkLSAs\n""
DisplayInter-Area-PrefixLSAs\n""DisplayInter-Area-RouterLSAs\n""DisplayAs-Extern
alLSAs\n""DisplayGroup-MembershipLSAs\n""DisplayType-7LSAs\n""DisplayLinkLSAs\n"
"DisplayIntra-Area-PrefixLSAs\n""SpecifyLinkstateIDasIPv4addressnotation\n""Disp
laySelf-originatedLSAs\n""DisplaydetailsofLSAs\n""DumpLSAs\n""DisplayLSA'sintern
alinformation\n"){intidx_lsa=4;intidx_ls_id=5;intidx_level=7;intlevel;structlist
node*i,*j;structospf6*o=ospf6;structospf6_area*oa;structospf6_interface*oi;uint1
6_ttype=0;uint32_tadv_router=0;uint32_tid=0;OSPF6_CMD_CHECK_RUNNING();type=parse
_type_spec(idx_lsa,argc,argv);inet_pton(AF_INET,argv[idx_ls_id]->arg,&id);level=
parse_show_level(idx_level,argc,argv);adv_router=o->router_id;switch(OSPF6_LSA_S
COPE(type)){caseOSPF6_SCOPE_AREA:for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa)){vt
y_out(vty,AREA_LSDB_TITLE_FORMAT,oa->name);ospf6_lsdb_show(vty,level,&type,&id,&
adv_router,oa->lsdb);}break;caseOSPF6_SCOPE_LINKLOCAL:for(ALL_LIST_ELEMENTS_RO(o
->area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){vty_out(vty,IF_LS
DB_TITLE_FORMAT,oi->interface->name,oa->name);ospf6_lsdb_show(vty,level,&type,&i
d,&adv_router,oi->lsdb);}}break;caseOSPF6_SCOPE_AS:vty_out(vty,AS_LSDB_TITLE_FOR
MAT);ospf6_lsdb_show(vty,level,&type,&id,&adv_router,o->lsdb);break;default:asse
rt(0);break;}vty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_border_r
outers,show_ipv6_ospf6_border_routers_cmd,"showipv6ospf6border-routers[<A.B.C.D|
detail>]",SHOW_STRIP6_STROSPF6_STR"DisplayroutingtableforABRandASBR\n""RouterID\
n""Showdetailedoutput\n"){intidx_ipv4=4;uint32_tadv_router;structospf6_route*ro;
structprefixprefix;OSPF6_CMD_CHECK_RUNNING();if(argc==5){if(strmatch(argv[idx_ip
v4]->text,"detail")){for(ro=ospf6_route_head(ospf6->brouter_table);ro;ro=ospf6_r
oute_next(ro))ospf6_route_show_detail(vty,ro);}else{inet_pton(AF_INET,argv[idx_i
pv4]->arg,&adv_router);ospf6_linkstate_prefix(adv_router,0,&prefix);ro=ospf6_rou
te_lookup(&prefix,ospf6->brouter_table);if(!ro){vty_out(vty,"NoRoutefoundforRout
erID:%s\n",argv[4]->arg);returnCMD_SUCCESS;}ospf6_route_show_detail(vty,ro);retu
rnCMD_SUCCESS;}}else{ospf6_brouter_show_header(vty);for(ro=ospf6_route_head(ospf
6->brouter_table);ro;ro=ospf6_route_next(ro))ospf6_brouter_show(vty,ro);}returnC
MD_SUCCESS;}DEFUN(show_ipv6_ospf6_linkstate,show_ipv6_ospf6_linkstate_cmd,"showi
pv6ospf6linkstate<routerA.B.C.D|networkA.B.C.DA.B.C.D>",SHOW_STRIP6_STROSPF6_STR
"Displaylinkstateroutingtable\n""DisplayRouterEntry\n""SpecifyRouterIDasIPv4addr
essnotation\n""DisplayNetworkEntry\n""SpecifyRouterIDasIPv4addressnotation\n""Sp
ecifyLinkstateIDasIPv4addressnotation\n"){intidx_ipv4=5;structlistnode*node;stru
ctospf6_area*oa;OSPF6_CMD_CHECK_RUNNING();for(ALL_LIST_ELEMENTS_RO(ospf6->area_l
ist,node,oa)){vty_out(vty,"\nSPFResultinArea%s\n\n",oa->name);ospf6_linkstate_ta
ble_show(vty,idx_ipv4,argc,argv,oa->spf_table);}vty_out(vty,"\n");returnCMD_SUCC
ESS;}DEFUN(show_ipv6_ospf6_linkstate_detail,show_ipv6_ospf6_linkstate_detail_cmd
,"showipv6ospf6linkstatedetail",SHOW_STRIP6_STROSPF6_STR"Displaylinkstaterouting
table\n""Displaydetailedinformation\n"){intidx_detail=4;structlistnode*node;stru
ctospf6_area*oa;OSPF6_CMD_CHECK_RUNNING();for(ALL_LIST_ELEMENTS_RO(ospf6->area_l
ist,node,oa)){vty_out(vty,"\nSPFResultinArea%s\n\n",oa->name);ospf6_linkstate_ta
ble_show(vty,idx_detail,argc,argv,oa->spf_table);}vty_out(vty,"\n");returnCMD_SU
CCESS;}staticvoidospf6_plist_add(structprefix_list*plist){if(prefix_list_afi(pli
st)!=AFI_IP6)return;ospf6_area_plist_update(plist,1);}staticvoidospf6_plist_del(
structprefix_list*plist){if(prefix_list_afi(plist)!=AFI_IP6)return;ospf6_area_pl
ist_update(plist,0);}/*Installospfrelatedcommands.*/voidospf6_init(void){ospf6_t
op_init();ospf6_area_init();ospf6_interface_init();ospf6_neighbor_init();ospf6_z
ebra_init(master);ospf6_lsa_init();ospf6_spf_init();ospf6_intra_init();ospf6_asb
r_init();ospf6_abr_init();prefix_list_add_hook(ospf6_plist_add);prefix_list_dele
te_hook(ospf6_plist_del);ospf6_bfd_init();install_node(&debug_node,config_write_
ospf6_debug);install_element_ospf6_debug_message();install_element_ospf6_debug_l
sa();install_element_ospf6_debug_interface();install_element_ospf6_debug_neighbo
r();install_element_ospf6_debug_zebra();install_element_ospf6_debug_spf();instal
l_element_ospf6_debug_route();install_element_ospf6_debug_brouter();install_elem
ent_ospf6_debug_asbr();install_element_ospf6_debug_abr();install_element_ospf6_d
ebug_flood();install_element_ospf6_clear_interface();install_element(VIEW_NODE,&
show_debugging_ospf6_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_border_rout
ers_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_linkstate_cmd);install_eleme
nt(VIEW_NODE,&show_ipv6_ospf6_linkstate_detail_cmd);install_element(VIEW_NODE,&s
how_ipv6_ospf6_database_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database
_type_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_id_cmd);install_e
lement(VIEW_NODE,&show_ipv6_ospf6_database_router_cmd);install_element(VIEW_NODE
,&show_ipv6_ospf6_database_type_id_cmd);install_element(VIEW_NODE,&show_ipv6_osp
f6_database_type_router_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database
_adv_router_linkstate_id_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_databas
e_id_router_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_type_id_rou
ter_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_type_adv_router_lin
kstate_id_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_self_originat
ed_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_type_self_originated
_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_type_id_self_originate
d_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_type_self_originated_
linkstate_id_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_database_aggr_route
r_cmd);/*Makeospfprotocolsocket.*/ospf6_serv_sock();thread_add_read(master,ospf6
_receive,NULL,ospf6_sock,NULL);}voidospf6_clean(void){if(!ospf6)return;if(ospf6-
>route_table)ospf6_route_remove_all(ospf6->route_table);if(ospf6->brouter_table)
ospf6_route_remove_all(ospf6->brouter_table);}