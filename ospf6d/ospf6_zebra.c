/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"log.h"#include"vty.h"#include"command.h"#include"prefix.h"#i
nclude"stream.h"#include"zclient.h"#include"memory.h"#include"lib/bfd.h"#include
"ospf6_proto.h"#include"ospf6_top.h"#include"ospf6_interface.h"#include"ospf6_ro
ute.h"#include"ospf6_lsa.h"#include"ospf6_lsdb.h"#include"ospf6_asbr.h"#include"
ospf6_zebra.h"#include"ospf6d.h"DEFINE_MTYPE_STATIC(OSPF6D,OSPF6_DISTANCE,"OSPF6
distance")unsignedcharconf_debug_ospf6_zebra=0;/*informationaboutzebra.*/structz
client*zclient=NULL;/*Router-idupdatemessagefromzebra.*/staticintospf6_router_id
_update_zebra(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id
){structprefixrouter_id;structospf6*o=ospf6;zebra_router_id_update_read(zclient-
>ibuf,&router_id);om6->zebra_router_id=router_id.u.prefix4.s_addr;if(o==NULL)ret
urn0;o->router_id_zebra=router_id.u.prefix4;if(IS_OSPF6_DEBUG_ZEBRA(RECV)){charb
uf[INET_ADDRSTRLEN];zlog_debug("%s:zebrarouter-id%supdate",__PRETTY_FUNCTION__,i
net_ntop(AF_INET,&router_id.u.prefix4,buf,INET_ADDRSTRLEN));}ospf6_router_id_upd
ate();return0;}/*redistributefunction*/voidospf6_zebra_redistribute(inttype){if(
vrf_bitmap_check(zclient->redist[AFI_IP6][type],VRF_DEFAULT))return;vrf_bitmap_s
et(zclient->redist[AFI_IP6][type],VRF_DEFAULT);if(zclient->sock>0)zebra_redistri
bute_send(ZEBRA_REDISTRIBUTE_ADD,zclient,AFI_IP6,type,0,VRF_DEFAULT);}voidospf6_
zebra_no_redistribute(inttype){if(!vrf_bitmap_check(zclient->redist[AFI_IP6][typ
e],VRF_DEFAULT))return;vrf_bitmap_unset(zclient->redist[AFI_IP6][type],VRF_DEFAU
LT);if(zclient->sock>0)zebra_redistribute_send(ZEBRA_REDISTRIBUTE_DELETE,zclient
,AFI_IP6,type,0,VRF_DEFAULT);}/*Intefaceadditionmessagefromzebra.*/staticintospf
6_zebra_if_add(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_i
d){structinterface*ifp;ifp=zebra_interface_add_read(zclient->ibuf,vrf_id);if(IS_
OSPF6_DEBUG_ZEBRA(RECV))zlog_debug("ZebraInterfaceadd:%sindex%dmtu%d",ifp->name,
ifp->ifindex,ifp->mtu6);ospf6_interface_if_add(ifp);return0;}staticintospf6_zebr
a_if_del(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){str
uctinterface*ifp;if(!(ifp=zebra_interface_state_read(zclient->ibuf,vrf_id)))retu
rn0;if(if_is_up(ifp))zlog_warn("Zebra:gotdeleteof%s,butinterfaceisstillup",ifp->
name);if(IS_OSPF6_DEBUG_ZEBRA(RECV))zlog_debug("ZebraInterfacedelete:%sindex%dmt
u%d",ifp->name,ifp->ifindex,ifp->mtu6);#if0/*XXX:ospf6_interface_if_delisnotther
ightwaytohandlethis,*becauseamongotherthinkableissues,itwillalsoclearall*setting
sastheyarecontainedinthestructospf6_interface.*/ospf6_interface_if_del(ifp);#end
if/*0*/if_set_index(ifp,IFINDEX_INTERNAL);return0;}staticintospf6_zebra_if_state
_update(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){stru
ctinterface*ifp;ifp=zebra_interface_state_read(zclient->ibuf,vrf_id);if(ifp==NUL
L)return0;if(IS_OSPF6_DEBUG_ZEBRA(RECV))zlog_debug("ZebraInterfacestatechange:""
%sindex%dflags%llxmetric%dmtu%dbandwidth%d",ifp->name,ifp->ifindex,(unsignedlong
long)ifp->flags,ifp->metric,ifp->mtu6,ifp->bandwidth);ospf6_interface_state_upda
te(ifp);return0;}staticintospf6_zebra_if_address_update_add(intcommand,structzcl
ient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structconnected*c;charbuf[128];c
=zebra_interface_address_read(ZEBRA_INTERFACE_ADDRESS_ADD,zclient->ibuf,vrf_id);
if(c==NULL)return0;if(IS_OSPF6_DEBUG_ZEBRA(RECV))zlog_debug("ZebraInterfaceaddre
ssadd:%s%5s%s/%d",c->ifp->name,prefix_family_str(c->address),inet_ntop(c->addres
s->family,&c->address->u.prefix,buf,sizeof(buf)),c->address->prefixlen);if(c->ad
dress->family==AF_INET6){ospf6_interface_state_update(c->ifp);ospf6_interface_co
nnected_route_update(c->ifp);}return0;}staticintospf6_zebra_if_address_update_de
lete(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structc
onnected*c;charbuf[128];c=zebra_interface_address_read(ZEBRA_INTERFACE_ADDRESS_D
ELETE,zclient->ibuf,vrf_id);if(c==NULL)return0;if(IS_OSPF6_DEBUG_ZEBRA(RECV))zlo
g_debug("ZebraInterfaceaddressdelete:%s%5s%s/%d",c->ifp->name,prefix_family_str(
c->address),inet_ntop(c->address->family,&c->address->u.prefix,buf,sizeof(buf)),
c->address->prefixlen);if(c->address->family==AF_INET6){ospf6_interface_connecte
d_route_update(c->ifp);ospf6_interface_state_update(c->ifp);}connected_free(c);r
eturn0;}staticintospf6_zebra_read_route(intcommand,structzclient*zclient,zebra_s
ize_tlength,vrf_id_tvrf_id){structzapi_routeapi;unsignedlongifindex;structin6_ad
dr*nexthop;if(ospf6==NULL)return0;if(zapi_route_decode(zclient->ibuf,&api)<0)ret
urn-1;/*wecompletelyignoresrcdestroutesfornow.*/if(CHECK_FLAG(api.message,ZAPI_M
ESSAGE_SRCPFX))return0;ifindex=api.nexthops[0].ifindex;nexthop=&api.nexthops[0].
gate.ipv6;if(IS_OSPF6_DEBUG_ZEBRA(RECV)){charprefixstr[PREFIX2STR_BUFFER],nextho
pstr[128];prefix2str((structprefix*)&api.prefix,prefixstr,sizeof(prefixstr));ine
t_ntop(AF_INET6,nexthop,nexthopstr,sizeof(nexthopstr));zlog_debug("ZebraReceiver
oute%s:%s%snexthop%sifindex%ldtag%"ROUTE_TAG_PRI,(command==ZEBRA_REDISTRIBUTE_RO
UTE_ADD?"add":"delete"),zebra_route_string(api.type),prefixstr,nexthopstr,ifinde
x,api.tag);}if(command==ZEBRA_REDISTRIBUTE_ROUTE_ADD)ospf6_asbr_redistribute_add
(api.type,ifindex,&api.prefix,api.nexthop_num,nexthop,api.tag);elseospf6_asbr_re
distribute_remove(api.type,ifindex,&api.prefix);return0;}DEFUN(show_zebra,show_o
spf6_zebra_cmd,"showipv6ospf6zebra",SHOW_STRIPV6_STROSPF6_STRZEBRA_STR){inti;if(
zclient==NULL){vty_out(vty,"Notconnectedtozebra\n");returnCMD_SUCCESS;}vty_out(v
ty,"ZebraInfomation\n");vty_out(vty,"fail:%d\n",zclient->fail);vty_out(vty,"redi
stributedefault:%d\n",vrf_bitmap_check(zclient->default_information,VRF_DEFAULT)
);vty_out(vty,"redistribute:");for(i=0;i<ZEBRA_ROUTE_MAX;i++){if(vrf_bitmap_chec
k(zclient->redist[AFI_IP6][i],VRF_DEFAULT))vty_out(vty,"%s",zebra_route_string(i
));}vty_out(vty,"\n");returnCMD_SUCCESS;}#defineADD0#defineREM1staticvoidospf6_z
ebra_route_update(inttype,structospf6_route*request){structzapi_routeapi;charbuf
[PREFIX2STR_BUFFER];intnhcount;intret=0;structprefix*dest;if(IS_OSPF6_DEBUG_ZEBR
A(SEND)){prefix2str(&request->prefix,buf,sizeof(buf));zlog_debug("Send%sroute:%s
",(type==REM?"remove":"add"),buf);}if(zclient->sock<0){if(IS_OSPF6_DEBUG_ZEBRA(S
END))zlog_debug("NotconnectedtoZebra");return;}if(request->path.origin.adv_route
r==ospf6->router_id&&(request->path.type==OSPF6_PATH_TYPE_EXTERNAL1||request->pa
th.type==OSPF6_PATH_TYPE_EXTERNAL2)){if(IS_OSPF6_DEBUG_ZEBRA(SEND))zlog_debug("I
gnoreself-originatedexternalroute");return;}/*Ifremovingisthebestpathandifthere'
sanotherpath,treatthisrequestasaddthesecondarypath*/if(type==REM&&ospf6_route_is
_best(request)&&request->next&&ospf6_route_is_same(request,request->next)){if(IS
_OSPF6_DEBUG_ZEBRA(SEND))zlog_debug("Best-pathremovalresultedSencondaryaddition"
);type=ADD;request=request->next;}/*Onlythebestpathwillbesenttozebra.*/if(!ospf6
_route_is_best(request)){/*thisisnotpreferredbestroute,ignore*/if(IS_OSPF6_DEBUG
_ZEBRA(SEND))zlog_debug("Ignorenon-bestroute");return;}nhcount=ospf6_route_num_n
exthops(request);if(nhcount==0){if(IS_OSPF6_DEBUG_ZEBRA(SEND))zlog_debug("Nonext
hop,ignore");return;}dest=&request->prefix;memset(&api,0,sizeof(api));api.vrf_id
=VRF_DEFAULT;api.type=ZEBRA_ROUTE_OSPF6;api.safi=SAFI_UNICAST;api.prefix=*dest;S
ET_FLAG(api.message,ZAPI_MESSAGE_NEXTHOP);api.nexthop_num=MIN(nhcount,MULTIPATH_
NUM);ospf6_route_zebra_copy_nexthops(request,api.nexthops,api.nexthop_num);SET_F
LAG(api.message,ZAPI_MESSAGE_METRIC);api.metric=(request->path.metric_type==2?re
quest->path.u.cost_e2:request->path.cost);if(request->path.tag){SET_FLAG(api.mes
sage,ZAPI_MESSAGE_TAG);api.tag=request->path.tag;}SET_FLAG(api.message,ZAPI_MESS
AGE_DISTANCE);api.distance=ospf6_distance_apply((structprefix_ipv6*)dest,request
);if(type==REM)ret=zclient_route_send(ZEBRA_ROUTE_DELETE,zclient,&api);elseret=z
client_route_send(ZEBRA_ROUTE_ADD,zclient,&api);if(ret<0)zlog_err("zclient_route
_send()%sfailed:%s",(type==REM?"delete":"add"),safe_strerror(errno));return;}voi
dospf6_zebra_route_update_add(structospf6_route*request){ospf6_zebra_route_updat
e(ADD,request);}voidospf6_zebra_route_update_remove(structospf6_route*request){o
spf6_zebra_route_update(REM,request);}voidospf6_zebra_add_discard(structospf6_ro
ute*request){structzapi_routeapi;charbuf[INET6_ADDRSTRLEN];structprefix*dest=&re
quest->prefix;if(!CHECK_FLAG(request->flag,OSPF6_ROUTE_BLACKHOLE_ADDED)){memset(
&api,0,sizeof(api));api.vrf_id=VRF_DEFAULT;api.type=ZEBRA_ROUTE_OSPF6;api.safi=S
AFI_UNICAST;api.prefix=*dest;zapi_route_set_blackhole(&api,BLACKHOLE_NULL);zclie
nt_route_send(ZEBRA_ROUTE_ADD,zclient,&api);if(IS_OSPF6_DEBUG_ZEBRA(SEND))zlog_d
ebug("Zebra:Routeadddiscard%s/%d",inet_ntop(AF_INET6,&dest->u.prefix6,buf,INET6_
ADDRSTRLEN),dest->prefixlen);SET_FLAG(request->flag,OSPF6_ROUTE_BLACKHOLE_ADDED)
;}else{if(IS_OSPF6_DEBUG_ZEBRA(SEND))zlog_debug("Zebra:Blackholeroutepresentalre
ady%s/%d",inet_ntop(AF_INET6,&dest->u.prefix6,buf,INET6_ADDRSTRLEN),dest->prefix
len);}}voidospf6_zebra_delete_discard(structospf6_route*request){structzapi_rout
eapi;charbuf[INET6_ADDRSTRLEN];structprefix*dest=&request->prefix;if(CHECK_FLAG(
request->flag,OSPF6_ROUTE_BLACKHOLE_ADDED)){memset(&api,0,sizeof(api));api.vrf_i
d=VRF_DEFAULT;api.type=ZEBRA_ROUTE_OSPF6;api.safi=SAFI_UNICAST;api.prefix=*dest;
zapi_route_set_blackhole(&api,BLACKHOLE_NULL);zclient_route_send(ZEBRA_ROUTE_DEL
ETE,zclient,&api);if(IS_OSPF6_DEBUG_ZEBRA(SEND))zlog_debug("Zebra:Routedeletedis
card%s/%d",inet_ntop(AF_INET6,&dest->u.prefix6,buf,INET6_ADDRSTRLEN),dest->prefi
xlen);UNSET_FLAG(request->flag,OSPF6_ROUTE_BLACKHOLE_ADDED);}else{if(IS_OSPF6_DE
BUG_ZEBRA(SEND))zlog_debug("Zebra:Blackholeroutealreadydeleted%s/%d",inet_ntop(A
F_INET6,&dest->u.prefix6,buf,INET6_ADDRSTRLEN),dest->prefixlen);}}staticstructos
pf6_distance*ospf6_distance_new(void){returnXCALLOC(MTYPE_OSPF6_DISTANCE,sizeof(
structospf6_distance));}staticvoidospf6_distance_free(structospf6_distance*odist
ance){XFREE(MTYPE_OSPF6_DISTANCE,odistance);}intospf6_distance_set(structvty*vty
,structospf6*o,constchar*distance_str,constchar*ip_str,constchar*access_list_str
){intret;structprefix_ipv6p;uint8_tdistance;structroute_node*rn;structospf6_dist
ance*odistance;ret=str2prefix_ipv6(ip_str,&p);if(ret==0){vty_out(vty,"Malformedp
refix\n");returnCMD_WARNING_CONFIG_FAILED;}distance=atoi(distance_str);/*GetOSPF
6distancenode.*/rn=route_node_get(o->distance_table,(structprefix*)&p);if(rn->in
fo){odistance=rn->info;route_unlock_node(rn);}else{odistance=ospf6_distance_new(
);rn->info=odistance;}/*Setdistancevalue.*/odistance->distance=distance;/*Reseta
ccess-listconfiguration.*/if(odistance->access_list){free(odistance->access_list
);odistance->access_list=NULL;}if(access_list_str)odistance->access_list=strdup(
access_list_str);returnCMD_SUCCESS;}intospf6_distance_unset(structvty*vty,struct
ospf6*o,constchar*distance_str,constchar*ip_str,constchar*access_list_str){intre
t;structprefix_ipv6p;structroute_node*rn;structospf6_distance*odistance;ret=str2
prefix_ipv6(ip_str,&p);if(ret==0){vty_out(vty,"Malformedprefix\n");returnCMD_WAR
NING_CONFIG_FAILED;}rn=route_node_lookup(o->distance_table,(structprefix*)&p);if
(!rn){vty_out(vty,"Cant'tfindspecifiedprefix\n");returnCMD_WARNING_CONFIG_FAILED
;}odistance=rn->info;if(odistance->access_list)free(odistance->access_list);ospf
6_distance_free(odistance);rn->info=NULL;route_unlock_node(rn);route_unlock_node
(rn);returnCMD_SUCCESS;}voidospf6_distance_reset(structospf6*o){structroute_node
*rn;structospf6_distance*odistance;for(rn=route_top(o->distance_table);rn;rn=rou
te_next(rn))if((odistance=rn->info)!=NULL){if(odistance->access_list)free(odista
nce->access_list);ospf6_distance_free(odistance);rn->info=NULL;route_unlock_node
(rn);}}uint8_tospf6_distance_apply(structprefix_ipv6*p,structospf6_route*or){str
uctospf6*o;o=ospf6;if(o==NULL)return0;if(o->distance_intra)if(or->path.type==OSP
F6_PATH_TYPE_INTRA)returno->distance_intra;if(o->distance_inter)if(or->path.type
==OSPF6_PATH_TYPE_INTER)returno->distance_inter;if(o->distance_external)if(or->p
ath.type==OSPF6_PATH_TYPE_EXTERNAL1||or->path.type==OSPF6_PATH_TYPE_EXTERNAL2)re
turno->distance_external;if(o->distance_all)returno->distance_all;return0;}stati
cvoidospf6_zebra_connected(structzclient*zclient){/*Sendtheclientregistration*/b
fd_client_sendmsg(zclient,ZEBRA_BFD_CLIENT_REGISTER);zclient_send_reg_requests(z
client,VRF_DEFAULT);}voidospf6_zebra_init(structthread_master*master){/*Allocate
zebrastructure.*/zclient=zclient_new_notify(master,&zclient_options_default);zcl
ient_init(zclient,ZEBRA_ROUTE_OSPF6,0,&ospf6d_privs);zclient->zebra_connected=os
pf6_zebra_connected;zclient->router_id_update=ospf6_router_id_update_zebra;zclie
nt->interface_add=ospf6_zebra_if_add;zclient->interface_delete=ospf6_zebra_if_de
l;zclient->interface_up=ospf6_zebra_if_state_update;zclient->interface_down=ospf
6_zebra_if_state_update;zclient->interface_address_add=ospf6_zebra_if_address_up
date_add;zclient->interface_address_delete=ospf6_zebra_if_address_update_delete;
zclient->redistribute_route_add=ospf6_zebra_read_route;zclient->redistribute_rou
te_del=ospf6_zebra_read_route;/*Installcommandelementforzebranode.*/install_elem
ent(VIEW_NODE,&show_ospf6_zebra_cmd);}/*Debug*/DEFUN(debug_ospf6_zebra_sendrecv,
debug_ospf6_zebra_sendrecv_cmd,"debugospf6zebra[<send|recv>]",DEBUG_STROSPF6_STR
"Debugconnectionbetweenzebra\n""DebugSendingzebra\n""DebugReceivingzebra\n"){int
idx_send_recv=3;unsignedcharlevel=0;if(argc==4){if(strmatch(argv[idx_send_recv]-
>text,"send"))level=OSPF6_DEBUG_ZEBRA_SEND;elseif(strmatch(argv[idx_send_recv]->
text,"recv"))level=OSPF6_DEBUG_ZEBRA_RECV;}elselevel=OSPF6_DEBUG_ZEBRA_SEND|OSPF
6_DEBUG_ZEBRA_RECV;OSPF6_DEBUG_ZEBRA_ON(level);returnCMD_SUCCESS;}DEFUN(no_debug
_ospf6_zebra_sendrecv,no_debug_ospf6_zebra_sendrecv_cmd,"nodebugospf6zebra[<send
|recv>]",NO_STRDEBUG_STROSPF6_STR"Debugconnectionbetweenzebra\n""DebugSendingzeb
ra\n""DebugReceivingzebra\n"){intidx_send_recv=4;unsignedcharlevel=0;if(argc==5)
{if(strmatch(argv[idx_send_recv]->text,"send"))level=OSPF6_DEBUG_ZEBRA_SEND;else
if(strmatch(argv[idx_send_recv]->text,"recv"))level=OSPF6_DEBUG_ZEBRA_RECV;}else
level=OSPF6_DEBUG_ZEBRA_SEND|OSPF6_DEBUG_ZEBRA_RECV;OSPF6_DEBUG_ZEBRA_OFF(level)
;returnCMD_SUCCESS;}intconfig_write_ospf6_debug_zebra(structvty*vty){if(IS_OSPF6
_DEBUG_ZEBRA(SEND)&&IS_OSPF6_DEBUG_ZEBRA(RECV))vty_out(vty,"debugospf6zebra\n");
else{if(IS_OSPF6_DEBUG_ZEBRA(SEND))vty_out(vty,"debugospf6zebrasend\n");if(IS_OS
PF6_DEBUG_ZEBRA(RECV))vty_out(vty,"debugospf6zebrarecv\n");}return0;}voidinstall
_element_ospf6_debug_zebra(void){install_element(ENABLE_NODE,&debug_ospf6_zebra_
sendrecv_cmd);install_element(ENABLE_NODE,&no_debug_ospf6_zebra_sendrecv_cmd);in
stall_element(CONFIG_NODE,&debug_ospf6_zebra_sendrecv_cmd);install_element(CONFI
G_NODE,&no_debug_ospf6_zebra_sendrecv_cmd);}