/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*//*Shor
testPathFirstcalculationforOSPFv3*/#include<zebra.h>#include"log.h"#include"memo
ry.h"#include"command.h"#include"vty.h"#include"prefix.h"#include"pqueue.h"#incl
ude"linklist.h"#include"thread.h"#include"ospf6_lsa.h"#include"ospf6_lsdb.h"#inc
lude"ospf6_route.h"#include"ospf6_area.h"#include"ospf6_proto.h"#include"ospf6_a
br.h"#include"ospf6_spf.h"#include"ospf6_intra.h"#include"ospf6_interface.h"#inc
lude"ospf6d.h"#include"ospf6_abr.h"unsignedcharconf_debug_ospf6_spf=0;staticvoid
ospf6_spf_copy_nexthops_to_route(structospf6_route*rt,structospf6_vertex*v){if(r
t&&v)ospf6_copy_nexthops(rt->nh_list,v->nh_list);}staticvoidospf6_spf_merge_next
hops_to_route(structospf6_route*rt,structospf6_vertex*v){if(rt&&v)ospf6_merge_ne
xthops(rt->nh_list,v->nh_list);}staticunsignedintospf6_spf_get_ifindex_from_nh(s
tructospf6_vertex*v){structospf6_nexthop*nh;structlistnode*node;if(v){node=listh
ead(v->nh_list);if(node){nh=listgetdata(node);if(nh)return(nh->ifindex);}}return
0;}staticintospf6_vertex_cmp(void*a,void*b){structospf6_vertex*va=(structospf6_v
ertex*)a;structospf6_vertex*vb=(structospf6_vertex*)b;/*ascendingorder*/if(va->c
ost!=vb->cost)return(va->cost-vb->cost);return(va->hops-vb->hops);}staticintospf
6_vertex_id_cmp(void*a,void*b){structospf6_vertex*va=(structospf6_vertex*)a;stru
ctospf6_vertex*vb=(structospf6_vertex*)b;intret=0;ret=ntohl(ospf6_linkstate_pref
ix_adv_router(&va->vertex_id))-ntohl(ospf6_linkstate_prefix_adv_router(&vb->vert
ex_id));if(ret)returnret;ret=ntohl(ospf6_linkstate_prefix_id(&va->vertex_id))-nt
ohl(ospf6_linkstate_prefix_id(&vb->vertex_id));returnret;}staticstructospf6_vert
ex*ospf6_vertex_create(structospf6_lsa*lsa){structospf6_vertex*v;v=(structospf6_
vertex*)XMALLOC(MTYPE_OSPF6_VERTEX,sizeof(structospf6_vertex));/*type*/if(ntohs(
lsa->header->type)==OSPF6_LSTYPE_ROUTER){v->type=OSPF6_VERTEX_TYPE_ROUTER;/*Rout
erLSAuseLinkID0asbaseinvertex_id*/ospf6_linkstate_prefix(lsa->header->adv_router
,htonl(0),&v->vertex_id);}elseif(ntohs(lsa->header->type)==OSPF6_LSTYPE_NETWORK)
{v->type=OSPF6_VERTEX_TYPE_NETWORK;/*vertex_id*/ospf6_linkstate_prefix(lsa->head
er->adv_router,lsa->header->id,&v->vertex_id);}elseassert(0);/*name*/ospf6_links
tate_prefix2str(&v->vertex_id,v->name,sizeof(v->name));if(IS_OSPF6_DEBUG_SPF(PRO
CESS))zlog_debug("%s:Creatingvertex%softype%s(0x%04hx)lsa%s",__func__,v->name,((
ntohs(lsa->header->type)==OSPF6_LSTYPE_ROUTER)?"Router":"N/W"),ntohs(lsa->header
->type),lsa->name);/*AssociatedLSA*/v->lsa=lsa;/*capabilitybits+options*/v->capa
bility=*(uint8_t*)(OSPF6_LSA_HEADER_END(lsa->header));v->options[0]=*(uint8_t*)(
OSPF6_LSA_HEADER_END(lsa->header)+1);v->options[1]=*(uint8_t*)(OSPF6_LSA_HEADER_
END(lsa->header)+2);v->options[2]=*(uint8_t*)(OSPF6_LSA_HEADER_END(lsa->header)+
3);v->nh_list=list_new();v->nh_list->cmp=(int(*)(void*,void*))ospf6_nexthop_cmp;
v->nh_list->del=(void(*)(void*))ospf6_nexthop_delete;v->parent=NULL;v->child_lis
t=list_new();v->child_list->cmp=ospf6_vertex_id_cmp;returnv;}staticvoidospf6_ver
tex_delete(structospf6_vertex*v){list_delete_and_null(&v->nh_list);list_delete_a
nd_null(&v->child_list);XFREE(MTYPE_OSPF6_VERTEX,v);}staticstructospf6_lsa*ospf6
_lsdesc_lsa(caddr_tlsdesc,structospf6_vertex*v){structospf6_lsa*lsa=NULL;uint16_
ttype=0;uint32_tid=0,adv_router=0;if(VERTEX_IS_TYPE(NETWORK,v)){type=htons(OSPF6
_LSTYPE_ROUTER);id=htonl(0);adv_router=NETWORK_LSDESC_GET_NBR_ROUTERID(lsdesc);}
else{if(ROUTER_LSDESC_IS_TYPE(POINTTOPOINT,lsdesc)){type=htons(OSPF6_LSTYPE_ROUT
ER);id=htonl(0);adv_router=ROUTER_LSDESC_GET_NBR_ROUTERID(lsdesc);}elseif(ROUTER
_LSDESC_IS_TYPE(TRANSIT_NETWORK,lsdesc)){type=htons(OSPF6_LSTYPE_NETWORK);id=hto
nl(ROUTER_LSDESC_GET_NBR_IFID(lsdesc));adv_router=ROUTER_LSDESC_GET_NBR_ROUTERID
(lsdesc);}}if(type==htons(OSPF6_LSTYPE_NETWORK))lsa=ospf6_lsdb_lookup(type,id,ad
v_router,v->area->lsdb);elselsa=ospf6_create_single_router_lsa(v->area,v->area->
lsdb,adv_router);if(IS_OSPF6_DEBUG_SPF(PROCESS)){charibuf[16],abuf[16];inet_ntop
(AF_INET,&id,ibuf,sizeof(ibuf));inet_ntop(AF_INET,&adv_router,abuf,sizeof(abuf))
;if(lsa)zlog_debug("Linkto:%slen%u,V%s",lsa->name,ntohs(lsa->header->length),v->
name);elsezlog_debug("Linkto:[%sId:%sAdv:%s]NoLSA,V%s",ospf6_lstype_name(type),i
buf,abuf,v->name);}returnlsa;}staticchar*ospf6_lsdesc_backlink(structospf6_lsa*l
sa,caddr_tlsdesc,structospf6_vertex*v){caddr_tbacklink,found=NULL;intsize;size=(
OSPF6_LSA_IS_TYPE(ROUTER,lsa)?sizeof(structospf6_router_lsdesc):sizeof(structosp
f6_network_lsdesc));for(backlink=OSPF6_LSA_HEADER_END(lsa->header)+4;backlink+si
ze<=OSPF6_LSA_END(lsa->header);backlink+=size){assert(!(OSPF6_LSA_IS_TYPE(NETWOR
K,lsa)&&VERTEX_IS_TYPE(NETWORK,v)));if(OSPF6_LSA_IS_TYPE(NETWORK,lsa)&&NETWORK_L
SDESC_GET_NBR_ROUTERID(backlink)==v->lsa->header->adv_router)found=backlink;else
if(VERTEX_IS_TYPE(NETWORK,v)&&ROUTER_LSDESC_IS_TYPE(TRANSIT_NETWORK,backlink)&&R
OUTER_LSDESC_GET_NBR_ROUTERID(backlink)==v->lsa->header->adv_router&&ROUTER_LSDE
SC_GET_NBR_IFID(backlink)==ntohl(v->lsa->header->id))found=backlink;else{if(!ROU
TER_LSDESC_IS_TYPE(POINTTOPOINT,backlink)||!ROUTER_LSDESC_IS_TYPE(POINTTOPOINT,l
sdesc))continue;if(ROUTER_LSDESC_GET_NBR_IFID(backlink)!=ROUTER_LSDESC_GET_IFID(
lsdesc)||ROUTER_LSDESC_GET_NBR_IFID(lsdesc)!=ROUTER_LSDESC_GET_IFID(backlink))co
ntinue;if(ROUTER_LSDESC_GET_NBR_ROUTERID(backlink)!=v->lsa->header->adv_router||
ROUTER_LSDESC_GET_NBR_ROUTERID(lsdesc)!=lsa->header->adv_router)continue;found=b
acklink;}}if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("Vertex%sLsa%sBacklink%s",v-
>name,lsa->name,(found?"OK":"FAIL"));returnfound;}staticvoidospf6_nexthop_calc(s
tructospf6_vertex*w,structospf6_vertex*v,caddr_tlsdesc){inti;ifindex_tifindex;st
ructospf6_interface*oi;uint16_ttype;uint32_tadv_router;structospf6_lsa*lsa;struc
tospf6_link_lsa*link_lsa;charbuf[64];assert(VERTEX_IS_TYPE(ROUTER,w));ifindex=(V
ERTEX_IS_TYPE(NETWORK,v)?ospf6_spf_get_ifindex_from_nh(v):ROUTER_LSDESC_GET_IFID
(lsdesc));if(ifindex==0){zlog_err("Nonexthopifindexatvertex%s",v->name);return;}
oi=ospf6_interface_lookup_by_ifindex(ifindex);if(oi==NULL){if(IS_OSPF6_DEBUG_SPF
(PROCESS))zlog_debug("Can'tfindinterfaceinSPF:ifindex%d",ifindex);return;}type=h
tons(OSPF6_LSTYPE_LINK);adv_router=(VERTEX_IS_TYPE(NETWORK,v)?NETWORK_LSDESC_GET
_NBR_ROUTERID(lsdesc):ROUTER_LSDESC_GET_NBR_ROUTERID(lsdesc));i=0;for(ALL_LSDB_T
YPED_ADVRTR(oi->lsdb,type,adv_router,lsa)){if(VERTEX_IS_TYPE(ROUTER,v)&&htonl(RO
UTER_LSDESC_GET_NBR_IFID(lsdesc))!=lsa->header->id)continue;link_lsa=(structospf
6_link_lsa*)OSPF6_LSA_HEADER_END(lsa->header);if(IS_OSPF6_DEBUG_SPF(PROCESS)){in
et_ntop(AF_INET6,&link_lsa->linklocal_addr,buf,sizeof(buf));zlog_debug("nexthop%
sfrom%s",buf,lsa->name);}ospf6_add_nexthop(w->nh_list,ifindex,&link_lsa->linkloc
al_addr);i++;}if(i==0&&IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("Nonexthopfor%sfou
nd",w->name);}staticintospf6_spf_install(structospf6_vertex*v,structospf6_route_
table*result_table){structospf6_route*route,*parent_route;structospf6_vertex*pre
v;charpbuf[PREFIX2STR_BUFFER];if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("SPFinst
all%s(lsa%s)hops%dcost%d",v->name,v->lsa->name,v->hops,v->cost);route=ospf6_rout
e_lookup(&v->vertex_id,result_table);if(route&&route->path.cost<v->cost){if(IS_O
SPF6_DEBUG_SPF(PROCESS))zlog_debug("alreadyinstalledwithlowercost(%d),ignore",ro
ute->path.cost);ospf6_vertex_delete(v);return-1;}elseif(route&&route->path.cost=
=v->cost){if(IS_OSPF6_DEBUG_SPF(PROCESS)){prefix2str(&route->prefix,pbuf,sizeof(
pbuf));zlog_debug("anotherpathfoundtoroute%slsa%s,merge",pbuf,v->lsa->name);}osp
f6_spf_merge_nexthops_to_route(route,v);prev=(structospf6_vertex*)route->route_o
ption;assert(prev->hops<=v->hops);if((VERTEX_IS_TYPE(ROUTER,v)&&route->path.orig
in.id!=v->lsa->header->id)){if(IS_OSPF6_DEBUG_SPF(PROCESS)){zlog_debug("%s:Vlsa%
sid%u,routeid%uaredifferent",__PRETTY_FUNCTION__,v->lsa->name,ntohl(v->lsa->head
er->id),ntohl(route->path.origin.id));}return0;}ospf6_vertex_delete(v);return-1;
}/*Thereshouldbenocasewherecandidatebeinginstalled(variable"v")iscloserthantheon
eintheSPFtree(variable"route").InthecasesomethinghasgonewrongwiththebehaviorofPr
iority-Queue.*//*thecasewheretherouteexistsalreadyishandledandreturneduptohere.*
/assert(route==NULL);route=ospf6_route_create();memcpy(&route->prefix,&v->vertex
_id,sizeof(structprefix));route->type=OSPF6_DEST_TYPE_LINKSTATE;route->path.type
=OSPF6_PATH_TYPE_INTRA;route->path.origin.type=v->lsa->header->type;route->path.
origin.id=v->lsa->header->id;route->path.origin.adv_router=v->lsa->header->adv_r
outer;route->path.metric_type=1;route->path.cost=v->cost;route->path.u.cost_e2=v
->hops;route->path.router_bits=v->capability;route->path.options[0]=v->options[0
];route->path.options[1]=v->options[1];route->path.options[2]=v->options[2];ospf
6_spf_copy_nexthops_to_route(route,v);/**TheSPFlogicimplementationdoesnottransfe
rthemultipathing*properties*ofaparenttoachildnode.Thusiftherewasa3-waymultipatht
oa*node'sparentandasinglehopfromtheparenttothechild,the*logicof*creatingnewverti
cesandcomputingnexthopspreventstherefrom*being3*pathstothechildnode.Thisisprimar
ilybecausetheresolutionof*multipathisdoneinthisroutine,notinthemainspfloop.**The
followinglogicaddressesthatproblembymergingtheparent's*nexthop*informationwithth
echild's,iftheparentisnottherootofthe*tree.*Thisisbasedontheassumptionthatbefore
anode'srouteis*installed,*itsparent'sroute'snexthopshavealreadybeeninstalled.*/i
f(v->parent&&v->parent->hops){parent_route=ospf6_route_lookup(&v->parent->vertex
_id,result_table);if(parent_route){ospf6_route_merge_nexthops(route,parent_route
);}}if(v->parent)listnode_add_sort(v->parent->child_list,v);route->route_option=
v;ospf6_route_add(route,result_table);return0;}voidospf6_spf_table_finish(struct
ospf6_route_table*result_table){structospf6_route*route,*nroute;structospf6_vert
ex*v;for(route=ospf6_route_head(result_table);route;route=nroute){nroute=ospf6_r
oute_next(route);v=(structospf6_vertex*)route->route_option;ospf6_vertex_delete(
v);ospf6_route_remove(route,result_table);}}staticconstchar*ospf6_spf_reason_str
[]={"R+","R-","N+","N-","L+","L-","R*","N*",};voidospf6_spf_reason_string(unsign
edintreason,char*buf,intsize){unsignedintbit;intlen=0;if(!buf)return;for(bit=0;b
it<array_size(ospf6_spf_reason_str);bit++){if((reason&(1<<bit))&&(len<size)){len
+=snprintf((buf+len),(size-len),"%s%s",(len>0)?",":"",ospf6_spf_reason_str[bit])
;}}}/*RFC232816.1.Calculatingtheshortest-pathtreeforanarea*//*RFC27403.8.1.Calcu
latingtheshortestpathtreeforanarea*/voidospf6_spf_calculation(uint32_trouter_id,
structospf6_route_table*result_table,structospf6_area*oa){structpqueue*candidate
_list;structospf6_vertex*root,*v,*w;intsize;caddr_tlsdesc;structospf6_lsa*lsa;st
ructin6_addraddress;ospf6_spf_table_finish(result_table);/*Installthecalculating
routeritselfastherootoftheSPFtree*//*constructrootvertex*/lsa=ospf6_create_singl
e_router_lsa(oa,oa->lsdb_self,router_id);if(lsa==NULL){if(IS_OSPF6_DEBUG_SPF(PRO
CESS))zlog_debug("%s:NorouterLSAforarea%s\n",__func__,oa->name);return;}/*initia
lize*/candidate_list=pqueue_create();candidate_list->cmp=ospf6_vertex_cmp;root=o
spf6_vertex_create(lsa);root->area=oa;root->cost=0;root->hops=0;root->link_id=ls
a->header->id;inet_pton(AF_INET6,"::1",&address);/*Actuallyinsertroottothecandid
ate-listastheonlycandidate*/pqueue_enqueue(root,candidate_list);/*Iterateuntilca
ndidate-listbecomesempty*/while(candidate_list->size){/*getclosestcandidatefromp
riorityqueue*/v=pqueue_dequeue(candidate_list);/*installingmayresultinmergingorr
ejectingofthevertex*/if(ospf6_spf_install(v,result_table)<0)continue;/*Skipoverl
oadedrouters*/if((OSPF6_LSA_IS_TYPE(ROUTER,v->lsa)&&ospf6_router_is_stub_router(
v->lsa)))continue;/*ForeachLSdescriptioninthejust-addedvertexV'sLSA*/size=(VERTE
X_IS_TYPE(ROUTER,v)?sizeof(structospf6_router_lsdesc):sizeof(structospf6_network
_lsdesc));for(lsdesc=OSPF6_LSA_HEADER_END(v->lsa->header)+4;lsdesc+size<=OSPF6_L
SA_END(v->lsa->header);lsdesc+=size){lsa=ospf6_lsdesc_lsa(lsdesc,v);if(lsa==NULL
)continue;if(OSPF6_LSA_IS_MAXAGE(lsa))continue;if(!ospf6_lsdesc_backlink(lsa,lsd
esc,v))continue;w=ospf6_vertex_create(lsa);w->area=oa;w->parent=v;if(VERTEX_IS_T
YPE(ROUTER,v)){w->cost=v->cost+ROUTER_LSDESC_GET_METRIC(lsdesc);w->hops=v->hops+
(VERTEX_IS_TYPE(NETWORK,w)?0:1);}else{/*NETWORK*/w->cost=v->cost;w->hops=v->hops
+1;}/*nexthopcalculation*/if(w->hops==0)ospf6_add_nexthop(w->nh_list,ROUTER_LSDE
SC_GET_IFID(lsdesc),NULL);elseif(w->hops==1&&v->hops==0)ospf6_nexthop_calc(w,v,l
sdesc);elseospf6_copy_nexthops(w->nh_list,v->nh_list);/*addnewcandidatetothecand
idate_list*/if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("Newcandidate:%shops%dcost
%d",w->name,w->hops,w->cost);pqueue_enqueue(w,candidate_list);}}pqueue_delete(ca
ndidate_list);ospf6_remove_temp_router_lsa(oa);oa->spf_calculation++;}staticvoid
ospf6_spf_log_database(structospf6_area*oa){char*p,*end,buffer[256];structlistno
de*node;structospf6_interface*oi;p=buffer;end=buffer+sizeof(buffer);snprintf(p,e
nd-p,"SPFonDB(#LSAs):");p=(buffer+strlen(buffer)<end?buffer+strlen(buffer):end);
snprintf(p,end-p,"Area%s:%d",oa->name,oa->lsdb->count);p=(buffer+strlen(buffer)<
end?buffer+strlen(buffer):end);for(ALL_LIST_ELEMENTS_RO(oa->if_list,node,oi)){sn
printf(p,end-p,"I/F%s:%d",oi->interface->name,oi->lsdb->count);p=(buffer+strlen(
buffer)<end?buffer+strlen(buffer):end);}zlog_debug("%s",buffer);}staticintospf6_
spf_calculation_thread(structthread*t){structospf6_area*oa;structospf6*ospf6;str
ucttimevalstart,end,runtime;structlistnode*node;intareas_processed=0;charrbuf[32
];ospf6=(structospf6*)THREAD_ARG(t);ospf6->t_spf_calc=NULL;/*executeSPFcalculati
on*/monotime(&start);ospf6->ts_spf=start;if(ospf6_is_router_abr(ospf6))ospf6_abr
_range_reset_cost(ospf6);for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,node,oa)){if(
oa==ospf6->backbone)continue;monotime(&oa->ts_spf);if(IS_OSPF6_DEBUG_SPF(PROCESS
))zlog_debug("SPFcalculationforArea%s",oa->name);if(IS_OSPF6_DEBUG_SPF(DATABASE)
)ospf6_spf_log_database(oa);ospf6_spf_calculation(ospf6->router_id,oa->spf_table
,oa);ospf6_intra_route_calculation(oa);ospf6_intra_brouter_calculation(oa);areas
_processed++;}if(ospf6->backbone){monotime(&ospf6->backbone->ts_spf);if(IS_OSPF6
_DEBUG_SPF(PROCESS))zlog_debug("SPFcalculationforBackbonearea%s",ospf6->backbone
->name);if(IS_OSPF6_DEBUG_SPF(DATABASE))ospf6_spf_log_database(ospf6->backbone);
ospf6_spf_calculation(ospf6->router_id,ospf6->backbone->spf_table,ospf6->backbon
e);ospf6_intra_route_calculation(ospf6->backbone);ospf6_intra_brouter_calculatio
n(ospf6->backbone);areas_processed++;}if(ospf6_is_router_abr(ospf6))ospf6_abr_de
faults_to_stub(ospf6);monotime(&end);timersub(&end,&start,&runtime);ospf6->ts_sp
f_duration=runtime;ospf6_spf_reason_string(ospf6->spf_reason,rbuf,sizeof(rbuf));
if(IS_OSPF6_DEBUG_SPF(PROCESS)||IS_OSPF6_DEBUG_SPF(TIME))zlog_debug("SPFruntime:
%lldsec%lldusec",(longlong)runtime.tv_sec,(longlong)runtime.tv_usec);zlog_info("
SPFprocessing:#Areas:%d,SPFruntime:%lldsec%lldusec,""Reason:%s\n",areas_processe
d,(longlong)runtime.tv_sec,(longlong)runtime.tv_usec,rbuf);ospf6->last_spf_reaso
n=ospf6->spf_reason;ospf6_reset_spf_reason(ospf6);return0;}/*AddscheduleforSPFca
lculation.ToavoidfrequenstSPFcalc,wesettimerforSPFcalc.*/voidospf6_spf_schedule(
structospf6*ospf6,unsignedintreason){unsignedlongdelay,elapsed,ht;ospf6_set_spf_
reason(ospf6,reason);if(IS_OSPF6_DEBUG_SPF(PROCESS)||IS_OSPF6_DEBUG_SPF(TIME)){c
harrbuf[32];ospf6_spf_reason_string(reason,rbuf,sizeof(rbuf));zlog_debug("SPF:ca
lculationtimerscheduled(reason%s)",rbuf);}/*OSPFinstancedoesnotexist.*/if(ospf6=
=NULL)return;/*SPFcalculationtimerisalreadyscheduled.*/if(ospf6->t_spf_calc){if(
IS_OSPF6_DEBUG_SPF(PROCESS)||IS_OSPF6_DEBUG_SPF(TIME))zlog_debug("SPF:calculatio
ntimerisalreadyscheduled:%p",(void*)ospf6->t_spf_calc);return;}elapsed=monotime_
since(&ospf6->ts_spf,NULL)/1000LL;ht=ospf6->spf_holdtime*ospf6->spf_hold_multipl
ier;if(ht>ospf6->spf_max_holdtime)ht=ospf6->spf_max_holdtime;/*GetSPFcalculation
delaytime.*/if(elapsed<ht){/*GotaneventwithintheholdtimeoflastSPF.Weneedto*incre
asethehold_multiplier,ifit'snotalreadyat/past*maximumvalue,andwasn'talreadyincre
ased..*/if(ht<ospf6->spf_max_holdtime)ospf6->spf_hold_multiplier++;/*alwayshonou
rtheSPFinitialdelay*/if((ht-elapsed)<ospf6->spf_delay)delay=ospf6->spf_delay;els
edelay=ht-elapsed;}else{/*Eventispastrequiredhold-timeoflastSPF*/delay=ospf6->sp
f_delay;ospf6->spf_hold_multiplier=1;}if(IS_OSPF6_DEBUG_SPF(PROCESS)||IS_OSPF6_D
EBUG_SPF(TIME))zlog_debug("SPF:calculationtimerdelay=%ld",delay);zlog_info("SPF:
Scheduledin%ldmsec",delay);ospf6->t_spf_calc=NULL;thread_add_timer_msec(master,o
spf6_spf_calculation_thread,ospf6,delay,&ospf6->t_spf_calc);}voidospf6_spf_displ
ay_subtree(structvty*vty,constchar*prefix,intrest,structospf6_vertex*v){structli
stnode*node,*nnode;structospf6_vertex*c;char*next_prefix;intlen;intrestnum;/*"pr
efix"isthespaceprefixofthedisplayline*/vty_out(vty,"%s+-%s[%d]\n",prefix,v->name
,v->cost);len=strlen(prefix)+4;next_prefix=(char*)malloc(len);if(next_prefix==NU
LL){vty_out(vty,"mallocfailed\n");return;}snprintf(next_prefix,len,"%s%s",prefix
,(rest?"|":""));restnum=listcount(v->child_list);for(ALL_LIST_ELEMENTS(v->child_
list,node,nnode,c)){restnum--;ospf6_spf_display_subtree(vty,next_prefix,restnum,
c);}free(next_prefix);}DEFUN(debug_ospf6_spf_process,debug_ospf6_spf_process_cmd
,"debugospf6spfprocess",DEBUG_STROSPF6_STR"DebugSPFCalculation\n""DebugDetailedS
PFProcess\n"){unsignedcharlevel=0;level=OSPF6_DEBUG_SPF_PROCESS;OSPF6_DEBUG_SPF_
ON(level);returnCMD_SUCCESS;}DEFUN(debug_ospf6_spf_time,debug_ospf6_spf_time_cmd
,"debugospf6spftime",DEBUG_STROSPF6_STR"DebugSPFCalculation\n""Measuretimetakenb
ySPFCalculation\n"){unsignedcharlevel=0;level=OSPF6_DEBUG_SPF_TIME;OSPF6_DEBUG_S
PF_ON(level);returnCMD_SUCCESS;}DEFUN(debug_ospf6_spf_database,debug_ospf6_spf_d
atabase_cmd,"debugospf6spfdatabase",DEBUG_STROSPF6_STR"DebugSPFCalculation\n""Lo
gnumberofLSAsatSPFCalculationtime\n"){unsignedcharlevel=0;level=OSPF6_DEBUG_SPF_
DATABASE;OSPF6_DEBUG_SPF_ON(level);returnCMD_SUCCESS;}DEFUN(no_debug_ospf6_spf_p
rocess,no_debug_ospf6_spf_process_cmd,"nodebugospf6spfprocess",NO_STRDEBUG_STROS
PF6_STR"QuitDebuggingSPFCalculation\n""QuitDebuggingDetailedSPFProcess\n"){unsig
nedcharlevel=0;level=OSPF6_DEBUG_SPF_PROCESS;OSPF6_DEBUG_SPF_OFF(level);returnCM
D_SUCCESS;}DEFUN(no_debug_ospf6_spf_time,no_debug_ospf6_spf_time_cmd,"nodebugosp
f6spftime",NO_STRDEBUG_STROSPF6_STR"QuitDebuggingSPFCalculation\n""QuitMeasuring
timetakenbySPFCalculation\n"){unsignedcharlevel=0;level=OSPF6_DEBUG_SPF_TIME;OSP
F6_DEBUG_SPF_OFF(level);returnCMD_SUCCESS;}DEFUN(no_debug_ospf6_spf_database,no_
debug_ospf6_spf_database_cmd,"nodebugospf6spfdatabase",NO_STRDEBUG_STROSPF6_STR"
DebugSPFCalculation\n""QuitLoggingnumberofLSAsatSPFCalculationtime\n"){unsignedc
harlevel=0;level=OSPF6_DEBUG_SPF_DATABASE;OSPF6_DEBUG_SPF_OFF(level);returnCMD_S
UCCESS;}staticintospf6_timers_spf_set(structvty*vty,unsignedintdelay,unsignedint
hold,unsignedintmax){VTY_DECLVAR_CONTEXT(ospf6,ospf);ospf->spf_delay=delay;ospf-
>spf_holdtime=hold;ospf->spf_max_holdtime=max;returnCMD_SUCCESS;}DEFUN(ospf6_tim
ers_throttle_spf,ospf6_timers_throttle_spf_cmd,"timersthrottlespf(0-600000)(0-60
0000)(0-600000)","Adjustroutingtimers\n""Throttlingadaptivetimer\n""OSPF6SPFtime
rs\n""Delay(msec)fromfirstchangereceivedtillSPFcalculation\n""Initialholdtime(ms
ec)betweenconsecutiveSPFcalculations\n""Maximumholdtime(msec)\n"){intidx_number=
3;intidx_number_2=4;intidx_number_3=5;unsignedintdelay,hold,max;delay=strtoul(ar
gv[idx_number]->arg,NULL,10);hold=strtoul(argv[idx_number_2]->arg,NULL,10);max=s
trtoul(argv[idx_number_3]->arg,NULL,10);returnospf6_timers_spf_set(vty,delay,hol
d,max);}DEFUN(no_ospf6_timers_throttle_spf,no_ospf6_timers_throttle_spf_cmd,"not
imersthrottlespf[(0-600000)(0-600000)(0-600000)]",NO_STR"Adjustroutingtimers\n""
Throttlingadaptivetimer\n""OSPF6SPFtimers\n""Delay(msec)fromfirstchangereceivedt
illSPFcalculation\n""Initialholdtime(msec)betweenconsecutiveSPFcalculations\n""M
aximumholdtime(msec)\n"){returnospf6_timers_spf_set(vty,OSPF_SPF_DELAY_DEFAULT,O
SPF_SPF_HOLDTIME_DEFAULT,OSPF_SPF_MAX_HOLDTIME_DEFAULT);}intconfig_write_ospf6_d
ebug_spf(structvty*vty){if(IS_OSPF6_DEBUG_SPF(PROCESS))vty_out(vty,"debugospf6sp
fprocess\n");if(IS_OSPF6_DEBUG_SPF(TIME))vty_out(vty,"debugospf6spftime\n");if(I
S_OSPF6_DEBUG_SPF(DATABASE))vty_out(vty,"debugospf6spfdatabase\n");return0;}void
ospf6_spf_config_write(structvty*vty){if(ospf6->spf_delay!=OSPF_SPF_DELAY_DEFAUL
T||ospf6->spf_holdtime!=OSPF_SPF_HOLDTIME_DEFAULT||ospf6->spf_max_holdtime!=OSPF
_SPF_MAX_HOLDTIME_DEFAULT)vty_out(vty,"timersthrottlespf%d%d%d\n",ospf6->spf_del
ay,ospf6->spf_holdtime,ospf6->spf_max_holdtime);}voidinstall_element_ospf6_debug
_spf(void){install_element(ENABLE_NODE,&debug_ospf6_spf_process_cmd);install_ele
ment(ENABLE_NODE,&debug_ospf6_spf_time_cmd);install_element(ENABLE_NODE,&debug_o
spf6_spf_database_cmd);install_element(ENABLE_NODE,&no_debug_ospf6_spf_process_c
md);install_element(ENABLE_NODE,&no_debug_ospf6_spf_time_cmd);install_element(EN
ABLE_NODE,&no_debug_ospf6_spf_database_cmd);install_element(CONFIG_NODE,&debug_o
spf6_spf_process_cmd);install_element(CONFIG_NODE,&debug_ospf6_spf_time_cmd);ins
tall_element(CONFIG_NODE,&debug_ospf6_spf_database_cmd);install_element(CONFIG_N
ODE,&no_debug_ospf6_spf_process_cmd);install_element(CONFIG_NODE,&no_debug_ospf6
_spf_time_cmd);install_element(CONFIG_NODE,&no_debug_ospf6_spf_database_cmd);}vo
idospf6_spf_init(void){install_element(OSPF6_NODE,&ospf6_timers_throttle_spf_cmd
);install_element(OSPF6_NODE,&no_ospf6_timers_throttle_spf_cmd);}/*CreateAggrega
tedLargeRouter-LSAfrommultipleLink-StateIDs*RFC5340A4.3:*Whenmorethanonerouter-L
SAisreceivedfromasinglerouter,*thelinksareprocessedasifconcatenatedintoasingleLS
A.*/structospf6_lsa*ospf6_create_single_router_lsa(structospf6_area*area,structo
spf6_lsdb*lsdb,uint32_tadv_router){structospf6_lsa*lsa=NULL;structospf6_lsa*rtr_
lsa=NULL;structospf6_lsa_header*lsa_header=NULL;uint8_t*new_header=NULL;conststr
uctroute_node*end=NULL;uint16_tlsa_length,total_lsa_length=0,num_lsa=0;uint16_tt
ype=0;charifbuf[16];uint32_tinterface_id;caddr_tlsd;lsa_length=sizeof(structospf
6_lsa_header)+sizeof(structospf6_router_lsa);total_lsa_length=lsa_length;type=ht
ons(OSPF6_LSTYPE_ROUTER);/*FirstcheckAggregatedLSAformedearlierinCache*/lsa=ospf
6_lsdb_lookup(type,htonl(0),adv_router,area->temp_router_lsa_lsdb);if(lsa)return
lsa;inet_ntop(AF_INET,&adv_router,ifbuf,sizeof(ifbuf));/*DeterminetotalLSAlength
fromalllinkstateids*/end=ospf6_lsdb_head(lsdb,2,type,adv_router,&rtr_lsa);while(
rtr_lsa){lsa=rtr_lsa;if(OSPF6_LSA_IS_MAXAGE(rtr_lsa)){rtr_lsa=ospf6_lsdb_next(en
d,rtr_lsa);continue;}lsa_header=(structospf6_lsa_header*)rtr_lsa->header;total_l
sa_length+=(ntohs(lsa_header->length)-lsa_length);num_lsa++;rtr_lsa=ospf6_lsdb_n
ext(end,rtr_lsa);}if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("%s:adv_router%snum_
lsa%utoconvert.",__PRETTY_FUNCTION__,ifbuf,num_lsa);if(num_lsa==1)returnlsa;if(n
um_lsa==0){if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("%s:adv_router%snotfoundinL
SDB.",__PRETTY_FUNCTION__,ifbuf);returnNULL;}/*AllocatememoryforthisLSA*/new_hea
der=XMALLOC(MTYPE_OSPF6_LSA_HEADER,total_lsa_length);if(!new_header)returnNULL;/
*LSAinformationstructure*/lsa=(structospf6_lsa*)XCALLOC(MTYPE_OSPF6_LSA,sizeof(s
tructospf6_lsa));if(!lsa){free(new_header);returnNULL;}lsa->header=(structospf6_
lsa_header*)new_header;lsa->lsdb=area->temp_router_lsa_lsdb;/*FillLargerLSAPaylo
ad*/end=ospf6_lsdb_head(lsdb,2,type,adv_router,&rtr_lsa);/**Weassumeatthispointi
ntimethatrtr_lsais*avalidpointer.*/assert(rtr_lsa);if(!OSPF6_LSA_IS_MAXAGE(rtr_l
sa)){/*AppendfirstLinkStateIDLSA*/lsa_header=(structospf6_lsa_header*)rtr_lsa->h
eader;memcpy(new_header,lsa_header,ntohs(lsa_header->length));/*Assignnewlsaleng
thasaggregatedlength.*/((structospf6_lsa_header*)new_header)->length=htons(total
_lsa_length);new_header+=ntohs(lsa_header->length);num_lsa--;}/*PrintLSAName*/os
pf6_lsa_printbuf(lsa,lsa->name,sizeof(lsa->name));rtr_lsa=ospf6_lsdb_next(end,rt
r_lsa);while(rtr_lsa){if(OSPF6_LSA_IS_MAXAGE(rtr_lsa)){rtr_lsa=ospf6_lsdb_next(e
nd,rtr_lsa);continue;}if(IS_OSPF6_DEBUG_SPF(PROCESS)){lsd=OSPF6_LSA_HEADER_END(r
tr_lsa->header)+4;interface_id=ROUTER_LSDESC_GET_IFID(lsd);inet_ntop(AF_INET,&in
terface_id,ifbuf,sizeof(ifbuf));zlog_debug("%s:NextRouterLSA%stoaggreatwithlen%u
interface_id%s",__PRETTY_FUNCTION__,rtr_lsa->name,ntohs(lsa_header->length),ifbu
f);}/*AppendNextLinkStateIDLSA*/lsa_header=(structospf6_lsa_header*)rtr_lsa->hea
der;memcpy(new_header,(OSPF6_LSA_HEADER_END(rtr_lsa->header)+4),(ntohs(lsa_heade
r->length)-lsa_length));new_header+=(ntohs(lsa_header->length)-lsa_length);num_l
sa--;rtr_lsa=ospf6_lsdb_next(end,rtr_lsa);}/*Calculatebirthofthislsa*/ospf6_lsa_
age_set(lsa);/*StoreAggregatedLSAintoareatemplsdb*/ospf6_lsdb_add(lsa,area->temp
_router_lsa_lsdb);if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("%s:LSA%sid%utype0%x
len%unum_lsa%u",__PRETTY_FUNCTION__,lsa->name,ntohl(lsa->header->id),ntohs(lsa->
header->type),ntohs(lsa->header->length),num_lsa);returnlsa;}voidospf6_remove_te
mp_router_lsa(structospf6_area*area){structospf6_lsa*lsa=NULL;for(ALL_LSDB(area-
>temp_router_lsa_lsdb,lsa)){if(IS_OSPF6_DEBUG_SPF(PROCESS))zlog_debug("%sRemoveL
SA%slsa->lock%ulsdbcount%u",__PRETTY_FUNCTION__,lsa->name,lsa->lock,area->temp_r
outer_lsa_lsdb->count);ospf6_lsdb_remove(lsa,area->temp_router_lsa_lsdb);}}