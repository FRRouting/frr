/**AreaBorderRouterfunction.*Copyright(C)2004YasuhiroOhara**ThisfileispartofGNUZ
ebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsof
theGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2
,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeus
eful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFIT
NESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshou
ldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileC
OPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Bost
on,MA02110-1301USA*/#include<zebra.h>#include"log.h"#include"prefix.h"#include"t
able.h"#include"vty.h"#include"linklist.h"#include"command.h"#include"thread.h"#
include"plist.h"#include"filter.h"#include"ospf6_proto.h"#include"ospf6_route.h"
#include"ospf6_lsa.h"#include"ospf6_route.h"#include"ospf6_lsdb.h"#include"ospf6
_message.h"#include"ospf6_zebra.h"#include"ospf6_top.h"#include"ospf6_area.h"#in
clude"ospf6_interface.h"#include"ospf6_neighbor.h"#include"ospf6_flood.h"#includ
e"ospf6_intra.h"#include"ospf6_abr.h"#include"ospf6d.h"unsignedcharconf_debug_os
pf6_abr;intospf6_is_router_abr(structospf6*o){structlistnode*node;structospf6_ar
ea*oa;intarea_count=0;for(ALL_LIST_ELEMENTS_RO(o->area_list,node,oa))if(IS_AREA_
ENABLED(oa))area_count++;if(area_count>1)return1;return0;}staticintospf6_abr_nex
thops_belong_to_area(structospf6_route*route,structospf6_area*area){structospf6_
interface*oi;oi=ospf6_interface_lookup_by_ifindex(ospf6_route_get_first_nh_index
(route));if(oi&&oi->area&&oi->area==area)return1;elsereturn0;}staticvoidospf6_ab
r_delete_route(structospf6_route*range,structospf6_route*summary,structospf6_rou
te_table*summary_table,structospf6_lsa*old){if(summary){ospf6_route_remove(summa
ry,summary_table);}if(old&&!OSPF6_LSA_IS_MAXAGE(old))ospf6_lsa_purge(old);}voido
spf6_abr_enable_area(structospf6_area*area){structospf6_area*oa;structlistnode*n
ode,*nnode;for(ALL_LIST_ELEMENTS(area->ospf6->area_list,node,nnode,oa))/*updateB
bitforeacharea*/OSPF6_ROUTER_LSA_SCHEDULE(oa);}voidospf6_abr_disable_area(struct
ospf6_area*area){structospf6_area*oa;structospf6_route*ro,*nro;structospf6_lsa*o
ld;structlistnode*node,*nnode;/*Withdrawallsummaryprefixespreviouslyoriginated*/
for(ro=ospf6_route_head(area->summary_prefix);ro;ro=nro){nro=ospf6_route_next(ro
);old=ospf6_lsdb_lookup(ro->path.origin.type,ro->path.origin.id,area->ospf6->rou
ter_id,area->lsdb);if(old)ospf6_lsa_purge(old);ospf6_route_remove(ro,area->summa
ry_prefix);}/*Withdrawallsummaryrouter-routespreviouslyoriginated*/for(ro=ospf6_
route_head(area->summary_router);ro;ro=nro){nro=ospf6_route_next(ro);old=ospf6_l
sdb_lookup(ro->path.origin.type,ro->path.origin.id,area->ospf6->router_id,area->
lsdb);if(old)ospf6_lsa_purge(old);ospf6_route_remove(ro,area->summary_router);}/
*ScheduleRouter-LSAforeacharea(ABRstatusmaychange)*/for(ALL_LIST_ELEMENTS(area->
ospf6->area_list,node,nnode,oa))/*updateBbitforeacharea*/OSPF6_ROUTER_LSA_SCHEDU
LE(oa);}/*RFC232812.4.3.Summary-LSAs*//*Returns1ifasummaryLSAhasbeengeneratedfor
thearea*//*Thisisusedbythearea/rangelogictoadd/removeblackholeroutes*/intospf6_a
br_originate_summary_to_area(structospf6_route*route,structospf6_area*area){stru
ctospf6_lsa*lsa,*old=NULL;structospf6_route*summary,*range=NULL;structospf6_area
*route_area;charbuffer[OSPF6_MAX_LSASIZE];structospf6_lsa_header*lsa_header;cadd
r_tp;structospf6_inter_prefix_lsa*prefix_lsa;structospf6_inter_router_lsa*router
_lsa;structospf6_route_table*summary_table=NULL;uint16_ttype;charbuf[PREFIX2STR_
BUFFER];intis_debug=0;/*Onlydestinationtypenetwork,rangeorASBRareconsidered*/if(
route->type!=OSPF6_DEST_TYPE_NETWORK&&route->type!=OSPF6_DEST_TYPE_RANGE&&((rout
e->type!=OSPF6_DEST_TYPE_ROUTER)||!CHECK_FLAG(route->path.router_bits,OSPF6_ROUT
ER_BIT_E))){if(is_debug)zlog_debug("Routetypeisnoneofnetwork,rangenorASBR,ignore
");return0;}/*ASExternalroutesareneverconsidered*/if(route->path.type==OSPF6_PAT
H_TYPE_EXTERNAL1||route->path.type==OSPF6_PATH_TYPE_EXTERNAL2){if(is_debug)zlog_
debug("Pathtypeisexternal,skip");return0;}/*donotgenerateifthepath'sareaisthesam
eastargetarea*/if(route->path.area_id==area->area_id){if(is_debug)zlog_debug("Th
erouteisintheareaitself,ignore");return0;}/*donotgenerateifthenexthopsbelongstot
hetargetarea*/if(ospf6_abr_nexthops_belong_to_area(route,area)){if(is_debug)zlog
_debug("Theroute'snexthopisinthesamearea,ignore");return0;}if(route->type==OSPF6
_DEST_TYPE_ROUTER){if(ADV_ROUTER_IN_PREFIX(&route->prefix)==area->ospf6->router_
id){inet_ntop(AF_INET,&(ADV_ROUTER_IN_PREFIX(&route->prefix)),buf,sizeof(buf));z
log_debug("%s:SkippingASBRannouncementforABR(%s)",__func__,buf);return0;}}if(rou
te->type==OSPF6_DEST_TYPE_ROUTER){if(IS_OSPF6_DEBUG_ABR||IS_OSPF6_DEBUG_ORIGINAT
E(INTER_ROUTER)){is_debug++;inet_ntop(AF_INET,&(ADV_ROUTER_IN_PREFIX(&route->pre
fix)),buf,sizeof(buf));zlog_debug("Originatingsummaryinarea%sforASBR%s",area->na
me,buf);}summary_table=area->summary_router;}else{if(IS_OSPF6_DEBUG_ABR||IS_OSPF
6_DEBUG_ORIGINATE(INTER_PREFIX)){is_debug++;prefix2str(&route->prefix,buf,sizeof
(buf));zlog_debug("Originatingsummaryinarea%sfor%s",area->name,buf);}summary_tab
le=area->summary_prefix;}summary=ospf6_route_lookup(&route->prefix,summary_table
);if(summary)old=ospf6_lsdb_lookup(summary->path.origin.type,summary->path.origi
n.id,area->ospf6->router_id,area->lsdb);/*ifthisroutehasjustremoved,removecorres
pondingLSA*/if(CHECK_FLAG(route->flag,OSPF6_ROUTE_REMOVE)){if(is_debug)zlog_debu
g("Theroutehasjustremoved,purgepreviousLSA");if(route->type==OSPF6_DEST_TYPE_RAN
GE){/*Whethertheroutehaveactivelongerprefix*/if(!CHECK_FLAG(route->flag,OSPF6_RO
UTE_ACTIVE_SUMMARY)){if(is_debug)zlog_debug("Therangeisnotactive.withdraw");ospf
6_abr_delete_route(route,summary,summary_table,old);}}elseif(old)ospf6_lsa_purge
(old);return0;}if((route->type==OSPF6_DEST_TYPE_ROUTER)&&IS_AREA_STUB(area)){if(
is_debug)zlog_debug("Areahasbeenstubbed,purgeInter-RouterLSA");ospf6_abr_delete_
route(route,summary,summary_table,old);return0;}if(area->no_summary&&(route->pat
h.subtype!=OSPF6_PATH_SUBTYPE_DEFAULT_RT)){if(is_debug)zlog_debug("Areahasbeenst
ubbed,purgeprefixLSA");ospf6_abr_delete_route(route,summary,summary_table,old);r
eturn0;}/*donotgenerateiftheroutecostisgreaterorequaltoLSInfinity*/if(route->pat
h.cost>=OSPF_LS_INFINITY){/*Whenwe'reclearingtherangeroutebecauseallactive*prefi
xes*undertherangearegone,wesettherange'scostto*OSPF_AREA_RANGE_COST_UNSPEC,which
is>OSPF_LS_INFINITY.We*don'twanttotriggerthecodehereforthat.Thiscodeis*for*handl
ingroutesthathavegonetoinfinity.Therangeremoval*happens*elsewhere.*/if((route->t
ype!=OSPF6_DEST_TYPE_RANGE)&&(route->path.cost!=OSPF_AREA_RANGE_COST_UNSPEC)){if
(is_debug)zlog_debug("ThecostexceedsLSInfinity,withdraw");if(old)ospf6_lsa_purge
(old);return0;}}/*ifthisisaroutetoASBR*/if(route->type==OSPF6_DEST_TYPE_ROUTER){
/*Onlythepreferedbestpathisconsidered*/if(!CHECK_FLAG(route->flag,OSPF6_ROUTE_BE
ST)){if(is_debug)zlog_debug("ThisisthesecondarypathtotheASBR,ignore");ospf6_abr_
delete_route(route,summary,summary_table,old);return0;}/*Donotgenerateiftheareai
sstub*//*XXX*/}/*ifthisisanintra-arearoute,thismaybesuppressedbyaggregation*/if(
route->type==OSPF6_DEST_TYPE_NETWORK&&route->path.type==OSPF6_PATH_TYPE_INTRA){/
*searchforconfiguredaddressrangefortheroute'sarea*/route_area=ospf6_area_lookup(
route->path.area_id,area->ospf6);assert(route_area);range=ospf6_route_lookup_bes
tmatch(&route->prefix,route_area->range_table);/*rangesareignoredwhenoriginateba
ckboneroutestotransitarea.Otherwise,ifrangesareconfigured,therouteissuppressed.*
/if(range&&!CHECK_FLAG(range->flag,OSPF6_ROUTE_REMOVE)&&(route->path.area_id!=OS
PF_AREA_BACKBONE||!IS_AREA_TRANSIT(area))){if(is_debug){prefix2str(&range->prefi
x,buf,sizeof(buf));zlog_debug("Suppressedbyrange%sofarea%s",buf,route_area->name
);}ospf6_abr_delete_route(route,summary,summary_table,old);return0;}}/*Ifthisisa
configuredaddressrange*/if(route->type==OSPF6_DEST_TYPE_RANGE){/*IfDoNotAdvertis
eisset*/if(CHECK_FLAG(route->flag,OSPF6_ROUTE_DO_NOT_ADVERTISE)){if(is_debug)zlo
g_debug("ThisistherangewithDoNotAdvertiseset.ignore");ospf6_abr_delete_route(rou
te,summary,summary_table,old);return0;}/*Iftherearenoactiveprefixesinthisrange,r
emove*/if(!CHECK_FLAG(route->flag,OSPF6_ROUTE_ACTIVE_SUMMARY)){if(is_debug)zlog_
debug("Therangeisnotactive.withdraw");ospf6_abr_delete_route(route,summary,summa
ry_table,old);return0;}}/*Checkexportlist*/if(EXPORT_NAME(area)){if(EXPORT_LIST(
area)==NULL)EXPORT_LIST(area)=access_list_lookup(AFI_IP6,EXPORT_NAME(area));if(E
XPORT_LIST(area))if(access_list_apply(EXPORT_LIST(area),&route->prefix)==FILTER_
DENY){if(is_debug){inet_ntop(AF_INET,&(ADV_ROUTER_IN_PREFIX(&route->prefix)),buf
,sizeof(buf));zlog_debug("prefix%swasdeniedbyexportlist",buf);}return0;}}/*Check
filter-list*/if(PREFIX_LIST_OUT(area))if(prefix_list_apply(PREFIX_LIST_OUT(area)
,&route->prefix)!=PREFIX_PERMIT){if(is_debug){inet_ntop(AF_INET,&(ADV_ROUTER_IN_
PREFIX(&route->prefix)),buf,sizeof(buf));zlog_debug("prefix%swasdeniedbyfilter-l
istout",buf);}return0;}/*therouteisgoingtobeoriginated.storeitinarea'ssummary_ta
ble*/if(summary==NULL){summary=ospf6_route_copy(route);summary->path.origin.adv_
router=area->ospf6->router_id;if(route->type==OSPF6_DEST_TYPE_ROUTER){summary->p
ath.origin.type=htons(OSPF6_LSTYPE_INTER_ROUTER);summary->path.origin.id=ADV_ROU
TER_IN_PREFIX(&route->prefix);}else{summary->path.origin.type=htons(OSPF6_LSTYPE
_INTER_PREFIX);summary->path.origin.id=ospf6_new_ls_id(summary->path.origin.type
,summary->path.origin.adv_router,area->lsdb);}summary=ospf6_route_add(summary,su
mmary_table);}else{summary->type=route->type;monotime(&summary->changed);}summar
y->path.router_bits=route->path.router_bits;summary->path.options[0]=route->path
.options[0];summary->path.options[1]=route->path.options[1];summary->path.option
s[2]=route->path.options[2];summary->path.prefix_options=route->path.prefix_opti
ons;summary->path.area_id=area->area_id;summary->path.type=OSPF6_PATH_TYPE_INTER
;summary->path.subtype=route->path.subtype;summary->path.cost=route->path.cost;/
*summary->nexthop[0]=route->nexthop[0];*//*preparebuffer*/memset(buffer,0,sizeof
(buffer));lsa_header=(structospf6_lsa_header*)buffer;if(route->type==OSPF6_DEST_
TYPE_ROUTER){router_lsa=(structospf6_inter_router_lsa*)((caddr_t)lsa_header+size
of(structospf6_lsa_header));p=(caddr_t)router_lsa+sizeof(structospf6_inter_route
r_lsa);/*FillInter-Area-Router-LSA*/router_lsa->options[0]=route->path.options[0
];router_lsa->options[1]=route->path.options[1];router_lsa->options[2]=route->pa
th.options[2];OSPF6_ABR_SUMMARY_METRIC_SET(router_lsa,route->path.cost);router_l
sa->router_id=ADV_ROUTER_IN_PREFIX(&route->prefix);type=htons(OSPF6_LSTYPE_INTER
_ROUTER);}else{prefix_lsa=(structospf6_inter_prefix_lsa*)((caddr_t)lsa_header+si
zeof(structospf6_lsa_header));p=(caddr_t)prefix_lsa+sizeof(structospf6_inter_pre
fix_lsa);/*FillInter-Area-Prefix-LSA*/OSPF6_ABR_SUMMARY_METRIC_SET(prefix_lsa,ro
ute->path.cost);prefix_lsa->prefix.prefix_length=route->prefix.prefixlen;prefix_
lsa->prefix.prefix_options=route->path.prefix_options;/*setPrefix*/memcpy(p,&rou
te->prefix.u.prefix6,OSPF6_PREFIX_SPACE(route->prefix.prefixlen));ospf6_prefix_a
pply_mask(&prefix_lsa->prefix);p+=OSPF6_PREFIX_SPACE(route->prefix.prefixlen);ty
pe=htons(OSPF6_LSTYPE_INTER_PREFIX);}/*FillLSAHeader*/lsa_header->age=0;lsa_head
er->type=type;lsa_header->id=summary->path.origin.id;lsa_header->adv_router=area
->ospf6->router_id;lsa_header->seqnum=ospf6_new_ls_seqnum(lsa_header->type,lsa_h
eader->id,lsa_header->adv_router,area->lsdb);lsa_header->length=htons((caddr_t)p
-(caddr_t)lsa_header);/*LSAchecksum*/ospf6_lsa_checksum(lsa_header);/*createLSA*
/lsa=ospf6_lsa_create(lsa_header);/*Originate*/ospf6_lsa_originate_area(lsa,area
);return1;}voidospf6_abr_range_reset_cost(structospf6*ospf6){structlistnode*node
,*nnode;structospf6_area*oa;structospf6_route*range;for(ALL_LIST_ELEMENTS(ospf6-
>area_list,node,nnode,oa))for(range=ospf6_route_head(oa->range_table);range;rang
e=ospf6_route_next(range))OSPF6_ABR_RANGE_CLEAR_COST(range);}staticinlineuint32_
tospf6_abr_range_compute_cost(structospf6_route*range,structospf6*o){structospf6
_route*ro;uint32_tcost=0;for(ro=ospf6_route_match_head(&range->prefix,o->route_t
able);ro;ro=ospf6_route_match_next(&range->prefix,ro)){if(ro->path.area_id==rang
e->path.area_id&&(ro->path.type==OSPF6_PATH_TYPE_INTRA)&&!CHECK_FLAG(ro->flag,OS
PF6_ROUTE_REMOVE))cost=MAX(cost,ro->path.cost);}returncost;}staticinlineintospf6
_abr_range_summary_needs_update(structospf6_route*range,uint32_tcost){intredo_su
mmary=0;if(CHECK_FLAG(range->flag,OSPF6_ROUTE_REMOVE)){UNSET_FLAG(range->flag,OS
PF6_ROUTE_ACTIVE_SUMMARY);redo_summary=1;}elseif(CHECK_FLAG(range->flag,OSPF6_RO
UTE_DO_NOT_ADVERTISE)){if(range->path.cost!=0){range->path.cost=0;redo_summary=1
;}}elseif(cost){if((OSPF6_PATH_COST_IS_CONFIGURED(range->path)&&range->path.cost
!=range->path.u.cost_config)){range->path.cost=range->path.u.cost_config;SET_FLA
G(range->flag,OSPF6_ROUTE_ACTIVE_SUMMARY);redo_summary=1;}elseif(!OSPF6_PATH_COS
T_IS_CONFIGURED(range->path)&&range->path.cost!=cost){range->path.cost=cost;SET_
FLAG(range->flag,OSPF6_ROUTE_ACTIVE_SUMMARY);redo_summary=1;}}elseif(CHECK_FLAG(
range->flag,OSPF6_ROUTE_ACTIVE_SUMMARY)){/*Costiszero,meaningnoactiverange*/UNSE
T_FLAG(range->flag,OSPF6_ROUTE_ACTIVE_SUMMARY);range->path.cost=OSPF_AREA_RANGE_
COST_UNSPEC;redo_summary=1;}return(redo_summary);}staticvoidospf6_abr_range_upda
te(structospf6_route*range){uint32_tcost=0;structlistnode*node,*nnode;structospf
6_area*oa;intsummary_orig=0;assert(range->type==OSPF6_DEST_TYPE_RANGE);/*updater
ange'scostandactiveflag*/cost=ospf6_abr_range_compute_cost(range,ospf6);/*Non-ze
rocostisaproxyforactivelongerprefixesinthisrange.*Ifthereareactiveroutescoveredb
ythisrangeANDeitherthe*configured*costhaschangedorthesummarizedcosthaschangedthe
nredo*summaries.*Alternately,iftherearenolongeractiveprefixesandthereare*summary
announcements,withdrawthoseannouncements.**Thedon'tadvertisecodereliesonthepath.
costbeingsettoUNSPEC*to*workthefirsttime.Subsequenttimesthepath.costisnot0anyway
*ifthere*wereactiveranges.*/if(ospf6_abr_range_summary_needs_update(range,cost))
{for(ALL_LIST_ELEMENTS(ospf6->area_list,node,nnode,oa))summary_orig+=ospf6_abr_o
riginate_summary_to_area(range,oa);if(CHECK_FLAG(range->flag,OSPF6_ROUTE_ACTIVE_
SUMMARY)&&summary_orig){if(!CHECK_FLAG(range->flag,OSPF6_ROUTE_BLACKHOLE_ADDED))
{if(IS_OSPF6_DEBUG_ABR)zlog_debug("Adddiscardroute");ospf6_zebra_add_discard(ran
ge);}}else{/*Summaryremovedornosummarygeneratedasno*specificsexist*/if(CHECK_FLA
G(range->flag,OSPF6_ROUTE_BLACKHOLE_ADDED)){if(IS_OSPF6_DEBUG_ABR)zlog_debug("De
letediscardroute");ospf6_zebra_delete_discard(range);}}}}voidospf6_abr_originate
_summary(structospf6_route*route){structlistnode*node,*nnode;structospf6_area*oa
;structospf6_route*range=NULL;if(route->type==OSPF6_DEST_TYPE_NETWORK){oa=ospf6_
area_lookup(route->path.area_id,ospf6);range=ospf6_route_lookup_bestmatch(&route
->prefix,oa->range_table);if(range){ospf6_abr_range_update(range);}}for(ALL_LIST
_ELEMENTS(ospf6->area_list,node,nnode,oa))ospf6_abr_originate_summary_to_area(ro
ute,oa);}voidospf6_abr_defaults_to_stub(structospf6*o){structlistnode*node,*nnod
e;structospf6_area*oa;structospf6_route*def,*route;if(!o->backbone)return;def=os
pf6_route_create();def->type=OSPF6_DEST_TYPE_NETWORK;def->prefix.family=AF_INET6
;def->prefix.prefixlen=0;memset(&def->prefix.u.prefix6,0,sizeof(structin6_addr))
;def->type=OSPF6_DEST_TYPE_NETWORK;def->path.type=OSPF6_PATH_TYPE_INTER;def->pat
h.subtype=OSPF6_PATH_SUBTYPE_DEFAULT_RT;def->path.area_id=o->backbone->area_id;f
or(ALL_LIST_ELEMENTS(ospf6->area_list,node,nnode,oa)){if(!IS_AREA_STUB(oa)){/*wi
thdrawdefaultswhenanareaswitchesfromstubto*non-stub*/route=ospf6_route_lookup(&d
ef->prefix,oa->summary_prefix);if(route&&(route->path.subtype==def->path.subtype
)){if(IS_OSPF6_DEBUG_ABR)zlog_debug("Withdrawingdefaultroutefromnon-stubbyarea%s
",oa->name);SET_FLAG(def->flag,OSPF6_ROUTE_REMOVE);ospf6_abr_originate_summary_t
o_area(def,oa);}}else{/*announcedefaultstostubbyareas*/if(IS_OSPF6_DEBUG_ABR)zlo
g_debug("Announcingdefaultrouteintostubbyarea%s",oa->name);UNSET_FLAG(def->flag,
OSPF6_ROUTE_REMOVE);ospf6_abr_originate_summary_to_area(def,oa);}}ospf6_route_de
lete(def);}/*RFC232816.2.Calculatingtheinter-arearoutes*/voidospf6_abr_examin_su
mmary(structospf6_lsa*lsa,structospf6_area*oa){structprefixprefix,abr_prefix;str
uctospf6_route_table*table=NULL;structospf6_route*range,*route,*old=NULL;structo
spf6_route*abr_entry;uint8_ttype=0;charoptions[3]={0,0,0};uint8_tprefix_options=
0;uint32_tcost=0;uint8_trouter_bits=0;charbuf[PREFIX2STR_BUFFER];intis_debug=0;s
tructospf6_inter_prefix_lsa*prefix_lsa=NULL;structospf6_inter_router_lsa*router_
lsa=NULL;structospf6_path*path;memset(&prefix,0,sizeof(prefix));if(lsa->header->
type==htons(OSPF6_LSTYPE_INTER_PREFIX)){if(IS_OSPF6_DEBUG_EXAMIN(INTER_PREFIX)){
is_debug++;zlog_debug("Examin%sinarea%s",lsa->name,oa->name);}prefix_lsa=(struct
ospf6_inter_prefix_lsa*)OSPF6_LSA_HEADER_END(lsa->header);prefix.family=AF_INET6
;prefix.prefixlen=prefix_lsa->prefix.prefix_length;ospf6_prefix_in6_addr(&prefix
.u.prefix6,&prefix_lsa->prefix);if(is_debug)prefix2str(&prefix,buf,sizeof(buf));
table=oa->ospf6->route_table;type=OSPF6_DEST_TYPE_NETWORK;prefix_options=prefix_
lsa->prefix.prefix_options;cost=OSPF6_ABR_SUMMARY_METRIC(prefix_lsa);}elseif(lsa
->header->type==htons(OSPF6_LSTYPE_INTER_ROUTER)){if(IS_OSPF6_DEBUG_EXAMIN(INTER
_ROUTER)){is_debug++;zlog_debug("Examin%sinarea%s",lsa->name,oa->name);}router_l
sa=(structospf6_inter_router_lsa*)OSPF6_LSA_HEADER_END(lsa->header);ospf6_linkst
ate_prefix(router_lsa->router_id,htonl(0),&prefix);if(is_debug)inet_ntop(AF_INET
,&router_lsa->router_id,buf,sizeof(buf));table=oa->ospf6->brouter_table;type=OSP
F6_DEST_TYPE_ROUTER;options[0]=router_lsa->options[0];options[1]=router_lsa->opt
ions[1];options[2]=router_lsa->options[2];cost=OSPF6_ABR_SUMMARY_METRIC(router_l
sa);SET_FLAG(router_bits,OSPF6_ROUTER_BIT_E);}elseassert(0);/*Findexistingroute*
/route=ospf6_route_lookup(&prefix,table);if(route)ospf6_route_lock(route);while(
route&&ospf6_route_is_prefix(&prefix,route)){if(route->path.area_id==oa->area_id
&&route->path.origin.type==lsa->header->type&&route->path.origin.id==lsa->header
->id&&route->path.origin.adv_router==lsa->header->adv_router&&!CHECK_FLAG(route-
>flag,OSPF6_ROUTE_WAS_REMOVED))old=route;route=ospf6_route_next(route);}if(route
)ospf6_route_unlock(route);/*(1)ifcost==LSInfinityoriftheLSAisMaxAge*/if(cost==O
SPF_LS_INFINITY){if(is_debug)zlog_debug("costisLS_INFINITY,ignore");if(old)ospf6
_route_remove(old,table);return;}if(OSPF6_LSA_IS_MAXAGE(lsa)){if(is_debug)zlog_d
ebug("LSAisMaxAge,ignore");if(old)ospf6_route_remove(old,table);return;}/*(2)ift
heLSAisself-originated,ignore*/if(lsa->header->adv_router==oa->ospf6->router_id)
{if(is_debug)zlog_debug("LSAisself-originated,ignore");if(old)ospf6_route_remove
(old,table);return;}/*(3)iftheprefixisequaltoanactiveconfiguredaddressrange*//*o
riftheNUbitissetintheprefix*/if(lsa->header->type==htons(OSPF6_LSTYPE_INTER_PREF
IX)){range=ospf6_route_lookup(&prefix,oa->range_table);if(range){if(is_debug)zlo
g_debug("Prefixisequaltoaddressrange,ignore");if(old)ospf6_route_remove(old,tabl
e);return;}if(CHECK_FLAG(prefix_lsa->prefix.prefix_options,OSPF6_PREFIX_OPTION_N
U)||CHECK_FLAG(prefix_lsa->prefix.prefix_options,OSPF6_PREFIX_OPTION_LA)){if(is_
debug)zlog_debug("PrefixhasNU/LAbitset,ignore");if(old)ospf6_route_remove(old,ta
ble);return;}}if(lsa->header->type==htons(OSPF6_LSTYPE_INTER_ROUTER)){/*Topasste
stsuites*/if(!OSPF6_OPT_ISSET(router_lsa->options,OSPF6_OPT_R)||!OSPF6_OPT_ISSET
(router_lsa->options,OSPF6_OPT_V6)){if(is_debug)zlog_debug("PrefixhasNU/LAbitset
,ignore");if(old)ospf6_route_remove(old,table);return;}/*Avoidinfiniterecursioni
fsomeonehasmaliciouslyannouncedanInter-RouterLSAforanABR*/if(lsa->header->adv_ro
uter==router_lsa->router_id){if(is_debug)zlog_debug("IgnorningInter-RouterLSAfor
anABR(%s)",buf);if(old)ospf6_route_remove(old,table);return;}}/*(4)iftheroutingt
ableentryfortheABRdoesnotexist*/ospf6_linkstate_prefix(lsa->header->adv_router,h
tonl(0),&abr_prefix);abr_entry=ospf6_route_lookup(&abr_prefix,oa->ospf6->brouter
_table);if(abr_entry==NULL||abr_entry->path.area_id!=oa->area_id||CHECK_FLAG(abr
_entry->flag,OSPF6_ROUTE_REMOVE)||!CHECK_FLAG(abr_entry->path.router_bits,OSPF6_
ROUTER_BIT_B)){if(is_debug)zlog_debug("ABRrouterentrydoesnotexist,ignore");if(ol
d)ospf6_route_remove(old,table);return;}/*Checkimportlist*/if(IMPORT_NAME(oa)){i
f(IMPORT_LIST(oa)==NULL)IMPORT_LIST(oa)=access_list_lookup(AFI_IP6,IMPORT_NAME(o
a));if(IMPORT_LIST(oa))if(access_list_apply(IMPORT_LIST(oa),&prefix)==FILTER_DEN
Y){if(is_debug)zlog_debug("Prefixwasdeniedbyimport-list");if(old)ospf6_route_rem
ove(old,table);return;}}/*Checkinputprefix-list*/if(PREFIX_LIST_IN(oa))if(prefix
_list_apply(PREFIX_LIST_IN(oa),&prefix)!=PREFIX_PERMIT){if(is_debug)zlog_debug("
Prefixwasdeniedbyprefix-list");if(old)ospf6_route_remove(old,table);return;}/*(5
),(6):thepathpreferenceishandledbythesortingintheroutingtable.Alwaysinstallthepa
thbysubstitutingoldroute(ifany).*/if(old)route=ospf6_route_copy(old);elseroute=o
spf6_route_create();route->type=type;route->prefix=prefix;route->path.origin.typ
e=lsa->header->type;route->path.origin.id=lsa->header->id;route->path.origin.adv
_router=lsa->header->adv_router;route->path.router_bits=router_bits;route->path.
options[0]=options[0];route->path.options[1]=options[1];route->path.options[2]=o
ptions[2];route->path.prefix_options=prefix_options;route->path.area_id=oa->area
_id;route->path.type=OSPF6_PATH_TYPE_INTER;route->path.cost=abr_entry->path.cost
+cost;ospf6_route_copy_nexthops(route,abr_entry);path=ospf6_path_dup(&route->pat
h);ospf6_copy_nexthops(path->nh_list,abr_entry->nh_list);listnode_add_sort(route
->paths,path);/*(7)Iftheroutesareidentical,copythenexthopsovertoexistingroute.os
pf6'sroutetableimplementationwillotherwisestringbothroutes,butkeeptheolderoneast
hebestroutesincetheroutesareidentical.*/old=ospf6_route_lookup(&prefix,table);if
(old&&(ospf6_route_cmp(route,old)==0)){ospf6_route_merge_nexthops(old,route);if(
is_debug)zlog_debug("%s:Updateroute:%soldcost%unewcost%unhcount%u",__PRETTY_FUNC
TION__,buf,old->path.cost,route->path.cost,listcount(route->nh_list));/*UpdateRI
B/FIB*/if(table->hook_add)(*table->hook_add)(old);/*Deletenewroute*/ospf6_route_
delete(route);}else{if(is_debug)zlog_debug("%s:Installroute:%scost%unhcount%u",_
_PRETTY_FUNCTION__,buf,route->path.cost,listcount(route->nh_list));/*ospf6_ia_ad
d_nw_route(table,&prefix,route);*/ospf6_route_add(route,table);}}voidospf6_abr_e
xamin_brouter(uint32_trouter_id){structospf6_lsa*lsa;structospf6_area*oa;uint16_
ttype;if(ospf6_is_router_abr(ospf6))oa=ospf6->backbone;elseoa=listgetdata(listhe
ad(ospf6->area_list));/**Itispossibletodesignateanonbackbone*areafirst.Ifthatist
hecasesafely*falloutofthisfunction.*/if(oa==NULL)return;type=htons(OSPF6_LSTYPE_
INTER_ROUTER);for(ALL_LSDB_TYPED_ADVRTR(oa->lsdb,type,router_id,lsa))ospf6_abr_e
xamin_summary(lsa,oa);type=htons(OSPF6_LSTYPE_INTER_PREFIX);for(ALL_LSDB_TYPED_A
DVRTR(oa->lsdb,type,router_id,lsa))ospf6_abr_examin_summary(lsa,oa);}voidospf6_a
br_reimport(structospf6_area*oa){structospf6_lsa*lsa;uint16_ttype;type=htons(OSP
F6_LSTYPE_INTER_ROUTER);for(ALL_LSDB_TYPED(oa->lsdb,type,lsa))ospf6_abr_examin_s
ummary(lsa,oa);type=htons(OSPF6_LSTYPE_INTER_PREFIX);for(ALL_LSDB_TYPED(oa->lsdb
,type,lsa))ospf6_abr_examin_summary(lsa,oa);}voidospf6_abr_prefix_resummarize(st
ructospf6*o){structospf6_route*route;if(IS_OSPF6_DEBUG_ABR)zlog_debug("Re-examin
ingInter-PrefixSummaries");for(route=ospf6_route_head(o->route_table);route;rout
e=ospf6_route_next(route))ospf6_abr_originate_summary(route);if(IS_OSPF6_DEBUG_A
BR)zlog_debug("Finishedre-examiningInter-PrefixSummaries");}/*Displayfunctions*/
staticchar*ospf6_inter_area_prefix_lsa_get_prefix_str(structospf6_lsa*lsa,char*b
uf,intbuflen,intpos){structospf6_inter_prefix_lsa*prefix_lsa;structin6_addrin6;i
f(lsa!=NULL){prefix_lsa=(structospf6_inter_prefix_lsa*)OSPF6_LSA_HEADER_END(lsa-
>header);ospf6_prefix_in6_addr(&in6,&prefix_lsa->prefix);if(buf){inet_ntop(AF_IN
ET6,&in6,buf,buflen);sprintf(&buf[strlen(buf)],"/%d",prefix_lsa->prefix.prefix_l
ength);}}return(buf);}staticintospf6_inter_area_prefix_lsa_show(structvty*vty,st
ructospf6_lsa*lsa){structospf6_inter_prefix_lsa*prefix_lsa;charbuf[INET6_ADDRSTR
LEN];prefix_lsa=(structospf6_inter_prefix_lsa*)OSPF6_LSA_HEADER_END(lsa->header)
;vty_out(vty,"Metric:%lu\n",(unsignedlong)OSPF6_ABR_SUMMARY_METRIC(prefix_lsa));
ospf6_prefix_options_printbuf(prefix_lsa->prefix.prefix_options,buf,sizeof(buf))
;vty_out(vty,"PrefixOptions:%s\n",buf);vty_out(vty,"Prefix:%s\n",ospf6_inter_are
a_prefix_lsa_get_prefix_str(lsa,buf,sizeof(buf),0));return0;}staticchar*ospf6_in
ter_area_router_lsa_get_prefix_str(structospf6_lsa*lsa,char*buf,intbuflen,intpos
){structospf6_inter_router_lsa*router_lsa;if(lsa!=NULL){router_lsa=(structospf6_
inter_router_lsa*)OSPF6_LSA_HEADER_END(lsa->header);if(buf)inet_ntop(AF_INET,&ro
uter_lsa->router_id,buf,buflen);}return(buf);}staticintospf6_inter_area_router_l
sa_show(structvty*vty,structospf6_lsa*lsa){structospf6_inter_router_lsa*router_l
sa;charbuf[64];router_lsa=(structospf6_inter_router_lsa*)OSPF6_LSA_HEADER_END(ls
a->header);ospf6_options_printbuf(router_lsa->options,buf,sizeof(buf));vty_out(v
ty,"Options:%s\n",buf);vty_out(vty,"Metric:%lu\n",(unsignedlong)OSPF6_ABR_SUMMAR
Y_METRIC(router_lsa));inet_ntop(AF_INET,&router_lsa->router_id,buf,sizeof(buf));
vty_out(vty,"DestinationRouterID:%s\n",buf);return0;}/*Debugcommands*/DEFUN(debu
g_ospf6_abr,debug_ospf6_abr_cmd,"debugospf6abr",DEBUG_STROSPF6_STR"DebugOSPFv3AB
Rfunction\n"){OSPF6_DEBUG_ABR_ON();returnCMD_SUCCESS;}DEFUN(no_debug_ospf6_abr,n
o_debug_ospf6_abr_cmd,"nodebugospf6abr",NO_STRDEBUG_STROSPF6_STR"DebugOSPFv3ABRf
unction\n"){OSPF6_DEBUG_ABR_OFF();returnCMD_SUCCESS;}intconfig_write_ospf6_debug
_abr(structvty*vty){if(IS_OSPF6_DEBUG_ABR)vty_out(vty,"debugospf6abr\n");return0
;}voidinstall_element_ospf6_debug_abr(void){install_element(ENABLE_NODE,&debug_o
spf6_abr_cmd);install_element(ENABLE_NODE,&no_debug_ospf6_abr_cmd);install_eleme
nt(CONFIG_NODE,&debug_ospf6_abr_cmd);install_element(CONFIG_NODE,&no_debug_ospf6
_abr_cmd);}structospf6_lsa_handlerinter_prefix_handler={.lh_type=OSPF6_LSTYPE_IN
TER_PREFIX,.lh_name="Inter-Prefix",.lh_short_name="IAP",.lh_show=ospf6_inter_are
a_prefix_lsa_show,.lh_get_prefix_str=ospf6_inter_area_prefix_lsa_get_prefix_str,
.lh_debug=0};structospf6_lsa_handlerinter_router_handler={.lh_type=OSPF6_LSTYPE_
INTER_ROUTER,.lh_name="Inter-Router",.lh_short_name="IAR",.lh_show=ospf6_inter_a
rea_router_lsa_show,.lh_get_prefix_str=ospf6_inter_area_router_lsa_get_prefix_st
r,.lh_debug=0};voidospf6_abr_init(void){ospf6_install_lsa_handler(&inter_prefix_
handler);ospf6_install_lsa_handler(&inter_router_handler);}