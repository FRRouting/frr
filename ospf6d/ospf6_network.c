/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"log.h"#include"memory.h"#include"sockunion.h"#include"sockop
t.h"#include"privs.h"#include"libospf.h"#include"ospf6_proto.h"#include"ospf6_ne
twork.h"#include"ospf6d.h"intospf6_sock;structin6_addrallspfrouters6;structin6_a
ddralldrouters6;/*setsockoptMulticastLooptooff*/staticvoidospf6_reset_mcastloop(
void){unsignedintoff=0;if(setsockopt(ospf6_sock,IPPROTO_IPV6,IPV6_MULTICAST_LOOP
,&off,sizeof(unsignedint))<0)zlog_warn("Network:resetIPV6_MULTICAST_LOOPfailed:%
s",safe_strerror(errno));}staticvoidospf6_set_pktinfo(void){setsockopt_ipv6_pkti
nfo(ospf6_sock,1);}staticvoidospf6_set_transport_class(void){#ifdefIPTOS_PREC_IN
TERNETCONTROLsetsockopt_ipv6_tclass(ospf6_sock,IPTOS_PREC_INTERNETCONTROL);#endi
f}staticvoidospf6_set_checksum(void){intoffset=12;#ifndefDISABLE_IPV6_CHECKSUMif
(setsockopt(ospf6_sock,IPPROTO_IPV6,IPV6_CHECKSUM,&offset,sizeof(offset))<0)zlog
_warn("Network:setIPV6_CHECKSUMfailed:%s",safe_strerror(errno));#elsezlog_warn("
Network:Don'tsetIPV6_CHECKSUM");#endif/*DISABLE_IPV6_CHECKSUM*/}/*Makeospf6d'sse
rversocket.*/intospf6_serv_sock(void){if(ospf6d_privs.change(ZPRIVS_RAISE))zlog_
err("ospf6_serv_sock:couldnotraiseprivs");ospf6_sock=socket(AF_INET6,SOCK_RAW,IP
PROTO_OSPFIGP);if(ospf6_sock<0){zlog_warn("Network:can'tcreateOSPF6socket.");if(
ospf6d_privs.change(ZPRIVS_LOWER))zlog_err("ospf_sock_init:couldnotlowerprivs");
return-1;}if(ospf6d_privs.change(ZPRIVS_LOWER))zlog_err("ospf_sock_init:couldnot
lowerprivs");/*setsocketoptions*/#if1sockopt_reuseaddr(ospf6_sock);#elseospf6_se
t_reuseaddr();#endif/*1*/ospf6_reset_mcastloop();ospf6_set_pktinfo();ospf6_set_t
ransport_class();ospf6_set_checksum();/*setupglobalin6_addr,allspf6andalldr6forl
ateruse*/inet_pton(AF_INET6,ALLSPFROUTERS6,&allspfrouters6);inet_pton(AF_INET6,A
LLDROUTERS6,&alldrouters6);return0;}/*ospf6setsocketoption*/intospf6_sso(ifindex
_tifindex,structin6_addr*group,intoption){structipv6_mreqmreq6;intret;intbufsize
=(8*1024*1024);assert(ifindex);mreq6.ipv6mr_interface=ifindex;memcpy(&mreq6.ipv6
mr_multiaddr,group,sizeof(structin6_addr));ret=setsockopt(ospf6_sock,IPPROTO_IPV
6,option,&mreq6,sizeof(mreq6));if(ret<0){zlog_err("Network:setsockopt(%d)onifind
ex%dfailed:%s",option,ifindex,safe_strerror(errno));returnret;}setsockopt_so_sen
dbuf(ospf6_sock,bufsize);setsockopt_so_recvbuf(ospf6_sock,bufsize);return0;}stat
icintiov_count(structiovec*iov){inti;for(i=0;iov[i].iov_base;i++);returni;}stati
cintiov_totallen(structiovec*iov){inti;inttotallen=0;for(i=0;iov[i].iov_base;i++
)totallen+=iov[i].iov_len;returntotallen;}intospf6_sendmsg(structin6_addr*src,st
ructin6_addr*dst,ifindex_t*ifindex,structiovec*message){intretval;structmsghdrsm
sghdr;structcmsghdr*scmsgp;union{structcmsghdrhdr;uint8_tbuf[CMSG_SPACE(sizeof(s
tructin6_pktinfo))];}cmsgbuf;structin6_pktinfo*pktinfo;structsockaddr_in6dst_sin
6;assert(dst);assert(*ifindex);scmsgp=(structcmsghdr*)&cmsgbuf;pktinfo=(structin
6_pktinfo*)(CMSG_DATA(scmsgp));memset(&dst_sin6,0,sizeof(structsockaddr_in6));/*
sourceaddress*/pktinfo->ipi6_ifindex=*ifindex;if(src)memcpy(&pktinfo->ipi6_addr,
src,sizeof(structin6_addr));elsememset(&pktinfo->ipi6_addr,0,sizeof(structin6_ad
dr));/*destinationaddress*/dst_sin6.sin6_family=AF_INET6;#ifdefSIN6_LENdst_sin6.
sin6_len=sizeof(structsockaddr_in6);#endif/*SIN6_LEN*/memcpy(&dst_sin6.sin6_addr
,dst,sizeof(structin6_addr));dst_sin6.sin6_scope_id=*ifindex;/*sendcontrolmsg*/s
cmsgp->cmsg_level=IPPROTO_IPV6;scmsgp->cmsg_type=IPV6_PKTINFO;scmsgp->cmsg_len=C
MSG_LEN(sizeof(structin6_pktinfo));/*scmsgp=CMSG_NXTHDR(&smsghdr,scmsgp);*//*sen
dmsghdr*/memset(&smsghdr,0,sizeof(smsghdr));smsghdr.msg_iov=message;smsghdr.msg_
iovlen=iov_count(message);smsghdr.msg_name=(caddr_t)&dst_sin6;smsghdr.msg_namele
n=sizeof(structsockaddr_in6);smsghdr.msg_control=(caddr_t)&cmsgbuf.buf;smsghdr.m
sg_controllen=sizeof(cmsgbuf.buf);retval=sendmsg(ospf6_sock,&smsghdr,0);if(retva
l!=iov_totallen(message))zlog_warn("sendmsgfailed:ifindex:%d:%s(%d)",*ifindex,sa
fe_strerror(errno),errno);returnretval;}intospf6_recvmsg(structin6_addr*src,stru
ctin6_addr*dst,ifindex_t*ifindex,structiovec*message){intretval;structmsghdrrmsg
hdr;structcmsghdr*rcmsgp;uint8_tcmsgbuf[CMSG_SPACE(sizeof(structin6_pktinfo))];s
tructin6_pktinfo*pktinfo;structsockaddr_in6src_sin6;rcmsgp=(structcmsghdr*)cmsgb
uf;pktinfo=(structin6_pktinfo*)(CMSG_DATA(rcmsgp));memset(&src_sin6,0,sizeof(str
uctsockaddr_in6));/*receivecontrolmsg*/rcmsgp->cmsg_level=IPPROTO_IPV6;rcmsgp->c
msg_type=IPV6_PKTINFO;rcmsgp->cmsg_len=CMSG_LEN(sizeof(structin6_pktinfo));/*rcm
sgp=CMSG_NXTHDR(&rmsghdr,rcmsgp);*//*receivemsghdr*/memset(&rmsghdr,0,sizeof(rms
ghdr));rmsghdr.msg_iov=message;rmsghdr.msg_iovlen=iov_count(message);rmsghdr.msg
_name=(caddr_t)&src_sin6;rmsghdr.msg_namelen=sizeof(structsockaddr_in6);rmsghdr.
msg_control=(caddr_t)cmsgbuf;rmsghdr.msg_controllen=sizeof(cmsgbuf);retval=recvm
sg(ospf6_sock,&rmsghdr,0);if(retval<0)zlog_warn("recvmsgfailed:%s",safe_strerror
(errno));elseif(retval==iov_totallen(message))zlog_warn("recvmsgreadfullbuffersi
ze:%d",retval);/*sourceaddress*/assert(src);memcpy(src,&src_sin6.sin6_addr,sizeo
f(structin6_addr));/*destinationaddress*/if(ifindex)*ifindex=pktinfo->ipi6_ifind
ex;if(dst)memcpy(dst,&pktinfo->ipi6_addr,sizeof(structin6_addr));returnretval;}