/***ospf6_bfd.c:IPv6OSPFBFDhandlingroutines**@copyrightCopyright(C)2015CumulusNe
tworks,Inc.**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistribut
eitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*Free
SoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisd
istributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpli
edwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPubl
icLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicense
along*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,
Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"c
ommand.h"#include"linklist.h"#include"memory.h"#include"prefix.h"#include"thread
.h"#include"buffer.h"#include"stream.h"#include"zclient.h"#include"vty.h"#includ
e"table.h"#include"bfd.h"#include"if.h"#include"ospf6d.h"#include"ospf6_message.
h"#include"ospf6_neighbor.h"#include"ospf6_interface.h"#include"ospf6_route.h"#i
nclude"ospf6_zebra.h"#include"ospf6_bfd.h"externstructzclient*zclient;/**ospf6_b
fd_info_free-FreeBFDinfostructure*/voidospf6_bfd_info_free(void**bfd_info){bfd_i
nfo_free((structbfd_info**)bfd_info);}/**ospf6_bfd_show_info-ShowBFDinfostructur
e*/voidospf6_bfd_show_info(structvty*vty,void*bfd_info,intparam_only){if(param_o
nly)bfd_show_param(vty,bfd_info,1,0,0,NULL);elsebfd_show_info(vty,bfd_info,0,1,0
,NULL);}/**ospf6_bfd_reg_dereg_nbr-Register/DeregisteraneighborwithBFDthrough*ze
braforstarting/stoppingthemonitoringof*theneighborrechahability.*/voidospf6_bfd_
reg_dereg_nbr(structospf6_neighbor*on,intcommand){structospf6_interface*oi=on->o
spf6_if;structinterface*ifp=oi->interface;structbfd_info*bfd_info;charsrc[64];if
(!oi->bfd_info||!on->bfd_info)return;bfd_info=(structbfd_info*)oi->bfd_info;if(I
S_OSPF6_DEBUG_ZEBRA(SEND)){inet_ntop(AF_INET6,&on->linklocal_addr,src,sizeof(src
));zlog_debug("%snbr(%s)withBFD",bfd_get_command_dbg_str(command),src);}bfd_peer
_sendmsg(zclient,bfd_info,AF_INET6,&on->linklocal_addr,on->ospf6_if->linklocal_a
ddr,ifp->name,0,0,command,0,VRF_DEFAULT);if(command==ZEBRA_BFD_DEST_DEREGISTER)b
fd_info_free((structbfd_info**)&on->bfd_info);}/**ospf6_bfd_trigger_event-Neighb
orisregistered/deregisteredwithBFDwhen*neighborstateischangedto/from2way.*/voido
spf6_bfd_trigger_event(structospf6_neighbor*on,intold_state,intstate){if((old_st
ate<OSPF6_NEIGHBOR_TWOWAY)&&(state>=OSPF6_NEIGHBOR_TWOWAY))ospf6_bfd_reg_dereg_n
br(on,ZEBRA_BFD_DEST_REGISTER);elseif((old_state>=OSPF6_NEIGHBOR_TWOWAY)&&(state
<OSPF6_NEIGHBOR_TWOWAY))ospf6_bfd_reg_dereg_nbr(on,ZEBRA_BFD_DEST_DEREGISTER);}/
**ospf6_bfd_reg_dereg_all_nbr-Register/Deregisterallneighborsassociated*withaint
erfacewithBFDthrough*zebraforstarting/stoppingthemonitoringof*theneighborrechaha
bility.*/staticvoidospf6_bfd_reg_dereg_all_nbr(structospf6_interface*oi,intcomma
nd){structospf6_neighbor*on;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(oi->nei
ghbor_list,node,on)){if(command==ZEBRA_BFD_DEST_REGISTER)ospf6_bfd_info_nbr_crea
te(oi,on);if(on->state<OSPF6_NEIGHBOR_TWOWAY){if(command==ZEBRA_BFD_DEST_DEREGIS
TER)bfd_info_free((structbfd_info**)&on->bfd_info);continue;}ospf6_bfd_reg_dereg
_nbr(on,command);}}/**ospf6_bfd_nbr_replay-ReplayalltheneighborsthathaveBFDenabl
ed*tozebra*/staticintospf6_bfd_nbr_replay(intcommand,structzclient*zclient,zebra
_size_tlength,vrf_id_tvrf_id){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);struct
listnode*node;structinterface*ifp;structospf6_interface*oi;structospf6_neighbor*
on;chardst[64];if(IS_OSPF6_DEBUG_ZEBRA(RECV))zlog_debug("Zebra:BFDDestreplayrequ
est");/*Sendtheclientregistration*/bfd_client_sendmsg(zclient,ZEBRA_BFD_CLIENT_R
EGISTER);/*Replaytheneighbor,ifBFDisenabledontheinterface*/FOR_ALL_INTERFACES(vr
f,ifp){oi=(structospf6_interface*)ifp->info;if(!oi||!oi->bfd_info)continue;for(A
LL_LIST_ELEMENTS_RO(oi->neighbor_list,node,on)){if(on->state<OSPF6_NEIGHBOR_TWOW
AY)continue;if(IS_OSPF6_DEBUG_ZEBRA(SEND)){inet_ntop(AF_INET6,&on->linklocal_add
r,dst,sizeof(dst));zlog_debug("Replayingnbr(%s)toBFD",dst);}ospf6_bfd_reg_dereg_
nbr(on,ZEBRA_BFD_DEST_UPDATE);}}return0;}/**ospf6_bfd_interface_dest_update-Find
theneighborforwhichtheBFDstatus*haschangedandbringdowntheneighbor*connectivityif
BFDdownisreceived.*/staticintospf6_bfd_interface_dest_update(intcommand,structzc
lient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structospf6
_interface*oi;structospf6_neighbor*on;structprefixdp;structprefixsp;structlistno
de*node,*nnode;chardst[64];intstatus;intold_status;structbfd_info*bfd_info;struc
ttimevaltv;ifp=bfd_get_peer_info(zclient->ibuf,&dp,&sp,&status,vrf_id);if((ifp==
NULL)||(dp.family!=AF_INET6))return0;if(IS_OSPF6_DEBUG_ZEBRA(RECV)){charbuf[PREF
IX2STR_BUFFER];prefix2str(&dp,buf,sizeof(buf));zlog_debug("Zebra:interface%sbfdd
estination%s%s",ifp->name,buf,bfd_get_status_str(status));}oi=(structospf6_inter
face*)ifp->info;if(!oi||!oi->bfd_info)return0;for(ALL_LIST_ELEMENTS(oi->neighbor
_list,node,nnode,on)){if(memcmp(&(on->linklocal_addr),&dp.u.prefix6,sizeof(struc
tin6_addr)))continue;if(IS_OSPF6_DEBUG_NEIGHBOR(EVENT)){inet_ntop(AF_INET6,&on->
linklocal_addr,dst,sizeof(dst));zlog_debug("[%s:%s]:BFD%s",ifp->name,dst,bfd_get
_status_str(status));}if(!on->bfd_info)continue;bfd_info=(structbfd_info*)on->bf
d_info;if(bfd_info->status==status)continue;old_status=bfd_info->status;bfd_info
->status=status;monotime(&tv);bfd_info->last_update=tv.tv_sec;if((status==BFD_ST
ATUS_DOWN)&&(old_status==BFD_STATUS_UP)){THREAD_OFF(on->inactivity_timer);thread
_add_event(master,inactivity_timer,on,0,NULL);}}return0;}/**ospf6_bfd_info_nbr_c
reate-Create/updateBFDinformationforaneighbor.*/voidospf6_bfd_info_nbr_create(st
ructospf6_interface*oi,structospf6_neighbor*on){structbfd_info*oi_bfd_info;struc
tbfd_info*on_bfd_info;if(!oi->bfd_info)return;oi_bfd_info=(structbfd_info*)oi->b
fd_info;if(!on->bfd_info)on->bfd_info=bfd_info_create();on_bfd_info=(structbfd_i
nfo*)on->bfd_info;on_bfd_info->detect_mult=oi_bfd_info->detect_mult;on_bfd_info-
>desired_min_tx=oi_bfd_info->desired_min_tx;on_bfd_info->required_min_rx=oi_bfd_
info->required_min_rx;}/**ospf6_bfd_write_config-WritetheinterfaceBFDconfigurati
on.*/voidospf6_bfd_write_config(structvty*vty,structospf6_interface*oi){structbf
d_info*bfd_info;if(!oi->bfd_info)return;bfd_info=(structbfd_info*)oi->bfd_info;i
f(CHECK_FLAG(bfd_info->flags,BFD_FLAG_PARAM_CFG))vty_out(vty,"ipv6ospf6bfd%d%d%d
\n",bfd_info->detect_mult,bfd_info->required_min_rx,bfd_info->desired_min_tx);el
sevty_out(vty,"ipv6ospf6bfd\n");}/**ospf6_bfd_if_param_set-SettheconfiguredBFDpa
ramtervaluesfor*interface.*/staticvoidospf6_bfd_if_param_set(structospf6_interfa
ce*oi,uint32_tmin_rx,uint32_tmin_tx,uint8_tdetect_mult,intdefaults){intcommand=0
;bfd_set_param((structbfd_info**)&(oi->bfd_info),min_rx,min_tx,detect_mult,defau
lts,&command);if(command)ospf6_bfd_reg_dereg_all_nbr(oi,command);}DEFUN(ipv6_osp
f6_bfd,ipv6_ospf6_bfd_cmd,"ipv6ospf6bfd",IP6_STROSPF6_STR"EnablesBFDsupport\n"){
VTY_DECLVAR_CONTEXT(interface,ifp);structospf6_interface*oi;assert(ifp);oi=(stru
ctospf6_interface*)ifp->info;if(oi==NULL)oi=ospf6_interface_create(ifp);assert(o
i);ospf6_bfd_if_param_set(oi,BFD_DEF_MIN_RX,BFD_DEF_MIN_TX,BFD_DEF_DETECT_MULT,1
);returnCMD_SUCCESS;}DEFUN(ipv6_ospf6_bfd_param,ipv6_ospf6_bfd_param_cmd,"ipv6os
pf6bfd(2-255)(50-60000)(50-60000)",IP6_STROSPF6_STR"EnablesBFDsupport\n""DetectM
ultiplier\n""Requiredminreceiveinterval\n""Desiredmintransmitinterval\n"){VTY_DE
CLVAR_CONTEXT(interface,ifp);intidx_number=3;intidx_number_2=4;intidx_number_3=5
;structospf6_interface*oi;uint32_trx_val;uint32_ttx_val;uint8_tdm_val;intret;ass
ert(ifp);oi=(structospf6_interface*)ifp->info;if(oi==NULL)oi=ospf6_interface_cre
ate(ifp);assert(oi);if((ret=bfd_validate_param(vty,argv[idx_number]->arg,argv[id
x_number_2]->arg,argv[idx_number_3]->arg,&dm_val,&rx_val,&tx_val))!=CMD_SUCCESS)
returnret;ospf6_bfd_if_param_set(oi,rx_val,tx_val,dm_val,0);returnCMD_SUCCESS;}D
EFUN(no_ipv6_ospf6_bfd,no_ipv6_ospf6_bfd_cmd,"noipv6ospf6bfd",NO_STRIP6_STROSPF6
_STR"DisablesBFDsupport\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structospf6_inter
face*oi;assert(ifp);oi=(structospf6_interface*)ifp->info;if(oi==NULL)oi=ospf6_in
terface_create(ifp);assert(oi);if(oi->bfd_info){ospf6_bfd_reg_dereg_all_nbr(oi,Z
EBRA_BFD_DEST_DEREGISTER);bfd_info_free((structbfd_info**)&(oi->bfd_info));}retu
rnCMD_SUCCESS;}voidospf6_bfd_init(void){bfd_gbl_init();/*InitializeBFDclientfunc
tions*/zclient->interface_bfd_dest_update=ospf6_bfd_interface_dest_update;zclien
t->bfd_dest_replay=ospf6_bfd_nbr_replay;/*InstallBFDcommand*/install_element(INT
ERFACE_NODE,&ipv6_ospf6_bfd_cmd);install_element(INTERFACE_NODE,&ipv6_ospf6_bfd_
param_cmd);install_element(INTERFACE_NODE,&no_ipv6_ospf6_bfd_cmd);}