/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"log.h"#include"memory.h"#include"vty.h"#include"linklist.h"#
include"prefix.h"#include"table.h"#include"thread.h"#include"command.h"#include"
defaults.h"#include"ospf6_proto.h"#include"ospf6_message.h"#include"ospf6_lsa.h"
#include"ospf6_lsdb.h"#include"ospf6_route.h"#include"ospf6_zebra.h"#include"osp
f6_top.h"#include"ospf6_area.h"#include"ospf6_interface.h"#include"ospf6_neighbo
r.h"#include"ospf6_flood.h"#include"ospf6_asbr.h"#include"ospf6_abr.h"#include"o
spf6_intra.h"#include"ospf6_spf.h"#include"ospf6d.h"DEFINE_QOBJ_TYPE(ospf6)/*glo
balospf6dvariable*/structospf6*ospf6;staticstructospf6_masterospf6_master;struct
ospf6_master*om6;staticvoidospf6_disable(structospf6*o);staticvoidospf6_top_lsdb
_hook_add(structospf6_lsa*lsa){switch(ntohs(lsa->header->type)){caseOSPF6_LSTYPE
_AS_EXTERNAL:ospf6_asbr_lsa_add(lsa);break;default:break;}}staticvoidospf6_top_l
sdb_hook_remove(structospf6_lsa*lsa){switch(ntohs(lsa->header->type)){caseOSPF6_
LSTYPE_AS_EXTERNAL:ospf6_asbr_lsa_remove(lsa,NULL);break;default:break;}}staticv
oidospf6_top_route_hook_add(structospf6_route*route){ospf6_abr_originate_summary
(route);ospf6_zebra_route_update_add(route);}staticvoidospf6_top_route_hook_remo
ve(structospf6_route*route){route->flag|=OSPF6_ROUTE_REMOVE;ospf6_abr_originate_
summary(route);ospf6_zebra_route_update_remove(route);}staticvoidospf6_top_brout
er_hook_add(structospf6_route*route){if(IS_OSPF6_DEBUG_EXAMIN(AS_EXTERNAL)){uint
32_tbrouter_id;charbrouter_name[16];brouter_id=ADV_ROUTER_IN_PREFIX(&route->pref
ix);inet_ntop(AF_INET,&brouter_id,brouter_name,sizeof(brouter_name));zlog_debug(
"%s:brouter%saddwithadvrouter%xnhcount%u",__PRETTY_FUNCTION__,brouter_name,route
->path.origin.adv_router,listcount(route->nh_list));}ospf6_abr_examin_brouter(AD
V_ROUTER_IN_PREFIX(&route->prefix));ospf6_asbr_lsentry_add(route);ospf6_abr_orig
inate_summary(route);}staticvoidospf6_top_brouter_hook_remove(structospf6_route*
route){if(IS_OSPF6_DEBUG_EXAMIN(AS_EXTERNAL)){uint32_tbrouter_id;charbrouter_nam
e[16];brouter_id=ADV_ROUTER_IN_PREFIX(&route->prefix);inet_ntop(AF_INET,&brouter
_id,brouter_name,sizeof(brouter_name));zlog_debug("%s:brouter%sdelwithnhcount%u"
,__PRETTY_FUNCTION__,brouter_name,listcount(route->nh_list));}route->flag|=OSPF6
_ROUTE_REMOVE;ospf6_abr_examin_brouter(ADV_ROUTER_IN_PREFIX(&route->prefix));osp
f6_asbr_lsentry_remove(route);ospf6_abr_originate_summary(route);}staticstructos
pf6*ospf6_create(void){structospf6*o;o=XCALLOC(MTYPE_OSPF6_TOP,sizeof(structospf
6));/*initialize*/monotime(&o->starttime);o->area_list=list_new();o->area_list->
cmp=ospf6_area_cmp;o->lsdb=ospf6_lsdb_create(o);o->lsdb_self=ospf6_lsdb_create(o
);o->lsdb->hook_add=ospf6_top_lsdb_hook_add;o->lsdb->hook_remove=ospf6_top_lsdb_
hook_remove;o->spf_delay=OSPF_SPF_DELAY_DEFAULT;o->spf_holdtime=OSPF_SPF_HOLDTIM
E_DEFAULT;o->spf_max_holdtime=OSPF_SPF_MAX_HOLDTIME_DEFAULT;o->spf_hold_multipli
er=1;/*LSAtimersvalueinit*/o->lsa_minarrival=OSPF_MIN_LS_ARRIVAL;o->route_table=
OSPF6_ROUTE_TABLE_CREATE(GLOBAL,ROUTES);o->route_table->scope=o;o->route_table->
hook_add=ospf6_top_route_hook_add;o->route_table->hook_remove=ospf6_top_route_ho
ok_remove;o->brouter_table=OSPF6_ROUTE_TABLE_CREATE(GLOBAL,BORDER_ROUTERS);o->br
outer_table->scope=o;o->brouter_table->hook_add=ospf6_top_brouter_hook_add;o->br
outer_table->hook_remove=ospf6_top_brouter_hook_remove;o->external_table=OSPF6_R
OUTE_TABLE_CREATE(GLOBAL,EXTERNAL_ROUTES);o->external_table->scope=o;o->external
_id_table=route_table_init();o->ref_bandwidth=OSPF6_REFERENCE_BANDWIDTH;o->dista
nce_table=route_table_init();/*Enable"log-adjacency-changes"*/#ifDFLT_OSPF6_LOG_
ADJACENCY_CHANGESSET_FLAG(o->config_flags,OSPF6_LOG_ADJACENCY_CHANGES);#endifQOB
J_REG(o,ospf6);returno;}voidospf6_delete(structospf6*o){structlistnode*node,*nno
de;structospf6_area*oa;QOBJ_UNREG(o);ospf6_flush_self_originated_lsas_now();ospf
6_disable(ospf6);for(ALL_LIST_ELEMENTS(o->area_list,node,nnode,oa))ospf6_area_de
lete(oa);list_delete_and_null(&o->area_list);ospf6_lsdb_delete(o->lsdb);ospf6_ls
db_delete(o->lsdb_self);ospf6_route_table_delete(o->route_table);ospf6_route_tab
le_delete(o->brouter_table);ospf6_route_table_delete(o->external_table);route_ta
ble_finish(o->external_id_table);ospf6_distance_reset(o);route_table_finish(o->d
istance_table);XFREE(MTYPE_OSPF6_TOP,o);}staticvoidospf6_disable(structospf6*o){
structlistnode*node,*nnode;structospf6_area*oa;if(!CHECK_FLAG(o->flag,OSPF6_DISA
BLED)){SET_FLAG(o->flag,OSPF6_DISABLED);for(ALL_LIST_ELEMENTS(o->area_list,node,
nnode,oa))ospf6_area_disable(oa);/*XXX:Thisalsochangespersistentsettings*/ospf6_
asbr_redistribute_reset();ospf6_lsdb_remove_all(o->lsdb);ospf6_route_remove_all(
o->route_table);ospf6_route_remove_all(o->brouter_table);THREAD_OFF(o->maxage_re
mover);THREAD_OFF(o->t_spf_calc);THREAD_OFF(o->t_ase_calc);THREAD_OFF(o->t_distr
ibute_update);}}voidospf6_master_init(void){memset(&ospf6_master,0,sizeof(struct
ospf6_master));om6=&ospf6_master;}staticintospf6_maxage_remover(structthread*thr
ead){structospf6*o=(structospf6*)THREAD_ARG(thread);structospf6_area*oa;structos
pf6_interface*oi;structospf6_neighbor*on;structlistnode*i,*j,*k;intreschedule=0;
o->maxage_remover=(structthread*)NULL;for(ALL_LIST_ELEMENTS_RO(o->area_list,i,oa
)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){for(ALL_LIST_ELEMENTS_RO(oi->neig
hbor_list,k,on)){if(on->state!=OSPF6_NEIGHBOR_EXCHANGE&&on->state!=OSPF6_NEIGHBO
R_LOADING)continue;ospf6_maxage_remove(o);return0;}}}for(ALL_LIST_ELEMENTS_RO(o-
>area_list,i,oa)){for(ALL_LIST_ELEMENTS_RO(oa->if_list,j,oi)){if(ospf6_lsdb_maxa
ge_remover(oi->lsdb)){reschedule=1;}}if(ospf6_lsdb_maxage_remover(oa->lsdb)){res
chedule=1;}}if(ospf6_lsdb_maxage_remover(o->lsdb)){reschedule=1;}if(reschedule){
ospf6_maxage_remove(o);}return0;}voidospf6_maxage_remove(structospf6*o){if(o)thr
ead_add_timer(master,ospf6_maxage_remover,o,OSPF_LSA_MAXAGE_REMOVE_DELAY_DEFAULT
,&o->maxage_remover);}voidospf6_router_id_update(void){if(!ospf6)return;if(ospf6
->router_id_static!=0)ospf6->router_id=ospf6->router_id_static;elseospf6->router
_id=om6->zebra_router_id;}/*startospf6*/DEFUN_NOSH(router_ospf6,router_ospf6_cmd
,"routerospf6",ROUTER_STROSPF6_STR){if(ospf6==NULL){ospf6=ospf6_create();if(ospf
6->router_id==0)ospf6_router_id_update();}/*setcurrentospfpoint.*/VTY_PUSH_CONTE
XT(OSPF6_NODE,ospf6);returnCMD_SUCCESS;}/*stopospf6*/DEFUN(no_router_ospf6,no_ro
uter_ospf6_cmd,"norouterospf6",NO_STRROUTER_STROSPF6_STR){if(ospf6==NULL)vty_out
(vty,"OSPFv3isnotconfigured\n");else{ospf6_delete(ospf6);ospf6=NULL;}/*returntoc
onfignode.*/VTY_PUSH_CONTEXT_NULL(CONFIG_NODE);returnCMD_SUCCESS;}/*changeRouter
_IDcommands.*/DEFUN(ospf6_router_id,ospf6_router_id_cmd,"ospf6router-idA.B.C.D",
OSPF6_STR"ConfigureOSPF6Router-ID\n"V4NOTATION_STR){VTY_DECLVAR_CONTEXT(ospf6,o)
;intidx=0;intret;constchar*router_id_str;uint32_trouter_id;structospf6_area*oa;s
tructlistnode*node;argv_find(argv,argc,"A.B.C.D",&idx);router_id_str=argv[idx]->
arg;ret=inet_pton(AF_INET,router_id_str,&router_id);if(ret==0){vty_out(vty,"malf
ormedOSPFRouter-ID:%s\n",router_id_str);returnCMD_SUCCESS;}o->router_id_static=r
outer_id;for(ALL_LIST_ELEMENTS_RO(o->area_list,node,oa)){if(oa->full_nbrs){vty_o
ut(vty,"Forthisrouter-idchangetotakeeffect,""saveconfigandrestartospf6d\n");retu
rnCMD_SUCCESS;}}o->router_id=router_id;returnCMD_SUCCESS;}DEFUN(no_ospf6_router_
id,no_ospf6_router_id_cmd,"noospf6router-id[A.B.C.D]",NO_STROSPF6_STR"ConfigureO
SPF6Router-ID\n"V4NOTATION_STR){VTY_DECLVAR_CONTEXT(ospf6,o);structospf6_area*oa
;structlistnode*node;o->router_id_static=0;for(ALL_LIST_ELEMENTS_RO(o->area_list
,node,oa)){if(oa->full_nbrs){vty_out(vty,"Forthisrouter-idchangetotakeeffect,""s
aveconfigandrestartospf6d\n");returnCMD_SUCCESS;}}o->router_id=0;if(o->router_id
_zebra.s_addr)o->router_id=(uint32_t)o->router_id_zebra.s_addr;returnCMD_SUCCESS
;}#ifCONFDATE>20180828CPP_NOTICE("ospf6:`router-idA.B.C.D`deprecated2017/08/28")
#endifALIAS_HIDDEN(ospf6_router_id,ospf6_router_id_hdn_cmd,"router-idA.B.C.D","C
onfigureOSPF6Router-ID\n"V4NOTATION_STR)#ifCONFDATE>20180828CPP_NOTICE("ospf6:`n
orouter-idA.B.C.D`deprecated2017/08/28")#endifALIAS_HIDDEN(no_ospf6_router_id,no
_ospf6_router_id_hdn_cmd,"norouter-id[A.B.C.D]",NO_STR"ConfigureOSPF6Router-ID\n
"V4NOTATION_STR)DEFUN(ospf6_log_adjacency_changes,ospf6_log_adjacency_changes_cm
d,"log-adjacency-changes","Logchangesinadjacencystate\n"){VTY_DECLVAR_CONTEXT(os
pf6,ospf6);SET_FLAG(ospf6->config_flags,OSPF6_LOG_ADJACENCY_CHANGES);UNSET_FLAG(
ospf6->config_flags,OSPF6_LOG_ADJACENCY_DETAIL);returnCMD_SUCCESS;}DEFUN(ospf6_l
og_adjacency_changes_detail,ospf6_log_adjacency_changes_detail_cmd,"log-adjacenc
y-changesdetail","Logchangesinadjacencystate\n""Logallstatechanges\n"){VTY_DECLV
AR_CONTEXT(ospf6,ospf6);SET_FLAG(ospf6->config_flags,OSPF6_LOG_ADJACENCY_CHANGES
);SET_FLAG(ospf6->config_flags,OSPF6_LOG_ADJACENCY_DETAIL);returnCMD_SUCCESS;}DE
FUN(no_ospf6_log_adjacency_changes,no_ospf6_log_adjacency_changes_cmd,"nolog-adj
acency-changes",NO_STR"Logchangesinadjacencystate\n"){VTY_DECLVAR_CONTEXT(ospf6,
ospf6);UNSET_FLAG(ospf6->config_flags,OSPF6_LOG_ADJACENCY_DETAIL);UNSET_FLAG(osp
f6->config_flags,OSPF6_LOG_ADJACENCY_CHANGES);returnCMD_SUCCESS;}DEFUN(no_ospf6_
log_adjacency_changes_detail,no_ospf6_log_adjacency_changes_detail_cmd,"nolog-ad
jacency-changesdetail",NO_STR"Logchangesinadjacencystate\n""Logallstatechanges\n
"){VTY_DECLVAR_CONTEXT(ospf6,ospf6);UNSET_FLAG(ospf6->config_flags,OSPF6_LOG_ADJ
ACENCY_DETAIL);returnCMD_SUCCESS;}DEFUN(ospf6_timers_lsa,ospf6_timers_lsa_cmd,"t
imerslsamin-arrival(0-600000)","Adjustroutingtimers\n""OSPF6LSAtimers\n""Minimum
delayinreceivingnewversionofaLSA\n""Delayinmilliseconds\n"){VTY_DECLVAR_CONTEXT(
ospf6,ospf);intidx_number=3;unsignedintminarrival;minarrival=strtoul(argv[idx_nu
mber]->arg,NULL,10);ospf->lsa_minarrival=minarrival;returnCMD_SUCCESS;}DEFUN(no_
ospf6_timers_lsa,no_ospf6_timers_lsa_cmd,"notimerslsamin-arrival[(0-600000)]",NO
_STR"Adjustroutingtimers\n""OSPF6LSAtimers\n""Minimumdelayinreceivingnewversiono
faLSA\n""Delayinmilliseconds\n"){VTY_DECLVAR_CONTEXT(ospf6,ospf);intidx_number=4
;unsignedintminarrival;if(argc==5){minarrival=strtoul(argv[idx_number]->arg,NULL
,10);if(ospf->lsa_minarrival!=minarrival||minarrival==OSPF_MIN_LS_ARRIVAL)return
CMD_SUCCESS;}ospf->lsa_minarrival=OSPF_MIN_LS_ARRIVAL;returnCMD_SUCCESS;}DEFUN(o
spf6_distance,ospf6_distance_cmd,"distance(1-255)","Administrativedistance\n""OS
PF6Administrativedistance\n"){VTY_DECLVAR_CONTEXT(ospf6,o);o->distance_all=atoi(
argv[1]->arg);returnCMD_SUCCESS;}DEFUN(no_ospf6_distance,no_ospf6_distance_cmd,"
nodistance(1-255)",NO_STR"Administrativedistance\n""OSPF6Administrativedistance\
n"){VTY_DECLVAR_CONTEXT(ospf6,o);o->distance_all=0;returnCMD_SUCCESS;}DEFUN(ospf
6_distance_ospf6,ospf6_distance_ospf6_cmd,"distanceospf6{intra-area(1-255)|inter
-area(1-255)|external(1-255)}","Administrativedistance\n""OSPF6administrativedis
tance\n""Intra-arearoutes\n""Distanceforintra-arearoutes\n""Inter-arearoutes\n""
Distanceforinter-arearoutes\n""Externalroutes\n""Distanceforexternalroutes\n"){V
TY_DECLVAR_CONTEXT(ospf6,o);intidx=0;o->distance_intra=0;o->distance_inter=0;o->
distance_external=0;if(argv_find(argv,argc,"intra-area",&idx))o->distance_intra=
atoi(argv[idx+1]->arg);idx=0;if(argv_find(argv,argc,"inter-area",&idx))o->distan
ce_inter=atoi(argv[idx+1]->arg);idx=0;if(argv_find(argv,argc,"external",&idx))o-
>distance_external=atoi(argv[idx+1]->arg);returnCMD_SUCCESS;}DEFUN(no_ospf6_dist
ance_ospf6,no_ospf6_distance_ospf6_cmd,"nodistanceospf6[{intra-area[(1-255)]|int
er-area[(1-255)]|external[(1-255)]}]",NO_STR"Administrativedistance\n""OSPF6dist
ance\n""Intra-arearoutes\n""Distanceforintra-arearoutes\n""Inter-arearoutes\n""D
istanceforinter-arearoutes\n""Externalroutes\n""Distanceforexternalroutes\n"){VT
Y_DECLVAR_CONTEXT(ospf6,o);intidx=0;if(argv_find(argv,argc,"intra-area",&idx)||a
rgc==3)idx=o->distance_intra=0;if(argv_find(argv,argc,"inter-area",&idx)||argc==
3)idx=o->distance_inter=0;if(argv_find(argv,argc,"external",&idx)||argc==3)o->di
stance_external=0;returnCMD_SUCCESS;}#if0DEFUN(ospf6_distance_source,ospf6_dista
nce_source_cmd,"distance(1-255)X:X::X:X/M[WORD]","Administrativedistance\n""Dist
ancevalue\n""IPsourceprefix\n""Accesslistname\n"){VTY_DECLVAR_CONTEXT(ospf6,o);c
har*alname=(argc==4)?argv[3]->arg:NULL;ospf6_distance_set(vty,o,argv[1]->arg,arg
v[2]->arg,alname);returnCMD_SUCCESS;}DEFUN(no_ospf6_distance_source,no_ospf6_dis
tance_source_cmd,"nodistance(1-255)X:X::X:X/M[WORD]",NO_STR"Administrativedistan
ce\n""Distancevalue\n""IPsourceprefix\n""Accesslistname\n"){VTY_DECLVAR_CONTEXT(
ospf6,o);char*alname=(argc==5)?argv[4]->arg:NULL;ospf6_distance_unset(vty,o,argv
[2]->arg,argv[3]->arg,alname);returnCMD_SUCCESS;}#endifDEFUN(ospf6_interface_are
a,ospf6_interface_area_cmd,"interfaceIFNAMEareaA.B.C.D","EnableroutingonanIPv6in
terface\n"IFNAME_STR"SpecifytheOSPF6areaID\n""OSPF6areaIDinIPv4addressnotation\n
"){VTY_DECLVAR_CONTEXT(ospf6,o);intidx_ifname=1;intidx_ipv4=3;structospf6_area*o
a;structospf6_interface*oi;structinterface*ifp;uint32_tarea_id;/*find/createospf
6interface*/ifp=if_get_by_name(argv[idx_ifname]->arg,VRF_DEFAULT,0);oi=(structos
pf6_interface*)ifp->info;if(oi==NULL)oi=ospf6_interface_create(ifp);if(oi->area)
{vty_out(vty,"%salreadyattachedtoArea%s\n",oi->interface->name,oi->area->name);r
eturnCMD_SUCCESS;}/*parseArea-ID*/if(inet_pton(AF_INET,argv[idx_ipv4]->arg,&area
_id)!=1){vty_out(vty,"InvalidArea-ID:%s\n",argv[idx_ipv4]->arg);returnCMD_SUCCES
S;}/*find/createospf6area*/oa=ospf6_area_lookup(area_id,o);if(oa==NULL)oa=ospf6_
area_create(area_id,o,OSPF6_AREA_FMT_DOTTEDQUAD);/*attachinterfacetoarea*/listno
de_add(oa->if_list,oi);/*sort??*/oi->area=oa;SET_FLAG(oa->flag,OSPF6_AREA_ENABLE
);/*ospf6processiscurrentlydisabled,notmuchmoretodo*/if(CHECK_FLAG(o->flag,OSPF6
_DISABLED))returnCMD_SUCCESS;/*startup*/ospf6_interface_enable(oi);/*Iftherouter
isABR,originatesummaryroutes*/if(ospf6_is_router_abr(o))ospf6_abr_enable_area(oa
);returnCMD_SUCCESS;}DEFUN(no_ospf6_interface_area,no_ospf6_interface_area_cmd,"
nointerfaceIFNAMEareaA.B.C.D",NO_STR"DisableroutingonanIPv6interface\n"IFNAME_ST
R"SpecifytheOSPF6areaID\n""OSPF6areaIDinIPv4addressnotation\n"){intidx_ifname=2;
intidx_ipv4=4;structospf6_interface*oi;structospf6_area*oa;structinterface*ifp;u
int32_tarea_id;ifp=if_lookup_by_name(argv[idx_ifname]->arg,VRF_DEFAULT);if(ifp==
NULL){vty_out(vty,"Nosuchinterface%s\n",argv[idx_ifname]->arg);returnCMD_SUCCESS
;}oi=(structospf6_interface*)ifp->info;if(oi==NULL){vty_out(vty,"Interface%snote
nabled\n",ifp->name);returnCMD_SUCCESS;}/*parseArea-ID*/if(inet_pton(AF_INET,arg
v[idx_ipv4]->arg,&area_id)!=1){vty_out(vty,"InvalidArea-ID:%s\n",argv[idx_ipv4]-
>arg);returnCMD_SUCCESS;}/*VerifyArea*/if(oi->area==NULL){vty_out(vty,"NosuchAre
a-ID:%s\n",argv[idx_ipv4]->arg);returnCMD_SUCCESS;}if(oi->area->area_id!=area_id
){vty_out(vty,"WrongArea-ID:%sisattachedtoarea%s\n",oi->interface->name,oi->area
->name);returnCMD_SUCCESS;}thread_execute(master,interface_down,oi,0);oa=oi->are
a;listnode_delete(oi->area->if_list,oi);oi->area=(structospf6_area*)NULL;/*Withd
rawinter-arearoutesfromthisarea,ifnecessary*/if(oa->if_list->count==0){UNSET_FLA
G(oa->flag,OSPF6_AREA_ENABLE);ospf6_abr_disable_area(oa);}returnCMD_SUCCESS;}DEF
UN(ospf6_stub_router_admin,ospf6_stub_router_admin_cmd,"stub-routeradministrativ
e","Makerouterastubrouter\n""Administrativelyapplied,foranindefiniteperiod\n"){s
tructlistnode*node;structospf6_area*oa;if(!CHECK_FLAG(ospf6->flag,OSPF6_STUB_ROU
TER)){for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,node,oa)){OSPF6_OPT_CLEAR(oa->op
tions,OSPF6_OPT_V6);OSPF6_OPT_CLEAR(oa->options,OSPF6_OPT_R);OSPF6_ROUTER_LSA_SC
HEDULE(oa);}SET_FLAG(ospf6->flag,OSPF6_STUB_ROUTER);}returnCMD_SUCCESS;}DEFUN(no
_ospf6_stub_router_admin,no_ospf6_stub_router_admin_cmd,"nostub-routeradministra
tive",NO_STR"Makerouterastubrouter\n""Administrativelyapplied,foranindefiniteper
iod\n"){structlistnode*node;structospf6_area*oa;if(CHECK_FLAG(ospf6->flag,OSPF6_
STUB_ROUTER)){for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,node,oa)){OSPF6_OPT_SET(
oa->options,OSPF6_OPT_V6);OSPF6_OPT_SET(oa->options,OSPF6_OPT_R);OSPF6_ROUTER_LS
A_SCHEDULE(oa);}UNSET_FLAG(ospf6->flag,OSPF6_STUB_ROUTER);}returnCMD_SUCCESS;}#i
f0DEFUN(ospf6_stub_router_startup,ospf6_stub_router_startup_cmd,"stub-routeron-s
tartup(5-86400)","Makerouterastubrouter\n""Advertiseinabilitytobeatransitrouter\
n""Automaticallyadvertiseasstub-routeronstartupofOSPF6\n""Time(seconds)toadverti
seselfasstub-router\n"){returnCMD_SUCCESS;}DEFUN(no_ospf6_stub_router_startup,no
_ospf6_stub_router_startup_cmd,"nostub-routeron-startup",NO_STR"Makerouterastubr
outer\n""Advertiseinabilitytobeatransitrouter\n""Automaticallyadvertiseasstub-ro
uteronstartupofOSPF6\n""Time(seconds)toadvertiseselfasstub-router\n"){returnCMD_
SUCCESS;}DEFUN(ospf6_stub_router_shutdown,ospf6_stub_router_shutdown_cmd,"stub-r
outeron-shutdown(5-86400)","Makerouterastubrouter\n""Advertiseinabilitytobeatran
sitrouter\n""Automaticallyadvertiseasstub-routerbeforeshutdown\n""Time(seconds)t
oadvertiseselfasstub-router\n"){returnCMD_SUCCESS;}DEFUN(no_ospf6_stub_router_sh
utdown,no_ospf6_stub_router_shutdown_cmd,"nostub-routeron-shutdown",NO_STR"Maker
outerastubrouter\n""Advertiseinabilitytobeatransitrouter\n""Automaticallyadverti
seasstub-routerbeforeshutdown\n""Time(seconds)toadvertiseselfasstub-router\n"){r
eturnCMD_SUCCESS;}#endifstaticvoidospf6_show(structvty*vty,structospf6*o){struct
listnode*n;structospf6_area*oa;charrouter_id[16],duration[32];structtimevalnow,r
unning,result;charbuf[32],rbuf[32];/*processid,routerid*/inet_ntop(AF_INET,&o->r
outer_id,router_id,sizeof(router_id));vty_out(vty,"OSPFv3RoutingProcess(0)withRo
uter-ID%s\n",router_id);/*runningtime*/monotime(&now);timersub(&now,&o->starttim
e,&running);timerstring(&running,duration,sizeof(duration));vty_out(vty,"Running
%s\n",duration);/*Redistributeconfiguration*//*XXX*/vty_out(vty,"LSAminimumarriv
al%dmsecs\n",o->lsa_minarrival);/*ShowSPFparameters*/vty_out(vty,"InitialSPFsche
dulingdelay%dmillisec(s)\n""MinimumholdtimebetweenconsecutiveSPFs%dmillsecond(s)
\n""MaximumholdtimebetweenconsecutiveSPFs%dmillsecond(s)\n""Holdtimemultiplieris
currently%d\n",o->spf_delay,o->spf_holdtime,o->spf_max_holdtime,o->spf_hold_mult
iplier);vty_out(vty,"SPFalgorithm");if(o->ts_spf.tv_sec||o->ts_spf.tv_usec){time
rsub(&now,&o->ts_spf,&result);timerstring(&result,buf,sizeof(buf));ospf6_spf_rea
son_string(o->last_spf_reason,rbuf,sizeof(rbuf));vty_out(vty,"lastexecuted%sago,
reason%s\n",buf,rbuf);vty_out(vty,"LastSPFduration%lldsec%lldusec\n",(longlong)o
->ts_spf_duration.tv_sec,(longlong)o->ts_spf_duration.tv_usec);}elsevty_out(vty,
"hasnotbeenrun\n");threadtimer_string(now,o->t_spf_calc,buf,sizeof(buf));vty_out
(vty,"SPFtimer%s%s\n",(o->t_spf_calc?"duein":"is"),buf);if(CHECK_FLAG(o->flag,OS
PF6_STUB_ROUTER))vty_out(vty,"RouterIsStubRouter\n");/*LSAs*/vty_out(vty,"Number
ofASscopedLSAsis%u\n",o->lsdb->count);/*Areas*/vty_out(vty,"Numberofareasinthisr
outeris%u\n",listcount(o->area_list));if(CHECK_FLAG(o->config_flags,OSPF6_LOG_AD
JACENCY_CHANGES)){if(CHECK_FLAG(o->config_flags,OSPF6_LOG_ADJACENCY_DETAIL))vty_
out(vty,"Alladjacencychangesarelogged\n");elsevty_out(vty,"Adjacencychangesarelo
gged\n");}vty_out(vty,"\n");for(ALL_LIST_ELEMENTS_RO(o->area_list,n,oa))ospf6_ar
ea_show(vty,oa);}/*showtoplevelstructures*/DEFUN(show_ipv6_ospf6,show_ipv6_ospf6
_cmd,"showipv6ospf6",SHOW_STRIP6_STROSPF6_STR){OSPF6_CMD_CHECK_RUNNING();ospf6_s
how(vty,ospf6);returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_route,show_ipv6_ospf6_ro
ute_cmd,"showipv6ospf6route[<intra-area|inter-area|external-1|external-2|X:X::X:
X|X:X::X:X/M|detail|summary>]",SHOW_STRIP6_STROSPF6_STRROUTE_STR"DisplayIntra-Ar
earoutes\n""DisplayInter-Arearoutes\n""DisplayType-1Externalroutes\n""DisplayTyp
e-2Externalroutes\n""SpecifyIPv6address\n""SpecifyIPv6prefix\n""Detailedinformat
ion\n""Summaryofroutetable\n"){OSPF6_CMD_CHECK_RUNNING();ospf6_route_table_show(
vty,4,argc,argv,ospf6->route_table);returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_rou
te_match,show_ipv6_ospf6_route_match_cmd,"showipv6ospf6routeX:X::X:X/M<match|lon
ger>",SHOW_STRIP6_STROSPF6_STRROUTE_STR"SpecifyIPv6prefix\n""Displayrouteswhichm
atchthespecifiedroute\n""Displayrouteslongerthanthespecifiedroute\n"){OSPF6_CMD_
CHECK_RUNNING();ospf6_route_table_show(vty,4,argc,argv,ospf6->route_table);retur
nCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_route_match_detail,show_ipv6_ospf6_route_mat
ch_detail_cmd,"showipv6ospf6routeX:X::X:X/Mmatchdetail",SHOW_STRIP6_STROSPF6_STR
ROUTE_STR"SpecifyIPv6prefix\n""Displayrouteswhichmatchthespecifiedroute\n""Detai
ledinformation\n"){OSPF6_CMD_CHECK_RUNNING();ospf6_route_table_show(vty,4,argc,a
rgv,ospf6->route_table);returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_route_type_deta
il,show_ipv6_ospf6_route_type_detail_cmd,"showipv6ospf6route<intra-area|inter-ar
ea|external-1|external-2>detail",SHOW_STRIP6_STROSPF6_STRROUTE_STR"DisplayIntra-
Arearoutes\n""DisplayInter-Arearoutes\n""DisplayType-1Externalroutes\n""DisplayT
ype-2Externalroutes\n""Detailedinformation\n"){OSPF6_CMD_CHECK_RUNNING();ospf6_r
oute_table_show(vty,4,argc,argv,ospf6->route_table);returnCMD_SUCCESS;}staticvoi
dospf6_stub_router_config_write(structvty*vty){if(CHECK_FLAG(ospf6->flag,OSPF6_S
TUB_ROUTER)){vty_out(vty,"stub-routeradministrative\n");}return;}staticintospf6_
distance_config_write(structvty*vty){structroute_node*rn;structospf6_distance*od
istance;if(ospf6->distance_all)vty_out(vty,"distance%u\n",ospf6->distance_all);i
f(ospf6->distance_intra||ospf6->distance_inter||ospf6->distance_external){vty_ou
t(vty,"distanceospf6");if(ospf6->distance_intra)vty_out(vty,"intra-area%u",ospf6
->distance_intra);if(ospf6->distance_inter)vty_out(vty,"inter-area%u",ospf6->dis
tance_inter);if(ospf6->distance_external)vty_out(vty,"external%u",ospf6->distanc
e_external);vty_out(vty,"\n");}for(rn=route_top(ospf6->distance_table);rn;rn=rou
te_next(rn))if((odistance=rn->info)!=NULL){charbuf[PREFIX_STRLEN];vty_out(vty,"d
istance%u%s%s\n",odistance->distance,prefix2str(&rn->p,buf,sizeof(buf)),odistanc
e->access_list?odistance->access_list:"");}return0;}/*OSPFconfigurationwritefunc
tion.*/staticintconfig_write_ospf6(structvty*vty){charrouter_id[16];structlistno
de*j,*k;structospf6_area*oa;structospf6_interface*oi;/*OSPFv3configuration.*/if(
ospf6==NULL)returnCMD_SUCCESS;inet_ntop(AF_INET,&ospf6->router_id_static,router_
id,sizeof(router_id));vty_out(vty,"routerospf6\n");if(ospf6->router_id_static!=0
)vty_out(vty,"ospf6router-id%s\n",router_id);/*log-adjacency-changesflagprint.*/
if(CHECK_FLAG(ospf6->config_flags,OSPF6_LOG_ADJACENCY_CHANGES)){if(CHECK_FLAG(os
pf6->config_flags,OSPF6_LOG_ADJACENCY_DETAIL))vty_out(vty,"log-adjacency-changes
detail\n");elseif(!DFLT_OSPF6_LOG_ADJACENCY_CHANGES)vty_out(vty,"log-adjacency-c
hanges\n");}elseif(DFLT_OSPF6_LOG_ADJACENCY_CHANGES){vty_out(vty,"nolog-adjacenc
y-changes\n");}if(ospf6->ref_bandwidth!=OSPF6_REFERENCE_BANDWIDTH)vty_out(vty,"a
uto-costreference-bandwidth%d\n",ospf6->ref_bandwidth);/*LSAtimersprint.*/if(osp
f6->lsa_minarrival!=OSPF_MIN_LS_ARRIVAL)vty_out(vty,"timerslsamin-arrival%d\n",o
spf6->lsa_minarrival);ospf6_stub_router_config_write(vty);ospf6_redistribute_con
fig_write(vty);ospf6_area_config_write(vty);ospf6_spf_config_write(vty);ospf6_di
stance_config_write(vty);for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,j,oa)){for(AL
L_LIST_ELEMENTS_RO(oa->if_list,k,oi))vty_out(vty,"interface%sarea%s\n",oi->inter
face->name,oa->name);}vty_out(vty,"!\n");return0;}/*OSPF6nodestructure.*/statics
tructcmd_nodeospf6_node={OSPF6_NODE,"%s(config-ospf6)#",1/*VTYSH*/};/*Installosp
frelatedcommands.*/voidospf6_top_init(void){/*Installospf6topnode.*/install_node
(&ospf6_node,config_write_ospf6);install_element(VIEW_NODE,&show_ipv6_ospf6_cmd)
;install_element(CONFIG_NODE,&router_ospf6_cmd);install_element(CONFIG_NODE,&no_
router_ospf6_cmd);install_element(VIEW_NODE,&show_ipv6_ospf6_route_cmd);install_
element(VIEW_NODE,&show_ipv6_ospf6_route_match_cmd);install_element(VIEW_NODE,&s
how_ipv6_ospf6_route_match_detail_cmd);install_element(VIEW_NODE,&show_ipv6_ospf
6_route_type_detail_cmd);install_default(OSPF6_NODE);install_element(OSPF6_NODE,
&ospf6_router_id_cmd);install_element(OSPF6_NODE,&no_ospf6_router_id_cmd);instal
l_element(OSPF6_NODE,&ospf6_router_id_hdn_cmd);install_element(OSPF6_NODE,&no_os
pf6_router_id_hdn_cmd);install_element(OSPF6_NODE,&ospf6_log_adjacency_changes_c
md);install_element(OSPF6_NODE,&ospf6_log_adjacency_changes_detail_cmd);install_
element(OSPF6_NODE,&no_ospf6_log_adjacency_changes_cmd);install_element(OSPF6_NO
DE,&no_ospf6_log_adjacency_changes_detail_cmd);/*LSAtimerscommands*/install_elem
ent(OSPF6_NODE,&ospf6_timers_lsa_cmd);install_element(OSPF6_NODE,&no_ospf6_timer
s_lsa_cmd);install_element(OSPF6_NODE,&ospf6_interface_area_cmd);install_element
(OSPF6_NODE,&no_ospf6_interface_area_cmd);install_element(OSPF6_NODE,&ospf6_stub
_router_admin_cmd);install_element(OSPF6_NODE,&no_ospf6_stub_router_admin_cmd);/
*Foralatertime*/#if0install_element(OSPF6_NODE,&ospf6_stub_router_startup_cmd);i
nstall_element(OSPF6_NODE,&no_ospf6_stub_router_startup_cmd);install_element(OSP
F6_NODE,&ospf6_stub_router_shutdown_cmd);install_element(OSPF6_NODE,&no_ospf6_st
ub_router_shutdown_cmd);#endifinstall_element(OSPF6_NODE,&ospf6_distance_cmd);in
stall_element(OSPF6_NODE,&no_ospf6_distance_cmd);install_element(OSPF6_NODE,&osp
f6_distance_ospf6_cmd);install_element(OSPF6_NODE,&no_ospf6_distance_ospf6_cmd);
#if0install_element(OSPF6_NODE,&ospf6_distance_source_cmd);install_element(OSPF6
_NODE,&no_ospf6_distance_source_cmd);#endif}