/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"log.h"#include"memory.h"#include"thread.h"#include"linklist.
h"#include"vty.h"#include"command.h"#include"ospf6_proto.h"#include"ospf6_lsa.h"
#include"ospf6_lsdb.h"#include"ospf6_message.h"#include"ospf6_top.h"#include"osp
f6_area.h"#include"ospf6_interface.h"#include"ospf6_neighbor.h"#include"ospf6_in
tra.h"#include"ospf6_flood.h"#include"ospf6d.h"#include"ospf6_bfd.h"#include"osp
f6_abr.h"#include"ospf6_asbr.h"#include"ospf6_lsa.h"#include"ospf6_spf.h"#includ
e"ospf6_zebra.h"DEFINE_HOOK(ospf6_neighbor_change,(structospf6_neighbor*on,intst
ate,intnext_state),(on,state,next_state))unsignedcharconf_debug_ospf6_neighbor=0
;constchar*ospf6_neighbor_state_str[]={"None","Down","Attempt","Init","Twoway","
ExStart","ExChange","Loading","Full",NULL};intospf6_neighbor_cmp(void*va,void*vb
){structospf6_neighbor*ona=(structospf6_neighbor*)va;structospf6_neighbor*onb=(s
tructospf6_neighbor*)vb;return(ntohl(ona->router_id)<ntohl(onb->router_id)?-1:1)
;}structospf6_neighbor*ospf6_neighbor_lookup(uint32_trouter_id,structospf6_inter
face*oi){structlistnode*n;structospf6_neighbor*on;for(ALL_LIST_ELEMENTS_RO(oi->n
eighbor_list,n,on))if(on->router_id==router_id)returnon;return(structospf6_neigh
bor*)NULL;}/*createospf6_neighbor*/structospf6_neighbor*ospf6_neighbor_create(ui
nt32_trouter_id,structospf6_interface*oi){structospf6_neighbor*on;charbuf[16];on
=(structospf6_neighbor*)XMALLOC(MTYPE_OSPF6_NEIGHBOR,sizeof(structospf6_neighbor
));if(on==NULL){zlog_warn("neighbor:mallocfailed");returnNULL;}memset(on,0,sizeo
f(structospf6_neighbor));inet_ntop(AF_INET,&router_id,buf,sizeof(buf));snprintf(
on->name,sizeof(on->name),"%s%%%s",buf,oi->interface->name);on->ospf6_if=oi;on->
state=OSPF6_NEIGHBOR_DOWN;on->state_change=0;monotime(&on->last_changed);on->rou
ter_id=router_id;on->summary_list=ospf6_lsdb_create(on);on->request_list=ospf6_l
sdb_create(on);on->retrans_list=ospf6_lsdb_create(on);on->dbdesc_list=ospf6_lsdb
_create(on);on->lsupdate_list=ospf6_lsdb_create(on);on->lsack_list=ospf6_lsdb_cr
eate(on);listnode_add_sort(oi->neighbor_list,on);ospf6_bfd_info_nbr_create(oi,on
);returnon;}voidospf6_neighbor_delete(structospf6_neighbor*on){structospf6_lsa*l
sa;ospf6_lsdb_remove_all(on->summary_list);ospf6_lsdb_remove_all(on->request_lis
t);for(ALL_LSDB(on->retrans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_
lsdb_remove(lsa,on->retrans_list);}ospf6_lsdb_remove_all(on->dbdesc_list);ospf6_
lsdb_remove_all(on->lsupdate_list);ospf6_lsdb_remove_all(on->lsack_list);ospf6_l
sdb_delete(on->summary_list);ospf6_lsdb_delete(on->request_list);ospf6_lsdb_dele
te(on->retrans_list);ospf6_lsdb_delete(on->dbdesc_list);ospf6_lsdb_delete(on->ls
update_list);ospf6_lsdb_delete(on->lsack_list);THREAD_OFF(on->inactivity_timer);
THREAD_OFF(on->thread_send_dbdesc);THREAD_OFF(on->thread_send_lsreq);THREAD_OFF(
on->thread_send_lsupdate);THREAD_OFF(on->thread_send_lsack);ospf6_bfd_reg_dereg_
nbr(on,ZEBRA_BFD_DEST_DEREGISTER);XFREE(MTYPE_OSPF6_NEIGHBOR,on);}staticvoidospf
6_neighbor_state_change(uint8_tnext_state,structospf6_neighbor*on,intevent){uint
8_tprev_state;prev_state=on->state;on->state=next_state;if(prev_state==next_stat
e)return;on->state_change++;monotime(&on->last_changed);/*log*/if(IS_OSPF6_DEBUG
_NEIGHBOR(STATE)){zlog_debug("Neighborstatechange%s:[%s]->[%s](%s)",on->name,osp
f6_neighbor_state_str[prev_state],ospf6_neighbor_state_str[next_state],ospf6_nei
ghbor_event_string(event));}/*Optionallynotifyaboutadjacencychanges*/if(CHECK_FL
AG(on->ospf6_if->area->ospf6->config_flags,OSPF6_LOG_ADJACENCY_CHANGES)&&(CHECK_
FLAG(on->ospf6_if->area->ospf6->config_flags,OSPF6_LOG_ADJACENCY_DETAIL)||(next_
state==OSPF6_NEIGHBOR_FULL)||(next_state<prev_state)))zlog_notice("AdjChg:Nbr%s:
%s->%s(%s)",on->name,ospf6_neighbor_state_str[prev_state],ospf6_neighbor_state_s
tr[next_state],ospf6_neighbor_event_string(event));if(prev_state==OSPF6_NEIGHBOR
_FULL||next_state==OSPF6_NEIGHBOR_FULL){OSPF6_ROUTER_LSA_SCHEDULE(on->ospf6_if->
area);if(on->ospf6_if->state==OSPF6_INTERFACE_DR){OSPF6_NETWORK_LSA_SCHEDULE(on-
>ospf6_if);OSPF6_INTRA_PREFIX_LSA_SCHEDULE_TRANSIT(on->ospf6_if);}if(next_state=
=OSPF6_NEIGHBOR_FULL)on->ospf6_if->area->intra_prefix_originate=1;OSPF6_INTRA_PR
EFIX_LSA_SCHEDULE_STUB(on->ospf6_if->area);if(prev_state==OSPF6_NEIGHBOR_LOADING
&&next_state==OSPF6_NEIGHBOR_FULL){OSPF6_AS_EXTERN_LSA_SCHEDULE(on->ospf6_if);on
->ospf6_if->area->full_nbrs++;}if(prev_state==OSPF6_NEIGHBOR_FULL)on->ospf6_if->
area->full_nbrs--;}if((prev_state==OSPF6_NEIGHBOR_EXCHANGE||prev_state==OSPF6_NE
IGHBOR_LOADING)&&(next_state!=OSPF6_NEIGHBOR_EXCHANGE&&next_state!=OSPF6_NEIGHBO
R_LOADING))ospf6_maxage_remove(on->ospf6_if->area->ospf6);hook_call(ospf6_neighb
or_change,on,next_state,prev_state);ospf6_bfd_trigger_event(on,prev_state,next_s
tate);}/*RFC2328section10.4*/staticintneed_adjacency(structospf6_neighbor*on){if
(on->ospf6_if->state==OSPF6_INTERFACE_POINTTOPOINT||on->ospf6_if->state==OSPF6_I
NTERFACE_DR||on->ospf6_if->state==OSPF6_INTERFACE_BDR)return1;if(on->ospf6_if->d
router==on->router_id||on->ospf6_if->bdrouter==on->router_id)return1;return0;}in
thello_received(structthread*thread){structospf6_neighbor*on;on=(structospf6_nei
ghbor*)THREAD_ARG(thread);assert(on);if(IS_OSPF6_DEBUG_NEIGHBOR(EVENT))zlog_debu
g("NeighborEvent%s:*HelloReceived*",on->name);/*resetInactivityTimer*/THREAD_OFF
(on->inactivity_timer);on->inactivity_timer=NULL;thread_add_timer(master,inactiv
ity_timer,on,on->ospf6_if->dead_interval,&on->inactivity_timer);if(on->state<=OS
PF6_NEIGHBOR_DOWN)ospf6_neighbor_state_change(OSPF6_NEIGHBOR_INIT,on,OSPF6_NEIGH
BOR_EVENT_HELLO_RCVD);return0;}inttwoway_received(structthread*thread){structosp
f6_neighbor*on;on=(structospf6_neighbor*)THREAD_ARG(thread);assert(on);if(on->st
ate>OSPF6_NEIGHBOR_INIT)return0;if(IS_OSPF6_DEBUG_NEIGHBOR(EVENT))zlog_debug("Ne
ighborEvent%s:*2Way-Received*",on->name);thread_add_event(master,neighbor_change
,on->ospf6_if,0,NULL);if(!need_adjacency(on)){ospf6_neighbor_state_change(OSPF6_
NEIGHBOR_TWOWAY,on,OSPF6_NEIGHBOR_EVENT_TWOWAY_RCVD);return0;}ospf6_neighbor_sta
te_change(OSPF6_NEIGHBOR_EXSTART,on,OSPF6_NEIGHBOR_EVENT_TWOWAY_RCVD);SET_FLAG(o
n->dbdesc_bits,OSPF6_DBDESC_MSBIT);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MBIT);S
ET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT);THREAD_OFF(on->thread_send_dbdesc);on
->thread_send_dbdesc=NULL;thread_add_event(master,ospf6_dbdesc_send,on,0,&on->th
read_send_dbdesc);return0;}intnegotiation_done(structthread*thread){structospf6_
neighbor*on;structospf6_lsa*lsa;on=(structospf6_neighbor*)THREAD_ARG(thread);ass
ert(on);if(on->state!=OSPF6_NEIGHBOR_EXSTART)return0;if(IS_OSPF6_DEBUG_NEIGHBOR(
EVENT))zlog_debug("NeighborEvent%s:*NegotiationDone*",on->name);/*clearls-list*/
ospf6_lsdb_remove_all(on->summary_list);ospf6_lsdb_remove_all(on->request_list);
for(ALL_LSDB(on->retrans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_lsd
b_remove(lsa,on->retrans_list);}/*InterfacescopedLSAs*/for(ALL_LSDB(on->ospf6_if
->lsdb,lsa)){if(OSPF6_LSA_IS_MAXAGE(lsa)){ospf6_increment_retrans_count(lsa);osp
f6_lsdb_add(ospf6_lsa_copy(lsa),on->retrans_list);}elseospf6_lsdb_add(ospf6_lsa_
copy(lsa),on->summary_list);}/*AreascopedLSAs*/for(ALL_LSDB(on->ospf6_if->area->
lsdb,lsa)){if(OSPF6_LSA_IS_MAXAGE(lsa)){ospf6_increment_retrans_count(lsa);ospf6
_lsdb_add(ospf6_lsa_copy(lsa),on->retrans_list);}elseospf6_lsdb_add(ospf6_lsa_co
py(lsa),on->summary_list);}/*ASscopedLSAs*/for(ALL_LSDB(on->ospf6_if->area->ospf
6->lsdb,lsa)){if(OSPF6_LSA_IS_MAXAGE(lsa)){ospf6_increment_retrans_count(lsa);os
pf6_lsdb_add(ospf6_lsa_copy(lsa),on->retrans_list);}elseospf6_lsdb_add(ospf6_lsa
_copy(lsa),on->summary_list);}UNSET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT);ospf
6_neighbor_state_change(OSPF6_NEIGHBOR_EXCHANGE,on,OSPF6_NEIGHBOR_EVENT_NEGOTIAT
ION_DONE);return0;}intexchange_done(structthread*thread){structospf6_neighbor*on
;on=(structospf6_neighbor*)THREAD_ARG(thread);assert(on);if(on->state!=OSPF6_NEI
GHBOR_EXCHANGE)return0;if(IS_OSPF6_DEBUG_NEIGHBOR(EVENT))zlog_debug("NeighborEve
nt%s:*ExchangeDone*",on->name);THREAD_OFF(on->thread_send_dbdesc);ospf6_lsdb_rem
ove_all(on->dbdesc_list);/*XXXthread_add_timer(master,ospf6_neighbor_last_dbdesc
_release,on,on->ospf6_if->dead_interval);*/if(on->request_list->count==0)ospf6_n
eighbor_state_change(OSPF6_NEIGHBOR_FULL,on,OSPF6_NEIGHBOR_EVENT_EXCHANGE_DONE);
else{ospf6_neighbor_state_change(OSPF6_NEIGHBOR_LOADING,on,OSPF6_NEIGHBOR_EVENT_
EXCHANGE_DONE);thread_add_event(master,ospf6_lsreq_send,on,0,&on->thread_send_ls
req);}return0;}/*Checkloadingstate.*/voidospf6_check_nbr_loading(structospf6_nei
ghbor*on){/*RFC2328Section10.9:Whentheneighborrespondstotheserequestswiththeprop
erLinkStateUpdatepacket(s),theLinkstaterequestlististruncatedandanewLinkStateReq
uestpacketissent.*/if((on->state==OSPF6_NEIGHBOR_LOADING)||(on->state==OSPF6_NEI
GHBOR_EXCHANGE)){if(on->request_list->count==0)thread_add_event(master,loading_d
one,on,0,NULL);elseif(on->last_ls_req==NULL){if(on->thread_send_lsreq!=NULL)THRE
AD_OFF(on->thread_send_lsreq);on->thread_send_lsreq=NULL;thread_add_event(master
,ospf6_lsreq_send,on,0,&on->thread_send_lsreq);}}}intloading_done(structthread*t
hread){structospf6_neighbor*on;on=(structospf6_neighbor*)THREAD_ARG(thread);asse
rt(on);if(on->state!=OSPF6_NEIGHBOR_LOADING)return0;if(IS_OSPF6_DEBUG_NEIGHBOR(E
VENT))zlog_debug("NeighborEvent%s:*LoadingDone*",on->name);assert(on->request_li
st->count==0);ospf6_neighbor_state_change(OSPF6_NEIGHBOR_FULL,on,OSPF6_NEIGHBOR_
EVENT_LOADING_DONE);return0;}intadj_ok(structthread*thread){structospf6_neighbor
*on;structospf6_lsa*lsa;on=(structospf6_neighbor*)THREAD_ARG(thread);assert(on);
if(IS_OSPF6_DEBUG_NEIGHBOR(EVENT))zlog_debug("NeighborEvent%s:*AdjOK?*",on->name
);if(on->state==OSPF6_NEIGHBOR_TWOWAY&&need_adjacency(on)){ospf6_neighbor_state_
change(OSPF6_NEIGHBOR_EXSTART,on,OSPF6_NEIGHBOR_EVENT_ADJ_OK);SET_FLAG(on->dbdes
c_bits,OSPF6_DBDESC_MSBIT);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MBIT);SET_FLAG(
on->dbdesc_bits,OSPF6_DBDESC_IBIT);THREAD_OFF(on->thread_send_dbdesc);on->thread
_send_dbdesc=NULL;thread_add_event(master,ospf6_dbdesc_send,on,0,&on->thread_sen
d_dbdesc);}elseif(on->state>=OSPF6_NEIGHBOR_EXSTART&&!need_adjacency(on)){ospf6_
neighbor_state_change(OSPF6_NEIGHBOR_TWOWAY,on,OSPF6_NEIGHBOR_EVENT_ADJ_OK);ospf
6_lsdb_remove_all(on->summary_list);ospf6_lsdb_remove_all(on->request_list);for(
ALL_LSDB(on->retrans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_lsdb_re
move(lsa,on->retrans_list);}}return0;}intseqnumber_mismatch(structthread*thread)
{structospf6_neighbor*on;structospf6_lsa*lsa;on=(structospf6_neighbor*)THREAD_AR
G(thread);assert(on);if(on->state<OSPF6_NEIGHBOR_EXCHANGE)return0;if(IS_OSPF6_DE
BUG_NEIGHBOR(EVENT))zlog_debug("NeighborEvent%s:*SeqNumberMismatch*",on->name);o
spf6_neighbor_state_change(OSPF6_NEIGHBOR_EXSTART,on,OSPF6_NEIGHBOR_EVENT_SEQNUM
BER_MISMATCH);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT);SET_FLAG(on->dbdesc_b
its,OSPF6_DBDESC_MBIT);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT);ospf6_lsdb_re
move_all(on->summary_list);ospf6_lsdb_remove_all(on->request_list);for(ALL_LSDB(
on->retrans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_lsdb_remove(lsa,
on->retrans_list);}THREAD_OFF(on->thread_send_dbdesc);on->dbdesc_seqnum++;/*Incr
seqnumasperRFC2328,sec10.3*/on->thread_send_dbdesc=NULL;thread_add_event(master,
ospf6_dbdesc_send,on,0,&on->thread_send_dbdesc);return0;}intbad_lsreq(structthre
ad*thread){structospf6_neighbor*on;structospf6_lsa*lsa;on=(structospf6_neighbor*
)THREAD_ARG(thread);assert(on);if(on->state<OSPF6_NEIGHBOR_EXCHANGE)return0;if(I
S_OSPF6_DEBUG_NEIGHBOR(EVENT))zlog_debug("NeighborEvent%s:*BadLSReq*",on->name);
ospf6_neighbor_state_change(OSPF6_NEIGHBOR_EXSTART,on,OSPF6_NEIGHBOR_EVENT_BAD_L
SREQ);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT);SET_FLAG(on->dbdesc_bits,OSPF
6_DBDESC_MBIT);SET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT);ospf6_lsdb_remove_all
(on->summary_list);ospf6_lsdb_remove_all(on->request_list);for(ALL_LSDB(on->retr
ans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_lsdb_remove(lsa,on->retr
ans_list);}THREAD_OFF(on->thread_send_dbdesc);on->dbdesc_seqnum++;/*Incrseqnumas
perRFC2328,sec10.3*/on->thread_send_dbdesc=NULL;thread_add_event(master,ospf6_db
desc_send,on,0,&on->thread_send_dbdesc);return0;}intoneway_received(structthread
*thread){structospf6_neighbor*on;structospf6_lsa*lsa;on=(structospf6_neighbor*)T
HREAD_ARG(thread);assert(on);if(on->state<OSPF6_NEIGHBOR_TWOWAY)return0;if(IS_OS
PF6_DEBUG_NEIGHBOR(EVENT))zlog_debug("NeighborEvent%s:*1Way-Received*",on->name)
;ospf6_neighbor_state_change(OSPF6_NEIGHBOR_INIT,on,OSPF6_NEIGHBOR_EVENT_ONEWAY_
RCVD);thread_add_event(master,neighbor_change,on->ospf6_if,0,NULL);ospf6_lsdb_re
move_all(on->summary_list);ospf6_lsdb_remove_all(on->request_list);for(ALL_LSDB(
on->retrans_list,lsa)){ospf6_decrement_retrans_count(lsa);ospf6_lsdb_remove(lsa,
on->retrans_list);}THREAD_OFF(on->thread_send_dbdesc);THREAD_OFF(on->thread_send
_lsreq);THREAD_OFF(on->thread_send_lsupdate);THREAD_OFF(on->thread_send_lsack);r
eturn0;}intinactivity_timer(structthread*thread){structospf6_neighbor*on;on=(str
uctospf6_neighbor*)THREAD_ARG(thread);assert(on);if(IS_OSPF6_DEBUG_NEIGHBOR(EVEN
T))zlog_debug("NeighborEvent%s:*InactivityTimer*",on->name);on->inactivity_timer
=NULL;on->drouter=on->prev_drouter=0;on->bdrouter=on->prev_bdrouter=0;ospf6_neig
hbor_state_change(OSPF6_NEIGHBOR_DOWN,on,OSPF6_NEIGHBOR_EVENT_INACTIVITY_TIMER);
thread_add_event(master,neighbor_change,on->ospf6_if,0,NULL);listnode_delete(on-
>ospf6_if->neighbor_list,on);ospf6_neighbor_delete(on);return0;}/*vtyfunctions*/
/*showneighborstructure*/staticvoidospf6_neighbor_show(structvty*vty,structospf6
_neighbor*on){charrouter_id[16];charduration[64];structtimevalres;charnstate[16]
;chardeadtime[64];longh,m,s;/*Router-ID(Name)*/inet_ntop(AF_INET,&on->router_id,
router_id,sizeof(router_id));#ifdefHAVE_GETNAMEINFO{}#endif/*HAVE_GETNAMEINFO*//
*Deadtime*/h=m=s=0;if(on->inactivity_timer){s=monotime_until(&on->inactivity_tim
er->u.sands,NULL)/1000000LL;h=s/3600;s-=h*3600;m=s/60;s-=m*60;}snprintf(deadtime
,sizeof(deadtime),"%02ld:%02ld:%02ld",h,m,s);/*NeighborState*/if(if_is_pointopoi
nt(on->ospf6_if->interface))snprintf(nstate,sizeof(nstate),"PointToPoint");else{
if(on->router_id==on->drouter)snprintf(nstate,sizeof(nstate),"DR");elseif(on->ro
uter_id==on->bdrouter)snprintf(nstate,sizeof(nstate),"BDR");elsesnprintf(nstate,
sizeof(nstate),"DROther");}/*Duration*/monotime_since(&on->last_changed,&res);ti
merstring(&res,duration,sizeof(duration));/*vty_out(vty,"%-15s%3d%11s%6s/%-12s%1
1s%s[%s]\n","NeighborID","Pri","DeadTime","State","","Duration","I/F","State");*
/vty_out(vty,"%-15s%3d%11s%8s/%-12s%11s%s[%s]\n",router_id,on->priority,deadtime
,ospf6_neighbor_state_str[on->state],nstate,duration,on->ospf6_if->interface->na
me,ospf6_interface_state_str[on->ospf6_if->state]);}staticvoidospf6_neighbor_sho
w_drchoice(structvty*vty,structospf6_neighbor*on){charrouter_id[16];chardrouter[
16],bdrouter[16];charduration[64];structtimevalnow,res;/*vty_out(vty,"%-15s%6s/%
-11s%-15s%-15s%s[%s]\n","RouterID","State","Duration","DR","BDR","I/F","State");
*/inet_ntop(AF_INET,&on->router_id,router_id,sizeof(router_id));inet_ntop(AF_INE
T,&on->drouter,drouter,sizeof(drouter));inet_ntop(AF_INET,&on->bdrouter,bdrouter
,sizeof(bdrouter));monotime(&now);timersub(&now,&on->last_changed,&res);timerstr
ing(&res,duration,sizeof(duration));vty_out(vty,"%-15s%8s/%-11s%-15s%-15s%s[%s]\
n",router_id,ospf6_neighbor_state_str[on->state],duration,drouter,bdrouter,on->o
spf6_if->interface->name,ospf6_interface_state_str[on->ospf6_if->state]);}static
voidospf6_neighbor_show_detail(structvty*vty,structospf6_neighbor*on){chardroute
r[16],bdrouter[16];charlinklocal_addr[64],duration[32];structtimevalnow,res;stru
ctospf6_lsa*lsa;inet_ntop(AF_INET6,&on->linklocal_addr,linklocal_addr,sizeof(lin
klocal_addr));inet_ntop(AF_INET,&on->drouter,drouter,sizeof(drouter));inet_ntop(
AF_INET,&on->bdrouter,bdrouter,sizeof(bdrouter));monotime(&now);timersub(&now,&o
n->last_changed,&res);timerstring(&res,duration,sizeof(duration));vty_out(vty,"N
eighbor%s\n",on->name);vty_out(vty,"Area%sviainterface%s(ifindex%d)\n",on->ospf6
_if->area->name,on->ospf6_if->interface->name,on->ospf6_if->interface->ifindex);
vty_out(vty,"HisIfIndex:%dLink-localaddress:%s\n",on->ifindex,linklocal_addr);vt
y_out(vty,"State%sforadurationof%s\n",ospf6_neighbor_state_str[on->state],durati
on);vty_out(vty,"HischoiceofDR/BDR%s/%s,Priority%d\n",drouter,bdrouter,on->prior
ity);vty_out(vty,"DbDescstatus:%s%s%sSeqNum:%#lx\n",(CHECK_FLAG(on->dbdesc_bits,
OSPF6_DBDESC_IBIT)?"Initial":""),(CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MBIT)?
"More":""),(CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT)?"Master":"Slave"),(un
signedlong)ntohl(on->dbdesc_seqnum));vty_out(vty,"Summary-List:%dLSAs\n",on->sum
mary_list->count);for(ALL_LSDB(on->summary_list,lsa))vty_out(vty,"%s\n",lsa->nam
e);vty_out(vty,"Request-List:%dLSAs\n",on->request_list->count);for(ALL_LSDB(on-
>request_list,lsa))vty_out(vty,"%s\n",lsa->name);vty_out(vty,"Retrans-List:%dLSA
s\n",on->retrans_list->count);for(ALL_LSDB(on->retrans_list,lsa))vty_out(vty,"%s
\n",lsa->name);timerclear(&res);if(on->thread_send_dbdesc)timersub(&on->thread_s
end_dbdesc->u.sands,&now,&res);timerstring(&res,duration,sizeof(duration));vty_o
ut(vty,"%dPendingLSAsforDbDescinTime%s[thread%s]\n",on->dbdesc_list->count,durat
ion,(on->thread_send_dbdesc?"on":"off"));for(ALL_LSDB(on->dbdesc_list,lsa))vty_o
ut(vty,"%s\n",lsa->name);timerclear(&res);if(on->thread_send_lsreq)timersub(&on-
>thread_send_lsreq->u.sands,&now,&res);timerstring(&res,duration,sizeof(duration
));vty_out(vty,"%dPendingLSAsforLSReqinTime%s[thread%s]\n",on->request_list->cou
nt,duration,(on->thread_send_lsreq?"on":"off"));for(ALL_LSDB(on->request_list,ls
a))vty_out(vty,"%s\n",lsa->name);timerclear(&res);if(on->thread_send_lsupdate)ti
mersub(&on->thread_send_lsupdate->u.sands,&now,&res);timerstring(&res,duration,s
izeof(duration));vty_out(vty,"%dPendingLSAsforLSUpdateinTime%s[thread%s]\n",on->
lsupdate_list->count,duration,(on->thread_send_lsupdate?"on":"off"));for(ALL_LSD
B(on->lsupdate_list,lsa))vty_out(vty,"%s\n",lsa->name);timerclear(&res);if(on->t
hread_send_lsack)timersub(&on->thread_send_lsack->u.sands,&now,&res);timerstring
(&res,duration,sizeof(duration));vty_out(vty,"%dPendingLSAsforLSAckinTime%s[thre
ad%s]\n",on->lsack_list->count,duration,(on->thread_send_lsack?"on":"off"));for(
ALL_LSDB(on->lsack_list,lsa))vty_out(vty,"%s\n",lsa->name);ospf6_bfd_show_info(v
ty,on->bfd_info,0);}DEFUN(show_ipv6_ospf6_neighbor,show_ipv6_ospf6_neighbor_cmd,
"showipv6ospf6neighbor[<detail|drchoice>]",SHOW_STRIP6_STROSPF6_STR"Neighborlist
\n""Displaydetails\n""DisplayDRchoices\n"){intidx_type=4;structospf6_neighbor*on
;structospf6_interface*oi;structospf6_area*oa;structlistnode*i,*j,*k;void(*showf
unc)(structvty*,structospf6_neighbor*);OSPF6_CMD_CHECK_RUNNING();showfunc=ospf6_
neighbor_show;if(argc==5){if(!strncmp(argv[idx_type]->arg,"de",2))showfunc=ospf6
_neighbor_show_detail;elseif(!strncmp(argv[idx_type]->arg,"dr",2))showfunc=ospf6
_neighbor_show_drchoice;}if(showfunc==ospf6_neighbor_show)vty_out(vty,"%-15s%3s%
11s%8s/%-12s%11s%s[%s]\n","NeighborID","Pri","DeadTime","State","IfState","Durat
ion","I/F","State");elseif(showfunc==ospf6_neighbor_show_drchoice)vty_out(vty,"%
-15s%8s/%-11s%-15s%-15s%s[%s]\n","RouterID","State","Duration","DR","BDR","I/F",
"State");for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,i,oa))for(ALL_LIST_ELEMENTS_R
O(oa->if_list,j,oi))for(ALL_LIST_ELEMENTS_RO(oi->neighbor_list,k,on))(*showfunc)
(vty,on);returnCMD_SUCCESS;}DEFUN(show_ipv6_ospf6_neighbor_one,show_ipv6_ospf6_n
eighbor_one_cmd,"showipv6ospf6neighborA.B.C.D",SHOW_STRIP6_STROSPF6_STR"Neighbor
list\n""SpecifyRouter-IDasIPv4addressnotation\n"){intidx_ipv4=4;structospf6_neig
hbor*on;structospf6_interface*oi;structospf6_area*oa;structlistnode*i,*j,*k;void
(*showfunc)(structvty*,structospf6_neighbor*);uint32_trouter_id;OSPF6_CMD_CHECK_
RUNNING();showfunc=ospf6_neighbor_show_detail;if((inet_pton(AF_INET,argv[idx_ipv
4]->arg,&router_id))!=1){vty_out(vty,"Router-IDisnotparsable:%s\n",argv[idx_ipv4
]->arg);returnCMD_SUCCESS;}for(ALL_LIST_ELEMENTS_RO(ospf6->area_list,i,oa))for(A
LL_LIST_ELEMENTS_RO(oa->if_list,j,oi))for(ALL_LIST_ELEMENTS_RO(oi->neighbor_list
,k,on))(*showfunc)(vty,on);returnCMD_SUCCESS;}voidospf6_neighbor_init(void){inst
all_element(VIEW_NODE,&show_ipv6_ospf6_neighbor_cmd);install_element(VIEW_NODE,&
show_ipv6_ospf6_neighbor_one_cmd);}DEFUN(debug_ospf6_neighbor,debug_ospf6_neighb
or_cmd,"debugospf6neighbor[<state|event>]",DEBUG_STROSPF6_STR"DebugOSPFv3Neighbo
r\n""DebugOSPFv3NeighborStateChange\n""DebugOSPFv3NeighborEvent\n"){intidx_type=
3;unsignedcharlevel=0;if(argc==4){if(!strncmp(argv[idx_type]->arg,"s",1))level=O
SPF6_DEBUG_NEIGHBOR_STATE;elseif(!strncmp(argv[idx_type]->arg,"e",1))level=OSPF6
_DEBUG_NEIGHBOR_EVENT;}elselevel=OSPF6_DEBUG_NEIGHBOR_STATE|OSPF6_DEBUG_NEIGHBOR
_EVENT;OSPF6_DEBUG_NEIGHBOR_ON(level);returnCMD_SUCCESS;}DEFUN(no_debug_ospf6_ne
ighbor,no_debug_ospf6_neighbor_cmd,"nodebugospf6neighbor[<state|event>]",NO_STRD
EBUG_STROSPF6_STR"DebugOSPFv3Neighbor\n""DebugOSPFv3NeighborStateChange\n""Debug
OSPFv3NeighborEvent\n"){intidx_type=4;unsignedcharlevel=0;if(argc==5){if(!strncm
p(argv[idx_type]->arg,"s",1))level=OSPF6_DEBUG_NEIGHBOR_STATE;if(!strncmp(argv[i
dx_type]->arg,"e",1))level=OSPF6_DEBUG_NEIGHBOR_EVENT;}elselevel=OSPF6_DEBUG_NEI
GHBOR_STATE|OSPF6_DEBUG_NEIGHBOR_EVENT;OSPF6_DEBUG_NEIGHBOR_OFF(level);returnCMD
_SUCCESS;}DEFUN(no_debug_ospf6,no_debug_ospf6_cmd,"nodebugospf6",NO_STRDEBUG_STR
OSPF6_STR){unsignedinti;structospf6_lsa_handler*handler=NULL;OSPF6_DEBUG_ABR_OFF
();OSPF6_DEBUG_ASBR_OFF();OSPF6_DEBUG_BROUTER_OFF();OSPF6_DEBUG_BROUTER_SPECIFIC
_ROUTER_OFF();OSPF6_DEBUG_BROUTER_SPECIFIC_AREA_OFF();OSPF6_DEBUG_FLOODING_OFF()
;OSPF6_DEBUG_INTERFACE_OFF();for(i=0;i<vector_active(ospf6_lsa_handler_vector);i
++){handler=vector_slot(ospf6_lsa_handler_vector,i);if(handler!=NULL){UNSET_FLAG
(handler->debug,OSPF6_LSA_DEBUG);}}for(i=0;i<6;i++)OSPF6_DEBUG_MESSAGE_OFF(i,OSP
F6_DEBUG_NEIGHBOR_STATE|OSPF6_DEBUG_NEIGHBOR_EVENT);OSPF6_DEBUG_NEIGHBOR_OFF(OSP
F6_DEBUG_NEIGHBOR_STATE|OSPF6_DEBUG_NEIGHBOR_EVENT);OSPF6_DEBUG_ROUTE_OFF(OSPF6_
DEBUG_ROUTE_TABLE);OSPF6_DEBUG_ROUTE_OFF(OSPF6_DEBUG_ROUTE_INTRA);OSPF6_DEBUG_RO
UTE_OFF(OSPF6_DEBUG_ROUTE_INTER);OSPF6_DEBUG_ROUTE_OFF(OSPF6_DEBUG_ROUTE_MEMORY)
;OSPF6_DEBUG_SPF_OFF(OSPF6_DEBUG_SPF_PROCESS);OSPF6_DEBUG_SPF_OFF(OSPF6_DEBUG_SP
F_TIME);OSPF6_DEBUG_SPF_OFF(OSPF6_DEBUG_SPF_DATABASE);OSPF6_DEBUG_ZEBRA_OFF(OSPF
6_DEBUG_ZEBRA_SEND|OSPF6_DEBUG_ZEBRA_RECV);returnCMD_SUCCESS;}intconfig_write_os
pf6_debug_neighbor(structvty*vty){if(IS_OSPF6_DEBUG_NEIGHBOR(STATE)&&IS_OSPF6_DE
BUG_NEIGHBOR(EVENT))vty_out(vty,"debugospf6neighbor\n");elseif(IS_OSPF6_DEBUG_NE
IGHBOR(STATE))vty_out(vty,"debugospf6neighborstate\n");elseif(IS_OSPF6_DEBUG_NEI
GHBOR(EVENT))vty_out(vty,"debugospf6neighborevent\n");return0;}voidinstall_eleme
nt_ospf6_debug_neighbor(void){install_element(ENABLE_NODE,&debug_ospf6_neighbor_
cmd);install_element(ENABLE_NODE,&no_debug_ospf6_neighbor_cmd);install_element(E
NABLE_NODE,&no_debug_ospf6_cmd);install_element(CONFIG_NODE,&debug_ospf6_neighbo
r_cmd);install_element(CONFIG_NODE,&no_debug_ospf6_neighbor_cmd);install_element
(CONFIG_NODE,&no_debug_ospf6_cmd);}