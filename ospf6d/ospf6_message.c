/**Copyright(C)2003YasuhiroOhara**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"memory.h"#include"log.h"#include"vty.h"#include"command.h"#i
nclude"thread.h"#include"linklist.h"#include"ospf6_proto.h"#include"ospf6_lsa.h"
#include"ospf6_lsdb.h"#include"ospf6_network.h"#include"ospf6_message.h"#include
"ospf6_top.h"#include"ospf6_area.h"#include"ospf6_neighbor.h"#include"ospf6_inte
rface.h"/*forstructuresandmacrosospf6_lsa_examin()needs*/#include"ospf6_abr.h"#i
nclude"ospf6_asbr.h"#include"ospf6_intra.h"#include"ospf6_flood.h"#include"ospf6
d.h"#include<netinet/ip6.h>unsignedcharconf_debug_ospf6_message[6]={0x03,0,0,0,0
,0};staticconststructmessageospf6_message_type_str[]={{OSPF6_MESSAGE_TYPE_HELLO,
"Hello"},{OSPF6_MESSAGE_TYPE_DBDESC,"DbDesc"},{OSPF6_MESSAGE_TYPE_LSREQ,"LSReq"}
,{OSPF6_MESSAGE_TYPE_LSUPDATE,"LSUpdate"},{OSPF6_MESSAGE_TYPE_LSACK,"LSAck"},{0}
};/*Minimum(besidesthestandardOSPFpacketheader)lengthsforOSPFpacketsofparticular
types,offsetisthe"type"field.*/constuint16_tospf6_packet_minlen[OSPF6_MESSAGE_TY
PE_ALL]={0,OSPF6_HELLO_MIN_SIZE,OSPF6_DB_DESC_MIN_SIZE,OSPF6_LS_REQ_MIN_SIZE,OSP
F6_LS_UPD_MIN_SIZE,OSPF6_LS_ACK_MIN_SIZE};/*Minimum(besidesthestandardLSAheader)
lengthsforLSAsofparticulartypes,offsetisthe"LSAfunctioncode"portionof"LSAtype"fi
eld.*/constuint16_tospf6_lsa_minlen[OSPF6_LSTYPE_SIZE]={0,/*0x2001*/OSPF6_ROUTER
_LSA_MIN_SIZE,/*0x2002*/OSPF6_NETWORK_LSA_MIN_SIZE,/*0x2003*/OSPF6_INTER_PREFIX_
LSA_MIN_SIZE,/*0x2004*/OSPF6_INTER_ROUTER_LSA_FIX_SIZE,/*0x4005*/OSPF6_AS_EXTERN
AL_LSA_MIN_SIZE,/*0x2006*/0,/*0x2007*/OSPF6_AS_EXTERNAL_LSA_MIN_SIZE,/*0x0008*/O
SPF6_LINK_LSA_MIN_SIZE,/*0x2009*/OSPF6_INTRA_PREFIX_LSA_MIN_SIZE};/*printfunctio
ns*/staticvoidospf6_header_print(structospf6_header*oh){charrouter_id[16],area_i
d[16];inet_ntop(AF_INET,&oh->router_id,router_id,sizeof(router_id));inet_ntop(AF
_INET,&oh->area_id,area_id,sizeof(area_id));zlog_debug("OSPFv%dType:%dLen:%huRou
ter-ID:%s",oh->version,oh->type,ntohs(oh->length),router_id);zlog_debug("Area-ID
:%sCksum:%hxInstance-ID:%d",area_id,ntohs(oh->checksum),oh->instance_id);}voidos
pf6_hello_print(structospf6_header*oh){structospf6_hello*hello;charoptions[16];c
hardrouter[16],bdrouter[16],neighbor[16];char*p;ospf6_header_print(oh);assert(oh
->type==OSPF6_MESSAGE_TYPE_HELLO);hello=(structospf6_hello*)((caddr_t)oh+sizeof(
structospf6_header));inet_ntop(AF_INET,&hello->drouter,drouter,sizeof(drouter));
inet_ntop(AF_INET,&hello->bdrouter,bdrouter,sizeof(bdrouter));ospf6_options_prin
tbuf(hello->options,options,sizeof(options));zlog_debug("I/F-Id:%ldPriority:%dOp
tion:%s",(unsignedlong)ntohl(hello->interface_id),hello->priority,options);zlog_
debug("HelloInterval:%huDeadInterval:%hu",ntohs(hello->hello_interval),ntohs(hel
lo->dead_interval));zlog_debug("DR:%sBDR:%s",drouter,bdrouter);for(p=(char*)((ca
ddr_t)hello+sizeof(structospf6_hello));p+sizeof(uint32_t)<=OSPF6_MESSAGE_END(oh)
;p+=sizeof(uint32_t)){inet_ntop(AF_INET,(void*)p,neighbor,sizeof(neighbor));zlog
_debug("Neighbor:%s",neighbor);}assert(p==OSPF6_MESSAGE_END(oh));}voidospf6_dbde
sc_print(structospf6_header*oh){structospf6_dbdesc*dbdesc;charoptions[16];char*p
;ospf6_header_print(oh);assert(oh->type==OSPF6_MESSAGE_TYPE_DBDESC);dbdesc=(stru
ctospf6_dbdesc*)((caddr_t)oh+sizeof(structospf6_header));ospf6_options_printbuf(
dbdesc->options,options,sizeof(options));zlog_debug("MBZ:%#xOption:%sIfMTU:%hu",
dbdesc->reserved1,options,ntohs(dbdesc->ifmtu));zlog_debug("MBZ:%#xBits:%s%s%sSe
qNum:%#lx",dbdesc->reserved2,(CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_IBIT)?"I":"-"
),(CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_MBIT)?"M":"-"),(CHECK_FLAG(dbdesc->bits,
OSPF6_DBDESC_MSBIT)?"m":"s"),(unsignedlong)ntohl(dbdesc->seqnum));for(p=(char*)(
(caddr_t)dbdesc+sizeof(structospf6_dbdesc));p+sizeof(structospf6_lsa_header)<=OS
PF6_MESSAGE_END(oh);p+=sizeof(structospf6_lsa_header))ospf6_lsa_header_print_raw
((structospf6_lsa_header*)p);assert(p==OSPF6_MESSAGE_END(oh));}voidospf6_lsreq_p
rint(structospf6_header*oh){charid[16],adv_router[16];char*p;ospf6_header_print(
oh);assert(oh->type==OSPF6_MESSAGE_TYPE_LSREQ);for(p=(char*)((caddr_t)oh+sizeof(
structospf6_header));p+sizeof(structospf6_lsreq_entry)<=OSPF6_MESSAGE_END(oh);p+
=sizeof(structospf6_lsreq_entry)){structospf6_lsreq_entry*e=(structospf6_lsreq_e
ntry*)p;inet_ntop(AF_INET,&e->adv_router,adv_router,sizeof(adv_router));inet_nto
p(AF_INET,&e->id,id,sizeof(id));zlog_debug("[%sId:%sAdv:%s]",ospf6_lstype_name(e
->type),id,adv_router);}assert(p==OSPF6_MESSAGE_END(oh));}voidospf6_lsupdate_pri
nt(structospf6_header*oh){structospf6_lsupdate*lsupdate;unsignedlongnum;char*p;o
spf6_header_print(oh);assert(oh->type==OSPF6_MESSAGE_TYPE_LSUPDATE);lsupdate=(st
ructospf6_lsupdate*)((caddr_t)oh+sizeof(structospf6_header));num=ntohl(lsupdate-
>lsa_number);zlog_debug("NumberofLSA:%ld",num);for(p=(char*)((caddr_t)lsupdate+s
izeof(structospf6_lsupdate));p<OSPF6_MESSAGE_END(oh)&&p+OSPF6_LSA_SIZE(p)<=OSPF6
_MESSAGE_END(oh);p+=OSPF6_LSA_SIZE(p)){ospf6_lsa_header_print_raw((structospf6_l
sa_header*)p);}assert(p==OSPF6_MESSAGE_END(oh));}voidospf6_lsack_print(structosp
f6_header*oh){char*p;ospf6_header_print(oh);assert(oh->type==OSPF6_MESSAGE_TYPE_
LSACK);for(p=(char*)((caddr_t)oh+sizeof(structospf6_header));p+sizeof(structospf
6_lsa_header)<=OSPF6_MESSAGE_END(oh);p+=sizeof(structospf6_lsa_header))ospf6_lsa
_header_print_raw((structospf6_lsa_header*)p);assert(p==OSPF6_MESSAGE_END(oh));}
staticvoidospf6_hello_recv(structin6_addr*src,structin6_addr*dst,structospf6_int
erface*oi,structospf6_header*oh){structospf6_hello*hello;structospf6_neighbor*on
;char*p;inttwoway=0;intneighborchange=0;intneighbor_ifindex_change=0;intbackupse
en=0;hello=(structospf6_hello*)((caddr_t)oh+sizeof(structospf6_header));/*HelloI
ntervalcheck*/if(ntohs(hello->hello_interval)!=oi->hello_interval){if(IS_OSPF6_D
EBUG_MESSAGE(oh->type,RECV))zlog_debug("HelloIntervalmismatch");return;}/*Router
DeadIntervalcheck*/if(ntohs(hello->dead_interval)!=oi->dead_interval){if(IS_OSPF
6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("RouterDeadIntervalmismatch");return;}
/*E-bitcheck*/if(OSPF6_OPT_ISSET(hello->options,OSPF6_OPT_E)!=OSPF6_OPT_ISSET(oi
->area->options,OSPF6_OPT_E)){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debu
g("E-bitmismatch");return;}/*Findneighbor,createifnotexist*/on=ospf6_neighbor_lo
okup(oh->router_id,oi);if(on==NULL){on=ospf6_neighbor_create(oh->router_id,oi);o
n->prev_drouter=on->drouter=hello->drouter;on->prev_bdrouter=on->bdrouter=hello-
>bdrouter;on->priority=hello->priority;}/*Alwaysoverrideneighbor'ssourceaddress*
/memcpy(&on->linklocal_addr,src,sizeof(structin6_addr));/*Neighborifindexcheck*/
if(on->ifindex!=(ifindex_t)ntohl(hello->interface_id)){on->ifindex=ntohl(hello->
interface_id);neighbor_ifindex_change++;}/*TwoWaycheck*/for(p=(char*)((caddr_t)h
ello+sizeof(structospf6_hello));p+sizeof(uint32_t)<=OSPF6_MESSAGE_END(oh);p+=siz
eof(uint32_t)){uint32_t*router_id=(uint32_t*)p;if(*router_id==oi->area->ospf6->r
outer_id)twoway++;}assert(p==OSPF6_MESSAGE_END(oh));/*RouterPrioritycheck*/if(on
->priority!=hello->priority){on->priority=hello->priority;neighborchange++;}/*DR
check*/if(on->drouter!=hello->drouter){on->prev_drouter=on->drouter;on->drouter=
hello->drouter;if(on->prev_drouter==on->router_id||on->drouter==on->router_id)ne
ighborchange++;}/*BDRcheck*/if(on->bdrouter!=hello->bdrouter){on->prev_bdrouter=
on->bdrouter;on->bdrouter=hello->bdrouter;if(on->prev_bdrouter==on->router_id||o
n->bdrouter==on->router_id)neighborchange++;}/*BackupSeencheck*/if(oi->state==OS
PF6_INTERFACE_WAITING){if(hello->bdrouter==on->router_id)backupseen++;elseif(hel
lo->drouter==on->router_id&&hello->bdrouter==htonl(0))backupseen++;}oi->hello_in
++;/*Executeneighborevents*/thread_execute(master,hello_received,on,0);if(twoway
)thread_execute(master,twoway_received,on,0);elsethread_execute(master,oneway_re
ceived,on,0);/*Scheduleinterfaceevents*/if(backupseen)thread_add_event(master,ba
ckup_seen,oi,0,NULL);if(neighborchange)thread_add_event(master,neighbor_change,o
i,0,NULL);if(neighbor_ifindex_change&&on->state==OSPF6_NEIGHBOR_FULL)OSPF6_ROUTE
R_LSA_SCHEDULE(oi->area);}staticvoidospf6_dbdesc_recv_master(structospf6_header*
oh,structospf6_neighbor*on){structospf6_dbdesc*dbdesc;char*p;dbdesc=(structospf6
_dbdesc*)((caddr_t)oh+sizeof(structospf6_header));if(on->state<OSPF6_NEIGHBOR_IN
IT){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("NeighborstatelessthanIn
it,ignore");return;}switch(on->state){caseOSPF6_NEIGHBOR_TWOWAY:if(IS_OSPF6_DEBU
G_MESSAGE(oh->type,RECV))zlog_debug("Neighborstateis2-Way,ignore");return;caseOS
PF6_NEIGHBOR_INIT:thread_execute(master,twoway_received,on,0);if(on->state!=OSPF
6_NEIGHBOR_EXSTART){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Neighbo
rstateisnotExStart,ignore");return;}/*elsefallthroughtoExStart*//*fallthru*/case
OSPF6_NEIGHBOR_EXSTART:/*ifneighborobeysusasourslave,schedulenegotiation_doneand
processLSAHeaders.Otherwise,ignorethismessage*/if(!CHECK_FLAG(dbdesc->bits,OSPF6
_DBDESC_MSBIT)&&!CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_IBIT)&&ntohl(dbdesc->seqnu
m)==on->dbdesc_seqnum){/*executeNegotiationDone*/thread_execute(master,negotiati
on_done,on,0);/*Recordneighboroptions*/memcpy(on->options,dbdesc->options,sizeof
(on->options));}else{if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Negoti
ationfailed");return;}/*fallthroughtoexchange*/caseOSPF6_NEIGHBOR_EXCHANGE:if(!m
emcmp(dbdesc,&on->dbdesc_last,sizeof(structospf6_dbdesc))){/*DuplicatedDatabaseD
escriptionisdroppedbymaster*/if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug
("DuplicateddbdescdiscardedbyMaster,ignore");return;}if(CHECK_FLAG(dbdesc->bits,
OSPF6_DBDESC_MSBIT)){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Master
/Slavebitmismatch");thread_add_event(master,seqnumber_mismatch,on,0,NULL);return
;}if(CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_IBIT)){if(IS_OSPF6_DEBUG_MESSAGE(oh->t
ype,RECV))zlog_debug("Initializebitmismatch");thread_add_event(master,seqnumber_
mismatch,on,0,NULL);return;}if(memcmp(on->options,dbdesc->options,sizeof(on->opt
ions))){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Optionfieldmismatch
");thread_add_event(master,seqnumber_mismatch,on,0,NULL);return;}if(ntohl(dbdesc
->seqnum)!=on->dbdesc_seqnum){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debu
g("Sequencenumbermismatch(%#lxexpected)",(unsignedlong)on->dbdesc_seqnum);thread
_add_event(master,seqnumber_mismatch,on,0,NULL);return;}break;caseOSPF6_NEIGHBOR
_LOADING:caseOSPF6_NEIGHBOR_FULL:if(!memcmp(dbdesc,&on->dbdesc_last,sizeof(struc
tospf6_dbdesc))){/*DuplicatedDatabaseDescriptionisdroppedbymaster*/if(IS_OSPF6_D
EBUG_MESSAGE(oh->type,RECV))zlog_debug("DuplicateddbdescdiscardedbyMaster,ignore
");return;}if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Notduplicatedbde
scinstate%s",ospf6_neighbor_state_str[on->state]);thread_add_event(master,seqnum
ber_mismatch,on,0,NULL);return;default:assert(0);break;}/*ProcessLSAheaders*/for
(p=(char*)((caddr_t)dbdesc+sizeof(structospf6_dbdesc));p+sizeof(structospf6_lsa_
header)<=OSPF6_MESSAGE_END(oh);p+=sizeof(structospf6_lsa_header)){structospf6_ls
a*his,*mine;structospf6_lsdb*lsdb=NULL;his=ospf6_lsa_create_headeronly((structos
pf6_lsa_header*)p);if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("%s",his-
>name);switch(OSPF6_LSA_SCOPE(his->header->type)){caseOSPF6_SCOPE_LINKLOCAL:lsdb
=on->ospf6_if->lsdb;break;caseOSPF6_SCOPE_AREA:lsdb=on->ospf6_if->area->lsdb;bre
ak;caseOSPF6_SCOPE_AS:lsdb=on->ospf6_if->area->ospf6->lsdb;break;caseOSPF6_SCOPE
_RESERVED:if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("IgnoringLSAofrese
rvedscope");ospf6_lsa_delete(his);continue;break;}if(ntohs(his->header->type)==O
SPF6_LSTYPE_AS_EXTERNAL&&IS_AREA_STUB(on->ospf6_if->area)){if(IS_OSPF6_DEBUG_MES
SAGE(oh->type,RECV))zlog_debug("SeqNumMismatch(E-bitmismatch),discard");ospf6_ls
a_delete(his);thread_add_event(master,seqnumber_mismatch,on,0,NULL);return;}mine
=ospf6_lsdb_lookup(his->header->type,his->header->id,his->header->adv_router,lsd
b);if(mine==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Addreques
t(Nodatabasecopy)");ospf6_lsdb_add(ospf6_lsa_copy(his),on->request_list);}elseif
(ospf6_lsa_compare(his,mine)<0){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_de
bug("Addrequest(ReceivedMoreRecent)");ospf6_lsdb_add(ospf6_lsa_copy(his),on->req
uest_list);}else{if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Discard(Ex
istingMoreRecent)");}ospf6_lsa_delete(his);}assert(p==OSPF6_MESSAGE_END(oh));/*I
ncrementsequencenumber*/on->dbdesc_seqnum++;/*schedulesendlsreq*/if(on->request_
list->count)thread_add_event(master,ospf6_lsreq_send,on,0,&on->thread_send_lsreq
);THREAD_OFF(on->thread_send_dbdesc);/*Morebitcheck*/if(!CHECK_FLAG(dbdesc->bits
,OSPF6_DBDESC_MBIT)&&!CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MBIT))thread_add_e
vent(master,exchange_done,on,0,NULL);else{on->thread_send_dbdesc=NULL;thread_add
_event(master,ospf6_dbdesc_send_newone,on,0,&on->thread_send_dbdesc);}/*savelast
receiveddbdesc*/memcpy(&on->dbdesc_last,dbdesc,sizeof(structospf6_dbdesc));}stat
icvoidospf6_dbdesc_recv_slave(structospf6_header*oh,structospf6_neighbor*on){str
uctospf6_dbdesc*dbdesc;char*p;dbdesc=(structospf6_dbdesc*)((caddr_t)oh+sizeof(st
ructospf6_header));if(on->state<OSPF6_NEIGHBOR_INIT){if(IS_OSPF6_DEBUG_MESSAGE(o
h->type,RECV))zlog_debug("NeighborstatelessthanInit,ignore");return;}switch(on->
state){caseOSPF6_NEIGHBOR_TWOWAY:if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_d
ebug("Neighborstateis2-Way,ignore");return;caseOSPF6_NEIGHBOR_INIT:thread_execut
e(master,twoway_received,on,0);if(on->state!=OSPF6_NEIGHBOR_EXSTART){if(IS_OSPF6
_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("NeighborstateisnotExStart,ignore");ret
urn;}/*elsefallthroughtoExStart*//*fallthru*/caseOSPF6_NEIGHBOR_EXSTART:/*Ifthen
eighborisMaster,actasSlave.Schedulenegotiation_doneandprocessLSAHeaders.Otherwis
e,ignorethismessage*/if(CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_IBIT)&&CHECK_FLAG(d
bdesc->bits,OSPF6_DBDESC_MBIT)&&CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_MSBIT)&&nto
hs(oh->length)==sizeof(structospf6_header)+sizeof(structospf6_dbdesc)){/*setthem
aster/slavebittoslave*/UNSET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT);/*settheDD
sequencenumbertoonespecifiedbymaster*/on->dbdesc_seqnum=ntohl(dbdesc->seqnum);/*
scheduleNegotiationDone*/thread_execute(master,negotiation_done,on,0);/*Recordne
ighboroptions*/memcpy(on->options,dbdesc->options,sizeof(on->options));}else{if(
IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Negotiationfailed");return;}br
eak;caseOSPF6_NEIGHBOR_EXCHANGE:if(!memcmp(dbdesc,&on->dbdesc_last,sizeof(struct
ospf6_dbdesc))){/*DuplicatedDatabaseDescriptioncausesslaveto*retransmit*/if(IS_O
SPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Duplicateddbdesccausesretransmit")
;THREAD_OFF(on->thread_send_dbdesc);on->thread_send_dbdesc=NULL;thread_add_event
(master,ospf6_dbdesc_send,on,0,&on->thread_send_dbdesc);return;}if(!CHECK_FLAG(d
bdesc->bits,OSPF6_DBDESC_MSBIT)){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_d
ebug("Master/Slavebitmismatch");thread_add_event(master,seqnumber_mismatch,on,0,
NULL);return;}if(CHECK_FLAG(dbdesc->bits,OSPF6_DBDESC_IBIT)){if(IS_OSPF6_DEBUG_M
ESSAGE(oh->type,RECV))zlog_debug("Initializebitmismatch");thread_add_event(maste
r,seqnumber_mismatch,on,0,NULL);return;}if(memcmp(on->options,dbdesc->options,si
zeof(on->options))){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Optionf
ieldmismatch");thread_add_event(master,seqnumber_mismatch,on,0,NULL);return;}if(
ntohl(dbdesc->seqnum)!=on->dbdesc_seqnum+1){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,R
ECV))zlog_debug("Sequencenumbermismatch(%#lxexpected)",(unsignedlong)on->dbdesc_
seqnum+1);thread_add_event(master,seqnumber_mismatch,on,0,NULL);return;}break;ca
seOSPF6_NEIGHBOR_LOADING:caseOSPF6_NEIGHBOR_FULL:if(!memcmp(dbdesc,&on->dbdesc_l
ast,sizeof(structospf6_dbdesc))){/*DuplicatedDatabaseDescriptioncausesslaveto*re
transmit*/if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Duplicateddbdescc
ausesretransmit");THREAD_OFF(on->thread_send_dbdesc);thread_add_event(master,osp
f6_dbdesc_send,on,0,&on->thread_send_dbdesc);return;}if(IS_OSPF6_DEBUG_MESSAGE(o
h->type,RECV))zlog_debug("Notduplicatedbdescinstate%s",ospf6_neighbor_state_str[
on->state]);thread_add_event(master,seqnumber_mismatch,on,0,NULL);return;default
:assert(0);break;}/*ProcessLSAheaders*/for(p=(char*)((caddr_t)dbdesc+sizeof(stru
ctospf6_dbdesc));p+sizeof(structospf6_lsa_header)<=OSPF6_MESSAGE_END(oh);p+=size
of(structospf6_lsa_header)){structospf6_lsa*his,*mine;structospf6_lsdb*lsdb=NULL
;his=ospf6_lsa_create_headeronly((structospf6_lsa_header*)p);switch(OSPF6_LSA_SC
OPE(his->header->type)){caseOSPF6_SCOPE_LINKLOCAL:lsdb=on->ospf6_if->lsdb;break;
caseOSPF6_SCOPE_AREA:lsdb=on->ospf6_if->area->lsdb;break;caseOSPF6_SCOPE_AS:lsdb
=on->ospf6_if->area->ospf6->lsdb;break;caseOSPF6_SCOPE_RESERVED:if(IS_OSPF6_DEBU
G_MESSAGE(oh->type,RECV))zlog_debug("IgnoringLSAofreservedscope");ospf6_lsa_dele
te(his);continue;break;}if(OSPF6_LSA_SCOPE(his->header->type)==OSPF6_SCOPE_AS&&I
S_AREA_STUB(on->ospf6_if->area)){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_d
ebug("E-bitmismatchwithLSAHeaders");ospf6_lsa_delete(his);thread_add_event(maste
r,seqnumber_mismatch,on,0,NULL);return;}mine=ospf6_lsdb_lookup(his->header->type
,his->header->id,his->header->adv_router,lsdb);if(mine==NULL||ospf6_lsa_compare(
his,mine)<0){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Addrequest-lis
t:%s",his->name);ospf6_lsdb_add(ospf6_lsa_copy(his),on->request_list);}ospf6_lsa
_delete(his);}assert(p==OSPF6_MESSAGE_END(oh));/*SetsequencenumbertoMaster's*/on
->dbdesc_seqnum=ntohl(dbdesc->seqnum);/*schedulesendlsreq*/if(on->request_list->
count)thread_add_event(master,ospf6_lsreq_send,on,0,&on->thread_send_lsreq);THRE
AD_OFF(on->thread_send_dbdesc);thread_add_event(master,ospf6_dbdesc_send_newone,
on,0,&on->thread_send_dbdesc);/*savelastreceiveddbdesc*/memcpy(&on->dbdesc_last,
dbdesc,sizeof(structospf6_dbdesc));}staticvoidospf6_dbdesc_recv(structin6_addr*s
rc,structin6_addr*dst,structospf6_interface*oi,structospf6_header*oh){structospf
6_neighbor*on;structospf6_dbdesc*dbdesc;on=ospf6_neighbor_lookup(oh->router_id,o
i);if(on==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Neighbornot
found,ignore");return;}dbdesc=(structospf6_dbdesc*)((caddr_t)oh+sizeof(structosp
f6_header));/*InterfaceMTUcheck*/if(!oi->mtu_ignore&&ntohs(dbdesc->ifmtu)!=oi->i
fmtu){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("I/FMTUmismatch");retu
rn;}if(dbdesc->reserved1||dbdesc->reserved2){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,
RECV))zlog_debug("Non-0reservedfieldin%s'sDbDesc,correct",on->name);dbdesc->rese
rved1=0;dbdesc->reserved2=0;}oi->db_desc_in++;if(ntohl(oh->router_id)<ntohl(ospf
6->router_id))ospf6_dbdesc_recv_master(oh,on);elseif(ntohl(ospf6->router_id)<nto
hl(oh->router_id))ospf6_dbdesc_recv_slave(oh,on);else{if(IS_OSPF6_DEBUG_MESSAGE(
oh->type,RECV))zlog_debug("Can'tdecidewhichismaster,ignore");}}staticvoidospf6_l
sreq_recv(structin6_addr*src,structin6_addr*dst,structospf6_interface*oi,structo
spf6_header*oh){structospf6_neighbor*on;char*p;structospf6_lsreq_entry*e;structo
spf6_lsdb*lsdb=NULL;structospf6_lsa*lsa;on=ospf6_neighbor_lookup(oh->router_id,o
i);if(on==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Neighbornot
found,ignore");return;}if(on->state!=OSPF6_NEIGHBOR_EXCHANGE&&on->state!=OSPF6_N
EIGHBOR_LOADING&&on->state!=OSPF6_NEIGHBOR_FULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->t
ype,RECV))zlog_debug("NeighborstatelessthanExchange,ignore");return;}oi->ls_req_
in++;/*Processeachrequest*/for(p=(char*)((caddr_t)oh+sizeof(structospf6_header))
;p+sizeof(structospf6_lsreq_entry)<=OSPF6_MESSAGE_END(oh);p+=sizeof(structospf6_
lsreq_entry)){e=(structospf6_lsreq_entry*)p;switch(OSPF6_LSA_SCOPE(e->type)){cas
eOSPF6_SCOPE_LINKLOCAL:lsdb=on->ospf6_if->lsdb;break;caseOSPF6_SCOPE_AREA:lsdb=o
n->ospf6_if->area->lsdb;break;caseOSPF6_SCOPE_AS:lsdb=on->ospf6_if->area->ospf6-
>lsdb;break;default:if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Ignorin
gLSAofreservedscope");continue;break;}/*Finddatabasecopy*/lsa=ospf6_lsdb_lookup(
e->type,e->id,e->adv_router,lsdb);if(lsa==NULL){charid[16],adv_router[16];if(IS_
OSPF6_DEBUG_MESSAGE(oh->type,RECV)){inet_ntop(AF_INET,&e->id,id,sizeof(id));inet
_ntop(AF_INET,&e->adv_router,adv_router,sizeof(adv_router));zlog_debug("Can'tfin
drequested[%sId:%sAdv:%s]",ospf6_lstype_name(e->type),id,adv_router);}thread_add
_event(master,bad_lsreq,on,0,NULL);return;}ospf6_lsdb_add(ospf6_lsa_copy(lsa),on
->lsupdate_list);}assert(p==OSPF6_MESSAGE_END(oh));/*schedulesendlsupdate*/THREA
D_OFF(on->thread_send_lsupdate);thread_add_event(master,ospf6_lsupdate_send_neig
hbor,on,0,&on->thread_send_lsupdate);}/*Verify,thatthespecifiedmemoryareacontain
sexactlyNvalidIPv6prefixesasspecifiedbyRFC5340,A.4.1.*/staticunsignedospf6_prefi
xes_examin(structospf6_prefix*current,/*startofbuffer*/unsignedlength,constuint3
2_treq_num_pfxs/*alwayscomparedwiththeactualnumberofprefixes*/){uint8_trequested
_pfx_bytes;uint32_treal_num_pfxs=0;while(length){if(length<OSPF6_PREFIX_MIN_SIZE
){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:unde
rsizedIPv6prefixheader",__func__);returnMSG_NG;}/*safetolookdeeper*/if(current->
prefix_length>IPV6_MAX_BITLEN){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKN
OWN,RECV))zlog_debug("%s:invalidPrefixLength(%ubits)",__func__,current->prefix_l
ength);returnMSG_NG;}/*coversbothfixed-andvariable-sizedfields*/requested_pfx_by
tes=OSPF6_PREFIX_MIN_SIZE+OSPF6_PREFIX_SPACE(current->prefix_length);if(requeste
d_pfx_bytes>length){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))z
log_debug("%s:undersizedIPv6prefix",__func__);returnMSG_NG;}/*nextprefix*/length
-=requested_pfx_bytes;current=(structospf6_prefix*)((caddr_t)current+requested_p
fx_bytes);real_num_pfxs++;}if(real_num_pfxs!=req_num_pfxs){if(IS_OSPF6_DEBUG_MES
SAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:IPv6prefixnumbermismatch(%u
required,%ureal)",__func__,req_num_pfxs,real_num_pfxs);returnMSG_NG;}returnMSG_O
K;}/*VerifyanLSAtohaveavalidlengthanddispatchfurther(whereappropriate)tocheckift
hecontents,includingnestedIPv6prefixes,isproperlysized/alignedwithintheLSA.Notet
hatthisfunctiongetsLSAtypeinnetworkbyteorder,usesinhostbyteorderandpassestoospf6
_lstype_name()innetworkbyteorderagain.*/staticunsignedospf6_lsa_examin(structosp
f6_lsa_header*lsah,constuint16_tlsalen,constuint8_theaderonly){structospf6_intra
_prefix_lsa*intra_prefix_lsa;structospf6_as_external_lsa*as_external_lsa;structo
spf6_link_lsa*link_lsa;unsignedexp_length;uint8_tltindex;uint16_tlsatype;/*Incas
eanadditionalminimumlengthconstraintisdefinedforcurrentLSAtype,makesurethatthisc
onstraintismet.*/lsatype=ntohs(lsah->type);ltindex=lsatype&OSPF6_LSTYPE_FCODE_MA
SK;if(ltindex<OSPF6_LSTYPE_SIZE&&ospf6_lsa_minlen[ltindex]&&lsalen<ospf6_lsa_min
len[ltindex]+OSPF6_LSA_HEADER_SIZE){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE
_UNKNOWN,RECV))zlog_debug("%s:undersized(%uB)LSA",__func__,lsalen);returnMSG_NG;
}switch(lsatype){caseOSPF6_LSTYPE_ROUTER:/*RFC5340A.4.3,LSAheader+OSPF6_ROUTER_L
SA_MIN_SIZEbytesfollowedbyN>=0interfacedescriptions.*/if((lsalen-OSPF6_LSA_HEADE
R_SIZE-OSPF6_ROUTER_LSA_MIN_SIZE)%OSPF6_ROUTER_LSDESC_FIX_SIZE){if(IS_OSPF6_DEBU
G_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:interfacedescriptional
ignmenterror",__func__);returnMSG_NG;}break;caseOSPF6_LSTYPE_NETWORK:/*RFC5340A.
4.4,LSAheader+OSPF6_NETWORK_LSA_MIN_SIZEbytesfollowedbyN>=0attachedrouterdescrip
tions.*/if((lsalen-OSPF6_LSA_HEADER_SIZE-OSPF6_NETWORK_LSA_MIN_SIZE)%OSPF6_NETWO
RK_LSDESC_FIX_SIZE){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))z
log_debug("%s:routerdescriptionalignmenterror",__func__);returnMSG_NG;}break;cas
eOSPF6_LSTYPE_INTER_PREFIX:/*RFC5340A.4.5,LSAheader+OSPF6_INTER_PREFIX_LSA_MIN_S
IZEbytesfollowedby3-4fieldsofasingleIPv6prefix.*/if(headeronly)break;returnospf6
_prefixes_examin((structospf6_prefix*)((caddr_t)lsah+OSPF6_LSA_HEADER_SIZE+OSPF6
_INTER_PREFIX_LSA_MIN_SIZE),lsalen-OSPF6_LSA_HEADER_SIZE-OSPF6_INTER_PREFIX_LSA_
MIN_SIZE,1);caseOSPF6_LSTYPE_INTER_ROUTER:/*RFC5340A.4.6,fixed-sizeLSA.*/if(lsal
en>OSPF6_LSA_HEADER_SIZE+OSPF6_INTER_ROUTER_LSA_FIX_SIZE){if(IS_OSPF6_DEBUG_MESS
AGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:oversized(%uB)LSA",__func__,
lsalen);returnMSG_NG;}break;caseOSPF6_LSTYPE_AS_EXTERNAL:/*RFC5340A.4.7,sameasA.
4.8.*/caseOSPF6_LSTYPE_TYPE_7:/*RFC5340A.4.8,LSAheader+OSPF6_AS_EXTERNAL_LSA_MIN
_SIZEbytesfollowedby3-4fieldsofIPv6prefixand3conditionalLSAfields:16bytesofforwa
rdingaddress,4bytesofexternalroutetag,4bytesofreferencedlinkstateID.*/if(headero
nly)break;as_external_lsa=(structospf6_as_external_lsa*)((caddr_t)lsah+OSPF6_LSA
_HEADER_SIZE);exp_length=OSPF6_LSA_HEADER_SIZE+OSPF6_AS_EXTERNAL_LSA_MIN_SIZE;/*
Tofindoutifthelastoptionalfield(ReferencedLinkStateID)isassumedinthisLSA,weneedt
oaccessfixedfieldsoftheIPv6prefixbeforeospf6_prefix_examin()confirmsitssizing.*/
if(exp_length+OSPF6_PREFIX_MIN_SIZE>lsalen){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESS
AGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:undersized(%uB)LSAheader",__func__,lsalen)
;returnMSG_NG;}/*forwardingaddress*/if(CHECK_FLAG(as_external_lsa->bits_metric,O
SPF6_ASBR_BIT_F))exp_length+=16;/*externalroutetag*/if(CHECK_FLAG(as_external_ls
a->bits_metric,OSPF6_ASBR_BIT_T))exp_length+=4;/*referencedlinkstateID*/if(as_ex
ternal_lsa->prefix.u._prefix_referenced_lstype)exp_length+=4;/*Allthefixed-sizef
ields(mandatoryandoptional)mustfit.I.e.,thischeckdoesnotincludeanyIPv6prefixfiel
ds.*/if(exp_length>lsalen){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,
RECV))zlog_debug("%s:undersized(%uB)LSAheader",__func__,lsalen);returnMSG_NG;}/*
Thelastcallcompletelycoverstheremainder(IPv6prefix).*/returnospf6_prefixes_exami
n((structospf6_prefix*)((caddr_t)as_external_lsa+OSPF6_AS_EXTERNAL_LSA_MIN_SIZE)
,lsalen-exp_length,1);caseOSPF6_LSTYPE_LINK:/*RFC5340A.4.9,LSAheader+OSPF6_LINK_
LSA_MIN_SIZEbytesfollowedbyN>=0IPv6prefixblocks(withNdeclaredbeforehand).*/if(he
aderonly)break;link_lsa=(structospf6_link_lsa*)((caddr_t)lsah+OSPF6_LSA_HEADER_S
IZE);returnospf6_prefixes_examin((structospf6_prefix*)((caddr_t)link_lsa+OSPF6_L
INK_LSA_MIN_SIZE),lsalen-OSPF6_LSA_HEADER_SIZE-OSPF6_LINK_LSA_MIN_SIZE,ntohl(lin
k_lsa->prefix_num)/*32bits*/);caseOSPF6_LSTYPE_INTRA_PREFIX:/*RFC5340A.4.10,LSAh
eader+OSPF6_INTRA_PREFIX_LSA_MIN_SIZEbytesfollowedbyN>=0IPv6prefixes(withNdeclar
edbeforehand).*/if(headeronly)break;intra_prefix_lsa=(structospf6_intra_prefix_l
sa*)((caddr_t)lsah+OSPF6_LSA_HEADER_SIZE);returnospf6_prefixes_examin((structosp
f6_prefix*)((caddr_t)intra_prefix_lsa+OSPF6_INTRA_PREFIX_LSA_MIN_SIZE),lsalen-OS
PF6_LSA_HEADER_SIZE-OSPF6_INTRA_PREFIX_LSA_MIN_SIZE,ntohs(intra_prefix_lsa->pref
ix_num)/*16bits*/);}/*NoadditionalvalidationispossibleforunknownLSAtypes,whichar
ethemselvesvalidinOPSFv3,hencethedefaultdecisionistoaccept.*/returnMSG_OK;}/*Ver
ifyiftheprovidedinputbufferisavalidsequenceofLSAs.ThisincludesverificationofLSAb
lockslength/alignmentanddispatchingofdeeper-levelchecks.*/staticunsignedospf6_ls
aseq_examin(structospf6_lsa_header*lsah,/*startofbuffereddata*/size_tlength,cons
tuint8_theaderonly,/*Whendeclared_num_lsasisnot0,compareittotherealnumberofLSAsa
ndtreatthedifferenceasanerror.*/constuint32_tdeclared_num_lsas){uint32_tcounted_
lsas=0;while(length){uint16_tlsalen;if(length<OSPF6_LSA_HEADER_SIZE){if(IS_OSPF6
_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:undersized(%zuB)t
railing(#%u)LSAheader",__func__,length,counted_lsas);returnMSG_NG;}/*saveonntohs
()callshereandintheLSAvalidator*/lsalen=OSPF6_LSA_SIZE(lsah);if(lsalen<OSPF6_LSA
_HEADER_SIZE){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_de
bug("%s:malformedLSAheader#%u,declaredlengthis%uB",__func__,counted_lsas,lsalen)
;returnMSG_NG;}if(headeronly){/*lesscheckshereandinospf6_lsa_examin()*/if(MSG_OK
!=ospf6_lsa_examin(lsah,lsalen,1)){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_
UNKNOWN,RECV))zlog_debug("%s:anomalyinheader-only%sLSA#%u",__func__,ospf6_lstype
_name(lsah->type),counted_lsas);returnMSG_NG;}lsah=(structospf6_lsa_header*)((ca
ddr_t)lsah+OSPF6_LSA_HEADER_SIZE);length-=OSPF6_LSA_HEADER_SIZE;}else{/*makesure
theinputbufferisdeepenoughbefore*furtherchecks*/if(lsalen>length){if(IS_OSPF6_DE
BUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:anomalyin%sLSA#%u:de
claredlengthis%uB,bufferedlengthis%zuB",__func__,ospf6_lstype_name(lsah->type),c
ounted_lsas,lsalen,length);returnMSG_NG;}if(MSG_OK!=ospf6_lsa_examin(lsah,lsalen
,0)){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:a
nomalyin%sLSA#%u",__func__,ospf6_lstype_name(lsah->type),counted_lsas);returnMSG
_NG;}lsah=(structospf6_lsa_header*)((caddr_t)lsah+lsalen);length-=lsalen;}counte
d_lsas++;}if(declared_num_lsas&&counted_lsas!=declared_num_lsas){if(IS_OSPF6_DEB
UG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:#LSAsdeclared(%u)does
notmatchactual(%u)",__func__,declared_num_lsas,counted_lsas);returnMSG_NG;}retur
nMSG_OK;}/*VerifyacompleteOSPFpacketforpropersizing/alignment.*/staticunsignedos
pf6_packet_examin(structospf6_header*oh,constunsignedbytesonwire){structospf6_ls
update*lsupd;unsignedtest;/*length,1stapproximation*/if(bytesonwire<OSPF6_HEADER
_SIZE){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s
:undersized(%uB)packet",__func__,bytesonwire);returnMSG_NG;}/*Nowitissafetoacces
sheaderfields.*/if(bytesonwire!=ntohs(oh->length)){if(IS_OSPF6_DEBUG_MESSAGE(OSP
F6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:%spacketlengtherror(%ureal,%udeclar
ed)",__func__,lookup_msg(ospf6_message_type_str,oh->type,NULL),bytesonwire,ntohs
(oh->length));returnMSG_NG;}/*versioncheck*/if(oh->version!=OSPFV3_VERSION){if(I
S_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:invalid(%u
)protocolversion",__func__,oh->version);returnMSG_NG;}/*length,2ndapproximation*
/if(oh->type<OSPF6_MESSAGE_TYPE_ALL&&ospf6_packet_minlen[oh->type]&&bytesonwire<
OSPF6_HEADER_SIZE+ospf6_packet_minlen[oh->type]){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6
_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:undersized(%uB)%spacket",__func__,byt
esonwire,lookup_msg(ospf6_message_type_str,oh->type,NULL));returnMSG_NG;}/*type-
specificdeepervalidation*/switch(oh->type){caseOSPF6_MESSAGE_TYPE_HELLO:/*RFC534
0A.3.2,packetheader+OSPF6_HELLO_MIN_SIZEbytesfollowedbyN>=0router-IDs.*/if(0==(b
ytesonwire-OSPF6_HEADER_SIZE-OSPF6_HELLO_MIN_SIZE)%4)returnMSG_OK;if(IS_OSPF6_DE
BUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:alignmenterrorin%spa
cket",__func__,lookup_msg(ospf6_message_type_str,oh->type,NULL));returnMSG_NG;ca
seOSPF6_MESSAGE_TYPE_DBDESC:/*RFC5340A.3.3,packetheader+OSPF6_DB_DESC_MIN_SIZEby
tesfollowedbyN>=0header-onlyLSAs.*/test=ospf6_lsaseq_examin((structospf6_lsa_hea
der*)((caddr_t)oh+OSPF6_HEADER_SIZE+OSPF6_DB_DESC_MIN_SIZE),bytesonwire-OSPF6_HE
ADER_SIZE-OSPF6_DB_DESC_MIN_SIZE,1,0);break;caseOSPF6_MESSAGE_TYPE_LSREQ:/*RFC53
40A.3.4,packetheader+N>=0LSdescriptionblocks.*/if(0==(bytesonwire-OSPF6_HEADER_S
IZE-OSPF6_LS_REQ_MIN_SIZE)%OSPF6_LSREQ_LSDESC_FIX_SIZE)returnMSG_OK;if(IS_OSPF6_
DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:alignmenterrorin%s
packet",__func__,lookup_msg(ospf6_message_type_str,oh->type,NULL));returnMSG_NG;
caseOSPF6_MESSAGE_TYPE_LSUPDATE:/*RFC5340A.3.5,packetheader+OSPF6_LS_UPD_MIN_SIZ
EbytesfollowedbyN>=0fullLSAs(withNdeclaredbeforehand).*/lsupd=(structospf6_lsupd
ate*)((caddr_t)oh+OSPF6_HEADER_SIZE);test=ospf6_lsaseq_examin((structospf6_lsa_h
eader*)((caddr_t)lsupd+OSPF6_LS_UPD_MIN_SIZE),bytesonwire-OSPF6_HEADER_SIZE-OSPF
6_LS_UPD_MIN_SIZE,0,ntohl(lsupd->lsa_number)/*32bits*/);break;caseOSPF6_MESSAGE_
TYPE_LSACK:/*RFC5340A.3.6,packetheader+N>=0header-onlyLSAs.*/test=ospf6_lsaseq_e
xamin((structospf6_lsa_header*)((caddr_t)oh+OSPF6_HEADER_SIZE+OSPF6_LS_ACK_MIN_S
IZE),bytesonwire-OSPF6_HEADER_SIZE-OSPF6_LS_ACK_MIN_SIZE,1,0);break;default:if(I
S_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:invalid(%u
)messagetype",__func__,oh->type);returnMSG_NG;}if(test!=MSG_OK&&IS_OSPF6_DEBUG_M
ESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:anomalyin%spacket",__func
__,lookup_msg(ospf6_message_type_str,oh->type,NULL));returntest;}/*Verifyparticu
larfieldsofotherwisecorrectreceivedOSPFpackettomeettherequirementsofRFC.*/static
intospf6_rxpacket_examin(structospf6_interface*oi,structospf6_header*oh,constuns
ignedbytesonwire){charbuf[2][INET_ADDRSTRLEN];if(MSG_OK!=ospf6_packet_examin(oh,
bytesonwire))returnMSG_NG;/*Area-IDcheck*/if(oh->area_id!=oi->area->area_id){if(
IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV)){if(oh->area_id==OSPF_AREA_BACKBONE)zlog_d
ebug("%s:MessagemaybeviaVirtualLink:notsupported",__func__);elsezlog_debug("%s:A
rea-IDmismatch(my%s,rcvd%s)",__func__,inet_ntop(AF_INET,&oi->area->area_id,buf[0
],INET_ADDRSTRLEN),inet_ntop(AF_INET,&oh->area_id,buf[1],INET_ADDRSTRLEN));}retu
rnMSG_NG;}/*Instance-IDcheck*/if(oh->instance_id!=oi->instance_id){if(IS_OSPF6_D
EBUG_MESSAGE(oh->type,RECV))zlog_debug("%s:Instance-IDmismatch(my%u,rcvd%u)",__f
unc__,oi->instance_id,oh->instance_id);returnMSG_NG;}/*Router-IDcheck*/if(oh->ro
uter_id==oi->area->ospf6->router_id){zlog_warn("%s:DuplicateRouter-ID(%s)",__fun
c__,inet_ntop(AF_INET,&oh->router_id,buf[0],INET_ADDRSTRLEN));returnMSG_NG;}retu
rnMSG_OK;}staticvoidospf6_lsupdate_recv(structin6_addr*src,structin6_addr*dst,st
ructospf6_interface*oi,structospf6_header*oh){structospf6_neighbor*on;structospf
6_lsupdate*lsupdate;char*p;on=ospf6_neighbor_lookup(oh->router_id,oi);if(on==NUL
L){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Neighbornotfound,ignore"
);return;}if(on->state!=OSPF6_NEIGHBOR_EXCHANGE&&on->state!=OSPF6_NEIGHBOR_LOADI
NG&&on->state!=OSPF6_NEIGHBOR_FULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlo
g_debug("NeighborstatelessthanExchange,ignore");return;}lsupdate=(structospf6_ls
update*)((caddr_t)oh+sizeof(structospf6_header));oi->ls_upd_in++;/*ProcessLSAs*/
for(p=(char*)((caddr_t)lsupdate+sizeof(structospf6_lsupdate));p<OSPF6_MESSAGE_EN
D(oh)&&p+OSPF6_LSA_SIZE(p)<=OSPF6_MESSAGE_END(oh);p+=OSPF6_LSA_SIZE(p)){ospf6_re
ceive_lsa(on,(structospf6_lsa_header*)p);}assert(p==OSPF6_MESSAGE_END(oh));}stat
icvoidospf6_lsack_recv(structin6_addr*src,structin6_addr*dst,structospf6_interfa
ce*oi,structospf6_header*oh){structospf6_neighbor*on;char*p;structospf6_lsa*his,
*mine;structospf6_lsdb*lsdb=NULL;assert(oh->type==OSPF6_MESSAGE_TYPE_LSACK);on=o
spf6_neighbor_lookup(oh->router_id,oi);if(on==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh
->type,RECV))zlog_debug("Neighbornotfound,ignore");return;}if(on->state!=OSPF6_N
EIGHBOR_EXCHANGE&&on->state!=OSPF6_NEIGHBOR_LOADING&&on->state!=OSPF6_NEIGHBOR_F
ULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("NeighborstatelessthanE
xchange,ignore");return;}oi->ls_ack_in++;for(p=(char*)((caddr_t)oh+sizeof(struct
ospf6_header));p+sizeof(structospf6_lsa_header)<=OSPF6_MESSAGE_END(oh);p+=sizeof
(structospf6_lsa_header)){his=ospf6_lsa_create_headeronly((structospf6_lsa_heade
r*)p);switch(OSPF6_LSA_SCOPE(his->header->type)){caseOSPF6_SCOPE_LINKLOCAL:lsdb=
on->ospf6_if->lsdb;break;caseOSPF6_SCOPE_AREA:lsdb=on->ospf6_if->area->lsdb;brea
k;caseOSPF6_SCOPE_AS:lsdb=on->ospf6_if->area->ospf6->lsdb;break;caseOSPF6_SCOPE_
RESERVED:if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("IgnoringLSAofreser
vedscope");ospf6_lsa_delete(his);continue;break;}if(IS_OSPF6_DEBUG_MESSAGE(oh->t
ype,RECV))zlog_debug("%sacknowledgedby%s",his->name,on->name);/*Finddatabasecopy
*/mine=ospf6_lsdb_lookup(his->header->type,his->header->id,his->header->adv_rout
er,lsdb);if(mine==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Nod
atabasecopy");ospf6_lsa_delete(his);continue;}/*CheckiftheLSAisonhisretrans-list
*/mine=ospf6_lsdb_lookup(his->header->type,his->header->id,his->header->adv_rout
er,on->retrans_list);if(mine==NULL){if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlo
g_debug("Noton%s'sretrans-list",on->name);ospf6_lsa_delete(his);continue;}if(osp
f6_lsa_compare(his,mine)!=0){/*Logthisquestionableacknowledgement,andexaminethen
extone.*/if(IS_OSPF6_DEBUG_MESSAGE(oh->type,RECV))zlog_debug("Questionableacknow
ledgement");ospf6_lsa_delete(his);continue;}if(IS_OSPF6_DEBUG_MESSAGE(oh->type,R
ECV))zlog_debug("Acknowledged,removefrom%s'sretrans-list",on->name);ospf6_decrem
ent_retrans_count(mine);if(OSPF6_LSA_IS_MAXAGE(mine))ospf6_maxage_remove(on->osp
f6_if->area->ospf6);ospf6_lsdb_remove(mine,on->retrans_list);ospf6_lsa_delete(hi
s);}assert(p==OSPF6_MESSAGE_END(oh));}staticuint8_t*recvbuf=NULL;staticuint8_t*s
endbuf=NULL;staticunsignedintiobuflen=0;intospf6_iobuf_size(unsignedintsize){uin
t8_t*recvnew,*sendnew;if(size<=iobuflen)returniobuflen;recvnew=XMALLOC(MTYPE_OSP
F6_MESSAGE,size);sendnew=XMALLOC(MTYPE_OSPF6_MESSAGE,size);if(recvnew==NULL||sen
dnew==NULL){if(recvnew)XFREE(MTYPE_OSPF6_MESSAGE,recvnew);if(sendnew)XFREE(MTYPE
_OSPF6_MESSAGE,sendnew);zlog_debug("CouldnotallocateI/Obufferofsize%d.",size);re
turniobuflen;}if(recvbuf)XFREE(MTYPE_OSPF6_MESSAGE,recvbuf);if(sendbuf)XFREE(MTY
PE_OSPF6_MESSAGE,sendbuf);recvbuf=recvnew;sendbuf=sendnew;iobuflen=size;returnio
buflen;}voidospf6_message_terminate(void){if(recvbuf){XFREE(MTYPE_OSPF6_MESSAGE,
recvbuf);recvbuf=NULL;}if(sendbuf){XFREE(MTYPE_OSPF6_MESSAGE,sendbuf);sendbuf=NU
LL;}iobuflen=0;}intospf6_receive(structthread*thread){intsockfd;unsignedintlen;c
harsrcname[64],dstname[64];structin6_addrsrc,dst;ifindex_tifindex;structioveciov
ector[2];structospf6_interface*oi;structospf6_header*oh;/*addnextreadthread*/soc
kfd=THREAD_FD(thread);thread_add_read(master,ospf6_receive,NULL,sockfd,NULL);/*i
nitialize*/memset(&src,0,sizeof(src));memset(&dst,0,sizeof(dst));ifindex=0;memse
t(recvbuf,0,iobuflen);iovector[0].iov_base=recvbuf;iovector[0].iov_len=iobuflen;
iovector[1].iov_base=NULL;iovector[1].iov_len=0;/*receivemessage*/len=ospf6_recv
msg(&src,&dst,&ifindex,iovector);if(len>iobuflen){zlog_err("Excessmessageread");
return0;}oi=ospf6_interface_lookup_by_ifindex(ifindex);if(oi==NULL||oi->area==NU
LL||CHECK_FLAG(oi->flag,OSPF6_INTERFACE_DISABLE)){if(IS_OSPF6_DEBUG_MESSAGE(OSPF
6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("Messagereceivedondisabledinterface");re
turn0;}if(CHECK_FLAG(oi->flag,OSPF6_INTERFACE_PASSIVE)){if(IS_OSPF6_DEBUG_MESSAG
E(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))zlog_debug("%s:Ignoremessageonpassiveinterfac
e%s",__func__,oi->interface->name);return0;}oh=(structospf6_header*)recvbuf;if(o
spf6_rxpacket_examin(oi,oh,len)!=MSG_OK)return0;/*Beingheremeans,thatnosizing/al
ignmentissuesweredetectedintheinputpacket.Thisrenderstheadditionalchecksperforme
dbelowandalsointhetype-specificdispatchingfunctionsadeadcode,whichcanbedismissed
inacleanup-focusedreviewroundlater.*//*Log*/if(IS_OSPF6_DEBUG_MESSAGE(oh->type,R
ECV)){inet_ntop(AF_INET6,&src,srcname,sizeof(srcname));inet_ntop(AF_INET6,&dst,d
stname,sizeof(dstname));zlog_debug("%sreceivedon%s",lookup_msg(ospf6_message_typ
e_str,oh->type,NULL),oi->interface->name);zlog_debug("src:%s",srcname);zlog_debu
g("dst:%s",dstname);switch(oh->type){caseOSPF6_MESSAGE_TYPE_HELLO:ospf6_hello_pr
int(oh);break;caseOSPF6_MESSAGE_TYPE_DBDESC:ospf6_dbdesc_print(oh);break;caseOSP
F6_MESSAGE_TYPE_LSREQ:ospf6_lsreq_print(oh);break;caseOSPF6_MESSAGE_TYPE_LSUPDAT
E:ospf6_lsupdate_print(oh);break;caseOSPF6_MESSAGE_TYPE_LSACK:ospf6_lsack_print(
oh);break;default:assert(0);}}switch(oh->type){caseOSPF6_MESSAGE_TYPE_HELLO:ospf
6_hello_recv(&src,&dst,oi,oh);break;caseOSPF6_MESSAGE_TYPE_DBDESC:ospf6_dbdesc_r
ecv(&src,&dst,oi,oh);break;caseOSPF6_MESSAGE_TYPE_LSREQ:ospf6_lsreq_recv(&src,&d
st,oi,oh);break;caseOSPF6_MESSAGE_TYPE_LSUPDATE:ospf6_lsupdate_recv(&src,&dst,oi
,oh);break;caseOSPF6_MESSAGE_TYPE_LSACK:ospf6_lsack_recv(&src,&dst,oi,oh);break;
default:assert(0);}return0;}staticvoidospf6_send(structin6_addr*src,structin6_ad
dr*dst,structospf6_interface*oi,structospf6_header*oh){unsignedintlen;charsrcnam
e[64],dstname[64];structioveciovector[2];/*initialize*/iovector[0].iov_base=(cad
dr_t)oh;iovector[0].iov_len=ntohs(oh->length);iovector[1].iov_base=NULL;iovector
[1].iov_len=0;/*fillOSPFheader*/oh->version=OSPFV3_VERSION;/*messagetypemustbese
tbefore*//*messagelengthmustbesetbefore*/oh->router_id=oi->area->ospf6->router_i
d;oh->area_id=oi->area->area_id;/*checksumiscalculatedbykernel*/oh->instance_id=
oi->instance_id;oh->reserved=0;/*Log*/if(IS_OSPF6_DEBUG_MESSAGE(oh->type,SEND)){
inet_ntop(AF_INET6,dst,dstname,sizeof(dstname));if(src)inet_ntop(AF_INET6,src,sr
cname,sizeof(srcname));elsememset(srcname,0,sizeof(srcname));zlog_debug("%ssendo
n%s",lookup_msg(ospf6_message_type_str,oh->type,NULL),oi->interface->name);zlog_
debug("src:%s",srcname);zlog_debug("dst:%s",dstname);switch(oh->type){caseOSPF6_
MESSAGE_TYPE_HELLO:ospf6_hello_print(oh);break;caseOSPF6_MESSAGE_TYPE_DBDESC:osp
f6_dbdesc_print(oh);break;caseOSPF6_MESSAGE_TYPE_LSREQ:ospf6_lsreq_print(oh);bre
ak;caseOSPF6_MESSAGE_TYPE_LSUPDATE:ospf6_lsupdate_print(oh);break;caseOSPF6_MESS
AGE_TYPE_LSACK:ospf6_lsack_print(oh);break;default:zlog_debug("Unknownmessage");
assert(0);break;}}/*sendmessage*/len=ospf6_sendmsg(src,dst,&oi->interface->ifind
ex,iovector);if(len!=ntohs(oh->length))zlog_err("Couldnotsendentiremessage");}st
aticuint32_tospf6_packet_max(structospf6_interface*oi){assert(oi->ifmtu>sizeof(s
tructip6_hdr));returnoi->ifmtu-(sizeof(structip6_hdr));}intospf6_hello_send(stru
ctthread*thread){structospf6_interface*oi;structospf6_header*oh;structospf6_hell
o*hello;uint8_t*p;structlistnode*node,*nnode;structospf6_neighbor*on;oi=(structo
spf6_interface*)THREAD_ARG(thread);oi->thread_send_hello=(structthread*)NULL;if(
oi->state<=OSPF6_INTERFACE_DOWN){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_HE
LLO,SEND))zlog_debug("UnabletosendHelloondowninterface%s",oi->interface->name);r
eturn0;}if(iobuflen==0){zlog_debug("UnabletosendHellooninterface%siobuflenis0",o
i->interface->name);return0;}/*setnextthread*/thread_add_timer(master,ospf6_hell
o_send,oi,oi->hello_interval,&oi->thread_send_hello);memset(sendbuf,0,iobuflen);
oh=(structospf6_header*)sendbuf;hello=(structospf6_hello*)((caddr_t)oh+sizeof(st
ructospf6_header));hello->interface_id=htonl(oi->interface->ifindex);hello->prio
rity=oi->priority;hello->options[0]=oi->area->options[0];hello->options[1]=oi->a
rea->options[1];hello->options[2]=oi->area->options[2];hello->hello_interval=hto
ns(oi->hello_interval);hello->dead_interval=htons(oi->dead_interval);hello->drou
ter=oi->drouter;hello->bdrouter=oi->bdrouter;p=(uint8_t*)((caddr_t)hello+sizeof(
structospf6_hello));for(ALL_LIST_ELEMENTS(oi->neighbor_list,node,nnode,on)){if(o
n->state<OSPF6_NEIGHBOR_INIT)continue;if(p-sendbuf+sizeof(uint32_t)>ospf6_packet
_max(oi)){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_HELLO,SEND))zlog_debug("s
endingHellomessage:exceedsI/FMTU");break;}memcpy(p,&on->router_id,sizeof(uint32_
t));p+=sizeof(uint32_t);}oh->type=OSPF6_MESSAGE_TYPE_HELLO;oh->length=htons(p-se
ndbuf);oi->hello_out++;ospf6_send(oi->linklocal_addr,&allspfrouters6,oi,oh);retu
rn0;}intospf6_dbdesc_send(structthread*thread){structospf6_neighbor*on;structosp
f6_header*oh;structospf6_dbdesc*dbdesc;uint8_t*p;structospf6_lsa*lsa;structin6_a
ddr*dst;on=(structospf6_neighbor*)THREAD_ARG(thread);on->thread_send_dbdesc=(str
uctthread*)NULL;if(on->state<OSPF6_NEIGHBOR_EXSTART){if(IS_OSPF6_DEBUG_MESSAGE(O
SPF6_MESSAGE_TYPE_DBDESC,SEND))zlog_debug("QuittosendDbDesctoneighbor%sstate%s",
on->name,ospf6_neighbor_state_str[on->state]);return0;}/*setnextthreadifmaster*/
if(CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT))thread_add_timer(master,ospf6_
dbdesc_send,on,on->ospf6_if->rxmt_interval,&on->thread_send_dbdesc);memset(sendb
uf,0,iobuflen);oh=(structospf6_header*)sendbuf;dbdesc=(structospf6_dbdesc*)((cad
dr_t)oh+sizeof(structospf6_header));/*ifthisisinitialone,initializesequencenumbe
rforDbDesc*/if(CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT)&&(on->dbdesc_seqnum
==0)){on->dbdesc_seqnum=monotime(NULL);}dbdesc->options[0]=on->ospf6_if->area->o
ptions[0];dbdesc->options[1]=on->ospf6_if->area->options[1];dbdesc->options[2]=o
n->ospf6_if->area->options[2];dbdesc->ifmtu=htons(on->ospf6_if->ifmtu);dbdesc->b
its=on->dbdesc_bits;dbdesc->seqnum=htonl(on->dbdesc_seqnum);/*ifthisisnotinitial
one,setLSAheadersindbdesc*/p=(uint8_t*)((caddr_t)dbdesc+sizeof(structospf6_dbdes
c));if(!CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_IBIT)){for(ALL_LSDB(on->dbdesc_l
ist,lsa)){ospf6_lsa_age_update_to_send(lsa,on->ospf6_if->transdelay);/*MTUcheck*
/if(p-sendbuf+sizeof(structospf6_lsa_header)>ospf6_packet_max(on->ospf6_if)){osp
f6_lsdb_lsa_unlock(lsa);break;}memcpy(p,lsa->header,sizeof(structospf6_lsa_heade
r));p+=sizeof(structospf6_lsa_header);}}oh->type=OSPF6_MESSAGE_TYPE_DBDESC;oh->l
ength=htons(p-sendbuf);if(on->ospf6_if->state==OSPF6_INTERFACE_POINTTOPOINT)dst=
&allspfrouters6;elsedst=&on->linklocal_addr;on->ospf6_if->db_desc_out++;ospf6_se
nd(on->ospf6_if->linklocal_addr,dst,on->ospf6_if,oh);return0;}intospf6_dbdesc_se
nd_newone(structthread*thread){structospf6_neighbor*on;structospf6_lsa*lsa;unsig
nedintsize=0;on=(structospf6_neighbor*)THREAD_ARG(thread);ospf6_lsdb_remove_all(
on->dbdesc_list);/*moveLSAsfromsummary_listtodbdesc_list(withinneighborstructure
)sothatospf6_send_dbdesc()cansendthoseLSAs*/size=sizeof(structospf6_lsa_header)+
sizeof(structospf6_dbdesc);for(ALL_LSDB(on->summary_list,lsa)){if(size+sizeof(st
ructospf6_lsa_header)>ospf6_packet_max(on->ospf6_if)){ospf6_lsdb_lsa_unlock(lsa)
;break;}ospf6_lsdb_add(ospf6_lsa_copy(lsa),on->dbdesc_list);ospf6_lsdb_remove(ls
a,on->summary_list);size+=sizeof(structospf6_lsa_header);}if(on->summary_list->c
ount==0)UNSET_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MBIT);/*Ifslave,Morebitcheckmust
bedonehere*/if(!CHECK_FLAG(on->dbdesc_bits,OSPF6_DBDESC_MSBIT)&&/*Slave*/!CHECK_
FLAG(on->dbdesc_last.bits,OSPF6_DBDESC_MBIT)&&!CHECK_FLAG(on->dbdesc_bits,OSPF6_
DBDESC_MBIT))thread_add_event(master,exchange_done,on,0,NULL);thread_execute(mas
ter,ospf6_dbdesc_send,on,0);return0;}intospf6_lsreq_send(structthread*thread){st
ructospf6_neighbor*on;structospf6_header*oh;structospf6_lsreq_entry*e;uint8_t*p;
structospf6_lsa*lsa,*last_req;on=(structospf6_neighbor*)THREAD_ARG(thread);on->t
hread_send_lsreq=(structthread*)NULL;/*LSReqwillbesentonlyinExStartorLoading*/if
(on->state!=OSPF6_NEIGHBOR_EXCHANGE&&on->state!=OSPF6_NEIGHBOR_LOADING){if(IS_OS
PF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSREQ,SEND))zlog_debug("QuittosendLSReqtone
ighbor%sstate%s",on->name,ospf6_neighbor_state_str[on->state]);return0;}/*schedu
leloading_doneifrequestlistisempty*/if(on->request_list->count==0){thread_add_ev
ent(master,loading_done,on,0,NULL);return0;}memset(sendbuf,0,iobuflen);oh=(struc
tospf6_header*)sendbuf;last_req=NULL;/*setRequestentriesinlsreq*/p=(uint8_t*)((c
addr_t)oh+sizeof(structospf6_header));for(ALL_LSDB(on->request_list,lsa)){/*MTUc
heck*/if(p-sendbuf+sizeof(structospf6_lsreq_entry)>ospf6_packet_max(on->ospf6_if
)){ospf6_lsdb_lsa_unlock(lsa);break;}e=(structospf6_lsreq_entry*)p;e->type=lsa->
header->type;e->id=lsa->header->id;e->adv_router=lsa->header->adv_router;p+=size
of(structospf6_lsreq_entry);last_req=lsa;}if(last_req!=NULL){if(on->last_ls_req!
=NULL){ospf6_lsa_unlock(on->last_ls_req);}ospf6_lsa_lock(last_req);on->last_ls_r
eq=last_req;}oh->type=OSPF6_MESSAGE_TYPE_LSREQ;oh->length=htons(p-sendbuf);on->o
spf6_if->ls_req_out++;if(on->ospf6_if->state==OSPF6_INTERFACE_POINTTOPOINT)ospf6
_send(on->ospf6_if->linklocal_addr,&allspfrouters6,on->ospf6_if,oh);elseospf6_se
nd(on->ospf6_if->linklocal_addr,&on->linklocal_addr,on->ospf6_if,oh);/*setnextth
read*/if(on->request_list->count!=0){on->thread_send_lsreq=NULL;thread_add_timer
(master,ospf6_lsreq_send,on,on->ospf6_if->rxmt_interval,&on->thread_send_lsreq);
}return0;}staticvoidospf6_send_lsupdate(structospf6_neighbor*on,structospf6_inte
rface*oi,structospf6_header*oh){if(on){on->ospf6_if->ls_upd_out++;if((on->ospf6_
if->state==OSPF6_INTERFACE_POINTTOPOINT)||(on->ospf6_if->state==OSPF6_INTERFACE_
DR)||(on->ospf6_if->state==OSPF6_INTERFACE_BDR)){ospf6_send(on->ospf6_if->linklo
cal_addr,&allspfrouters6,on->ospf6_if,oh);}else{ospf6_send(on->ospf6_if->linkloc
al_addr,&on->linklocal_addr,on->ospf6_if,oh);}}elseif(oi){oi->ls_upd_out++;if((o
i->state==OSPF6_INTERFACE_POINTTOPOINT)||(oi->state==OSPF6_INTERFACE_DR)||(oi->s
tate==OSPF6_INTERFACE_BDR)){ospf6_send(oi->linklocal_addr,&allspfrouters6,oi,oh)
;}else{ospf6_send(oi->linklocal_addr,&alldrouters6,oi,oh);}}}intospf6_lsupdate_s
end_neighbor(structthread*thread){structospf6_neighbor*on;structospf6_header*oh;
structospf6_lsupdate*lsupdate;uint8_t*p;intlsa_cnt;structospf6_lsa*lsa;on=(struc
tospf6_neighbor*)THREAD_ARG(thread);on->thread_send_lsupdate=(structthread*)NULL
;if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSUPDATE,SEND))zlog_debug("LSUpdat
etoneighbor%s",on->name);if(on->state<OSPF6_NEIGHBOR_EXCHANGE){if(IS_OSPF6_DEBUG
_MESSAGE(OSPF6_MESSAGE_TYPE_LSUPDATE,SEND))zlog_debug("Quittosend(neighborstate%
s)",ospf6_neighbor_state_str[on->state]);return0;}memset(sendbuf,0,iobuflen);oh=
(structospf6_header*)sendbuf;lsupdate=(structospf6_lsupdate*)((caddr_t)oh+sizeof
(structospf6_header));p=(uint8_t*)((caddr_t)lsupdate+sizeof(structospf6_lsupdate
));lsa_cnt=0;/*lsupdate_listliststhoseLSAwhichdoesn'tneedtoberetransmitted.remov
ethosefromthelist*/for(ALL_LSDB(on->lsupdate_list,lsa)){/*MTUcheck*/if((p-sendbu
f+(unsignedint)OSPF6_LSA_SIZE(lsa->header))>ospf6_packet_max(on->ospf6_if)){if(l
sa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh->length=htons(p-sendbuf);lsupdat
e->lsa_number=htonl(lsa_cnt);ospf6_send_lsupdate(on,NULL,oh);memset(sendbuf,0,io
buflen);oh=(structospf6_header*)sendbuf;lsupdate=(structospf6_lsupdate*)((caddr_
t)oh+sizeof(structospf6_header));p=(uint8_t*)((caddr_t)lsupdate+sizeof(structosp
f6_lsupdate));lsa_cnt=0;}}ospf6_lsa_age_update_to_send(lsa,on->ospf6_if->transde
lay);memcpy(p,lsa->header,OSPF6_LSA_SIZE(lsa->header));p+=OSPF6_LSA_SIZE(lsa->he
ader);lsa_cnt++;assert(lsa->lock==2);ospf6_lsdb_remove(lsa,on->lsupdate_list);}i
f(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh->length=htons(p-sendbuf);lsup
date->lsa_number=htonl(lsa_cnt);ospf6_send_lsupdate(on,NULL,oh);}/*Theaddressesu
sedforretransmissionsaredifferentfromthosesentthefirsttimeandsoweneedtoseparatet
hemhere.*/memset(sendbuf,0,iobuflen);oh=(structospf6_header*)sendbuf;lsupdate=(s
tructospf6_lsupdate*)((caddr_t)oh+sizeof(structospf6_header));p=(uint8_t*)((cadd
r_t)lsupdate+sizeof(structospf6_lsupdate));lsa_cnt=0;for(ALL_LSDB(on->retrans_li
st,lsa)){/*MTUcheck*/if((p-sendbuf+(unsignedint)OSPF6_LSA_SIZE(lsa->header))>osp
f6_packet_max(on->ospf6_if)){if(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh
->length=htons(p-sendbuf);lsupdate->lsa_number=htonl(lsa_cnt);if(on->ospf6_if->s
tate==OSPF6_INTERFACE_POINTTOPOINT){ospf6_send(on->ospf6_if->linklocal_addr,&all
spfrouters6,on->ospf6_if,oh);}else{ospf6_send(on->ospf6_if->linklocal_addr,&on->
linklocal_addr,on->ospf6_if,oh);}memset(sendbuf,0,iobuflen);oh=(structospf6_head
er*)sendbuf;lsupdate=(structospf6_lsupdate*)((caddr_t)oh+sizeof(structospf6_head
er));p=(uint8_t*)((caddr_t)lsupdate+sizeof(structospf6_lsupdate));lsa_cnt=0;}}os
pf6_lsa_age_update_to_send(lsa,on->ospf6_if->transdelay);memcpy(p,lsa->header,OS
PF6_LSA_SIZE(lsa->header));p+=OSPF6_LSA_SIZE(lsa->header);lsa_cnt++;}if(lsa_cnt)
{oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh->length=htons(p-sendbuf);lsupdate->lsa_
number=htonl(lsa_cnt);if(on->ospf6_if->state==OSPF6_INTERFACE_POINTTOPOINT)ospf6
_send(on->ospf6_if->linklocal_addr,&allspfrouters6,on->ospf6_if,oh);elseospf6_se
nd(on->ospf6_if->linklocal_addr,&on->linklocal_addr,on->ospf6_if,oh);}if(on->lsu
pdate_list->count!=0){on->thread_send_lsupdate=NULL;thread_add_event(master,ospf
6_lsupdate_send_neighbor,on,0,&on->thread_send_lsupdate);}elseif(on->retrans_lis
t->count!=0){on->thread_send_lsupdate=NULL;thread_add_timer(master,ospf6_lsupdat
e_send_neighbor,on,on->ospf6_if->rxmt_interval,&on->thread_send_lsupdate);}retur
n0;}intospf6_lsupdate_send_neighbor_now(structospf6_neighbor*on,structospf6_lsa*
lsa){structospf6_header*oh;structospf6_lsupdate*lsupdate;uint8_t*p;intlsa_cnt=0;
memset(sendbuf,0,iobuflen);oh=(structospf6_header*)sendbuf;lsupdate=(structospf6
_lsupdate*)((caddr_t)oh+sizeof(structospf6_header));p=(uint8_t*)((caddr_t)lsupda
te+sizeof(structospf6_lsupdate));ospf6_lsa_age_update_to_send(lsa,on->ospf6_if->
transdelay);memcpy(p,lsa->header,OSPF6_LSA_SIZE(lsa->header));p+=OSPF6_LSA_SIZE(
lsa->header);lsa_cnt++;oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh->length=htons(p-s
endbuf);lsupdate->lsa_number=htonl(lsa_cnt);if(IS_OSPF6_DEBUG_FLOODING||IS_OSPF6
_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSUPDATE,SEND))zlog_debug("%s:Sendlsupdatewith
lsa%s(age%u)",__PRETTY_FUNCTION__,lsa->name,ntohs(lsa->header->age));ospf6_send_
lsupdate(on,NULL,oh);return0;}intospf6_lsupdate_send_interface(structthread*thre
ad){structospf6_interface*oi;structospf6_header*oh;structospf6_lsupdate*lsupdate
;uint8_t*p;intlsa_cnt;structospf6_lsa*lsa;oi=(structospf6_interface*)THREAD_ARG(
thread);oi->thread_send_lsupdate=(structthread*)NULL;if(oi->state<=OSPF6_INTERFA
CE_WAITING){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSUPDATE,SEND))zlog_deb
ug("QuittosendLSUpdatetointerface%sstate%s",oi->interface->name,ospf6_interface_
state_str[oi->state]);return0;}/*ifwehavenothingtosend,return*/if(oi->lsupdate_l
ist->count==0)return0;memset(sendbuf,0,iobuflen);oh=(structospf6_header*)sendbuf
;lsupdate=(structospf6_lsupdate*)((caddr_t)oh+sizeof(structospf6_header));p=(uin
t8_t*)((caddr_t)lsupdate+sizeof(structospf6_lsupdate));lsa_cnt=0;for(ALL_LSDB(oi
->lsupdate_list,lsa)){/*MTUcheck*/if((p-sendbuf+((unsignedint)OSPF6_LSA_SIZE(lsa
->header)))>ospf6_packet_max(oi)){if(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSUPDA
TE;oh->length=htons(p-sendbuf);lsupdate->lsa_number=htonl(lsa_cnt);ospf6_send_ls
update(NULL,oi,oh);if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSUPDATE,SEND))z
log_debug("%s:LSUpdatelength%d",__PRETTY_FUNCTION__,ntohs(oh->length));memset(se
ndbuf,0,iobuflen);oh=(structospf6_header*)sendbuf;lsupdate=(structospf6_lsupdate
*)((caddr_t)oh+sizeof(structospf6_header));p=(uint8_t*)((caddr_t)lsupdate+sizeof
(structospf6_lsupdate));lsa_cnt=0;}}ospf6_lsa_age_update_to_send(lsa,oi->transde
lay);memcpy(p,lsa->header,OSPF6_LSA_SIZE(lsa->header));p+=OSPF6_LSA_SIZE(lsa->he
ader);lsa_cnt++;assert(lsa->lock==2);ospf6_lsdb_remove(lsa,oi->lsupdate_list);}i
f(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSUPDATE;oh->length=htons(p-sendbuf);lsup
date->lsa_number=htonl(lsa_cnt);ospf6_send_lsupdate(NULL,oi,oh);}if(oi->lsupdate
_list->count>0){oi->thread_send_lsupdate=NULL;thread_add_event(master,ospf6_lsup
date_send_interface,oi,0,&oi->thread_send_lsupdate);}return0;}intospf6_lsack_sen
d_neighbor(structthread*thread){structospf6_neighbor*on;structospf6_header*oh;ui
nt8_t*p;structospf6_lsa*lsa;intlsa_cnt=0;on=(structospf6_neighbor*)THREAD_ARG(th
read);on->thread_send_lsack=(structthread*)NULL;if(on->state<OSPF6_NEIGHBOR_EXCH
ANGE){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSACK,SEND))zlog_debug("Quitt
osendLSAcktoneighbor%sstate%s",on->name,ospf6_neighbor_state_str[on->state]);ret
urn0;}/*ifwehavenothingtosend,return*/if(on->lsack_list->count==0)return0;memset
(sendbuf,0,iobuflen);oh=(structospf6_header*)sendbuf;p=(uint8_t*)((caddr_t)oh+si
zeof(structospf6_header));for(ALL_LSDB(on->lsack_list,lsa)){/*MTUcheck*/if(p-sen
dbuf+sizeof(structospf6_lsa_header)>ospf6_packet_max(on->ospf6_if)){/*ifwerunout
ofpacketsize/spacehere,bettertotryagainsoon.*/if(lsa_cnt){oh->type=OSPF6_MESSAGE
_TYPE_LSACK;oh->length=htons(p-sendbuf);on->ospf6_if->ls_ack_out++;ospf6_send(on
->ospf6_if->linklocal_addr,&on->linklocal_addr,on->ospf6_if,oh);memset(sendbuf,0
,iobuflen);oh=(structospf6_header*)sendbuf;p=(uint8_t*)((caddr_t)oh+sizeof(struc
tospf6_header));lsa_cnt=0;}}ospf6_lsa_age_update_to_send(lsa,on->ospf6_if->trans
delay);memcpy(p,lsa->header,sizeof(structospf6_lsa_header));p+=sizeof(structospf
6_lsa_header);assert(lsa->lock==2);ospf6_lsdb_remove(lsa,on->lsack_list);lsa_cnt
++;}if(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSACK;oh->length=htons(p-sendbuf);on
->ospf6_if->ls_ack_out++;ospf6_send(on->ospf6_if->linklocal_addr,&on->linklocal_
addr,on->ospf6_if,oh);}if(on->lsack_list->count>0)thread_add_event(master,ospf6_
lsack_send_neighbor,on,0,&on->thread_send_lsack);return0;}intospf6_lsack_send_in
terface(structthread*thread){structospf6_interface*oi;structospf6_header*oh;uint
8_t*p;structospf6_lsa*lsa;intlsa_cnt=0;oi=(structospf6_interface*)THREAD_ARG(thr
ead);oi->thread_send_lsack=(structthread*)NULL;if(oi->state<=OSPF6_INTERFACE_WAI
TING){if(IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_LSACK,SEND))zlog_debug("Quitt
osendLSAcktointerface%sstate%s",oi->interface->name,ospf6_interface_state_str[oi
->state]);return0;}/*ifwehavenothingtosend,return*/if(oi->lsack_list->count==0)r
eturn0;memset(sendbuf,0,iobuflen);oh=(structospf6_header*)sendbuf;p=(uint8_t*)((
caddr_t)oh+sizeof(structospf6_header));for(ALL_LSDB(oi->lsack_list,lsa)){/*MTUch
eck*/if(p-sendbuf+sizeof(structospf6_lsa_header)>ospf6_packet_max(oi)){/*ifwerun
outofpacketsize/spacehere,bettertotryagainsoon.*/THREAD_OFF(oi->thread_send_lsac
k);thread_add_event(master,ospf6_lsack_send_interface,oi,0,&oi->thread_send_lsac
k);ospf6_lsdb_lsa_unlock(lsa);break;}ospf6_lsa_age_update_to_send(lsa,oi->transd
elay);memcpy(p,lsa->header,sizeof(structospf6_lsa_header));p+=sizeof(structospf6
_lsa_header);assert(lsa->lock==2);ospf6_lsdb_remove(lsa,oi->lsack_list);lsa_cnt+
+;}if(lsa_cnt){oh->type=OSPF6_MESSAGE_TYPE_LSACK;oh->length=htons(p-sendbuf);if(
(oi->state==OSPF6_INTERFACE_POINTTOPOINT)||(oi->state==OSPF6_INTERFACE_DR)||(oi-
>state==OSPF6_INTERFACE_BDR))ospf6_send(oi->linklocal_addr,&allspfrouters6,oi,oh
);elseospf6_send(oi->linklocal_addr,&alldrouters6,oi,oh);}if(oi->lsack_list->cou
nt>0)thread_add_event(master,ospf6_lsack_send_interface,oi,0,&oi->thread_send_ls
ack);return0;}/*Commands*/DEFUN(debug_ospf6_message,debug_ospf6_message_cmd,"deb
ugospf6message<unknown|hello|dbdesc|lsreq|lsupdate|lsack|all>[<send|recv>]",DEBU
G_STROSPF6_STR"DebugOSPFv3message\n""DebugUnknownmessage\n""DebugHellomessage\n"
"DebugDatabaseDescriptionmessage\n""DebugLinkStateRequestmessage\n""DebugLinkSta
teUpdatemessage\n""DebugLinkStateAcknowledgementmessage\n""DebugAllmessage\n""De
bugonlysendingmessage\n""Debugonlyreceivingmessage\n"){intidx_packet=3;intidx_se
nd_recv=4;unsignedcharlevel=0;inttype=0;inti;/*checktype*/if(!strncmp(argv[idx_p
acket]->arg,"u",1))type=OSPF6_MESSAGE_TYPE_UNKNOWN;elseif(!strncmp(argv[idx_pack
et]->arg,"h",1))type=OSPF6_MESSAGE_TYPE_HELLO;elseif(!strncmp(argv[idx_packet]->
arg,"d",1))type=OSPF6_MESSAGE_TYPE_DBDESC;elseif(!strncmp(argv[idx_packet]->arg,
"lsr",3))type=OSPF6_MESSAGE_TYPE_LSREQ;elseif(!strncmp(argv[idx_packet]->arg,"ls
u",3))type=OSPF6_MESSAGE_TYPE_LSUPDATE;elseif(!strncmp(argv[idx_packet]->arg,"ls
a",3))type=OSPF6_MESSAGE_TYPE_LSACK;elseif(!strncmp(argv[idx_packet]->arg,"a",1)
)type=OSPF6_MESSAGE_TYPE_ALL;if(argc==4)level=OSPF6_DEBUG_MESSAGE_SEND|OSPF6_DEB
UG_MESSAGE_RECV;elseif(!strncmp(argv[idx_send_recv]->arg,"s",1))level=OSPF6_DEBU
G_MESSAGE_SEND;elseif(!strncmp(argv[idx_send_recv]->arg,"r",1))level=OSPF6_DEBUG
_MESSAGE_RECV;if(type==OSPF6_MESSAGE_TYPE_ALL){for(i=0;i<6;i++)OSPF6_DEBUG_MESSA
GE_ON(i,level);}elseOSPF6_DEBUG_MESSAGE_ON(type,level);returnCMD_SUCCESS;}DEFUN(
no_debug_ospf6_message,no_debug_ospf6_message_cmd,"nodebugospf6message<unknown|h
ello|dbdesc|lsreq|lsupdate|lsack|all>[<send|recv>]",NO_STRDEBUG_STROSPF6_STR"Deb
ugOSPFv3message\n""DebugUnknownmessage\n""DebugHellomessage\n""DebugDatabaseDesc
riptionmessage\n""DebugLinkStateRequestmessage\n""DebugLinkStateUpdatemessage\n"
"DebugLinkStateAcknowledgementmessage\n""DebugAllmessage\n""Debugonlysendingmess
age\n""Debugonlyreceivingmessage\n"){intidx_packet=4;intidx_send_recv=5;unsigned
charlevel=0;inttype=0;inti;/*checktype*/if(!strncmp(argv[idx_packet]->arg,"u",1)
)type=OSPF6_MESSAGE_TYPE_UNKNOWN;elseif(!strncmp(argv[idx_packet]->arg,"h",1))ty
pe=OSPF6_MESSAGE_TYPE_HELLO;elseif(!strncmp(argv[idx_packet]->arg,"d",1))type=OS
PF6_MESSAGE_TYPE_DBDESC;elseif(!strncmp(argv[idx_packet]->arg,"lsr",3))type=OSPF
6_MESSAGE_TYPE_LSREQ;elseif(!strncmp(argv[idx_packet]->arg,"lsu",3))type=OSPF6_M
ESSAGE_TYPE_LSUPDATE;elseif(!strncmp(argv[idx_packet]->arg,"lsa",3))type=OSPF6_M
ESSAGE_TYPE_LSACK;elseif(!strncmp(argv[idx_packet]->arg,"a",1))type=OSPF6_MESSAG
E_TYPE_ALL;if(argc==5)level=OSPF6_DEBUG_MESSAGE_SEND|OSPF6_DEBUG_MESSAGE_RECV;el
seif(!strncmp(argv[idx_send_recv]->arg,"s",1))level=OSPF6_DEBUG_MESSAGE_SEND;els
eif(!strncmp(argv[idx_send_recv]->arg,"r",1))level=OSPF6_DEBUG_MESSAGE_RECV;if(t
ype==OSPF6_MESSAGE_TYPE_ALL){for(i=0;i<6;i++)OSPF6_DEBUG_MESSAGE_OFF(i,level);}e
lseOSPF6_DEBUG_MESSAGE_OFF(type,level);returnCMD_SUCCESS;}intconfig_write_ospf6_
debug_message(structvty*vty){constchar*type_str[]={"unknown","hello","dbdesc","l
sreq","lsupdate","lsack"};unsignedchars=0,r=0;inti;for(i=0;i<6;i++){if(IS_OSPF6_
DEBUG_MESSAGE(i,SEND))s|=1<<i;if(IS_OSPF6_DEBUG_MESSAGE(i,RECV))r|=1<<i;}if(s==0
x3f&&r==0x3f){vty_out(vty,"debugospf6messageall\n");return0;}if(s==0x3f&&r==0){v
ty_out(vty,"debugospf6messageallsend\n");return0;}elseif(s==0&&r==0x3f){vty_out(
vty,"debugospf6messageallrecv\n");return0;}/*Unknownmessageisloggedbydefault*/if
(!IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,SEND)&&!IS_OSPF6_DEBUG_MESSA
GE(OSPF6_MESSAGE_TYPE_UNKNOWN,RECV))vty_out(vty,"nodebugospf6messageunknown\n");
elseif(!IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYPE_UNKNOWN,SEND))vty_out(vty,"nod
ebugospf6messageunknownsend\n");elseif(!IS_OSPF6_DEBUG_MESSAGE(OSPF6_MESSAGE_TYP
E_UNKNOWN,RECV))vty_out(vty,"nodebugospf6messageunknownrecv\n");for(i=1;i<6;i++)
{if(IS_OSPF6_DEBUG_MESSAGE(i,SEND)&&IS_OSPF6_DEBUG_MESSAGE(i,RECV))vty_out(vty,"
debugospf6message%s\n",type_str[i]);elseif(IS_OSPF6_DEBUG_MESSAGE(i,SEND))vty_ou
t(vty,"debugospf6message%ssend\n",type_str[i]);elseif(IS_OSPF6_DEBUG_MESSAGE(i,R
ECV))vty_out(vty,"debugospf6message%srecv\n",type_str[i]);}return0;}voidinstall_
element_ospf6_debug_message(void){install_element(ENABLE_NODE,&debug_ospf6_messa
ge_cmd);install_element(ENABLE_NODE,&no_debug_ospf6_message_cmd);install_element
(CONFIG_NODE,&debug_ospf6_message_cmd);install_element(CONFIG_NODE,&no_debug_osp
f6_message_cmd);}