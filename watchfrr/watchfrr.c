/**Monitorstatusoffrrdaemonsandrestartifnecessary.**Copyright(C)2004AndrewJ.Scho
rr**Thisprogramisfreesoftware;youcanredistributeitand/ormodify*itunderthetermsof
theGNUGeneralPublicLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2
oftheLicense,or*(atyouroption)anylaterversion.**Thisprogramisdistributedinthehop
ethatitwillbeuseful,*butWITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCH
ANTABILITYorFITNESSFORAPARTICULARPURPOSE.Seethe*GNUGeneralPublicLicenseformorede
tails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprog
ram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,
FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<thread.h>#include<l
og.h>#include<network.h>#include<sigevent.h>#include<lib/version.h>#include"comm
and.h"#include"memory_vty.h"#include"libfrr.h"#include<getopt.h>#include<sys/un.
h>#include<sys/wait.h>#include<memory.h>#include<systemd.h>#include"watchfrr.h"#
ifndefMIN#defineMIN(X,Y)(((X)<=(Y))?(X):(Y))#endif/*Macrostohelprandomizetimers.
*/#defineJITTER(X)((random()%((X)+1))-((X)/2))#defineFUZZY(X)((X)+JITTER((X)/20)
)#defineDEFAULT_PERIOD5#defineDEFAULT_TIMEOUT90#defineDEFAULT_RESTART_TIMEOUT20#
defineDEFAULT_LOGLEVELLOG_INFO#defineDEFAULT_MIN_RESTART60#defineDEFAULT_MAX_RES
TART600#definePING_TOKEN"PING"/*Needstobeglobal,referencedsomewhereinsidelibfrr.
*/structthread_master*master;staticcharpidfile_default[256];staticboolwatch_only
=false;typedefenum{PHASE_NONE=0,PHASE_STOPS_PENDING,PHASE_WAITING_DOWN,PHASE_ZEB
RA_RESTART_PENDING,PHASE_WAITING_ZEBRA_UP}restart_phase_t;staticconstchar*phase_
str[]={"None","Stopjobsrunning","Waitingforotherdaemonstocomedown","Zebrarestart
jobrunning","Waitingforzebratocomeup","Startjobsrunning",};#definePHASE_TIMEOUT(
3*gs.restart_timeout)structrestart_info{constchar*name;constchar*what;pid_tpid;s
tructtimevaltime;longinterval;structthread*t_kill;intkills;};staticstructglobal_
state{restart_phase_tphase;structthread*t_phase_hanging;constchar*vtydir;longper
iod;longtimeout;longrestart_timeout;longmin_restart_interval;longmax_restart_int
erval;structdaemon*daemons;constchar*restart_command;constchar*start_command;con
stchar*stop_command;structrestart_inforestart;intloglevel;structdaemon*special;/
*pointstozebrawhendoingphasedrestart*/intnumdaemons;intnumpids;intnumdown;/*#ofd
aemonsthatarenotUPorUNRESPONSIVE*/}gs={.phase=PHASE_NONE,.vtydir=frr_vtydir,.per
iod=1000*DEFAULT_PERIOD,.timeout=DEFAULT_TIMEOUT,.restart_timeout=DEFAULT_RESTAR
T_TIMEOUT,.loglevel=DEFAULT_LOGLEVEL,.min_restart_interval=DEFAULT_MIN_RESTART,.
max_restart_interval=DEFAULT_MAX_RESTART,};typedefenum{DAEMON_INIT,DAEMON_DOWN,D
AEMON_CONNECTING,DAEMON_UP,DAEMON_UNRESPONSIVE}daemon_state_t;#defineIS_UP(DMN)\
(((DMN)->state==DAEMON_UP)||((DMN)->state==DAEMON_UNRESPONSIVE))staticconstchar*
state_str[]={"Init","Down","Connecting","Up","Unresponsive",};structdaemon{const
char*name;daemon_state_tstate;intfd;structtimevalecho_sent;unsignedintconnect_tr
ies;structthread*t_wakeup;structthread*t_read;structthread*t_write;structdaemon*
next;structrestart_inforestart;};#defineOPTION_MINRESTART2000#defineOPTION_MAXRE
START2001#defineOPTION_DRY2002staticconststructoptionlongopts[]={{"daemon",no_ar
gument,NULL,'d'},{"statedir",required_argument,NULL,'S'},{"loglevel",required_ar
gument,NULL,'l'},{"interval",required_argument,NULL,'i'},{"timeout",required_arg
ument,NULL,'t'},{"restart-timeout",required_argument,NULL,'T'},{"restart",requir
ed_argument,NULL,'r'},{"start-command",required_argument,NULL,'s'},{"kill-comman
d",required_argument,NULL,'k'},{"dry",no_argument,NULL,OPTION_DRY},{"min-restart
-interval",required_argument,NULL,OPTION_MINRESTART},{"max-restart-interval",req
uired_argument,NULL,OPTION_MAXRESTART},{"pid-file",required_argument,NULL,'p'},{
"blank-string",required_argument,NULL,'b'},{"help",no_argument,NULL,'h'},{"versi
on",no_argument,NULL,'v'},{NULL,0,NULL,0}};staticinttry_connect(structdaemon*dmn
);staticintwakeup_send_echo(structthread*t_wakeup);staticvoidtry_restart(structd
aemon*dmn);staticvoidphase_check(void);staticconstchar*progname;staticvoidprinth
elp(FILE*target){fprintf(target,"Usage:%s[OPTION...]<daemonname>...\n\n\Watchdog
programtomonitorstatusoffrrdaemonsandtrytorestart\n\themiftheyaredownorunrespons
ive.Itdetermineswhetheradaemonis\n\upbasedonwhetheritcanconnecttothedaemon'svtyu
nixstreamsocket.\n\Itthenrepeatedlysendsechocommandsoverthatsockettodeterminewhe
ther\n\thedaemonisresponsive.Ifthedaemoncrashes,wewillreceiveanEOF\n\onthesocket
connectionandknowimmediatelythatthedaemonisdown.\n\n\Thedaemonstobemonitoredshou
ldbelistedonthecommandline.\n\n\Inordertoavoidattemptingtorestartthedaemonsinafa
stloop,\n\the-mand-Moptionsallowyoutocontroltheminimumdelaybetween\n\restartcomm
ands.Theminimumrestartdelayisrecalculatedeachtime\n\arestartisattempted:ifthetim
esincethelastrestartattemptexceeds\n\twicethe-Mvalue,thentherestartdelayissettot
he-mvalue.\n\Otherwise,theintervalisdoubled(butcappedatthe-Mvalue).\n\n",prognam
e);fprintf(target,"Options:\n\-d,--daemonRunindaemonmode.Inthismode,errormessage
saresent\n\tosysloginsteadofstdout.\n\-S,--statedirSetthevtysocketdirectory(defa
ultis%s)\n\-l,--loglevelSetthelogginglevel(defaultis%d).\n\Thevalueshouldrangefr
om%d(LOG_EMERG)to%d(LOG_DEBUG),\n\butitcanbesethigherthan%difextra-verbosedebugg
ing\n\messagesaredesired.\n\--min-restart-interval\n\Settheminimumsecondstowaitb
etweeninvocationsofdaemon\n\restartcommands(defaultis%d).\n\--max-restart-interv
al\n\Setthemaximumsecondstowaitbetweeninvocationsofdaemon\n\restartcommands(defa
ultis%d).\n\-i,--intervalSetthestatuspollingintervalinseconds(defaultis%d)\n\-t,
--timeoutSettheunresponsivenesstimeoutinseconds(defaultis%d)\n\-T,--restart-time
out\n\Settherestart(kill)timeoutinseconds(defaultis%d).\n\Ifanybackgroundjobsare
stillrunningafterthismuch\n\timehaselapsed,theywillbekilled.\n\-r,--restartSuppl
yaBourneshellcommandtousetorestartasingle\n\daemon.Thecommandstringshouldinclude
'%%s'wherethe\n\nameofthedaemonshouldbesubstituted.\n\-s,--start-command\n\Suppl
yaBourneshelltocommandtousetostartasingle\n\daemon.Thecommandstringshouldinclude
'%%s'wherethe\n\nameofthedaemonshouldbesubstituted.\n\-k,--kill-command\n\Supply
aBourneshelltocommandtousetostopasingle\n\daemon.Thecommandstringshouldinclude'%
%s'wherethe\n\nameofthedaemonshouldbesubstituted.\n\--dryDonotstartorrestartanyt
hing,justlog.\n\-p,--pid-fileSetprocessidentifierfilename\n\(defaultis%s).\n\-b,
--blank-string\n\Whenthesuppliedargumentstringisfoundinanyofthe\n\variousshellco
mmandarguments(-r,-s,or-k),replace\n\itwithaspace.Thisisanuglyhacktocircumventpr
oblems\n\passingcommand-lineargumentswithembeddedspaces.\n\-v,--versionPrintprog
ramversion\n\-h,--helpDisplaythishelpandexit\n",frr_vtydir,DEFAULT_LOGLEVEL,LOG_
EMERG,LOG_DEBUG,LOG_DEBUG,DEFAULT_MIN_RESTART,DEFAULT_MAX_RESTART,DEFAULT_PERIOD
,DEFAULT_TIMEOUT,DEFAULT_RESTART_TIMEOUT,pidfile_default);}staticpid_trun_backgr
ound(char*shell_cmd){pid_tchild;switch(child=fork()){case-1:zlog_err("forkfailed
,cannotruncommand[%s]:%s",shell_cmd,safe_strerror(errno));return-1;case0:/*Child
process.*//*Useseparateprocessgroupsochildprocessescanbekilled*easily.*/if(setpg
id(0,0)<0)zlog_warn("warning:setpgid(0,0)failed:%s",safe_strerror(errno));{chars
hell[]="sh";chardashc[]="-c";char*constargv[4]={shell,dashc,shell_cmd,NULL};exec
v("/bin/sh",argv);zlog_err("execv(/bin/sh-c'%s')failed:%s",shell_cmd,safe_strerr
or(errno));_exit(127);}default:/*Parentprocess:wewillreapthechildlater.*/zlog_er
r("Forkedbackgroundcommand[pid%d]:%s",(int)child,shell_cmd);returnchild;}}static
structtimeval*time_elapsed(structtimeval*result,conststructtimeval*start_time){g
ettimeofday(result,NULL);result->tv_sec-=start_time->tv_sec;result->tv_usec-=sta
rt_time->tv_usec;while(result->tv_usec<0){result->tv_usec+=1000000L;result->tv_s
ec--;}returnresult;}staticintrestart_kill(structthread*t_kill){structrestart_inf
o*restart=THREAD_ARG(t_kill);structtimevaldelay;time_elapsed(&delay,&restart->ti
me);zlog_warn("Warning:%s%schildprocess%dstillrunningafter""%ldseconds,sendingsi
gnal%d",restart->what,restart->name,(int)restart->pid,(long)delay.tv_sec,(restar
t->kills?SIGKILL:SIGTERM));kill(-restart->pid,(restart->kills?SIGKILL:SIGTERM));
restart->kills++;restart->t_kill=NULL;thread_add_timer(master,restart_kill,resta
rt,gs.restart_timeout,&restart->t_kill);return0;}staticstructrestart_info*find_c
hild(pid_tchild){structdaemon*dmn;for(dmn=gs.daemons;dmn;dmn=dmn->next){if(dmn->
restart.pid==child)return&dmn->restart;}returnNULL;}staticvoidsigchild(void){pid
_tchild;intstatus;constchar*name;constchar*what;structrestart_info*restart;switc
h(child=waitpid(-1,&status,WNOHANG)){case-1:zlog_err("waitpidfailed:%s",safe_str
error(errno));return;case0:zlog_warn("SIGCHLDreceived,butwaitpiddidnotreapachild
");return;}if(child==integrated_write_pid){integrated_write_sigchld(status);retu
rn;}if((restart=find_child(child))!=NULL){name=restart->name;what=restart->what;
restart->pid=0;gs.numpids--;thread_cancel(restart->t_kill);restart->t_kill=NULL;
/*Updaterestarttimetoreflectthetimethecommand*completed.*/gettimeofday(&restart-
>time,NULL);}else{zlog_err("waitpidreturnedstatusforanunknownchildprocess%d",(in
t)child);name="(unknown)";what="background";}if(WIFSTOPPED(status))zlog_warn("wa
rning:%s%sprocess%disstopped",what,name,(int)child);elseif(WIFSIGNALED(status))z
log_warn("%s%sprocess%dterminatedduetosignal%d",what,name,(int)child,WTERMSIG(st
atus));elseif(WIFEXITED(status)){if(WEXITSTATUS(status)!=0)zlog_warn("%s%sproces
s%dexitedwithnon-zerostatus%d",what,name,(int)child,WEXITSTATUS(status));elsezlo
g_debug("%s%sprocess%dexitednormally",what,name,(int)child);}elsezlog_err("canno
tinterpret%s%sprocess%dwaitstatus0x%x",what,name,(int)child,status);phase_check(
);}staticintrun_job(structrestart_info*restart,constchar*cmdtype,constchar*comma
nd,intforce,intupdate_interval){structtimevaldelay;if(gs.loglevel>LOG_DEBUG+1)zl
og_debug("attemptingto%s%s",cmdtype,restart->name);if(restart->pid){if(gs.loglev
el>LOG_DEBUG+1)zlog_debug("cannot%s%s,previouspid%dstillrunning",cmdtype,restart
->name,(int)restart->pid);return-1;}/*Note:time_elapsedtestmustcomebeforetheforc
etest,sinceweneedtomakesurethatdelayisinitializedforusebelowinupdatingtherestart
interval.*/if((time_elapsed(&delay,&restart->time)->tv_sec<restart->interval)&&!
force){if(gs.loglevel>LOG_DEBUG+1)zlog_debug("postponing%s%s:""elapsedtime%ld<re
tryinterval%ld",cmdtype,restart->name,(long)delay.tv_sec,restart->interval);retu
rn-1;}gettimeofday(&restart->time,NULL);restart->kills=0;{charcmd[strlen(command
)+strlen(restart->name)+1];snprintf(cmd,sizeof(cmd),command,restart->name);if((r
estart->pid=run_background(cmd))>0){restart->t_kill=NULL;thread_add_timer(master
,restart_kill,restart,gs.restart_timeout,&restart->t_kill);restart->what=cmdtype
;gs.numpids++;}elserestart->pid=0;}/*Calculatethenewrestartinterval.*/if(update_
interval){if(delay.tv_sec>2*gs.max_restart_interval)restart->interval=gs.min_res
tart_interval;elseif((restart->interval*=2)>gs.max_restart_interval)restart->int
erval=gs.max_restart_interval;if(gs.loglevel>LOG_DEBUG+1)zlog_debug("restart%sin
tervalisnow%ld",restart->name,restart->interval);}returnrestart->pid;}#defineSET
_READ_HANDLER(DMN)\do{\(DMN)->t_read=NULL;\thread_add_read(master,handle_read,(D
MN),(DMN)->fd,\&(DMN)->t_read);\}while(0);#defineSET_WAKEUP_DOWN(DMN)\do{\(DMN)-
>t_wakeup=NULL;\thread_add_timer_msec(master,wakeup_down,(DMN),\FUZZY(gs.period)
,&(DMN)->t_wakeup);\}while(0);#defineSET_WAKEUP_UNRESPONSIVE(DMN)\do{\(DMN)->t_w
akeup=NULL;\thread_add_timer_msec(master,wakeup_unresponsive,(DMN),\FUZZY(gs.per
iod),&(DMN)->t_wakeup);\}while(0);#defineSET_WAKEUP_ECHO(DMN)\do{\(DMN)->t_wakeu
p=NULL;\thread_add_timer_msec(master,wakeup_send_echo,(DMN),\FUZZY(gs.period),&(
DMN)->t_wakeup);\}while(0);staticintwakeup_down(structthread*t_wakeup){structdae
mon*dmn=THREAD_ARG(t_wakeup);dmn->t_wakeup=NULL;if(try_connect(dmn)<0)SET_WAKEUP
_DOWN(dmn);if((dmn->connect_tries>1)&&(dmn->state!=DAEMON_UP))try_restart(dmn);r
eturn0;}staticintwakeup_init(structthread*t_wakeup){structdaemon*dmn=THREAD_ARG(
t_wakeup);dmn->t_wakeup=NULL;if(try_connect(dmn)<0){SET_WAKEUP_DOWN(dmn);zlog_er
r("%sstate->down:initialconnectionattemptfailed",dmn->name);dmn->state=DAEMON_DO
WN;}return0;}staticvoiddaemon_down(structdaemon*dmn,constchar*why){if(IS_UP(dmn)
||(dmn->state==DAEMON_INIT))zlog_err("%sstate->down:%s",dmn->name,why);elseif(gs
.loglevel>LOG_DEBUG)zlog_debug("%sstilldown:%s",dmn->name,why);if(IS_UP(dmn))gs.
numdown++;dmn->state=DAEMON_DOWN;if(dmn->fd>=0){close(dmn->fd);dmn->fd=-1;}THREA
D_OFF(dmn->t_read);THREAD_OFF(dmn->t_write);THREAD_OFF(dmn->t_wakeup);if(try_con
nect(dmn)<0)SET_WAKEUP_DOWN(dmn);phase_check();}staticinthandle_read(structthrea
d*t_read){structdaemon*dmn=THREAD_ARG(t_read);staticconstcharresp[sizeof(PING_TO
KEN)+4]=PING_TOKEN"\n";charbuf[sizeof(resp)+100];ssize_trc;structtimevaldelay;dm
n->t_read=NULL;if((rc=read(dmn->fd,buf,sizeof(buf)))<0){charwhy[100];if(ERRNO_IO
_RETRY(errno)){/*Pretenditneverhappened.*/SET_READ_HANDLER(dmn);return0;}snprint
f(why,sizeof(why),"unexpectedreaderror:%s",safe_strerror(errno));daemon_down(dmn
,why);return0;}if(rc==0){daemon_down(dmn,"readreturnedEOF");return0;}if(!dmn->ec
ho_sent.tv_sec){charwhy[sizeof(buf)+100];snprintf(why,sizeof(why),"unexpectedrea
dreturns%dbytes:%.*s",(int)rc,(int)rc,buf);daemon_down(dmn,why);return0;}/*Weare
expectinganechoresponse:isthereanychancethattheresponsewouldnotbereturnedentirel
yinthefirstread?Thatseemsinconceivable...*/if((rc!=sizeof(resp))||memcmp(buf,res
p,sizeof(resp))){charwhy[100+sizeof(buf)];snprintf(why,sizeof(why),"readreturned
badechoresponseof%dbytes""(expecting%u):%.*s",(int)rc,(unsignedint)sizeof(resp),
(int)rc,buf);daemon_down(dmn,why);return0;}time_elapsed(&delay,&dmn->echo_sent);
dmn->echo_sent.tv_sec=0;if(dmn->state==DAEMON_UNRESPONSIVE){if(delay.tv_sec<gs.t
imeout){dmn->state=DAEMON_UP;zlog_warn("%sstate->up:echoresponsereceivedafter%ld
.%06ld""seconds",dmn->name,(long)delay.tv_sec,(long)delay.tv_usec);}elsezlog_war
n("%s:slowechoresponsefinallyreceivedafter%ld.%06ld""seconds",dmn->name,(long)de
lay.tv_sec,(long)delay.tv_usec);}elseif(gs.loglevel>LOG_DEBUG+1)zlog_debug("%s:e
choresponsereceivedafter%ld.%06ldseconds",dmn->name,(long)delay.tv_sec,(long)del
ay.tv_usec);SET_READ_HANDLER(dmn);if(dmn->t_wakeup)thread_cancel(dmn->t_wakeup);
SET_WAKEUP_ECHO(dmn);return0;}/**Waittillwenoticethatalldaemonsarereadybefore*we
sendwearereadytosystemd*/staticvoiddaemon_send_ready(void){staticintsent=0;if(!s
ent&&gs.numdown==0){FILE*fp;fp=fopen(DAEMON_VTY_DIR"/watchfrr.started","w");if(f
p)fclose(fp);#ifdefinedHAVE_SYSTEMDzlog_notice("Watchfrr:NotifyingSystemdweareup
andrunning");systemd_send_started(master,0);#endifsent=1;}}staticvoiddaemon_up(s
tructdaemon*dmn,constchar*why){dmn->state=DAEMON_UP;gs.numdown--;dmn->connect_tr
ies=0;zlog_notice("%sstate->up:%s",dmn->name,why);daemon_send_ready();SET_WAKEUP
_ECHO(dmn);phase_check();}staticintcheck_connect(structthread*t_write){structdae
mon*dmn=THREAD_ARG(t_write);intsockerr;socklen_treslen=sizeof(sockerr);dmn->t_wr
ite=NULL;if(getsockopt(dmn->fd,SOL_SOCKET,SO_ERROR,(char*)&sockerr,&reslen)<0){z
log_warn("%s:check_connect:getsockoptfailed:%s",dmn->name,safe_strerror(errno));
daemon_down(dmn,"getsockoptfailedcheckingconnectionsuccess");return0;}if((reslen
==sizeof(sockerr))&&sockerr){charwhy[100];snprintf(why,sizeof(why),"getsockoptre
portsthatconnectionattemptfailed:%s",safe_strerror(sockerr));daemon_down(dmn,why
);return0;}daemon_up(dmn,"delayedconnectsucceeded");return0;}staticintwakeup_con
nect_hanging(structthread*t_wakeup){structdaemon*dmn=THREAD_ARG(t_wakeup);charwh
y[100];dmn->t_wakeup=NULL;snprintf(why,sizeof(why),"connectionattempttimedoutaft
er%ldseconds",gs.timeout);daemon_down(dmn,why);return0;}/*Makingconnectiontoprot
ocoldaemon.*/staticinttry_connect(structdaemon*dmn){intsock;structsockaddr_unadd
r;socklen_tlen;if(gs.loglevel>LOG_DEBUG+1)zlog_debug("%s:attemptingtoconnect",dm
n->name);dmn->connect_tries++;memset(&addr,0,sizeof(structsockaddr_un));addr.sun
_family=AF_UNIX;snprintf(addr.sun_path,sizeof(addr.sun_path),"%s/%s.vty",gs.vtyd
ir,dmn->name);#ifdefHAVE_STRUCT_SOCKADDR_UN_SUN_LENlen=addr.sun_len=SUN_LEN(&add
r);#elselen=sizeof(addr.sun_family)+strlen(addr.sun_path);#endif/*HAVE_STRUCT_SO
CKADDR_UN_SUN_LEN*//*Quickchecktoseeifwemightsucceedbeforewegotothetroubleofcrea
tingasocket.*/if(access(addr.sun_path,W_OK)<0){if(errno!=ENOENT)zlog_err("%s:acc
esstosocket%sdenied:%s",dmn->name,addr.sun_path,safe_strerror(errno));return-1;}
if((sock=socket(AF_UNIX,SOCK_STREAM,0))<0){zlog_err("%s(%s):cannotmakesocket:%s"
,__func__,addr.sun_path,safe_strerror(errno));return-1;}if(set_nonblocking(sock)
<0||set_cloexec(sock)<0){zlog_err("%s(%s):set_nonblocking/cloexec(%d)failed",__f
unc__,addr.sun_path,sock);close(sock);return-1;}if(connect(sock,(structsockaddr*
)&addr,len)<0){if((errno!=EINPROGRESS)&&(errno!=EWOULDBLOCK)){if(gs.loglevel>LOG
_DEBUG)zlog_debug("%s(%s):connectfailed:%s",__func__,addr.sun_path,safe_strerror
(errno));close(sock);return-1;}if(gs.loglevel>LOG_DEBUG)zlog_debug("%s:connectio
ninprogress",dmn->name);dmn->state=DAEMON_CONNECTING;dmn->fd=sock;dmn->t_write=N
ULL;thread_add_write(master,check_connect,dmn,dmn->fd,&dmn->t_write);dmn->t_wake
up=NULL;thread_add_timer(master,wakeup_connect_hanging,dmn,gs.timeout,&dmn->t_wa
keup);SET_READ_HANDLER(dmn);return0;}dmn->fd=sock;SET_READ_HANDLER(dmn);daemon_u
p(dmn,"connectsucceeded");return1;}staticintphase_hanging(structthread*t_hanging
){gs.t_phase_hanging=NULL;zlog_err("Phase[%s]hangingfor%ldseconds,abortingphased
restart",phase_str[gs.phase],PHASE_TIMEOUT);gs.phase=PHASE_NONE;return0;}staticv
oidset_phase(restart_phase_tnew_phase){gs.phase=new_phase;if(gs.t_phase_hanging)
thread_cancel(gs.t_phase_hanging);gs.t_phase_hanging=NULL;thread_add_timer(maste
r,phase_hanging,NULL,PHASE_TIMEOUT,&gs.t_phase_hanging);}staticvoidphase_check(v
oid){switch(gs.phase){casePHASE_NONE:break;casePHASE_STOPS_PENDING:if(gs.numpids
)break;zlog_info("Phasedrestart:allroutingdaemonstopjobshavecompleted.");set_pha
se(PHASE_WAITING_DOWN);/*FALLTHRU*/casePHASE_WAITING_DOWN:if(gs.numdown+IS_UP(gs
.special)<gs.numdaemons)break;zlog_info("Phasedrestart:allroutingdaemonsnowdown.
");run_job(&gs.special->restart,"restart",gs.restart_command,1,1);set_phase(PHAS
E_ZEBRA_RESTART_PENDING);/*FALLTHRU*/casePHASE_ZEBRA_RESTART_PENDING:if(gs.speci
al->restart.pid)break;zlog_info("Phasedrestart:%srestartjobcompleted.",gs.specia
l->name);set_phase(PHASE_WAITING_ZEBRA_UP);/*FALLTHRU*/casePHASE_WAITING_ZEBRA_U
P:if(!IS_UP(gs.special))break;zlog_info("Phasedrestart:%sisnowup.",gs.special->n
ame);{structdaemon*dmn;for(dmn=gs.daemons;dmn;dmn=dmn->next){if(dmn!=gs.special)
run_job(&dmn->restart,"start",gs.start_command,1,0);}}gs.phase=PHASE_NONE;THREAD
_OFF(gs.t_phase_hanging);zlog_notice("Phasedglobalrestarthascompleted.");break;}
}staticvoidtry_restart(structdaemon*dmn){if(watch_only)return;if(dmn!=gs.special
){if((gs.special->state==DAEMON_UP)&&(gs.phase==PHASE_NONE))run_job(&dmn->restar
t,"restart",gs.restart_command,0,1);elsezlog_debug("%s:postponingrestartattemptb
ecausemaster%sdaemon""notup[%s],orphasedrestartinprogress",dmn->name,gs.special-
>name,state_str[gs.special->state]);return;}if((gs.phase!=PHASE_NONE)||gs.numpid
s){if(gs.loglevel>LOG_DEBUG+1)zlog_debug("postponingphasedglobalrestart:restarta
lreadyin""progress[%s],oroutstandingchildprocesses[%d]",phase_str[gs.phase],gs.n
umpids);return;}/*Isittoosoonforarestart?*/{structtimevaldelay;if(time_elapsed(&
delay,&gs.special->restart.time)->tv_sec<gs.special->restart.interval){if(gs.log
level>LOG_DEBUG+1)zlog_debug("postponingphasedglobalrestart:""elapsedtime%ld<ret
ryinterval%ld",(long)delay.tv_sec,gs.special->restart.interval);return;}}run_job
(&gs.restart,"restart",gs.restart_command,0,1);}staticintwakeup_unresponsive(str
uctthread*t_wakeup){structdaemon*dmn=THREAD_ARG(t_wakeup);dmn->t_wakeup=NULL;if(
dmn->state!=DAEMON_UNRESPONSIVE)zlog_err("%s:nolongerunresponsive(now%s),""wakeu
pshouldhavebeencancelled!",dmn->name,state_str[dmn->state]);else{SET_WAKEUP_UNRE
SPONSIVE(dmn);try_restart(dmn);}return0;}staticintwakeup_no_answer(structthread*
t_wakeup){structdaemon*dmn=THREAD_ARG(t_wakeup);dmn->t_wakeup=NULL;dmn->state=DA
EMON_UNRESPONSIVE;zlog_err("%sstate->unresponsive:noresponseyettoping""sent%ldse
condsago",dmn->name,gs.timeout);SET_WAKEUP_UNRESPONSIVE(dmn);try_restart(dmn);re
turn0;}staticintwakeup_send_echo(structthread*t_wakeup){staticconstcharechocmd[]
="echo"PING_TOKEN;ssize_trc;structdaemon*dmn=THREAD_ARG(t_wakeup);dmn->t_wakeup=
NULL;if(((rc=write(dmn->fd,echocmd,sizeof(echocmd)))<0)||((size_t)rc!=sizeof(ech
ocmd))){charwhy[100+sizeof(echocmd)];snprintf(why,sizeof(why),"write'%s'returned
%dinsteadof%u",echocmd,(int)rc,(unsignedint)sizeof(echocmd));daemon_down(dmn,why
);}else{gettimeofday(&dmn->echo_sent,NULL);dmn->t_wakeup=NULL;thread_add_timer(m
aster,wakeup_no_answer,dmn,gs.timeout,&dmn->t_wakeup);}return0;}boolcheck_all_up
(void){structdaemon*dmn;for(dmn=gs.daemons;dmn;dmn=dmn->next)if(dmn->state!=DAEM
ON_UP)returnfalse;returntrue;}staticvoidsigint(void){zlog_notice("Terminatingons
ignal");systemd_send_stopping();exit(0);}staticintvalid_command(constchar*cmd){c
har*p;return((p=strchr(cmd,'%'))!=NULL)&&(*(p+1)=='s')&&!strchr(p+1,'%');}/*This
isanuglyhacktocircumventproblemswithpassingcommand-lineargumentsthatcontainspace
s.Thefixistouseaconfigurationfile.*/staticchar*translate_blanks(constchar*cmd,co
nstchar*blankstr){char*res;char*p;size_tbslen=strlen(blankstr);if(!(res=strdup(c
md))){perror("strdup");exit(1);}while((p=strstr(res,blankstr))!=NULL){*p='';if(b
slen!=1)memmove(p+1,p+bslen,strlen(p+bslen)+1);}returnres;}structzebra_privs_twa
tchfrr_privs={#ifdefVTY_GROUP.vty_group=VTY_GROUP,#endif};staticstructquagga_sig
nal_twatchfrr_signals[]={{.signal=SIGINT,.handler=sigint,},{.signal=SIGTERM,.han
dler=sigint,},{.signal=SIGCHLD,.handler=sigchild,},};FRR_DAEMON_INFO(watchfrr,WA
TCHFRR,.flags=FRR_NO_PRIVSEP|FRR_NO_TCPVTY|FRR_LIMITED_CLI|FRR_NO_CFG_PID_DRY|FR
R_NO_ZCLIENT,.printhelp=printhelp,.copyright="Copyright2004AndrewJ.Schorr",.sign
als=watchfrr_signals,.n_signals=array_size(watchfrr_signals),.privs=&watchfrr_pr
ivs,)#defineDEPRECATED_OPTIONS"aAezR:"intmain(intargc,char**argv){intopt;constch
ar*pidfile=pidfile_default;constchar*special="zebra";constchar*blankstr=NULL;snp
rintf(pidfile_default,sizeof(pidfile_default),"%s/watchfrr.pid",frr_vtydir);frr_
preinit(&watchfrr_di,argc,argv);progname=watchfrr_di.progname;frr_opt_add("b:dk:
l:i:p:r:S:s:t:T:"DEPRECATED_OPTIONS,longopts,"");gs.restart.name="all";while((op
t=frr_getopt(argc,argv,NULL))!=EOF){if(opt&&opt<128&&strchr(DEPRECATED_OPTIONS,o
pt)){fprintf(stderr,"The-%coptionnolongerexists.\n""Pleaserefertothewatchfrr(8)m
anpage.\n",opt);exit(1);}switch(opt){case0:break;case'b':blankstr=optarg;break;c
aseOPTION_DRY:watch_only=true;break;case'k':if(!valid_command(optarg)){fprintf(s
tderr,"Invalidkillcommand,mustcontain'%%s':%s\n",optarg);frr_help_exit(1);}gs.st
op_command=optarg;break;case'l':{chargarbage[3];if((sscanf(optarg,"%d%1s",&gs.lo
glevel,garbage)!=1)||(gs.loglevel<LOG_EMERG)){fprintf(stderr,"Invalidloglevelarg
ument:%s\n",optarg);frr_help_exit(1);}}break;caseOPTION_MINRESTART:{chargarbage[
3];if((sscanf(optarg,"%ld%1s",&gs.min_restart_interval,garbage)!=1)||(gs.min_res
tart_interval<0)){fprintf(stderr,"Invalidmin_restart_intervalargument:%s\n",opta
rg);frr_help_exit(1);}}break;caseOPTION_MAXRESTART:{chargarbage[3];if((sscanf(op
targ,"%ld%1s",&gs.max_restart_interval,garbage)!=1)||(gs.max_restart_interval<0)
){fprintf(stderr,"Invalidmax_restart_intervalargument:%s\n",optarg);frr_help_exi
t(1);}}break;case'i':{chargarbage[3];intperiod;if((sscanf(optarg,"%d%1s",&period
,garbage)!=1)||(gs.period<1)){fprintf(stderr,"Invalidintervalargument:%s\n",opta
rg);frr_help_exit(1);}gs.period=1000*period;}break;case'p':pidfile=optarg;break;
case'r':if(!valid_command(optarg)){fprintf(stderr,"Invalidrestartcommand,mustcon
tain'%%s':%s\n",optarg);frr_help_exit(1);}gs.restart_command=optarg;break;case's
':if(!valid_command(optarg)){fprintf(stderr,"Invalidstartcommand,mustcontain'%%s
':%s\n",optarg);frr_help_exit(1);}gs.start_command=optarg;break;case'S':gs.vtydi
r=optarg;break;case't':{chargarbage[3];if((sscanf(optarg,"%ld%1s",&gs.timeout,ga
rbage)!=1)||(gs.timeout<1)){fprintf(stderr,"Invalidtimeoutargument:%s\n",optarg)
;frr_help_exit(1);}}break;case'T':{chargarbage[3];if((sscanf(optarg,"%ld%1s",&gs
.restart_timeout,garbage)!=1)||(gs.restart_timeout<1)){fprintf(stderr,"Invalidre
starttimeoutargument:%s\n",optarg);frr_help_exit(1);}}break;default:fputs("Inval
idoption.\n",stderr);frr_help_exit(1);}}if(watch_only&&(gs.start_command||gs.sto
p_command||gs.restart_command)){fputs("Options-r/-s/-karenotusedwhen--dryisactiv
e.\n",stderr);}if(!watch_only&&(!gs.restart_command||!gs.start_command||!gs.stop
_command)){fprintf(stderr,"Options-s(start),-k(kill),and-r(restart)arerequired.\
n");frr_help_exit(1);}if(blankstr){if(gs.restart_command)gs.restart_command=tran
slate_blanks(gs.restart_command,blankstr);if(gs.start_command)gs.start_command=t
ranslate_blanks(gs.start_command,blankstr);if(gs.stop_command)gs.stop_command=tr
anslate_blanks(gs.stop_command,blankstr);}gs.restart.interval=gs.min_restart_int
erval;master=frr_init();zlog_set_level(ZLOG_DEST_MONITOR,ZLOG_DISABLED);if(watch
frr_di.daemon_mode){zlog_set_level(ZLOG_DEST_SYSLOG,MIN(gs.loglevel,LOG_DEBUG));
if(daemon(0,0)<0){fprintf(stderr,"Watchfrrdaemonfailed:%s",strerror(errno));exit
(1);}}elsezlog_set_level(ZLOG_DEST_STDOUT,MIN(gs.loglevel,LOG_DEBUG));watchfrr_v
ty_init();frr_vty_serv();{inti;structdaemon*tail=NULL;for(i=optind;i<argc;i++){s
tructdaemon*dmn;if(!(dmn=(structdaemon*)calloc(1,sizeof(*dmn)))){fprintf(stderr,
"calloc(1,%u)failed:%s\n",(unsignedint)sizeof(*dmn),safe_strerror(errno));return
1;}dmn->name=dmn->restart.name=argv[i];dmn->state=DAEMON_INIT;gs.numdaemons++;gs
.numdown++;dmn->fd=-1;dmn->t_wakeup=NULL;thread_add_timer_msec(master,wakeup_ini
t,dmn,100+(random()%900),&dmn->t_wakeup);dmn->restart.interval=gs.min_restart_in
terval;if(tail)tail->next=dmn;elsegs.daemons=dmn;tail=dmn;if(!strcmp(dmn->name,s
pecial))gs.special=dmn;}}if(!gs.daemons){fputs("Mustspecifyoneormoredaemonstomon
itor.\n",stderr);frr_help_exit(1);}if(!watch_only&&!gs.special){fprintf(stderr,"
\"%s\"daemonmustbeindaemonlist\n",special);frr_help_exit(1);}/*Makesurewe'renota
lreadyrunning.*/pid_output(pidfile);/*Announcewhichdaemonsarebeingmonitored.*/{s
tructdaemon*dmn;size_tlen=0;for(dmn=gs.daemons;dmn;dmn=dmn->next)len+=strlen(dmn
->name)+1;{charbuf[len+1];char*p=buf;for(dmn=gs.daemons;dmn;dmn=dmn->next){if(p!
=buf)*p++='';strcpy(p,dmn->name);p+=strlen(p);}zlog_notice("%s%swatching[%s]%s",
progname,FRR_VERSION,buf,watch_only?",monitormode":"");}}{structthreadthread;whi
le(thread_fetch(master,&thread))thread_call(&thread);}systemd_send_stopping();/*
Notreached.*/return0;}