/**watchfrrCLIfunctions.**Copyright(C)2016DavidLamparterforNetDEF,Inc.**Thisprog
ramisfreesoftware;youcanredistributeitand/ormodify*itunderthetermsoftheGNUGenera
lPublicLicenseaspublishedby*theFreeSoftwareFoundation;eitherversion2oftheLicense
,or*(atyouroption)anylaterversion.**Thisprogramisdistributedinthehopethatitwillb
euseful,*butWITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.Seethe*GNUGeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include<sys/wait.h>#include"memory.h"#i
nclude"log.h"#include"vty.h"#include"command.h"#include"watchfrr.h"pid_tintegrat
ed_write_pid;staticintintegrated_result_fd;DEFUN(config_write_integrated,config_
write_integrated_cmd,"writeintegrated","Writerunningconfigurationtomemory,networ
k,orterminal\n""Writeintegratedall-daemonfrr.conffile\n"){pid_tchild;sigset_told
mask,sigmask;constchar*e_inprog="Configurationwritealreadyinprogress.";constchar
*e_dmn="Notalldaemonsareup,cannotwriteconfig.";if(integrated_write_pid!=-1){vty_
out(vty,"%%%s\n",e_inprog);returnCMD_WARNING;}/*checkthatalldaemonsareupbeforecl
obberingconfig*/if(!check_all_up()){vty_out(vty,"%%%s\n",e_dmn);/**vtyshinterpre
tsthisreturnvaluetomeanthatitshould*nottrytowritetheconfigitself*/returnCMD_WARN
ING_CONFIG_FAILED;}fflush(stdout);fflush(stderr);/*needtotemporarilyblockSIGCHLD
becauseitcouldarrivebetween*fork()callandsettingtheintegrated_write_pidvariable.
This*wouldmeanthecompletioncallgetslostandthishangsforever.*/sigemptyset(&oldmas
k);sigemptyset(&sigmask);sigaddset(&sigmask,SIGCHLD);sigprocmask(SIG_BLOCK,&sigm
ask,&oldmask);child=fork();if(child==-1){vty_out(vty,"%%configurationwritefork()
failed:%s.\n",safe_strerror(errno));sigprocmask(SIG_SETMASK,&oldmask,NULL);retur
nCMD_WARNING;}if(child!=0){/*note:theVTYwon'twriteacommandreturnvaluetovtysh;*th
e*sessiontemporarilyentersanintentional"hang"state.This*is*tomakesurelatencyinvt
yshdoingtheconfigwrite(several*secondsisnotraretosee)doesnotinterferewith*watchf
rr's*supervisorjob.**Thefdisduplicatedheresowedon'tneedtoholdavty*pointer*(which
couldbecomeinvalidinthemeantime).*/integrated_write_pid=child;integrated_result_
fd=dup(vty->wfd);sigprocmask(SIG_SETMASK,&oldmask,NULL);returnCMD_SUSPEND;}/*red
irectstdout/stderrtovtysession.Notevty->wfdismarked*CLOEXEC,butdup2willclearthat
flag.*/dup2(vty->wfd,1);dup2(vty->wfd,2);/*don'tallowtheusertopassparameters,we'
reroothere!*shouldprobablyhardenvtyshatsomepointtoo...*/execl(VTYSH_BIN_PATH,"vt
ysh","-w",NULL);/*unbufferedwrite;wejustmessedwithstdout...*/charmsg[512];snprin
tf(msg,sizeof(msg),"errorexecuting%s:%s\n",VTYSH_BIN_PATH,safe_strerror(errno));
write(1,msg,strlen(msg));exit(1);}DEFUN_NOSH(show_debugging_watchfrr,show_debugg
ing_watchfrr_cmd,"showdebugging[watchfrr]",SHOW_STRDEBUG_STRWATCHFRR_STR){return
CMD_SUCCESS;}voidintegrated_write_sigchld(intstatus){uint8_treply[4]={0,0,0,CMD_
WARNING};if(WIFEXITED(status)){zlog_info("configurationwritecompletedwithexitcod
e%d",WEXITSTATUS(status));reply[3]=WEXITSTATUS(status);}elseif(WIFSIGNALED(statu
s)){zlog_warn("configurationwriteterminatedbysignal%d",WTERMSIG(status));}else{z
log_warn("configurationwriteterminated");}if(reply[3]!=CMD_SUCCESS){/*failuremig
htbesilentinvtyshwithoutthis*/staticconstcharmsg[]="%Configurationwritefailed.\n
";write(integrated_result_fd,msg,strlen(msg));}/*don'tcareaboutfailureshere,ifth
econnectionisbrokenthe*returnvaluewilljustbelost.*/write(integrated_result_fd,re
ply,sizeof(reply));close(integrated_result_fd);integrated_write_pid=-1;}voidwatc
hfrr_vty_init(void){integrated_write_pid=-1;install_element(ENABLE_NODE,&config_
write_integrated_cmd);install_element(ENABLE_NODE,&show_debugging_watchfrr_cmd);
install_element(CONFIG_NODE,&show_debugging_watchfrr_cmd);}