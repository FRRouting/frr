/**SHARP-vtycode*Copyright(C)CumulusNetworks,Inc.*DonaldSharp**ThisfileispartofF
RR.**FRRisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUG
eneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(aty
ouroption)any*laterversion.**FRRisdistributedinthehopethatitwillbeuseful,but*WIT
HOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPART
ICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceiv
edacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot
,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1
301USA*/#include<zebra.h>#include"vty.h"#include"command.h"#include"prefix.h"#in
clude"nexthop.h"#include"log.h"#include"vrf.h"#include"zclient.h"#include"sharpd
/sharp_zebra.h"#include"sharpd/sharp_vty.h"#ifndefVTYSH_EXTRACT_PL#include"sharp
d/sharp_vty_clippy.c"#endifexternuint32_ttotal_routes;externuint32_tinstalled_ro
utes;externuint32_tremoved_routes;DEFPY(watch_nexthop_v6,watch_nexthop_v6_cmd,"s
harpwatchnexthopX:X::X:X$nhop","SharproutingProtocol\n""Watchforchanges\n""Watch
fornexthopchanges\n""Thev6nexthoptosignalforwatching\n"){structprefixp;memset(&p
,0,sizeof(p));p.prefixlen=128;memcpy(&p.u.prefix6,&nhop,16);p.family=AF_INET6;sh
arp_zebra_nexthop_watch(&p,true);returnCMD_SUCCESS;}DEFPY(watch_nexthop_v4,watch
_nexthop_v4_cmd,"sharpwatchnexthopA.B.C.D$nhop","SharproutingProtocol\n""Watchfo
rchanges\n""Watchfornexthopchanges\n""Thev4nexthoptosignalforwatching\n"){struct
prefixp;memset(&p,0,sizeof(p));p.prefixlen=32;p.u.prefix4=nhop;p.family=AF_INET;
sharp_zebra_nexthop_watch(&p,true);returnCMD_SUCCESS;}DEFPY(install_routes,insta
ll_routes_cmd,"sharpinstallroutesA.B.C.D$startnexthopA.B.C.D$nexthop(1-1000000)$
routes","SharproutingProtocol\n""installsomeroutes\n""Routestoinstall\n""Address
tostart/32generationat\n""Nexthoptouse\n""Nexthopaddress\n""Howmanytocreate\n"){
inti;structprefixp;structnexthopnhop;uint32_ttemp;total_routes=routes;installed_
routes=0;memset(&p,0,sizeof(p));memset(&nhop,0,sizeof(nhop));p.family=AF_INET;p.
prefixlen=32;p.u.prefix4=start;nhop.gate.ipv4=nexthop;nhop.type=NEXTHOP_TYPE_IPV
4;zlog_debug("Inserting%ldroutes",routes);temp=ntohl(p.u.prefix4.s_addr);for(i=0
;i<routes;i++){route_add(&p,&nhop);p.u.prefix4.s_addr=htonl(++temp);}returnCMD_S
UCCESS;}DEFPY(vrf_label,vrf_label_cmd,"sharplabel<ip$ipv4|ipv6$ipv6>vrfNAME$name
label(0-100000)$label","SharpRoutingProtocol\n""Giveavrfalabel\n""Popandforwardf
orIPv4\n""PopandforwardforIPv6\n"VRF_CMD_HELP_STR"Thelabeltouse,0specifiesremove
thelabelinstalledfromprevious\n""Specifiedrangetouse\n"){structvrf*vrf;afi_tafi=
(ipv4)?AFI_IP:AFI_IP6;if(strcmp(name,"default")==0)vrf=vrf_lookup_by_id(VRF_DEFA
ULT);elsevrf=vrf_lookup_by_name(name);if(!vrf){vty_out(vty,"Unabletofindvrfyousi
llyhead");returnCMD_WARNING_CONFIG_FAILED;}if(label==0)label=MPLS_LABEL_NONE;vrf
_label_add(vrf->vrf_id,afi,label);returnCMD_SUCCESS;}DEFPY(remove_routes,remove_
routes_cmd,"sharpremoveroutesA.B.C.D$start(1-1000000)$routes","SharpRoutingProto
col\n""Removesomeroutes\n""Routestoremove\n""Startingspot\n""Routestouniinstall\
n"){inti;structprefixp;uint32_ttemp;total_routes=routes;removed_routes=0;memset(
&p,0,sizeof(p));p.family=AF_INET;p.prefixlen=32;p.u.prefix4=start;zlog_debug("Re
moving%ldroutes",routes);temp=ntohl(p.u.prefix4.s_addr);for(i=0;i<routes;i++){ro
ute_delete(&p);p.u.prefix4.s_addr=htonl(++temp);}returnCMD_SUCCESS;}voidsharp_vt
y_init(void){install_element(ENABLE_NODE,&install_routes_cmd);install_element(EN
ABLE_NODE,&remove_routes_cmd);install_element(ENABLE_NODE,&vrf_label_cmd);instal
l_element(ENABLE_NODE,&watch_nexthop_v6_cmd);install_element(ENABLE_NODE,&watch_
nexthop_v4_cmd);return;}