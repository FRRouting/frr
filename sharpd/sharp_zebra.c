/**Zebraconnectcode.*Copyright(C)CumulusNetworks,Inc.*DonaldSharp**Thisfileispar
tofFRR.**FRRisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofthe
GNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or
(atyouroption)any*laterversion.**FRRisdistributedinthehopethatitwillbeuseful,but
*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORA
PARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavere
ceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;i
fnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA021
10-1301USA*/#include<zebra.h>#include"thread.h"#include"command.h"#include"netwo
rk.h"#include"prefix.h"#include"routemap.h"#include"table.h"#include"stream.h"#i
nclude"memory.h"#include"zclient.h"#include"filter.h"#include"plist.h"#include"l
og.h"#include"nexthop.h"#include"sharp_zebra.h"/*Zebrastructuretoholdcurrentstat
us.*/structzclient*zclient=NULL;/*Forregisteringthreads.*/externstructthread_mas
ter*master;staticstructinterface*zebra_interface_if_lookup(structstream*s){chari
fname_tmp[INTERFACE_NAMSIZ];/*Readinterfacename.*/stream_get(ifname_tmp,s,INTERF
ACE_NAMSIZ);/*Andlookitup.*/returnif_lookup_by_name(ifname_tmp,VRF_DEFAULT);}/*I
ntefaceadditionmessagefromzebra.*/staticintinterface_add(intcommand,structzclien
t*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;ifp=zebra_inter
face_add_read(zclient->ibuf,vrf_id);if(!ifp->info)return0;return0;}staticintinte
rface_delete(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id)
{structinterface*ifp;structstream*s;s=zclient->ibuf;/*zebra_interface_state_read
()updatesinterfacestructureiniflist*/ifp=zebra_interface_state_read(s,vrf_id);if
(ifp==NULL)return0;if_set_index(ifp,IFINDEX_INTERNAL);return0;}staticintinterfac
e_address_add(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id
){zebra_interface_address_read(command,zclient->ibuf,vrf_id);return0;}staticinti
nterface_address_delete(intcommand,structzclient*zclient,zebra_size_tlength,vrf_
id_tvrf_id){structconnected*c;c=zebra_interface_address_read(command,zclient->ib
uf,vrf_id);if(!c)return0;connected_free(c);return0;}staticintinterface_state_up(
intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){zebra_interf
ace_if_lookup(zclient->ibuf);return0;}staticintinterface_state_down(intcommand,s
tructzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){zebra_interface_state_re
ad(zclient->ibuf,vrf_id);return0;}externuint32_ttotal_routes;externuint32_tinsta
lled_routes;externuint32_tremoved_routes;staticintroute_notify_owner(intcommand,
structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structprefixp;enumzapi_
route_notify_ownernote;uint32_ttable;if(!zapi_route_notify_decode(zclient->ibuf,
&p,&table,&note))return-1;switch(note){caseZAPI_ROUTE_INSTALLED:installed_routes
++;if(total_routes==installed_routes)zlog_debug("InstalledAllItems");break;caseZ
API_ROUTE_FAIL_INSTALL:zlog_debug("Failedinstallofroute");break;caseZAPI_ROUTE_B
ETTER_ADMIN_WON:zlog_debug("BetterAdminDistancewonoverus");break;caseZAPI_ROUTE_
REMOVED:removed_routes++;if(total_routes==removed_routes)zlog_debug("RemovedallI
tems");break;caseZAPI_ROUTE_REMOVE_FAIL:zlog_debug("RouteremovalFailure");break;
}return0;}staticvoidzebra_connected(structzclient*zclient){zclient_send_reg_requ
ests(zclient,VRF_DEFAULT);}voidvrf_label_add(vrf_id_tvrf_id,afi_tafi,mpls_label_
tlabel){zclient_send_vrf_label(zclient,vrf_id,afi,label,ZEBRA_LSP_SHARP);}voidro
ute_add(structprefix*p,structnexthop*nh){structzapi_routeapi;structzapi_nexthop*
api_nh;memset(&api,0,sizeof(api));api.vrf_id=VRF_DEFAULT;api.type=ZEBRA_ROUTE_SH
ARP;api.safi=SAFI_UNICAST;memcpy(&api.prefix,p,sizeof(*p));SET_FLAG(api.flags,ZE
BRA_FLAG_ALLOW_RECURSION);SET_FLAG(api.message,ZAPI_MESSAGE_NEXTHOP);api_nh=&api
.nexthops[0];api_nh->vrf_id=VRF_DEFAULT;api_nh->gate.ipv4=nh->gate.ipv4;api_nh->
type=nh->type;api_nh->ifindex=nh->ifindex;api.nexthop_num=1;zclient_route_send(Z
EBRA_ROUTE_ADD,zclient,&api);}voidroute_delete(structprefix*p){structzapi_routea
pi;memset(&api,0,sizeof(api));api.vrf_id=VRF_DEFAULT;api.type=ZEBRA_ROUTE_SHARP;
api.safi=SAFI_UNICAST;memcpy(&api.prefix,p,sizeof(*p));zclient_route_send(ZEBRA_
ROUTE_DELETE,zclient,&api);return;}voidsharp_zebra_nexthop_watch(structprefix*p,
boolwatch){intcommand=ZEBRA_NEXTHOP_REGISTER;if(!watch)command=ZEBRA_NEXTHOP_UNR
EGISTER;zclient_send_rnh(zclient,command,p,true,VRF_DEFAULT);}staticintsharp_nex
thop_update(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){
structzapi_routenhr;charbuf[PREFIX_STRLEN];inti;if(!zapi_nexthop_update_decode(z
client->ibuf,&nhr)){zlog_warn("%s:Decodeofupdatefailed",__PRETTY_FUNCTION__);ret
urn0;}zlog_debug("Receivedupdatefor%s",prefix2str(&nhr.prefix,buf,sizeof(buf)));
for(i=0;i<nhr.nexthop_num;i++){structzapi_nexthop*znh=&nhr.nexthops[i];switch(zn
h->type){caseNEXTHOP_TYPE_IPV4_IFINDEX:caseNEXTHOP_TYPE_IPV4:zlog_debug("\tNexth
op%s,type:%d,ifindex:%d,vrf:%d,label_num:%d",inet_ntop(AF_INET,&znh->gate.ipv4.s
_addr,buf,sizeof(buf)),znh->type,znh->ifindex,znh->vrf_id,znh->label_num);break;
caseNEXTHOP_TYPE_IPV6_IFINDEX:caseNEXTHOP_TYPE_IPV6:zlog_debug("\tNexthop%s,type
:%d,ifindex:%d,vrf:%d,label_num:%d",inet_ntop(AF_INET6,&znh->gate.ipv6,buf,sizeo
f(buf)),znh->type,znh->ifindex,znh->vrf_id,znh->label_num);break;caseNEXTHOP_TYP
E_IFINDEX:zlog_debug("\tNexthopIFINDEX:%d,ifindex:%d",znh->type,znh->ifindex);br
eak;caseNEXTHOP_TYPE_BLACKHOLE:zlog_debug("\tNexthopblackhole");break;}}return0;
}externstructzebra_privs_tsharp_privs;voidsharp_zebra_init(void){structzclient_o
ptionsopt={.receive_notify=true};zclient=zclient_new_notify(master,&opt);zclient
_init(zclient,ZEBRA_ROUTE_SHARP,0,&sharp_privs);zclient->zebra_connected=zebra_c
onnected;zclient->interface_add=interface_add;zclient->interface_delete=interfac
e_delete;zclient->interface_up=interface_state_up;zclient->interface_down=interf
ace_state_down;zclient->interface_address_add=interface_address_add;zclient->int
erface_address_delete=interface_address_delete;zclient->route_notify_owner=route
_notify_owner;zclient->nexthop_update=sharp_nexthop_update;}