/**OSPFnetworkrelatedfunctions*Copyright(C)1999ToshiakiTakada**ThisfileispartofG
NUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*undertheterm
softheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversi
on2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillb
euseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include"thread.h"#include"linklist.h"#i
nclude"prefix.h"#include"if.h"#include"sockunion.h"#include"log.h"#include"socko
pt.h"#include"privs.h"#include"ospfd/ospfd.h"#include"ospfd/ospf_network.h"#incl
ude"ospfd/ospf_interface.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"
#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/ospf_pa
cket.h"#include"ospfd/ospf_dump.h"/*JointotheOSPFALLSPFROUTERSmulticastgroup.*/i
ntospf_if_add_allspfrouters(structospf*top,structprefix*p,ifindex_tifindex){intr
et;ret=setsockopt_ipv4_multicast(top->fd,IP_ADD_MEMBERSHIP,p->u.prefix4,htonl(OS
PF_ALLSPFROUTERS),ifindex);if(ret<0)zlog_warn("can'tsetsockoptIP_ADD_MEMBERSHIP(
fd%d,addr%s,""ifindex%u,AllSPFRouters):%s;perhapsakernellimit""on#ofmulticastgro
upmembershipshasbeenexceeded?",top->fd,inet_ntoa(p->u.prefix4),ifindex,safe_stre
rror(errno));else{if(IS_DEBUG_OSPF_EVENT)zlog_debug("interface%s[%u]joinAllSPFRo
utersMulticastgroup.",inet_ntoa(p->u.prefix4),ifindex);}returnret;}intospf_if_dr
op_allspfrouters(structospf*top,structprefix*p,ifindex_tifindex){intret;ret=sets
ockopt_ipv4_multicast(top->fd,IP_DROP_MEMBERSHIP,p->u.prefix4,htonl(OSPF_ALLSPFR
OUTERS),ifindex);if(ret<0)zlog_warn("can'tsetsockoptIP_DROP_MEMBERSHIP(fd%d,addr
%s,""ifindex%u,AllSPFRouters):%s",top->fd,inet_ntoa(p->u.prefix4),ifindex,safe_s
trerror(errno));else{if(IS_DEBUG_OSPF_EVENT)zlog_debug("interface%s[%u]leaveAllS
PFRoutersMulticastgroup.",inet_ntoa(p->u.prefix4),ifindex);}returnret;}/*Jointot
heOSPFALLDesignatedROUTERSmulticastgroup.*/intospf_if_add_alldrouters(structospf
*top,structprefix*p,ifindex_tifindex){intret;ret=setsockopt_ipv4_multicast(top->
fd,IP_ADD_MEMBERSHIP,p->u.prefix4,htonl(OSPF_ALLDROUTERS),ifindex);if(ret<0)zlog
_warn("can'tsetsockoptIP_ADD_MEMBERSHIP(fd%d,addr%s,""ifindex%u,AllDRouters):%s;
perhapsakernellimit""on#ofmulticastgroupmembershipshasbeenexceeded?",top->fd,ine
t_ntoa(p->u.prefix4),ifindex,safe_strerror(errno));elsezlog_debug("interface%s[%
u]joinAllDRoutersMulticastgroup.",inet_ntoa(p->u.prefix4),ifindex);returnret;}in
tospf_if_drop_alldrouters(structospf*top,structprefix*p,ifindex_tifindex){intret
;ret=setsockopt_ipv4_multicast(top->fd,IP_DROP_MEMBERSHIP,p->u.prefix4,htonl(OSP
F_ALLDROUTERS),ifindex);if(ret<0)zlog_warn("can'tsetsockoptIP_DROP_MEMBERSHIP(fd
%d,addr%s,""ifindex%u,AllDRouters):%s",top->fd,inet_ntoa(p->u.prefix4),ifindex,s
afe_strerror(errno));elsezlog_debug("interface%s[%u]leaveAllDRoutersMulticastgro
up.",inet_ntoa(p->u.prefix4),ifindex);returnret;}intospf_if_ipmulticast(structos
pf*top,structprefix*p,ifindex_tifindex){uint8_tval;intret,len;/*Preventreceiving
self-originedmulticastpackets.*/ret=setsockopt_ipv4_multicast_loop(top->fd,0);if
(ret<0)zlog_warn("can'tsetsockoptIP_MULTICAST_LOOP(0)forfd%d:%s",top->fd,safe_st
rerror(errno));/*Explicitlysetmulticastttlto1--endo.*/val=1;len=sizeof(val);ret=
setsockopt(top->fd,IPPROTO_IP,IP_MULTICAST_TTL,(void*)&val,len);if(ret<0)zlog_wa
rn("can'tsetsockoptIP_MULTICAST_TTL(1)forfd%d:%s",top->fd,safe_strerror(errno));
#ifndefGNU_LINUX/*ForGNULINUXospf_writeusesIP_PKTINFO,in_pktinfotosend*packetout
ofifindex.BelowwouldbeusedNonLinuxsystem.*/ret=setsockopt_ipv4_multicast_if(top-
>fd,p->u.prefix4,ifindex);if(ret<0)zlog_warn("can'tsetsockoptIP_MULTICAST_IF(fd%
d,addr%s,""ifindex%u):%s",top->fd,inet_ntoa(p->u.prefix4),ifindex,safe_strerror(
errno));#endifreturnret;}intospf_sock_init(structospf*ospf){intospf_sock;intret,
hincl=1;intbufsize=(8*1024*1024);/*silentlyignore.alreadydone*/if(ospf->fd>0)ret
urn-1;if(ospf->vrf_id==VRF_UNKNOWN){/*silentlyreturnsinceVRFisnotready*/return-1
;}if(ospfd_privs.change(ZPRIVS_RAISE)){zlog_err("ospf_sock_init:couldnotraisepri
vs,%s",safe_strerror(errno));}ospf_sock=vrf_socket(AF_INET,SOCK_RAW,IPPROTO_OSPF
IGP,ospf->vrf_id,ospf->name);if(ospf_sock<0){intsave_errno=errno;if(ospfd_privs.
change(ZPRIVS_LOWER))zlog_err("ospf_sock_init:couldnotlowerprivs,%s",safe_strerr
or(errno));zlog_err("ospf_read_sock_init:socket:%s",safe_strerror(save_errno));e
xit(1);}#ifdefIP_HDRINCL/*wewillincludeIPheaderwithpacket*/ret=setsockopt(ospf_s
ock,IPPROTO_IP,IP_HDRINCL,&hincl,sizeof(hincl));if(ret<0){intsave_errno=errno;zl
og_warn("Can'tsetIP_HDRINCLoptionforfd%d:%s",ospf_sock,safe_strerror(save_errno)
);close(ospf_sock);gotoout;}#elifdefined(IPTOS_PREC_INTERNETCONTROL)#warning"IP_
HDRINCLnotavailableonthissystem"#warning"usingIPTOS_PREC_INTERNETCONTROL"ret=set
sockopt_ipv4_tos(ospf_sock,IPTOS_PREC_INTERNETCONTROL);if(ret<0){intsave_errno=e
rrno;zlog_warn("can'tsetsockoptIP_TOS%dtosocket%d:%s",tos,ospf_sock,safe_strerro
r(save_errno));close(ospf_sock);/*Preventsdleak.*/gotoout;}#else/*!IPTOS_PREC_IN
TERNETCONTROL*/#warning"IP_HDRINCLnotavailable,norisIPTOS_PREC_INTERNETCONTROL"z
log_warn("IP_HDRINCLoptionnotavailable");#endif/*IP_HDRINCL*/ret=setsockopt_ifin
dex(AF_INET,ospf_sock,1);if(ret<0)zlog_warn("Can'tsetpktinfooptionforfd%d",ospf_
sock);setsockopt_so_sendbuf(ospf_sock,bufsize);setsockopt_so_recvbuf(ospf_sock,b
ufsize);ospf->fd=ospf_sock;out:if(ospfd_privs.change(ZPRIVS_LOWER)){zlog_err("os
pf_sock_init:couldnotlowerprivs,%s",safe_strerror(errno));}returnret;}