/**OSPFFlooding--RFC2328Section13.*Copyright(C)1999,2000ToshiakiTakada**Thisfile
ispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itund
erthetermsoftheGNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;ei
therversion2,or(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopeth
atitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANT
ABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetai
ls.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram
;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,Fif
thFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"monotime.h"#include"li
nklist.h"#include"prefix.h"#include"if.h"#include"command.h"#include"table.h"#in
clude"thread.h"#include"memory.h"#include"log.h"#include"zclient.h"#include"ospf
d/ospfd.h"#include"ospfd/ospf_interface.h"#include"ospfd/ospf_ism.h"#include"osp
fd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_lsdb.h"#include"osp
fd/ospf_neighbor.h"#include"ospfd/ospf_nsm.h"#include"ospfd/ospf_spf.h"#include"
ospfd/ospf_flood.h"#include"ospfd/ospf_packet.h"#include"ospfd/ospf_abr.h"#inclu
de"ospfd/ospf_route.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_dump.h"ext
ernstructzclient*zclient;/*DotheLSAackingspecifiedintable19,Section13.5,row2*Thi
sgetcalledfromospf_flood_out_interface.Declaredinline*forspeed.*/staticvoidospf_
flood_delayed_lsa_ack(structospf_neighbor*inbr,structospf_lsa*lsa){/*LSAismorere
centthandatabasecopy,butwasnotfloodedbackoutreceivinginterface.Delayedacknowledg
mentsent.IfinterfaceisinBackupstatedelayedacknowledgmentsentonlyifadvertisementr
eceivedfromDesignatedRouter,otherwisedonothingSeeRFC2328Section13.5*//*WhetherLS
Aismorerecentornot,andwhetherthisisinresponsetotheLSAbeingsentoutrecievinginterf
acehasbeenworkedoutpreviously*//*DealwithrouterasBDR*/if(inbr->oi->state==ISM_Ba
ckup&&!NBR_IS_DR(inbr))return;/*ScheduleadelayedLSAAcktobesent*/listnode_add(inb
r->oi->ls_ack,ospf_lsa_lock(lsa));/*delayedLSAAck*/}/*CheckLSAisrelatedtoexterna
linfo.*/structexternal_info*ospf_external_info_check(structospf*ospf,structospf_
lsa*lsa){structas_external_lsa*al;structprefix_ipv4p;structroute_node*rn;inttype
;al=(structas_external_lsa*)lsa->data;p.family=AF_INET;p.prefix=lsa->data->id;p.
prefixlen=ip_masklen(al->mask);for(type=0;type<=ZEBRA_ROUTE_MAX;type++){intredis
t_on=0;redist_on=is_prefix_default(&p)?vrf_bitmap_check(zclient->default_informa
tion,ospf->vrf_id):(zclient->mi_redist[AFI_IP][type].enabled||vrf_bitmap_check(z
client->redist[AFI_IP][type],ospf->vrf_id));//Pending:checkforMIabove.if(redist_
on){structlist*ext_list;structlistnode*node;structospf_external*ext;ext_list=osp
f->external[type];if(!ext_list)continue;for(ALL_LIST_ELEMENTS_RO(ext_list,node,e
xt)){rn=NULL;if(ext->external_info)rn=route_node_lookup(ext->external_info,(stru
ctprefix*)&p);if(rn){route_unlock_node(rn);if(rn->info!=NULL)return(structextern
al_info*)rn->info;}}}}returnNULL;}staticvoidospf_process_self_originated_lsa(str
uctospf*ospf,structospf_lsa*new,structospf_area*area){structospf_interface*oi;st
ructexternal_info*ei;structlistnode*node;if(IS_DEBUG_OSPF_EVENT)zlog_debug("LSA[
Type%d:%s]:Processself-originatedLSAseq0x%x",new->data->type,inet_ntoa(new->data
->id),ntohl(new->data->ls_seqnum));/*Ifwe'rehere,weinstalledaself-originatedLSAt
hatwereceivedfromaneighbor,i.e.it'smorerecent.Wemustseewhetherwewanttooriginatei
t.Ifyes,weshouldusethisLSA'ssequencenumberandreoriginateanewinstance.ifnot---wem
ustflushthisLSAfromthedomain.*/switch(new->data->type){caseOSPF_ROUTER_LSA:/*Ori
ginateanewinstanceandscheduleflooding*/if(area->router_lsa_self)area->router_lsa
_self->data->ls_seqnum=new->data->ls_seqnum;ospf_router_lsa_update_area(area);re
turn;caseOSPF_NETWORK_LSA:caseOSPF_OPAQUE_LINK_LSA:/*WemustfindtheinterfacetheLS
Acouldbelongto.IftheinterfaceisnomoreabroadcasttypeorwearenomoretheDR,weflushthe
LSAotherwise--createthenewinstanceandscheduleflooding.*//*Lookthroughallinterfac
es,notjustarea,sinceinterfacecouldbemovedfromoneareatoanother.*/for(ALL_LIST_ELE
MENTS_RO(ospf->oiflist,node,oi))/*Thesearesanitycheck.*/if(IPV4_ADDR_SAME(&oi->a
ddress->u.prefix4,&new->data->id)){if(oi->area!=area||oi->type!=OSPF_IFTYPE_BROA
DCAST||!IPV4_ADDR_SAME(&oi->address->u.prefix4,&DR(oi))){ospf_schedule_lsa_flush
_area(area,new);return;}if(new->data->type==OSPF_OPAQUE_LINK_LSA){ospf_opaque_ls
a_refresh(new);return;}if(oi->network_lsa_self)oi->network_lsa_self->data->ls_se
qnum=new->data->ls_seqnum;/*Schedulenetwork-LSAorigination.*/ospf_network_lsa_up
date(oi);return;}break;caseOSPF_SUMMARY_LSA:caseOSPF_ASBR_SUMMARY_LSA:ospf_sched
ule_abr_task(ospf);break;caseOSPF_AS_EXTERNAL_LSA:caseOSPF_AS_NSSA_LSA:if((new->
data->type==OSPF_AS_EXTERNAL_LSA)&&CHECK_FLAG(new->flags,OSPF_LSA_LOCAL_XLT)){os
pf_translated_nssa_refresh(ospf,NULL,new);return;}ei=ospf_external_info_check(os
pf,new);if(ei)ospf_external_lsa_refresh(ospf,new,ei,LSA_REFRESH_FORCE);elseospf_
lsa_flush_as(ospf,new);break;caseOSPF_OPAQUE_AREA_LSA:ospf_opaque_lsa_refresh(ne
w);break;caseOSPF_OPAQUE_AS_LSA:ospf_opaque_lsa_refresh(new);/*Reconsiderationma
yneeded.*//*XXX*/break;default:break;}}/*OSPFLSAflooding--RFC2328Section13.(5).*
//*NowUpdatedforNSSAoperation,asfollows:Type-5'shavenochange.BlockedtoSTUBorNSSA
.Type-7'scanbereceived,andifaDRtheywillalsofloodthelocalNSSAAreaasType-7'sIfaSel
f-OriginatedLSA(nowanASBR),TheLSDBwillbeupdatedasType-5's,(forcontinualre-fresh)
IfanNSSA-IRitisinstalled/floodedasType-7,P-biton.ifanNSSA-ABRitisinstalled/flood
edasType-7,P-bitoff.Later,duringtheABRTASK,iftheABRistheElectedNSSAtranslator,th
enAllType-7s(withP-bitON)areTranslatedtoType-5'sandfloodedtoallnon-NSSA/STUBarea
s.DuringASECalculations,non-ABRscalculateexternalroutesfromType-7'sABRscalculate
externalroutesfromType-5'sandnon-selfType-7s*/intospf_flood(structospf*ospf,stru
ctospf_neighbor*nbr,structospf_lsa*current,structospf_lsa*new){structospf_interf
ace*oi;intlsa_ack_flag;/*Type-7LSA'swillbefloodedthroughouttheirnativeNSSAarea,b
utwillalsobefloodedasType-5'sintoABRcapablelinks.*/if(IS_DEBUG_OSPF_EVENT)zlog_d
ebug("LSA[Flooding]:start,NBR%s(%s),cur(%p),New-LSA[%s]",inet_ntoa(nbr->router_i
d),lookup_msg(ospf_nsm_state_msg,nbr->state,NULL),(void*)current,dump_lsa_key(ne
w));oi=nbr->oi;/*Ifthereisalreadyadatabasecopy,andifthedatabasecopywasreceivedvi
afloodingandinstalledlessthanMinLSArrivalsecondsago,discardthenewLSA(withoutackn
owledgingit).*/if(current!=NULL)/*--endo.*/{if(IS_LSA_SELF(current)&&(ntohs(curr
ent->data->ls_age)==0&&ntohl(current->data->ls_seqnum)==OSPF_INITIAL_SEQUENCE_NU
MBER)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("LSA[Flooding]:Gotaself-originatedLSA,"
"whilelocaloneisinitialinstance.");;/*AcceptthisLSAforquickLSDBresynchronization
.*/}elseif(monotime_since(&current->tv_recv,NULL)<ospf->min_ls_arrival*1000LL){i
f(IS_DEBUG_OSPF_EVENT)zlog_debug("LSA[Flooding]:LSAisreceivedrecently.");return-
1;}}/*FloodthenewLSAoutsomesubsetoftherouter'sinterfaces.Insomecases(e.g.,thesta
teofthereceivinginterfaceisDRandtheLSAwasreceivedfromarouterotherthantheBackupDR
)theLSAwillbefloodedbackoutthereceivinginterface.*/lsa_ack_flag=ospf_flood_throu
gh(ospf,nbr,new);/*Removethecurrentdatabasecopyfromallneighbors'Linkstateretrans
missionlists.AS_EXTERNALandAS_EXTERNAL_OPAQUEdoes^^^^^^^^^^^^^^^^^^^^^^^nothavea
reaID.Allother(evenNSSA's)dohaveareaID.*/if(current){switch(current->data->type)
{caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:ospf_ls_retransmit_delete_nbr_a
s(ospf,current);break;default:ospf_ls_retransmit_delete_nbr_area(nbr->oi->area,c
urrent);break;}}/*Dosomeinternalhousekeepingthatisneededhere*/SET_FLAG(new->flag
s,OSPF_LSA_RECEIVED);ospf_lsa_is_self_originated(ospf,new);/*Letitsettheflag*//*
InstallthenewLSAinthelinkstatedatabase(replacingthecurrentdatabasecopy).Thismayc
ausetheroutingtablecalculationtobescheduled.Inaddition,timestampthenewLSAwiththe
currenttime.ThefloodingprocedurecannotoverwritethenewlyinstalledLSAuntilMinLSArr
ivalsecondshaveelapsed.*/if(!(new=ospf_lsa_install(ospf,nbr->oi,new)))return-1;/
*unknownLSAtypeoranyothererrorcondition*//*AcknowledgethereceiptoftheLSAbysendin
gaLinkStateAcknowledgmentpacketbackoutthereceivinginterface.*/if(lsa_ack_flag)os
pf_flood_delayed_lsa_ack(nbr,new);/*IfthisnewLSAindicatesthatitwasoriginatedbyth
ereceivingrouteritself,theroutermusttakespecialaction,eitherupdatingtheLSAorinso
mecasesflushingitfromtheroutingdomain.*/if(ospf_lsa_is_self_originated(ospf,new)
)ospf_process_self_originated_lsa(ospf,new,oi->area);else/*Updatestatisticsvalue
forOSPF-MIB.*/ospf->rx_lsa_count++;return0;}/*OSPFLSAflooding--RFC2328Section13.
3.*/staticintospf_flood_through_interface(structospf_interface*oi,structospf_nei
ghbor*inbr,structospf_lsa*lsa){structospf_neighbor*onbr;structroute_node*rn;intr
etx_flag;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_flood_through_interface():""con
sideringint%s,INBR(%s),LSA[%s]AGE%u",IF_NAME(oi),inbr?inet_ntoa(inbr->router_id)
:"NULL",dump_lsa_key(lsa),ntohs(lsa->data->ls_age));if(!ospf_if_is_enable(oi))re
turn0;/*RememberifnewLSAisadedtoaretransmitlist.*/retx_flag=0;/*Eachoftheneighbo
rsattachedtothisinterfaceareexamined,todeterminewhethertheymustreceivethenewLSA.
Thefollowingstepsareexecutedforeachneighbor:*/for(rn=route_top(oi->nbrs);rn;rn=r
oute_next(rn)){structospf_lsa*ls_req;if(rn->info==NULL)continue;onbr=rn->info;if
(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_flood_through_interface():consideringnbr%s
(%s)",inet_ntoa(onbr->router_id),lookup_msg(ospf_nsm_state_msg,onbr->state,NULL)
);/*IftheneighborisinalesserstatethanExchange,itdoesnotparticipateinflooding,and
thenextneighborshouldbeexamined.*/if(onbr->state<NSM_Exchange)continue;/*Ifthead
jacencyisnotyetfull(neighborstateisExchangeorLoading),examinetheLinkstaterequest
listassociatedwiththisadjacency.IfthereisaninstanceofthenewLSAonthelist,itindica
testhattheneighboringrouterhasaninstanceoftheLSAalready.ComparethenewLSAtothenei
ghbor'scopy:*/if(onbr->state<NSM_Full){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_f
lood_through_interface():nbradjisnotFull");ls_req=ospf_ls_request_lookup(onbr,ls
a);if(ls_req!=NULL){intret;ret=ospf_lsa_more_recent(ls_req,lsa);/*ThenewLSAisles
srecent.*/if(ret>0)continue;/*Thetwocopiesarethesameinstance,thendeletetheLSAfro
mtheLinkstaterequestlist.*/elseif(ret==0){ospf_ls_request_delete(onbr,ls_req);os
pf_check_nbr_loading(onbr);continue;}/*ThenewLSAismorerecent.DeletetheLSAfromthe
Linkstaterequestlist.*/else{ospf_ls_request_delete(onbr,ls_req);ospf_check_nbr_l
oading(onbr);}}}if(IS_OPAQUE_LSA(lsa->data->type)){if(!CHECK_FLAG(onbr->options,
OSPF_OPTION_O)){if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))zlog_debug("Skipthisneighbor:
NotOpaque-capable.");continue;}}/*IfthenewLSAwasreceivedfromthisneighbor,examine
thenextneighbor.*/#ifdefORIGINAL_CODINGif(inbr)if(IPV4_ADDR_SAME(&inbr->router_i
d,&onbr->router_id))continue;#else/*ORIGINAL_CODING*/if(inbr){/**TriggeredbyLSUp
dmessageparser"ospf_ls_upd()".*E.g.,allLSAshandlinghereisreceivedvianetwork.*/if
(IPV4_ADDR_SAME(&inbr->router_id,&onbr->router_id)){if(IS_DEBUG_OSPF(lsa,LSA_FLO
ODING))zlog_debug("Skipthisneighbor:inbr==onbr");continue;}}else{/**TriggeredbyM
axAgeremover,sofar.*NULL"inbr"meansfloodingstartsfromthisnode.*/if(IPV4_ADDR_SAM
E(&lsa->data->adv_router,&onbr->router_id)){if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))z
log_debug("Skipthisneighbor:lsah->adv_router==onbr");continue;}}#endif/*ORIGINAL
_CODING*//*AddthenewLSAtotheLinkstateretransmissionlistfortheadjacency.TheLSAwil
lberetransmittedatintervalsuntilanacknowledgmentisseenfromtheneighbor.*/ospf_ls_
retransmit_add(onbr,lsa);retx_flag=1;}/*Ifinthepreviousstep,theLSAwasNOTaddedtoa
nyoftheLinkstateretransmissionlists,thereisnoneedtofloodtheLSAouttheinterface.*/
if(retx_flag==0){return(inbr&&inbr->oi==oi);}/*ifwe'vereceivedthelsaonthisinterf
aceweneedtoperformadditionalchecking*/if(inbr&&(inbr->oi==oi)){/*IfthenewLSAwasr
eceivedonthisinterface,anditwasreceivedfromeithertheDesignatedRouterortheBackupD
esignatedRouter,chancesarethatalltheneighborshavereceivedtheLSAalready.*/if(NBR_
IS_DR(inbr)||NBR_IS_BDR(inbr)){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_flood_thro
ugh_interface():""DR/BDRNOTSENDtoint%s",IF_NAME(oi));return1;}/*IfthenewLSAwasre
ceivedonthisinterface,andtheinterfacestateisBackup,examinethenextinterface.TheDe
signatedRouterwilldothefloodingonthisinterface.However,iftheDesignatedRouterfail
stherouterwillendupretransmittingtheupdates.*/if(oi->state==ISM_Backup){if(IS_DE
BUG_OSPF_NSSA)zlog_debug("ospf_flood_through_interface():""ISM_BackupNOTSENDtoin
t%s",IF_NAME(oi));return1;}}/*TheLSAmustbefloodedouttheinterface.SendaLinkStateU
pdatepacket(includingthenewLSAascontents)outtheinterface.TheLSA'sLSagemustbeincr
ementedbyInfTransDelay(whichmustbe>0)whenitiscopiedintotheoutgoingLinkStateUpdat
epacket(untiltheLSagefieldreachesthemaximumvalueofMaxAge).*//*XXXHASSO:IsthisIS_
DEBUG_OSPF_NSSAreallycorrect?*/if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_flood_thro
ugh_interface():""DR/BDRsendingupdtoint%s",IF_NAME(oi));/*RFC2328Section13.3Onno
n-broadcastnetworks,separateLinkStateUpdatepacketsmustbesent,asunicasts,toeachad
jacentneighbor(i.e.,thoseinstateExchangeorgreater).ThedestinationIPaddressesfort
hesepacketsaretheneighbors'IPaddresses.*/if(oi->type==OSPF_IFTYPE_NBMA){structro
ute_node*rn;structospf_neighbor*nbr;for(rn=route_top(oi->nbrs);rn;rn=route_next(
rn))if((nbr=rn->info)!=NULL)if(nbr!=oi->nbr_self&&nbr->state>=NSM_Exchange)ospf_
ls_upd_send_lsa(nbr,lsa,OSPF_SEND_PACKET_DIRECT);}elseospf_ls_upd_send_lsa(oi->n
br_self,lsa,OSPF_SEND_PACKET_INDIRECT);return0;}intospf_flood_through_area(struc
tospf_area*area,structospf_neighbor*inbr,structospf_lsa*lsa){structlistnode*node
,*nnode;structospf_interface*oi;intlsa_ack_flag=0;assert(area);/*Allothertypesar
especifictoasinglearea(AreaA).Theeligibleinterfacesareallthoseinterfacesattachin
gtotheAreaA.IfAreaAisthebackbone,thisincludesallthevirtuallinks.*/for(ALL_LIST_E
LEMENTS(area->oiflist,node,nnode,oi)){if(area->area_id.s_addr!=OSPF_AREA_BACKBON
E&&oi->type==OSPF_IFTYPE_VIRTUALLINK)continue;if((lsa->data->type==OSPF_OPAQUE_L
INK_LSA)&&(lsa->oi!=oi)){/**LinklocalscopedOpaque-LSAshouldonlybeflooded*forthel
inkonwhichtheLSAhasreceived.*/if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))zlog_debug("Typ
e-9Opaque-LSA:lsa->oi(%p)!=oi(%p)",(void*)lsa->oi,(void*)oi);continue;}if(ospf_f
lood_through_interface(oi,inbr,lsa))lsa_ack_flag=1;}return(lsa_ack_flag);}intosp
f_flood_through_as(structospf*ospf,structospf_neighbor*inbr,structospf_lsa*lsa){
structlistnode*node;structospf_area*area;intlsa_ack_flag;lsa_ack_flag=0;/*Theinc
omingLSAistype5ortype7(AS-EXTERNALorAS-NSSA)DiverttheType-5LSA'stoallnon-NSSA/ST
UBareasDiverttheType-7LSA'stoallNSSAareasAS-external-LSAsarefloodedthroughoutthe
entireAS,withtheexceptionofstubareas(seeSection3.6).Theeligibleinterfacesareallt
herouter'sinterfaces,excludingvirtuallinksandthoseinterfacesattachingtostubareas
.*/if(CHECK_FLAG(lsa->flags,OSPF_LSA_LOCAL_XLT))/*Translatedfrom7*/if(IS_DEBUG_O
SPF_NSSA)zlog_debug("Flood/AS:NSSATRANSLATEDLSA");for(ALL_LIST_ELEMENTS_RO(ospf-
>areas,node,area)){intcontinue_flag=0;structlistnode*if_node;structospf_interfac
e*oi;switch(area->external_routing){/*Don'tsendASexternalsintostubareas.Varioust
ypesofsupportforpartialstubareascanbeimplementedhere.NSSA'swillreceiveType-7'sth
athaveareasmatchingtheoriginlLSA.*/caseOSPF_AREA_NSSA:/*SendingType5or7intoNSSAa
rea*//*Type-7,floodNSSAarea*/if(lsa->data->type==OSPF_AS_NSSA_LSA&&area==lsa->ar
ea)/*Wewillsendit.*/continue_flag=0;elsecontinue_flag=1;/*SkipthisNSSAareaforTyp
e-5'setal*/break;caseOSPF_AREA_TYPE_MAX:caseOSPF_AREA_STUB:continue_flag=1;/*Ski
pthisarea.*/break;caseOSPF_AREA_DEFAULT:default:/*NoType-7intonormalarea*/if(lsa
->data->type==OSPF_AS_NSSA_LSA)continue_flag=1;/*skipType-7*/elsecontinue_flag=0
;/*Dothisarea.*/break;}/*Docontinueforaboveswitch.Savesabigifthenmess*/if(contin
ue_flag)continue;/*mainfor-loop*//*sendtoeveryinterfaceinthisarea*/for(ALL_LIST_
ELEMENTS_RO(area->oiflist,if_node,oi)){/*Skipvirtuallinks*/if(oi->type!=OSPF_IFT
YPE_VIRTUALLINK)if(ospf_flood_through_interface(oi,inbr,lsa))/*lsa*/lsa_ack_flag
=1;}}/*mainareafor-loop*/return(lsa_ack_flag);}intospf_flood_through(structospf*
ospf,structospf_neighbor*inbr,structospf_lsa*lsa){intlsa_ack_flag=0;/*Type-7LSA'
sforNSSAarefloodedthroughouttheAShere,anduponreturnareupdatedintheLSDBforType-7'
s.Later,re-freshwillre-sendthem(andalso,ifABR,packetcodewilltranslatetoType-5's)
Asusual,Type-5LSA's(ifnotDISCARDEDbecauseweareSTUBorNSSA)arefloodedthroughoutthe
AS,andareupdatedintheglobaltable.*/#ifdefORIGINAL_CODINGswitch(lsa->data->type){
caseOSPF_ROUTER_LSA:caseOSPF_NETWORK_LSA:caseOSPF_SUMMARY_LSA:caseOSPF_ASBR_SUMM
ARY_LSA:caseOSPF_OPAQUE_LINK_LSA:/*ospf_flood_through_interface?*/caseOSPF_OPAQU
E_AREA_LSA:lsa_ack_flag=ospf_flood_through_area(inbr->oi->area,inbr,lsa);break;c
aseOSPF_AS_EXTERNAL_LSA:/*Type-5*/caseOSPF_OPAQUE_AS_LSA:lsa_ack_flag=ospf_flood
_through_as(ospf,inbr,lsa);break;/*Type-7OnlyreceivedwithinNSSA,thenflooded*/cas
eOSPF_AS_NSSA_LSA:/*AnyP-bitwasinstalledwiththeType-7.*/lsa_ack_flag=ospf_flood_
through_area(inbr->oi->area,inbr,lsa);if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_flo
od_through:LOCALNSSAFLOODofType-7.");break;default:break;}#else/*ORIGINAL_CODING
*//**Atthecommonsub-sub-function"ospf_flood_through_interface()",*aparameter"inb
r"willbeusedtodistinguishthecalledcontext*whetherthegivenLSAwasreceivedfromthene
ighbor,orthe*floodingfortheLSAstartsfromthisnode(e.g.theLSAwasself-*originated,o
rtheLSAisgoingtobeflushedfromroutingdomain).**So,forconsistencyreasons,thisfunct
ion"ospf_flood_through()"*shouldalsoallowtheusagethatthegiven"inbr"parametertobe
*NULL.Ifwedoso,correspondingAREAparametershouldbereferred*by"lsa->area",insteado
f"inbr->oi->area".*/switch(lsa->data->type){caseOSPF_AS_EXTERNAL_LSA:/*Type-5*/c
aseOSPF_OPAQUE_AS_LSA:lsa_ack_flag=ospf_flood_through_as(ospf,inbr,lsa);break;/*
Type-7OnlyreceivedwithinNSSA,thenflooded*/caseOSPF_AS_NSSA_LSA:/*AnyP-bitwasinst
alledwiththeType-7.*/if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_flood_through:LOCALN
SSAFLOODofType-7.");/*Fallthrough*/default:lsa_ack_flag=ospf_flood_through_area(
lsa->area,inbr,lsa);break;}#endif/*ORIGINAL_CODING*/return(lsa_ack_flag);}/*Mana
gementfunctionsforneighbor'sLinkStateRequestlist.*/voidospf_ls_request_add(struc
tospf_neighbor*nbr,structospf_lsa*lsa){/**Wecannotmakeuseofthenewlyintroducedcal
lbackfunction*"lsdb->new_lsa_hook"toreplacedebugoutputbelow,justbecause*itseemsn
osimpleandsmartwaytopassneighborinformationto*thecommonfunction"ospf_lsdb_add()"
--endo.*/if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))zlog_debug("RqstL(%lu)++,NBR(%s),LSA
[%s]",ospf_ls_request_count(nbr),inet_ntoa(nbr->router_id),dump_lsa_key(lsa));os
pf_lsdb_add(&nbr->ls_req,lsa);}unsignedlongospf_ls_request_count(structospf_neig
hbor*nbr){returnospf_lsdb_count_all(&nbr->ls_req);}intospf_ls_request_isempty(st
ructospf_neighbor*nbr){returnospf_lsdb_isempty(&nbr->ls_req);}/*RemoveLSAfromnei
ghbor'sls-requestlist.*/voidospf_ls_request_delete(structospf_neighbor*nbr,struc
tospf_lsa*lsa){if(nbr->ls_req_last==lsa){ospf_lsa_unlock(&nbr->ls_req_last);nbr-
>ls_req_last=NULL;}if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))/*--endo.*/zlog_debug("Rqs
tL(%lu)--,NBR(%s),LSA[%s]",ospf_ls_request_count(nbr),inet_ntoa(nbr->router_id),
dump_lsa_key(lsa));ospf_lsdb_delete(&nbr->ls_req,lsa);}/*RemoveallLSAfromneighbo
r'sls-requenstlist.*/voidospf_ls_request_delete_all(structospf_neighbor*nbr){osp
f_lsa_unlock(&nbr->ls_req_last);nbr->ls_req_last=NULL;ospf_lsdb_delete_all(&nbr-
>ls_req);}/*LookupLSAfromneighbor'sls-requestlist.*/structospf_lsa*ospf_ls_reque
st_lookup(structospf_neighbor*nbr,structospf_lsa*lsa){returnospf_lsdb_lookup(&nb
r->ls_req,lsa);}structospf_lsa*ospf_ls_request_new(structlsa_header*lsah){struct
ospf_lsa*new;new=ospf_lsa_new();new->data=ospf_lsa_data_new(OSPF_LSA_HEADER_SIZE
);memcpy(new->data,lsah,OSPF_LSA_HEADER_SIZE);returnnew;}/*Managementfunctionsfo
rneighbor'sls-retransmitlist.*/unsignedlongospf_ls_retransmit_count(structospf_n
eighbor*nbr){returnospf_lsdb_count_all(&nbr->ls_rxmt);}unsignedlongospf_ls_retra
nsmit_count_self(structospf_neighbor*nbr,intlsa_type){returnospf_lsdb_count_self
(&nbr->ls_rxmt,lsa_type);}intospf_ls_retransmit_isempty(structospf_neighbor*nbr)
{returnospf_lsdb_isempty(&nbr->ls_rxmt);}/*AddLSAtoberetransmittedtoneighbor'sls
-retransmitlist.*/voidospf_ls_retransmit_add(structospf_neighbor*nbr,structospf_
lsa*lsa){structospf_lsa*old;old=ospf_ls_retransmit_lookup(nbr,lsa);if(ospf_lsa_m
ore_recent(old,lsa)<0){if(old){old->retransmit_counter--;ospf_lsdb_delete(&nbr->
ls_rxmt,old);}lsa->retransmit_counter++;/**Wecannotmakeuseofthenewlyintroducedca
llbackfunction*"lsdb->new_lsa_hook"toreplacedebugoutputbelow,just*because*itseem
snosimpleandsmartwaytopassneighborinformation*to*thecommonfunction"ospf_lsdb_add
()"--endo.*/if(IS_DEBUG_OSPF(lsa,LSA_FLOODING))zlog_debug("RXmtL(%lu)++,NBR(%s),
LSA[%s]",ospf_ls_retransmit_count(nbr),inet_ntoa(nbr->router_id),dump_lsa_key(ls
a));ospf_lsdb_add(&nbr->ls_rxmt,lsa);}}/*RemoveLSAfromneibghbor'sls-retransmitli
st.*/voidospf_ls_retransmit_delete(structospf_neighbor*nbr,structospf_lsa*lsa){i
f(ospf_ls_retransmit_lookup(nbr,lsa)){lsa->retransmit_counter--;if(IS_DEBUG_OSPF
(lsa,LSA_FLOODING))/*--endo.*/zlog_debug("RXmtL(%lu)--,NBR(%s),LSA[%s]",ospf_ls_
retransmit_count(nbr),inet_ntoa(nbr->router_id),dump_lsa_key(lsa));ospf_lsdb_del
ete(&nbr->ls_rxmt,lsa);}}/*Clearneighbor'sls-retransmitlist.*/voidospf_ls_retran
smit_clear(structospf_neighbor*nbr){structospf_lsdb*lsdb;inti;lsdb=&nbr->ls_rxmt
;for(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++){structroute_table*table=lsdb->type[i].db
;structroute_node*rn;structospf_lsa*lsa;for(rn=route_top(table);rn;rn=route_next
(rn))if((lsa=rn->info)!=NULL)ospf_ls_retransmit_delete(nbr,lsa);}ospf_lsa_unlock
(&nbr->ls_req_last);nbr->ls_req_last=NULL;}/*LookupLSAfromneighbor'sls-retransmi
tlist.*/structospf_lsa*ospf_ls_retransmit_lookup(structospf_neighbor*nbr,structo
spf_lsa*lsa){returnospf_lsdb_lookup(&nbr->ls_rxmt,lsa);}staticvoidospf_ls_retran
smit_delete_nbr_if(structospf_interface*oi,structospf_lsa*lsa){structroute_node*
rn;structospf_neighbor*nbr;structospf_lsa*lsr;if(ospf_if_is_enable(oi))for(rn=ro
ute_top(oi->nbrs);rn;rn=route_next(rn))/*IfLSAfindinLS-retransmitlist,thenremove
it.*/if((nbr=rn->info)!=NULL){lsr=ospf_ls_retransmit_lookup(nbr,lsa);/*IfLSAfind
inls-retransmitlist,removeit.*/if(lsr!=NULL&&lsr->data->ls_seqnum==lsa->data->ls
_seqnum)ospf_ls_retransmit_delete(nbr,lsr);}}voidospf_ls_retransmit_delete_nbr_a
rea(structospf_area*area,structospf_lsa*lsa){structlistnode*node,*nnode;structos
pf_interface*oi;for(ALL_LIST_ELEMENTS(area->oiflist,node,nnode,oi))ospf_ls_retra
nsmit_delete_nbr_if(oi,lsa);}voidospf_ls_retransmit_delete_nbr_as(structospf*osp
f,structospf_lsa*lsa){structlistnode*node,*nnode;structospf_interface*oi;for(ALL
_LIST_ELEMENTS(ospf->oiflist,node,nnode,oi))ospf_ls_retransmit_delete_nbr_if(oi,
lsa);}/*Setsls_agetoMaxAgeandfloodsthrouthearea.WhenweimplementASErouting,therew
illbeanothefunctionflushinganLSAfromthewholedomain.*/voidospf_lsa_flush_area(str
uctospf_lsa*lsa,structospf_area*area){/*Resetthelsaoriginationtimesuchthatitgive
smoretimefortheACKtobereceivedandavoidretransmissions*/lsa->data->ls_age=htons(O
SPF_LSA_MAXAGE);if(IS_DEBUG_OSPF_EVENT)zlog_debug("%s:MAXAGEsettoLSA%s",__PRETTY
_FUNCTION__,inet_ntoa(lsa->data->id));monotime(&lsa->tv_recv);lsa->tv_orig=lsa->
tv_recv;ospf_flood_through_area(area,NULL,lsa);ospf_lsa_maxage(area->ospf,lsa);}
voidospf_lsa_flush_as(structospf*ospf,structospf_lsa*lsa){/*Resetthelsaoriginati
ontimesuchthatitgivesmoretimefortheACKtobereceivedandavoidretransmissions*/lsa->
data->ls_age=htons(OSPF_LSA_MAXAGE);monotime(&lsa->tv_recv);lsa->tv_orig=lsa->tv
_recv;ospf_flood_through_as(ospf,NULL,lsa);ospf_lsa_maxage(ospf,lsa);}voidospf_l
sa_flush(structospf*ospf,structospf_lsa*lsa){lsa->data->ls_age=htons(OSPF_LSA_MA
XAGE);switch(lsa->data->type){caseOSPF_ROUTER_LSA:caseOSPF_NETWORK_LSA:caseOSPF_
SUMMARY_LSA:caseOSPF_ASBR_SUMMARY_LSA:caseOSPF_AS_NSSA_LSA:caseOSPF_OPAQUE_LINK_
LSA:caseOSPF_OPAQUE_AREA_LSA:ospf_lsa_flush_area(lsa,lsa->area);break;caseOSPF_A
S_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:ospf_lsa_flush_as(ospf,lsa);break;default:
zlog_info("%s:UnknownLSAtype%u",__func__,lsa->data->type);break;}}