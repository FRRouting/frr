/**OSPFASexternalroutecalculation.*Copyright(C)1999,2000AlexZinin,ToshiakiTakada
**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormo
difyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFou
ndation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedi
nthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyo
f*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicensefo
rmoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*witht
hisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Fran
klinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"thread.h"#in
clude"memory.h"#include"hash.h"#include"linklist.h"#include"prefix.h"#include"if
.h"#include"table.h"#include"vty.h"#include"log.h"#include"ospfd/ospfd.h"#includ
e"ospfd/ospf_interface.h"#include"ospfd/ospf_ism.h"#include"ospfd/ospf_asbr.h"#i
nclude"ospfd/ospf_lsa.h"#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neighbor.
h"#include"ospfd/ospf_nsm.h"#include"ospfd/ospf_spf.h"#include"ospfd/ospf_route.
h"#include"ospfd/ospf_ase.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_dump
.h"structospf_route*ospf_find_asbr_route(structospf*ospf,structroute_table*rtrs,
structprefix_ipv4*asbr){structroute_node*rn;structospf_route*or,*best=NULL;struc
tlistnode*node;structlist*chosen;/*Sanitycheck.*/if(rtrs==NULL)returnNULL;rn=rou
te_node_lookup(rtrs,(structprefix*)asbr);if(!rn)returnNULL;route_unlock_node(rn)
;chosen=list_new();/*Firsttrytofindintra-areanon-bbpaths.*/if(!CHECK_FLAG(ospf->
config,OSPF_RFC1583_COMPATIBLE))for(ALL_LIST_ELEMENTS_RO((structlist*)rn->info,n
ode,or))if(or->cost<OSPF_LS_INFINITY)if(!OSPF_IS_AREA_ID_BACKBONE(or->u.std.area
_id)&&or->path_type==OSPF_PATH_INTRA_AREA)listnode_add(chosen,or);/*Ifnoneisfoun
d--lookthroughall.*/if(listcount(chosen)==0){list_delete_and_null(&chosen);chose
n=rn->info;}/*Nowfindtheroutewithleastcost.*/for(ALL_LIST_ELEMENTS_RO(chosen,nod
e,or))if(or->cost<OSPF_LS_INFINITY){if(best==NULL)best=or;elseif(best->cost>or->
cost)best=or;elseif(best->cost==or->cost&&IPV4_ADDR_CMP(&best->u.std.area_id,&or
->u.std.area_id)<0)best=or;}if(chosen!=rn->info)list_delete_and_null(&chosen);re
turnbest;}structospf_route*ospf_find_asbr_route_through_area(structroute_table*r
trs,structprefix_ipv4*asbr,structospf_area*area){structroute_node*rn;/*Sanityche
ck.*/if(rtrs==NULL)returnNULL;rn=route_node_lookup(rtrs,(structprefix*)asbr);if(
rn){structlistnode*node;structospf_route*or;route_unlock_node(rn);for(ALL_LIST_E
LEMENTS_RO((structlist*)rn->info,node,or))if(IPV4_ADDR_SAME(&or->u.std.area_id,&
area->area_id))returnor;}returnNULL;}staticvoidospf_ase_complete_direct_routes(s
tructospf_route*ro,structin_addrnexthop){structlistnode*node;structospf_path*op;
for(ALL_LIST_ELEMENTS_RO(ro->paths,node,op))if(op->nexthop.s_addr==0)op->nexthop
.s_addr=nexthop.s_addr;}staticintospf_ase_forward_address_check(structospf*ospf,
structin_addrfwd_addr){structlistnode*ifn;structospf_interface*oi;for(ALL_LIST_E
LEMENTS_RO(ospf->oiflist,ifn,oi))if(if_is_operative(oi->ifp))if(oi->type!=OSPF_I
FTYPE_VIRTUALLINK)if(IPV4_ADDR_SAME(&oi->address->u.prefix4,&fwd_addr))return0;r
eturn1;}#if0/*CalculateASBRroute.*/staticstructospf_route*ospf_ase_calculate_asb
r_route(structospf*ospf,structroute_table*rt_network,structroute_table*rt_router
,structas_external_lsa*al){structprefix_ipv4asbr;structospf_route*asbr_route;str
uctroute_node*rn;/*FindASBRroutefromRouterroutingtable.*/asbr.family=AF_INET;asb
r.prefix=al->header.adv_router;asbr.prefixlen=IPV4_MAX_BITLEN;apply_mask_ipv4(&a
sbr);asbr_route=ospf_find_asbr_route(ospf,rt_router,&asbr);if(asbr_route==NULL){
if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("ospf_ase_calculate():RoutetoASBR%snotfound
",inet_ntoa(asbr.prefix));returnNULL;}if(!(asbr_route->u.std.flags&ROUTER_LSA_EX
TERNAL)){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("ospf_ase_calculate():Originatingr
outerisnotanASBR");returnNULL;}if(al->e[0].fwd_addr.s_addr!=0){if(IS_DEBUG_OSPF(
lsa,LSA))zlog_debug("ospf_ase_calculate():""Forwardingaddressisnot0.0.0.0.");if(
!ospf_ase_forward_address_check(ospf,al->e[0].fwd_addr)){if(IS_DEBUG_OSPF(lsa,LS
A))zlog_debug("ospf_ase_calculate():""Forwardingaddressisoneofouraddresses,Ignor
e.");returnNULL;}if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("ospf_ase_calculate():""Lo
okingupintheNetworkRoutingTable.");/*Lookingupthepathtothefwd_addrfromNetworkrou
te.*/asbr.family=AF_INET;asbr.prefix=al->e[0].fwd_addr;asbr.prefixlen=IPV4_MAX_B
ITLEN;rn=route_node_match(rt_network,(structprefix*)&asbr);if(rn==NULL){if(IS_DE
BUG_OSPF(lsa,LSA))zlog_debug("ospf_ase_calculate():""Couldn'tfindaroutetotheforw
ardingaddress.");returnNULL;}route_unlock_node(rn);if((asbr_route=rn->info)==NUL
L){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("ospf_ase_calculate():""SomehowOSPFroute
toASBRislost");returnNULL;}}returnasbr_route;}#endifstaticstructospf_route*ospf_
ase_calculate_new_route(structospf_lsa*lsa,structospf_route*asbr_route,uint32_tm
etric){structas_external_lsa*al;structospf_route*new;al=(structas_external_lsa*)
lsa->data;new=ospf_route_new();/*Setredistributedtype--doesmakesense?*//*new->ty
pe=type;*/new->id=al->header.id;new->mask=al->mask;if(!IS_EXTERNAL_METRIC(al->e[
0].tos)){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[External]:type-1created.");
new->path_type=OSPF_PATH_TYPE1_EXTERNAL;new->cost=asbr_route->cost+metric;/*X+Y*
/}else{if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[External]:type-2created.");ne
w->path_type=OSPF_PATH_TYPE2_EXTERNAL;new->cost=asbr_route->cost;/*X*/new->u.ext
.type2_cost=metric;/*Y*/}new->type=OSPF_DESTINATION_NETWORK;new->u.ext.origin=ls
a;new->u.ext.tag=ntohl(al->e[0].route_tag);new->u.ext.asbr=asbr_route;assert(new
!=asbr_route);returnnew;}#defineOSPF_ASE_CALC_INTERVAL1intospf_ase_calculate_rou
te(structospf*ospf,structospf_lsa*lsa){uint32_tmetric;structas_external_lsa*al;s
tructospf_route*asbr_route;structprefix_ipv4asbr,p;structroute_node*rn;structosp
f_route*new,*or;intret;assert(lsa);al=(structas_external_lsa*)lsa->data;if(lsa->
data->type==OSPF_AS_NSSA_LSA)if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_ase_calc():P
rocessingType-7");/*StayawayfromanyLocalTranslatedType-7LSAs*/if(CHECK_FLAG(lsa-
>flags,OSPF_LSA_LOCAL_XLT)){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_ase_calc():Re
jectingLocalXlt'd");return0;}if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[Externa
l]:CalculateAS-external-LSAto%s/%d",inet_ntoa(al->header.id),ip_masklen(al->mask
));/*(1)IfthecostspecifiedbytheLSAisLSInfinity,oriftheLSA'sLSageisequaltoMaxAge,
thenexaminethenextLSA.*/if((metric=GET_METRIC(al->e[0].metric))>=OSPF_LS_INFINIT
Y){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[External]:MetricisOSPF_LS_INFINIT
Y");return0;}if(IS_LSA_MAXAGE(lsa)){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[
External]:AS-external-LSAisMAXAGE");return0;}/*(2)IftheLSAwasoriginatedbythecalc
ulatingrouteritself,examinethenextLSA.*/if(IS_LSA_SELF(lsa)){if(IS_DEBUG_OSPF(ls
a,LSA))zlog_debug("Route[External]:AS-external-LSAisselforiginated");return0;}/*
(3)CallthedestinationdescribedbytheLSAN.N'saddressisobtainedbymaskingtheLSA'sLin
kStateIDwiththenetwork/subnetmaskcontainedinthebodyoftheLSA.Lookuptheroutingtabl
eentries(potentiallyoneperattachedarea)fortheASboundaryrouter(ASBR)thatoriginate
dtheLSA.IfnoentriesexistforrouterASBR(i.e.,ASBRisunreachable),donothingwiththisL
SAandconsiderthenextinthelist.*/asbr.family=AF_INET;asbr.prefix=al->header.adv_r
outer;asbr.prefixlen=IPV4_MAX_BITLEN;apply_mask_ipv4(&asbr);asbr_route=ospf_find
_asbr_route(ospf,ospf->new_rtrs,&asbr);if(asbr_route==NULL){if(IS_DEBUG_OSPF(lsa
,LSA))zlog_debug("Route[External]:Can'tfindoriginatingASBRroute");return0;}if(!(
asbr_route->u.std.flags&ROUTER_LSA_EXTERNAL)){if(IS_DEBUG_OSPF(lsa,LSA))zlog_deb
ug("Route[External]:OriginatingrouterisnotanASBR");return0;}/*Else,thisLSAdescri
besanASexternalpathtodestinationN.ExaminetheforwardingaddressspecifiedintheAS-ex
ternal-LSA.ThisindicatestheIPaddresstowhichpacketsforthedestinationshouldbeforwa
rded.*/if(al->e[0].fwd_addr.s_addr==0){/*Iftheforwardingaddressissetto0.0.0.0,pa
cketsshouldbesenttotheASBRitself.AmongthemultipleroutingtableentriesfortheASBR,s
electthepreferredentryasfollows.IfRFC1583Compatibilityissetto"disabled",prunethe
setofroutingtableentriesfortheASBRasdescribedinSection16.4.1.Inanycase,amongther
emainingroutingtableentries,selecttheroutingtableentrywiththeleastcost;whenthere
aremultipleleastcostroutingtableentriestheentrywhoseassociatedareahasthelargestO
SPFAreaID(whenconsideredasanunsigned32-bitinteger)ischosen.*//*asbr_routealready
containstherequestedroute*/}else{/*Iftheforwardingaddressisnon-zero,lookupthefor
wardingaddressintheroutingtable.[24]Thematchingroutingtableentrymustspecifyanint
ra-areaorinter-areapath;ifnosuchpathexists,donothingwiththeLSAandconsiderthenext
inthelist.*/if(!ospf_ase_forward_address_check(ospf,al->e[0].fwd_addr)){if(IS_DE
BUG_OSPF(lsa,LSA))zlog_debug("Route[External]:Forwardingaddressisourrouter""addr
ess");return0;}asbr.family=AF_INET;asbr.prefix=al->e[0].fwd_addr;asbr.prefixlen=
IPV4_MAX_BITLEN;rn=route_node_match(ospf->new_table,(structprefix*)&asbr);if(rn=
=NULL||(asbr_route=rn->info)==NULL){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[
External]:Can'tfindroutetoforwarding""address");if(rn)route_unlock_node(rn);retu
rn0;}route_unlock_node(rn);}/*(4)LetXbethecostspecifiedbythepreferredroutingtabl
eentryfortheASBR/forwardingaddress,andYthecostspecifiedintheLSA.Xisintermsofthel
inkstatemetric,andYisatype1or2externalmetric.*//*(5)Lookuptheroutingtableentryfo
rthedestinationN.IfnoentryexistsforN,installtheASexternalpathtoN,withnexthopequa
ltothelistofnexthopstotheforwardingaddress,andadvertisingrouterequaltoASBR.Ifthe
externalmetrictypeis1,thenthepath-typeissettotype1externalandthecostisequaltoX+Y
.Iftheexternalmetrictypeis2,thepath-typeissettotype2external,thelinkstatecompone
ntoftheroute'scostisX,andthetype2costisY.*/new=ospf_ase_calculate_new_route(lsa,
asbr_route,metric);/*(6)ComparetheASexternalpathdescribedbytheLSAwiththeexisting
pathsinN'sroutingtableentry,asfollows.Ifthenewpathispreferred,itreplacestheprese
ntpathsinN'sroutingtableentry.Ifthenewpathisofequalpreference,itisaddedtoN'srout
ingtableentry'slistofpaths.*//*Setprefix.*/p.family=AF_INET;p.prefix=al->header.
id;p.prefixlen=ip_masklen(al->mask);/*ifthereisaIntra/InterarearoutetotheNdonoti
nstallexternalroute*/if((rn=route_node_lookup(ospf->new_table,(structprefix*)&p)
)){route_unlock_node(rn);if(rn->info==NULL)zlog_info("Route[External]:rn->infoNU
LL");if(new)ospf_route_free(new);return0;}/*Findaroutetothesamedest*//*Ifthereis
noroute,createnewone.*/if((rn=route_node_lookup(ospf->new_external_route,(struct
prefix*)&p)))route_unlock_node(rn);if(!rn||(or=rn->info)==NULL){if(IS_DEBUG_OSPF
(lsa,LSA))zlog_debug("Route[External]:Addinganewroute%s/%d",inet_ntoa(p.prefix),
p.prefixlen);ospf_route_add(ospf->new_external_route,&p,new,asbr_route);if(al->e
[0].fwd_addr.s_addr)ospf_ase_complete_direct_routes(new,al->e[0].fwd_addr);retur
n0;}else{/*(a)Intra-areaandinter-areapathsarealwayspreferredoverASexternalpaths.
(b)Type1externalpathsarealwayspreferredovertype2externalpaths.Whenallpathsaretyp
e2externalpaths,thepathswiththesmallestadvertisedtype2metricarealwayspreferred.*
/ret=ospf_route_cmp(ospf,new,or);/*(c)IfthenewASexternalpathisstillindistinguish
ablefromthecurrentpathsintheN'sroutingtableentry,andRFC1583Compatibilityissetto"
disabled",selectthepreferredpathsbasedontheintra-ASpathstotheASBR/forwardingaddr
esses,asspecifiedinSection16.4.1.(d)IfthenewASexternalpathisstillindistinguishab
lefromthecurrentpathsintheN'sroutingtableentry,selectthepreferredpathbasedonalea
stcostcomparison.Type1externalpathsarecomparedbylookingatthesumofthedistancetoth
eforwardingaddressandtheadvertisedtype1metric(X+Y).Type2externalpathsadvertising
equaltype2metricsarecomparedbylookingatthedistancetotheforwardingaddresses.*//*N
ewrouteisbetter*/if(ret<0){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[External]
:Newrouteisbetter");ospf_route_subst(rn,new,asbr_route);if(al->e[0].fwd_addr.s_a
ddr)ospf_ase_complete_direct_routes(new,al->e[0].fwd_addr);or=new;new=NULL;}/*Ol
drouteisbetter*/elseif(ret>0){if(IS_DEBUG_OSPF(lsa,LSA))zlog_debug("Route[Extern
al]:Oldrouteisbetter");/*donothing*/}/*Routesareequal*/else{if(IS_DEBUG_OSPF(lsa
,LSA))zlog_debug("Route[External]:Routesareequal");ospf_route_copy_nexthops(or,a
sbr_route->paths);if(al->e[0].fwd_addr.s_addr)ospf_ase_complete_direct_routes(or
,al->e[0].fwd_addr);}}/*MakesuresettingnewlycalculatedASBRroute.*/or->u.ext.asbr
=asbr_route;if(new)ospf_route_free(new);lsa->route=or;return0;}staticintospf_ase
_route_match_same(structroute_table*rt,structprefix*prefix,structospf_route*newo
r){structroute_node*rn;structospf_route*or;structospf_path*op;structospf_path*ne
wop;structlistnode*n1;structlistnode*n2;if(!rt||!prefix)return0;rn=route_node_lo
okup(rt,prefix);if(!rn)return0;route_unlock_node(rn);or=rn->info;if(or->path_typ
e!=newor->path_type)return0;switch(or->path_type){caseOSPF_PATH_TYPE1_EXTERNAL:i
f(or->cost!=newor->cost)return0;break;caseOSPF_PATH_TYPE2_EXTERNAL:if((or->cost!
=newor->cost)||(or->u.ext.type2_cost!=newor->u.ext.type2_cost))return0;break;def
ault:assert(0);return0;}if(or->paths->count!=newor->paths->count)return0;/*Check
eachpath.*/for(n1=listhead(or->paths),n2=listhead(newor->paths);n1&&n2;n1=listne
xtnode(n1),n2=listnextnode(n2)){op=listgetdata(n1);newop=listgetdata(n2);if(!IPV
4_ADDR_SAME(&op->nexthop,&newop->nexthop))return0;if(op->ifindex!=newop->ifindex
)return0;}if(or->u.ext.tag!=newor->u.ext.tag)return0;return1;}staticintospf_ase_
compare_tables(structospf*ospf,structroute_table*new_external_route,structroute_
table*old_external_route){structroute_node*rn,*new_rn;structospf_route*or;/*Remo
vedeletedroutes*/for(rn=route_top(old_external_route);rn;rn=route_next(rn))if((o
r=rn->info)){if(!(new_rn=route_node_lookup(new_external_route,&rn->p)))ospf_zebr
a_delete(ospf,(structprefix_ipv4*)&rn->p,or);elseroute_unlock_node(new_rn);}/*In
stallnewroutes*/for(rn=route_top(new_external_route);rn;rn=route_next(rn))if((or
=rn->info)!=NULL)if(!ospf_ase_route_match_same(old_external_route,&rn->p,or))osp
f_zebra_add(ospf,(structprefix_ipv4*)&rn->p,or);return0;}staticintospf_ase_calcu
late_timer(structthread*t){structospf*ospf;structospf_lsa*lsa;structroute_node*r
n;structlistnode*node;structospf_area*area;structtimevalstart_time,stop_time;osp
f=THREAD_ARG(t);ospf->t_ase_calc=NULL;if(ospf->ase_calc){ospf->ase_calc=0;monoti
me(&start_time);/*CalculateexternalrouteforeachAS-external-LSA*/LSDB_LOOP(EXTERN
AL_LSDB(ospf),rn,lsa)ospf_ase_calculate_route(ospf,lsa);/*Thisversionsimpleaddst
othetableallNSSAareas*/if(ospf->anyNSSA)for(ALL_LIST_ELEMENTS_RO(ospf->areas,nod
e,area)){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_ase_calculate_timer():lookingata
rea%s",inet_ntoa(area->area_id));if(area->external_routing==OSPF_AREA_NSSA)LSDB_
LOOP(NSSA_LSDB(area),rn,lsa)ospf_ase_calculate_route(ospf,lsa);}/*kevinm:Andaddt
heNSSAroutesinospf_top*/LSDB_LOOP(NSSA_LSDB(ospf),rn,lsa)ospf_ase_calculate_rout
e(ospf,lsa);/*Compareoldandnewexternalroutingtableandinstallthedifferenceinfozeb
ra/kernel*/ospf_ase_compare_tables(ospf,ospf->new_external_route,ospf->old_exter
nal_route);/*Deleteoldexternalroutingtable*/ospf_route_table_free(ospf->old_exte
rnal_route);ospf->old_external_route=ospf->new_external_route;ospf->new_external
_route=route_table_init();monotime(&stop_time);if(IS_DEBUG_OSPF_EVENT)zlog_info(
"SPFProcessingTime(usecs):ExternalRoutes:%lld\n",(stop_time.tv_sec-start_time.tv
_sec)*1000000LL+(stop_time.tv_usec-start_time.tv_usec));}return0;}voidospf_ase_c
alculate_schedule(structospf*ospf){if(ospf==NULL)return;ospf->ase_calc=1;}voidos
pf_ase_calculate_timer_add(structospf*ospf){if(ospf==NULL)return;thread_add_time
r(master,ospf_ase_calculate_timer,ospf,OSPF_ASE_CALC_INTERVAL,&ospf->t_ase_calc)
;}voidospf_ase_register_external_lsa(structospf_lsa*lsa,structospf*top){structro
ute_node*rn;structprefix_ipv4p;structlist*lst;structas_external_lsa*al;al=(struc
tas_external_lsa*)lsa->data;p.family=AF_INET;p.prefix=lsa->data->id;p.prefixlen=
ip_masklen(al->mask);apply_mask_ipv4(&p);rn=route_node_get(top->external_lsas,(s
tructprefix*)&p);if((lst=rn->info)==NULL)rn->info=lst=list_new();elseroute_unloc
k_node(rn);/*WeassumethatifLSAisdeletedfromDBisisalsodeletedfromthisRT*/listnode
_add(lst,ospf_lsa_lock(lsa));/*external_lsaslst*/}voidospf_ase_unregister_extern
al_lsa(structospf_lsa*lsa,structospf*top){structroute_node*rn;structprefix_ipv4p
;structlist*lst;structas_external_lsa*al;al=(structas_external_lsa*)lsa->data;p.
family=AF_INET;p.prefix=lsa->data->id;p.prefixlen=ip_masklen(al->mask);apply_mas
k_ipv4(&p);rn=route_node_lookup(top->external_lsas,(structprefix*)&p);if(rn){lst
=rn->info;listnode_delete(lst,lsa);ospf_lsa_unlock(&lsa);/*external_lsaslist*/ro
ute_unlock_node(rn);}}voidospf_ase_external_lsas_finish(structroute_table*rt){st
ructroute_node*rn;structospf_lsa*lsa;structlist*lst;structlistnode*node,*nnode;f
or(rn=route_top(rt);rn;rn=route_next(rn))if((lst=rn->info)!=NULL){for(ALL_LIST_E
LEMENTS(lst,node,nnode,lsa))ospf_lsa_unlock(&lsa);/*external_lsaslst*/list_delet
e_and_null(&lst);}route_table_finish(rt);}voidospf_ase_incremental_update(struct
ospf*ospf,structospf_lsa*lsa){structlist*lsas;structlistnode*node;structroute_no
de*rn,*rn2;structprefix_ipv4p;structroute_table*tmp_old;structas_external_lsa*al
;al=(structas_external_lsa*)lsa->data;p.family=AF_INET;p.prefix=lsa->data->id;p.
prefixlen=ip_masklen(al->mask);apply_mask_ipv4(&p);/*ifnew_tableisNULL,therewasn
ospfcalculation,thusincrementalupdateisunneeded*/if(!ospf->new_table)return;/*If
thereisalreadyanintra-areaorinter-arearoutetothedestination,norecalculationisnec
essary(internalroutestakeprecedence).*/rn=route_node_lookup(ospf->new_table,(str
uctprefix*)&p);if(rn){route_unlock_node(rn);if(rn->info)return;}rn=route_node_lo
okup(ospf->external_lsas,(structprefix*)&p);assert(rn);assert(rn->info);lsas=rn-
>info;route_unlock_node(rn);for(ALL_LIST_ELEMENTS_RO(lsas,node,lsa))ospf_ase_cal
culate_route(ospf,lsa);/*preparetemporaryoldroutingtableforcompare*/tmp_old=rout
e_table_init();rn=route_node_lookup(ospf->old_external_route,(structprefix*)&p);
if(rn&&rn->info){rn2=route_node_get(tmp_old,(structprefix*)&p);rn2->info=rn->inf
o;route_unlock_node(rn);}/*installchangestozebra*/ospf_ase_compare_tables(ospf,o
spf->new_external_route,tmp_old);/*updateospf->old_external_routetable*/if(rn&&r
n->info)ospf_route_free((structospf_route*)rn->info);rn2=route_node_lookup(ospf-
>new_external_route,(structprefix*)&p);/*ifnewrouteexists,installittoospf->old_e
xternal_route*/if(rn2&&rn2->info){if(!rn)rn=route_node_get(ospf->old_external_ro
ute,(structprefix*)&p);rn->info=rn2->info;}else{/*removeroutenodefromospf->old_e
xternal_route*/if(rn){rn->info=NULL;route_unlock_node(rn);}}if(rn2){/*rn2->infoi
sstoredinroutenodeofospf->old_external_route*/rn2->info=NULL;route_unlock_node(r
n2);route_unlock_node(rn2);}route_table_finish(tmp_old);}