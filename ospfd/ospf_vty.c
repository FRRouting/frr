/*OSPFVTYinterface.*Copyright(C)20056WIND<alain.ritoux@6wind.com>*Copyright(C)20
00ToshiakiTakada**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredist
ributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe
*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZeb
raisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventhe
impliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*Genera
lPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLi
censealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Founda
tion,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#incl
ude<string.h>#include"monotime.h"#include"memory.h"#include"thread.h"#include"pr
efix.h"#include"table.h"#include"vty.h"#include"command.h"#include"plist.h"#incl
ude"log.h"#include"zclient.h"#include<lib/json.h>#include"defaults.h"#include"os
pfd/ospfd.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/
ospf_lsdb.h"#include"ospfd/ospf_ism.h"#include"ospfd/ospf_interface.h"#include"o
spfd/ospf_nsm.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/ospf_flood.h"#incl
ude"ospfd/ospf_abr.h"#include"ospfd/ospf_spf.h"#include"ospfd/ospf_route.h"#incl
ude"ospfd/ospf_zebra.h"/*#include"ospfd/ospf_routemap.h"*/#include"ospfd/ospf_vt
y.h"#include"ospfd/ospf_dump.h"#include"ospfd/ospf_bfd.h"staticconstchar*ospf_ne
twork_type_str[]={"Null","POINTOPOINT","BROADCAST","NBMA","POINTOMULTIPOINT","VI
RTUALLINK","LOOPBACK"};/*Utilityfunctions.*/intstr2area_id(constchar*str,structi
n_addr*area_id,int*area_id_fmt){char*ep;area_id->s_addr=htonl(strtoul(str,&ep,10
));if(*ep&&!inet_aton(str,area_id))return-1;*area_id_fmt=*ep?OSPF_AREA_ID_FMT_DO
TTEDQUAD:OSPF_AREA_ID_FMT_DECIMAL;return0;}voidarea_id2str(char*buf,intlength,st
ructin_addr*area_id,intarea_id_fmt){memset(buf,0,length);if(area_id_fmt==OSPF_AR
EA_ID_FMT_DOTTEDQUAD)strncpy(buf,inet_ntoa(*area_id),length);elsesprintf(buf,"%l
u",(unsignedlong)ntohl(area_id->s_addr));}staticintstr2metric(constchar*str,int*
metric){/*Sanitycheck.*/if(str==NULL)return0;*metric=strtol(str,NULL,10);if(*met
ric<0&&*metric>16777214){/*vty_out(vty,"OSPFmetricvalueisinvalid\n");*/return0;}
return1;}staticintstr2metric_type(constchar*str,int*metric_type){/*Sanitycheck.*
/if(str==NULL)return0;if(strncmp(str,"1",1)==0)*metric_type=EXTERNAL_METRIC_TYPE
_1;elseif(strncmp(str,"2",1)==0)*metric_type=EXTERNAL_METRIC_TYPE_2;elsereturn0;
return1;}intospf_oi_count(structinterface*ifp){structroute_node*rn;inti=0;for(rn
=route_top(IF_OIFS(ifp));rn;rn=route_next(rn))if(rn->info)i++;returni;}#defineOS
PF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf)\if(argv_find(argv,argc,"vrf
",&idx_vrf)){\vrf_name=argv[idx_vrf+1]->arg;\all_vrf=strmatch(vrf_name,"all");\}
staticstructospf*ospf_cmd_lookup_ospf(structvty*vty,structcmd_token*argv[],const
intargc,uint32_tenable,unsignedshort*instance){structospf*ospf=NULL;intidx_vrf=0
,idx_inst=0;constchar*vrf_name=NULL;*instance=0;if(argv_find(argv,argc,"(1-65535
)",&idx_inst))*instance=strtoul(argv[idx_inst]->arg,NULL,10);if(argv_find(argv,a
rgc,"vrf",&idx_vrf)){vrf_name=argv[idx_vrf+1]->arg;if(enable){/*AllocateVRFaware
instance*/ospf=ospf_get(*instance,vrf_name);}else{ospf=ospf_lookup_by_inst_name(
*instance,vrf_name);}}else{if(enable){ospf=ospf_get(*instance,NULL);}else{ospf=o
spf_lookup_instance(*instance);}}returnospf;}staticvoidospf_show_vrf_name(struct
ospf*ospf,structvty*vty,json_object*json,uint8_tuse_vrf){if(use_vrf){if(json){if
(ospf->vrf_id==VRF_DEFAULT)json_object_string_add(json,"vrfName","default");else
json_object_string_add(json,"vrfName",ospf->name);json_object_int_add(json,"vrfI
d",ospf->vrf_id);}else{if(ospf->vrf_id==VRF_DEFAULT)vty_out(vty,"VRFName:%s\n","
default");elseif(ospf->name)vty_out(vty,"VRFName:%s\n",ospf->name);}}}#ifndefVTY
SH_EXTRACT_PL#include"ospfd/ospf_vty_clippy.c"#endifDEFUN_NOSH(router_ospf,route
r_ospf_cmd,"routerospf[{(1-65535)|vrfNAME}]","Enablearoutingprocess\n""StartOSPF
configuration\n""InstanceID\n"VRF_CMD_HELP_STR){structospf*ospf=NULL;intret=CMD_
SUCCESS;unsignedshortinstance=0;structvrf*vrf=NULL;structroute_node*rn;structint
erface*ifp;ospf=ospf_cmd_lookup_ospf(vty,argv,argc,1,&instance);if(!ospf)returnC
MD_WARNING_CONFIG_FAILED;/*Thefollowinglogictosetthevtyqobjindexisinplacetobeabl
etoignorethecommandswhichdontbelongtothisinstance.*/if(ospf->instance!=instance)
{VTY_PUSH_CONTEXT_NULL(OSPF_NODE);ret=CMD_NOT_MY_INSTANCE;}else{if(ospf->vrf_id!
=VRF_UNKNOWN)ospf->oi_running=1;if(IS_DEBUG_OSPF_EVENT)zlog_debug("Configcommand
'routerospf%d'received,vrf%sid%uoi_running%u",instance,ospf->name?ospf->name:"NI
L",ospf->vrf_id,ospf->oi_running);VTY_PUSH_CONTEXT(OSPF_NODE,ospf);/*Activate'ip
ospfareax'configuredinterfacesforgiven*vrf.Activateareaonvrfxawareinterfaces.*vr
f_enablecallbackcallsrouter_id_updatewhich*internallywillcallospf_if_updatetotri
gger*network_run_state*/vrf=vrf_lookup_by_id(ospf->vrf_id);FOR_ALL_INTERFACES(vr
f,ifp){structospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(OSPF_IF_PARAM_CO
NFIGURED(params,if_area)){for(rn=route_top(ospf->networks);rn;rn=route_next(rn))
{if(rn->info!=NULL){vty_out(vty,"Interface%shasareaconfigbutpleaseremoveallnetwo
rkcommandsfirst.\n",ifp->name);returnret;}}ospf_interface_area_set(ospf,ifp);osp
f->if_ospf_cli_count++;}}ospf_router_id_update(ospf);}returnret;}DEFUN(no_router
_ospf,no_router_ospf_cmd,"norouterospf[{(1-65535)|vrfNAME}]",NO_STR"Enablearouti
ngprocess\n""StartOSPFconfiguration\n""InstanceID\n"VRF_CMD_HELP_STR){structospf
*ospf;unsignedshortinstance=0;ospf=ospf_cmd_lookup_ospf(vty,argv,argc,0,&instanc
e);if(ospf==NULL){if(instance)returnCMD_NOT_MY_INSTANCE;elsereturnCMD_WARNING;}o
spf_finish(ospf);returnCMD_SUCCESS;}DEFPY(ospf_router_id,ospf_router_id_cmd,"osp
frouter-idA.B.C.D","OSPFspecificcommands\n""router-idfortheOSPFprocess\n""OSPFro
uter-idinIPaddressformat\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);structlistn
ode*node;structospf_area*area;ospf->router_id_static=router_id;for(ALL_LIST_ELEM
ENTS_RO(ospf->areas,node,area))if(area->full_nbrs){vty_out(vty,"Forthisrouter-id
changetotakeeffect,""saveconfigandrestartospfd\n");returnCMD_SUCCESS;}ospf_route
r_id_update(ospf);returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_router_id_old,ospf_router
_id_old_cmd,"router-idA.B.C.D","router-idfortheOSPFprocess\n""OSPFrouter-idinIPa
ddressformat\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4=1;structlis
tnode*node;structospf_area*area;structin_addrrouter_id;intret;ret=inet_aton(argv
[idx_ipv4]->arg,&router_id);if(!ret){vty_out(vty,"PleasespecifyRouterIDbyA.B.C.D
\n");returnCMD_WARNING_CONFIG_FAILED;}ospf->router_id_static=router_id;for(ALL_L
IST_ELEMENTS_RO(ospf->areas,node,area))if(area->full_nbrs){vty_out(vty,"Forthisr
outer-idchangetotakeeffect,""saveconfigandrestartospfd\n");returnCMD_SUCCESS;}os
pf_router_id_update(ospf);returnCMD_SUCCESS;}DEFPY(no_ospf_router_id,no_ospf_rou
ter_id_cmd,"noospfrouter-id[A.B.C.D]",NO_STR"OSPFspecificcommands\n""router-idfo
rtheOSPFprocess\n""OSPFrouter-idinIPaddressformat\n"){VTY_DECLVAR_INSTANCE_CONTE
XT(ospf,ospf);structlistnode*node;structospf_area*area;if(router_id_str){if(!IPV
4_ADDR_SAME(&ospf->router_id_static,&router_id)){vty_out(vty,"%%OSPFrouter-iddoe
sn'tmatch\n");returnCMD_WARNING_CONFIG_FAILED;}}ospf->router_id_static.s_addr=0;
for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area))if(area->full_nbrs){vty_out(vty,
"Forthisrouter-idchangetotakeeffect,""saveconfigandrestartospfd\n");returnCMD_SU
CCESS;}ospf_router_id_update(ospf);returnCMD_SUCCESS;}staticvoidospf_passive_int
erface_default(structospf*ospf,uint8_tnewval){structvrf*vrf=vrf_lookup_by_id(osp
f->vrf_id);structlistnode*ln;structinterface*ifp;structospf_interface*oi;ospf->p
assive_interface_default=newval;FOR_ALL_INTERFACES(vrf,ifp){if(ifp&&OSPF_IF_PARA
M_CONFIGURED(IF_DEF_PARAMS(ifp),passive_interface))UNSET_IF_PARAM(IF_DEF_PARAMS(
ifp),passive_interface);}for(ALL_LIST_ELEMENTS_RO(ospf->oiflist,ln,oi)){if(OSPF_
IF_PARAM_CONFIGURED(oi->params,passive_interface))UNSET_IF_PARAM(oi->params,pass
ive_interface);/*updatemulticastmemberships*/ospf_if_set_multicast(oi);}}staticv
oidospf_passive_interface_update_addr(structospf*ospf,structinterface*ifp,struct
ospf_if_params*params,uint8_tvalue,structin_addraddr){uint8_tdflt;params->passiv
e_interface=value;if(params!=IF_DEF_PARAMS(ifp)){if(OSPF_IF_PARAM_CONFIGURED(IF_
DEF_PARAMS(ifp),passive_interface))dflt=IF_DEF_PARAMS(ifp)->passive_interface;el
sedflt=ospf->passive_interface_default;if(value!=dflt)SET_IF_PARAM(params,passiv
e_interface);elseUNSET_IF_PARAM(params,passive_interface);ospf_free_if_params(if
p,addr);ospf_if_update_params(ifp,addr);}}staticvoidospf_passive_interface_updat
e(structospf*ospf,structinterface*ifp,structospf_if_params*params,uint8_tvalue){
params->passive_interface=value;if(params==IF_DEF_PARAMS(ifp)){if(value!=ospf->p
assive_interface_default)SET_IF_PARAM(params,passive_interface);elseUNSET_IF_PAR
AM(params,passive_interface);}}DEFUN(ospf_passive_interface,ospf_passive_interfa
ce_addr_cmd,"passive-interface<IFNAME[A.B.C.D]|default>","Suppressroutingupdates
onaninterface\n""Interface'sname\n""IPv4address\n""Suppressroutingupdatesoninter
facesbydefault\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4=2;structi
nterface*ifp=NULL;structin_addraddr={.s_addr=INADDR_ANY};intret;structospf_if_pa
rams*params;structroute_node*rn;if(strmatch(argv[1]->text,"default")){ospf_passi
ve_interface_default(ospf,OSPF_IF_PASSIVE);returnCMD_SUCCESS;}if(ospf->vrf_id!=V
RF_UNKNOWN)ifp=if_get_by_name(argv[1]->arg,ospf->vrf_id,0);if(ifp==NULL){vty_out
(vty,"interface%snotfound.\n",(char*)argv[1]->arg);returnCMD_WARNING_CONFIG_FAIL
ED;}params=IF_DEF_PARAMS(ifp);if(argc==3){ret=inet_aton(argv[idx_ipv4]->arg,&add
r);if(!ret){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WA
RNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_update_params(i
fp,addr);ospf_passive_interface_update_addr(ospf,ifp,params,OSPF_IF_PASSIVE,addr
);}ospf_passive_interface_update(ospf,ifp,params,OSPF_IF_PASSIVE);/*XXXWeshouldc
allospf_if_set_multicastonexactlythose*interfacesforwhichthepassivepropertychang
ed.Itistoomuch*worktodeterminethisset,sowedothisforeveryinterface.*Thisissafeand
reasonablebecauseospf_if_set_multicastusesa*recordofjoinedgroupstoavoidsystemsca
llsifthedesired*membershipsmatchthecurrentmemership.*/for(rn=route_top(IF_OIFS(i
fp));rn;rn=route_next(rn)){structospf_interface*oi=rn->info;if(oi&&(OSPF_IF_PARA
M(oi,passive_interface)==OSPF_IF_PASSIVE))ospf_if_set_multicast(oi);}/**XXXItisn
otclearwhatstatetransitionstheinterfaceneedsto*undergowhengoingfromactivetopassi
ve.Fixingthiswill*requirepreciseidentificationofinterfaceshavingsucha*transition
.*/returnCMD_SUCCESS;}DEFUN(no_ospf_passive_interface,no_ospf_passive_interface_
addr_cmd,"nopassive-interface<IFNAME[A.B.C.D]|default>",NO_STR"Allowroutingupdat
esonaninterface\n""Interface'sname\n""IPv4address\n""Allowroutingupdatesoninterf
acesbydefault\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4=3;structin
terface*ifp=NULL;structin_addraddr={.s_addr=INADDR_ANY};structospf_if_params*par
ams;intret;structroute_node*rn;if(strmatch(argv[2]->text,"default")){ospf_passiv
e_interface_default(ospf,OSPF_IF_ACTIVE);returnCMD_SUCCESS;}if(ospf->vrf_id!=VRF
_UNKNOWN)ifp=if_get_by_name(argv[2]->arg,ospf->vrf_id,0);if(ifp==NULL){vty_out(v
ty,"interface%snotfound.\n",(char*)argv[2]->arg);returnCMD_WARNING_CONFIG_FAILED
;}params=IF_DEF_PARAMS(ifp);if(argc==4){ret=inet_aton(argv[idx_ipv4]->arg,&addr)
;if(!ret){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARN
ING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);if(params==NULL)return
CMD_SUCCESS;ospf_passive_interface_update_addr(ospf,ifp,params,OSPF_IF_ACTIVE,ad
dr);}ospf_passive_interface_update(ospf,ifp,params,OSPF_IF_ACTIVE);/*XXXWeshould
callospf_if_set_multicastonexactlythose*interfacesforwhichthepassivepropertychan
ged.Itistoomuch*worktodeterminethisset,sowedothisforeveryinterface.*Thisissafean
dreasonablebecauseospf_if_set_multicastusesa*recordofjoinedgroupstoavoidsystemsc
allsifthedesired*membershipsmatchthecurrentmemership.*/for(rn=route_top(IF_OIFS(
ifp));rn;rn=route_next(rn)){structospf_interface*oi=rn->info;if(oi&&(OSPF_IF_PAR
AM(oi,passive_interface)==OSPF_IF_ACTIVE))ospf_if_set_multicast(oi);}returnCMD_S
UCCESS;}DEFUN(ospf_network_area,ospf_network_area_cmd,"networkA.B.C.D/Marea<A.B.
C.D|(0-4294967295)>","EnableroutingonanIPnetwork\n""OSPFnetworkprefix\n""SettheO
SPFareaID\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n"){VTY_DE
CLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_prefixlen=1;intidx_ipv4_number=3;s
tructprefix_ipv4p;structin_addrarea_id;intret,format;if(ospf->instance){vty_out(
vty,"Thenetworkcommandisnotsupportedinmulti-instanceospf\n");returnCMD_WARNING_C
ONFIG_FAILED;}if(ospf->if_ospf_cli_count>0){vty_out(vty,"Pleaseremoveallipospfar
eax.x.x.xcommandsfirst.\n");if(IS_DEBUG_OSPF_EVENT)zlog_debug("%sospfvrf%snumof%
uipospareaxconfig",__PRETTY_FUNCTION__,ospf->name?ospf->name:"NIL",ospf->if_ospf
_cli_count);returnCMD_WARNING_CONFIG_FAILED;}/*GetnetworkprefixandAreaID.*/str2p
refix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);VTY_GET_OSPF_AREA_ID(area_id,format
,argv[idx_ipv4_number]->arg);ret=ospf_network_set(ospf,&p,area_id,format);if(ret
==0){vty_out(vty,"Thereisalreadysamenetworkstatement.\n");returnCMD_WARNING_CONF
IG_FAILED;}returnCMD_SUCCESS;}DEFUN(no_ospf_network_area,no_ospf_network_area_cm
d,"nonetworkA.B.C.D/Marea<A.B.C.D|(0-4294967295)>",NO_STR"EnableroutingonanIPnet
work\n""OSPFnetworkprefix\n""SettheOSPFareaID\n""OSPFareaIDinIPaddressformat\n""
OSPFareaIDasadecimalvalue\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv
4_prefixlen=2;intidx_ipv4_number=4;structprefix_ipv4p;structin_addrarea_id;intre
t,format;if(ospf->instance){vty_out(vty,"Thenetworkcommandisnotsupportedinmulti-
instanceospf\n");returnCMD_WARNING_CONFIG_FAILED;}/*GetnetworkprefixandAreaID.*/
str2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);VTY_GET_OSPF_AREA_ID(area_id,f
ormat,argv[idx_ipv4_number]->arg);ret=ospf_network_unset(ospf,&p,area_id);if(ret
==0){vty_out(vty,"Can'tfindspecifiednetworkareaconfiguration.\n");returnCMD_WARN
ING_CONFIG_FAILED;}returnCMD_SUCCESS;}DEFUN(ospf_area_range,ospf_area_range_cmd,
"area<A.B.C.D|(0-4294967295)>rangeA.B.C.D/M[advertise[cost(0-16777215)]]","OSPFa
reaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Sum
marizeroutesmatchingaddress/mask(borderroutersonly)\n""Arearangeprefix\n""Advert
isethisrange(default)\n""Userspecifiedmetricforthisrange\n""Advertisedmetricfort
hisrange\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;intidx
_ipv4_prefixlen=3;intidx_cost=6;structprefix_ipv4p;structin_addrarea_id;intforma
t;uint32_tcost;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);s
tr2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);ospf_area_range_set(ospf,area_i
d,&p,OSPF_AREA_RANGE_ADVERTISE);if(argc>5){cost=strtoul(argv[idx_cost]->arg,NULL
,10);ospf_area_range_cost_set(ospf,area_id,&p,cost);}returnCMD_SUCCESS;}DEFUN(os
pf_area_range_cost,ospf_area_range_cost_cmd,"area<A.B.C.D|(0-4294967295)>rangeA.
B.C.D/Mcost(0-16777215)","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""O
SPFareaIDasadecimalvalue\n""Summarizeroutesmatchingaddress/mask(borderroutersonl
y)\n""Arearangeprefix\n""Userspecifiedmetricforthisrange\n""Advertisedmetricfort
hisrange\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;intidx
_ipv4_prefixlen=3;intidx_cost=5;structprefix_ipv4p;structin_addrarea_id;intforma
t;uint32_tcost;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);s
tr2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);ospf_area_range_set(ospf,area_i
d,&p,OSPF_AREA_RANGE_ADVERTISE);ospf_area_display_format_set(ospf,ospf_area_get(
ospf,area_id),format);cost=strtoul(argv[idx_cost]->arg,NULL,10);ospf_area_range_
cost_set(ospf,area_id,&p,cost);returnCMD_SUCCESS;}DEFUN(ospf_area_range_not_adve
rtise,ospf_area_range_not_advertise_cmd,"area<A.B.C.D|(0-4294967295)>rangeA.B.C.
D/Mnot-advertise","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFarea
IDasadecimalvalue\n""Summarizeroutesmatchingaddress/mask(borderroutersonly)\n""A
rearangeprefix\n""DoNotAdvertisethisrange\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,
ospf);intidx_ipv4_number=1;intidx_ipv4_prefixlen=3;structprefix_ipv4p;structin_a
ddrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->
arg);str2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);ospf_area_range_set(ospf,
area_id,&p,0);ospf_area_display_format_set(ospf,ospf_area_get(ospf,area_id),form
at);returnCMD_SUCCESS;}DEFUN(no_ospf_area_range,no_ospf_area_range_cmd,"noarea<A
.B.C.D|(0-4294967295)>rangeA.B.C.D/M[<cost(0-16777215)|advertise[cost(0-16777215
)]|not-advertise>]",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""
OSPFareaIDasadecimalvalue\n""Summarizeroutesmatchingaddress/mask(borderrouterson
ly)\n""Arearangeprefix\n""Userspecifiedmetricforthisrange\n""Advertisedmetricfor
thisrange\n""Advertisethisrange(default)\n""Userspecifiedmetricforthisrange\n""A
dvertisedmetricforthisrange\n""DoNotAdvertisethisrange\n"){VTY_DECLVAR_INSTANCE_
CONTEXT(ospf,ospf);intidx_ipv4_number=2;intidx_ipv4_prefixlen=4;structprefix_ipv
4p;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_i
pv4_number]->arg);str2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);ospf_area_ra
nge_unset(ospf,area_id,&p);returnCMD_SUCCESS;}DEFUN(ospf_area_range_substitute,o
spf_area_range_substitute_cmd,"area<A.B.C.D|(0-4294967295)>rangeA.B.C.D/Msubstit
uteA.B.C.D/M","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDas
adecimalvalue\n""Summarizeroutesmatchingaddress/mask(borderroutersonly)\n""Arear
angeprefix\n""Announcearearangeasanotherprefix\n""Networkprefixtobeannouncedinst
eadofrange\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;inti
dx_ipv4_prefixlen=3;intidx_ipv4_prefixlen_2=5;structprefix_ipv4p,s;structin_addr
area_id;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg
);str2prefix_ipv4(argv[idx_ipv4_prefixlen]->arg,&p);str2prefix_ipv4(argv[idx_ipv
4_prefixlen_2]->arg,&s);ospf_area_range_substitute_set(ospf,area_id,&p,&s);ospf_
area_display_format_set(ospf,ospf_area_get(ospf,area_id),format);returnCMD_SUCCE
SS;}DEFUN(no_ospf_area_range_substitute,no_ospf_area_range_substitute_cmd,"noare
a<A.B.C.D|(0-4294967295)>rangeA.B.C.D/MsubstituteA.B.C.D/M",NO_STR"OSPFareaparam
eters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Summarizero
utesmatchingaddress/mask(borderroutersonly)\n""Arearangeprefix\n""Announceareara
ngeasanotherprefix\n""Networkprefixtobeannouncedinsteadofrange\n"){VTY_DECLVAR_I
NSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=2;intidx_ipv4_prefixlen=4;intidx_i
pv4_prefixlen_2=6;structprefix_ipv4p,s;structin_addrarea_id;intformat;VTY_GET_OS
PF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);str2prefix_ipv4(argv[idx_i
pv4_prefixlen]->arg,&p);str2prefix_ipv4(argv[idx_ipv4_prefixlen_2]->arg,&s);ospf
_area_range_substitute_unset(ospf,area_id,&p);returnCMD_SUCCESS;}/*CommandHandle
rLogicinVLinkstuffisdelicate!!ALTERATYOUROWNRISK!!!!Variousdummyvaluesareusedtor
epresent'NoChange'stateforVLinkconfigurationNOTbeingchangedbyaVLinkcommand,andsp
ecialsyntaxisusedwithinthecommandstringssothatthetypedincommandverbscanbeseenint
heconfigurationcommandbacckendhandler.Thisistodrasticallyreducetheverbeagerequir
edtocoeupwithareasonablycompatibleCiscoVLinkcommand-MatthewGrant<grantma@anathot
h.gen.nz>Wed,21Feb200115:13:52+1300*//*Configurationdataforvirtuallinks*/structo
spf_vl_config_data{structvty*vty;/*vtystuff*/structin_addrarea_id;/*areaIDfromco
mmandline*/intarea_id_fmt;/*commandlineareaIDformat*/structin_addrvl_peer;/*comm
andlinevl_peer*/intauth_type;/*Authehnticationtype,ifgiven*/char*auth_key;/*simp
lepasswordifpresent*/intcrypto_key_id;/*CryptographickeyID*/char*md5_key;/*MD5au
thenticationkey*/inthello_interval;/*Obviouswhattheseare...*/intretransmit_inter
val;inttransmit_delay;intdead_interval;};staticvoidospf_vl_config_data_init(stru
ctospf_vl_config_data*vl_config,structvty*vty){memset(vl_config,0,sizeof(structo
spf_vl_config_data));vl_config->auth_type=OSPF_AUTH_CMD_NOTSEEN;vl_config->vty=v
ty;}staticstructospf_vl_data*ospf_find_vl_data(structospf*ospf,structospf_vl_con
fig_data*vl_config){structospf_area*area;structospf_vl_data*vl_data;structvty*vt
y;structin_addrarea_id;vty=vl_config->vty;area_id=vl_config->area_id;if(area_id.
s_addr==OSPF_AREA_BACKBONE){vty_out(vty,"ConfiguringVLsoverthebackboneisnotallow
ed\n");returnNULL;}area=ospf_area_get(ospf,area_id);ospf_area_display_format_set
(ospf,area,vl_config->area_id_fmt);if(area->external_routing!=OSPF_AREA_DEFAULT)
{if(vl_config->area_id_fmt==OSPF_AREA_ID_FMT_DOTTEDQUAD)vty_out(vty,"Area%sis%s\
n",inet_ntoa(area_id),area->external_routing==OSPF_AREA_NSSA?"nssa":"stub");else
vty_out(vty,"Area%ldis%s\n",(unsignedlong)ntohl(area_id.s_addr),area->external_r
outing==OSPF_AREA_NSSA?"nssa":"stub");returnNULL;}if((vl_data=ospf_vl_lookup(osp
f,area,vl_config->vl_peer))==NULL){vl_data=ospf_vl_data_new(area,vl_config->vl_p
eer);if(vl_data->vl_oi==NULL){vl_data->vl_oi=ospf_vl_new(ospf,vl_data);ospf_vl_a
dd(ospf,vl_data);ospf_spf_calculate_schedule(ospf,SPF_FLAG_CONFIG_CHANGE);}}retu
rnvl_data;}staticintospf_vl_set_security(structospf_vl_data*vl_data,structospf_v
l_config_data*vl_config){structcrypt_key*ck;structvty*vty;structinterface*ifp=vl
_data->vl_oi->ifp;vty=vl_config->vty;if(vl_config->auth_type!=OSPF_AUTH_CMD_NOTS
EEN){SET_IF_PARAM(IF_DEF_PARAMS(ifp),auth_type);IF_DEF_PARAMS(ifp)->auth_type=vl
_config->auth_type;}if(vl_config->auth_key){memset(IF_DEF_PARAMS(ifp)->auth_simp
le,0,OSPF_AUTH_SIMPLE_SIZE+1);strncpy((char*)IF_DEF_PARAMS(ifp)->auth_simple,vl_
config->auth_key,OSPF_AUTH_SIMPLE_SIZE);}elseif(vl_config->md5_key){if(ospf_cryp
t_key_lookup(IF_DEF_PARAMS(ifp)->auth_crypt,vl_config->crypto_key_id)!=NULL){vty
_out(vty,"OSPF:Key%dalreadyexists\n",vl_config->crypto_key_id);returnCMD_WARNING
;}ck=ospf_crypt_key_new();ck->key_id=vl_config->crypto_key_id;memset(ck->auth_ke
y,0,OSPF_AUTH_MD5_SIZE+1);strncpy((char*)ck->auth_key,vl_config->md5_key,OSPF_AU
TH_MD5_SIZE);ospf_crypt_key_add(IF_DEF_PARAMS(ifp)->auth_crypt,ck);}elseif(vl_co
nfig->crypto_key_id!=0){/*Deleteakey*/if(ospf_crypt_key_lookup(IF_DEF_PARAMS(ifp
)->auth_crypt,vl_config->crypto_key_id)==NULL){vty_out(vty,"OSPF:Key%ddoesnotexi
st\n",vl_config->crypto_key_id);returnCMD_WARNING_CONFIG_FAILED;}ospf_crypt_key_
delete(IF_DEF_PARAMS(ifp)->auth_crypt,vl_config->crypto_key_id);}returnCMD_SUCCE
SS;}staticintospf_vl_set_timers(structospf_vl_data*vl_data,structospf_vl_config_
data*vl_config){structinterface*ifp=vl_data->vl_oi->ifp;/*VirtualLinkdatainitial
isedtodefaults,soonlysetifavaluegiven*/if(vl_config->hello_interval){SET_IF_PARA
M(IF_DEF_PARAMS(ifp),v_hello);IF_DEF_PARAMS(ifp)->v_hello=vl_config->hello_inter
val;}if(vl_config->dead_interval){SET_IF_PARAM(IF_DEF_PARAMS(ifp),v_wait);IF_DEF
_PARAMS(ifp)->v_wait=vl_config->dead_interval;}if(vl_config->retransmit_interval
){SET_IF_PARAM(IF_DEF_PARAMS(ifp),retransmit_interval);IF_DEF_PARAMS(ifp)->retra
nsmit_interval=vl_config->retransmit_interval;}if(vl_config->transmit_delay){SET
_IF_PARAM(IF_DEF_PARAMS(ifp),transmit_delay);IF_DEF_PARAMS(ifp)->transmit_delay=
vl_config->transmit_delay;}returnCMD_SUCCESS;}/*Thebusinessendofalloftheabove*/s
taticintospf_vl_set(structospf*ospf,structospf_vl_config_data*vl_config){structo
spf_vl_data*vl_data;intret;vl_data=ospf_find_vl_data(ospf,vl_config);if(!vl_data
)returnCMD_WARNING_CONFIG_FAILED;/*Processthisonefirstasitcanhaveafatalresult,wh
ichcanonlylogicallyoccurifthevirtuallinkexistsalreadyThusacommanderrordoesnotres
ultinachangetotherunningconfigurationsuchasunexpectedlyalteredtimervaluesetc.*/r
et=ospf_vl_set_security(vl_data,vl_config);if(ret!=CMD_SUCCESS)returnret;/*Setan
ytimebasedparameters,theseareaalreadyrangechecked*/ret=ospf_vl_set_timers(vl_dat
a,vl_config);if(ret!=CMD_SUCCESS)returnret;returnCMD_SUCCESS;}/*Thisstuffexistst
omakespecifyingallthealiascommandsALOTsimpler*/#defineVLINK_HELPSTR_IPADDR\"OSPF
areaparameters\n"\"OSPFareaIDinIPaddressformat\n"\"OSPFareaIDasadecimalvalue\n"\
"Configureavirtuallink\n"\"RouterIDoftheremoteABR\n"#defineVLINK_HELPSTR_AUTHTYP
E_SIMPLE\"Enableauthenticationonthisvirtuallink\n"\"dummystring\n"#defineVLINK_H
ELPSTR_AUTHTYPE_ALL\VLINK_HELPSTR_AUTHTYPE_SIMPLE\"Usenullauthentication\n"\"Use
message-digestauthentication\n"#defineVLINK_HELPSTR_TIME_PARAM\"TimebetweenHELLO
packets\n"\"Seconds\n"\"Timebetweenretransmittinglostlinkstateadvertisements\n"\
"Seconds\n"\"Linkstatetransmitdelay\n"\"Seconds\n"\"Intervaltimeafterwhichaneigh
borisdeclareddown\n"\"Seconds\n"#defineVLINK_HELPSTR_AUTH_SIMPLE\"Authentication
password(key)\n"\"TheOSPFpassword(key)\n"#defineVLINK_HELPSTR_AUTH_MD5\"Messaged
igestauthenticationpassword(key)\n"\"KeyID\n"\"UseMD5algorithm\n"\"TheOSPFpasswo
rd(key)\n"DEFUN(ospf_area_vlink,ospf_area_vlink_cmd,"area<A.B.C.D|(0-4294967295)
>virtual-linkA.B.C.D[authentication[<message-digest|null>]][<message-digest-key(
1-255)md5KEY|authentication-keyAUTH_KEY>]",VLINK_HELPSTR_IPADDR"Enableauthentica
tiononthisvirtuallink\n""Usemessage-digestauthentication\n""Usenullauthenticatio
n\n"VLINK_HELPSTR_AUTH_MD5VLINK_HELPSTR_AUTH_SIMPLE){VTY_DECLVAR_INSTANCE_CONTEX
T(ospf,ospf);intidx_ipv4_number=1;intidx_ipv4=3;structospf_vl_config_datavl_conf
ig;charauth_key[OSPF_AUTH_SIMPLE_SIZE+1];charmd5_key[OSPF_AUTH_MD5_SIZE+1];intre
t;intidx=0;ospf_vl_config_data_init(&vl_config,vty);/*Readofffirst2parametersand
checkthem*/ret=str2area_id(argv[idx_ipv4_number]->arg,&vl_config.area_id,&vl_con
fig.area_id_fmt);if(ret<0){vty_out(vty,"OSPFareaIDisinvalid\n");returnCMD_WARNIN
G_CONFIG_FAILED;}ret=inet_aton(argv[idx_ipv4]->arg,&vl_config.vl_peer);if(!ret){
vty_out(vty,"PleasespecifyvalidRouterIDasa.b.c.d\n");returnCMD_WARNING_CONFIG_FA
ILED;}if(argc<=4){/*Thatsallfolks!-BUGSB.strikesagain!!!*/returnospf_vl_set(ospf
,&vl_config);}if(argv_find(argv,argc,"authentication",&idx)){/*authentication-th
isoptioncanonlyoccuratstartofcommandline*/vl_config.auth_type=OSPF_AUTH_SIMPLE;}
if(argv_find(argv,argc,"message-digest",&idx)){/*authenticationmessage-digest*/v
l_config.auth_type=OSPF_AUTH_CRYPTOGRAPHIC;}elseif(argv_find(argv,argc,"null",&i
dx)){/*"authenticationnull"*/vl_config.auth_type=OSPF_AUTH_NULL;}if(argv_find(ar
gv,argc,"message-digest-key",&idx)){vl_config.md5_key=NULL;vl_config.crypto_key_
id=strtol(argv[idx+1]->arg,NULL,10);if(vl_config.crypto_key_id<0)returnCMD_WARNI
NG_CONFIG_FAILED;memset(md5_key,0,OSPF_AUTH_MD5_SIZE+1);strncpy(md5_key,argv[idx
+3]->arg,OSPF_AUTH_MD5_SIZE);vl_config.md5_key=md5_key;}if(argv_find(argv,argc,"
authentication-key",&idx)){memset(auth_key,0,OSPF_AUTH_SIMPLE_SIZE+1);strncpy(au
th_key,argv[idx+1]->arg,OSPF_AUTH_SIMPLE_SIZE);vl_config.auth_key=auth_key;}/*Ac
tionconfiguration*/returnospf_vl_set(ospf,&vl_config);}DEFUN(no_ospf_area_vlink,
no_ospf_area_vlink_cmd,"noarea<A.B.C.D|(0-4294967295)>virtual-linkA.B.C.D[authen
tication[<message-digest|null>]][<message-digest-key(1-255)md5KEY|authentication
-keyAUTH_KEY>]",NO_STRVLINK_HELPSTR_IPADDR"Enableauthenticationonthisvirtuallink
\n"\"Usemessage-digestauthentication\n"\"Usenullauthentication\n"\VLINK_HELPSTR_
AUTH_MD5VLINK_HELPSTR_AUTH_SIMPLE){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intid
x_ipv4_number=2;intidx_ipv4=4;structospf_area*area;structospf_vl_config_datavl_c
onfig;structospf_vl_data*vl_data=NULL;charauth_key[OSPF_AUTH_SIMPLE_SIZE+1];inti
dx=0;intret,format;ospf_vl_config_data_init(&vl_config,vty);ret=str2area_id(argv
[idx_ipv4_number]->arg,&vl_config.area_id,&format);if(ret<0){vty_out(vty,"OSPFar
eaIDisinvalid\n");returnCMD_WARNING_CONFIG_FAILED;}area=ospf_area_lookup_by_area
_id(ospf,vl_config.area_id);if(!area){vty_out(vty,"Areadoesnotexist\n");returnCM
D_WARNING_CONFIG_FAILED;}ret=inet_aton(argv[idx_ipv4]->arg,&vl_config.vl_peer);i
f(!ret){vty_out(vty,"PleasespecifyvalidRouterIDasa.b.c.d\n");returnCMD_WARNING_C
ONFIG_FAILED;}if(argc<=5){/*BasicVLinknocommand*//*Thatsallfolks!-BUGSB.strikesa
gain!!!*/if((vl_data=ospf_vl_lookup(ospf,area,vl_config.vl_peer)))ospf_vl_delete
(ospf,vl_data);ospf_area_check_free(ospf,vl_config.area_id);returnCMD_SUCCESS;}/
*Ifwearedownhere,weareresetingparameters*//*Dealwithotherparameters*/if(argv_fin
d(argv,argc,"authentication",&idx)){/*authentication-thisoptioncanonlyoccuratsta
rtofcommandline*/vl_config.auth_type=OSPF_AUTH_NOTSET;}if(argv_find(argv,argc,"m
essage-digest-key",&idx)){vl_config.md5_key=NULL;vl_config.crypto_key_id=strtol(
argv[idx+1]->arg,NULL,10);if(vl_config.crypto_key_id<0)returnCMD_WARNING_CONFIG_
FAILED;}if(argv_find(argv,argc,"authentication-key",&idx)){/*Resetauthentication
-keyto0*/memset(auth_key,0,OSPF_AUTH_SIMPLE_SIZE+1);vl_config.auth_key=auth_key;
}/*Actionconfiguration*/returnospf_vl_set(ospf,&vl_config);}DEFUN(ospf_area_vlin
k_intervals,ospf_area_vlink_intervals_cmd,"area<A.B.C.D|(0-4294967295)>virtual-l
inkA.B.C.D{hello-interval(1-65535)|retransmit-interval(1-65535)|transmit-delay(1
-65535)|dead-interval(1-65535)}",VLINK_HELPSTR_IPADDRVLINK_HELPSTR_TIME_PARAM){V
TY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);structospf_vl_config_datavl_config;intret
=0;ospf_vl_config_data_init(&vl_config,vty);char*area_id=argv[1]->arg;char*route
r_id=argv[3]->arg;ret=str2area_id(area_id,&vl_config.area_id,&vl_config.area_id_
fmt);if(ret<0){vty_out(vty,"OSPFareaIDisinvalid\n");returnCMD_WARNING_CONFIG_FAI
LED;}ret=inet_aton(router_id,&vl_config.vl_peer);if(!ret){vty_out(vty,"Pleasespe
cifyvalidRouterIDasa.b.c.d\n");returnCMD_WARNING_CONFIG_FAILED;}for(intidx=4;idx
<argc;idx++){if(strmatch(argv[idx]->text,"hello-interval"))vl_config.hello_inter
val=strtol(argv[++idx]->arg,NULL,10);elseif(strmatch(argv[idx]->text,"retransmit
-interval"))vl_config.retransmit_interval=strtol(argv[++idx]->arg,NULL,10);elsei
f(strmatch(argv[idx]->text,"transmit-delay"))vl_config.transmit_delay=strtol(arg
v[++idx]->arg,NULL,10);elseif(strmatch(argv[idx]->text,"dead-interval"))vl_confi
g.dead_interval=strtol(argv[++idx]->arg,NULL,10);}/*Actionconfiguration*/returno
spf_vl_set(ospf,&vl_config);}DEFUN(no_ospf_area_vlink_intervals,no_ospf_area_vli
nk_intervals_cmd,"noarea<A.B.C.D|(0-4294967295)>virtual-linkA.B.C.D{hello-interv
al(1-65535)|retransmit-interval(1-65535)|transmit-delay(1-65535)|dead-interval(1
-65535)}",NO_STRVLINK_HELPSTR_IPADDRVLINK_HELPSTR_TIME_PARAM){VTY_DECLVAR_INSTAN
CE_CONTEXT(ospf,ospf);structospf_vl_config_datavl_config;intret=0;ospf_vl_config
_data_init(&vl_config,vty);char*area_id=argv[2]->arg;char*router_id=argv[4]->arg
;ret=str2area_id(area_id,&vl_config.area_id,&vl_config.area_id_fmt);if(ret<0){vt
y_out(vty,"OSPFareaIDisinvalid\n");returnCMD_WARNING_CONFIG_FAILED;}ret=inet_ato
n(router_id,&vl_config.vl_peer);if(!ret){vty_out(vty,"PleasespecifyvalidRouterID
asa.b.c.d\n");returnCMD_WARNING_CONFIG_FAILED;}for(intidx=5;idx<argc;idx++){if(s
trmatch(argv[idx]->text,"hello-interval"))vl_config.hello_interval=OSPF_HELLO_IN
TERVAL_DEFAULT;elseif(strmatch(argv[idx]->text,"retransmit-interval"))vl_config.
retransmit_interval=OSPF_RETRANSMIT_INTERVAL_DEFAULT;elseif(strmatch(argv[idx]->
text,"transmit-delay"))vl_config.transmit_delay=OSPF_TRANSMIT_DELAY_DEFAULT;else
if(strmatch(argv[idx]->text,"dead-interval"))vl_config.dead_interval=OSPF_ROUTER
_DEAD_INTERVAL_DEFAULT;}/*Actionconfiguration*/returnospf_vl_set(ospf,&vl_config
);}DEFUN(ospf_area_shortcut,ospf_area_shortcut_cmd,"area<A.B.C.D|(0-4294967295)>
shortcut<default|enable|disable>","OSPFareaparameters\n""OSPFareaIDinIPaddressfo
rmat\n""OSPFareaIDasadecimalvalue\n""Configurethearea'sshortcuttingmode\n""Setde
faultshortcuttingbehavior\n""Enableshortcuttingthroughthearea\n""Disableshortcut
tingthroughthearea\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_numbe
r=1;intidx_enable_disable=3;structospf_area*area;structin_addrarea_id;intmode;in
tformat;VTY_GET_OSPF_AREA_ID_NO_BB("shortcut",area_id,format,argv[idx_ipv4_numbe
r]->arg);area=ospf_area_get(ospf,area_id);ospf_area_display_format_set(ospf,area
,format);if(strncmp(argv[idx_enable_disable]->arg,"de",2)==0)mode=OSPF_SHORTCUT_
DEFAULT;elseif(strncmp(argv[idx_enable_disable]->arg,"di",2)==0)mode=OSPF_SHORTC
UT_DISABLE;elseif(strncmp(argv[idx_enable_disable]->arg,"e",1)==0)mode=OSPF_SHOR
TCUT_ENABLE;elsereturnCMD_WARNING_CONFIG_FAILED;ospf_area_shortcut_set(ospf,area
,mode);if(ospf->abr_type!=OSPF_ABR_SHORTCUT)vty_out(vty,"Shortcutareasettingwill
takeeffect""onlywhentherouterisconfiguredasShortcutABR\n");returnCMD_SUCCESS;}DE
FUN(no_ospf_area_shortcut,no_ospf_area_shortcut_cmd,"noarea<A.B.C.D|(0-429496729
5)>shortcut<enable|disable>",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPaddressf
ormat\n""OSPFareaIDasadecimalvalue\n""Deconfigurethearea'sshortcuttingmode\n""De
configureenabledshortcuttingthroughthearea\n""Deconfiguredisabledshortcuttingthr
oughthearea\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=2;str
uctospf_area*area;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID_NO_BB("sho
rtcut",area_id,format,argv[idx_ipv4_number]->arg);area=ospf_area_lookup_by_area_
id(ospf,area_id);if(!area)returnCMD_SUCCESS;ospf_area_shortcut_unset(ospf,area);
returnCMD_SUCCESS;}DEFUN(ospf_area_stub,ospf_area_stub_cmd,"area<A.B.C.D|(0-4294
967295)>stub","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDas
adecimalvalue\n""ConfigureOSPFareaasstub\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,o
spf);intidx_ipv4_number=1;structin_addrarea_id;intret,format;VTY_GET_OSPF_AREA_I
D_NO_BB("stub",area_id,format,argv[idx_ipv4_number]->arg);ret=ospf_area_stub_set
(ospf,area_id);ospf_area_display_format_set(ospf,ospf_area_get(ospf,area_id),for
mat);if(ret==0){vty_out(vty,"Firstdeconfigureallvirtuallinkthroughthisarea\n");r
eturnCMD_WARNING_CONFIG_FAILED;}ospf_area_no_summary_unset(ospf,area_id);returnC
MD_SUCCESS;}DEFUN(ospf_area_stub_no_summary,ospf_area_stub_no_summary_cmd,"area<
A.B.C.D|(0-4294967295)>stubno-summary","OSPFstubparameters\n""OSPFareaIDinIPaddr
essformat\n""OSPFareaIDasadecimalvalue\n""ConfigureOSPFareaasstub\n""Donotinject
inter-arearoutesintostub\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4
_number=1;structin_addrarea_id;intret,format;VTY_GET_OSPF_AREA_ID_NO_BB("stub",a
rea_id,format,argv[idx_ipv4_number]->arg);ret=ospf_area_stub_set(ospf,area_id);o
spf_area_display_format_set(ospf,ospf_area_get(ospf,area_id),format);if(ret==0){
vty_out(vty,"%%Areacannotbestubasitcontainsavirtuallink\n");returnCMD_WARNING_CO
NFIG_FAILED;}ospf_area_no_summary_set(ospf,area_id);returnCMD_SUCCESS;}DEFUN(no_
ospf_area_stub,no_ospf_area_stub_cmd,"noarea<A.B.C.D|(0-4294967295)>stub",NO_STR
"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\
n""ConfigureOSPFareaasstub\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ip
v4_number=2;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID_NO_BB("stub",are
a_id,format,argv[idx_ipv4_number]->arg);ospf_area_stub_unset(ospf,area_id);ospf_
area_no_summary_unset(ospf,area_id);returnCMD_SUCCESS;}DEFUN(no_ospf_area_stub_n
o_summary,no_ospf_area_stub_no_summary_cmd,"noarea<A.B.C.D|(0-4294967295)>stubno
-summary",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaID
asadecimalvalue\n""ConfigureOSPFareaasstub\n""Donotinjectinter-arearoutesintoare
a\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=2;structin_addr
area_id;intformat;VTY_GET_OSPF_AREA_ID_NO_BB("stub",area_id,format,argv[idx_ipv4
_number]->arg);ospf_area_no_summary_unset(ospf,area_id);returnCMD_SUCCESS;}stati
cintospf_area_nssa_cmd_handler(structvty*vty,intargc,structcmd_token**argv,intcf
g_nosum,intnosum){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);structin_addrarea_id;i
ntret,format;VTY_GET_OSPF_AREA_ID_NO_BB("NSSA",area_id,format,argv[1]->arg);ret=
ospf_area_nssa_set(ospf,area_id);ospf_area_display_format_set(ospf,ospf_area_get
(ospf,area_id),format);if(ret==0){vty_out(vty,"%%Areacannotbenssaasitcontainsavi
rtuallink\n");returnCMD_WARNING_CONFIG_FAILED;}if(argc>3){if(strncmp(argv[3]->te
xt,"translate-c",11)==0)ospf_area_nssa_translator_role_set(ospf,area_id,OSPF_NSS
A_ROLE_CANDIDATE);elseif(strncmp(argv[3]->text,"translate-n",11)==0)ospf_area_ns
sa_translator_role_set(ospf,area_id,OSPF_NSSA_ROLE_NEVER);elseif(strncmp(argv[3]
->text,"translate-a",11)==0)ospf_area_nssa_translator_role_set(ospf,area_id,OSPF
_NSSA_ROLE_ALWAYS);}else{ospf_area_nssa_translator_role_set(ospf,area_id,OSPF_NS
SA_ROLE_CANDIDATE);}if(cfg_nosum){if(nosum)ospf_area_no_summary_set(ospf,area_id
);elseospf_area_no_summary_unset(ospf,area_id);}ospf_schedule_abr_task(ospf);ret
urnCMD_SUCCESS;}DEFUN(ospf_area_nssa_translate,ospf_area_nssa_translate_cmd,"are
a<A.B.C.D|(0-4294967295)>nssa<translate-candidate|translate-never|translate-alwa
ys>","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalv
alue\n""ConfigureOSPFareaasnssa\n""ConfigureNSSA-ABRfortranslateelection(default
)\n""ConfigureNSSA-ABRtonevertranslate\n""ConfigureNSSA-ABRtoalwaystranslate\n")
{returnospf_area_nssa_cmd_handler(vty,argc,argv,0,0);}DEFUN(ospf_area_nssa,ospf_
area_nssa_cmd,"area<A.B.C.D|(0-4294967295)>nssa","OSPFareaparameters\n""OSPFarea
IDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""ConfigureOSPFareaasnssa\n"){
returnospf_area_nssa_cmd_handler(vty,argc,argv,0,0);}DEFUN(ospf_area_nssa_no_sum
mary,ospf_area_nssa_no_summary_cmd,"area<A.B.C.D|(0-4294967295)>nssano-summary",
"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\
n""ConfigureOSPFareaasnssa\n""Donotinjectinter-arearoutesintonssa\n"){intidx_ipv
4_number=1;structin_addrarea_id;intformat;VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf
);VTY_GET_OSPF_AREA_ID_NO_BB("NSSA",area_id,format,argv[idx_ipv4_number]->arg);o
spf_area_display_format_set(ospf,ospf_area_get(ospf,area_id),format);ospf_area_n
ssa_no_summary_set(ospf,area_id);ospf_schedule_abr_task(ospf);returnCMD_SUCCESS;
}DEFUN(no_ospf_area_nssa_no_summary,no_ospf_area_nssa_no_summary_cmd,"noarea<A.B
.C.D|(0-4294967295)>nssano-summary",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPa
ddressformat\n""OSPFareaIDasadecimalvalue\n""ConfigureOSPFareaasnssa\n""Donotinj
ectinter-arearoutesintonssa\n"){intidx_ipv4_number=2;structin_addrarea_id;intfor
mat;VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);VTY_GET_OSPF_AREA_ID_NO_BB("nssa",ar
ea_id,format,argv[idx_ipv4_number]->arg);ospf_area_display_format_set(ospf,ospf_
area_get(ospf,area_id),format);ospf_area_no_summary_unset(ospf,area_id);ospf_sch
edule_abr_task(ospf);returnCMD_SUCCESS;}DEFUN(no_ospf_area_nssa,no_ospf_area_nss
a_cmd,"noarea<A.B.C.D|(0-4294967295)>nssa[<translate-candidate|translate-never|t
ranslate-always>]",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""O
SPFareaIDasadecimalvalue\n""ConfigureOSPFareaasnssa\n""ConfigureNSSA-ABRfortrans
lateelection(default)\n""ConfigureNSSA-ABRtonevertranslate\n""ConfigureNSSA-ABRt
oalwaystranslate\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=
2;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID_NO_BB("NSSA",area_id,forma
t,argv[idx_ipv4_number]->arg);ospf_area_nssa_unset(ospf,area_id,argc);ospf_sched
ule_abr_task(ospf);returnCMD_SUCCESS;}DEFUN(ospf_area_default_cost,ospf_area_def
ault_cost_cmd,"area<A.B.C.D|(0-4294967295)>default-cost(0-16777215)","OSPFareapa
rameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Setthesu
mmary-defaultcostofaNSSAorstubarea\n""Stub'sadvertiseddefaultsummarycost\n"){VTY
_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;intidx_number=3;struct
ospf_area*area;structin_addrarea_id;uint32_tcost;intformat;structprefix_ipv4p;VT
Y_GET_OSPF_AREA_ID_NO_BB("default-cost",area_id,format,argv[idx_ipv4_number]->ar
g);cost=strtoul(argv[idx_number]->arg,NULL,10);area=ospf_area_get(ospf,area_id);
ospf_area_display_format_set(ospf,area,format);if(area->external_routing==OSPF_A
REA_DEFAULT){vty_out(vty,"Theareaisneitherstub,norNSSA\n");returnCMD_WARNING_CON
FIG_FAILED;}area->default_cost=cost;p.family=AF_INET;p.prefix.s_addr=OSPF_DEFAUL
T_DESTINATION;p.prefixlen=0;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce
_stub_defaults():""announcing0.0.0.0/0toarea%s",inet_ntoa(area->area_id));ospf_a
br_announce_network_to_area(&p,area->default_cost,area);returnCMD_SUCCESS;}DEFUN
(no_ospf_area_default_cost,no_ospf_area_default_cost_cmd,"noarea<A.B.C.D|(0-4294
967295)>default-cost(0-16777215)",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPadd
ressformat\n""OSPFareaIDasadecimalvalue\n""Setthesummary-defaultcostofaNSSAorstu
barea\n""Stub'sadvertiseddefaultsummarycost\n"){VTY_DECLVAR_INSTANCE_CONTEXT(osp
f,ospf);intidx_ipv4_number=2;structospf_area*area;structin_addrarea_id;intformat
;structprefix_ipv4p;VTY_GET_OSPF_AREA_ID_NO_BB("default-cost",area_id,format,arg
v[idx_ipv4_number]->arg);area=ospf_area_lookup_by_area_id(ospf,area_id);if(area=
=NULL)returnCMD_SUCCESS;if(area->external_routing==OSPF_AREA_DEFAULT){vty_out(vt
y,"Theareaisneitherstub,norNSSA\n");returnCMD_WARNING_CONFIG_FAILED;}area->defau
lt_cost=1;p.family=AF_INET;p.prefix.s_addr=OSPF_DEFAULT_DESTINATION;p.prefixlen=
0;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_stub_defaults():""announc
ing0.0.0.0/0toarea%s",inet_ntoa(area->area_id));ospf_abr_announce_network_to_are
a(&p,area->default_cost,area);ospf_area_check_free(ospf,area_id);returnCMD_SUCCE
SS;}DEFUN(ospf_area_export_list,ospf_area_export_list_cmd,"area<A.B.C.D|(0-42949
67295)>export-listNAME","OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OS
PFareaIDasadecimalvalue\n""Setthefilterfornetworksannouncedtootherareas\n""Nameo
ftheaccess-list\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1
;structospf_area*area;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area_i
d,format,argv[idx_ipv4_number]->arg);area=ospf_area_get(ospf,area_id);ospf_area_
display_format_set(ospf,area,format);ospf_area_export_list_set(ospf,area,argv[3]
->arg);returnCMD_SUCCESS;}DEFUN(no_ospf_area_export_list,no_ospf_area_export_lis
t_cmd,"noarea<A.B.C.D|(0-4294967295)>export-listNAME",NO_STR"OSPFareaparameters\
n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Unsetthefilterfor
networksannouncedtootherareas\n""Nameoftheaccess-list\n"){VTY_DECLVAR_INSTANCE_C
ONTEXT(ospf,ospf);intidx_ipv4_number=2;structospf_area*area;structin_addrarea_id
;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);area=
ospf_area_lookup_by_area_id(ospf,area_id);if(area==NULL)returnCMD_SUCCESS;ospf_a
rea_export_list_unset(ospf,area);returnCMD_SUCCESS;}DEFUN(ospf_area_import_list,
ospf_area_import_list_cmd,"area<A.B.C.D|(0-4294967295)>import-listNAME","OSPFare
aparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Setth
efilterfornetworksfromotherareasannouncedtothespecifiedone\n""Nameoftheaccess-li
st\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;structospf_a
rea*area;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv
[idx_ipv4_number]->arg);area=ospf_area_get(ospf,area_id);ospf_area_display_forma
t_set(ospf,area,format);ospf_area_import_list_set(ospf,area,argv[3]->arg);return
CMD_SUCCESS;}DEFUN(no_ospf_area_import_list,no_ospf_area_import_list_cmd,"noarea
<A.B.C.D|(0-4294967295)>import-listNAME",NO_STR"OSPFareaparameters\n""OSPFareaID
inIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Unsetthefilterfornetworksannou
ncedtootherareas\n""Nameoftheaccess-list\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,o
spf);intidx_ipv4_number=2;structospf_area*area;structin_addrarea_id;intformat;VT
Y_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);area=ospf_area_loo
kup_by_area_id(ospf,area_id);if(area==NULL)returnCMD_SUCCESS;ospf_area_import_li
st_unset(ospf,area);returnCMD_SUCCESS;}DEFUN(ospf_area_filter_list,ospf_area_fil
ter_list_cmd,"area<A.B.C.D|(0-4294967295)>filter-listprefixWORD<in|out>","OSPFar
eaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Filt
ernetworksbetweenOSPFareas\n""FilterprefixesbetweenOSPFareas\n""NameofanIPprefix
-list\n""Filternetworkssenttothisarea\n""Filternetworkssentfromthisarea\n"){VTY_
DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=1;intidx_word=4;intidx_in
_out=5;structospf_area*area;structin_addrarea_id;structprefix_list*plist;intform
at;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4_number]->arg);area=ospf_are
a_get(ospf,area_id);ospf_area_display_format_set(ospf,area,format);plist=prefix_
list_lookup(AFI_IP,argv[idx_word]->arg);if(strncmp(argv[idx_in_out]->arg,"in",2)
==0){PREFIX_LIST_IN(area)=plist;if(PREFIX_NAME_IN(area))free(PREFIX_NAME_IN(area
));PREFIX_NAME_IN(area)=strdup(argv[idx_word]->arg);ospf_schedule_abr_task(ospf)
;}else{PREFIX_LIST_OUT(area)=plist;if(PREFIX_NAME_OUT(area))free(PREFIX_NAME_OUT
(area));PREFIX_NAME_OUT(area)=strdup(argv[idx_word]->arg);ospf_schedule_abr_task
(ospf);}returnCMD_SUCCESS;}DEFUN(no_ospf_area_filter_list,no_ospf_area_filter_li
st_cmd,"noarea<A.B.C.D|(0-4294967295)>filter-listprefixWORD<in|out>",NO_STR"OSPF
areaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Fi
lternetworksbetweenOSPFareas\n""FilterprefixesbetweenOSPFareas\n""NameofanIPpref
ix-list\n""Filternetworkssenttothisarea\n""Filternetworkssentfromthisarea\n"){VT
Y_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=2;intidx_word=5;intidx_
in_out=6;structospf_area*area;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_I
D(area_id,format,argv[idx_ipv4_number]->arg);if((area=ospf_area_lookup_by_area_i
d(ospf,area_id))==NULL)returnCMD_SUCCESS;if(strncmp(argv[idx_in_out]->arg,"in",2
)==0){if(PREFIX_NAME_IN(area))if(strcmp(PREFIX_NAME_IN(area),argv[idx_word]->arg
)!=0)returnCMD_SUCCESS;PREFIX_LIST_IN(area)=NULL;if(PREFIX_NAME_IN(area))free(PR
EFIX_NAME_IN(area));PREFIX_NAME_IN(area)=NULL;ospf_schedule_abr_task(ospf);}else
{if(PREFIX_NAME_OUT(area))if(strcmp(PREFIX_NAME_OUT(area),argv[idx_word]->arg)!=
0)returnCMD_SUCCESS;PREFIX_LIST_OUT(area)=NULL;if(PREFIX_NAME_OUT(area))free(PRE
FIX_NAME_OUT(area));PREFIX_NAME_OUT(area)=NULL;ospf_schedule_abr_task(ospf);}ret
urnCMD_SUCCESS;}DEFUN(ospf_area_authentication_message_digest,ospf_area_authenti
cation_message_digest_cmd,"[no]area<A.B.C.D|(0-4294967295)>authenticationmessage
-digest",NO_STR"OSPFareaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDa
sadecimalvalue\n""Enableauthentication\n""Usemessage-digestauthentication\n"){VT
Y_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx=0;structospf_area*area;structin_add
rarea_id;intformat;argv_find(argv,argc,"area",&idx);VTY_GET_OSPF_AREA_ID(area_id
,format,argv[idx+1]->arg);area=ospf_area_get(ospf,area_id);ospf_area_display_for
mat_set(ospf,area,format);area->auth_type=strmatch(argv[0]->text,"no")?OSPF_AUTH
_NULL:OSPF_AUTH_CRYPTOGRAPHIC;returnCMD_SUCCESS;}DEFUN(ospf_area_authentication,
ospf_area_authentication_cmd,"area<A.B.C.D|(0-4294967295)>authentication","OSPFa
reaparameters\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Ena
bleauthentication\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number
=1;structospf_area*area;structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area
_id,format,argv[idx_ipv4_number]->arg);area=ospf_area_get(ospf,area_id);ospf_are
a_display_format_set(ospf,area,format);area->auth_type=OSPF_AUTH_SIMPLE;returnCM
D_SUCCESS;}DEFUN(no_ospf_area_authentication,no_ospf_area_authentication_cmd,"no
area<A.B.C.D|(0-4294967295)>authentication",NO_STR"OSPFareaparameters\n""OSPFare
aIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Enableauthentication\n"){VT
Y_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4_number=2;structospf_area*area;
structin_addrarea_id;intformat;VTY_GET_OSPF_AREA_ID(area_id,format,argv[idx_ipv4
_number]->arg);area=ospf_area_lookup_by_area_id(ospf,area_id);if(area==NULL)retu
rnCMD_SUCCESS;area->auth_type=OSPF_AUTH_NULL;ospf_area_check_free(ospf,area_id);
returnCMD_SUCCESS;}DEFUN(ospf_abr_type,ospf_abr_type_cmd,"ospfabr-type<cisco|ibm
|shortcut|standard>","OSPFspecificcommands\n""SetOSPFABRtype\n""AlternativeABR,c
iscoimplementation\n""AlternativeABR,IBMimplementation\n""ShortcutABR\n""Standar
dbehavior(RFC2328)\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_vendor=2;u
int8_tabr_type=OSPF_ABR_UNKNOWN;if(strncmp(argv[idx_vendor]->arg,"c",1)==0)abr_t
ype=OSPF_ABR_CISCO;elseif(strncmp(argv[idx_vendor]->arg,"i",1)==0)abr_type=OSPF_
ABR_IBM;elseif(strncmp(argv[idx_vendor]->arg,"sh",2)==0)abr_type=OSPF_ABR_SHORTC
UT;elseif(strncmp(argv[idx_vendor]->arg,"st",2)==0)abr_type=OSPF_ABR_STAND;elser
eturnCMD_WARNING_CONFIG_FAILED;/*IfABRtypevalueischanged,scheduleABRtask.*/if(os
pf->abr_type!=abr_type){ospf->abr_type=abr_type;ospf_schedule_abr_task(ospf);}re
turnCMD_SUCCESS;}DEFUN(no_ospf_abr_type,no_ospf_abr_type_cmd,"noospfabr-type<cis
co|ibm|shortcut|standard>",NO_STR"OSPFspecificcommands\n""SetOSPFABRtype\n""Alte
rnativeABR,ciscoimplementation\n""AlternativeABR,IBMimplementation\n""ShortcutAB
R\n""StandardABR\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_vendor=3;uin
t8_tabr_type=OSPF_ABR_UNKNOWN;if(strncmp(argv[idx_vendor]->arg,"c",1)==0)abr_typ
e=OSPF_ABR_CISCO;elseif(strncmp(argv[idx_vendor]->arg,"i",1)==0)abr_type=OSPF_AB
R_IBM;elseif(strncmp(argv[idx_vendor]->arg,"sh",2)==0)abr_type=OSPF_ABR_SHORTCUT
;elseif(strncmp(argv[idx_vendor]->arg,"st",2)==0)abr_type=OSPF_ABR_STAND;elseret
urnCMD_WARNING_CONFIG_FAILED;/*IfABRtypevalueischanged,scheduleABRtask.*/if(ospf
->abr_type==abr_type){ospf->abr_type=OSPF_ABR_DEFAULT;ospf_schedule_abr_task(osp
f);}returnCMD_SUCCESS;}DEFUN(ospf_log_adjacency_changes,ospf_log_adjacency_chang
es_cmd,"log-adjacency-changes","Logchangesinadjacencystate\n"){VTY_DECLVAR_INSTA
NCE_CONTEXT(ospf,ospf);SET_FLAG(ospf->config,OSPF_LOG_ADJACENCY_CHANGES);UNSET_F
LAG(ospf->config,OSPF_LOG_ADJACENCY_DETAIL);returnCMD_SUCCESS;}DEFUN(ospf_log_ad
jacency_changes_detail,ospf_log_adjacency_changes_detail_cmd,"log-adjacency-chan
gesdetail","Logchangesinadjacencystate\n""Logallstatechanges\n"){VTY_DECLVAR_INS
TANCE_CONTEXT(ospf,ospf);SET_FLAG(ospf->config,OSPF_LOG_ADJACENCY_CHANGES);SET_F
LAG(ospf->config,OSPF_LOG_ADJACENCY_DETAIL);returnCMD_SUCCESS;}DEFUN(no_ospf_log
_adjacency_changes,no_ospf_log_adjacency_changes_cmd,"nolog-adjacency-changes",N
O_STR"Logchangesinadjacencystate\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);UNS
ET_FLAG(ospf->config,OSPF_LOG_ADJACENCY_DETAIL);UNSET_FLAG(ospf->config,OSPF_LOG
_ADJACENCY_CHANGES);returnCMD_SUCCESS;}DEFUN(no_ospf_log_adjacency_changes_detai
l,no_ospf_log_adjacency_changes_detail_cmd,"nolog-adjacency-changesdetail",NO_ST
R"Logchangesinadjacencystate\n""Logallstatechanges\n"){VTY_DECLVAR_INSTANCE_CONT
EXT(ospf,ospf);UNSET_FLAG(ospf->config,OSPF_LOG_ADJACENCY_DETAIL);returnCMD_SUCC
ESS;}DEFUN(ospf_compatible_rfc1583,ospf_compatible_rfc1583_cmd,"compatiblerfc158
3","OSPFcompatibilitylist\n""compatiblewithRFC1583\n"){VTY_DECLVAR_INSTANCE_CONT
EXT(ospf,ospf);if(!CHECK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE)){SET_FLAG(os
pf->config,OSPF_RFC1583_COMPATIBLE);ospf_spf_calculate_schedule(ospf,SPF_FLAG_CO
NFIG_CHANGE);}returnCMD_SUCCESS;}DEFUN(no_ospf_compatible_rfc1583,no_ospf_compat
ible_rfc1583_cmd,"nocompatiblerfc1583",NO_STR"OSPFcompatibilitylist\n""compatibl
ewithRFC1583\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);if(CHECK_FLAG(ospf->con
fig,OSPF_RFC1583_COMPATIBLE)){UNSET_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE);o
spf_spf_calculate_schedule(ospf,SPF_FLAG_CONFIG_CHANGE);}returnCMD_SUCCESS;}ALIA
S(ospf_compatible_rfc1583,ospf_rfc1583_flag_cmd,"ospfrfc1583compatibility","OSPF
specificcommands\n""EnabletheRFC1583Compatibilityflag\n")ALIAS(no_ospf_compatibl
e_rfc1583,no_ospf_rfc1583_flag_cmd,"noospfrfc1583compatibility",NO_STR"OSPFspeci
ficcommands\n""DisabletheRFC1583Compatibilityflag\n")staticintospf_timers_spf_se
t(structvty*vty,unsignedintdelay,unsignedinthold,unsignedintmax){VTY_DECLVAR_INS
TANCE_CONTEXT(ospf,ospf);ospf->spf_delay=delay;ospf->spf_holdtime=hold;ospf->spf
_max_holdtime=max;returnCMD_SUCCESS;}DEFUN(ospf_timers_min_ls_interval,ospf_time
rs_min_ls_interval_cmd,"timersthrottlelsaall(0-5000)","Adjustroutingtimers\n""Th
rottlingadaptivetimer\n""LSAdelaybetweentransmissions\n""AllLSAtypes\n""Delay(ms
ec)betweensendingLSAs\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_number=
4;unsignedintinterval;if(argc<5){vty_out(vty,"Insufficientarguments\n");returnCM
D_WARNING_CONFIG_FAILED;}interval=strtoul(argv[idx_number]->arg,NULL,10);ospf->m
in_ls_interval=interval;returnCMD_SUCCESS;}DEFUN(no_ospf_timers_min_ls_interval,
no_ospf_timers_min_ls_interval_cmd,"notimersthrottlelsaall[(0-5000)]",NO_STR"Adj
ustroutingtimers\n""Throttlingadaptivetimer\n""LSAdelaybetweentransmissions\n""A
llLSAtypes\n""Delay(msec)betweensendingLSAs\n"){VTY_DECLVAR_INSTANCE_CONTEXT(osp
f,ospf);ospf->min_ls_interval=OSPF_MIN_LS_INTERVAL;returnCMD_SUCCESS;}DEFUN(ospf
_timers_throttle_spf,ospf_timers_throttle_spf_cmd,"timersthrottlespf(0-600000)(0
-600000)(0-600000)","Adjustroutingtimers\n""Throttlingadaptivetimer\n""OSPFSPFti
mers\n""Delay(msec)fromfirstchangereceivedtillSPFcalculation\n""Initialholdtime(
msec)betweenconsecutiveSPFcalculations\n""Maximumholdtime(msec)\n"){intidx_numbe
r=3;intidx_number_2=4;intidx_number_3=5;unsignedintdelay,hold,max;if(argc<6){vty
_out(vty,"Insufficientarguments\n");returnCMD_WARNING_CONFIG_FAILED;}delay=strto
ul(argv[idx_number]->arg,NULL,10);hold=strtoul(argv[idx_number_2]->arg,NULL,10);
max=strtoul(argv[idx_number_3]->arg,NULL,10);returnospf_timers_spf_set(vty,delay
,hold,max);}DEFUN(no_ospf_timers_throttle_spf,no_ospf_timers_throttle_spf_cmd,"n
otimersthrottlespf[(0-600000)(0-600000)(0-600000)]",NO_STR"Adjustroutingtimers\n
""Throttlingadaptivetimer\n""OSPFSPFtimers\n""Delay(msec)fromfirstchangereceived
tillSPFcalculation\n""Initialholdtime(msec)betweenconsecutiveSPFcalculations\n""
Maximumholdtime(msec)\n"){returnospf_timers_spf_set(vty,OSPF_SPF_DELAY_DEFAULT,O
SPF_SPF_HOLDTIME_DEFAULT,OSPF_SPF_MAX_HOLDTIME_DEFAULT);}DEFUN(ospf_timers_lsa_m
in_arrival,ospf_timers_lsa_min_arrival_cmd,"timerslsamin-arrival(0-600000)","Adj
ustroutingtimers\n""OSPFLSAtimers\n""MinimumdelayinreceivingnewversionofaLSA\n""
Delayinmilliseconds\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);ospf->min_ls_arr
ival=strtoul(argv[argc-1]->arg,NULL,10);returnCMD_SUCCESS;}DEFUN(no_ospf_timers_
lsa_min_arrival,no_ospf_timers_lsa_min_arrival_cmd,"notimerslsamin-arrival[(0-60
0000)]",NO_STR"Adjustroutingtimers\n""OSPFLSAtimers\n""Minimumdelayinreceivingne
wversionofaLSA\n""Delayinmilliseconds\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf
);unsignedintminarrival;if(argc>4){minarrival=strtoul(argv[argc-1]->arg,NULL,10)
;if(ospf->min_ls_arrival!=minarrival||minarrival==OSPF_MIN_LS_ARRIVAL)returnCMD_
SUCCESS;}ospf->min_ls_arrival=OSPF_MIN_LS_ARRIVAL;returnCMD_SUCCESS;}#ifCONFDATE
>20180708CPP_NOTICE("ospf:`timerslsaarrival(0-1000)`deprecated2017/07/08")#endif
ALIAS_HIDDEN(ospf_timers_lsa_min_arrival,ospf_timers_lsa_arrival_cmd,"timerslsaa
rrival(0-1000)","adjustroutingtimers\n""throttlinglinkstateadvertisementdelays\n
""ospfminimumarrivalintervaldelay\n""delay(msec)betweenacceptedlsas\n");#ifCONFD
ATE>20180708CPP_NOTICE("ospf:`notimerslsaarrival(0-1000)`deprecated2017/07/08")#
endifALIAS_HIDDEN(no_ospf_timers_lsa_min_arrival,no_ospf_timers_lsa_arrival_cmd,
"notimerslsaarrival(0-1000)",NO_STR"adjustroutingtimers\n""throttlinglinkstatead
vertisementdelays\n""ospfminimumarrivalintervaldelay\n""delay(msec)betweenaccept
edlsas\n");DEFUN(ospf_neighbor,ospf_neighbor_cmd,"neighborA.B.C.D[priority(0-255
)[poll-interval(1-65535)]]",NEIGHBOR_STR"NeighborIPaddress\n""NeighborPriority\n
""Priority\n""DeadNeighborPollinginterval\n""Seconds\n"){VTY_DECLVAR_INSTANCE_CO
NTEXT(ospf,ospf);intidx_ipv4=1;intidx_pri=3;intidx_poll=5;structin_addrnbr_addr;
unsignedintpriority=OSPF_NEIGHBOR_PRIORITY_DEFAULT;unsignedintinterval=OSPF_POLL
_INTERVAL_DEFAULT;if(!inet_aton(argv[idx_ipv4]->arg,&nbr_addr)){vty_out(vty,"Ple
asespecifyNeighborIDbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}if(argc>2)pri
ority=strtoul(argv[idx_pri]->arg,NULL,10);if(argc>4)interval=strtoul(argv[idx_po
ll]->arg,NULL,10);ospf_nbr_nbma_set(ospf,nbr_addr);if(argc>2)ospf_nbr_nbma_prior
ity_set(ospf,nbr_addr,priority);if(argc>4)ospf_nbr_nbma_poll_interval_set(ospf,n
br_addr,interval);returnCMD_SUCCESS;}DEFUN(ospf_neighbor_poll_interval,ospf_neig
hbor_poll_interval_cmd,"neighborA.B.C.Dpoll-interval(1-65535)[priority(0-255)]",
NEIGHBOR_STR"NeighborIPaddress\n""DeadNeighborPollinginterval\n""Seconds\n""OSPF
priorityofnon-broadcastneighbor\n""Priority\n"){VTY_DECLVAR_INSTANCE_CONTEXT(osp
f,ospf);intidx_ipv4=1;intidx_poll=3;intidx_pri=5;structin_addrnbr_addr;unsignedi
ntpriority=OSPF_NEIGHBOR_PRIORITY_DEFAULT;unsignedintinterval=OSPF_POLL_INTERVAL
_DEFAULT;if(!inet_aton(argv[idx_ipv4]->arg,&nbr_addr)){vty_out(vty,"Pleasespecif
yNeighborIDbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}interval=strtoul(argv[
idx_poll]->arg,NULL,10);if(argc>4)priority=strtoul(argv[idx_pri]->arg,NULL,10);o
spf_nbr_nbma_set(ospf,nbr_addr);ospf_nbr_nbma_poll_interval_set(ospf,nbr_addr,in
terval);if(argc>4)ospf_nbr_nbma_priority_set(ospf,nbr_addr,priority);returnCMD_S
UCCESS;}DEFUN(no_ospf_neighbor,no_ospf_neighbor_cmd,"noneighborA.B.C.D[priority(
0-255)[poll-interval(1-65525)]]",NO_STRNEIGHBOR_STR"NeighborIPaddress\n""Neighbo
rPriority\n""Priority\n""DeadNeighborPollinginterval\n""Seconds\n"){VTY_DECLVAR_
INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4=2;structin_addrnbr_addr;if(!inet_aton(ar
gv[idx_ipv4]->arg,&nbr_addr)){vty_out(vty,"PleasespecifyNeighborIDbyA.B.C.D\n");
returnCMD_WARNING_CONFIG_FAILED;}(void)ospf_nbr_nbma_unset(ospf,nbr_addr);return
CMD_SUCCESS;}DEFUN(no_ospf_neighbor_poll,no_ospf_neighbor_poll_cmd,"noneighborA.
B.C.Dpoll-interval(1-65535)[priority(0-255)]",NO_STRNEIGHBOR_STR"NeighborIPaddre
ss\n""DeadNeighborPollinginterval\n""Seconds\n""NeighborPriority\n""Priority\n")
{VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ipv4=2;structin_addrnbr_addr;if(
!inet_aton(argv[idx_ipv4]->arg,&nbr_addr)){vty_out(vty,"PleasespecifyNeighborIDb
yA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}(void)ospf_nbr_nbma_unset(ospf,nbr
_addr);returnCMD_SUCCESS;}DEFUN(ospf_refresh_timer,ospf_refresh_timer_cmd,"refre
shtimer(10-1800)","Adjustrefreshparameters\n""Setrefreshtimer\n""Timervalueinsec
onds\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_number=2;unsignedintinte
rval;interval=strtoul(argv[idx_number]->arg,NULL,10);interval=(interval/OSPF_LSA
_REFRESHER_GRANULARITY)*OSPF_LSA_REFRESHER_GRANULARITY;ospf_timers_refresh_set(o
spf,interval);returnCMD_SUCCESS;}DEFUN(no_ospf_refresh_timer,no_ospf_refresh_tim
er_val_cmd,"norefreshtimer[(10-1800)]",NO_STR"Adjustrefreshparameters\n""Unsetre
freshtimer\n""Timervalueinseconds\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);in
tidx_number=3;unsignedintinterval;if(argc==1){interval=strtoul(argv[idx_number]-
>arg,NULL,10);if(ospf->lsa_refresh_interval!=interval||interval==OSPF_LSA_REFRES
H_INTERVAL_DEFAULT)returnCMD_SUCCESS;}ospf_timers_refresh_unset(ospf);returnCMD_
SUCCESS;}DEFUN(ospf_auto_cost_reference_bandwidth,ospf_auto_cost_reference_bandw
idth_cmd,"auto-costreference-bandwidth(1-4294967)","CalculateOSPFinterfacecostac
cordingtobandwidth\n""UsereferencebandwidthmethodtoassignOSPFcost\n""Thereferenc
ebandwidthintermsofMbitspersecond\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);st
ructvrf*vrf=vrf_lookup_by_id(ospf->vrf_id);intidx_number=2;uint32_trefbw;structi
nterface*ifp;refbw=strtol(argv[idx_number]->arg,NULL,10);if(refbw<1||refbw>42949
67){vty_out(vty,"reference-bandwidthvalueisinvalid\n");returnCMD_WARNING_CONFIG_
FAILED;}/*Ifreferencebandwidthischanged.*/if((refbw)==ospf->ref_bandwidth)return
CMD_SUCCESS;ospf->ref_bandwidth=refbw;FOR_ALL_INTERFACES(vrf,ifp)ospf_if_recalcu
late_output_cost(ifp);returnCMD_SUCCESS;}DEFUN(no_ospf_auto_cost_reference_bandw
idth,no_ospf_auto_cost_reference_bandwidth_cmd,"noauto-costreference-bandwidth[(
1-4294967)]",NO_STR"CalculateOSPFinterfacecostaccordingtobandwidth\n""Usereferen
cebandwidthmethodtoassignOSPFcost\n""ThereferencebandwidthintermsofMbitspersecon
d\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);structvrf*vrf=vrf_lookup_by_id(osp
f->vrf_id);structinterface*ifp;if(ospf->ref_bandwidth==OSPF_DEFAULT_REF_BANDWIDT
H)returnCMD_SUCCESS;ospf->ref_bandwidth=OSPF_DEFAULT_REF_BANDWIDTH;vty_out(vty,"
%%OSPF:Referencebandwidthischanged.\n");vty_out(vty,"Pleaseensurereferencebandwi
dthisconsistentacrossallrouters\n");FOR_ALL_INTERFACES(vrf,ifp)ospf_if_recalcula
te_output_cost(ifp);returnCMD_SUCCESS;}DEFUN(ospf_write_multiplier,ospf_write_mu
ltiplier_cmd,"ospfwrite-multiplier(1-100)","OSPFspecificcommands\n""Writemultipl
ier\n""Maximumnumberofinterfaceservicedperwrite\n"){VTY_DECLVAR_INSTANCE_CONTEXT
(ospf,ospf);intidx_number;uint32_twrite_oi_count;if(argc==3)idx_number=2;elseidx
_number=1;write_oi_count=strtol(argv[idx_number]->arg,NULL,10);if(write_oi_count
<1||write_oi_count>100){vty_out(vty,"write-multipliervalueisinvalid\n");returnCM
D_WARNING_CONFIG_FAILED;}ospf->write_oi_count=write_oi_count;returnCMD_SUCCESS;}
ALIAS(ospf_write_multiplier,write_multiplier_cmd,"write-multiplier(1-100)","Writ
emultiplier\n""Maximumnumberofinterfaceservicedperwrite\n")DEFUN(no_ospf_write_m
ultiplier,no_ospf_write_multiplier_cmd,"noospfwrite-multiplier(1-100)",NO_STR"OS
PFspecificcommands\n""Writemultiplier\n""Maximumnumberofinterfaceservicedperwrit
e\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);ospf->write_oi_count=OSPF_WRITE_IN
TERFACE_COUNT_DEFAULT;returnCMD_SUCCESS;}ALIAS(no_ospf_write_multiplier,no_write
_multiplier_cmd,"nowrite-multiplier(1-100)",NO_STR"Writemultiplier\n""Maximumnum
berofinterfaceservicedperwrite\n")constchar*ospf_abr_type_descr_str[]={"Unknown"
,"Standard(RFC2328)","AlternativeIBM","AlternativeCisco","AlternativeShortcut"};
constchar*ospf_shortcut_mode_descr_str[]={"Default","Enabled","Disabled"};static
voidshow_ip_ospf_area(structvty*vty,structospf_area*area,json_object*json_areas,
uint8_tuse_json){json_object*json_area=NULL;if(use_json)json_area=json_object_ne
w_object();/*ShowAreaID.*/if(!use_json)vty_out(vty,"AreaID:%s",inet_ntoa(area->a
rea_id));/*ShowAreatype/mode.*/if(OSPF_IS_AREA_BACKBONE(area)){if(use_json)json_
object_boolean_true_add(json_area,"backbone");elsevty_out(vty,"(Backbone)\n");}e
lse{if(use_json){if(area->external_routing==OSPF_AREA_STUB){if(area->no_summary)
json_object_boolean_true_add(json_area,"stubNoSummary");if(area->shortcut_config
ured)json_object_boolean_true_add(json_area,"stubShortcut");}elseif(area->extern
al_routing==OSPF_AREA_NSSA){if(area->no_summary)json_object_boolean_true_add(jso
n_area,"nssaNoSummary");if(area->shortcut_configured)json_object_boolean_true_ad
d(json_area,"nssaShortcut");}json_object_string_add(json_area,"shortcuttingMode"
,ospf_shortcut_mode_descr_str[area->shortcut_configured]);if(area->shortcut_capa
bility)json_object_boolean_true_add(json_area,"sBitConcensus");}else{if(area->ex
ternal_routing==OSPF_AREA_STUB)vty_out(vty,"(Stub%s%s)",area->no_summary?",nosum
mary":"",area->shortcut_configured?";":"");elseif(area->external_routing==OSPF_A
REA_NSSA)vty_out(vty,"(NSSA%s%s)",area->no_summary?",nosummary":"",area->shortcu
t_configured?";":"");vty_out(vty,"\n");vty_out(vty,"Shortcuttingmode:%s",ospf_sh
ortcut_mode_descr_str[area->shortcut_configured]);vty_out(vty,",S-bitconsensus:%
s\n",area->shortcut_capability?"ok":"no");}}/*Shownumberofinterfaces*/if(use_jso
n){json_object_int_add(json_area,"areaIfTotalCounter",listcount(area->oiflist));
json_object_int_add(json_area,"areaIfActiveCounter",area->act_ints);}elsevty_out
(vty,"Numberofinterfacesinthisarea:Total:%d,""Active:%d\n",listcount(area->oifli
st),area->act_ints);if(area->external_routing==OSPF_AREA_NSSA){if(use_json){json
_object_boolean_true_add(json_area,"nssa");if(!IS_OSPF_ABR(area->ospf))json_obje
ct_boolean_false_add(json_area,"abr");elseif(area->NSSATranslatorState){json_obj
ect_boolean_true_add(json_area,"abr");if(area->NSSATranslatorRole==OSPF_NSSA_ROL
E_CANDIDATE)json_object_boolean_true_add(json_area,"nssaTranslatorElected");else
if(area->NSSATranslatorRole==OSPF_NSSA_ROLE_ALWAYS)json_object_boolean_true_add(
json_area,"nssaTranslatorAlways");}else{json_object_boolean_true_add(json_area,"
abr");if(area->NSSATranslatorRole==OSPF_NSSA_ROLE_CANDIDATE)json_object_boolean_
false_add(json_area,"nssaTranslatorElected");elsejson_object_boolean_true_add(js
on_area,"nssaTranslatorNever");}}else{vty_out(vty,"ItisanNSSAconfiguration.\nEle
ctedNSSA/ABRperformstype-7/type-5LSAtranslation.\n");if(!IS_OSPF_ABR(area->ospf)
)vty_out(vty,"ItisnotABR,thereforenotTranslator.\n");elseif(area->NSSATranslator
State){vty_out(vty,"WeareanABRand");if(area->NSSATranslatorRole==OSPF_NSSA_ROLE_
CANDIDATE)vty_out(vty,"theNSSAElectedTranslator.\n");elseif(area->NSSATranslator
Role==OSPF_NSSA_ROLE_ALWAYS)vty_out(vty,"alwaysanNSSATranslator.\n");}else{vty_o
ut(vty,"WeareanABR,but");if(area->NSSATranslatorRole==OSPF_NSSA_ROLE_CANDIDATE)v
ty_out(vty,"nottheNSSAElectedTranslator.\n");elsevty_out(vty,"neveranNSSATransla
tor.\n");}}}/*Stub-routerstateforthisarea*/if(CHECK_FLAG(area->stub_router_state
,OSPF_AREA_IS_STUB_ROUTED)){chartimebuf[OSPF_TIME_DUMP_SIZE];if(use_json){json_o
bject_boolean_true_add(json_area,"originStubMaxDistRouterLsa");if(CHECK_FLAG(are
a->stub_router_state,OSPF_AREA_ADMIN_STUB_ROUTED))json_object_boolean_true_add(j
son_area,"indefiniteActiveAdmin");if(area->t_stub_router){longtime_store;time_st
ore=monotime_until(&area->t_stub_router->u.sands,NULL)/1000LL;json_object_int_ad
d(json_area,"activeStartupRemainderMsecs",time_store);}}else{vty_out(vty,"Origin
atingstub/maximum-distanceRouter-LSA\n");if(CHECK_FLAG(area->stub_router_state,O
SPF_AREA_ADMIN_STUB_ROUTED))vty_out(vty,"Administrativelyactivated(indefinitely)
\n");if(area->t_stub_router)vty_out(vty,"Activefromstartup,%sremaining\n",ospf_t
imer_dump(area->t_stub_router,timebuf,sizeof(timebuf)));}}if(use_json){/*Shownum
beroffullyadjacentneighbors.*/json_object_int_add(json_area,"nbrFullAdjacentCoun
ter",area->full_nbrs);/*Showauthenticationtype.*/if(area->auth_type==OSPF_AUTH_N
ULL)json_object_string_add(json_area,"authentication","authenticationNone");else
if(area->auth_type==OSPF_AUTH_SIMPLE)json_object_string_add(json_area,"authentic
ation","authenticationSimplePassword");elseif(area->auth_type==OSPF_AUTH_CRYPTOG
RAPHIC)json_object_string_add(json_area,"authentication","authenticationMessageD
igest");if(!OSPF_IS_AREA_BACKBONE(area))json_object_int_add(json_area,"virtualAd
jacenciesPassingCounter",area->full_vls);/*ShowSPFcalculationtimes.*/json_object
_int_add(json_area,"spfExecutedCounter",area->spf_calculation);json_object_int_a
dd(json_area,"lsaNumber",area->lsdb->total);json_object_int_add(json_area,"lsaRo
uterNumber",ospf_lsdb_count(area->lsdb,OSPF_ROUTER_LSA));json_object_int_add(jso
n_area,"lsaRouterChecksum",ospf_lsdb_checksum(area->lsdb,OSPF_ROUTER_LSA));json_
object_int_add(json_area,"lsaNetworkNumber",ospf_lsdb_count(area->lsdb,OSPF_NETW
ORK_LSA));json_object_int_add(json_area,"lsaNetworkChecksum",ospf_lsdb_checksum(
area->lsdb,OSPF_NETWORK_LSA));json_object_int_add(json_area,"lsaSummaryNumber",o
spf_lsdb_count(area->lsdb,OSPF_SUMMARY_LSA));json_object_int_add(json_area,"lsaS
ummaryChecksum",ospf_lsdb_checksum(area->lsdb,OSPF_SUMMARY_LSA));json_object_int
_add(json_area,"lsaAsbrNumber",ospf_lsdb_count(area->lsdb,OSPF_ASBR_SUMMARY_LSA)
);json_object_int_add(json_area,"lsaAsbrChecksum",ospf_lsdb_checksum(area->lsdb,
OSPF_ASBR_SUMMARY_LSA));json_object_int_add(json_area,"lsaNssaNumber",ospf_lsdb_
count(area->lsdb,OSPF_AS_NSSA_LSA));json_object_int_add(json_area,"lsaNssaChecks
um",ospf_lsdb_checksum(area->lsdb,OSPF_AS_NSSA_LSA));}else{/*Shownumberoffullyad
jacentneighbors.*/vty_out(vty,"Numberoffullyadjacentneighborsinthisarea:""%d\n",
area->full_nbrs);/*Showauthenticationtype.*/vty_out(vty,"Areahas");if(area->auth
_type==OSPF_AUTH_NULL)vty_out(vty,"noauthentication\n");elseif(area->auth_type==
OSPF_AUTH_SIMPLE)vty_out(vty,"simplepasswordauthentication\n");elseif(area->auth
_type==OSPF_AUTH_CRYPTOGRAPHIC)vty_out(vty,"messagedigestauthentication\n");if(!
OSPF_IS_AREA_BACKBONE(area))vty_out(vty,"Numberoffullvirtualadjacenciesgoingthro
ugh""thisarea:%d\n",area->full_vls);/*ShowSPFcalculationtimes.*/vty_out(vty,"SPF
algorithmexecuted%dtimes\n",area->spf_calculation);/*ShownumberofLSA.*/vty_out(v
ty,"NumberofLSA%ld\n",area->lsdb->total);vty_out(vty,"NumberofrouterLSA%ld.Check
sumSum0x%08x\n",ospf_lsdb_count(area->lsdb,OSPF_ROUTER_LSA),ospf_lsdb_checksum(a
rea->lsdb,OSPF_ROUTER_LSA));vty_out(vty,"NumberofnetworkLSA%ld.ChecksumSum0x%08x
\n",ospf_lsdb_count(area->lsdb,OSPF_NETWORK_LSA),ospf_lsdb_checksum(area->lsdb,O
SPF_NETWORK_LSA));vty_out(vty,"NumberofsummaryLSA%ld.ChecksumSum0x%08x\n",ospf_l
sdb_count(area->lsdb,OSPF_SUMMARY_LSA),ospf_lsdb_checksum(area->lsdb,OSPF_SUMMAR
Y_LSA));vty_out(vty,"NumberofASBRsummaryLSA%ld.ChecksumSum0x%08x\n",ospf_lsdb_co
unt(area->lsdb,OSPF_ASBR_SUMMARY_LSA),ospf_lsdb_checksum(area->lsdb,OSPF_ASBR_SU
MMARY_LSA));vty_out(vty,"NumberofNSSALSA%ld.ChecksumSum0x%08x\n",ospf_lsdb_count
(area->lsdb,OSPF_AS_NSSA_LSA),ospf_lsdb_checksum(area->lsdb,OSPF_AS_NSSA_LSA));}
if(use_json){json_object_int_add(json_area,"lsaOpaqueLinkNumber",ospf_lsdb_count
(area->lsdb,OSPF_OPAQUE_LINK_LSA));json_object_int_add(json_area,"lsaOpaqueLinkC
hecksum",ospf_lsdb_checksum(area->lsdb,OSPF_OPAQUE_LINK_LSA));json_object_int_ad
d(json_area,"lsaOpaqueAreaNumber",ospf_lsdb_count(area->lsdb,OSPF_OPAQUE_AREA_LS
A));json_object_int_add(json_area,"lsaOpaqueAreaChecksum",ospf_lsdb_checksum(are
a->lsdb,OSPF_OPAQUE_AREA_LSA));}else{vty_out(vty,"NumberofopaquelinkLSA%ld.Check
sumSum0x%08x\n",ospf_lsdb_count(area->lsdb,OSPF_OPAQUE_LINK_LSA),ospf_lsdb_check
sum(area->lsdb,OSPF_OPAQUE_LINK_LSA));vty_out(vty,"NumberofopaqueareaLSA%ld.Chec
ksumSum0x%08x\n",ospf_lsdb_count(area->lsdb,OSPF_OPAQUE_AREA_LSA),ospf_lsdb_chec
ksum(area->lsdb,OSPF_OPAQUE_AREA_LSA));}if(use_json)json_object_object_add(json_
areas,inet_ntoa(area->area_id),json_area);elsevty_out(vty,"\n");}staticintshow_i
p_ospf_common(structvty*vty,structospf*ospf,json_object*json,uint8_tuse_vrf){str
uctlistnode*node,*nnode;structospf_area*area;structtimevalresult;chartimebuf[OSP
F_TIME_DUMP_SIZE];json_object*json_vrf=NULL;json_object*json_areas=NULL;if(json)
{if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;json_areas=json_
object_new_object();}if(ospf->instance){if(json){json_object_int_add(json,"ospfI
nstance",ospf->instance);}else{vty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instanc
e);}}ospf_show_vrf_name(ospf,vty,json_vrf,use_vrf);/*ShowRouterID.*/if(json){jso
n_object_string_add(json_vrf,"routerId",inet_ntoa(ospf->router_id));}else{vty_ou
t(vty,"OSPFRoutingProcess,RouterID:%s\n",inet_ntoa(ospf->router_id));}/*Graceful
shutdown*/if(ospf->t_deferred_shutdown){if(json){longtime_store;time_store=monot
ime_until(&ospf->t_deferred_shutdown->u.sands,NULL)/1000LL;json_object_int_add(j
son_vrf,"deferredShutdownMsecs",time_store);}else{vty_out(vty,"Deferredshutdowni
nprogress,%sremaining\n",ospf_timer_dump(ospf->t_deferred_shutdown,timebuf,sizeo
f(timebuf)));}}/*Showcapability.*/if(json){json_object_boolean_true_add(json_vrf
,"tosRoutesOnly");json_object_boolean_true_add(json_vrf,"rfc2328Conform");if(CHE
CK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE)){json_object_boolean_true_add(json
_vrf,"rfc1583Compatibility");}}else{vty_out(vty,"SupportsonlysingleTOS(TOS0)rout
es\n");vty_out(vty,"ThisimplementationconformstoRFC2328\n");vty_out(vty,"RFC1583
Compatibilityflagis%s\n",CHECK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE)?"enabl
ed":"disabled");}if(json){if(CHECK_FLAG(ospf->config,OSPF_OPAQUE_CAPABLE)){json_
object_boolean_true_add(json_vrf,"opaqueCapable");}}else{vty_out(vty,"OpaqueCapa
bilityflagis%s\n",CHECK_FLAG(ospf->config,OSPF_OPAQUE_CAPABLE)?"enabled":"disabl
ed");}/*Showstub-routerconfiguration*/if(ospf->stub_router_startup_time!=OSPF_ST
UB_ROUTER_UNCONFIGURED||ospf->stub_router_shutdown_time!=OSPF_STUB_ROUTER_UNCONF
IGURED){if(json){json_object_boolean_true_add(json_vrf,"stubAdvertisement");if(o
spf->stub_router_startup_time!=OSPF_STUB_ROUTER_UNCONFIGURED)json_object_int_add
(json_vrf,"postStartEnabledMsecs",ospf->stub_router_startup_time/1000);if(ospf->
stub_router_shutdown_time!=OSPF_STUB_ROUTER_UNCONFIGURED)json_object_int_add(jso
n_vrf,"preShutdownEnabledMsecs",ospf->stub_router_shutdown_time/1000);}else{vty_
out(vty,"Stubrouteradvertisementisconfigured\n");if(ospf->stub_router_startup_ti
me!=OSPF_STUB_ROUTER_UNCONFIGURED)vty_out(vty,"Enabledfor%usafterstart-up\n",osp
f->stub_router_startup_time);if(ospf->stub_router_shutdown_time!=OSPF_STUB_ROUTE
R_UNCONFIGURED)vty_out(vty,"Enabledfor%uspriortofullshutdown\n",ospf->stub_route
r_shutdown_time);}}/*ShowSPFtimers.*/if(json){json_object_int_add(json_vrf,"spfS
cheduleDelayMsecs",ospf->spf_delay);json_object_int_add(json_vrf,"holdtimeMinMse
cs",ospf->spf_holdtime);json_object_int_add(json_vrf,"holdtimeMaxMsecs",ospf->sp
f_max_holdtime);json_object_int_add(json_vrf,"holdtimeMultplier",ospf->spf_hold_
multiplier);}else{vty_out(vty,"InitialSPFschedulingdelay%dmillisec(s)\n""Minimum
holdtimebetweenconsecutiveSPFs%dmillisec(s)\n""Maximumholdtimebetweenconsecutive
SPFs%dmillisec(s)\n""Holdtimemultiplieriscurrently%d\n",ospf->spf_delay,ospf->sp
f_holdtime,ospf->spf_max_holdtime,ospf->spf_hold_multiplier);}if(json){if(ospf->
ts_spf.tv_sec||ospf->ts_spf.tv_usec){longtime_store=0;time_store=monotime_since(
&ospf->ts_spf,NULL)/1000LL;json_object_int_add(json_vrf,"spfLastExecutedMsecs",t
ime_store);time_store=(1000*ospf->ts_spf_duration.tv_sec)+(ospf->ts_spf_duration
.tv_usec/1000);json_object_int_add(json_vrf,"spfLastDurationMsecs",time_store);}
elsejson_object_boolean_true_add(json_vrf,"spfHasNotRun");}else{vty_out(vty,"SPF
algorithm");if(ospf->ts_spf.tv_sec||ospf->ts_spf.tv_usec){monotime_since(&ospf->
ts_spf,&result);vty_out(vty,"lastexecuted%sago\n",ospf_timeval_dump(&result,time
buf,sizeof(timebuf)));vty_out(vty,"LastSPFduration%s\n",ospf_timeval_dump(&ospf-
>ts_spf_duration,timebuf,sizeof(timebuf)));}elsevty_out(vty,"hasnotbeenrun\n");}
if(json){if(ospf->t_spf_calc){longtime_store;time_store=monotime_until(&ospf->t_
spf_calc->u.sands,NULL)/1000LL;json_object_int_add(json_vrf,"spfTimerDueInMsecs"
,time_store);}json_object_int_add(json_vrf,"lsaMinIntervalMsecs",ospf->min_ls_in
terval);json_object_int_add(json_vrf,"lsaMinArrivalMsecs",ospf->min_ls_arrival);
/*Showwritemultipliervalues*/json_object_int_add(json_vrf,"writeMultiplier",ospf
->write_oi_count);/*Showrefreshparameters.*/json_object_int_add(json_vrf,"refres
hTimerMsecs",ospf->lsa_refresh_interval*1000);}else{vty_out(vty,"SPFtimer%s%s\n"
,(ospf->t_spf_calc?"duein":"is"),ospf_timer_dump(ospf->t_spf_calc,timebuf,sizeof
(timebuf)));vty_out(vty,"LSAminimuminterval%dmsecs\n",ospf->min_ls_interval);vty
_out(vty,"LSAminimumarrival%dmsecs\n",ospf->min_ls_arrival);/*Showwritemultiplie
rvalues*/vty_out(vty,"WriteMultipliersetto%d\n",ospf->write_oi_count);/*Showrefr
eshparameters.*/vty_out(vty,"Refreshtimer%dsecs\n",ospf->lsa_refresh_interval);}
/*ShowABR/ASBRflags.*/if(CHECK_FLAG(ospf->flags,OSPF_FLAG_ABR)){if(json)json_obj
ect_string_add(json_vrf,"abrType",ospf_abr_type_descr_str[ospf->abr_type]);elsev
ty_out(vty,"ThisrouterisanABR,ABRtypeis:%s\n",ospf_abr_type_descr_str[ospf->abr_
type]);}if(CHECK_FLAG(ospf->flags,OSPF_FLAG_ASBR)){if(json)json_object_string_ad
d(json_vrf,"asbrRouter","injectingExternalRoutingInformation");elsevty_out(vty,"
ThisrouterisanASBR""(injectingexternalroutinginformation)\n");}/*ShowNumberofAS-
external-LSAs.*/if(json){json_object_int_add(json_vrf,"lsaExternalCounter",ospf_
lsdb_count(ospf->lsdb,OSPF_AS_EXTERNAL_LSA));json_object_int_add(json_vrf,"lsaEx
ternalChecksum",ospf_lsdb_checksum(ospf->lsdb,OSPF_AS_EXTERNAL_LSA));}else{vty_o
ut(vty,"NumberofexternalLSA%ld.ChecksumSum0x%08x\n",ospf_lsdb_count(ospf->lsdb,O
SPF_AS_EXTERNAL_LSA),ospf_lsdb_checksum(ospf->lsdb,OSPF_AS_EXTERNAL_LSA));}if(js
on){json_object_int_add(json_vrf,"lsaAsopaqueCounter",ospf_lsdb_count(ospf->lsdb
,OSPF_OPAQUE_AS_LSA));json_object_int_add(json_vrf,"lsaAsOpaqueChecksum",ospf_ls
db_checksum(ospf->lsdb,OSPF_OPAQUE_AS_LSA));}else{vty_out(vty,"NumberofopaqueASL
SA%ld.ChecksumSum0x%08x\n",ospf_lsdb_count(ospf->lsdb,OSPF_OPAQUE_AS_LSA),ospf_l
sdb_checksum(ospf->lsdb,OSPF_OPAQUE_AS_LSA));}/*Shownumberofareasattached.*/if(j
son)json_object_int_add(json_vrf,"attachedAreaCounter",listcount(ospf->areas));e
lsevty_out(vty,"Numberofareasattachedtothisrouter:%d\n",listcount(ospf->areas));
if(CHECK_FLAG(ospf->config,OSPF_LOG_ADJACENCY_CHANGES)){if(CHECK_FLAG(ospf->conf
ig,OSPF_LOG_ADJACENCY_DETAIL)){if(json)json_object_boolean_true_add(json_vrf,"ad
jacencyChangesLoggedAll");elsevty_out(vty,"Alladjacencychangesarelogged\n");}els
e{if(json)json_object_boolean_true_add(json_vrf,"adjacencyChangesLogged");elsevt
y_out(vty,"Adjacencychangesarelogged\n");}}/*Showeachareastatus.*/for(ALL_LIST_E
LEMENTS(ospf->areas,node,nnode,area))show_ip_ospf_area(vty,area,json_areas,json?
1:0);if(json){if(use_vrf){json_object_object_add(json_vrf,"areas",json_areas);if
(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(json,"default",json_vrf);elsej
son_object_object_add(json,ospf->name,json_vrf);}else{json_object_object_add(jso
n,"areas",json_areas);}}elsevty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ip_o
spf,show_ip_ospf_cmd,"showipospf[vrf<NAME|all>][json]",SHOW_STRIP_STR"OSPFinform
ation\n"VRF_CMD_HELP_STR"AllVRFs\n"JSON_STR){structospf*ospf;uint8_tuj=use_json(
argc,argv);structlistnode*node=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;intret=
CMD_SUCCESS;intinst=0;intidx_vrf=0;json_object*json=NULL;uint8_tuse_vrf=0;if(lis
tcount(om->ospf)==0)returnCMD_SUCCESS;OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_n
ame,all_vrf);if(uj)json=json_object_new_object();/*vrfinputisprovidedcouldbeallo
rspecificvrf*/if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->os
pf,node,ospf)){if(!ospf->oi_running)continue;ret=show_ip_ospf_common(vty,ospf,js
on,use_vrf);}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_
C_TO_STRING_PRETTY));json_object_free(json);}returnret;}ospf=ospf_lookup_by_inst
_name(inst,vrf_name);if((ospf==NULL)||!ospf->oi_running){if(uj)json_object_free(
json);returnCMD_SUCCESS;}}else{ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);/*Display
defaultospf(instance0)info*/if(ospf==NULL||!ospf->oi_running){if(uj)json_object_
free(json);returnCMD_SUCCESS;}}if(ospf){show_ip_ospf_common(vty,ospf,json,use_vr
f);if(uj)vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING
_PRETTY));}if(uj)json_object_free(json);returnret;}DEFUN(show_ip_ospf_instance,s
how_ip_ospf_instance_cmd,"showipospf(1-65535)[json]",SHOW_STRIP_STR"OSPFinformat
ion\n""InstanceID\n"JSON_STR){intidx_number=3;structospf*ospf;unsignedshortinsta
nce=0;uint8_tuj=use_json(argc,argv);intret=CMD_SUCCESS;json_object*json=NULL;ins
tance=strtoul(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance)
;if(ospf==NULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;
if(uj)json=json_object_new_object();ret=show_ip_ospf_common(vty,ospf,json,0);if(
uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRET
TY));json_object_free(json);}returnret;}staticvoidshow_ip_ospf_interface_sub(str
uctvty*vty,structospf*ospf,structinterface*ifp,json_object*json_interface_sub,ui
nt8_tuse_json){intis_up;structospf_neighbor*nbr;structroute_node*rn;uint32_tband
width=ifp->bandwidth?ifp->bandwidth:ifp->speed;/*Isinterfaceup?*/if(use_json){is
_up=if_is_operative(ifp);if(is_up)json_object_boolean_true_add(json_interface_su
b,"ifUp");elsejson_object_boolean_false_add(json_interface_sub,"ifDown");json_ob
ject_int_add(json_interface_sub,"ifIndex",ifp->ifindex);json_object_int_add(json
_interface_sub,"mtuBytes",ifp->mtu);json_object_int_add(json_interface_sub,"band
widthMbit",bandwidth);json_object_string_add(json_interface_sub,"ifFlags",if_fla
g_dump(ifp->flags));}else{vty_out(vty,"%sis%s\n",ifp->name,((is_up=if_is_operati
ve(ifp))?"up":"down"));vty_out(vty,"ifindex%u,MTU%ubytes,BW%uMbit%s\n",ifp->ifin
dex,ifp->mtu,bandwidth,if_flag_dump(ifp->flags));}/*IsinterfaceOSPFenabled?*/if(
use_json){if(ospf_oi_count(ifp)==0){json_object_boolean_false_add(json_interface
_sub,"ospfEnabled");return;}elseif(!is_up){json_object_boolean_false_add(json_in
terface_sub,"ospfRunning");return;}elsejson_object_boolean_true_add(json_interfa
ce_sub,"ospfEnabled");}else{if(ospf_oi_count(ifp)==0){vty_out(vty,"OSPFnotenable
donthisinterface\n");return;}elseif(!is_up){vty_out(vty,"OSPFisenabled,butnotrun
ningonthisinterface\n");return;}}for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next
(rn)){structospf_interface*oi=rn->info;if(oi==NULL)continue;if(CHECK_FLAG(oi->co
nnected->flags,ZEBRA_IFA_UNNUMBERED)){if(use_json)json_object_boolean_true_add(j
son_interface_sub,"ifUnnumbered");elsevty_out(vty,"ThisinterfaceisUNNUMBERED,");
}else{/*ShowOSPFinterfaceinformation.*/if(use_json){json_object_string_add(json_
interface_sub,"ipAddress",inet_ntoa(oi->address->u.prefix4));json_object_int_add
(json_interface_sub,"ipAddressPrefixlen",oi->address->prefixlen);}elsevty_out(vt
y,"InternetAddress%s/%d,",inet_ntoa(oi->address->u.prefix4),oi->address->prefixl
en);if(oi->connected->destination||oi->type==OSPF_IFTYPE_VIRTUALLINK){structin_a
ddr*dest;constchar*dstr;if(CONNECTED_PEER(oi->connected)||oi->type==OSPF_IFTYPE_
VIRTUALLINK)dstr="Peer";elsedstr="Broadcast";/*ForVlinks,showingthepeeraddressis
*probablymore*****informativethanthelocal*interfacethatisbeingused*****/if(oi->t
ype==OSPF_IFTYPE_VIRTUALLINK)dest=&oi->vl_data->peer_addr;elsedest=&oi->connecte
d->destination->u.prefix4;if(use_json){json_object_string_add(json_interface_sub
,"ospfIfType",dstr);if(oi->type==OSPF_IFTYPE_VIRTUALLINK)json_object_string_add(
json_interface_sub,"vlinkPeer",inet_ntoa(*dest));elsejson_object_string_add(json
_interface_sub,"localIfUsed",inet_ntoa(*dest));}elsevty_out(vty,"%s%s,",dstr,ine
t_ntoa(*dest));}}if(use_json){json_object_string_add(json_interface_sub,"area",o
spf_area_desc_string(oi->area));if(OSPF_IF_PARAM(oi,mtu_ignore))json_object_bool
ean_true_add(json_interface_sub,"mtuMismatchDetect");json_object_string_add(json
_interface_sub,"routerId",inet_ntoa(ospf->router_id));json_object_string_add(jso
n_interface_sub,"networkType",ospf_network_type_str[oi->type]);json_object_int_a
dd(json_interface_sub,"cost",oi->output_cost);json_object_int_add(json_interface
_sub,"transmitDelayMsecs",1000/OSPF_IF_PARAM(oi,transmit_delay));json_object_str
ing_add(json_interface_sub,"state",lookup_msg(ospf_ism_state_msg,oi->state,NULL)
);json_object_int_add(json_interface_sub,"priority",PRIORITY(oi));}else{vty_out(
vty,"Area%s\n",ospf_area_desc_string(oi->area));vty_out(vty,"MTUmismatchdetectio
n:%s\n",OSPF_IF_PARAM(oi,mtu_ignore)?"disabled":"enabled");vty_out(vty,"RouterID
%s,NetworkType%s,Cost:%d\n",inet_ntoa(ospf->router_id),ospf_network_type_str[oi-
>type],oi->output_cost);vty_out(vty,"TransmitDelayis%dsec,State%s,Priority%d\n",
OSPF_IF_PARAM(oi,transmit_delay),lookup_msg(ospf_ism_state_msg,oi->state,NULL),P
RIORITY(oi));}/*ShowDRinformation.*/if(DR(oi).s_addr==0){if(!use_json)vty_out(vt
y,"Nobackupdesignatedrouteronthisnetwork\n");}else{nbr=ospf_nbr_lookup_by_addr(o
i->nbrs,&BDR(oi));if(nbr==NULL){if(!use_json)vty_out(vty,"Nobackupdesignatedrout
eronthisnetwork\n");}else{if(use_json){json_object_string_add(json_interface_sub
,"bdrId",inet_ntoa(nbr->router_id));json_object_string_add(json_interface_sub,"b
drAddress",inet_ntoa(nbr->address.u.prefix4));}else{vty_out(vty,"BackupDesignate
dRouter(ID)%s,",inet_ntoa(nbr->router_id));vty_out(vty,"InterfaceAddress%s\n",in
et_ntoa(nbr->address.u.prefix4));}}}/*Nextnetwork-LSAsequencenumberwe'lluse,ifwe
'reelected*DR*/if(oi->params&&ntohl(oi->params->network_lsa_seqnum)!=OSPF_INITIA
L_SEQUENCE_NUMBER){if(use_json)json_object_int_add(json_interface_sub,"networkLs
aSequence",ntohl(oi->params->network_lsa_seqnum));elsevty_out(vty,"SavedNetwork-
LSAsequencenumber0x%x\n",ntohl(oi->params->network_lsa_seqnum));}if(use_json){if
(OI_MEMBER_CHECK(oi,MEMBER_ALLROUTERS)||OI_MEMBER_CHECK(oi,MEMBER_DROUTERS)){if(
OI_MEMBER_CHECK(oi,MEMBER_ALLROUTERS))json_object_boolean_true_add(json_interfac
e_sub,"mcastMemberOspfAllRouters");if(OI_MEMBER_CHECK(oi,MEMBER_DROUTERS))json_o
bject_boolean_true_add(json_interface_sub,"mcastMemberOspfDesignatedRouters");}}
else{vty_out(vty,"Multicastgroupmemberships:");if(OI_MEMBER_CHECK(oi,MEMBER_ALLR
OUTERS)||OI_MEMBER_CHECK(oi,MEMBER_DROUTERS)){if(OI_MEMBER_CHECK(oi,MEMBER_ALLRO
UTERS))vty_out(vty,"OSPFAllRouters");if(OI_MEMBER_CHECK(oi,MEMBER_DROUTERS))vty_
out(vty,"OSPFDesignatedRouters");}elsevty_out(vty,"<None>");vty_out(vty,"\n");}i
f(use_json){if(OSPF_IF_PARAM(oi,fast_hello)==0)json_object_int_add(json_interfac
e_sub,"timerMsecs",1000/OSPF_IF_PARAM(oi,v_hello));elsejson_object_int_add(json_
interface_sub,"timerMsecs",1000/OSPF_IF_PARAM(oi,fast_hello));json_object_int_ad
d(json_interface_sub,"timerDeadMsecs",1000/OSPF_IF_PARAM(oi,v_wait));json_object
_int_add(json_interface_sub,"timerWaitMsecs",1000/OSPF_IF_PARAM(oi,v_wait));json
_object_int_add(json_interface_sub,"timerRetransmit",1000/OSPF_IF_PARAM(oi,retra
nsmit_interval));}else{vty_out(vty,"Timerintervalsconfigured,");vty_out(vty,"Hel
lo");if(OSPF_IF_PARAM(oi,fast_hello)==0)vty_out(vty,"%ds,",OSPF_IF_PARAM(oi,v_he
llo));elsevty_out(vty,"%dms,",1000/OSPF_IF_PARAM(oi,fast_hello));vty_out(vty,"De
ad%ds,Wait%ds,Retransmit%d\n",OSPF_IF_PARAM(oi,v_wait),OSPF_IF_PARAM(oi,v_wait),
OSPF_IF_PARAM(oi,retransmit_interval));}if(OSPF_IF_PASSIVE_STATUS(oi)==OSPF_IF_A
CTIVE){chartimebuf[OSPF_TIME_DUMP_SIZE];if(use_json){longtime_store=0;if(oi->t_h
ello)time_store=monotime_until(&oi->t_hello->u.sands,NULL)/1000LL;json_object_in
t_add(json_interface_sub,"timerHelloInMsecs",time_store);}elsevty_out(vty,"Hello
duein%s\n",ospf_timer_dump(oi->t_hello,timebuf,sizeof(timebuf)));}else/*passive-
interfaceisset*/{if(use_json)json_object_boolean_true_add(json_interface_sub,"ti
merPassiveIface");elsevty_out(vty,"NoHellos(Passiveinterface)\n");}if(use_json){
json_object_int_add(json_interface_sub,"nbrCount",ospf_nbr_count(oi,0));json_obj
ect_int_add(json_interface_sub,"nbrAdjacentCount",ospf_nbr_count(oi,NSM_Full));}
elsevty_out(vty,"NeighborCountis%d,Adjacentneighborcountis%d\n",ospf_nbr_count(o
i,0),ospf_nbr_count(oi,NSM_Full));ospf_bfd_interface_show(vty,ifp,json_interface
_sub,use_json);}}staticintshow_ip_ospf_interface_common(structvty*vty,structospf
*ospf,char*intf_name,uint8_tuse_vrf,json_object*json,uint8_tuse_json){structinte
rface*ifp;structvrf*vrf=vrf_lookup_by_id(ospf->vrf_id);json_object*json_vrf=NULL
;json_object*json_interface_sub=NULL,*json_interface=NULL;if(use_json){if(use_vr
f)json_vrf=json_object_new_object();elsejson_vrf=json;json_interface=json_object
_new_object();}if(ospf->instance){if(use_json)json_object_int_add(json,"ospfInst
ance",ospf->instance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instance);}o
spf_show_vrf_name(ospf,vty,json_vrf,use_vrf);if(intf_name==NULL){/*ShowAllInterf
aces.*/FOR_ALL_INTERFACES(vrf,ifp){if(ospf_oi_count(ifp)){if(use_json){json_inte
rface_sub=json_object_new_object();}show_ip_ospf_interface_sub(vty,ospf,ifp,json
_interface_sub,use_json);if(use_json){json_object_object_add(json_interface,ifp-
>name,json_interface_sub);}}}if(use_json)json_object_object_add(json_vrf,"interf
aces",json_interface);}else{/*Interfacenameisspecified.*/ifp=if_lookup_by_name(i
ntf_name,ospf->vrf_id);if(ifp==NULL){if(use_json)json_object_boolean_true_add(js
on_vrf,"noSuchIface");elsevty_out(vty,"Nosuchinterfacename\n");}else{if(use_json
){json_interface_sub=json_object_new_object();json_interface=json_object_new_obj
ect();}show_ip_ospf_interface_sub(vty,ospf,ifp,json_interface_sub,use_json);if(u
se_json){json_object_object_add(json_interface,ifp->name,json_interface_sub);jso
n_object_object_add(json_vrf,"interfaces",json_interface);}}}if(use_json){if(use
_vrf){if(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(json,"default",json_vr
f);elsejson_object_object_add(json,ospf->name,json_vrf);}}elsevty_out(vty,"\n");
returnCMD_SUCCESS;}staticvoidshow_ip_ospf_interface_traffic_sub(structvty*vty,st
ructospf_interface*oi,json_object*json_interface_sub,uint8_tuse_json){if(use_jso
n){json_object_int_add(json_interface_sub,"ifIndex",oi->ifp->ifindex);json_objec
t_int_add(json_interface_sub,"helloIn",oi->hello_in);json_object_int_add(json_in
terface_sub,"helloOut",oi->hello_out);json_object_int_add(json_interface_sub,"db
DescIn",oi->db_desc_in);json_object_int_add(json_interface_sub,"dbDescOut",oi->d
b_desc_out);json_object_int_add(json_interface_sub,"lsReqIn",oi->ls_req_in);json
_object_int_add(json_interface_sub,"lsReqOut",oi->ls_req_out);json_object_int_ad
d(json_interface_sub,"lsUpdIn",oi->ls_upd_in);json_object_int_add(json_interface
_sub,"lsUpdOut",oi->ls_upd_out);json_object_int_add(json_interface_sub,"lsAckIn"
,oi->ls_ack_in);json_object_int_add(json_interface_sub,"lsAckOut",oi->ls_ack_out
);}else{vty_out(vty,"%-10s%8u/%-8u%7u/%-7u%7u/%-7u%7u/%-7u%7u/%-7u\n",oi->ifp->n
ame,oi->hello_in,oi->hello_out,oi->db_desc_in,oi->db_desc_out,oi->ls_req_in,oi->
ls_req_out,oi->ls_upd_in,oi->ls_upd_out,oi->ls_ack_in,oi->ls_ack_out);}}/*OSPFv2
PacketCounters*/staticintshow_ip_ospf_interface_traffic_common(structvty*vty,str
uctospf*ospf,char*intf_name,json_object*json,intdisplay_once,uint8_tuse_vrf,uint
8_tuse_json){structvrf*vrf=NULL;structinterface*ifp=NULL;json_object*json_vrf=NU
LL;json_object*json_interface_sub=NULL;if(!use_json&&!display_once){vty_out(vty,
"\n");vty_out(vty,"%-12s%-17s%-17s%-17s%-17s%-17s\n","Interface","HELLO","DB-Des
c","LS-Req","LS-Update","LS-Ack");vty_out(vty,"%-10s%-18s%-18s%-17s%-17s%-17s\n"
,"","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx","Rx/Tx");vty_out(vty,"----------------------
----------------------------------------------------------------------\n");}else
if(use_json){if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;}osp
f_show_vrf_name(ospf,vty,json_vrf,use_vrf);if(intf_name==NULL){vrf=vrf_lookup_by
_id(ospf->vrf_id);FOR_ALL_INTERFACES(vrf,ifp){structroute_node*rn;structospf_int
erface*oi;if(ospf_oi_count(ifp)==0)continue;for(rn=route_top(IF_OIFS(ifp));rn;rn
=route_next(rn)){oi=rn->info;if(oi==NULL)continue;if(use_json){json_interface_su
b=json_object_new_object();}show_ip_ospf_interface_traffic_sub(vty,oi,json_inter
face_sub,use_json);if(use_json){json_object_object_add(json_vrf,ifp->name,json_i
nterface_sub);}}}}else{/*Interfacenameisspecified.*/ifp=if_lookup_by_name(intf_n
ame,ospf->vrf_id);if(ifp!=NULL){structroute_node*rn;structospf_interface*oi;if(o
spf_oi_count(ifp)==0){vty_out(vty,"OSPFnotenabledonthisinterface%s\n",ifp->name)
;returnCMD_SUCCESS;}for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn)){oi=rn->
info;if(use_json){json_interface_sub=json_object_new_object();}show_ip_ospf_inte
rface_traffic_sub(vty,oi,json_interface_sub,use_json);if(use_json){json_object_o
bject_add(json_vrf,ifp->name,json_interface_sub);}}}}if(use_json){if(use_vrf){if
(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(json,"default",json_vrf);elsej
son_object_object_add(json,ospf->name,json_vrf);}}elsevty_out(vty,"\n");returnCM
D_SUCCESS;}DEFUN(show_ip_ospf_interface,show_ip_ospf_interface_cmd,"showipospf[v
rf<NAME|all>]interface[INTERFACE][json]",SHOW_STRIP_STR"OSPFinformation\n"VRF_CM
D_HELP_STR"AllVRFs\n""Interfaceinformation\n""Interfacename\n"JSON_STR){structos
pf*ospf;uint8_tuj=use_json(argc,argv);structlistnode*node=NULL;char*vrf_name=NUL
L,*intf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;intidx_vrf=0,id
x_intf=0;uint8_tuse_vrf=0;json_object*json=NULL;OSPF_FIND_VRF_ARGS(argv,argc,idx
_vrf,vrf_name,all_vrf);if(argv_find(argv,argc,"INTERFACE",&idx_intf))intf_name=a
rgv[idx_intf]->arg;if(uj)json=json_object_new_object();/*vrfinputisprovidedcould
beallorspecificvrf*/if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(
om->ospf,node,ospf)){if(!ospf->oi_running)continue;ret=show_ip_ospf_interface_co
mmon(vty,ospf,intf_name,use_vrf,json,uj);}if(uj){vty_out(vty,"%s\n",json_object_
to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}return
ret;}ospf=ospf_lookup_by_inst_name(inst,vrf_name);if(ospf==NULL||!ospf->oi_runni
ng){if(uj)json_object_free(json);returnCMD_SUCCESS;}ret=show_ip_ospf_interface_c
ommon(vty,ospf,intf_name,use_vrf,json,uj);}else{/*Displaydefaultospf(instance0)i
nfo*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running){i
f(uj)json_object_free(json);returnCMD_SUCCESS;}ret=show_ip_ospf_interface_common
(vty,ospf,intf_name,use_vrf,json,uj);}if(uj){vty_out(vty,"%s\n",json_object_to_j
son_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}returnret;
}DEFUN(show_ip_ospf_instance_interface,show_ip_ospf_instance_interface_cmd,"show
ipospf(1-65535)interface[INTERFACE][json]",SHOW_STRIP_STR"OSPFinformation\n""Ins
tanceID\n""Interfaceinformation\n""Interfacename\n"JSON_STR){intidx_number=3;int
idx_intf=0;structospf*ospf;unsignedshortinstance=0;uint8_tuj=use_json(argc,argv)
;char*intf_name=NULL;intret=CMD_SUCCESS;json_object*json=NULL;instance=strtoul(a
rgv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)
returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;if(uj)json=json
_object_new_object();if(argv_find(argv,argc,"INTERFACE",&idx_intf))intf_name=arg
v[idx_intf]->arg;ret=show_ip_ospf_interface_common(vty,ospf,intf_name,0,json,uj)
;if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_
PRETTY));json_object_free(json);}returnret;}DEFUN(show_ip_ospf_interface_traffic
,show_ip_ospf_interface_traffic_cmd,"showipospf[vrf<NAME|all>]interfacetraffic[I
NTERFACE][json]",SHOW_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""In
terfaceinformation\n""ProtocolPacketcounters\n""Interfacename\n"JSON_STR){struct
ospf*ospf=NULL;structlistnode*node=NULL;char*vrf_name=NULL,*intf_name=NULL;boola
ll_vrf=FALSE;intinst=0;intidx_vrf=0,idx_intf=0;uint8_tuj=use_json(argc,argv);jso
n_object*json=NULL;intret=CMD_SUCCESS;intdisplay_once=0;uint8_tuse_vrf=0;OSPF_FI
ND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);if(argv_find(argv,argc,"INTERFAC
E",&idx_intf))intf_name=argv[idx_intf]->arg;if(uj)json=json_object_new_object();
if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf))
{if(!ospf->oi_running)continue;ret=show_ip_ospf_interface_traffic_common(vty,osp
f,intf_name,json,display_once,use_vrf,uj);display_once=1;}if(uj){vty_out(vty,"%s
\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_fr
ee(json);}returnret;}ospf=ospf_lookup_by_inst_name(inst,vrf_name);if(ospf==NULL|
|!ospf->oi_running){if(uj)json_object_free(json);returnCMD_SUCCESS;}ret=show_ip_
ospf_interface_traffic_common(vty,ospf,intf_name,json,display_once,use_vrf,uj);}
else{ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running){i
f(uj)json_object_free(json);returnCMD_SUCCESS;}ret=show_ip_ospf_interface_traffi
c_common(vty,ospf,intf_name,json,display_once,use_vrf,uj);}if(uj){vty_out(vty,"%
s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_f
ree(json);}returnret;}staticvoidshow_ip_ospf_neighbour_header(structvty*vty){vty
_out(vty,"\n%-15s%3s%-15s%9s%-15s%-20s%5s%5s%5s\n","NeighborID","Pri","State","D
eadTime","Address","Interface","RXmtL","RqstL","DBsmL");}staticvoidshow_ip_ospf_
neighbor_sub(structvty*vty,structospf_interface*oi,json_object*json,uint8_tuse_j
son){structroute_node*rn;structospf_neighbor*nbr,*prev_nbr=NULL;charmsgbuf[16];c
hartimebuf[OSPF_TIME_DUMP_SIZE];json_object*json_neighbor=NULL,*json_neigh_array
=NULL;for(rn=route_top(oi->nbrs);rn;rn=route_next(rn)){if((nbr=rn->info)){/*Dono
tshowmyself.*/if(nbr==oi->nbr_self)continue;/*Downstateisnotshown.*/if(nbr->stat
e==NSM_Down)continue;if(use_json){charneigh_str[INET_ADDRSTRLEN];if(prev_nbr&&!I
PV4_ADDR_SAME(&prev_nbr->src,&nbr->src)){/*Startnewneighlist*/json_neigh_array=N
ULL;}if(nbr->state==NSM_Attempt&&nbr->router_id.s_addr==0)strlcpy(neigh_str,"nei
ghbor",sizeof(neigh_str));elsestrlcpy(neigh_str,inet_ntoa(nbr->router_id),sizeof
(neigh_str));json_object_object_get_ex(json,neigh_str,&json_neigh_array);if(!jso
n_neigh_array){json_neigh_array=json_object_new_array();json_object_object_add(j
son,neigh_str,json_neigh_array);}json_neighbor=json_object_new_object();ospf_nbr
_state_message(nbr,msgbuf,16);longtime_store;time_store=monotime_until(&nbr->t_i
nactivity->u.sands,NULL)/1000LL;json_object_int_add(json_neighbor,"priority",nbr
->priority);json_object_string_add(json_neighbor,"state",msgbuf);json_object_int
_add(json_neighbor,"deadTimeMsecs",time_store);json_object_string_add(json_neigh
bor,"address",inet_ntoa(nbr->src));json_object_string_add(json_neighbor,"ifaceNa
me",IF_NAME(oi));json_object_int_add(json_neighbor,"retransmitCounter",ospf_ls_r
etransmit_count(nbr));json_object_int_add(json_neighbor,"requestCounter",ospf_ls
_request_count(nbr));json_object_int_add(json_neighbor,"dbSummaryCounter",ospf_d
b_summary_count(nbr));json_object_array_add(json_neigh_array,json_neighbor);}els
e{ospf_nbr_state_message(nbr,msgbuf,16);if(nbr->state==NSM_Attempt&&nbr->router_
id.s_addr==0)vty_out(vty,"%-15s%3d%-15s","-",nbr->priority,msgbuf);elsevty_out(v
ty,"%-15s%3d%-15s",inet_ntoa(nbr->router_id),nbr->priority,msgbuf);vty_out(vty,"
%9s",ospf_timer_dump(nbr->t_inactivity,timebuf,sizeof(timebuf)));vty_out(vty,"%-
15s",inet_ntoa(nbr->src));vty_out(vty,"%-20s%5ld%5ld%5d\n",IF_NAME(oi),ospf_ls_r
etransmit_count(nbr),ospf_ls_request_count(nbr),ospf_db_summary_count(nbr));}pre
v_nbr=nbr;}}}staticintshow_ip_ospf_neighbor_common(structvty*vty,structospf*ospf
,json_object*json,uint8_tuse_json,uint8_tuse_vrf){structospf_interface*oi;struct
listnode*node;json_object*json_vrf=NULL;json_object*json_nbr_sub=NULL;if(use_jso
n){if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;json_nbr_sub=j
son_object_new_object();}if(ospf->instance){if(use_json)json_object_int_add(json
,"ospfInstance",ospf->instance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->in
stance);}ospf_show_vrf_name(ospf,vty,json_vrf,use_vrf);if(!use_json)show_ip_ospf
_neighbour_header(vty);for(ALL_LIST_ELEMENTS_RO(ospf->oiflist,node,oi)){if(ospf_
interface_neighbor_count(oi)==0)continue;show_ip_ospf_neighbor_sub(vty,oi,json_n
br_sub,use_json);}if(use_json){json_object_object_add(json_vrf,"neighbors",json_
nbr_sub);if(use_vrf){if(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(json,"d
efault",json_vrf);elsejson_object_object_add(json,ospf->name,json_vrf);}}elsevty
_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ip_ospf_neighbor,show_ip_ospf_neigh
bor_cmd,"showipospf[vrf<NAME|all>]neighbor[json]",SHOW_STRIP_STR"OSPFinformation
\n"VRF_CMD_HELP_STR"AllVRFs\n""Neighborlist\n"JSON_STR){structospf*ospf;uint8_tu
j=use_json(argc,argv);structlistnode*node=NULL;char*vrf_name=NULL;boolall_vrf=FA
LSE;intret=CMD_SUCCESS;intinst=0;intidx_vrf=0;uint8_tuse_vrf=0;json_object*json=
NULL;OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);if(uj)json=json_obje
ct_new_object();/*vrfinputisprovidedcouldbeallorspecificvrf*/if(vrf_name){use_vr
f=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_runni
ng)continue;ret=show_ip_ospf_neighbor_common(vty,ospf,json,uj,use_vrf);}if(uj){v
ty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));
json_object_free(json);}returnret;}ospf=ospf_lookup_by_inst_name(inst,vrf_name);
if(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(json);returnCMD_SUCCESS
;}}else{/*Displaydefaultospf(instance0)info*/ospf=ospf_lookup_by_vrf_id(VRF_DEFA
ULT);if(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(json);returnCMD_SU
CCESS;}}if(ospf){ret=show_ip_ospf_neighbor_common(vty,ospf,json,uj,use_vrf);if(u
j){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETT
Y));}}if(uj)json_object_free(json);returnret;}DEFUN(show_ip_ospf_instance_neighb
or,show_ip_ospf_instance_neighbor_cmd,"showipospf(1-65535)neighbor[json]",SHOW_S
TRIP_STR"OSPFinformation\n""InstanceID\n""Neighborlist\n"JSON_STR){intidx_number
=3;structospf*ospf;unsignedshortinstance=0;uint8_tuj=use_json(argc,argv);json_ob
ject*json=NULL;intret=CMD_SUCCESS;instance=strtoul(argv[idx_number]->arg,NULL,10
);ospf=ospf_lookup_instance(instance);if(ospf==NULL)returnCMD_NOT_MY_INSTANCE;if
(!ospf->oi_running)returnCMD_SUCCESS;if(uj)json=json_object_new_object();ret=sho
w_ip_ospf_neighbor_common(vty,ospf,json,uj,0);if(uj){vty_out(vty,"%s\n",json_obj
ect_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}re
turnret;}staticintshow_ip_ospf_neighbor_all_common(structvty*vty,structospf*ospf
,json_object*json,uint8_tuse_json,uint8_tuse_vrf){structlistnode*node;structospf
_interface*oi;json_object*json_vrf=NULL;json_object*json_neighbor_sub=NULL;if(us
e_json){if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;json_neig
hbor_sub=json_object_new_object();}ospf_show_vrf_name(ospf,vty,json_vrf,use_vrf)
;if(!use_json)show_ip_ospf_neighbour_header(vty);if(ospf->instance){if(use_json)
json_object_int_add(json_vrf,"ospfInstance",ospf->instance);elsevty_out(vty,"\nO
SPFInstance:%d\n\n",ospf->instance);}for(ALL_LIST_ELEMENTS_RO(ospf->oiflist,node
,oi)){structlistnode*nbr_node;structospf_nbr_nbma*nbr_nbma;show_ip_ospf_neighbor
_sub(vty,oi,json_vrf,use_json);/*printDownneighborstatus*/for(ALL_LIST_ELEMENTS_
RO(oi->nbr_nbma,nbr_node,nbr_nbma)){if(nbr_nbma->nbr==NULL||nbr_nbma->nbr->state
==NSM_Down){if(use_json){json_object_int_add(json_neighbor_sub,"nbrNbmaPriority"
,nbr_nbma->priority);json_object_boolean_true_add(json_neighbor_sub,"nbrNbmaDown
");json_object_string_add(json_neighbor_sub,"nbrNbmaIfaceName",IF_NAME(oi));json
_object_int_add(json_neighbor_sub,"nbrNbmaRetransmitCounter",0);json_object_int_
add(json_neighbor_sub,"nbrNbmaRequestCounter",0);json_object_int_add(json_neighb
or_sub,"nbrNbmaDbSummaryCounter",0);json_object_object_add(json_vrf,inet_ntoa(nb
r_nbma->addr),json_neighbor_sub);}else{vty_out(vty,"%-15s%3d%-15s%9s","-",nbr_nb
ma->priority,"Down","-");vty_out(vty,"%-15s%-20s%5d%5d%5d\n",inet_ntoa(nbr_nbma-
>addr),IF_NAME(oi),0,0,0);}}}}if(use_json){if(use_vrf){if(ospf->vrf_id==VRF_DEFA
ULT)json_object_object_add(json,"default",json_vrf);elsejson_object_object_add(j
son,ospf->name,json_vrf);}}elsevty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_i
p_ospf_neighbor_all,show_ip_ospf_neighbor_all_cmd,"showipospf[vrf<NAME|all>]neig
hborall[json]",SHOW_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""Neig
hborlist\n""includedownstatusneighbor\n"JSON_STR){structospf*ospf;uint8_tuj=use_
json(argc,argv);structlistnode*node=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;in
tret=CMD_SUCCESS;intinst=0;intidx_vrf=0;uint8_tuse_vrf=0;json_object*json=NULL;O
SPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);if(uj)json=json_object_new
_object();/*vrfinputisprovidedcouldbeallorspecificvrf*/if(vrf_name){use_vrf=1;if
(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)con
tinue;ret=show_ip_ospf_neighbor_all_common(vty,ospf,json,uj,use_vrf);}if(uj){vty
_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));js
on_object_free(json);}returnret;}ospf=ospf_lookup_by_inst_name(inst,vrf_name);if
(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(json);returnCMD_SUCCESS;}
}else{/*Displaydefaultospf(instance0)info*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAUL
T);if(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(json);returnCMD_SUCC
ESS;}}if(ospf){ret=show_ip_ospf_neighbor_all_common(vty,ospf,json,uj,use_vrf);if
(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRE
TTY));}}if(uj)json_object_free(json);returnret;}DEFUN(show_ip_ospf_instance_neig
hbor_all,show_ip_ospf_instance_neighbor_all_cmd,"showipospf(1-65535)neighborall[
json]",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n""Neighborlist\n""includedo
wnstatusneighbor\n"JSON_STR){intidx_number=3;structospf*ospf;unsignedshortinstan
ce=0;uint8_tuj=use_json(argc,argv);json_object*json=NULL;intret=CMD_SUCCESS;inst
ance=strtoul(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);
if(ospf==NULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;i
f(uj)json=json_object_new_object();ret=show_ip_ospf_neighbor_all_common(vty,ospf
,json,uj,0);if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C
_TO_STRING_PRETTY));json_object_free(json);}returnret;}staticintshow_ip_ospf_nei
ghbor_int_common(structvty*vty,structospf*ospf,intarg_base,structcmd_token**argv
,uint8_tuse_json,uint8_tuse_vrf){structinterface*ifp;structroute_node*rn;json_ob
ject*json=NULL;if(use_json)json=json_object_new_object();if(ospf->instance){if(u
se_json)json_object_int_add(json,"ospfInstance",ospf->instance);elsevty_out(vty,
"\nOSPFInstance:%d\n\n",ospf->instance);}ospf_show_vrf_name(ospf,vty,json,use_vr
f);ifp=if_lookup_by_name_all_vrf(argv[arg_base]->arg);if(!ifp){if(use_json)json_
object_boolean_true_add(json,"noSuchIface");elsevty_out(vty,"Nosuchinterface.\n"
);returnCMD_WARNING;}for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn)){struct
ospf_interface*oi=rn->info;if(oi==NULL)continue;show_ip_ospf_neighbor_sub(vty,oi
,json,use_json);}if(use_json){vty_out(vty,"%s\n",json_object_to_json_string_ext(
json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}elsevty_out(vty,"\n");ret
urnCMD_SUCCESS;}DEFUN(show_ip_ospf_neighbor_int,show_ip_ospf_neighbor_int_cmd,"s
howipospfneighborIFNAME[json]",SHOW_STRIP_STR"OSPFinformation\n""Neighborlist\n"
"Interfacename\n"JSON_STR){structospf*ospf;intidx_ifname=4;uint8_tuj=use_json(ar
gc,argv);structlistnode*node=NULL;intret=CMD_SUCCESS;structinterface*ifp=NULL;if
(!uj)show_ip_ospf_neighbour_header(vty);ifp=if_lookup_by_name_all_vrf(argv[idx_i
fname]->arg);for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)
continue;if(!ifp||ifp->vrf_id!=ospf->vrf_id)continue;ret=show_ip_ospf_neighbor_i
nt_common(vty,ospf,idx_ifname,argv,uj,0);}returnret;}DEFUN(show_ip_ospf_instance
_neighbor_int,show_ip_ospf_instance_neighbor_int_cmd,"showipospf(1-65535)neighbo
rIFNAME[json]",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n""Neighborlist\n""I
nterfacename\n"JSON_STR){intidx_number=3;intidx_ifname=5;structospf*ospf;unsigne
dshortinstance=0;uint8_tuj=use_json(argc,argv);if(!uj)show_ip_ospf_neighbour_hea
der(vty);instance=strtoul(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instan
ce(instance);if(ospf==NULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)return
CMD_SUCCESS;if(!uj)show_ip_ospf_neighbour_header(vty);returnshow_ip_ospf_neighbo
r_int_common(vty,ospf,idx_ifname,argv,uj,0);}staticvoidshow_ip_ospf_nbr_nbma_det
ail_sub(structvty*vty,structospf_interface*oi,structospf_nbr_nbma*nbr_nbma,uint8
_tuse_json,json_object*json){chartimebuf[OSPF_TIME_DUMP_SIZE];json_object*json_s
ub=NULL;if(use_json)json_sub=json_object_new_object();else/*ShowneighborID.*/vty
_out(vty,"Neighbor%s,","-");/*Showinterfaceaddress.*/if(use_json)json_object_str
ing_add(json_sub,"ifaceAddress",inet_ntoa(nbr_nbma->addr));elsevty_out(vty,"inte
rfaceaddress%s\n",inet_ntoa(nbr_nbma->addr));/*ShowAreaID.*/if(use_json){json_ob
ject_string_add(json_sub,"areaId",ospf_area_desc_string(oi->area));json_object_s
tring_add(json_sub,"iface",IF_NAME(oi));}elsevty_out(vty,"Inthearea%sviainterfac
e%s\n",ospf_area_desc_string(oi->area),IF_NAME(oi));/*Showneighborpriorityandsta
te.*/if(use_json){json_object_int_add(json_sub,"nbrPriority",nbr_nbma->priority)
;json_object_string_add(json_sub,"nbrState","down");}elsevty_out(vty,"Neighborpr
iorityis%d,Stateis%s,",nbr_nbma->priority,"Down");/*Showstatechanges.*/if(use_js
on)json_object_int_add(json_sub,"stateChangeCounter",nbr_nbma->state_change);els
evty_out(vty,"%dstatechanges\n",nbr_nbma->state_change);/*ShowPollInterval*/if(u
se_json)json_object_int_add(json_sub,"pollInterval",nbr_nbma->v_poll);elsevty_ou
t(vty,"Pollinterval%d\n",nbr_nbma->v_poll);/*Showpoll-intervaltimer.*/if(use_jso
n){longtime_store;time_store=monotime_until(&nbr_nbma->t_poll->u.sands,NULL)/100
0LL;json_object_int_add(json_sub,"pollIntervalTimerDueMsec",time_store);}elsevty
_out(vty,"Polltimerduein%s\n",ospf_timer_dump(nbr_nbma->t_poll,timebuf,sizeof(ti
mebuf)));/*Showpoll-intervaltimerthread.*/if(use_json){if(nbr_nbma->t_poll!=NULL
)json_object_string_add(json_sub,"pollIntervalTimerThread","on");}elsevty_out(vt
y,"ThreadPollTimer%s\n",nbr_nbma->t_poll!=NULL?"on":"off");if(use_json)json_obje
ct_object_add(json,"noNbrId",json_sub);}staticvoidshow_ip_ospf_neighbor_detail_s
ub(structvty*vty,structospf_interface*oi,structospf_neighbor*nbr,json_object*jso
n,uint8_tuse_json){chartimebuf[OSPF_TIME_DUMP_SIZE];json_object*json_sub=NULL;if
(use_json)json_sub=json_object_new_object();else{/*ShowneighborID.*/if(nbr->stat
e==NSM_Attempt&&nbr->router_id.s_addr==0)vty_out(vty,"Neighbor%s,","-");elsevty_
out(vty,"Neighbor%s,",inet_ntoa(nbr->router_id));}/*Showinterfaceaddress.*/if(us
e_json)json_object_string_add(json_sub,"ifaceAddress",inet_ntoa(nbr->address.u.p
refix4));elsevty_out(vty,"interfaceaddress%s\n",inet_ntoa(nbr->address.u.prefix4
));/*ShowAreaID.*/if(use_json){json_object_string_add(json_sub,"areaId",ospf_are
a_desc_string(oi->area));json_object_string_add(json_sub,"ifaceName",oi->ifp->na
me);}elsevty_out(vty,"Inthearea%sviainterface%s\n",ospf_area_desc_string(oi->are
a),oi->ifp->name);/*Showneighborpriorityandstate.*/if(use_json){json_object_int_
add(json_sub,"nbrPriority",nbr->priority);json_object_string_add(json_sub,"nbrSt
ate",lookup_msg(ospf_nsm_state_msg,nbr->state,NULL));}elsevty_out(vty,"Neighborp
riorityis%d,Stateis%s,",nbr->priority,lookup_msg(ospf_nsm_state_msg,nbr->state,N
ULL));/*Showstatechanges.*/if(use_json)json_object_int_add(json_sub,"stateChange
Counter",nbr->state_change);elsevty_out(vty,"%dstatechanges\n",nbr->state_change
);if(nbr->ts_last_progress.tv_sec||nbr->ts_last_progress.tv_usec){structtimevalr
es;longtime_store;time_store=monotime_since(&nbr->ts_last_progress,&res)/1000LL;
if(use_json){json_object_int_add(json_sub,"lastPrgrsvChangeMsec",time_store);}el
se{vty_out(vty,"Mostrecentstatechangestatistics:\n");vty_out(vty,"Progressivecha
nge%sago\n",ospf_timeval_dump(&res,timebuf,sizeof(timebuf)));}}if(nbr->ts_last_r
egress.tv_sec||nbr->ts_last_regress.tv_usec){structtimevalres;longtime_store;tim
e_store=monotime_since(&nbr->ts_last_regress,&res)/1000LL;if(use_json){json_obje
ct_int_add(json_sub,"lastRegressiveChangeMsec",time_store);if(nbr->last_regress_
str)json_object_string_add(json_sub,"lastRegressiveChangeReason",nbr->last_regre
ss_str);}else{vty_out(vty,"Regressivechange%sago,dueto%s\n",ospf_timeval_dump(&r
es,timebuf,sizeof(timebuf)),(nbr->last_regress_str?nbr->last_regress_str:"??"));
}}/*ShowDesignatedRotuerID.*/if(use_json)json_object_string_add(json_sub,"router
DesignatedId",inet_ntoa(nbr->d_router));elsevty_out(vty,"DRis%s,",inet_ntoa(nbr-
>d_router));/*ShowBackupDesignatedRotuerID.*/if(use_json)json_object_string_add(
json_sub,"routerDesignatedBackupId",inet_ntoa(nbr->bd_router));elsevty_out(vty,"
BDRis%s\n",inet_ntoa(nbr->bd_router));/*Showoptions.*/if(use_json){json_object_i
nt_add(json_sub,"optionsCounter",nbr->options);json_object_string_add(json_sub,"
optionsList",ospf_options_dump(nbr->options));}elsevty_out(vty,"Options%d%s\n",n
br->options,ospf_options_dump(nbr->options));/*ShowRouterDeadintervaltimer.*/if(
use_json){if(nbr->t_inactivity){longtime_store;time_store=monotime_until(&nbr->t
_inactivity->u.sands,NULL)/1000LL;json_object_int_add(json_sub,"routerDeadInterv
alTimerDueMsec",time_store);}elsejson_object_int_add(json_sub,"routerDeadInterva
lTimerDueMsec",-1);}elsevty_out(vty,"Deadtimerduein%s\n",ospf_timer_dump(nbr->t_
inactivity,timebuf,sizeof(timebuf)));/*ShowDatabaseSummarylist.*/if(use_json)jso
n_object_int_add(json_sub,"databaseSummaryListCounter",ospf_db_summary_count(nbr
));elsevty_out(vty,"DatabaseSummaryList%d\n",ospf_db_summary_count(nbr));/*ShowL
inkStateRequestlist.*/if(use_json)json_object_int_add(json_sub,"linkStateRequest
ListCounter",ospf_ls_request_count(nbr));elsevty_out(vty,"LinkStateRequestList%l
d\n",ospf_ls_request_count(nbr));/*ShowLinkStateRetransmissionlist.*/if(use_json
)json_object_int_add(json_sub,"linkStateRetransmissionListCounter",ospf_ls_retra
nsmit_count(nbr));elsevty_out(vty,"LinkStateRetransmissionList%ld\n",ospf_ls_ret
ransmit_count(nbr));/*Showinactivitytimerthread.*/if(use_json){if(nbr->t_inactiv
ity!=NULL)json_object_string_add(json_sub,"threadInactivityTimer","on");}elsevty
_out(vty,"ThreadInactivityTimer%s\n",nbr->t_inactivity!=NULL?"on":"off");/*ShowD
atabaseDescriptionretransmissionthread.*/if(use_json){if(nbr->t_db_desc!=NULL)js
on_object_string_add(json_sub,"threadDatabaseDescriptionRetransmission","on");}e
lsevty_out(vty,"ThreadDatabaseDescriptionRetransmision%s\n",nbr->t_db_desc!=NULL
?"on":"off");/*ShowLinkStateRequestRetransmissionthread.*/if(use_json){if(nbr->t
_ls_req!=NULL)json_object_string_add(json_sub,"threadLinkStateRequestRetransmiss
ion","on");}elsevty_out(vty,"ThreadLinkStateRequestRetransmission%s\n",nbr->t_ls
_req!=NULL?"on":"off");/*ShowLinkStateUpdateRetransmissionthread.*/if(use_json){
if(nbr->t_ls_upd!=NULL)json_object_string_add(json_sub,"threadLinkStateUpdateRet
ransmission","on");}elsevty_out(vty,"ThreadLinkStateUpdateRetransmission%s\n\n",
nbr->t_ls_upd!=NULL?"on":"off");if(use_json){if(nbr->state==NSM_Attempt&&nbr->ro
uter_id.s_addr==0)json_object_object_add(json,"noNbrId",json_sub);elsejson_objec
t_object_add(json,inet_ntoa(nbr->router_id),json_sub);}ospf_bfd_show_info(vty,nb
r->bfd_info,json,use_json,0);}staticintshow_ip_ospf_neighbor_id_common(structvty
*vty,structospf*ospf,intarg_base,structcmd_token**argv,uint8_tuse_json,uint8_tus
e_vrf){structlistnode*node;structospf_neighbor*nbr;structospf_interface*oi;struc
tin_addrrouter_id;intret;json_object*json=NULL;if(use_json)json=json_object_new_
object();if(ospf->instance){if(use_json)json_object_int_add(json,"ospfInstance",
ospf->instance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instance);}ospf_sh
ow_vrf_name(ospf,vty,json,use_vrf);ret=inet_aton(argv[arg_base]->arg,&router_id)
;if(!ret){if(!use_json)vty_out(vty,"PleasespecifyNeighborIDbyA.B.C.D\n");else{vt
y_out(vty,"{}\n");json_object_free(json);}returnCMD_WARNING;}for(ALL_LIST_ELEMEN
TS_RO(ospf->oiflist,node,oi)){if((nbr=ospf_nbr_lookup_by_routerid(oi->nbrs,&rout
er_id))){show_ip_ospf_neighbor_detail_sub(vty,oi,nbr,json,use_json);}}if(use_jso
n){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETT
Y));json_object_free(json);}elsevty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_
ip_ospf_neighbor_id,show_ip_ospf_neighbor_id_cmd,"showipospfneighborA.B.C.D[json
]",SHOW_STRIP_STR"OSPFinformation\n""Neighborlist\n""NeighborID\n"JSON_STR){stru
ctospf*ospf;uint8_tuj=use_json(argc,argv);structlistnode*node=NULL;intret=CMD_SU
CCESS;for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)continu
e;ret=show_ip_ospf_neighbor_id_common(vty,ospf,0,argv,uj,0);}returnret;}DEFUN(sh
ow_ip_ospf_instance_neighbor_id,show_ip_ospf_instance_neighbor_id_cmd,"showiposp
f(1-65535)neighborA.B.C.D[json]",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n"
"Neighborlist\n""NeighborID\n"JSON_STR){intidx_number=3;intidx_router_id=5;struc
tospf*ospf;unsignedshortinstance=0;uint8_tuj=use_json(argc,argv);instance=strtou
l(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NU
LL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;returnshow_i
p_ospf_neighbor_id_common(vty,ospf,idx_router_id,argv,uj,0);}staticintshow_ip_os
pf_neighbor_detail_common(structvty*vty,structospf*ospf,json_object*json,uint8_t
use_json,uint8_tuse_vrf){structospf_interface*oi;structlistnode*node;json_object
*json_vrf=NULL;if(use_json){if(use_vrf)json_vrf=json_object_new_object();elsejso
n_vrf=json;}if(ospf->instance){if(use_json)json_object_int_add(json_vrf,"ospfIns
tance",ospf->instance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instance);}
ospf_show_vrf_name(ospf,vty,json_vrf,use_vrf);for(ALL_LIST_ELEMENTS_RO(ospf->oif
list,node,oi)){structroute_node*rn;structospf_neighbor*nbr;for(rn=route_top(oi->
nbrs);rn;rn=route_next(rn)){if((nbr=rn->info)){if(nbr!=oi->nbr_self){if(nbr->sta
te!=NSM_Down){show_ip_ospf_neighbor_detail_sub(vty,oi,nbr,json_vrf,use_json);}}}
}}if(use_json){if(use_vrf){if(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(j
son,"default",json_vrf);elsejson_object_object_add(json,ospf->name,json_vrf);}}e
lsevty_out(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ip_ospf_neighbor_detail,show_
ip_ospf_neighbor_detail_cmd,"showipospf[vrf<NAME|all>]neighbordetail[json]",SHOW
_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""Neighborlist\n""detailo
fallneighbors\n"JSON_STR){structospf*ospf;uint8_tuj=use_json(argc,argv);structli
stnode*node=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst
=0;intidx_vrf=0;uint8_tuse_vrf=0;json_object*json=NULL;OSPF_FIND_VRF_ARGS(argv,a
rgc,idx_vrf,vrf_name,all_vrf);if(uj)json=json_object_new_object();/*vrfinputispr
ovidedcouldbeallorspecificvrf*/if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_E
LEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)continue;ret=show_ip_ospf_n
eighbor_detail_common(vty,ospf,json,uj,use_vrf);}if(uj){vty_out(vty,"%s\n",json_
object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);
}returnret;}ospf=ospf_lookup_by_inst_name(inst,vrf_name);if(ospf==NULL||!ospf->o
i_running){if(uj)json_object_free(json);returnCMD_SUCCESS;}}else{/*Displaydefaul
tospf(instance0)info*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!os
pf->oi_running){if(uj)json_object_free(json);returnCMD_SUCCESS;}}if(ospf){ret=sh
ow_ip_ospf_neighbor_detail_common(vty,ospf,json,uj,use_vrf);if(uj){vty_out(vty,"
%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_PRETTY));}}if(uj)json
_object_free(json);returnret;}DEFUN(show_ip_ospf_instance_neighbor_detail,show_i
p_ospf_instance_neighbor_detail_cmd,"showipospf(1-65535)neighbordetail[json]",SH
OW_STRIP_STR"OSPFinformation\n""InstanceID\n""Neighborlist\n""detailofallneighbo
rs\n"JSON_STR){intidx_number=3;structospf*ospf;unsignedshortinstance=0;uint8_tuj
=use_json(argc,argv);json_object*json=NULL;intret=CMD_SUCCESS;instance=strtoul(a
rgv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)
returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;if(uj)json=json
_object_new_object();ret=show_ip_ospf_neighbor_detail_common(vty,ospf,json,uj,0)
;if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_TO_STRING_
PRETTY));json_object_free(json);}returnret;}staticintshow_ip_ospf_neighbor_detai
l_all_common(structvty*vty,structospf*ospf,json_object*json,uint8_tuse_json,uint
8_tuse_vrf){structlistnode*node;structospf_interface*oi;json_object*json_vrf=NUL
L;if(use_json){if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;}i
f(ospf->instance){if(use_json)json_object_int_add(json,"ospfInstance",ospf->inst
ance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instance);}ospf_show_vrf_nam
e(ospf,vty,json_vrf,use_vrf);for(ALL_LIST_ELEMENTS_RO(ospf->oiflist,node,oi)){st
ructroute_node*rn;structospf_neighbor*nbr;structospf_nbr_nbma*nbr_nbma;for(rn=ro
ute_top(oi->nbrs);rn;rn=route_next(rn))if((nbr=rn->info))if(nbr!=oi->nbr_self)if
(nbr->state!=NSM_Down)show_ip_ospf_neighbor_detail_sub(vty,oi,rn->info,json_vrf,
use_json);if(oi->type==OSPF_IFTYPE_NBMA){structlistnode*nd;for(ALL_LIST_ELEMENTS
_RO(oi->nbr_nbma,nd,nbr_nbma)){if(nbr_nbma->nbr==NULL||nbr_nbma->nbr->state==NSM
_Down)show_ip_ospf_nbr_nbma_detail_sub(vty,oi,nbr_nbma,use_json,json_vrf);}}}if(
use_json){if(use_vrf){if(ospf->vrf_id==VRF_DEFAULT)json_object_object_add(json,"
default",json_vrf);elsejson_object_object_add(json,ospf->name,json_vrf);}}else{v
ty_out(vty,"\n");}returnCMD_SUCCESS;}DEFUN(show_ip_ospf_neighbor_detail_all,show
_ip_ospf_neighbor_detail_all_cmd,"showipospf[vrf<NAME|all>]neighbordetailall[jso
n]",SHOW_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""Neighborlist\n"
"detailofallneighbors\n""includedownstatusneighbor\n"JSON_STR){structospf*ospf;u
int8_tuj=use_json(argc,argv);structlistnode*node=NULL;char*vrf_name=NULL;boolall
_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;intidx_vrf=0;uint8_tuse_vrf=0;json_objec
t*json=NULL;OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);if(uj)json=js
on_object_new_object();/*vrfinputisprovidedcouldbeallorspecificvrf*/if(vrf_name)
{use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->o
i_running)continue;ret=show_ip_ospf_neighbor_detail_all_common(vty,ospf,json,uj,
use_vrf);}if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_T
O_STRING_PRETTY));json_object_free(json);}returnret;}ospf=ospf_lookup_by_inst_na
me(inst,vrf_name);if(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(json)
;returnCMD_SUCCESS;}}else{/*Displaydefaultospf(instance0)info*/ospf=ospf_lookup_
by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running){if(uj)json_object_free(
json);returnCMD_SUCCESS;}}if(ospf){ret=show_ip_ospf_neighbor_detail_all_common(v
ty,ospf,json,uj,use_vrf);if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ex
t(json,JSON_C_TO_STRING_PRETTY));}}if(uj)json_object_free(json);returnret;}DEFUN
(show_ip_ospf_instance_neighbor_detail_all,show_ip_ospf_instance_neighbor_detail
_all_cmd,"showipospf(1-65535)neighbordetailall[json]",SHOW_STRIP_STR"OSPFinforma
tion\n""InstanceID\n""Neighborlist\n""detailofallneighbors\n""includedownstatusn
eighbor\n"JSON_STR){intidx_number=3;structospf*ospf;unsignedshortinstance=0;uint
8_tuj=use_json(argc,argv);json_object*json=NULL;intret=CMD_SUCCESS;instance=strt
oul(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==
NULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;if(uj)json
=json_object_new_object();ret=show_ip_ospf_neighbor_detail_all_common(vty,ospf,j
son,uj,0);if(uj){vty_out(vty,"%s\n",json_object_to_json_string_ext(json,JSON_C_T
O_STRING_PRETTY));json_object_free(json);}returnret;}staticintshow_ip_ospf_neigh
bor_int_detail_common(structvty*vty,structospf*ospf,intarg_base,structcmd_token*
*argv,uint8_tuse_json){structospf_interface*oi;structinterface*ifp;structroute_n
ode*rn,*nrn;structospf_neighbor*nbr;json_object*json=NULL;if(use_json)json=json_
object_new_object();if(ospf->instance){if(use_json)json_object_int_add(json,"osp
fInstance",ospf->instance);elsevty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instanc
e);}ifp=if_lookup_by_name_all_vrf(argv[arg_base]->arg);if(!ifp){if(!use_json)vty
_out(vty,"Nosuchinterface.\n");else{vty_out(vty,"{}\n");json_object_free(json);}
returnCMD_WARNING;}for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn)){if((oi=r
n->info)){for(nrn=route_top(oi->nbrs);nrn;nrn=route_next(nrn)){if((nbr=nrn->info
)){if(nbr!=oi->nbr_self){if(nbr->state!=NSM_Down)show_ip_ospf_neighbor_detail_su
b(vty,oi,nbr,json,use_json);}}}}}if(use_json){vty_out(vty,"%s\n",json_object_to_
json_string_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}elsevty_o
ut(vty,"\n");returnCMD_SUCCESS;}DEFUN(show_ip_ospf_neighbor_int_detail,show_ip_o
spf_neighbor_int_detail_cmd,"showipospfneighborIFNAMEdetail[json]",SHOW_STRIP_ST
R"OSPFinformation\n""Neighborlist\n""Interfacename\n""detailofallneighbors\n"JSO
N_STR){structospf*ospf;uint8_tuj=use_json(argc,argv);structlistnode*node=NULL;in
tret=CMD_SUCCESS;for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_runn
ing)continue;ret=show_ip_ospf_neighbor_int_detail_common(vty,ospf,0,argv,uj);}re
turnret;}DEFUN(show_ip_ospf_instance_neighbor_int_detail,show_ip_ospf_instance_n
eighbor_int_detail_cmd,"showipospf(1-65535)neighborIFNAMEdetail[json]",SHOW_STRI
P_STR"OSPFinformation\n""InstanceID\n""Neighborlist\n""Interfacename\n""detailof
allneighbors\n"JSON_STR){intidx_number=3;intidx_ifname=5;structospf*ospf;unsigne
dshortinstance=0;uint8_tuj=use_json(argc,argv);instance=strtoul(argv[idx_number]
->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)returnCMD_NOT_M
Y_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;returnshow_ip_ospf_neighbor_in
t_detail_common(vty,ospf,idx_ifname,argv,uj);}/*Showfunctions*/staticintshow_lsa
_summary(structvty*vty,structospf_lsa*lsa,intself){structrouter_lsa*rl;structsum
mary_lsa*sl;structas_external_lsa*asel;structprefix_ipv4p;if(lsa!=NULL)/*Ifselfo
ptionisset,checkLSAselfflag.*/if(self==0||IS_LSA_SELF(lsa)){/*LSAcommonpartshow.
*/vty_out(vty,"%-15s",inet_ntoa(lsa->data->id));vty_out(vty,"%-15s%4d0x%08lx0x%0
4x",inet_ntoa(lsa->data->adv_router),LS_AGE(lsa),(unsignedlong)ntohl(lsa->data->
ls_seqnum),ntohs(lsa->data->checksum));/*LSAspecificpartshow.*/switch(lsa->data-
>type){caseOSPF_ROUTER_LSA:rl=(structrouter_lsa*)lsa->data;vty_out(vty,"%-d",nto
hs(rl->links));break;caseOSPF_SUMMARY_LSA:sl=(structsummary_lsa*)lsa->data;p.fam
ily=AF_INET;p.prefix=sl->header.id;p.prefixlen=ip_masklen(sl->mask);apply_mask_i
pv4(&p);vty_out(vty,"%s/%d",inet_ntoa(p.prefix),p.prefixlen);break;caseOSPF_AS_E
XTERNAL_LSA:caseOSPF_AS_NSSA_LSA:asel=(structas_external_lsa*)lsa->data;p.family
=AF_INET;p.prefix=asel->header.id;p.prefixlen=ip_masklen(asel->mask);apply_mask_
ipv4(&p);vty_out(vty,"%s%s/%d[0x%lx]",IS_EXTERNAL_METRIC(asel->e[0].tos)?"E2":"E
1",inet_ntoa(p.prefix),p.prefixlen,(unsignedlong)ntohl(asel->e[0].route_tag));br
eak;caseOSPF_NETWORK_LSA:caseOSPF_ASBR_SUMMARY_LSA:caseOSPF_OPAQUE_LINK_LSA:case
OSPF_OPAQUE_AREA_LSA:caseOSPF_OPAQUE_AS_LSA:default:break;}vty_out(vty,"\n");}re
turn0;}staticconstchar*show_database_desc[]={"unknown","RouterLinkStates","NetLi
nkStates","SummaryLinkStates","ASBR-SummaryLinkStates","ASExternalLinkStates","G
roupMembershipLSA","NSSA-externalLinkStates","Type-8LSA","Link-LocalOpaque-LSA",
"Area-LocalOpaque-LSA","AS-externalOpaque-LSA",};staticconstchar*show_database_h
eader[]={"","LinkIDADVRouterAgeSeq#CkSumLinkcount","LinkIDADVRouterAgeSeq#CkSum"
,"LinkIDADVRouterAgeSeq#CkSumRoute","LinkIDADVRouterAgeSeq#CkSum","LinkIDADVRout
erAgeSeq#CkSumRoute","---headerforGroupMember----","LinkIDADVRouterAgeSeq#CkSumR
oute","---type-8---","Opaque-Type/IdADVRouterAgeSeq#CkSum","Opaque-Type/IdADVRou
terAgeSeq#CkSum","Opaque-Type/IdADVRouterAgeSeq#CkSum",};staticvoidshow_ip_ospf_
database_header(structvty*vty,structospf_lsa*lsa){structrouter_lsa*rlsa=(structr
outer_lsa*)lsa->data;vty_out(vty,"LSage:%d\n",LS_AGE(lsa));vty_out(vty,"Options:
0x%-2x:%s\n",lsa->data->options,ospf_options_dump(lsa->data->options));vty_out(v
ty,"LSFlags:0x%-2x%s\n",lsa->flags,((lsa->flags&OSPF_LSA_LOCAL_XLT)?"(Translated
fromType-7)":""));if(lsa->data->type==OSPF_ROUTER_LSA){vty_out(vty,"Flags:0x%x",
rlsa->flags);if(rlsa->flags)vty_out(vty,":%s%s%s%s",IS_ROUTER_LSA_BORDER(rlsa)?"
ABR":"",IS_ROUTER_LSA_EXTERNAL(rlsa)?"ASBR":"",IS_ROUTER_LSA_VIRTUAL(rlsa)?"VL-e
ndpoint":"",IS_ROUTER_LSA_SHORTCUT(rlsa)?"Shortcut":"");vty_out(vty,"\n");}vty_o
ut(vty,"LSType:%s\n",lookup_msg(ospf_lsa_type_msg,lsa->data->type,NULL));vty_out
(vty,"LinkStateID:%s%s\n",inet_ntoa(lsa->data->id),lookup_msg(ospf_link_state_id
_type_msg,lsa->data->type,NULL));vty_out(vty,"AdvertisingRouter:%s\n",inet_ntoa(
lsa->data->adv_router));vty_out(vty,"LSSeqNumber:%08lx\n",(unsignedlong)ntohl(ls
a->data->ls_seqnum));vty_out(vty,"Checksum:0x%04x\n",ntohs(lsa->data->checksum))
;vty_out(vty,"Length:%d\n\n",ntohs(lsa->data->length));}constchar*link_type_desc
[]={"(null)","anotherRouter(point-to-point)","aTransitNetwork","StubNetwork","aV
irtualLink",};constchar*link_id_desc[]={"(null)","NeighboringRouterID","Designat
edRouteraddress","Net","NeighboringRouterID",};constchar*link_data_desc[]={"(nul
l)","RouterInterfaceaddress","RouterInterfaceaddress","NetworkMask","RouterInter
faceaddress",};/*Showrouter-LSAeachLinkinformation.*/staticvoidshow_ip_ospf_data
base_router_links(structvty*vty,structrouter_lsa*rl){intlen,type;unsignedinti;le
n=ntohs(rl->header.length)-4;for(i=0;i<ntohs(rl->links)&&len>0;len-=12,i++){type
=rl->link[i].type;vty_out(vty,"Linkconnectedto:%s\n",link_type_desc[type]);vty_o
ut(vty,"(LinkID)%s:%s\n",link_id_desc[type],inet_ntoa(rl->link[i].link_id));vty_
out(vty,"(LinkData)%s:%s\n",link_data_desc[type],inet_ntoa(rl->link[i].link_data
));vty_out(vty,"NumberofTOSmetrics:0\n");vty_out(vty,"TOS0Metric:%d\n",ntohs(rl-
>link[i].metric));vty_out(vty,"\n");}}/*Showrouter-LSAdetailinformation.*/static
intshow_router_lsa_detail(structvty*vty,structospf_lsa*lsa){if(lsa!=NULL){struct
router_lsa*rl=(structrouter_lsa*)lsa->data;show_ip_ospf_database_header(vty,lsa)
;vty_out(vty,"NumberofLinks:%d\n\n",ntohs(rl->links));show_ip_ospf_database_rout
er_links(vty,rl);vty_out(vty,"\n");}return0;}/*Shownetwork-LSAdetailinformation.
*/staticintshow_network_lsa_detail(structvty*vty,structospf_lsa*lsa){intlength,i
;if(lsa!=NULL){structnetwork_lsa*nl=(structnetwork_lsa*)lsa->data;show_ip_ospf_d
atabase_header(vty,lsa);vty_out(vty,"NetworkMask:/%d\n",ip_masklen(nl->mask));le
ngth=ntohs(lsa->data->length)-OSPF_LSA_HEADER_SIZE-4;for(i=0;length>0;i++,length
-=4)vty_out(vty,"AttachedRouter:%s\n",inet_ntoa(nl->routers[i]));vty_out(vty,"\n
");}return0;}/*Showsummary-LSAdetailinformation.*/staticintshow_summary_lsa_deta
il(structvty*vty,structospf_lsa*lsa){if(lsa!=NULL){structsummary_lsa*sl=(structs
ummary_lsa*)lsa->data;show_ip_ospf_database_header(vty,lsa);vty_out(vty,"Network
Mask:/%d\n",ip_masklen(sl->mask));vty_out(vty,"TOS:0Metric:%d\n",GET_METRIC(sl->
metric));vty_out(vty,"\n");}return0;}/*Showsummary-ASBR-LSAdetailinformation.*/s
taticintshow_summary_asbr_lsa_detail(structvty*vty,structospf_lsa*lsa){if(lsa!=N
ULL){structsummary_lsa*sl=(structsummary_lsa*)lsa->data;show_ip_ospf_database_he
ader(vty,lsa);vty_out(vty,"NetworkMask:/%d\n",ip_masklen(sl->mask));vty_out(vty,
"TOS:0Metric:%d\n",GET_METRIC(sl->metric));vty_out(vty,"\n");}return0;}/*ShowAS-
external-LSAdetailinformation.*/staticintshow_as_external_lsa_detail(structvty*v
ty,structospf_lsa*lsa){if(lsa!=NULL){structas_external_lsa*al=(structas_external
_lsa*)lsa->data;show_ip_ospf_database_header(vty,lsa);vty_out(vty,"NetworkMask:/
%d\n",ip_masklen(al->mask));vty_out(vty,"MetricType:%s\n",IS_EXTERNAL_METRIC(al-
>e[0].tos)?"2(Largerthananylinkstatepath)":"1");vty_out(vty,"TOS:0\n");vty_out(v
ty,"Metric:%d\n",GET_METRIC(al->e[0].metric));vty_out(vty,"ForwardAddress:%s\n",
inet_ntoa(al->e[0].fwd_addr));vty_out(vty,"ExternalRouteTag:%"ROUTE_TAG_PRI"\n\n
",(route_tag_t)ntohl(al->e[0].route_tag));}return0;}#if0staticintshow_as_externa
l_lsa_stdvty(structospf_lsa*lsa){structas_external_lsa*al=(structas_external_lsa
*)lsa->data;/*show_ip_ospf_database_header(vty,lsa);*/zlog_debug("NetworkMask:/%
d%s",ip_masklen(al->mask),"\n");zlog_debug("MetricType:%s%s",IS_EXTERNAL_METRIC(
al->e[0].tos)?"2(Largerthananylinkstatepath)":"1","\n");zlog_debug("TOS:0%s","\n
");zlog_debug("Metric:%d%s",GET_METRIC(al->e[0].metric),"\n");zlog_debug("Forwar
dAddress:%s%s",inet_ntoa(al->e[0].fwd_addr),"\n");zlog_debug("ExternalRouteTag:%
"ROUTE_TAG_PRI"%s%s",(route_tag_t)ntohl(al->e[0].route_tag),"\n","\n");return0;}
#endif/*ShowAS-NSSA-LSAdetailinformation.*/staticintshow_as_nssa_lsa_detail(stru
ctvty*vty,structospf_lsa*lsa){if(lsa!=NULL){structas_external_lsa*al=(structas_e
xternal_lsa*)lsa->data;show_ip_ospf_database_header(vty,lsa);vty_out(vty,"Networ
kMask:/%d\n",ip_masklen(al->mask));vty_out(vty,"MetricType:%s\n",IS_EXTERNAL_MET
RIC(al->e[0].tos)?"2(Largerthananylinkstatepath)":"1");vty_out(vty,"TOS:0\n");vt
y_out(vty,"Metric:%d\n",GET_METRIC(al->e[0].metric));vty_out(vty,"NSSA:ForwardAd
dress:%s\n",inet_ntoa(al->e[0].fwd_addr));vty_out(vty,"ExternalRouteTag:%"ROUTE_
TAG_PRI"\n\n",(route_tag_t)ntohl(al->e[0].route_tag));}return0;}staticintshow_fu
nc_dummy(structvty*vty,structospf_lsa*lsa){return0;}staticintshow_opaque_lsa_det
ail(structvty*vty,structospf_lsa*lsa){if(lsa!=NULL){show_ip_ospf_database_header
(vty,lsa);show_opaque_info_detail(vty,lsa);vty_out(vty,"\n");}return0;}int(*show
_function[])(structvty*,structospf_lsa*)={NULL,show_router_lsa_detail,show_netwo
rk_lsa_detail,show_summary_lsa_detail,show_summary_asbr_lsa_detail,show_as_exter
nal_lsa_detail,show_func_dummy,show_as_nssa_lsa_detail,/*almostsameasexternal*/N
ULL,/*type-8*/show_opaque_lsa_detail,show_opaque_lsa_detail,show_opaque_lsa_deta
il,};staticvoidshow_lsa_prefix_set(structvty*vty,structprefix_ls*lp,structin_add
r*id,structin_addr*adv_router){memset(lp,0,sizeof(structprefix_ls));lp->family=0
;if(id==NULL)lp->prefixlen=0;elseif(adv_router==NULL){lp->prefixlen=32;lp->id=*i
d;}else{lp->prefixlen=64;lp->id=*id;lp->adv_router=*adv_router;}}staticvoidshow_
lsa_detail_proc(structvty*vty,structroute_table*rt,structin_addr*id,structin_add
r*adv_router){structprefix_lslp;structroute_node*rn,*start;structospf_lsa*lsa;sh
ow_lsa_prefix_set(vty,&lp,id,adv_router);start=route_node_get(rt,(structprefix*)
&lp);if(start){route_lock_node(start);for(rn=start;rn;rn=route_next_until(rn,sta
rt))if((lsa=rn->info)){if(show_function[lsa->data->type]!=NULL)show_function[lsa
->data->type](vty,lsa);}route_unlock_node(start);}}/*ShowdetailLSAinformation--i
fidisNULLthenshowallLSAs.*/staticvoidshow_lsa_detail(structvty*vty,structospf*os
pf,inttype,structin_addr*id,structin_addr*adv_router){structlistnode*node;struct
ospf_area*area;switch(type){caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:vty_
out(vty,"%s\n\n",show_database_desc[type]);show_lsa_detail_proc(vty,AS_LSDB(ospf
,type),id,adv_router);break;default:for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,ar
ea)){vty_out(vty,"\n%s(Area%s)\n\n",show_database_desc[type],ospf_area_desc_stri
ng(area));show_lsa_detail_proc(vty,AREA_LSDB(area,type),id,adv_router);}break;}}
staticvoidshow_lsa_detail_adv_router_proc(structvty*vty,structroute_table*rt,str
uctin_addr*adv_router){structroute_node*rn;structospf_lsa*lsa;for(rn=route_top(r
t);rn;rn=route_next(rn))if((lsa=rn->info))if(IPV4_ADDR_SAME(adv_router,&lsa->dat
a->adv_router)){if(CHECK_FLAG(lsa->flags,OSPF_LSA_LOCAL_XLT))continue;if(show_fu
nction[lsa->data->type]!=NULL)show_function[lsa->data->type](vty,lsa);}}/*Showde
tailLSAinformation.*/staticvoidshow_lsa_detail_adv_router(structvty*vty,structos
pf*ospf,inttype,structin_addr*adv_router){structlistnode*node;structospf_area*ar
ea;switch(type){caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:vty_out(vty,"%s\
n\n",show_database_desc[type]);show_lsa_detail_adv_router_proc(vty,AS_LSDB(ospf,
type),adv_router);break;default:for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area))
{vty_out(vty,"\n%s(Area%s)\n\n",show_database_desc[type],ospf_area_desc_string(a
rea));show_lsa_detail_adv_router_proc(vty,AREA_LSDB(area,type),adv_router);}brea
k;}}staticvoidshow_ip_ospf_database_summary(structvty*vty,structospf*ospf,intsel
f){structospf_lsa*lsa;structroute_node*rn;structospf_area*area;structlistnode*no
de;inttype;for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){for(type=OSPF_MIN_LS
A;type<OSPF_MAX_LSA;type++){switch(type){caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQU
E_AS_LSA:continue;default:break;}if(ospf_lsdb_count_self(area->lsdb,type)>0||(!s
elf&&ospf_lsdb_count(area->lsdb,type)>0)){vty_out(vty,"%s(Area%s)\n\n",show_data
base_desc[type],ospf_area_desc_string(area));vty_out(vty,"%s\n",show_database_he
ader[type]);LSDB_LOOP(AREA_LSDB(area,type),rn,lsa)show_lsa_summary(vty,lsa,self)
;vty_out(vty,"\n");}}}for(type=OSPF_MIN_LSA;type<OSPF_MAX_LSA;type++){switch(typ
e){caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:break;default:continue;}if(os
pf_lsdb_count_self(ospf->lsdb,type)||(!self&&ospf_lsdb_count(ospf->lsdb,type))){
vty_out(vty,"%s\n\n",show_database_desc[type]);vty_out(vty,"%s\n",show_database_
header[type]);LSDB_LOOP(AS_LSDB(ospf,type),rn,lsa)show_lsa_summary(vty,lsa,self)
;vty_out(vty,"\n");}}vty_out(vty,"\n");}staticvoidshow_ip_ospf_database_maxage(s
tructvty*vty,structospf*ospf){structroute_node*rn;vty_out(vty,"\nMaxAgeLinkState
s:\n\n");for(rn=route_top(ospf->maxage_lsa);rn;rn=route_next(rn)){structospf_lsa
*lsa;if((lsa=rn->info)!=NULL){vty_out(vty,"Linktype:%d\n",lsa->data->type);vty_o
ut(vty,"LinkStateID:%s\n",inet_ntoa(lsa->data->id));vty_out(vty,"AdvertisingRout
er:%s\n",inet_ntoa(lsa->data->adv_router));vty_out(vty,"LSAlockcount:%d\n",lsa->
lock);vty_out(vty,"\n");}}}#defineOSPF_LSA_TYPE_NSSA_DESC"NSSAexternallinkstate\
n"#defineOSPF_LSA_TYPE_NSSA_CMD_STR"|nssa-external"#defineOSPF_LSA_TYPE_OPAQUE_L
INK_DESC"LinklocalOpaque-LSA\n"#defineOSPF_LSA_TYPE_OPAQUE_AREA_DESC"LinkareaOpa
que-LSA\n"#defineOSPF_LSA_TYPE_OPAQUE_AS_DESC"LinkASOpaque-LSA\n"#defineOSPF_LSA
_TYPE_OPAQUE_CMD_STR"|opaque-link|opaque-area|opaque-as"#defineOSPF_LSA_TYPES_DE
SC\"ASBRsummarylinkstates\n"\"Externallinkstates\n"\"Networklinkstates\n"\"Route
rlinkstates\n"\"Networksummarylinkstates\n"OSPF_LSA_TYPE_NSSA_DESC\OSPF_LSA_TYPE
_OPAQUE_LINK_DESCOSPF_LSA_TYPE_OPAQUE_AREA_DESC\OSPF_LSA_TYPE_OPAQUE_AS_DESCstat
icintshow_ip_ospf_database_common(structvty*vty,structospf*ospf,intarg_base,inta
rgc,structcmd_token**argv,uint8_tuse_vrf){intidx_type=4;inttype,ret;structin_add
rid,adv_router;if(ospf->instance)vty_out(vty,"\nOSPFInstance:%d\n",ospf->instanc
e);ospf_show_vrf_name(ospf,vty,NULL,use_vrf);vty_out(vty,"\nOSPFRouterwithID(%s)
\n\n",inet_ntoa(ospf->router_id));/*ShowallLSA.*/if(argc==arg_base+4){show_ip_os
pf_database_summary(vty,ospf,0);returnCMD_SUCCESS;}/*Setdatabasetypetoshow.*/if(
strncmp(argv[arg_base+idx_type]->text,"r",1)==0)type=OSPF_ROUTER_LSA;elseif(strn
cmp(argv[arg_base+idx_type]->text,"ne",2)==0)type=OSPF_NETWORK_LSA;elseif(strncm
p(argv[arg_base+idx_type]->text,"ns",2)==0)type=OSPF_AS_NSSA_LSA;elseif(strncmp(
argv[arg_base+idx_type]->text,"su",2)==0)type=OSPF_SUMMARY_LSA;elseif(strncmp(ar
gv[arg_base+idx_type]->text,"a",1)==0)type=OSPF_ASBR_SUMMARY_LSA;elseif(strncmp(
argv[arg_base+idx_type]->text,"e",1)==0)type=OSPF_AS_EXTERNAL_LSA;elseif(strncmp
(argv[arg_base+idx_type]->text,"se",2)==0){show_ip_ospf_database_summary(vty,osp
f,1);returnCMD_SUCCESS;}elseif(strncmp(argv[arg_base+idx_type]->text,"m",1)==0){
show_ip_ospf_database_maxage(vty,ospf);returnCMD_SUCCESS;}elseif(strncmp(argv[ar
g_base+idx_type]->text,"opaque-l",8)==0)type=OSPF_OPAQUE_LINK_LSA;elseif(strncmp
(argv[arg_base+idx_type]->text,"opaque-ar",9)==0)type=OSPF_OPAQUE_AREA_LSA;elsei
f(strncmp(argv[arg_base+idx_type]->text,"opaque-as",9)==0)type=OSPF_OPAQUE_AS_LS
A;elsereturnCMD_WARNING;/*`showipospfdatabaseLSA'.*/if(argc==arg_base+5)show_lsa
_detail(vty,ospf,type,NULL,NULL);elseif(argc>=arg_base+6){ret=inet_aton(argv[arg
_base+5]->arg,&id);if(!ret)returnCMD_WARNING;/*`showipospfdatabaseLSAID'.*/if(ar
gc==arg_base+6)show_lsa_detail(vty,ospf,type,&id,NULL);/*`showipospfdatabaseLSAI
Dadv-routerADV_ROUTER'.*/elseif(argc==arg_base+7){if(strncmp(argv[arg_base+6]->t
ext,"s",1)==0)adv_router=ospf->router_id;else{ret=inet_aton(argv[arg_base+7]->ar
g,&adv_router);if(!ret)returnCMD_WARNING;}show_lsa_detail(vty,ospf,type,&id,&adv
_router);}}returnCMD_SUCCESS;}DEFUN(show_ip_ospf_database_max,show_ip_ospf_datab
ase_max_cmd,"showipospf[vrf<NAME|all>]database<max-age|self-originate>",SHOW_STR
IP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""Databasesummary\n""LSAsinMa
xAgelist\n""Self-originatedlinkstates\n"){structospf*ospf=NULL;structlistnode*no
de=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;intidx
_vrf=0;uint8_tuse_vrf=0;OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);i
f(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){
if(!ospf->oi_running)continue;ret=show_ip_ospf_database_common(vty,ospf,idx_vrf?
2:0,argc,argv,use_vrf);}}else{ospf=ospf_lookup_by_inst_name(inst,vrf_name);if(os
pf==NULL||!ospf->oi_running)returnCMD_SUCCESS;ret=(show_ip_ospf_database_common(
vty,ospf,idx_vrf?2:0,argc,argv,use_vrf));}}else{/*Displaydefaultospf(instance0)i
nfo*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running)re
turnCMD_SUCCESS;ret=show_ip_ospf_database_common(vty,ospf,0,argc,argv,use_vrf);}
returnret;}DEFUN(show_ip_ospf_instance_database,show_ip_ospf_instance_database_c
md,"showipospf[{(1-65535)|vrfNAME}]database[<asbr-summary|external|network|route
r|summary|nssa-external|opaque-link|opaque-area|opaque-as>[A.B.C.D[<self-origina
te|adv-routerA.B.C.D>]]]",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n"VRF_CMD
_HELP_STR"Databasesummary\n"OSPF_LSA_TYPES_DESC"LinkStateID(asanIPaddress)\n""Se
lf-originatedlinkstates\n""AdvertisingRouterlinkstates\n""AdvertisingRouter(asan
IPaddress)\n"){structospf*ospf;unsignedshortinstance=0;structlistnode*node=NULL;
char*vrf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;intidx=0;uint8
_tuse_vrf=0;if(argv_find(argv,argc,"(1-65535)",&idx)){instance=strtoul(argv[idx]
->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)returnCMD_NOT_M
Y_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;return(show_ip_ospf_database_c
ommon(vty,ospf,idx?1:0,argc,argv,use_vrf));}elseif(argv_find(argv,argc,"vrf",&id
x)){vrf_name=argv[++idx]->arg;all_vrf=strmatch(vrf_name,"all");}if(vrf_name){use
_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_ru
nning)continue;ret=(show_ip_ospf_database_common(vty,ospf,idx?2:0,argc,argv,use_
vrf));}}else{ospf=ospf_lookup_by_inst_name(inst,vrf_name);if((ospf==NULL)||!ospf
->oi_running)returnCMD_SUCCESS;ret=(show_ip_ospf_database_common(vty,ospf,idx?2:
0,argc,argv,use_vrf));}}else{/*Displaydefaultospf(instance0)info*/ospf=ospf_look
up_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running)returnCMD_SUCCESS;ret
=(show_ip_ospf_database_common(vty,ospf,0,argc,argv,use_vrf));}returnret;}DEFUN(
show_ip_ospf_instance_database_max,show_ip_ospf_instance_database_max_cmd,"showi
pospf(1-65535)database<max-age|self-originate>",SHOW_STRIP_STR"OSPFinformation\n
""InstanceID\n""Databasesummary\n""LSAsinMaxAgelist\n""Self-originatedlinkstates
\n"){intidx_number=3;structospf*ospf;unsignedshortinstance=0;instance=strtoul(ar
gv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)r
eturnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;returnshow_ip_os
pf_database_common(vty,ospf,1,argc,argv,0);}staticintshow_ip_ospf_database_type_
adv_router_common(structvty*vty,structospf*ospf,intarg_base,intargc,structcmd_to
ken**argv,uint8_tuse_vrf){intidx_type=4;inttype,ret;structin_addradv_router;if(o
spf->instance)vty_out(vty,"\nOSPFInstance:%d\n",ospf->instance);ospf_show_vrf_na
me(ospf,vty,NULL,use_vrf);vty_out(vty,"\nOSPFRouterwithID(%s)\n\n",inet_ntoa(osp
f->router_id));/*Setdatabasetypetoshow.*/if(strncmp(argv[arg_base+idx_type]->tex
t,"r",1)==0)type=OSPF_ROUTER_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"n
e",2)==0)type=OSPF_NETWORK_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"ns"
,2)==0)type=OSPF_AS_NSSA_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"s",1)
==0)type=OSPF_SUMMARY_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"a",1)==0
)type=OSPF_ASBR_SUMMARY_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"e",1)=
=0)type=OSPF_AS_EXTERNAL_LSA;elseif(strncmp(argv[arg_base+idx_type]->text,"opaqu
e-l",8)==0)type=OSPF_OPAQUE_LINK_LSA;elseif(strncmp(argv[arg_base+idx_type]->tex
t,"opaque-ar",9)==0)type=OSPF_OPAQUE_AREA_LSA;elseif(strncmp(argv[arg_base+idx_t
ype]->text,"opaque-as",9)==0)type=OSPF_OPAQUE_AS_LSA;elsereturnCMD_WARNING;/*`sh
owipospfdatabaseLSAadv-routerADV_ROUTER'.*/if(strncmp(argv[arg_base+5]->text,"s"
,1)==0)adv_router=ospf->router_id;else{ret=inet_aton(argv[arg_base+6]->arg,&adv_
router);if(!ret)returnCMD_WARNING;}show_lsa_detail_adv_router(vty,ospf,type,&adv
_router);returnCMD_SUCCESS;}DEFUN(show_ip_ospf_instance_database_type_adv_router
,show_ip_ospf_instance_database_type_adv_router_cmd,"showipospf[{(1-65535)|vrfNA
ME}]database<asbr-summary|external|network|router|summary|nssa-external|opaque-l
ink|opaque-area|opaque-as><adv-routerA.B.C.D|self-originate>",SHOW_STRIP_STR"OSP
Finformation\n""InstanceID\n"VRF_CMD_HELP_STR"Databasesummary\n"OSPF_LSA_TYPES_D
ESC"AdvertisingRouterlinkstates\n""AdvertisingRouter(asanIPaddress)\n""Self-orig
inatedlinkstates\n"){structospf*ospf=NULL;unsignedshortinstance=0;structlistnode
*node=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;int
idx=0,idx_vrf=0;uint8_tuse_vrf=0;if(argv_find(argv,argc,"(1-65535)",&idx)){insta
nce=strtoul(argv[idx]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf=
=NULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;return(sh
ow_ip_ospf_database_type_adv_router_common(vty,ospf,idx?1:0,argc,argv,use_vrf));
}OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);if(vrf_name){use_vrf=1;i
f(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)co
ntinue;ret=show_ip_ospf_database_type_adv_router_common(vty,ospf,idx?1:0,argc,ar
gv,use_vrf);}}else{ospf=ospf_lookup_by_inst_name(inst,vrf_name);if((ospf==NULL)|
|!ospf->oi_running)returnCMD_SUCCESS;ret=show_ip_ospf_database_type_adv_router_c
ommon(vty,ospf,idx?1:0,argc,argv,use_vrf);}}else{/*Displaydefaultospf(instance0)
info*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running)r
eturnCMD_SUCCESS;ret=show_ip_ospf_database_type_adv_router_common(vty,ospf,idx?1
:0,argc,argv,use_vrf);}returnret;/*return(show_ip_ospf_database_type_adv_router_
common(vty,ospf,idx?1:0,argc,argv));*/}DEFUN(ip_ospf_authentication_args,ip_ospf
_authentication_args_addr_cmd,"ipospfauthentication<null|message-digest>[A.B.C.D
]","IPInformation\n""OSPFinterfacecommands\n""Enableauthenticationonthisinterfac
e\n""Usenullauthentication\n""Usemessage-digestauthentication\n""Addressofinterf
ace\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_encryption=3;intidx_ipv4=4;str
uctin_addraddr;intret;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(a
rgc==5){ret=inet_aton(argv[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"Pleasespe
cifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_g
et_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}/*Handlenullauthenticati
on*/if(argv[idx_encryption]->arg[0]=='n'){SET_IF_PARAM(params,auth_type);params-
>auth_type=OSPF_AUTH_NULL;returnCMD_SUCCESS;}/*Handlemessage-digestauthenticatio
n*/if(argv[idx_encryption]->arg[0]=='m'){SET_IF_PARAM(params,auth_type);params->
auth_type=OSPF_AUTH_CRYPTOGRAPHIC;returnCMD_SUCCESS;}vty_out(vty,"Youshouldn'tge
there!\n");returnCMD_WARNING_CONFIG_FAILED;}DEFUN(ip_ospf_authentication,ip_ospf
_authentication_addr_cmd,"ipospfauthentication[A.B.C.D]","IPInformation\n""OSPFi
nterfacecommands\n""Enableauthenticationonthisinterface\n""Addressofinterface\n"
){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=3;structin_addraddr;intret;stru
ctospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(argc==4){ret=inet_aton(argv
[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.
C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);osp
f_if_update_params(ifp,addr);}SET_IF_PARAM(params,auth_type);params->auth_type=O
SPF_AUTH_SIMPLE;returnCMD_SUCCESS;}DEFUN(no_ip_ospf_authentication_args,no_ip_os
pf_authentication_args_addr_cmd,"noipospfauthentication<null|message-digest>[A.B
.C.D]",NO_STR"IPInformation\n""OSPFinterfacecommands\n""Enableauthenticationonth
isinterface\n""Usenullauthentication\n""Usemessage-digestauthentication\n""Addre
ssofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_encryption=4;intidx_
ipv4=5;structin_addraddr;intret;structospf_if_params*params;structroute_node*rn;
intauth_type;params=IF_DEF_PARAMS(ifp);if(argc==6){ret=inet_aton(argv[idx_ipv4]-
>arg,&addr);if(!ret){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");ret
urnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);if(params==
NULL){vty_out(vty,"IpAddressspecifiedisunknown\n");returnCMD_WARNING_CONFIG_FAIL
ED;}params->auth_type=OSPF_AUTH_NOTSET;UNSET_IF_PARAM(params,auth_type);if(param
s!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,addr);ospf_if_update_params(ifp,a
ddr);}}else{if(argv[idx_encryption]->arg[0]=='n'){auth_type=OSPF_AUTH_NULL;}else
if(argv[idx_encryption]->arg[0]=='m'){auth_type=OSPF_AUTH_CRYPTOGRAPHIC;}else{vt
y_out(vty,"Unexpectedinputencountered\n");returnCMD_WARNING_CONFIG_FAILED;}/**He
rewehaveacasewheretheuserhasentered*'noipospfauthentication(null|message_digest)
'*weneedtofindifwehaveanyipaddressesunderneathit*that*correspondtotheassociatedt
ype.*/if(params->auth_type==auth_type){params->auth_type=OSPF_AUTH_NOTSET;UNSET_
IF_PARAM(params,auth_type);}for(rn=route_top(IF_OIFS_PARAMS(ifp));rn;rn=route_ne
xt(rn)){if((params=rn->info)){if(params->auth_type==auth_type){params->auth_type
=OSPF_AUTH_NOTSET;UNSET_IF_PARAM(params,auth_type);if(params!=IF_DEF_PARAMS(ifp)
){ospf_free_if_params(ifp,rn->p.u.prefix4);ospf_if_update_params(ifp,rn->p.u.pre
fix4);}}}}}returnCMD_SUCCESS;}DEFUN(no_ip_ospf_authentication,no_ip_ospf_authent
ication_addr_cmd,"noipospfauthentication[A.B.C.D]",NO_STR"IPInformation\n""OSPFi
nterfacecommands\n""Enableauthenticationonthisinterface\n""Addressofinterface\n"
){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=4;structin_addraddr;intret;stru
ctospf_if_params*params;structroute_node*rn;params=IF_DEF_PARAMS(ifp);if(argc==5
){ret=inet_aton(argv[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"Pleasespecifyin
terfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_
if_params(ifp,addr);if(params==NULL){vty_out(vty,"IpAddressspecifiedisunknown\n"
);returnCMD_WARNING_CONFIG_FAILED;}params->auth_type=OSPF_AUTH_NOTSET;UNSET_IF_P
ARAM(params,auth_type);if(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,ad
dr);ospf_if_update_params(ifp,addr);}}else{/**Whenauserenters'noipospfauthentica
tion'*Weshouldremoveallauthenticationtypesfrom*theinterface.*/if((params->auth_t
ype==OSPF_AUTH_NULL)||(params->auth_type==OSPF_AUTH_CRYPTOGRAPHIC)||(params->aut
h_type==OSPF_AUTH_SIMPLE)){params->auth_type=OSPF_AUTH_NOTSET;UNSET_IF_PARAM(par
ams,auth_type);}for(rn=route_top(IF_OIFS_PARAMS(ifp));rn;rn=route_next(rn)){if((
params=rn->info)){if((params->auth_type==OSPF_AUTH_NULL)||(params->auth_type==OS
PF_AUTH_CRYPTOGRAPHIC)||(params->auth_type==OSPF_AUTH_SIMPLE)){params->auth_type
=OSPF_AUTH_NOTSET;UNSET_IF_PARAM(params,auth_type);if(params!=IF_DEF_PARAMS(ifp)
){ospf_free_if_params(ifp,rn->p.u.prefix4);ospf_if_update_params(ifp,rn->p.u.pre
fix4);}}}}}returnCMD_SUCCESS;}DEFUN(ip_ospf_authentication_key,ip_ospf_authentic
ation_key_addr_cmd,"ipospfauthentication-keyAUTH_KEY[A.B.C.D]","IPInformation\n"
"OSPFinterfacecommands\n""Authenticationpassword(key)\n""TheOSPFpassword(key)\n"
"Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structin_add
raddr;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(argv_find(argv,ar
gc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){vty_out(vty,"Pleasespec
ifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_ge
t_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}memset(params->auth_simpl
e,0,OSPF_AUTH_SIMPLE_SIZE+1);strncpy((char*)params->auth_simple,argv[3]->arg,OSP
F_AUTH_SIMPLE_SIZE);SET_IF_PARAM(params,auth_simple);returnCMD_SUCCESS;}DEFUN_HI
DDEN(ospf_authentication_key,ospf_authentication_key_cmd,"ospfauthentication-key
AUTH_KEY[A.B.C.D]","OSPFinterfacecommands\n"VLINK_HELPSTR_AUTH_SIMPLE"Addressofi
nterface\n"){returnip_ospf_authentication_key(self,vty,argc,argv);}DEFUN(no_ip_o
spf_authentication_key,no_ip_ospf_authentication_key_authkey_addr_cmd,"noipospfa
uthentication-key[AUTH_KEY[A.B.C.D]]",NO_STR"IPInformation\n""OSPFinterfacecomma
nds\n"VLINK_HELPSTR_AUTH_SIMPLE"Addressofinterface\n"){VTY_DECLVAR_CONTEXT(inter
face,ifp);intidx=0;structin_addraddr;structospf_if_params*params;params=IF_DEF_P
ARAMS(ifp);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,
&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNIN
G_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);if(params==NULL)returnCM
D_SUCCESS;}memset(params->auth_simple,0,OSPF_AUTH_SIMPLE_SIZE);UNSET_IF_PARAM(pa
rams,auth_simple);if(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,addr);o
spf_if_update_params(ifp,addr);}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_authenti
cation_key,no_ospf_authentication_key_authkey_addr_cmd,"noospfauthentication-key
[AUTH_KEY[A.B.C.D]]",NO_STR"OSPFinterfacecommands\n"VLINK_HELPSTR_AUTH_SIMPLE"Ad
dressofinterface\n"){returnno_ip_ospf_authentication_key(self,vty,argc,argv);}DE
FUN(ip_ospf_message_digest_key,ip_ospf_message_digest_key_cmd,"ipospfmessage-dig
est-key(1-255)md5KEY[A.B.C.D]","IPInformation\n""OSPFinterfacecommands\n""Messag
edigestauthenticationpassword(key)\n""KeyID\n""UseMD5algorithm\n""TheOSPFpasswor
d(key)\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);structcrypt_
key*ck;uint8_tkey_id;structin_addraddr;structospf_if_params*params;params=IF_DEF
_PARAMS(ifp);intidx=0;argv_find(argv,argc,"(1-255)",&idx);char*keyid=argv[idx]->
arg;argv_find(argv,argc,"KEY",&idx);char*cryptkey=argv[idx]->arg;if(argv_find(ar
gv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){vty_out(vty,"Pleas
especifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=os
pf_get_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}key_id=strtol(keyid,
NULL,10);if(ospf_crypt_key_lookup(params->auth_crypt,key_id)!=NULL){vty_out(vty,
"OSPF:Key%dalreadyexists\n",key_id);returnCMD_WARNING;}ck=ospf_crypt_key_new();c
k->key_id=(uint8_t)key_id;memset(ck->auth_key,0,OSPF_AUTH_MD5_SIZE+1);strncpy((c
har*)ck->auth_key,cryptkey,OSPF_AUTH_MD5_SIZE);ospf_crypt_key_add(params->auth_c
rypt,ck);SET_IF_PARAM(params,auth_crypt);returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_me
ssage_digest_key,ospf_message_digest_key_cmd,"ospfmessage-digest-key(1-255)md5KE
Y[A.B.C.D]","OSPFinterfacecommands\n""Messagedigestauthenticationpassword(key)\n
""KeyID\n""UseMD5algorithm\n""TheOSPFpassword(key)\n""Addressofinterface\n"){ret
urnip_ospf_message_digest_key(self,vty,argc,argv);}DEFUN(no_ip_ospf_message_dige
st_key,no_ip_ospf_message_digest_key_cmd,"noipospfmessage-digest-key(1-255)[md5K
EY][A.B.C.D]",NO_STR"IPInformation\n""OSPFinterfacecommands\n""Messagedigestauth
enticationpassword(key)\n""KeyID\n""UseMD5algorithm\n""TheOSPFpassword(key)\n""A
ddressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structcrypt_ke
y*ck;intkey_id;structin_addraddr;structospf_if_params*params;params=IF_DEF_PARAM
S(ifp);argv_find(argv,argc,"(1-255)",&idx);char*keyid=argv[idx]->arg;if(argv_fin
d(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){vty_out(vty,"P
leasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}param
s=ospf_lookup_if_params(ifp,addr);if(params==NULL)returnCMD_SUCCESS;}key_id=strt
ol(keyid,NULL,10);ck=ospf_crypt_key_lookup(params->auth_crypt,key_id);if(ck==NUL
L){vty_out(vty,"OSPF:Key%ddoesnotexist\n",key_id);returnCMD_WARNING_CONFIG_FAILE
D;}ospf_crypt_key_delete(params->auth_crypt,key_id);if(params!=IF_DEF_PARAMS(ifp
)){ospf_free_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}returnCMD_SUCC
ESS;}DEFUN_HIDDEN(no_ospf_message_digest_key,no_ospf_message_digest_key_cmd,"noo
spfmessage-digest-key(1-255)[md5KEY][A.B.C.D]",NO_STR"OSPFinterfacecommands\n""M
essagedigestauthenticationpassword(key)\n""KeyID\n""UseMD5algorithm\n""TheOSPFpa
ssword(key)\n""Addressofinterface\n"){returnno_ip_ospf_message_digest_key(self,v
ty,argc,argv);}DEFUN(ip_ospf_cost,ip_ospf_cost_cmd,"ipospfcost(1-65535)[A.B.C.D]
","IPInformation\n""OSPFinterfacecommands\n""Interfacecost\n""Cost\n""Addressofi
nterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;uint32_tcost=OSPF_OUTPU
T_COST_DEFAULT;structin_addraddr;structospf_if_params*params;params=IF_DEF_PARAM
S(ifp);//getargumentschar*coststr=NULL,*ifaddr=NULL;argv_find(argv,argc,"(1-6553
5)",&idx);coststr=argv[idx]->arg;cost=strtol(coststr,NULL,10);ifaddr=argv_find(a
rgv,argc,"A.B.C.D",&idx)?argv[idx]->arg:NULL;if(ifaddr){if(!inet_aton(ifaddr,&ad
dr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_C
ONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_update_params(ifp,addr
);}SET_IF_PARAM(params,output_cost_cmd);params->output_cost_cmd=cost;ospf_if_rec
alculate_output_cost(ifp);returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_cost,ospf_cost_cm
d,"ospfcost(1-65535)[A.B.C.D]","OSPFinterfacecommands\n""Interfacecost\n""Cost\n
""Addressofinterface\n"){returnip_ospf_cost(self,vty,argc,argv);}DEFUN(no_ip_osp
f_cost,no_ip_ospf_cost_cmd,"noipospfcost[(1-65535)][A.B.C.D]",NO_STR"IPInformati
on\n""OSPFinterfacecommands\n""Interfacecost\n""Cost\n""Addressofinterface\n"){V
TY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structin_addraddr;structospf_if_param
s*params;params=IF_DEF_PARAMS(ifp);//getargumentschar*ifaddr=NULL;ifaddr=argv_fi
nd(argv,argc,"A.B.C.D",&idx)?argv[idx]->arg:NULL;/*Accordingtothesemanticswearem
imicking"noipospfcostN"is*alwaystreatedas"noipospfcost"regardlessoftheactualvalu
e*ofNalreadyconfiguredfortheinterface.Thusignorecost.*/if(ifaddr){if(!inet_aton(
ifaddr,&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD
_WARNING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);if(params==NULL)r
eturnCMD_SUCCESS;}UNSET_IF_PARAM(params,output_cost_cmd);if(params!=IF_DEF_PARAM
S(ifp)){ospf_free_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}ospf_if_r
ecalculate_output_cost(ifp);returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_cost,no_ospf
_cost_cmd,"noospfcost[(1-65535)][A.B.C.D]",NO_STR"OSPFinterfacecommands\n""Inter
facecost\n""Cost\n""Addressofinterface\n"){returnno_ip_ospf_cost(self,vty,argc,a
rgv);}staticvoidospf_nbr_timer_update(structospf_interface*oi){structroute_node*
rn;structospf_neighbor*nbr;for(rn=route_top(oi->nbrs);rn;rn=route_next(rn))if((n
br=rn->info)){nbr->v_inactivity=OSPF_IF_PARAM(oi,v_wait);nbr->v_db_desc=OSPF_IF_
PARAM(oi,retransmit_interval);nbr->v_ls_req=OSPF_IF_PARAM(oi,retransmit_interval
);nbr->v_ls_upd=OSPF_IF_PARAM(oi,retransmit_interval);}}staticintospf_vty_dead_i
nterval_set(structvty*vty,constchar*interval_str,constchar*nbr_str,constchar*fas
t_hello_str){VTY_DECLVAR_CONTEXT(interface,ifp);uint32_tseconds;uint8_thellomult
;structin_addraddr;intret;structospf_if_params*params;structospf_interface*oi;st
ructroute_node*rn;params=IF_DEF_PARAMS(ifp);if(nbr_str){ret=inet_aton(nbr_str,&a
ddr);if(!ret){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_
WARNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_update_params
(ifp,addr);}if(interval_str){seconds=strtoul(interval_str,NULL,10);/*resetfast_h
ellotoo,justtobesure*/UNSET_IF_PARAM(params,fast_hello);params->fast_hello=OSPF_
FAST_HELLO_DEFAULT;}elseif(fast_hello_str){hellomult=strtoul(fast_hello_str,NULL
,10);/*1sdead-intervalwithsub-secondhellosdesired*/seconds=OSPF_ROUTER_DEAD_INTE
RVAL_MINIMAL;SET_IF_PARAM(params,fast_hello);params->fast_hello=hellomult;}else{
vty_out(vty,"Pleasespecifydead-intervalorhello-multiplier\n");returnCMD_WARNING_
CONFIG_FAILED;}SET_IF_PARAM(params,v_wait);params->v_wait=seconds;/*Updatetimerv
aluesinneighborstructure.*/if(nbr_str){structospf*ospf=NULL;ospf=ospf_lookup_by_
vrf_id(ifp->vrf_id);if(ospf){oi=ospf_if_lookup_by_local_addr(ospf,ifp,addr);if(o
i)ospf_nbr_timer_update(oi);}}else{for(rn=route_top(IF_OIFS(ifp));rn;rn=route_ne
xt(rn))if((oi=rn->info))ospf_nbr_timer_update(oi);}returnCMD_SUCCESS;}DEFUN(ip_o
spf_dead_interval,ip_ospf_dead_interval_cmd,"ipospfdead-interval(1-65535)[A.B.C.
D]","IPInformation\n""OSPFinterfacecommands\n""Intervaltimeafterwhichaneighboris
declareddown\n""Seconds\n""Addressofinterface\n"){intidx=0;char*interval=argv_fi
nd(argv,argc,"(1-65535)",&idx)?argv[idx]->arg:NULL;char*ifaddr=argv_find(argv,ar
gc,"A.B.C.D",&idx)?argv[idx]->arg:NULL;returnospf_vty_dead_interval_set(vty,inte
rval,ifaddr,NULL);}DEFUN_HIDDEN(ospf_dead_interval,ospf_dead_interval_cmd,"ospfd
ead-interval(1-65535)[A.B.C.D]","OSPFinterfacecommands\n""Intervaltimeafterwhich
aneighborisdeclareddown\n""Seconds\n""Addressofinterface\n"){returnip_ospf_dead_
interval(self,vty,argc,argv);}DEFUN(ip_ospf_dead_interval_minimal,ip_ospf_dead_i
nterval_minimal_addr_cmd,"ipospfdead-intervalminimalhello-multiplier(1-10)[A.B.C
.D]","IPInformation\n""OSPFinterfacecommands\n""Intervaltimeafterwhichaneighbori
sdeclareddown\n""Minimal1sdead-intervalwithfastsub-secondhellos\n""Hellomultipli
erfactor\n""NumberofHellostosendeachsecond\n""Addressofinterface\n"){intidx_numb
er=5;intidx_ipv4=6;if(argc==7)returnospf_vty_dead_interval_set(vty,NULL,argv[idx
_ipv4]->arg,argv[idx_number]->arg);elsereturnospf_vty_dead_interval_set(vty,NULL
,NULL,argv[idx_number]->arg);}DEFUN(no_ip_ospf_dead_interval,no_ip_ospf_dead_int
erval_cmd,"noipospfdead-interval[<(1-65535)|minimalhello-multiplier(1-10)>[A.B.C
.D]]",NO_STR"IPInformation\n""OSPFinterfacecommands\n""Intervaltimeafterwhichane
ighborisdeclareddown\n""Seconds\n""Minimal1sdead-intervalwithfastsub-secondhello
s\n""Hellomultiplierfactor\n""NumberofHellostosendeachsecond\n""Addressofinterfa
ce\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=argc-1;structin_addraddr={
.s_addr=0L};intret;structospf_if_params*params;structospf_interface*oi;structrou
te_node*rn;params=IF_DEF_PARAMS(ifp);if(argv[idx_ipv4]->type==IPV4_TKN){ret=inet
_aton(argv[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"Pleasespecifyinterfaceadd
ressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_if_params(
ifp,addr);if(params==NULL)returnCMD_SUCCESS;}UNSET_IF_PARAM(params,v_wait);param
s->v_wait=OSPF_ROUTER_DEAD_INTERVAL_DEFAULT;UNSET_IF_PARAM(params,fast_hello);pa
rams->fast_hello=OSPF_FAST_HELLO_DEFAULT;if(params!=IF_DEF_PARAMS(ifp)){ospf_fre
e_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}/*Updatetimervaluesinneig
hborstructure.*/if(argc==1){structospf*ospf=NULL;ospf=ospf_lookup_by_vrf_id(ifp-
>vrf_id);if(ospf){oi=ospf_if_lookup_by_local_addr(ospf,ifp,addr);if(oi)ospf_nbr_
timer_update(oi);}}else{for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn))if((
oi=rn->info))ospf_nbr_timer_update(oi);}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_
dead_interval,no_ospf_dead_interval_cmd,"noospfdead-interval[<(1-65535)|minimalh
ello-multiplier(1-10)>[A.B.C.D]]",NO_STR"OSPFinterfacecommands\n""Intervaltimeaf
terwhichaneighborisdeclareddown\n""Seconds\n""Minimal1sdead-intervalwithfastsub-
secondhellos\n""Hellomultiplierfactor\n""NumberofHellostosendeachsecond\n""Addre
ssofinterface\n"){returnno_ip_ospf_dead_interval(self,vty,argc,argv);}DEFUN(ip_o
spf_hello_interval,ip_ospf_hello_interval_cmd,"ipospfhello-interval(1-65535)[A.B
.C.D]","IPInformation\n""OSPFinterfacecommands\n""TimebetweenHELLOpackets\n""Sec
onds\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;struc
tin_addraddr;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);uint32_tsecon
ds=0;argv_find(argv,argc,"(1-65535)",&idx);seconds=strtol(argv[idx]->arg,NULL,10
);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){v
ty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_
FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}SET
_IF_PARAM(params,v_hello);params->v_hello=seconds;returnCMD_SUCCESS;}DEFUN_HIDDE
N(ospf_hello_interval,ospf_hello_interval_cmd,"ospfhello-interval(1-65535)[A.B.C
.D]","OSPFinterfacecommands\n""TimebetweenHELLOpackets\n""Seconds\n""Addressofin
terface\n"){returnip_ospf_hello_interval(self,vty,argc,argv);}DEFUN(no_ip_ospf_h
ello_interval,no_ip_ospf_hello_interval_cmd,"noipospfhello-interval[(1-65535)[A.
B.C.D]]",NO_STR"IPInformation\n""OSPFinterfacecommands\n""TimebetweenHELLOpacket
s\n"//ignored"Seconds\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,if
p);intidx=0;structin_addraddr;structospf_if_params*params;params=IF_DEF_PARAMS(i
fp);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr))
{vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFI
G_FAILED;}params=ospf_lookup_if_params(ifp,addr);if(params==NULL)returnCMD_SUCCE
SS;}UNSET_IF_PARAM(params,v_hello);params->v_hello=OSPF_HELLO_INTERVAL_DEFAULT;i
f(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,addr);ospf_if_update_param
s(ifp,addr);}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_hello_interval,no_ospf_hell
o_interval_cmd,"noospfhello-interval[(1-65535)[A.B.C.D]]",NO_STR"OSPFinterfaceco
mmands\n""TimebetweenHELLOpackets\n"//ignored"Seconds\n""Addressofinterface\n"){
returnno_ip_ospf_hello_interval(self,vty,argc,argv);}DEFUN(ip_ospf_network,ip_os
pf_network_cmd,"ipospfnetwork<broadcast|non-broadcast|point-to-multipoint|point-
to-point>","IPInformation\n""OSPFinterfacecommands\n""Networktype\n""SpecifyOSPF
broadcastmulti-accessnetwork\n""SpecifyOSPFNBMAnetwork\n""SpecifyOSPFpoint-to-mu
ltipointnetwork\n""SpecifyOSPFpoint-to-pointnetwork\n"){VTY_DECLVAR_CONTEXT(inte
rface,ifp);intidx=0;intold_type=IF_DEF_PARAMS(ifp)->type;structroute_node*rn;if(
old_type==OSPF_IFTYPE_LOOPBACK){vty_out(vty,"Thisisaloopbackinterface.Can'tsetne
tworktype.\n");returnCMD_WARNING_CONFIG_FAILED;}if(argv_find(argv,argc,"broadcas
t",&idx))IF_DEF_PARAMS(ifp)->type=OSPF_IFTYPE_BROADCAST;elseif(argv_find(argv,ar
gc,"non-broadcast",&idx))IF_DEF_PARAMS(ifp)->type=OSPF_IFTYPE_NBMA;elseif(argv_f
ind(argv,argc,"point-to-multipoint",&idx))IF_DEF_PARAMS(ifp)->type=OSPF_IFTYPE_P
OINTOMULTIPOINT;elseif(argv_find(argv,argc,"point-to-point",&idx))IF_DEF_PARAMS(
ifp)->type=OSPF_IFTYPE_POINTOPOINT;if(IF_DEF_PARAMS(ifp)->type==old_type)returnC
MD_SUCCESS;SET_IF_PARAM(IF_DEF_PARAMS(ifp),type);for(rn=route_top(IF_OIFS(ifp));
rn;rn=route_next(rn)){structospf_interface*oi=rn->info;if(!oi)continue;oi->type=
IF_DEF_PARAMS(ifp)->type;if(oi->state>ISM_Down){OSPF_ISM_EVENT_EXECUTE(oi,ISM_In
terfaceDown);OSPF_ISM_EVENT_EXECUTE(oi,ISM_InterfaceUp);}}returnCMD_SUCCESS;}DEF
UN_HIDDEN(ospf_network,ospf_network_cmd,"ospfnetwork<broadcast|non-broadcast|poi
nt-to-multipoint|point-to-point>","OSPFinterfacecommands\n""Networktype\n""Speci
fyOSPFbroadcastmulti-accessnetwork\n""SpecifyOSPFNBMAnetwork\n""SpecifyOSPFpoint
-to-multipointnetwork\n""SpecifyOSPFpoint-to-pointnetwork\n"){returnip_ospf_netw
ork(self,vty,argc,argv);}DEFUN(no_ip_ospf_network,no_ip_ospf_network_cmd,"noipos
pfnetwork[<broadcast|non-broadcast|point-to-multipoint|point-to-point>]",NO_STR"
IPInformation\n""OSPFinterfacecommands\n""Networktype\n""SpecifyOSPFbroadcastmul
ti-accessnetwork\n""SpecifyOSPFNBMAnetwork\n""SpecifyOSPFpoint-to-multipointnetw
ork\n""SpecifyOSPFpoint-to-pointnetwork\n"){VTY_DECLVAR_CONTEXT(interface,ifp);i
ntold_type=IF_DEF_PARAMS(ifp)->type;structroute_node*rn;IF_DEF_PARAMS(ifp)->type
=ospf_default_iftype(ifp);if(IF_DEF_PARAMS(ifp)->type==old_type)returnCMD_SUCCES
S;for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn)){structospf_interface*oi=r
n->info;if(!oi)continue;oi->type=IF_DEF_PARAMS(ifp)->type;if(oi->state>ISM_Down)
{OSPF_ISM_EVENT_EXECUTE(oi,ISM_InterfaceDown);OSPF_ISM_EVENT_EXECUTE(oi,ISM_Inte
rfaceUp);}}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_network,no_ospf_network_cmd,"
noospfnetwork[<broadcast|non-broadcast|point-to-multipoint|point-to-point>]",NO_
STR"OSPFinterfacecommands\n""Networktype\n""SpecifyOSPFbroadcastmulti-accessnetw
ork\n""SpecifyOSPFNBMAnetwork\n""SpecifyOSPFpoint-to-multipointnetwork\n""Specif
yOSPFpoint-to-pointnetwork\n"){returnno_ip_ospf_network(self,vty,argc,argv);}DEF
UN(ip_ospf_priority,ip_ospf_priority_cmd,"ipospfpriority(0-255)[A.B.C.D]","IPInf
ormation\n""OSPFinterfacecommands\n""Routerpriority\n""Priority\n""Addressofinte
rface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;longpriority;structroute_n
ode*rn;structin_addraddr;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);a
rgv_find(argv,argc,"(0-255)",&idx);priority=strtol(argv[idx]->arg,NULL,10);if(ar
gv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){vty_out(
vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;
}params=ospf_get_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}SET_IF_PAR
AM(params,priority);params->priority=priority;for(rn=route_top(IF_OIFS(ifp));rn;
rn=route_next(rn)){structospf_interface*oi=rn->info;if(!oi)continue;if(PRIORITY(
oi)!=OSPF_IF_PARAM(oi,priority)){PRIORITY(oi)=OSPF_IF_PARAM(oi,priority);OSPF_IS
M_EVENT_SCHEDULE(oi,ISM_NeighborChange);}}returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_p
riority,ospf_priority_cmd,"ospfpriority(0-255)[A.B.C.D]","OSPFinterfacecommands\
n""Routerpriority\n""Priority\n""Addressofinterface\n"){returnip_ospf_priority(s
elf,vty,argc,argv);}DEFUN(no_ip_ospf_priority,no_ip_ospf_priority_cmd,"noipospfp
riority[(0-255)[A.B.C.D]]",NO_STR"IPInformation\n""OSPFinterfacecommands\n""Rout
erpriority\n"//ignored"Priority\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(in
terface,ifp);intidx=0;structroute_node*rn;structin_addraddr;structospf_if_params
*params;params=IF_DEF_PARAMS(ifp);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!in
et_aton(argv[idx]->arg,&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C
.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);i
f(params==NULL)returnCMD_SUCCESS;}UNSET_IF_PARAM(params,priority);params->priori
ty=OSPF_ROUTER_PRIORITY_DEFAULT;if(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_para
ms(ifp,addr);ospf_if_update_params(ifp,addr);}for(rn=route_top(IF_OIFS(ifp));rn;
rn=route_next(rn)){structospf_interface*oi=rn->info;if(!oi)continue;if(PRIORITY(
oi)!=OSPF_IF_PARAM(oi,priority)){PRIORITY(oi)=OSPF_IF_PARAM(oi,priority);OSPF_IS
M_EVENT_SCHEDULE(oi,ISM_NeighborChange);}}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_osp
f_priority,no_ospf_priority_cmd,"noospfpriority[(0-255)[A.B.C.D]]",NO_STR"OSPFin
terfacecommands\n""Routerpriority\n""Priority\n""Addressofinterface\n"){returnno
_ip_ospf_priority(self,vty,argc,argv);}DEFUN(ip_ospf_retransmit_interval,ip_ospf
_retransmit_interval_addr_cmd,"ipospfretransmit-interval(3-65535)[A.B.C.D]","IPI
nformation\n""OSPFinterfacecommands\n""Timebetweenretransmittinglostlinkstateadv
ertisements\n""Seconds\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,i
fp);intidx=0;uint32_tseconds;structin_addraddr;structospf_if_params*params;param
s=IF_DEF_PARAMS(ifp);argv_find(argv,argc,"(3-65535)",&idx);seconds=strtol(argv[i
dx]->arg,NULL,10);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(argv[idx
]->arg,&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");returnCMD
_WARNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_update_param
s(ifp,addr);}SET_IF_PARAM(params,retransmit_interval);params->retransmit_interva
l=seconds;returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_retransmit_interval,ospf_retransm
it_interval_cmd,"ospfretransmit-interval(3-65535)[A.B.C.D]","OSPFinterfacecomman
ds\n""Timebetweenretransmittinglostlinkstateadvertisements\n""Seconds\n""Address
ofinterface\n"){returnip_ospf_retransmit_interval(self,vty,argc,argv);}DEFUN(no_
ip_ospf_retransmit_interval,no_ip_ospf_retransmit_interval_addr_cmd,"noipospfret
ransmit-interval[(3-65535)][A.B.C.D]",NO_STR"IPInformation\n""OSPFinterfacecomma
nds\n""Timebetweenretransmittinglostlinkstateadvertisements\n""Seconds\n""Addres
sofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structin_addraddr;s
tructospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(argv_find(argv,argc,"A.B
.C.D",&idx)){if(!inet_aton(argv[idx]->arg,&addr)){vty_out(vty,"Pleasespecifyinte
rfaceaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_if
_params(ifp,addr);if(params==NULL)returnCMD_SUCCESS;}UNSET_IF_PARAM(params,retra
nsmit_interval);params->retransmit_interval=OSPF_RETRANSMIT_INTERVAL_DEFAULT;if(
params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,addr);ospf_if_update_params(
ifp,addr);}returnCMD_SUCCESS;}DEFUN_HIDDEN(no_ospf_retransmit_interval,no_ospf_r
etransmit_interval_cmd,"noospfretransmit-interval[(3-65535)][A.B.C.D]",NO_STR"OS
PFinterfacecommands\n""Timebetweenretransmittinglostlinkstateadvertisements\n""S
econds\n""Addressofinterface\n"){returnno_ip_ospf_retransmit_interval(self,vty,a
rgc,argv);}DEFUN(ip_ospf_transmit_delay,ip_ospf_transmit_delay_addr_cmd,"ipospft
ransmit-delay(1-65535)[A.B.C.D]","IPInformation\n""OSPFinterfacecommands\n""Link
statetransmitdelay\n""Seconds\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(inte
rface,ifp);intidx=0;uint32_tseconds;structin_addraddr;structospf_if_params*param
s;params=IF_DEF_PARAMS(ifp);argv_find(argv,argc,"(1-65535)",&idx);seconds=strtol
(argv[idx]->arg,NULL,10);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!inet_aton(a
rgv[idx]->arg,&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.C.D\n");re
turnCMD_WARNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,addr);ospf_if_updat
e_params(ifp,addr);}SET_IF_PARAM(params,transmit_delay);params->transmit_delay=s
econds;returnCMD_SUCCESS;}DEFUN_HIDDEN(ospf_transmit_delay,ospf_transmit_delay_c
md,"ospftransmit-delay(1-65535)[A.B.C.D]","OSPFinterfacecommands\n""Linkstatetra
nsmitdelay\n""Seconds\n""Addressofinterface\n"){returnip_ospf_transmit_delay(sel
f,vty,argc,argv);}DEFUN(no_ip_ospf_transmit_delay,no_ip_ospf_transmit_delay_addr
_cmd,"noipospftransmit-delay[(1-65535)][A.B.C.D]",NO_STR"IPInformation\n""OSPFin
terfacecommands\n""Linkstatetransmitdelay\n""Seconds\n""Addressofinterface\n"){V
TY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structin_addraddr;structospf_if_param
s*params;params=IF_DEF_PARAMS(ifp);if(argv_find(argv,argc,"A.B.C.D",&idx)){if(!i
net_aton(argv[idx]->arg,&addr)){vty_out(vty,"PleasespecifyinterfaceaddressbyA.B.
C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);
if(params==NULL)returnCMD_SUCCESS;}UNSET_IF_PARAM(params,transmit_delay);params-
>transmit_delay=OSPF_TRANSMIT_DELAY_DEFAULT;if(params!=IF_DEF_PARAMS(ifp)){ospf_
free_if_params(ifp,addr);ospf_if_update_params(ifp,addr);}returnCMD_SUCCESS;}DEF
UN_HIDDEN(no_ospf_transmit_delay,no_ospf_transmit_delay_cmd,"noospftransmit-dela
y[(1-65535)[A.B.C.D]]",NO_STR"OSPFinterfacecommands\n""Linkstatetransmitdelay\n"
"Seconds\n""Addressofinterface\n"){returnno_ip_ospf_transmit_delay(self,vty,argc
,argv);}DEFUN(ip_ospf_area,ip_ospf_area_cmd,"ipospf[(1-65535)]area<A.B.C.D|(0-42
94967295)>[A.B.C.D]","IPInformation\n""OSPFinterfacecommands\n""InstanceID\n""En
ableOSPFonthisinterface\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalva
lue\n""Addressofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;intfor
mat,ret;structin_addrarea_id;structin_addraddr;structospf_if_params*params=NULL;
structroute_node*rn;structospf*ospf=NULL;unsignedshortinstance=0;char*areaid;if(
argv_find(argv,argc,"(1-65535)",&idx))instance=strtol(argv[idx]->arg,NULL,10);ar
gv_find(argv,argc,"area",&idx);areaid=argv[idx+1]->arg;if(ifp->vrf_id&&!instance
)ospf=ospf_lookup_by_vrf_id(ifp->vrf_id);elseospf=ospf_lookup_instance(instance)
;if(instance&&ospf==NULL){params=IF_DEF_PARAMS(ifp);if(OSPF_IF_PARAM_CONFIGURED(
params,if_area)){UNSET_IF_PARAM(params,if_area);ospf=ospf_lookup_by_vrf_id(VRF_D
EFAULT);ospf_interface_area_unset(ospf,ifp);ospf->if_ospf_cli_count--;}returnCMD
_NOT_MY_INSTANCE;}ret=str2area_id(areaid,&area_id,&format);if(ret<0){vty_out(vty
,"PleasespecifyareabyA.B.C.D|<0-4294967295>\n");returnCMD_WARNING_CONFIG_FAILED;
}if(memcmp(ifp->name,"VLINK",5)==0){vty_out(vty,"CannotenableOSPFonavirtuallink.
\n");returnCMD_WARNING_CONFIG_FAILED;}params=IF_DEF_PARAMS(ifp);if(OSPF_IF_PARAM
_CONFIGURED(params,if_area)&&!IPV4_ADDR_SAME(&params->if_area,&area_id)){vty_out
(vty,"Mustremovepreviousareaconfigbeforechangingospfarea\n");returnCMD_WARNING_C
ONFIG_FAILED;}//Checkifwehaveanaddressargandproccessitif(argc==idx+3){if(!inet_a
ton(argv[idx+2]->arg,&addr)){vty_out(vty,"PleasespecifyIntfAddressbyA.B.C.D\n");
returnCMD_WARNING_CONFIG_FAILED;}//update/createaddress-levelparamsparams=ospf_g
et_if_params((ifp),(addr));if(OSPF_IF_PARAM_CONFIGURED(params,if_area)){vty_out(
vty,"Mustremovepreviousarea/addressconfigbeforechangingospfarea");returnCMD_WARN
ING_CONFIG_FAILED;}ospf_if_update_params((ifp),(addr));}if(ospf){for(rn=route_to
p(ospf->networks);rn;rn=route_next(rn)){if(rn->info!=NULL){vty_out(vty,"Pleasere
moveallnetworkcommandsfirst.\n");returnCMD_WARNING_CONFIG_FAILED;}}}/*enableospf
onthisinterfacewitharea_id*/if(params){SET_IF_PARAM(params,if_area);params->if_a
rea=area_id;params->if_area_id_fmt=format;}if(ospf){ospf_interface_area_set(ospf
,ifp);ospf->if_ospf_cli_count++;}returnCMD_SUCCESS;}DEFUN(no_ip_ospf_area,no_ip_
ospf_area_cmd,"noipospf[(1-65535)]area[<A.B.C.D|(0-4294967295)>[A.B.C.D]]",NO_ST
R"IPInformation\n""OSPFinterfacecommands\n""InstanceID\n""DisableOSPFonthisinter
face\n""OSPFareaIDinIPaddressformat\n""OSPFareaIDasadecimalvalue\n""Addressofint
erface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx=0;structospf*ospf;structosp
f_if_params*params;unsignedshortinstance=0;structin_addraddr;if(argv_find(argv,a
rgc,"(1-65535)",&idx))instance=strtol(argv[idx]->arg,NULL,10);if(ifp->vrf_id&&!i
nstance)ospf=ospf_lookup_by_vrf_id(ifp->vrf_id);elseospf=ospf_lookup_instance(in
stance);if(ospf==NULL)returnCMD_NOT_MY_INSTANCE;argv_find(argv,argc,"area",&idx)
;//Checkifwehaveanaddressargandproccessitif(argc==idx+3){if(!inet_aton(argv[idx+
2]->arg,&addr)){vty_out(vty,"PleasespecifyIntfAddressbyA.B.C.D\n");returnCMD_WAR
NING_CONFIG_FAILED;}params=ospf_lookup_if_params(ifp,addr);if((params)==NULL)ret
urnCMD_SUCCESS;}elseparams=IF_DEF_PARAMS(ifp);if(!OSPF_IF_PARAM_CONFIGURED(param
s,if_area)){vty_out(vty,"Can'tfindspecifiedinterfaceareaconfiguration.\n");retur
nCMD_WARNING_CONFIG_FAILED;}UNSET_IF_PARAM(params,if_area);if(params!=IF_DEF_PAR
AMS((ifp))){ospf_free_if_params((ifp),(addr));ospf_if_update_params((ifp),(addr)
);}ospf_interface_area_unset(ospf,ifp);ospf->if_ospf_cli_count--;returnCMD_SUCCE
SS;}DEFUN(ospf_redistribute_source,ospf_redistribute_source_cmd,"redistribute"FR
R_REDIST_STR_OSPFD"[{metric(0-16777214)|metric-type(1-2)|route-mapWORD}]",REDIST
_STRFRR_REDIST_HELP_STR_OSPFD"Metricforredistributedroutes\n""OSPFdefaultmetric\
n""OSPFexteriormetrictypeforredistributedroutes\n""SetOSPFExternalType1/2metrics
\n""Routemapreference\n""Pointertoroute-mapentries\n"){VTY_DECLVAR_INSTANCE_CONT
EXT(ospf,ospf);intidx_protocol=1;intsource;inttype=-1;intmetric=-1;structospf_re
dist*red;intidx=0;if(!ospf)returnCMD_SUCCESS;/*Getdistributesource.*/source=prot
o_redistnum(AFI_IP,argv[idx_protocol]->text);if(source<0)returnCMD_WARNING_CONFI
G_FAILED;red=ospf_redist_add(ospf,source,0);/*Getmetricvalue.*/if(argv_find(argv
,argc,"(0-16777214)",&idx)){if(!str2metric(argv[idx]->arg,&metric))returnCMD_WAR
NING_CONFIG_FAILED;}idx=1;/*Getmetrictype.*/if(argv_find(argv,argc,"(1-2)",&idx)
){if(!str2metric_type(argv[idx]->arg,&type))returnCMD_WARNING_CONFIG_FAILED;}idx
=1;/*Getroute-map*/if(argv_find(argv,argc,"WORD",&idx)){ospf_routemap_set(red,ar
gv[idx]->arg);}elseospf_routemap_unset(red);returnospf_redistribute_set(ospf,sou
rce,0,type,metric);}DEFUN(no_ospf_redistribute_source,no_ospf_redistribute_sourc
e_cmd,"noredistribute"FRR_REDIST_STR_OSPFD"[{metric(0-16777214)|metric-type(1-2)
|route-mapWORD}]",NO_STRREDIST_STRFRR_REDIST_HELP_STR_OSPFD"Metricforredistribut
edroutes\n""OSPFdefaultmetric\n""OSPFexteriormetrictypeforredistributedroutes\n"
"SetOSPFExternalType1/2metrics\n""Routemapreference\n""Pointertoroute-mapentries
\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_protocol=2;intsource;structo
spf_redist*red;source=proto_redistnum(AFI_IP,argv[idx_protocol]->text);if(source
<0)returnCMD_WARNING_CONFIG_FAILED;red=ospf_redist_lookup(ospf,source,0);if(!red
)returnCMD_SUCCESS;ospf_routemap_unset(red);returnospf_redistribute_unset(ospf,s
ource,0);}DEFUN(ospf_redistribute_instance_source,ospf_redistribute_instance_sou
rce_cmd,"redistribute<ospf|table>(1-65535)[{metric(0-16777214)|metric-type(1-2)|
route-mapWORD}]",REDIST_STR"OpenShortestPathFirst\n""Non-mainKernelRoutingTable\
n""InstanceID/TableID\n""Metricforredistributedroutes\n""OSPFdefaultmetric\n""OS
PFexteriormetrictypeforredistributedroutes\n""SetOSPFExternalType1/2metrics\n""R
outemapreference\n""Pointertoroute-mapentries\n"){VTY_DECLVAR_INSTANCE_CONTEXT(o
spf,ospf);intidx_ospf_table=1;intidx_number=2;intidx=3;intsource;inttype=-1;intm
etric=-1;unsignedshortinstance;structospf_redist*red;if(!ospf)returnCMD_SUCCESS;
source=proto_redistnum(AFI_IP,argv[idx_ospf_table]->text);instance=strtoul(argv[
idx_number]->arg,NULL,10);if(!ospf)returnCMD_SUCCESS;if((source==ZEBRA_ROUTE_OSP
F)&&!ospf->instance){vty_out(vty,"Instanceredistributioninnon-instancedOSPFnotal
lowed\n");returnCMD_WARNING_CONFIG_FAILED;}if((source==ZEBRA_ROUTE_OSPF)&&(ospf-
>instance==instance)){vty_out(vty,"SameinstanceOSPFredistributionnotallowed\n");
returnCMD_WARNING_CONFIG_FAILED;}/*Getmetricvalue.*/if(argv_find(argv,argc,"metr
ic",&idx))if(!str2metric(argv[idx+1]->arg,&metric))returnCMD_WARNING_CONFIG_FAIL
ED;idx=3;/*Getmetrictype.*/if(argv_find(argv,argc,"metric-type",&idx))if(!str2me
tric_type(argv[idx+1]->arg,&type))returnCMD_WARNING_CONFIG_FAILED;red=ospf_redis
t_add(ospf,source,instance);idx=3;if(argv_find(argv,argc,"route-map",&idx))ospf_
routemap_set(red,argv[idx+1]->arg);elseospf_routemap_unset(red);returnospf_redis
tribute_set(ospf,source,instance,type,metric);}DEFUN(no_ospf_redistribute_instan
ce_source,no_ospf_redistribute_instance_source_cmd,"noredistribute<ospf|table>(1
-65535)[{metric(0-16777214)|metric-type(1-2)|route-mapWORD}]",NO_STRREDIST_STR"O
penShortestPathFirst\n""Non-mainKernelRoutingTable\n""InstanceID/TableId\n""Metr
icforredistributedroutes\n""OSPFdefaultmetric\n""OSPFexteriormetrictypeforredist
ributedroutes\n""SetOSPFExternalType1/2metrics\n""Routemapreference\n""Pointerto
route-mapentries\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_ospf_table=2
;intidx_number=3;unsignedintinstance;structospf_redist*red;intsource;if(strncmp(
argv[idx_ospf_table]->arg,"o",1)==0)source=ZEBRA_ROUTE_OSPF;elsesource=ZEBRA_ROU
TE_TABLE;instance=strtoul(argv[idx_number]->arg,NULL,10);if((source==ZEBRA_ROUTE
_OSPF)&&!ospf->instance){vty_out(vty,"Instanceredistributioninnon-instancedOSPFn
otallowed\n");returnCMD_WARNING_CONFIG_FAILED;}if((source==ZEBRA_ROUTE_OSPF)&&(o
spf->instance==instance)){vty_out(vty,"SameinstanceOSPFredistributionnotallowed\
n");returnCMD_WARNING_CONFIG_FAILED;}red=ospf_redist_lookup(ospf,source,instance
);if(!red)returnCMD_SUCCESS;ospf_routemap_unset(red);returnospf_redistribute_uns
et(ospf,source,instance);}DEFUN(ospf_distribute_list_out,ospf_distribute_list_ou
t_cmd,"distribute-listWORDout"FRR_REDIST_STR_OSPFD,"Filternetworksinroutingupdat
es\n""Access-listname\n"OUT_STRFRR_REDIST_HELP_STR_OSPFD){VTY_DECLVAR_INSTANCE_C
ONTEXT(ospf,ospf);intidx_word=1;intsource;char*proto=argv[argc-1]->text;/*Getdis
tributesource.*/source=proto_redistnum(AFI_IP,proto);if(source<0)returnCMD_WARNI
NG_CONFIG_FAILED;returnospf_distribute_list_out_set(ospf,source,argv[idx_word]->
arg);}DEFUN(no_ospf_distribute_list_out,no_ospf_distribute_list_out_cmd,"nodistr
ibute-listWORDout"FRR_REDIST_STR_OSPFD,NO_STR"Filternetworksinroutingupdates\n""
Access-listname\n"OUT_STRFRR_REDIST_HELP_STR_OSPFD){VTY_DECLVAR_INSTANCE_CONTEXT
(ospf,ospf);intidx_word=2;intsource;char*proto=argv[argc-1]->text;source=proto_r
edistnum(AFI_IP,proto);if(source<0)returnCMD_WARNING_CONFIG_FAILED;returnospf_di
stribute_list_out_unset(ospf,source,argv[idx_word]->arg);}/*Defaultinformationor
iginate.*/DEFUN(ospf_default_information_originate,ospf_default_information_orig
inate_cmd,"default-informationoriginate[{always|metric(0-16777214)|metric-type(1
-2)|route-mapWORD}]","Controldistributionofdefaultinformation\n""Distributeadefa
ultroute\n""Alwaysadvertisedefaultroute\n""OSPFdefaultmetric\n""OSPFmetric\n""OS
PFmetrictypefordefaultroutes\n""SetOSPFExternalType1/2metrics\n""Routemapreferen
ce\n""Pointertoroute-mapentries\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intd
efault_originate=DEFAULT_ORIGINATE_ZEBRA;inttype=-1;intmetric=-1;structospf_redi
st*red;intidx=0;red=ospf_redist_add(ospf,DEFAULT_ROUTE,0);/*Checkwhether"always"
wasspecified*/if(argv_find(argv,argc,"always",&idx))default_originate=DEFAULT_OR
IGINATE_ALWAYS;idx=1;/*Getmetricvalue*/if(argv_find(argv,argc,"(0-16777214)",&id
x)){if(!str2metric(argv[idx]->arg,&metric))returnCMD_WARNING_CONFIG_FAILED;}idx=
1;/*Getmetrictype.*/if(argv_find(argv,argc,"(1-2)",&idx)){if(!str2metric_type(ar
gv[idx]->arg,&type))returnCMD_WARNING_CONFIG_FAILED;}idx=1;/*Getroute-map*/if(ar
gv_find(argv,argc,"WORD",&idx))ospf_routemap_set(red,argv[idx]->arg);elseospf_ro
utemap_unset(red);returnospf_redistribute_default_set(ospf,default_originate,typ
e,metric);}DEFUN(no_ospf_default_information_originate,no_ospf_default_informati
on_originate_cmd,"nodefault-informationoriginate[{always|metric(0-16777214)|metr
ic-type(1-2)|route-mapWORD}]",NO_STR"Controldistributionofdefaultinformation\n""
Distributeadefaultroute\n""Alwaysadvertisedefaultroute\n""OSPFdefaultmetric\n""O
SPFmetric\n""OSPFmetrictypefordefaultroutes\n""SetOSPFExternalType1/2metrics\n""
Routemapreference\n""Pointertoroute-mapentries\n"){VTY_DECLVAR_INSTANCE_CONTEXT(
ospf,ospf);structprefix_ipv4p;structospf_external*ext;structospf_redist*red;p.fa
mily=AF_INET;p.prefix.s_addr=0;p.prefixlen=0;ospf_external_lsa_flush(ospf,DEFAUL
T_ROUTE,&p,0);ext=ospf_external_lookup(ospf,DEFAULT_ROUTE,0);if(ext&&EXTERNAL_IN
FO(ext)){ospf_external_info_delete(ospf,DEFAULT_ROUTE,0,p);ospf_external_del(osp
f,DEFAULT_ROUTE,0);}red=ospf_redist_lookup(ospf,DEFAULT_ROUTE,0);if(!red)returnC
MD_SUCCESS;ospf_routemap_unset(red);returnospf_redistribute_default_unset(ospf);
}DEFUN(ospf_default_metric,ospf_default_metric_cmd,"default-metric(0-16777214)",
"Setmetricofredistributedroutes\n""Defaultmetric\n"){VTY_DECLVAR_INSTANCE_CONTEX
T(ospf,ospf);intidx_number=1;intmetric=-1;if(!str2metric(argv[idx_number]->arg,&
metric))returnCMD_WARNING_CONFIG_FAILED;ospf->default_metric=metric;returnCMD_SU
CCESS;}DEFUN(no_ospf_default_metric,no_ospf_default_metric_cmd,"nodefault-metric
[(0-16777214)]",NO_STR"Setmetricofredistributedroutes\n""Defaultmetric\n"){VTY_D
ECLVAR_INSTANCE_CONTEXT(ospf,ospf);ospf->default_metric=-1;returnCMD_SUCCESS;}DE
FUN(ospf_distance,ospf_distance_cmd,"distance(1-255)","Administrativedistance\n"
"OSPFAdministrativedistance\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx_n
umber=1;ospf->distance_all=atoi(argv[idx_number]->arg);returnCMD_SUCCESS;}DEFUN(
no_ospf_distance,no_ospf_distance_cmd,"nodistance(1-255)",NO_STR"Administratived
istance\n""OSPFAdministrativedistance\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf
);ospf->distance_all=0;returnCMD_SUCCESS;}DEFUN(no_ospf_distance_ospf,no_ospf_di
stance_ospf_cmd,"nodistanceospf[{intra-area[(1-255)]|inter-area[(1-255)]|externa
l[(1-255)]}]",NO_STR"Administrativedistance\n""OSPFadministrativedistance\n""Int
ra-arearoutes\n""Distanceforintra-arearoutes\n""Inter-arearoutes\n""Distancefori
nter-arearoutes\n""Externalroutes\n""Distanceforexternalroutes\n"){VTY_DECLVAR_I
NSTANCE_CONTEXT(ospf,ospf);intidx=0;if(!ospf)returnCMD_SUCCESS;if(argv_find(argv
,argc,"intra-area",&idx)||argc==3)idx=ospf->distance_intra=0;if(argv_find(argv,a
rgc,"inter-area",&idx)||argc==3)idx=ospf->distance_inter=0;if(argv_find(argv,arg
c,"external",&idx)||argc==3)ospf->distance_external=0;returnCMD_SUCCESS;}DEFUN(o
spf_distance_ospf,ospf_distance_ospf_cmd,"distanceospf{intra-area(1-255)|inter-a
rea(1-255)|external(1-255)}","Administrativedistance\n""OSPFadministrativedistan
ce\n""Intra-arearoutes\n""Distanceforintra-arearoutes\n""Inter-arearoutes\n""Dis
tanceforinter-arearoutes\n""Externalroutes\n""Distanceforexternalroutes\n"){VTY_
DECLVAR_INSTANCE_CONTEXT(ospf,ospf);intidx=0;ospf->distance_intra=0;ospf->distan
ce_inter=0;ospf->distance_external=0;if(argv_find(argv,argc,"intra-area",&idx))o
spf->distance_intra=atoi(argv[idx+1]->arg);idx=0;if(argv_find(argv,argc,"inter-a
rea",&idx))ospf->distance_inter=atoi(argv[idx+1]->arg);idx=0;if(argv_find(argv,a
rgc,"external",&idx))ospf->distance_external=atoi(argv[idx+1]->arg);returnCMD_SU
CCESS;}#if0DEFUN(ospf_distance_source,ospf_distance_source_cmd,"distance(1-255)A
.B.C.D/M","Administrativedistance\n""Distancevalue\n""IPsourceprefix\n"){VTY_DEC
LVAR_CONTEXT(ospf,ospf);intidx_number=1;intidx_ipv4_prefixlen=2;if(!ospf)returnC
MD_SUCCESS;ospf_distance_set(vty,ospf,argv[idx_number]->arg,argv[idx_ipv4_prefix
len]->arg,NULL);returnCMD_SUCCESS;}DEFUN(no_ospf_distance_source,no_ospf_distanc
e_source_cmd,"nodistance(1-255)A.B.C.D/M",NO_STR"Administrativedistance\n""Dista
ncevalue\n""IPsourceprefix\n"){VTY_DECLVAR_CONTEXT(ospf,ospf);intidx_number=2;in
tidx_ipv4_prefixlen=3;if(!ospf)returnCMD_SUCCESS;ospf_distance_unset(vty,ospf,ar
gv[idx_number]->arg,argv[idx_ipv4_prefixlen]->arg,NULL);returnCMD_SUCCESS;}DEFUN
(ospf_distance_source_access_list,ospf_distance_source_access_list_cmd,"distance
(1-255)A.B.C.D/MWORD","Administrativedistance\n""Distancevalue\n""IPsourceprefix
\n""Accesslistname\n"){VTY_DECLVAR_CONTEXT(ospf,ospf);intidx_number=1;intidx_ipv
4_prefixlen=2;intidx_word=3;if(!ospf)returnCMD_SUCCESS;ospf_distance_set(vty,osp
f,argv[idx_number]->arg,argv[idx_ipv4_prefixlen]->arg,argv[idx_word]->arg);retur
nCMD_SUCCESS;}DEFUN(no_ospf_distance_source_access_list,no_ospf_distance_source_
access_list_cmd,"nodistance(1-255)A.B.C.D/MWORD",NO_STR"Administrativedistance\n
""Distancevalue\n""IPsourceprefix\n""Accesslistname\n"){VTY_DECLVAR_CONTEXT(ospf
,ospf);intidx_number=2;intidx_ipv4_prefixlen=3;intidx_word=4;if(!ospf)returnCMD_
SUCCESS;ospf_distance_unset(vty,ospf,argv[idx_number]->arg,argv[idx_ipv4_prefixl
en]->arg,argv[idx_word]->arg);returnCMD_SUCCESS;}#endifDEFUN(ip_ospf_mtu_ignore,
ip_ospf_mtu_ignore_addr_cmd,"ipospfmtu-ignore[A.B.C.D]","IPInformation\n""OSPFin
terfacecommands\n""DisableMTUmismatchdetectiononthisinterface\n""Addressofinterf
ace\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=3;structin_addraddr;intre
t;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(argc==4){ret=inet_ato
n(argv[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"Pleasespecifyinterfaceaddress
byA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_get_if_params(ifp,add
r);ospf_if_update_params(ifp,addr);}params->mtu_ignore=1;if(params->mtu_ignore!=
OSPF_MTU_IGNORE_DEFAULT)SET_IF_PARAM(params,mtu_ignore);else{UNSET_IF_PARAM(para
ms,mtu_ignore);if(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,addr);ospf
_if_update_params(ifp,addr);}}returnCMD_SUCCESS;}DEFUN(no_ip_ospf_mtu_ignore,no_
ip_ospf_mtu_ignore_addr_cmd,"noipospfmtu-ignore[A.B.C.D]",NO_STR"IPInformation\n
""OSPFinterfacecommands\n""DisableMTUmismatchdetectiononthisinterface\n""Address
ofinterface\n"){VTY_DECLVAR_CONTEXT(interface,ifp);intidx_ipv4=4;structin_addrad
dr;intret;structospf_if_params*params;params=IF_DEF_PARAMS(ifp);if(argc==5){ret=
inet_aton(argv[idx_ipv4]->arg,&addr);if(!ret){vty_out(vty,"Pleasespecifyinterfac
eaddressbyA.B.C.D\n");returnCMD_WARNING_CONFIG_FAILED;}params=ospf_get_if_params
(ifp,addr);ospf_if_update_params(ifp,addr);}params->mtu_ignore=0;if(params->mtu_
ignore!=OSPF_MTU_IGNORE_DEFAULT)SET_IF_PARAM(params,mtu_ignore);else{UNSET_IF_PA
RAM(params,mtu_ignore);if(params!=IF_DEF_PARAMS(ifp)){ospf_free_if_params(ifp,ad
dr);ospf_if_update_params(ifp,addr);}}returnCMD_SUCCESS;}DEFUN(ospf_max_metric_r
outer_lsa_admin,ospf_max_metric_router_lsa_admin_cmd,"max-metricrouter-lsaadmini
strative","OSPFmaximum/infinite-distancemetric\n""AdvertiseownRouter-LSAwithinfi
nitedistance(stubrouter)\n""Administrativelyapplied,foranindefiniteperiod\n"){VT
Y_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);structlistnode*ln;structospf_area*area;for
(ALL_LIST_ELEMENTS_RO(ospf->areas,ln,area)){SET_FLAG(area->stub_router_state,OSP
F_AREA_ADMIN_STUB_ROUTED);if(!CHECK_FLAG(area->stub_router_state,OSPF_AREA_IS_ST
UB_ROUTED))ospf_router_lsa_update_area(area);}/*Allowsforareasconfiguredlatertog
ettheproperty*/ospf->stub_router_admin_set=OSPF_STUB_ROUTER_ADMINISTRATIVE_SET;r
eturnCMD_SUCCESS;}DEFUN(no_ospf_max_metric_router_lsa_admin,no_ospf_max_metric_r
outer_lsa_admin_cmd,"nomax-metricrouter-lsaadministrative",NO_STR"OSPFmaximum/in
finite-distancemetric\n""AdvertiseownRouter-LSAwithinfinitedistance(stubrouter)\
n""Administrativelyapplied,foranindefiniteperiod\n"){VTY_DECLVAR_INSTANCE_CONTEX
T(ospf,ospf);structlistnode*ln;structospf_area*area;for(ALL_LIST_ELEMENTS_RO(osp
f->areas,ln,area)){UNSET_FLAG(area->stub_router_state,OSPF_AREA_ADMIN_STUB_ROUTE
D);/*Don'ttrampleonthestart-upstubtimer*/if(CHECK_FLAG(area->stub_router_state,O
SPF_AREA_IS_STUB_ROUTED)&&!area->t_stub_router){UNSET_FLAG(area->stub_router_sta
te,OSPF_AREA_IS_STUB_ROUTED);ospf_router_lsa_update_area(area);}}ospf->stub_rout
er_admin_set=OSPF_STUB_ROUTER_ADMINISTRATIVE_UNSET;returnCMD_SUCCESS;}DEFUN(ospf
_max_metric_router_lsa_startup,ospf_max_metric_router_lsa_startup_cmd,"max-metri
crouter-lsaon-startup(5-86400)","OSPFmaximum/infinite-distancemetric\n""Advertis
eownRouter-LSAwithinfinitedistance(stubrouter)\n""AutomaticallyadvertisestubRout
er-LSAonstartupofOSPF\n""Time(seconds)toadvertiseselfasstub-router\n"){VTY_DECLV
AR_INSTANCE_CONTEXT(ospf,ospf);intidx_number=3;unsignedintseconds;if(argc<4){vty
_out(vty,"%%Mustsupplystub-routerperiod");returnCMD_WARNING_CONFIG_FAILED;}secon
ds=strtoul(argv[idx_number]->arg,NULL,10);ospf->stub_router_startup_time=seconds
;returnCMD_SUCCESS;}DEFUN(no_ospf_max_metric_router_lsa_startup,no_ospf_max_metr
ic_router_lsa_startup_cmd,"nomax-metricrouter-lsaon-startup[(5-86400)]",NO_STR"O
SPFmaximum/infinite-distancemetric\n""AdvertiseownRouter-LSAwithinfinitedistance
(stubrouter)\n""AutomaticallyadvertisestubRouter-LSAonstartupofOSPF\n""Time(seco
nds)toadvertiseselfasstub-router\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);str
uctlistnode*ln;structospf_area*area;ospf->stub_router_startup_time=OSPF_STUB_ROU
TER_UNCONFIGURED;for(ALL_LIST_ELEMENTS_RO(ospf->areas,ln,area)){SET_FLAG(area->s
tub_router_state,OSPF_AREA_WAS_START_STUB_ROUTED);OSPF_TIMER_OFF(area->t_stub_ro
uter);/*Don'ttrampleonadminstubrouted*/if(!CHECK_FLAG(area->stub_router_state,OS
PF_AREA_ADMIN_STUB_ROUTED)){UNSET_FLAG(area->stub_router_state,OSPF_AREA_IS_STUB
_ROUTED);ospf_router_lsa_update_area(area);}}returnCMD_SUCCESS;}DEFUN(ospf_max_m
etric_router_lsa_shutdown,ospf_max_metric_router_lsa_shutdown_cmd,"max-metricrou
ter-lsaon-shutdown(5-100)","OSPFmaximum/infinite-distancemetric\n""AdvertiseownR
outer-LSAwithinfinitedistance(stubrouter)\n""Advertisestub-routerpriortofullshut
downofOSPF\n""Time(seconds)towaittillfullshutdown\n"){VTY_DECLVAR_INSTANCE_CONTE
XT(ospf,ospf);intidx_number=3;unsignedintseconds;if(argc<4){vty_out(vty,"%%Musts
upplystub-routershutdownperiod");returnCMD_WARNING_CONFIG_FAILED;}seconds=strtou
l(argv[idx_number]->arg,NULL,10);ospf->stub_router_shutdown_time=seconds;returnC
MD_SUCCESS;}DEFUN(no_ospf_max_metric_router_lsa_shutdown,no_ospf_max_metric_rout
er_lsa_shutdown_cmd,"nomax-metricrouter-lsaon-shutdown[(5-100)]",NO_STR"OSPFmaxi
mum/infinite-distancemetric\n""AdvertiseownRouter-LSAwithinfinitedistance(stubro
uter)\n""Advertisestub-routerpriortofullshutdownofOSPF\n""Time(seconds)towaittil
lfullshutdown\n"){VTY_DECLVAR_INSTANCE_CONTEXT(ospf,ospf);ospf->stub_router_shut
down_time=OSPF_STUB_ROUTER_UNCONFIGURED;returnCMD_SUCCESS;}staticvoidconfig_writ
e_stub_router(structvty*vty,structospf*ospf){structlistnode*ln;structospf_area*a
rea;if(ospf->stub_router_startup_time!=OSPF_STUB_ROUTER_UNCONFIGURED)vty_out(vty
,"max-metricrouter-lsaon-startup%u\n",ospf->stub_router_startup_time);if(ospf->s
tub_router_shutdown_time!=OSPF_STUB_ROUTER_UNCONFIGURED)vty_out(vty,"max-metricr
outer-lsaon-shutdown%u\n",ospf->stub_router_shutdown_time);for(ALL_LIST_ELEMENTS
_RO(ospf->areas,ln,area)){if(CHECK_FLAG(area->stub_router_state,OSPF_AREA_ADMIN_
STUB_ROUTED)){vty_out(vty,"max-metricrouter-lsaadministrative\n");break;}}return
;}staticvoidshow_ip_ospf_route_network(structvty*vty,structospf*ospf,structroute
_table*rt,json_object*json){structroute_node*rn;structospf_route*or;structlistno
de*pnode,*pnnode;structospf_path*path;json_object*json_route=NULL,*json_nexthop_
array=NULL,*json_nexthop=NULL;if(!json)vty_out(vty,"============OSPFnetworkrouti
ngtable============\n");for(rn=route_top(rt);rn;rn=route_next(rn)){if((or=rn->in
fo)==NULL)continue;charbuf1[PREFIX2STR_BUFFER];memset(buf1,0,sizeof(buf1));prefi
x2str(&rn->p,buf1,sizeof(buf1));json_route=json_object_new_object();if(json){jso
n_object_object_add(json,buf1,json_route);json_object_to_json_string_ext(json,JS
ON_C_TO_STRING_NOSLASHESCAPE);}switch(or->path_type){caseOSPF_PATH_INTER_AREA:if
(or->type==OSPF_DESTINATION_NETWORK){if(json){json_object_string_add(json_route,
"routeType","NIA");json_object_int_add(json_route,"cost",or->cost);json_object_s
tring_add(json_route,"area",inet_ntoa(or->u.std.area_id));}else{vty_out(vty,"NIA
%-18s[%d]area:%s\n",buf1,or->cost,inet_ntoa(or->u.std.area_id));}}elseif(or->typ
e==OSPF_DESTINATION_DISCARD){if(json){json_object_string_add(json_route,"routeTy
pe","DIA");}else{vty_out(vty,"DIA%-18sDiscardentry\n",buf1);}}break;caseOSPF_PAT
H_INTRA_AREA:if(json){json_object_string_add(json_route,"routeType","N");json_ob
ject_int_add(json_route,"cost",or->cost);json_object_string_add(json_route,"area
",inet_ntoa(or->u.std.area_id));}else{vty_out(vty,"N%-18s[%d]area:%s\n",buf1,or-
>cost,inet_ntoa(or->u.std.area_id));}break;default:break;}if(or->type==OSPF_DEST
INATION_NETWORK){if(json){json_nexthop_array=json_object_new_array();json_object
_object_add(json_route,"nexthops",json_nexthop_array);}for(ALL_LIST_ELEMENTS(or-
>paths,pnode,pnnode,path)){if(json){json_nexthop=json_object_new_object();json_o
bject_array_add(json_nexthop_array,json_nexthop);}if(if_lookup_by_index(path->if
index,ospf->vrf_id)){if(path->nexthop.s_addr==0){if(json){json_object_string_add
(json_nexthop,"ip","");json_object_string_add(json_nexthop,"directlyattachedto",
ifindex2ifname(path->ifindex,ospf->vrf_id));}else{vty_out(vty,"%24sdirectlyattac
hedto%s\n","",ifindex2ifname(path->ifindex,ospf->vrf_id));}}else{if(json){json_o
bject_string_add(json_nexthop,"ip",inet_ntoa(path->nexthop));json_object_string_
add(json_nexthop,"via",ifindex2ifname(path->ifindex,ospf->vrf_id));}else{vty_out
(vty,"%24svia%s,%s\n","",inet_ntoa(path->nexthop),ifindex2ifname(path->ifindex,o
spf->vrf_id));}}}}}if(!json)json_object_free(json_route);}if(!json)vty_out(vty,"
\n");}staticvoidshow_ip_ospf_route_router(structvty*vty,structospf*ospf,structro
ute_table*rtrs,json_object*json){structroute_node*rn;structospf_route*or;structl
istnode*pnode;structlistnode*node;structospf_path*path;json_object*json_route=NU
LL,*json_nexthop_array=NULL,*json_nexthop=NULL;if(!json)vty_out(vty,"===========
=OSPFrouterroutingtable=============\n");for(rn=route_top(rtrs);rn;rn=route_next
(rn)){if(rn->info==NULL)continue;intflag=0;json_route=json_object_new_object();i
f(json){json_object_object_add(json,inet_ntoa(rn->p.u.prefix4),json_route);json_
object_string_add(json_route,"routeType","R");}else{vty_out(vty,"R%-15s",inet_nt
oa(rn->p.u.prefix4));}for(ALL_LIST_ELEMENTS_RO((structlist*)rn->info,node,or)){i
f(flag++){if(!json)vty_out(vty,"%24s","");}/*Showpath.*/if(json){json_object_int
_add(json_route,"cost",or->cost);json_object_string_add(json_route,"area",inet_n
toa(or->u.std.area_id));if(or->path_type==OSPF_PATH_INTER_AREA)json_object_boole
an_true_add(json_route,"IA");if(or->u.std.flags&ROUTER_LSA_BORDER)json_object_st
ring_add(json_route,"routerType","abr");elseif(or->u.std.flags&ROUTER_LSA_EXTERN
AL)json_object_string_add(json_route,"routerType","asbr");}else{vty_out(vty,"%s[
%d]area:%s",(or->path_type==OSPF_PATH_INTER_AREA?"IA":""),or->cost,inet_ntoa(or-
>u.std.area_id));/*Showflags.*/vty_out(vty,"%s%s\n",(or->u.std.flags&ROUTER_LSA_
BORDER?",ABR":""),(or->u.std.flags&ROUTER_LSA_EXTERNAL?",ASBR":""));}if(json){js
on_nexthop_array=json_object_new_array();json_object_object_add(json_route,"next
hops",json_nexthop_array);}for(ALL_LIST_ELEMENTS_RO(or->paths,pnode,path)){if(js
on){json_nexthop=json_object_new_object();json_object_array_add(json_nexthop_arr
ay,json_nexthop);}if(if_lookup_by_index(path->ifindex,ospf->vrf_id)){if(path->ne
xthop.s_addr==0){if(json){json_object_string_add(json_nexthop,"ip","");json_obje
ct_string_add(json_nexthop,"directlyattachedto",ifindex2ifname(path->ifindex,osp
f->vrf_id));}else{vty_out(vty,"%24sdirectlyattachedto%s\n","",ifindex2ifname(pat
h->ifindex,ospf->vrf_id));}}else{if(json){json_object_string_add(json_nexthop,"i
p",inet_ntoa(path->nexthop));json_object_string_add(json_nexthop,"via",ifindex2i
fname(path->ifindex,ospf->vrf_id));}else{vty_out(vty,"%24svia%s,%s\n","",inet_nt
oa(path->nexthop),ifindex2ifname(path->ifindex,ospf->vrf_id));}}}}}if(!json)json
_object_free(json_route);}if(!json)vty_out(vty,"\n");}staticvoidshow_ip_ospf_rou
te_external(structvty*vty,structospf*ospf,structroute_table*rt,json_object*json)
{structroute_node*rn;structospf_route*er;structlistnode*pnode,*pnnode;structospf
_path*path;json_object*json_route=NULL,*json_nexthop_array=NULL,*json_nexthop=NU
LL;if(!json)vty_out(vty,"============OSPFexternalroutingtable===========\n");for
(rn=route_top(rt);rn;rn=route_next(rn)){if((er=rn->info)==NULL)continue;charbuf1
[19];snprintf(buf1,19,"%s/%d",inet_ntoa(rn->p.u.prefix4),rn->p.prefixlen);json_r
oute=json_object_new_object();if(json){json_object_object_add(json,buf1,json_rou
te);json_object_to_json_string_ext(json,JSON_C_TO_STRING_NOSLASHESCAPE);}switch(
er->path_type){caseOSPF_PATH_TYPE1_EXTERNAL:if(json){json_object_string_add(json
_route,"routeType","NE1");json_object_int_add(json_route,"cost",er->cost);}else{
vty_out(vty,"NE1%-18s[%d]tag:%"ROUTE_TAG_PRI"\n",buf1,er->cost,er->u.ext.tag);}b
reak;caseOSPF_PATH_TYPE2_EXTERNAL:if(json){json_object_string_add(json_route,"ro
uteType","NE2");json_object_int_add(json_route,"cost",er->cost);}else{vty_out(vt
y,"NE2%-18s[%d/%d]tag:%"ROUTE_TAG_PRI"\n",buf1,er->cost,er->u.ext.type2_cost,er-
>u.ext.tag);}break;}if(json){json_nexthop_array=json_object_new_array();json_obj
ect_object_add(json_route,"nexthops",json_nexthop_array);}for(ALL_LIST_ELEMENTS(
er->paths,pnode,pnnode,path)){if(json){json_nexthop=json_object_new_object();jso
n_object_array_add(json_nexthop_array,json_nexthop);}if(if_lookup_by_index(path-
>ifindex,ospf->vrf_id)){if(path->nexthop.s_addr==0){if(json){json_object_string_
add(json_nexthop,"ip","");json_object_string_add(json_nexthop,"directlyattachedt
o",ifindex2ifname(path->ifindex,ospf->vrf_id));}else{vty_out(vty,"%24sdirectlyat
tachedto%s\n","",ifindex2ifname(path->ifindex,ospf->vrf_id));}}else{if(json){jso
n_object_string_add(json_nexthop,"ip",inet_ntoa(path->nexthop));json_object_stri
ng_add(json_nexthop,"via",ifindex2ifname(path->ifindex,ospf->vrf_id));}else{vty_
out(vty,"%24svia%s,%s\n","",inet_ntoa(path->nexthop),ifindex2ifname(path->ifinde
x,ospf->vrf_id));}}}}if(!json)json_object_free(json_route);}if(!json)vty_out(vty
,"\n");}staticintshow_ip_ospf_border_routers_common(structvty*vty,structospf*osp
f,uint8_tuse_vrf){if(ospf->instance)vty_out(vty,"\nOSPFInstance:%d\n\n",ospf->in
stance);ospf_show_vrf_name(ospf,vty,NULL,use_vrf);if(ospf->new_table==NULL){vty_
out(vty,"NoOSPFroutinginformationexist\n");returnCMD_SUCCESS;}/*ShowNetworkroute
s.show_ip_ospf_route_network(vty,ospf->new_table);*//*ShowRouterroutes.*/show_ip
_ospf_route_router(vty,ospf,ospf->new_rtrs,NULL);vty_out(vty,"\n");returnCMD_SUC
CESS;}DEFUN(show_ip_ospf_border_routers,show_ip_ospf_border_routers_cmd,"showipo
spf[vrf<NAME|all>]border-routers",SHOW_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_
STR"AllVRFs\n""ShowalltheABR'sandASBR's\n"){structospf*ospf=NULL;structlistnode*
node=NULL;char*vrf_name=NULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;inti
dx_vrf=0;uint8_tuse_vrf=0;OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf)
;if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)
){if(!ospf->oi_running)continue;ret=show_ip_ospf_border_routers_common(vty,ospf,
use_vrf);}}else{ospf=ospf_lookup_by_inst_name(inst,vrf_name);if(ospf==NULL||!osp
f->oi_running)returnCMD_SUCCESS;ret=show_ip_ospf_border_routers_common(vty,ospf,
use_vrf);}}else{/*Displaydefaultospf(instance0)info*/ospf=ospf_lookup_by_vrf_id(
VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running)returnCMD_SUCCESS;ret=show_ip_ospf
_border_routers_common(vty,ospf,use_vrf);}returnret;}DEFUN(show_ip_ospf_instance
_border_routers,show_ip_ospf_instance_border_routers_cmd,"showipospf(1-65535)bor
der-routers",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n""ShowalltheABR'sandA
SBR's\n"){intidx_number=3;structospf*ospf;unsignedshortinstance=0;instance=strto
ul(argv[idx_number]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==N
ULL)returnCMD_NOT_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;returnshow_
ip_ospf_border_routers_common(vty,ospf,0);}staticintshow_ip_ospf_route_common(st
ructvty*vty,structospf*ospf,json_object*json,uint8_tuse_vrf){json_object*json_vr
f=NULL;if(ospf->instance)vty_out(vty,"\nOSPFInstance:%d\n\n",ospf->instance);if(
json){if(use_vrf)json_vrf=json_object_new_object();elsejson_vrf=json;}ospf_show_
vrf_name(ospf,vty,json_vrf,use_vrf);if(ospf->new_table==NULL){vty_out(vty,"NoOSP
Froutinginformationexist\n");returnCMD_SUCCESS;}/*ShowNetworkroutes.*/show_ip_os
pf_route_network(vty,ospf,ospf->new_table,json_vrf);/*ShowRouterroutes.*/show_ip
_ospf_route_router(vty,ospf,ospf->new_rtrs,json_vrf);/*ShowASExternalroutes.*/sh
ow_ip_ospf_route_external(vty,ospf,ospf->old_external_route,json_vrf);if(json){i
f(use_vrf){//json_object_object_add(json_vrf,"areas",//json_areas);if(ospf->vrf_
id==VRF_DEFAULT)json_object_object_add(json,"default",json_vrf);elsejson_object_
object_add(json,ospf->name,json_vrf);}}else{vty_out(vty,"\n");}returnCMD_SUCCESS
;}DEFUN(show_ip_ospf_route,show_ip_ospf_route_cmd,"showipospf[vrf<NAME|all>]rout
e[json]",SHOW_STRIP_STR"OSPFinformation\n"VRF_CMD_HELP_STR"AllVRFs\n""OSPFroutin
gtable\n"JSON_STR){structospf*ospf=NULL;structlistnode*node=NULL;char*vrf_name=N
ULL;boolall_vrf=FALSE;intret=CMD_SUCCESS;intinst=0;intidx_vrf=0;uint8_tuse_vrf=0
;uint8_tuj=use_json(argc,argv);json_object*json=NULL;if(uj)json=json_object_new_
object();OSPF_FIND_VRF_ARGS(argv,argc,idx_vrf,vrf_name,all_vrf);/*vrfinputisprov
idedcouldbeallorspecificvrf*/if(vrf_name){use_vrf=1;if(all_vrf){for(ALL_LIST_ELE
MENTS_RO(om->ospf,node,ospf)){if(!ospf->oi_running)continue;ret=show_ip_ospf_rou
te_common(vty,ospf,json,use_vrf);}if(uj){/*KeepNon-prettyformat*/vty_out(vty,"%s
\n",json_object_to_json_string(json));json_object_free(json);}returnret;}ospf=os
pf_lookup_by_inst_name(inst,vrf_name);if(ospf==NULL||!ospf->oi_running){if(uj)js
on_object_free(json);returnCMD_SUCCESS;}}else{/*Displaydefaultospf(instance0)inf
o*/ospf=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf==NULL||!ospf->oi_running){if(
uj)json_object_free(json);returnCMD_SUCCESS;}}if(ospf){ret=show_ip_ospf_route_co
mmon(vty,ospf,json,use_vrf);/*KeepNon-prettyformat*/if(uj)vty_out(vty,"%s\n",jso
n_object_to_json_string(json));}if(uj)json_object_free(json);returnret;}DEFUN(sh
ow_ip_ospf_instance_route,show_ip_ospf_instance_route_cmd,"showipospf(1-65535)ro
ute",SHOW_STRIP_STR"OSPFinformation\n""InstanceID\n""OSPFroutingtable\n"){intidx
_number=3;structospf*ospf;unsignedshortinstance=0;instance=strtoul(argv[idx_numb
er]->arg,NULL,10);ospf=ospf_lookup_instance(instance);if(ospf==NULL)returnCMD_NO
T_MY_INSTANCE;if(!ospf->oi_running)returnCMD_SUCCESS;returnshow_ip_ospf_route_co
mmon(vty,ospf,NULL,0);}DEFUN(show_ip_ospf_vrfs,show_ip_ospf_vrfs_cmd,"showipospf
vrfs[json]",SHOW_STRIP_STR"OSPFinformation\n""ShowOSPFVRFs\n"JSON_STR){uint8_tuj
=use_json(argc,argv);json_object*json=NULL;json_object*json_vrfs=NULL;structospf
*ospf=NULL;structlistnode*node=NULL;intcount=0;staticcharheader[]="NameIdRouterI
d";if(uj){json=json_object_new_object();json_vrfs=json_object_new_object();}for(
ALL_LIST_ELEMENTS_RO(om->ospf,node,ospf)){json_object*json_vrf=NULL;constchar*na
me=NULL;int64_tvrf_id_ui=0;count++;if(!uj&&count==1)vty_out(vty,"%s\n",header);i
f(uj)json_vrf=json_object_new_object();if(ospf->vrf_id==0)name=VRF_DEFAULT_NAME;
elsename=ospf->name;vrf_id_ui=(ospf->vrf_id==VRF_UNKNOWN)?-1:(int64_t)ospf->vrf_
id;if(uj){json_object_int_add(json_vrf,"vrfId",vrf_id_ui);json_object_string_add
(json_vrf,"routerId",inet_ntoa(ospf->router_id));json_object_object_add(json_vrf
s,name,json_vrf);}else{vty_out(vty,"%-25s%-5d%-16s\n",name,ospf->vrf_id,inet_nto
a(ospf->router_id));}}if(uj){json_object_object_add(json,"vrfs",json_vrfs);json_
object_int_add(json,"totalVrfs",count);vty_out(vty,"%s\n",json_object_to_json_st
ring_ext(json,JSON_C_TO_STRING_PRETTY));json_object_free(json);}else{if(count)vt
y_out(vty,"\nTotalnumberofOSPFVRFs:%d\n",count);}returnCMD_SUCCESS;}constchar*os
pf_abr_type_str[]={"unknown","standard","ibm","cisco","shortcut"};constchar*ospf
_shortcut_mode_str[]={"default","enable","disable"};constchar*ospf_int_type_str[
]={"unknown",/*shouldneverbeused.*/"point-to-point","broadcast","non-broadcast",
"point-to-multipoint","virtual-link",/*shouldneverbeused.*/"loopback"};staticint
config_write_interface_one(structvty*vty,structvrf*vrf){structlistnode*node;stru
ctinterface*ifp;structcrypt_key*ck;structroute_node*rn=NULL;structospf_if_params
*params;intwrite=0;structospf*ospf=vrf->info;FOR_ALL_INTERFACES(vrf,ifp){if(memc
mp(ifp->name,"VLINK",5)==0)continue;vty_frame(vty,"!\n");if(ifp->vrf_id==VRF_DEF
AULT)vty_frame(vty,"interface%s\n",ifp->name);elsevty_frame(vty,"interface%svrf%
s\n",ifp->name,vrf->name);if(ifp->desc)vty_out(vty,"description%s\n",ifp->desc);
write++;params=IF_DEF_PARAMS(ifp);do{/*InterfaceNetworkprint.*/if(OSPF_IF_PARAM_
CONFIGURED(params,type)&&params->type!=OSPF_IFTYPE_LOOPBACK){if(params->type!=os
pf_default_iftype(ifp)){vty_out(vty,"ipospfnetwork%s",ospf_int_type_str[params->
type]);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4)
);vty_out(vty,"\n");}}/*OSPFinterfaceauthenticationprint*/if(OSPF_IF_PARAM_CONFI
GURED(params,auth_type)&&params->auth_type!=OSPF_AUTH_NOTSET){constchar*auth_str
;/*Translationtablesarenotthatmuchhelp*hereduetosyntax*ofthesimpleoption*/switch
(params->auth_type){caseOSPF_AUTH_NULL:auth_str="null";break;caseOSPF_AUTH_SIMPL
E:auth_str="";break;caseOSPF_AUTH_CRYPTOGRAPHIC:auth_str="message-digest";break;
default:auth_str="";break;}vty_out(vty,"ipospfauthentication%s",auth_str);if(par
ams!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(vty
,"\n");}/*SimpleAuthenticationPasswordprint.*/if(OSPF_IF_PARAM_CONFIGURED(params
,auth_simple)&&params->auth_simple[0]!='\0'){vty_out(vty,"ipospfauthentication-k
ey%s",params->auth_simple);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_n
toa(rn->p.u.prefix4));vty_out(vty,"\n");}/*CryptographicAuthenticationKeyprint.*
/if(params&&params->auth_crypt){for(ALL_LIST_ELEMENTS_RO(params->auth_crypt,node
,ck)){vty_out(vty,"ipospfmessage-digest-key%dmd5%s",ck->key_id,ck->auth_key);if(
params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(
vty,"\n");}}/*InterfaceOutputCostprint.*/if(OSPF_IF_PARAM_CONFIGURED(params,outp
ut_cost_cmd)){vty_out(vty,"ipospfcost%u",params->output_cost_cmd);if(params!=IF_
DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(vty,"\n");}
/*HelloIntervalprint.*/if(OSPF_IF_PARAM_CONFIGURED(params,v_hello)&&params->v_he
llo!=OSPF_HELLO_INTERVAL_DEFAULT){vty_out(vty,"ipospfhello-interval%u",params->v
_hello);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4
));vty_out(vty,"\n");}/*RouterDeadIntervalprint.*/if(OSPF_IF_PARAM_CONFIGURED(pa
rams,v_wait)&&params->v_wait!=OSPF_ROUTER_DEAD_INTERVAL_DEFAULT){vty_out(vty,"ip
ospfdead-interval");/*fasthello?*/if(OSPF_IF_PARAM_CONFIGURED(params,fast_hello)
)vty_out(vty,"minimalhello-multiplier%d",params->fast_hello);elsevty_out(vty,"%u
",params->v_wait);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p
.u.prefix4));vty_out(vty,"\n");}/*RouterPriorityprint.*/if(OSPF_IF_PARAM_CONFIGU
RED(params,priority)&&params->priority!=OSPF_ROUTER_PRIORITY_DEFAULT){vty_out(vt
y,"ipospfpriority%u",params->priority);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty
,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(vty,"\n");}/*RetransmitIntervalprint.*
/if(OSPF_IF_PARAM_CONFIGURED(params,retransmit_interval)&&params->retransmit_int
erval!=OSPF_RETRANSMIT_INTERVAL_DEFAULT){vty_out(vty,"ipospfretransmit-interval%
u",params->retransmit_interval);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",i
net_ntoa(rn->p.u.prefix4));vty_out(vty,"\n");}/*TransmitDelayprint.*/if(OSPF_IF_
PARAM_CONFIGURED(params,transmit_delay)&&params->transmit_delay!=OSPF_TRANSMIT_D
ELAY_DEFAULT){vty_out(vty,"ipospftransmit-delay%u",params->transmit_delay);if(pa
rams!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(vt
y,"\n");}/*Areaprint.*/if(OSPF_IF_PARAM_CONFIGURED(params,if_area)){if(ospf&&osp
f->instance)vty_out(vty,"ipospf%d",ospf->instance);elsevty_out(vty,"ipospf");siz
e_tbuflen=MAX(strlen("4294967295"),strlen("255.255.255.255"));charbuf[buflen];ar
ea_id2str(buf,sizeof(buf),&params->if_area,params->if_area_id_fmt);vty_out(vty,"
area%s",buf);if(params!=IF_DEF_PARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.pr
efix4));vty_out(vty,"\n");}/*bfdprint.*/if(params->bfd_info)ospf_bfd_write_confi
g(vty,params);/*MTUignoreprint.*/if(OSPF_IF_PARAM_CONFIGURED(params,mtu_ignore)&
&params->mtu_ignore!=OSPF_MTU_IGNORE_DEFAULT){if(params->mtu_ignore==0)vty_out(v
ty,"noipospfmtu-ignore");elsevty_out(vty,"ipospfmtu-ignore");if(params!=IF_DEF_P
ARAMS(ifp))vty_out(vty,"%s",inet_ntoa(rn->p.u.prefix4));vty_out(vty,"\n");}while
(1){if(rn==NULL)rn=route_top(IF_OIFS_PARAMS(ifp));elsern=route_next(rn);if(rn==N
ULL)break;params=rn->info;if(params!=NULL)break;}}while(rn);ospf_opaque_config_w
rite_if(vty,ifp);vty_endframe(vty,NULL);}returnwrite;}/*Configurationwritefuncti
onforospfd.*/staticintconfig_write_interface(structvty*vty){intwrite=0;structvrf
*vrf=NULL;/*DisplayallVRFawareOSPFinterfaceconfiguration*/RB_FOREACH(vrf,vrf_nam
e_head,&vrfs_by_name){write+=config_write_interface_one(vty,vrf);}returnwrite;}s
taticintconfig_write_network_area(structvty*vty,structospf*ospf){structroute_nod
e*rn;uint8_tbuf[INET_ADDRSTRLEN];/*`networkarea'print.*/for(rn=route_top(ospf->n
etworks);rn;rn=route_next(rn))if(rn->info){structospf_network*n=rn->info;memset(
buf,0,INET_ADDRSTRLEN);/*CreateAreaIDstringbyspecifiedAreaIDformat.*/if(n->area_
id_fmt==OSPF_AREA_ID_FMT_DOTTEDQUAD)strncpy((char*)buf,inet_ntoa(n->area_id),INE
T_ADDRSTRLEN);elsesprintf((char*)buf,"%lu",(unsignedlongint)ntohl(n->area_id.s_a
ddr));/*Networkprint.*/vty_out(vty,"network%s/%darea%s\n",inet_ntoa(rn->p.u.pref
ix4),rn->p.prefixlen,buf);}return0;}staticintconfig_write_ospf_area(structvty*vt
y,structospf*ospf){structlistnode*node;structospf_area*area;uint8_tbuf[INET_ADDR
STRLEN];/*Areaconfigurationprint.*/for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,are
a)){structroute_node*rn1;area_id2str((char*)buf,INET_ADDRSTRLEN,&area->area_id,a
rea->area_id_fmt);if(area->auth_type!=OSPF_AUTH_NULL){if(area->auth_type==OSPF_A
UTH_SIMPLE)vty_out(vty,"area%sauthentication\n",buf);elsevty_out(vty,"area%sauth
enticationmessage-digest\n",buf);}if(area->shortcut_configured!=OSPF_SHORTCUT_DE
FAULT)vty_out(vty,"area%sshortcut%s\n",buf,ospf_shortcut_mode_str[area->shortcut
_configured]);if((area->external_routing==OSPF_AREA_STUB)||(area->external_routi
ng==OSPF_AREA_NSSA)){if(area->external_routing==OSPF_AREA_STUB){vty_out(vty,"are
a%sstub",buf);if(area->no_summary)vty_out(vty,"no-summary\n");vty_out(vty,"\n");
}elseif(area->external_routing==OSPF_AREA_NSSA){switch(area->NSSATranslatorRole)
{caseOSPF_NSSA_ROLE_NEVER:vty_out(vty,"area%snssatranslate-never\n",buf);break;c
aseOSPF_NSSA_ROLE_ALWAYS:vty_out(vty,"area%snssatranslate-always\n",buf);break;c
aseOSPF_NSSA_ROLE_CANDIDATE:vty_out(vty,"area%snssa\n",buf);break;}if(area->no_s
ummary)vty_out(vty,"area%snssano-summary\n",buf);}if(area->default_cost!=1)vty_o
ut(vty,"area%sdefault-cost%d\n",buf,area->default_cost);}for(rn1=route_top(area-
>ranges);rn1;rn1=route_next(rn1))if(rn1->info){structospf_area_range*range=rn1->
info;vty_out(vty,"area%srange%s/%d",buf,inet_ntoa(rn1->p.u.prefix4),rn1->p.prefi
xlen);if(range->cost_config!=OSPF_AREA_RANGE_COST_UNSPEC)vty_out(vty,"cost%d",ra
nge->cost_config);if(!CHECK_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTISE))vty_out
(vty,"not-advertise");if(CHECK_FLAG(range->flags,OSPF_AREA_RANGE_SUBSTITUTE))vty
_out(vty,"substitute%s/%d",inet_ntoa(range->subst_addr),range->subst_masklen);vt
y_out(vty,"\n");}if(EXPORT_NAME(area))vty_out(vty,"area%sexport-list%s\n",buf,EX
PORT_NAME(area));if(IMPORT_NAME(area))vty_out(vty,"area%simport-list%s\n",buf,IM
PORT_NAME(area));if(PREFIX_NAME_IN(area))vty_out(vty,"area%sfilter-listprefix%si
n\n",buf,PREFIX_NAME_IN(area));if(PREFIX_NAME_OUT(area))vty_out(vty,"area%sfilte
r-listprefix%sout\n",buf,PREFIX_NAME_OUT(area));}return0;}staticintconfig_write_
ospf_nbr_nbma(structvty*vty,structospf*ospf){structospf_nbr_nbma*nbr_nbma;struct
route_node*rn;/*StaticNeighborconfigurationprint.*/for(rn=route_top(ospf->nbr_nb
ma);rn;rn=route_next(rn))if((nbr_nbma=rn->info)){vty_out(vty,"neighbor%s",inet_n
toa(nbr_nbma->addr));if(nbr_nbma->priority!=OSPF_NEIGHBOR_PRIORITY_DEFAULT)vty_o
ut(vty,"priority%d",nbr_nbma->priority);if(nbr_nbma->v_poll!=OSPF_POLL_INTERVAL_
DEFAULT)vty_out(vty,"poll-interval%d",nbr_nbma->v_poll);vty_out(vty,"\n");}retur
n0;}staticintconfig_write_virtual_link(structvty*vty,structospf*ospf){structlist
node*node;structospf_vl_data*vl_data;charbuf[INET_ADDRSTRLEN];/*Virtual-Linkprin
t*/for(ALL_LIST_ELEMENTS_RO(ospf->vlinks,node,vl_data)){structlistnode*n2;struct
crypt_key*ck;structospf_interface*oi;if(vl_data!=NULL){memset(buf,0,INET_ADDRSTR
LEN);area_id2str(buf,sizeof(buf),&vl_data->vl_area_id,vl_data->vl_area_id_fmt);o
i=vl_data->vl_oi;/*timers*/if(OSPF_IF_PARAM(oi,v_hello)!=OSPF_HELLO_INTERVAL_DEF
AULT||OSPF_IF_PARAM(oi,v_wait)!=OSPF_ROUTER_DEAD_INTERVAL_DEFAULT||OSPF_IF_PARAM
(oi,retransmit_interval)!=OSPF_RETRANSMIT_INTERVAL_DEFAULT||OSPF_IF_PARAM(oi,tra
nsmit_delay)!=OSPF_TRANSMIT_DELAY_DEFAULT)vty_out(vty,"area%svirtual-link%shello
-interval%dretransmit-interval%dtransmit-delay%ddead-interval%d\n",buf,inet_ntoa
(vl_data->vl_peer),OSPF_IF_PARAM(oi,v_hello),OSPF_IF_PARAM(oi,retransmit_interva
l),OSPF_IF_PARAM(oi,transmit_delay),OSPF_IF_PARAM(oi,v_wait));elsevty_out(vty,"a
rea%svirtual-link%s\n",buf,inet_ntoa(vl_data->vl_peer));/*Authkey*/if(IF_DEF_PAR
AMS(vl_data->vl_oi->ifp)->auth_simple[0]!='\0')vty_out(vty,"area%svirtual-link%s
authentication-key%s\n",buf,inet_ntoa(vl_data->vl_peer),IF_DEF_PARAMS(vl_data->v
l_oi->ifp)->auth_simple);/*md5keys*/for(ALL_LIST_ELEMENTS_RO(IF_DEF_PARAMS(vl_da
ta->vl_oi->ifp)->auth_crypt,n2,ck))vty_out(vty,"area%svirtual-link%s""message-di
gest-key%dmd5%s\n",buf,inet_ntoa(vl_data->vl_peer),ck->key_id,ck->auth_key);}}re
turn0;}staticintconfig_write_ospf_redistribute(structvty*vty,structospf*ospf){in
ttype;/*redistributeprint.*/for(type=0;type<ZEBRA_ROUTE_MAX;type++){structlist*r
ed_list;structlistnode*node;structospf_redist*red;red_list=ospf->redist[type];if
(!red_list)continue;for(ALL_LIST_ELEMENTS_RO(red_list,node,red)){vty_out(vty,"re
distribute%s",zebra_route_string(type));if(red->instance)vty_out(vty,"%d",red->i
nstance);if(red->dmetric.value>=0)vty_out(vty,"metric%d",red->dmetric.value);if(
red->dmetric.type==EXTERNAL_METRIC_TYPE_1)vty_out(vty,"metric-type1");if(ROUTEMA
P_NAME(red))vty_out(vty,"route-map%s",ROUTEMAP_NAME(red));vty_out(vty,"\n");}}re
turn0;}staticintconfig_write_ospf_default_metric(structvty*vty,structospf*ospf){
if(ospf->default_metric!=-1)vty_out(vty,"default-metric%d\n",ospf->default_metri
c);return0;}staticintconfig_write_ospf_distribute(structvty*vty,structospf*ospf)
{inttype;structospf_redist*red;if(ospf){/*distribute-listprint.*/for(type=0;type
<ZEBRA_ROUTE_MAX;type++)if(DISTRIBUTE_NAME(ospf,type))vty_out(vty,"distribute-li
st%sout%s\n",DISTRIBUTE_NAME(ospf,type),zebra_route_string(type));/*default-info
rmationprint.*/if(ospf->default_originate!=DEFAULT_ORIGINATE_NONE){vty_out(vty,"
default-informationoriginate");if(ospf->default_originate==DEFAULT_ORIGINATE_ALW
AYS)vty_out(vty,"always");red=ospf_redist_lookup(ospf,DEFAULT_ROUTE,0);if(red){i
f(red->dmetric.value>=0)vty_out(vty,"metric%d",red->dmetric.value);if(red->dmetr
ic.type==EXTERNAL_METRIC_TYPE_1)vty_out(vty,"metric-type1");if(ROUTEMAP_NAME(red
))vty_out(vty,"route-map%s",ROUTEMAP_NAME(red));}vty_out(vty,"\n");}}return0;}st
aticintconfig_write_ospf_distance(structvty*vty,structospf*ospf){structroute_nod
e*rn;structospf_distance*odistance;if(ospf->distance_all)vty_out(vty,"distance%d
\n",ospf->distance_all);if(ospf->distance_intra||ospf->distance_inter||ospf->dis
tance_external){vty_out(vty,"distanceospf");if(ospf->distance_intra)vty_out(vty,
"intra-area%d",ospf->distance_intra);if(ospf->distance_inter)vty_out(vty,"inter-
area%d",ospf->distance_inter);if(ospf->distance_external)vty_out(vty,"external%d
",ospf->distance_external);vty_out(vty,"\n");}for(rn=route_top(ospf->distance_ta
ble);rn;rn=route_next(rn))if((odistance=rn->info)!=NULL){vty_out(vty,"distance%d
%s/%d%s\n",odistance->distance,inet_ntoa(rn->p.u.prefix4),rn->p.prefixlen,odista
nce->access_list?odistance->access_list:"");}return0;}staticintospf_config_write
_one(structvty*vty,structospf*ospf){structvrf*vrf=vrf_lookup_by_id(ospf->vrf_id)
;structinterface*ifp;structospf_interface*oi;structlistnode*node=NULL;intwrite=0
;/*`routerospf'print.*/if(ospf->instance&&ospf->name){vty_out(vty,"routerospf%dv
rf%s\n",ospf->instance,ospf->name);}elseif(ospf->instance){vty_out(vty,"routeros
pf%d\n",ospf->instance);}elseif(ospf->name){vty_out(vty,"routerospfvrf%s\n",ospf
->name);}elsevty_out(vty,"routerospf\n");if(!ospf->networks){write++;returnwrite
;}/*RouterIDprint.*/if(ospf->router_id_static.s_addr!=0)vty_out(vty,"ospfrouter-
id%s\n",inet_ntoa(ospf->router_id_static));/*ABRtypeprint.*/if(ospf->abr_type!=O
SPF_ABR_DEFAULT)vty_out(vty,"ospfabr-type%s\n",ospf_abr_type_str[ospf->abr_type]
);/*log-adjacency-changesflagprint.*/if(CHECK_FLAG(ospf->config,OSPF_LOG_ADJACEN
CY_CHANGES)){if(CHECK_FLAG(ospf->config,OSPF_LOG_ADJACENCY_DETAIL))vty_out(vty,"
log-adjacency-changesdetail\n");elseif(!DFLT_OSPF_LOG_ADJACENCY_CHANGES)vty_out(
vty,"log-adjacency-changes\n");}elseif(DFLT_OSPF_LOG_ADJACENCY_CHANGES){vty_out(
vty,"nolog-adjacency-changes\n");}/*RFC1583compatibilityflagprint--Compatiblewit
hCISCO*12.1.*/if(CHECK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE))vty_out(vty,"c
ompatiblerfc1583\n");/*auto-costreference-bandwidthconfiguration.*/if(ospf->ref_
bandwidth!=OSPF_DEFAULT_REF_BANDWIDTH){vty_out(vty,"!Important:ensurereferenceba
ndwidth""isconsistentacrossallrouters\n");vty_out(vty,"auto-costreference-bandwi
dth%d\n",ospf->ref_bandwidth);}/*SPFtimersprint.*/if(ospf->spf_delay!=OSPF_SPF_D
ELAY_DEFAULT||ospf->spf_holdtime!=OSPF_SPF_HOLDTIME_DEFAULT||ospf->spf_max_holdt
ime!=OSPF_SPF_MAX_HOLDTIME_DEFAULT)vty_out(vty,"timersthrottlespf%d%d%d\n",ospf-
>spf_delay,ospf->spf_holdtime,ospf->spf_max_holdtime);/*LSAtimersprint.*/if(ospf
->min_ls_interval!=OSPF_MIN_LS_INTERVAL)vty_out(vty,"timersthrottlelsaall%d\n",o
spf->min_ls_interval);if(ospf->min_ls_arrival!=OSPF_MIN_LS_ARRIVAL)vty_out(vty,"
timerslsamin-arrival%d\n",ospf->min_ls_arrival);/*Writemultiplierprint.*/if(ospf
->write_oi_count!=OSPF_WRITE_INTERFACE_COUNT_DEFAULT)vty_out(vty,"ospfwrite-mult
iplier%d\n",ospf->write_oi_count);/*Max-metricrouter-lsaprint*/config_write_stub
_router(vty,ospf);/*SPFrefreshparametersprint.*/if(ospf->lsa_refresh_interval!=O
SPF_LSA_REFRESH_INTERVAL_DEFAULT)vty_out(vty,"refreshtimer%d\n",ospf->lsa_refres
h_interval);/*Redistributeinformationprint.*/config_write_ospf_redistribute(vty,
ospf);/*passive-interfaceprint.*/if(ospf->passive_interface_default==OSPF_IF_PAS
SIVE)vty_out(vty,"passive-interfacedefault\n");FOR_ALL_INTERFACES(vrf,ifp)if(OSP
F_IF_PARAM_CONFIGURED(IF_DEF_PARAMS(ifp),passive_interface)&&IF_DEF_PARAMS(ifp)-
>passive_interface!=ospf->passive_interface_default){vty_out(vty,"%spassive-inte
rface%s\n",IF_DEF_PARAMS(ifp)->passive_interface?"":"no",ifp->name);}for(ALL_LIS
T_ELEMENTS_RO(ospf->oiflist,node,oi)){if(!OSPF_IF_PARAM_CONFIGURED(oi->params,pa
ssive_interface))continue;if(OSPF_IF_PARAM_CONFIGURED(IF_DEF_PARAMS(oi->ifp),pas
sive_interface)){if(oi->params->passive_interface==IF_DEF_PARAMS(oi->ifp)->passi
ve_interface)continue;}elseif(oi->params->passive_interface==ospf->passive_inter
face_default)continue;vty_out(vty,"%spassive-interface%s%s\n",oi->params->passiv
e_interface?"":"no",oi->ifp->name,inet_ntoa(oi->address->u.prefix4));}/*Networka
reaprint.*/config_write_network_area(vty,ospf);/*Areaconfigprint.*/config_write_
ospf_area(vty,ospf);/*staticneighborprint.*/config_write_ospf_nbr_nbma(vty,ospf)
;/*Virtual-Linkprint.*/config_write_virtual_link(vty,ospf);/*Defaultmetricconfig
uration.*/config_write_ospf_default_metric(vty,ospf);/*Distribute-listanddefault
-informationprint.*/config_write_ospf_distribute(vty,ospf);/*Distanceconfigurati
on.*/config_write_ospf_distance(vty,ospf);ospf_opaque_config_write_router(vty,os
pf);write++;returnwrite;}/*OSPFconfigurationwritefunction.*/staticintospf_config
_write(structvty*vty){structospf*ospf;structlistnode*ospf_node=NULL;intwrite=0;i
f(listcount(om->ospf)==0)returnwrite;for(ALL_LIST_ELEMENTS_RO(om->ospf,ospf_node
,ospf)){/*VRFDefaultcheckifitisrunning.*Upondaemonstart,therecouldbedefaultinsta
nce*inabsenceof'routerospf'/oi_runningisdisabled.*/if(ospf->vrf_id==VRF_DEFAULT&
&ospf->oi_running)write+=ospf_config_write_one(vty,ospf);/*ForNon-DefaultVRFsimp
lydisplaytheconfiguration,*evenifitisnotoi_running.*/elseif(ospf->vrf_id!=VRF_DE
FAULT)write+=ospf_config_write_one(vty,ospf);}returnwrite;}voidospf_vty_show_ini
t(void){/*"showipospf"commands.*/install_element(VIEW_NODE,&show_ip_ospf_cmd);in
stall_element(VIEW_NODE,&show_ip_ospf_instance_cmd);/*"showipospfdatabase"comman
ds.*/install_element(VIEW_NODE,&show_ip_ospf_database_max_cmd);install_element(V
IEW_NODE,&show_ip_ospf_instance_database_type_adv_router_cmd);install_element(VI
EW_NODE,&show_ip_ospf_instance_database_cmd);install_element(VIEW_NODE,&show_ip_
ospf_instance_database_max_cmd);/*"showipospfinterface"commands.*/install_elemen
t(VIEW_NODE,&show_ip_ospf_interface_cmd);install_element(VIEW_NODE,&show_ip_ospf
_instance_interface_cmd);/*"showipospfinterfacetraffic*/install_element(VIEW_NOD
E,&show_ip_ospf_interface_traffic_cmd);/*"showipospfneighbor"commands.*/install_
element(VIEW_NODE,&show_ip_ospf_neighbor_int_detail_cmd);install_element(VIEW_NO
DE,&show_ip_ospf_neighbor_int_cmd);install_element(VIEW_NODE,&show_ip_ospf_neigh
bor_id_cmd);install_element(VIEW_NODE,&show_ip_ospf_neighbor_detail_all_cmd);ins
tall_element(VIEW_NODE,&show_ip_ospf_neighbor_detail_cmd);install_element(VIEW_N
ODE,&show_ip_ospf_neighbor_cmd);install_element(VIEW_NODE,&show_ip_ospf_neighbor
_all_cmd);install_element(VIEW_NODE,&show_ip_ospf_instance_neighbor_int_detail_c
md);install_element(VIEW_NODE,&show_ip_ospf_instance_neighbor_int_cmd);install_e
lement(VIEW_NODE,&show_ip_ospf_instance_neighbor_id_cmd);install_element(VIEW_NO
DE,&show_ip_ospf_instance_neighbor_detail_all_cmd);install_element(VIEW_NODE,&sh
ow_ip_ospf_instance_neighbor_detail_cmd);install_element(VIEW_NODE,&show_ip_ospf
_instance_neighbor_cmd);install_element(VIEW_NODE,&show_ip_ospf_instance_neighbo
r_all_cmd);/*"showipospfroute"commands.*/install_element(VIEW_NODE,&show_ip_ospf
_route_cmd);install_element(VIEW_NODE,&show_ip_ospf_border_routers_cmd);install_
element(VIEW_NODE,&show_ip_ospf_instance_route_cmd);install_element(VIEW_NODE,&s
how_ip_ospf_instance_border_routers_cmd);/*"showipospfvrfs"commands.*/install_el
ement(VIEW_NODE,&show_ip_ospf_vrfs_cmd);}/*ospfd'sinterfacenode.*/staticstructcm
d_nodeinterface_node={INTERFACE_NODE,"%s(config-if)#",1};/*InitializationofOSPFi
nterface.*/staticvoidospf_vty_if_init(void){/*Installinterfacenode.*/install_nod
e(&interface_node,config_write_interface);if_cmd_init();/*"ipospfauthentication"
commands.*/install_element(INTERFACE_NODE,&ip_ospf_authentication_args_addr_cmd)
;install_element(INTERFACE_NODE,&ip_ospf_authentication_addr_cmd);install_elemen
t(INTERFACE_NODE,&no_ip_ospf_authentication_args_addr_cmd);install_element(INTER
FACE_NODE,&no_ip_ospf_authentication_addr_cmd);install_element(INTERFACE_NODE,&i
p_ospf_authentication_key_addr_cmd);install_element(INTERFACE_NODE,&no_ip_ospf_a
uthentication_key_authkey_addr_cmd);install_element(INTERFACE_NODE,&no_ospf_auth
entication_key_authkey_addr_cmd);/*"ipospfmessage-digest-key"commands.*/install_
element(INTERFACE_NODE,&ip_ospf_message_digest_key_cmd);install_element(INTERFAC
E_NODE,&no_ip_ospf_message_digest_key_cmd);/*"ipospfcost"commands.*/install_elem
ent(INTERFACE_NODE,&ip_ospf_cost_cmd);install_element(INTERFACE_NODE,&no_ip_ospf
_cost_cmd);/*"ipospfmtu-ignore"commands.*/install_element(INTERFACE_NODE,&ip_osp
f_mtu_ignore_addr_cmd);install_element(INTERFACE_NODE,&no_ip_ospf_mtu_ignore_add
r_cmd);/*"ipospfdead-interval"commands.*/install_element(INTERFACE_NODE,&ip_ospf
_dead_interval_cmd);install_element(INTERFACE_NODE,&ip_ospf_dead_interval_minima
l_addr_cmd);install_element(INTERFACE_NODE,&no_ip_ospf_dead_interval_cmd);/*"ipo
spfhello-interval"commands.*/install_element(INTERFACE_NODE,&ip_ospf_hello_inter
val_cmd);install_element(INTERFACE_NODE,&no_ip_ospf_hello_interval_cmd);/*"iposp
fnetwork"commands.*/install_element(INTERFACE_NODE,&ip_ospf_network_cmd);install
_element(INTERFACE_NODE,&no_ip_ospf_network_cmd);/*"ipospfpriority"commands.*/in
stall_element(INTERFACE_NODE,&ip_ospf_priority_cmd);install_element(INTERFACE_NO
DE,&no_ip_ospf_priority_cmd);/*"ipospfretransmit-interval"commands.*/install_ele
ment(INTERFACE_NODE,&ip_ospf_retransmit_interval_addr_cmd);install_element(INTER
FACE_NODE,&no_ip_ospf_retransmit_interval_addr_cmd);/*"ipospftransmit-delay"comm
ands.*/install_element(INTERFACE_NODE,&ip_ospf_transmit_delay_addr_cmd);install_
element(INTERFACE_NODE,&no_ip_ospf_transmit_delay_addr_cmd);/*"ipospfarea"comman
ds.*/install_element(INTERFACE_NODE,&ip_ospf_area_cmd);install_element(INTERFACE
_NODE,&no_ip_ospf_area_cmd);/*Thesecommandsarecompatibitliyforpreviousversion.*/
install_element(INTERFACE_NODE,&ospf_authentication_key_cmd);install_element(INT
ERFACE_NODE,&ospf_message_digest_key_cmd);install_element(INTERFACE_NODE,&no_osp
f_message_digest_key_cmd);install_element(INTERFACE_NODE,&ospf_dead_interval_cmd
);install_element(INTERFACE_NODE,&no_ospf_dead_interval_cmd);install_element(INT
ERFACE_NODE,&ospf_hello_interval_cmd);install_element(INTERFACE_NODE,&no_ospf_he
llo_interval_cmd);install_element(INTERFACE_NODE,&ospf_cost_cmd);install_element
(INTERFACE_NODE,&no_ospf_cost_cmd);install_element(INTERFACE_NODE,&ospf_network_
cmd);install_element(INTERFACE_NODE,&no_ospf_network_cmd);install_element(INTERF
ACE_NODE,&ospf_priority_cmd);install_element(INTERFACE_NODE,&no_ospf_priority_cm
d);install_element(INTERFACE_NODE,&ospf_retransmit_interval_cmd);install_element
(INTERFACE_NODE,&no_ospf_retransmit_interval_cmd);install_element(INTERFACE_NODE
,&ospf_transmit_delay_cmd);install_element(INTERFACE_NODE,&no_ospf_transmit_dela
y_cmd);}staticvoidospf_vty_zebra_init(void){install_element(OSPF_NODE,&ospf_redi
stribute_source_cmd);install_element(OSPF_NODE,&no_ospf_redistribute_source_cmd)
;install_element(OSPF_NODE,&ospf_redistribute_instance_source_cmd);install_eleme
nt(OSPF_NODE,&no_ospf_redistribute_instance_source_cmd);install_element(OSPF_NOD
E,&ospf_distribute_list_out_cmd);install_element(OSPF_NODE,&no_ospf_distribute_l
ist_out_cmd);install_element(OSPF_NODE,&ospf_default_information_originate_cmd);
install_element(OSPF_NODE,&no_ospf_default_information_originate_cmd);install_el
ement(OSPF_NODE,&ospf_default_metric_cmd);install_element(OSPF_NODE,&no_ospf_def
ault_metric_cmd);install_element(OSPF_NODE,&ospf_distance_cmd);install_element(O
SPF_NODE,&no_ospf_distance_cmd);install_element(OSPF_NODE,&no_ospf_distance_ospf
_cmd);install_element(OSPF_NODE,&ospf_distance_ospf_cmd);#if0install_element(OSP
F_NODE,&ospf_distance_source_cmd);install_element(OSPF_NODE,&no_ospf_distance_so
urce_cmd);install_element(OSPF_NODE,&ospf_distance_source_access_list_cmd);insta
ll_element(OSPF_NODE,&no_ospf_distance_source_access_list_cmd);#endif/*0*/}stati
cstructcmd_nodeospf_node={OSPF_NODE,"%s(config-router)#",1};staticvoidospf_inter
face_clear(structinterface*ifp){if(!if_is_operative(ifp))return;if(IS_DEBUG_OSPF
(ism,ISM_EVENTS))zlog_debug("ISM[%s]:clearbyreset",ifp->name);ospf_if_reset(ifp)
;}DEFUN(clear_ip_ospf_interface,clear_ip_ospf_interface_cmd,"clearipospfinterfac
e[IFNAME]",CLEAR_STRIP_STR"OSPFinformation\n""Interfaceinformation\n""Interfacen
ame\n"){intidx_ifname=4;structinterface*ifp;structlistnode*node;structospf*ospf=
NULL;if(argc==4)/*Clearalltheospfv2interfaces.*/{for(ALL_LIST_ELEMENTS_RO(om->os
pf,node,ospf)){structvrf*vrf=vrf_lookup_by_id(ospf->vrf_id);FOR_ALL_INTERFACES(v
rf,ifp)ospf_interface_clear(ifp);}}else{/*Interfacenameisspecified.*/ifp=if_look
up_by_name_all_vrf(argv[idx_ifname]->arg);if(ifp==NULL)vty_out(vty,"Nosuchinterf
acename\n");elseospf_interface_clear(ifp);}returnCMD_SUCCESS;}voidospf_vty_clear
_init(void){install_element(ENABLE_NODE,&clear_ip_ospf_interface_cmd);}/*Install
OSPFrelatedvtycommands.*/voidospf_vty_init(void){/*Installospftopnode.*/install_
node(&ospf_node,ospf_config_write);/*"routerospf"commands.*/install_element(CONF
IG_NODE,&router_ospf_cmd);install_element(CONFIG_NODE,&no_router_ospf_cmd);insta
ll_default(OSPF_NODE);/*"ospfrouter-id"commands.*/install_element(OSPF_NODE,&osp
f_router_id_cmd);install_element(OSPF_NODE,&ospf_router_id_old_cmd);install_elem
ent(OSPF_NODE,&no_ospf_router_id_cmd);/*"passive-interface"commands.*/install_el
ement(OSPF_NODE,&ospf_passive_interface_addr_cmd);install_element(OSPF_NODE,&no_
ospf_passive_interface_addr_cmd);/*"ospfabr-type"commands.*/install_element(OSPF
_NODE,&ospf_abr_type_cmd);install_element(OSPF_NODE,&no_ospf_abr_type_cmd);/*"os
pflog-adjacency-changes"commands.*/install_element(OSPF_NODE,&ospf_log_adjacency
_changes_cmd);install_element(OSPF_NODE,&ospf_log_adjacency_changes_detail_cmd);
install_element(OSPF_NODE,&no_ospf_log_adjacency_changes_cmd);install_element(OS
PF_NODE,&no_ospf_log_adjacency_changes_detail_cmd);/*"ospfrfc1583-compatible"com
mands.*/install_element(OSPF_NODE,&ospf_compatible_rfc1583_cmd);install_element(
OSPF_NODE,&no_ospf_compatible_rfc1583_cmd);install_element(OSPF_NODE,&ospf_rfc15
83_flag_cmd);install_element(OSPF_NODE,&no_ospf_rfc1583_flag_cmd);/*"networkarea
"commands.*/install_element(OSPF_NODE,&ospf_network_area_cmd);install_element(OS
PF_NODE,&no_ospf_network_area_cmd);/*"areaauthentication"commands.*/install_elem
ent(OSPF_NODE,&ospf_area_authentication_message_digest_cmd);install_element(OSPF
_NODE,&ospf_area_authentication_cmd);install_element(OSPF_NODE,&no_ospf_area_aut
hentication_cmd);/*"arearange"commands.*/install_element(OSPF_NODE,&ospf_area_ra
nge_cmd);install_element(OSPF_NODE,&ospf_area_range_cost_cmd);install_element(OS
PF_NODE,&ospf_area_range_not_advertise_cmd);install_element(OSPF_NODE,&no_ospf_a
rea_range_cmd);install_element(OSPF_NODE,&ospf_area_range_substitute_cmd);instal
l_element(OSPF_NODE,&no_ospf_area_range_substitute_cmd);/*"areavirtual-link"comm
ands.*/install_element(OSPF_NODE,&ospf_area_vlink_cmd);install_element(OSPF_NODE
,&ospf_area_vlink_intervals_cmd);install_element(OSPF_NODE,&no_ospf_area_vlink_c
md);install_element(OSPF_NODE,&no_ospf_area_vlink_intervals_cmd);/*"areastub"com
mands.*/install_element(OSPF_NODE,&ospf_area_stub_no_summary_cmd);install_elemen
t(OSPF_NODE,&ospf_area_stub_cmd);install_element(OSPF_NODE,&no_ospf_area_stub_no
_summary_cmd);install_element(OSPF_NODE,&no_ospf_area_stub_cmd);/*"areanssa"comm
ands.*/install_element(OSPF_NODE,&ospf_area_nssa_cmd);install_element(OSPF_NODE,
&ospf_area_nssa_translate_cmd);install_element(OSPF_NODE,&ospf_area_nssa_no_summ
ary_cmd);install_element(OSPF_NODE,&no_ospf_area_nssa_no_summary_cmd);install_el
ement(OSPF_NODE,&no_ospf_area_nssa_cmd);install_element(OSPF_NODE,&ospf_area_def
ault_cost_cmd);install_element(OSPF_NODE,&no_ospf_area_default_cost_cmd);install
_element(OSPF_NODE,&ospf_area_shortcut_cmd);install_element(OSPF_NODE,&no_ospf_a
rea_shortcut_cmd);install_element(OSPF_NODE,&ospf_area_export_list_cmd);install_
element(OSPF_NODE,&no_ospf_area_export_list_cmd);install_element(OSPF_NODE,&ospf
_area_filter_list_cmd);install_element(OSPF_NODE,&no_ospf_area_filter_list_cmd);
install_element(OSPF_NODE,&ospf_area_import_list_cmd);install_element(OSPF_NODE,
&no_ospf_area_import_list_cmd);/*SPFtimercommands*/install_element(OSPF_NODE,&os
pf_timers_throttle_spf_cmd);install_element(OSPF_NODE,&no_ospf_timers_throttle_s
pf_cmd);/*LSAtimerscommands*/install_element(OSPF_NODE,&ospf_timers_min_ls_inter
val_cmd);install_element(OSPF_NODE,&no_ospf_timers_min_ls_interval_cmd);install_
element(OSPF_NODE,&ospf_timers_lsa_min_arrival_cmd);install_element(OSPF_NODE,&n
o_ospf_timers_lsa_min_arrival_cmd);install_element(OSPF_NODE,&ospf_timers_lsa_ar
rival_cmd);install_element(OSPF_NODE,&no_ospf_timers_lsa_arrival_cmd);/*refresht
imercommands*/install_element(OSPF_NODE,&ospf_refresh_timer_cmd);install_element
(OSPF_NODE,&no_ospf_refresh_timer_val_cmd);/*max-metriccommands*/install_element
(OSPF_NODE,&ospf_max_metric_router_lsa_admin_cmd);install_element(OSPF_NODE,&no_
ospf_max_metric_router_lsa_admin_cmd);install_element(OSPF_NODE,&ospf_max_metric
_router_lsa_startup_cmd);install_element(OSPF_NODE,&no_ospf_max_metric_router_ls
a_startup_cmd);install_element(OSPF_NODE,&ospf_max_metric_router_lsa_shutdown_cm
d);install_element(OSPF_NODE,&no_ospf_max_metric_router_lsa_shutdown_cmd);/*refe
rencebandwidthcommands*/install_element(OSPF_NODE,&ospf_auto_cost_reference_band
width_cmd);install_element(OSPF_NODE,&no_ospf_auto_cost_reference_bandwidth_cmd)
;/*"neighbor"commands.*/install_element(OSPF_NODE,&ospf_neighbor_cmd);install_el
ement(OSPF_NODE,&ospf_neighbor_poll_interval_cmd);install_element(OSPF_NODE,&no_
ospf_neighbor_cmd);install_element(OSPF_NODE,&no_ospf_neighbor_poll_cmd);/*write
multipliercommands*/install_element(OSPF_NODE,&ospf_write_multiplier_cmd);instal
l_element(OSPF_NODE,&write_multiplier_cmd);install_element(OSPF_NODE,&no_ospf_wr
ite_multiplier_cmd);install_element(OSPF_NODE,&no_write_multiplier_cmd);/*Initin
terfacerelatedvtycommands.*/ospf_vty_if_init();/*Initzebrarelatedvtycommands.*/o
spf_vty_zebra_init();}