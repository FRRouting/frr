/**OSPFdmainheader.*Copyright(C)1998,99,2000KunihiroIshiguro,ToshiakiTakada**Thi
sfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyi
t*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundati
on;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedintheh
opethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MER
CHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformore
details.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispr
ogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinS
t,FifthFloor,Boston,MA02110-1301USA*/#ifndef_ZEBRA_OSPFD_H#define_ZEBRA_OSPFD_H#
include<zebra.h>#include"qobj.h"#include"libospf.h"#include"filter.h"#include"lo
g.h"#include"vrf.h"#include"ospf_memory.h"#include"ospf_dump_api.h"#defineOSPF_V
ERSION2/*VTYportnumber.*/#defineOSPF_VTY_PORT2604/*IPTTLforOSPFprotocol.*/#defin
eOSPF_IP_TTL1#defineOSPF_VL_IP_TTL100/*Defaultconfigurationfilenameforospfd.*/#d
efineOSPF_DEFAULT_CONFIG"ospfd.conf"#defineOSPF_NSSA_TRANS_STABLE_DEFAULT40#defi
neOSPF_ALLSPFROUTERS0xe0000005/*224.0.0.5*/#defineOSPF_ALLDROUTERS0xe0000006/*22
4.0.0.6*//*OSPFAuthenticationType.*/#defineOSPF_AUTH_NULL0#defineOSPF_AUTH_SIMPL
E1#defineOSPF_AUTH_CRYPTOGRAPHIC2/*ForInterfaceauthenticationsettingdefault*/#de
fineOSPF_AUTH_NOTSET-1/*Fortheconsumptionandsanityofthecommandhandler*//*DONIOTR
EMOVE!!!NeedtodetectwhetheravaluehasbeengivenornotinVLinkcommandhandlers*/#defin
eOSPF_AUTH_CMD_NOTSEEN-2/*OSPFoptions.*/#defineOSPF_OPTION_MT0x01/*M/T*/#defineO
SPF_OPTION_E0x02#defineOSPF_OPTION_MC0x04#defineOSPF_OPTION_NP0x08#defineOSPF_OP
TION_EA0x10#defineOSPF_OPTION_DC0x20#defineOSPF_OPTION_O0x40#defineOSPF_OPTION_D
N0x80/*OSPFDatabaseDescriptionflags.*/#defineOSPF_DD_FLAG_MS0x01#defineOSPF_DD_F
LAG_M0x02#defineOSPF_DD_FLAG_I0x04#defineOSPF_DD_FLAG_ALL0x07#defineOSPF_LS_REFR
ESH_SHIFT(60*15)#defineOSPF_LS_REFRESH_JITTER60structospf_external{unsignedshort
instance;structroute_table*external_info;};/*OSPFmasterforsystemwideconfiguratio
nandvariables.*/structospf_master{/*OSPFinstance.*/structlist*ospf;/*OSPFthreadm
aster.*/structthread_master*master;/*VariousOSPFglobalconfiguration.*/uint8_topt
ions;#defineOSPF_MASTER_SHUTDOWN(1<<0)/*deferred-shutdown*/};structospf_redist{u
nsignedshortinstance;/*Redistributemetricinfo.*/struct{inttype;/*Externalmetrict
ype(E1orE2).*/intvalue;/*Valueforstaticmetric(24-bit).-1meansmetricvalueisnotset
.*/}dmetric;/*Forredistributeroutemap.*/struct{char*name;structroute_map*map;}ro
ute_map;/*+1isfordefault-information*/#defineROUTEMAP_NAME(R)(R->route_map.name)
#defineROUTEMAP(R)(R->route_map.map)};/*OSPFinstancestructure.*/structospf{/*OSP
F'srunningstatebasedonthe'[no]routerospf[<instance>]'*config.*/uint8_toi_running
;/*OSPFinstanceID*/unsignedshortinstance;/*OSPFRouterID.*/structin_addrrouter_id
;/*Configuredautomatically.*/structin_addrrouter_id_static;/*Configuredmanually.
*/structin_addrrouter_id_zebra;vrf_id_tvrf_id;/*VRFId*/char*name;/*VRFname*//*AB
R/ASBRinternalflags.*/uint8_tflags;#defineOSPF_FLAG_ABR0x0001#defineOSPF_FLAG_AS
BR0x0002/*ABRtype.*/uint8_tabr_type;#defineOSPF_ABR_UNKNOWN0#defineOSPF_ABR_STAN
D1#defineOSPF_ABR_IBM2#defineOSPF_ABR_CISCO3#defineOSPF_ABR_SHORTCUT4#defineOSPF
_ABR_DEFAULTOSPF_ABR_CISCO/*NSSAABR*/uint8_tanyNSSA;/*BumpforeveryNSSAattached.*
//*Configuredvariables.*/uint8_tconfig;#defineOSPF_RFC1583_COMPATIBLE(1<<0)#defi
neOSPF_OPAQUE_CAPABLE(1<<2)#defineOSPF_LOG_ADJACENCY_CHANGES(1<<3)#defineOSPF_LO
G_ADJACENCY_DETAIL(1<<4)/*Opaque-LSAadministrativeflags.*/uint8_topaque;#defineO
PAQUE_OPERATION_READY_BIT(1<<0)/*RFC3137stubrouter.Configuredtimetostaystub/max-
metric*/unsignedintstub_router_startup_time;/*seconds*/unsignedintstub_router_sh
utdown_time;/*seconds*/#defineOSPF_STUB_ROUTER_UNCONFIGURED0uint8_tstub_router_a
dmin_set;#defineOSPF_STUB_ROUTER_ADMINISTRATIVE_SET1#defineOSPF_STUB_ROUTER_ADMI
NISTRATIVE_UNSET0#defineOSPF_STUB_MAX_METRIC_SUMMARY_COST0x00ff0000/*LSAtimers*/
unsignedintmin_ls_interval;/*minimumdelaybetweenLSAs(inmsec)*/unsignedintmin_ls_
arrival;/*minimuminterarrivaltimebetweenLSAs(inmsec)*//*SPFparameters*/unsignedi
ntspf_delay;/*SPFdelaytime.*/unsignedintspf_holdtime;/*SPFholdtime.*/unsignedint
spf_max_holdtime;/*SPFmaximum-holdtime*/unsignedintspf_hold_multiplier;/*Adaptiv
emultiplierforholdtime*/intdefault_originate;/*Defaultinformationoriginate.*/#de
fineDEFAULT_ORIGINATE_NONE0#defineDEFAULT_ORIGINATE_ZEBRA1#defineDEFAULT_ORIGINA
TE_ALWAYS2uint32_tref_bandwidth;/*ReferenceBandwidth(Kbps).*/structroute_table*n
etworks;/*OSPFconfignetworks.*/structlist*vlinks;/*ConfiguredVirtual-Links.*/str
uctlist*areas;/*OSPFareas.*/structroute_table*nbr_nbma;structospf_area*backbone;
/*PointertotheBackboneArea.*/structlist*oiflist;/*ospfinterfaces*/uint8_tpassive
_interface_default;/*passive-interfacedefault*//*LSDBofAS-external-LSAs.*/struct
ospf_lsdb*lsdb;/*Flags.*/intexternal_origin;/*AS-external-LSAoriginflag.*/intase
_calc;/*ASEcalculationflag.*/structlist*opaque_lsa_self;/*Type-11Opaque-LSAs*//*
Routingtables.*/structroute_table*old_table;/*Oldroutingtable.*/structroute_tabl
e*new_table;/*Currentroutingtable.*/structroute_table*old_rtrs;/*OldABR/ASBRRT.*
/structroute_table*new_rtrs;/*NewABR/ASBRRT.*/structroute_table*new_external_rou
te;/*NewExternalRoute.*/structroute_table*old_external_route;/*OldExternalRoute.
*/structroute_table*external_lsas;/*DatabaseofexternalLSAs,prefixisLSA'sadv.netw
ork*//*Timestamps*/structtimevalts_spf;/*SPFcalculationtimestamp.*/structtimeval
ts_spf_duration;/*ExecutiontimeoflastSPF*/structroute_table*maxage_lsa;/*ListofM
axAgeLSAfordeletion.*/intredistribute;/*Numofredistributedprotocols.*//*Threads.
*/structthread*t_abr_task;/*ABRtasktimer.*/structthread*t_asbr_check;/*ASBRcheck
timer.*/structthread*t_distribute_update;/*Distirbutelistupdatetimer.*/structthr
ead*t_spf_calc;/*SPFcalculationtimer.*/structthread*t_ase_calc;/*ASEcalculationt
imer.*/structthread*t_external_lsa;/*AS-external-LSAorigintimer.*/structthread*t
_opaque_lsa_self;/*Type-11Opaque-LSAsoriginevent.*/structthread*t_sr_update;/*Se
gmentRoutingupdatetimer*/unsignedintmaxage_delay;/*DelayonMaxageremovertimer,sec
*/structthread*t_maxage;/*MaxAgeLSAremovertimer.*/structthread*t_maxage_walker;/
*MaxAgeLSAcheckingtimer.*/structthread*t_deferred_shutdown;/*deferred/stub-route
rshutdowntimer*/structthread*t_write;#defineOSPF_WRITE_INTERFACE_COUNT_DEFAULT20
intwrite_oi_count;/*Numofpacketssentperthreadinvocation*/structthread*t_read;int
fd;structstream*ibuf;structlist*oi_write_q;/*Distributelistsoutofotherroutesourc
es.*/struct{char*name;structaccess_list*list;}dlist[ZEBRA_ROUTE_MAX];#defineDIST
RIBUTE_NAME(O,T)(O)->dlist[T].name#defineDISTRIBUTE_LIST(O,T)(O)->dlist[T].list/
*OSPFredistributeconfiguration*/structlist*redist[ZEBRA_ROUTE_MAX+1];/*Redistrib
utetaginfo.*/route_tag_tdtag[ZEBRA_ROUTE_MAX+1];//Pending:cantconfigureasofnowin
tdefault_metric;/*Defaultmetricforredistribute.*/#defineOSPF_LSA_REFRESHER_GRANU
LARITY10#defineOSPF_LSA_REFRESHER_SLOTS\((OSPF_LS_REFRESH_TIME+OSPF_LS_REFRESH_S
HIFT)\/OSPF_LSA_REFRESHER_GRANULARITY\+1)struct{uint16_tindex;structlist*qs[OSPF
_LSA_REFRESHER_SLOTS];}lsa_refresh_queue;structthread*t_lsa_refresher;time_tlsa_
refresher_started;#defineOSPF_LSA_REFRESH_INTERVAL_DEFAULT10uint16_tlsa_refresh_
interval;/*Distanceparameter.*/uint8_tdistance_all;uint8_tdistance_intra;uint8_t
distance_inter;uint8_tdistance_external;/*StatisticsforLSAorigination.*/uint32_t
lsa_originate_count;/*StatisticsforLSAusedfornewinstantiation.*/uint32_trx_lsa_c
ount;/*Counterof"ipospfareax.x.x.x"used*formultualexclusionofnetworkcommandunder
*routerospforipospfareaxunderinterface.*/uint32_tif_ospf_cli_count;structroute_t
able*distance_table;/*UsedduringospfinstancegoingdownsendLSDB*updatetoneighborsi
mmediatly*/uint8_tinst_shutdown;/*Redistributedexternalinformation.*/structlist*
external[ZEBRA_ROUTE_MAX+1];#defineEXTERNAL_INFO(E)(E->external_info)QOBJ_FIELDS
};DECLARE_QOBJ_TYPE(ospf)/*OSPFareastructure.*/structospf_area{/*OSPFinstance.*/
structospf*ospf;/*Zebrainterfacelistbelongingtothearea.*/structlist*oiflist;/*Ar
eaID.*/structin_addrarea_id;/*AreaIDformat.*/intarea_id_fmt;#defineOSPF_AREA_ID_
FMT_DOTTEDQUAD1#defineOSPF_AREA_ID_FMT_DECIMAL2/*Addressrange.*/structlist*addre
ss_range;/*Configuredvariables.*/intexternal_routing;/*ExternalRoutingCapability
.*/intno_summary;/*Don'tinjectsummariesintostub.*/intshortcut_configured;/*Areac
onfiguredasshortcut.*/#defineOSPF_SHORTCUT_DEFAULT0#defineOSPF_SHORTCUT_ENABLE1#
defineOSPF_SHORTCUT_DISABLE2intshortcut_capability;/*OtherABRsagreeonS-bit*/uint
32_tdefault_cost;/*StubDefaultCost.*/intauth_type;/*Authenticationtype.*/uint8_t
NSSATranslatorRole;/*NSSAconfiguredrole*/#defineOSPF_NSSA_ROLE_NEVER0#defineOSPF
_NSSA_ROLE_CANDIDATE1#defineOSPF_NSSA_ROLE_ALWAYS2uint8_tNSSATranslatorState;/*N
SSAoperationalrole*/#defineOSPF_NSSA_TRANSLATE_DISABLED0#defineOSPF_NSSA_TRANSLA
TE_ENABLED1intNSSATranslatorStabilityInterval;uint8_ttransit;/*TransitCapability
.*/#defineOSPF_TRANSIT_FALSE0#defineOSPF_TRANSIT_TRUE1structroute_table*ranges;/
*ConfiguredAreaRanges.*//*RFC3137stubrouterstateflagsforarea*/uint8_tstub_router
_state;#defineOSPF_AREA_ADMIN_STUB_ROUTED(1<<0)/*adminstub-routerset*/#defineOSP
F_AREA_IS_STUB_ROUTED(1<<1)/*stub-routeractive*/#defineOSPF_AREA_WAS_START_STUB_
ROUTED(1<<2)/*startupSRwasdone*//*ArearelatedLSDBs[Type1-4].*/structospf_lsdb*ls
db;/*Self-originatedLSAs.*/structospf_lsa*router_lsa_self;structlist*opaque_lsa_
self;/*Type-10Opaque-LSAs*//*Areaannouncelist.*/struct{char*name;structaccess_li
st*list;}_export;#defineEXPORT_NAME(A)(A)->_export.name#defineEXPORT_LIST(A)(A)-
>_export.list/*Areaacceptancelist.*/struct{char*name;structaccess_list*list;}imp
ort;#defineIMPORT_NAME(A)(A)->import.name#defineIMPORT_LIST(A)(A)->import.list/*
Type3LSAAreaprefix-list.*/struct{char*name;structprefix_list*list;}plist_in;#def
inePREFIX_LIST_IN(A)(A)->plist_in.list#definePREFIX_NAME_IN(A)(A)->plist_in.name
struct{char*name;structprefix_list*list;}plist_out;#definePREFIX_LIST_OUT(A)(A)-
>plist_out.list#definePREFIX_NAME_OUT(A)(A)->plist_out.name/*ShortestPathTree.*/
structvertex*spf;/*Threads.*/structthread*t_stub_router;/*Stub-routertimer*/stru
ctthread*t_opaque_lsa_self;/*Type-10Opaque-LSAsorigin.*//*Statisticsfield.*/uint
32_tspf_calculation;/*SPFCalculationCount.*//*Timestamps.*/structtimevalts_spf;/
*SPFcalculationtimestamp.*//*Routercount.*/uint32_tabr_count;/*ABRrouterinthisar
ea.*/uint32_tasbr_count;/*ASBRrouterinthisarea.*//*Counters.*/uint32_tact_ints;/
*Activeinterfaces.*/uint32_tfull_nbrs;/*Fullyadjacentneighbors.*/uint32_tfull_vl
s;/*Fullyadjacentvirtualneighbors.*/};/*OSPFconfignetworkstructure.*/structospf_
network{/*AreaID.*/structin_addrarea_id;intarea_id_fmt;};/*OSPFNBMAneighborstruc
ture.*/structospf_nbr_nbma{/*NeighborIPaddress.*/structin_addraddr;/*OSPFinterfa
ce.*/structospf_interface*oi;/*OSPFneighborstructure.*/structospf_neighbor*nbr;/
*Neighborpriority.*/uint8_tpriority;/*Polltimervalue.*/uint32_tv_poll;/*Polltime
rthread.*/structthread*t_poll;/*Statechange.*/uint32_tstate_change;};/*Macro.*/#
defineOSPF_AREA_SAME(X,Y)\(memcmp((X->area_id),(Y->area_id),IPV4_MAX_BYTELEN)==0
)#defineIS_OSPF_ABR(O)((O)->flags&OSPF_FLAG_ABR)#defineIS_OSPF_ASBR(O)((O)->flag
s&OSPF_FLAG_ASBR)#defineOSPF_IS_AREA_ID_BACKBONE(I)((I).s_addr==OSPF_AREA_BACKBO
NE)#defineOSPF_IS_AREA_BACKBONE(A)OSPF_IS_AREA_ID_BACKBONE((A)->area_id)#ifdefro
undup#defineROUNDUP(val,gran)roundup(val,gran)#else/*roundup*/#defineROUNDUP(val
,gran)(((val)-1|(gran)-1)+1)#endif/*roundup*/#defineLSA_OPTIONS_GET(area)\(((are
a)->external_routing==OSPF_AREA_DEFAULT)?OSPF_OPTION_E:0)#defineLSA_OPTIONS_NSSA
_GET(area)\(((area)->external_routing==OSPF_AREA_NSSA)?OSPF_OPTION_NP:0)#defineO
SPF_TIMER_ON(T,F,V)thread_add_timer(master,(F),ospf,(V),&(T))#defineOSPF_AREA_TI
MER_ON(T,F,V)thread_add_timer(master,(F),area,(V),&(T))#defineOSPF_POLL_TIMER_ON
(T,F,V)thread_add_timer(master,(F),nbr_nbma,(V),&(T))#defineOSPF_POLL_TIMER_OFF(
X)OSPF_TIMER_OFF((X))#defineOSPF_TIMER_OFF(X)\do{\if(X){\thread_cancel(X);\(X)=N
ULL;\}\}while(0)/*Externvariables.*/externstructospf_master*om;externconstintosp
f_redistributed_proto_max;externstructzclient*zclient;externstructthread_master*
master;externintospf_zlog;externstructzebra_privs_tospfd_privs;/*Prototypes.*/ex
ternconstchar*ospf_redist_string(unsignedintroute_type);externstructospf*ospf_lo
okup_instance(unsignedshort);externstructospf*ospf_get(unsignedshortinstance,con
stchar*name);externstructospf*ospf_get_instance(unsignedshort);externstructospf*
ospf_lookup_by_inst_name(unsignedshortinstance,constchar*name);externstructospf*
ospf_lookup_by_vrf_id(vrf_id_tvrf_id);externvoidospf_finish(structospf*);externv
oidospf_router_id_update(structospf*ospf);externintospf_network_set(structospf*,
structprefix_ipv4*,structin_addr,int);externintospf_network_unset(structospf*,st
ructprefix_ipv4*,structin_addr);externintospf_area_display_format_set(structospf
*,structospf_area*area,intdf);externintospf_area_stub_set(structospf*,structin_a
ddr);externintospf_area_stub_unset(structospf*,structin_addr);externintospf_area
_no_summary_set(structospf*,structin_addr);externintospf_area_no_summary_unset(s
tructospf*,structin_addr);externintospf_area_nssa_set(structospf*,structin_addr)
;externintospf_area_nssa_unset(structospf*,structin_addr,int);externintospf_area
_nssa_translator_role_set(structospf*,structin_addr,int);externintospf_area_expo
rt_list_set(structospf*,structospf_area*,constchar*);externintospf_area_export_l
ist_unset(structospf*,structospf_area*);externintospf_area_import_list_set(struc
tospf*,structospf_area*,constchar*);externintospf_area_import_list_unset(structo
spf*,structospf_area*);externintospf_area_shortcut_set(structospf*,structospf_ar
ea*,int);externintospf_area_shortcut_unset(structospf*,structospf_area*);externi
ntospf_timers_refresh_set(structospf*,int);externintospf_timers_refresh_unset(st
ructospf*);externintospf_nbr_nbma_set(structospf*,structin_addr);externintospf_n
br_nbma_unset(structospf*,structin_addr);externintospf_nbr_nbma_priority_set(str
uctospf*,structin_addr,uint8_t);externintospf_nbr_nbma_priority_unset(structospf
*,structin_addr);externintospf_nbr_nbma_poll_interval_set(structospf*,structin_a
ddr,unsignedint);externintospf_nbr_nbma_poll_interval_unset(structospf*,structin
_addr);externvoidospf_prefix_list_update(structprefix_list*);externvoidospf_init
(void);externvoidospf_if_update(structospf*,structinterface*);externvoidospf_ls_
upd_queue_empty(structospf_interface*);externvoidospf_terminate(void);externvoid
ospf_nbr_nbma_if_update(structospf*,structospf_interface*);externstructospf_nbr_
nbma*ospf_nbr_nbma_lookup(structospf*,structin_addr);externstructospf_nbr_nbma*o
spf_nbr_nbma_lookup_next(structospf*,structin_addr*,int);externintospf_oi_count(
structinterface*);externstructospf_area*ospf_area_get(structospf*,structin_addr)
;externvoidospf_area_check_free(structospf*,structin_addr);externstructospf_area
*ospf_area_lookup_by_area_id(structospf*,structin_addr);externvoidospf_area_add_
if(structospf_area*,structospf_interface*);externvoidospf_area_del_if(structospf
_area*,structospf_interface*);externvoidospf_interface_area_set(structospf*,stru
ctinterface*);externvoidospf_interface_area_unset(structospf*,structinterface*);
externvoidospf_route_map_init(void);externvoidospf_master_init(structthread_mast
er*master);externvoidospf_vrf_init(void);externvoidospf_vrf_terminate(void);exte
rnvoidospf_vrf_link(structospf*ospf,structvrf*vrf);externvoidospf_vrf_unlink(str
uctospf*ospf,structvrf*vrf);constchar*ospf_vrf_id_to_name(vrf_id_tvrf_id);intosp
f_area_nssa_no_summary_set(structospf*,structin_addr);#endif/*_ZEBRA_OSPFD_H*/