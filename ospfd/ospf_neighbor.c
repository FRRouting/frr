/**OSPFNeighborfunctions.*Copyright(C)1999,2000ToshiakiTakada**ThisfileispartofG
NUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itundertheterm
softheGNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;eitherversi
on2,or(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopethatitwillb
euseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include"linklist.h"#include"prefix.h"#i
nclude"memory.h"#include"command.h"#include"thread.h"#include"stream.h"#include"
table.h"#include"log.h"#include"json.h"#include"ospfd/ospfd.h"#include"ospfd/osp
f_interface.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospf
d/ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/ospf_nsm.h"#include"
ospfd/ospf_packet.h"#include"ospfd/ospf_network.h"#include"ospfd/ospf_flood.h"#i
nclude"ospfd/ospf_dump.h"#include"ospfd/ospf_bfd.h"/*Fillinthethe'key'asappropri
atetoretrievetheentryfornbr*fromtheospf_interface'snbrstable.Indexedbyinterfacea
ddress*forallcasesexceptVirtual-linkandPointToPointinterfaces,where*neighboursar
eindexedbyrouter-IDinstead.*/staticvoidospf_nbr_key(structospf_interface*oi,stru
ctospf_neighbor*nbr,structprefix*key){key->family=AF_INET;key->prefixlen=IPV4_MA
X_BITLEN;/*vlinksareindexedbyrouter-id*/if(oi->type==OSPF_IFTYPE_VIRTUALLINK||oi
->type==OSPF_IFTYPE_POINTOPOINT)key->u.prefix4=nbr->router_id;elsekey->u.prefix4
=nbr->src;return;}structospf_neighbor*ospf_nbr_new(structospf_interface*oi){stru
ctospf_neighbor*nbr;/*Allcatenewneighbor.*/nbr=XCALLOC(MTYPE_OSPF_NEIGHBOR,sizeo
f(structospf_neighbor));/*Relateneighbortotheinterface.*/nbr->oi=oi;/*Setdefault
values.*/nbr->state=NSM_Down;/*Setinheritancevalues.*/nbr->v_inactivity=OSPF_IF_
PARAM(oi,v_wait);nbr->v_db_desc=OSPF_IF_PARAM(oi,retransmit_interval);nbr->v_ls_
req=OSPF_IF_PARAM(oi,retransmit_interval);nbr->v_ls_upd=OSPF_IF_PARAM(oi,retrans
mit_interval);nbr->priority=-1;/*DDflags.*/nbr->dd_flags=OSPF_DD_FLAG_MS|OSPF_DD
_FLAG_M|OSPF_DD_FLAG_I;/*LastreceivedandsentDD.*/nbr->last_send=NULL;nbr->nbr_nb
ma=NULL;ospf_lsdb_init(&nbr->db_sum);ospf_lsdb_init(&nbr->ls_rxmt);ospf_lsdb_ini
t(&nbr->ls_req);nbr->crypt_seqnum=0;ospf_bfd_info_nbr_create(oi,nbr);returnnbr;}
voidospf_nbr_free(structospf_neighbor*nbr){/*FreeDBsummarylist.*/if(ospf_db_summ
ary_count(nbr))ospf_db_summary_clear(nbr);/*ospf_db_summary_delete_all(nbr);*//*
Freelsrequestlist.*/if(ospf_ls_request_count(nbr))ospf_ls_request_delete_all(nbr
);/*Freeretransmitlist.*/if(ospf_ls_retransmit_count(nbr))ospf_ls_retransmit_cle
ar(nbr);/*CleanupLSDBs.*/ospf_lsdb_cleanup(&nbr->db_sum);ospf_lsdb_cleanup(&nbr-
>ls_req);ospf_lsdb_cleanup(&nbr->ls_rxmt);/*Clearlastsendpacket.*/if(nbr->last_s
end)ospf_packet_free(nbr->last_send);if(nbr->nbr_nbma){nbr->nbr_nbma->nbr=NULL;n
br->nbr_nbma=NULL;}/*Cancelalltimers.*/OSPF_NSM_TIMER_OFF(nbr->t_inactivity);OSP
F_NSM_TIMER_OFF(nbr->t_db_desc);OSPF_NSM_TIMER_OFF(nbr->t_ls_req);OSPF_NSM_TIMER
_OFF(nbr->t_ls_upd);/*Cancelallevents.*//*Threadlookupcostwouldbenegligible.*/th
read_cancel_event(master,nbr);ospf_bfd_info_free(&nbr->bfd_info);XFREE(MTYPE_OSP
F_NEIGHBOR,nbr);}/*DeletespecifiedOSPFneighborfrominterface.*/voidospf_nbr_delet
e(structospf_neighbor*nbr){structospf_interface*oi;structroute_node*rn;structpre
fixp;oi=nbr->oi;/*getappropriateprefix'key'*/ospf_nbr_key(oi,nbr,&p);rn=route_no
de_lookup(oi->nbrs,&p);if(rn){/*IflookupforaNBRsucceeds,theleafroute_nodecould*o
nlyexistbecausethereis(orwas)anbrthere.*Ifthenbrwasdeleted,theleafroute_nodeshou
ldhave*lostitslastrefcounttoo,andbedeleted.*Thereforealooked-upleafroute_nodeinn
brstable*shouldneverhaveNULLinfo.*/assert(rn->info);if(rn->info){rn->info=NULL;r
oute_unlock_node(rn);}elsezlog_info("Can'tfindneighbor%sintheinterface%s",inet_n
toa(nbr->src),IF_NAME(oi));route_unlock_node(rn);}else{/**Thisneighborwasnotfoun
d,butbeforewemoveonand*freetheneighborstructre,makesurethatitwasnot*indexedincor
rectlyandendedupinthe"worng"place*//*Reversethelookuprules*/if(oi->type==OSPF_IF
TYPE_VIRTUALLINK||oi->type==OSPF_IFTYPE_POINTOPOINT)p.u.prefix4=nbr->src;elsep.u
.prefix4=nbr->router_id;rn=route_node_lookup(oi->nbrs,&p);if(rn){/*Wefoundthenei
ghbor!*Nowmakesureitisnottheexactsameneighbor*structurethatweareabouttofree*/if(
nbr==rn->info){/*Sameneighbor,dropthereferencetoit*/rn->info=NULL;route_unlock_n
ode(rn);}route_unlock_node(rn);}}/*Freeospf_neighborstructure.*/ospf_nbr_free(nb
r);}/*Checkmyselfisintheneighborlist.*/intospf_nbr_bidirectional(structin_addr*r
outer_id,structin_addr*neighbors,intsize){inti;intmax;max=size/sizeof(structin_a
ddr);for(i=0;i<max;i++)if(IPV4_ADDR_SAME(router_id,&neighbors[i]))return1;return
0;}/*resetnbr_self*/voidospf_nbr_self_reset(structospf_interface*oi,structin_add
rrouter_id){if(oi->nbr_self)ospf_nbr_delete(oi->nbr_self);oi->nbr_self=ospf_nbr_
new(oi);ospf_nbr_add_self(oi,router_id);}/*Addselftonbrlist.*/voidospf_nbr_add_s
elf(structospf_interface*oi,structin_addrrouter_id){structprefixp;structroute_no
de*rn;if(!oi->nbr_self)oi->nbr_self=ospf_nbr_new(oi);/*Initialstate*/oi->nbr_sel
f->address=*oi->address;oi->nbr_self->priority=OSPF_IF_PARAM(oi,priority);oi->nb
r_self->router_id=router_id;oi->nbr_self->src=oi->address->u.prefix4;oi->nbr_sel
f->state=NSM_TwoWay;switch(oi->area->external_routing){caseOSPF_AREA_DEFAULT:SET
_FLAG(oi->nbr_self->options,OSPF_OPTION_E);break;caseOSPF_AREA_STUB:UNSET_FLAG(o
i->nbr_self->options,OSPF_OPTION_E);break;caseOSPF_AREA_NSSA:UNSET_FLAG(oi->nbr_
self->options,OSPF_OPTION_E);SET_FLAG(oi->nbr_self->options,OSPF_OPTION_NP);brea
k;}/*Addnbr_selftonbrstable*/ospf_nbr_key(oi,oi->nbr_self,&p);rn=route_node_get(
oi->nbrs,&p);if(rn->info){/*Thereisalreadypseudoneighbor.*/zlog_warn("router_id%
salreadypresentinneighbortable.noderefcount%u",inet_ntoa(router_id),rn->lock);ro
ute_unlock_node(rn);}elsern->info=oi->nbr_self;}/*Getneighborcountbystatus.Speci
fystatus=0,getallneighborotherthanmyself.*/intospf_nbr_count(structospf_interfac
e*oi,intstate){structospf_neighbor*nbr;structroute_node*rn;intcount=0;for(rn=rou
te_top(oi->nbrs);rn;rn=route_next(rn))if((nbr=rn->info))if(!IPV4_ADDR_SAME(&nbr-
>router_id,&oi->ospf->router_id))if(state==0||nbr->state==state)count++;returnco
unt;}intospf_nbr_count_opaque_capable(structospf_interface*oi){structospf_neighb
or*nbr;structroute_node*rn;intcount=0;for(rn=route_top(oi->nbrs);rn;rn=route_nex
t(rn))if((nbr=rn->info))if(!IPV4_ADDR_SAME(&nbr->router_id,&oi->ospf->router_id)
)if(nbr->state==NSM_Full)if(CHECK_FLAG(nbr->options,OSPF_OPTION_O))count++;retur
ncount;}/*lookupnbrbyaddress-usethisonlyifyouknowyoumust*otherwiseusetheospf_nbr
_lookup()wrapper,whichdeals*withvirtuallinkandPointToPointneighbours*/structospf
_neighbor*ospf_nbr_lookup_by_addr(structroute_table*nbrs,structin_addr*addr){str
uctprefixp;structroute_node*rn;structospf_neighbor*nbr;p.family=AF_INET;p.prefix
len=IPV4_MAX_BITLEN;p.u.prefix4=*addr;rn=route_node_lookup(nbrs,&p);if(!rn)retur
nNULL;/*Seecommentinospf_nbr_delete*/assert(rn->info);if(rn->info==NULL){route_u
nlock_node(rn);returnNULL;}nbr=(structospf_neighbor*)rn->info;route_unlock_node(
rn);returnnbr;}structospf_neighbor*ospf_nbr_lookup_by_routerid(structroute_table
*nbrs,structin_addr*id){structroute_node*rn;structospf_neighbor*nbr;for(rn=route
_top(nbrs);rn;rn=route_next(rn))if((nbr=rn->info)!=NULL)if(IPV4_ADDR_SAME(&nbr->
router_id,id)){route_unlock_node(rn);returnnbr;}returnNULL;}voidospf_renegotiate
_optional_capabilities(structospf*top){structlistnode*node;structospf_interface*
oi;structroute_table*nbrs;structroute_node*rn;structospf_neighbor*nbr;/*Atfirst,
flushself-originatedLSAsfromroutingdomain.*/ospf_flush_self_originated_lsas_now(
top);/*RevertallneighborstatustoExStart.*/for(ALL_LIST_ELEMENTS_RO(top->oiflist,
node,oi)){if((nbrs=oi->nbrs)==NULL)continue;for(rn=route_top(nbrs);rn;rn=route_n
ext(rn)){if((nbr=rn->info)==NULL||nbr==oi->nbr_self)continue;if(nbr->state<NSM_E
xStart)continue;if(IS_DEBUG_OSPF_EVENT)zlog_debug("Renegotiateoptionalcapabiliti
eswithneighbor(%s)",inet_ntoa(nbr->router_id));OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_S
eqNumberMismatch);}}return;}structospf_neighbor*ospf_nbr_lookup(structospf_inter
face*oi,structip*iph,structospf_header*ospfh){if(oi->type==OSPF_IFTYPE_VIRTUALLI
NK||oi->type==OSPF_IFTYPE_POINTOPOINT)return(ospf_nbr_lookup_by_routerid(oi->nbr
s,&ospfh->router_id));elsereturn(ospf_nbr_lookup_by_addr(oi->nbrs,&iph->ip_src))
;}staticstructospf_neighbor*ospf_nbr_add(structospf_interface*oi,structospf_head
er*ospfh,structprefix*p){structospf_neighbor*nbr;nbr=ospf_nbr_new(oi);nbr->state
=NSM_Down;nbr->src=p->u.prefix4;memcpy(&nbr->address,p,sizeof(structprefix));nbr
->nbr_nbma=NULL;if(oi->type==OSPF_IFTYPE_NBMA){structospf_nbr_nbma*nbr_nbma;stru
ctlistnode*node;for(ALL_LIST_ELEMENTS_RO(oi->nbr_nbma,node,nbr_nbma)){if(IPV4_AD
DR_SAME(&nbr_nbma->addr,&nbr->src)){nbr_nbma->nbr=nbr;nbr->nbr_nbma=nbr_nbma;if(
nbr_nbma->t_poll)OSPF_POLL_TIMER_OFF(nbr_nbma->t_poll);nbr->state_change=nbr_nbm
a->state_change+1;}}}/*Newnbr,savethecryptosequencenumberifnecessary*/if(ntohs(o
spfh->auth_type)==OSPF_AUTH_CRYPTOGRAPHIC)nbr->crypt_seqnum=ospfh->u.crypt.crypt
_seqnum;if(IS_DEBUG_OSPF_EVENT)zlog_debug("NSM[%s:%s]:start",IF_NAME(nbr->oi),in
et_ntoa(nbr->router_id));returnnbr;}structospf_neighbor*ospf_nbr_get(structospf_
interface*oi,structospf_header*ospfh,structip*iph,structprefix*p){structroute_no
de*rn;structprefixkey;structospf_neighbor*nbr;key.family=AF_INET;key.prefixlen=I
PV4_MAX_BITLEN;if(oi->type==OSPF_IFTYPE_VIRTUALLINK||oi->type==OSPF_IFTYPE_POINT
OPOINT)key.u.prefix4=ospfh->router_id;/*indexvlinkandptpnbrsbyrouter-id*/elsekey
.u.prefix4=iph->ip_src;rn=route_node_get(oi->nbrs,&key);if(rn->info){route_unloc
k_node(rn);nbr=rn->info;if(oi->type==OSPF_IFTYPE_NBMA&&nbr->state==NSM_Attempt){
nbr->src=iph->ip_src;memcpy(&nbr->address,p,sizeof(structprefix));}}else{rn->inf
o=nbr=ospf_nbr_add(oi,ospfh,p);}nbr->router_id=ospfh->router_id;returnnbr;}