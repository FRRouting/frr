/**Routemapfunctionofospfd.*Copyright(C)2000IPInfusionInc.**WrittenbyToshiakiTak
ada.**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/
ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwar
eFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistribu
tedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarra
ntyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicen
seformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*w
iththisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51
FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"memory.h
"#include"prefix.h"#include"table.h"#include"vty.h"#include"routemap.h"#include"
command.h"#include"log.h"#include"plist.h"#include"vrf.h"#include"ospfd/ospfd.h"
#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_interface.h"#include"ospfd/ospf_l
sa.h"#include"ospfd/ospf_route.h"#include"ospfd/ospf_zebra.h"/*Hookfunctionforup
datingroute_mapassignment.*/staticvoidospf_route_map_update(constchar*name){stru
ctospf*ospf;inttype;structlistnode*n1=NULL;/*IfOSPFinstatncedoesnotexist,returnr
ightnow.*/if(listcount(om->ospf)==0)return;for(ALL_LIST_ELEMENTS_RO(om->ospf,n1,
ospf)){/*Updateroute-map*/for(type=0;type<=ZEBRA_ROUTE_MAX;type++){structlist*re
d_list;structlistnode*node;structospf_redist*red;red_list=ospf->redist[type];if(
!red_list)continue;for(ALL_LIST_ELEMENTS_RO(red_list,node,red)){if(ROUTEMAP_NAME
(red)&&strcmp(ROUTEMAP_NAME(red),name)==0){/*Keepoldroute-map.*/structroute_map*
old=ROUTEMAP(red);/*Updateroute-map.*/ROUTEMAP(red)=route_map_lookup_by_name(ROU
TEMAP_NAME(red));/*Noupdateforthisdistributetype.*/if(old==NULL&&ROUTEMAP(red)==
NULL)continue;ospf_distribute_list_update(ospf,type,red->instance);}}}}}staticvo
idospf_route_map_event(route_map_event_tevent,constchar*name){structospf*ospf;in
ttype;structlistnode*n1=NULL;for(ALL_LIST_ELEMENTS_RO(om->ospf,n1,ospf)){for(typ
e=0;type<=ZEBRA_ROUTE_MAX;type++){structlist*red_list;structlistnode*node;struct
ospf_redist*red;red_list=ospf->redist[type];if(!red_list)continue;for(ALL_LIST_E
LEMENTS_RO(red_list,node,red)){if(ROUTEMAP_NAME(red)&&ROUTEMAP(red)&&!strcmp(ROU
TEMAP_NAME(red),name)){ospf_distribute_list_update(ospf,type,red->instance);}}}}
}/*`matchipnetxthop'*//*Matchfunctionreturn1ifmatchissuccesselsereturnzero.*/sta
ticroute_map_result_troute_match_ip_nexthop(void*rule,structprefix*prefix,route_
map_object_ttype,void*object){structaccess_list*alist;structexternal_info*ei=obj
ect;structprefix_ipv4p;if(type==RMAP_OSPF){p.family=AF_INET;p.prefix=ei->nexthop
;p.prefixlen=IPV4_MAX_BITLEN;alist=access_list_lookup(AFI_IP,(char*)rule);if(ali
st==NULL)returnRMAP_NOMATCH;return(access_list_apply(alist,&p)==FILTER_DENY?RMAP
_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}/*Routemap`ipnext-hop'matchstatement.`
arg'shouldbeaccess-listname.*/staticvoid*route_match_ip_nexthop_compile(constcha
r*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}/*Freeroutemap'scompiled`ipa
ddress'value.*/staticvoidroute_match_ip_nexthop_free(void*rule){XFREE(MTYPE_ROUT
E_MAP_COMPILED,rule);}/*Routemapcommandsformetricmatching.*/structroute_map_rule
_cmdroute_match_ip_nexthop_cmd={"ipnext-hop",route_match_ip_nexthop,route_match_
ip_nexthop_compile,route_match_ip_nexthop_free};/*`matchipnext-hopprefix-listPRE
FIX_LIST'*/staticroute_map_result_troute_match_ip_next_hop_prefix_list(void*rule
,structprefix*prefix,route_map_object_ttype,void*object){structprefix_list*plist
;structexternal_info*ei=object;structprefix_ipv4p;if(type==RMAP_OSPF){p.family=A
F_INET;p.prefix=ei->nexthop;p.prefixlen=IPV4_MAX_BITLEN;plist=prefix_list_lookup
(AFI_IP,(char*)rule);if(plist==NULL)returnRMAP_NOMATCH;return(prefix_list_apply(
plist,&p)==PREFIX_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}staticvoid*
route_match_ip_next_hop_prefix_list_compile(constchar*arg){returnXSTRDUP(MTYPE_R
OUTE_MAP_COMPILED,arg);}staticvoidroute_match_ip_next_hop_prefix_list_free(void*
rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}structroute_map_rule_cmdroute_match_
ip_next_hop_prefix_list_cmd={"ipnext-hopprefix-list",route_match_ip_next_hop_pre
fix_list,route_match_ip_next_hop_prefix_list_compile,route_match_ip_next_hop_pre
fix_list_free};/*`matchipaddressIP_ACCESS_LIST'*//*Matchfunctionshouldreturn1ifm
atchissuccesselsereturnzero.*/staticroute_map_result_troute_match_ip_address(voi
d*rule,structprefix*prefix,route_map_object_ttype,void*object){structaccess_list
*alist;/*structprefix_ipv4match;*/if(type==RMAP_OSPF){alist=access_list_lookup(A
FI_IP,(char*)rule);if(alist==NULL)returnRMAP_NOMATCH;return(access_list_apply(al
ist,prefix)==FILTER_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}/*Routema
p`ipaddress'matchstatement.`arg'shouldbeaccess-listname.*/staticvoid*route_match
_ip_address_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE_MAP_COMPILED,arg);}
/*Freeroutemap'scompiled`ipaddress'value.*/staticvoidroute_match_ip_address_free
(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routemapcommandsforipaddress
matching.*/structroute_map_rule_cmdroute_match_ip_address_cmd={"ipaddress",route
_match_ip_address,route_match_ip_address_compile,route_match_ip_address_free};/*
`matchipaddressprefix-listPREFIX_LIST'*/staticroute_map_result_troute_match_ip_a
ddress_prefix_list(void*rule,structprefix*prefix,route_map_object_ttype,void*obj
ect){structprefix_list*plist;if(type==RMAP_OSPF){plist=prefix_list_lookup(AFI_IP
,(char*)rule);if(plist==NULL)returnRMAP_NOMATCH;return(prefix_list_apply(plist,p
refix)==PREFIX_DENY?RMAP_NOMATCH:RMAP_MATCH);}returnRMAP_NOMATCH;}staticvoid*rou
te_match_ip_address_prefix_list_compile(constchar*arg){returnXSTRDUP(MTYPE_ROUTE
_MAP_COMPILED,arg);}staticvoidroute_match_ip_address_prefix_list_free(void*rule)
{XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}structroute_map_rule_cmdroute_match_ip_ad
dress_prefix_list_cmd={"ipaddressprefix-list",route_match_ip_address_prefix_list
,route_match_ip_address_prefix_list_compile,route_match_ip_address_prefix_list_f
ree};/*`matchinterfaceIFNAME'*//*Matchfunctionshouldreturn1ifmatchissuccesselser
eturnzero.*/staticroute_map_result_troute_match_interface(void*rule,structprefix
*prefix,route_map_object_ttype,void*object){structinterface*ifp;structexternal_i
nfo*ei;if(type==RMAP_OSPF){ei=object;ifp=if_lookup_by_name_all_vrf((char*)rule);
if(ifp==NULL||ifp->ifindex!=ei->ifindex)returnRMAP_NOMATCH;returnRMAP_MATCH;}ret
urnRMAP_NOMATCH;}/*Routemap`interface'matchstatement.`arg'shouldbeinterfacename.
*/staticvoid*route_match_interface_compile(constchar*arg){returnXSTRDUP(MTYPE_RO
UTE_MAP_COMPILED,arg);}/*Freeroutemap'scompiled`interface'value.*/staticvoidrout
e_match_interface_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule);}/*Routem
apcommandsforipaddressmatching.*/structroute_map_rule_cmdroute_match_interface_c
md={"interface",route_match_interface,route_match_interface_compile,route_match_
interface_free};/*Matchfunctionreturn1ifmatchissuccesselsereturnzero.*/staticrou
te_map_result_troute_match_tag(void*rule,structprefix*prefix,route_map_object_tt
ype,void*object){route_tag_t*tag;structexternal_info*ei;if(type==RMAP_OSPF){tag=
rule;ei=object;return((ei->tag==*tag)?RMAP_MATCH:RMAP_NOMATCH);}returnRMAP_NOMAT
CH;}/*Routemapcommandsfortagmatching.*/staticstructroute_map_rule_cmdroute_match
_tag_cmd={"tag",route_match_tag,route_map_rule_tag_compile,route_map_rule_tag_fr
ee,};structospf_metric{enum{metric_increment,metric_decrement,metric_absolute}ty
pe;boolused;uint32_tmetric;};/*`setmetricMETRIC'*//*Setmetrictoattribute.*/stati
croute_map_result_troute_set_metric(void*rule,structprefix*prefix,route_map_obje
ct_ttype,void*object){structospf_metric*metric;structexternal_info*ei;if(type==R
MAP_OSPF){/*Fetchroutemap'sruleinformation.*/metric=rule;ei=object;/*Setmetricou
tvalue.*/if(!metric->used)returnRMAP_OKAY;if(metric->type==metric_increment)ei->
route_map_set.metric+=metric->metric;if(metric->type==metric_decrement)ei->route
_map_set.metric-=metric->metric;if(metric->type==metric_absolute)ei->route_map_s
et.metric=metric->metric;if((signedint)ei->route_map_set.metric<1)ei->route_map_
set.metric=-1;if(ei->route_map_set.metric>OSPF_LS_INFINITY)ei->route_map_set.met
ric=OSPF_LS_INFINITY;}returnRMAP_OKAY;}/*setmetriccompilation.*/staticvoid*route
_set_metric_compile(constchar*arg){structospf_metric*metric;metric=XCALLOC(MTYPE
_ROUTE_MAP_COMPILED,sizeof(uint32_t));metric->used=false;if(all_digit(arg))metri
c->type=metric_absolute;if(strmatch(arg,"+rtt")||strmatch(arg,"-rtt")){zlog_warn
("OSPFdoesnotsupport'setmetric+rtt/-rtt'");returnmetric;}if((arg[0]=='+')&&all_d
igit(arg+1)){metric->type=metric_increment;arg++;}if((arg[0]=='-')&&all_digit(ar
g+1)){metric->type=metric_decrement;arg++;}metric->metric=strtoul(arg,NULL,10);i
f(metric->metric)metric->used=true;returnmetric;}/*Freeroutemap'scompiled`setmet
ric'value.*/staticvoidroute_set_metric_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COM
PILED,rule);}/*Setmetricrulestructure.*/structroute_map_rule_cmdroute_set_metric
_cmd={"metric",route_set_metric,route_set_metric_compile,route_set_metric_free,}
;/*`setmetric-typeTYPE'*//*Setmetric-typetoattribute.*/staticroute_map_result_tr
oute_set_metric_type(void*rule,structprefix*prefix,route_map_object_ttype,void*o
bject){uint32_t*metric_type;structexternal_info*ei;if(type==RMAP_OSPF){/*Fetchro
utemap'sruleinformation.*/metric_type=rule;ei=object;/*Setmetricoutvalue.*/ei->r
oute_map_set.metric_type=*metric_type;}returnRMAP_OKAY;}/*setmetric-typecompilat
ion.*/staticvoid*route_set_metric_type_compile(constchar*arg){uint32_t*metric_ty
pe;metric_type=XCALLOC(MTYPE_ROUTE_MAP_COMPILED,sizeof(uint32_t));if(strcmp(arg,
"type-1")==0)*metric_type=EXTERNAL_METRIC_TYPE_1;elseif(strcmp(arg,"type-2")==0)
*metric_type=EXTERNAL_METRIC_TYPE_2;if(*metric_type==EXTERNAL_METRIC_TYPE_1||*me
tric_type==EXTERNAL_METRIC_TYPE_2)returnmetric_type;XFREE(MTYPE_ROUTE_MAP_COMPIL
ED,metric_type);returnNULL;}/*Freeroutemap'scompiled`setmetric-type'value.*/stat
icvoidroute_set_metric_type_free(void*rule){XFREE(MTYPE_ROUTE_MAP_COMPILED,rule)
;}/*Setmetricrulestructure.*/structroute_map_rule_cmdroute_set_metric_type_cmd={
"metric-type",route_set_metric_type,route_set_metric_type_compile,route_set_metr
ic_type_free,};staticroute_map_result_troute_set_tag(void*rule,structprefix*pref
ix,route_map_object_ttype,void*object){route_tag_t*tag;structexternal_info*ei;if
(type==RMAP_OSPF){tag=rule;ei=object;/*Settagvalue*/ei->tag=*tag;}returnRMAP_OKA
Y;}/*Routemapcommandsfortagset.*/staticstructroute_map_rule_cmdroute_set_tag_cmd
={"tag",route_set_tag,route_map_rule_tag_compile,route_map_rule_tag_free,};DEFUN
(set_metric_type,set_metric_type_cmd,"setmetric-type<type-1|type-2>",SET_STR"Typ
eofmetricfordestinationroutingprotocol\n""OSPF[6]externaltype1metric\n""OSPF[6]e
xternaltype2metric\n"){char*ext=argv[2]->text;returngeneric_set_add(vty,VTY_GET_
CONTEXT(route_map_index),"metric-type",ext);}DEFUN(no_set_metric_type,no_set_met
ric_type_cmd,"nosetmetric-type[<type-1|type-2>]",NO_STRSET_STR"Typeofmetricforde
stinationroutingprotocol\n""OSPF[6]externaltype1metric\n""OSPF[6]externaltype2me
tric\n"){char*ext=(argc==4)?argv[3]->text:NULL;returngeneric_set_delete(vty,VTY_
GET_CONTEXT(route_map_index),"metric-type",ext);}/*Route-mapinit*/voidospf_route
_map_init(void){route_map_init();route_map_add_hook(ospf_route_map_update);route
_map_delete_hook(ospf_route_map_update);route_map_event_hook(ospf_route_map_even
t);route_map_set_metric_hook(generic_set_add);route_map_no_set_metric_hook(gener
ic_set_delete);route_map_match_ip_next_hop_hook(generic_match_add);route_map_no_
match_ip_next_hop_hook(generic_match_delete);route_map_match_interface_hook(gene
ric_match_add);route_map_no_match_interface_hook(generic_match_delete);route_map
_match_ip_address_hook(generic_match_add);route_map_no_match_ip_address_hook(gen
eric_match_delete);route_map_match_ip_address_prefix_list_hook(generic_match_add
);route_map_no_match_ip_address_prefix_list_hook(generic_match_delete);route_map
_match_ip_next_hop_prefix_list_hook(generic_match_add);route_map_no_match_ip_nex
t_hop_prefix_list_hook(generic_match_delete);route_map_match_tag_hook(generic_ma
tch_add);route_map_no_match_tag_hook(generic_match_delete);route_map_set_metric_
hook(generic_set_add);route_map_no_set_metric_hook(generic_set_delete);route_map
_set_tag_hook(generic_set_add);route_map_no_set_tag_hook(generic_set_delete);rou
te_map_install_match(&route_match_ip_nexthop_cmd);route_map_install_match(&route
_match_ip_next_hop_prefix_list_cmd);route_map_install_match(&route_match_ip_addr
ess_cmd);route_map_install_match(&route_match_ip_address_prefix_list_cmd);route_
map_install_match(&route_match_interface_cmd);route_map_install_match(&route_mat
ch_tag_cmd);route_map_install_set(&route_set_metric_cmd);route_map_install_set(&
route_set_metric_type_cmd);route_map_install_set(&route_set_tag_cmd);install_ele
ment(RMAP_NODE,&set_metric_type_cmd);install_element(RMAP_NODE,&no_set_metric_ty
pe_cmd);}