/**OSPFroutingtable.*Copyright(C)1999,2000ToshiakiTakada**ThisfileispartofGNUZeb
ra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofth
eGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,o
r(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeusef
ul,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNE
SSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshould
havereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOP
YING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston
,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#include"table.h"#include"m
emory.h"#include"linklist.h"#include"log.h"#include"if.h"#include"command.h"#inc
lude"sockunion.h"#include"ospfd/ospfd.h"#include"ospfd/ospf_interface.h"#include
"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_route.h"#includ
e"ospfd/ospf_spf.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_dump.h"struct
ospf_route*ospf_route_new(){structospf_route*new;new=XCALLOC(MTYPE_OSPF_ROUTE,si
zeof(structospf_route));new->paths=list_new();new->paths->del=(void(*)(void*))os
pf_path_free;returnnew;}voidospf_route_free(structospf_route*or){if(or->paths)li
st_delete_and_null(&or->paths);XFREE(MTYPE_OSPF_ROUTE,or);}structospf_path*ospf_
path_new(){structospf_path*new;new=XCALLOC(MTYPE_OSPF_PATH,sizeof(structospf_pat
h));returnnew;}staticstructospf_path*ospf_path_dup(structospf_path*path){structo
spf_path*new;new=ospf_path_new();memcpy(new,path,sizeof(structospf_path));return
new;}voidospf_path_free(structospf_path*op){XFREE(MTYPE_OSPF_PATH,op);}voidospf_
route_delete(structospf*ospf,structroute_table*rt){structroute_node*rn;structosp
f_route*or;for(rn=route_top(rt);rn;rn=route_next(rn))if((or=rn->info)!=NULL){if(
or->type==OSPF_DESTINATION_NETWORK)ospf_zebra_delete(ospf,(structprefix_ipv4*)&r
n->p,or);elseif(or->type==OSPF_DESTINATION_DISCARD)ospf_zebra_delete_discard(osp
f,(structprefix_ipv4*)&rn->p);}}voidospf_route_table_free(structroute_table*rt){
structroute_node*rn;structospf_route*or;for(rn=route_top(rt);rn;rn=route_next(rn
))if((or=rn->info)!=NULL){ospf_route_free(or);rn->info=NULL;route_unlock_node(rn
);}route_table_finish(rt);}/*Ifaprefixexistsinthenewroutingtable,thenreturn1,oth
erwisereturn0.SincetheZEBRA-RIBdoesanimplicitwithdraw,itisnotnecessarytosendadel
ete,anaddlaterwillactlikeanimplicitdelete.*/staticintospf_route_exist_new_table(
structroute_table*rt,structprefix_ipv4*prefix){structroute_node*rn;assert(rt);as
sert(prefix);rn=route_node_lookup(rt,(structprefix*)prefix);if(!rn){return0;}rou
te_unlock_node(rn);if(!rn->info){return0;}return1;}/*Ifaprefixandanexthopmatchan
yrouteintheroutingtable,thenreturn1,otherwisereturn0.*/intospf_route_match_same(
structroute_table*rt,structprefix_ipv4*prefix,structospf_route*newor){structrout
e_node*rn;structospf_route*or;structospf_path*op;structospf_path*newop;structlis
tnode*n1;structlistnode*n2;if(!rt||!prefix)return0;rn=route_node_lookup(rt,(stru
ctprefix*)prefix);if(!rn||!rn->info)return0;route_unlock_node(rn);or=rn->info;if
(or->type==newor->type&&or->cost==newor->cost){if(or->type==OSPF_DESTINATION_NET
WORK){if(or->paths->count!=newor->paths->count)return0;/*Checkeachpath.*/for(n1=
listhead(or->paths),n2=listhead(newor->paths);n1&&n2;n1=listnextnode(n1),n2=list
nextnode(n2)){op=listgetdata(n1);newop=listgetdata(n2);if(!IPV4_ADDR_SAME(&op->n
exthop,&newop->nexthop))return0;if(op->ifindex!=newop->ifindex)return0;}return1;
}elseif(prefix_same(&rn->p,(structprefix*)prefix))return1;}return0;}/*deleterout
esgeneratedfromAS-Externalroutesifthereisainter/intra*arearoute*/staticvoidospf_
route_delete_same_ext(structospf*ospf,structroute_table*external_routes,structro
ute_table*routes){structroute_node*rn,*ext_rn;if((external_routes==NULL)||(route
s==NULL))return;/*Removedeletedroutes*/for(rn=route_top(routes);rn;rn=route_next
(rn)){if(rn&&rn->info){structprefix_ipv4*p=(structprefix_ipv4*)(&rn->p);if((ext_
rn=route_node_lookup(external_routes,(structprefix*)p))){if(ext_rn->info){ospf_z
ebra_delete(ospf,p,ext_rn->info);ospf_route_free(ext_rn->info);ext_rn->info=NULL
;}route_unlock_node(ext_rn);}}}}/*rt:Old,cmprt:New*/staticvoidospf_route_delete_
uniq(structospf*ospf,structroute_table*rt,structroute_table*cmprt){structroute_n
ode*rn;structospf_route*or;for(rn=route_top(rt);rn;rn=route_next(rn))if((or=rn->
info)!=NULL)if(or->path_type==OSPF_PATH_INTRA_AREA||or->path_type==OSPF_PATH_INT
ER_AREA){if(or->type==OSPF_DESTINATION_NETWORK){if(!ospf_route_exist_new_table(c
mprt,(structprefix_ipv4*)&rn->p))ospf_zebra_delete(ospf,(structprefix_ipv4*)&rn-
>p,or);}elseif(or->type==OSPF_DESTINATION_DISCARD)if(!ospf_route_exist_new_table
(cmprt,(structprefix_ipv4*)&rn->p))ospf_zebra_delete_discard(ospf,(structprefix_
ipv4*)&rn->p);}}/*Installroutestotable.*/voidospf_route_install(structospf*ospf,
structroute_table*rt){structroute_node*rn;structospf_route*or;/*rtcontainsnewrou
tingtable,new_tablecontainsanoldone.updatingpointers*/if(ospf->old_table)ospf_ro
ute_table_free(ospf->old_table);ospf->old_table=ospf->new_table;ospf->new_table=
rt;/*Deleteoldroutes.*/if(ospf->old_table)ospf_route_delete_uniq(ospf,ospf->old_
table,rt);if(ospf->old_external_route)ospf_route_delete_same_ext(ospf,ospf->old_
external_route,rt);/*Installnewroutes.*/for(rn=route_top(rt);rn;rn=route_next(rn
))if((or=rn->info)!=NULL){if(or->type==OSPF_DESTINATION_NETWORK){if(!ospf_route_
match_same(ospf->old_table,(structprefix_ipv4*)&rn->p,or))ospf_zebra_add(ospf,(s
tructprefix_ipv4*)&rn->p,or);}elseif(or->type==OSPF_DESTINATION_DISCARD)if(!ospf
_route_match_same(ospf->old_table,(structprefix_ipv4*)&rn->p,or))ospf_zebra_add_
discard(ospf,(structprefix_ipv4*)&rn->p);}}/*RFC232816.1.(4).For"router".*/voido
spf_intra_add_router(structroute_table*rt,structvertex*v,structospf_area*area){s
tructroute_node*rn;structospf_route*or;structprefix_ipv4p;structrouter_lsa*lsa;i
f(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_router:Start");lsa=(structroute
r_lsa*)v->lsa;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_router:LSID:%s",
inet_ntoa(lsa->header.id));if(!OSPF_IS_AREA_BACKBONE(area))ospf_vl_up_check(area
,lsa->header.id,v);if(!CHECK_FLAG(lsa->flags,ROUTER_LSA_SHORTCUT))area->shortcut
_capability=0;/*IfthenewlyaddedvertexisanareaborderrouterorASboundaryrouter,arou
tingtableentryisaddedwhosedestinationtypeis"router".*/if(!IS_ROUTER_LSA_BORDER(l
sa)&&!IS_ROUTER_LSA_EXTERNAL(lsa)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra
_add_router:""thisrouterisneitherASBRnorABR,skippingit");return;}/*UpdateABRandA
SBRcountinthisarea.*/if(IS_ROUTER_LSA_BORDER(lsa))area->abr_count++;if(IS_ROUTER
_LSA_EXTERNAL(lsa))area->asbr_count++;/*TheOptionsfieldfoundintheassociatedroute
r-LSAiscopiedintotheroutingtableentry'sOptionalcapabilitiesfield.Callthenewlyadd
edvertexRouterX.*/or=ospf_route_new();or->id=v->id;or->u.std.area_id=area->area_
id;or->u.std.external_routing=area->external_routing;or->path_type=OSPF_PATH_INT
RA_AREA;or->cost=v->distance;or->type=OSPF_DESTINATION_ROUTER;or->u.std.origin=(
structlsa_header*)lsa;or->u.std.options=lsa->header.options;or->u.std.flags=lsa-
>flags;/*IfRouterXistheendpointofoneofthecalculatingrouter'svirtuallinks,andthev
irtuallinkusesAreaAasTransitarea:thevirtuallinkisdeclaredup,theIPaddressofthevir
tualinterfaceissettotheIPaddressoftheoutgoinginterfacecalculatedaboveforRouterX,
andthevirtualneighbor'sIPaddressissettoRouterX'sinterfaceaddress(containedinRout
erX'srouter-LSA)thatpointsbacktotherootoftheshortest-pathtree;equivalently,thisi
stheinterfacethatpointsbacktoRouterX'sparentvertexontheshortest-pathtree(similar
tothecalculationinSection16.1.1).*/p.family=AF_INET;p.prefix=v->id;p.prefixlen=I
PV4_MAX_BITLEN;apply_mask_ipv4(&p);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra
_add_router:talkingabout%s/%d",inet_ntoa(p.prefix),p.prefixlen);rn=route_node_ge
t(rt,(structprefix*)&p);/*NotethatwekeepallroutestoABRsandASBRs,notonlythebest*/
if(rn->info==NULL)rn->info=list_new();elseroute_unlock_node(rn);ospf_route_copy_
nexthops_from_vertex(or,v);listnode_add(rn->info,or);if(IS_DEBUG_OSPF_EVENT)zlog
_debug("ospf_intra_add_router:Stop");}/*RFC232816.1.(4).Fortransitnetwork.*/void
ospf_intra_add_transit(structroute_table*rt,structvertex*v,structospf_area*area)
{structroute_node*rn;structospf_route*or;structprefix_ipv4p;structnetwork_lsa*ls
a;lsa=(structnetwork_lsa*)v->lsa;/*Ifthenewlyaddedvertexisatransitnetwork,therou
tingtableentryforthenetworkislocated.Theentry'sDestinationIDistheIPnetworknumber
,whichcanbeobtainedbymaskingtheVertexID(LinkStateID)withitsassociatedsubnetmask(
foundinthebodyoftheassociatednetwork-LSA).*/p.family=AF_INET;p.prefix=v->id;p.pr
efixlen=ip_masklen(lsa->mask);apply_mask_ipv4(&p);rn=route_node_get(rt,(structpr
efix*)&p);/*Iftheroutingtableentryalreadyexists(i.e.,thereisalreadyanintra-arear
outetothedestinationinstalledintheroutingtable),multipleverticeshavemappedtothes
ameIPnetwork.Forexample,thiscanoccurwhenanewDesignatedRouterisbeingestablished.I
nthiscase,thecurrentroutingtableentryshouldbeoverwrittenifandonlyifthenewlyfound
pathisjustasshortandthecurrentroutingtableentry'sLinkStateOriginhasasmallerLinkS
tateIDthanthenewlyaddedvertex'LSA.*/if(rn->info){structospf_route*cur_or;route_u
nlock_node(rn);cur_or=rn->info;if(v->distance>cur_or->cost||IPV4_ADDR_CMP(&cur_o
r->u.std.origin->id,&lsa->header.id)>0)return;ospf_route_free(rn->info);}or=ospf
_route_new();or->id=v->id;or->u.std.area_id=area->area_id;or->u.std.external_rou
ting=area->external_routing;or->path_type=OSPF_PATH_INTRA_AREA;or->cost=v->dista
nce;or->type=OSPF_DESTINATION_NETWORK;or->u.std.origin=(structlsa_header*)lsa;os
pf_route_copy_nexthops_from_vertex(or,v);rn->info=or;}/*RFC232816.1.secondstage.
*/voidospf_intra_add_stub(structroute_table*rt,structrouter_lsa_link*link,struct
vertex*v,structospf_area*area,intparent_is_root,intlsa_pos){uint32_tcost;structr
oute_node*rn;structospf_route*or;structprefix_ipv4p;structrouter_lsa*lsa;structo
spf_interface*oi;structospf_path*path;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_in
tra_add_stub():Start");lsa=(structrouter_lsa*)v->lsa;p.family=AF_INET;p.prefix=l
ink->link_id;p.prefixlen=ip_masklen(link->link_data);apply_mask_ipv4(&p);if(IS_D
EBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():processingrouteto%s/%d",inet_n
toa(p.prefix),p.prefixlen);/*(1)CalculatethedistanceDofstubnetworkfromtheroot.Di
sequaltothedistancefromtheroottotheroutervertex(calculatedinstage1),plusthestubn
etworklink'sadvertisedcost.*/cost=v->distance+ntohs(link->m[0].metric);if(IS_DEB
UG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():calculatedcostis%d+%d=%d",v->dis
tance,ntohs(link->m[0].metric),cost);/*PtPlinkswith/32masksaddshostroutestoremot
e,directly*connectedhosts,seeRFC2328,12.4.1.1,Option1.*Suchroutescanjustbeignore
dforthesakeoftidyness.*/if(parent_is_root&&link->link_data.s_addr==0xffffffff&&o
spf_if_lookup_by_local_addr(area->ospf,NULL,link->link_id)){if(IS_DEBUG_OSPF_EVE
NT)zlog_debug("%s:ignoringhostroute%s/32toself.",__func__,inet_ntoa(link->link_i
d));return;}rn=route_node_get(rt,(structprefix*)&p);/*Lookupcurrentroutingtable.
*/if(rn->info){structospf_route*cur_or;route_unlock_node(rn);cur_or=rn->info;if(
IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():""anotherroutetothesamepre
fixfoundwithcost%u",cur_or->cost);/*Comparethisdistancetothecurrentbestcosttothe
stubnetwork.Thisisdonebylookingupthestubnetwork'scurrentroutingtableentry.Ifthec
alculateddistanceDislarger,goontoexaminethenextstubnetworklinkintheLSA.*/if(cost
>cur_or->cost){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():oldroute
isbetter,exit");return;}/*(2)Ifthisstepisreached,thestubnetwork'sroutingtableent
rymustbeupdated.Calculatethesetofnexthopsthatwouldresultfromusingthestubnetworkl
ink.ThiscalculationisshowninSection16.1.1;inputtothiscalculationisthedestination
(thestubnetwork)andtheparentvertex(theroutervertex).IfthedistanceDisthesameasthe
currentroutingtablecost,simplyaddthissetofnexthopstotheroutingtableentry'slistof
nexthops.Inthiscase,theroutingtablealreadyhasaLinkStateOrigin.IfthisLinkStateOri
ginisarouter-LSAwhoseLinkStateIDissmallerthanV'sRouterID,resettheLinkStateOrigin
toV'srouter-LSA.*/if(cost==cur_or->cost){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf
_intra_add_stub():routesareequal,merge");ospf_route_copy_nexthops_from_vertex(cu
r_or,v);if(IPV4_ADDR_CMP(&cur_or->u.std.origin->id,&lsa->header.id)<0)cur_or->u.
std.origin=(structlsa_header*)lsa;return;}/*OtherwiseDissmallerthantheroutingtab
lecost.Overwritethecurrentroutingtableentrybysettingtheroutingtableentry'scostto
D,andbysettingtheentry'slistofnexthopstothenewlycalculatedset.Settheroutingtable
entry'sLinkStateOrigintoV'srouter-LSA.Thengoontoexaminethenextstubnetworklink.*/
if(cost<cur_or->cost){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():n
ewrouteisbetter,setit");cur_or->cost=cost;list_delete_all_node(cur_or->paths);os
pf_route_copy_nexthops_from_vertex(cur_or,v);cur_or->u.std.origin=(structlsa_hea
der*)lsa;return;}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():insta
llingnewroute");or=ospf_route_new();or->id=v->id;or->u.std.area_id=area->area_id
;or->u.std.external_routing=area->external_routing;or->path_type=OSPF_PATH_INTRA
_AREA;or->cost=cost;or->type=OSPF_DESTINATION_NETWORK;or->u.std.origin=(structls
a_header*)lsa;/*Nexthopisdependonconnectiontype.*/if(v!=area->spf){if(IS_DEBUG_O
SPF_EVENT)zlog_debug("ospf_intra_add_stub():thisnetworkisonremoterouter");ospf_r
oute_copy_nexthops_from_vertex(or,v);}else{if(IS_DEBUG_OSPF_EVENT)zlog_debug("os
pf_intra_add_stub():thisnetworkisonthisrouter");if((oi=ospf_if_lookup_by_lsa_pos
(area,lsa_pos))){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_intra_add_stub():theint
erfaceis%s",IF_NAME(oi));path=ospf_path_new();path->nexthop.s_addr=0;path->ifind
ex=oi->ifp->ifindex;if(CHECK_FLAG(oi->connected->flags,ZEBRA_IFA_UNNUMBERED))pat
h->unnumbered=1;listnode_add(or->paths,path);}else{if(IS_DEBUG_OSPF_EVENT)zlog_d
ebug("ospf_intra_add_stub():where'stheinterface?");}}rn->info=or;if(IS_DEBUG_OSP
F_EVENT)zlog_debug("ospf_intra_add_stub():Stop");}constchar*ospf_path_type_str[]
={"unknown-type","intra-area","inter-area","type1-external","type2-external"};vo
idospf_route_table_dump(structroute_table*rt){structroute_node*rn;structospf_rou
te*or;charbuf1[BUFSIZ];charbuf2[BUFSIZ];structlistnode*pnode;structospf_path*pat
h;#if0zlog_debug("TypeDestAreaPathTypeCostNextAdv.");zlog_debug("Hop(s)Router(s)
");#endif/*0*/zlog_debug("==========OSPFroutingtable==========");for(rn=route_to
p(rt);rn;rn=route_next(rn))if((or=rn->info)!=NULL){if(or->type==OSPF_DESTINATION
_NETWORK){zlog_debug("N%s/%d\t%s\t%s\t%d",inet_ntop(AF_INET,&rn->p.u.prefix4,buf
1,BUFSIZ),rn->p.prefixlen,inet_ntop(AF_INET,&or->u.std.area_id,buf2,BUFSIZ),ospf
_path_type_str[or->path_type],or->cost);for(ALL_LIST_ELEMENTS_RO(or->paths,pnode
,path))zlog_debug("->%s",inet_ntoa(path->nexthop));}elsezlog_debug("R%s\t%s\t%s\
t%d",inet_ntop(AF_INET,&rn->p.u.prefix4,buf1,BUFSIZ),inet_ntop(AF_INET,&or->u.st
d.area_id,buf2,BUFSIZ),ospf_path_type_str[or->path_type],or->cost);}zlog_debug("
========================================");}/*Thisis16.4.1implementation.oIntra-
areapathsusingnon-backboneareasarealwaysthemostpreferred.oTheotherpaths,intra-ar
eabackbonepathsandinter-areapaths,areofequalpreference.*/staticintospf_asbr_rout
e_cmp(structospf*ospf,structospf_route*r1,structospf_route*r2){uint8_tr1_type,r2
_type;r1_type=r1->path_type;r2_type=r2->path_type;/*r1/r2itselfisbackbone,andit'
sInter-areapath.*/if(OSPF_IS_AREA_ID_BACKBONE(r1->u.std.area_id))r1_type=OSPF_PA
TH_INTER_AREA;if(OSPF_IS_AREA_ID_BACKBONE(r2->u.std.area_id))r2_type=OSPF_PATH_I
NTER_AREA;return(r1_type-r2_type);}/*Comparetworoutes.ret<0--r1isbetter.ret==0--
r1andr2arethesame.ret>0--r2isbetter.*/intospf_route_cmp(structospf*ospf,structos
pf_route*r1,structospf_route*r2){intret=0;/*Pathtypesofr1andr2arenotthesame.*/if
((ret=(r1->path_type-r2->path_type)))returnret;if(IS_DEBUG_OSPF_EVENT)zlog_debug
("Route[Compare]:Pathtypesarethesame.");/*Pathtypesarethesame,compareanycost.*/s
witch(r1->path_type){caseOSPF_PATH_INTRA_AREA:caseOSPF_PATH_INTER_AREA:break;cas
eOSPF_PATH_TYPE1_EXTERNAL:if(!CHECK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE)){
ret=ospf_asbr_route_cmp(ospf,r1->u.ext.asbr,r2->u.ext.asbr);if(ret!=0)returnret;
}break;caseOSPF_PATH_TYPE2_EXTERNAL:if((ret=(r1->u.ext.type2_cost-r2->u.ext.type
2_cost)))returnret;if(!CHECK_FLAG(ospf->config,OSPF_RFC1583_COMPATIBLE)){ret=osp
f_asbr_route_cmp(ospf,r1->u.ext.asbr,r2->u.ext.asbr);if(ret!=0)returnret;}break;
}/*Anyway,comparethecosts.*/return(r1->cost-r2->cost);}staticintospf_path_exist(
structlist*plist,structin_addrnexthop,structospf_interface*oi){structlistnode*no
de,*nnode;structospf_path*path;for(ALL_LIST_ELEMENTS(plist,node,nnode,path))if(I
PV4_ADDR_SAME(&path->nexthop,&nexthop)&&path->ifindex==oi->ifp->ifindex)return1;
return0;}voidospf_route_copy_nexthops_from_vertex(structospf_route*to,structvert
ex*v){structlistnode*node;structospf_path*path;structvertex_nexthop*nexthop;stru
ctvertex_parent*vp;assert(to->paths);for(ALL_LIST_ELEMENTS_RO(v->parents,node,vp
)){nexthop=vp->nexthop;if(nexthop->oi!=NULL){if(!ospf_path_exist(to->paths,nexth
op->router,nexthop->oi)){path=ospf_path_new();path->nexthop=nexthop->router;path
->ifindex=nexthop->oi->ifp->ifindex;if(CHECK_FLAG(nexthop->oi->connected->flags,
ZEBRA_IFA_UNNUMBERED))path->unnumbered=1;listnode_add(to->paths,path);}}}}struct
ospf_path*ospf_path_lookup(structlist*plist,structospf_path*path){structlistnode
*node;structospf_path*op;for(ALL_LIST_ELEMENTS_RO(plist,node,op)){if(!IPV4_ADDR_
SAME(&op->nexthop,&path->nexthop))continue;if(!IPV4_ADDR_SAME(&op->adv_router,&p
ath->adv_router))continue;if(op->ifindex!=path->ifindex)continue;returnop;}retur
nNULL;}voidospf_route_copy_nexthops(structospf_route*to,structlist*from){structl
istnode*node,*nnode;structospf_path*path;assert(to->paths);for(ALL_LIST_ELEMENTS
(from,node,nnode,path))/*Thesameroutesarejustdiscarded.*/if(!ospf_path_lookup(to
->paths,path))listnode_add(to->paths,ospf_path_dup(path));}voidospf_route_subst_
nexthops(structospf_route*to,structlist*from){list_delete_all_node(to->paths);os
pf_route_copy_nexthops(to,from);}voidospf_route_subst(structroute_node*rn,struct
ospf_route*new_or,structospf_route*over){route_lock_node(rn);ospf_route_free(rn-
>info);ospf_route_copy_nexthops(new_or,over->paths);rn->info=new_or;route_unlock
_node(rn);}voidospf_route_add(structroute_table*rt,structprefix_ipv4*p,structosp
f_route*new_or,structospf_route*over){structroute_node*rn;rn=route_node_get(rt,(
structprefix*)p);ospf_route_copy_nexthops(new_or,over->paths);if(rn->info){if(IS
_DEBUG_OSPF_EVENT)zlog_debug("ospf_route_add():something'swrong!");route_unlock_
node(rn);return;}rn->info=new_or;}voidospf_prune_unreachable_networks(structrout
e_table*rt){structroute_node*rn,*next;structospf_route*or;if(IS_DEBUG_OSPF_EVENT
)zlog_debug("Pruningunreachablenetworks");for(rn=route_top(rt);rn;rn=next){next=
route_next(rn);if(rn->info!=NULL){or=rn->info;if(listcount(or->paths)==0){if(IS_
DEBUG_OSPF_EVENT)zlog_debug("Pruningrouteto%s/%d",inet_ntoa(rn->p.u.prefix4),rn-
>p.prefixlen);ospf_route_free(or);rn->info=NULL;route_unlock_node(rn);}}}}voidos
pf_prune_unreachable_routers(structroute_table*rtrs){structroute_node*rn,*next;s
tructospf_route*or;structlistnode*node,*nnode;structlist*paths;if(IS_DEBUG_OSPF_
EVENT)zlog_debug("Pruningunreachablerouters");for(rn=route_top(rtrs);rn;rn=next)
{next=route_next(rn);if((paths=rn->info)==NULL)continue;for(ALL_LIST_ELEMENTS(pa
ths,node,nnode,or)){if(listcount(or->paths)==0){if(IS_DEBUG_OSPF_EVENT){zlog_deb
ug("Pruningroutetortr%s",inet_ntoa(rn->p.u.prefix4));zlog_debug("viaarea%s",inet
_ntoa(or->u.std.area_id));}listnode_delete(paths,or);ospf_route_free(or);}}if(li
stcount(paths)==0){if(IS_DEBUG_OSPF_EVENT)zlog_debug("Pruningrouternode%s",inet_
ntoa(rn->p.u.prefix4));list_delete_and_null(&paths);rn->info=NULL;route_unlock_n
ode(rn);}}}intospf_add_discard_route(structospf*ospf,structroute_table*rt,struct
ospf_area*area,structprefix_ipv4*p){structroute_node*rn;structospf_route*or,*new
_or;rn=route_node_get(rt,(structprefix*)p);if(rn==NULL){if(IS_DEBUG_OSPF_EVENT)z
log_debug("ospf_add_discard_route():routerinstallationerror");return0;}if(rn->in
fo)/*Iftheroutetothesamedestinationisfound*/{route_unlock_node(rn);or=rn->info;i
f(or->path_type==OSPF_PATH_INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_a
dd_discard_route():""anintra-arearouteexists");return0;}if(or->type==OSPF_DESTIN
ATION_DISCARD){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_add_discard_route():""dis
cardentryalreadyinstalled");return0;}ospf_route_free(rn->info);}if(IS_DEBUG_OSPF
_EVENT)zlog_debug("ospf_add_discard_route():""adding%s/%d",inet_ntoa(p->prefix),
p->prefixlen);new_or=ospf_route_new();new_or->type=OSPF_DESTINATION_DISCARD;new_
or->id.s_addr=0;new_or->cost=0;new_or->u.std.area_id=area->area_id;new_or->u.std
.external_routing=area->external_routing;new_or->path_type=OSPF_PATH_INTER_AREA;
rn->info=new_or;ospf_zebra_add_discard(ospf,p);return1;}voidospf_delete_discard_
route(structospf*ospf,structroute_table*rt,structprefix_ipv4*p){structroute_node
*rn;structospf_route*or;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_delete_discard_r
oute():""deleting%s/%d",inet_ntoa(p->prefix),p->prefixlen);rn=route_node_lookup(
rt,(structprefix*)p);if(rn==NULL){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_delete
_discard_route():noroutefound");return;}or=rn->info;if(or->path_type==OSPF_PATH_
INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_delete_discard_route():""ani
ntra-arearouteexists");return;}if(or->type!=OSPF_DESTINATION_DISCARD){if(IS_DEBU
G_OSPF_EVENT)zlog_debug("ospf_delete_discard_route():""notadiscardentry");return
;}/*freetherouteentryandtheroutenode*/ospf_route_free(rn->info);rn->info=NULL;ro
ute_unlock_node(rn);route_unlock_node(rn);/*removethediscardentryfromtherib*/osp
f_zebra_delete_discard(ospf,p);return;}