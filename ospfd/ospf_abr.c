/**OSPFABRfunctions.*Copyright(C)1999,2000AlexZinin,ToshiakiTakada**Thisfileispa
rtofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underth
etermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;either
version2,or(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatit
willbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABIL
ITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.*
*YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;see
thefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFl
oor,Boston,MA02110-1301USA*/#include<zebra.h>#include"thread.h"#include"memory.h
"#include"linklist.h"#include"prefix.h"#include"if.h"#include"table.h"#include"v
ty.h"#include"filter.h"#include"plist.h"#include"log.h"#include"ospfd/ospfd.h"#i
nclude"ospfd/ospf_interface.h"#include"ospfd/ospf_ism.h"#include"ospfd/ospf_asbr
.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neig
hbor.h"#include"ospfd/ospf_nsm.h"#include"ospfd/ospf_spf.h"#include"ospfd/ospf_r
oute.h"#include"ospfd/ospf_ia.h"#include"ospfd/ospf_flood.h"#include"ospfd/ospf_
abr.h"#include"ospfd/ospf_ase.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_
dump.h"staticstructospf_area_range*ospf_area_range_new(structprefix_ipv4*p){stru
ctospf_area_range*range;range=XCALLOC(MTYPE_OSPF_AREA_RANGE,sizeof(structospf_ar
ea_range));range->addr=p->prefix;range->masklen=p->prefixlen;range->cost_config=
OSPF_AREA_RANGE_COST_UNSPEC;returnrange;}staticvoidospf_area_range_free(structos
pf_area_range*range){XFREE(MTYPE_OSPF_AREA_RANGE,range);}staticvoidospf_area_ran
ge_add(structospf_area*area,structospf_area_range*range){structroute_node*rn;str
uctprefix_ipv4p;p.family=AF_INET;p.prefixlen=range->masklen;p.prefix=range->addr
;apply_mask_ipv4(&p);rn=route_node_get(area->ranges,(structprefix*)&p);if(rn->in
fo)route_unlock_node(rn);elsern->info=range;}staticvoidospf_area_range_delete(st
ructospf_area*area,structroute_node*rn){structospf_area_range*range=rn->info;if(
range->specifics!=0)ospf_delete_discard_route(area->ospf,area->ospf->new_table,(
structprefix_ipv4*)&rn->p);ospf_area_range_free(range);rn->info=NULL;route_unloc
k_node(rn);route_unlock_node(rn);}structospf_area_range*ospf_area_range_lookup(s
tructospf_area*area,structprefix_ipv4*p){structroute_node*rn;rn=route_node_looku
p(area->ranges,(structprefix*)p);if(rn){route_unlock_node(rn);returnrn->info;}re
turnNULL;}structospf_area_range*ospf_area_range_lookup_next(structospf_area*area
,structin_addr*range_net,intfirst){structroute_node*rn;structprefix_ipv4p;struct
ospf_area_range*find;p.family=AF_INET;p.prefixlen=IPV4_MAX_BITLEN;p.prefix=*rang
e_net;apply_mask_ipv4(&p);if(first)rn=route_top(area->ranges);else{rn=route_node
_get(area->ranges,(structprefix*)&p);rn=route_next(rn);}for(;rn;rn=route_next(rn
))if(rn->info)break;if(rn&&rn->info){find=rn->info;*range_net=rn->p.u.prefix4;ro
ute_unlock_node(rn);returnfind;}returnNULL;}staticstructospf_area_range*ospf_are
a_range_match(structospf_area*area,structprefix_ipv4*p){structroute_node*node;no
de=route_node_match(area->ranges,(structprefix*)p);if(node){route_unlock_node(no
de);returnnode->info;}returnNULL;}structospf_area_range*ospf_area_range_match_an
y(structospf*ospf,structprefix_ipv4*p){structospf_area_range*range;structospf_ar
ea*area;structlistnode*node;for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area))if((
range=ospf_area_range_match(area,p)))returnrange;returnNULL;}intospf_area_range_
active(structospf_area_range*range){returnrange->specifics;}staticintospf_area_a
ctively_attached(structospf_area*area){returnarea->act_ints;}intospf_area_range_
set(structospf*ospf,structin_addrarea_id,structprefix_ipv4*p,intadvertise){struc
tospf_area*area;structospf_area_range*range;area=ospf_area_get(ospf,area_id);if(
area==NULL)return0;range=ospf_area_range_lookup(area,p);if(range!=NULL){if((CHEC
K_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTISE)&&!CHECK_FLAG(advertise,OSPF_AREA_
RANGE_ADVERTISE))||(!CHECK_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTISE)&&CHECK_F
LAG(advertise,OSPF_AREA_RANGE_ADVERTISE)))ospf_schedule_abr_task(ospf);}else{ran
ge=ospf_area_range_new(p);ospf_area_range_add(area,range);ospf_schedule_abr_task
(ospf);}if(CHECK_FLAG(advertise,OSPF_AREA_RANGE_ADVERTISE))SET_FLAG(range->flags
,OSPF_AREA_RANGE_ADVERTISE);elseUNSET_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTIS
E);return1;}intospf_area_range_cost_set(structospf*ospf,structin_addrarea_id,str
uctprefix_ipv4*p,uint32_tcost){structospf_area*area;structospf_area_range*range;
area=ospf_area_get(ospf,area_id);if(area==NULL)return0;range=ospf_area_range_loo
kup(area,p);if(range==NULL)return0;if(range->cost_config!=cost){range->cost_conf
ig=cost;if(ospf_area_range_active(range))ospf_schedule_abr_task(ospf);}return1;}
intospf_area_range_unset(structospf*ospf,structin_addrarea_id,structprefix_ipv4*
p){structospf_area*area;structroute_node*rn;area=ospf_area_lookup_by_area_id(osp
f,area_id);if(area==NULL)return0;rn=route_node_lookup(area->ranges,(structprefix
*)p);if(rn==NULL)return0;if(ospf_area_range_active(rn->info))ospf_schedule_abr_t
ask(ospf);ospf_area_range_delete(area,rn);return1;}intospf_area_range_substitute
_set(structospf*ospf,structin_addrarea_id,structprefix_ipv4*p,structprefix_ipv4*
s){structospf_area*area;structospf_area_range*range;area=ospf_area_get(ospf,area
_id);range=ospf_area_range_lookup(area,p);if(range!=NULL){if(!CHECK_FLAG(range->
flags,OSPF_AREA_RANGE_ADVERTISE)||!CHECK_FLAG(range->flags,OSPF_AREA_RANGE_SUBST
ITUTE))ospf_schedule_abr_task(ospf);}else{range=ospf_area_range_new(p);ospf_area
_range_add(area,range);ospf_schedule_abr_task(ospf);}SET_FLAG(range->flags,OSPF_
AREA_RANGE_ADVERTISE);SET_FLAG(range->flags,OSPF_AREA_RANGE_SUBSTITUTE);range->s
ubst_addr=s->prefix;range->subst_masklen=s->prefixlen;return1;}intospf_area_rang
e_substitute_unset(structospf*ospf,structin_addrarea_id,structprefix_ipv4*p){str
uctospf_area*area;structospf_area_range*range;area=ospf_area_lookup_by_area_id(o
spf,area_id);if(area==NULL)return0;range=ospf_area_range_lookup(area,p);if(range
==NULL)return0;if(CHECK_FLAG(range->flags,OSPF_AREA_RANGE_SUBSTITUTE))if(ospf_ar
ea_range_active(range))ospf_schedule_abr_task(ospf);UNSET_FLAG(range->flags,OSPF
_AREA_RANGE_SUBSTITUTE);range->subst_addr.s_addr=0;range->subst_masklen=0;return
1;}intospf_act_bb_connection(structospf*ospf){if(ospf->backbone==NULL)return0;re
turnospf->backbone->full_nbrs;}/*Determinewhetherthisrouteriselectedtranslatoror
notforarea*/staticintospf_abr_nssa_am_elected(structospf_area*area){structroute_
node*rn;structospf_lsa*lsa;structrouter_lsa*rlsa;structin_addr*best=NULL;LSDB_LO
OP(ROUTER_LSDB(area),rn,lsa){/*sanitychecks*/if(!lsa||(lsa->data->type!=OSPF_ROU
TER_LSA)||IS_LSA_SELF(lsa))continue;rlsa=(structrouter_lsa*)lsa->data;/*ignoreno
n-ABRrouters*/if(!IS_ROUTER_LSA_BORDER(rlsa))continue;/*RouterhasNtflag-alwaystr
anslate*/if(IS_ROUTER_LSA_NT(rlsa)){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_n
ssa_am_elected:""router%sassertsNt",inet_ntoa(lsa->data->id));return0;}if(best==
NULL)best=&lsa->data->id;elseif(IPV4_ADDR_CMP(&best->s_addr,&lsa->data->id.s_add
r)<0)best=&lsa->data->id;}if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_nssa_am_ele
cted:bestelectableABRis:%s",(best)?inet_ntoa(*best):"<none>");if(best==NULL)retu
rn1;if(IPV4_ADDR_CMP(&best->s_addr,&area->ospf->router_id.s_addr)<0)return1;else
return0;}/*CheckNSSAABRstatus*assumestherearenssaareas*/staticvoidospf_abr_nssa_
check_status(structospf*ospf){structospf_area*area;structlistnode*lnode,*nnode;f
or(ALL_LIST_ELEMENTS(ospf->areas,lnode,nnode,area)){uint8_told_state=area->NSSAT
ranslatorState;if(area->external_routing!=OSPF_AREA_NSSA)continue;if(IS_DEBUG_OS
PF(nssa,NSSA))zlog_debug("ospf_abr_nssa_check_status:""checkingarea%s",inet_ntoa
(area->area_id));if(!IS_OSPF_ABR(area->ospf)){if(IS_DEBUG_OSPF(nssa,NSSA))zlog_d
ebug("ospf_abr_nssa_check_status:""notABR");area->NSSATranslatorState=OSPF_NSSA_
TRANSLATE_DISABLED;}else{switch(area->NSSATranslatorRole){caseOSPF_NSSA_ROLE_NEV
ER:/*WeneverTranslateType-7LSA.*//*TODO:checkpreviousstateandflush?*/if(IS_DEBUG
_OSPF(nssa,NSSA))zlog_debug("ospf_abr_nssa_check_status:""nevertranslate");area-
>NSSATranslatorState=OSPF_NSSA_TRANSLATE_DISABLED;break;caseOSPF_NSSA_ROLE_ALWAY
S:/*WealwaystranslateifweareanABR*TODO:originatenewLSAsifstatechange?*orletthens
saabrtasktakecareofit?*/if(IS_DEBUG_OSPF(nssa,NSSA))zlog_debug("ospf_abr_nssa_ch
eck_status:""translatealways");area->NSSATranslatorState=OSPF_NSSA_TRANSLATE_ENA
BLED;break;caseOSPF_NSSA_ROLE_CANDIDATE:/*WeareacandidateforTranslation*/if(ospf
_abr_nssa_am_elected(area)>0){area->NSSATranslatorState=OSPF_NSSA_TRANSLATE_ENAB
LED;if(IS_DEBUG_OSPF(nssa,NSSA))zlog_debug("ospf_abr_nssa_check_status:""elected
translator");}else{area->NSSATranslatorState=OSPF_NSSA_TRANSLATE_DISABLED;if(IS_
DEBUG_OSPF(nssa,NSSA))zlog_debug("ospf_abr_nssa_check_status:""notelected");}bre
ak;}}/*RFC3101,3.1:*AllNSSAborderroutersmustsettheE-bitintheType-1*router-LSAs*o
ftheirdirectlyattachednon-stubareas,evenwhentheyare*not*translating.*/if(old_sta
te!=area->NSSATranslatorState){if(old_state==OSPF_NSSA_TRANSLATE_DISABLED)ospf_a
sbr_status_update(ospf,++ospf->redistribute);elseif(area->NSSATranslatorState==O
SPF_NSSA_TRANSLATE_DISABLED)ospf_asbr_status_update(ospf,--ospf->redistribute);}
}}/*Checkareaborderrouterstatus.*/voidospf_check_abr_status(structospf*ospf){str
uctospf_area*area;structlistnode*node,*nnode;intbb_configured=0;intbb_act_attach
ed=0;intareas_configured=0;intareas_act_attached=0;uint8_tnew_flags=ospf->flags;
if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_check_abr_status():Start");for(ALL_LIST_
ELEMENTS(ospf->areas,node,nnode,area)){if(listcount(area->oiflist)){areas_config
ured++;if(OSPF_IS_AREA_BACKBONE(area))bb_configured=1;}if(ospf_area_actively_att
ached(area)){areas_act_attached++;if(OSPF_IS_AREA_BACKBONE(area))bb_act_attached
=1;}}if(IS_DEBUG_OSPF_EVENT){zlog_debug("ospf_check_abr_status():lookedthroughar
eas");zlog_debug("ospf_check_abr_status():bb_configured:%d",bb_configured);zlog_
debug("ospf_check_abr_status():bb_act_attached:%d",bb_act_attached);zlog_debug("
ospf_check_abr_status():areas_configured:%d",areas_configured);zlog_debug("ospf_
check_abr_status():areas_act_attached:%d",areas_act_attached);}switch(ospf->abr_
type){caseOSPF_ABR_SHORTCUT:caseOSPF_ABR_STAND:if(areas_act_attached>1)SET_FLAG(
new_flags,OSPF_FLAG_ABR);elseUNSET_FLAG(new_flags,OSPF_FLAG_ABR);break;caseOSPF_
ABR_IBM:if((areas_act_attached>1)&&bb_configured)SET_FLAG(new_flags,OSPF_FLAG_AB
R);elseUNSET_FLAG(new_flags,OSPF_FLAG_ABR);break;caseOSPF_ABR_CISCO:if((areas_co
nfigured>1)&&bb_act_attached)SET_FLAG(new_flags,OSPF_FLAG_ABR);elseUNSET_FLAG(ne
w_flags,OSPF_FLAG_ABR);break;default:break;}if(new_flags!=ospf->flags){ospf_spf_
calculate_schedule(ospf,SPF_FLAG_ABR_STATUS_CHANGE);if(IS_DEBUG_OSPF_EVENT)zlog_
debug("ospf_check_abr_status():newrouterflags:%x",new_flags);ospf->flags=new_fla
gs;ospf_router_lsa_update(ospf);}}staticvoidospf_abr_update_aggregate(structospf
_area_range*range,structospf_route*or,structospf_area*area){if(IS_DEBUG_OSPF_EVE
NT)zlog_debug("ospf_abr_update_aggregate():Start");if(CHECK_FLAG(area->stub_rout
er_state,OSPF_AREA_IS_STUB_ROUTED)&&(range->cost!=OSPF_STUB_MAX_METRIC_SUMMARY_C
OST)){range->cost=OSPF_STUB_MAX_METRIC_SUMMARY_COST;if(IS_DEBUG_OSPF_EVENT)zlog_
debug("ospf_abr_update_aggregate():usesummarymax-metric0x%08x",range->cost);}els
eif(range->cost_config!=OSPF_AREA_RANGE_COST_UNSPEC){if(IS_DEBUG_OSPF_EVENT)zlog
_debug("ospf_abr_update_aggregate():useconfiguredcost%d",range->cost_config);ran
ge->cost=range->cost_config;}else{if(range->specifics==0){if(IS_DEBUG_OSPF_EVENT
)zlog_debug("ospf_abr_update_aggregate():useor->cost%d",or->cost);range->cost=or
->cost;/*1sttimeget1stcost*/}if(or->cost>range->cost){if(IS_DEBUG_OSPF_EVENT)zlo
g_debug("ospf_abr_update_aggregate():updateto%d",or->cost);range->cost=or->cost;
}}range->specifics++;}staticvoidset_metric(structospf_lsa*lsa,uint32_tmetric){st
ructsummary_lsa*header;uint8_t*mp;metric=htonl(metric);mp=(uint8_t*)&metric;mp++
;header=(structsummary_lsa*)lsa->data;memcpy(header->metric,mp,3);}/*ospf_abr_tr
anslate_nssa*/staticintospf_abr_translate_nssa(structospf_area*area,structospf_l
sa*lsa){/*IncomingType-7orlateraggregatedType-7**LSAisskippedifP-bitisoff.*LSAis
aggregatedifwithinrange.**TheType-7istranslated,Installed/ApprovedasaType-5into*
globalLSDB,thenFloodedthroughAS**Later,anyUnapprovedTranslatedType-5'sareflushed
/discarded*/structospf_lsa*old=NULL,*new=NULL;structas_external_lsa*ext7;structp
refix_ipv4p;if(!CHECK_FLAG(lsa->data->options,OSPF_OPTION_NP)){if(IS_DEBUG_OSPF_
NSSA)zlog_debug("ospf_abr_translate_nssa():LSAId%s,P-bitoff,NOTranslation",inet_
ntoa(lsa->data->id));return1;}if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_transla
te_nssa():LSAId%s,TRANSLATING7to5",inet_ntoa(lsa->data->id));ext7=(structas_exte
rnal_lsa*)(lsa->data);p.prefix=lsa->data->id;p.prefixlen=ip_masklen(ext7->mask);
if(ext7->e[0].fwd_addr.s_addr==OSPF_DEFAULT_DESTINATION){if(IS_DEBUG_OSPF_NSSA)z
log_debug("ospf_abr_translate_nssa():LSAId%s,""Forwardaddressis0,NOTranslation",
inet_ntoa(lsa->data->id));return1;}/*tryfindexistingAS-ExternalLSAforthisprefix*
/old=ospf_external_info_find_lsa(area->ospf,&p);if(old){if(IS_DEBUG_OSPF_NSSA)zl
og_debug("ospf_abr_translate_nssa():""foundoldtranslatedLSAId%s,refreshing",inet
_ntoa(old->data->id));/*refresh*/new=ospf_translated_nssa_refresh(area->ospf,lsa
,old);if(!new){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_translate_nssa():""cou
ldnotrefreshtranslatedLSAId%s",inet_ntoa(old->data->id));}}else{/*noexistingexte
rnalrouteforthisLSAId*originatetranslatedLSA*/if((new=ospf_translated_nssa_origi
nate(area->ospf,lsa))==NULL){if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_translat
e_nssa():Couldnottranslate""Type-7for%stoType-5",inet_ntoa(lsa->data->id));retur
n1;}}/*AreawhereAggregatetestingwillbeinserted,justlikesummaryadvertisements*//*
ospf_abr_check_nssa_range(p_arg,lsa->cost,lsa->area);*/return0;}staticvoidospf_a
br_translate_nssa_range(structprefix_ipv4*p,uint32_tcost){/*TheType-7iscreatedfr
omtheaggregatedprefixandforwardedforlsainstallationandflooding...tobeadded...*/}
voidospf_abr_announce_network_to_area(structprefix_ipv4*p,uint32_tcost,structosp
f_area*area){structospf_lsa*lsa,*old=NULL;structsummary_lsa*sl=NULL;uint32_tfull
_cost;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network_to_area():Sta
rt");if(CHECK_FLAG(area->stub_router_state,OSPF_AREA_IS_STUB_ROUTED))full_cost=O
SPF_STUB_MAX_METRIC_SUMMARY_COST;elsefull_cost=cost;old=ospf_lsa_lookup_by_prefi
x(area->lsdb,OSPF_SUMMARY_LSA,(structprefix_ipv4*)p,area->ospf->router_id);if(ol
d){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network_to_area():oldsum
maryfound");sl=(structsummary_lsa*)old->data;if(IS_DEBUG_OSPF_EVENT)zlog_debug("
ospf_abr_announce_network_to_area():""oldmetric:%d,newmetric:%d",GET_METRIC(sl->
metric),cost);if((GET_METRIC(sl->metric)==full_cost)&&((old->flags&OSPF_LSA_IN_M
AXAGE)==0)){/*unchanged.simplyreapproveit*/if(IS_DEBUG_OSPF_EVENT)zlog_debug("os
pf_abr_announce_network_to_area():""oldsummaryapproved");SET_FLAG(old->flags,OSP
F_LSA_APPROVED);}else{/*LSAischanged,refreshit*/if(IS_DEBUG_OSPF_EVENT)zlog_debu
g("ospf_abr_announce_network_to_area():""refreshingsummary");set_metric(old,full
_cost);lsa=ospf_lsa_refresh(area->ospf,old);if(!lsa){charbuf[PREFIX2STR_BUFFER];
prefix2str((structprefix*)p,buf,sizeof(buf));zlog_warn("%s:Couldnotrefresh%sto%s
",__func__,buf,inet_ntoa(area->area_id));return;}SET_FLAG(lsa->flags,OSPF_LSA_AP
PROVED);/*Thiswillfloodthrougharea.*/}}else{if(IS_DEBUG_OSPF_EVENT)zlog_debug("o
spf_abr_announce_network_to_area():""creatingnewsummary");lsa=ospf_summary_lsa_o
riginate((structprefix_ipv4*)p,full_cost,area);/*Thiswillfloodthrougharea.*/if(!
lsa){charbuf[PREFIX2STR_BUFFER];prefix2str((structprefix*)p,buf,sizeof(buf));zlo
g_warn("%s:Couldnotoriginate%sto%s",__func__,buf,inet_ntoa(area->area_id));retur
n;}SET_FLAG(lsa->flags,OSPF_LSA_APPROVED);if(IS_DEBUG_OSPF_EVENT)zlog_debug("osp
f_abr_announce_network_to_area():""floodingnewversionofsummary");}if(IS_DEBUG_OS
PF_EVENT)zlog_debug("ospf_abr_announce_network_to_area():Stop");}staticintospf_a
br_nexthops_belong_to_area(structospf_route*or,structospf_area*area){structlistn
ode*node,*nnode;structospf_path*path;structospf_interface*oi;for(ALL_LIST_ELEMEN
TS_RO(or->paths,node,path))for(ALL_LIST_ELEMENTS_RO(area->oiflist,nnode,oi))if(o
i->ifp&&oi->ifp->ifindex==path->ifindex)return1;return0;}staticintospf_abr_shoul
d_accept(structprefix_ipv4*p,structospf_area*area){if(IMPORT_NAME(area)){if(IMPO
RT_LIST(area)==NULL)IMPORT_LIST(area)=access_list_lookup(AFI_IP,IMPORT_NAME(area
));if(IMPORT_LIST(area))if(access_list_apply(IMPORT_LIST(area),p)==FILTER_DENY)r
eturn0;}return1;}staticintospf_abr_plist_in_check(structospf_area*area,structosp
f_route*or,structprefix_ipv4*p){if(PREFIX_NAME_IN(area)){if(PREFIX_LIST_IN(area)
==NULL)PREFIX_LIST_IN(area)=prefix_list_lookup(AFI_IP,PREFIX_NAME_IN(area));if(P
REFIX_LIST_IN(area))if(prefix_list_apply(PREFIX_LIST_IN(area),p)!=PREFIX_PERMIT)
return0;}return1;}staticintospf_abr_plist_out_check(structospf_area*area,structo
spf_route*or,structprefix_ipv4*p){if(PREFIX_NAME_OUT(area)){if(PREFIX_LIST_OUT(a
rea)==NULL)PREFIX_LIST_OUT(area)=prefix_list_lookup(AFI_IP,PREFIX_NAME_OUT(area)
);if(PREFIX_LIST_OUT(area))if(prefix_list_apply(PREFIX_LIST_OUT(area),p)!=PREFIX
_PERMIT)return0;}return1;}staticvoidospf_abr_announce_network(structospf*ospf,st
ructprefix_ipv4*p,structospf_route*or){structospf_area_range*range;structospf_ar
ea*area,*or_area;structlistnode*node;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr
_announce_network():Start");or_area=ospf_area_lookup_by_area_id(ospf,or->u.std.a
rea_id);assert(or_area);for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){if(IS_D
EBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network():lookingatarea%s",inet_nt
oa(area->area_id));if(IPV4_ADDR_SAME(&or->u.std.area_id,&area->area_id))continue
;if(ospf_abr_nexthops_belong_to_area(or,area))continue;if(!ospf_abr_should_accep
t(p,area)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network():""pref
ix%s/%dwasdeniedbyimport-list",inet_ntoa(p->prefix),p->prefixlen);continue;}if(!
ospf_abr_plist_in_check(area,or,p)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_
announce_network():""prefix%s/%dwasdeniedbyprefix-list",inet_ntoa(p->prefix),p->
prefixlen);continue;}if(area->external_routing!=OSPF_AREA_DEFAULT&&area->no_summ
ary){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network():""area%sisst
ubandno_summary",inet_ntoa(area->area_id));continue;}if(or->path_type==OSPF_PATH
_INTER_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_network():this
is""inter-arearouteto%s/%d",inet_ntoa(p->prefix),p->prefixlen);if(!OSPF_IS_AREA_
BACKBONE(area))ospf_abr_announce_network_to_area(p,or->cost,area);}if(or->path_t
ype==OSPF_PATH_INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_
network():""thisisintra-arearouteto%s/%d",inet_ntoa(p->prefix),p->prefixlen);if(
(range=ospf_area_range_match(or_area,p))&&!ospf_area_is_transit(area))ospf_abr_u
pdate_aggregate(range,or,area);elseospf_abr_announce_network_to_area(p,or->cost,
area);}}}staticintospf_abr_should_announce(structospf*ospf,structprefix_ipv4*p,s
tructospf_route*or){structospf_area*area;area=ospf_area_lookup_by_area_id(ospf,o
r->u.std.area_id);assert(area);if(EXPORT_NAME(area)){if(EXPORT_LIST(area)==NULL)
EXPORT_LIST(area)=access_list_lookup(AFI_IP,EXPORT_NAME(area));if(EXPORT_LIST(ar
ea))if(access_list_apply(EXPORT_LIST(area),p)==FILTER_DENY)return0;}return1;}sta
ticvoidospf_abr_process_nssa_translates(structospf*ospf){/*ScanthroughallNSSA_LS
DBrecordsforallareas;IfP-bitison,translateallType-7'sto5'sandaggregateorfloodins
tallasapprovedinType-5LSDBwithXLATEFlagonlater,dosameforallaggregates...Atend,DI
SCARDallremainingUNAPPROVEDType-5's(Aggregateisforfuture)*/structlistnode*node;s
tructospf_area*area;structroute_node*rn;structospf_lsa*lsa;if(IS_DEBUG_OSPF_NSSA
)zlog_debug("ospf_abr_process_nssa_translates():Start");for(ALL_LIST_ELEMENTS_RO
(ospf->areas,node,area)){if(!area->NSSATranslatorState)continue;/*skipifnottrans
lator*/if(area->external_routing!=OSPF_AREA_NSSA)continue;/*skipifnotNssaArea*/i
f(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_process_nssa_translates():""lookingata
rea%s",inet_ntoa(area->area_id));LSDB_LOOP(NSSA_LSDB(area),rn,lsa)ospf_abr_trans
late_nssa(area,lsa);}if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_process_nssa_tra
nslates():Stop");}staticvoidospf_abr_process_network_rt(structospf*ospf,structro
ute_table*rt){structospf_area*area;structospf_route*or;structroute_node*rn;if(IS
_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():Start");for(rn=route
_top(rt);rn;rn=route_next(rn)){if((or=rn->info)==NULL)continue;if(!(area=ospf_ar
ea_lookup_by_area_id(ospf,or->u.std.area_id))){if(IS_DEBUG_OSPF_EVENT)zlog_debug
("ospf_abr_process_network_rt():area%snolongerexists",inet_ntoa(or->u.std.area_i
d));continue;}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():t
hisisarouteto%s/%d",inet_ntoa(rn->p.u.prefix4),rn->p.prefixlen);if(or->path_type
>=OSPF_PATH_TYPE1_EXTERNAL){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_
network_rt():""thisisanExternalrouter,skipping");continue;}if(or->cost>=OSPF_LS_
INFINITY){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():""thi
sroute'scostisinfinity,skipping");continue;}if(or->type==OSPF_DESTINATION_DISCAR
D){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():""thisisadis
cardentry,skipping");continue;}if(or->path_type==OSPF_PATH_INTRA_AREA&&!ospf_abr
_should_announce(ospf,(structprefix_ipv4*)&rn->p,or)){if(IS_DEBUG_OSPF_EVENT)zlo
g_debug("ospf_abr_process_network_rt():deniedbyexport-list");continue;}if(or->pa
th_type==OSPF_PATH_INTRA_AREA&&!ospf_abr_plist_out_check(area,or,(structprefix_i
pv4*)&rn->p)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():d
eniedbyprefix-list");continue;}if((or->path_type==OSPF_PATH_INTER_AREA)&&!OSPF_I
S_AREA_ID_BACKBONE(or->u.std.area_id)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_a
br_process_network_rt():""thisisrouteisnotbackboneone,skipping");continue;}if((o
spf->abr_type==OSPF_ABR_CISCO)||(ospf->abr_type==OSPF_ABR_IBM))if(!ospf_act_bb_c
onnection(ospf)&&or->path_type!=OSPF_PATH_INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlo
g_debug("ospf_abr_process_network_rt():ALTABR:""NoBBconnection,skipnotintra-area
routes");continue;}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_r
t():announcing");ospf_abr_announce_network(ospf,(structprefix_ipv4*)&rn->p,or);}
if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_network_rt():Stop");}staticv
oidospf_abr_announce_rtr_to_area(structprefix_ipv4*p,uint32_tcost,structospf_are
a*area){structospf_lsa*lsa,*old=NULL;structsummary_lsa*slsa=NULL;if(IS_DEBUG_OSP
F_EVENT)zlog_debug("ospf_abr_announce_rtr_to_area():Start");old=ospf_lsa_lookup_
by_prefix(area->lsdb,OSPF_ASBR_SUMMARY_LSA,p,area->ospf->router_id);if(old){if(I
S_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_rtr_to_area():oldsummaryfound")
;slsa=(structsummary_lsa*)old->data;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_
announce_network_to_area():""oldmetric:%d,newmetric:%d",GET_METRIC(slsa->metric)
,cost);}if(old&&(GET_METRIC(slsa->metric)==cost)&&((old->flags&OSPF_LSA_IN_MAXAG
E)==0)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_rtr_to_area():oldsu
mmaryapproved");SET_FLAG(old->flags,OSPF_LSA_APPROVED);}else{if(IS_DEBUG_OSPF_EV
ENT)zlog_debug("ospf_abr_announce_rtr_to_area():2.2");if(old){set_metric(old,cos
t);lsa=ospf_lsa_refresh(area->ospf,old);}elselsa=ospf_summary_asbr_lsa_originate
(p,cost,area);if(!lsa){charbuf[PREFIX2STR_BUFFER];prefix2str((structprefix*)p,bu
f,sizeof(buf));zlog_warn("%s:Couldnotrefresh/originate%sto%s",__func__,buf,inet_
ntoa(area->area_id));return;}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announc
e_rtr_to_area():""floodingnewversionofsummary");/*zlog_info("ospf_abr_announce_r
tr_to_area():creatingnewsummary");lsa=ospf_summary_asbr_lsa(p,cost,area,old);*/S
ET_FLAG(lsa->flags,OSPF_LSA_APPROVED);/*ospf_flood_through_area(area,NULL,lsa);*
/}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_rtr_to_area():Stop");}sta
ticvoidospf_abr_announce_rtr(structospf*ospf,structprefix_ipv4*p,structospf_rout
e*or){structlistnode*node;structospf_area*area;if(IS_DEBUG_OSPF_EVENT)zlog_debug
("ospf_abr_announce_rtr():Start");for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area
)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_rtr():lookingatarea%s",i
net_ntoa(area->area_id));if(IPV4_ADDR_SAME(&or->u.std.area_id,&area->area_id))co
ntinue;if(ospf_abr_nexthops_belong_to_area(or,area))continue;if(area->external_r
outing!=OSPF_AREA_DEFAULT){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_
rtr():""area%sdoesn'tsupportexternalrouting",inet_ntoa(area->area_id));continue;
}if(or->path_type==OSPF_PATH_INTER_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf
_abr_announce_rtr():""thisisinter-arearouteto%s",inet_ntoa(p->prefix));if(!OSPF_
IS_AREA_BACKBONE(area))ospf_abr_announce_rtr_to_area(p,or->cost,area);}if(or->pa
th_type==OSPF_PATH_INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_annou
nce_rtr():""thisisintra-arearouteto%s",inet_ntoa(p->prefix));ospf_abr_announce_r
tr_to_area(p,or->cost,area);}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announ
ce_rtr():Stop");}staticvoidospf_abr_process_router_rt(structospf*ospf,structrout
e_table*rt){structospf_route*or;structroute_node*rn;structlist*l;if(IS_DEBUG_OSP
F_EVENT)zlog_debug("ospf_abr_process_router_rt():Start");for(rn=route_top(rt);rn
;rn=route_next(rn)){structlistnode*node,*nnode;charflag=0;structospf_route*best=
NULL;if(rn->info==NULL)continue;l=rn->info;if(IS_DEBUG_OSPF_EVENT)zlog_debug("os
pf_abr_process_router_rt():thisisarouteto%s",inet_ntoa(rn->p.u.prefix4));for(ALL
_LIST_ELEMENTS(l,node,nnode,or)){if(!ospf_area_lookup_by_area_id(ospf,or->u.std.
area_id)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_router_rt():area%s
nolongerexists",inet_ntoa(or->u.std.area_id));continue;}if(!CHECK_FLAG(or->u.std
.flags,ROUTER_LSA_EXTERNAL)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process
_router_rt():""ThisisnotanASBR,skipping");continue;}if(!flag){best=ospf_find_asb
r_route(ospf,rt,(structprefix_ipv4*)&rn->p);flag=1;}if(best==NULL)continue;if(or
!=best){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_router_rt():""Thisro
uteisnotthebestamongpossible,skipping");continue;}if(or->path_type==OSPF_PATH_IN
TER_AREA&&!OSPF_IS_AREA_ID_BACKBONE(or->u.std.area_id)){if(IS_DEBUG_OSPF_EVENT)z
log_debug("ospf_abr_process_router_rt():""Thisrouteisnotabackboneone,skipping");
continue;}if(or->cost>=OSPF_LS_INFINITY){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf
_abr_process_router_rt():""ThisroutehasLS_INFINITYmetric,skipping");continue;}if
(ospf->abr_type==OSPF_ABR_CISCO||ospf->abr_type==OSPF_ABR_IBM)if(!ospf_act_bb_co
nnection(ospf)&&or->path_type!=OSPF_PATH_INTRA_AREA){if(IS_DEBUG_OSPF_EVENT)zlog
_debug("ospf_abr_process_network_rt():ALTABR:""NoBBconnection,skipnotintra-arear
outes");continue;}ospf_abr_announce_rtr(ospf,(structprefix_ipv4*)&rn->p,or);}}if
(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_process_router_rt():Stop");}staticvoid
ospf_abr_unapprove_translates(structospf*ospf)/*ForNSSATranslations*/{structospf
_lsa*lsa;structroute_node*rn;if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_unapprov
e_translates():Start");/*NSSATranslatorisnotchecked,becauseitmayhavegoneaway,and
wewouldwanttoflushanyresidualsanyway*/LSDB_LOOP(EXTERNAL_LSDB(ospf),rn,lsa)if(CH
ECK_FLAG(lsa->flags,OSPF_LSA_LOCAL_XLT)){UNSET_FLAG(lsa->flags,OSPF_LSA_APPROVED
);if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_unapprove_translates():""approvedun
setonlinkid%s",inet_ntoa(lsa->data->id));}if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf
_abr_unapprove_translates():Stop");}staticvoidospf_abr_unapprove_summaries(struc
tospf*ospf){structlistnode*node;structospf_area*area;structroute_node*rn;structo
spf_lsa*lsa;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_unapprove_summaries():St
art");for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){if(IS_DEBUG_OSPF_EVENT)zl
og_debug("ospf_abr_unapprove_summaries():""consideringarea%s",inet_ntoa(area->ar
ea_id));LSDB_LOOP(SUMMARY_LSDB(area),rn,lsa)if(ospf_lsa_is_self_originated(ospf,
lsa)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_unapprove_summaries():""approv
edunsetonsummarylinkid%s",inet_ntoa(lsa->data->id));UNSET_FLAG(lsa->flags,OSPF_L
SA_APPROVED);}LSDB_LOOP(ASBR_SUMMARY_LSDB(area),rn,lsa)if(ospf_lsa_is_self_origi
nated(ospf,lsa)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_unapprove_summaries
():""approvedunsetonasbr-summarylinkid%s",inet_ntoa(lsa->data->id));UNSET_FLAG(l
sa->flags,OSPF_LSA_APPROVED);}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_unapp
rove_summaries():Stop");}staticvoidospf_abr_prepare_aggregates(structospf*ospf){
structlistnode*node;structroute_node*rn;structospf_area_range*range;structospf_a
rea*area;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_prepare_aggregates():Start"
);for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){for(rn=route_top(area->ranges
);rn;rn=route_next(rn))if((range=rn->info)!=NULL){range->cost=0;range->specifics
=0;}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_prepare_aggregates():Stop");}st
aticvoidospf_abr_announce_aggregates(structospf*ospf){structospf_area*area,*ar;s
tructospf_area_range*range;structroute_node*rn;structprefixp;structlistnode*node
,*n;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_aggregates():Start");fo
r(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){if(IS_DEBUG_OSPF_EVENT)zlog_debug
("ospf_abr_announce_aggregates():lookingatarea%s",inet_ntoa(area->area_id));for(
rn=route_top(area->ranges);rn;rn=route_next(rn))if((range=rn->info)){if(!CHECK_F
LAG(range->flags,OSPF_AREA_RANGE_ADVERTISE)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("
ospf_abr_announce_aggregates():""discardingsuppress-ranges");continue;}p.family=
AF_INET;p.u.prefix4=range->addr;p.prefixlen=range->masklen;if(IS_DEBUG_OSPF_EVEN
T)zlog_debug("ospf_abr_announce_aggregates():""thisisrange:%s/%d",inet_ntoa(p.u.
prefix4),p.prefixlen);if(CHECK_FLAG(range->flags,OSPF_AREA_RANGE_SUBSTITUTE)){p.
family=AF_INET;p.u.prefix4=range->subst_addr;p.prefixlen=range->subst_masklen;}i
f(range->specifics){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_aggrega
tes():activerange");for(ALL_LIST_ELEMENTS_RO(ospf->areas,n,ar)){if(ar==area)cont
inue;/*Wedonotchecknexthopshere,becauseintra-arearoutescanbeassociatedwithoneare
aonly*//*backboneroutesarenotsummarizedwhenannouncedintotransitareas*/if(ospf_ar
ea_is_transit(ar)&&OSPF_IS_AREA_BACKBONE(area)){if(IS_DEBUG_OSPF_EVENT)zlog_debu
g("ospf_abr_announce_aggregates():Skipping""announcementofBBaggregateinto""atran
sitarea");continue;}ospf_abr_announce_network_to_area((structprefix_ipv4*)&p,ran
ge->cost,ar);}}}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_aggregates
():Stop");}staticvoidospf_abr_send_nssa_aggregates(structospf*ospf)/*temporarily
turnedoff*/{structlistnode*node;/*,n;*/structospf_area*area;/*,*ar;*/structroute
_node*rn;structospf_area_range*range;structprefix_ipv4p;if(IS_DEBUG_OSPF_NSSA)zl
og_debug("ospf_abr_send_nssa_aggregates():Start");for(ALL_LIST_ELEMENTS_RO(ospf-
>areas,node,area)){if(!area->NSSATranslatorState)continue;if(IS_DEBUG_OSPF_NSSA)
zlog_debug("ospf_abr_send_nssa_aggregates():lookingatarea%s",inet_ntoa(area->are
a_id));for(rn=route_top(area->ranges);rn;rn=route_next(rn)){if(rn->info==NULL)co
ntinue;range=rn->info;if(!CHECK_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTISE)){if
(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_send_nssa_aggregates():""discardingsupp
ress-ranges");continue;}p.family=AF_INET;p.prefix=range->addr;p.prefixlen=range-
>masklen;if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_send_nssa_aggregates():""thi
sisrange:%s/%d",inet_ntoa(p.prefix),p.prefixlen);if(CHECK_FLAG(range->flags,OSPF
_AREA_RANGE_SUBSTITUTE)){p.family=AF_INET;p.prefix=range->subst_addr;p.prefixlen
=range->subst_masklen;}if(range->specifics){if(IS_DEBUG_OSPF_NSSA)zlog_debug("os
pf_abr_send_nssa_aggregates():activerange");/*FetchLSA-Type-7fromaggregateprefix
,and*then*translate,Install(asType-5),Approve,and*Flood*/ospf_abr_translate_nssa
_range(&p,range->cost);}}/*allarearanges*/}/*allareas*/if(IS_DEBUG_OSPF_NSSA)zlo
g_debug("ospf_abr_send_nssa_aggregates():Stop");}staticvoidospf_abr_announce_stu
b_defaults(structospf*ospf){structlistnode*node;structospf_area*area;structprefi
x_ipv4p;if(!IS_OSPF_ABR(ospf))return;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr
_announce_stub_defaults():Start");p.family=AF_INET;p.prefix.s_addr=OSPF_DEFAULT_
DESTINATION;p.prefixlen=0;for(ALL_LIST_ELEMENTS_RO(ospf->areas,node,area)){if(IS
_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_stub_defaults():lookingatarea%s"
,inet_ntoa(area->area_id));if((area->external_routing!=OSPF_AREA_STUB)&&(area->e
xternal_routing!=OSPF_AREA_NSSA))continue;if(OSPF_IS_AREA_BACKBONE(area))continu
e;/*SanityCheck*/if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_announce_stub_defau
lts():""announcing0.0.0.0/0toarea%s",inet_ntoa(area->area_id));ospf_abr_announce
_network_to_area(&p,area->default_cost,area);}if(IS_DEBUG_OSPF_EVENT)zlog_debug(
"ospf_abr_announce_stub_defaults():Stop");}staticintospf_abr_remove_unapproved_t
ranslates_apply(structospf*ospf,structospf_lsa*lsa){if(CHECK_FLAG(lsa->flags,OSP
F_LSA_LOCAL_XLT)&&!CHECK_FLAG(lsa->flags,OSPF_LSA_APPROVED)){zlog_info("ospf_abr
_remove_unapproved_translates():""removingunapprovedtranslates,ID:%s",inet_ntoa(
lsa->data->id));/*FLUSHTHROUGHOUTAS*/ospf_lsa_flush_as(ospf,lsa);/*DISCARDfromLS
DB*/}return0;}staticvoidospf_abr_remove_unapproved_translates(structospf*ospf){s
tructroute_node*rn;structospf_lsa*lsa;/*AllAREAPROCESSshouldhaveAPPROVEDnecessar
yLSAs*//*RemoveanyleftoverandnotAPPROVED*/if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf
_abr_remove_unapproved_translates():Start");LSDB_LOOP(EXTERNAL_LSDB(ospf),rn,lsa
)ospf_abr_remove_unapproved_translates_apply(ospf,lsa);if(IS_DEBUG_OSPF_NSSA)zlo
g_debug("ospf_abr_remove_unapproved_translates():Stop");}staticvoidospf_abr_remo
ve_unapproved_summaries(structospf*ospf){structlistnode*node;structospf_area*are
a;structroute_node*rn;structospf_lsa*lsa;if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf
_abr_remove_unapproved_summaries():Start");for(ALL_LIST_ELEMENTS_RO(ospf->areas,
node,area)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_remove_unapproved_summar
ies():""lookingatarea%s",inet_ntoa(area->area_id));LSDB_LOOP(SUMMARY_LSDB(area),
rn,lsa)if(ospf_lsa_is_self_originated(ospf,lsa))if(!CHECK_FLAG(lsa->flags,OSPF_L
SA_APPROVED))ospf_lsa_flush_area(lsa,area);LSDB_LOOP(ASBR_SUMMARY_LSDB(area),rn,
lsa)if(ospf_lsa_is_self_originated(ospf,lsa))if(!CHECK_FLAG(lsa->flags,OSPF_LSA_
APPROVED))ospf_lsa_flush_area(lsa,area);}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf
_abr_remove_unapproved_summaries():Stop");}staticvoidospf_abr_manage_discard_rou
tes(structospf*ospf){structlistnode*node,*nnode;structroute_node*rn;structospf_a
rea*area;structospf_area_range*range;for(ALL_LIST_ELEMENTS(ospf->areas,node,nnod
e,area))for(rn=route_top(area->ranges);rn;rn=route_next(rn))if((range=rn->info)!
=NULL)if(CHECK_FLAG(range->flags,OSPF_AREA_RANGE_ADVERTISE)){if(range->specifics
)ospf_add_discard_route(ospf,ospf->new_table,area,(structprefix_ipv4*)&rn->p);el
seospf_delete_discard_route(ospf,ospf->new_table,(structprefix_ipv4*)&rn->p);}}/
*ThisisthefunctiontakingcareaboutABRNSSA,i.e.NSSATranslator,-LSAaggregationandfl
ooding.ForallNSSAsAnySELF-AS-LSAisintheType-5LSDBandType-7LSDB.TheseLSA'sarerefr
eshedfromtheType-5LSDB,installedintotheType-7LSDBwiththeP-bitset.AnyreceivedType
-5sarelegalforanABR,elseillegalforIR.ReceivedType-7sareinstalled,byarea,withinco
mingP-bit.Theyareflooded;iftheElectedNSSATranslator,thenP-bitoff.Additionally,th
isABRwillplace"translatedtype-7's"intotheType-5LSDBinordertokeeptrackofAPPROVALo
rnot.Itwillscanthrougheveryarea,lookingforType-7LSAswithP-BitSET.TheType-7'saree
itherAS-FLOODED&5-INSTALLEDorAGGREGATED.Later,theAGGREGATEDLSAsareAS-FLOODED&5-I
NSTALLED.5-INSTALLEDisintotheType-5LSDB;AnyUNAPPROVEDType-5LSAsleftoverareFLUSHE
DandDISCARDED.ForExternalCalculations,anyNSSAareasusetheType-7AREA-LSDB,anyABR-n
on-NSSAareasusetheType-5GLOBAL-LSDB.*/staticvoidospf_abr_nssa_task(structospf*os
pf)/*calledonlyifany_nssa*/{if(IS_DEBUG_OSPF_NSSA)zlog_debug("CheckforNSSA-ABRTa
sks():");if(!IS_OSPF_ABR(ospf))return;if(!ospf->anyNSSA)return;/*Eachareamustcon
firmTranslatorRole*/if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_nssa_task():Start
");/*ForallGlobalEntriesflagged"local-translate",unsetAPPROVED*/if(IS_DEBUG_OSPF
_NSSA)zlog_debug("ospf_abr_nssa_task():unapprovetranslates");ospf_abr_unapprove_
translates(ospf);/*RESETallRangesineveryArea,sameassummaries*/if(IS_DEBUG_OSPF_N
SSA)zlog_debug("ospf_abr_nssa_task():NSSAinitializeaggregates");ospf_abr_prepare
_aggregates(ospf);/*TURNEDOFFjustfornow*//*ForallNSSAs,Type-7s,translateto5's,IN
STALL/FLOOD,or*AggregateasType-7*InstallorApproveinType-5GlobalLSDB*/if(IS_DEBUG
_OSPF_NSSA)zlog_debug("ospf_abr_nssa_task():processtranslates");ospf_abr_process
_nssa_translates(ospf);/*Translate/Sendany"ranged"aggregates,andalso5-Installand
*Approve*ScanType-7'sforaggregates,translatetoType-5's,*Install/Flood/Approve*/i
f(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_nssa_task():sendNSSAaggregates");ospf_
abr_send_nssa_aggregates(ospf);/*TURNEDOFFFORNOW*//*SendanyNSSAdefaultsasType-5*
if(IS_DEBUG_OSPF_NSSA)*zlog_debug("ospf_abr_nssa_task():announcenssadefaults");*
ospf_abr_announce_nssa_defaults(ospf);*havntacluewhataboveissupposedtodo.*//*Flu
shanyunapprovedprevioustranslatesfromGlobalDataBase*/if(IS_DEBUG_OSPF_NSSA)zlog_
debug("ospf_abr_nssa_task():removeunapprovedtranslates");ospf_abr_remove_unappro
ved_translates(ospf);ospf_abr_manage_discard_routes(ospf);/*sameasnormal...disca
rd*/if(IS_DEBUG_OSPF_NSSA)zlog_debug("ospf_abr_nssa_task():Stop");}/*Thisisthefu
nctiontakingcareaboutABRstuff,i.e.summary-LSAoriginationandflooding.*/voidospf_a
br_task(structospf*ospf){if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task():Star
t");if(ospf->new_table==NULL||ospf->new_rtrs==NULL){if(IS_DEBUG_OSPF_EVENT)zlog_
debug("ospf_abr_task():Routingtablesarenotyetready");return;}if(IS_DEBUG_OSPF_EV
ENT)zlog_debug("ospf_abr_task():unapprovesummaries");ospf_abr_unapprove_summarie
s(ospf);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task():prepareaggregates");o
spf_abr_prepare_aggregates(ospf);if(IS_OSPF_ABR(ospf)){if(IS_DEBUG_OSPF_EVENT)zl
og_debug("ospf_abr_task():processnetworkRT");ospf_abr_process_network_rt(ospf,os
pf->new_table);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task():processrouterR
T");ospf_abr_process_router_rt(ospf,ospf->new_rtrs);if(IS_DEBUG_OSPF_EVENT)zlog_
debug("ospf_abr_task():announceaggregates");ospf_abr_announce_aggregates(ospf);i
f(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task():announcestubdefaults");ospf_ab
r_announce_stub_defaults(ospf);}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task
():removeunapprovedsummaries");ospf_abr_remove_unapproved_summaries(ospf);ospf_a
br_manage_discard_routes(ospf);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_abr_task(
):Stop");}staticintospf_abr_task_timer(structthread*thread){structospf*ospf=THRE
AD_ARG(thread);ospf->t_abr_task=0;if(IS_DEBUG_OSPF_EVENT)zlog_debug("RunningABRt
askontimer");ospf_check_abr_status(ospf);ospf_abr_nssa_check_status(ospf);ospf_a
br_task(ospf);ospf_abr_nssa_task(ospf);/*ifnssa-abr,thenscanType-7LSDB*/return0;
}voidospf_schedule_abr_task(structospf*ospf){if(IS_DEBUG_OSPF_EVENT)zlog_debug("
SchedulingABRtask");thread_add_timer(master,ospf_abr_task_timer,ospf,OSPF_ABR_TA
SK_DELAY,&ospf->t_abr_task);}