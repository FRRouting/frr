/**OSPFSendingandReceivingOSPFPackets.*Copyright(C)1999,2000ToshiakiTakada**This
fileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit
*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundatio
n;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistributedintheho
pethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERC
HANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformored
etails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispro
gram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt
,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"monotime.h"#includ
e"thread.h"#include"memory.h"#include"linklist.h"#include"prefix.h"#include"if.h
"#include"table.h"#include"sockunion.h"#include"stream.h"#include"log.h"#include
"sockopt.h"#include"checksum.h"#include"md5.h"#include"vrf.h"#include"ospfd/ospf
d.h"#include"ospfd/ospf_network.h"#include"ospfd/ospf_interface.h"#include"ospfd
/ospf_ism.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/
ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/ospf_nsm.h"#include"os
pfd/ospf_packet.h"#include"ospfd/ospf_spf.h"#include"ospfd/ospf_flood.h"#include
"ospfd/ospf_dump.h"/**OSPFFragmentation/fragmentedwrites**ospfdcansupportwriting
fragmentedpackets,forcaseswhere*kernelwillnotfragmentIP_HDRINCLand/ormulticastde
stined*packets(ieTTBOMKallkernels,BSD,SunOS,Linux).However,*SunOS,probablyBSDtoo
,clobbertheusersuppliedIPIDandIP*flagsfields,henceuser-spacefragmentationwillnot
work.*OnlyLinuxisknowntoleaveIPheaderunmolested.*Further,fragmentationreallyshou
ldbedonethekernel,whichalready*supportsit,andwhichavoidsnastyIPIDstateproblems.*
*FragmentationofOSPFpacketscanberequiredonnetworkswithrouter*withmanymanyinterfa
cesactiveinonearea,oronnetworkswithlinks*withlowMTUs.*/#ifdefGNU_LINUX#defineWAN
T_OSPF_WRITE_FRAGMENT#endif/*PacketTypeString.*/conststructmessageospf_packet_ty
pe_str[]={{OSPF_MSG_HELLO,"Hello"},{OSPF_MSG_DB_DESC,"DatabaseDescription"},{OSP
F_MSG_LS_REQ,"LinkStateRequest"},{OSPF_MSG_LS_UPD,"LinkStateUpdate"},{OSPF_MSG_L
S_ACK,"LinkStateAcknowledgment"},{0}};/*Minimum(besidesOSPF_HEADER_SIZE)lengthsf
orOSPFpacketsofparticulartypes,offsetisthe"type"fieldofapacket.*/staticconstuint
16_tospf_packet_minlen[]={0,OSPF_HELLO_MIN_SIZE,OSPF_DB_DESC_MIN_SIZE,OSPF_LS_RE
Q_MIN_SIZE,OSPF_LS_UPD_MIN_SIZE,OSPF_LS_ACK_MIN_SIZE,};/*Minimum(besidesOSPF_LSA
_HEADER_SIZE)lengthsforLSAsofparticulartypes,offsetisthe"LSAtype"field.*/staticc
onstuint16_tospf_lsa_minlen[]={0,OSPF_ROUTER_LSA_MIN_SIZE,OSPF_NETWORK_LSA_MIN_S
IZE,OSPF_SUMMARY_LSA_MIN_SIZE,OSPF_SUMMARY_LSA_MIN_SIZE,OSPF_AS_EXTERNAL_LSA_MIN
_SIZE,0,OSPF_AS_EXTERNAL_LSA_MIN_SIZE,0,0,0,0,};/*forospf_check_auth()*/staticin
tospf_check_sum(structospf_header*);/*OSPFauthenticationcheckingfunction*/static
intospf_auth_type(structospf_interface*oi){intauth_type;if(OSPF_IF_PARAM(oi,auth
_type)==OSPF_AUTH_NOTSET)auth_type=oi->area->auth_type;elseauth_type=OSPF_IF_PAR
AM(oi,auth_type);/*HandlecasewhereMD5keylistisnotconfiguredakaCisco*/if(auth_typ
e==OSPF_AUTH_CRYPTOGRAPHIC&&list_isempty(OSPF_IF_PARAM(oi,auth_crypt)))returnOSP
F_AUTH_NULL;returnauth_type;}structospf_packet*ospf_packet_new(size_tsize){struc
tospf_packet*new;new=XCALLOC(MTYPE_OSPF_PACKET,sizeof(structospf_packet));new->s
=stream_new(size);returnnew;}voidospf_packet_free(structospf_packet*op){if(op->s
)stream_free(op->s);XFREE(MTYPE_OSPF_PACKET,op);op=NULL;}structospf_fifo*ospf_fi
fo_new(){structospf_fifo*new;new=XCALLOC(MTYPE_OSPF_FIFO,sizeof(structospf_fifo)
);returnnew;}/*Addnewpackettofifo.*/voidospf_fifo_push(structospf_fifo*fifo,stru
ctospf_packet*op){if(fifo->tail)fifo->tail->next=op;elsefifo->head=op;fifo->tail
=op;fifo->count++;}/*Addnewpackettoheadoffifo.*/staticvoidospf_fifo_push_head(st
ructospf_fifo*fifo,structospf_packet*op){op->next=fifo->head;if(fifo->tail==NULL
)fifo->tail=op;fifo->head=op;fifo->count++;}/*Deletefirstpacketfromfifo.*/struct
ospf_packet*ospf_fifo_pop(structospf_fifo*fifo){structospf_packet*op;op=fifo->he
ad;if(op){fifo->head=op->next;if(fifo->head==NULL)fifo->tail=NULL;fifo->count--;
}returnop;}/*Returnfirstfifoentry.*/structospf_packet*ospf_fifo_head(structospf_
fifo*fifo){returnfifo->head;}/*Flushospfpacketfifo.*/voidospf_fifo_flush(structo
spf_fifo*fifo){structospf_packet*op;structospf_packet*next;for(op=fifo->head;op;
op=next){next=op->next;ospf_packet_free(op);}fifo->head=fifo->tail=NULL;fifo->co
unt=0;}/*Freeospfpacketfifo.*/voidospf_fifo_free(structospf_fifo*fifo){ospf_fifo
_flush(fifo);XFREE(MTYPE_OSPF_FIFO,fifo);}voidospf_packet_add(structospf_interfa
ce*oi,structospf_packet*op){if(!oi->obuf){zlog_err("ospf_packet_add(interface%si
nstate%d[%s],packettype%s,""destination%s)calledwithNULLobuf,ignoring""(pleasere
portthisbug)!\n",IF_NAME(oi),oi->state,lookup_msg(ospf_ism_state_msg,oi->state,N
ULL),lookup_msg(ospf_packet_type_str,stream_getc_from(op->s,1),NULL),inet_ntoa(o
p->dst));return;}/*Addpackettoendofqueue.*/ospf_fifo_push(oi->obuf,op);/*Debugof
packetfifo*//*ospf_fifo_debug(oi->obuf);*/}staticvoidospf_packet_add_top(structo
spf_interface*oi,structospf_packet*op){if(!oi->obuf){zlog_err("ospf_packet_add(i
nterface%sinstate%d[%s],packettype%s,""destination%s)calledwithNULLobuf,ignoring
""(pleasereportthisbug)!\n",IF_NAME(oi),oi->state,lookup_msg(ospf_ism_state_msg,
oi->state,NULL),lookup_msg(ospf_packet_type_str,stream_getc_from(op->s,1),NULL),
inet_ntoa(op->dst));return;}/*Addpackettoheadofqueue.*/ospf_fifo_push_head(oi->o
buf,op);/*Debugofpacketfifo*//*ospf_fifo_debug(oi->obuf);*/}voidospf_packet_dele
te(structospf_interface*oi){structospf_packet*op;op=ospf_fifo_pop(oi->obuf);if(o
p)ospf_packet_free(op);}structospf_packet*ospf_packet_dup(structospf_packet*op){
structospf_packet*new;if(stream_get_endp(op->s)!=op->length)/*XXXsize_t*/zlog_wa
rn("ospf_packet_dupstream%luospf_packet%usizemismatch",(unsignedlong)STREAM_SIZE
(op->s),op->length);/*ReservespaceforMD5authenticationthatmaybeaddedlater.*/new=
ospf_packet_new(stream_get_endp(op->s)+OSPF_AUTH_MD5_SIZE);stream_copy(new->s,op
->s);new->dst=op->dst;new->length=op->length;returnnew;}/*XXXinline*/staticunsig
nedintospf_packet_authspace(structospf_interface*oi){intauth=0;if(ospf_auth_type
(oi)==OSPF_AUTH_CRYPTOGRAPHIC)auth=OSPF_AUTH_MD5_SIZE;returnauth;}staticunsigned
intospf_packet_max(structospf_interface*oi){intmax;max=oi->ifp->mtu-ospf_packet_
authspace(oi);max-=(OSPF_HEADER_SIZE+sizeof(structip));returnmax;}staticintospf_
check_md5_digest(structospf_interface*oi,structospf_header*ospfh){MD5_CTXctx;uns
ignedchardigest[OSPF_AUTH_MD5_SIZE];structcrypt_key*ck;structospf_neighbor*nbr;u
int16_tlength=ntohs(ospfh->length);/*Getsecretkey.*/ck=ospf_crypt_key_lookup(OSP
F_IF_PARAM(oi,auth_crypt),ospfh->u.crypt.key_id);if(ck==NULL){zlog_warn("interfa
ce%s:ospf_check_md5nokey%d",IF_NAME(oi),ospfh->u.crypt.key_id);return0;}/*checkc
ryptoseqnum.*/nbr=ospf_nbr_lookup_by_routerid(oi->nbrs,&ospfh->router_id);if(nbr
&&ntohl(nbr->crypt_seqnum)>ntohl(ospfh->u.crypt.crypt_seqnum)){zlog_warn("interf
ace%s:ospf_check_md5badsequence%d(expect%d)",IF_NAME(oi),ntohl(ospfh->u.crypt.cr
ypt_seqnum),ntohl(nbr->crypt_seqnum));return0;}/*Generateadigestfortheospfpacket
-theirdigest+ourdigest.*/memset(&ctx,0,sizeof(ctx));MD5Init(&ctx);MD5Update(&ctx
,ospfh,length);MD5Update(&ctx,ck->auth_key,OSPF_AUTH_MD5_SIZE);MD5Final(digest,&
ctx);/*comparethetwo*/if(memcmp((caddr_t)ospfh+length,digest,OSPF_AUTH_MD5_SIZE)
){zlog_warn("interface%s:ospf_check_md5checksummismatch",IF_NAME(oi));return0;}/
*saveneighbor'scrypt_seqnum*/if(nbr)nbr->crypt_seqnum=ospfh->u.crypt.crypt_seqnu
m;return1;}/*Thisfunctioniscalledfromospf_write(),itwilldetecttheauthentications
chemeandifitisMD5,itwillchangethesequenceandupdatetheMD5digest.*/staticintospf_m
ake_md5_digest(structospf_interface*oi,structospf_packet*op){structospf_header*o
spfh;unsignedchardigest[OSPF_AUTH_MD5_SIZE]={0};MD5_CTXctx;void*ibuf;uint32_tt;s
tructcrypt_key*ck;constuint8_t*auth_key;ibuf=STREAM_DATA(op->s);ospfh=(structosp
f_header*)ibuf;if(ntohs(ospfh->auth_type)!=OSPF_AUTH_CRYPTOGRAPHIC)return0;/*Wed
othisheresowhenwedupapacket,wedon'thavetowasteCPUrewritingotherheaders.Notethatq
uagga_time/deliberately/isnotusedhere*/t=(time(NULL)&0xFFFFFFFF);if(t>oi->crypt_
seqnum)oi->crypt_seqnum=t;elseoi->crypt_seqnum++;ospfh->u.crypt.crypt_seqnum=hto
nl(oi->crypt_seqnum);/*GetMD5Authenticationkeyfromauth_keylist.*/if(list_isempty
(OSPF_IF_PARAM(oi,auth_crypt)))auth_key=(constuint8_t*)digest;else{ck=listgetdat
a(listtail(OSPF_IF_PARAM(oi,auth_crypt)));auth_key=ck->auth_key;}/*Generateadige
stfortheentirepacket+oursecretkey.*/memset(&ctx,0,sizeof(ctx));MD5Init(&ctx);MD5
Update(&ctx,ibuf,ntohs(ospfh->length));MD5Update(&ctx,auth_key,OSPF_AUTH_MD5_SIZ
E);MD5Final(digest,&ctx);/*Appendmd5digesttotheendofthestream.*/stream_put(op->s
,digest,OSPF_AUTH_MD5_SIZE);/*Wedo*NOT*incrementtheOSPFheaderlength.*/op->length
=ntohs(ospfh->length)+OSPF_AUTH_MD5_SIZE;if(stream_get_endp(op->s)!=op->length)/
*XXXsize_t*/zlog_warn("ospf_make_md5_digest:lengthmismatchstream%luospf_packet%u
",(unsignedlong)stream_get_endp(op->s),op->length);returnOSPF_AUTH_MD5_SIZE;}sta
ticintospf_ls_req_timer(structthread*thread){structospf_neighbor*nbr;nbr=THREAD_
ARG(thread);nbr->t_ls_req=NULL;/*SendLinkStateRequest.*/if(ospf_ls_request_count
(nbr))ospf_ls_req_send(nbr);/*SetLinkStateRequestretransmissiontimer.*/OSPF_NSM_
TIMER_ON(nbr->t_ls_req,ospf_ls_req_timer,nbr->v_ls_req);return0;}voidospf_ls_req
_event(structospf_neighbor*nbr){if(nbr->t_ls_req){thread_cancel(nbr->t_ls_req);n
br->t_ls_req=NULL;}nbr->t_ls_req=NULL;thread_add_event(master,ospf_ls_req_timer,
nbr,0,&nbr->t_ls_req);}/*Cyclictimerfunction.Fistregisteredinospf_nbr_new()inosp
f_neighbor.c*/intospf_ls_upd_timer(structthread*thread){structospf_neighbor*nbr;
nbr=THREAD_ARG(thread);nbr->t_ls_upd=NULL;/*SendLinkStateUpdate.*/if(ospf_ls_ret
ransmit_count(nbr)>0){structlist*update;structospf_lsdb*lsdb;inti;intretransmit_
interval;retransmit_interval=OSPF_IF_PARAM(nbr->oi,retransmit_interval);lsdb=&nb
r->ls_rxmt;update=list_new();for(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++){structroute_
table*table=lsdb->type[i].db;structroute_node*rn;for(rn=route_top(table);rn;rn=r
oute_next(rn)){structospf_lsa*lsa;if((lsa=rn->info)!=NULL){/*Don'tretransmitanLS
AifwereceiveditwithinthelastRxmtIntervalseconds-thisistoallowtheneighbourachance
toacknowledgetheLSAasitmayhavebenjustreceivedbeforetheretransmittimerfired.Thisi
sasmalltweaktowhatisintheRFC,butitwillcutoutoutalotofretransmittraffic-MAG*/if(m
onotime_since(&lsa->tv_recv,NULL)>=retransmit_interval*1000000LL)listnode_add(up
date,rn->info);}}}if(listcount(update)>0)ospf_ls_upd_send(nbr,update,OSPF_SEND_P
ACKET_DIRECT,0);list_delete_and_null(&update);}/*SetLSUpdateretransmissiontimer.
*/OSPF_NSM_TIMER_ON(nbr->t_ls_upd,ospf_ls_upd_timer,nbr->v_ls_upd);return0;}into
spf_ls_ack_timer(structthread*thread){structospf_interface*oi;oi=THREAD_ARG(thre
ad);oi->t_ls_ack=NULL;/*SendLinkStateAcknowledgment.*/if(listcount(oi->ls_ack)>0
)ospf_ls_ack_send_delayed(oi);/*SetLSAcktimer.*/OSPF_ISM_TIMER_ON(oi->t_ls_ack,o
spf_ls_ack_timer,oi->v_ls_ack);return0;}#ifdefWANT_OSPF_WRITE_FRAGMENTstaticvoid
ospf_write_frags(intfd,structospf_packet*op,structip*iph,structmsghdr*msg,unsign
edintmaxdatasize,unsignedintmtu,intflags,uint8_ttype){#defineOSPF_WRITE_FRAG_SHI
FT3uint16_toffset;structiovec*iovp;intret;assert(op->length==stream_get_endp(op-
>s));assert(msg->msg_iovlen==2);/*wecanbuttry.**SunOS,BSDandBSDderivedkernelslik
elywillclearip_id,as*wellastheIP_MFflag,makingthisallquitepointless.**However,fo
rasystemonwhichIP_MFisleftalone,andip_idleft*aloneorelsewhichsetssameip_idforeac
hfragmentthismight*work,eglinux.**XXX-TODO:Itwouldbemuchnicertohavethekernel'sus
etheir*existingfragmentationsupporttodothisforus.Bugs/RFEsneedto*beraisedagainst
thevariouskernels.*//*setMoreFrag*/iph->ip_off|=IP_MF;/*ipfragoffsetisexpressedi
nunitsof8bytewords*/offset=maxdatasize>>OSPF_WRITE_FRAG_SHIFT;iovp=&msg->msg_iov
[1];while((stream_get_endp(op->s)-stream_get_getp(op->s))>maxdatasize){/*datalen
gthofthisfragistonextoffsetvalue*/iovp->iov_len=offset<<OSPF_WRITE_FRAG_SHIFT;ip
h->ip_len=iovp->iov_len+sizeof(structip);assert(iph->ip_len<=mtu);sockopt_iphdri
ncl_swab_htosys(iph);ret=sendmsg(fd,msg,flags);sockopt_iphdrincl_swab_systoh(iph
);if(ret<0)zlog_warn("***ospf_write_frags:sendmsgfailedto%s,""id%d,off%d,len%d,m
tu%ufailedwith%s",inet_ntoa(iph->ip_dst),iph->ip_id,iph->ip_off,iph->ip_len,mtu,
safe_strerror(errno));if(IS_DEBUG_OSPF_PACKET(type-1,SEND)){zlog_debug("ospf_wri
te_frags:sentid%d,off%d,len%dto%s\n",iph->ip_id,iph->ip_off,iph->ip_len,inet_nto
a(iph->ip_dst));if(IS_DEBUG_OSPF_PACKET(type-1,DETAIL)){zlog_debug("------------
-----IPHeaderDump----------------------");ospf_ip_header_dump(iph);zlog_debug("-
----------------------------------------------------");}}iph->ip_off+=offset;str
eam_forward_getp(op->s,iovp->iov_len);iovp->iov_base=stream_pnt(op->s);}/*setupf
orfinalfragment*/iovp->iov_len=stream_get_endp(op->s)-stream_get_getp(op->s);iph
->ip_len=iovp->iov_len+sizeof(structip);iph->ip_off&=(~IP_MF);}#endif/*WANT_OSPF
_WRITE_FRAGMENT*/staticintospf_write(structthread*thread){structospf*ospf=THREAD
_ARG(thread);structospf_interface*oi;structospf_interface*last_serviced_oi=NULL;
structospf_packet*op;structsockaddr_insa_dst;structipiph;structmsghdrmsg;structi
oveciov[2];uint8_ttype;intret;intflags=0;structlistnode*node;#ifdefWANT_OSPF_WRI
TE_FRAGMENTstaticuint16_tipid=0;uint16_tmaxdatasize;#endif/*WANT_OSPF_WRITE_FRAG
MENT*/#defineOSPF_WRITE_IPHL_SHIFT2intpkt_count=0;#ifdefGNU_LINUXunsignedcharcms
gbuf[64]={};structcmsghdr*cm=(structcmsghdr*)cmsgbuf;structin_pktinfo*pi;#endifo
spf->t_write=NULL;node=listhead(ospf->oi_write_q);assert(node);oi=listgetdata(no
de);assert(oi);#ifdefWANT_OSPF_WRITE_FRAGMENT/*seedipidstaticwithloworderbitsoft
ime*/if(ipid==0)ipid=(time(NULL)&0xffff);#endif/*WANT_OSPF_WRITE_FRAGMENT*/while
((pkt_count<ospf->write_oi_count)&&oi&&(last_serviced_oi!=oi)){/*Ifthereisonlypa
cketinthequeue,theoiisremovedfromwrite-q,sofixupthelastinterfacethatwasserviced*
/if(last_serviced_oi==NULL){last_serviced_oi=oi;}pkt_count++;#ifdefWANT_OSPF_WRI
TE_FRAGMENT/*convenience-maxOSPFdataperpacket*/maxdatasize=oi->ifp->mtu-sizeof(s
tructip);#endif/*WANT_OSPF_WRITE_FRAGMENT*//*Getonepacketfromqueue.*/op=ospf_fif
o_head(oi->obuf);assert(op);assert(op->length>=OSPF_HEADER_SIZE);if(op->dst.s_ad
dr==htonl(OSPF_ALLSPFROUTERS)||op->dst.s_addr==htonl(OSPF_ALLDROUTERS))ospf_if_i
pmulticast(ospf,oi->address,oi->ifp->ifindex);/*Rewritethemd5signature&updatethe
seq*/ospf_make_md5_digest(oi,op);/*RetrieveOSPFpackettype.*/stream_set_getp(op->
s,1);type=stream_getc(op->s);/*resetgetpointer*/stream_set_getp(op->s,0);memset(
&iph,0,sizeof(structip));memset(&sa_dst,0,sizeof(sa_dst));sa_dst.sin_family=AF_I
NET;#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENsa_dst.sin_len=sizeof(sa_dst);#endif/*H
AVE_STRUCT_SOCKADDR_IN_SIN_LEN*/sa_dst.sin_addr=op->dst;sa_dst.sin_port=htons(0)
;/*SetDONTROUTEflagifdstisunicast.*/if(oi->type!=OSPF_IFTYPE_VIRTUALLINK)if(!IN_
MULTICAST(htonl(op->dst.s_addr)))flags=MSG_DONTROUTE;iph.ip_hl=sizeof(structip)>
>OSPF_WRITE_IPHL_SHIFT;/*it'dbeverystrangeforheadertonotbe4byte-wordaligned*but.
.*/if(sizeof(structip)>(unsignedint)(iph.ip_hl<<OSPF_WRITE_IPHL_SHIFT))iph.ip_hl
++;/*wepresumesizeofstructipcantoverflowip_hl..*/iph.ip_v=IPVERSION;iph.ip_tos=I
PTOS_PREC_INTERNETCONTROL;iph.ip_len=(iph.ip_hl<<OSPF_WRITE_IPHL_SHIFT)+op->leng
th;#ifdefined(__DragonFly__)/**DragonFly'srawsocketexpectsip_len/ip_offinnetwork
byte*order.*/iph.ip_len=htons(iph.ip_len);#endif#ifdefWANT_OSPF_WRITE_FRAGMENT/*
XXX-MT:notthread-safeatall..*XXX:thispresumesthisisonlyprogrammesendingOSPF*pack
ets*otherwise,noguaranteeipidwillbeunique*/iph.ip_id=++ipid;#endif/*WANT_OSPF_WR
ITE_FRAGMENT*/iph.ip_off=0;if(oi->type==OSPF_IFTYPE_VIRTUALLINK)iph.ip_ttl=OSPF_
VL_IP_TTL;elseiph.ip_ttl=OSPF_IP_TTL;iph.ip_p=IPPROTO_OSPFIGP;iph.ip_sum=0;iph.i
p_src.s_addr=oi->address->u.prefix4.s_addr;iph.ip_dst.s_addr=op->dst.s_addr;mems
et(&msg,0,sizeof(msg));msg.msg_name=(caddr_t)&sa_dst;msg.msg_namelen=sizeof(sa_d
st);msg.msg_iov=iov;msg.msg_iovlen=2;iov[0].iov_base=(char*)&iph;iov[0].iov_len=
iph.ip_hl<<OSPF_WRITE_IPHL_SHIFT;iov[1].iov_base=stream_pnt(op->s);iov[1].iov_le
n=op->length;#ifdefGNU_LINUXmsg.msg_control=(caddr_t)cm;cm->cmsg_level=SOL_IP;cm
->cmsg_type=IP_PKTINFO;cm->cmsg_len=CMSG_LEN(sizeof(structin_pktinfo));pi=(struc
tin_pktinfo*)CMSG_DATA(cm);pi->ipi_ifindex=oi->ifp->ifindex;msg.msg_controllen=c
m->cmsg_len;#endif/*Sadlywecannotrelyonkernelstofragmentpackets*becauseofeitherI
P_HDRINCLand/ormulticast*destinationbeingset.*/#ifdefWANT_OSPF_WRITE_FRAGMENTif(
op->length>maxdatasize)ospf_write_frags(ospf->fd,op,&iph,&msg,maxdatasize,oi->if
p->mtu,flags,type);#endif/*WANT_OSPF_WRITE_FRAGMENT*//*sendfinalfragment(couldbe
first)*/sockopt_iphdrincl_swab_htosys(&iph);ret=sendmsg(ospf->fd,&msg,flags);soc
kopt_iphdrincl_swab_systoh(&iph);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_writeto
%s,""id%d,off%d,len%d,interface%s,mtu%u:",inet_ntoa(iph.ip_dst),iph.ip_id,iph.ip
_off,iph.ip_len,oi->ifp->name,oi->ifp->mtu);if(ret<0)zlog_warn("***sendmsginospf
_writefailedto%s,""id%d,off%d,len%d,interface%s,mtu%u:%s",inet_ntoa(iph.ip_dst),
iph.ip_id,iph.ip_off,iph.ip_len,oi->ifp->name,oi->ifp->mtu,safe_strerror(errno))
;/*Showdebugsendingpacket.*/if(IS_DEBUG_OSPF_PACKET(type-1,SEND)){if(IS_DEBUG_OS
PF_PACKET(type-1,DETAIL)){zlog_debug("------------------------------------------
-----------");ospf_ip_header_dump(&iph);stream_set_getp(op->s,0);ospf_packet_dum
p(op->s);}zlog_debug("%ssentto[%s]via[%s].",lookup_msg(ospf_packet_type_str,type
,NULL),inet_ntoa(op->dst),IF_NAME(oi));if(IS_DEBUG_OSPF_PACKET(type-1,DETAIL))zl
og_debug("-----------------------------------------------------");}switch(type){
caseOSPF_MSG_HELLO:oi->hello_out++;break;caseOSPF_MSG_DB_DESC:oi->db_desc_out++;
break;caseOSPF_MSG_LS_REQ:oi->ls_req_out++;break;caseOSPF_MSG_LS_UPD:oi->ls_upd_
out++;break;caseOSPF_MSG_LS_ACK:oi->ls_ack_out++;break;default:break;}/*Nowdelet
epacketfromqueue.*/ospf_packet_delete(oi);/*Movethisinterfacetothetailofwrite_qt
oserveeveryoneinaroundrobinfashion*/list_delete_node(ospf->oi_write_q,node);if(o
spf_fifo_head(oi->obuf)==NULL){oi->on_write_q=0;last_serviced_oi=NULL;oi=NULL;}e
lse{listnode_add(ospf->oi_write_q,oi);}/*Setuptoservicefromtheheadofthequeueagai
n*/if(!list_isempty(ospf->oi_write_q)){node=listhead(ospf->oi_write_q);assert(no
de);oi=listgetdata(node);assert(oi);}}/*Ifpacketsstillremaininqueue,callwritethr
ead.*/if(!list_isempty(ospf->oi_write_q)){ospf->t_write=NULL;thread_add_write(ma
ster,ospf_write,ospf,ospf->fd,&ospf->t_write);}return0;}/*OSPFHellomessageread--
RFC2328Section10.5.*/staticvoidospf_hello(structip*iph,structospf_header*ospfh,s
tructstream*s,structospf_interface*oi,intsize){structospf_hello*hello;structospf
_neighbor*nbr;intold_state;structprefixp;/*incrementstatistics.*/oi->hello_in++;
hello=(structospf_hello*)stream_pnt(s);/*IfHelloismyself,silentlydiscard.*/if(IP
V4_ADDR_SAME(&ospfh->router_id,&oi->ospf->router_id)){if(IS_DEBUG_OSPF_PACKET(os
pfh->type-1,RECV)){zlog_debug("ospf_header[%s/%s]:selforiginated,""dropping.",lo
okup_msg(ospf_packet_type_str,ospfh->type,NULL),inet_ntoa(iph->ip_src));}return;
}/*getneighborprefix.*/p.family=AF_INET;p.prefixlen=ip_masklen(hello->network_ma
sk);p.u.prefix4=iph->ip_src;/*Comparenetworkmask.*//*CheckingisignoredforPoint-t
o-PointandVirtuallink.*/if(oi->type!=OSPF_IFTYPE_POINTOPOINT&&oi->type!=OSPF_IFT
YPE_VIRTUALLINK)if(oi->address->prefixlen!=p.prefixlen){zlog_warn("Packet%s[Hell
o:RECV]:NetworkMaskmismatchon%s(configuredprefixlengthis%d,buthellopacketindicat
es%d).",inet_ntoa(ospfh->router_id),IF_NAME(oi),(int)oi->address->prefixlen,(int
)p.prefixlen);return;}/*CompareRouterDeadInterval.*/if(OSPF_IF_PARAM(oi,v_wait)!
=ntohl(hello->dead_interval)){zlog_warn("Packet%s[Hello:RECV]:RouterDeadInterval
mismatch""(expected%u,butreceived%u).",inet_ntoa(ospfh->router_id),OSPF_IF_PARAM
(oi,v_wait),ntohl(hello->dead_interval));return;}/*CompareHelloInterval-ignoredi
ffast-hellosareset.*/if(OSPF_IF_PARAM(oi,fast_hello)==0){if(OSPF_IF_PARAM(oi,v_h
ello)!=ntohs(hello->hello_interval)){zlog_warn("Packet%s[Hello:RECV]:HelloInterv
almismatch""(expected%u,butreceived%u).",inet_ntoa(ospfh->router_id),OSPF_IF_PAR
AM(oi,v_hello),ntohs(hello->hello_interval));return;}}if(IS_DEBUG_OSPF_EVENT)zlo
g_debug("Packet%s[Hello:RECV]:Options%svrf%s",inet_ntoa(ospfh->router_id),ospf_o
ptions_dump(hello->options),ospf_vrf_id_to_name(oi->ospf->vrf_id));/*Compareopti
ons.*/#defineREJECT_IF_TBIT_ON1/*XXX*/#ifdefREJECT_IF_TBIT_ONif(CHECK_FLAG(hello
->options,OSPF_OPTION_MT)){/**Thisrouterdoesnotsupportnon-zeroTOS.*DropthisHello
packetnottoestablishneighbor*relationship.*/zlog_warn("Packet%s[Hello:RECV]:T-bi
ton,dropit.",inet_ntoa(ospfh->router_id));return;}#endif/*REJECT_IF_TBIT_ON*/if(
CHECK_FLAG(oi->ospf->config,OSPF_OPAQUE_CAPABLE)&&CHECK_FLAG(hello->options,OSPF
_OPTION_O)){/**ThisrouterdoesknowthecorrectusageofO-bit*thebitshouldbesetinDDpac
ketonly.*/zlog_warn("Packet%s[Hello:RECV]:O-bitabuse?",inet_ntoa(ospfh->router_i
d));#ifdefSTRICT_OBIT_USAGE_CHECKreturn;/*Rejectthispacket.*/#else/*STRICT_OBIT_
USAGE_CHECK*/UNSET_FLAG(hello->options,OSPF_OPTION_O);/*IgnoreO-bit.*/#endif/*ST
RICT_OBIT_USAGE_CHECK*/}/*newforNSSAistoensurethatNPisonandEisoff*/if(oi->area->
external_routing==OSPF_AREA_NSSA){if(!(CHECK_FLAG(OPTIONS(oi),OSPF_OPTION_NP)&&C
HECK_FLAG(hello->options,OSPF_OPTION_NP)&&!CHECK_FLAG(OPTIONS(oi),OSPF_OPTION_E)
&&!CHECK_FLAG(hello->options,OSPF_OPTION_E))){zlog_warn("NSSA-Packet-%s[Hello:RE
CV]:myoptions:%x,hisoptions%x",inet_ntoa(ospfh->router_id),OPTIONS(oi),hello->op
tions);return;}if(IS_DEBUG_OSPF_NSSA)zlog_debug("NSSA-Hello:RECV:Packetfrom%s:",
inet_ntoa(ospfh->router_id));}else/*ThesettingoftheE-bitfoundintheHelloPacket'sO
ptionsfieldmustmatchthisarea'sExternalRoutingCapabilityAmismatchcausesprocessing
tostopandthepackettobedropped.ThesettingoftherestofthebitsintheHelloPacket'sOpti
onsfieldshouldbeignored.*/if(CHECK_FLAG(OPTIONS(oi),OSPF_OPTION_E)!=CHECK_FLAG(h
ello->options,OSPF_OPTION_E)){zlog_warn("Packet%s[Hello:RECV]:myoptions:%x,hisop
tions%x",inet_ntoa(ospfh->router_id),OPTIONS(oi),hello->options);return;}/*getne
ighbourstruct*/nbr=ospf_nbr_get(oi,ospfh,iph,&p);/*neighbourmustbevalid,ospf_nbr
_getcreatesifnoneexisted*/assert(nbr);old_state=nbr->state;/*Addeventtothread.*/
OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_PacketReceived);/*RFC2328Section9.5.1Iftherouter
isnoteligibletobecomeDesignatedRouter,(snip)ItmustalsosendanHelloPacketinreplyto
anHelloPacketreceivedfromanyeligibleneighbor(otherthanthecurrentDesignatedRouter
andBackupDesignatedRouter).*/if(oi->type==OSPF_IFTYPE_NBMA)if(PRIORITY(oi)==0&&h
ello->priority>0&&IPV4_ADDR_CMP(&DR(oi),&iph->ip_src)&&IPV4_ADDR_CMP(&BDR(oi),&i
ph->ip_src))OSPF_NSM_TIMER_ON(nbr->t_hello_reply,ospf_hello_reply_timer,OSPF_HEL
LO_REPLY_DELAY);/*onNBMAnetworktype,ithappenstoreceivebidirectionalHellopacketwi
thoutadvance1-WayReceivedevent.ToavoidincorrectDR-seletion,raise1-WayReceivedeve
nt.*/if(oi->type==OSPF_IFTYPE_NBMA&&(old_state==NSM_Down||old_state==NSM_Attempt
)){OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_OneWayReceived);nbr->priority=hello->priority
;nbr->d_router=hello->d_router;nbr->bd_router=hello->bd_router;return;}if(ospf_n
br_bidirectional(&oi->ospf->router_id,hello->neighbors,size-OSPF_HELLO_MIN_SIZE)
){OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_TwoWayReceived);nbr->options|=hello->options;}
else{OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_OneWayReceived);/*Setneighborinformation.*/
nbr->priority=hello->priority;nbr->d_router=hello->d_router;nbr->bd_router=hello
->bd_router;return;}/*IfneighboritselfdeclaresDRandnoBDRexists,causeeventBackupS
een*/if(IPV4_ADDR_SAME(&nbr->address.u.prefix4,&hello->d_router))if(hello->bd_ro
uter.s_addr==0&&oi->state==ISM_Waiting)OSPF_ISM_EVENT_SCHEDULE(oi,ISM_BackupSeen
);/*neighboritselfdeclaresBDR.*/if(oi->state==ISM_Waiting&&IPV4_ADDR_SAME(&nbr->
address.u.prefix4,&hello->bd_router))OSPF_ISM_EVENT_SCHEDULE(oi,ISM_BackupSeen);
/*hadnotpreviously.*/if((IPV4_ADDR_SAME(&nbr->address.u.prefix4,&hello->d_router
)&&IPV4_ADDR_CMP(&nbr->address.u.prefix4,&nbr->d_router))||(IPV4_ADDR_CMP(&nbr->
address.u.prefix4,&hello->d_router)&&IPV4_ADDR_SAME(&nbr->address.u.prefix4,&nbr
->d_router)))OSPF_ISM_EVENT_SCHEDULE(oi,ISM_NeighborChange);/*hadnotpreviously.*
/if((IPV4_ADDR_SAME(&nbr->address.u.prefix4,&hello->bd_router)&&IPV4_ADDR_CMP(&n
br->address.u.prefix4,&nbr->bd_router))||(IPV4_ADDR_CMP(&nbr->address.u.prefix4,
&hello->bd_router)&&IPV4_ADDR_SAME(&nbr->address.u.prefix4,&nbr->bd_router)))OSP
F_ISM_EVENT_SCHEDULE(oi,ISM_NeighborChange);/*Neighborprioritycheck.*/if(nbr->pr
iority>=0&&nbr->priority!=hello->priority)OSPF_ISM_EVENT_SCHEDULE(oi,ISM_Neighbo
rChange);/*Setneighborinformation.*/nbr->priority=hello->priority;nbr->d_router=
hello->d_router;nbr->bd_router=hello->bd_router;}/*SaveDDflags/options/Seqnumrec
eived.*/staticvoidospf_db_desc_save_current(structospf_neighbor*nbr,structospf_d
b_desc*dd){nbr->last_recv.flags=dd->flags;nbr->last_recv.options=dd->options;nbr
->last_recv.dd_seqnum=ntohl(dd->dd_seqnum);}/*ProcessrestofDDpacket.*/staticvoid
ospf_db_desc_proc(structstream*s,structospf_interface*oi,structospf_neighbor*nbr
,structospf_db_desc*dd,uint16_tsize){structospf_lsa*new,*find;structlsa_header*l
sah;stream_forward_getp(s,OSPF_DB_DESC_MIN_SIZE);for(size-=OSPF_DB_DESC_MIN_SIZE
;size>=OSPF_LSA_HEADER_SIZE;size-=OSPF_LSA_HEADER_SIZE){lsah=(structlsa_header*)
stream_pnt(s);stream_forward_getp(s,OSPF_LSA_HEADER_SIZE);/*UnknownLStype.*/if(l
sah->type<OSPF_MIN_LSA||lsah->type>=OSPF_MAX_LSA){zlog_warn("Packet[DD:RECV]:Unk
nownLStype%d.",lsah->type);OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_SeqNumberMismatch);re
turn;}if(IS_OPAQUE_LSA(lsah->type)&&!CHECK_FLAG(nbr->options,OSPF_OPTION_O)){zlo
g_warn("LSA[Type%d:%s]:Opaquecapabilitymismatch?",lsah->type,inet_ntoa(lsah->id)
);OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_SeqNumberMismatch);return;}switch(lsah->type){
caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS_LSA:/*Checkforstubarea.RejectifAS-Ex
ternalfromstubbutallowiffromNSSA.*/if(oi->area->external_routing==OSPF_AREA_STUB
){zlog_warn("Packet[DD:RECV]:LSA[Type%d:%s]from%sarea.",lsah->type,inet_ntoa(lsa
h->id),(oi->area->external_routing==OSPF_AREA_STUB)?"STUB":"NSSA");OSPF_NSM_EVEN
T_SCHEDULE(nbr,NSM_SeqNumberMismatch);return;}break;default:break;}/*CreateLS-re
questobject.*/new=ospf_ls_request_new(lsah);/*LookupreceivedLSA,thenaddLSrequest
list.*/find=ospf_lsa_lookup_by_header(oi->area,lsah);/*ospf_lsa_more_recentisfin
ewithNULLpointers*/switch(ospf_lsa_more_recent(find,new)){case-1:/*Neighbourhasa
morerecentLSA,wemustrequestit*/ospf_ls_request_add(nbr,new);/*fallthru*/case0:/*
IfwehaveacopyofthisLSA,it'seitherless*recent*andwe'rerequestingitfromneighbour(t
hecase*above),or*it'sasrecentandwebothhavesamecopy(this*case).**Inneitherofthese
twocasesisthereanypointin*describingourcopyoftheLSAtotheneighbourina*DB-Summaryp
acket,ifwe'restillintendingtodoso.**See:draft-ogier-ospf-dbex-opt-00.txt,describ
ingthe*backwardcompatibleoptimisationtoOSPFDBExchange*/*DBDescriptionprocessimpl
ementedhere.*/if(find)ospf_lsdb_delete(&nbr->db_sum,find);ospf_lsa_discard(new);
break;default:/*Wehavethemorerecentcopy,nothingspecifictodo:*-noneedtorequestnei
ghboursstalecopy*-mustleaveDBsummarylistcopyalone*/if(IS_DEBUG_OSPF_EVENT)zlog_d
ebug("Packet[DD:RECV]:LSAreceivedType%d,""ID%sisnotrecent.",lsah->type,inet_ntoa
(lsah->id));ospf_lsa_discard(new);}}/*Master*/if(IS_SET_DD_MS(nbr->dd_flags)){nb
r->dd_seqnum++;/*BothsideshavenoMore,thenwe'redonewithExchange*/if(!IS_SET_DD_M(
dd->flags)&&!IS_SET_DD_M(nbr->dd_flags))OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_Exchange
Done);elseospf_db_desc_send(nbr);}/*Slave*/else{nbr->dd_seqnum=ntohl(dd->dd_seqn
um);/*SendDDpacketinreply.**MustbedonetoacknowledgetheMaster'sDD,regardlessof*wh
etherwehavemoreLSAsourselvestodescribe.**Thisfunctionwillclearthe'More'bit,ifaft
erthisDD*wehavenomoreLSAstodescribetothemaster..*/ospf_db_desc_send(nbr);/*Slave
canraiseExchangeDonenow,ifmasterisalsodone*/if(!IS_SET_DD_M(dd->flags)&&!IS_SET_
DD_M(nbr->dd_flags))OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_ExchangeDone);}/*Savereceive
dneighborvaluesfromDD.*/ospf_db_desc_save_current(nbr,dd);if(!nbr->t_ls_req)ospf
_ls_req_send(nbr);}staticintospf_db_desc_is_dup(structospf_db_desc*dd,structospf
_neighbor*nbr){/*IsDDduplicated?*/if(dd->options==nbr->last_recv.options&&dd->fl
ags==nbr->last_recv.flags&&dd->dd_seqnum==htonl(nbr->last_recv.dd_seqnum))return
1;return0;}/*OSPFDatabaseDescriptionmessageread--RFC2328Section10.6.*/staticvoid
ospf_db_desc(structip*iph,structospf_header*ospfh,structstream*s,structospf_inte
rface*oi,uint16_tsize){structospf_db_desc*dd;structospf_neighbor*nbr;/*Increment
statistics.*/oi->db_desc_in++;dd=(structospf_db_desc*)stream_pnt(s);nbr=ospf_nbr
_lookup(oi,iph,ospfh);if(nbr==NULL){zlog_warn("Packet[DD]:UnknownNeighbor%s",ine
t_ntoa(ospfh->router_id));return;}/*CheckMTU.*/if((OSPF_IF_PARAM(oi,mtu_ignore)=
=0)&&(ntohs(dd->mtu)>oi->ifp->mtu)){zlog_warn("Packet[DD]:Neighbor%sMTU%uislarge
rthan[%s]'sMTU%u",inet_ntoa(nbr->router_id),ntohs(dd->mtu),IF_NAME(oi),oi->ifp->
mtu);return;}/**XXXHACKbyHassoTepper.SettingN/PbitinNSSAareaDDpacketsis*not*requ
ired.InfactatleastJunOSsendsDDpacketswithPbitclear.*Untilpropersolutionisdevelop
ped,thishackshouldhelp.**Update:AccordingtotheRFCs,Nbitisspecified/only/forHello
*options,unfortunatelyitsuseinDDoptionsisnotspecified.Hence*some*implementations
followE-bitsemanticsandsetitinDDoptions,and*some*treatitasunspecifiedandhencefol
lowthedirective"defaultfor*optionsisclear",ieunset.**Resettheflag,asospfdfollows
E-bitsemantics.*/if((oi->area->external_routing==OSPF_AREA_NSSA)&&(CHECK_FLAG(nb
r->options,OSPF_OPTION_NP))&&(!CHECK_FLAG(dd->options,OSPF_OPTION_NP))){if(IS_DE
BUG_OSPF_EVENT)zlog_debug("Packet[DD]:Neighbour%s:HasNSSAcapability,sendswithNbi
tclearinDDoptions",inet_ntoa(nbr->router_id));SET_FLAG(dd->options,OSPF_OPTION_N
P);}#ifdefREJECT_IF_TBIT_ONif(CHECK_FLAG(dd->options,OSPF_OPTION_MT)){/**InHello
protocol,optionalcapabilitymusthavechecked*topreventthisT-bitenabledrouterbemyne
ighbor.*/zlog_warn("Packet[DD]:Neighbor%s:T-biton?",inet_ntoa(nbr->router_id));r
eturn;}#endif/*REJECT_IF_TBIT_ON*/if(CHECK_FLAG(dd->options,OSPF_OPTION_O)&&!CHE
CK_FLAG(oi->ospf->config,OSPF_OPAQUE_CAPABLE)){/**Thisnodeisnotconfiguredtohandl
eO-bit,fornow.*Clearittoignoreunsupportedcapabilityproposedby*neighbor.*/UNSET_F
LAG(dd->options,OSPF_OPTION_O);}/*Addeventtothread.*/OSPF_NSM_EVENT_SCHEDULE(nbr
,NSM_PacketReceived);/*ProcessDDpacketbyneighborstatus.*/switch(nbr->state){case
NSM_Down:caseNSM_Attempt:caseNSM_TwoWay:zlog_warn("Packet[DD]:Neighbor%sstateis%
s,packetdiscarded.",inet_ntoa(nbr->router_id),lookup_msg(ospf_nsm_state_msg,nbr-
>state,NULL));break;caseNSM_Init:OSPF_NSM_EVENT_EXECUTE(nbr,NSM_TwoWayReceived);
/*IfthenewstateisExStart,theprocessingofthecurrentpacketshouldthencontinueinthis
newstatebyfallingthroughtocaseExStartbelow.*/if(nbr->state!=NSM_ExStart)break;/*
fallthru*/caseNSM_ExStart:/*InitialDBD*/if((IS_SET_DD_ALL(dd->flags)==OSPF_DD_FL
AG_ALL)&&(size==OSPF_DB_DESC_MIN_SIZE)){if(IPV4_ADDR_CMP(&nbr->router_id,&oi->os
pf->router_id)>0){/*We'reSlave---obey*/if(CHECK_FLAG(oi->ospf->config,OSPF_LOG_A
DJACENCY_DETAIL))zlog_info("Packet[DD]:Neighbor%sNegotiationdone(Slave).",inet_n
toa(nbr->router_id));nbr->dd_seqnum=ntohl(dd->dd_seqnum);/*ResetI/MS*/UNSET_FLAG
(nbr->dd_flags,(OSPF_DD_FLAG_MS|OSPF_DD_FLAG_I));}else{/*We'reMaster,ignorethein
itialDBDfrom*Slave*/if(CHECK_FLAG(oi->ospf->config,OSPF_LOG_ADJACENCY_DETAIL))zl
og_info("Packet[DD]:Neighbor%s:InitialDBDfromSlave,""ignoring.",inet_ntoa(nbr->r
outer_id));break;}}/*AckfromtheSlave*/elseif(!IS_SET_DD_MS(dd->flags)&&!IS_SET_D
D_I(dd->flags)&&ntohl(dd->dd_seqnum)==nbr->dd_seqnum&&IPV4_ADDR_CMP(&nbr->router
_id,&oi->ospf->router_id)<0){zlog_info("Packet[DD]:Neighbor%sNegotiationdone(Mas
ter).",inet_ntoa(nbr->router_id));/*ResetI,leavingMS*/UNSET_FLAG(nbr->dd_flags,O
SPF_DD_FLAG_I);}else{zlog_warn("Packet[DD]:Neighbor%sNegotiationfails.",inet_nto
a(nbr->router_id));break;}/*ThisiswheretherealOptionsaresaved*/nbr->options=dd->
options;if(CHECK_FLAG(oi->ospf->config,OSPF_OPAQUE_CAPABLE)){if(IS_DEBUG_OSPF_EV
ENT)zlog_debug("Neighbor[%s]is%sOpaque-capable.",inet_ntoa(nbr->router_id),CHECK
_FLAG(nbr->options,OSPF_OPTION_O)?"":"NOT");if(!CHECK_FLAG(nbr->options,OSPF_OPT
ION_O)&&IPV4_ADDR_SAME(&DR(oi),&nbr->address.u.prefix4)){zlog_warn("DR-neighbor[
%s]isNOTopaque-capable;""Opaque-LSAscannotbereliablyadvertised""inthisnetwork.",
inet_ntoa(nbr->router_id));/*Thissituationisundesirable,butnotareal*error.*/}}OS
PF_NSM_EVENT_EXECUTE(nbr,NSM_NegotiationDone);/*continueprocessingrestofpacket.*
/ospf_db_desc_proc(s,oi,nbr,dd,size);break;caseNSM_Exchange:if(ospf_db_desc_is_d
up(dd,nbr)){if(IS_SET_DD_MS(nbr->dd_flags))/*Master:discardduplicatedDDpacket.*/
zlog_info("Packet[DD](Master):Neighbor%spacketduplicated.",inet_ntoa(nbr->router
_id));else/*Slave:causetoretransmitthelastDatabaseDescription.*/{zlog_info("Pack
et[DD][Slave]:Neighbor%spacketduplicated.",inet_ntoa(nbr->router_id));ospf_db_de
sc_resend(nbr);}break;}/*OtherwiseDDpacketshouldbechecked.*//*CheckMaster/Slaveb
itmismatch*/if(IS_SET_DD_MS(dd->flags)!=IS_SET_DD_MS(nbr->last_recv.flags)){zlog
_warn("Packet[DD]:Neighbor%sMS-bitmismatch.",inet_ntoa(nbr->router_id));OSPF_NSM
_EVENT_SCHEDULE(nbr,NSM_SeqNumberMismatch);if(IS_DEBUG_OSPF_EVENT)zlog_debug("Pa
cket[DD]:dd->flags=%d,nbr->dd_flags=%d",dd->flags,nbr->dd_flags);break;}/*Checki
nitializebitisset.*/if(IS_SET_DD_I(dd->flags)){zlog_info("Packet[DD]:Neighbor%sI
-bitset.",inet_ntoa(nbr->router_id));OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_SeqNumberMi
smatch);break;}/*CheckDDOptions.*/if(dd->options!=nbr->options){#ifdefORIGINAL_C
ODING/*Savethenewoptionsfordebugging*/nbr->options=dd->options;#endif/*ORIGINAL_
CODING*/zlog_warn("Packet[DD]:Neighbor%soptionsmismatch.",inet_ntoa(nbr->router_
id));OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_SeqNumberMismatch);break;}/*CheckDDsequence
number.*/if((IS_SET_DD_MS(nbr->dd_flags)&&ntohl(dd->dd_seqnum)!=nbr->dd_seqnum)|
|(!IS_SET_DD_MS(nbr->dd_flags)&&ntohl(dd->dd_seqnum)!=nbr->dd_seqnum+1)){zlog_wa
rn("Packet[DD]:Neighbor%ssequencenumbermismatch.",inet_ntoa(nbr->router_id));OSP
F_NSM_EVENT_SCHEDULE(nbr,NSM_SeqNumberMismatch);break;}/*Continueprocessingresto
fpacket.*/ospf_db_desc_proc(s,oi,nbr,dd,size);break;caseNSM_Loading:caseNSM_Full
:if(ospf_db_desc_is_dup(dd,nbr)){if(IS_SET_DD_MS(nbr->dd_flags)){/*Mastershouldd
iscardduplicateDDpacket.*/zlog_info("Packet[DD]:Neighbor%sduplicated,""packetdis
carded.",inet_ntoa(nbr->router_id));break;}else{if(monotime_since(&nbr->last_sen
d_ts,NULL)<nbr->v_inactivity*1000000LL){/*InstatesLoadingandFulltheslavemustrese
nditslastDatabaseDescriptionpacketinresponsetoduplicateDatabaseDescriptionpacket
sreceivedfromthemaster.ForthisreasontheslavemustwaitRouterDeadIntervalsecondsbef
orefreeingthelastDatabaseDescriptionpacket.ReceptionofaDatabaseDescriptionpacket
fromthemasterafterthisintervalwillgenerateaSeqNumberMismatchneighborevent.RFC232
8Section10.8*/ospf_db_desc_resend(nbr);break;}}}OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_
SeqNumberMismatch);break;default:zlog_warn("Packet[DD]:Neighbor%sNSMillegalstatu
s%u.",inet_ntoa(nbr->router_id),nbr->state);break;}}#defineOSPF_LSA_KEY_SIZE12/*
type(4)+id(4)+ar(4)*//*OSPFLinkStateRequestRead--RFC2328Section10.7.*/staticvoid
ospf_ls_req(structip*iph,structospf_header*ospfh,structstream*s,structospf_inter
face*oi,uint16_tsize){structospf_neighbor*nbr;uint32_tls_type;structin_addrls_id
;structin_addradv_router;structospf_lsa*find;structlist*ls_upd;unsignedintlength
;/*Incrementstatistics.*/oi->ls_req_in++;nbr=ospf_nbr_lookup(oi,iph,ospfh);if(nb
r==NULL){zlog_warn("LinkStateRequest:UnknownNeighbor%s.",inet_ntoa(ospfh->router
_id));return;}/*Addeventtothread.*/OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_PacketReceive
d);/*NeighborStateshouldbeExchangeorlater.*/if(nbr->state!=NSM_Exchange&&nbr->st
ate!=NSM_Loading&&nbr->state!=NSM_Full){zlog_warn("LinkStateRequestreceivedfrom%
s:""Neighborstateis%s,packetdiscarded.",inet_ntoa(ospfh->router_id),lookup_msg(o
spf_nsm_state_msg,nbr->state,NULL));return;}/*SendLinkStateUpdateforALLrequested
LSAs.*/ls_upd=list_new();length=OSPF_HEADER_SIZE+OSPF_LS_UPD_MIN_SIZE;while(size
>=OSPF_LSA_KEY_SIZE){/*GetonesliceofLinkStateRequest.*/ls_type=stream_getl(s);ls
_id.s_addr=stream_get_ipv4(s);adv_router.s_addr=stream_get_ipv4(s);/*VerifyLSAty
pe.*/if(ls_type<OSPF_MIN_LSA||ls_type>=OSPF_MAX_LSA){OSPF_NSM_EVENT_SCHEDULE(nbr
,NSM_BadLSReq);list_delete_and_null(&ls_upd);return;}/*SearchproperLSAinLSDB.*/f
ind=ospf_lsa_lookup(oi->ospf,oi->area,ls_type,ls_id,adv_router);if(find==NULL){O
SPF_NSM_EVENT_SCHEDULE(nbr,NSM_BadLSReq);list_delete_and_null(&ls_upd);return;}/
*PacketoverflowsMTUsize,sendimmediately.*/if(length+ntohs(find->data->length)>os
pf_packet_max(oi)){if(oi->type==OSPF_IFTYPE_NBMA)ospf_ls_upd_send(nbr,ls_upd,OSP
F_SEND_PACKET_DIRECT,0);elseospf_ls_upd_send(nbr,ls_upd,OSPF_SEND_PACKET_INDIREC
T,0);/*Onlyremovelistcontents.Keepls_upd.*/list_delete_all_node(ls_upd);length=O
SPF_HEADER_SIZE+OSPF_LS_UPD_MIN_SIZE;}/*AppendLSAtoupdatelist.*/listnode_add(ls_
upd,find);length+=ntohs(find->data->length);size-=OSPF_LSA_KEY_SIZE;}/*Sendresto
fLinkStateUpdate.*/if(listcount(ls_upd)>0){if(oi->type==OSPF_IFTYPE_NBMA)ospf_ls
_upd_send(nbr,ls_upd,OSPF_SEND_PACKET_DIRECT,0);elseospf_ls_upd_send(nbr,ls_upd,
OSPF_SEND_PACKET_INDIRECT,0);list_delete_and_null(&ls_upd);}elselist_delete_and_
null(&ls_upd);}/*GetthelistofLSAsfromLinkStateUpdatepacket.Andprocesssomevalidat
ion--RFC2328Section13.(1)-(2).*/staticstructlist*ospf_ls_upd_list_lsa(structospf
_neighbor*nbr,structstream*s,structospf_interface*oi,size_tsize){uint16_tcount,s
um;uint32_tlength;structlsa_header*lsah;structospf_lsa*lsa;structlist*lsas;lsas=
list_new();count=stream_getl(s);size-=OSPF_LS_UPD_MIN_SIZE;/*#LSAs*/for(;size>=O
SPF_LSA_HEADER_SIZE&&count>0;size-=length,stream_forward_getp(s,length),count--)
{lsah=(structlsa_header*)stream_pnt(s);length=ntohs(lsah->length);if(length>size
){zlog_warn("LinkStateUpdate:LSAlengthexceedspacketsize.");break;}/*ValidatetheL
SA'sLSchecksum.*/sum=lsah->checksum;if(!ospf_lsa_checksum_valid(lsah)){/*(bug#68
5)moredetailsinaone-linemessagemakeit*possible*toidentifyproblemsourceontheoneha
ndandto*haveabetter*chancetocompressrepeatedmessagesinsyslogonthe*other*/zlog_wa
rn("LinkStateUpdate:LSAchecksumerror%x/%x,ID=%sfrom:nbr%s,routerID%s,advrouter%s
",sum,lsah->checksum,inet_ntoa(lsah->id),inet_ntoa(nbr->src),inet_ntoa(nbr->rout
er_id),inet_ntoa(lsah->adv_router));continue;}/*ExaminetheLSA'sLStype.*/if(lsah-
>type<OSPF_MIN_LSA||lsah->type>=OSPF_MAX_LSA){zlog_warn("LinkStateUpdate:Unknown
LStype%d",lsah->type);continue;}/**WhatifthereceivedLSA'sageisgreaterthanMaxAge?
*TreatitasaMaxAgecase--endo.*/if(ntohs(lsah->ls_age)>OSPF_LSA_MAXAGE)lsah->ls_ag
e=htons(OSPF_LSA_MAXAGE);if(CHECK_FLAG(nbr->options,OSPF_OPTION_O)){#ifdefSTRICT
_OBIT_USAGE_CHECKif((IS_OPAQUE_LSA(lsah->type)&&!CHECK_FLAG(lsah->options,OSPF_O
PTION_O))||(!IS_OPAQUE_LSA(lsah->type)&&CHECK_FLAG(lsah->options,OSPF_OPTION_O))
){/**Thisneighbormustknowtheexactusageof*O-bit;*thebitwillbesetinType-9,10,11LSA
s*only.*/zlog_warn("LSA[Type%d:%s]:O-bitabuse?",lsah->type,inet_ntoa(lsah->id));
continue;}#endif/*STRICT_OBIT_USAGE_CHECK*//*DonottakeinASExternalOpaque-LSAsifw
earea*stub.*/if(lsah->type==OSPF_OPAQUE_AS_LSA&&nbr->oi->area->external_routing!
=OSPF_AREA_DEFAULT){if(IS_DEBUG_OSPF_EVENT)zlog_debug("LSA[Type%d:%s]:Weareastub
,don'ttakethisLSA.",lsah->type,inet_ntoa(lsah->id));continue;}}elseif(IS_OPAQUE_
LSA(lsah->type)){zlog_warn("LSA[Type%d:%s]:Opaquecapabilitymismatch?",lsah->type
,inet_ntoa(lsah->id));continue;}/*CreateOSPFLSAinstance.*/lsa=ospf_lsa_new();lsa
->vrf_id=oi->ospf->vrf_id;/*WemaywishtoputsomeerrorcheckingiftypeNSSAcomesinanda
reanotinNSSAmode*/switch(lsah->type){caseOSPF_AS_EXTERNAL_LSA:caseOSPF_OPAQUE_AS
_LSA:lsa->area=NULL;break;caseOSPF_OPAQUE_LINK_LSA:lsa->oi=oi;/*Rememberincoming
interfaceforfloodingcontrol.*//*Fallthrough*/default:lsa->area=oi->area;break;}l
sa->data=ospf_lsa_data_new(length);memcpy(lsa->data,lsah,length);if(IS_DEBUG_OSP
F_EVENT)zlog_debug("LSA[Type%d:%s]:%pnewLSAcreatedwithLinkStateUpdate",lsa->data
->type,inet_ntoa(lsa->data->id),(void*)lsa);listnode_add(lsas,lsa);}returnlsas;}
/*CleanupUpdatelist.*/staticvoidospf_upd_list_clean(structlist*lsas){structlistn
ode*node,*nnode;structospf_lsa*lsa;for(ALL_LIST_ELEMENTS(lsas,node,nnode,lsa))os
pf_lsa_discard(lsa);list_delete_and_null(&lsas);}/*OSPFLinkStateUpdatemessagerea
d--RFC2328Section13.*/staticvoidospf_ls_upd(structospf*ospf,structip*iph,structo
spf_header*ospfh,structstream*s,structospf_interface*oi,uint16_tsize){structospf
_neighbor*nbr;structlist*lsas;structlistnode*node,*nnode;structospf_lsa*lsa=NULL
;/*unsignedlongls_req_found=0;*//*Dis-assemblethestream,updateeachentry,re-encap
sulatefor*flooding*//*Incrementstatistics.*/oi->ls_upd_in++;/*Checkneighbor.*/nb
r=ospf_nbr_lookup(oi,iph,ospfh);if(nbr==NULL){zlog_warn("LinkStateUpdate:Unknown
Neighbor%sonint:%s",inet_ntoa(ospfh->router_id),IF_NAME(oi));return;}/*Addeventt
othread.*/OSPF_NSM_EVENT_SCHEDULE(nbr,NSM_PacketReceived);/*Checkneighborstate.*
/if(nbr->state<NSM_Exchange){if(IS_DEBUG_OSPF(nsm,NSM_EVENTS))zlog_debug("LinkSt
ateUpdate:""Neighbor[%s]state%sislessthanExchange",inet_ntoa(ospfh->router_id),l
ookup_msg(ospf_nsm_state_msg,nbr->state,NULL));return;}/*GetlistofLSAsfromLinkSt
ateUpdatepacket.-AlsoperormsStages*1(validateLSAchecksum)and2(checkforLSAconsist
enttype)*ofsection13.*/lsas=ospf_ls_upd_list_lsa(nbr,s,oi,size);if(lsas==NULL)re
turn;#defineDISCARD_LSA(L,N)\{\if(IS_DEBUG_OSPF_EVENT)\zlog_debug(\"ospf_lsa_dis
card()inospf_ls_upd()point%d:lsa%p"\"Type-%d",\N,(void*)lsa,(int)lsa->data->type
);\ospf_lsa_discard(L);\continue;\}/*ProcesseachLSAreceivedintheonepacket.**Numb
ersinparentheses,e.g.(1),(2),etc.,andthecorresponding*textbelowarefromthestepsin
RFC2328,Section13.*/for(ALL_LIST_ELEMENTS(lsas,node,nnode,lsa)){structospf_lsa*l
s_ret,*current;intret=1;if(IS_DEBUG_OSPF_NSSA){charbuf1[INET_ADDRSTRLEN];charbuf
2[INET_ADDRSTRLEN];charbuf3[INET_ADDRSTRLEN];zlog_debug("LSAType-%dfrom%s,ID:%s,
ADV:%s",lsa->data->type,inet_ntop(AF_INET,&ospfh->router_id,buf1,INET_ADDRSTRLEN
),inet_ntop(AF_INET,&lsa->data->id,buf2,INET_ADDRSTRLEN),inet_ntop(AF_INET,&lsa-
>data->adv_router,buf3,INET_ADDRSTRLEN));}listnode_delete(lsas,lsa);/*Wedon'tnee
ditinlistanymore*//*(1)ValidateChecksum-Doneabovebyospf_ls_upd_list_lsa()*//*(2)
LSAType-Doneabovebyospf_ls_upd_list_lsa()*//*(3)DonottakeinASExternalLSAsifweare
astuborNSSA.*//*DonottakeinASNSSAifthisneighborandwearenotNSSA*//*DotakeinType-7
'sifweareanNSSA*//*IfwearealsoanABR,latertranslatethemtoaType-5*packet*//*Later,
anNSSARe-freshcanRe-freshType-7'sandanABRwilltranslatethemtoaseparateType-5packe
t.*/if(lsa->data->type==OSPF_AS_EXTERNAL_LSA)/*RejectfromSTUBorNSSA*/if(nbr->oi-
>area->external_routing!=OSPF_AREA_DEFAULT){if(IS_DEBUG_OSPF_NSSA)zlog_debug("In
comingExternalLSADiscarded:WeareNSSA/STUBArea");DISCARD_LSA(lsa,1);}if(lsa->data
->type==OSPF_AS_NSSA_LSA)if(nbr->oi->area->external_routing!=OSPF_AREA_NSSA){if(
IS_DEBUG_OSPF_NSSA)zlog_debug("IncomingNSSALSADiscarded:NotNSSAArea");DISCARD_LS
A(lsa,2);}/*VU229804:Router-LSAAdv-IDmustbeequaltoLS-ID*/if(lsa->data->type==OSP
F_ROUTER_LSA)if(!IPV4_ADDR_SAME(&lsa->data->id,&lsa->data->adv_router)){charbuf1
[INET_ADDRSTRLEN];charbuf2[INET_ADDRSTRLEN];charbuf3[INET_ADDRSTRLEN];zlog_err("
IncomingRouter-LSAfrom%swith""Adv-ID[%s]!=LS-ID[%s]",inet_ntop(AF_INET,&ospfh->r
outer_id,buf1,INET_ADDRSTRLEN),inet_ntop(AF_INET,&lsa->data->id,buf2,INET_ADDRST
RLEN),inet_ntop(AF_INET,&lsa->data->adv_router,buf3,INET_ADDRSTRLEN));zlog_err("
OSPFdomaincompromisedbyattackorcorruption.""Verifycorrectoperationof-ALL-OSPFrou
ters.");DISCARD_LSA(lsa,0);}/*FindtheLSAinthecurrentdatabase.*/current=ospf_lsa_
lookup_by_header(oi->area,lsa->data);/*(4)IftheLSA'sLSageisequaltoMaxAge,andther
eiscurrentlynoinstanceoftheLSAintherouter'slinkstatedatabase,andnoneofrouter'sne
ighborsareinstatesExchangeorLoading,thentakethefollowingactions:*/if(IS_LSA_MAXA
GE(lsa)&&!current&&ospf_check_nbr_status(oi->ospf)){/*(4a)ResponseLinkStateAckno
wledgment.*/ospf_ls_ack_send(nbr,lsa);/*(4b)DiscardLSA.*/if(IS_DEBUG_OSPF(lsa,LS
A)){zlog_debug("LinkStateUpdate[%s]:LSageisequaltoMaxAge.",dump_lsa_key(lsa));}D
ISCARD_LSA(lsa,3);}if(IS_OPAQUE_LSA(lsa->data->type)&&IPV4_ADDR_SAME(&lsa->data-
>adv_router,&oi->ospf->router_id)){/**Evenifinitialflushingseemstobecompleted,th
ere*might*beacasethatself-originatedLSAwithMaxAgestill*remain*intheroutingdomain
.*JustsendanLSAckmessagetoceaseretransmission.*/if(IS_LSA_MAXAGE(lsa)){zlog_warn
("LSA[%s]:Boomerangeffect?",dump_lsa_key(lsa));ospf_ls_ack_send(nbr,lsa);ospf_ls
a_discard(lsa);if(current!=NULL&&!IS_LSA_MAXAGE(current))ospf_opaque_lsa_refresh
_schedule(current);continue;}/**Ifaninstanceofself-originatedOpaque-LSAisnot*fou
nd*intheLSDB,therearesomepossiblecaseshere.**1)Thisnodelostopaque-capabilityafte
rrestart.*2)Else,apartofopaque-typeisnomoresupported.*3)Else,apartofopaque-idisn
omoresupported.**Anyway,itisstillthisnode'sresponsibilityto*flushit.*Otherwise,t
heLSAinstanceremainsintherouting*domain*untilitsagereachestoMaxAge.*//*XXX:Wesho
ulddealwiththisfor*ALL*LSAs,not*justopaque*/if(current==NULL){if(IS_DEBUG_OSPF_E
VENT)zlog_debug("LSA[%s]:PreviouslyoriginatedOpaque-LSA,""notfoundintheLSDB.",du
mp_lsa_key(lsa));SET_FLAG(lsa->flags,OSPF_LSA_SELF);ospf_opaque_self_originated_
lsa_received(nbr,lsa);ospf_ls_ack_send(nbr,lsa);continue;}}/*Itmightbehappenthat
receivedLSAisself-originated*networkLSA,but*routerIDischanged.So,weshouldcheckif
LSAisa*network-LSAwhose*LinkStateIDisoneoftherouter'sownIPinterface*addressesbut
whose*AdvertisingRouterisnotequaltotherouter'sownRouterID*AccordingtoRFC232812.4
.2and13.4thisLSAshouldbe*flushed.*/if(lsa->data->type==OSPF_NETWORK_LSA){structl
istnode*oinode,*oinnode;structospf_interface*out_if;intFlag=0;for(ALL_LIST_ELEME
NTS(oi->ospf->oiflist,oinode,oinnode,out_if)){if(out_if==NULL)break;if((IPV4_ADD
R_SAME(&out_if->address->u.prefix4,&lsa->data->id))&&(!(IPV4_ADDR_SAME(&oi->ospf
->router_id,&lsa->data->adv_router)))){if(out_if->network_lsa_self){ospf_lsa_flu
sh_area(lsa,out_if->area);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_lsa_discard()i
nospf_ls_upd()point9:lsa%pType-%d",(void*)lsa,(int)lsa->data->type);ospf_lsa_dis
card(lsa);Flag=1;}break;}}if(Flag)continue;}/*(5)FindtheinstanceofthisLSAthatisc
urrentlycontainedintherouter'slinkstatedatabase.Ifthereisnodatabasecopy,ortherec
eivedLSAismorerecentthanthedatabasecopythefollowingstepsmustbeperformed.(Thesubs
tepsfromRFC2328section13step(5)willbeperformedinospf_flood())*/if(current==NULL|
|(ret=ospf_lsa_more_recent(current,lsa))<0){/*Actualfloodingprocedure.*/if(ospf_
flood(oi->ospf,nbr,current,lsa)<0)/*TrapNSSAlater.*/DISCARD_LSA(lsa,4);continue;
}/*(6)Else,IfthereisaninstanceoftheLSAonthesendingneighbor'sLinkstaterequestlist
,anerrorhasoccurredintheDatabaseExchangeprocess.Inthiscase,restarttheDatabaseExc
hangeprocessbygeneratingtheneighboreventBadLSReqforthesendingneighborandstopproc
essingtheLinkStateUpdatepacket.*/if(ospf_ls_request_lookup(nbr,lsa)){OSPF_NSM_EV
ENT_SCHEDULE(nbr,NSM_BadLSReq);zlog_warn("LSA[%s]instanceexistsonLinkstatereques
tlist",dump_lsa_key(lsa));/*CleanlistofLSAs.*/ospf_upd_list_clean(lsas);/*thisls
aisnotonlsaslistalready.*/ospf_lsa_discard(lsa);return;}/*IfthereceivedLSAisthes
ameinstanceasthedatabasecopy(i.e.,neitheroneismorerecent)thefollowingtwostepssho
uldbeperformed:*/if(ret==0){/*IftheLSAislistedintheLinkstateretransmissionlistfo
rthereceivingadjacency,therouteritselfisexpectinganacknowledgmentforthisLSA.Ther
outershouldtreatthereceivedLSAasanacknowledgmentbyremovingtheLSAfromtheLinkstate
retransmissionlist.Thisistermedan"impliedacknowledgment".*/ls_ret=ospf_ls_retran
smit_lookup(nbr,lsa);if(ls_ret!=NULL){ospf_ls_retransmit_delete(nbr,ls_ret);/*De
layedacknowledgmentsentifadvertisementreceivedfromDesignatedRouter,otherwisedono
thing.*/if(oi->state==ISM_Backup)if(NBR_IS_DR(nbr))listnode_add(oi->ls_ack,ospf_
lsa_lock(lsa));DISCARD_LSA(lsa,5);}else/*AcknowledgethereceiptoftheLSAbysendinga
LinkStateAcknowledgmentpacketbackoutthereceivinginterface.*/{ospf_ls_ack_send(nb
r,lsa);DISCARD_LSA(lsa,6);}}/*Thedatabasecopyismorerecent.IfthedatabasecopyhasLS
ageequaltoMaxAgeandLSsequencenumberequaltoMaxSequenceNumber,simplydiscardtherece
ivedLSAwithoutacknowledgingit.(Inthiscase,theLSA'sLSsequencenumberiswrapping,and
theMaxSequenceNumberLSAmustbecompletelyflushedbeforeanynewLSAinstancecanbeintrod
uced).*/elseif(ret>0)/*Databasecopyismorerecent*/{if(IS_LSA_MAXAGE(current)&&cur
rent->data->ls_seqnum==htonl(OSPF_MAX_SEQUENCE_NUMBER)){DISCARD_LSA(lsa,7);}/*Ot
herwise,aslongasthedatabasecopyhasnotbeensentinaLinkStateUpdatewithinthelastMinL
SArrivalseconds,sendthedatabasecopybacktothesendingneighbor,encapsulatedwithinaL
inkStateUpdatePacket.TheLinkStateUpdatePacketshouldbesentdirectlytotheneighbor.I
nsodoing,donotputthedatabasecopyoftheLSAontheneighbor'slinkstateretransmissionli
st,anddonotacknowledgethereceived(lessrecent)LSAinstance.*/else{if(monotime_sinc
e(&current->tv_orig,NULL)>=ospf->min_ls_arrival*1000LL)/*TrapNSSAtypelater.*/osp
f_ls_upd_send_lsa(nbr,current,OSPF_SEND_PACKET_DIRECT);DISCARD_LSA(lsa,8);}}}#un
defDISCARD_LSAassert(listcount(lsas)==0);list_delete_and_null(&lsas);}/*OSPFLink
StateAcknowledgmentmessageread--RFC2328Section13.7.*/staticvoidospf_ls_ack(struc
tip*iph,structospf_header*ospfh,structstream*s,structospf_interface*oi,uint16_ts
ize){structospf_neighbor*nbr;/*incrementstatistics.*/oi->ls_ack_in++;nbr=ospf_nb
r_lookup(oi,iph,ospfh);if(nbr==NULL){zlog_warn("LinkStateAcknowledgment:UnknownN
eighbor%s.",inet_ntoa(ospfh->router_id));return;}/*Addeventtothread.*/OSPF_NSM_E
VENT_SCHEDULE(nbr,NSM_PacketReceived);if(nbr->state<NSM_Exchange){if(IS_DEBUG_OS
PF(nsm,NSM_EVENTS))zlog_debug("LinkStateAcknowledgment:""Neighbor[%s]state%sisle
ssthanExchange",inet_ntoa(ospfh->router_id),lookup_msg(ospf_nsm_state_msg,nbr->s
tate,NULL));return;}while(size>=OSPF_LSA_HEADER_SIZE){structospf_lsa*lsa,*lsr;ls
a=ospf_lsa_new();lsa->data=(structlsa_header*)stream_pnt(s);lsa->vrf_id=oi->ospf
->vrf_id;/*lsah=(structlsa_header*)stream_pnt(s);*/size-=OSPF_LSA_HEADER_SIZE;st
ream_forward_getp(s,OSPF_LSA_HEADER_SIZE);if(lsa->data->type<OSPF_MIN_LSA||lsa->
data->type>=OSPF_MAX_LSA){lsa->data=NULL;ospf_lsa_discard(lsa);continue;}lsr=osp
f_ls_retransmit_lookup(nbr,lsa);if(lsr!=NULL&&ospf_lsa_more_recent(lsr,lsa)==0)o
spf_ls_retransmit_delete(nbr,lsr);lsa->data=NULL;ospf_lsa_discard(lsa);}return;}
staticstructstream*ospf_recv_packet(structospf*ospf,intfd,structinterface**ifp,s
tructstream*ibuf){intret;structip*iph;uint16_tip_len;ifindex_tifindex=0;structio
veciov;/*Headeranddatabothrequirealignment.*/charbuff[CMSG_SPACE(SOPT_SIZE_CMSG_
IFINDEX_IPV4())];structmsghdrmsgh;memset(&msgh,0,sizeof(structmsghdr));msgh.msg_
iov=&iov;msgh.msg_iovlen=1;msgh.msg_control=(caddr_t)buff;msgh.msg_controllen=si
zeof(buff);ret=stream_recvmsg(ibuf,fd,&msgh,0,OSPF_MAX_PACKET_SIZE+1);if(ret<0){
zlog_warn("stream_recvmsgfailed:%s",safe_strerror(errno));returnNULL;}if((unsign
edint)ret<sizeof(iph))/*retmustbe>0now*/{zlog_warn("ospf_recv_packet:discardingr
untpacketoflength%d""(ipheadersizeis%u)",ret,(unsignedint)sizeof(iph));returnNUL
L;}/*Notethatthereshouldnotbealignmentproblemswiththisassignmentbecausethisisatt
hebeginningofthestreamdatabuffer.*/iph=(structip*)STREAM_DATA(ibuf);sockopt_iphd
rincl_swab_systoh(iph);ip_len=iph->ip_len;#if!defined(GNU_LINUX)&&(OpenBSD<20031
1)&&(__FreeBSD_version<1000000)/**KernelnetworkcodetouchesincomingIPheaderparame
ters,*beforeprotocolspecificprocessing.**1)Convertbyteordertohostrepresentation.
*-->ip_len,ip_id,ip_off**2)Adjustip_lentostripIPheadersize!*-->Ifuserprocessrece
ivesentireIPpacketviaRAW*socket,itmustconsideraddingIPheadersizeto*the"ip_len"fi
eldof"ip"structure.**Formoredetails,see<netinet/ip_input.c>.*/ip_len=ip_len+(iph
->ip_hl<<2);#endif#ifdefined(__DragonFly__)/**inDragonFly'srawsocket,ip_len/ip_o
ffareread*innetworkbyteorder.*AsOpenBSD<200311adjustip_lentostripIPheadersize!*/
ip_len=ntohs(iph->ip_len)+(iph->ip_hl<<2);#endififindex=getsockopt_ifindex(AF_IN
ET,&msgh);*ifp=if_lookup_by_index(ifindex,ospf->vrf_id);if(ret!=ip_len){zlog_war
n("ospf_recv_packetreadlengthmismatch:ip_lenis%d,""butrecvmsgreturned%d",ip_len,
ret);returnNULL;}returnibuf;}staticstructospf_interface*ospf_associate_packet_vl
(structospf*ospf,structinterface*ifp,structip*iph,structospf_header*ospfh){struc
tospf_interface*rcv_oi;structospf_vl_data*vl_data;structospf_area*vl_area;struct
listnode*node;if(IN_MULTICAST(ntohl(iph->ip_dst.s_addr))||!OSPF_IS_AREA_BACKBONE
(ospfh))returnNULL;/*lookforlocalOSPFinterfacematchingthedestination*todetermine
AreaID.Wepresumethereforethedestinationaddress*isunique,oratleast(for"unnumbered
"links),notusedinother*areas*/if((rcv_oi=ospf_if_lookup_by_local_addr(ospf,NULL,
iph->ip_dst))==NULL)returnNULL;for(ALL_LIST_ELEMENTS_RO(ospf->vlinks,node,vl_dat
a)){vl_area=ospf_area_lookup_by_area_id(ospf,vl_data->vl_area_id);if(!vl_area)co
ntinue;if(OSPF_AREA_SAME(&vl_area,&rcv_oi->area)&&IPV4_ADDR_SAME(&vl_data->vl_pe
er,&ospfh->router_id)){if(IS_DEBUG_OSPF_EVENT)zlog_debug("associatingpacketwith%
s",IF_NAME(vl_data->vl_oi));if(!CHECK_FLAG(vl_data->vl_oi->ifp->flags,IFF_UP)){i
f(IS_DEBUG_OSPF_EVENT)zlog_debug("ThisVLisnotupyet,sorry");returnNULL;}returnvl_
data->vl_oi;}}if(IS_DEBUG_OSPF_EVENT)zlog_debug("couldn'tfindanyVLtoassociatethe
packetwith");returnNULL;}staticintospf_check_area_id(structospf_interface*oi,str
uctospf_header*ospfh){/*CheckmatchtheAreaIDofthereceivinginterface.*/if(OSPF_ARE
A_SAME(&oi->area,&ospfh))return1;return0;}/*UnboundsocketwillacceptanyRawIPpacke
tsifprotoismatched.Topreventit,comparesrcIPaddressandi/faddresswithmaskingi/fnet
workmask.*/staticintospf_check_network_mask(structospf_interface*oi,structin_add
rip_src){structin_addrmask,me,him;if(oi->type==OSPF_IFTYPE_POINTOPOINT||oi->type
==OSPF_IFTYPE_VIRTUALLINK)return1;masklen2ip(oi->address->prefixlen,&mask);me.s_
addr=oi->address->u.prefix4.s_addr&mask.s_addr;him.s_addr=ip_src.s_addr&mask.s_a
ddr;if(IPV4_ADDR_SAME(&me,&him))return1;return0;}/*Return1,ifthepacketisproperly
authenticatedandchecksummed,0otherwise.Inparticular,checkthatAuTypeheaderfieldis
validandmatchesthelocallyconfiguredAuType,andthatD.5requirementsaremet.*/statici
ntospf_check_auth(structospf_interface*oi,structospf_header*ospfh){structcrypt_k
ey*ck;uint16_tiface_auth_type;uint16_tpkt_auth_type=ntohs(ospfh->auth_type);swit
ch(pkt_auth_type){caseOSPF_AUTH_NULL:/*RFC2328D.5.1*/if(OSPF_AUTH_NULL!=(iface_a
uth_type=ospf_auth_type(oi))){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_w
arn("interface%s:auth-typemismatch,local%s,rcvdNull",IF_NAME(oi),lookup_msg(ospf
_auth_type_str,iface_auth_type,NULL));return0;}if(!ospf_check_sum(ospfh)){if(IS_
DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_warn("interface%s:NullauthOK,butcheck
sumerror,Router-ID%s",IF_NAME(oi),inet_ntoa(ospfh->router_id));return0;}return1;
caseOSPF_AUTH_SIMPLE:/*RFC2328D.5.2*/if(OSPF_AUTH_SIMPLE!=(iface_auth_type=ospf_
auth_type(oi))){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_warn("interface
%s:auth-typemismatch,local%s,rcvdSimple",IF_NAME(oi),lookup_msg(ospf_auth_type_s
tr,iface_auth_type,NULL));return0;}if(memcmp(OSPF_IF_PARAM(oi,auth_simple),ospfh
->u.auth_data,OSPF_AUTH_SIMPLE_SIZE)){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV
))zlog_warn("interface%s:Simpleauthfailed",IF_NAME(oi));return0;}if(!ospf_check_
sum(ospfh)){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_warn("interface%s:S
impleauthOK,checksumerror,Router-ID%s",IF_NAME(oi),inet_ntoa(ospfh->router_id));
return0;}return1;caseOSPF_AUTH_CRYPTOGRAPHIC:/*RFC2328D.5.3*/if(OSPF_AUTH_CRYPTO
GRAPHIC!=(iface_auth_type=ospf_auth_type(oi))){if(IS_DEBUG_OSPF_PACKET(ospfh->ty
pe-1,RECV))zlog_warn("interface%s:auth-typemismatch,local%s,rcvdCryptographic",I
F_NAME(oi),lookup_msg(ospf_auth_type_str,iface_auth_type,NULL));return0;}if(ospf
h->checksum){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_warn("interface%s:
OSPFheaderchecksumisnot0",IF_NAME(oi));return0;}/*onlyMD5cryptomethodcanpassospf
_packet_examin()*/if(NULL==(ck=listgetdata(listtail(OSPF_IF_PARAM(oi,auth_crypt)
)))||ospfh->u.crypt.key_id!=ck->key_id||/*ConditionaboveusesthelastkeyIDonthelis
t,whichisdifferentfromwhatospf_crypt_key_lookup()does.Abug?*/!ospf_check_md5_dig
est(oi,ospfh)){if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV))zlog_warn("interface%
s:MD5authfailed",IF_NAME(oi));return0;}return1;default:if(IS_DEBUG_OSPF_PACKET(o
spfh->type-1,RECV))zlog_warn("interface%s:invalidpacketauth-type(%02x)",IF_NAME(
oi),pkt_auth_type);return0;}}staticintospf_check_sum(structospf_header*ospfh){ui
nt32_tret;uint16_tsum;/*clearauth_dataforchecksum.*/memset(ospfh->u.auth_data,0,
OSPF_AUTH_SIMPLE_SIZE);/*keepchecksumandclear.*/sum=ospfh->checksum;memset(&ospf
h->checksum,0,sizeof(uint16_t));/*calculatechecksum.*/ret=in_cksum(ospfh,ntohs(o
spfh->length));if(ret!=sum){zlog_info("ospf_check_sum():checksummismatch,my%X,hi
s%X",ret,sum);return0;}return1;}/*Verify,thatgivenlink/TOSrecordsareproperlysize
d/alignedandmatchRouter-LSA"#links"and"#TOS"fieldsasspecifiedinRFC2328A.4.2.*/st
aticunsignedospf_router_lsa_links_examin(structrouter_lsa_link*link,uint16_tlink
bytes,constuint16_tnum_links){unsignedcounted_links=0,thislinklen;while(linkbyte
s){thislinklen=OSPF_ROUTER_LSA_LINK_SIZE+4*link->m[0].tos_count;if(thislinklen>l
inkbytes){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:lengtherrorinlinkblock#
%u",__func__,counted_links);returnMSG_NG;}link=(structrouter_lsa_link*)((caddr_t
)link+thislinklen);linkbytes-=thislinklen;counted_links++;}if(counted_links!=num
_links){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:%ulinkblocksdeclared,%upr
esent",__func__,num_links,counted_links);returnMSG_NG;}returnMSG_OK;}/*Verify,th
atthegivenLSAisproperlysized/aligned(includingtype-specificminimumlengthconstrai
nt).*/staticunsignedospf_lsa_examin(structlsa_header*lsah,constuint16_tlsalen,co
nstuint8_theaderonly){unsignedret;structrouter_lsa*rlsa;if(lsah->type<OSPF_MAX_L
SA&&ospf_lsa_minlen[lsah->type]&&lsalen<OSPF_LSA_HEADER_SIZE+ospf_lsa_minlen[lsa
h->type]){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:undersized(%uB)%s",__fu
nc__,lsalen,lookup_msg(ospf_lsa_type_msg,lsah->type,NULL));returnMSG_NG;}switch(
lsah->type){caseOSPF_ROUTER_LSA:/*RFC2328A.4.2,LSAheader+4bytesfollowedbyN>=1*(1
2+)-bytelinkblocks*/if(headeronly){ret=(lsalen-OSPF_LSA_HEADER_SIZE-OSPF_ROUTER_
LSA_MIN_SIZE)%4?MSG_NG:MSG_OK;break;}rlsa=(structrouter_lsa*)lsah;ret=ospf_route
r_lsa_links_examin((structrouter_lsa_link*)rlsa->link,lsalen-OSPF_LSA_HEADER_SIZ
E-4,/*skip:basicheader,"flags",0,"#links"*/ntohs(rlsa->links)/*16bits*/);break;c
aseOSPF_AS_EXTERNAL_LSA:/*RFC2328A.4.5,LSAheader+4bytesfollowedbyN>=112-byteslon
g*blocks*/caseOSPF_AS_NSSA_LSA:/*RFC3101C,idem*/ret=(lsalen-OSPF_LSA_HEADER_SIZE
-OSPF_AS_EXTERNAL_LSA_MIN_SIZE)%12?MSG_NG:MSG_OK;break;/*FollowingLSAtypesarecon
sideredOKlength-wiseassoonastheir*minimum*lengthconstraintismetandlengthofthewho
leLSAisamultipleof*4*(basicLSAheadersizeisalreadyamultipleof4).*/caseOSPF_NETWOR
K_LSA:/*RFC2328A.4.3,LSAheader+4bytesfollowedbyN>=1router-IDs*/caseOSPF_SUMMARY_
LSA:caseOSPF_ASBR_SUMMARY_LSA:/*RFC2328A.4.4,LSAheader+4bytesfollowedbyN>=14-byt
esTOS*blocks*/caseOSPF_OPAQUE_LINK_LSA:caseOSPF_OPAQUE_AREA_LSA:caseOSPF_OPAQUE_
AS_LSA:/*RFC5250A.2,"somenumberofoctets(ofapplication-specific*data)paddedto32-b
italignment."Thisisconsidered*equivalent*to4-bytealignmentofallotherLSAtypes,see
*OSPF-ALIGNMENT.txt*fileforthedetailedanalysisofthispassage.*/ret=lsalen%4?MSG_N
G:MSG_OK;break;default:if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:unsupporte
dLSAtype0x%02x",__func__,lsah->type);returnMSG_NG;}if(ret!=MSG_OK&&IS_DEBUG_OSPF
_PACKET(0,RECV))zlog_debug("%s:alignmenterrorin%s",__func__,lookup_msg(ospf_lsa_
type_msg,lsah->type,NULL));returnret;}/*Verifyiftheprovidedinputbufferisavalidse
quenceofLSAs.ThisincludesverificationofLSAblockslength/alignmentanddispatchingof
deeper-levelchecks.*/staticunsignedospf_lsaseq_examin(structlsa_header*lsah,/*st
artofbuffereddata*/size_tlength,constuint8_theaderonly,/*Whendeclared_num_lsasis
not0,compareittotherealnumberofLSAsandtreatthedifferenceasanerror.*/constuint32_
tdeclared_num_lsas){uint32_tcounted_lsas=0;while(length){uint16_tlsalen;if(lengt
h<OSPF_LSA_HEADER_SIZE){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:undersize
d(%zuB)trailing(#%u)LSAheader",__func__,length,counted_lsas);returnMSG_NG;}/*sav
eonntohs()callshereandintheLSAvalidator*/lsalen=ntohs(lsah->length);if(lsalen<OS
PF_LSA_HEADER_SIZE){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:malformedLSAh
eader#%u,declaredlengthis%uB",__func__,counted_lsas,lsalen);returnMSG_NG;}if(hea
deronly){/*lesscheckshereandinospf_lsa_examin()*/if(MSG_OK!=ospf_lsa_examin(lsah
,lsalen,1)){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:malformedheader-onlyL
SA#%u",__func__,counted_lsas);returnMSG_NG;}lsah=(structlsa_header*)((caddr_t)ls
ah+OSPF_LSA_HEADER_SIZE);length-=OSPF_LSA_HEADER_SIZE;}else{/*makesuretheinputbu
fferisdeepenoughbefore*furtherchecks*/if(lsalen>length){if(IS_DEBUG_OSPF_PACKET(
0,RECV))zlog_debug("%s:anomalyinLSA#%u:declaredlengthis%uB,bufferedlengthis%zuB"
,__func__,counted_lsas,lsalen,length);returnMSG_NG;}if(MSG_OK!=ospf_lsa_examin(l
sah,lsalen,0)){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:malformedLSA#%u",_
_func__,counted_lsas);returnMSG_NG;}lsah=(structlsa_header*)((caddr_t)lsah+lsale
n);length-=lsalen;}counted_lsas++;}if(declared_num_lsas&&counted_lsas!=declared_
num_lsas){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:#LSAsdeclared(%u)doesno
tmatchactual(%u)",__func__,declared_num_lsas,counted_lsas);returnMSG_NG;}returnM
SG_OK;}/*VerifyacompleteOSPFpacketforpropersizing/alignment.*/staticunsignedospf
_packet_examin(structospf_header*oh,constunsignedbytesonwire){uint16_tbytesdecla
red,bytesauth;unsignedret;structospf_ls_update*lsupd;/*Length,1stapproximation.*
/if(bytesonwire<OSPF_HEADER_SIZE){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s
:undersized(%uB)packet",__func__,bytesonwire);returnMSG_NG;}/*Nowitissafetoacces
sheaderfields.Performinglengthcheck,*allow*forpossibleextrabytesofcryptoauth/pad
ding,whicharenot*counted*intheOSPFheader"length"field.*/if(oh->version!=OSPF_VER
SION){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:invalid(%u)protocolversion"
,__func__,oh->version);returnMSG_NG;}bytesdeclared=ntohs(oh->length);if(ntohs(oh
->auth_type)!=OSPF_AUTH_CRYPTOGRAPHIC)bytesauth=0;else{if(oh->u.crypt.auth_data_
len!=OSPF_AUTH_MD5_SIZE){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:unsuppor
tedcryptoauthlength(%uB)",__func__,oh->u.crypt.auth_data_len);returnMSG_NG;}byte
sauth=OSPF_AUTH_MD5_SIZE;}if(bytesdeclared+bytesauth>bytesonwire){if(IS_DEBUG_OS
PF_PACKET(0,RECV))zlog_debug("%s:packetlengtherror(%ureal,%u+%udeclared)",__func
__,bytesonwire,bytesdeclared,bytesauth);returnMSG_NG;}/*Length,2ndapproximation.
Thetype-specificconstraintischeckedagainstdeclaredlength,notamountofbytesonwire.
*/if(oh->type>=OSPF_MSG_HELLO&&oh->type<=OSPF_MSG_LS_ACK&&bytesdeclared<OSPF_HEA
DER_SIZE+ospf_packet_minlen[oh->type]){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debu
g("%s:undersized(%uB)%spacket",__func__,bytesdeclared,lookup_msg(ospf_packet_typ
e_str,oh->type,NULL));returnMSG_NG;}switch(oh->type){caseOSPF_MSG_HELLO:/*RFC232
8A.3.2,packetheader+OSPF_HELLO_MIN_SIZEbytesfollowedbyN>=0router-IDs.*/ret=(byte
sdeclared-OSPF_HEADER_SIZE-OSPF_HELLO_MIN_SIZE)%4?MSG_NG:MSG_OK;break;caseOSPF_M
SG_DB_DESC:/*RFC2328A.3.3,packetheader+OSPF_DB_DESC_MIN_SIZEbytesfollowedbyN>=0h
eader-onlyLSAs.*/ret=ospf_lsaseq_examin((structlsa_header*)((caddr_t)oh+OSPF_HEA
DER_SIZE+OSPF_DB_DESC_MIN_SIZE),bytesdeclared-OSPF_HEADER_SIZE-OSPF_DB_DESC_MIN_
SIZE,1,/*header-onlyLSAs*/0);break;caseOSPF_MSG_LS_REQ:/*RFC2328A.3.4,packethead
erfollowedbyN>=012-bytes*requestblocks.*/ret=(bytesdeclared-OSPF_HEADER_SIZE-OSP
F_LS_REQ_MIN_SIZE)%OSPF_LSA_KEY_SIZE?MSG_NG:MSG_OK;break;caseOSPF_MSG_LS_UPD:/*R
FC2328A.3.5,packetheader+OSPF_LS_UPD_MIN_SIZEbytesfollowedbyN>=0fullLSAs(withNde
claredbeforehand).*/lsupd=(structospf_ls_update*)((caddr_t)oh+OSPF_HEADER_SIZE);
ret=ospf_lsaseq_examin((structlsa_header*)((caddr_t)lsupd+OSPF_LS_UPD_MIN_SIZE),
bytesdeclared-OSPF_HEADER_SIZE-OSPF_LS_UPD_MIN_SIZE,0,/*fullLSAs*/ntohl(lsupd->n
um_lsas)/*32bits*/);break;caseOSPF_MSG_LS_ACK:/*RFC2328A.3.6,packetheaderfollowe
dbyN>=0header-only*LSAs.*/ret=ospf_lsaseq_examin((structlsa_header*)((caddr_t)oh
+OSPF_HEADER_SIZE+OSPF_LS_ACK_MIN_SIZE),bytesdeclared-OSPF_HEADER_SIZE-OSPF_LS_A
CK_MIN_SIZE,1,/*header-onlyLSAs*/0);break;default:if(IS_DEBUG_OSPF_PACKET(0,RECV
))zlog_debug("%s:invalidpackettype0x%02x",__func__,oh->type);returnMSG_NG;}if(re
t!=MSG_OK&&IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("%s:malformed%spacket",__func
__,lookup_msg(ospf_packet_type_str,oh->type,NULL));returnret;}/*OSPFHeaderverifi
cation.*/staticintospf_verify_header(structstream*ibuf,structospf_interface*oi,s
tructip*iph,structospf_header*ospfh){/*CheckAreaID.*/if(!ospf_check_area_id(oi,o
spfh)){zlog_warn("interface%s:ospf_readinvalidAreaID%s.",IF_NAME(oi),inet_ntoa(o
spfh->area_id));return-1;}/*Checknetworkmask,Silentlydiscarded.*/if(!ospf_check_
network_mask(oi,iph->ip_src)){zlog_warn("interface%s:ospf_readnetworkaddressisno
tsame[%s]",IF_NAME(oi),inet_ntoa(iph->ip_src));return-1;}/*Checkauthentication.T
hefunctionhandlesloggingactions,where*required.*/if(!ospf_check_auth(oi,ospfh))r
eturn-1;return0;}/*Startingpointofpacketprocessfunction.*/intospf_read(structthr
ead*thread){intret;structstream*ibuf;structospf*ospf;structospf_interface*oi;str
uctip*iph;structospf_header*ospfh;uint16_tlength;structinterface*ifp=NULL;struct
connected*c;/*firstofallgetinterfacepointer.*/ospf=THREAD_ARG(thread);/*preparef
ornextpacket.*/ospf->t_read=NULL;thread_add_read(master,ospf_read,ospf,ospf->fd,
&ospf->t_read);stream_reset(ospf->ibuf);ibuf=ospf_recv_packet(ospf,ospf->fd,&ifp
,ospf->ibuf);if(ibuf==NULL)return-1;/*ThisrawpacketisknowntobeatleastasbigasitsI
Pheader.*//*Notethatthereshouldnotbealignmentproblemswiththisassignmentbecauseth
isisatthebeginningofthestreamdatabuffer.*/iph=(structip*)STREAM_DATA(ibuf);/*Not
ethatsockopt_iphdrincl_swab_systohwascalledin*ospf_recv_packet.*/if(ifp==NULL){/
*Handlecaseswheretheplatformdoesnotsupportretrievingtheifindex,andalsoplatforms(
suchasSolaris8)thatclaimtosupportifindexretrievalbutdonot.*/c=if_lookup_address(
(void*)&iph->ip_src,AF_INET,ospf->vrf_id);if(c)ifp=c->ifp;if(ifp==NULL)return0;}
/*IPHeaderdump.*/if(IS_DEBUG_OSPF_PACKET(0,RECV))ospf_ip_header_dump(iph);/*Self
-originatedpacketshouldbediscardedsilently.*/if(ospf_if_lookup_by_local_addr(osp
f,NULL,iph->ip_src)){if(IS_DEBUG_OSPF_PACKET(0,RECV)){zlog_debug("ospf_read[%s]:
Droppingself-originatedpacket",inet_ntoa(iph->ip_src));}return0;}/*AdvancefromIP
headertoOSPFheader(iph->ip_hlhasbeenverifiedbyospf_recv_packet()tobecorrect).*/s
tream_forward_getp(ibuf,iph->ip_hl*4);ospfh=(structospf_header*)stream_pnt(ibuf)
;if(MSG_OK!=ospf_packet_examin(ospfh,stream_get_endp(ibuf)-stream_get_getp(ibuf)
))return-1;/*NowitissafetoaccessallfieldsofOSPFpacketheader.*//*associatepacketw
ithospfinterface*/oi=ospf_if_lookup_recv_if(ospf,iph->ip_src,ifp);/*ospf_verify_
header()reliesonavalid"oi"andthuscanbecalledonlyafterthepassive/backbone/otherch
ecksbelowarepassed.Thesechecksinturnaccessthefieldsofunverified"ospfh"structuref
ortheirownpurposesandmustremainveryaccurateindoingthis.*//*Ifincominginterfaceis
passiveone,ignoreit.*/if(oi&&OSPF_IF_PASSIVE_STATUS(oi)==OSPF_IF_PASSIVE){charbu
f[3][INET_ADDRSTRLEN];if(IS_DEBUG_OSPF_EVENT)zlog_debug("ignoringpacketfromroute
r%ssentto%s,""receivedonapassiveinterface,%s",inet_ntop(AF_INET,&ospfh->router_i
d,buf[0],sizeof(buf[0])),inet_ntop(AF_INET,&iph->ip_dst,buf[1],sizeof(buf[1])),i
net_ntop(AF_INET,&oi->address->u.prefix4,buf[2],sizeof(buf[2])));if(iph->ip_dst.
s_addr==htonl(OSPF_ALLSPFROUTERS)){/*Trytofixmulticastmembership.*SomeOS:esmayha
veproblemsinthisarea,*makesureitisremoved.*/OI_MEMBER_JOINED(oi,MEMBER_ALLROUTER
S);ospf_if_set_multicast(oi);}return0;}/*ifnolocalospf_interface,*orheaderareais
backbonebutospf_interfaceisnot*checkforVLINKinterface*/if((oi==NULL)||(OSPF_IS_A
REA_ID_BACKBONE(ospfh->area_id)&&!OSPF_IS_AREA_ID_BACKBONE(oi->area->area_id))){
if((oi=ospf_associate_packet_vl(ospf,ifp,iph,ospfh))==NULL){if(!ospf->instance&&
IS_DEBUG_OSPF_EVENT)zlog_debug("Packetfrom[%s]receivedonlink%s""butnoospf_interf
ace",inet_ntoa(iph->ip_src),ifp->name);return0;}}/*elseitmustbealocalospfinterfa
ce,checkitwasreceivedon*correctlink*/elseif(oi->ifp!=ifp){if(IS_DEBUG_OSPF_EVENT
)zlog_warn("Packetfrom[%s]receivedonwronglink%s",inet_ntoa(iph->ip_src),ifp->nam
e);return0;}elseif(oi->state==ISM_Down){charbuf[2][INET_ADDRSTRLEN];zlog_warn("I
gnoringpacketfrom%sto%sreceivedoninterfacethatis""down[%s];interfaceflagsare%s",
inet_ntop(AF_INET,&iph->ip_src,buf[0],sizeof(buf[0])),inet_ntop(AF_INET,&iph->ip
_dst,buf[1],sizeof(buf[1])),ifp->name,if_flag_dump(ifp->flags));/*Fixmulticastme
mberships?*/if(iph->ip_dst.s_addr==htonl(OSPF_ALLSPFROUTERS))OI_MEMBER_JOINED(oi
,MEMBER_ALLROUTERS);elseif(iph->ip_dst.s_addr==htonl(OSPF_ALLDROUTERS))OI_MEMBER
_JOINED(oi,MEMBER_DROUTERS);if(oi->multicast_memberships)ospf_if_set_multicast(o
i);return0;}/**IfthereceivedpacketisdestinedforAllDRouters,thepacket*shouldbeacc
eptedonlyifthereceivedospfinterfacestateis*eitherDRorBackup--endo.*/if(iph->ip_d
st.s_addr==htonl(OSPF_ALLDROUTERS)&&(oi->state!=ISM_DR&&oi->state!=ISM_Backup)){
zlog_warn("DroppingpacketforAllDRoutersfrom[%s]via[%s](ISM:%s)",inet_ntoa(iph->i
p_src),IF_NAME(oi),lookup_msg(ospf_ism_state_msg,oi->state,NULL));/*Trytofixmult
icastmembership.*/SET_FLAG(oi->multicast_memberships,MEMBER_DROUTERS);ospf_if_se
t_multicast(oi);return0;}/*VerifymoreOSPFheaderfields.*/ret=ospf_verify_header(i
buf,oi,iph,ospfh);if(ret<0){if(IS_DEBUG_OSPF_PACKET(0,RECV))zlog_debug("ospf_rea
d[%s]:Headercheckfailed,""dropping.",inet_ntoa(iph->ip_src));returnret;}/*Showde
bugreceivingpacket.*/if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,RECV)){if(IS_DEBUG_OS
PF_PACKET(ospfh->type-1,DETAIL)){zlog_debug("-----------------------------------
------------------");ospf_packet_dump(ibuf);}zlog_debug("%sreceivedfrom[%s]via[%
s]",lookup_msg(ospf_packet_type_str,ospfh->type,NULL),inet_ntoa(ospfh->router_id
),IF_NAME(oi));zlog_debug("src[%s],",inet_ntoa(iph->ip_src));zlog_debug("dst[%s]
",inet_ntoa(iph->ip_dst));if(IS_DEBUG_OSPF_PACKET(ospfh->type-1,DETAIL))zlog_deb
ug("-----------------------------------------------------");}stream_forward_getp
(ibuf,OSPF_HEADER_SIZE);/*Adjustsizetomessagelength.*/length=ntohs(ospfh->length
)-OSPF_HEADER_SIZE;/*Readrestofthepacketandcalleachsortofpacketroutine.*/switch(
ospfh->type){caseOSPF_MSG_HELLO:ospf_hello(iph,ospfh,ibuf,oi,length);break;caseO
SPF_MSG_DB_DESC:ospf_db_desc(iph,ospfh,ibuf,oi,length);break;caseOSPF_MSG_LS_REQ
:ospf_ls_req(iph,ospfh,ibuf,oi,length);break;caseOSPF_MSG_LS_UPD:ospf_ls_upd(osp
f,iph,ospfh,ibuf,oi,length);break;caseOSPF_MSG_LS_ACK:ospf_ls_ack(iph,ospfh,ibuf
,oi,length);break;default:zlog_warn("interface%s:OSPFpacketheadertype%disillegal
",IF_NAME(oi),ospfh->type);break;}return0;}/*MakeOSPFheader.*/staticvoidospf_mak
e_header(inttype,structospf_interface*oi,structstream*s){structospf_header*ospfh
;ospfh=(structospf_header*)STREAM_DATA(s);ospfh->version=(uint8_t)OSPF_VERSION;o
spfh->type=(uint8_t)type;ospfh->router_id=oi->ospf->router_id;ospfh->checksum=0;
ospfh->area_id=oi->area->area_id;ospfh->auth_type=htons(ospf_auth_type(oi));mems
et(ospfh->u.auth_data,0,OSPF_AUTH_SIMPLE_SIZE);stream_forward_endp(s,OSPF_HEADER
_SIZE);}/*MakeAuthenticationData.*/staticintospf_make_auth(structospf_interface*
oi,structospf_header*ospfh){structcrypt_key*ck;switch(ospf_auth_type(oi)){caseOS
PF_AUTH_NULL:/*memset(ospfh->u.auth_data,0,sizeof(ospfh->u.auth_data));*/break;c
aseOSPF_AUTH_SIMPLE:memcpy(ospfh->u.auth_data,OSPF_IF_PARAM(oi,auth_simple),OSPF
_AUTH_SIMPLE_SIZE);break;caseOSPF_AUTH_CRYPTOGRAPHIC:/*Ifkeyisnotset,thenset0.*/
if(list_isempty(OSPF_IF_PARAM(oi,auth_crypt))){ospfh->u.crypt.zero=0;ospfh->u.cr
ypt.key_id=0;ospfh->u.crypt.auth_data_len=OSPF_AUTH_MD5_SIZE;}else{ck=listgetdat
a(listtail(OSPF_IF_PARAM(oi,auth_crypt)));ospfh->u.crypt.zero=0;ospfh->u.crypt.k
ey_id=ck->key_id;ospfh->u.crypt.auth_data_len=OSPF_AUTH_MD5_SIZE;}/*note:theseqi
sdoneinospf_make_md5_digest()*/break;default:/*memset(ospfh->u.auth_data,0,sizeo
f(ospfh->u.auth_data));*/break;}return0;}/*FillrestofOSPFheader.*/staticvoidospf
_fill_header(structospf_interface*oi,structstream*s,uint16_tlength){structospf_h
eader*ospfh;ospfh=(structospf_header*)STREAM_DATA(s);/*Filllength.*/ospfh->lengt
h=htons(length);/*Calculatechecksum.*/if(ntohs(ospfh->auth_type)!=OSPF_AUTH_CRYP
TOGRAPHIC)ospfh->checksum=in_cksum(ospfh,length);elseospfh->checksum=0;/*AddAuth
enticationData.*/ospf_make_auth(oi,ospfh);}staticintospf_make_hello(structospf_i
nterface*oi,structstream*s){structospf_neighbor*nbr;structroute_node*rn;uint16_t
length=OSPF_HELLO_MIN_SIZE;structin_addrmask;unsignedlongp;intflag=0;/*Setnetmas
kofinterface.*/if(!(CHECK_FLAG(oi->connected->flags,ZEBRA_IFA_UNNUMBERED)&&oi->t
ype==OSPF_IFTYPE_POINTOPOINT)&&oi->type!=OSPF_IFTYPE_VIRTUALLINK)masklen2ip(oi->
address->prefixlen,&mask);elsememset((char*)&mask,0,sizeof(structin_addr));strea
m_put_ipv4(s,mask.s_addr);/*SetHelloInterval.*/if(OSPF_IF_PARAM(oi,fast_hello)==
0)stream_putw(s,OSPF_IF_PARAM(oi,v_hello));elsestream_putw(s,0);/*hello-interval
of0forfast-hellos*/if(IS_DEBUG_OSPF_EVENT)zlog_debug("make_hello:options:%x,int:
%s",OPTIONS(oi),IF_NAME(oi));/*SetOptions.*/stream_putc(s,OPTIONS(oi));/*SetRout
erPriority.*/stream_putc(s,PRIORITY(oi));/*SetRouterDeadInterval.*/stream_putl(s
,OSPF_IF_PARAM(oi,v_wait));/*SetDesignatedRouter.*/stream_put_ipv4(s,DR(oi).s_ad
dr);p=stream_get_endp(s);/*SetBackupDesignatedRouter.*/stream_put_ipv4(s,BDR(oi)
.s_addr);/*Addneighborseen.*/for(rn=route_top(oi->nbrs);rn;rn=route_next(rn))if(
(nbr=rn->info))if(nbr->router_id.s_addr!=0)/*Ignore0.0.0.0node.*/if(nbr->state!=
NSM_Attempt)/*IgnoreDownneighbor.*/if(nbr->state!=NSM_Down)/*ThisismyselfforDRel
ection.*/if(!IPV4_ADDR_SAME(&nbr->router_id,&oi->ospf->router_id)){/*Checkneighb
oris*sane?*/if(nbr->d_router.s_addr!=0&&IPV4_ADDR_SAME(&nbr->d_router,&oi->addre
ss->u.prefix4)&&IPV4_ADDR_SAME(&nbr->bd_router,&oi->address->u.prefix4))flag=1;s
tream_put_ipv4(s,nbr->router_id.s_addr);length+=4;}/*LetneighborgenerateBackupSe
en.*/if(flag==1)stream_putl_at(s,p,0);/*ipv4address,normally*/returnlength;}stat
icintospf_make_db_desc(structospf_interface*oi,structospf_neighbor*nbr,structstr
eam*s){structospf_lsa*lsa;uint16_tlength=OSPF_DB_DESC_MIN_SIZE;uint8_toptions;un
signedlongpp;inti;structospf_lsdb*lsdb;/*SetInterfaceMTU.*/if(oi->type==OSPF_IFT
YPE_VIRTUALLINK)stream_putw(s,0);elsestream_putw(s,oi->ifp->mtu);/*SetOptions.*/
options=OPTIONS(oi);if(CHECK_FLAG(oi->ospf->config,OSPF_OPAQUE_CAPABLE))SET_FLAG
(options,OSPF_OPTION_O);stream_putc(s,options);/*DDflags*/pp=stream_get_endp(s);
stream_putc(s,nbr->dd_flags);/*SetDDSequenceNumber.*/stream_putl(s,nbr->dd_seqnu
m);/*shortcutunneededwalkof(empty)summaryLSDBs*/if(ospf_db_summary_isempty(nbr))
gotoempty;/*DescribeLSAHeaderfromDatabaseSummaryList.*/lsdb=&nbr->db_sum;for(i=O
SPF_MIN_LSA;i<OSPF_MAX_LSA;i++){structroute_table*table=lsdb->type[i].db;structr
oute_node*rn;for(rn=route_top(table);rn;rn=route_next(rn))if((lsa=rn->info)!=NUL
L){if(IS_OPAQUE_LSA(lsa->data->type)&&(!CHECK_FLAG(options,OSPF_OPTION_O))){/*Su
ppressadvertising*opaque-informations.*//*RemoveLSAfromDBsummarylist.*/ospf_lsdb
_delete(lsdb,lsa);continue;}if(!CHECK_FLAG(lsa->flags,OSPF_LSA_DISCARD)){structl
sa_header*lsah;uint16_tls_age;/*DDpacketoverflowsinterfaceMTU.*/if(length+OSPF_L
SA_HEADER_SIZE>ospf_packet_max(oi))break;/*KeeppointertoLSage.*/lsah=(structlsa_
header*)(STREAM_DATA(s)+stream_get_endp(s));/*Proceedstreampointer.*/stream_put(
s,lsa->data,OSPF_LSA_HEADER_SIZE);length+=OSPF_LSA_HEADER_SIZE;/*SetLSage.*/ls_a
ge=LS_AGE(lsa);lsah->ls_age=htons(ls_age);}/*RemoveLSAfromDBsummarylist.*/ospf_l
sdb_delete(lsdb,lsa);}}/*Update'More'bit*/if(ospf_db_summary_isempty(nbr)){empty
:if(nbr->state>=NSM_Exchange){UNSET_FLAG(nbr->dd_flags,OSPF_DD_FLAG_M);/*Rewrite
DDflags*/stream_putc_at(s,pp,nbr->dd_flags);}else{assert(IS_SET_DD_M(nbr->dd_fla
gs));}}returnlength;}staticintospf_make_ls_req_func(structstream*s,uint16_t*leng
th,unsignedlongdelta,structospf_neighbor*nbr,structospf_lsa*lsa){structospf_inte
rface*oi;oi=nbr->oi;/*LSRequestpacketoverflowsinterfaceMTU.*/if(*length+delta>os
pf_packet_max(oi))return0;stream_putl(s,lsa->data->type);stream_put_ipv4(s,lsa->
data->id.s_addr);stream_put_ipv4(s,lsa->data->adv_router.s_addr);ospf_lsa_unlock
(&nbr->ls_req_last);nbr->ls_req_last=ospf_lsa_lock(lsa);*length+=12;return1;}sta
ticintospf_make_ls_req(structospf_neighbor*nbr,structstream*s){structospf_lsa*ls
a;uint16_tlength=OSPF_LS_REQ_MIN_SIZE;unsignedlongdelta=stream_get_endp(s)+12;st
ructroute_table*table;structroute_node*rn;inti;structospf_lsdb*lsdb;lsdb=&nbr->l
s_req;for(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++){table=lsdb->type[i].db;for(rn=route
_top(table);rn;rn=route_next(rn))if((lsa=(rn->info))!=NULL)if(ospf_make_ls_req_f
unc(s,&length,delta,nbr,lsa)==0){route_unlock_node(rn);break;}}returnlength;}sta
ticintls_age_increment(structospf_lsa*lsa,intdelay){intage;age=IS_LSA_MAXAGE(lsa
)?OSPF_LSA_MAXAGE:LS_AGE(lsa)+delay;return(age>OSPF_LSA_MAXAGE?OSPF_LSA_MAXAGE:a
ge);}staticintospf_make_ls_upd(structospf_interface*oi,structlist*update,structs
tream*s){structospf_lsa*lsa;structlistnode*node;uint16_tlength=0;unsignedintsize
_noauth;unsignedlongdelta=stream_get_endp(s);unsignedlongpp;intcount=0;if(IS_DEB
UG_OSPF_EVENT)zlog_debug("ospf_make_ls_upd:Start");pp=stream_get_endp(s);stream_
forward_endp(s,OSPF_LS_UPD_MIN_SIZE);length+=OSPF_LS_UPD_MIN_SIZE;/*Calculateamo
untofpacketusablefordata.*/size_noauth=stream_get_size(s)-ospf_packet_authspace(
oi);while((node=listhead(update))!=NULL){structlsa_header*lsah;uint16_tls_age;if
(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_make_ls_upd:ListIteration%d",count);lsa=li
stgetdata(node);assert(lsa->data);/*Willitfit?*/if(length+delta+ntohs(lsa->data-
>length)>size_noauth)break;/*KeeppointertoLSage.*/lsah=(structlsa_header*)(STREA
M_DATA(s)+stream_get_endp(s));/*PutLSAtoLinkStateRequest.*/stream_put(s,lsa->dat
a,ntohs(lsa->data->length));/*SetLSage.*//*eachhopmustincrementanlsa_agebytransm
it_delayofOSPFinterface*/ls_age=ls_age_increment(lsa,OSPF_IF_PARAM(oi,transmit_d
elay));lsah->ls_age=htons(ls_age);length+=ntohs(lsa->data->length);count++;list_
delete_node(update,node);ospf_lsa_unlock(&lsa);/*oi->ls_upd_queue*/}/*Nowset#LSA
s.*/stream_putl_at(s,pp,count);if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_make_ls_u
pd:Stop");returnlength;}staticintospf_make_ls_ack(structospf_interface*oi,struct
list*ack,structstream*s){structlistnode*node,*nnode;uint16_tlength=OSPF_LS_ACK_M
IN_SIZE;unsignedlongdelta=stream_get_endp(s)+24;structospf_lsa*lsa;for(ALL_LIST_
ELEMENTS(ack,node,nnode,lsa)){assert(lsa);if(length+delta>ospf_packet_max(oi))br
eak;stream_put(s,lsa->data,OSPF_LSA_HEADER_SIZE);length+=OSPF_LSA_HEADER_SIZE;li
stnode_delete(ack,lsa);ospf_lsa_unlock(&lsa);/*oi->ls_ack_direct.ls_ack*/}return
length;}staticvoidospf_hello_send_sub(structospf_interface*oi,in_addr_taddr){str
uctospf_packet*op;uint16_tlength=OSPF_HEADER_SIZE;op=ospf_packet_new(oi->ifp->mt
u);/*PrepareOSPFcommonheader.*/ospf_make_header(OSPF_MSG_HELLO,oi,op->s);/*Prepa
reOSPFHellobody.*/length+=ospf_make_hello(oi,op->s);/*FillOSPFheader.*/ospf_fill
_header(oi,op->s,length);/*Setpacketlength.*/op->length=length;op->dst.s_addr=ad
dr;if(IS_DEBUG_OSPF_EVENT){if(oi->ospf->vrf_id)zlog_debug("%s:HelloTxinterface%s
ospfvrf%sid%u",__PRETTY_FUNCTION__,oi->ifp->name,ospf_vrf_id_to_name(oi->ospf->v
rf_id),oi->ospf->vrf_id);}/*Addpackettothetopoftheinterfaceoutputqueue,sothatthe
y*can'tgetdelayedbythingslikelongqueuesofLSUpdatepackets*/ospf_packet_add_top(oi
,op);/*Hookthreadtowritepacket.*/OSPF_ISM_WRITE_ON(oi->ospf);}staticvoidospf_pol
l_send(structospf_nbr_nbma*nbr_nbma){structospf_interface*oi;oi=nbr_nbma->oi;ass
ert(oi);/*Ifthisispassiveinterface,donotsendOSPFHello.*/if(OSPF_IF_PASSIVE_STATU
S(oi)==OSPF_IF_PASSIVE)return;if(oi->type!=OSPF_IFTYPE_NBMA)return;if(nbr_nbma->
nbr!=NULL&&nbr_nbma->nbr->state!=NSM_Down)return;if(PRIORITY(oi)==0)return;if(nb
r_nbma->priority==0&&oi->state!=ISM_DR&&oi->state!=ISM_Backup)return;ospf_hello_
send_sub(oi,nbr_nbma->addr.s_addr);}intospf_poll_timer(structthread*thread){stru
ctospf_nbr_nbma*nbr_nbma;nbr_nbma=THREAD_ARG(thread);nbr_nbma->t_poll=NULL;if(IS
_DEBUG_OSPF(nsm,NSM_TIMERS))zlog_debug("NSM[%s:%s]:Timer(Polltimerexpire)",IF_NA
ME(nbr_nbma->oi),inet_ntoa(nbr_nbma->addr));ospf_poll_send(nbr_nbma);if(nbr_nbma
->v_poll>0)OSPF_POLL_TIMER_ON(nbr_nbma->t_poll,ospf_poll_timer,nbr_nbma->v_poll)
;return0;}intospf_hello_reply_timer(structthread*thread){structospf_neighbor*nbr
;nbr=THREAD_ARG(thread);nbr->t_hello_reply=NULL;assert(nbr->oi);if(IS_DEBUG_OSPF
(nsm,NSM_TIMERS))zlog_debug("NSM[%s:%s]:Timer(hello-replytimerexpire)",IF_NAME(n
br->oi),inet_ntoa(nbr->router_id));ospf_hello_send_sub(nbr->oi,nbr->address.u.pr
efix4.s_addr);return0;}/*SendOSPFHello.*/voidospf_hello_send(structospf_interfac
e*oi){/*Ifthisispassiveinterface,donotsendOSPFHello.*/if(OSPF_IF_PASSIVE_STATUS(
oi)==OSPF_IF_PASSIVE)return;if(oi->type==OSPF_IFTYPE_NBMA){structospf_neighbor*n
br;structroute_node*rn;for(rn=route_top(oi->nbrs);rn;rn=route_next(rn))if((nbr=r
n->info))if(nbr!=oi->nbr_self)if(nbr->state!=NSM_Down){/*RFC2328Section9.5.1Ifth
erouterisnoteligibletobecomeDesignatedRouter,itmustperiodicallysendHelloPacketst
oboththeDesignatedRouterandtheBackupDesignatedRouter(iftheyexist).*/if(PRIORITY(
oi)==0&&IPV4_ADDR_CMP(&DR(oi),&nbr->address.u.prefix4)&&IPV4_ADDR_CMP(&BDR(oi),&
nbr->address.u.prefix4))continue;/*IftherouteriseligibletobecomeDesignatedRouter
,itmustperiodicallysendHelloPacketstoallneighborsthatarealsoeligible.Inaddition,
iftherouterisitselftheDesignatedRouterorBackupDesignatedRouter,itmustalsosendper
iodicHelloPacketstoallotherneighbors.*/if(nbr->priority==0&&oi->state==ISM_DROth
er)continue;/*ifoi->state==Waiting,send*hellotoallneighbors*/ospf_hello_send_sub
(oi,nbr->address.u.prefix4.s_addr);}}else{/*Decidedestinationaddress.*/if(oi->ty
pe==OSPF_IFTYPE_VIRTUALLINK)ospf_hello_send_sub(oi,oi->vl_data->peer_addr.s_addr
);elseospf_hello_send_sub(oi,htonl(OSPF_ALLSPFROUTERS));}}/*SendOSPFDatabaseDesc
ription.*/voidospf_db_desc_send(structospf_neighbor*nbr){structospf_interface*oi
;structospf_packet*op;uint16_tlength=OSPF_HEADER_SIZE;oi=nbr->oi;op=ospf_packet_
new(oi->ifp->mtu);/*PrepareOSPFcommonheader.*/ospf_make_header(OSPF_MSG_DB_DESC,
oi,op->s);/*PrepareOSPFDatabaseDescriptionbody.*/length+=ospf_make_db_desc(oi,nb
r,op->s);/*FillOSPFheader.*/ospf_fill_header(oi,op->s,length);/*Setpacketlength.
*/op->length=length;/*Decidedestinationaddress.*/if(oi->type==OSPF_IFTYPE_POINTO
POINT)op->dst.s_addr=htonl(OSPF_ALLSPFROUTERS);elseop->dst=nbr->address.u.prefix
4;/*Addpackettotheinterfaceoutputqueue.*/ospf_packet_add(oi,op);/*Hookthreadtowr
itepacket.*/OSPF_ISM_WRITE_ON(oi->ospf);/*RemoveoldDDpacket,thencopynewoneandkee
pinneighbor*structure.*/if(nbr->last_send)ospf_packet_free(nbr->last_send);nbr->
last_send=ospf_packet_dup(op);monotime(&nbr->last_send_ts);}/*Re-sendDatabaseDes
cription.*/voidospf_db_desc_resend(structospf_neighbor*nbr){structospf_interface
*oi;oi=nbr->oi;/*Addpackettotheinterfaceoutputqueue.*/ospf_packet_add(oi,ospf_pa
cket_dup(nbr->last_send));/*Hookthreadtowritepacket.*/OSPF_ISM_WRITE_ON(oi->ospf
);}/*SendLinkStateRequest.*/voidospf_ls_req_send(structospf_neighbor*nbr){struct
ospf_interface*oi;structospf_packet*op;uint16_tlength=OSPF_HEADER_SIZE;oi=nbr->o
i;op=ospf_packet_new(oi->ifp->mtu);/*PrepareOSPFcommonheader.*/ospf_make_header(
OSPF_MSG_LS_REQ,oi,op->s);/*PrepareOSPFLinkStateRequestbody.*/length+=ospf_make_
ls_req(nbr,op->s);if(length==OSPF_HEADER_SIZE){ospf_packet_free(op);return;}/*Fi
llOSPFheader.*/ospf_fill_header(oi,op->s,length);/*Setpacketlength.*/op->length=
length;/*Decidedestinationaddress.*/if(oi->type==OSPF_IFTYPE_POINTOPOINT)op->dst
.s_addr=htonl(OSPF_ALLSPFROUTERS);elseop->dst=nbr->address.u.prefix4;/*Addpacket
totheinterfaceoutputqueue.*/ospf_packet_add(oi,op);/*Hookthreadtowritepacket.*/O
SPF_ISM_WRITE_ON(oi->ospf);/*AddLinkStateRequestRetransmissionTimer.*/OSPF_NSM_T
IMER_ON(nbr->t_ls_req,ospf_ls_req_timer,nbr->v_ls_req);}/*SendLinkStateUpdatewit
hanLSA.*/voidospf_ls_upd_send_lsa(structospf_neighbor*nbr,structospf_lsa*lsa,int
flag){structlist*update;update=list_new();listnode_add(update,lsa);/*ospfinstanc
eisgoingdown,sendselforiginated*MAXAGELSAupdatetoneighborstoremovefromLSDB*/if(n
br->oi->ospf->inst_shutdown&&IS_LSA_MAXAGE(lsa))ospf_ls_upd_send(nbr,update,flag
,1);elseospf_ls_upd_send(nbr,update,flag,0);list_delete_and_null(&update);}/*Det
erminesizeforpacket.Mustbeatleastbigenoughtoaccomodatenext*LSAonlist,whichmaybeb
iggerthanMTUsize.**Returnpointertonewospf_packet*NULLifwecannotallocate,egbecaus
eLSAisbiggerthanimposedlimit*onpacketsizes(inwhichcaseoffendingLSAisdeletedfromu
pdatelist)*/staticstructospf_packet*ospf_ls_upd_packet_new(structlist*update,str
uctospf_interface*oi){structospf_lsa*lsa;structlistnode*ln;size_tsize;staticchar
warned=0;lsa=listgetdata((ln=listhead(update)));assert(lsa->data);if((OSPF_LS_UP
D_MIN_SIZE+ntohs(lsa->data->length))>ospf_packet_max(oi)){if(!warned){zlog_warn(
"ospf_ls_upd_packet_new:oversizedLSAencountered!""willneedtofragment.Notoptimal.
Trydivideup""yournetworkwithareas.Use'debugospfpacketsend'""toseedetails,orlooka
t'showipospfdatabase..'");warned=1;}if(IS_DEBUG_OSPF_PACKET(0,SEND))zlog_debug("
ospf_ls_upd_packet_new:oversizedLSAid:%s,""%dbytesoriginatedby%s,willbefragmente
d!",inet_ntoa(lsa->data->id),ntohs(lsa->data->length),inet_ntoa(lsa->data->adv_r
outer));/**AllocatejustenoughtofitthisLSAonly,toavoidincluding*other*LSAsinfragm
entedLSAUpdates.*/size=ntohs(lsa->data->length)+(oi->ifp->mtu-ospf_packet_max(oi
))+OSPF_LS_UPD_MIN_SIZE;}elsesize=oi->ifp->mtu;if(size>OSPF_MAX_PACKET_SIZE){zlo
g_warn("ospf_ls_upd_packet_new:oversizedLSAid:%stoobig,""%dbytes,packetsize%ld,d
roppingitcompletely.""OSPFroutingisbroken!",inet_ntoa(lsa->data->id),ntohs(lsa->
data->length),(longint)size);list_delete_node(update,ln);returnNULL;}/*IPheaderi
sbuiltupseparatelybyospf_write().Thismeans,thatwe*must*reducethe"affordable"size
justcalculatedbylengthofanIP*header.*Thismakessure,thatevenifwemanagetofillthepa
yloadwithLSA*data*completely,thefinalpacket(ourdataplusIPheader)stillfits*into*o
utgoinginterfaceMTU.Thiscorrectionisn'treallymeaningfulfor*an*oversizedLSA,butfo
rconsistencythecorrectionisdoneforboth*cases.**P.S.OSPF_MAX_PACKET_SIZEabovealre
adyincludesIPheadersize*/returnospf_packet_new(size-sizeof(structip));}staticvoi
dospf_ls_upd_queue_send(structospf_interface*oi,structlist*update,structin_addra
ddr,intsend_lsupd_now){structospf_packet*op;uint16_tlength=OSPF_HEADER_SIZE;if(I
S_DEBUG_OSPF_EVENT)zlog_debug("listcount=%d,[%s]dst%s",listcount(update),IF_NAME
(oi),inet_ntoa(addr));/*Checkthatwehavereallysomethingtoprocess*/if(listcount(up
date)==0)return;op=ospf_ls_upd_packet_new(update,oi);/*PrepareOSPFcommonheader.*
/ospf_make_header(OSPF_MSG_LS_UPD,oi,op->s);/*PrepareOSPFLinkStateUpdatebody.*In
cludesType-7translation.*/length+=ospf_make_ls_upd(oi,update,op->s);/*FillOSPFhe
ader.*/ospf_fill_header(oi,op->s,length);/*Setpacketlength.*/op->length=length;/
*Decidedestinationaddress.*/if(oi->type==OSPF_IFTYPE_POINTOPOINT)op->dst.s_addr=
htonl(OSPF_ALLSPFROUTERS);elseop->dst.s_addr=addr.s_addr;/*Addpackettotheinterfa
ceoutputqueue.*/ospf_packet_add(oi,op);/*Callospf_write()rightawaytosendospfpack
etstoneighbors*/if(send_lsupd_now){structthreados_packet_thd;os_packet_thd.arg=(
void*)oi->ospf;if(oi->on_write_q==0){listnode_add(oi->ospf->oi_write_q,oi);oi->o
n_write_q=1;}ospf_write(&os_packet_thd);}else{/*Hookthreadtowritepacket.*/OSPF_I
SM_WRITE_ON(oi->ospf);}}staticintospf_ls_upd_send_queue_event(structthread*threa
d){structospf_interface*oi=THREAD_ARG(thread);structroute_node*rn;structroute_no
de*rnext;structlist*update;charagain=0;oi->t_ls_upd_event=NULL;if(IS_DEBUG_OSPF_
EVENT)zlog_debug("ospf_ls_upd_send_queuestart");for(rn=route_top(oi->ls_upd_queu
e);rn;rn=rnext){rnext=route_next(rn);if(rn->info==NULL)continue;update=(structli
st*)rn->info;ospf_ls_upd_queue_send(oi,update,rn->p.u.prefix4,0);/*listmightnotb
eempty.*/if(listcount(update)==0){list_delete_and_null((structlist**)&rn->info);
route_unlock_node(rn);}elseagain=1;}if(again!=0){if(IS_DEBUG_OSPF_EVENT)zlog_deb
ug("ospf_ls_upd_send_queue:updatelistsnotcleared,""%dnodestotryagain,raisingnewe
vent",again);oi->t_ls_upd_event=NULL;thread_add_event(master,ospf_ls_upd_send_qu
eue_event,oi,0,&oi->t_ls_upd_event);}if(IS_DEBUG_OSPF_EVENT)zlog_debug("ospf_ls_
upd_send_queuestop");return0;}voidospf_ls_upd_send(structospf_neighbor*nbr,struc
tlist*update,intflag,intsend_lsupd_now){structospf_interface*oi;structospf_lsa*l
sa;structprefix_ipv4p;structroute_node*rn;structlistnode*node;oi=nbr->oi;p.famil
y=AF_INET;p.prefixlen=IPV4_MAX_BITLEN;/*Decidedestinationaddress.*/if(oi->type==
OSPF_IFTYPE_VIRTUALLINK)p.prefix=oi->vl_data->peer_addr;elseif(oi->type==OSPF_IF
TYPE_POINTOPOINT)p.prefix.s_addr=htonl(OSPF_ALLSPFROUTERS);elseif(flag==OSPF_SEN
D_PACKET_DIRECT)p.prefix=nbr->address.u.prefix4;elseif(oi->state==ISM_DR||oi->st
ate==ISM_Backup)p.prefix.s_addr=htonl(OSPF_ALLSPFROUTERS);elseif(oi->type==OSPF_
IFTYPE_POINTOMULTIPOINT)p.prefix.s_addr=htonl(OSPF_ALLSPFROUTERS);elsep.prefix.s
_addr=htonl(OSPF_ALLDROUTERS);if(oi->type==OSPF_IFTYPE_NBMA){if(flag==OSPF_SEND_
PACKET_INDIRECT)zlog_warn("*LS-UpdateisdirectlysentonNBMAnetwork.");if(IPV4_ADDR
_SAME(&oi->address->u.prefix4,&p.prefix))zlog_warn("*LS-Updateissenttomyself.");
}rn=route_node_get(oi->ls_upd_queue,(structprefix*)&p);if(rn->info==NULL)rn->inf
o=list_new();elseroute_unlock_node(rn);for(ALL_LIST_ELEMENTS_RO(update,node,lsa)
)listnode_add(rn->info,ospf_lsa_lock(lsa));/*oi->ls_upd_queue*/if(send_lsupd_now
){structlist*send_update_list;structroute_node*rn,*rnext;for(rn=route_top(oi->ls
_upd_queue);rn;rn=rnext){rnext=route_next(rn);if(rn->info==NULL)continue;send_up
date_list=(structlist*)rn->info;ospf_ls_upd_queue_send(oi,send_update_list,rn->p
.u.prefix4,1);}}elsethread_add_event(master,ospf_ls_upd_send_queue_event,oi,0,&o
i->t_ls_upd_event);}staticvoidospf_ls_ack_send_list(structospf_interface*oi,stru
ctlist*ack,structin_addrdst){structospf_packet*op;uint16_tlength=OSPF_HEADER_SIZ
E;op=ospf_packet_new(oi->ifp->mtu);/*PrepareOSPFcommonheader.*/ospf_make_header(
OSPF_MSG_LS_ACK,oi,op->s);/*PrepareOSPFLinkStateAcknowledgmentbody.*/length+=osp
f_make_ls_ack(oi,ack,op->s);/*FillOSPFheader.*/ospf_fill_header(oi,op->s,length)
;/*Setpacketlength.*/op->length=length;/*Decidedestinationaddress.*/if(oi->type=
=OSPF_IFTYPE_POINTOPOINT)op->dst.s_addr=htonl(OSPF_ALLSPFROUTERS);elseop->dst.s_
addr=dst.s_addr;/*Addpackettotheinterfaceoutputqueue.*/ospf_packet_add(oi,op);/*
Hookthreadtowritepacket.*/OSPF_ISM_WRITE_ON(oi->ospf);}staticintospf_ls_ack_send
_event(structthread*thread){structospf_interface*oi=THREAD_ARG(thread);oi->t_ls_
ack_direct=NULL;while(listcount(oi->ls_ack_direct.ls_ack))ospf_ls_ack_send_list(
oi,oi->ls_ack_direct.ls_ack,oi->ls_ack_direct.dst);return0;}voidospf_ls_ack_send
(structospf_neighbor*nbr,structospf_lsa*lsa){structospf_interface*oi=nbr->oi;if(
listcount(oi->ls_ack_direct.ls_ack)==0)oi->ls_ack_direct.dst=nbr->address.u.pref
ix4;listnode_add(oi->ls_ack_direct.ls_ack,ospf_lsa_lock(lsa));thread_add_event(m
aster,ospf_ls_ack_send_event,oi,0,&oi->t_ls_ack_direct);}/*SendLinkStateAcknowle
dgmentdelayed.*/voidospf_ls_ack_send_delayed(structospf_interface*oi){structin_a
ddrdst;/*Decidedestinationaddress.*//*RFC2328Section13.5Onnon-broadcastnetworks,
delayedLinkStateAcknowledgmentpacketsmustbeunicastseparatelyovereachadjacency(i.
e.,neighborwhosestateis>=Exchange).*/if(oi->type==OSPF_IFTYPE_NBMA){structospf_n
eighbor*nbr;structroute_node*rn;for(rn=route_top(oi->nbrs);rn;rn=route_next(rn))
if((nbr=rn->info)!=NULL)if(nbr!=oi->nbr_self&&nbr->state>=NSM_Exchange)while(lis
tcount(oi->ls_ack))ospf_ls_ack_send_list(oi,oi->ls_ack,nbr->address.u.prefix4);r
eturn;}if(oi->type==OSPF_IFTYPE_VIRTUALLINK)dst.s_addr=oi->vl_data->peer_addr.s_
addr;elseif(oi->state==ISM_DR||oi->state==ISM_Backup)dst.s_addr=htonl(OSPF_ALLSP
FROUTERS);elseif(oi->type==OSPF_IFTYPE_POINTOPOINT)dst.s_addr=htonl(OSPF_ALLSPFR
OUTERS);elseif(oi->type==OSPF_IFTYPE_POINTOMULTIPOINT)dst.s_addr=htonl(OSPF_ALLS
PFROUTERS);elsedst.s_addr=htonl(OSPF_ALLDROUTERS);while(listcount(oi->ls_ack))os
pf_ls_ack_send_list(oi,oi->ls_ack,dst);}/**Onpt-to-ptlinks,allOSPFcontrolpackets
aresenttothemulticast*address.Asaresult,thekerneldoesnotneedtolearntheinterface*
MACoftheOSPFneighbor.However,inourworld,thiswilldelay*convergence.Takethecasewhe
nduetoalinkflap,allroutesnow*wanttouseaninterfacewhichwasdeemedtobecostlierprior
tothis*event.Forroutesthatwillbeinstalled,themissingMACwillhave*punt-to-CPUseton
them.ThismayoverloadtheCPUcontrolpaththat*canbeavoidediftheMACwasknownapriori.*/
#defineOSPF_PING_NBR_STR_MAX(BUFSIZ)voidospf_proactively_arp(structospf_neighbor
*nbr){charping_nbr[OSPF_PING_NBR_STR_MAX];intret;if(!nbr||!nbr->oi||!nbr->oi->if
p)return;snprintf(ping_nbr,sizeof(ping_nbr),"ping-c1-I%s%s>/dev/null2>&1&",nbr->
oi->ifp->name,inet_ntoa(nbr->address.u.prefix4));ret=system(ping_nbr);if(IS_DEBU
G_OSPF_EVENT)zlog_debug("Executed%s%s",ping_nbr,((ret==0)?"successfully":"butfai
led"));}