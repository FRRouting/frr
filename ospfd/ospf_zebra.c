/**ZebraconnectlibraryforOSPFd*Copyright(C)1997,98,99,2000KunihiroIshiguro,Toshi
akiTakada**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributei
tand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSo
ftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdis
tributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimplied
warrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublic
Licenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicenseal
ong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,In
c.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"thr
ead.h"#include"command.h"#include"network.h"#include"prefix.h"#include"routemap.
h"#include"table.h"#include"stream.h"#include"memory.h"#include"zclient.h"#inclu
de"filter.h"#include"plist.h"#include"log.h"#include"lib/bfd.h"#include"nexthop.
h"#include"ospfd/ospfd.h"#include"ospfd/ospf_interface.h"#include"ospfd/ospf_ism
.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_abr
.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_dump.h"#include"ospfd/ospf_rout
e.h"#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/osp
f_nsm.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_te.h"DEFINE_MTYPE_STATIC
(OSPFD,OSPF_EXTERNAL,"OSPFExternalroutetable")DEFINE_MTYPE_STATIC(OSPFD,OSPF_RED
ISTRIBUTE,"OSPFRedistriute")DEFINE_MTYPE_STATIC(OSPFD,OSPF_DIST_ARGS,"OSPFDistri
butearguments")DEFINE_HOOK(ospf_if_update,(structinterface*ifp),(ifp))DEFINE_HOO
K(ospf_if_delete,(structinterface*ifp),(ifp))/*Zebrastructuretoholdcurrentstatus
.*/structzclient*zclient=NULL;/*Forregisteringthreads.*/externstructthread_maste
r*master;/*Router-idupdatemessagefromzebra.*/staticintospf_router_id_update_zebr
a(intcommand,structzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structospf
*ospf=NULL;structprefixrouter_id;zebra_router_id_update_read(zclient->ibuf,&rout
er_id);if(IS_DEBUG_OSPF(zebra,ZEBRA_INTERFACE)){charbuf[PREFIX2STR_BUFFER];prefi
x2str(&router_id,buf,sizeof(buf));zlog_debug("Zebrarcvd:routeridupdate%svrf%sid%
u",buf,ospf_vrf_id_to_name(vrf_id),vrf_id);}ospf=ospf_lookup_by_vrf_id(vrf_id);i
f(ospf!=NULL){ospf->router_id_zebra=router_id.u.prefix4;ospf_router_id_update(os
pf);}else{if(IS_DEBUG_OSPF_EVENT){charbuf[PREFIX2STR_BUFFER];prefix2str(&router_
id,buf,sizeof(buf));zlog_debug("%s:ospfinstancenotfoundforvrf%sid%urouter_id%s",
__PRETTY_FUNCTION__,ospf_vrf_id_to_name(vrf_id),vrf_id,buf);}}return0;}/*Intefac
eadditionmessagefromzebra.*/staticintospf_interface_add(intcommand,structzclient
*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp=NULL;structospf*
ospf=NULL;ifp=zebra_interface_add_read(zclient->ibuf,vrf_id);if(ifp==NULL)return
0;if(IS_DEBUG_OSPF(zebra,ZEBRA_INTERFACE))zlog_debug("Zebra:interfaceadd%svrf%s[
%u]index%dflags%llxmetric%dmtu%d",ifp->name,ospf_vrf_id_to_name(ifp->vrf_id),ifp
->vrf_id,ifp->ifindex,(unsignedlonglong)ifp->flags,ifp->metric,ifp->mtu);assert(
ifp->info);if(!OSPF_IF_PARAM_CONFIGURED(IF_DEF_PARAMS(ifp),type)){SET_IF_PARAM(I
F_DEF_PARAMS(ifp),type);IF_DEF_PARAMS(ifp)->type=ospf_default_iftype(ifp);}ospf=
ospf_lookup_by_vrf_id(vrf_id);if(!ospf)return0;ospf_if_update(ospf,ifp);hook_cal
l(ospf_if_update,ifp);return0;}staticintospf_interface_delete(intcommand,structz
client*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structstre
am*s;structroute_node*rn;s=zclient->ibuf;/*zebra_interface_state_read()updatesin
terfacestructureiniflist*/ifp=zebra_interface_state_read(s,vrf_id);if(ifp==NULL)
return0;if(if_is_up(ifp))zlog_warn("Zebra:gotdeleteof%s,butinterfaceisstillup",i
fp->name);if(IS_DEBUG_OSPF(zebra,ZEBRA_INTERFACE))zlog_debug("Zebra:interfacedel
ete%svrf%s[%u]index%dflags%llxmetric%dmtu%d",ifp->name,ospf_vrf_id_to_name(ifp->
vrf_id),ifp->vrf_id,ifp->ifindex,(unsignedlonglong)ifp->flags,ifp->metric,ifp->m
tu);hook_call(ospf_if_delete,ifp);for(rn=route_top(IF_OIFS(ifp));rn;rn=route_nex
t(rn))if(rn->info)ospf_if_free((structospf_interface*)rn->info);if_set_index(ifp
,IFINDEX_INTERNAL);return0;}staticstructinterface*zebra_interface_if_lookup(stru
ctstream*s,vrf_id_tvrf_id){charifname_tmp[INTERFACE_NAMSIZ];/*Readinterfacename.
*/stream_get(ifname_tmp,s,INTERFACE_NAMSIZ);/*Andlookitup.*/returnif_lookup_by_n
ame(ifname_tmp,vrf_id);}staticintospf_interface_state_up(intcommand,structzclien
t*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;structospf_inte
rface*oi;structroute_node*rn;ifp=zebra_interface_if_lookup(zclient->ibuf,vrf_id)
;if(ifp==NULL)return0;/*Interfaceisalreadyup.*/if(if_is_operative(ifp)){/*Tempor
arilykeepifpvalues.*/structinterfaceif_tmp;memcpy(&if_tmp,ifp,sizeof(structinter
face));zebra_interface_if_set_value(zclient->ibuf,ifp);if(IS_DEBUG_OSPF(zebra,ZE
BRA_INTERFACE))zlog_debug("Zebra:Interface[%s]stateupdatespeed%u->%u,bw%d->%d",i
fp->name,if_tmp.speed,ifp->speed,if_tmp.bandwidth,ifp->bandwidth);ospf_if_recalc
ulate_output_cost(ifp);if(if_tmp.mtu!=ifp->mtu){if(IS_DEBUG_OSPF(zebra,ZEBRA_INT
ERFACE))zlog_debug("Zebra:Interface[%s]MTUchange%u->%u.",ifp->name,if_tmp.mtu,if
p->mtu);/*Mustresettheinterface(simulatedown/up)whenMTU*changes.*/ospf_if_reset(
ifp);}return0;}zebra_interface_if_set_value(zclient->ibuf,ifp);if(IS_DEBUG_OSPF(
zebra,ZEBRA_INTERFACE))zlog_debug("Zebra:Interface[%s]statechangetoup.",ifp->nam
e);for(rn=route_top(IF_OIFS(ifp));rn;rn=route_next(rn)){if((oi=rn->info)==NULL)c
ontinue;ospf_if_up(oi);}return0;}staticintospf_interface_state_down(intcommand,s
tructzclient*zclient,zebra_size_tlength,vrf_id_tvrf_id){structinterface*ifp;stru
ctospf_interface*oi;structroute_node*node;ifp=zebra_interface_state_read(zclient
->ibuf,vrf_id);if(ifp==NULL)return0;if(IS_DEBUG_OSPF(zebra,ZEBRA_INTERFACE))zlog
_debug("Zebra:Interface[%s]statechangetodown.",ifp->name);for(node=route_top(IF_
OIFS(ifp));node;node=route_next(node)){if((oi=node->info)==NULL)continue;ospf_if
_down(oi);}return0;}staticintospf_interface_address_add(intcommand,structzclient
*zclient,zebra_size_tlength,vrf_id_tvrf_id){structconnected*c;structospf*ospf=NU
LL;c=zebra_interface_address_read(command,zclient->ibuf,vrf_id);if(c==NULL)retur
n0;if(IS_DEBUG_OSPF(zebra,ZEBRA_INTERFACE)){charbuf[PREFIX2STR_BUFFER];prefix2st
r(c->address,buf,sizeof(buf));zlog_debug("Zebra:interface%saddressadd%svrf%sid%u
",c->ifp->name,buf,ospf_vrf_id_to_name(vrf_id),vrf_id);}ospf=ospf_lookup_by_vrf_
id(vrf_id);if(!ospf)return0;ospf_if_update(ospf,c->ifp);hook_call(ospf_if_update
,c->ifp);return0;}staticintospf_interface_address_delete(intcommand,structzclien
t*zclient,zebra_size_tlength,vrf_id_tvrf_id){structconnected*c;structinterface*i
fp;structospf_interface*oi;structroute_node*rn;structprefixp;c=zebra_interface_a
ddress_read(command,zclient->ibuf,vrf_id);if(c==NULL)return0;if(IS_DEBUG_OSPF(ze
bra,ZEBRA_INTERFACE)){charbuf[PREFIX2STR_BUFFER];prefix2str(c->address,buf,sizeo
f(buf));zlog_debug("Zebra:interface%saddressdelete%s",c->ifp->name,buf);}ifp=c->
ifp;p=*c->address;p.prefixlen=IPV4_MAX_PREFIXLEN;rn=route_node_lookup(IF_OIFS(if
p),&p);if(!rn){connected_free(c);return0;}assert(rn->info);oi=rn->info;route_unl
ock_node(rn);/*Callinterfacehookfunctionstocleanup*/ospf_if_free(oi);hook_call(o
spf_if_update,c->ifp);connected_free(c);return0;}staticintospf_interface_link_pa
rams(intcommand,structzclient*zclient,zebra_size_tlength){structinterface*ifp;if
p=zebra_interface_link_params_read(zclient->ibuf);if(ifp==NULL)return0;/*UpdateT
ETLV*/ospf_mpls_te_update_if(ifp);return0;}/*VRFupdateforaninterface.*/staticint
ospf_interface_vrf_update(intcommand,structzclient*zclient,zebra_size_tlength,vr
f_id_tvrf_id){structinterface*ifp=NULL;vrf_id_tnew_vrf_id;ifp=zebra_interface_vr
f_update_read(zclient->ibuf,vrf_id,&new_vrf_id);if(!ifp)return0;if(IS_DEBUG_OSPF
_EVENT)zlog_debug("%s:RxInterface%sVRFchangevrf_id%uNewvrf%sid%u",__PRETTY_FUNCT
ION__,ifp->name,vrf_id,ospf_vrf_id_to_name(new_vrf_id),new_vrf_id);/*if_update(i
fp,ifp->name,strlen(ifp->name),new_vrf_id);*/if_update_to_new_vrf(ifp,new_vrf_id
);return0;}voidospf_zebra_add(structospf*ospf,structprefix_ipv4*p,structospf_rou
te*or){structzapi_routeapi;structzapi_nexthop*api_nh;uint8_tdistance;structospf_
path*path;structlistnode*node;intcount=0;memset(&api,0,sizeof(api));api.vrf_id=o
spf->vrf_id;api.type=ZEBRA_ROUTE_OSPF;api.instance=ospf->instance;api.safi=SAFI_
UNICAST;memcpy(&api.prefix,p,sizeof(*p));SET_FLAG(api.message,ZAPI_MESSAGE_NEXTH
OP);/*Metricvalue.*/SET_FLAG(api.message,ZAPI_MESSAGE_METRIC);if(or->path_type==
OSPF_PATH_TYPE1_EXTERNAL)api.metric=or->cost+or->u.ext.type2_cost;elseif(or->pat
h_type==OSPF_PATH_TYPE2_EXTERNAL)api.metric=or->u.ext.type2_cost;elseapi.metric=
or->cost;/*CheckifpathtypeisASE*/if(((or->path_type==OSPF_PATH_TYPE1_EXTERNAL)||
(or->path_type==OSPF_PATH_TYPE2_EXTERNAL))&&(or->u.ext.tag>0)&&(or->u.ext.tag<=R
OUTE_TAG_MAX)){SET_FLAG(api.message,ZAPI_MESSAGE_TAG);api.tag=or->u.ext.tag;}/*D
istancevalue.*/distance=ospf_distance_apply(ospf,p,or);if(distance){SET_FLAG(api
.message,ZAPI_MESSAGE_DISTANCE);api.distance=distance;}/*Nexthop,ifindex,distanc
eandmetricinformation.*/for(ALL_LIST_ELEMENTS_RO(or->paths,node,path)){if(count>
=MULTIPATH_NUM)break;api_nh=&api.nexthops[count];#ifdefHAVE_NETLINKif(path->unnu
mbered||(path->nexthop.s_addr!=INADDR_ANY&&path->ifindex!=0)){#else/*HAVE_NETLIN
K*/if(path->nexthop.s_addr!=INADDR_ANY&&path->ifindex!=0){#endif/*HAVE_NETLINK*/
api_nh->gate.ipv4=path->nexthop;api_nh->ifindex=path->ifindex;api_nh->type=NEXTH
OP_TYPE_IPV4_IFINDEX;}elseif(path->nexthop.s_addr!=INADDR_ANY){api_nh->gate.ipv4
=path->nexthop;api_nh->type=NEXTHOP_TYPE_IPV4;}else{api_nh->ifindex=path->ifinde
x;api_nh->type=NEXTHOP_TYPE_IFINDEX;}api_nh->vrf_id=ospf->vrf_id;count++;if(IS_D
EBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE)){charbuf[2][INET_ADDRSTRLEN];zlog_debug("Zeb
ra:Routeadd%s/%dnexthop%s,ifindex=%d",inet_ntop(AF_INET,&p->prefix,buf[0],sizeof
(buf[0])),p->prefixlen,inet_ntop(AF_INET,&path->nexthop,buf[1],sizeof(buf[1])),p
ath->ifindex);}}api.nexthop_num=count;zclient_route_send(ZEBRA_ROUTE_ADD,zclient
,&api);}voidospf_zebra_delete(structospf*ospf,structprefix_ipv4*p,structospf_rou
te*or){structzapi_routeapi;memset(&api,0,sizeof(api));api.vrf_id=ospf->vrf_id;ap
i.type=ZEBRA_ROUTE_OSPF;api.instance=ospf->instance;api.safi=SAFI_UNICAST;memcpy
(&api.prefix,p,sizeof(*p));if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE)){charbuf[I
NET_ADDRSTRLEN];zlog_debug("Zebra:Routedelete%s/%d",inet_ntop(AF_INET,&p->prefix
,buf,sizeof(buf[0])),p->prefixlen);}zclient_route_send(ZEBRA_ROUTE_DELETE,zclien
t,&api);}voidospf_zebra_add_discard(structospf*ospf,structprefix_ipv4*p){structz
api_routeapi;memset(&api,0,sizeof(api));api.vrf_id=ospf->vrf_id;api.type=ZEBRA_R
OUTE_OSPF;api.instance=ospf->instance;api.safi=SAFI_UNICAST;memcpy(&api.prefix,p
,sizeof(*p));zapi_route_set_blackhole(&api,BLACKHOLE_NULL);zclient_route_send(ZE
BRA_ROUTE_ADD,zclient,&api);if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE))zlog_debu
g("Zebra:Routeadddiscard%s/%d",inet_ntoa(p->prefix),p->prefixlen);}voidospf_zebr
a_delete_discard(structospf*ospf,structprefix_ipv4*p){structzapi_routeapi;memset
(&api,0,sizeof(api));api.vrf_id=ospf->vrf_id;api.type=ZEBRA_ROUTE_OSPF;api.insta
nce=ospf->instance;api.safi=SAFI_UNICAST;memcpy(&api.prefix,p,sizeof(*p));zapi_r
oute_set_blackhole(&api,BLACKHOLE_NULL);zclient_route_send(ZEBRA_ROUTE_DELETE,zc
lient,&api);if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE))zlog_debug("Zebra:Routede
letediscard%s/%d",inet_ntoa(p->prefix),p->prefixlen);}structospf_external*ospf_e
xternal_lookup(structospf*ospf,uint8_ttype,unsignedshortinstance){structlist*ext
_list;structlistnode*node;structospf_external*ext;ext_list=ospf->external[type];
if(!ext_list)return(NULL);for(ALL_LIST_ELEMENTS_RO(ext_list,node,ext))if(ext->in
stance==instance)returnext;returnNULL;}structospf_external*ospf_external_add(str
uctospf*ospf,uint8_ttype,unsignedshortinstance){structlist*ext_list;structospf_e
xternal*ext;ext=ospf_external_lookup(ospf,type,instance);if(ext)returnext;if(!os
pf->external[type])ospf->external[type]=list_new();ext_list=ospf->external[type]
;ext=(structospf_external*)XCALLOC(MTYPE_OSPF_EXTERNAL,sizeof(structospf_externa
l));ext->instance=instance;EXTERNAL_INFO(ext)=route_table_init();listnode_add(ex
t_list,ext);returnext;}voidospf_external_del(structospf*ospf,uint8_ttype,unsigne
dshortinstance){structospf_external*ext;ext=ospf_external_lookup(ospf,type,insta
nce);if(ext){if(EXTERNAL_INFO(ext))route_table_finish(EXTERNAL_INFO(ext));listno
de_delete(ospf->external[type],ext);if(!ospf->external[type]->count)list_delete_
and_null(&ospf->external[type]);XFREE(MTYPE_OSPF_EXTERNAL,ext);}}structospf_redi
st*ospf_redist_lookup(structospf*ospf,uint8_ttype,unsignedshortinstance){structl
ist*red_list;structlistnode*node;structospf_redist*red;red_list=ospf->redist[typ
e];if(!red_list)return(NULL);for(ALL_LIST_ELEMENTS_RO(red_list,node,red))if(red-
>instance==instance)returnred;returnNULL;}structospf_redist*ospf_redist_add(stru
ctospf*ospf,uint8_ttype,unsignedshortinstance){structlist*red_list;structospf_re
dist*red;red=ospf_redist_lookup(ospf,type,instance);if(red)returnred;if(!ospf->r
edist[type])ospf->redist[type]=list_new();red_list=ospf->redist[type];red=(struc
tospf_redist*)XCALLOC(MTYPE_OSPF_REDISTRIBUTE,sizeof(structospf_redist));red->in
stance=instance;red->dmetric.type=-1;red->dmetric.value=-1;listnode_add(red_list
,red);returnred;}voidospf_redist_del(structospf*ospf,uint8_ttype,unsignedshortin
stance){structospf_redist*red;red=ospf_redist_lookup(ospf,type,instance);if(red)
{listnode_delete(ospf->redist[type],red);if(!ospf->redist[type]->count){list_del
ete_and_null(&ospf->redist[type]);}ospf_routemap_unset(red);XFREE(MTYPE_OSPF_RED
ISTRIBUTE,red);}}intospf_is_type_redistributed(structospf*ospf,inttype,unsigneds
hortinstance){return(DEFAULT_ROUTE_TYPE(type)?vrf_bitmap_check(zclient->default_
information,ospf->vrf_id):((instance&&redist_check_instance(&zclient->mi_redist[
AFI_IP][type],instance))||(!instance&&vrf_bitmap_check(zclient->redist[AFI_IP][t
ype],ospf->vrf_id))));}intospf_redistribute_set(structospf*ospf,inttype,unsigned
shortinstance,intmtype,intmvalue){intforce=0;structospf_redist*red;red=ospf_redi
st_lookup(ospf,type,instance);if(ospf_is_type_redistributed(ospf,type,instance))
{if(mtype!=red->dmetric.type){red->dmetric.type=mtype;force=LSA_REFRESH_FORCE;}i
f(mvalue!=red->dmetric.value){red->dmetric.value=mvalue;force=LSA_REFRESH_FORCE;
}ospf_external_lsa_refresh_type(ospf,type,instance,force);if(IS_DEBUG_OSPF(zebra
,ZEBRA_REDISTRIBUTE))zlog_debug("Redistribute[%s][%d]:RefreshType[%d],Metric[%d]
",ospf_redist_string(type),instance,metric_type(ospf,type,instance),metric_value
(ospf,type,instance));returnCMD_SUCCESS;}red->dmetric.type=mtype;red->dmetric.va
lue=mvalue;ospf_external_add(ospf,type,instance);zclient_redistribute(ZEBRA_REDI
STRIBUTE_ADD,zclient,AFI_IP,type,instance,ospf->vrf_id);if(IS_DEBUG_OSPF(zebra,Z
EBRA_REDISTRIBUTE))zlog_debug("Redistribute[%s][%d]vrfid%u:StartType[%d],Metric[
%d]",ospf_redist_string(type),instance,ospf->vrf_id,metric_type(ospf,type,instan
ce),metric_value(ospf,type,instance));ospf_asbr_status_update(ospf,++ospf->redis
tribute);returnCMD_SUCCESS;}intospf_redistribute_unset(structospf*ospf,inttype,u
nsignedshortinstance){if(type==zclient->redist_default&&instance==zclient->insta
nce)returnCMD_SUCCESS;if(!ospf_is_type_redistributed(ospf,type,instance))returnC
MD_SUCCESS;zclient_redistribute(ZEBRA_REDISTRIBUTE_DELETE,zclient,AFI_IP,type,in
stance,ospf->vrf_id);if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE))zlog_debug("Redi
stribute[%s][%d]vrfid%u:Stop",ospf_redist_string(type),instance,ospf->vrf_id);os
pf_redist_del(ospf,type,instance);/*RemovetheroutesfromOSPFtable.*/ospf_redistri
bute_withdraw(ospf,type,instance);ospf_external_del(ospf,type,instance);ospf_asb
r_status_update(ospf,--ospf->redistribute);returnCMD_SUCCESS;}intospf_redistribu
te_default_set(structospf*ospf,intoriginate,intmtype,intmvalue){structospf_redis
t*red;ospf->default_originate=originate;red=ospf_redist_add(ospf,DEFAULT_ROUTE,0
);red->dmetric.type=mtype;red->dmetric.value=mvalue;ospf_external_add(ospf,DEFAU
LT_ROUTE,0);if(ospf_is_type_redistributed(ospf,DEFAULT_ROUTE,0)){/*ifospf->defau
lt_originatechangesvalue,iscallingospf_external_lsa_refresh_defaultsufficienttoi
mplementthechange?*/ospf_external_lsa_refresh_default(ospf);if(IS_DEBUG_OSPF(zeb
ra,ZEBRA_REDISTRIBUTE))zlog_debug("Redistribute[%s]:RefreshType[%d],Metric[%d]",
ospf_redist_string(DEFAULT_ROUTE),metric_type(ospf,DEFAULT_ROUTE,0),metric_value
(ospf,DEFAULT_ROUTE,0));returnCMD_SUCCESS;}zclient_redistribute_default(ZEBRA_RE
DISTRIBUTE_DEFAULT_ADD,zclient,ospf->vrf_id);if(IS_DEBUG_OSPF(zebra,ZEBRA_REDIST
RIBUTE))zlog_debug("Redistribute[DEFAULT]:StartType[%d],Metric[%d]",metric_type(
ospf,DEFAULT_ROUTE,0),metric_value(ospf,DEFAULT_ROUTE,0));if(ospf->router_id.s_a
ddr==0)ospf->external_origin|=(1<<DEFAULT_ROUTE);elsethread_add_timer(master,osp
f_default_originate_timer,ospf,1,NULL);ospf_asbr_status_update(ospf,++ospf->redi
stribute);returnCMD_SUCCESS;}intospf_redistribute_default_unset(structospf*ospf)
{if(!ospf_is_type_redistributed(ospf,DEFAULT_ROUTE,0))returnCMD_SUCCESS;ospf->de
fault_originate=DEFAULT_ORIGINATE_NONE;ospf_redist_del(ospf,DEFAULT_ROUTE,0);zcl
ient_redistribute_default(ZEBRA_REDISTRIBUTE_DEFAULT_DELETE,zclient,ospf->vrf_id
);if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE))zlog_debug("Redistribute[DEFAULT]:S
top");//Pending:howdoestheexternal_infocleanupworkinthiscase?ospf_asbr_status_up
date(ospf,--ospf->redistribute);returnCMD_SUCCESS;}staticintospf_external_lsa_or
iginate_check(structospf*ospf,structexternal_info*ei){/*Ifprefixismulticast,then
donotoriginateLSA.*/if(IN_MULTICAST(htonl(ei->p.prefix.s_addr))){zlog_info("LSA[
Type5:%s]:NotoriginateAS-external-LSA,""Prefixbelongsmulticast",inet_ntoa(ei->p.
prefix));return0;}/*Takecareofdefault-originate.*/if(is_prefix_default(&ei->p))i
f(ospf->default_originate==DEFAULT_ORIGINATE_NONE){zlog_info("LSA[Type5:0.0.0.0]
:NotoriginateAS-external-LSA""fordefault");return0;}return1;}/*Ifconnectedprefix
isOSPFenableinterface,thendonotannounce.*/intospf_distribute_check_connected(str
uctospf*ospf,structexternal_info*ei){structlistnode*node;structospf_interface*oi
;for(ALL_LIST_ELEMENTS_RO(ospf->oiflist,node,oi))if(prefix_match(oi->address,(st
ructprefix*)&ei->p))return0;return1;}/*return1ifexternalLSAmustbeoriginated,0oth
erwise*/intospf_redistribute_check(structospf*ospf,structexternal_info*ei,int*ch
anged){structroute_map_set_valuessave_values;structprefix_ipv4*p=&ei->p;structos
pf_redist*red;uint8_ttype=is_prefix_default(&ei->p)?DEFAULT_ROUTE:ei->type;unsig
nedshortinstance=is_prefix_default(&ei->p)?0:ei->instance;if(changed)*changed=0;
if(!ospf_external_lsa_originate_check(ospf,ei))return0;/*Takecareconnectedroute.
*/if(type==ZEBRA_ROUTE_CONNECT&&!ospf_distribute_check_connected(ospf,ei))return
0;if(!DEFAULT_ROUTE_TYPE(type)&&DISTRIBUTE_NAME(ospf,type))/*distirbute-listexis
ts,butaccess-listmaynot?*/if(DISTRIBUTE_LIST(ospf,type))if(access_list_apply(DIS
TRIBUTE_LIST(ospf,type),p)==FILTER_DENY){if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBU
TE))zlog_debug("Redistribute[%s]:%s/%dfilteredbyditribute-list.",ospf_redist_str
ing(type),inet_ntoa(p->prefix),p->prefixlen);return0;}save_values=ei->route_map_
set;ospf_reset_route_map_set_values(&ei->route_map_set);/*applyroute-mapifneeded
*/red=ospf_redist_lookup(ospf,type,instance);if(red&&ROUTEMAP_NAME(red)){intret;
ret=route_map_apply(ROUTEMAP(red),(structprefix*)p,RMAP_OSPF,ei);if(ret==RMAP_DE
NYMATCH){ei->route_map_set=save_values;if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE
))zlog_debug("Redistribute[%s]:%s/%dfilteredbyroute-map.",ospf_redist_string(typ
e),inet_ntoa(p->prefix),p->prefixlen);return0;}/*checkif'route-mapset'changedsom
ething*/if(changed)*changed=!ospf_route_map_set_compare(&ei->route_map_set,&save
_values);}return1;}/*OSPFroute-mapsetforredistribution*/voidospf_routemap_set(st
ructospf_redist*red,constchar*name){if(ROUTEMAP_NAME(red))free(ROUTEMAP_NAME(red
));ROUTEMAP_NAME(red)=strdup(name);ROUTEMAP(red)=route_map_lookup_by_name(name);
}voidospf_routemap_unset(structospf_redist*red){if(ROUTEMAP_NAME(red))free(ROUTE
MAP_NAME(red));ROUTEMAP_NAME(red)=NULL;ROUTEMAP(red)=NULL;}/*Zebrarouteaddanddel
etetreatment.*/staticintospf_zebra_read_route(intcommand,structzclient*zclient,z
ebra_size_tlength,vrf_id_tvrf_id){structzapi_routeapi;structprefix_ipv4p;unsigne
dlongifindex;structin_addrnexthop;structexternal_info*ei;structospf*ospf;inti;os
pf=ospf_lookup_by_vrf_id(vrf_id);if(ospf==NULL)return0;if(zapi_route_decode(zcli
ent->ibuf,&api)<0)return-1;ifindex=api.nexthops[0].ifindex;nexthop=api.nexthops[
0].gate.ipv4;memcpy(&p,&api.prefix,sizeof(p));if(IPV4_NET127(ntohl(p.prefix.s_ad
dr)))return0;if(IS_DEBUG_OSPF(zebra,ZEBRA_REDISTRIBUTE)){charbuf_prefix[PREFIX_S
TRLEN];prefix2str(&api.prefix,buf_prefix,sizeof(buf_prefix));zlog_debug("%s:from
client%s:vrf_id%d,p%s",__func__,zebra_route_string(api.type),vrf_id,buf_prefix);
}if(command==ZEBRA_REDISTRIBUTE_ROUTE_ADD){/*XXX|HACK|TODO|FIXME:*Maybeweshouldi
gnorereject/blackholeroutes?Testing*showsthatthereisnoproblemsthoughandthisisonl
yway*to"summarize"routesinASBRatthemoment.Maybeweneed*justabettergeneralisedsolu
tionforthesetypes?*//*Protocoltagoverwritesallothertagvaluesentbyzebra*/if(ospf-
>dtag[api.type]>0)api.tag=ospf->dtag[api.type];/**Givenzebrasendsupdateforaprefi
xviaADDmessage,it*should*beconsideredasanimplicitDELforthatprefixwithother*sourc
e*types.*/for(i=0;i<ZEBRA_ROUTE_MAX;i++)if(i!=api.type)ospf_external_info_delete
(ospf,i,api.instance,p);ei=ospf_external_info_add(ospf,api.type,api.instance,p,i
findex,nexthop,api.tag);if(ei==NULL){/*Nothinghaschanged,sonothingtodo;return*/r
eturn0;}if(ospf->router_id.s_addr==0)/*SetflagstogenerateAS-external-LSAoriginat
eeventforeachredistributedprotocolslater.*/ospf->external_origin|=(1<<api.type);
else{if(ei){if(is_prefix_default(&p))ospf_external_lsa_refresh_default(ospf);els
e{structospf_lsa*current;current=ospf_external_info_find_lsa(ospf,&ei->p);if(!cu
rrent)ospf_external_lsa_originate(ospf,ei);else{if(IS_DEBUG_OSPF(zebra,ZEBRA_RED
ISTRIBUTE))zlog_debug("ospf_zebra_read_route():%srefreshingLSA",inet_ntoa(p.pref
ix));ospf_external_lsa_refresh(ospf,current,ei,LSA_REFRESH_FORCE);}}}}}else/*if(
command==ZEBRA_REDISTRIBUTE_ROUTE_DEL)*/{ospf_external_info_delete(ospf,api.type
,api.instance,p);if(is_prefix_default(&p))ospf_external_lsa_refresh_default(ospf
);elseospf_external_lsa_flush(ospf,api.type,&p,ifindex/*,nexthop*/);}return0;}in
tospf_distribute_list_out_set(structospf*ospf,inttype,constchar*name){/*Lookupac
cess-listfordistribute-list.*/DISTRIBUTE_LIST(ospf,type)=access_list_lookup(AFI_
IP,name);/*Clearpreviousdistribute-name.*/if(DISTRIBUTE_NAME(ospf,type))free(DIS
TRIBUTE_NAME(ospf,type));/*Setdistribute-name.*/DISTRIBUTE_NAME(ospf,type)=strdu
p(name);/*Ifaccess-listhavebeenset,scheduleupdatetimer.*/if(DISTRIBUTE_LIST(ospf
,type))ospf_distribute_list_update(ospf,type,0);returnCMD_SUCCESS;}intospf_distr
ibute_list_out_unset(structospf*ospf,inttype,constchar*name){/*Scheduleupdatetim
er.*/if(DISTRIBUTE_LIST(ospf,type))ospf_distribute_list_update(ospf,type,0);/*Un
setdistribute-list.*/DISTRIBUTE_LIST(ospf,type)=NULL;/*Cleardistribute-name.*/if
(DISTRIBUTE_NAME(ospf,type))free(DISTRIBUTE_NAME(ospf,type));DISTRIBUTE_NAME(osp
f,type)=NULL;returnCMD_SUCCESS;}/*distribute-listupdatetimer.*/staticintospf_dis
tribute_list_update_timer(structthread*thread){structroute_node*rn;structexterna
l_info*ei;structroute_table*rt;structospf_lsa*lsa;inttype,default_refresh=0,arg_
type;structospf*ospf=NULL;void**arg=THREAD_ARG(thread);ospf=(structospf*)arg[0];
arg_type=(int)(intptr_t)arg[1];if(ospf==NULL)return0;ospf->t_distribute_update=N
ULL;zlog_info("Zebra[Redistribute]:distribute-listupdatetimerfired!");if(IS_DEBU
G_OSPF_EVENT){zlog_debug("%s:ospfdistribute-listupdatearg_type%dvrf%sid%d",__PRE
TTY_FUNCTION__,arg_type,ospf_vrf_id_to_name(ospf->vrf_id),ospf->vrf_id);}/*forea
challexternalinfo.*/for(type=0;type<=ZEBRA_ROUTE_MAX;type++){structlist*ext_list
;structlistnode*node;structospf_external*ext;ext_list=ospf->external[type];if(!e
xt_list)continue;for(ALL_LIST_ELEMENTS_RO(ext_list,node,ext)){rt=ext->external_i
nfo;if(!rt)continue;for(rn=route_top(rt);rn;rn=route_next(rn))if((ei=rn->info)!=
NULL){if(is_prefix_default(&ei->p))default_refresh=1;elseif((lsa=ospf_external_i
nfo_find_lsa(ospf,&ei->p)))ospf_external_lsa_refresh(ospf,lsa,ei,LSA_REFRESH_IF_
CHANGED);elseospf_external_lsa_originate(ospf,ei);}}}if(default_refresh)ospf_ext
ernal_lsa_refresh_default(ospf);XFREE(MTYPE_OSPF_DIST_ARGS,arg);return0;}/*Updat
edistribute-listandsettimertoapplyaccess-list.*/voidospf_distribute_list_update(
structospf*ospf,inttype,unsignedshortinstance){structroute_table*rt;structospf_e
xternal*ext;void**args=XCALLOC(MTYPE_OSPF_DIST_ARGS,sizeof(void*)*2);args[0]=osp
f;args[1]=(void*)((ptrdiff_t)type);/*Externalinfodoesnotexist.*/ext=ospf_externa
l_lookup(ospf,type,instance);if(!ext||!(rt=EXTERNAL_INFO(ext))){XFREE(MTYPE_OSPF
_DIST_ARGS,args);return;}/*Ifexistspreviouslyinvokedthread,thenletitcontinue.*/i
f(ospf->t_distribute_update){XFREE(MTYPE_OSPF_DIST_ARGS,args);return;}/*Settimer
.*/ospf->t_distribute_update=NULL;thread_add_timer_msec(master,ospf_distribute_l
ist_update_timer,(void**)args,ospf->min_ls_interval,&ospf->t_distribute_update);
}/*Ifaccess-listisupdated,applysomecheck.*/staticvoidospf_filter_update(structac
cess_list*access){structospf*ospf;inttype;intabr_inv=0;structospf_area*area;stru
ctlistnode*node,*n1;/*IfOSPFinstancedoesnotexist,returnrightnow.*/if(listcount(o
m->ospf)==0)return;/*Iterateallospf[VRF]instances*/for(ALL_LIST_ELEMENTS_RO(om->
ospf,n1,ospf)){/*Updatedistribute-list,andapplyfilter.*/for(type=0;type<=ZEBRA_R
OUTE_MAX;type++){structlist*red_list;structlistnode*node;structospf_redist*red;r
ed_list=ospf->redist[type];if(red_list)for(ALL_LIST_ELEMENTS_RO(red_list,node,re
d)){if(ROUTEMAP(red)){/*ifroute-mapisnotNULLit*maybe*usingthisaccesslist*/ospf_d
istribute_list_update(ospf,type,red->instance);}}/*Thereisplaceforroute-mapforde
fault-information*(ZEBRA_ROUTE_MAX),*butnodistributelist.*/if(type==ZEBRA_ROUTE_
MAX)break;if(DISTRIBUTE_NAME(ospf,type)){/*Keepoldaccess-listfordistribute-list.
*/structaccess_list*old=DISTRIBUTE_LIST(ospf,type);/*Updateaccess-listfordistrib
ute-list.*/DISTRIBUTE_LIST(ospf,type)=access_list_lookup(AFI_IP,DISTRIBUTE_NAME(
ospf,type));/*Noupdateforthisdistributetype.*/if(old==NULL&&DISTRIBUTE_LIST(ospf
,type)==NULL)continue;/*Scheduledistribute-listupdatetimer.*/if(DISTRIBUTE_LIST(
ospf,type)==NULL||strcmp(DISTRIBUTE_NAME(ospf,type),access->name)==0)ospf_distri
bute_list_update(ospf,type,0);}}/*UpdateAreaaccess-list.*/for(ALL_LIST_ELEMENTS_
RO(ospf->areas,node,area)){if(EXPORT_NAME(area)){EXPORT_LIST(area)=NULL;abr_inv+
+;}if(IMPORT_NAME(area)){IMPORT_LIST(area)=NULL;abr_inv++;}}/*ScheduleABRtasks--
thiswillbechanged--takada.*/if(IS_OSPF_ABR(ospf)&&abr_inv)ospf_schedule_abr_task
(ospf);}}/*Ifprefix-listisupdated,dosomeupdates.*/voidospf_prefix_list_update(st
ructprefix_list*plist){structospf*ospf=NULL;inttype;intabr_inv=0;structospf_area
*area;structlistnode*node,*n1;/*IfOSPFinstatncedoesnotexist,returnrightnow.*/if(
listcount(om->ospf)==0)return;/*Iterateallospf[VRF]instances*/for(ALL_LIST_ELEME
NTS_RO(om->ospf,n1,ospf)){/*Updateallroute-mapswhichareused*asredistributionfilt
ers.*Theymightuseprefix-list.*/for(type=0;type<=ZEBRA_ROUTE_MAX;type++){structli
st*red_list;structlistnode*node;structospf_redist*red;red_list=ospf->redist[type
];if(red_list){for(ALL_LIST_ELEMENTS_RO(red_list,node,red)){if(ROUTEMAP(red)){/*
ifroute-mapisnotNULL*itmaybeusing*thisprefixlist*/ospf_distribute_list_update(os
pf,type,red->instance);}}}}/*Updateareafilter-lists.*/for(ALL_LIST_ELEMENTS_RO(o
spf->areas,node,area)){/*Updatefilter-listin.*/if(PREFIX_NAME_IN(area))if(strcmp
(PREFIX_NAME_IN(area),prefix_list_name(plist))==0){PREFIX_LIST_IN(area)=prefix_l
ist_lookup(AFI_IP,PREFIX_NAME_IN(area));abr_inv++;}/*Updatefilter-listout.*/if(P
REFIX_NAME_OUT(area))if(strcmp(PREFIX_NAME_OUT(area),prefix_list_name(plist))==0
){PREFIX_LIST_IN(area)=prefix_list_lookup(AFI_IP,PREFIX_NAME_OUT(area));abr_inv+
+;}}/*ScheduleABRtask.*/if(IS_OSPF_ABR(ospf)&&abr_inv)ospf_schedule_abr_task(osp
f);}}staticstructospf_distance*ospf_distance_new(void){returnXCALLOC(MTYPE_OSPF_
DISTANCE,sizeof(structospf_distance));}staticvoidospf_distance_free(structospf_d
istance*odistance){XFREE(MTYPE_OSPF_DISTANCE,odistance);}intospf_distance_set(st
ructvty*vty,structospf*ospf,constchar*distance_str,constchar*ip_str,constchar*ac
cess_list_str){intret;structprefix_ipv4p;uint8_tdistance;structroute_node*rn;str
uctospf_distance*odistance;ret=str2prefix_ipv4(ip_str,&p);if(ret==0){vty_out(vty
,"Malformedprefix\n");returnCMD_WARNING_CONFIG_FAILED;}distance=atoi(distance_st
r);/*GetOSPFdistancenode.*/rn=route_node_get(ospf->distance_table,(structprefix*
)&p);if(rn->info){odistance=rn->info;route_unlock_node(rn);}else{odistance=ospf_
distance_new();rn->info=odistance;}/*Setdistancevalue.*/odistance->distance=dist
ance;/*Resetaccess-listconfiguration.*/if(odistance->access_list){free(odistance
->access_list);odistance->access_list=NULL;}if(access_list_str)odistance->access
_list=strdup(access_list_str);returnCMD_SUCCESS;}intospf_distance_unset(structvt
y*vty,structospf*ospf,constchar*distance_str,constchar*ip_str,charconst*access_l
ist_str){intret;structprefix_ipv4p;structroute_node*rn;structospf_distance*odist
ance;ret=str2prefix_ipv4(ip_str,&p);if(ret==0){vty_out(vty,"Malformedprefix\n");
returnCMD_WARNING_CONFIG_FAILED;}rn=route_node_lookup(ospf->distance_table,(stru
ctprefix*)&p);if(!rn){vty_out(vty,"Can'tfindspecifiedprefix\n");returnCMD_WARNIN
G_CONFIG_FAILED;}odistance=rn->info;if(odistance->access_list)free(odistance->ac
cess_list);ospf_distance_free(odistance);rn->info=NULL;route_unlock_node(rn);rou
te_unlock_node(rn);returnCMD_SUCCESS;}voidospf_distance_reset(structospf*ospf){s
tructroute_node*rn;structospf_distance*odistance;for(rn=route_top(ospf->distance
_table);rn;rn=route_next(rn))if((odistance=rn->info)!=NULL){if(odistance->access
_list)free(odistance->access_list);ospf_distance_free(odistance);rn->info=NULL;r
oute_unlock_node(rn);}}uint8_tospf_distance_apply(structospf*ospf,structprefix_i
pv4*p,structospf_route*or){if(ospf==NULL)return0;if(ospf->distance_intra)if(or->
path_type==OSPF_PATH_INTRA_AREA)returnospf->distance_intra;if(ospf->distance_int
er)if(or->path_type==OSPF_PATH_INTER_AREA)returnospf->distance_inter;if(ospf->di
stance_external)if(or->path_type==OSPF_PATH_TYPE1_EXTERNAL||or->path_type==OSPF_
PATH_TYPE2_EXTERNAL)returnospf->distance_external;if(ospf->distance_all)returnos
pf->distance_all;return0;}voidospf_zebra_vrf_register(structospf*ospf){if(!zclie
nt||zclient->sock<0||!ospf)return;if(ospf->vrf_id!=VRF_UNKNOWN){if(IS_DEBUG_OSPF
_EVENT)zlog_debug("%s:RegisterVRF%sid%u",__PRETTY_FUNCTION__,ospf_vrf_id_to_name
(ospf->vrf_id),ospf->vrf_id);zclient_send_reg_requests(zclient,ospf->vrf_id);}}v
oidospf_zebra_vrf_deregister(structospf*ospf){if(!zclient||zclient->sock<0||!osp
f)return;if(ospf->vrf_id!=VRF_DEFAULT&&ospf->vrf_id!=VRF_UNKNOWN){if(IS_DEBUG_OS
PF_EVENT)zlog_debug("%s:De-RegisterVRF%sid%utoZebra.",__PRETTY_FUNCTION__,ospf_v
rf_id_to_name(ospf->vrf_id),ospf->vrf_id);/*Deregisterforrouter-id,interfaces,*r
edistributedroutes.*/zclient_send_dereg_requests(zclient,ospf->vrf_id);}}staticv
oidospf_zebra_connected(structzclient*zclient){/*Sendtheclientregistration*/bfd_
client_sendmsg(zclient,ZEBRA_BFD_CLIENT_REGISTER);zclient_send_reg_requests(zcli
ent,VRF_DEFAULT);}voidospf_zebra_init(structthread_master*master,unsignedshortin
stance){/*Allocatezebrastructure.*/zclient=zclient_new_notify(master,&zclient_op
tions_default);zclient_init(zclient,ZEBRA_ROUTE_OSPF,instance,&ospfd_privs);zcli
ent->zebra_connected=ospf_zebra_connected;zclient->router_id_update=ospf_router_
id_update_zebra;zclient->interface_add=ospf_interface_add;zclient->interface_del
ete=ospf_interface_delete;zclient->interface_up=ospf_interface_state_up;zclient-
>interface_down=ospf_interface_state_down;zclient->interface_address_add=ospf_in
terface_address_add;zclient->interface_address_delete=ospf_interface_address_del
ete;zclient->interface_link_params=ospf_interface_link_params;zclient->interface
_vrf_update=ospf_interface_vrf_update;zclient->redistribute_route_add=ospf_zebra
_read_route;zclient->redistribute_route_del=ospf_zebra_read_route;access_list_ad
d_hook(ospf_filter_update);access_list_delete_hook(ospf_filter_update);prefix_li
st_add_hook(ospf_prefix_list_update);prefix_list_delete_hook(ospf_prefix_list_up
date);}