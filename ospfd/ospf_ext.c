/**ThisisanimplementationofRFC7684OSPFv2Prefix/LinkAttribute*Advertisement**Modu
lename:ExtendedPrefix/LinkOpaqueLSA**Author:OlivierDugeon<olivier.dugeon@orange.
com>*Author:AnselmeSawadogo<anselmesawadogo@gmail.com>**Copyright(C)2016-2018Ora
ngeLabshttp://www.orange.com**Thisprogramisfreesoftware;youcanredistributeitand/
ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbytheFree*Softwar
eFoundation;eitherversion2oftheLicense,or(atyouroption)*anylaterversion.**Thispr
ogramisdistributedinthehopethatitwillbeuseful,butWITHOUT*ANYWARRANTY;withouteven
theimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAPARTICULARPURPOSE.SeetheGNUGene
ralPublicLicensefor*moredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPubli
cLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Fou
ndation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#i
nclude<math.h>#include<stdio.h>#include<stdlib.h>#include"linklist.h"#include"pr
efix.h"#include"if.h"#include"table.h"#include"memory.h"#include"command.h"#incl
ude"vty.h"#include"stream.h"#include"log.h"#include"thread.h"#include"hash.h"#in
clude"sockunion.h"/*forinet_aton()*/#include"network.h"#include"if.h"#include"li
bospf.h"/*forospfinterfacetypes*/#include"ospfd/ospfd.h"#include"ospfd/ospf_inte
rface.h"#include"ospfd/ospf_ism.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf
_lsa.h"#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/
ospf_nsm.h"#include"ospfd/ospf_flood.h"#include"ospfd/ospf_packet.h"#include"osp
fd/ospf_spf.h"#include"ospfd/ospf_dump.h"#include"ospfd/ospf_route.h"#include"os
pfd/ospf_ase.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_sr.h"#include"osp
fd/ospf_ext.h"/*Followingstructureareinternaluseonly.*//**Globalvariabletomanage
ExtendedPrefix/LinkOpaqueLSAonthisnode.*Notethatallparametervaluesarestoredinnet
workbyteorder.*/staticstructospf_ext_lpOspfEXT;/**------------------------------
-----------------------------------------*Followingsareinitialize/terminatefunct
ionsforExtendedPrefix/Link*OpaqueLSAhandling.*----------------------------------
-------------------------------------*//*ExtendedPrefixOpaqueLSArelatedcallbackf
unctions*/staticvoidospf_ext_pref_ism_change(structospf_interface*oi,intold_stat
us);staticvoidospf_ext_pref_show_info(structvty*vty,structospf_lsa*lsa);staticin
tospf_ext_pref_lsa_originate(void*arg);staticstructospf_lsa*ospf_ext_pref_lsa_re
fresh(structospf_lsa*lsa);staticvoidospf_ext_pref_lsa_schedule(structext_itf*ext
i,enumlsa_opcodeopcode);/*ExtendedLinkOpaqueLSArelatedcallbackfunctions*/statici
ntospf_ext_link_new_if(structinterface*ifp);staticintospf_ext_link_del_if(struct
interface*ifp);staticvoidospf_ext_link_ism_change(structospf_interface*oi,intold
_status);staticvoidospf_ext_link_nsm_change(structospf_neighbor*nbr,intold_statu
s);staticvoidospf_ext_link_show_info(structvty*vty,structospf_lsa*lsa);staticint
ospf_ext_link_lsa_originate(void*arg);staticstructospf_lsa*ospf_ext_link_lsa_ref
resh(structospf_lsa*lsa);staticvoidospf_ext_link_lsa_schedule(structext_itf*exti
,enumlsa_opcodeopcode);staticvoidospf_ext_lsa_schedule(structext_itf*exti,enumls
a_opcodeop);staticintospf_ext_link_lsa_update(structospf_lsa*lsa);staticintospf_
ext_pref_lsa_update(structospf_lsa*lsa);staticvoiddel_ext_info(void*val);/**Exte
ndedLink/Prefixinitialization**@param-none**@return-0ifOK,<>0otherwise*/intospf_
ext_init(void){intrc=0;memset(&OspfEXT,0,sizeof(structospf_ext_lp));OspfEXT.enab
led=false;/*OnlyAreafloodingissupportedyet*/OspfEXT.scope=OSPF_OPAQUE_AREA_LSA;/
*Initializeinterfacelist*/OspfEXT.iflist=list_new();OspfEXT.iflist->del=del_ext_
info;zlog_info("EXT(%s):RegisterExtendedLinkOpaqueLSA",__func__);rc=ospf_registe
r_opaque_functab(OSPF_OPAQUE_AREA_LSA,OPAQUE_TYPE_EXTENDED_LINK_LSA,ospf_ext_lin
k_new_if,/*newif*/ospf_ext_link_del_if,/*delif*/ospf_ext_link_ism_change,/*ismch
ange*/ospf_ext_link_nsm_change,/*nsmchange*/NULL,/*Writerouterconfig.*/NULL,/*Wr
iteinterfaceconf.*/NULL,/*Writedebugconfig.*/ospf_ext_link_show_info,/*ShowLSAin
fo*/ospf_ext_link_lsa_originate,/*OriginateLSA*/ospf_ext_link_lsa_refresh,/*Refr
eshLSA*/ospf_ext_link_lsa_update,/*new_lsa_hook*/NULL);/*del_lsa_hook*/if(rc!=0)
{zlog_warn("EXT(%s):FailedtoregisterExtendedLinkLSA",__func__);returnrc;}zlog_in
fo("EXT(%s):RegisterExtendedPrefixOpaqueLSA",__func__);rc=ospf_register_opaque_f
unctab(OspfEXT.scope,OPAQUE_TYPE_EXTENDED_PREFIX_LSA,NULL,/*newifhandlebylink*/N
ULL,/*delifhandlebylink*/ospf_ext_pref_ism_change,/*ismchange*/NULL,/*nsmchange*
/ospf_sr_config_write_router,/*Writerouterconfig.*/NULL,/*Writeinterfaceconf.*/N
ULL,/*Writedebugconfig.*/ospf_ext_pref_show_info,/*ShowLSAinfo*/ospf_ext_pref_ls
a_originate,/*OriginateLSA*/ospf_ext_pref_lsa_refresh,/*RefreshLSA*/ospf_ext_pre
f_lsa_update,/*new_lsa_hook*/NULL);/*del_lsa_hook*/if(rc!=0){zlog_warn("EXT(%s):
FailedtoregisterExtendedPrefixLSA",__func__);returnrc;}returnrc;}/**ExtendedLink
/Prefixterminationfunction**@param-none*@return-none*/voidospf_ext_term(void){if
((OspfEXT.scope!=OSPF_OPAQUE_AREA_LSA)&&(OspfEXT.scope!=OSPF_OPAQUE_AS_LSA))zlog
_warn("EXT:UnabletounregisterExtendedPrefix""OpaqueLSAfunctions:Wrongscope!");el
seospf_delete_opaque_functab(OspfEXT.scope,OPAQUE_TYPE_EXTENDED_PREFIX_LSA);ospf
_delete_opaque_functab(OSPF_OPAQUE_AREA_LSA,OPAQUE_TYPE_EXTENDED_LINK_LSA);list_
delete_and_null(&OspfEXT.iflist);OspfEXT.scope=0;OspfEXT.enabled=false;return;}/
**ExtendedLink/Prefixfinishfunction**@param-none*@return-none*/voidospf_ext_fini
sh(void){//list_delete_all_node(OspfEXT.iflist);OspfEXT.enabled=false;}/**------
---------------------------------------------------------------*Followingsarecon
trolfunctionsforExtendedPrefix/LinkOpaqueLSA*parametersmanagement.*-------------
--------------------------------------------------------*//*Functionstofreememor
yspace*/staticvoiddel_ext_info(void*val){XFREE(MTYPE_OSPF_EXT_PARAMS,val);}/*Inc
rementinstancevalueforExtendedPrefixOpaqueLSAsOpaqueIDfield*/staticuint32_tget_e
xt_pref_instance_value(void){staticuint32_tseqno=0;if(seqno<MAX_LEGAL_EXT_INSTAN
CE_NUM)seqno+=1;elseseqno=1;/*Avoidzero.*/returnseqno;}/*Incrementinstancevaluef
orExtendedLinkOpaqueLSAsOpaqueIDfield*/staticuint32_tget_ext_link_instance_value
(void){staticuint32_tseqno=0;if(seqno<MAX_LEGAL_EXT_INSTANCE_NUM)seqno+=1;elsese
qno=1;/*Avoidzero.*/returnseqno;}/*LookupExtendedPrefix/LinksbyifpfromOspfEXTstr
uctiflist*/staticstructext_itf*lookup_ext_by_ifp(structinterface*ifp){structlist
node*node,*nnode;structext_itf*exti;for(ALL_LIST_ELEMENTS(OspfEXT.iflist,node,nn
ode,exti))if(exti->ifp==ifp)returnexti;returnNULL;}/*LookupExtendedPrefix/Linksb
yLSAIDfromOspfEXTstructiflist*/staticstructext_itf*lookup_ext_by_instance(struct
ospf_lsa*lsa){structlistnode*node;structext_itf*exti;uint32_tkey=GET_OPAQUE_ID(n
tohl(lsa->data->id.s_addr));uint8_ttype=GET_OPAQUE_TYPE(ntohl(lsa->data->id.s_ad
dr));for(ALL_LIST_ELEMENTS_RO(OspfEXT.iflist,node,exti))if((exti->instance==key)
&&(exti->type==type))returnexti;returnNULL;}/**---------------------------------
-------------------------------------*Theunderlyingsubsectiondefinessettersandun
setterstocreateand*deletetlvsandsubtlvs*----------------------------------------
------------------------------*//*ExtendedPrefixTLV-RFC7684section2.1*/staticvoi
dset_ext_prefix(structext_itf*exti,uint8_troute_type,uint8_tflags,structprefix_i
pv4p){TLV_TYPE(exti->prefix)=htons(EXT_TLV_PREFIX);/*Warning:Sizemustbeadjustdep
endingofsubTLV's*/TLV_LEN(exti->prefix)=htons(EXT_TLV_PREFIX_SIZE);exti->prefix.
route_type=route_type;exti->prefix.flags=flags;/*OnlyAddressFamilyIpv4(0)isdefin
edinRFC7684*/exti->prefix.af=0;exti->prefix.pref_length=p.prefixlen;exti->prefix
.address=p.prefix;}/*ExtendedLinkTLV-RFC7684section3.1*/staticvoidset_ext_link(s
tructext_itf*exti,uint8_ttype,structin_addrid,structin_addrdata){TLV_TYPE(exti->
link)=htons(EXT_TLV_LINK);/*Warning:SizemustbeadjustdependingofsubTLV's*/TLV_LEN
(exti->link)=htons(EXT_TLV_LINK_SIZE);exti->link.link_type=type;exti->link.link_
id=id;exti->link.link_data=data;}/*PrefixSIDSubTLV-section5*/staticvoidset_prefi
x_sid(structext_itf*exti,uint8_talgorithm,uint32_tvalue,intvalue_type,uint8_tfla
gs){if((algorithm!=SR_ALGORITHM_SPF)&&(algorithm!=SR_ALGORITHM_STRICT_SPF)){zlog
_warn("EXT(%s):unrecognizedalgorithm,notSPForS-SPF",__func__);return;}/*Updatefl
agsaccordingtothetypeofvaluefield:labelorindex*/if(value_type==SID_LABEL)SET_FLA
G(flags,EXT_SUBTLV_PREFIX_SID_VFLG);/*setprefixsidsubtlvforanextendedprefixtlv*/
TLV_TYPE(exti->node_sid)=htons(EXT_SUBTLV_PREFIX_SID);exti->node_sid.algorithm=a
lgorithm;exti->node_sid.flags=flags;exti->node_sid.mtid=0;/*Multi-Topologyisnots
upported*//*SetLabelorIndexvalue*/if(value_type==SID_LABEL){TLV_LEN(exti->node_s
id)=htons(SID_LABEL_SIZE(EXT_SUBTLV_PREFIX_SID_SIZE));exti->node_sid.value=htonl
(SET_LABEL(value));}else{TLV_LEN(exti->node_sid)=htons(SID_INDEX_SIZE(EXT_SUBTLV
_PREFIX_SID_SIZE));exti->node_sid.value=htonl(value);}}/*AdjacencySIDSubTLV-sect
ion6.1*/staticvoidset_adj_sid(structext_itf*exti,boolbackup,uint32_tvalue,intval
ue_type){intindex;uint8_tflags;/*DeterminewhichADJ_SIDmustbeset:nominalorbackup*
/if(backup){flags=EXT_SUBTLV_LINK_ADJ_SID_BFLG;index=1;}else{index=0;flags=0;}/*
SetHeader*/TLV_TYPE(exti->adj_sid[index])=htons(EXT_SUBTLV_ADJ_SID);/*OnlyLocalA
DJ-SIDissupportedforthemoment*/SET_FLAG(flags,EXT_SUBTLV_LINK_ADJ_SID_LFLG);exti
->adj_sid[index].mtid=0;/*Multi-Topologyisnotsupported*//*AdjustLength,FlagsandV
aluedependingonthetypeofLabel*/if(value_type==SID_LABEL){SET_FLAG(flags,EXT_SUBT
LV_LINK_ADJ_SID_VFLG);TLV_LEN(exti->adj_sid[index])=htons(SID_LABEL_SIZE(EXT_SUB
TLV_ADJ_SID_SIZE));exti->adj_sid[index].value=htonl(SET_LABEL(value));}else{UNSE
T_FLAG(flags,EXT_SUBTLV_LINK_ADJ_SID_VFLG);TLV_LEN(exti->adj_sid[index])=htons(S
ID_INDEX_SIZE(EXT_SUBTLV_ADJ_SID_SIZE));exti->adj_sid[index].value=htonl(value);
}exti->adj_sid[index].flags=flags;/*Setcomputedflags*/exti->adj_sid[index].mtid=
0;/*Multi-Topologyisnotsupported*/exti->adj_sid[index].weight=0;/*Load-Balancing
isnotsupported*/}/*LANAdjacencySIDSubTLV-section6.2*/staticvoidset_lan_adj_sid(s
tructext_itf*exti,boolbackup,uint32_tvalue,intvalue_type,structin_addrneighbor_i
d){intindex;uint8_tflags;/*DeterminewhichADJ_SIDmustbeset:nominalorbackup*/if(ba
ckup){flags=EXT_SUBTLV_LINK_ADJ_SID_BFLG;index=1;}else{index=0;flags=0;}/*SetHea
der*/TLV_TYPE(exti->lan_sid[index])=htons(EXT_SUBTLV_LAN_ADJ_SID);/*OnlyLocalADJ
-SIDissupportedforthemoment*/SET_FLAG(flags,EXT_SUBTLV_LINK_ADJ_SID_LFLG);/*Adju
stLength,FlagsandValuedependingonthetypeofLabel*/if(value_type==SID_LABEL){SET_F
LAG(flags,EXT_SUBTLV_LINK_ADJ_SID_VFLG);TLV_LEN(exti->lan_sid[index])=htons(SID_
LABEL_SIZE(EXT_SUBTLV_PREFIX_RANGE_SIZE));exti->lan_sid[index].value=htonl(SET_L
ABEL(value));}else{UNSET_FLAG(flags,EXT_SUBTLV_LINK_ADJ_SID_VFLG);TLV_LEN(exti->
lan_sid[index])=htons(SID_INDEX_SIZE(EXT_SUBTLV_PREFIX_RANGE_SIZE));exti->lan_si
d[index].value=htonl(value);}exti->lan_sid[index].flags=flags;/*Setcomputedflags
*/exti->lan_sid[index].mtid=0;/*Multi-Topologyisnotsupported*/exti->lan_sid[inde
x].weight=0;/*Load-Balancingisnotsupported*/exti->lan_sid[index].neighbor_id=nei
ghbor_id;}/*ExperimentalSubTLVfromCisco*/staticvoidset_rmt_itf_addr(structext_it
f*exti,structin_addrrmtif){TLV_TYPE(exti->rmt_itf_addr)=htons(EXT_SUBTLV_RMT_ITF
_ADDR);TLV_LEN(exti->rmt_itf_addr)=htons(sizeof(structin_addr));exti->rmt_itf_ad
dr.value=rmtif;}/**UpdateExtendedprefixSIDindexforLoopbackinterfacetype**@parami
fname-Loopbackinterfacename*@paramindex-newvaluefortheprefixSIDofthisinterface*@
paramp-prefixforthisinterfaceorNULLifExtendedPrefix*shouldberemove**@returninsta
ncenumberifupdateisOK,0otherwise*/uint32_tospf_ext_schedule_prefix_index(structi
nterface*ifp,uint32_tindex,structprefix_ipv4*p,uint8_tflags){intrc=0;structext_i
tf*exti;/*FindExtendedPrefixinterface*/exti=lookup_ext_by_ifp(ifp);if(exti==NULL
)returnrc;if(p!=NULL){if(IS_DEBUG_OSPF_SR)zlog_debug("EXT(%s):Schedulenewprefix%
s/%uwith""index%uoninterface%s",__func__,inet_ntoa(p->prefix),p->prefixlen,index
,ifp->name);/*SetfirstExtendedPrefixthenthePrefixSIDinformation*/set_ext_prefix(
exti,OSPF_PATH_INTRA_AREA,EXT_TLV_PREF_NFLG,*p);set_prefix_sid(exti,SR_ALGORITHM
_SPF,index,SID_INDEX,flags);/*TrytoScheduleLSA*/SET_FLAG(exti->flags,EXT_LPFLG_L
SA_ACTIVE);if(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED))ospf_ext_pref_lsa_sc
hedule(exti,REFRESH_THIS_LSA);elseospf_ext_pref_lsa_schedule(exti,REORIGINATE_TH
IS_LSA);}else{if(IS_DEBUG_OSPF_SR)zlog_debug("EXT(%s):Removeprefixforinterface%s
",__func__,ifp->name);if(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED)){ospf_ext
_pref_lsa_schedule(exti,FLUSH_THIS_LSA);UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ENG
AGED);UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ACTIVE);}}returnSET_OPAQUE_LSID(exti-
>type,exti->instance);}/**UsedbySegmentRoutingtoactivate/deactivateExtendedLink/
Prefixflooding**@paramenableToactivateornotSegmentRoutingExtendedLSAflooding**@r
eturnnone*/voidospf_ext_update_sr(boolenable){structlistnode*node;structext_itf*
exti;if(IS_DEBUG_OSPF_SR)zlog_debug("EXT(%s):%sExtendedLSAsforSegmentRouting",__
func__,enable?"Enable":"Disable");if(enable){OspfEXT.enabled=true;/*RefreshLSAsi
falreadyengagedororiginate*/for(ALL_LIST_ELEMENTS_RO(OspfEXT.iflist,node,exti))i
f(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED))ospf_ext_lsa_schedule(exti,REFRE
SH_THIS_LSA);elseospf_ext_lsa_schedule(exti,REORIGINATE_THIS_LSA);}else{/*Startb
yFlushingengagedLSAs*/for(ALL_LIST_ELEMENTS_RO(OspfEXT.iflist,node,exti))if(CHEC
K_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED))ospf_ext_lsa_schedule(exti,FLUSH_THIS_
LSA);/*AndthendisableExtendedLink/Prefix*/OspfEXT.enabled=false;}}/**-----------
------------------------------------------------------------*Followingsarecallba
ckfunctionsagainstgenericOpaque-LSAshandling*-----------------------------------
------------------------------------*//*AddnewInterfaceinExtendedInterfaceList*/
staticintospf_ext_link_new_if(structinterface*ifp){structext_itf*new;intrc=-1;if
(lookup_ext_by_ifp(ifp)!=NULL){zlog_warn("EXT(%s):interface%sisalreadyinuse",__f
unc__,ifp?ifp->name:"-");rc=0;/*Donothinghere.*/returnrc;}new=XCALLOC(MTYPE_OSPF
_EXT_PARAMS,sizeof(structext_itf));if(new==NULL){zlog_warn("EXT(%s):XCALLOC:%s",
__func__,safe_strerror(errno));returnrc;}/*initializenewinformationandlinkbackth
einterface*/new->ifp=ifp;new->flags=EXT_LPFLG_LSA_INACTIVE;listnode_add(OspfEXT.
iflist,new);rc=0;returnrc;}/*RemoveexistingInterfacefromExtendedInterfaceList*/s
taticintospf_ext_link_del_if(structinterface*ifp){structext_itf*exti;intrc=-1;ex
ti=lookup_ext_by_ifp(ifp);if(exti!=NULL){structlist*iflist=OspfEXT.iflist;/*Dequ
euelistnodeentryfromthelist.*/listnode_delete(iflist,exti);XFREE(MTYPE_OSPF_EXT_
PARAMS,exti);rc=0;}else{zlog_warn("EXT(%s):interface%sisnotfound",__func__,ifp?i
fp->name:"-");}returnrc;}/**DetermineifanInterfacebelongstoanExtendedLinkAdjacen
cyorLANAdj.*typeandallocatenewinstancevalueaccordingly*/staticvoidospf_ext_link_
ism_change(structospf_interface*oi,intold_status){structext_itf*exti;/*Getinterf
aceinformationforSegmentRouting*/exti=lookup_ext_by_ifp(oi->ifp);if(exti==NULL){
zlog_warn("EXT(%s):CannotgetExtendedinfo.fromOI(%s)",__func__,IF_NAME(oi));retur
n;}/*DetermineifinterfaceisrelatedtoAdjacencyorLANAdj.SID*/if(oi->type!=OSPF_IFT
YPE_LOOPBACK){if(oi->state==ISM_DR)exti->stype=LAN_ADJ_SID;elseexti->stype=ADJ_S
ID;exti->instance=get_ext_link_instance_value();exti->type=OPAQUE_TYPE_EXTENDED_
LINK_LSA;zlog_debug("EXT(%s):Set%sSIDtointerface%s",__func__,exti->stype==ADJ_SI
D?"Adj.":"LANAdj.",oi->ifp->name);}}/**DetermineifanInterfacebelongstoanExtended
Prefixand*allocatenewinstancevalueaccordingly*/staticvoidospf_ext_pref_ism_chang
e(structospf_interface*oi,intold_status){structext_itf*exti;/*Getinterfaceinform
ationforSegmentRouting*/exti=lookup_ext_by_ifp(oi->ifp);if(exti==NULL){zlog_warn
("EXT(%s):CannotgetExtendedinfo.fromOI(%s)",__func__,IF_NAME(oi));return;}/*Dete
rmineifinterfaceisrelatedtoaNodeSID*/if(oi->type==OSPF_IFTYPE_LOOPBACK){exti->st
ype=PREF_SID;exti->instance=get_ext_pref_instance_value();exti->type=OPAQUE_TYPE
_EXTENDED_PREFIX_LSA;zlog_debug("EXT(%s):SetNodeSIDtointerface%s",__func__,oi->i
fp->name);/*CompleteSRDBiftheinterfacebelongstoaPrefix*/if(OspfEXT.enabled)ospf_
sr_update_prefix(oi->ifp,oi->address);}}/**FinishExtendedLinkconfigurationandflo
odcorrespondingLSA*whenOSPFadjacencyonthislinkfireup*/staticvoidospf_ext_link_ns
m_change(structospf_neighbor*nbr,intold_status){structospf_interface*oi=nbr->oi;
structext_itf*exti;uint32_tlabel;/*ProcessNeighboronlywhenitsstateisNSMFull*/if(
nbr->state!=NSM_Full)return;/*GetinterfaceinformationforSegmentRouting*/exti=loo
kup_ext_by_ifp(oi->ifp);if(exti==NULL){zlog_warn("EXT(%s):CannotgetExtendedinfo.
fromOI(%s)",__func__,IF_NAME(oi));return;}if(oi->area==NULL||oi->area->ospf==NUL
L){zlog_warn("EXT(%s):CannotrefertoOSPFfromOI(%s)",__func__,IF_NAME(oi));return;
}/*KeepAreainformationincombinationwithSRinfo.*/exti->area=oi->area;OspfEXT.area
=oi->area;/*ProcessonlyAdjacency/LANSID*/if(exti->stype==PREF_SID)return;switch(
oi->state){caseISM_PointToPoint:/*SegmentIDisanAdjacencyone*/exti->stype=ADJ_SID
;/*SetExtendedLinkTLVwithlink_id==NbrRouterID*/set_ext_link(exti,OSPF_IFTYPE_POI
NTOPOINT,nbr->router_id,oi->address->u.prefix4);/*SetExtendedLinkAdjacencySubTLV
s,backupfirst*/label=get_ext_link_label_value();set_adj_sid(exti,true,label,SID_
LABEL);label=get_ext_link_label_value();set_adj_sid(exti,false,label,SID_LABEL);
/*AndRemoteInterfaceaddress*/set_rmt_itf_addr(exti,nbr->address.u.prefix4);break
;caseISM_DR:/*SegmentIDisaLANAdjacencyfortheDRonly*/exti->stype=LAN_ADJ_SID;/*Se
tExtendedLinkTLVwithlink_id==DR*/set_ext_link(exti,OSPF_IFTYPE_BROADCAST,DR(oi),
oi->address->u.prefix4);/*SetExtendedLinkAdjacencySubTLVs,backupfirst*/label=get
_ext_link_label_value();set_lan_adj_sid(exti,true,label,SID_LABEL,nbr->router_id
);label=get_ext_link_label_value();set_lan_adj_sid(exti,false,label,SID_LABEL,nb
r->router_id);break;caseISM_DROther:caseISM_Backup:/*SegmentIDisanAdjacencyifnot
theDR*/exti->stype=ADJ_SID;/*SetExtendedLinkTLVwithlink_id==DR*/set_ext_link(ext
i,OSPF_IFTYPE_BROADCAST,DR(oi),oi->address->u.prefix4);/*SetExtendedLinkAdjacenc
ySubTLVs,backupfirst*/label=get_ext_link_label_value();set_adj_sid(exti,true,lab
el,SID_LABEL);label=get_ext_link_label_value();set_adj_sid(exti,false,label,SID_
LABEL);break;default:if(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED)){ospf_ext_
link_lsa_schedule(exti,FLUSH_THIS_LSA);UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ENGA
GED);UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ACTIVE);}return;}if(IS_DEBUG_OSPF_SR)z
log_debug("EXT(%s):Complete%sSIDtointerface%s",__func__,exti->stype==ADJ_SID?"Ad
j.":"LANAdj.",oi->ifp->name);/*floodthislinksparamsifeverythingisok*/SET_FLAG(ex
ti->flags,EXT_LPFLG_LSA_ACTIVE);if(OspfEXT.enabled){if(CHECK_FLAG(exti->flags,EX
T_LPFLG_LSA_ENGAGED))ospf_ext_link_lsa_schedule(exti,REFRESH_THIS_LSA);elseospf_
ext_link_lsa_schedule(exti,REORIGINATE_THIS_LSA);}}/*CallbackstohandleExtendedLi
nkSegmentRoutingLSAinformation*/staticintospf_ext_link_lsa_update(structospf_lsa
*lsa){/*SanityCheck*/if(lsa==NULL){zlog_warn("EXT(%s):Abort!LSAisNULL",__func__)
;return-1;}/*ProcessonlyOpaqueLSA*/if((lsa->data->type!=OSPF_OPAQUE_AREA_LSA)&&(
lsa->data->type!=OSPF_OPAQUE_AS_LSA))return0;/*ProcessonlyExtendedLinkLSA*/if(GE
T_OPAQUE_TYPE(ntohl(lsa->data->id.s_addr))!=OPAQUE_TYPE_EXTENDED_LINK_LSA)return
0;/*CheckifExtendedisenable*/if(!OspfEXT.enabled)return0;/*CallSegmentRoutingLSA
updateordeletion*/if(!IS_LSA_MAXAGE(lsa))ospf_sr_ext_link_lsa_update(lsa);elseos
pf_sr_ext_link_lsa_delete(lsa);return0;}/*CallbackstohandleExtendedPrefixSegment
RoutingLSAinformation*/staticintospf_ext_pref_lsa_update(structospf_lsa*lsa){/*S
anityCheck*/if(lsa==NULL){zlog_warn("EXT(%s):Abort!LSAisNULL",__func__);return-1
;}/*ProcessonlyOpaqueLSA*/if((lsa->data->type!=OSPF_OPAQUE_AREA_LSA)&&(lsa->data
->type!=OSPF_OPAQUE_AS_LSA))return0;/*ProcessonlyExtendedPrefixLSA*/if(GET_OPAQU
E_TYPE(ntohl(lsa->data->id.s_addr))!=OPAQUE_TYPE_EXTENDED_PREFIX_LSA)return0;/*C
heckifitisnotmyLSA*/if(IS_LSA_SELF(lsa))return0;/*CheckifExtendedisenable*/if(!O
spfEXT.enabled)return0;/*CallSegmentRoutingLSAupdateordeletion*/if(!IS_LSA_MAXAG
E(lsa))ospf_sr_ext_prefix_lsa_update(lsa);elseospf_sr_ext_prefix_lsa_delete(lsa)
;return0;}/**-------------------------------------------------------*Followingsa
reOSPFprotocolprocessingfunctionsfor*ExtendedPrefix/LinkOpaqueLSA*--------------
-----------------------------------------*/staticvoidbuild_tlv_header(structstre
am*s,structtlv_header*tlvh){stream_put(s,tlvh,sizeof(structtlv_header));}staticv
oidbuild_tlv(structstream*s,structtlv_header*tlvh){if((tlvh!=NULL)&&(ntohs(tlvh-
>type)!=0)){build_tlv_header(s,tlvh);stream_put(s,TLV_DATA(tlvh),TLV_BODY_SIZE(t
lvh));}}/*BuildanExtendedPrefixOpaqueLSAbodyforextendedprefixTLV*/staticvoidospf
_ext_pref_lsa_body_set(structstream*s,structext_itf*exti){/*Sanitycheck*/if((ext
i==NULL)||(exti->stype!=PREF_SID))return;/*AdjustExtendedPrefixTLVsize*/TLV_LEN(
exti->prefix)=htons(ntohs(TLV_LEN(exti->node_sid))+EXT_TLV_PREFIX_SIZE+TLV_HDR_S
IZE);/*BuildLSAbodyforanExtendedPrefixTLV*/build_tlv_header(s,&exti->prefix.head
er);stream_put(s,TLV_DATA(&exti->prefix.header),EXT_TLV_PREFIX_SIZE);/*ThenaddPr
efixSIDSubTLV*/build_tlv(s,&exti->node_sid.header);}/*BuildanExtendedLinkOpaqueL
SAbodyforextendedlinkTLV*/staticvoidospf_ext_link_lsa_body_set(structstream*s,st
ructext_itf*exti){size_tsize;/*Sanitycheck*/if((exti==NULL)||((exti->stype!=ADJ_
SID)&&(exti->stype!=LAN_ADJ_SID)))return;if(exti->stype==ADJ_SID){/*AdjustExtend
edLinkTLVsizeforAdj.SID*/size=EXT_TLV_LINK_SIZE+2*EXT_SUBTLV_ADJ_SID_SIZE+2*TLV_
HDR_SIZE;if(ntohs(TLV_TYPE(exti->rmt_itf_addr))!=0)size=size+EXT_SUBTLV_RMT_ITF_
ADDR_SIZE+TLV_HDR_SIZE;TLV_LEN(exti->link)=htons(size);/*BuildLSAbodyforanExtend
edLinkTLVwithAdj.SID*/build_tlv_header(s,&exti->link.header);stream_put(s,TLV_DA
TA(&exti->link.header),EXT_TLV_LINK_SIZE);/*thenaddAdjacencySubTLVs*/build_tlv(s
,&exti->adj_sid[1].header);build_tlv(s,&exti->adj_sid[0].header);/*AddCiscoexper
imentalSubTLVifinterfaceisPtoP*/if(ntohs(TLV_TYPE(exti->rmt_itf_addr))!=0)build_
tlv(s,&exti->rmt_itf_addr.header);}else{/*AdjustExtendedLinkTLVsizeforLANSID*/si
ze=EXT_TLV_LINK_SIZE+2*(EXT_SUBTLV_LAN_ADJ_SID_SIZE+TLV_HDR_SIZE);TLV_LEN(exti->
link)=htons(size);/*BuildLSAbodyforanExtendedLinkTLVwithLANSID*/build_tlv_header
(s,&exti->link.header);stream_put(s,TLV_DATA(&exti->link.header),EXT_TLV_LINK_SI
ZE);/*thenaddLAN-AdjacencySubTLVs*/build_tlv(s,&exti->lan_sid[1].header);build_t
lv(s,&exti->lan_sid[0].header);}}/*CreatenewExtendedPrefixopaque-LSAforeveryexte
ndedprefix*/staticstructospf_lsa*ospf_ext_pref_lsa_new(structospf_area*area,stru
ctext_itf*exti){structstream*s;structlsa_header*lsah;structospf_lsa*new=NULL;str
uctospf*top;uint8_toptions,lsa_type;structin_addrlsa_id;structin_addrrouter_id;u
int32_ttmp;uint16_tlength;/*SanityCheck*/if(exti==NULL)returnNULL;/*Createastrea
mforLSA.*/s=stream_new(OSPF_MAX_LSA_SIZE);if(s==NULL){zlog_warn("EXT(%s):stream_
new()error",__func__);returnNULL;}/*PrepareLSAHeader*/lsah=(structlsa_header*)ST
REAM_DATA(s);lsa_type=OspfEXT.scope;/**LSAIDisavariablenumberidentifyingdifferen
tinstancesof*ExtendedPrefixOpaqueLSAfromthesamerouterseeRFC7684*/tmp=SET_OPAQUE_
LSID(OPAQUE_TYPE_EXTENDED_PREFIX_LSA,exti->instance);lsa_id.s_addr=htonl(tmp);op
tions=OSPF_OPTION_O;/*Don'tforgetthis:-)*//*FixOptionsandRouterIDdependingofthef
loodingscope*/if((OspfEXT.scope==OSPF_OPAQUE_AS_LSA)||(area==NULL)){options=OSPF
_OPTION_E;top=ospf_lookup_by_vrf_id(VRF_DEFAULT);router_id.s_addr=top?top->route
r_id.s_addr:0;}else{options|=LSA_OPTIONS_GET(area);/*Getareadefaultoption*/optio
ns|=LSA_OPTIONS_NSSA_GET(area);router_id=area->ospf->router_id;}/*Setopaque-LSAh
eaderfields.*/lsa_header_set(s,options,lsa_type,lsa_id,router_id);if(IS_DEBUG_OS
PF(lsa,LSA_GENERATE))zlog_debug("EXT(%s):LSA[Type%u:%s]:CreateanOpaque-LSA""Exte
ndedPrefixOpaqueLSAinstance",__func__,lsa_type,inet_ntoa(lsa_id));/*Setopaque-LS
Abodyfields.*/ospf_ext_pref_lsa_body_set(s,exti);/*Setlength.*/length=stream_get
_endp(s);lsah->length=htons(length);/*Now,createanOSPFLSAinstance.*/new=ospf_lsa
_new();if(new==NULL){zlog_warn("EXT(%s):ospf_lsa_new()error",__func__);stream_fr
ee(s);returnNULL;}new->data=ospf_lsa_data_new(length);if(new->data==NULL){zlog_w
arn("EXT(%s):ospf_lsa_data_new()error",__func__);ospf_lsa_unlock(&new);new=NULL;
stream_free(s);returnNULL;}/*SegmentRoutingbelongsonlytodefaultVRF*/new->vrf_id=
VRF_DEFAULT;new->area=area;SET_FLAG(new->flags,OSPF_LSA_SELF);memcpy(new->data,l
sah,length);stream_free(s);returnnew;}/*CreatenewExtendedLinkopaque-LSAforeverye
xtendedlinkTLV*/staticstructospf_lsa*ospf_ext_link_lsa_new(structospf_area*area,
structext_itf*exti){structstream*s;structlsa_header*lsah;structospf_lsa*new=NULL
;uint8_toptions,lsa_type;structin_addrlsa_id;uint32_ttmp;uint16_tlength;/*Sanity
Check*/if(exti==NULL)returnNULL;/*CreateastreamforLSA.*/s=stream_new(OSPF_MAX_LS
A_SIZE);if(s==NULL){zlog_warn("EXT(%s):stream_new()error",__func__);returnNULL;}
lsah=(structlsa_header*)STREAM_DATA(s);options=OSPF_OPTION_O;/*Don'tforgetthis:-
)*/options|=LSA_OPTIONS_GET(area);/*Getareadefaultoption*/options|=LSA_OPTIONS_N
SSA_GET(area);/*ExtendedLinkOpaqueLSAareonlyfloodedwithinanarea*/lsa_type=OSPF_O
PAQUE_AREA_LSA;/**LSAIDisavariablenumberidentifyingdifferentinstancesof*Extended
LinkOpaqueLSAfromthesamerouterseeRFC7684*/tmp=SET_OPAQUE_LSID(OPAQUE_TYPE_EXTEND
ED_LINK_LSA,exti->instance);lsa_id.s_addr=htonl(tmp);if(IS_DEBUG_OSPF(lsa,LSA_GE
NERATE))zlog_debug("EXT(%s)LSA[Type%u:%s]:CreateanOpaque-LSA""ExtendedLinkOpaque
LSAinstance",__func__,lsa_type,inet_ntoa(lsa_id));/*Setopaque-LSAheaderfields.*/
lsa_header_set(s,options,lsa_type,lsa_id,area->ospf->router_id);/*Setopaque-LSAb
odyfields.*/ospf_ext_link_lsa_body_set(s,exti);/*Setlength.*/length=stream_get_e
ndp(s);lsah->length=htons(length);/*Now,createanOSPFLSAinstance.*/new=ospf_lsa_n
ew();if(new==NULL){zlog_warn("EXT(%s):ospf_lsa_new()error",__func__);stream_free
(s);returnNULL;}new->data=ospf_lsa_data_new(length);if(new->data==NULL){zlog_war
n("EXT(%s):ospf_lsa_data_new()error",__func__);ospf_lsa_unlock(&new);new=NULL;st
ream_free(s);returnNULL;}/*SegmentRoutingbelongsonlytodefaultVRF*/new->vrf_id=VR
F_DEFAULT;new->area=area;SET_FLAG(new->flags,OSPF_LSA_SELF);memcpy(new->data,lsa
h,length);stream_free(s);returnnew;}/**ProcesstheoriginationofanExtendedPrefixOp
aqueLSA*foreveryextendedprefixTLV*/staticintospf_ext_pref_lsa_originate1(structo
spf_area*area,structext_itf*exti){structospf_lsa*new;intrc=-1;/*CreatenewOpaque-
LSA/ExtendedPrefixOpaqueLSAinstance.*/new=ospf_ext_pref_lsa_new(area,exti);if(ne
w==NULL){zlog_warn("EXT(%s):ospf_ext_pref_lsa_new()error",__func__);returnrc;}/*
InstallthisLSAintoLSDB.*/if(ospf_lsa_install(area->ospf,NULL/*oi*/,new)==NULL){z
log_warn("EXT(%s):ospf_lsa_install()error",__func__);ospf_lsa_unlock(&new);retur
nrc;}/*NowthisExtendedPrefixOpaqueLSAinfoparameterentryhas*associatedLSA.*/SET_F
LAG(exti->flags,EXT_LPFLG_LSA_ENGAGED);/*UpdatenewLSAoriginationcount.*/area->os
pf->lsa_originate_count++;/*FloodnewLSAthrougharea.*/ospf_flood_through_area(are
a,NULL/*nbr*/,new);if(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){chararea_id[INET_ADDRSTRL
EN];strncpy(area_id,inet_ntoa(area->area_id),INET_ADDRSTRLEN);zlog_debug("EXT(%s
):LSA[Type%u:%s]:OriginateOpaque-LSA""ExtendedPrefixOpaqueLSA:Area(%s),Link(%s)"
,__func__,new->data->type,inet_ntoa(new->data->id),area_id,exti->ifp->name);ospf
_lsa_header_dump(new->data);}rc=0;returnrc;}/**ProcesstheoriginationofanExtended
LinkOpaqueLSA*foreveryextendedlinkTLV*/staticintospf_ext_link_lsa_originate1(str
uctospf_area*area,structext_itf*exti){structospf_lsa*new;intrc=-1;/*CreatenewOpa
que-LSA/ExtendedLinkOpaqueLSAinstance.*/new=ospf_ext_link_lsa_new(area,exti);if(
new==NULL){zlog_warn("EXT(%s):ospf_ext_link_lsa_new()error",__func__);returnrc;}
/*InstallthisLSAintoLSDB.*/if(ospf_lsa_install(area->ospf,NULL/*oi*/,new)==NULL)
{zlog_warn("EXT(%s):ospf_lsa_install()error",__func__);ospf_lsa_unlock(&new);ret
urnrc;}/*Nowthislink-parameterentryhasassociatedLSA.*/SET_FLAG(exti->flags,EXT_L
PFLG_LSA_ENGAGED);/*UpdatenewLSAoriginationcount.*/area->ospf->lsa_originate_cou
nt++;/*FloodnewLSAthrougharea.*/ospf_flood_through_area(area,NULL/*nbr*/,new);if
(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){chararea_id[INET_ADDRSTRLEN];strncpy(area_id,i
net_ntoa(area->area_id),INET_ADDRSTRLEN);zlog_debug("EXT(%s):LSA[Type%u:%s]:Orig
inateOpaque-LSA""ExtendedLinkOpaqueLSA:Area(%s),Link(%s)",__func__,new->data->ty
pe,inet_ntoa(new->data->id),area_id,exti->ifp->name);ospf_lsa_header_dump(new->d
ata);}rc=0;returnrc;}/*TriggertheoriginationofExtendedPrefixOpaqueLSAs*/staticin
tospf_ext_pref_lsa_originate(void*arg){structospf_area*area=(structospf_area*)ar
g;structlistnode*node;structext_itf*exti;intrc=-1;if(!OspfEXT.enabled){zlog_info
("EXT(%s):SegmentRouting""functionalityisDisablednow",__func__);rc=0;/*Thisisnot
anerrorcase.*/returnrc;}if(IS_DEBUG_OSPF_SR)zlog_debug("EXT(%s):StartOriginatePr
efixLSAforarea%s",__func__,inet_ntoa(area->area_id));/*CheckifExtendedPrefixOpaq
ueLSAisalreadyengaged*/for(ALL_LIST_ELEMENTS_RO(OspfEXT.iflist,node,exti)){/*Pro
cessonlyPrefixSID*/if(exti->stype!=PREF_SID)continue;/*ProcessonlyExtendedPrefix
withvalidAreaID*/if((exti->area==NULL)||(!IPV4_ADDR_SAME(&exti->area->area_id,&a
rea->area_id)))continue;if(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED)){if(CHE
CK_FLAG(exti->flags,EXT_LPFLG_LSA_FORCED_REFRESH)){zlog_warn("EXT(%s):Refreshins
teadof""Originate",__func__);UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_FORCED_REFRESH
);ospf_ext_pref_lsa_schedule(exti,REFRESH_THIS_LSA);}continue;}/*Ok,let'strytoor
iginateanLSA*/if(IS_DEBUG_OSPF_SR)zlog_debug("EXT(%s):Let'sfinallyreoriginatethe
""LSA7.0.0.%uforItf%s",__func__,exti->instance,exti->ifp?exti->ifp->name:"");osp
f_ext_pref_lsa_originate1(area,exti);}rc=0;returnrc;}/*TriggertheoriginationofEx
tendedLinkOpaqueLSAs*/staticintospf_ext_link_lsa_originate(void*arg){structospf_
area*area=(structospf_area*)arg;structlistnode*node;structext_itf*exti;intrc=-1;
if(!OspfEXT.enabled){zlog_info("EXT(%s):SegmentRouting""functionalityisDisabledn
ow",__func__);rc=0;/*Thisisnotanerrorcase.*/returnrc;}/*CheckifExtendedPrefixOpa
queLSAisalreadyengaged*/for(ALL_LIST_ELEMENTS_RO(OspfEXT.iflist,node,exti)){/*Pr
ocessonlyAdjacencyorLANSID*/if(exti->stype==PREF_SID)continue;/*ProcessonlyExten
dedLinkwithvalidAreaID*/if((exti->area==NULL)||(!IPV4_ADDR_SAME(&exti->area->are
a_id,&area->area_id)))continue;/*CheckifLSAnotalreadyengaged*/if(CHECK_FLAG(exti
->flags,EXT_LPFLG_LSA_ENGAGED)){if(CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_FORCED_R
EFRESH)){zlog_warn("EXT(%s):Refreshinsteadof""Originate",__func__);UNSET_FLAG(ex
ti->flags,EXT_LPFLG_LSA_FORCED_REFRESH);ospf_ext_link_lsa_schedule(exti,REFRESH_
THIS_LSA);}continue;}/*Ok,let'strytooriginateanLSA*/if(IS_DEBUG_OSPF_SR)zlog_deb
ug("EXT(%s):Let'sfinallyreoriginatethe""LSA8.0.0.%uforItf%sthroughtheArea%s",__f
unc__,exti->instance,exti->ifp?exti->ifp->name:"-",inet_ntoa(area->area_id));osp
f_ext_link_lsa_originate1(area,exti);}rc=0;returnrc;}/*RefreshanExtendedPrefixOp
aqueLSA*/staticstructospf_lsa*ospf_ext_pref_lsa_refresh(structospf_lsa*lsa){stru
ctospf_lsa*new=NULL;structospf_area*area=lsa->area;structospf*top;structext_itf*
exti;if(!OspfEXT.enabled){/**ThisLSAmusthaveflushedbeforeduetoExtendedPrefix*Opa
queLSAstatuschange.*Itseemsaslipamongroutersintheroutingdomain.*/zlog_info("EXT(
%s):SegmentRoutingfunctionalityis""Disabled",__func__);/*Flushitanyway.*/lsa->da
ta->ls_age=htons(OSPF_LSA_MAXAGE);}/*LookupthislsacorrespondingExtendedparameter
s*/exti=lookup_ext_by_instance(lsa);if(exti==NULL){zlog_warn("EXT(%s):Invalidpar
ameterLSAID",__func__);/*Flushitanyway.*/lsa->data->ls_age=htons(OSPF_LSA_MAXAGE
);}/*CheckifInterfacewasnotdisableintheinterval*/if((exti!=NULL)&&!CHECK_FLAG(ex
ti->flags,EXT_LPFLG_LSA_ACTIVE)){zlog_warn("EXT(%s):InterfacewasDisabled:Flushit
!",__func__);/*Flushitanyway.*/lsa->data->ls_age=htons(OSPF_LSA_MAXAGE);}/*Ifthe
lsa'sagereachedtoMaxAge,startflushingprocedure.*/if(IS_LSA_MAXAGE(lsa)){if(exti)
UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED);ospf_opaque_lsa_flush_schedule(lsa
);returnNULL;}/*CreatenewOpaque-LSA/ExtendedPrefixOpaqueLSAinstance.*/new=ospf_e
xt_pref_lsa_new(area,exti);if(new==NULL){zlog_warn("EXT(%s):ospf_ext_pref_lsa_ne
w()error",__func__);returnNULL;}new->data->ls_seqnum=lsa_seqnum_increment(lsa);/
**InstallthisLSAintoLSDB*Given"lsa"willbefreedinthenextfunction*AsareacouldbeNUL
Li.e.whenusingOPAQUE_LSA_AS,weprefertouse*ospf_lookup()togetospfinstance*/if(are
a)top=area->ospf;elsetop=ospf_lookup_by_vrf_id(VRF_DEFAULT);if(ospf_lsa_install(
top,NULL/*oi*/,new)==NULL){zlog_warn("EXT(%s):ospf_lsa_install()error",__func__)
;ospf_lsa_unlock(&new);returnNULL;}/*FloodupdatedLSAthroughthePrefixAreaaccordin
gtotheRFC7684*/ospf_flood_through_area(area,NULL/*nbr*/,new);/*Debuglogging.*/if
(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){zlog_debug("EXT(%s):LSA[Type%u:%s]RefreshExten
dedPrefixLSA",__func__,new->data->type,inet_ntoa(new->data->id));ospf_lsa_header
_dump(new->data);}returnnew;}/*RefreshanExtendedLinkOpaqueLSA*/staticstructospf_
lsa*ospf_ext_link_lsa_refresh(structospf_lsa*lsa){structext_itf*exti;structospf_
area*area=lsa->area;structospf*top=area->ospf;structospf_lsa*new=NULL;if(!OspfEX
T.enabled){/**ThisLSAmusthaveflushedbeforeduetoOSPF-SRstatus*change.Itseemsaslip
amongroutersintheroutingdomain.*/zlog_info("EXT(%s):SegmentRoutingfunctionalityi
sDisabled",__func__);/*Flushitanyway.*/lsa->data->ls_age=htons(OSPF_LSA_MAXAGE);
}/*LookupthisLSAcorrespondingExtendedparameters*/exti=lookup_ext_by_instance(lsa
);if(exti==NULL){zlog_warn("EXT(%s):InvalidparameterLSAID",__func__);/*Flushitan
yway.*/lsa->data->ls_age=htons(OSPF_LSA_MAXAGE);}/*CheckifInterfacewasnotdisable
intheinterval*/if((exti!=NULL)&&!CHECK_FLAG(exti->flags,EXT_LPFLG_LSA_ACTIVE)){z
log_warn("EXT(%s):InterfacewasDisabled:Flushit!",__func__);lsa->data->ls_age=hto
ns(OSPF_LSA_MAXAGE);}/*Ifthelsa'sagereachedtoMaxAge,startflushingprocedure*/if(I
S_LSA_MAXAGE(lsa)){if(exti)UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_ENGAGED);ospf_op
aque_lsa_flush_schedule(lsa);returnNULL;}/*CreatenewOpaque-LSA/ExtendedLinkinsta
nce*/new=ospf_ext_link_lsa_new(area,exti);if(new==NULL){zlog_warn("EXT(%s):Error
creatingnewLSA",__func__);returnNULL;}new->data->ls_seqnum=lsa_seqnum_increment(
lsa);/*InstallthisLSAintoLSDB.*//*Given"lsa"willbefreedinthenextfunction*/if(osp
f_lsa_install(top,NULL/*oi*/,new)==NULL){zlog_warn("EXT(%s):ErrorinstallingnewLS
A",__func__);ospf_lsa_unlock(&new);returnNULL;}/*FloodupdatedLSAthroughthelinkAr
eaaccordingtotheRFC7684*/ospf_flood_through_area(area,NULL/*nbr*/,new);/*Debuglo
gging.*/if(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){zlog_debug("EXT(%s):LSA[Type%u:%s]:R
efreshExtendedLinkLSA",__func__,new->data->type,inet_ntoa(new->data->id));ospf_l
sa_header_dump(new->data);}returnnew;}/*ScheduleExtendedPrefixOpaqueLSAoriginati
on/refreshment/flushing*/staticvoidospf_ext_pref_lsa_schedule(structext_itf*exti
,enumlsa_opcodeopcode){structospf_lsalsa;structlsa_headerlsah;structospf*top;uin
t32_ttmp;memset(&lsa,0,sizeof(lsa));memset(&lsah,0,sizeof(lsah));/*SanityCheck*/
if(exti==NULL)return;/*Checkifthecorrespondinglinkisreadytobeflooded*/if(!(CHECK
_FLAG(exti->flags,EXT_LPFLG_LSA_ACTIVE)))return;zlog_debug("EXT(%s):Schedule%s%s
%sLSAforinterface%s",__func__,opcode==REORIGINATE_THIS_LSA?"Re-Originate":"",opc
ode==REFRESH_THIS_LSA?"Refresh":"",opcode==FLUSH_THIS_LSA?"Flush":"",exti->ifp?e
xti->ifp->name:"-");/*SetLSAheaderinformation*/if(exti->area==NULL){zlog_warn("E
XT(%s):FloodingisAreascopebutareaisnotyet""set",__func__);if(OspfEXT.area==NULL)
{top=ospf_lookup_by_vrf_id(VRF_DEFAULT);OspfEXT.area=ospf_area_lookup_by_area_id
(top,OspfEXT.area_id);}exti->area=OspfEXT.area;}lsa.area=exti->area;lsa.data=&ls
ah;lsah.type=OSPF_OPAQUE_AREA_LSA;tmp=SET_OPAQUE_LSID(OPAQUE_TYPE_EXTENDED_PREFI
X_LSA,exti->instance);lsah.id.s_addr=htonl(tmp);switch(opcode){caseREORIGINATE_T
HIS_LSA:ospf_opaque_lsa_reoriginate_schedule((void*)exti->area,OSPF_OPAQUE_AREA_
LSA,OPAQUE_TYPE_EXTENDED_PREFIX_LSA);break;caseREFRESH_THIS_LSA:ospf_opaque_lsa_
refresh_schedule(&lsa);break;caseFLUSH_THIS_LSA:UNSET_FLAG(exti->flags,EXT_LPFLG
_LSA_ENGAGED);ospf_opaque_lsa_flush_schedule(&lsa);break;default:zlog_warn("EXT(
%s):Unknownopcode",__func__);break;}}/*ScheduleExtendedLinkOpaqueLSAorigination/
refreshment/flushing*/staticvoidospf_ext_link_lsa_schedule(structext_itf*exti,en
umlsa_opcodeopcode){structospf_lsalsa;structlsa_headerlsah;structospf*top;uint32
_ttmp;memset(&lsa,0,sizeof(lsa));memset(&lsah,0,sizeof(lsah));/*SanityCheck*/if(
exti==NULL)return;/*Checkifthecorrespondinglinkisreadytobeflooded*/if(!(CHECK_FL
AG(exti->flags,EXT_LPFLG_LSA_ACTIVE)))return;zlog_debug("EXT(%s):Schedule%s%s%sL
SAforinterface%s",__func__,opcode==REORIGINATE_THIS_LSA?"Re-Originate":"",opcode
==REFRESH_THIS_LSA?"Refresh":"",opcode==FLUSH_THIS_LSA?"Flush":"",exti->ifp?exti
->ifp->name:"-");/*SetLSAheaderinformation*/if(exti->area==NULL){zlog_warn("EXT(
%s):FloodingisAreascopebutareaisnot""yetset",__func__);if(OspfEXT.area==NULL){to
p=ospf_lookup_by_vrf_id(VRF_DEFAULT);OspfEXT.area=ospf_area_lookup_by_area_id(to
p,OspfEXT.area_id);}exti->area=OspfEXT.area;}lsa.area=exti->area;lsa.data=&lsah;
lsah.type=OSPF_OPAQUE_AREA_LSA;tmp=SET_OPAQUE_LSID(OPAQUE_TYPE_EXTENDED_LINK_LSA
,exti->instance);lsah.id.s_addr=htonl(tmp);switch(opcode){caseREORIGINATE_THIS_L
SA:ospf_opaque_lsa_reoriginate_schedule((void*)exti->area,OSPF_OPAQUE_AREA_LSA,O
PAQUE_TYPE_EXTENDED_LINK_LSA);break;caseREFRESH_THIS_LSA:ospf_opaque_lsa_refresh
_schedule(&lsa);break;caseFLUSH_THIS_LSA:UNSET_FLAG(exti->flags,EXT_LPFLG_LSA_EN
GAGED);ospf_opaque_lsa_flush_schedule(&lsa);break;default:zlog_warn("EXT(%s):Unk
nownopcode",__func__);break;}}/*ScheduleExtendedLinkorPrefixdependingoftheTypeof
LSA*/staticvoidospf_ext_lsa_schedule(structext_itf*exti,enumlsa_opcodeop){if(ext
i->stype==PREF_SID)ospf_ext_pref_lsa_schedule(exti,op);elseospf_ext_link_lsa_sch
edule(exti,op);}/**------------------------------------*Followingsarevtyshowfunc
tions.*------------------------------------*//*CiscoexperimentalSubTLV*/staticui
nt16_tshow_vty_ext_link_rmt_itf_addr(structvty*vty,structtlv_header*tlvh){struct
ext_subtlv_rmt_itf_addr*top;top=(structext_subtlv_rmt_itf_addr*)tlvh;vty_out(vty
,"RemoteInterfaceAddressSub-TLV:Length%u\n""Address:%s\n",ntohs(top->header.leng
th),inet_ntoa(top->value));returnTLV_SIZE(tlvh);}/*AdjacencySIDSubTLV*/staticuin
t16_tshow_vty_ext_link_adj_sid(structvty*vty,structtlv_header*tlvh){structext_su
btlv_adj_sid*top=(structext_subtlv_adj_sid*)tlvh;vty_out(vty,"Adj-SIDSub-TLV:Len
gth%u\n\tFlags:""0x%x\n\tMT-ID:0x%x\n\tWeight:0x%x\n\t%s:%u\n",ntohs(top->header
.length),top->flags,top->mtid,top->weight,CHECK_FLAG(top->flags,EXT_SUBTLV_LINK_
ADJ_SID_VFLG)?"Label":"Index",CHECK_FLAG(top->flags,EXT_SUBTLV_LINK_ADJ_SID_VFLG
)?GET_LABEL(ntohl(top->value)):ntohl(top->value));returnTLV_SIZE(tlvh);}/*LANAdj
acencySubTLV*/staticuint16_tshow_vty_ext_link_lan_adj_sid(structvty*vty,structtl
v_header*tlvh){structext_subtlv_lan_adj_sid*top=(structext_subtlv_lan_adj_sid*)t
lvh;vty_out(vty,"LAN-Adj-SIDSub-TLV:Length%u\n\tFlags:""0x%x\n\tMT-ID:0x%x\n\tWe
ight:0x%x\n\tNeighborID:""%s\n\t%s:%u\n",ntohs(top->header.length),top->flags,to
p->mtid,top->weight,inet_ntoa(top->neighbor_id),CHECK_FLAG(top->flags,EXT_SUBTLV
_LINK_ADJ_SID_VFLG)?"Label":"Index",CHECK_FLAG(top->flags,EXT_SUBTLV_LINK_ADJ_SI
D_VFLG)?GET_LABEL(ntohl(top->value)):ntohl(top->value));returnTLV_SIZE(tlvh);}st
aticuint16_tshow_vty_unknown_tlv(structvty*vty,structtlv_header*tlvh){vty_out(vt
y,"UnknownTLV:[type(0x%x),length(0x%x)]\n",ntohs(tlvh->type),ntohs(tlvh->length)
);returnTLV_SIZE(tlvh);}/*ExtendedLinkSubTLVs*/staticuint16_tshow_vty_link_info(
structvty*vty,structtlv_header*ext){structext_tlv_link*top=(structext_tlv_link*)
ext;structtlv_header*tlvh;uint16_tlength=ntohs(top->header.length)-3*sizeof(uint
32_t);uint16_tsum=0;vty_out(vty,"ExtendedLinkTLV:Length%u\nLinkType:0x%x\n""Link
ID:%s\n",ntohs(top->header.length),top->link_type,inet_ntoa(top->link_id));vty_o
ut(vty,"Linkdata:%s\n",inet_ntoa(top->link_data));tlvh=(structtlv_header*)((char
*)(ext)+TLV_HDR_SIZE+EXT_TLV_LINK_SIZE);for(;sum<length;tlvh=TLV_HDR_NEXT(tlvh))
{switch(ntohs(tlvh->type)){caseEXT_SUBTLV_ADJ_SID:sum+=show_vty_ext_link_adj_sid
(vty,tlvh);break;caseEXT_SUBTLV_LAN_ADJ_SID:sum+=show_vty_ext_link_lan_adj_sid(v
ty,tlvh);break;caseEXT_SUBTLV_RMT_ITF_ADDR:sum+=show_vty_ext_link_rmt_itf_addr(v
ty,tlvh);break;default:sum+=show_vty_unknown_tlv(vty,tlvh);break;}}returnsum+siz
eof(structext_tlv_link);}/*ExtendedLinkTLVs*/staticvoidospf_ext_link_show_info(s
tructvty*vty,structospf_lsa*lsa){structlsa_header*lsah=(structlsa_header*)lsa->d
ata;structtlv_header*tlvh;uint16_tlength=0,sum=0;/*InitializeTLVbrowsing*/length
=ntohs(lsah->length)-OSPF_LSA_HEADER_SIZE;for(tlvh=TLV_HDR_TOP(lsah);sum<length;
tlvh=TLV_HDR_NEXT(tlvh)){switch(ntohs(tlvh->type)){caseEXT_TLV_LINK:sum+=show_vt
y_link_info(vty,tlvh);break;default:sum+=show_vty_unknown_tlv(vty,tlvh);break;}}
}/*PrefixSIDSubTLV*/staticuint16_tshow_vty_ext_pref_pref_sid(structvty*vty,struc
ttlv_header*tlvh){structext_subtlv_prefix_sid*top=(structext_subtlv_prefix_sid*)
tlvh;vty_out(vty,"PrefixSIDSub-TLV:Length%u\n\tAlgorithm:""%u\n\tFlags:0x%x\n\tM
T-ID:0x%x\n\t%s:%u\n",ntohs(top->header.length),top->algorithm,top->flags,top->m
tid,CHECK_FLAG(top->flags,EXT_SUBTLV_PREFIX_SID_VFLG)?"Label":"Index",CHECK_FLAG
(top->flags,EXT_SUBTLV_PREFIX_SID_VFLG)?GET_LABEL(ntohl(top->value)):ntohl(top->
value));returnTLV_SIZE(tlvh);}/*ExtendedPrefixSubTLVs*/staticuint16_tshow_vty_pr
ef_info(structvty*vty,structtlv_header*ext){structext_tlv_prefix*top=(structext_
tlv_prefix*)ext;structtlv_header*tlvh;uint16_tlength=ntohs(top->header.length)-2
*sizeof(uint32_t);uint16_tsum=0;vty_out(vty,"ExtendedPrefixTLV:Length%u\n\tRoute
Type:%u\n""\tAddressFamily:0x%x\n\tFlags:0x%x\n\tAddress:%s/%u\n",ntohs(top->hea
der.length),top->route_type,top->af,top->flags,inet_ntoa(top->address),top->pref
_length);tlvh=(structtlv_header*)((char*)(ext)+TLV_HDR_SIZE+EXT_TLV_PREFIX_SIZE)
;for(;sum<length;tlvh=TLV_HDR_NEXT(tlvh)){switch(ntohs(tlvh->type)){caseEXT_SUBT
LV_PREFIX_SID:sum+=show_vty_ext_pref_pref_sid(vty,tlvh);break;default:sum+=show_
vty_unknown_tlv(vty,tlvh);break;}}returnsum+sizeof(structext_tlv_prefix);}/*Exte
ndedPrefixTLVs*/staticvoidospf_ext_pref_show_info(structvty*vty,structospf_lsa*l
sa){structlsa_header*lsah=(structlsa_header*)lsa->data;structtlv_header*tlvh;uin
t16_tlength=0,sum=0;/*InitializeTLVbrowsing*/length=ntohs(lsah->length)-OSPF_LSA
_HEADER_SIZE;for(tlvh=TLV_HDR_TOP(lsah);sum<length;tlvh=TLV_HDR_NEXT(tlvh)){swit
ch(ntohs(tlvh->type)){caseEXT_TLV_PREFIX:sum+=show_vty_pref_info(vty,tlvh);break
;default:sum+=show_vty_unknown_tlv(vty,tlvh);break;}}}