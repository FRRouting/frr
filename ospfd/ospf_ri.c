/**ThisisanimplementationofRFC4970RouterInformation*withsupportofRFC5088PCECapab
ilitesannouncement**Modulename:RouterInformation*Author:OlivierDugeon<olivier.du
geon@orange.com>*Copyright(C)2012-2017OrangeLabshttp://www.orange.com/**Thisfile
ispartofGNUQuagga.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*un
derthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;e
itherversion2,or(atyouroption)any*laterversion.**GNUQuaggaisdistributedinthehope
thatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHA
NTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredet
ails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogr
am;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,F
ifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include<math.h>#include"link
list.h"#include"prefix.h"#include"if.h"#include"table.h"#include"memory.h"#inclu
de"command.h"#include"vty.h"#include"stream.h"#include"log.h"#include"thread.h"#
include"hash.h"#include"sockunion.h"/*forinet_aton()*/#include"mpls.h"#include"o
spfd/ospfd.h"#include"ospfd/ospf_interface.h"#include"ospfd/ospf_ism.h"#include"
ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_lsdb.h"#include"
ospfd/ospf_neighbor.h"#include"ospfd/ospf_nsm.h"#include"ospfd/ospf_flood.h"#inc
lude"ospfd/ospf_packet.h"#include"ospfd/ospf_spf.h"#include"ospfd/ospf_dump.h"#i
nclude"ospfd/ospf_route.h"#include"ospfd/ospf_ase.h"#include"ospfd/ospf_zebra.h"
#include"ospfd/ospf_sr.h"#include"ospfd/ospf_ri.h"/*StoreRouterInformationPCETLV
andSubTLVinnetworkbyteorder.*/structospf_pce_info{boolenabled;structri_tlv_pcepc
e_header;structri_pce_subtlv_addresspce_address;structri_pce_subtlv_path_scopepc
e_scope;structlist*pce_domain;structlist*pce_neighbor;structri_pce_subtlv_cap_fl
agpce_cap_flag;};/**StoreRouterInformationSegmentRoutingTLVandSubTLV*innetworkby
teorder*/structospf_ri_sr_info{boolenabled;/*Algorithmssupportedbythenode*/struc
tri_sr_tlv_sr_algorithmalgo;/**SegmentRoutingGlobalBlocki.e.labelrange*Onlyonera
ngesupportedinthiscode*/structri_sr_tlv_sid_label_rangerange;/*MaximumSIDDepthsu
pportedbythenode*/structri_sr_tlv_node_msdmsd;};/*Followingstructureareinternalu
seonly.*/structospf_router_info{boolenabled;uint8_tregistered;uint8_tscope;/*Fla
gstomanagethisrouterinformation.*/#defineRIFLG_LSA_ENGAGED0x1#defineRIFLG_LSA_FO
RCED_REFRESH0x2uint32_tflags;/*areapointeriffloodingisType10NulliffloodingisASsc
ope*/structospf_area*area;structin_addrarea_id;/*StoreRouterInformationCapabilit
iesLSA*/structri_tlv_router_caprouter_cap;/*StorePCEcapabilityLSA*/structospf_pc
e_infopce_info;/*StoreSRcapabilityLSA*/structospf_ri_sr_infosr_info;};/**Globalv
ariabletomanageOpaque-LSA/RouterInformationonthisnode.*Notethatallparametervalue
sarestoredinnetworkbyteorder.*/staticstructospf_router_infoOspfRI;/*------------
------------------------------------------------------------------**Followingsar
einitialize/terminatefunctionsforRouterInformation*handling.*-------------------
-----------------------------------------------------------*/staticvoidospf_rout
er_info_ism_change(structospf_interface*oi,intold_status);staticvoidospf_router_
info_nsm_change(structospf_neighbor*nbr,intold_status);staticvoidospf_router_inf
o_config_write_router(structvty*vty);staticvoidospf_router_info_show_info(struct
vty*vty,structospf_lsa*lsa);staticintospf_router_info_lsa_originate(void*arg);st
aticstructospf_lsa*ospf_router_info_lsa_refresh(structospf_lsa*lsa);staticvoidos
pf_router_info_lsa_schedule(enumlsa_opcodeopcode);staticvoidospf_router_info_reg
ister_vty(void);staticintospf_router_info_lsa_update(structospf_lsa*lsa);staticv
oiddel_pce_info(void*val);intospf_router_info_init(void){zlog_info("RI->Initiali
zeRouterInformation");memset(&OspfRI,0,sizeof(structospf_router_info));OspfRI.en
abled=false;OspfRI.registered=0;OspfRI.scope=OSPF_OPAQUE_AS_LSA;OspfRI.area_id.s
_addr=0;OspfRI.flags=0;/*Initializepcedomainandneighborlist*/OspfRI.pce_info.ena
bled=false;OspfRI.pce_info.pce_domain=list_new();OspfRI.pce_info.pce_domain->del
=del_pce_info;OspfRI.pce_info.pce_neighbor=list_new();OspfRI.pce_info.pce_neighb
or->del=del_pce_info;/*InitializeSegmentRoutinginformationstructure*/OspfRI.sr_i
nfo.enabled=false;ospf_router_info_register_vty();return0;}staticintospf_router_
info_register(uint8_tscope){intrc=0;if(OspfRI.registered)returnrc;zlog_info("RI-
>RegisterRouterInformationwithscope%s(%d)",scope==OSPF_OPAQUE_AREA_LSA?"Area":"A
S",scope);rc=ospf_register_opaque_functab(scope,OPAQUE_TYPE_ROUTER_INFORMATION_L
SA,NULL,/*newinterface*/NULL,/*delinterface*/ospf_router_info_ism_change,ospf_ro
uter_info_nsm_change,ospf_router_info_config_write_router,NULL,/*Config.writeint
erface*/NULL,/*Config.writedebug*/ospf_router_info_show_info,ospf_router_info_ls
a_originate,ospf_router_info_lsa_refresh,ospf_router_info_lsa_update,NULL);/*del
_lsa_hook*/if(rc!=0){zlog_warn("ospf_router_info_init:Failedtoregisterfunctions"
);returnrc;}OspfRI.registered=1;OspfRI.scope=scope;returnrc;}staticintospf_route
r_info_unregister(){if((OspfRI.scope!=OSPF_OPAQUE_AS_LSA)&&(OspfRI.scope!=OSPF_O
PAQUE_AREA_LSA)){zlog_warn("UnabletounregisterRouterInfofunctions:Wrongscope!");
return-1;}ospf_delete_opaque_functab(OspfRI.scope,OPAQUE_TYPE_ROUTER_INFORMATION
_LSA);OspfRI.registered=0;return0;}voidospf_router_info_term(void){list_delete_a
nd_null(&OspfRI.pce_info.pce_domain);list_delete_and_null(&OspfRI.pce_info.pce_n
eighbor);OspfRI.enabled=false;ospf_router_info_unregister();return;}voidospf_rou
ter_info_finish(void){list_delete_all_node(OspfRI.pce_info.pce_domain);list_dele
te_all_node(OspfRI.pce_info.pce_neighbor);OspfRI.enabled=false;}staticvoiddel_pc
e_info(void*val){XFREE(MTYPE_OSPF_PCE_PARAMS,val);return;}/*CatchRILSAfloodingSc
opeforospf_ext.[h,c]code*/structscope_infoospf_router_info_get_flooding_scope(vo
id){structscope_infoflooding_scope;if(OspfRI.scope==OSPF_OPAQUE_AS_LSA){flooding
_scope.scope=OSPF_OPAQUE_AS_LSA;flooding_scope.area_id.s_addr=0;returnflooding_s
cope;}flooding_scope.scope=OSPF_OPAQUE_AREA_LSA;flooding_scope.area_id.s_addr=Os
pfRI.area_id.s_addr;returnflooding_scope;}/*------------------------------------
------------------------------------**FollowingsarecontrolfunctionsforROUTERINFO
RMATIONparameters*management.*--------------------------------------------------
----------------------*/staticvoidset_router_info_capabilities(structri_tlv_rout
er_cap*ric,uint32_tcap){ric->header.type=htons(RI_TLV_CAPABILITIES);ric->header.
length=htons(RI_TLV_LENGTH);ric->value=htonl(cap);return;}staticintset_pce_heade
r(structospf_pce_info*pce){uint16_tlength=0;structlistnode*node;structri_pce_sub
tlv_domain*domain;structri_pce_subtlv_neighbor*neighbor;/*PCEAddress*/if(ntohs(p
ce->pce_address.header.type)!=0)length+=TLV_SIZE(&pce->pce_address.header);/*PCE
PathScope*/if(ntohs(pce->pce_scope.header.type)!=0)length+=TLV_SIZE(&pce->pce_sc
ope.header);/*PCEDomain*/for(ALL_LIST_ELEMENTS_RO(pce->pce_domain,node,domain)){
if(ntohs(domain->header.type)!=0)length+=TLV_SIZE(&domain->header);}/*PCENeighbo
r*/for(ALL_LIST_ELEMENTS_RO(pce->pce_neighbor,node,neighbor)){if(ntohs(neighbor-
>header.type)!=0)length+=TLV_SIZE(&neighbor->header);}/*PCECapabilities*/if(ntoh
s(pce->pce_cap_flag.header.type)!=0)length+=TLV_SIZE(&pce->pce_cap_flag.header);
if(length!=0){pce->pce_header.header.type=htons(RI_TLV_PCE);pce->pce_header.head
er.length=htons(length);pce->enabled=true;}else{pce->pce_header.header.type=0;pc
e->pce_header.header.length=0;pce->enabled=false;}returnlength;}staticvoidset_pc
e_address(structin_addripv4,structospf_pce_info*pce){/*EnablePCEInfo*/pce->pce_h
eader.header.type=htons(RI_TLV_PCE);/*SetPCEAddress*/pce->pce_address.header.typ
e=htons(RI_PCE_SUBTLV_ADDRESS);pce->pce_address.header.length=htons(PCE_ADDRESS_
LENGTH_IPV4);pce->pce_address.address.type=htons(PCE_ADDRESS_TYPE_IPV4);pce->pce
_address.address.value=ipv4;return;}staticvoidset_pce_path_scope(uint32_tscope,s
tructospf_pce_info*pce){/*SetPCEScope*/pce->pce_scope.header.type=htons(RI_PCE_S
UBTLV_PATH_SCOPE);pce->pce_scope.header.length=htons(RI_TLV_LENGTH);pce->pce_sco
pe.value=htonl(scope);return;}staticvoidset_pce_domain(uint16_ttype,uint32_tdoma
in,structospf_pce_info*pce){structri_pce_subtlv_domain*new;/*Createnewdomaininfo
*/new=XCALLOC(MTYPE_OSPF_PCE_PARAMS,sizeof(structri_pce_subtlv_domain));new->hea
der.type=htons(RI_PCE_SUBTLV_DOMAIN);new->header.length=htons(PCE_ADDRESS_LENGTH
_IPV4);new->type=htons(type);new->value=htonl(domain);/*Addnewdomaintothelist*/l
istnode_add(pce->pce_domain,new);return;}staticvoidunset_pce_domain(uint16_ttype
,uint32_tdomain,structospf_pce_info*pce){structlistnode*node;structri_pce_subtlv
_domain*old=NULL;intfound=0;/*Searchthecorrespondingnode*/for(ALL_LIST_ELEMENTS_
RO(pce->pce_domain,node,old)){if((old->type==htons(type))&&(old->value==htonl(do
main))){found=1;break;}}/*iffoundremoveit*/if(found){listnode_delete(pce->pce_do
main,old);/*Avoidmisjudgementinthenextlookup.*/if(listcount(pce->pce_domain)==0)
pce->pce_domain->head=pce->pce_domain->tail=NULL;/*Finallyfreetheolddomain*/XFRE
E(MTYPE_OSPF_PCE_PARAMS,old);}}staticvoidset_pce_neighbor(uint16_ttype,uint32_td
omain,structospf_pce_info*pce){structri_pce_subtlv_neighbor*new;/*Createnewneigh
borinfo*/new=XCALLOC(MTYPE_OSPF_PCE_PARAMS,sizeof(structri_pce_subtlv_neighbor))
;new->header.type=htons(RI_PCE_SUBTLV_NEIGHBOR);new->header.length=htons(PCE_ADD
RESS_LENGTH_IPV4);new->type=htons(type);new->value=htonl(domain);/*Addnewdomaint
othelist*/listnode_add(pce->pce_neighbor,new);return;}staticvoidunset_pce_neighb
or(uint16_ttype,uint32_tdomain,structospf_pce_info*pce){structlistnode*node;stru
ctri_pce_subtlv_neighbor*old=NULL;intfound=0;/*Searchthecorrespondingnode*/for(A
LL_LIST_ELEMENTS_RO(pce->pce_neighbor,node,old)){if((old->type==htons(type))&&(o
ld->value==htonl(domain))){found=1;break;}}/*iffoundremoveit*/if(found){listnode
_delete(pce->pce_neighbor,old);/*Avoidmisjudgementinthenextlookup.*/if(listcount
(pce->pce_neighbor)==0)pce->pce_neighbor->head=pce->pce_neighbor->tail=NULL;/*Fi
nallyfreetheolddomain*/XFREE(MTYPE_OSPF_PCE_PARAMS,old);}}staticvoidset_pce_cap_
flag(uint32_tcap,structospf_pce_info*pce){/*SetPCECapabilitiesflag*/pce->pce_cap
_flag.header.type=htons(RI_PCE_SUBTLV_CAP_FLAG);pce->pce_cap_flag.header.length=
htons(RI_TLV_LENGTH);pce->pce_cap_flag.value=htonl(cap);return;}/*SegmentRouting
TLVsetter*//*AlgorithmSubTLV-section3.1*/staticvoidset_sr_algorithm(uint8_talgo)
{OspfRI.sr_info.algo.value[0]=algo;for(inti=1;i<ALGORITHM_COUNT;i++)OspfRI.sr_in
fo.algo.value[i]=SR_ALGORITHM_UNSET;/*SetTLVtypeandlength==only1Algorithm*/TLV_T
YPE(OspfRI.sr_info.algo)=htons(RI_SR_TLV_SR_ALGORITHM);TLV_LEN(OspfRI.sr_info.al
go)=htons(sizeof(uint8_t));}/*unsetAglogithmSubTLV*/staticvoidunset_sr_algorithm
(uint8_talgo){for(inti=0;i<ALGORITHM_COUNT;i++)OspfRI.sr_info.algo.value[i]=SR_A
LGORITHM_UNSET;/*UnsetTLVtypeandlength*/TLV_TYPE(OspfRI.sr_info.algo)=htons(0);T
LV_LEN(OspfRI.sr_info.algo)=htons(0);}/*SegmentRoutingGlobalBlockSubTLV-section3
.2*/staticvoidset_sr_sid_label_range(structsr_srgbsrgb){/*SetHeader*/TLV_TYPE(Os
pfRI.sr_info.range)=htons(RI_SR_TLV_SID_LABEL_RANGE);TLV_LEN(OspfRI.sr_info.rang
e)=htons(SUBTLV_SID_LABEL_SIZE+sizeof(uint32_t));/*SetRangeSize*/OspfRI.sr_info.
range.size=htonl(SET_RANGE_SIZE(srgb.range_size));/*SetLowerboundlabelSubTLV*/TL
V_TYPE(OspfRI.sr_info.range.lower)=htons(SUBTLV_SID_LABEL);TLV_LEN(OspfRI.sr_inf
o.range.lower)=htons(SID_RANGE_LABEL_LENGTH);OspfRI.sr_info.range.lower.value=ht
onl(SET_LABEL(srgb.lower_bound));}/*UnsetthisSRGBSubTLV*/staticvoidunset_sr_sid_
label_range(void){TLV_TYPE(OspfRI.sr_info.range)=htons(0);TLV_LEN(OspfRI.sr_info
.range)=htons(0);TLV_TYPE(OspfRI.sr_info.range.lower)=htons(0);TLV_LEN(OspfRI.sr
_info.range.lower)=htons(0);}/*SetMaximumStackDepthforthisrouter*/staticvoidset_
sr_node_msd(uint8_tmsd){TLV_TYPE(OspfRI.sr_info.msd)=htons(RI_SR_TLV_NODE_MSD);T
LV_LEN(OspfRI.sr_info.msd)=htons(sizeof(uint32_t));OspfRI.sr_info.msd.value=msd;
}/*UnsetthisrouterMSD*/staticvoidunset_sr_node_msd(void){TLV_TYPE(OspfRI.sr_info
.msd)=htons(0);TLV_LEN(OspfRI.sr_info.msd)=htons(0);}staticvoidunset_param(struc
ttlv_header*tlv){tlv->type=0;/*FilltheValueto0*/memset(TLV_DATA(tlv),0,TLV_BODY_
SIZE(tlv));tlv->length=0;return;}staticvoidinitialize_params(structospf_router_i
nfo*ori){uint32_tcap=0;structospf*top;/**InitializedefaultRouterInformationCapab
ilities.*/cap=RI_TE_SUPPORT;set_router_info_capabilities(&ori->router_cap,cap);/
*IfAreaaddressisnotnullandexist,retrievecorresponding*structure*/top=ospf_lookup
_by_vrf_id(VRF_DEFAULT);zlog_info("RI->InitializeRouterInfofor%sscopewithinarea%
s",OspfRI.scope==OSPF_OPAQUE_AREA_LSA?"Area":"AS",inet_ntoa(OspfRI.area_id));/*T
rytogettheAreacontextatthisstep.Doitlatterifnot*available*/if((OspfRI.scope==OSP
F_OPAQUE_AREA_LSA)&&(OspfRI.area==NULL))OspfRI.area=ospf_area_lookup_by_area_id(
top,OspfRI.area_id);/**InitializedefaultPCEInformationvalues*//*PCEaddress==OSPF
RouterID*/set_pce_address(top->router_id,&ori->pce_info);/*PCEscope*/cap=7;/*Set
L,RandRdbitstoone=intra&inter-areapathcomputation*/set_pce_path_scope(cap,&ori->
pce_info);/*PCECapabilities*/cap=PCE_CAP_BIDIRECTIONAL|PCE_CAP_DIVERSE_PATH|PCE_
CAP_OBJECTIVES|PCE_CAP_ADDITIVE|PCE_CAP_MULTIPLE_REQ;set_pce_cap_flag(cap,&ori->
pce_info);return;}staticintis_mandated_params_set(structospf_router_infoori){int
rc=0;if(ntohs(ori.router_cap.header.type)==0)returnrc;if((ntohs(ori.pce_info.pce
_header.header.type)==RI_TLV_PCE)&&(ntohs(ori.pce_info.pce_address.header.type)=
=0)&&(ntohs(ori.pce_info.pce_cap_flag.header.type)==0))returnrc;if((ori.sr_info.
enabled)&&(ntohs(TLV_TYPE(ori.sr_info.algo))==0)&&(ntohs(TLV_TYPE(ori.sr_info.ra
nge))==0))returnrc;rc=1;returnrc;}/**UsedbySegmentRoutingtosetnewTLVsandSub-TLVs
values**@paramenableToactivateornotSegmentRoutingrouterInformationflooding*@para
msizeSizeofLabelRangei.e.SRGBsize*@paramlowerLowerboundoftheLabelRangei.e.SRGBfi
rstlabel*@parammsdMaximumlabelStackDepthsuportedbytherouter**@returnnone*/voidos
pf_router_info_update_sr(boolenable,structsr_srgbsrgb,uint8_tmsd){/*Firstactivat
eandinitializeRouterInformationisnecessary*/if(!OspfRI.enabled){OspfRI.enabled=t
rue;initialize_params(&OspfRI);}if(IS_DEBUG_OSPF_SR)zlog_debug("RI->%sRoutingInf
ormationforSegmentRouting",enable?"Enable":"Disable");/*UnsetorSetSRparameters*/
if(!enable){unset_sr_algorithm(SR_ALGORITHM_SPF);unset_sr_sid_label_range();unse
t_sr_node_msd();OspfRI.sr_info.enabled=false;}else{//OnlySR_ALGORITHM_SPFissuppo
rtedset_sr_algorithm(SR_ALGORITHM_SPF);set_sr_sid_label_range(srgb);if(msd!=0)se
t_sr_node_msd(msd);elseunset_sr_node_msd();OspfRI.sr_info.enabled=true;}/*Refres
hifalreadyengagedororiginateRILSA*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED)
)ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);elseospf_router_info_lsa_schedu
le(REORIGINATE_THIS_LSA);}/*----------------------------------------------------
--------------------**FollowingsarecallbackfunctionsagainstgenericOpaque-LSAshan
dling.*------------------------------------------------------------------------*
/staticvoidospf_router_info_ism_change(structospf_interface*oi,intold_state){/*S
ofar,nothingtodohere.*/return;}staticvoidospf_router_info_nsm_change(structospf_
neighbor*nbr,intold_state){/*Sofar,nothingtodohere.*/return;}/*-----------------
-------------------------------------------------------**FollowingsareOSPFprotoc
olprocessingfunctionsforROUTERINFORMATION*--------------------------------------
----------------------------------*/staticvoidbuild_tlv_header(structstream*s,st
ructtlv_header*tlvh){stream_put(s,tlvh,sizeof(structtlv_header));return;}staticv
oidbuild_tlv(structstream*s,structtlv_header*tlvh){if(ntohs(tlvh->type)!=0){buil
d_tlv_header(s,tlvh);stream_put(s,TLV_DATA(tlvh),TLV_BODY_SIZE(tlvh));}return;}s
taticvoidospf_router_info_lsa_body_set(structstream*s){structlistnode*node;struc
tri_pce_subtlv_domain*domain;structri_pce_subtlv_neighbor*neighbor;/*BuildRouter
InformationTLV*/build_tlv(s,&OspfRI.router_cap.header);/*BuildSegmentRoutingTLVs
ifenabled*/if(OspfRI.sr_info.enabled){/*BuildAlgorithmTLV*/build_tlv(s,&TLV_HDR(
OspfRI.sr_info.algo));/*BuildSRGBTLV*/build_tlv(s,&TLV_HDR(OspfRI.sr_info.range)
);/*BuildMSDTLV*/build_tlv(s,&TLV_HDR(OspfRI.sr_info.msd));}/*AddRIPCETLVifitiss
et*/if(OspfRI.pce_info.enabled){/*ComputePCEInfoheaderfirst*/set_pce_header(&Osp
fRI.pce_info);/*BuildPCETLV*/build_tlv_header(s,&OspfRI.pce_info.pce_header.head
er);/*BuildPCEaddresssub-tlv*/build_tlv(s,&OspfRI.pce_info.pce_address.header);/
*BuildPCEpathscopesub-tlv*/build_tlv(s,&OspfRI.pce_info.pce_scope.header);/*Buil
dPCEdomainsub-tlv*/for(ALL_LIST_ELEMENTS_RO(OspfRI.pce_info.pce_domain,node,doma
in))build_tlv(s,&domain->header);/*BuildPCEneighborsub-tlv*/for(ALL_LIST_ELEMENT
S_RO(OspfRI.pce_info.pce_neighbor,node,neighbor))build_tlv(s,&neighbor->header);
/*BuildPCEcapflagsub-tlv*/build_tlv(s,&OspfRI.pce_info.pce_cap_flag.header);}ret
urn;}/*Createnewopaque-LSA.*/staticstructospf_lsa*ospf_router_info_lsa_new(){str
uctospf*top;structstream*s;structlsa_header*lsah;structospf_lsa*new=NULL;uint8_t
options,lsa_type;structin_addrlsa_id;uint32_ttmp;uint16_tlength;/*Createastreamf
orLSA.*/if((s=stream_new(OSPF_MAX_LSA_SIZE))==NULL){zlog_warn("ospf_router_info_
lsa_new:stream_new()?");returnNULL;}lsah=(structlsa_header*)STREAM_DATA(s);optio
ns=OSPF_OPTION_E;/*EnableASexternalaswefloodRIwithOpaqueType11*/options|=OSPF_OP
TION_O;/*Don'tforgetthis:-)*/lsa_type=OspfRI.scope;/*LSAID==0forRouterInformatio
nseeRFC4970*/tmp=SET_OPAQUE_LSID(OPAQUE_TYPE_ROUTER_INFORMATION_LSA,0);lsa_id.s_
addr=htonl(tmp);if(IS_DEBUG_OSPF(lsa,LSA_GENERATE))zlog_debug("LSA[Type%d:%s]:Cr
eateanOpaque-LSA/ROUTERINFORMATIONinstance",lsa_type,inet_ntoa(lsa_id));top=ospf
_lookup_by_vrf_id(VRF_DEFAULT);/*Setopaque-LSAheaderfields.*/lsa_header_set(s,op
tions,lsa_type,lsa_id,top->router_id);/*Setopaque-LSAbodyfields.*/ospf_router_in
fo_lsa_body_set(s);/*Setlength.*/length=stream_get_endp(s);lsah->length=htons(le
ngth);/*Now,createanOSPFLSAinstance.*/if((new=ospf_lsa_new())==NULL){zlog_warn("
ospf_router_info_lsa_new:ospf_lsa_new()?");stream_free(s);returnNULL;}if((new->d
ata=ospf_lsa_data_new(length))==NULL){zlog_warn("ospf_router_info_lsa_new:ospf_l
sa_data_new()?");ospf_lsa_unlock(&new);new=NULL;stream_free(s);returnnew;}new->a
rea=OspfRI.area;/*AreamustbenulliftheOpaquetypeisASscope,fulfillotherwise*/if(ne
w->area&&new->area->ospf)new->vrf_id=new->area->ospf->vrf_id;elsenew->vrf_id=VRF
_DEFAULT;SET_FLAG(new->flags,OSPF_LSA_SELF);memcpy(new->data,lsah,length);stream
_free(s);returnnew;}staticintospf_router_info_lsa_originate1(void*arg){structosp
f_lsa*new;structospf*top;structospf_area*area;intrc=-1;vrf_id_tvrf_id=VRF_DEFAUL
T;/*FirstcheckiftheareaisknowniffloodingscopeisArea*/if(OspfRI.scope==OSPF_OPAQU
E_AREA_LSA){area=(structospf_area*)arg;if(area->area_id.s_addr!=OspfRI.area_id.s
_addr){zlog_debug("RI->ThisisnottheRouterInformationArea.Stopprocessing");return
rc;}OspfRI.area=area;if(area->ospf)vrf_id=area->ospf->vrf_id;}/*CreatenewOpaque-
LSA/ROUTERINFORMATIONinstance.*/if((new=ospf_router_info_lsa_new())==NULL){zlog_
warn("ospf_router_info_lsa_originate1:ospf_router_info_lsa_new()?");returnrc;}ne
w->vrf_id=vrf_id;/*Getospfinfo*/top=ospf_lookup_by_vrf_id(vrf_id);if(top==NULL){
zlog_debug("%s:ospfinstancenotfoundforvrfid%u",__PRETTY_FUNCTION__,vrf_id);ospf_
lsa_unlock(&new);returnrc;}/*InstallthisLSAintoLSDB.*/if(ospf_lsa_install(top,NU
LL/*oi*/,new)==NULL){zlog_warn("ospf_router_info_lsa_originate1:ospf_lsa_install
()?");ospf_lsa_unlock(&new);returnrc;}/*NowthisRouterInfoparameterentryhasassoci
atedLSA.*/SET_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED);/*UpdatenewLSAoriginationcoun
t.*/top->lsa_originate_count++;/*FloodnewLSAthroughAS.*/if(OspfRI.scope==OSPF_OP
AQUE_AS_LSA)ospf_flood_through_as(top,NULL/*nbr*/,new);elseospf_flood_through_ar
ea(OspfRI.area,NULL/*nbr*/,new);if(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){zlog_debug("
LSA[Type%d:%s]:OriginateOpaque-LSA/ROUTERINFORMATION",new->data->type,inet_ntoa(
new->data->id));ospf_lsa_header_dump(new->data);}rc=0;returnrc;}staticintospf_ro
uter_info_lsa_originate(void*arg){intrc=-1;if(!OspfRI.enabled){zlog_info("ospf_r
outer_info_lsa_originate:ROUTERINFORMATIONisdisablednow.");rc=0;/*Thisisnotanerr
orcase.*/returnrc;}/*CheckifRouterInformationLSAisalreadyengaged*/if(CHECK_FLAG(
OspfRI.flags,RIFLG_LSA_ENGAGED)){if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_FORCED_REF
RESH)){UNSET_FLAG(OspfRI.flags,RIFLG_LSA_FORCED_REFRESH);ospf_router_info_lsa_sc
hedule(REFRESH_THIS_LSA);}}else{if(!is_mandated_params_set(OspfRI))zlog_warn("os
pf_router_info_lsa_originate:lacksmandatedROUTERINFORMATIONparameters");/*Ok,let
'strytooriginateanLSA*/if(ospf_router_info_lsa_originate1(arg)!=0)returnrc;}rc=0
;returnrc;}staticstructospf_lsa*ospf_router_info_lsa_refresh(structospf_lsa*lsa)
{structospf_lsa*new=NULL;structospf*top;if(!OspfRI.enabled){/**ThisLSAmusthavefl
ushedbeforeduetoROUTERINFORMATION*statuschange.*Itseemsaslipamongroutersintherou
tingdomain.*/zlog_info("ospf_router_info_lsa_refresh:ROUTERINFORMATIONisdisabled
now.");lsa->data->ls_age=htons(OSPF_LSA_MAXAGE);/*Flushitanyway.*/}/*Verifythatt
heRouterInformationIDissupported*/if(GET_OPAQUE_ID(ntohl(lsa->data->id.s_addr))!
=0){zlog_warn("ospf_router_info_lsa_refresh:UnsupportedRouterInformationID");ret
urnNULL;}/*Ifthelsa'sagereachedtoMaxAge,startflushingprocedure.*/if(IS_LSA_MAXAG
E(lsa)){UNSET_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED);ospf_opaque_lsa_flush_schedul
e(lsa);returnNULL;}/*CreatenewOpaque-LSA/ROUTERINFORMATIONinstance.*/if((new=osp
f_router_info_lsa_new())==NULL){zlog_warn("ospf_router_info_lsa_refresh:ospf_rou
ter_info_lsa_new()?");returnNULL;}new->data->ls_seqnum=lsa_seqnum_increment(lsa)
;new->vrf_id=lsa->vrf_id;/*InstallthisLSAintoLSDB.*//*Given"lsa"willbefreedinthe
nextfunction.*/top=ospf_lookup_by_vrf_id(lsa->vrf_id);if(ospf_lsa_install(top,NU
LL/*oi*/,new)==NULL){zlog_warn("ospf_router_info_lsa_refresh:ospf_lsa_install()?
");ospf_lsa_unlock(&new);returnnew;}/*FloodupdatedLSAthroughASorAREAdependingofO
spfRI.scope.*/if(OspfRI.scope==OSPF_OPAQUE_AS_LSA)ospf_flood_through_as(top,NULL
/*nbr*/,new);elseospf_flood_through_area(OspfRI.area,NULL/*nbr*/,new);/*Debuglog
ging.*/if(IS_DEBUG_OSPF(lsa,LSA_GENERATE)){zlog_debug("LSA[Type%d:%s]:RefreshOpa
que-LSA/ROUTERINFORMATION",new->data->type,inet_ntoa(new->data->id));ospf_lsa_he
ader_dump(new->data);}returnnew;}staticvoidospf_router_info_lsa_schedule(enumlsa
_opcodeopcode){structospf_lsalsa;structlsa_headerlsah;structospf*top;uint32_ttmp
;memset(&lsa,0,sizeof(lsa));memset(&lsah,0,sizeof(lsah));zlog_debug("RI->LSAsche
dule%s%s%s",opcode==REORIGINATE_THIS_LSA?"Re-Originate":"",opcode==REFRESH_THIS_
LSA?"Refresh":"",opcode==FLUSH_THIS_LSA?"Flush":"");/*CheckLSAflagsstatecoherenc
e*/if(!CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED)&&(opcode!=REORIGINATE_THIS_LSA
))return;if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED)&&(opcode==REORIGINATE_THI
S_LSA))opcode=REFRESH_THIS_LSA;top=ospf_lookup_by_vrf_id(VRF_DEFAULT);if((OspfRI
.scope==OSPF_OPAQUE_AREA_LSA)&&(OspfRI.area==NULL)){zlog_warn("ospf_router_info_
lsa_schedule():RouterInfoisAreascopefloodingbutareaisnotset");OspfRI.area=ospf_a
rea_lookup_by_area_id(top,OspfRI.area_id);}lsa.area=OspfRI.area;lsa.data=&lsah;l
sah.type=OspfRI.scope;/*LSAIDissetto0fortheRouterInformation.SeeRFC4970*/tmp=SET
_OPAQUE_LSID(OPAQUE_TYPE_ROUTER_INFORMATION_LSA,0);lsah.id.s_addr=htonl(tmp);swi
tch(opcode){caseREORIGINATE_THIS_LSA:if(OspfRI.scope==OSPF_OPAQUE_AREA_LSA)ospf_
opaque_lsa_reoriginate_schedule((void*)OspfRI.area,OSPF_OPAQUE_AREA_LSA,OPAQUE_T
YPE_ROUTER_INFORMATION_LSA);elseospf_opaque_lsa_reoriginate_schedule((void*)top,
OSPF_OPAQUE_AS_LSA,OPAQUE_TYPE_ROUTER_INFORMATION_LSA);break;caseREFRESH_THIS_LS
A:ospf_opaque_lsa_refresh_schedule(&lsa);break;caseFLUSH_THIS_LSA:UNSET_FLAG(Osp
fRI.flags,RIFLG_LSA_ENGAGED);ospf_opaque_lsa_flush_schedule(&lsa);break;default:
zlog_warn("ospf_router_info_lsa_schedule:Unknownopcode(%u)",opcode);break;}retur
n;}/*CallbacktohandleSegmentRoutinginformation*/staticintospf_router_info_lsa_up
date(structospf_lsa*lsa){/*SanityCheck*/if(lsa==NULL){zlog_warn("OSPF-RI(%s):Abo
rt!LSAisNULL",__func__);return-1;}/*ProcessonlyOpaqueLSA*/if((lsa->data->type!=O
SPF_OPAQUE_AREA_LSA)&&(lsa->data->type!=OSPF_OPAQUE_AS_LSA))return0;/*Processonl
yRouterInformationLSA*/if(GET_OPAQUE_TYPE(ntohl(lsa->data->id.s_addr))!=OPAQUE_T
YPE_ROUTER_INFORMATION_LSA)return0;/*CheckifitisnotmyLSA*/if(IS_LSA_SELF(lsa))re
turn0;/*CheckifRouterInfo&SegmentRoutingareenable*/if(!OspfRI.enabled||!OspfRI.s
r_info.enabled)return0;/*CallSegmentRoutingLSAupdateordeletion*/if(!IS_LSA_MAXAG
E(lsa))ospf_sr_ri_lsa_update(lsa);elseospf_sr_ri_lsa_delete(lsa);return0;}/*----
--------------------------------------------------------------------**Followings
arevtysessioncontrolfunctions.*-------------------------------------------------
-----------------------*/staticuint16_tshow_vty_router_cap(structvty*vty,structt
lv_header*tlvh){structri_tlv_router_cap*top=(structri_tlv_router_cap*)tlvh;if(vt
y!=NULL)vty_out(vty,"RouterCapabilities:0x%x\n",ntohl(top->value));elsezlog_debu
g("RouterCapabilities:0x%x",ntohl(top->value));returnTLV_SIZE(tlvh);}staticuint1
6_tshow_vty_pce_subtlv_address(structvty*vty,structtlv_header*tlvh){structri_pce
_subtlv_address*top=(structri_pce_subtlv_address*)tlvh;if(ntohs(top->address.typ
e)==PCE_ADDRESS_TYPE_IPV4){if(vty!=NULL)vty_out(vty,"PCEAddress:%s\n",inet_ntoa(
top->address.value));elsezlog_debug("PCEAddress:%s",inet_ntoa(top->address.value
));}else{/*TODO:AddsupporttoIPv6withinet_ntop()*/if(vty!=NULL)vty_out(vty,"PCEAd
dress:0x%x\n",ntohl(top->address.value.s_addr));elsezlog_debug("PCEAddress:0x%x"
,ntohl(top->address.value.s_addr));}returnTLV_SIZE(tlvh);}staticuint16_tshow_vty
_pce_subtlv_path_scope(structvty*vty,structtlv_header*tlvh){structri_pce_subtlv_
path_scope*top=(structri_pce_subtlv_path_scope*)tlvh;if(vty!=NULL)vty_out(vty,"P
CEPathScope:0x%x\n",ntohl(top->value));elsezlog_debug("PCEPathScope:0x%x",ntohl(
top->value));returnTLV_SIZE(tlvh);}staticuint16_tshow_vty_pce_subtlv_domain(stru
ctvty*vty,structtlv_header*tlvh){structri_pce_subtlv_domain*top=(structri_pce_su
btlv_domain*)tlvh;structin_addrtmp;if(ntohs(top->type)==PCE_DOMAIN_TYPE_AREA){tm
p.s_addr=top->value;if(vty!=NULL)vty_out(vty,"PCEdomainArea:%s\n",inet_ntoa(tmp)
);elsezlog_debug("PCEdomainArea:%s",inet_ntoa(tmp));}else{if(vty!=NULL)vty_out(v
ty,"PCEdomainAS:%d\n",ntohl(top->value));elsezlog_debug("PCEdomainAS:%d",ntohl(t
op->value));}returnTLV_SIZE(tlvh);}staticuint16_tshow_vty_pce_subtlv_neighbor(st
ructvty*vty,structtlv_header*tlvh){structri_pce_subtlv_neighbor*top=(structri_pc
e_subtlv_neighbor*)tlvh;structin_addrtmp;if(ntohs(top->type)==PCE_DOMAIN_TYPE_AR
EA){tmp.s_addr=top->value;if(vty!=NULL)vty_out(vty,"PCEneighborArea:%s\n",inet_n
toa(tmp));elsezlog_debug("PCEneighborArea:%s",inet_ntoa(tmp));}else{if(vty!=NULL
)vty_out(vty,"PCEneighborAS:%d\n",ntohl(top->value));elsezlog_debug("PCEneighbor
AS:%d",ntohl(top->value));}returnTLV_SIZE(tlvh);}staticuint16_tshow_vty_pce_subt
lv_cap_flag(structvty*vty,structtlv_header*tlvh){structri_pce_subtlv_cap_flag*to
p=(structri_pce_subtlv_cap_flag*)tlvh;if(vty!=NULL)vty_out(vty,"PCECapabilitiesF
lag:0x%x\n",ntohl(top->value));elsezlog_debug("PCECapabilitiesFlag:0x%x",ntohl(t
op->value));returnTLV_SIZE(tlvh);}staticuint16_tshow_vty_unknown_tlv(structvty*v
ty,structtlv_header*tlvh){if(vty!=NULL)vty_out(vty,"UnknownTLV:[type(0x%x),lengt
h(0x%x)]\n",ntohs(tlvh->type),ntohs(tlvh->length));elsezlog_debug("UnknownTLV:[t
ype(0x%x),length(0x%x)]",ntohs(tlvh->type),ntohs(tlvh->length));returnTLV_SIZE(t
lvh);}staticuint16_tshow_vty_pce_info(structvty*vty,structtlv_header*ri,uint32_t
total){structtlv_header*tlvh;uint16_tsum=0;for(tlvh=ri;sum<total;tlvh=TLV_HDR_NE
XT(tlvh)){switch(ntohs(tlvh->type)){caseRI_PCE_SUBTLV_ADDRESS:sum+=show_vty_pce_
subtlv_address(vty,tlvh);break;caseRI_PCE_SUBTLV_PATH_SCOPE:sum+=show_vty_pce_su
btlv_path_scope(vty,tlvh);break;caseRI_PCE_SUBTLV_DOMAIN:sum+=show_vty_pce_subtl
v_domain(vty,tlvh);break;caseRI_PCE_SUBTLV_NEIGHBOR:sum+=show_vty_pce_subtlv_nei
ghbor(vty,tlvh);break;caseRI_PCE_SUBTLV_CAP_FLAG:sum+=show_vty_pce_subtlv_cap_fl
ag(vty,tlvh);break;default:sum+=show_vty_unknown_tlv(vty,tlvh);break;}}returnsum
;}/*DisplaySegmentRoutingAlgorithmTLVinformation*/staticuint16_tshow_vty_sr_algo
rithm(structvty*vty,structtlv_header*tlvh){structri_sr_tlv_sr_algorithm*algo=(st
ructri_sr_tlv_sr_algorithm*)tlvh;inti;if(vty!=NULL){vty_out(vty,"SegmentRoutingA
lgorithmTLV:\n");for(i=0;i<ntohs(algo->header.length);i++){switch(algo->value[i]
){case0:vty_out(vty,"Algorithm%d:SPF\n",i);break;case1:vty_out(vty,"Algorithm%d:
StrictSPF\n",i);break;default:vty_out(vty,"Algorithm%d:Unknownvalue%d\n",i,algo-
>value[i]);break;}}}else{zlog_debug("SegmentRoutingAlgorithmTLV:\n");for(i=0;i<n
tohs(algo->header.length);i++)switch(algo->value[i]){case0:zlog_debug("Algorithm
%d:SPF\n",i);break;case1:zlog_debug("Algorithm%d:StrictSPF\n",i);break;default:z
log_debug("Algorithm%d:Unknownvalue%d\n",i,algo->value[i]);break;}}returnTLV_SIZ
E(tlvh);}/*DisplaySegmentRoutingSID/LabelRangeTLVinformation*/staticuint16_tshow
_vty_sr_range(structvty*vty,structtlv_header*tlvh){structri_sr_tlv_sid_label_ran
ge*range=(structri_sr_tlv_sid_label_range*)tlvh;if(vty!=NULL){vty_out(vty,"Segme
ntRoutingRangeTLV:\n""RangeSize=%d\n""SIDLabel=%d\n\n",GET_RANGE_SIZE(ntohl(rang
e->size)),GET_LABEL(ntohl(range->lower.value)));}else{zlog_debug("SegmentRouting
RangeTLV:\n""RangeSize=%d\n""SIDLabel=%d\n\n",GET_RANGE_SIZE(ntohl(range->size))
,GET_LABEL(ntohl(range->lower.value)));}returnTLV_SIZE(tlvh);}/*DisplaySegmentRo
utingMaximumStackDepthTLVinformation*/staticuint16_tshow_vty_sr_msd(structvty*vt
y,structtlv_header*tlvh){structri_sr_tlv_node_msd*msd=(structri_sr_tlv_node_msd*
)tlvh;if(vty!=NULL){vty_out(vty,"SegmentRoutingMSDTLV:\n""NodeMaximumStackDepth=
%d\n",msd->value);}else{zlog_debug("SegmentRoutingMSDTLV:\n""NodeMaximumStackDep
th=%d\n",msd->value);}returnTLV_SIZE(tlvh);}staticvoidospf_router_info_show_info
(structvty*vty,structospf_lsa*lsa){structlsa_header*lsah=(structlsa_header*)lsa-
>data;structtlv_header*tlvh;uint16_tlength=0,sum=0;/*InitializeTLVbrowsing*/leng
th=ntohs(lsah->length)-OSPF_LSA_HEADER_SIZE;for(tlvh=TLV_HDR_TOP(lsah);sum<lengt
h;tlvh=TLV_HDR_NEXT(tlvh)){switch(ntohs(tlvh->type)){caseRI_TLV_CAPABILITIES:sum
+=show_vty_router_cap(vty,tlvh);break;caseRI_TLV_PCE:tlvh++;sum+=TLV_HDR_SIZE;su
m+=show_vty_pce_info(vty,tlvh,length-sum);break;caseRI_SR_TLV_SR_ALGORITHM:sum+=
show_vty_sr_algorithm(vty,tlvh);break;caseRI_SR_TLV_SID_LABEL_RANGE:sum+=show_vt
y_sr_range(vty,tlvh);break;caseRI_SR_TLV_NODE_MSD:sum+=show_vty_sr_msd(vty,tlvh)
;break;default:sum+=show_vty_unknown_tlv(vty,tlvh);break;}}return;}staticvoidosp
f_router_info_config_write_router(structvty*vty){structospf_pce_info*pce=&OspfRI
.pce_info;structlistnode*node;structri_pce_subtlv_domain*domain;structri_pce_sub
tlv_neighbor*neighbor;structin_addrtmp;if(!OspfRI.enabled)return;if(OspfRI.scope
==OSPF_OPAQUE_AS_LSA)vty_out(vty,"router-infoas\n");elsevty_out(vty,"router-info
area%s\n",inet_ntoa(OspfRI.area_id));if(OspfRI.pce_info.enabled){if(pce->pce_add
ress.header.type!=0)vty_out(vty,"pceaddress%s\n",inet_ntoa(pce->pce_address.addr
ess.value));if(pce->pce_cap_flag.header.type!=0)vty_out(vty,"pceflag0x%x\n",ntoh
l(pce->pce_cap_flag.value));for(ALL_LIST_ELEMENTS_RO(pce->pce_domain,node,domain
)){if(domain->header.type!=0){if(domain->type==PCE_DOMAIN_TYPE_AREA){tmp.s_addr=
domain->value;vty_out(vty,"pcedomainarea%s\n",inet_ntoa(tmp));}else{vty_out(vty,
"pcedomainas%d\n",ntohl(domain->value));}}}for(ALL_LIST_ELEMENTS_RO(pce->pce_nei
ghbor,node,neighbor)){if(neighbor->header.type!=0){if(neighbor->type==PCE_DOMAIN
_TYPE_AREA){tmp.s_addr=neighbor->value;vty_out(vty,"pceneighborarea%s\n",inet_nt
oa(tmp));}else{vty_out(vty,"pceneighboras%d\n",ntohl(neighbor->value));}}}if(pce
->pce_scope.header.type!=0)vty_out(vty,"pcescope0x%x\n",ntohl(OspfRI.pce_info.pc
e_scope.value));}return;}/*-----------------------------------------------------
-------------------**Followingsarevtycommandfunctions.*-------------------------
-----------------------------------------------*/DEFUN(router_info,router_info_a
rea_cmd,"router-info<as|areaA.B.C.D>",OSPF_RI_STR"EnabletheRouterInformationfunc
tionalitywithASfloodingscope\n""EnabletheRouterInformationfunctionalitywithAreaf
loodingscope\n""OSPFareaIDinIPformat\n"){intidx_ipv4=2;char*area=(argc==3)?argv[
idx_ipv4]->arg:NULL;uint8_tscope;if(OspfRI.enabled)returnCMD_SUCCESS;/*Checkandg
etAreavalueifpresent*/if(area){if(!inet_aton(area,&OspfRI.area_id)){vty_out(vty,
"%%specifiedAreaID%sisinvalid\n",area);returnCMD_WARNING_CONFIG_FAILED;}scope=OS
PF_OPAQUE_AREA_LSA;}else{OspfRI.area_id.s_addr=0;scope=OSPF_OPAQUE_AS_LSA;}/*Fir
ststarttoregisterRouterInformationcallbacks*/if((ospf_router_info_register(scope
))!=0){zlog_warn("UnabletoregisterRouterInformationcallbacks.Abort!");returnCMD_
WARNING_CONFIG_FAILED;}OspfRI.enabled=true;if(IS_DEBUG_OSPF_EVENT)zlog_debug("RI
->RouterInformation(%sflooding):OFF->ON",OspfRI.scope==OSPF_OPAQUE_AREA_LSA?"Are
a":"AS");/**Followingcodeisintendedtohandletwocases;**1)RouterInformationwasdisa
bledatstartuptime,butnowbecome*enabled.*2)RouterInformationwasonceenabledthendis
abled,andnowenabled*again.*/initialize_params(&OspfRI);/*RefreshRILSAifalreadyen
gaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED)){zlog_debug("RI->RefreshLSA
followingconfiguration");ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);}else{z
log_debug("RI->Initialoriginationfollowingconfiguration");ospf_router_info_lsa_s
chedule(REORIGINATE_THIS_LSA);}returnCMD_SUCCESS;}DEFUN(no_router_info,no_router
_info_cmd,"norouter-info",NO_STR"DisabletheRouterInformationfunctionality\n"){if
(!OspfRI.enabled)returnCMD_SUCCESS;if(IS_DEBUG_OSPF_EVENT)zlog_debug("RI->Router
Information:ON->OFF");if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_
info_lsa_schedule(FLUSH_THIS_LSA);OspfRI.enabled=false;returnCMD_SUCCESS;}static
intospf_ri_enabled(structvty*vty){if(OspfRI.enabled)return1;if(vty)vty_out(vty,"
%%OSPFRIisnotturnedon\n");return0;}DEFUN(pce_address,pce_address_cmd,"pceaddress
A.B.C.D",PCE_STR"StableIPaddressofthePCE\n""PCEaddressinIPv4addressformat\n"){in
tidx_ipv4=2;structin_addrvalue;structospf_pce_info*pi=&OspfRI.pce_info;if(!ospf_
ri_enabled(vty))returnCMD_WARNING_CONFIG_FAILED;if(!inet_aton(argv[idx_ipv4]->ar
g,&value)){vty_out(vty,"PleasespecifyPCEAddressbyA.B.C.D\n");returnCMD_WARNING_C
ONFIG_FAILED;}if(ntohs(pi->pce_address.header.type)==0||ntohl(pi->pce_address.ad
dress.value.s_addr)!=ntohl(value.s_addr)){set_pce_address(value,pi);/*RefreshRIL
SAifalreadyengaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_in
fo_lsa_schedule(REFRESH_THIS_LSA);}returnCMD_SUCCESS;}DEFUN(no_pce_address,no_pc
e_address_cmd,"nopceaddress[A.B.C.D]",NO_STRPCE_STR"DisablePCEaddress\n""PCEaddr
essinIPv4addressformat\n"){unset_param(&OspfRI.pce_info.pce_address.header);/*Re
freshRILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_r
outer_info_lsa_schedule(REFRESH_THIS_LSA);returnCMD_SUCCESS;}DEFUN(pce_path_scop
e,pce_path_scope_cmd,"pcescopeBITPATTERN",PCE_STR"PathscopevisibilitiesofthePCEf
orpathcomputation\n""32-bitHexadecimalvalue\n"){intidx_bitpattern=2;uint32_tscop
e;structospf_pce_info*pi=&OspfRI.pce_info;if(!ospf_ri_enabled(vty))returnCMD_WAR
NING_CONFIG_FAILED;if(sscanf(argv[idx_bitpattern]->arg,"0x%x",&scope)!=1){vty_ou
t(vty,"pce_path_scope:fscanf:%s\n",safe_strerror(errno));returnCMD_WARNING_CONFI
G_FAILED;}if(ntohl(pi->pce_scope.header.type)==0||scope!=pi->pce_scope.value){se
t_pce_path_scope(scope,pi);/*RefreshRILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI.
flags,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);}return
CMD_SUCCESS;}DEFUN(no_pce_path_scope,no_pce_path_scope_cmd,"nopcescope[BITPATTER
N]",NO_STRPCE_STR"DisablePCEpathscope\n""32-bitHexadecimalvalue\n"){unset_param(
&OspfRI.pce_info.pce_address.header);/*RefreshRILSAifalreadyengaged*/if(CHECK_FL
AG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_schedule(REFRESH_THIS_LS
A);returnCMD_SUCCESS;}DEFUN(pce_domain,pce_domain_cmd,"pcedomainas(0-65535)",PCE
_STR"ConfigurePCEdomainASnumber\n""ASnumberwherethePCEasvisibilitiesforpathcompu
tation\n""ASnumberindecimal<0-65535>\n"){intidx_number=3;uint32_tas;structospf_p
ce_info*pce=&OspfRI.pce_info;structlistnode*node;structri_pce_subtlv_domain*doma
in;if(!ospf_ri_enabled(vty))returnCMD_WARNING_CONFIG_FAILED;if(sscanf(argv[idx_n
umber]->arg,"%d",&as)!=1){vty_out(vty,"pce_domain:fscanf:%s\n",safe_strerror(err
no));returnCMD_WARNING_CONFIG_FAILED;}/*Checkifthedomainisnotalreadyinthedomainl
ist*/for(ALL_LIST_ELEMENTS_RO(pce->pce_domain,node,domain)){if(ntohl(domain->hea
der.type)==0&&as==domain->value)returnCMD_SUCCESS;}/*Createnewdomainifnotfound*/
set_pce_domain(PCE_DOMAIN_TYPE_AS,as,pce);/*RefreshRILSAifalreadyengaged*/if(CHE
CK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_schedule(REFRESH_TH
IS_LSA);returnCMD_SUCCESS;}DEFUN(no_pce_domain,no_pce_domain_cmd,"nopcedomainas(
0-65535)",NO_STRPCE_STR"DisablePCEdomainASnumber\n""ASnumberwherethePCEasvisibil
itiesforpathcomputation\n""ASnumberindecimal<0-65535>\n"){intidx_number=4;uint32
_tas;structospf_pce_info*pce=&OspfRI.pce_info;if(sscanf(argv[idx_number]->arg,"%
d",&as)!=1){vty_out(vty,"no_pce_domain:fscanf:%s\n",safe_strerror(errno));return
CMD_WARNING_CONFIG_FAILED;}/*UnsetcorrespondingPCEdomain*/unset_pce_domain(PCE_D
OMAIN_TYPE_AS,as,pce);/*RefreshRILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI.flags
,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);returnCMD_SU
CCESS;}DEFUN(pce_neigbhor,pce_neighbor_cmd,"pceneighboras(0-65535)",PCE_STR"Conf
igurePCEneighbordomainASnumber\n""ASnumberofPCEneighbors\n""ASnumberindecimal<0-
65535>\n"){intidx_number=3;uint32_tas;structospf_pce_info*pce=&OspfRI.pce_info;s
tructlistnode*node;structri_pce_subtlv_neighbor*neighbor;if(!ospf_ri_enabled(vty
))returnCMD_WARNING_CONFIG_FAILED;if(sscanf(argv[idx_number]->arg,"%d",&as)!=1){
vty_out(vty,"pce_neighbor:fscanf:%s\n",safe_strerror(errno));returnCMD_WARNING_C
ONFIG_FAILED;}/*Checkifthedomainisnotalreadyinthedomainlist*/for(ALL_LIST_ELEMEN
TS_RO(pce->pce_neighbor,node,neighbor)){if(ntohl(neighbor->header.type)==0&&as==
neighbor->value)returnCMD_SUCCESS;}/*Createnewdomainifnotfound*/set_pce_neighbor
(PCE_DOMAIN_TYPE_AS,as,pce);/*RefreshRILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI
.flags,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);return
CMD_SUCCESS;}DEFUN(no_pce_neighbor,no_pce_neighbor_cmd,"nopceneighboras(0-65535)
",NO_STRPCE_STR"DisablePCEneighborASnumber\n""ASnumberofPCEneighbor\n""ASnumberi
ndecimal<0-65535>\n"){intidx_number=4;uint32_tas;structospf_pce_info*pce=&OspfRI
.pce_info;if(sscanf(argv[idx_number]->arg,"%d",&as)!=1){vty_out(vty,"no_pce_neig
hbor:fscanf:%s\n",safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}/*Unset
correspondingPCEdomain*/unset_pce_neighbor(PCE_DOMAIN_TYPE_AS,as,pce);/*RefreshR
ILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_
info_lsa_schedule(REFRESH_THIS_LSA);returnCMD_SUCCESS;}DEFUN(pce_cap_flag,pce_ca
p_flag_cmd,"pceflagBITPATTERN",PCE_STR"CapabilitiesofthePCEforpathcomputation\n"
"32-bitHexadecimalvalue\n"){intidx_bitpattern=2;uint32_tcap;structospf_pce_info*
pce=&OspfRI.pce_info;if(!ospf_ri_enabled(vty))returnCMD_WARNING_CONFIG_FAILED;if
(sscanf(argv[idx_bitpattern]->arg,"0x%x",&cap)!=1){vty_out(vty,"pce_cap_flag:fsc
anf:%s\n",safe_strerror(errno));returnCMD_WARNING_CONFIG_FAILED;}if(ntohl(pce->p
ce_cap_flag.header.type)==0||cap!=pce->pce_cap_flag.value){set_pce_cap_flag(cap,
pce);/*RefreshRILSAifalreadyengaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGE
D))ospf_router_info_lsa_schedule(REFRESH_THIS_LSA);}returnCMD_SUCCESS;}DEFUN(no_
pce_cap_flag,no_pce_cap_flag_cmd,"nopceflag",NO_STRPCE_STR"DisablePCEcapabilitie
s\n"){unset_param(&OspfRI.pce_info.pce_cap_flag.header);/*RefreshRILSAifalreadye
ngaged*/if(CHECK_FLAG(OspfRI.flags,RIFLG_LSA_ENGAGED))ospf_router_info_lsa_sched
ule(REFRESH_THIS_LSA);returnCMD_SUCCESS;}DEFUN(show_ip_ospf_router_info,show_ip_
ospf_router_info_cmd,"showipospfrouter-info",SHOW_STRIP_STROSPF_STR"RouterInform
ation\n"){if(OspfRI.enabled){vty_out(vty,"---RouterInformationparameters---\n");
show_vty_router_cap(vty,&OspfRI.router_cap.header);}else{if(vty!=NULL)vty_out(vt
y,"RouterInformationisdisabledonthisrouter\n");}returnCMD_SUCCESS;}DEFUN(show_ip
_opsf_router_info_pce,show_ip_ospf_router_info_pce_cmd,"showipospfrouter-infopce
",SHOW_STRIP_STROSPF_STR"RouterInformation\n""PCEinformation\n"){structospf_pce_
info*pce=&OspfRI.pce_info;structlistnode*node;structri_pce_subtlv_domain*domain;
structri_pce_subtlv_neighbor*neighbor;if((OspfRI.enabled)&&(OspfRI.pce_info.enab
led)){vty_out(vty,"---PCEparameters---\n");if(pce->pce_address.header.type!=0)sh
ow_vty_pce_subtlv_address(vty,&pce->pce_address.header);if(pce->pce_scope.header
.type!=0)show_vty_pce_subtlv_path_scope(vty,&pce->pce_scope.header);for(ALL_LIST
_ELEMENTS_RO(pce->pce_domain,node,domain)){if(domain->header.type!=0)show_vty_pc
e_subtlv_domain(vty,&domain->header);}for(ALL_LIST_ELEMENTS_RO(pce->pce_neighbor
,node,neighbor)){if(neighbor->header.type!=0)show_vty_pce_subtlv_neighbor(vty,&n
eighbor->header);}if(pce->pce_cap_flag.header.type!=0)show_vty_pce_subtlv_cap_fl
ag(vty,&pce->pce_cap_flag.header);}else{vty_out(vty,"PCEinfoisdisabledonthisrout
er\n");}returnCMD_SUCCESS;}/*InstallnewCLIcommands*/staticvoidospf_router_info_r
egister_vty(void){install_element(VIEW_NODE,&show_ip_ospf_router_info_cmd);insta
ll_element(VIEW_NODE,&show_ip_ospf_router_info_pce_cmd);install_element(OSPF_NOD
E,&router_info_area_cmd);install_element(OSPF_NODE,&no_router_info_cmd);install_
element(OSPF_NODE,&pce_address_cmd);install_element(OSPF_NODE,&no_pce_address_cm
d);install_element(OSPF_NODE,&pce_path_scope_cmd);install_element(OSPF_NODE,&no_
pce_path_scope_cmd);install_element(OSPF_NODE,&pce_domain_cmd);install_element(O
SPF_NODE,&no_pce_domain_cmd);install_element(OSPF_NODE,&pce_neighbor_cmd);instal
l_element(OSPF_NODE,&no_pce_neighbor_cmd);install_element(OSPF_NODE,&pce_cap_fla
g_cmd);install_element(OSPF_NODE,&no_pce_cap_flag_cmd);return;}