/**OSPFLSDBsupport.*Copyright(C)1999,2000AlexZinin,KunihiroIshiguro,ToshiakiTaka
da**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/or
modifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareF
oundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdistribute
dinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrant
yof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicense
formoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*wit
hthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51Fr
anklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"prefix.h"#
include"table.h"#include"memory.h"#include"log.h"#include"ospfd/ospfd.h"#include
"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_lsdb.h"structos
pf_lsdb*ospf_lsdb_new(){structospf_lsdb*new;new=XCALLOC(MTYPE_OSPF_LSDB,sizeof(s
tructospf_lsdb));ospf_lsdb_init(new);returnnew;}voidospf_lsdb_init(structospf_ls
db*lsdb){inti;for(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++)lsdb->type[i].db=route_table
_init();}voidospf_lsdb_free(structospf_lsdb*lsdb){ospf_lsdb_cleanup(lsdb);XFREE(
MTYPE_OSPF_LSDB,lsdb);}voidospf_lsdb_cleanup(structospf_lsdb*lsdb){inti;assert(l
sdb);assert(lsdb->total==0);ospf_lsdb_delete_all(lsdb);for(i=OSPF_MIN_LSA;i<OSPF
_MAX_LSA;i++)route_table_finish(lsdb->type[i].db);}voidls_prefix_set(structprefi
x_ls*lp,structospf_lsa*lsa){if(lp&&lsa&&lsa->data){lp->family=0;lp->prefixlen=64
;lp->id=lsa->data->id;lp->adv_router=lsa->data->adv_router;}}staticvoidospf_lsdb
_delete_entry(structospf_lsdb*lsdb,structroute_node*rn){structospf_lsa*lsa=rn->i
nfo;if(!lsa)return;assert(rn->table==lsdb->type[lsa->data->type].db);if(IS_LSA_S
ELF(lsa))lsdb->type[lsa->data->type].count_self--;lsdb->type[lsa->data->type].co
unt--;lsdb->type[lsa->data->type].checksum-=ntohs(lsa->data->checksum);lsdb->tot
al--;rn->info=NULL;route_unlock_node(rn);#ifdefMONITOR_LSDB_CHANGEif(lsdb->del_l
sa_hook!=NULL)(*lsdb->del_lsa_hook)(lsa);#endif/*MONITOR_LSDB_CHANGE*/ospf_lsa_u
nlock(&lsa);/*lsdb*/return;}/*AddnewLSAtolsdb.*/voidospf_lsdb_add(structospf_lsd
b*lsdb,structospf_lsa*lsa){structroute_table*table;structprefix_lslp;structroute
_node*rn;table=lsdb->type[lsa->data->type].db;ls_prefix_set(&lp,lsa);rn=route_no
de_get(table,(structprefix*)&lp);/*nothingtodo?*/if(rn->info&&rn->info==lsa){rou
te_unlock_node(rn);return;}/*purgeoldentry?*/if(rn->info)ospf_lsdb_delete_entry(
lsdb,rn);if(IS_LSA_SELF(lsa))lsdb->type[lsa->data->type].count_self++;lsdb->type
[lsa->data->type].count++;lsdb->total++;#ifdefMONITOR_LSDB_CHANGEif(lsdb->new_ls
a_hook!=NULL)(*lsdb->new_lsa_hook)(lsa);#endif/*MONITOR_LSDB_CHANGE*/lsdb->type[
lsa->data->type].checksum+=ntohs(lsa->data->checksum);rn->info=ospf_lsa_lock(lsa
);/*lsdb*/}voidospf_lsdb_delete(structospf_lsdb*lsdb,structospf_lsa*lsa){structr
oute_table*table;structprefix_lslp;structroute_node*rn;if(!lsdb){zlog_warn("%s:C
alledwithNULLLSDB",__func__);if(lsa)zlog_warn("LSA[Type%d:%s]:LSA%p,lsa->lsdb%p"
,lsa->data->type,inet_ntoa(lsa->data->id),(void*)lsa,(void*)lsa->lsdb);return;}i
f(!lsa){zlog_warn("%s:CalledwithNULLLSA",__func__);return;}assert(lsa->data->typ
e<OSPF_MAX_LSA);table=lsdb->type[lsa->data->type].db;ls_prefix_set(&lp,lsa);if((
rn=route_node_lookup(table,(structprefix*)&lp))){if(rn->info==lsa)ospf_lsdb_dele
te_entry(lsdb,rn);route_unlock_node(rn);/*route_node_lookup*/}}voidospf_lsdb_del
ete_all(structospf_lsdb*lsdb){structroute_table*table;structroute_node*rn;inti;f
or(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++){table=lsdb->type[i].db;for(rn=route_top(ta
ble);rn;rn=route_next(rn))if(rn->info!=NULL)ospf_lsdb_delete_entry(lsdb,rn);}}vo
idospf_lsdb_clean_stat(structospf_lsdb*lsdb){structroute_table*table;structroute
_node*rn;structospf_lsa*lsa;inti;for(i=OSPF_MIN_LSA;i<OSPF_MAX_LSA;i++){table=ls
db->type[i].db;for(rn=route_top(table);rn;rn=route_next(rn))if((lsa=(rn->info))!
=NULL)lsa->stat=LSA_SPF_NOT_EXPLORED;}}structospf_lsa*ospf_lsdb_lookup(structosp
f_lsdb*lsdb,structospf_lsa*lsa){structroute_table*table;structprefix_lslp;struct
route_node*rn;structospf_lsa*find;table=lsdb->type[lsa->data->type].db;ls_prefix
_set(&lp,lsa);rn=route_node_lookup(table,(structprefix*)&lp);if(rn){find=rn->inf
o;route_unlock_node(rn);returnfind;}returnNULL;}structospf_lsa*ospf_lsdb_lookup_
by_id(structospf_lsdb*lsdb,uint8_ttype,structin_addrid,structin_addradv_router){
structroute_table*table;structprefix_lslp;structroute_node*rn;structospf_lsa*fin
d;table=lsdb->type[type].db;memset(&lp,0,sizeof(structprefix_ls));lp.family=0;lp
.prefixlen=64;lp.id=id;lp.adv_router=adv_router;rn=route_node_lookup(table,(stru
ctprefix*)&lp);if(rn){find=rn->info;route_unlock_node(rn);returnfind;}returnNULL
;}structospf_lsa*ospf_lsdb_lookup_by_id_next(structospf_lsdb*lsdb,uint8_ttype,st
ructin_addrid,structin_addradv_router,intfirst){structroute_table*table;structpr
efix_lslp;structroute_node*rn;structospf_lsa*find;table=lsdb->type[type].db;mems
et(&lp,0,sizeof(structprefix_ls));lp.family=0;lp.prefixlen=64;lp.id=id;lp.adv_ro
uter=adv_router;if(first)rn=route_top(table);else{if((rn=route_node_lookup(table
,(structprefix*)&lp))==NULL)returnNULL;rn=route_next(rn);}for(;rn;rn=route_next(
rn))if(rn->info)break;if(rn&&rn->info){find=rn->info;route_unlock_node(rn);retur
nfind;}returnNULL;}unsignedlongospf_lsdb_count_all(structospf_lsdb*lsdb){returnl
sdb->total;}unsignedlongospf_lsdb_count(structospf_lsdb*lsdb,inttype){returnlsdb
->type[type].count;}unsignedlongospf_lsdb_count_self(structospf_lsdb*lsdb,inttyp
e){returnlsdb->type[type].count_self;}unsignedintospf_lsdb_checksum(structospf_l
sdb*lsdb,inttype){returnlsdb->type[type].checksum;}unsignedlongospf_lsdb_isempty
(structospf_lsdb*lsdb){return(lsdb->total==0);}