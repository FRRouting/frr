/*ThisfileispartofQuagga.**Quaggaisfreesoftware;youcanredistributeitand/ormodify
it*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundat
ion;eitherversion2,or(atyouroption)any*laterversion.**Quaggaisdistributedintheho
pethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERC
HANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformored
etails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthispro
gram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt
,FifthFloor,Boston,MA02110-1301USA*//**SimpleprogramtodemonstratehowOSPFAPIcanbe
used.This*applicationretrievestheLSDBfromtheOSPFdaemonandthen*originates,updates
andfinallydeletesanapplication-specific*opaqueLSA.Youcanusethisapplicationasatem
platewhenwriting*yourownapplication.*//*ThefollowingincludesareneededinallOSPFAP
Iclientapplications.*/#include<zebra.h>#include"prefix.h"/*neededbyospf_asbr.h*/
#include"privs.h"#include"log.h"/*workaroundgccbug69981,disableMTYPEsinlibospf*/
#define_QUAGGA_OSPF_MEMORY_H#include"ospfd/ospfd.h"#include"ospfd/ospf_asbr.h"#i
nclude"ospfd/ospf_lsa.h"#include"ospfd/ospf_opaque.h"#include"ospfd/ospf_api.h"#
include"ospf_apiclient.h"/*privilegesstruct.*setcap_num_*anduid/gidtonothingtous
eNULLprivs*asospfapiclientlinksinlibospf.awhichusesprivs.*/structzebra_privs_tos
pfd_privs={.user=NULL,.group=NULL,.cap_num_p=0,.cap_num_i=0};/*Thefollowinginclu
desarespecifictothisapplication.Forexampleitusesthreadsfromlibfrr,howeveryourapp
licationisfreetouseanythreadlibrary(likepthreads).*/#include"ospfd/ospf_dump.h"/
*forospf_lsa_header_dump*/#include"thread.h"#include"log.h"/*Localportnumberfora
syncchannel.NotethatOSPFAPIlibrarywillalsoallocateasyncchannelatASYNCPORT+1.*/#d
efineASYNCPORT4000/*Masterthread*/structthread_master*master;/*Globalvariables*/
structospf_apiclient*oclient;char**args;/*OuropaqueLSAshavethefollowingformat.*/
structmy_opaque_lsa{structlsa_headerhdr;/*includecommonLSAheader*/uint8_tdata[4]
;/*ourowndataformatthenfollowshere*/};/*----------------------------------------
-----------------*ThreadsforasynchronousmessagesandLSAupdate/delete*------------
---------------------------------------------*/staticintlsa_delete(structthread*
t){structospf_apiclient*oclient;structin_addrarea_id;intrc;oclient=THREAD_ARG(t)
;rc=inet_aton(args[6],&area_id);if(rc<=0){printf("AddressSpecified:%sisinvalid\n
",args[6]);returnrc;}printf("DeletingLSA...");rc=ospf_apiclient_lsa_delete(oclie
nt,area_id,atoi(args[2]),/*lsatype*/atoi(args[3]),/*opaquetype*/atoi(args[4]));/
*opaqueID*/printf("done,returncodeis=%d\n",rc);returnrc;}staticintlsa_inject(str
uctthread*t){structospf_apiclient*cl;structin_addrifaddr;structin_addrarea_id;ui
nt8_tlsa_type;uint8_topaque_type;uint32_topaque_id;void*opaquedata;intopaquelen;
staticuint32_tcounter=1;/*Incrementedeachtimeinvoked*/intrc;cl=THREAD_ARG(t);rc=
inet_aton(args[5],&ifaddr);if(rc<=0){printf("Ifaddrspecified%sisinvalid\n",args[
5]);returnrc;}rc=inet_aton(args[6],&area_id);if(rc<=0){printf("AreaIDspecified%s
isinvalid\n",args[6]);returnrc;}lsa_type=atoi(args[2]);opaque_type=atoi(args[3])
;opaque_id=atoi(args[4]);opaquedata=&counter;opaquelen=sizeof(uint32_t);printf("
Originating/updatingLSAwithcounter=%d...",counter);rc=ospf_apiclient_lsa_origina
te(cl,ifaddr,area_id,lsa_type,opaque_type,opaque_id,opaquedata,opaquelen);printf
("done,returncodeis%d\n",rc);counter++;return0;}/*Thisthreadhandlesasynchronousm
essagescominginfromtheOSPFAPIserver*/staticintlsa_read(structthread*thread){stru
ctospf_apiclient*oclient;intfd;intret;printf("lsa_readcalled\n");oclient=THREAD_
ARG(thread);fd=THREAD_FD(thread);/*Handleasynchronousmessage*/ret=ospf_apiclient
_handle_async(oclient);if(ret<0){printf("Connectionclosed,exiting...");exit(0);}
/*Reschedulereadthread*/thread_add_read(master,lsa_read,oclient,fd,NULL);return0
;}/*---------------------------------------------------------*Callbackfunctionsf
orasynchronousevents*---------------------------------------------------------*/
staticvoidlsa_update_callback(structin_addrifaddr,structin_addrarea_id,uint8_tis
_self_originated,structlsa_header*lsa){printf("lsa_update_callback:");printf("if
addr:%s",inet_ntoa(ifaddr));printf("area:%s\n",inet_ntoa(area_id));printf("is_se
lf_origin:%u\n",is_self_originated);/*Itisimportanttonotethatlsa_headerdoesindee
dincludetheheaderandtheLSApayload.Toaccessthepayload,firstchecktheLSAtypeandthen
typecastlsaintothecorrespondingtype,e.g.:if(lsa->type==OSPF_ROUTER_LSA){structro
uter_lsa*rl=(structrouter_lsa)lsa;...uint16_tlinks=rl->links;...}*/ospf_lsa_head
er_dump(lsa);}staticvoidlsa_delete_callback(structin_addrifaddr,structin_addrare
a_id,uint8_tis_self_originated,structlsa_header*lsa){printf("lsa_delete_callback
:");printf("ifaddr:%s",inet_ntoa(ifaddr));printf("area:%s\n",inet_ntoa(area_id))
;printf("is_self_origin:%u\n",is_self_originated);ospf_lsa_header_dump(lsa);}sta
ticvoidready_callback(uint8_tlsa_type,uint8_topaque_type,structin_addraddr){prin
tf("ready_callback:lsa_type:%dopaque_type:%daddr=%s\n",lsa_type,opaque_type,inet
_ntoa(addr));/*ScheduleopaqueLSAoriginatein5secs*/thread_add_timer(master,lsa_in
ject,oclient,5,NULL);/*ScheduleopaqueLSAupdatewithnewvalue*/thread_add_timer(mas
ter,lsa_inject,oclient,10,NULL);/*Scheduledelete*/thread_add_timer(master,lsa_de
lete,oclient,30,NULL);}staticvoidnew_if_callback(structin_addrifaddr,structin_ad
drarea_id){printf("new_if_callback:ifaddr:%s",inet_ntoa(ifaddr));printf("area_id
:%s\n",inet_ntoa(area_id));}staticvoiddel_if_callback(structin_addrifaddr){print
f("new_if_callback:ifaddr:%s\n",inet_ntoa(ifaddr));}staticvoidism_change_callbac
k(structin_addrifaddr,structin_addrarea_id,uint8_tstate){printf("ism_change:ifad
dr:%s",inet_ntoa(ifaddr));printf("area_id:%s\n",inet_ntoa(area_id));printf("stat
e:%d[%s]\n",state,lookup_msg(ospf_ism_state_msg,state,NULL));}staticvoidnsm_chan
ge_callback(structin_addrifaddr,structin_addrnbraddr,structin_addrrouter_id,uint
8_tstate){printf("nsm_change:ifaddr:%s",inet_ntoa(ifaddr));printf("nbraddr:%s\n"
,inet_ntoa(nbraddr));printf("router_id:%s\n",inet_ntoa(router_id));printf("state
:%d[%s]\n",state,lookup_msg(ospf_nsm_state_msg,state,NULL));}/*-----------------
----------------------------------------*Mainprogram*---------------------------
------------------------------*/staticintusage(void){printf("Usage:ospfclient<os
pfd><lsatype><opaquetype><opaqueid><ifaddr><areaid>\n");printf("whereospfd:route
rwhereAPI-enabledOSPFdaemonisrunning\n");printf("lsatype:either9,10,or11dependin
gonfloodingscope\n");printf("opaquetype:0-255(e.g.,experimentalapplicationsuse>1
28)\n");printf("opaqueid:arbitraryapplicationinstance(24bits)\n");printf("ifaddr
:interfaceIPaddress(fortype9)otherwiseignored\n");printf("areaid:areainIPaddress
format(fortype10)otherwiseignored\n");exit(1);}intmain(intargc,char*argv[]){stru
ctthreadthread;args=argv;/*ospfclientshouldbestartedwiththefollowingarguments:**
(1)host(2)lsa_type(3)opaque_type(4)opaque_id(5)if_addr*(6)area_id**host:nameorIP
ofhostwhereospfdisrunning*lsa_type:9,10,or11*opaque_type:0-255(e.g.,experimental
applicationsuse>128)*opaque_id:arbitraryapplicationinstance(24bits)*if_addr:inte
rfaceIPaddress(fortype9)otherwiseignored*area_id:areainIPaddressformat(fortype10
)otherwiseignored*/if(argc!=7){usage();}/*Initialization*/zprivs_preinit(&ospfd_
privs);zprivs_init(&ospfd_privs);master=thread_master_create(NULL);/*Openconnect
iontoOSPFdaemon*/oclient=ospf_apiclient_connect(args[1],ASYNCPORT);if(!oclient){
printf("ConnectingtoOSPFdaemonon%sfailed!\n",args[1]);exit(1);}/*Registercallbac
kfunctions.*/ospf_apiclient_register_callback(oclient,ready_callback,new_if_call
back,del_if_callback,ism_change_callback,nsm_change_callback,lsa_update_callback
,lsa_delete_callback);/*RegisterLSAtypeandopaquetype.*/ospf_apiclient_register_o
paque_type(oclient,atoi(args[2]),atoi(args[3]));/*SynchronizedatabasewithOSPFdae
mon.*/ospf_apiclient_sync_lsdb(oclient);/*Schedulethreadthathandlesasynchronousm
essages*/thread_add_read(master,lsa_read,oclient,oclient->fd_async,NULL);/*Nowco
nnectionisestablished,runloop*/while(1){thread_fetch(master,&thread);thread_call
(&thread);}/*Neverreached*/return0;}