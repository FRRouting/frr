/**ClientsideofOSPFAPI.*Copyright(C)2001,2002,2003RalphKeller**ThisfileispartofG
NUZebra.**GNUZebraisfreesoftware;youcanredistributeitand/ormodify*itundertheterm
softheGNUGeneralPublicLicenseaspublished*bytheFreeSoftwareFoundation;eitherversi
on2,or(atyour*option)anylaterversion.**GNUZebraisdistributedinthehopethatitwillb
euseful,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYor
FITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Yous
houldhavereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefi
leCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,B
oston,MA02110-1301USA*/#include<zebra.h>#include<lib/version.h>#include"getopt.h
"#include"thread.h"#include"prefix.h"#include"linklist.h"#include"if.h"#include"
vector.h"#include"vty.h"#include"command.h"#include"filter.h"#include"stream.h"#
include"log.h"#include"memory.h"/*workaroundgccbug69981,disableMTYPEsinlibospf*/
#define_QUAGGA_OSPF_MEMORY_H#include"ospfd/ospfd.h"#include"ospfd/ospf_interface
.h"#include"ospfd/ospf_asbr.h"#include"ospfd/ospf_lsa.h"#include"ospfd/ospf_opaq
ue.h"#include"ospfd/ospf_lsdb.h"#include"ospfd/ospf_neighbor.h"#include"ospfd/os
pf_dump.h"#include"ospfd/ospf_zebra.h"#include"ospfd/ospf_api.h"#include"ospf_ap
iclient.h"/**sigh*...can'tfindabetterwaytohammerthisintoautomake*/#include"ospfd
/ospf_dump_api.c"#include"ospfd/ospf_api.c"DEFINE_MGROUP(OSPFCLIENT,"libospfapic
lient")DEFINE_MTYPE_STATIC(OSPFCLIENT,OSPF_APICLIENT,"OSPF-APIclient")/*Backlogf
orlisten*/#defineBACKLOG5/*-----------------------------------------------------
------*Forwarddeclarations*-----------------------------------------------------
------*/voidospf_apiclient_handle_reply(structospf_apiclient*oclient,structmsg*m
sg);voidospf_apiclient_handle_update_notify(structospf_apiclient*oclient,structm
sg*msg);voidospf_apiclient_handle_delete_notify(structospf_apiclient*oclient,str
uctmsg*msg);/*-----------------------------------------------------------*Initia
lization*-----------------------------------------------------------*/staticunsi
gnedshortospf_apiclient_getport(void){structservent*sp=getservbyname("ospfapi","
tcp");returnsp?ntohs(sp->s_port):OSPF_API_SYNC_PORT;}/*-------------------------
----------------------------------*Followingsarefunctionsforconnectionmanagement
*-----------------------------------------------------------*/structospf_apiclie
nt*ospf_apiclient_connect(char*host,intsyncport){structsockaddr_inmyaddr_sync;st
ructsockaddr_inmyaddr_async;structsockaddr_inpeeraddr;structhostent*hp;structosp
f_apiclient*new;intsize=0;unsignedintpeeraddrlen;intasync_server_sock;intfd1,fd2
;intret;inton=1;/*Therearetwoconnectionsbetweentheclientandtheserver.Firstthecli
entopensaconnectionforsynchronousrequests/repliestotheserver.Theserverwillaccept
thisconnectionandasareactionopenareverseconnectionchannelforasynchronousmessages
.*/async_server_sock=socket(AF_INET,SOCK_STREAM,0);if(async_server_sock<0){fprin
tf(stderr,"ospf_apiclient_connect:creatingasyncsocketfailed\n");returnNULL;}/*Pr
eparesocketforasynchronousmessages*//*Initializeasyncaddressstructure*/memset(&m
yaddr_async,0,sizeof(structsockaddr_in));myaddr_async.sin_family=AF_INET;myaddr_
async.sin_addr.s_addr=htonl(INADDR_ANY);myaddr_async.sin_port=htons(syncport+1);
size=sizeof(structsockaddr_in);#ifdefHAVE_STRUCT_SOCKADDR_IN_SIN_LENmyaddr_async
.sin_len=size;#endif/*HAVE_STRUCT_SOCKADDR_IN_SIN_LEN*//*Thisisaserversocket,reu
seaddrandport*/ret=setsockopt(async_server_sock,SOL_SOCKET,SO_REUSEADDR,(void*)&
on,sizeof(on));if(ret<0){fprintf(stderr,"ospf_apiclient_connect:SO_REUSEADDRfail
ed\n");close(async_server_sock);returnNULL;}#ifdefSO_REUSEPORTret=setsockopt(asy
nc_server_sock,SOL_SOCKET,SO_REUSEPORT,(void*)&on,sizeof(on));if(ret<0){fprintf(
stderr,"ospf_apiclient_connect:SO_REUSEPORTfailed\n");close(async_server_sock);r
eturnNULL;}#endif/*SO_REUSEPORT*//*Bindsockettoaddressstructure*/ret=bind(async_
server_sock,(structsockaddr*)&myaddr_async,size);if(ret<0){fprintf(stderr,"ospf_
apiclient_connect:bindasyncsocketfailed\n");close(async_server_sock);returnNULL;
}/*Waitforreversechannelconnectionestablishmentfromserver*/ret=listen(async_serv
er_sock,BACKLOG);if(ret<0){fprintf(stderr,"ospf_apiclient_connect:listen:%s\n",s
afe_strerror(errno));close(async_server_sock);returnNULL;}/*Makeconnectionforsyn
chronousrequestsandconnecttoserver*//*Resolveaddressofserver*/hp=gethostbyname(h
ost);if(!hp){fprintf(stderr,"ospf_apiclient_connect:nosuchhost%s\n",host);close(
async_server_sock);returnNULL;}fd1=socket(AF_INET,SOCK_STREAM,0);if(fd1<0){close
(async_server_sock);fprintf(stderr,"ospf_apiclient_connect:creatingsyncsocketfai
led\n");returnNULL;}/*Reuseaddrandport*/ret=setsockopt(fd1,SOL_SOCKET,SO_REUSEAD
DR,(void*)&on,sizeof(on));if(ret<0){fprintf(stderr,"ospf_apiclient_connect:SO_RE
USEADDRfailed\n");close(fd1);close(async_server_sock);returnNULL;}#ifdefSO_REUSE
PORTret=setsockopt(fd1,SOL_SOCKET,SO_REUSEPORT,(void*)&on,sizeof(on));if(ret<0){
fprintf(stderr,"ospf_apiclient_connect:SO_REUSEPORTfailed\n");close(fd1);close(a
sync_server_sock);returnNULL;}#endif/*SO_REUSEPORT*//*Bindsyncsockettoaddressstr
ucture.Thisisneededsincewewantthesyncportnumberonafixedportnumber.Thereverseasyn
cchannelwillbeatthisport+1*/memset(&myaddr_sync,0,sizeof(structsockaddr_in));mya
ddr_sync.sin_family=AF_INET;myaddr_sync.sin_port=htons(syncport);#ifdefHAVE_STRU
CT_SOCKADDR_IN_SIN_LENmyaddr_sync.sin_len=sizeof(structsockaddr_in);#endif/*HAVE
_STRUCT_SOCKADDR_IN_SIN_LEN*/ret=bind(fd1,(structsockaddr*)&myaddr_sync,size);if
(ret<0){fprintf(stderr,"ospf_apiclient_connect:bindsyncsocketfailed\n");close(fd
1);close(async_server_sock);returnNULL;}/*Prepareaddressstructureforconnect*/mem
cpy(&myaddr_sync.sin_addr,hp->h_addr,hp->h_length);myaddr_sync.sin_family=AF_INE
T;myaddr_sync.sin_port=htons(ospf_apiclient_getport());#ifdefHAVE_STRUCT_SOCKADD
R_IN_SIN_LENmyaddr_sync.sin_len=sizeof(structsockaddr_in);#endif/*HAVE_STRUCT_SO
CKADDR_IN_SIN_LEN*//*NowestablishsynchronouschannelwithOSPFdaemon*/ret=connect(f
d1,(structsockaddr*)&myaddr_sync,sizeof(structsockaddr_in));if(ret<0){fprintf(st
derr,"ospf_apiclient_connect:syncconnectfailed\n");close(async_server_sock);clos
e(fd1);returnNULL;}/*Acceptreverseconnection*/peeraddrlen=sizeof(structsockaddr_
in);memset(&peeraddr,0,peeraddrlen);fd2=accept(async_server_sock,(structsockaddr
*)&peeraddr,&peeraddrlen);if(fd2<0){fprintf(stderr,"ospf_apiclient_connect:accep
tasyncfailed\n");close(async_server_sock);close(fd1);close(fd2);returnNULL;}/*Se
rversocketisnotneededanymoresincewearenotacceptingmoreconnections*/close(async_s
erver_sock);/*Createnewclient-sideinstance*/new=XCALLOC(MTYPE_OSPF_APICLIENT,siz
eof(structospf_apiclient));/*Initializesocketdescriptorsforsyncandasyncchannels*
/new->fd_sync=fd1;new->fd_async=fd2;returnnew;}intospf_apiclient_close(structosp
f_apiclient*oclient){if(oclient->fd_sync>=0){close(oclient->fd_sync);}if(oclient
->fd_async>=0){close(oclient->fd_async);}/*Freeclientstructure*/XFREE(MTYPE_OSPF
_APICLIENT,oclient);return0;}/*-------------------------------------------------
----------*FollowingsarefunctionstosendarequesttoOSPFd*-------------------------
----------------------------------*//*Sendsynchronousrequest,waitforreply*/stati
cintospf_apiclient_send_request(structospf_apiclient*oclient,structmsg*msg){uint
32_treqseq;structmsg_reply*msgreply;intrc;/*NB:Given"msg"isfreedinsidethisfuncti
on.*//*Rememberthesequencenumberoftherequest*/reqseq=ntohl(msg->hdr.msgseq);/*Wr
itemessagetoOSPFd*/rc=msg_write(oclient->fd_sync,msg);msg_free(msg);if(rc<0){ret
urn-1;}/*Waitforreply*//*NB:New"msg"isallocatedby"msg_read()".*/msg=msg_read(ocl
ient->fd_sync);if(!msg)return-1;assert(msg->hdr.msgtype==MSG_REPLY);assert(ntohl
(msg->hdr.msgseq)==reqseq);msgreply=(structmsg_reply*)STREAM_DATA(msg->s);rc=msg
reply->errcode;msg_free(msg);returnrc;}/*---------------------------------------
--------------------*Helperfunctions*-------------------------------------------
----------------*/staticuint32_tospf_apiclient_get_seqnr(void){staticuint32_tseq
nr=MIN_SEQ;uint32_ttmp;tmp=seqnr;/*Incrementsequencenumber*/if(seqnr<MAX_SEQ){se
qnr++;}else{seqnr=MIN_SEQ;}returntmp;}/*----------------------------------------
-------------------*APItoaccessOSPFdaemonbyclientapplications.*-----------------
------------------------------------------*//**Synchronousrequesttoregisteropaqu
etype.*/intospf_apiclient_register_opaque_type(structospf_apiclient*cl,uint8_tlt
ype,uint8_totype){structmsg*msg;intrc;/*justput1asasequencenumber.*/msg=new_msg_
register_opaque_type(ospf_apiclient_get_seqnr(),ltype,otype);if(!msg){fprintf(st
derr,"new_msg_register_opaque_typefailed\n");return-1;}rc=ospf_apiclient_send_re
quest(cl,msg);returnrc;}/**SynchronousrequesttosynchronizewithOSPF'sLSDB.*Twoste
psrequired:register_eventinordertoget*dynamicupdatesandLSDB_Sync.*/intospf_apicl
ient_sync_lsdb(structospf_apiclient*oclient){structmsg*msg;intrc;structlsa_filte
r_typefilter;filter.typemask=0xFFFF;/*allLSAs*/filter.origin=ANY_ORIGIN;filter.n
um_areas=0;/*allAreas.*/msg=new_msg_register_event(ospf_apiclient_get_seqnr(),&f
ilter);if(!msg){fprintf(stderr,"new_msg_register_eventfailed\n");return-1;}rc=os
pf_apiclient_send_request(oclient,msg);if(rc!=0)gotoout;msg=new_msg_sync_lsdb(os
pf_apiclient_get_seqnr(),&filter);if(!msg){fprintf(stderr,"new_msg_sync_lsdbfail
ed\n");return-1;}rc=ospf_apiclient_send_request(oclient,msg);out:returnrc;}/**Sy
nchronousrequesttooriginateorupdateanLSA.*/intospf_apiclient_lsa_originate(struc
tospf_apiclient*oclient,structin_addrifaddr,structin_addrarea_id,uint8_tlsa_type
,uint8_topaque_type,uint32_topaque_id,void*opaquedata,intopaquelen){structmsg*ms
g;intrc;uint8_tbuf[OSPF_MAX_LSA_SIZE];structlsa_header*lsah;uint32_ttmp;/*Wecano
nlyoriginateopaqueLSAs*/if(!IS_OPAQUE_LSA(lsa_type)){fprintf(stderr,"Cannotorigi
natenon-opaqueLSAtype%d\n",lsa_type);returnOSPF_API_ILLEGALLSATYPE;}/*MakeanewLS
Afromparameters*/lsah=(structlsa_header*)buf;lsah->ls_age=0;lsah->options=0;lsah
->type=lsa_type;tmp=SET_OPAQUE_LSID(opaque_type,opaque_id);lsah->id.s_addr=htonl
(tmp);lsah->adv_router.s_addr=0;lsah->ls_seqnum=0;lsah->checksum=0;lsah->length=
htons(sizeof(structlsa_header)+opaquelen);memcpy(((uint8_t*)lsah)+sizeof(structl
sa_header),opaquedata,opaquelen);msg=new_msg_originate_request(ospf_apiclient_ge
t_seqnr(),ifaddr,area_id,lsah);if(!msg){fprintf(stderr,"new_msg_originate_reques
tfailed\n");returnOSPF_API_NOMEMORY;}rc=ospf_apiclient_send_request(oclient,msg)
;returnrc;}intospf_apiclient_lsa_delete(structospf_apiclient*oclient,structin_ad
drarea_id,uint8_tlsa_type,uint8_topaque_type,uint32_topaque_id){structmsg*msg;in
trc;/*OnlyopaqueLSAcanbedeleted*/if(!IS_OPAQUE_LSA(lsa_type)){fprintf(stderr,"Ca
nnotdeletenon-opaqueLSAtype%d\n",lsa_type);returnOSPF_API_ILLEGALLSATYPE;}/*opaq
ue_idisinhostbyteorderandwillbeconverted*tonetworkbyteorderbynew_msg_delete_requ
est*/msg=new_msg_delete_request(ospf_apiclient_get_seqnr(),area_id,lsa_type,opaq
ue_type,opaque_id);rc=ospf_apiclient_send_request(oclient,msg);returnrc;}/*-----
------------------------------------------------------*Followingsarehandlersform
essagesfromOSPFdaemon*----------------------------------------------------------
-*/staticvoidospf_apiclient_handle_ready(structospf_apiclient*oclient,structmsg*
msg){structmsg_ready_notify*r;r=(structmsg_ready_notify*)STREAM_DATA(msg->s);/*I
nvokeregisteredcallbackfunction.*/if(oclient->ready_notify){(oclient->ready_noti
fy)(r->lsa_type,r->opaque_type,r->addr);}}staticvoidospf_apiclient_handle_new_if
(structospf_apiclient*oclient,structmsg*msg){structmsg_new_if*n;n=(structmsg_new
_if*)STREAM_DATA(msg->s);/*Invokeregisteredcallbackfunction.*/if(oclient->new_if
){(oclient->new_if)(n->ifaddr,n->area_id);}}staticvoidospf_apiclient_handle_del_
if(structospf_apiclient*oclient,structmsg*msg){structmsg_del_if*d;d=(structmsg_d
el_if*)STREAM_DATA(msg->s);/*Invokeregisteredcallbackfunction.*/if(oclient->del_
if){(oclient->del_if)(d->ifaddr);}}staticvoidospf_apiclient_handle_ism_change(st
ructospf_apiclient*oclient,structmsg*msg){structmsg_ism_change*m;m=(structmsg_is
m_change*)STREAM_DATA(msg->s);/*Invokeregisteredcallbackfunction.*/if(oclient->i
sm_change){(oclient->ism_change)(m->ifaddr,m->area_id,m->status);}}staticvoidosp
f_apiclient_handle_nsm_change(structospf_apiclient*oclient,structmsg*msg){struct
msg_nsm_change*m;m=(structmsg_nsm_change*)STREAM_DATA(msg->s);/*Invokeregistered
callbackfunction.*/if(oclient->nsm_change){(oclient->nsm_change)(m->ifaddr,m->nb
raddr,m->router_id,m->status);}}staticvoidospf_apiclient_handle_lsa_update(struc
tospf_apiclient*oclient,structmsg*msg){structmsg_lsa_change_notify*cn;structlsa_
header*lsa;intlsalen;cn=(structmsg_lsa_change_notify*)STREAM_DATA(msg->s);/*Extr
actLSAfrommessage*/lsalen=ntohs(cn->data.length);lsa=XMALLOC(MTYPE_OSPF_APICLIEN
T,lsalen);if(!lsa){fprintf(stderr,"LSAupdate:CannotallocatememoryforLSA\n");retu
rn;}memcpy(lsa,&(cn->data),lsalen);/*Invokeregisteredupdatecallbackfunction*/if(
oclient->update_notify){(oclient->update_notify)(cn->ifaddr,cn->area_id,cn->is_s
elf_originated,lsa);}/*freememoryallocatedbyospfapiclientlibrary*/XFREE(MTYPE_OS
PF_APICLIENT,lsa);}staticvoidospf_apiclient_handle_lsa_delete(structospf_apiclie
nt*oclient,structmsg*msg){structmsg_lsa_change_notify*cn;structlsa_header*lsa;in
tlsalen;cn=(structmsg_lsa_change_notify*)STREAM_DATA(msg->s);/*ExtractLSAfrommes
sage*/lsalen=ntohs(cn->data.length);lsa=XMALLOC(MTYPE_OSPF_APICLIENT,lsalen);if(
!lsa){fprintf(stderr,"LSAdelete:CannotallocatememoryforLSA\n");return;}memcpy(ls
a,&(cn->data),lsalen);/*Invokeregisteredupdatecallbackfunction*/if(oclient->dele
te_notify){(oclient->delete_notify)(cn->ifaddr,cn->area_id,cn->is_self_originate
d,lsa);}/*freememoryallocatedbyospfapiclientlibrary*/XFREE(MTYPE_OSPF_APICLIENT,
lsa);}staticvoidospf_apiclient_msghandle(structospf_apiclient*oclient,structmsg*
msg){/*Callmessagehandlerfunction.*/switch(msg->hdr.msgtype){caseMSG_READY_NOTIF
Y:ospf_apiclient_handle_ready(oclient,msg);break;caseMSG_NEW_IF:ospf_apiclient_h
andle_new_if(oclient,msg);break;caseMSG_DEL_IF:ospf_apiclient_handle_del_if(ocli
ent,msg);break;caseMSG_ISM_CHANGE:ospf_apiclient_handle_ism_change(oclient,msg);
break;caseMSG_NSM_CHANGE:ospf_apiclient_handle_nsm_change(oclient,msg);break;cas
eMSG_LSA_UPDATE_NOTIFY:ospf_apiclient_handle_lsa_update(oclient,msg);break;caseM
SG_LSA_DELETE_NOTIFY:ospf_apiclient_handle_lsa_delete(oclient,msg);break;default
:fprintf(stderr,"ospf_apiclient_read:Unknownmessagetype:%d\n",msg->hdr.msgtype);
break;}}/*-----------------------------------------------------------*Callbackha
ndlerregistration*-----------------------------------------------------------*/v
oidospf_apiclient_register_callback(structospf_apiclient*oclient,void(*ready_not
ify)(uint8_tlsa_type,uint8_topaque_type,structin_addraddr),void(*new_if)(structi
n_addrifaddr,structin_addrarea_id),void(*del_if)(structin_addrifaddr),void(*ism_
change)(structin_addrifaddr,structin_addrarea_id,uint8_tstatus),void(*nsm_change
)(structin_addrifaddr,structin_addrnbraddr,structin_addrrouter_id,uint8_tstatus)
,void(*update_notify)(structin_addrifaddr,structin_addrarea_id,uint8_tself_origi
n,structlsa_header*lsa),void(*delete_notify)(structin_addrifaddr,structin_addrar
ea_id,uint8_tself_origin,structlsa_header*lsa)){assert(oclient);assert(update_no
tify);/*Registercallbackfunction*/oclient->ready_notify=ready_notify;oclient->ne
w_if=new_if;oclient->del_if=del_if;oclient->ism_change=ism_change;oclient->nsm_c
hange=nsm_change;oclient->update_notify=update_notify;oclient->delete_notify=del
ete_notify;}/*-----------------------------------------------------------*Asynch
ronousmessagehandling*----------------------------------------------------------
-*/intospf_apiclient_handle_async(structospf_apiclient*oclient){structmsg*msg;/*
Getamessage*/msg=msg_read(oclient->fd_async);if(!msg){/*Connectionbrokedown*/ret
urn-1;}/*Handlemessage*/ospf_apiclient_msghandle(oclient,msg);/*Don'tforgettofre
ethismessage*/msg_free(msg);return0;}