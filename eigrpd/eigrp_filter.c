/**EIGRPFilterFunctions.*Copyright(C)2013-2015*Authors:*DonnieSavage*JanJanovic*
MatejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvorkovy*MartinKontsek*Luk
asKoribsky***ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistribut
eitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*Free
SoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisd
istributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpli
edwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPubl
icLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicense
along*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,
Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"i
f.h"#include"command.h"#include"prefix.h"#include"table.h"#include"thread.h"#inc
lude"memory.h"#include"log.h"#include"stream.h"#include"filter.h"#include"sockun
ion.h"#include"sockopt.h"#include"routemap.h"#include"if_rmap.h"#include"plist.h
"#include"distribute.h"#include"md5.h"#include"keychain.h"#include"privs.h"#incl
ude"vrf.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#include"eigr
pd/eigrp_const.h"#include"eigrpd/eigrp_filter.h"#include"eigrpd/eigrp_packet.h"#
include"eigrpd/eigrp_memory.h"/**Distribute-listupdatefunctions.*/voideigrp_dist
ribute_update(structdistribute*dist){structinterface*ifp;structeigrp_interface*e
i=NULL;structaccess_list*alist;structprefix_list*plist;//structroute_map*routema
p;structeigrp*e;/*ifnointerfaceaddressispresent,setlisttoeigrpprocessstruct*/e=e
igrp_lookup();/*Checkifdistribute-listwassetforprocessorinterface*/if(!dist->ifn
ame){/*accesslistINforwholeprocess*/if(dist->list[DISTRIBUTE_V4_IN]){alist=acces
s_list_lookup(AFI_IP,dist->list[DISTRIBUTE_V4_IN]);if(alist)e->list[EIGRP_FILTER
_IN]=alist;elsee->list[EIGRP_FILTER_IN]=NULL;}else{e->list[EIGRP_FILTER_IN]=NULL
;}/*accesslistOUTforwholeprocess*/if(dist->list[DISTRIBUTE_V4_OUT]){alist=access
_list_lookup(AFI_IP,dist->list[DISTRIBUTE_V4_OUT]);if(alist)e->list[EIGRP_FILTER
_OUT]=alist;elsee->list[EIGRP_FILTER_OUT]=NULL;}else{e->list[EIGRP_FILTER_OUT]=N
ULL;}/*PREFIX_LISTINforprocess*/if(dist->prefix[DISTRIBUTE_V4_IN]){plist=prefix_
list_lookup(AFI_IP,dist->prefix[DISTRIBUTE_V4_IN]);if(plist){e->prefix[EIGRP_FIL
TER_IN]=plist;}elsee->prefix[EIGRP_FILTER_IN]=NULL;}elsee->prefix[EIGRP_FILTER_I
N]=NULL;/*PREFIX_LISTOUTforprocess*/if(dist->prefix[DISTRIBUTE_V4_OUT]){plist=pr
efix_list_lookup(AFI_IP,dist->prefix[DISTRIBUTE_V4_OUT]);if(plist){e->prefix[EIG
RP_FILTER_OUT]=plist;}elsee->prefix[EIGRP_FILTER_OUT]=NULL;}elsee->prefix[EIGRP_
FILTER_OUT]=NULL;//Thisiscommentedout,becausethedistribute.[ch]code//changeslook
edpoorlywrittenfromfirstglance//commitwas133bdf2d//TODO:DBS#if0/*route-mapINforw
holeprocess*/if(dist->route[DISTRIBUTE_V4_IN]){routemap=route_map_lookup_by_name
(dist->route[DISTRIBUTE_V4_IN]);if(routemap)e->routemap[EIGRP_FILTER_IN]=routema
p;elsee->routemap[EIGRP_FILTER_IN]=NULL;}else{e->routemap[EIGRP_FILTER_IN]=NULL;
}/*route-mapOUTforwholeprocess*/if(dist->route[DISTRIBUTE_V4_OUT]){routemap=rout
e_map_lookup_by_name(dist->route[DISTRIBUTE_V4_OUT]);if(routemap)e->routemap[EIG
RP_FILTER_OUT]=routemap;elsee->routemap[EIGRP_FILTER_OUT]=NULL;}else{e->routemap
[EIGRP_FILTER_OUT]=NULL;}#endif//TODO:checkGracefulrestartafter10sec/*checkifthe
reisalreadyGRscheduled*/if(e->t_distribute!=NULL){/*ifis,cancelschedule*/thread_
cancel(e->t_distribute);}/*scheduleGracefulrestartforwholeprocessin10sec*/e->t_d
istribute=NULL;thread_add_timer(master,eigrp_distribute_timer_process,e,(10),&e-
>t_distribute);return;}ifp=if_lookup_by_name(dist->ifname,VRF_DEFAULT);if(ifp==N
ULL)return;/*structeigrp_if_info*info=ifp->info;ei=info->eigrp_interface;*/struc
tlistnode*node,*nnode;structeigrp_interface*ei2;/*Findproperinterface*/for(ALL_L
IST_ELEMENTS(e->eiflist,node,nnode,ei2)){if(strcmp(ei2->ifp->name,ifp->name)==0)
{ei=ei2;break;}}assert(ei!=NULL);/*Access-listforinterfacein*/if(dist->list[DIST
RIBUTE_V4_IN]){alist=access_list_lookup(AFI_IP,dist->list[DISTRIBUTE_V4_IN]);if(
alist){ei->list[EIGRP_FILTER_IN]=alist;}elseei->list[EIGRP_FILTER_IN]=NULL;}else
{ei->list[EIGRP_FILTER_IN]=NULL;}/*Access-listforinterfacein*/if(dist->list[DIST
RIBUTE_V4_OUT]){alist=access_list_lookup(AFI_IP,dist->list[DISTRIBUTE_V4_OUT]);i
f(alist)ei->list[EIGRP_FILTER_OUT]=alist;elseei->list[EIGRP_FILTER_OUT]=NULL;}el
seei->list[EIGRP_FILTER_OUT]=NULL;/*Prefix-listforinterfacein*/if(dist->prefix[D
ISTRIBUTE_V4_IN]){plist=prefix_list_lookup(AFI_IP,dist->prefix[DISTRIBUTE_V4_IN]
);if(plist)ei->prefix[EIGRP_FILTER_IN]=plist;elseei->prefix[EIGRP_FILTER_IN]=NUL
L;}elseei->prefix[EIGRP_FILTER_IN]=NULL;/*Prefix-listforinterfaceout*/if(dist->p
refix[DISTRIBUTE_V4_OUT]){plist=prefix_list_lookup(AFI_IP,dist->prefix[DISTRIBUT
E_V4_OUT]);if(plist)ei->prefix[EIGRP_FILTER_OUT]=plist;elseei->prefix[EIGRP_FILT
ER_OUT]=NULL;}elseei->prefix[EIGRP_FILTER_OUT]=NULL;#if0/*route-mapINforwholepro
cess*/if(dist->route[DISTRIBUTE_V4_IN]){zlog_info("<DEBUGACLALLin");routemap=rou
te_map_lookup_by_name(dist->route[DISTRIBUTE_V4_IN]);if(routemap)ei->routemap[EI
GRP_FILTER_IN]=routemap;elseei->routemap[EIGRP_FILTER_IN]=NULL;}else{ei->routema
p[EIGRP_FILTER_IN]=NULL;}/*route-mapOUTforwholeprocess*/if(dist->route[DISTRIBUT
E_V4_OUT]){routemap=route_map_lookup_by_name(dist->route[DISTRIBUTE_V4_OUT]);if(
routemap)ei->routemap[EIGRP_FILTER_OUT]=routemap;elseei->routemap[EIGRP_FILTER_O
UT]=NULL;}else{ei->routemap[EIGRP_FILTER_OUT]=NULL;}#endif//TODO:checkGracefulre
startafter10sec/*checkifthereisalreadyGRscheduled*/if(ei->t_distribute!=NULL){/*
ifis,cancelschedule*/thread_cancel(ei->t_distribute);}/*scheduleGracefulrestartf
orinterfacein10sec*/e->t_distribute=NULL;thread_add_timer(master,eigrp_distribut
e_timer_interface,ei,10,&e->t_distribute);}/**Functioncalledbyprefix-listandacce
ss-listupdate*/voideigrp_distribute_update_interface(structinterface*ifp){struct
distribute*dist;dist=distribute_lookup(ifp->name);if(dist)eigrp_distribute_updat
e(dist);}/*Updateallinterface'sdistributelist.*Functionusedinhookforprefix-list*
/voideigrp_distribute_update_all(structprefix_list*notused){structvrf*vrf=vrf_lo
okup_by_id(VRF_DEFAULT);structinterface*ifp;FOR_ALL_INTERFACES(vrf,ifp)eigrp_dis
tribute_update_interface(ifp);}/**Functionusedinhookforacces-list*/voideigrp_dis
tribute_update_all_wrapper(structaccess_list*notused){eigrp_distribute_update_al
l(NULL);}/**@fneigrp_distribute_timer_process**@param[in]threadcurrentexecutiont
hreadtimerisassociatedwith**@returnintalwaysreturns0**@par*Calledwhen10secwaitin
gtimeexpireand*executesGracefulrestartforwholeprocess*/inteigrp_distribute_timer
_process(structthread*thread){structeigrp*eigrp;eigrp=THREAD_ARG(thread);eigrp->
t_distribute=NULL;/*executeGRforwholeprocess*/eigrp_update_send_process_GR(eigrp
,EIGRP_GR_FILTER,NULL);return0;}/**@fneigrp_distribute_timer_interface**@param[i
n]threadcurrentexecutionthreadtimerisassociatedwith**@returnintalwaysreturns0**@
par*Calledwhen10secwaitingtimeexpireand*executesGracefulrestartforinterface*/int
eigrp_distribute_timer_interface(structthread*thread){structeigrp_interface*ei;e
i=THREAD_ARG(thread);ei->t_distribute=NULL;/*executeGRforinterface*/eigrp_update
_send_interface_GR(ei,EIGRP_GR_FILTER,NULL);return0;}