/**EIGRPSendingandReceivingEIGRPUpdatePackets.*Copyright(C)2013-2016*Authors:*Do
nnieSavage*JanJanovic*MatejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvor
kovy*MartinKontsek*LukasKoribsky**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"thread.h"#include"memory.h"#include"linklist.h"#include"pref
ix.h"#include"if.h"#include"table.h"#include"sockunion.h"#include"stream.h"#incl
ude"log.h"#include"sockopt.h"#include"checksum.h"#include"md5.h"#include"vty.h"#
include"plist.h"#include"plist_int.h"#include"routemap.h"#include"vty.h"#include
"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#include"eigrpd/eigrp_interface
.h"#include"eigrpd/eigrp_neighbor.h"#include"eigrpd/eigrp_packet.h"#include"eigr
pd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"#include"eigrpd/eigrp_dump.h"#inclu
de"eigrpd/eigrp_macros.h"#include"eigrpd/eigrp_topology.h"#include"eigrpd/eigrp_
fsm.h"#include"eigrpd/eigrp_network.h"#include"eigrpd/eigrp_memory.h"booleigrp_u
pdate_prefix_apply(structeigrp*eigrp,structeigrp_interface*ei,intin,structprefix
*prefix){structaccess_list*alist;structprefix_list*plist;alist=eigrp->list[in];i
f(alist&&access_list_apply(alist,prefix)==FILTER_DENY)returntrue;plist=eigrp->pr
efix[in];if(plist&&prefix_list_apply(plist,prefix)==PREFIX_DENY)returntrue;alist
=ei->list[in];if(alist&&access_list_apply(alist,prefix)==FILTER_DENY)returntrue;
plist=ei->prefix[in];if(plist&&prefix_list_apply(plist,prefix)==PREFIX_DENY)retu
rntrue;returnfalse;}/***@fnremove_received_prefix_gr**@param[in]nbr_prefixesList
ofneighborprefixes*@param[in]recv_prefixPrefixwhichneedstoberemovedfrom*list**@r
eturnvoid**@par*Functionisusedforremovingreceivedprefix*fromlistofneighborprefix
es*/staticvoidremove_received_prefix_gr(structlist*nbr_prefixes,structeigrp_pref
ix_entry*recv_prefix){structlistnode*node1,*node11;structeigrp_prefix_entry*pref
ix=NULL;/*iterateoverallprefixesinlist*/for(ALL_LIST_ELEMENTS(nbr_prefixes,node1
,node11,prefix)){/*removeprefixfromlistiffound*/if(prefix==recv_prefix){listnode
_delete(nbr_prefixes,prefix);}}}/***@fneigrp_update_receive_GR_ask**@param[in]ei
grpEIGRPprocess*@param[in]nbrNeighborupdateofwhowe*received*@param[in]nbr_prefix
esPrefixeswhichweren'tadvertised**@returnvoid**@par*FunctionisusedfornotifyingFS
Maboutprefixeswhich*weren'tadvertisedbyneighbor:*WewillsendmessagetoFSMwithprefi
xdelaysettoinfinity.*/staticvoideigrp_update_receive_GR_ask(structeigrp*eigrp,st
ructeigrp_neighbor*nbr,structlist*nbr_prefixes){structlistnode*node1;structeigrp
_prefix_entry*prefix;structeigrp_fsm_action_messagefsm_msg;/*iterateoverallprefi
xeswhichweren'tadvertisedbyneighbor*/for(ALL_LIST_ELEMENTS_RO(nbr_prefixes,node1
,prefix)){charbuffer[PREFIX_STRLEN];zlog_debug("GRreceive:Neighbornotadvertised%
s",prefix2str(prefix->destination,buffer,PREFIX_STRLEN));fsm_msg.metrics=prefix-
>reported_metric;/*setdelaytoMAX*/fsm_msg.metrics.delay=EIGRP_MAX_METRIC;structe
igrp_nexthop_entry*entry=eigrp_prefix_entry_lookup(prefix->entries,nbr);fsm_msg.
packet_type=EIGRP_OPC_UPDATE;fsm_msg.eigrp=eigrp;fsm_msg.data_type=EIGRP_INT;fsm
_msg.adv_router=nbr;fsm_msg.entry=entry;fsm_msg.prefix=prefix;/*sendmessagetoFSM
*/eigrp_fsm_event(&fsm_msg);}}/**EIGRPUPDATEreadfunction*/voideigrp_update_recei
ve(structeigrp*eigrp,structip*iph,structeigrp_header*eigrph,structstream*s,struc
teigrp_interface*ei,intsize){structeigrp_neighbor*nbr;structTLV_IPv4_Internal_ty
pe*tlv;structeigrp_prefix_entry*pe;structeigrp_nexthop_entry*ne;uint32_tflags;ui
nt16_ttype;uint16_tlength;uint8_tsame;structprefixdest_addr;uint8_tgraceful_rest
art;uint8_tgraceful_restart_final;structlist*nbr_prefixes=NULL;/*incrementstatis
tics.*/ei->update_in++;/*getneighborstruct*/nbr=eigrp_nbr_get(ei,eigrph,iph);/*n
eighbormustbevalid,eigrp_nbr_getcreatesifnoneexisted*/assert(nbr);flags=ntohl(ei
grph->flags);if(flags&EIGRP_CR_FLAG){return;}same=0;graceful_restart=0;graceful_
restart_final=0;if((nbr->recv_sequence_number)==(ntohl(eigrph->sequence)))same=1
;nbr->recv_sequence_number=ntohl(eigrph->sequence);if(IS_DEBUG_EIGRP_PACKET(0,RE
CV))zlog_debug("ProcessingUpdatesize[%u]int(%s)nbr(%s)seq[%u]flags[%0x]",size,if
index2ifname(nbr->ei->ifp->ifindex,VRF_DEFAULT),inet_ntoa(nbr->src),nbr->recv_se
quence_number,flags);if((flags==(EIGRP_INIT_FLAG+EIGRP_RS_FLAG+EIGRP_EOT_FLAG))&
&(!same)){/*GracefulrestartUpdatereceivedwithallroutes*/zlog_info("Neighbor%s(%s
)isresync:peergraceful-restart",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp-
>ifindex,VRF_DEFAULT));/*getallprefixesfromneighborfromtopologytable*/nbr_prefix
es=eigrp_neighbor_prefixes_lookup(eigrp,nbr);graceful_restart=1;graceful_restart
_final=1;}elseif((flags==(EIGRP_INIT_FLAG+EIGRP_RS_FLAG))&&(!same)){/*Gracefulre
startUpdatereceived,routesalsoinnextpacket*/zlog_info("Neighbor%s(%s)isresync:pe
ergraceful-restart",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp->ifindex,VRF
_DEFAULT));/*getallprefixesfromneighborfromtopologytable*/nbr_prefixes=eigrp_nei
ghbor_prefixes_lookup(eigrp,nbr);/*saveprefixestoneighborforlateruse*/nbr->nbr_g
r_prefixes=nbr_prefixes;graceful_restart=1;graceful_restart_final=0;}elseif((fla
gs==(EIGRP_EOT_FLAG))&&(!same)){/*IftherewasINIT+RSUpdatepacketbefore,*considert
hisasGREOT*/if(nbr->nbr_gr_prefixes!=NULL){/*thisisfinalpacketofGR*/nbr_prefixes
=nbr->nbr_gr_prefixes;nbr->nbr_gr_prefixes=NULL;graceful_restart=1;graceful_rest
art_final=1;}}elseif((flags==(0))&&(!same)){/*IftherewasINIT+RSUpdatepacketbefor
e,*considerthisasGRnotfinalpacket*/if(nbr->nbr_gr_prefixes!=NULL){/*thisisGRnotf
inalroutepacket*/nbr_prefixes=nbr->nbr_gr_prefixes;graceful_restart=1;graceful_r
estart_final=0;}}elseif((flags&EIGRP_INIT_FLAG)&&(!same)){/*Wheninpendingstate,s
endINITupdateonlyifitwasn'talreadysentbefore(onlyifinit_sequenceis0)*/if((nbr->s
tate==EIGRP_NEIGHBOR_PENDING)&&(nbr->init_sequence_number==0))eigrp_update_send_
init(nbr);if(nbr->state==EIGRP_NEIGHBOR_UP){eigrp_nbr_state_set(nbr,EIGRP_NEIGHB
OR_DOWN);eigrp_topology_neighbor_down(nbr->ei->eigrp,nbr);nbr->recv_sequence_num
ber=ntohl(eigrph->sequence);zlog_info("Neighbor%s(%s)isdown:peerrestarted",inet_
ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp->ifindex,VRF_DEFAULT));eigrp_nbr_stat
e_set(nbr,EIGRP_NEIGHBOR_PENDING);zlog_info("Neighbor%s(%s)ispending:newadjacenc
y",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp->ifindex,VRF_DEFAULT));eigrp_
update_send_init(nbr);}}/*Ifthereistopologyinformation*/while(s->endp>s->getp){t
ype=stream_getw(s);switch(type){caseEIGRP_TLV_IPv4_INT:stream_set_getp(s,s->getp
-sizeof(uint16_t));tlv=eigrp_read_ipv4_tlv(s);/*searchingifdestinationexists*/de
st_addr.family=AF_INET;dest_addr.u.prefix4=tlv->destination;dest_addr.prefixlen=
tlv->prefix_length;structeigrp_prefix_entry*dest=eigrp_topology_table_lookup_ipv
4(eigrp->topology_table,&dest_addr);/*ifexistsitcomestoDUAL*/if(dest!=NULL){/*re
movereceivedprefixfromneighborprefix*listifinGR*/if(graceful_restart)remove_rece
ived_prefix_gr(nbr_prefixes,dest);structeigrp_fsm_action_messagemsg;structeigrp_
nexthop_entry*entry=eigrp_prefix_entry_lookup(dest->entries,nbr);msg.packet_type
=EIGRP_OPC_UPDATE;msg.eigrp=eigrp;msg.data_type=EIGRP_INT;msg.adv_router=nbr;msg
.metrics=tlv->metric;msg.entry=entry;msg.prefix=dest;eigrp_fsm_event(&msg);}else
{/*Herecomestopologyinformationsave*/pe=eigrp_prefix_entry_new();pe->serno=eigrp
->serno;pe->destination=(structprefix*)prefix_ipv4_new();prefix_copy(pe->destina
tion,&dest_addr);pe->af=AF_INET;pe->state=EIGRP_FSM_STATE_PASSIVE;pe->nt=EIGRP_T
OPOLOGY_TYPE_REMOTE;ne=eigrp_nexthop_entry_new();ne->ei=ei;ne->adv_router=nbr;ne
->reported_metric=tlv->metric;ne->reported_distance=eigrp_calculate_metrics(eigr
p,tlv->metric);/**Filtering*/if(eigrp_update_prefix_apply(eigrp,ei,EIGRP_FILTER_
IN,&dest_addr))ne->reported_metric.delay=EIGRP_MAX_METRIC;ne->distance=eigrp_cal
culate_total_metrics(eigrp,ne);pe->fdistance=pe->distance=pe->rdistance=ne->dist
ance;ne->prefix=pe;ne->flags=EIGRP_NEXTHOP_ENTRY_SUCCESSOR_FLAG;eigrp_prefix_ent
ry_add(eigrp->topology_table,pe);eigrp_nexthop_entry_add(pe,ne);pe->distance=pe-
>fdistance=pe->rdistance=ne->distance;pe->reported_metric=ne->total_metric;eigrp
_topology_update_node_flags(pe);pe->req_action|=EIGRP_FSM_NEED_UPDATE;listnode_a
dd(eigrp->topology_changes_internalIPV4,pe);}eigrp_IPv4_InternalTLV_free(tlv);br
eak;caseEIGRP_TLV_IPv4_EXT:/*DVS:processingofexternalroutesneedspacketandfsmwork
.*fornow,letsjustnotcreashthebox*/default:length=stream_getw(s);//-2fortype,-2fo
rlenfor(length-=4;length;length--){(void)stream_getc(s);}}}/*askaboutprefixesnot
presentinGRupdate,*ifthisisfinalGRpacket*/if(graceful_restart_final){eigrp_updat
e_receive_GR_ask(eigrp,nbr,nbr_prefixes);}/**Wedon'tneedtosendseparateAckforINIT
Update.INITwillbe*ackedinEOTUpdate.*/if((nbr->state==EIGRP_NEIGHBOR_UP)&&!(flags
==EIGRP_INIT_FLAG)){eigrp_hello_send_ack(nbr);}eigrp_query_send_all(eigrp);eigrp
_update_send_all(eigrp,ei);if(nbr_prefixes)list_delete_and_null(&nbr_prefixes);}
/*sendEIGRPUpdatepacket*/voideigrp_update_send_init(structeigrp_neighbor*nbr){st
ructeigrp_packet*ep;uint16_tlength=EIGRP_HEADER_LEN;ep=eigrp_packet_new(nbr->ei-
>ifp->mtu,nbr);/*PrepareEIGRPINITUPDATEheader*/if(IS_DEBUG_EIGRP_PACKET(0,RECV))
zlog_debug("EnqueuingUpdateInitSeq[%u]Ack[%u]",nbr->ei->eigrp->sequence_number,n
br->recv_sequence_number);eigrp_packet_header_init(EIGRP_OPC_UPDATE,nbr->ei->eig
rp,ep->s,EIGRP_INIT_FLAG,nbr->ei->eigrp->sequence_number,nbr->recv_sequence_numb
er);//encodeAuthenticationTLV,ifneededif((nbr->ei->params.auth_type==EIGRP_AUTH_
TYPE_MD5)&&(nbr->ei->params.auth_keychain!=NULL)){length+=eigrp_add_authTLV_MD5_
to_stream(ep->s,nbr->ei);eigrp_make_md5_digest(nbr->ei,ep->s,EIGRP_AUTH_UPDATE_I
NIT_FLAG);}/*EIGRPChecksum*/eigrp_packet_checksum(nbr->ei,ep->s,length);ep->leng
th=length;ep->dst.s_addr=nbr->src.s_addr;/*Thisacknumberweawaitfromneighbor*/nbr
->init_sequence_number=nbr->ei->eigrp->sequence_number;ep->sequence_number=nbr->
ei->eigrp->sequence_number;if(IS_DEBUG_EIGRP_PACKET(0,RECV))zlog_debug("Enqueuin
gUpdateInitLen[%u]Seq[%u]Dest[%s]",ep->length,ep->sequence_number,inet_ntoa(ep->
dst));/*Putpackettoretransmissionqueue*/eigrp_fifo_push(nbr->retrans_queue,ep);i
f(nbr->retrans_queue->count==1){eigrp_send_packet_reliably(nbr);}}staticvoideigr
p_update_place_on_nbr_queue(structeigrp_neighbor*nbr,structeigrp_packet*ep,uint3
2_tseq_no,intlength){if((nbr->ei->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(nbr->
ei->params.auth_keychain!=NULL)){eigrp_make_md5_digest(nbr->ei,ep->s,EIGRP_AUTH_
UPDATE_FLAG);}/*EIGRPChecksum*/eigrp_packet_checksum(nbr->ei,ep->s,length);ep->l
ength=length;ep->dst.s_addr=nbr->src.s_addr;/*Thisacknumberweawaitfromneighbor*/
ep->sequence_number=seq_no;if(IS_DEBUG_EIGRP_PACKET(0,RECV))zlog_debug("Enqueuin
gUpdateInitLen[%u]Seq[%u]Dest[%s]",ep->length,ep->sequence_number,inet_ntoa(ep->
dst));/*Putpackettoretransmissionqueue*/eigrp_fifo_push(nbr->retrans_queue,ep);i
f(nbr->retrans_queue->count==1)eigrp_send_packet_reliably(nbr);}staticvoideigrp_
update_send_to_all_nbrs(structeigrp_interface*ei,structeigrp_packet*ep){structli
stnode*node,*nnode;structeigrp_neighbor*nbr;boolpacket_sent=false;for(ALL_LIST_E
LEMENTS(ei->nbrs,node,nnode,nbr)){structeigrp_packet*ep_dup;if(nbr->state!=EIGRP
_NEIGHBOR_UP)continue;if(packet_sent)ep_dup=eigrp_packet_duplicate(ep,NULL);else
ep_dup=ep;ep_dup->nbr=nbr;packet_sent=true;/*Putpackettoretransmissionqueue*/eig
rp_fifo_push(nbr->retrans_queue,ep_dup);if(nbr->retrans_queue->count==1){eigrp_s
end_packet_reliably(nbr);}}if(!packet_sent)eigrp_packet_free(ep);}voideigrp_upda
te_send_EOT(structeigrp_neighbor*nbr){structeigrp_packet*ep;uint16_tlength=EIGRP
_HEADER_LEN;structeigrp_nexthop_entry*te;structeigrp_prefix_entry*pe;structlistn
ode*node2,*nnode2;structeigrp_interface*ei=nbr->ei;structeigrp*eigrp=ei->eigrp;s
tructprefix*dest_addr;uint32_tseq_no=eigrp->sequence_number;uint16_tmtu=ei->ifp-
>mtu;structroute_node*rn;ep=eigrp_packet_new(mtu,nbr);/*PrepareEIGRPEOTUPDATEhea
der*/eigrp_packet_header_init(EIGRP_OPC_UPDATE,eigrp,ep->s,EIGRP_EOT_FLAG,seq_no
,nbr->recv_sequence_number);//encodeAuthenticationTLV,ifneededif((ei->params.aut
h_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL)){length+=eigrp_ad
d_authTLV_MD5_to_stream(ep->s,ei);}for(rn=route_top(eigrp->topology_table);rn;rn
=route_next(rn)){if(!rn->info)continue;pe=rn->info;for(ALL_LIST_ELEMENTS(pe->ent
ries,node2,nnode2,te)){if(eigrp_nbr_split_horizon_check(te,ei))continue;if((leng
th+EIGRP_TLV_MAX_IPV4_BYTE)>mtu){eigrp_update_place_on_nbr_queue(nbr,ep,seq_no,l
ength);seq_no++;length=EIGRP_HEADER_LEN;ep=eigrp_packet_new(mtu,nbr);eigrp_packe
t_header_init(EIGRP_OPC_UPDATE,nbr->ei->eigrp,ep->s,EIGRP_EOT_FLAG,seq_no,nbr->r
ecv_sequence_number);if((ei->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params
.auth_keychain!=NULL)){length+=eigrp_add_authTLV_MD5_to_stream(ep->s,ei);}}/*Get
destinationaddressfromprefix*/dest_addr=pe->destination;/*Checkifanylistfits*/if
(eigrp_update_prefix_apply(eigrp,ei,EIGRP_FILTER_OUT,dest_addr))continue;else{le
ngth+=eigrp_add_internalTLV_to_stream(ep->s,pe);}}}eigrp_update_place_on_nbr_que
ue(nbr,ep,seq_no,length);eigrp->sequence_number=seq_no++;}voideigrp_update_send(
structeigrp_interface*ei){structeigrp_packet*ep;structlistnode*node,*nnode;struc
teigrp_prefix_entry*pe;uint8_thas_tlv;structeigrp*eigrp=ei->eigrp;structprefix*d
est_addr;uint32_tseq_no=eigrp->sequence_number;if(ei->nbrs->count==0)return;uint
16_tlength=EIGRP_HEADER_LEN;ep=eigrp_packet_new(ei->ifp->mtu,NULL);/*PrepareEIGR
PINITUPDATEheader*/eigrp_packet_header_init(EIGRP_OPC_UPDATE,eigrp,ep->s,0,seq_n
o,0);//encodeAuthenticationTLV,ifneededif((ei->params.auth_type==EIGRP_AUTH_TYPE
_MD5)&&(ei->params.auth_keychain!=NULL)){length+=eigrp_add_authTLV_MD5_to_stream
(ep->s,ei);}has_tlv=0;for(ALL_LIST_ELEMENTS(ei->eigrp->topology_changes_internal
IPV4,node,nnode,pe)){structeigrp_nexthop_entry*ne;if(!(pe->req_action&EIGRP_FSM_
NEED_UPDATE))continue;ne=listnode_head(pe->entries);if(eigrp_nbr_split_horizon_c
heck(ne,ei))continue;if((length+EIGRP_TLV_MAX_IPV4_BYTE)>(uint16_t)ei->ifp->mtu)
{if((ei->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL
)){eigrp_make_md5_digest(ei,ep->s,EIGRP_AUTH_UPDATE_FLAG);}eigrp_packet_checksum
(ei,ep->s,length);ep->length=length;ep->dst.s_addr=htonl(EIGRP_MULTICAST_ADDRESS
);ep->sequence_number=seq_no;seq_no++;eigrp_update_send_to_all_nbrs(ei,ep);lengt
h=EIGRP_HEADER_LEN;ep=eigrp_packet_new(ei->ifp->mtu,NULL);eigrp_packet_header_in
it(EIGRP_OPC_UPDATE,eigrp,ep->s,0,seq_no,0);if((ei->params.auth_type==EIGRP_AUTH
_TYPE_MD5)&&(ei->params.auth_keychain!=NULL)){length+=eigrp_add_authTLV_MD5_to_s
tream(ep->s,ei);}has_tlv=0;}/*Getdestinationaddressfromprefix*/dest_addr=pe->des
tination;if(eigrp_update_prefix_apply(eigrp,ei,EIGRP_FILTER_OUT,dest_addr)){//pe
->reported_metric.delay=EIGRP_MAX_METRIC;continue;}else{length+=eigrp_add_intern
alTLV_to_stream(ep->s,pe);has_tlv=1;}}if(!has_tlv){eigrp_packet_free(ep);return;
}if((ei->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL
)){eigrp_make_md5_digest(ei,ep->s,EIGRP_AUTH_UPDATE_FLAG);}/*EIGRPChecksum*/eigr
p_packet_checksum(ei,ep->s,length);ep->length=length;ep->dst.s_addr=htonl(EIGRP_
MULTICAST_ADDRESS);/*Thisacknumberweawaitfromneighbor*/ep->sequence_number=eigrp
->sequence_number;if(IS_DEBUG_EIGRP_PACKET(0,RECV))zlog_debug("EnqueuingUpdatele
ngth[%u]Seq[%u]",length,ep->sequence_number);eigrp_update_send_to_all_nbrs(ei,ep
);ei->eigrp->sequence_number=seq_no++;}voideigrp_update_send_all(structeigrp*eig
rp,structeigrp_interface*exception){structeigrp_interface*iface;structlistnode*n
ode,*node2,*nnode2;structeigrp_prefix_entry*pe;for(ALL_LIST_ELEMENTS_RO(eigrp->e
iflist,node,iface)){if(iface!=exception){eigrp_update_send(iface);}}for(ALL_LIST
_ELEMENTS(eigrp->topology_changes_internalIPV4,node2,nnode2,pe)){if(pe->req_acti
on&EIGRP_FSM_NEED_UPDATE){pe->req_action&=~EIGRP_FSM_NEED_UPDATE;listnode_delete
(eigrp->topology_changes_internalIPV4,pe);}}}/***@fneigrp_update_send_GR_part**@
param[in]nbrcontainsneighborwhowouldreceive*Graceful*restart**@returnvoid**@par*
FunctionusedforsendingGracefulrestartUpdatepacket*andiftherearemultiplechunks,se
ndonlyoneofthem.*Itiscalledfromthread.Donotcallitdirectly.**Usesnbr_gr_packet_ty
pefromneighbor.*/staticvoideigrp_update_send_GR_part(structeigrp_neighbor*nbr){s
tructeigrp_packet*ep;uint16_tlength=EIGRP_HEADER_LEN;structeigrp_prefix_entry*pe
;structprefix*dest_addr;structeigrp_interface*ei=nbr->ei;structeigrp*eigrp=ei->e
igrp;structlist*prefixes;uint32_tflags;unsignedintsend_prefixes;structroute_node
*rn;/*getprefixestosendtoneighbor*/prefixes=nbr->nbr_gr_prefixes_send;send_prefi
xes=0;length=EIGRP_HEADER_LEN;/*iftherealreadywerelastpacketchunk,wewon'tcontinu
e*/if(nbr->nbr_gr_packet_type==EIGRP_PACKET_PART_LAST)return;/*ifthisisfirstpack
etchunk,weneedtodecide,*iftherewillbeoneormorechunks*/if(nbr->nbr_gr_packet_type
==EIGRP_PACKET_PART_FIRST){if(prefixes->count<=EIGRP_TLV_MAX_IPv4){/*therewillbe
onlyonechunk*/flags=EIGRP_INIT_FLAG+EIGRP_RS_FLAG+EIGRP_EOT_FLAG;nbr->nbr_gr_pac
ket_type=EIGRP_PACKET_PART_LAST;}else{/*therewillbemorechunks*/flags=EIGRP_INIT_
FLAG+EIGRP_RS_FLAG;nbr->nbr_gr_packet_type=EIGRP_PACKET_PART_NA;}}else{/*thisisn
otfirstchunk,andweneedtodecide,*iftherewillbemorechunks*/if(prefixes->count<=EIG
RP_TLV_MAX_IPv4){/*thisislastchunk*/flags=EIGRP_EOT_FLAG;nbr->nbr_gr_packet_type
=EIGRP_PACKET_PART_LAST;}else{/*therewillbemorechunks*/flags=0;nbr->nbr_gr_packe
t_type=EIGRP_PACKET_PART_NA;}}ep=eigrp_packet_new(ei->ifp->mtu,nbr);/*PrepareEIG
RPGracefulrestartUPDATEheader*/eigrp_packet_header_init(EIGRP_OPC_UPDATE,eigrp,e
p->s,flags,eigrp->sequence_number,nbr->recv_sequence_number);//encodeAuthenticat
ionTLV,ifneededif((ei->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_
keychain!=NULL)){length+=eigrp_add_authTLV_MD5_to_stream(ep->s,ei);}for(rn=route
_top(eigrp->topology_table);rn;rn=route_next(rn)){if(!rn->info)continue;pe=rn->i
nfo;/**Filtering*/dest_addr=pe->destination;if(eigrp_update_prefix_apply(eigrp,e
i,EIGRP_FILTER_OUT,dest_addr)){/*donotsendfilteredroute*/zlog_info("Filteredpref
ix%swon'tbesentout.",inet_ntoa(dest_addr->u.prefix4));}else{/*sendingroutewhichw
asn'tfiltered*/length+=eigrp_add_internalTLV_to_stream(ep->s,pe);send_prefixes++
;}/**Thismakesnosense,Filteroutthenfilterin???*Lookintothismore-DBS*/if(eigrp_up
date_prefix_apply(eigrp,ei,EIGRP_FILTER_IN,dest_addr)){/*donotsendfilteredroute*
/zlog_info("Filteredprefix%swillberemoved.",inet_ntoa(dest_addr->u.prefix4));/*p
reparemessageforFSM*/structeigrp_fsm_action_messagefsm_msg;structeigrp_nexthop_e
ntry*entry=eigrp_prefix_entry_lookup(pe->entries,nbr);fsm_msg.packet_type=EIGRP_
OPC_UPDATE;fsm_msg.eigrp=eigrp;fsm_msg.data_type=EIGRP_INT;fsm_msg.adv_router=nb
r;fsm_msg.metrics=pe->reported_metric;/*SetdelaytoMAX*/fsm_msg.metrics.delay=EIG
RP_MAX_METRIC;fsm_msg.entry=entry;fsm_msg.prefix=pe;/*sendmessagetoFSM*/eigrp_fs
m_event(&fsm_msg);}/*NULLthepointer*/dest_addr=NULL;/*deleteprocessedprefixfroml
ist*/listnode_delete(prefixes,pe);/*ifthereareenoughprefixes,sendpacket*/if(send
_prefixes>=EIGRP_TLV_MAX_IPv4)break;}/*computeAuthdigest*/if((ei->params.auth_ty
pe==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL)){eigrp_make_md5_diges
t(ei,ep->s,EIGRP_AUTH_UPDATE_FLAG);}/*EIGRPChecksum*/eigrp_packet_checksum(ei,ep
->s,length);ep->length=length;ep->dst.s_addr=nbr->src.s_addr;/*Thisacknumberweaw
aitfromneighbor*/ep->sequence_number=eigrp->sequence_number;if(IS_DEBUG_EIGRP_PA
CKET(0,RECV))zlog_debug("EnqueuingUpdateInitLen[%u]Seq[%u]Dest[%s]",ep->length,e
p->sequence_number,inet_ntoa(ep->dst));/*Putpackettoretransmissionqueue*/eigrp_f
ifo_push(nbr->retrans_queue,ep);if(nbr->retrans_queue->count==1){eigrp_send_pack
et_reliably(nbr);}}/***@fneigrp_update_send_GR_thread**@param[in]threadcontainsn
eighborwhowouldreceive*Gracefulrestart**@returnintalways0**@par*Functionusedfors
endingGracefulrestartUpdatepacket*inthread,itispreparedformultiplechunksofpacket
.**Usesnbr_gr_packet_typeandt_nbr_send_grfromneighbor.*/inteigrp_update_send_GR_
thread(structthread*thread){structeigrp_neighbor*nbr;/*getargumentfromthread*/nb
r=THREAD_ARG(thread);/*removethisthreadpointer*/nbr->t_nbr_send_gr=NULL;/*ifther
eispacketwaitinginqueue,*schedulethisthreadagainwithsmalldelay*/if(nbr->retrans_
queue->count>0){nbr->t_nbr_send_gr=NULL;thread_add_timer_msec(master,eigrp_updat
e_send_GR_thread,nbr,10,&nbr->t_nbr_send_gr);return0;}/*sendGREIGRPpacketchunk*/
eigrp_update_send_GR_part(nbr);/*ifitwasn'tlastchunk,schedulethisthreadagain*/if
(nbr->nbr_gr_packet_type!=EIGRP_PACKET_PART_LAST){thread_execute(master,eigrp_up
date_send_GR_thread,nbr,0);nbr->t_nbr_send_gr=NULL;}return0;}/***@fneigrp_update
_send_GR**@param[in]nbrNeighborwhowouldreceive*Graceful*restart*@param[in]gr_typ
eWhoexecutedGracefulrestart*@param[in]vtyVirtualterminalforlogoutput**@returnvoi
d**@par*FunctionusedforsendingGracefulrestartUpdatepacket:*CreatesUpdatepacketwi
thINIT,RS,EOTflagsandinclude*allrouteexceptthosefiltered*/voideigrp_update_send_
GR(structeigrp_neighbor*nbr,enumGR_typegr_type,structvty*vty){structeigrp_prefix
_entry*pe2;structlist*prefixes;structroute_node*rn;structeigrp_interface*ei=nbr-
>ei;structeigrp*eigrp=ei->eigrp;if(gr_type==EIGRP_GR_FILTER){/*functionwascalled
afterapplyingfiltration*/zlog_info("Neighbor%s(%s)isresync:routeconfigurationcha
nged",inet_ntoa(nbr->src),ifindex2ifname(ei->ifp->ifindex,VRF_DEFAULT));}elseif(
gr_type==EIGRP_GR_MANUAL){/*Gracefulrestartwascalledmanually*/zlog_info("Neighbo
r%s(%s)isresync:manuallycleared",inet_ntoa(nbr->src),ifindex2ifname(ei->ifp->ifi
ndex,VRF_DEFAULT));if(vty!=NULL){vty_time_print(vty,0);vty_out(vty,"Neighbor%s(%
s)isresync:manuallycleared\n",inet_ntoa(nbr->src),ifindex2ifname(ei->ifp->ifinde
x,VRF_DEFAULT));}}prefixes=list_new();/*addallprefixesfromtopologytabletolist*/f
or(rn=route_top(eigrp->topology_table);rn;rn=route_next(rn)){if(!rn->info)contin
ue;pe2=rn->info;listnode_add(prefixes,pe2);}/*saveprefixestoneighbor*/nbr->nbr_g
r_prefixes_send=prefixes;/*indicate,thatthisisfirstGRUpdatepacketchunk*/nbr->nbr
_gr_packet_type=EIGRP_PACKET_PART_FIRST;/*executepacketsendinginthread*/thread_e
xecute(master,eigrp_update_send_GR_thread,nbr,0);nbr->t_nbr_send_gr=NULL;}/***@f
neigrp_update_send_interface_GR**@param[in]eiInterfacetoneighborsofwhich*the*GR*
issent*@param[in]gr_typeWhoexecutedGracefulrestart*@param[in]vtyVirtualterminalf
orlogoutput**@returnvoid**@par*FunctionusedforsendingGracefulrestartUpdatepacket
*toallneighborsonspecifiedinterface.*/voideigrp_update_send_interface_GR(structe
igrp_interface*ei,enumGR_typegr_type,structvty*vty){structlistnode*node;structei
grp_neighbor*nbr;/*iterateoverallneighborsoneigrpinterface*/for(ALL_LIST_ELEMENT
S_RO(ei->nbrs,node,nbr)){/*sendGRtoneighbor*/eigrp_update_send_GR(nbr,gr_type,vt
y);}}/***@fneigrp_update_send_process_GR**@param[in]eigrpEIGRPprocess*@param[in]
gr_typeWhoexecutedGracefulrestart*@param[in]vtyVirtualterminalforlogoutput**@ret
urnvoid**@par*FunctionusedforsendingGracefulrestartUpdatepacket*toallneighborsin
eigrpprocess.*/voideigrp_update_send_process_GR(structeigrp*eigrp,enumGR_typegr_
type,structvty*vty){structlistnode*node;structeigrp_interface*ei;/*iterateoveral
leigrpinterfaces*/for(ALL_LIST_ELEMENTS_RO(eigrp->eiflist,node,ei)){/*sendGRtoal
lneighborsoninterface*/eigrp_update_send_interface_GR(ei,gr_type,vty);}}