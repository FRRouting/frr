/**EIGRPTopologyTable.*Copyright(C)2013-2016*Authors:*DonnieSavage*JanJanovic*Ma
tejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvorkovy*MartinKontsek*Lukas
Koribsky**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistributeit
and/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*FreeSof
twareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisdist
ributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpliedw
arrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicL
icenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicensealo
ng*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,Inc
.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"pref
ix.h"#include"table.h"#include"memory.h"#include"log.h"#include"linklist.h"#incl
ude"vty.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#include"eigr
pd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"eigrpd/eigrp_pack
et.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"#include"eigrpd/e
igrp_network.h"#include"eigrpd/eigrp_dump.h"#include"eigrpd/eigrp_topology.h"#in
clude"eigrpd/eigrp_fsm.h"#include"eigrpd/eigrp_memory.h"staticinteigrp_nexthop_e
ntry_cmp(structeigrp_nexthop_entry*,structeigrp_nexthop_entry*);/**Returnslinked
listusedastopologytable*cmp-assignedfunctionforcomparingtopologynodes*del-assign
edfunctionexecutedbeforedeletingtopologynodebylist*function*/structroute_table*e
igrp_topology_new(){returnroute_table_init();}/**Returnsnewcreatedtoplogynode*cm
p-assignedfunctionforcomparingtopologyentry*/structeigrp_prefix_entry*eigrp_pref
ix_entry_new(){structeigrp_prefix_entry*new;new=XCALLOC(MTYPE_EIGRP_PREFIX_ENTRY
,sizeof(structeigrp_prefix_entry));new->entries=list_new();new->rij=list_new();n
ew->entries->cmp=(int(*)(void*,void*))eigrp_nexthop_entry_cmp;new->distance=new-
>fdistance=new->rdistance=EIGRP_MAX_METRIC;new->destination=NULL;returnnew;}/**T
opologyentrycomparison*/staticinteigrp_nexthop_entry_cmp(structeigrp_nexthop_ent
ry*entry1,structeigrp_nexthop_entry*entry2){if(entry1->distance<entry2->distance
)return-1;if(entry1->distance>entry2->distance)return1;return0;}/**Returnsnewtop
ologyentry*/structeigrp_nexthop_entry*eigrp_nexthop_entry_new(){structeigrp_next
hop_entry*new;new=XCALLOC(MTYPE_EIGRP_NEXTHOP_ENTRY,sizeof(structeigrp_nexthop_e
ntry));new->reported_distance=EIGRP_MAX_METRIC;new->distance=EIGRP_MAX_METRIC;re
turnnew;}/**Freeingtopologytablelist*/voideigrp_topology_free(structroute_table*
table){route_table_finish(table);}/**Deletingalltopologynodesintable*/voideigrp_
topology_cleanup(structroute_table*table){eigrp_topology_delete_all(table);}/**A
ddingtopologynodetotopologytable*/voideigrp_prefix_entry_add(structroute_table*t
opology,structeigrp_prefix_entry*pe){structroute_node*rn;rn=route_node_get(topol
ogy,pe->destination);if(rn->info){if(IS_DEBUG_EIGRP_EVENT){charbuf[PREFIX_STRLEN
];zlog_debug("%s:%sShouldwehavefoundthisentryinthetopotable?",__PRETTY_FUNCTION_
_,prefix2str(pe->destination,buf,sizeof(buf)));}}rn->info=pe;route_lock_node(rn)
;}/**Addingtopologyentrytotopologynode*/voideigrp_nexthop_entry_add(structeigrp_
prefix_entry*node,structeigrp_nexthop_entry*entry){structlist*l=list_new();listn
ode_add(l,entry);if(listnode_lookup(node->entries,entry)==NULL){listnode_add_sor
t(node->entries,entry);entry->prefix=node;eigrp_zebra_route_add(node->destinatio
n,l);}list_delete_and_null(&l);}/**Deletingtopologynodefromtopologytable*/voidei
grp_prefix_entry_delete(structroute_table*table,structeigrp_prefix_entry*pe){str
ucteigrp*eigrp=eigrp_lookup();structroute_node*rn;rn=route_node_lookup(table,pe-
>destination);if(!rn)return;/**Emergencyremovalofthenodefromthislist.*Whateverit
is.*/listnode_delete(eigrp->topology_changes_internalIPV4,pe);list_delete_and_nu
ll(&pe->entries);list_delete_and_null(&pe->rij);eigrp_zebra_route_delete(pe->des
tination);rn->info=NULL;route_unlock_node(rn);//Lookupaboveroute_unlock_node(rn)
;//InitialcreationXFREE(MTYPE_EIGRP_PREFIX_ENTRY,pe);}/**Deletingtopologyentryfr
omtopologynode*/voideigrp_nexthop_entry_delete(structeigrp_prefix_entry*node,str
ucteigrp_nexthop_entry*entry){if(listnode_lookup(node->entries,entry)!=NULL){lis
tnode_delete(node->entries,entry);eigrp_zebra_route_delete(node->destination);XF
REE(MTYPE_EIGRP_NEXTHOP_ENTRY,entry);}}/**Deletingallnodesfromtopologytable*/voi
deigrp_topology_delete_all(structroute_table*topology){structroute_node*rn;struc
teigrp_prefix_entry*pe;for(rn=route_top(topology);rn;rn=route_next(rn)){pe=rn->i
nfo;if(!pe)continue;eigrp_prefix_entry_delete(topology,pe);}}/**Return0iftopolog
yisnotempty*otherwisereturn1*/unsignedinteigrp_topology_table_isempty(structlist
*topology){if(topology->count)return1;elsereturn0;}structeigrp_prefix_entry*eigr
p_topology_table_lookup_ipv4(structroute_table*table,structprefix*address){struc
teigrp_prefix_entry*pe;structroute_node*rn;rn=route_node_lookup(table,address);i
f(!rn)returnNULL;pe=rn->info;route_unlock_node(rn);returnpe;}/**Forafutureoptimi
zation,putthesuccessorlistintoit's*ownseparatelistfromthefulllist?**Thatwaywecan
cleanupallthelist_newandlist_delete's*thatwearedoing.DBS*/structlist*eigrp_topol
ogy_get_successor(structeigrp_prefix_entry*table_node){structlist*successors=lis
t_new();structeigrp_nexthop_entry*data;structlistnode*node1,*node2;for(ALL_LIST_
ELEMENTS(table_node->entries,node1,node2,data)){if(data->flags&EIGRP_NEXTHOP_ENT
RY_SUCCESSOR_FLAG){listnode_add(successors,data);}}/**Ifwehavenosuccessorsreturn
NULL*/if(!successors->count){list_delete_and_null(&successors);successors=NULL;}
returnsuccessors;}structlist*eigrp_topology_get_successor_max(structeigrp_prefix
_entry*table_node,unsignedintmaxpaths){structlist*successors=eigrp_topology_get_
successor(table_node);if(successors&&successors->count>maxpaths){do{structlistno
de*node=listtail(successors);list_delete_node(successors,node);}while(successors
->count>maxpaths);}returnsuccessors;}structeigrp_nexthop_entry*eigrp_prefix_entr
y_lookup(structlist*entries,structeigrp_neighbor*nbr){structeigrp_nexthop_entry*
data;structlistnode*node,*nnode;for(ALL_LIST_ELEMENTS(entries,node,nnode,data)){
if(data->adv_router==nbr){returndata;}}returnNULL;}/*Lookupallprefixesfromspecif
iedneighbor*/structlist*eigrp_neighbor_prefixes_lookup(structeigrp*eigrp,structe
igrp_neighbor*nbr){structlistnode*node2,*node22;structeigrp_nexthop_entry*entry;
structeigrp_prefix_entry*pe;structroute_node*rn;/*createnewemptylistforprefixess
torage*/structlist*prefixes=list_new();/*iterateoverallprefixesintopologytable*/
for(rn=route_top(eigrp->topology_table);rn;rn=route_next(rn)){if(!rn->info)conti
nue;pe=rn->info;/*iterateoverallneighborentryinprefix*/for(ALL_LIST_ELEMENTS(pe-
>entries,node2,node22,entry)){/*ifentryisfromspecifiedneighbor,addtolist*/if(ent
ry->adv_router==nbr){listnode_add(prefixes,pe);}}}/*returnlistofprefixesfromspec
ifiedneighbor*/returnprefixes;}enummetric_changeeigrp_topology_update_distance(s
tructeigrp_fsm_action_message*msg){structeigrp*eigrp=msg->eigrp;structeigrp_pref
ix_entry*prefix=msg->prefix;structeigrp_nexthop_entry*entry=msg->entry;enummetri
c_changechange=METRIC_SAME;uint32_tnew_reported_distance;assert(entry);switch(ms
g->data_type){caseEIGRP_CONNECTED:if(prefix->nt==EIGRP_TOPOLOGY_TYPE_CONNECTED)r
eturnchange;change=METRIC_DECREASE;break;caseEIGRP_INT:if(prefix->nt==EIGRP_TOPO
LOGY_TYPE_CONNECTED){change=METRIC_INCREASE;gotodistance_done;}if(eigrp_metrics_
is_same(msg->metrics,entry->reported_metric)){returnchange;//Nochange}new_report
ed_distance=eigrp_calculate_metrics(eigrp,msg->metrics);if(entry->reported_dista
nce<new_reported_distance){change=METRIC_INCREASE;gotodistance_done;}elsechange=
METRIC_DECREASE;entry->reported_metric=msg->metrics;entry->reported_distance=new
_reported_distance;eigrp_calculate_metrics(eigrp,msg->metrics);entry->distance=e
igrp_calculate_total_metrics(eigrp,entry);break;caseEIGRP_EXT:if(prefix->nt==EIG
RP_TOPOLOGY_TYPE_REMOTE_EXTERNAL){if(eigrp_metrics_is_same(msg->metrics,entry->r
eported_metric))returnchange;}else{change=METRIC_INCREASE;gotodistance_done;}bre
ak;default:zlog_err("%s:Pleaseimplementhandler",__PRETTY_FUNCTION__);break;}dist
ance_done:/**Movetocorrectpositioninlistaccordingtonewdistance*/listnode_delete(
prefix->entries,entry);listnode_add_sort(prefix->entries,entry);returnchange;}vo
ideigrp_topology_update_all_node_flags(structeigrp*eigrp){structeigrp_prefix_ent
ry*pe;structroute_node*rn;for(rn=route_top(eigrp->topology_table);rn;rn=route_ne
xt(rn)){pe=rn->info;if(!pe)continue;eigrp_topology_update_node_flags(pe);}}voide
igrp_topology_update_node_flags(structeigrp_prefix_entry*dest){structlistnode*no
de;structeigrp_nexthop_entry*entry;structeigrp*eigrp=eigrp_lookup();for(ALL_LIST
_ELEMENTS_RO(dest->entries,node,entry)){if(((uint64_t)entry->distance<=(uint64_t
)dest->distance*(uint64_t)eigrp->variance)&&entry->distance!=EIGRP_MAX_METRIC)//
issuccessor{entry->flags|=EIGRP_NEXTHOP_ENTRY_SUCCESSOR_FLAG;entry->flags&=~EIGR
P_NEXTHOP_ENTRY_FSUCCESSOR_FLAG;}elseif(entry->reported_distance<dest->fdistance
)//isfeasiblesuccessor{entry->flags|=EIGRP_NEXTHOP_ENTRY_FSUCCESSOR_FLAG;entry->
flags&=~EIGRP_NEXTHOP_ENTRY_SUCCESSOR_FLAG;}else{entry->flags&=~EIGRP_NEXTHOP_EN
TRY_FSUCCESSOR_FLAG;entry->flags&=~EIGRP_NEXTHOP_ENTRY_SUCCESSOR_FLAG;}}}voideig
rp_update_routing_table(structeigrp_prefix_entry*prefix){structeigrp*eigrp=eigrp
_lookup();structlist*successors=eigrp_topology_get_successor_max(prefix,eigrp->m
ax_paths);structlistnode*node;structeigrp_nexthop_entry*entry;if(successors){eig
rp_zebra_route_add(prefix->destination,successors);for(ALL_LIST_ELEMENTS_RO(succ
essors,node,entry))entry->flags|=EIGRP_NEXTHOP_ENTRY_INTABLE_FLAG;list_delete_an
d_null(&successors);}else{eigrp_zebra_route_delete(prefix->destination);for(ALL_
LIST_ELEMENTS_RO(prefix->entries,node,entry))entry->flags&=~EIGRP_NEXTHOP_ENTRY_
INTABLE_FLAG;}}voideigrp_topology_neighbor_down(structeigrp*eigrp,structeigrp_ne
ighbor*nbr){structlistnode*node2,*node22;structeigrp_prefix_entry*pe;structeigrp
_nexthop_entry*entry;structroute_node*rn;for(rn=route_top(eigrp->topology_table)
;rn;rn=route_next(rn)){pe=rn->info;if(!pe)continue;for(ALL_LIST_ELEMENTS(pe->ent
ries,node2,node22,entry)){structeigrp_fsm_action_messagemsg;if(entry->adv_router
!=nbr)continue;msg.metrics.delay=EIGRP_MAX_METRIC;msg.packet_type=EIGRP_OPC_UPDA
TE;msg.eigrp=eigrp;msg.data_type=EIGRP_INT;msg.adv_router=nbr;msg.entry=entry;ms
g.prefix=pe;eigrp_fsm_event(&msg);}}eigrp_query_send_all(eigrp);eigrp_update_sen
d_all(eigrp,nbr->ei);}voideigrp_update_topology_table_prefix(structroute_table*t
able,structeigrp_prefix_entry*prefix){structlistnode*node1,*node2;structeigrp_ne
xthop_entry*entry;for(ALL_LIST_ELEMENTS(prefix->entries,node1,node2,entry)){if(e
ntry->distance==EIGRP_MAX_METRIC){eigrp_nexthop_entry_delete(prefix,entry);}}if(
prefix->distance==EIGRP_MAX_METRIC&&prefix->nt!=EIGRP_TOPOLOGY_TYPE_CONNECTED){e
igrp_prefix_entry_delete(table,prefix);}}