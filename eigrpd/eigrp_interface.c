/**EIGRPInterfaceFunctions.*Copyright(C)2013-2016*Authors:*DonnieSavage*JanJanov
ic*MatejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvorkovy*MartinKontsek*
LukasKoribsky**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistrib
uteitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*Fr
eeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebrai
sdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimp
liedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPu
blicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicen
sealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundatio
n,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include
"thread.h"#include"linklist.h"#include"prefix.h"#include"if.h"#include"table.h"#
include"memory.h"#include"command.h"#include"stream.h"#include"log.h"#include"ke
ychain.h"#include"vrf.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h
"#include"eigrpd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"eig
rpd/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"#in
clude"eigrpd/eigrp_network.h"#include"eigrpd/eigrp_topology.h"#include"eigrpd/ei
grp_memory.h"#include"eigrpd/eigrp_fsm.h"structeigrp_interface*eigrp_if_new(stru
cteigrp*eigrp,structinterface*ifp,structprefix*p){structeigrp_interface*ei=ifp->
info;inti;if(ei)returnei;ei=XCALLOC(MTYPE_EIGRP_IF,sizeof(structeigrp_interface)
);/*Setzebrainterfacepointer.*/ei->ifp=ifp;ei->address=p;ifp->info=ei;listnode_a
dd(eigrp->eiflist,ei);ei->type=EIGRP_IFTYPE_BROADCAST;/*Initializeneighborlist.*
/ei->nbrs=list_new();ei->crypt_seqnum=time(NULL);/*Initializelists*/for(i=0;i<EI
GRP_FILTER_MAX;i++){ei->list[i]=NULL;ei->prefix[i]=NULL;ei->routemap[i]=NULL;}ei
->eigrp=eigrp;ei->params.v_hello=EIGRP_HELLO_INTERVAL_DEFAULT;ei->params.v_wait=
EIGRP_HOLD_INTERVAL_DEFAULT;ei->params.bandwidth=EIGRP_BANDWIDTH_DEFAULT;ei->par
ams.delay=EIGRP_DELAY_DEFAULT;ei->params.reliability=EIGRP_RELIABILITY_DEFAULT;e
i->params.load=EIGRP_LOAD_DEFAULT;ei->params.auth_type=EIGRP_AUTH_TYPE_NONE;ei->
params.auth_keychain=NULL;returnei;}inteigrp_if_delete_hook(structinterface*ifp)
{structeigrp_interface*ei=ifp->info;structeigrp*eigrp;if(!ei)return0;list_delete
_and_null(&ei->nbrs);eigrp=ei->eigrp;listnode_delete(eigrp->eiflist,ei);XFREE(MT
YPE_EIGRP_IF_INFO,ifp->info);ifp->info=NULL;return0;}structlist*eigrp_iflist;voi
deigrp_if_init(){/*InitializeZebrainterfacedatastructure.*///hook_register_prio(
if_add,0,eigrp_if_new);hook_register_prio(if_del,0,eigrp_if_delete_hook);}voidei
grp_del_if_params(structeigrp_if_params*eip){if(eip->auth_keychain)free(eip->aut
h_keychain);}inteigrp_if_up(structeigrp_interface*ei){structeigrp_prefix_entry*p
e;structeigrp_nexthop_entry*ne;structeigrp_metricsmetric;structeigrp_interface*e
i2;structlistnode*node,*nnode;structeigrp*eigrp;if(ei==NULL)return0;eigrp=ei->ei
grp;eigrp_adjust_sndbuflen(eigrp,ei->ifp->mtu);eigrp_if_stream_set(ei);/*Setmult
icastmembershipsappropriatelyfornewstate.*/eigrp_if_set_multicast(ei);thread_add
_event(master,eigrp_hello_timer,ei,(1),NULL);/*Preparemetrics*/metric.bandwidth=
eigrp_bandwidth_to_scaled(ei->params.bandwidth);metric.delay=eigrp_delay_to_scal
ed(ei->params.delay);metric.load=ei->params.load;metric.reliability=ei->params.r
eliability;metric.mtu[0]=0xDC;metric.mtu[1]=0x05;metric.mtu[2]=0x00;metric.hop_c
ount=0;metric.flags=0;metric.tag=0;/*Addconnectedentrytotopologytable*/ne=eigrp_
nexthop_entry_new();ne->ei=ei;ne->reported_metric=metric;ne->total_metric=metric
;ne->distance=eigrp_calculate_metrics(eigrp,metric);ne->reported_distance=0;ne->
adv_router=eigrp->neighbor_self;ne->flags=EIGRP_NEXTHOP_ENTRY_SUCCESSOR_FLAG;str
uctprefixdest_addr;dest_addr.family=AF_INET;dest_addr.u.prefix4=ei->connected->a
ddress->u.prefix4;dest_addr.prefixlen=ei->connected->address->prefixlen;apply_ma
sk(&dest_addr);pe=eigrp_topology_table_lookup_ipv4(eigrp->topology_table,&dest_a
ddr);if(pe==NULL){pe=eigrp_prefix_entry_new();pe->serno=eigrp->serno;pe->destina
tion=(structprefix*)prefix_ipv4_new();prefix_copy(pe->destination,&dest_addr);pe
->af=AF_INET;pe->nt=EIGRP_TOPOLOGY_TYPE_CONNECTED;ne->prefix=pe;pe->reported_met
ric=metric;pe->state=EIGRP_FSM_STATE_PASSIVE;pe->fdistance=eigrp_calculate_metri
cs(eigrp,metric);pe->req_action|=EIGRP_FSM_NEED_UPDATE;eigrp_prefix_entry_add(ei
grp->topology_table,pe);listnode_add(eigrp->topology_changes_internalIPV4,pe);ei
grp_nexthop_entry_add(pe,ne);for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei2
)){eigrp_update_send(ei2);}pe->req_action&=~EIGRP_FSM_NEED_UPDATE;listnode_delet
e(eigrp->topology_changes_internalIPV4,pe);}else{structeigrp_fsm_action_messagem
sg;ne->prefix=pe;eigrp_nexthop_entry_add(pe,ne);msg.packet_type=EIGRP_OPC_UPDATE
;msg.eigrp=eigrp;msg.data_type=EIGRP_CONNECTED;msg.adv_router=NULL;msg.entry=ne;
msg.prefix=pe;eigrp_fsm_event(&msg);}return1;}inteigrp_if_down(structeigrp_inter
face*ei){structlistnode*node,*nnode;structeigrp_neighbor*nbr;if(ei==NULL)return0
;/*Shutdownpacketreceptionandsending*/if(ei->t_hello)THREAD_OFF(ei->t_hello);eig
rp_if_stream_unset(ei);/*Setinfinitemetricstorouteslearnedbythisinterfaceandstar
t*queryprocess*/for(ALL_LIST_ELEMENTS(ei->nbrs,node,nnode,nbr)){eigrp_nbr_delete
(nbr);}return1;}voideigrp_if_stream_set(structeigrp_interface*ei){/*setoutputfif
oqueue.*/if(ei->obuf==NULL)ei->obuf=eigrp_fifo_new();}voideigrp_if_stream_unset(
structeigrp_interface*ei){structeigrp*eigrp=ei->eigrp;if(ei->obuf){eigrp_fifo_fr
ee(ei->obuf);ei->obuf=NULL;if(ei->on_write_q){listnode_delete(eigrp->oi_write_q,
ei);if(list_isempty(eigrp->oi_write_q))thread_cancel(eigrp->t_write);ei->on_writ
e_q=0;}}}booleigrp_if_is_passive(structeigrp_interface*ei){if(ei->params.passive
_interface==EIGRP_IF_ACTIVE)returnfalse;if(ei->eigrp->passive_interface_default=
=EIGRP_IF_ACTIVE)returnfalse;returntrue;}voideigrp_if_set_multicast(structeigrp_
interface*ei){if(!eigrp_if_is_passive(ei)){/*TheinterfaceshouldbelongtotheEIGRP-
all-routersgroup.*/if(!ei->member_allrouters&&(eigrp_if_add_allspfrouters(ei->ei
grp,ei->address,ei->ifp->ifindex)>=0))/*Settheflagonlyifthesystemcalltojoin*succ
eeded.*/ei->member_allrouters=true;}else{/*TheinterfaceshouldNOTbelongtotheEIGRP
-all-routers*group.*/if(ei->member_allrouters){/*Onlyactuallydropifthisisthelast
reference*/eigrp_if_drop_allspfrouters(ei->eigrp,ei->address,ei->ifp->ifindex);/
*Unsettheflagregardlessofwhetherthesystemcalltoleavethegroupsucceeded,sinceit'sm
uchsafertoassumethatwearenotamember.*/ei->member_allrouters=false;}}}uint8_teigr
p_default_iftype(structinterface*ifp){if(if_is_pointopoint(ifp))returnEIGRP_IFTY
PE_POINTOPOINT;elseif(if_is_loopback(ifp))returnEIGRP_IFTYPE_LOOPBACK;elsereturn
EIGRP_IFTYPE_BROADCAST;}voideigrp_if_free(structeigrp_interface*ei,intsource){st
ructprefixdest_addr;structeigrp_prefix_entry*pe;structeigrp*eigrp=eigrp_lookup()
;if(source==INTERFACE_DOWN_BY_VTY){THREAD_OFF(ei->t_hello);eigrp_hello_send(ei,E
IGRP_HELLO_GRACEFUL_SHUTDOWN,NULL);}dest_addr=*ei->connected->address;apply_mask
(&dest_addr);pe=eigrp_topology_table_lookup_ipv4(eigrp->topology_table,&dest_add
r);if(pe)eigrp_prefix_entry_delete(eigrp->topology_table,pe);eigrp_if_down(ei);l
ist_delete_and_null(&ei->nbrs);listnode_delete(ei->eigrp->eiflist,ei);}/*Simulat
edown/upontheinterface.Thisisneeded,forexample,whentheMTUchanges.*/voideigrp_if_
reset(structinterface*ifp){structeigrp_interface*ei=ifp->info;if(!ei)return;eigr
p_if_down(ei);eigrp_if_up(ei);}structeigrp_interface*eigrp_if_lookup_by_local_ad
dr(structeigrp*eigrp,structinterface*ifp,structin_addraddress){structlistnode*no
de;structeigrp_interface*ei;for(ALL_LIST_ELEMENTS_RO(eigrp->eiflist,node,ei)){if
(ifp&&ei->ifp!=ifp)continue;if(IPV4_ADDR_SAME(&address,&ei->address->u.prefix4))
returnei;}returnNULL;}/***@fneigrp_if_lookup_by_name**@param[in]eigrpEIGRPproces
s*@param[in]if_nameNameoftheinterface**@returnstructeigrp_interface***@par*Funct
ionisusedforlookupinterfacebyname.*/structeigrp_interface*eigrp_if_lookup_by_nam
e(structeigrp*eigrp,constchar*if_name){structeigrp_interface*ei;structlistnode*n
ode;/*iterateoveralleigrpinterfaces*/for(ALL_LIST_ELEMENTS_RO(eigrp->eiflist,nod
e,ei)){/*compareintnamewitheigrpinterface'sname*/if(strcmp(ei->ifp->name,if_name
)==0){returnei;}}returnNULL;}uint32_teigrp_bandwidth_to_scaled(uint32_tbandwidth
){uint64_ttemp_bandwidth=(256ull*10000000)/bandwidth;temp_bandwidth=temp_bandwid
th<EIGRP_MAX_METRIC?temp_bandwidth:EIGRP_MAX_METRIC;return(uint32_t)temp_bandwid
th;}uint32_teigrp_scaled_to_bandwidth(uint32_tscaled){uint64_ttemp_scaled=scaled
*(256ull*10000000);temp_scaled=temp_scaled<EIGRP_MAX_METRIC?temp_scaled:EIGRP_MA
X_METRIC;return(uint32_t)temp_scaled;}uint32_teigrp_delay_to_scaled(uint32_tdela
y){returndelay*256;}uint32_teigrp_scaled_to_delay(uint32_tscaled){returnscaled/2
56;}