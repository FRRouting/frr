/**EIGRPDaemonProgram.*Copyright(C)2013-2014*Authors:*DonnieSavage*JanJanovic*Ma
tejPerina*PeterOrsag*PeterPaluch**ThisfileispartofGNUZebra.**GNUZebraisfreesoftw
are;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicense
aspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*later
version.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANT
Y;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.
SeetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGN
UGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFre
eSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#inclu
de<zebra.h>#include"thread.h"#include"vty.h"#include"command.h"#include"linklist
.h"#include"prefix.h"#include"table.h"#include"if.h"#include"memory.h"#include"s
tream.h"#include"log.h"#include"sockunion.h"/*forinet_aton()*/#include"zclient.h
"#include"plist.h"#include"sockopt.h"#include"keychain.h"#include"libfrr.h"#incl
ude"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#include"eigrpd/eigrp_interf
ace.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"#include"eigrpd/
eigrp_neighbor.h"#include"eigrpd/eigrp_packet.h"#include"eigrpd/eigrp_network.h"
#include"eigrpd/eigrp_topology.h"#include"eigrpd/eigrp_memory.h"DEFINE_QOBJ_TYPE
(eigrp)staticstructeigrp_mastereigrp_master;structeigrp_master*eigrp_om;staticvo
ideigrp_delete(structeigrp*);staticstructeigrp*eigrp_new(constchar*);staticvoide
igrp_add(structeigrp*);externstructzclient*zclient;externstructin_addrrouter_id_
zebra;/**voideigrp_router_id_update(structeigrp*eigrp)**Description:*updateroute
ridassociatedwiththisinstanceofEIGRP.*Iftheidchanges,thencallif_updateforeachint
erface*toresyncthetopologydatabasewithallneighbors**SelecttherouterIDbasedonthes
epriorities:*1.StaticallyassignedrouterIDisalwaysthefirstchoice.*2.Ifthereisnost
aticallyassignedrouterID,thentrytostick*withthemostrecentvalue,sincechangingrout
erID'sisvery*disruptive.*3.Lastchoice:justgowithwhateverthezebradaemonrecommends
.**Note:*routeridforEIGRPisreallyjusta32bitnumber.Ciscohistorically*displaysitin
dotteddecimalnotation,andwillpickupanIPaddress*fromaninterfacesoitcanbe'auto-con
figed"toauniqevalue**ThisdoesnotworkforIPv6,andtomakethecodesimpler,its*storedan
dprocessedinternerallasa32bitnumber*/voideigrp_router_id_update(structeigrp*eigr
p){structvrf*vrf=vrf_lookup_by_id(VRF_DEFAULT);structinterface*ifp;uint32_troute
r_id,router_id_old;router_id_old=eigrp->router_id;if(eigrp->router_id_static!=0)
router_id=eigrp->router_id_static;elseif(eigrp->router_id!=0)router_id=eigrp->ro
uter_id;elserouter_id=router_id_zebra.s_addr;eigrp->router_id=router_id;if(route
r_id_old!=router_id){//if(IS_DEBUG_EIGRP_EVENT)//zlog_debug("Router-ID[NEW:%s]:U
pdate",//inet_ntoa(eigrp->router_id));/*updateeigrp_interface's*/FOR_ALL_INTERFA
CES(vrf,ifp)eigrp_if_update(ifp);}}voideigrp_master_init(){structtimevaltv;memse
t(&eigrp_master,0,sizeof(structeigrp_master));eigrp_om=&eigrp_master;eigrp_om->e
igrp=list_new();monotime(&tv);eigrp_om->start_time=tv.tv_sec;}/*Allocateneweigrp
structure.*/staticstructeigrp*eigrp_new(constchar*AS){structeigrp*eigrp=XCALLOC(
MTYPE_EIGRP_TOP,sizeof(structeigrp));inteigrp_socket;/*initinformationrelevantto
peers*/eigrp->vrid=0;eigrp->AS=atoi(AS);eigrp->router_id=0L;eigrp->router_id_sta
tic=0L;eigrp->sequence_number=1;/*ConfiguredefaultKValuesforEIGRPProcess*/eigrp-
>k_values[0]=EIGRP_K1_DEFAULT;eigrp->k_values[1]=EIGRP_K2_DEFAULT;eigrp->k_value
s[2]=EIGRP_K3_DEFAULT;eigrp->k_values[3]=EIGRP_K4_DEFAULT;eigrp->k_values[4]=EIG
RP_K5_DEFAULT;eigrp->k_values[5]=EIGRP_K6_DEFAULT;/*initinternaldatastructures*/
eigrp->eiflist=list_new();eigrp->passive_interface_default=EIGRP_IF_ACTIVE;eigrp
->networks=eigrp_topology_new();if((eigrp_socket=eigrp_sock_init())<0){zlog_err(
"eigrp_new:fatalerror:eigrp_sock_initwasunabletoopen""asocket");exit(1);}eigrp->
fd=eigrp_socket;eigrp->maxsndbuflen=getsockopt_so_sendbuf(eigrp->fd);if((eigrp->
ibuf=stream_new(EIGRP_PACKET_MAX_LEN+1))==NULL){zlog_err("eigrp_new:fatalerror:s
tream_new(%u)failedallocatingibuf",EIGRP_PACKET_MAX_LEN+1);exit(1);}eigrp->t_rea
d=NULL;thread_add_read(master,eigrp_read,eigrp,eigrp->fd,&eigrp->t_read);eigrp->
oi_write_q=list_new();eigrp->topology_table=route_table_init();eigrp->neighbor_s
elf=eigrp_nbr_new(NULL);eigrp->neighbor_self->src.s_addr=INADDR_ANY;eigrp->varia
nce=EIGRP_VARIANCE_DEFAULT;eigrp->max_paths=EIGRP_MAX_PATHS_DEFAULT;eigrp->serno
=0;eigrp->serno_last_update=0;eigrp->topology_changes_externalIPV4=list_new();ei
grp->topology_changes_internalIPV4=list_new();eigrp->list[EIGRP_FILTER_IN]=NULL;
eigrp->list[EIGRP_FILTER_OUT]=NULL;eigrp->prefix[EIGRP_FILTER_IN]=NULL;eigrp->pr
efix[EIGRP_FILTER_OUT]=NULL;eigrp->routemap[EIGRP_FILTER_IN]=NULL;eigrp->routema
p[EIGRP_FILTER_OUT]=NULL;QOBJ_REG(eigrp,eigrp);returneigrp;}staticvoideigrp_add(
structeigrp*eigrp){listnode_add(eigrp_om->eigrp,eigrp);}staticvoideigrp_delete(s
tructeigrp*eigrp){listnode_delete(eigrp_om->eigrp,eigrp);}structeigrp*eigrp_get(
constchar*AS){structeigrp*eigrp;eigrp=eigrp_lookup();if(eigrp==NULL){eigrp=eigrp
_new(AS);eigrp_add(eigrp);}returneigrp;}/*Shutdowntheentireprocess*/voideigrp_te
rminate(void){structeigrp*eigrp;structlistnode*node,*nnode;/*shutdownalreadyinpr
ogress*/if(CHECK_FLAG(eigrp_om->options,EIGRP_MASTER_SHUTDOWN))return;SET_FLAG(e
igrp_om->options,EIGRP_MASTER_SHUTDOWN);for(ALL_LIST_ELEMENTS(eigrp_om->eigrp,no
de,nnode,eigrp))eigrp_finish(eigrp);frr_fini();}voideigrp_finish(structeigrp*eig
rp){eigrp_finish_final(eigrp);/*eigrpbeingshut-down?Ifso,wasthisthelasteigrpinst
ance?*/if(CHECK_FLAG(eigrp_om->options,EIGRP_MASTER_SHUTDOWN)&&(listcount(eigrp_
om->eigrp)==0)){if(zclient){zclient_stop(zclient);zclient_free(zclient);}exit(0)
;}return;}/*Finalcleanupofeigrpinstance*/voideigrp_finish_final(structeigrp*eigr
p){structeigrp_interface*ei;structeigrp_neighbor*nbr;structlistnode*node,*nnode,
*node2,*nnode2;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){for(ALL_LIST
_ELEMENTS(ei->nbrs,node2,nnode2,nbr))eigrp_nbr_delete(nbr);eigrp_if_free(ei,INTE
RFACE_DOWN_BY_FINAL);}THREAD_OFF(eigrp->t_write);THREAD_OFF(eigrp->t_read);close
(eigrp->fd);list_delete_and_null(&eigrp->eiflist);list_delete_and_null(&eigrp->o
i_write_q);eigrp_topology_cleanup(eigrp->topology_table);eigrp_topology_free(eig
rp->topology_table);eigrp_nbr_delete(eigrp->neighbor_self);list_delete_and_null(
&eigrp->topology_changes_externalIPV4);list_delete_and_null(&eigrp->topology_cha
nges_internalIPV4);eigrp_delete(eigrp);XFREE(MTYPE_EIGRP_TOP,eigrp);}/*Lookforex
istingeigrpprocess*/structeigrp*eigrp_lookup(void){if(listcount(eigrp_om->eigrp)
==0)returnNULL;returnlistgetdata(listhead(eigrp_om->eigrp));}