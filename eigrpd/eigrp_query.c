/**EIGRPSendingandReceivingEIGRPQueryPackets.*Copyright(C)2013-2014*Authors:*Don
nieSavage*JanJanovic*MatejPerina*PeterOrsag*PeterPaluch**ThisfileispartofGNUZebr
a.**GNUZebraisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsofthe
GNUGeneralPublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or
(atyouroption)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeusefu
l,but*WITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNES
SFORAPARTICULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldh
avereceivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPY
ING;ifnot,writetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,
MA02110-1301USA*/#include<zebra.h>#include"thread.h"#include"memory.h"#include"l
inklist.h"#include"prefix.h"#include"if.h"#include"table.h"#include"sockunion.h"
#include"stream.h"#include"log.h"#include"sockopt.h"#include"checksum.h"#include
"md5.h"#include"vty.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#
include"eigrpd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"eigrp
d/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"#incl
ude"eigrpd/eigrp_dump.h"#include"eigrpd/eigrp_macros.h"#include"eigrpd/eigrp_top
ology.h"#include"eigrpd/eigrp_fsm.h"#include"eigrpd/eigrp_memory.h"uint32_teigrp
_query_send_all(structeigrp*eigrp){structeigrp_interface*iface;structlistnode*no
de,*node2,*nnode2;structeigrp_prefix_entry*pe;uint32_tcounter;if(eigrp==NULL){zl
og_debug("EIGRPRoutingProcessnotenabled");return0;}counter=0;for(ALL_LIST_ELEMEN
TS_RO(eigrp->eiflist,node,iface)){eigrp_send_query(iface);counter++;}for(ALL_LIS
T_ELEMENTS(eigrp->topology_changes_internalIPV4,node2,nnode2,pe)){if(pe->req_act
ion&EIGRP_FSM_NEED_QUERY){pe->req_action&=~EIGRP_FSM_NEED_QUERY;listnode_delete(
eigrp->topology_changes_internalIPV4,pe);}}returncounter;}/*EIGRPQUERYreadfuncti
on*/voideigrp_query_receive(structeigrp*eigrp,structip*iph,structeigrp_header*ei
grph,structstream*s,structeigrp_interface*ei,intsize){structeigrp_neighbor*nbr;s
tructTLV_IPv4_Internal_type*tlv;structprefixdest_addr;uint16_ttype;uint16_tlengt
h;/*incrementstatistics.*/ei->query_in++;/*getneighborstruct*/nbr=eigrp_nbr_get(
ei,eigrph,iph);/*neighbormustbevalid,eigrp_nbr_getcreatesifnoneexisted*/assert(n
br);nbr->recv_sequence_number=ntohl(eigrph->sequence);while(s->endp>s->getp){typ
e=stream_getw(s);switch(type){caseEIGRP_TLV_IPv4_INT:stream_set_getp(s,s->getp-s
izeof(uint16_t));tlv=eigrp_read_ipv4_tlv(s);dest_addr.family=AF_INET;dest_addr.u
.prefix4=tlv->destination;dest_addr.prefixlen=tlv->prefix_length;structeigrp_pre
fix_entry*dest=eigrp_topology_table_lookup_ipv4(eigrp->topology_table,&dest_addr
);/*Ifthedestinationexists(itshould,butonenever*know)*/if(dest!=NULL){structeigr
p_fsm_action_messagemsg;structeigrp_nexthop_entry*entry=eigrp_prefix_entry_looku
p(dest->entries,nbr);msg.packet_type=EIGRP_OPC_QUERY;msg.eigrp=eigrp;msg.data_ty
pe=EIGRP_INT;msg.adv_router=nbr;msg.metrics=tlv->metric;msg.entry=entry;msg.pref
ix=dest;eigrp_fsm_event(&msg);}eigrp_IPv4_InternalTLV_free(tlv);break;caseEIGRP_
TLV_IPv4_EXT:/*DVS:processingofexternalroutesneedspacketandfsmwork.*fornow,letsj
ustnotcreashthebox*/default:length=stream_getw(s);//-2fortype,-2forlenfor(length
-=4;length;length--){(void)stream_getc(s);}}}eigrp_hello_send_ack(nbr);eigrp_que
ry_send_all(eigrp);eigrp_update_send_all(eigrp,nbr->ei);}voideigrp_send_query(st
ructeigrp_interface*ei){structeigrp_packet*ep=NULL;uint16_tlength=EIGRP_HEADER_L
EN;structlistnode*node,*nnode,*node2,*nnode2;structeigrp_neighbor*nbr;structeigr
p_prefix_entry*pe;boolhas_tlv=false;boolnew_packet=true;for(ALL_LIST_ELEMENTS(ei
->eigrp->topology_changes_internalIPV4,node,nnode,pe)){if(!(pe->req_action&EIGRP
_FSM_NEED_QUERY))continue;if(new_packet){ep=eigrp_packet_new(ei->ifp->mtu,NULL);
/*PrepareEIGRPINITUPDATEheader*/eigrp_packet_header_init(EIGRP_OPC_QUERY,ei->eig
rp,ep->s,0,ei->eigrp->sequence_number,0);//encodeAuthenticationTLV,ifneededif((e
i->params.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL)){len
gth+=eigrp_add_authTLV_MD5_to_stream(ep->s,ei);}new_packet=false;}length+=eigrp_
add_internalTLV_to_stream(ep->s,pe);has_tlv=true;for(ALL_LIST_ELEMENTS(ei->nbrs,
node2,nnode2,nbr)){if(nbr->state==EIGRP_NEIGHBOR_UP)listnode_add(pe->rij,nbr);}i
f(length+EIGRP_TLV_MAX_IPV4_BYTE>(uint16_t)ei->ifp->mtu){if((ei->params.auth_typ
e==EIGRP_AUTH_TYPE_MD5)&&ei->params.auth_keychain!=NULL){eigrp_make_md5_digest(e
i,ep->s,EIGRP_AUTH_UPDATE_FLAG);}eigrp_packet_checksum(ei,ep->s,length);ep->leng
th=length;ep->dst.s_addr=htonl(EIGRP_MULTICAST_ADDRESS);ep->sequence_number=ei->
eigrp->sequence_number;ei->eigrp->sequence_number++;for(ALL_LIST_ELEMENTS(ei->nb
rs,node2,nnode2,nbr)){structeigrp_packet*dup;if(nbr->state!=EIGRP_NEIGHBOR_UP)co
ntinue;dup=eigrp_packet_duplicate(ep,nbr);/*Putpackettoretransmissionqueue*/eigr
p_fifo_push(nbr->retrans_queue,dup);if(nbr->retrans_queue->count==1)eigrp_send_p
acket_reliably(nbr);}has_tlv=false;length=0;eigrp_packet_free(ep);ep=NULL;new_pa
cket=true;}}if(!has_tlv){if(ep)eigrp_packet_free(ep);return;}if((ei->params.auth
_type==EIGRP_AUTH_TYPE_MD5)&&ei->params.auth_keychain!=NULL)eigrp_make_md5_diges
t(ei,ep->s,EIGRP_AUTH_UPDATE_FLAG);/*EIGRPChecksum*/eigrp_packet_checksum(ei,ep-
>s,length);ep->length=length;ep->dst.s_addr=htonl(EIGRP_MULTICAST_ADDRESS);/*Thi
sacknumberweawaitfromneighbor*/ep->sequence_number=ei->eigrp->sequence_number;ei
->eigrp->sequence_number++;for(ALL_LIST_ELEMENTS(ei->nbrs,node2,nnode2,nbr)){str
ucteigrp_packet*dup;if(nbr->state!=EIGRP_NEIGHBOR_UP)continue;dup=eigrp_packet_d
uplicate(ep,nbr);/*Putpackettoretransmissionqueue*/eigrp_fifo_push(nbr->retrans_
queue,dup);if(nbr->retrans_queue->count==1)eigrp_send_packet_reliably(nbr);}eigr
p_packet_free(ep);}