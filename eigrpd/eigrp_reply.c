/**EigrpSendingandReceivingEIGRPReplyPackets.*Copyright(C)2013-2016*Authors:*Don
nieSavage*JanJanovic*MatejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvork
ovy*MartinKontsek*LukasKoribsky**ThisfileispartofGNUZebra.**GNUZebraisfreesoftwa
re;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicensea
spublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterv
ersion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY
;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.S
eetheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNU
GeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFree
Software*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#includ
e<zebra.h>#include"thread.h"#include"memory.h"#include"linklist.h"#include"prefi
x.h"#include"if.h"#include"table.h"#include"sockunion.h"#include"stream.h"#inclu
de"log.h"#include"sockopt.h"#include"checksum.h"#include"md5.h"#include"vty.h"#i
nclude"keychain.h"#include"plist.h"#include"eigrpd/eigrp_structs.h"#include"eigr
pd/eigrpd.h"#include"eigrpd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#
include"eigrpd/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigr
p_vty.h"#include"eigrpd/eigrp_dump.h"#include"eigrpd/eigrp_macros.h"#include"eig
rpd/eigrp_topology.h"#include"eigrpd/eigrp_fsm.h"#include"eigrpd/eigrp_memory.h"
voideigrp_send_reply(structeigrp_neighbor*nbr,structeigrp_prefix_entry*pe){struc
teigrp_packet*ep;uint16_tlength=EIGRP_HEADER_LEN;structeigrp_interface*ei=nbr->e
i;structeigrp*eigrp=ei->eigrp;structeigrp_prefix_entry*pe2;//TODO:Workinprogress
/*Filtering*//*getlistfromeigrpprocess*/pe2=XCALLOC(MTYPE_EIGRP_PREFIX_ENTRY,siz
eof(structeigrp_prefix_entry));memcpy(pe2,pe,sizeof(structeigrp_prefix_entry));i
f(eigrp_update_prefix_apply(eigrp,ei,EIGRP_FILTER_OUT,pe2->destination)){zlog_in
fo("REPLYSEND:SettingMetrictomax");pe2->reported_metric.delay=EIGRP_MAX_METRIC;}
/**Endoffiltering*/ep=eigrp_packet_new(ei->ifp->mtu,nbr);/*PrepareEIGRPINITUPDAT
Eheader*/eigrp_packet_header_init(EIGRP_OPC_REPLY,eigrp,ep->s,0,eigrp->sequence_
number,0);//encodeAuthenticationTLV,ifneededif(ei->params.auth_type==EIGRP_AUTH_
TYPE_MD5&&(ei->params.auth_keychain!=NULL)){length+=eigrp_add_authTLV_MD5_to_str
eam(ep->s,ei);}length+=eigrp_add_internalTLV_to_stream(ep->s,pe2);if((ei->params
.auth_type==EIGRP_AUTH_TYPE_MD5)&&(ei->params.auth_keychain!=NULL)){eigrp_make_m
d5_digest(ei,ep->s,EIGRP_AUTH_UPDATE_FLAG);}/*EIGRPChecksum*/eigrp_packet_checks
um(ei,ep->s,length);ep->length=length;ep->dst.s_addr=nbr->src.s_addr;/*Thisacknu
mberweawaitfromneighbor*/ep->sequence_number=eigrp->sequence_number;/*Putpackett
oretransmissionqueue*/eigrp_fifo_push(nbr->retrans_queue,ep);if(nbr->retrans_que
ue->count==1){eigrp_send_packet_reliably(nbr);}XFREE(MTYPE_EIGRP_PREFIX_ENTRY,pe
2);}/*EIGRPREPLYreadfunction*/voideigrp_reply_receive(structeigrp*eigrp,structip
*iph,structeigrp_header*eigrph,structstream*s,structeigrp_interface*ei,intsize){
structeigrp_neighbor*nbr;structTLV_IPv4_Internal_type*tlv;uint16_ttype;/*increme
ntstatistics.*/ei->reply_in++;/*getneighborstruct*/nbr=eigrp_nbr_get(ei,eigrph,i
ph);/*neighbormustbevalid,eigrp_nbr_getcreatesifnoneexisted*/assert(nbr);nbr->re
cv_sequence_number=ntohl(eigrph->sequence);while(s->endp>s->getp){type=stream_ge
tw(s);if(type!=EIGRP_TLV_IPv4_INT)continue;structprefixdest_addr;stream_set_getp
(s,s->getp-sizeof(uint16_t));tlv=eigrp_read_ipv4_tlv(s);dest_addr.family=AF_INET
;dest_addr.u.prefix4=tlv->destination;dest_addr.prefixlen=tlv->prefix_length;str
ucteigrp_prefix_entry*dest=eigrp_topology_table_lookup_ipv4(eigrp->topology_tabl
e,&dest_addr);/**Destinationmustexists*/if(!dest){charbuf[PREFIX_STRLEN];zlog_er
r("%s:Receivedprefix%swhichwedonotknowabout",__PRETTY_FUNCTION__,prefix2str(&des
t_addr,buf,sizeof(buf)));eigrp_IPv4_InternalTLV_free(tlv);continue;}structeigrp_
fsm_action_messagemsg;structeigrp_nexthop_entry*entry=eigrp_prefix_entry_lookup(
dest->entries,nbr);if(eigrp_update_prefix_apply(eigrp,ei,EIGRP_FILTER_IN,&dest_a
ddr)){tlv->metric.delay=EIGRP_MAX_METRIC;}/**Endoffiltering*/msg.packet_type=EIG
RP_OPC_REPLY;msg.eigrp=eigrp;msg.data_type=EIGRP_INT;msg.adv_router=nbr;msg.metr
ics=tlv->metric;msg.entry=entry;msg.prefix=dest;eigrp_fsm_event(&msg);eigrp_IPv4
_InternalTLV_free(tlv);}eigrp_hello_send_ack(nbr);}