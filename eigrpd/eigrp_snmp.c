/**EIGRPSNMPSupport.*Copyright(C)2013-2014*Authors:*DonnieSavage*JanJanovic*Mate
jPerina*PeterOrsag*PeterPaluch**ThisfileispartofGNUZebra.**GNUZebraisfreesoftwar
e;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseas
publishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouroption)any*laterve
rsion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;
withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.Se
etheGNU*GeneralPublicLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUG
eneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeS
oftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include
<zebra.h>#ifdefHAVE_SNMP#include<net-snmp/net-snmp-config.h>#include<net-snmp/ne
t-snmp-includes.h>#include"thread.h"#include"memory.h"#include"linklist.h"#inclu
de"prefix.h"#include"if.h"#include"table.h"#include"sockunion.h"#include"stream.
h"#include"log.h"#include"sockopt.h"#include"checksum.h"#include"md5.h"#include"
keychain.h"#include"smux.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrp
d.h"#include"eigrpd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"
eigrpd/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"
#include"eigrpd/eigrp_dump.h"#include"eigrpd/eigrp_network.h"#include"eigrpd/eig
rp_topology.h"#include"eigrpd/eigrp_fsm.h"#include"eigrpd/eigrp_snmp.h"structlis
t*eigrp_snmp_iflist;/*Declarestaticlocalvariablesforconvenience.*/SNMP_LOCAL_VAR
IABLES/*EIGRP-MIB-1.3.6.1.4.1.9.9.449.1*/#defineEIGRPMIB1,3,6,1,4,1,9,9,449,1/*E
IGRP-MIBinstances.*/oideigrp_oid[]={EIGRPMIB};/*EIGRPVPNentry*/#defineEIGRPVPNID
1#defineEIGRPVPNNAME2/*EIGRPTrafficstatisticsentry*/#defineEIGRPASNUMBER1#define
EIGRPNBRCOUNT2#defineEIGRPHELLOSSENT3#defineEIGRPHELLOSRCVD4#defineEIGRPUPDATESS
ENT5#defineEIGRPUPDATESRCVD6#defineEIGRPQUERIESSENT7#defineEIGRPQUERIESRCVD8#def
ineEIGRPREPLIESSENT9#defineEIGRPREPLIESRCVD10#defineEIGRPACKSSENT11#defineEIGRPA
CKSRCVD12#defineEIGRPINPUTQHIGHMARK13#defineEIGRPINPUTQDROPS14#defineEIGRPSIAQUE
RIESSENT15#defineEIGRPSIAQUERIESRCVD16#defineEIGRPASROUTERIDTYPE17#defineEIGRPAS
ROUTERID18#defineEIGRPTOPOROUTES19#defineEIGRPHEADSERIAL20#defineEIGRPNEXTSERIAL
21#defineEIGRPXMITPENDREPLIES22#defineEIGRPXMITDUMMIES23/*EIGRPtopologyentry*/#d
efineEIGRPDESTNETTYPE1#defineEIGRPDESTNET2#defineEIGRPDESTNETPREFIXLEN4#defineEI
GRPACTIVE5#defineEIGRPSTUCKINACTIVE6#defineEIGRPDESTSUCCESSORS7#defineEIGRPFDIST
ANCE8#defineEIGRPROUTEORIGINTYPE9#defineEIGRPROUTEORIGINADDRTYPE10#defineEIGRPRO
UTEORIGINADDR11#defineEIGRPNEXTHOPADDRESSTYPE12#defineEIGRPNEXTHOPADDRESS13#defi
neEIGRPNEXTHOPINTERFACE14#defineEIGRPDISTANCE15#defineEIGRPREPORTDISTANCE16/*EIG
RPpeerentry*/#defineEIGRPHANDLE1#defineEIGRPPEERADDRTYPE2#defineEIGRPPEERADDR3#d
efineEIGRPPEERIFINDEX4#defineEIGRPHOLDTIME5#defineEIGRPUPTIME6#defineEIGRPSRTT7#
defineEIGRPRTO8#defineEIGRPPKTSENQUEUED9#defineEIGRPLASTSEQ10#defineEIGRPVERSION
11#defineEIGRPRETRANS12#defineEIGRPRETRIES13/*EIGRPinterfaceentry*/#defineEIGRPP
EERCOUNT3#defineEIGRPXMITRELIABLEQ4#defineEIGRPXMITUNRELIABLEQ5#defineEIGRPMEANS
RTT6#defineEIGRPPACINGRELIABLE7#defineEIGRPPACINGUNRELIABLE8#defineEIGRPMFLOWTIM
ER9#defineEIGRPPENDINGROUTES10#defineEIGRPHELLOINTERVAL11#defineEIGRPXMITNEXTSER
IAL12#defineEIGRPUMCASTS13#defineEIGRPRMCASTS14#defineEIGRPUUCASTS15#defineEIGRP
RUCASTS16#defineEIGRPMCASTEXCEPTS17#defineEIGRPCRPKTS18#defineEIGRPACKSSUPPRESSE
D19#defineEIGRPRETRANSSENT20#defineEIGRPOOSRCVD21#defineEIGRPAUTHMODE22#defineEI
GRPAUTHKEYCHAIN23/*SNMPvaluehack.*/#defineCOUNTERASN_COUNTER#defineINTEGERASN_IN
TEGER#defineGAUGEASN_GAUGE#defineTIMETICKSASN_TIMETICKS#defineIPADDRESSASN_IPADD
RESS#defineSTRINGASN_OCTET_STR#defineIPADDRESSPREFIXLENASN_INTEGER#defineIPADDRE
SSTYPEASN_INTEGER#defineINTERFACEINDEXORZEROASN_INTEGER#defineUINTEGERASN_UNSIGN
ED/*Hookfunctions.*/staticuint8_t*eigrpVpnEntry(structvariable*,oid*,size_t*,int
,size_t*,WriteMethod**);staticuint8_t*eigrpTraffStatsEntry(structvariable*,oid*,
size_t*,int,size_t*,WriteMethod**);staticuint8_t*eigrpTopologyEntry(structvariab
le*,oid*,size_t*,int,size_t*,WriteMethod**);staticuint8_t*eigrpPeerEntry(structv
ariable*,oid*,size_t*,int,size_t*,WriteMethod**);staticuint8_t*eigrpInterfaceEnt
ry(structvariable*,oid*,size_t*,int,size_t*,WriteMethod**);structvariableeigrp_v
ariables[]={/*EIGRPvpnvariables*/{EIGRPVPNID,INTEGER,NOACCESS,eigrpVpnEntry,4,{1
,1,1,1}},{EIGRPVPNNAME,STRING,RONLY,eigrpVpnEntry,4,{1,1,1,2}},/*EIGRPtrafficsta
tsvariables*/{EIGRPASNUMBER,UINTEGER,NOACCESS,eigrpTraffStatsEntry,4,{2,1,1,1}},
{EIGRPNBRCOUNT,UINTEGER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,2}},{EIGRPHELLOSSENT
,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,3}},{EIGRPHELLOSRCVD,COUNTER,RONLY,
eigrpTraffStatsEntry,4,{2,1,1,4}},{EIGRPUPDATESSENT,COUNTER,RONLY,eigrpTraffStat
sEntry,4,{2,1,1,5}},{EIGRPUPDATESRCVD,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,
1,6}},{EIGRPQUERIESSENT,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,7}},{EIGRPQU
ERIESRCVD,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,8}},{EIGRPREPLIESSENT,COUN
TER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,9}},{EIGRPREPLIESRCVD,COUNTER,RONLY,eigr
pTraffStatsEntry,4,{2,1,1,10}},{EIGRPACKSSENT,COUNTER,RONLY,eigrpTraffStatsEntry
,4,{2,1,1,11}},{EIGRPACKSRCVD,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,12}},{
EIGRPINPUTQHIGHMARK,INTEGER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,13}},{EIGRPINPUT
QDROPS,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,14}},{EIGRPSIAQUERIESSENT,COU
NTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,15}},{EIGRPSIAQUERIESRCVD,COUNTER,RONLY
,eigrpTraffStatsEntry,4,{2,1,1,16}},{EIGRPASROUTERIDTYPE,IPADDRESSTYPE,RONLY,eig
rpTraffStatsEntry,4,{2,1,1,17}},{EIGRPASROUTERID,IPADDRESS,RONLY,eigrpTraffStats
Entry,4,{2,1,1,18}},{EIGRPTOPOROUTES,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1
,19}},{EIGRPHEADSERIAL,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,20}},{EIGRPNE
XTSERIAL,COUNTER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,21}},{EIGRPXMITPENDREPLIES,
INTEGER,RONLY,eigrpTraffStatsEntry,4,{2,1,1,22}},{EIGRPXMITDUMMIES,COUNTER,RONLY
,eigrpTraffStatsEntry,4,{2,1,1,23}},/*EIGRPtopologyvariables*/{EIGRPDESTNETTYPE,
IPADDRESSTYPE,NOACCESS,eigrpTopologyEntry,4,{3,1,1,1}},{EIGRPDESTNET,IPADDRESSPR
EFIXLEN,NOACCESS,eigrpTopologyEntry,4,{3,1,1,2}},{EIGRPDESTNETPREFIXLEN,IPADDRES
STYPE,NOACCESS,eigrpTopologyEntry,4,{3,1,1,4}},{EIGRPACTIVE,INTEGER,RONLY,eigrpT
opologyEntry,4,{3,1,1,5}},{EIGRPSTUCKINACTIVE,INTEGER,RONLY,eigrpTopologyEntry,4
,{3,1,1,6}},{EIGRPDESTSUCCESSORS,INTEGER,RONLY,eigrpTopologyEntry,4,{3,1,1,7}},{
EIGRPFDISTANCE,INTEGER,RONLY,eigrpTopologyEntry,4,{3,1,1,8}},{EIGRPROUTEORIGINTY
PE,STRING,RONLY,eigrpTopologyEntry,4,{3,1,1,9}},{EIGRPROUTEORIGINADDRTYPE,IPADDR
ESSTYPE,RONLY,eigrpTopologyEntry,4,{3,1,1,10}},{EIGRPROUTEORIGINADDR,IPADDRESS,R
ONLY,eigrpTopologyEntry,4,{3,1,1,11}},{EIGRPNEXTHOPADDRESSTYPE,IPADDRESSTYPE,RON
LY,eigrpTopologyEntry,4,{3,1,1,12}},{EIGRPNEXTHOPADDRESS,IPADDRESS,RONLY,eigrpTo
pologyEntry,4,{3,1,1,13}},{EIGRPNEXTHOPINTERFACE,STRING,RONLY,eigrpTopologyEntry
,4,{3,1,1,14}},{EIGRPDISTANCE,INTEGER,RONLY,eigrpTopologyEntry,4,{3,1,1,15}},{EI
GRPREPORTDISTANCE,INTEGER,RONLY,eigrpTopologyEntry,4,{3,1,1,16}},/*EIGRPpeervari
ables*/{EIGRPHANDLE,INTEGER,NOACCESS,eigrpPeerEntry,4,{4,1,1,1}},{EIGRPPEERADDRT
YPE,IPADDRESSTYPE,RONLY,eigrpPeerEntry,4,{4,1,1,2}},{EIGRPPEERADDR,IPADDRESS,RON
LY,eigrpPeerEntry,4,{4,1,1,3}},{EIGRPPEERIFINDEX,INTERFACEINDEXORZERO,RONLY,eigr
pPeerEntry,4,{4,1,1,4}},{EIGRPHOLDTIME,INTEGER,RONLY,eigrpPeerEntry,4,{4,1,1,5}}
,{EIGRPUPTIME,STRING,RONLY,eigrpPeerEntry,4,{4,1,1,6}},{EIGRPSRTT,INTEGER,RONLY,
eigrpPeerEntry,4,{4,1,1,7}},{EIGRPRTO,INTEGER,RONLY,eigrpPeerEntry,4,{4,1,1,8}},
{EIGRPPKTSENQUEUED,INTEGER,RONLY,eigrpPeerEntry,4,{4,1,1,9}},{EIGRPLASTSEQ,INTEG
ER,RONLY,eigrpPeerEntry,4,{4,1,1,10}},{EIGRPVERSION,STRING,RONLY,eigrpPeerEntry,
4,{4,1,1,11}},{EIGRPRETRANS,COUNTER,RONLY,eigrpPeerEntry,4,{4,1,1,12}},{EIGRPRET
RIES,INTEGER,RONLY,eigrpPeerEntry,4,{4,1,1,13}},/*EIGRPinterfacevariables*/{EIGR
PPEERCOUNT,GAUGE,RONLY,eigrpInterfaceEntry,4,{5,1,1,3}},{EIGRPXMITRELIABLEQ,GAUG
E,RONLY,eigrpInterfaceEntry,4,{5,1,1,4}},{EIGRPXMITUNRELIABLEQ,GAUGE,RONLY,eigrp
InterfaceEntry,4,{5,1,1,5}},{EIGRPMEANSRTT,INTEGER,RONLY,eigrpInterfaceEntry,4,{
5,1,1,6}},{EIGRPPACINGRELIABLE,INTEGER,RONLY,eigrpInterfaceEntry,4,{5,1,1,7}},{E
IGRPPACINGUNRELIABLE,INTEGER,RONLY,eigrpInterfaceEntry,4,{5,1,1,8}},{EIGRPMFLOWT
IMER,INTEGER,RONLY,eigrpInterfaceEntry,4,{5,1,1,9}},{EIGRPPENDINGROUTES,GAUGE,RO
NLY,eigrpInterfaceEntry,4,{5,1,1,10}},{EIGRPHELLOINTERVAL,INTEGER,RONLY,eigrpInt
erfaceEntry,4,{5,1,1,11}},{EIGRPXMITNEXTSERIAL,COUNTER,RONLY,eigrpInterfaceEntry
,4,{5,1,1,12}},{EIGRPUMCASTS,COUNTER,RONLY,eigrpInterfaceEntry,4,{5,1,1,13}},{EI
GRPRMCASTS,COUNTER,RONLY,eigrpInterfaceEntry,4,{5,1,1,14}},{EIGRPUUCASTS,COUNTER
,RONLY,eigrpInterfaceEntry,4,{5,1,1,15}},{EIGRPRUCASTS,COUNTER,RONLY,eigrpInterf
aceEntry,4,{5,1,1,16}},{EIGRPMCASTEXCEPTS,COUNTER,RONLY,eigrpInterfaceEntry,4,{5
,1,1,17}},{EIGRPCRPKTS,COUNTER,RONLY,eigrpInterfaceEntry,4,{5,1,1,18}},{EIGRPACK
SSUPPRESSED,COUNTER,RONLY,eigrpInterfaceEntry,4,{5,1,1,19}},{EIGRPRETRANSSENT,CO
UNTER,RONLY,eigrpInterfaceEntry,4,{5,1,1,20}},{EIGRPOOSRCVD,COUNTER,RONLY,eigrpI
nterfaceEntry,4,{5,1,1,21}},{EIGRPAUTHMODE,INTEGER,RONLY,eigrpInterfaceEntry,4,{
5,1,1,22}},{EIGRPAUTHKEYCHAIN,STRING,RONLY,eigrpInterfaceEntry,4,{5,1,1,23}}};st
aticstructeigrp_neighbor*eigrp_snmp_nbr_lookup(structeigrp*eigrp,structin_addr*n
br_addr,unsignedint*ifindex){structlistnode*node,*nnode,*node2,*nnode2;structeig
rp_interface*ei;structeigrp_neighbor*nbr;for(ALL_LIST_ELEMENTS(eigrp->eiflist,no
de,nnode,ei)){for(ALL_LIST_ELEMENTS(ei->nbrs,node2,nnode2,nbr)){if(IPV4_ADDR_SAM
E(&nbr->src,nbr_addr)){returnnbr;}}}returnNULL;}staticstructeigrp_neighbor*eigrp
_snmp_nbr_lookup_next(structin_addr*nbr_addr,unsignedint*ifindex,intfirst){struc
tlistnode*node,*nnode,*node2,*nnode2;structeigrp_interface*ei;structeigrp_neighb
or*nbr;structroute_node*rn;structeigrp_neighbor*min=NULL;structeigrp*eigrp=eigrp
;eigrp=eigrp_lookup();for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){for(A
LL_LIST_ELEMENTS(ei->nbrs,node2,nnode2,nbr)){if(first){if(!min)min=nbr;elseif(nt
ohl(nbr->src.s_addr)<ntohl(min->src.s_addr))min=nbr;}elseif(ntohl(nbr->src.s_add
r)>ntohl(nbr_addr->s_addr)){if(!min)min=nbr;elseif(ntohl(nbr->src.s_addr)<ntohl(
min->src.s_addr))min=nbr;}}}if(min){*nbr_addr=min->src;*ifindex=0;returnmin;}ret
urnNULL;}staticstructeigrp_neighbor*eigrpNbrLookup(structvariable*v,oid*name,siz
e_t*length,structin_addr*nbr_addr,unsignedint*ifindex,intexact){unsignedintlen;i
ntfirst;structeigrp_neighbor*nbr;structeigrp*eigrp;eigrp=eigrp_lookup();if(!eigr
p)returnNULL;if(exact){if(*length!=v->namelen+IN_ADDR_SIZE+1)returnNULL;oid2in_a
ddr(name+v->namelen,IN_ADDR_SIZE,nbr_addr);*ifindex=name[v->namelen+IN_ADDR_SIZE
];returneigrp_snmp_nbr_lookup(eigrp,nbr_addr,ifindex);}else{first=0;len=*length-
v->namelen;if(len<=0)first=1;if(len>IN_ADDR_SIZE)len=IN_ADDR_SIZE;oid2in_addr(na
me+v->namelen,len,nbr_addr);len=*length-v->namelen-IN_ADDR_SIZE;if(len>=1)*ifind
ex=name[v->namelen+IN_ADDR_SIZE];nbr=eigrp_snmp_nbr_lookup_next(nbr_addr,ifindex
,first);if(nbr){*length=v->namelen+IN_ADDR_SIZE+1;oid_copy_addr(name+v->namelen,
nbr_addr,IN_ADDR_SIZE);name[v->namelen+IN_ADDR_SIZE]=*ifindex;returnnbr;}}return
NULL;}staticuint8_t*eigrpVpnEntry(structvariable*v,oid*name,size_t*length,intexa
ct,size_t*var_len,WriteMethod**write_method){structeigrp*eigrp;eigrp=eigrp_looku
p();/*Checkwhethertheinstanceidentifierisvalid*/if(smux_header_generic(v,name,le
ngth,exact,var_len,write_method)==MATCH_FAILED)returnNULL;/*Returnthecurrentvalu
eofthevariable*/switch(v->magic){caseEIGRPVPNID:/*1*//*TheuniqueVPNidentifier*/i
f(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPVPNNAME
:/*2*//*ThenamegiventotheVPN*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_IN
TEGER(0);break;default:returnNULL;}returnNULL;}staticuint32_teigrp_neighbor_coun
t(structeigrp*eigrp){uint32_tcount;structeigrp_interface*ei;structlistnode*node,
*node2,*nnode2;structeigrp_neighbor*nbr;if(eigrp==NULL){return0;}count=0;for(ALL
_LIST_ELEMENTS_RO(eigrp->eiflist,node,ei)){for(ALL_LIST_ELEMENTS(ei->nbrs,node2,
nnode2,nbr)){if(nbr->state==EIGRP_NEIGHBOR_UP)count++;}}returncount;}staticuint8
_t*eigrpTraffStatsEntry(structvariable*v,oid*name,size_t*length,intexact,size_t*
var_len,WriteMethod**write_method){structeigrp*eigrp;structeigrp_interface*ei;st
ructlistnode*node,*nnode;intcounter;eigrp=eigrp_lookup();/*Checkwhethertheinstan
ceidentifierisvalid*/if(smux_header_generic(v,name,length,exact,var_len,write_me
thod)==MATCH_FAILED)returnNULL;/*Returnthecurrentvalueofthevariable*/switch(v->m
agic){caseEIGRPASNUMBER:/*1*//*AS-numberofthisEIGRPinstance.*/if(eigrp)returnSNM
P_INTEGER(eigrp->AS);elsereturnSNMP_INTEGER(0);break;caseEIGRPNBRCOUNT:/*2*//*Ne
ighborcountofthisEIGRPinstance*/if(eigrp)returnSNMP_INTEGER(eigrp_neighbor_count
(eigrp));elsereturnSNMP_INTEGER(0);break;caseEIGRPHELLOSSENT:/*3*//*Hellopackets
outputcount*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode
,ei)){counter+=ei->hello_out;}returnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGE
R(0);break;caseEIGRPHELLOSRCVD:/*4*//*Hellopacketsinputcount*/if(eigrp){counter=
0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){counter+=ei->hello_in;}re
turnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0);break;caseEIGRPUPDATESSENT:
/*5*//*Updatepacketsoutputcount*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp
->eiflist,node,nnode,ei)){counter+=ei->update_out;}returnSNMP_INTEGER(counter);}
elsereturnSNMP_INTEGER(0);break;caseEIGRPUPDATESRCVD:/*6*//*Updatepacketsinputco
unt*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){co
unter+=ei->update_in;}returnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0);bre
ak;caseEIGRPQUERIESSENT:/*7*//*Querrypacketsoutputcount*/if(eigrp){counter=0;for
(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){counter+=ei->query_out;}return
SNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0);break;caseEIGRPQUERIESRCVD:/*8*
//*Querrypacketsinputcount*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eif
list,node,nnode,ei)){counter+=ei->query_in;}returnSNMP_INTEGER(counter);}elseret
urnSNMP_INTEGER(0);break;caseEIGRPREPLIESSENT:/*9*//*Replypacketsoutputcount*/if
(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){counter+=
ei->reply_out;}returnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0);break;case
EIGRPREPLIESRCVD:/*10*//*Replypacketsinputcount*/if(eigrp){counter=0;for(ALL_LIS
T_ELEMENTS(eigrp->eiflist,node,nnode,ei)){counter+=ei->reply_in;}returnSNMP_INTE
GER(counter);}elsereturnSNMP_INTEGER(0);break;caseEIGRPACKSSENT:/*11*//*Acknowle
dgementpacketsoutputcount*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eifl
ist,node,nnode,ei)){counter+=ei->ack_out;}returnSNMP_INTEGER(counter);}elseretur
nSNMP_INTEGER(0);break;caseEIGRPACKSRCVD:/*12*//*Acknowledgementpacketsinputcoun
t*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){coun
ter+=ei->ack_in;}returnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0);break;ca
seEIGRPINPUTQHIGHMARK:/*13*//*ThehighestnumberofEIGRPpacketsintheinputqueue*/if(
eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPINPUTQDRO
PS:/*14*//*ThenumberofEIGRPpacketsdroppedfromtheinputqueue*/if(eigrp){returnSNMP
_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPSIAQUERIESSENT:/*15*//*SIA
querrypacketsoutputcount*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eifli
st,node,nnode,ei)){counter+=ei->siaQuery_out;}returnSNMP_INTEGER(counter);}elser
eturnSNMP_INTEGER(0);break;caseEIGRPSIAQUERIESRCVD:/*16*//*SIAquerrypacketsinput
count*/if(eigrp){counter=0;for(ALL_LIST_ELEMENTS(eigrp->eiflist,node,nnode,ei)){
counter+=ei->siaQuery_in;}returnSNMP_INTEGER(counter);}elsereturnSNMP_INTEGER(0)
;break;caseEIGRPASROUTERIDTYPE:/*17*//*WhethertherouterIDissetmanuallyorautomati
cally*/if(eigrp)if(eigrp->router_id_static!=0)returnSNMP_INTEGER(1);elsereturnSN
MP_INTEGER(1);elsereturnSNMP_INTEGER(0);break;caseEIGRPASROUTERID:/*18*//*Router
IDforthisEIGRPAS*/if(eigrp)if(eigrp->router_id_static!=0)returnSNMP_INTEGER(eigr
p->router_id_static);elsereturnSNMP_INTEGER(eigrp->router_id);elsereturnSNMP_INT
EGER(0);break;caseEIGRPTOPOROUTES:/*19*//*ThetotalnumberofEIGRPderivedroutescurr
entlyexistinginthetopologytablefortheAS*/if(eigrp){returnSNMP_INTEGER(1);}elsere
turnSNMP_INTEGER(0);break;caseEIGRPHEADSERIAL:/*20*//*Theserialnumberofthefirstr
outeintheinternalsequenceforanAS*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNM
P_INTEGER(0);break;caseEIGRPNEXTSERIAL:/*21*//*Theserialnumberthatwouldbeassigne
dtothenextneworchangedrouteinthetopologytablefortheAS*/if(eigrp){returnSNMP_INTE
GER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPXMITPENDREPLIES:/*22*//*Totalnu
mberofoutstandingrepliesexpectedtoqueriesthathavebeensenttopeersinthecurrentAS*/
if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPXMITDU
MMIES:/*23*//*Totalnumberofcurrentlyexistingdummiesassociatedwith*theAS*/if(eigr
p){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;default:returnNULL;}re
turnNULL;}staticuint8_t*eigrpTopologyEntry(structvariable*v,oid*name,size_t*leng
th,intexact,size_t*var_len,WriteMethod**write_method){structeigrp*eigrp;structei
grp_interface*ei;structlistnode*node,*nnode;eigrp=eigrp_lookup();/*Checkwhethert
heinstanceidentifierisvalid*/if(smux_header_generic(v,name,length,exact,var_len,
write_method)==MATCH_FAILED)returnNULL;/*Returnthecurrentvalueofthevariable*/swi
tch(v->magic){caseEIGRPDESTNETTYPE:/*1*//*TheformatofthedestinationIPnetworknumb
erforasinglerouteinthetopologytable*/if(eigrp){returnSNMP_INTEGER(1);}elsereturn
SNMP_INTEGER(0);break;caseEIGRPDESTNET:/*2*//*ThedestinationIPnetworknumberforas
inglerouteinthe*topologytable*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_I
NTEGER(0);break;caseEIGRPDESTNETPREFIXLEN:/*4*//*Theprefixlengthassociatedwithth
edestinationIPnetworkaddressforasinglerouteinthetopologytableintheAS*/if(eigrp){
returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPACTIVE:/*5*//*Av
alueoftrue(1)indicatestheroutetothedestinationnetworkhasfailedAvalueoffalse(2)in
dicatestherouteisstable(passive).*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSN
MP_INTEGER(0);break;caseEIGRPSTUCKINACTIVE:/*6*//*Avalueoftrue(1)indicatesthatth
atthisroutewhichisinactivestatehasnotreceivedanyrepliestoqueriesforalternatepath
s*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPDES
TSUCCESSORS:/*7*//*NextroutinghopforapathtothedestinationIPnetwork*/if(eigrp){re
turnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPFDISTANCE:/*8*//*M
inimumdistancefromthisroutertothedestinationIP*network*/if(eigrp){returnSNMP_INT
EGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPROUTEORIGINTYPE:/*9*//*Textstr
ingdescribingtheinternaloriginoftheEIGRProute*/if(eigrp){returnSNMP_INTEGER(1);}
elsereturnSNMP_INTEGER(0);break;caseEIGRPROUTEORIGINADDRTYPE:/*10*//*Theformatof
theIPaddressdefinedastheoriginofthistopologyrouteentry*/if(eigrp){returnSNMP_INT
EGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPROUTEORIGINADDR:/*11*//*Iftheo
riginofthetopologyrouteentryisexternaltothisrouter,thenthisobjectistheIPaddresso
ftherouterfromwhichitoriginated*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP
_INTEGER(0);break;caseEIGRPNEXTHOPADDRESSTYPE:/*12*//*TheformatofthenexthopIPadd
ress*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRP
NEXTHOPADDRESS:/*13*//*NexthopIPaddressfortheroute*/if(eigrp){returnSNMP_INTEGER
(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPNEXTHOPINTERFACE:/*14*//*Theinterf
acethroughwhichthenexthopIPaddressis*reached*/if(eigrp){returnSNMP_INTEGER(1);}e
lsereturnSNMP_INTEGER(0);break;caseEIGRPDISTANCE:/*15*//*Thecomputeddistancetoth
edestinationnetworkentryfrom*thisrouter*/if(eigrp){returnSNMP_INTEGER(1);}elsere
turnSNMP_INTEGER(0);break;caseEIGRPREPORTDISTANCE:/*16*//*Thecomputeddistancetot
hedestinationnetworkinthetopologyentryreportedtothisrouterbytheoriginatorofthisr
oute*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;default:r
eturnNULL;}returnNULL;}staticuint8_t*eigrpPeerEntry(structvariable*v,oid*name,si
ze_t*length,intexact,size_t*var_len,WriteMethod**write_method){structeigrp*eigrp
;structeigrp_interface*ei;structlistnode*node,*nnode;structeigrp_neighbor*nbr;st
ructin_addrnbr_addr;unsignedintifindex;eigrp=eigrp_lookup();/*Checkwhethertheins
tanceidentifierisvalid*/if(smux_header_generic(v,name,length,exact,var_len,write
_method)==MATCH_FAILED)returnNULL;memset(&nbr_addr,0,sizeof(structin_addr));ifin
dex=0;nbr=eigrpNbrLookup(v,name,length,&nbr_addr,&ifindex,exact);if(!nbr)returnN
ULL;ei=nbr->ei;if(!ei)returnNULL;/*Returnthecurrentvalueofthevariable*/switch(v-
>magic){caseEIGRPHANDLE:/*1*//*TheuniqueinternalidentifierforthepeerintheAS*/if(
eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPPEERADDRT
YPE:/*2*//*TheformatoftheremotesourceIPaddressusedbythepeer*/if(eigrp){returnSNM
P_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPPEERADDR:/*3*//*Thesource
IPaddressusedbythepeer*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(
0);break;caseEIGRPPEERIFINDEX:/*4*//*TheifIndexoftheinterfaceonthisrouter*/if(ei
grp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPHOLDTIME:/*
5*//*HowmuchtimemustpasswithoutreceivingahellopacketfromthisEIGRPpeerbeforethisr
outerdeclaresthepeerdown*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGE
R(0);break;caseEIGRPUPTIME:/*6*//*TheelapsedtimesincetheEIGRPadjacencywasfirst*e
stablished*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;cas
eEIGRPSRTT:/*7*//*Thecomputedsmoothroundtriptimeforpacketstoandfrom*thepeer*/if(
eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPRTO:/*8*/
/*Thecomputedretransmissiontimeoutforthepeer*/if(eigrp){returnSNMP_INTEGER(1);}e
lsereturnSNMP_INTEGER(0);break;caseEIGRPPKTSENQUEUED:/*9*//*ThenumberofanyEIGRPp
acketscurrentlyenqueued*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER
(0);break;caseEIGRPLASTSEQ:/*10*//*sequencenumberofthelastEIGRPpacketsenttothisp
eer*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPV
ERSION:/*11*//*TheEIGRPversioninformationreportedbytheremotepeer*/if(eigrp){retu
rnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPRETRANS:/*12*//*Thec
umulativenumberofretransmissionstothispeer*/if(eigrp){returnSNMP_INTEGER(1);}els
ereturnSNMP_INTEGER(0);break;caseEIGRPRETRIES:/*13*//*Thenumberoftimesthecurrent
unacknowledgedpackethas*beenretried*/if(eigrp){returnSNMP_INTEGER(1);}elsereturn
SNMP_INTEGER(0);break;default:returnNULL;}returnNULL;}staticuint8_t*eigrpInterfa
ceEntry(structvariable*v,oid*name,size_t*length,intexact,size_t*var_len,WriteMet
hod**write_method){structeigrp*eigrp;structeigrp_interface*ei;structlistnode*nod
e,*nnode;structkeychain*keychain;structlist*keylist;intcounter;eigrp=eigrp_looku
p();/*Checkwhethertheinstanceidentifierisvalid*/if(smux_header_generic(v,name,le
ngth,exact,var_len,write_method)==MATCH_FAILED)returnNULL;/*Returnthecurrentvalu
eofthevariable*/switch(v->magic){caseEIGRPPEERCOUNT:/*3*//*ThenumberofEIGRPadjac
enciescurrentlyformedwithpeersreachedthroughthisinterface*/if(eigrp){returnSNMP_
INTEGER(eigrp_neighbor_count(eigrp));}elsereturnSNMP_INTEGER(0);break;caseEIGRPX
MITRELIABLEQ:/*4*//*ThenumberofEIGRPpacketscurrentlywaitinginthereliabletranspor
ttransmissionqueue*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);b
reak;caseEIGRPXMITUNRELIABLEQ:/*5*//*ThenumberofEIGRPpacketscurrentlywaitinginth
eunreliabletransporttransmissionqueue*/if(eigrp){returnSNMP_INTEGER(1);}elseretu
rnSNMP_INTEGER(0);break;caseEIGRPMEANSRTT:/*6*//*Theaverageofallthecomputedsmoot
hroundtriptimevaluesforapackettoandfromallpeersestablishedonthisinterface*/if(ei
grp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPPACINGRELIA
BLE:/*7*//*TheconfiguredtimeintervalbetweenEIGRPpacket*transmissions*/if(eigrp){
returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPPACINGUNRELIABLE
:/*8*//*TheconfiguredtimeintervalbetweenEIGRPpackettransmissionsontheinterfacewh
entheunreliabletransportmethodisused*/if(eigrp){returnSNMP_INTEGER(1);}elseretur
nSNMP_INTEGER(0);break;caseEIGRPMFLOWTIMER:/*9*//*Theconfiguredmulticastflowcont
roltimervalue*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;
caseEIGRPPENDINGROUTES:/*10*//*ThenumberofqueuedEIGRProutingupdatesawaiting*tran
smission*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseE
IGRPHELLOINTERVAL:/*11*//*TheconfiguredtimeintervalbetweenHellopacket*transmissi
ons*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPX
MITNEXTSERIAL:/*12*//*TheserialnumberofthenextEIGRPpacketthatistobequeuedfortran
smission*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseE
IGRPUMCASTS:/*13*//*ThetotalnumberofunreliableEIGRPmulticastpacketssentonthisint
erface*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIG
RPRMCASTS:/*14*//*ThetotalnumberofreliableEIGRPmulticastpacketssentonthisinterfa
ce*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPUU
CASTS:/*15*//*ThetotalnumberofunreliableEIGRPunicastpacketssentonthisinterface*/
if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPRUCAST
S:/*16*//*ThetotalnumberofreliableEIGRPunicastpacketssentonthisinterface*/if(eig
rp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPMCASTEXCEPTS
:/*17*//*ThetotalnumberofEIGRPmulticastexceptiontransmissions*/if(eigrp){returnS
NMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPCRPKTS:/*18*//*Thetotal
numberEIGRPConditional-Receivepacketssenton*thisinterface*/if(eigrp){returnSNMP_
INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPACKSSUPPRESSED:/*19*//*Thet
otalnumberofindividualEIGRPacknowledgementpacketsthathavebeensuppressedandcombin
edinanalreadyenqueuedoutboundreliablepacketonthisinterface*/if(eigrp){returnSNMP
_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPRETRANSSENT:/*20*//*Thetot
alnumberEIGRPpacketretransmissionssentonthe*interface*/if(eigrp){returnSNMP_INTE
GER(1);}elsereturnSNMP_INTEGER(0);break;caseEIGRPOOSRCVD:/*21*//*Thetotalnumbero
fout-of-sequenceEIGRPpacketsreceived*/if(eigrp){returnSNMP_INTEGER(1);}elseretur
nSNMP_INTEGER(0);break;caseEIGRPAUTHMODE:/*22*//*TheEIGRPauthenticationmodeofthe
interface*/if(eigrp){returnSNMP_INTEGER(1);}elsereturnSNMP_INTEGER(0);break;case
EIGRPAUTHKEYCHAIN:/*23*//*Thenameoftheauthenticationkey-chainconfiguredonthisint
erface.*/keylist=keychain_list_get();for(ALL_LIST_ELEMENTS(keylist,node,nnode,ke
ychain)){return(uint8_t*)keychain->name;}if(eigrp&&keychain){*var_len=str_len(ke
ychain->name);return(uint8_t*)keychain->name;}elsereturn(uint8_t*)"TEST";break;d
efault:returnNULL;}returnNULL;}/*RegisterEIGRP-MIB.*/voideigrp_snmp_init(){eigrp
_snmp_iflist=list_new();smux_init(eigrp_om->master);REGISTER_MIB("ciscoEigrpMIB"
,eigrp_variables,variable,eigrp_oid);}#endif