/**EIGRPDumpFunctionsandDebugging.*Copyright(C)2013-2014*Authors:*DonnieSavage*J
anJanovic*MatejPerina*PeterOrsag*PeterPaluch**ThisfileispartofGNUZebra.**GNUZebr
aisfreesoftware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralP
ublicLicenseaspublishedbythe*FreeSoftwareFoundation;eitherversion2,or(atyouropti
on)any*laterversion.**GNUZebraisdistributedinthehopethatitwillbeuseful,but*WITHO
UTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTIC
ULARPURPOSE.SeetheGNU*GeneralPublicLicenseformoredetails.**Youshouldhavereceived
acopyoftheGNUGeneralPublicLicensealong*withthisprogram;seethefileCOPYING;ifnot,w
ritetotheFreeSoftware*Foundation,Inc.,51FranklinSt,FifthFloor,Boston,MA02110-130
1USA*/#include<zebra.h>#include"linklist.h"#include"thread.h"#include"prefix.h"#
include"command.h"#include"stream.h"#include"log.h"#include"sockopt.h"#include"t
able.h"#include"keychain.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrp
d.h"#include"eigrpd/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"
eigrpd/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/eigrp_vty.h"
#include"eigrpd/eigrp_network.h"#include"eigrpd/eigrp_dump.h"#include"eigrpd/eig
rp_topology.h"/*Enabledebugoptionvariables--validonlysession.*/unsignedlongterm_
debug_eigrp=0;unsignedlongterm_debug_eigrp_nei=0;unsignedlongterm_debug_eigrp_pa
cket[11]={0,0,0,0,0,0,0,0,0,0,0};unsignedlongterm_debug_eigrp_zebra=6;unsignedlo
ngterm_debug_eigrp_transmit=0;/*Configurationdebugoptionvariables.*/unsignedlong
conf_debug_eigrp=0;unsignedlongconf_debug_eigrp_nei=0;unsignedlongconf_debug_eig
rp_packet[11]={0,0,0,0,0,0,0,0,0,0,0};unsignedlongconf_debug_eigrp_zebra=0;unsig
nedlongconf_debug_eigrp_transmit=0;staticintconfig_write_debug(structvty*vty){in
twrite=0;inti;constchar*type_str[]={"update","request","query","reply","hello","
","probe","ack","","SIAquery","SIAreply","stub","all"};constchar*detail_str[]={"
","send","recv","","detail","senddetail","recvdetail","detail"};/*debugeigrpeven
t.*//*debugeigrppacket*/for(i=0;i<10;i++){if(conf_debug_eigrp_packet[i]==0&&term
_debug_eigrp_packet[i]==0)continue;vty_out(vty,"debugeigrppacket%s%s\n",type_str
[i],detail_str[conf_debug_eigrp_packet[i]]);write=1;}returnwrite;}staticinteigrp
_neighbor_packet_queue_sum(structeigrp_interface*ei){structeigrp_neighbor*nbr;st
ructlistnode*node,*nnode;intsum;sum=0;for(ALL_LIST_ELEMENTS(ei->nbrs,node,nnode,
nbr)){sum+=nbr->retrans_queue->count;}returnsum;}/**Expectsheadertobeinhostorder
*/voideigrp_ip_header_dump(structip*iph){/*IPHeaderdump.*/zlog_debug("ip_v%u",ip
h->ip_v);zlog_debug("ip_hl%u",iph->ip_hl);zlog_debug("ip_tos%u",iph->ip_tos);zlo
g_debug("ip_len%u",iph->ip_len);zlog_debug("ip_id%u",(uint32_t)iph->ip_id);zlog_
debug("ip_off%u",(uint32_t)iph->ip_off);zlog_debug("ip_ttl%u",iph->ip_ttl);zlog_
debug("ip_p%u",iph->ip_p);zlog_debug("ip_sum0x%x",(uint32_t)iph->ip_sum);zlog_de
bug("ip_src%s",inet_ntoa(iph->ip_src));zlog_debug("ip_dst%s",inet_ntoa(iph->ip_d
st));}/**Expectsheadertobeinhostorder*/voideigrp_header_dump(structeigrp_header*
eigrph){/*EIGRPHeaderdump.*/zlog_debug("eigrp_version%u",eigrph->version);zlog_d
ebug("eigrp_opcode%u",eigrph->opcode);zlog_debug("eigrp_checksum0x%x",ntohs(eigr
ph->checksum));zlog_debug("eigrp_flags0x%x",ntohl(eigrph->flags));zlog_debug("ei
grp_sequence%u",ntohl(eigrph->sequence));zlog_debug("eigrp_ack%u",ntohl(eigrph->
ack));zlog_debug("eigrp_vrid%u",ntohs(eigrph->vrid));zlog_debug("eigrp_AS%u",nto
hs(eigrph->ASNumber));}constchar*eigrp_if_name_string(structeigrp_interface*ei){
staticcharbuf[EIGRP_IF_STRING_MAXLEN]="";if(!ei)return"inactive";snprintf(buf,EI
GRP_IF_STRING_MAXLEN,"%s",ei->ifp->name);returnbuf;}constchar*eigrp_topology_ip_
string(structeigrp_prefix_entry*tn){staticcharbuf[EIGRP_IF_STRING_MAXLEN]="";uin
t32_tifaddr;ifaddr=ntohl(tn->destination->u.prefix4.s_addr);snprintf(buf,EIGRP_I
F_STRING_MAXLEN,"%u.%u.%u.%u",(ifaddr>>24)&0xff,(ifaddr>>16)&0xff,(ifaddr>>8)&0x
ff,ifaddr&0xff);returnbuf;}constchar*eigrp_if_ip_string(structeigrp_interface*ei
){staticcharbuf[EIGRP_IF_STRING_MAXLEN]="";uint32_tifaddr;if(!ei)return"inactive
";ifaddr=ntohl(ei->address->u.prefix4.s_addr);snprintf(buf,EIGRP_IF_STRING_MAXLE
N,"%u.%u.%u.%u",(ifaddr>>24)&0xff,(ifaddr>>16)&0xff,(ifaddr>>8)&0xff,ifaddr&0xff
);returnbuf;}constchar*eigrp_neigh_ip_string(structeigrp_neighbor*nbr){staticcha
rbuf[EIGRP_IF_STRING_MAXLEN]="";uint32_tifaddr;ifaddr=ntohl(nbr->src.s_addr);snp
rintf(buf,EIGRP_IF_STRING_MAXLEN,"%u.%u.%u.%u",(ifaddr>>24)&0xff,(ifaddr>>16)&0x
ff,(ifaddr>>8)&0xff,ifaddr&0xff);returnbuf;}voidshow_ip_eigrp_interface_header(s
tructvty*vty,structeigrp*eigrp){vty_out(vty,"\nEIGRPinterfacesforAS(%d)\n\n%-10s
%-10s%-10s%-6s%-12s%-7s%-14s%-12s%-8s%-8s%-8s\n%-39s%-12s%-7s%-14s%-12s%-8s\n",e
igrp->AS,"Interface","Bandwidth","Delay","Peers","XmitQueue","Mean","PacingTime"
,"Multicast","Pending","Hello","Holdtime","","Un/Reliable","SRTT","Un/Reliable",
"FlowTimer","Routes");}voidshow_ip_eigrp_interface_sub(structvty*vty,structeigrp
*eigrp,structeigrp_interface*ei){vty_out(vty,"%-11s",eigrp_if_name_string(ei));v
ty_out(vty,"%-11u",ei->params.bandwidth);vty_out(vty,"%-11u",ei->params.delay);v
ty_out(vty,"%-7u",ei->nbrs->count);vty_out(vty,"%u%c%-10u",0,'/',eigrp_neighbor_
packet_queue_sum(ei));vty_out(vty,"%-7u%-14u%-12u%-8u",0,0,0,0);vty_out(vty,"%-8
u%-8u\n",ei->params.v_hello,ei->params.v_wait);}voidshow_ip_eigrp_interface_deta
il(structvty*vty,structeigrp*eigrp,structeigrp_interface*ei){vty_out(vty,"%-2s%s
%d%-3s\n","","Hellointervalis",0,"sec");vty_out(vty,"%-2s%s%s\n","","Nextxmitser
ial","<none>");vty_out(vty,"%-2s%s%d%s%d%s%d%s%d\n","","Un/reliablemcasts:",0,"/
",0,"Un/reliableucasts:",0,"/",0);vty_out(vty,"%-2s%s%d%s%d%s%d\n","","Mcastexce
ptions:",0,"CRpackets:",0,"ACKssupressed:",0);vty_out(vty,"%-2s%s%d%s%d\n","","R
etransmissionssent:",0,"Out-of-sequencercvd:",0);vty_out(vty,"%-2s%s%s%s\n","","
Authenticationmodeis","not","set");vty_out(vty,"%-2s%s\n","","Usemulticast");}vo
idshow_ip_eigrp_neighbor_header(structvty*vty,structeigrp*eigrp){vty_out(vty,"\n
EIGRPneighborsforAS(%d)\n\n%-3s%-17s%-20s%-6s%-8s%-6s%-5s%-5s%-5s\n%-41s%-6s%-8s
%-6s%-4s%-6s%-5s\n",eigrp->AS,"H","Address","Interface","Hold","Uptime","SRTT","
RTO","Q","Seq","","(sec)","","(ms)","","Cnt","Num");}voidshow_ip_eigrp_neighbor_
sub(structvty*vty,structeigrp_neighbor*nbr,intdetail){vty_out(vty,"%-3u%-17s%-21
s",0,eigrp_neigh_ip_string(nbr),eigrp_if_name_string(nbr->ei));if(nbr->t_holddow
n)vty_out(vty,"%-7lu",thread_timer_remain_second(nbr->t_holddown));elsevty_out(v
ty,"-");vty_out(vty,"%-8u%-6u%-5u",0,0,EIGRP_PACKET_RETRANS_TIME);vty_out(vty,"%
-7lu",nbr->retrans_queue->count);vty_out(vty,"%u\n",nbr->recv_sequence_number);i
f(detail){vty_out(vty,"Version%u.%u/%u.%u",nbr->os_rel_major,nbr->os_rel_minor,n
br->tlv_rel_major,nbr->tlv_rel_minor);vty_out(vty,",Retrans:%lu,Retries:%lu",nbr
->retrans_queue->count,0UL);vty_out(vty,",%s\n",eigrp_nbr_state_str(nbr));}}/**P
rintstandardheaderforshowEIGRPtopologyoutput*/voidshow_ip_eigrp_topology_header(
structvty*vty,structeigrp*eigrp){structin_addrrouter_id;router_id.s_addr=eigrp->
router_id;vty_out(vty,"\nEIGRPTopologyTableforAS(%d)/ID(%s)\n\n",eigrp->AS,inet_
ntoa(router_id));vty_out(vty,"Codes:P-Passive,A-Active,U-Update,Q-Query,""R-Repl
y\nr-replyStatus,s-siaStatus\n\n");}voidshow_ip_eigrp_prefix_entry(structvty*vty
,structeigrp_prefix_entry*tn){structlist*successors=eigrp_topology_get_successor
(tn);charbuffer[PREFIX_STRLEN];vty_out(vty,"%-3c",(tn->state>0)?'A':'P');vty_out
(vty,"%s,",prefix2str(tn->destination,buffer,PREFIX_STRLEN));vty_out(vty,"%usucc
essors,",(successors)?successors->count:0);vty_out(vty,"FDis%u,serno:%"PRIu64"\n
",tn->fdistance,tn->serno);if(successors)list_delete_and_null(&successors);}void
show_ip_eigrp_nexthop_entry(structvty*vty,structeigrp*eigrp,structeigrp_nexthop_
entry*te,int*first){if(te->reported_distance==EIGRP_MAX_METRIC)return;if(*first)
{show_ip_eigrp_prefix_entry(vty,te->prefix);*first=0;}if(te->adv_router==eigrp->
neighbor_self)vty_out(vty,"%-7s%s,%s\n","","viaConnected",eigrp_if_name_string(t
e->ei));else{vty_out(vty,"%-7s%s%s(%u/%u),%s\n","","via",inet_ntoa(te->adv_route
r->src),te->distance,te->reported_distance,eigrp_if_name_string(te->ei));}}DEFUN
_NOSH(show_debugging_eigrp,show_debugging_eigrp_cmd,"showdebugging[eigrp]",SHOW_
STRDEBUG_STREIGRP_STR){inti;vty_out(vty,"EIGRPdebuggingstatus:\n");/*Showdebugst
atusforevents.*/if(IS_DEBUG_EIGRP(event,EVENT))vty_out(vty,"EIGRPeventdebuggingi
son\n");/*ShowdebugstatusforEIGRPPackets.*/for(i=0;i<11;i++){if(i==8)continue;if
(IS_DEBUG_EIGRP_PACKET(i,SEND)&&IS_DEBUG_EIGRP_PACKET(i,RECV)){vty_out(vty,"EIGR
Ppacket%s%sdebuggingison\n",lookup_msg(eigrp_packet_type_str,i+1,NULL),IS_DEBUG_
EIGRP_PACKET(i,PACKET_DETAIL)?"detail":"");}else{if(IS_DEBUG_EIGRP_PACKET(i,SEND
))vty_out(vty,"EIGRPpacket%ssend%sdebuggingison\n",lookup_msg(eigrp_packet_type_
str,i+1,NULL),IS_DEBUG_EIGRP_PACKET(i,PACKET_DETAIL)?"detail":"");if(IS_DEBUG_EI
GRP_PACKET(i,RECV))vty_out(vty,"EIGRPpacket%sreceive%sdebuggingison\n",lookup_ms
g(eigrp_packet_type_str,i+1,NULL),IS_DEBUG_EIGRP_PACKET(i,PACKET_DETAIL)?"detail
":"");}}returnCMD_SUCCESS;}/*[no]debugeigrppacket(hello|dd|ls-request|ls-update|
ls-ack|all)[send|recv[detail]]*/DEFUN(debug_eigrp_transmit,debug_eigrp_transmit_
cmd,"debugeigrptransmit<send|recv|all>[detail]",DEBUG_STREIGRP_STR"EIGRPtransmis
sionevents\n""packetsent\n""packetreceived\n""allpackets\n""DetailedInformation\
n"){intflag=0;intidx=2;/*sendorrecv.*/if(argv_find(argv,argc,"send",&idx))flag=E
IGRP_DEBUG_SEND;elseif(argv_find(argv,argc,"recv",&idx))flag=EIGRP_DEBUG_RECV;el
seif(argv_find(argv,argc,"all",&idx))flag=EIGRP_DEBUG_SEND_RECV;/*detailoption*/
if(argv_find(argv,argc,"detail",&idx))flag=EIGRP_DEBUG_PACKET_DETAIL;if(vty->nod
e==CONFIG_NODE)DEBUG_TRANSMIT_ON(0,flag);elseTERM_DEBUG_TRANSMIT_ON(0,flag);retu
rnCMD_SUCCESS;}DEFUN(no_debug_eigrp_transmit,no_debug_eigrp_transmit_cmd,"nodebu
geigrptransmit<send|recv|all>[detail]",NO_STRUNDEBUG_STREIGRP_STR"EIGRPtransmiss
ionevents\n""packetsent\n""packetreceived\n""allpackets\n""DetailedInformation\n
"){intflag=0;intidx=3;/*sendorrecv.*/if(argv_find(argv,argc,"send",&idx))flag=EI
GRP_DEBUG_SEND;elseif(argv_find(argv,argc,"recv",&idx))flag=EIGRP_DEBUG_RECV;els
eif(argv_find(argv,argc,"all",&idx))flag=EIGRP_DEBUG_SEND_RECV;/*detailoption*/i
f(argv_find(argv,argc,"detail",&idx))flag=EIGRP_DEBUG_PACKET_DETAIL;if(vty->node
==CONFIG_NODE)DEBUG_TRANSMIT_OFF(0,flag);elseTERM_DEBUG_TRANSMIT_OFF(0,flag);ret
urnCMD_SUCCESS;}DEFUN(debug_eigrp_packets,debug_eigrp_packets_all_cmd,"debugeigr
ppackets<siaquery|siareply|ack|hello|probe|query|reply|request|retry|stub|terse|
update|all>[send|receive][detail]",DEBUG_STREIGRP_STR"EIGRPpackets\n""EIGRPSIA-Q
uerypackets\n""EIGRPSIA-Replypackets\n""EIGRPackpackets\n""EIGRPhellopackets\n""
EIGRPprobepackets\n""EIGRPquerypackets\n""EIGRPreplypackets\n""EIGRPrequestpacke
ts\n""EIGRPretransmissions\n""EIGRPstubpackets\n""DisplayallEIGRPpacketsexceptHe
llos\n""EIGRPupdatepackets\n""DisplayallEIGRPpackets\n""SendPackets\n""ReceivePa
ckets\n""DetailInformation\n"){inttype=0;intflag=0;inti;intidx=0;/*Checkpacketty
pe.*/if(argv_find(argv,argc,"hello",&idx))type=EIGRP_DEBUG_HELLO;if(argv_find(ar
gv,argc,"update",&idx))type=EIGRP_DEBUG_UPDATE;if(argv_find(argv,argc,"query",&i
dx))type=EIGRP_DEBUG_QUERY;if(argv_find(argv,argc,"ack",&idx))type=EIGRP_DEBUG_A
CK;if(argv_find(argv,argc,"probe",&idx))type=EIGRP_DEBUG_PROBE;if(argv_find(argv
,argc,"stub",&idx))type=EIGRP_DEBUG_STUB;if(argv_find(argv,argc,"reply",&idx))ty
pe=EIGRP_DEBUG_REPLY;if(argv_find(argv,argc,"request",&idx))type=EIGRP_DEBUG_REQ
UEST;if(argv_find(argv,argc,"siaquery",&idx))type=EIGRP_DEBUG_SIAQUERY;if(argv_f
ind(argv,argc,"siareply",&idx))type=EIGRP_DEBUG_SIAREPLY;if(argv_find(argv,argc,
"all",&idx))type=EIGRP_DEBUG_PACKETS_ALL;/*Allpackettypes,bothsendandrecv.*/flag
=EIGRP_DEBUG_SEND_RECV;/*sendorrecv.*/if(argv_find(argv,argc,"s",&idx))flag=EIGR
P_DEBUG_SEND;elseif(argv_find(argv,argc,"r",&idx))flag=EIGRP_DEBUG_RECV;/*detail
.*/if(argv_find(argv,argc,"detail",&idx))flag|=EIGRP_DEBUG_PACKET_DETAIL;for(i=0
;i<11;i++)if(type&(0x01<<i)){if(vty->node==CONFIG_NODE)DEBUG_PACKET_ON(i,flag);e
lseTERM_DEBUG_PACKET_ON(i,flag);}returnCMD_SUCCESS;}DEFUN(no_debug_eigrp_packets
,no_debug_eigrp_packets_all_cmd,"nodebugeigrppackets<siaquery|siareply|ack|hello
|probe|query|reply|request|retry|stub|terse|update|all>[send|receive][detail]",N
O_STRUNDEBUG_STREIGRP_STR"EIGRPpackets\n""EIGRPSIA-Querypackets\n""EIGRPSIA-Repl
ypackets\n""EIGRPackpackets\n""EIGRPhellopackets\n""EIGRPprobepackets\n""EIGRPqu
erypackets\n""EIGRPreplypackets\n""EIGRPrequestpackets\n""EIGRPretransmissions\n
""EIGRPstubpackets\n""DisplayallEIGRPpacketsexceptHellos\n""EIGRPupdatepackets\n
""DisplayallEIGRPpackets\n""SendPackets\n""ReceivePackets\n""DetailedInformation
\n"){inttype=0;intflag=0;inti;intidx=0;/*Checkpackettype.*/if(argv_find(argv,arg
c,"hello",&idx))type=EIGRP_DEBUG_HELLO;if(argv_find(argv,argc,"update",&idx))typ
e=EIGRP_DEBUG_UPDATE;if(argv_find(argv,argc,"query",&idx))type=EIGRP_DEBUG_QUERY
;if(argv_find(argv,argc,"ack",&idx))type=EIGRP_DEBUG_ACK;if(argv_find(argv,argc,
"probe",&idx))type=EIGRP_DEBUG_PROBE;if(argv_find(argv,argc,"stub",&idx))type=EI
GRP_DEBUG_STUB;if(argv_find(argv,argc,"reply",&idx))type=EIGRP_DEBUG_REPLY;if(ar
gv_find(argv,argc,"request",&idx))type=EIGRP_DEBUG_REQUEST;if(argv_find(argv,arg
c,"siaquery",&idx))type=EIGRP_DEBUG_SIAQUERY;if(argv_find(argv,argc,"siareply",&
idx))type=EIGRP_DEBUG_SIAREPLY;/*Default,bothsendandrecv.*/flag=EIGRP_DEBUG_SEND
_RECV;/*sendorrecv.*/if(argv_find(argv,argc,"send",&idx))flag=EIGRP_DEBUG_SEND;e
lseif(argv_find(argv,argc,"reply",&idx))flag=EIGRP_DEBUG_RECV;/*detail.*/if(argv
_find(argv,argc,"detail",&idx))flag|=EIGRP_DEBUG_PACKET_DETAIL;for(i=0;i<11;i++)
if(type&(0x01<<i)){if(vty->node==CONFIG_NODE)DEBUG_PACKET_OFF(i,flag);elseTERM_D
EBUG_PACKET_OFF(i,flag);}returnCMD_SUCCESS;}/*Debugnode.*/staticstructcmd_nodeei
grp_debug_node={DEBUG_NODE,"",1/*VTYSH*/};/*Initializedebugcommands.*/voideigrp_
debug_init(){install_node(&eigrp_debug_node,config_write_debug);install_element(
ENABLE_NODE,&show_debugging_eigrp_cmd);install_element(ENABLE_NODE,&debug_eigrp_
packets_all_cmd);install_element(ENABLE_NODE,&no_debug_eigrp_packets_all_cmd);in
stall_element(ENABLE_NODE,&debug_eigrp_transmit_cmd);install_element(ENABLE_NODE
,&no_debug_eigrp_transmit_cmd);install_element(CONFIG_NODE,&show_debugging_eigrp
_cmd);install_element(CONFIG_NODE,&debug_eigrp_packets_all_cmd);install_element(
CONFIG_NODE,&no_debug_eigrp_packets_all_cmd);install_element(CONFIG_NODE,&debug_
eigrp_transmit_cmd);install_element(CONFIG_NODE,&no_debug_eigrp_transmit_cmd);}