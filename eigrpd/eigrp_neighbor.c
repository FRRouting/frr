/**EIGRPNeighborHandling.*Copyright(C)2013-2016*Authors:*DonnieSavage*JanJanovic
*MatejPerina*PeterOrsag*PeterPaluch*FrantisekGazo*TomasHvorkovy*MartinKontsek*Lu
kasKoribsky**ThisfileispartofGNUZebra.**GNUZebraisfreesoftware;youcanredistribut
eitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicenseaspublishedbythe*Free
SoftwareFoundation;eitherversion2,or(atyouroption)any*laterversion.**GNUZebraisd
istributedinthehopethatitwillbeuseful,but*WITHOUTANYWARRANTY;withouteventheimpli
edwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.SeetheGNU*GeneralPubl
icLicenseformoredetails.**YoushouldhavereceivedacopyoftheGNUGeneralPublicLicense
along*withthisprogram;seethefileCOPYING;ifnot,writetotheFreeSoftware*Foundation,
Inc.,51FranklinSt,FifthFloor,Boston,MA02110-1301USA*/#include<zebra.h>#include"l
inklist.h"#include"prefix.h"#include"memory.h"#include"command.h"#include"thread
.h"#include"stream.h"#include"table.h"#include"log.h"#include"keychain.h"#includ
e"vty.h"#include"eigrpd/eigrp_structs.h"#include"eigrpd/eigrpd.h"#include"eigrpd
/eigrp_interface.h"#include"eigrpd/eigrp_neighbor.h"#include"eigrpd/eigrp_dump.h
"#include"eigrpd/eigrp_packet.h"#include"eigrpd/eigrp_zebra.h"#include"eigrpd/ei
grp_vty.h"#include"eigrpd/eigrp_network.h"#include"eigrpd/eigrp_topology.h"#incl
ude"eigrpd/eigrp_memory.h"structeigrp_neighbor*eigrp_nbr_new(structeigrp_interfa
ce*ei){structeigrp_neighbor*nbr;/*Allcatenewneighbor.*/nbr=XCALLOC(MTYPE_EIGRP_N
EIGHBOR,sizeof(structeigrp_neighbor));/*Relateneighbortotheinterface.*/nbr->ei=e
i;/*Setdefaultvalues.*/eigrp_nbr_state_set(nbr,EIGRP_NEIGHBOR_DOWN);returnnbr;}/
***@fnvoiddissect_eigrp_sw_version(tvbuff_t*tvb,proto_tree*tree,*proto_item*ti)*
*@par*Createanewneighborstructureandinitalizeit.*/staticstructeigrp_neighbor*eig
rp_nbr_add(structeigrp_interface*ei,structeigrp_header*eigrph,structip*iph){stru
cteigrp_neighbor*nbr;nbr=eigrp_nbr_new(ei);nbr->src=iph->ip_src;//if(IS_DEBUG_EI
GRP_EVENT)//zlog_debug("NSM[%s:%s]:start",IF_NAME(nbr->oi),//inet_ntoa(nbr->rout
er_id));returnnbr;}structeigrp_neighbor*eigrp_nbr_get(structeigrp_interface*ei,s
tructeigrp_header*eigrph,structip*iph){structeigrp_neighbor*nbr;structlistnode*n
ode,*nnode;for(ALL_LIST_ELEMENTS(ei->nbrs,node,nnode,nbr)){if(iph->ip_src.s_addr
==nbr->src.s_addr){returnnbr;}}nbr=eigrp_nbr_add(ei,eigrph,iph);listnode_add(ei-
>nbrs,nbr);returnnbr;}/***@fneigrp_nbr_lookup_by_addr**@param[in]eiEIGRPinterfac
e*@param[in]nbr_addrAddressofneighbor**@returnvoid**@par*Functionisusedforneighb
orlookupbyaddress*inspecifiedinterface.*/structeigrp_neighbor*eigrp_nbr_lookup_b
y_addr(structeigrp_interface*ei,structin_addr*addr){structeigrp_neighbor*nbr;str
uctlistnode*node,*nnode;for(ALL_LIST_ELEMENTS(ei->nbrs,node,nnode,nbr)){if(addr-
>s_addr==nbr->src.s_addr){returnnbr;}}returnNULL;}/***@fneigrp_nbr_lookup_by_add
r_process**@param[in]eigrpEIGRPprocess*@param[in]nbr_addrAddressofneighbor**@ret
urnvoid**@par*Functionisusedforneighborlookupbyaddress*inwholeEIGRPprocess.*/str
ucteigrp_neighbor*eigrp_nbr_lookup_by_addr_process(structeigrp*eigrp,structin_ad
drnbr_addr){structeigrp_interface*ei;structlistnode*node,*node2,*nnode2;structei
grp_neighbor*nbr;/*iterateoveralleigrpinterfaces*/for(ALL_LIST_ELEMENTS_RO(eigrp
->eiflist,node,ei)){/*iterateoverallneighborsoneigrpinterface*/for(ALL_LIST_ELEM
ENTS(ei->nbrs,node2,nnode2,nbr)){/*compareifneighboraddressissameasargaddress*/i
f(nbr->src.s_addr==nbr_addr.s_addr){returnnbr;}}}returnNULL;}/*DeletespecifiedEI
GRPneighborfrominterface.*/voideigrp_nbr_delete(structeigrp_neighbor*nbr){eigrp_
nbr_state_set(nbr,EIGRP_NEIGHBOR_DOWN);if(nbr->ei)eigrp_topology_neighbor_down(n
br->ei->eigrp,nbr);/*Cancelallevents.*//*Threadlookupcostwouldbenegligible.*/thr
ead_cancel_event(master,nbr);eigrp_fifo_free(nbr->multicast_queue);eigrp_fifo_fr
ee(nbr->retrans_queue);THREAD_OFF(nbr->t_holddown);if(nbr->ei)listnode_delete(nb
r->ei->nbrs,nbr);XFREE(MTYPE_EIGRP_NEIGHBOR,nbr);}intholddown_timer_expired(stru
ctthread*thread){structeigrp_neighbor*nbr;nbr=THREAD_ARG(thread);zlog_info("Neig
hbor%s(%s)isdown:holdingtimeexpired",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei-
>ifp->ifindex,VRF_DEFAULT));nbr->state=EIGRP_NEIGHBOR_DOWN;eigrp_nbr_delete(nbr)
;return0;}uint8_teigrp_nbr_state_get(structeigrp_neighbor*nbr){return(nbr->state
);}voideigrp_nbr_state_set(structeigrp_neighbor*nbr,uint8_tstate){nbr->state=sta
te;if(eigrp_nbr_state_get(nbr)==EIGRP_NEIGHBOR_DOWN){//resetalltheseq/ackcounter
snbr->recv_sequence_number=0;nbr->init_sequence_number=0;nbr->retrans_counter=0;
//Kvaluesnbr->K1=EIGRP_K1_DEFAULT;nbr->K2=EIGRP_K2_DEFAULT;nbr->K3=EIGRP_K3_DEFA
ULT;nbr->K4=EIGRP_K4_DEFAULT;nbr->K5=EIGRP_K5_DEFAULT;nbr->K6=EIGRP_K6_DEFAULT;/
/holdtime..nbr->v_holddown=EIGRP_HOLD_INTERVAL_DEFAULT;THREAD_OFF(nbr->t_holddow
n);/*outwiththeold*/if(nbr->multicast_queue)eigrp_fifo_free(nbr->multicast_queue
);if(nbr->retrans_queue)eigrp_fifo_free(nbr->retrans_queue);/*inwiththenew*/nbr-
>retrans_queue=eigrp_fifo_new();nbr->multicast_queue=eigrp_fifo_new();nbr->crypt
_seqnum=0;}}constchar*eigrp_nbr_state_str(structeigrp_neighbor*nbr){constchar*st
ate;switch(nbr->state){caseEIGRP_NEIGHBOR_DOWN:state="Down";break;caseEIGRP_NEIG
HBOR_PENDING:state="WaitingforInit";break;caseEIGRP_NEIGHBOR_UP:state="Up";break
;default:state="Unknown";break;}return(state);}voideigrp_nbr_state_update(struct
eigrp_neighbor*nbr){switch(nbr->state){caseEIGRP_NEIGHBOR_DOWN:{/*StartHoldDownT
imerforneighbor*///THREAD_OFF(nbr->t_holddown);//THREAD_TIMER_ON(master,nbr->t_h
olddown,//holddown_timer_expired,//nbr,nbr->v_holddown);break;}caseEIGRP_NEIGHBO
R_PENDING:{/*ResetHoldDownTimerforneighbor*/THREAD_OFF(nbr->t_holddown);thread_a
dd_timer(master,holddown_timer_expired,nbr,nbr->v_holddown,&nbr->t_holddown);bre
ak;}caseEIGRP_NEIGHBOR_UP:{/*ResetHoldDownTimerforneighbor*/THREAD_OFF(nbr->t_ho
lddown);thread_add_timer(master,holddown_timer_expired,nbr,nbr->v_holddown,&nbr-
>t_holddown);break;}}}inteigrp_nbr_count_get(void){structeigrp_interface*iface;s
tructlistnode*node,*node2,*nnode2;structeigrp_neighbor*nbr;structeigrp*eigrp=eig
rp_lookup();uint32_tcounter;if(eigrp==NULL){zlog_debug("EIGRPRoutingProcessnoten
abled");return0;}counter=0;for(ALL_LIST_ELEMENTS_RO(eigrp->eiflist,node,iface)){
for(ALL_LIST_ELEMENTS(iface->nbrs,node2,nnode2,nbr)){if(nbr->state==EIGRP_NEIGHB
OR_UP){counter++;}}}returncounter;}/***@fneigrp_nbr_hard_restart**@param[in]nbrN
eighborwhowouldreceivehardrestart*@param[in]vtyVirtualterminalforlogoutput*@retu
rnvoid**@par*Functionusedforexecutinghardrestartforneighbor:*SendHellopacketwith
PeerTerminationTLVwith*neighbor'saddress,setit'sstatetoDOWNanddeletetheneighbor*
/voideigrp_nbr_hard_restart(structeigrp_neighbor*nbr,structvty*vty){if(nbr==NULL
){zlog_err("NbrHardrestart:Neighbornotspecified.");return;}zlog_debug("Neighbor%
s(%s)isdown:manuallycleared",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp->if
index,VRF_DEFAULT));if(vty!=NULL){vty_time_print(vty,0);vty_out(vty,"Neighbor%s(
%s)isdown:manuallycleared\n",inet_ntoa(nbr->src),ifindex2ifname(nbr->ei->ifp->if
index,VRF_DEFAULT));}/*sendHellowithPeerTerminationTLV*/eigrp_hello_send(nbr->ei
,EIGRP_HELLO_GRACEFUL_SHUTDOWN_NBR,&(nbr->src));/*setneighbortoDOWN*/nbr->state=
EIGRP_NEIGHBOR_DOWN;/*deleteneighbor*/eigrp_nbr_delete(nbr);}inteigrp_nbr_split_
horizon_check(structeigrp_nexthop_entry*ne,structeigrp_interface*ei){if(ne->dist
ance==EIGRP_MAX_METRIC)return0;return(ne->ei==ei);}