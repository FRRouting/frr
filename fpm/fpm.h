/**PublicdefinitionspertainingtotheForwardingPlaneManagercomponent.**Permissioni
sgrantedtouse,copy,modifyand/ordistributethis*softwareundereitheroneofthelicense
sbelow.**NotethatifyouuseotherfilesfromtheQuaggatreedirectlyor*indirectly,thenth
elicensesinthosefilesstillapply.**Pleaseretainbothlicensesbelowwhenmodifyingthis
codeinthe*Quaggatree.**Copyright(C)2012byOpenSourceRouting.*Copyright(C)2012byIn
ternetSystemsConsortium,Inc.("ISC")*//**LicenseOption1:GPL**Thisprogramisfreesof
tware;youcanredistributeitand/ormodifyit*underthetermsoftheGNUGeneralPublicLicen
seaspublishedbytheFree*SoftwareFoundation;eitherversion2oftheLicense,or(atyourop
tion)*anylaterversion.**Thisprogramisdistributedinthehopethatitwillbeuseful,butW
ITHOUT*ANYWARRANTY;withouteventheimpliedwarrantyofMERCHANTABILITYor*FITNESSFORAP
ARTICULARPURPOSE.SeetheGNUGeneralPublicLicensefor*moredetails.**Youshouldhaverec
eivedacopyoftheGNUGeneralPublicLicensealong*withthisprogram;ifnot,writetotheFree
SoftwareFoundation,Inc.,*59TemplePlace-Suite330,Boston,MA02111-1307,USA.*//**Lic
enseOption2:ISCLicense**Permissiontouse,copy,modify,and/ordistributethissoftware
*foranypurposewithorwithoutfeeisherebygranted,provided*thattheabovecopyrightnoti
ceandthispermissionnoticeappear*inallcopies.**THESOFTWAREISPROVIDED"ASIS"ANDTHEA
UTHORDISCLAIMSALL*WARRANTIESWITHREGARDTOTHISSOFTWAREINCLUDINGALLIMPLIED*WARRANTI
ESOFMERCHANTABILITYANDFITNESS.INNOEVENTSHALLTHE*AUTHORBELIABLEFORANYSPECIAL,DIRE
CT,INDIRECT,OR*CONSEQUENTIALDAMAGESORANYDAMAGESWHATSOEVERRESULTINGFROMLOSS*OFUSE
,DATAORPROFITS,WHETHERINANACTIONOFCONTRACT,*NEGLIGENCEOROTHERTORTIOUSACTION,ARIS
INGOUTOFORIN*CONNECTIONWITHTHEUSEORPERFORMANCEOFTHISSOFTWARE.*/#ifndef_FPM_H#def
ine_FPM_H/**TheForwardingPlaneManager(FPM)isanoptionalcomponentthat*maybeusedins
cenarioswheretherouterhasaforwardingpath*thatisdistinctfromthekernel,commonlyaha
rdware-basedfast*path.Itisresponsibleforprogrammingforwardinginformation*(suchas
routesandnexthops)inthefastpath.**InQuagga,theRoutingInformationBaseismaintained
inthe*'zebra'infrastructuredaemon.Routingprotocolscommunicatetheir*bestroutestoz
ebra,andzebracomputesthebestrouteacross*protocolsforeachprefix.Thislatterinforma
tioncomprisesthe*bulkoftheForwardingInformationBase.**Thisheaderfiledefinesapoin
t-to-pointinterfaceusingwhich*zebracanupdatetheFPMaboutchangesinroutes.Thecommun
ication*takesplaceoverastreamsocket.TheFPMlistensonawell-known*TCPport,andzebrai
nitiatestheconnection.**AllmessagessentovertheconnectionstartwithashortFPM*heade
r,fpm_msg_hdr_t.Inthecaseofrouteadd/deletemessages,*theheaderisfollowedbyanetlin
kmessage.Zebrashouldsenda*completecopyoftheforwardingtable(s)totheFPM,including*
routesthatitmayhavepickedupfromthekernel.**TheFPMinterfaceusesreplacesemantics.T
hatis,ifa'routeadd'*messageforaprefixisfollowedbyanother'routeadd'message,the*in
formationinthesecondmessageiscompletebyitself,andreplaces*theinformationsentinth
efirstmessage.**IftheconnectiontotheFPMgoesdownforsomereason,theclient*(zebra)sh
ouldsendtheFPMacompletecopyoftheforwarding*table(s)whenitreconnects.*//**Localho
stasadefaultserverforfpmconnection*/#defineFPM_DEFAULT_IP(htonl(INADDR_LOOPBACK)
)/**defaultportforfpmconnections*/#defineFPM_DEFAULT_PORT2620/**Largestmessageth
atcanbesenttoorreceivedfromtheFPM.*/#defineFPM_MAX_MSG_LEN4096#ifdef__SUNPRO_C#p
ragmapack(1)#endif/**Headerthatprecedeseachfpmmessageto/fromtheFPM.*/typedefstru
ctfpm_msg_hdr_t_{/**Protocolversion.*/uint8_tversion;/**Typeofmessage,seebelow.*
/uint8_tmsg_type;/**Lengthofentiremessage,includingtheheader,innetworkbyte*order
.*/uint16_tmsg_len;}__attribute__((packed))fpm_msg_hdr_t;#ifdef__SUNPRO_C#pragma
pack()#endif/**ThecurrentversionoftheFPMprotocolis1.*/#defineFPM_PROTO_VERSION1t
ypedefenumfpm_msg_type_e_{FPM_MSG_TYPE_NONE=0,/**Indicatesthatthepayloadisacompl
etelyformednetlink*message.**XXXNetlinkcaresaboutthealignmentofmessages.Whenany*
FPM_MSG_TYPE_NETLINKmessagesaresentoverachannel,thenall*messagesshouldbesizedsuc
hthatnetlinkalignmentis*maintained.*/FPM_MSG_TYPE_NETLINK=1,FPM_MSG_TYPE_PROTOBU
F=2,}fpm_msg_type_e;/**TheFPMmessageheaderisalignedtothesameboundaryasnetlink*me
ssages(4).Thismeansthatanetlinkmessagedoesnotneed*paddingwhenencapsulatedinanFPM
message.*/#defineFPM_MSG_ALIGNTO4/**fpm_msg_align**Roundupthegivenlengthtothedes
iredalignment.****NB**:Alignmentisrequiredonlywhennetlinkmessagesareused.*/stati
cinlinesize_tfpm_msg_align(size_tlen){return(len+FPM_MSG_ALIGNTO-1)&~(FPM_MSG_AL
IGNTO-1);}/**The(roundedup)sizeoftheFPMmessageheader.Thisensuresthat*themessagep
ayloadalwaysstartsatanalignedaddress.*/#defineFPM_MSG_HDR_LEN(sizeof(fpm_msg_hdr
_t))#ifndefCOMPILE_ASSERT#defineCOMPILE_ASSERT(x)externint__dummy[2*!!(x)-1]#end
ifCOMPILE_ASSERT(FPM_MSG_ALIGNTO==FPM_MSG_HDR_LEN);/**fpm_data_len_to_msg_len**T
helengthvaluethatshouldbeplacedinthemsg_lenfieldofthe*headerfora*payload*ofsize'
data_len'.*/staticinlinesize_tfpm_data_len_to_msg_len(size_tdata_len){returndata
_len+FPM_MSG_HDR_LEN;}/**fpm_msg_data**Pointertothepayloadofthegivenfpmheader.*/
staticinlinevoid*fpm_msg_data(fpm_msg_hdr_t*hdr){return((char*)hdr)+FPM_MSG_HDR_
LEN;}/**fpm_msg_len*/staticinlinesize_tfpm_msg_len(constfpm_msg_hdr_t*hdr){retur
nntohs(hdr->msg_len);}/**fpm_msg_data_len*/staticinlinesize_tfpm_msg_data_len(co
nstfpm_msg_hdr_t*hdr){return(fpm_msg_len(hdr)-FPM_MSG_HDR_LEN);}/**fpm_msg_next*
*Movetothenextmessageinabuffer.*/staticinlinefpm_msg_hdr_t*fpm_msg_next(fpm_msg_
hdr_t*hdr,size_t*len){size_tmsg_len;msg_len=fpm_msg_len(hdr);if(len){if(*len<msg
_len){assert(0);returnNULL;}*len-=msg_len;}return(fpm_msg_hdr_t*)(((char*)hdr)+m
sg_len);}/**fpm_msg_hdr_ok**ReturnsTRUEifamessageheaderlookswell-formed.*/static
inlineintfpm_msg_hdr_ok(constfpm_msg_hdr_t*hdr){size_tmsg_len;if(hdr->msg_type==
FPM_MSG_TYPE_NONE)return0;msg_len=fpm_msg_len(hdr);if(msg_len<FPM_MSG_HDR_LEN||m
sg_len>FPM_MAX_MSG_LEN)return0;/**Netlinkmessagesmustbealignedproperly.*/if(hdr-
>msg_type==FPM_MSG_TYPE_NETLINK&&fpm_msg_align(msg_len)!=msg_len)return0;return1
;}/**fpm_msg_ok**ReturnsTRUEifamessagelookswell-formed.**@paramlenThelengthinbyt
esfrom'hdr'totheendofthebuffer.*/staticinlineintfpm_msg_ok(constfpm_msg_hdr_t*hd
r,size_tlen){if(len<FPM_MSG_HDR_LEN)return0;if(!fpm_msg_hdr_ok(hdr))return0;if(f
pm_msg_len(hdr)>len)return0;return1;}//tcpmaximumrange#defineTCP_MAX_PORT65535//
tcpminimumrange#defineTCP_MIN_PORT1#endif/*_FPM_H*/